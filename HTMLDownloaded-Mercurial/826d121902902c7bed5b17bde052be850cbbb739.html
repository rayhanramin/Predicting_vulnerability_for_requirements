<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 24869:826d121902902c7bed5b17bde052be850cbbb739</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 826d121902902c7bed5b17bde052be850cbbb739" />
<meta property="og:url" content="/comm-central/rev/826d121902902c7bed5b17bde052be850cbbb739" />
<meta property="og:description" content="Bug 1478572 - Turn on ESLint in mail/components/im; r=florian" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 826d121902902c7bed5b17bde052be850cbbb739 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/826d121902902c7bed5b17bde052be850cbbb739">shortlog</a> |
<a href="/comm-central/log/826d121902902c7bed5b17bde052be850cbbb739">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/826d121902902c7bed5b17bde052be850cbbb739">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/826d121902902c7bed5b17bde052be850cbbb739">files</a> |
changeset |
<a href="/comm-central/raw-rev/826d121902902c7bed5b17bde052be850cbbb739">raw</a>  | <a href="/comm-central/archive/826d121902902c7bed5b17bde052be850cbbb739.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1478572">Bug 1478572</a> - Turn on ESLint in mail/components/im; r=florian
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#71;&#101;&#111;&#102;&#102;&#32;&#76;&#97;&#110;&#107;&#111;&#119;&#32;&#60;&#103;&#101;&#111;&#102;&#102;&#64;&#100;&#97;&#114;&#107;&#116;&#114;&#111;&#106;&#97;&#110;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Tue, 02 Oct 2018 17:17:08 +1300</td></tr>

<tr>
 <td>changeset 24869</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/826d121902902c7bed5b17bde052be850cbbb739">826d121902902c7bed5b17bde052be850cbbb739</a></td>
</tr>



<tr>
<td>parent 24868</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/1bc7b3e7b9dbf36520251860b7bee9a3ee8653a9">1bc7b3e7b9dbf36520251860b7bee9a3ee8653a9</a>
</td>
</tr>

<tr>
<td>child 24870</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/cc2807a09902b25cf0a964faf4e422397ecf05c7">cc2807a09902b25cf0a964faf4e422397ecf05c7</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=826d121902902c7bed5b17bde052be850cbbb739">14958</a></td></tr>
<tr><td>push user</td><td>geoff@darktrojan.net</td></tr>
<tr><td>push date</td><td class="date age">Tue, 02 Oct 2018 04:17:34 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@826d12190290 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=826d121902902c7bed5b17bde052be850cbbb739">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=826d121902902c7bed5b17bde052be850cbbb739&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=826d121902902c7bed5b17bde052be850cbbb739&newProject=comm-central&newRevision=1bc7b3e7b9dbf36520251860b7bee9a3ee8653a9&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=826d121902902c7bed5b17bde052be850cbbb739&newProject=comm-central&newRevision=1bc7b3e7b9dbf36520251860b7bee9a3ee8653a9&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=826d121902902c7bed5b17bde052be850cbbb739&newProject=comm-central&newRevision=1bc7b3e7b9dbf36520251860b7bee9a3ee8653a9&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28florian%29&revcount=50">florian</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1478572">1478572</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1478572">Bug 1478572</a> - Turn on ESLint in mail/components/im; r=florian</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/826d121902902c7bed5b17bde052be850cbbb739/.eslintignore">.eslintignore</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/826d121902902c7bed5b17bde052be850cbbb739/.eslintignore">file</a> |
<a href="/comm-central/annotate/826d121902902c7bed5b17bde052be850cbbb739/.eslintignore">annotate</a> |
<a href="/comm-central/diff/826d121902902c7bed5b17bde052be850cbbb739/.eslintignore">diff</a> |
<a href="/comm-central/comparison/826d121902902c7bed5b17bde052be850cbbb739/.eslintignore">comparison</a> |
<a href="/comm-central/log/826d121902902c7bed5b17bde052be850cbbb739/.eslintignore">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/826d121902902c7bed5b17bde052be850cbbb739/chat/modules/imSmileys.jsm">chat/modules/imSmileys.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/826d121902902c7bed5b17bde052be850cbbb739/chat/modules/imSmileys.jsm">file</a> |
<a href="/comm-central/annotate/826d121902902c7bed5b17bde052be850cbbb739/chat/modules/imSmileys.jsm">annotate</a> |
<a href="/comm-central/diff/826d121902902c7bed5b17bde052be850cbbb739/chat/modules/imSmileys.jsm">diff</a> |
<a href="/comm-central/comparison/826d121902902c7bed5b17bde052be850cbbb739/chat/modules/imSmileys.jsm">comparison</a> |
<a href="/comm-central/log/826d121902902c7bed5b17bde052be850cbbb739/chat/modules/imSmileys.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/826d121902902c7bed5b17bde052be850cbbb739/mail/base/content/search.xml">mail/base/content/search.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/826d121902902c7bed5b17bde052be850cbbb739/mail/base/content/search.xml">file</a> |
<a href="/comm-central/annotate/826d121902902c7bed5b17bde052be850cbbb739/mail/base/content/search.xml">annotate</a> |
<a href="/comm-central/diff/826d121902902c7bed5b17bde052be850cbbb739/mail/base/content/search.xml">diff</a> |
<a href="/comm-central/comparison/826d121902902c7bed5b17bde052be850cbbb739/mail/base/content/search.xml">comparison</a> |
<a href="/comm-central/log/826d121902902c7bed5b17bde052be850cbbb739/mail/base/content/search.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/.eslintrc.js">mail/components/im/content/.eslintrc.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/.eslintrc.js">file</a> |
<a href="/comm-central/annotate/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/.eslintrc.js">annotate</a> |
<a href="/comm-central/diff/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/.eslintrc.js">diff</a> |
<a href="/comm-central/comparison/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/.eslintrc.js">comparison</a> |
<a href="/comm-central/log/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/.eslintrc.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/addbuddy.js">mail/components/im/content/addbuddy.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/addbuddy.js">file</a> |
<a href="/comm-central/annotate/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/addbuddy.js">annotate</a> |
<a href="/comm-central/diff/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/addbuddy.js">diff</a> |
<a href="/comm-central/comparison/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/addbuddy.js">comparison</a> |
<a href="/comm-central/log/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/addbuddy.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/am-im.js">mail/components/im/content/am-im.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/am-im.js">file</a> |
<a href="/comm-central/annotate/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/am-im.js">annotate</a> |
<a href="/comm-central/diff/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/am-im.js">diff</a> |
<a href="/comm-central/comparison/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/am-im.js">comparison</a> |
<a href="/comm-central/log/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/am-im.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/chat-messenger.js">mail/components/im/content/chat-messenger.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/chat-messenger.js">file</a> |
<a href="/comm-central/annotate/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/chat-messenger.js">annotate</a> |
<a href="/comm-central/diff/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/chat-messenger.js">diff</a> |
<a href="/comm-central/comparison/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/chat-messenger.js">comparison</a> |
<a href="/comm-central/log/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/chat-messenger.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/imAccountWizard.js">mail/components/im/content/imAccountWizard.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/imAccountWizard.js">file</a> |
<a href="/comm-central/annotate/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/imAccountWizard.js">annotate</a> |
<a href="/comm-central/diff/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/imAccountWizard.js">diff</a> |
<a href="/comm-central/comparison/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/imAccountWizard.js">comparison</a> |
<a href="/comm-central/log/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/imAccountWizard.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/imAccounts.js">mail/components/im/content/imAccounts.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/imAccounts.js">file</a> |
<a href="/comm-central/annotate/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/imAccounts.js">annotate</a> |
<a href="/comm-central/diff/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/imAccounts.js">diff</a> |
<a href="/comm-central/comparison/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/imAccounts.js">comparison</a> |
<a href="/comm-central/log/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/imAccounts.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/imContextMenu.js">mail/components/im/content/imContextMenu.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/imContextMenu.js">file</a> |
<a href="/comm-central/annotate/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/imContextMenu.js">annotate</a> |
<a href="/comm-central/diff/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/imContextMenu.js">diff</a> |
<a href="/comm-central/comparison/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/imContextMenu.js">comparison</a> |
<a href="/comm-central/log/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/imContextMenu.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/imStatusSelector.js">mail/components/im/content/imStatusSelector.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/imStatusSelector.js">file</a> |
<a href="/comm-central/annotate/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/imStatusSelector.js">annotate</a> |
<a href="/comm-central/diff/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/imStatusSelector.js">diff</a> |
<a href="/comm-central/comparison/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/imStatusSelector.js">comparison</a> |
<a href="/comm-central/log/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/imStatusSelector.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/imcontact.xml">mail/components/im/content/imcontact.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/imcontact.xml">file</a> |
<a href="/comm-central/annotate/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/imcontact.xml">annotate</a> |
<a href="/comm-central/diff/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/imcontact.xml">diff</a> |
<a href="/comm-central/comparison/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/imcontact.xml">comparison</a> |
<a href="/comm-central/log/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/imcontact.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/imconv.xml">mail/components/im/content/imconv.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/imconv.xml">file</a> |
<a href="/comm-central/annotate/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/imconv.xml">annotate</a> |
<a href="/comm-central/diff/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/imconv.xml">diff</a> |
<a href="/comm-central/comparison/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/imconv.xml">comparison</a> |
<a href="/comm-central/log/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/imconv.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/imconversation.xml">mail/components/im/content/imconversation.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/imconversation.xml">file</a> |
<a href="/comm-central/annotate/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/imconversation.xml">annotate</a> |
<a href="/comm-central/diff/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/imconversation.xml">diff</a> |
<a href="/comm-central/comparison/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/imconversation.xml">comparison</a> |
<a href="/comm-central/log/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/imconversation.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/imgroup.xml">mail/components/im/content/imgroup.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/imgroup.xml">file</a> |
<a href="/comm-central/annotate/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/imgroup.xml">annotate</a> |
<a href="/comm-central/diff/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/imgroup.xml">diff</a> |
<a href="/comm-central/comparison/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/imgroup.xml">comparison</a> |
<a href="/comm-central/log/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/imgroup.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/joinchat.js">mail/components/im/content/joinchat.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/joinchat.js">file</a> |
<a href="/comm-central/annotate/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/joinchat.js">annotate</a> |
<a href="/comm-central/diff/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/joinchat.js">diff</a> |
<a href="/comm-central/comparison/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/joinchat.js">comparison</a> |
<a href="/comm-central/log/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/content/joinchat.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/imIncomingServer.js">mail/components/im/imIncomingServer.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/imIncomingServer.js">file</a> |
<a href="/comm-central/annotate/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/imIncomingServer.js">annotate</a> |
<a href="/comm-central/diff/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/imIncomingServer.js">diff</a> |
<a href="/comm-central/comparison/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/imIncomingServer.js">comparison</a> |
<a href="/comm-central/log/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/imIncomingServer.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/imProtocolInfo.js">mail/components/im/imProtocolInfo.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/imProtocolInfo.js">file</a> |
<a href="/comm-central/annotate/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/imProtocolInfo.js">annotate</a> |
<a href="/comm-central/diff/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/imProtocolInfo.js">diff</a> |
<a href="/comm-central/comparison/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/imProtocolInfo.js">comparison</a> |
<a href="/comm-central/log/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/imProtocolInfo.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/jar.mn">mail/components/im/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/jar.mn">file</a> |
<a href="/comm-central/annotate/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/jar.mn">annotate</a> |
<a href="/comm-central/diff/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/jar.mn">diff</a> |
<a href="/comm-central/comparison/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/jar.mn">comparison</a> |
<a href="/comm-central/log/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/messages/bubbles/Footer.html">mail/components/im/messages/bubbles/Footer.html</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/messages/bubbles/Footer.html">file</a> |
<a href="/comm-central/annotate/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/messages/bubbles/Footer.html">annotate</a> |
<a href="/comm-central/diff/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/messages/bubbles/Footer.html">diff</a> |
<a href="/comm-central/comparison/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/messages/bubbles/Footer.html">comparison</a> |
<a href="/comm-central/log/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/messages/bubbles/Footer.html">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/messages/dark/Footer.html">mail/components/im/messages/dark/Footer.html</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/messages/dark/Footer.html">file</a> |
<a href="/comm-central/annotate/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/messages/dark/Footer.html">annotate</a> |
<a href="/comm-central/diff/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/messages/dark/Footer.html">diff</a> |
<a href="/comm-central/comparison/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/messages/dark/Footer.html">comparison</a> |
<a href="/comm-central/log/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/messages/dark/Footer.html">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/messages/mail/Footer.html">mail/components/im/messages/mail/Footer.html</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/messages/mail/Footer.html">file</a> |
<a href="/comm-central/annotate/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/messages/mail/Footer.html">annotate</a> |
<a href="/comm-central/diff/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/messages/mail/Footer.html">diff</a> |
<a href="/comm-central/comparison/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/messages/mail/Footer.html">comparison</a> |
<a href="/comm-central/log/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/messages/mail/Footer.html">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/messages/papersheets/Footer.html">mail/components/im/messages/papersheets/Footer.html</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/messages/papersheets/Footer.html">file</a> |
<a href="/comm-central/annotate/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/messages/papersheets/Footer.html">annotate</a> |
<a href="/comm-central/diff/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/messages/papersheets/Footer.html">diff</a> |
<a href="/comm-central/comparison/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/messages/papersheets/Footer.html">comparison</a> |
<a href="/comm-central/log/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/messages/papersheets/Footer.html">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/modules/chatHandler.jsm">mail/components/im/modules/chatHandler.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/modules/chatHandler.jsm">file</a> |
<a href="/comm-central/annotate/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/modules/chatHandler.jsm">annotate</a> |
<a href="/comm-central/diff/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/modules/chatHandler.jsm">diff</a> |
<a href="/comm-central/comparison/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/modules/chatHandler.jsm">comparison</a> |
<a href="/comm-central/log/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/modules/chatHandler.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/modules/chatNotifications.jsm">mail/components/im/modules/chatNotifications.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/modules/chatNotifications.jsm">file</a> |
<a href="/comm-central/annotate/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/modules/chatNotifications.jsm">annotate</a> |
<a href="/comm-central/diff/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/modules/chatNotifications.jsm">diff</a> |
<a href="/comm-central/comparison/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/modules/chatNotifications.jsm">comparison</a> |
<a href="/comm-central/log/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/modules/chatNotifications.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/modules/index_im.js">mail/components/im/modules/index_im.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/modules/index_im.js">diff</a> |
<a href="/comm-central/comparison/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/modules/index_im.js">comparison</a> |
<a href="/comm-central/log/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/modules/index_im.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/modules/index_im.jsm">mail/components/im/modules/index_im.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/modules/index_im.jsm">file</a> |
<a href="/comm-central/annotate/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/modules/index_im.jsm">annotate</a> |
<a href="/comm-central/diff/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/modules/index_im.jsm">diff</a> |
<a href="/comm-central/comparison/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/modules/index_im.jsm">comparison</a> |
<a href="/comm-central/log/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/modules/index_im.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/modules/search_im.js">mail/components/im/modules/search_im.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/modules/search_im.js">diff</a> |
<a href="/comm-central/comparison/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/modules/search_im.js">comparison</a> |
<a href="/comm-central/log/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/modules/search_im.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/modules/search_im.jsm">mail/components/im/modules/search_im.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/modules/search_im.jsm">file</a> |
<a href="/comm-central/annotate/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/modules/search_im.jsm">annotate</a> |
<a href="/comm-central/diff/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/modules/search_im.jsm">diff</a> |
<a href="/comm-central/comparison/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/modules/search_im.jsm">comparison</a> |
<a href="/comm-central/log/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/modules/search_im.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/moz.build">mail/components/im/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/moz.build">file</a> |
<a href="/comm-central/annotate/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/moz.build">annotate</a> |
<a href="/comm-central/diff/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/moz.build">diff</a> |
<a href="/comm-central/comparison/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/moz.build">comparison</a> |
<a href="/comm-central/log/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/moz.build">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/smileys/theme.js">mail/components/im/smileys/theme.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/smileys/theme.js">diff</a> |
<a href="/comm-central/comparison/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/smileys/theme.js">comparison</a> |
<a href="/comm-central/log/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/smileys/theme.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/smileys/theme.json">mail/components/im/smileys/theme.json</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/smileys/theme.json">file</a> |
<a href="/comm-central/annotate/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/smileys/theme.json">annotate</a> |
<a href="/comm-central/diff/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/smileys/theme.json">diff</a> |
<a href="/comm-central/comparison/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/smileys/theme.json">comparison</a> |
<a href="/comm-central/log/826d121902902c7bed5b17bde052be850cbbb739/mail/components/im/smileys/theme.json">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/.eslintignore</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/.eslintignore</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -47,25 +47,27 @@ mailnews/test/*</span>
<a href="#l1.4"></a><span id="l1.4"> mailnews/extensions/*</span>
<a href="#l1.5"></a><span id="l1.5"> !mailnews/extensions/newsblog</span>
<a href="#l1.6"></a><span id="l1.6"> </span>
<a href="#l1.7"></a><span id="l1.7"> # mail exclusions</span>
<a href="#l1.8"></a><span id="l1.8"> mail/app/**</span>
<a href="#l1.9"></a><span id="l1.9"> mail/base/**</span>
<a href="#l1.10"></a><span id="l1.10"> mail/branding/**</span>
<a href="#l1.11"></a><span id="l1.11"> mail/components/cloudfile/**</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-mail/components/im/**</span>
<a href="#l1.13"></a><span id="l1.13"> mail/components/newmailaccount/**</span>
<a href="#l1.14"></a><span id="l1.14"> mail/components/search/**</span>
<a href="#l1.15"></a><span id="l1.15"> mail/config/**</span>
<a href="#l1.16"></a><span id="l1.16"> mail/extensions/**</span>
<a href="#l1.17"></a><span id="l1.17"> mail/installer/**</span>
<a href="#l1.18"></a><span id="l1.18"> mail/locales/**</span>
<a href="#l1.19"></a><span id="l1.19"> mail/test/**</span>
<a href="#l1.20"></a><span id="l1.20"> mail/themes/**</span>
<a href="#l1.21"></a><span id="l1.21"> </span>
<a href="#l1.22"></a><span id="l1.22" class="difflineplus">+# prefs files</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineplus">+mail/components/im/all-im.js</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineplus">+</span>
<a href="#l1.25"></a><span id="l1.25"> # calendar/ exclusions</span>
<a href="#l1.26"></a><span id="l1.26"> </span>
<a href="#l1.27"></a><span id="l1.27"> # prefs files</span>
<a href="#l1.28"></a><span id="l1.28"> calendar/lightning/content/lightning.js</span>
<a href="#l1.29"></a><span id="l1.29"> </span>
<a href="#l1.30"></a><span id="l1.30"> # third party library</span>
<a href="#l1.31"></a><span id="l1.31"> calendar/base/modules/ical.js</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/chat/modules/imSmileys.jsm</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/chat/modules/imSmileys.jsm</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -16,17 +16,17 @@ this.EXPORTED_SYMBOLS = [</span>
<a href="#l2.4"></a><span id="l2.4">   &quot;smileImMarkup&quot;, // used to add smile:// img tags into IM markup.</span>
<a href="#l2.5"></a><span id="l2.5">   &quot;smileTextNode&quot;, // used to add smile:// img tags to the content of a textnode</span>
<a href="#l2.6"></a><span id="l2.6">   &quot;smileString&quot;, // used to add smile:// img tags into a string without parsing it as HTML. Be sure the string doesn't contain HTML tags.</span>
<a href="#l2.7"></a><span id="l2.7">   &quot;getSmileRealURI&quot;, // used to retrieve the chrome URI for a smile:// URI</span>
<a href="#l2.8"></a><span id="l2.8">   &quot;getSmileyList&quot; // used to display a list of smileys in the UI</span>
<a href="#l2.9"></a><span id="l2.9"> ];</span>
<a href="#l2.10"></a><span id="l2.10"> </span>
<a href="#l2.11"></a><span id="l2.11"> var kEmoticonsThemePref = &quot;messenger.options.emoticonsTheme&quot;;</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-var kThemeFile = &quot;theme.js&quot;;</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+var kThemeFile = &quot;theme.json&quot;;</span>
<a href="#l2.14"></a><span id="l2.14"> </span>
<a href="#l2.15"></a><span id="l2.15"> Object.defineProperty(this, &quot;gTheme&quot;, {</span>
<a href="#l2.16"></a><span id="l2.16">   configurable: true,</span>
<a href="#l2.17"></a><span id="l2.17">   enumerable: true,</span>
<a href="#l2.18"></a><span id="l2.18"> </span>
<a href="#l2.19"></a><span id="l2.19">   get() {</span>
<a href="#l2.20"></a><span id="l2.20">     delete this.gTheme;</span>
<a href="#l2.21"></a><span id="l2.21">     gPrefObserver.init();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/base/content/search.xml</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/base/content/search.xml</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -228,17 +228,17 @@</span>
<a href="#l3.4"></a><span id="l3.4">                 tabmail.closeTab();</span>
<a href="#l3.5"></a><span id="l3.5">               }</span>
<a href="#l3.6"></a><span id="l3.6">               this.value = ''; // clear our value, to avoid persistence</span>
<a href="#l3.7"></a><span id="l3.7">               let args = {</span>
<a href="#l3.8"></a><span id="l3.8">                 searcher: new GlodaMsgSearcher(null, searchString)</span>
<a href="#l3.9"></a><span id="l3.9">               };</span>
<a href="#l3.10"></a><span id="l3.10">               if (Services.prefs.getBoolPref(&quot;mail.chat.enabled&quot;)) {</span>
<a href="#l3.11"></a><span id="l3.11">                 if (!(&quot;GlodaIMSearcher&quot; in window))</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-                  ChromeUtils.import(&quot;resource:///modules/search_im.js&quot;);</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+                  ChromeUtils.import(&quot;resource:///modules/search_im.jsm&quot;);</span>
<a href="#l3.14"></a><span id="l3.14">                 args.IMSearcher = new GlodaIMSearcher(null, searchString);</span>
<a href="#l3.15"></a><span id="l3.15">               }</span>
<a href="#l3.16"></a><span id="l3.16">               tabmail.openTab(&quot;glodaFacet&quot;, args);</span>
<a href="#l3.17"></a><span id="l3.17">             }</span>
<a href="#l3.18"></a><span id="l3.18">           } catch (e) {</span>
<a href="#l3.19"></a><span id="l3.19">             logException(e);</span>
<a href="#l3.20"></a><span id="l3.20">           }</span>
<a href="#l3.21"></a><span id="l3.21">         ]]&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1">new file mode 100644</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineminus">--- /dev/null</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineplus">+++ b/mail/components/im/content/.eslintrc.js</span>
<a href="#l4.4"></a><span id="l4.4" class="difflineat">@@ -0,0 +1,27 @@</span>
<a href="#l4.5"></a><span id="l4.5" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l4.6"></a><span id="l4.6" class="difflineplus">+/* eslint-env node */</span>
<a href="#l4.7"></a><span id="l4.7" class="difflineplus">+</span>
<a href="#l4.8"></a><span id="l4.8" class="difflineplus">+module.exports = {</span>
<a href="#l4.9"></a><span id="l4.9" class="difflineplus">+  overrides: [{</span>
<a href="#l4.10"></a><span id="l4.10" class="difflineplus">+    files: [</span>
<a href="#l4.11"></a><span id="l4.11" class="difflineplus">+      &quot;imcontact.xml&quot;,</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+      &quot;imconv.xml&quot;,</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+      &quot;imconversation.xml&quot;,</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+    ],</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+    globals: {</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+      AppConstants: true,</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+      chatHandler: true,</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+      fixIterator: true,</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+      gChatTab: true,</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+      Services: true,</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+      // chat/modules/imStatusUtils.jsm</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineplus">+      Status: true,</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineplus">+</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineplus">+      // chat/modules/imTextboxUtils.jsm</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineplus">+      MessageFormat: true,</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineplus">+      TextboxSize: true,</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineplus">+      TextboxSpellChecker: true,</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineplus">+    },</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineplus">+  }],</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/components/im/content/addbuddy.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/components/im/content/addbuddy.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -1,14 +1,14 @@</span>
<a href="#l5.4"></a><span id="l5.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l5.5"></a><span id="l5.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l5.6"></a><span id="l5.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l5.7"></a><span id="l5.7"> </span>
<a href="#l5.8"></a><span id="l5.8" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l5.9"></a><span id="l5.9" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l5.10"></a><span id="l5.10" class="difflineplus">+var { fixIterator } = ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;, null);</span>
<a href="#l5.11"></a><span id="l5.11" class="difflineplus">+var { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;, null);</span>
<a href="#l5.12"></a><span id="l5.12"> </span>
<a href="#l5.13"></a><span id="l5.13"> var addBuddy = {</span>
<a href="#l5.14"></a><span id="l5.14">   onload: function ab_onload() {</span>
<a href="#l5.15"></a><span id="l5.15">     let accountList = document.getElementById(&quot;accountlist&quot;);</span>
<a href="#l5.16"></a><span id="l5.16">     for (let acc of fixIterator(Services.accounts.getAccounts())) {</span>
<a href="#l5.17"></a><span id="l5.17">       if (!acc.connected)</span>
<a href="#l5.18"></a><span id="l5.18">         continue;</span>
<a href="#l5.19"></a><span id="l5.19">       let proto = acc.protocol;</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineat">@@ -29,10 +29,10 @@ var addBuddy = {</span>
<a href="#l5.21"></a><span id="l5.21">   },</span>
<a href="#l5.22"></a><span id="l5.22"> </span>
<a href="#l5.23"></a><span id="l5.23">   getValue: function ab_getValue(aId) { return document.getElementById(aId).value; },</span>
<a href="#l5.24"></a><span id="l5.24"> </span>
<a href="#l5.25"></a><span id="l5.25">   create: function ab_create() {</span>
<a href="#l5.26"></a><span id="l5.26">     let account = Services.accounts.getAccountById(this.getValue(&quot;accountlist&quot;));</span>
<a href="#l5.27"></a><span id="l5.27">     let group = document.getElementById(&quot;chatBundle&quot;).getString(&quot;defaultGroup&quot;);</span>
<a href="#l5.28"></a><span id="l5.28">     account.addBuddy(Services.tags.createTag(group), this.getValue(&quot;name&quot;));</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineminus">-  }</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineplus">+  },</span>
<a href="#l5.31"></a><span id="l5.31"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/components/im/content/am-im.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/components/im/content/am-im.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -1,18 +1,20 @@</span>
<a href="#l6.4"></a><span id="l6.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l6.5"></a><span id="l6.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l6.6"></a><span id="l6.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l6.7"></a><span id="l6.7"> </span>
<a href="#l6.8"></a><span id="l6.8" class="difflineplus">+// chat/content/imAccountOptionsHelper.js</span>
<a href="#l6.9"></a><span id="l6.9" class="difflineplus">+/* globals accountOptionsHelper */</span>
<a href="#l6.10"></a><span id="l6.10" class="difflineplus">+</span>
<a href="#l6.11"></a><span id="l6.11"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l6.12"></a><span id="l6.12"> </span>
<a href="#l6.13"></a><span id="l6.13"> var autoJoinPref = &quot;autoJoin&quot;;</span>
<a href="#l6.14"></a><span id="l6.14"> </span>
<a href="#l6.15"></a><span id="l6.15" class="difflineminus">-function onPreInit(aAccount, aAccountValue)</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineminus">-{</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineplus">+function onPreInit(aAccount, aAccountValue) {</span>
<a href="#l6.18"></a><span id="l6.18">   account.init(aAccount.incomingServer.wrappedJSObject.imAccount);</span>
<a href="#l6.19"></a><span id="l6.19"> }</span>
<a href="#l6.20"></a><span id="l6.20"> </span>
<a href="#l6.21"></a><span id="l6.21"> var account = {</span>
<a href="#l6.22"></a><span id="l6.22">   init: function account_init(aAccount) {</span>
<a href="#l6.23"></a><span id="l6.23">     this.account = aAccount;</span>
<a href="#l6.24"></a><span id="l6.24">     this.proto = this.account.protocol;</span>
<a href="#l6.25"></a><span id="l6.25">     document.getElementById(&quot;accountName&quot;).value = this.account.name;</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineat">@@ -20,18 +22,17 @@ var account = {</span>
<a href="#l6.27"></a><span id="l6.27">     document.getElementById(&quot;protocolIcon&quot;).src =</span>
<a href="#l6.28"></a><span id="l6.28">       this.proto.iconBaseURI + &quot;icon48.png&quot;;</span>
<a href="#l6.29"></a><span id="l6.29"> </span>
<a href="#l6.30"></a><span id="l6.30">     let password = document.getElementById(&quot;server.password&quot;);</span>
<a href="#l6.31"></a><span id="l6.31">     let passwordBox = document.getElementById(&quot;passwordBox&quot;);</span>
<a href="#l6.32"></a><span id="l6.32">     if (this.proto.noPassword) {</span>
<a href="#l6.33"></a><span id="l6.33">       passwordBox.hidden = true;</span>
<a href="#l6.34"></a><span id="l6.34">       password.removeAttribute(&quot;wsm_persist&quot;);</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineminus">-    }</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineminus">-    else {</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineplus">+    } else {</span>
<a href="#l6.38"></a><span id="l6.38">       passwordBox.hidden = false;</span>
<a href="#l6.39"></a><span id="l6.39">       try {</span>
<a href="#l6.40"></a><span id="l6.40">         // Should we force layout here to ensure password.value works?</span>
<a href="#l6.41"></a><span id="l6.41">         // Will throw if we don't have a protocol plugin for the account.</span>
<a href="#l6.42"></a><span id="l6.42">         password.value = this.account.password;</span>
<a href="#l6.43"></a><span id="l6.43">         password.setAttribute(&quot;wsm_persist&quot;, &quot;true&quot;);</span>
<a href="#l6.44"></a><span id="l6.44">       } catch (e) {</span>
<a href="#l6.45"></a><span id="l6.45">         passwordBox.hidden = true;</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineat">@@ -63,35 +64,35 @@ var account = {</span>
<a href="#l6.47"></a><span id="l6.47">       yield options.getNext();</span>
<a href="#l6.48"></a><span id="l6.48">   },</span>
<a href="#l6.49"></a><span id="l6.49"> </span>
<a href="#l6.50"></a><span id="l6.50">   populateProtoSpecificBox: function account_populate() {</span>
<a href="#l6.51"></a><span id="l6.51">     let attributes = {};</span>
<a href="#l6.52"></a><span id="l6.52">     attributes[Ci.prplIPref.typeBool] = [</span>
<a href="#l6.53"></a><span id="l6.53">       {name: &quot;wsm_persist&quot;, value: &quot;true&quot;},</span>
<a href="#l6.54"></a><span id="l6.54">       {name: &quot;preftype&quot;, value: &quot;bool&quot;},</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineminus">-      {name: &quot;genericattr&quot;, value: &quot;true&quot;}</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineplus">+      {name: &quot;genericattr&quot;, value: &quot;true&quot;},</span>
<a href="#l6.57"></a><span id="l6.57">     ];</span>
<a href="#l6.58"></a><span id="l6.58">     attributes[Ci.prplIPref.typeInt] = [</span>
<a href="#l6.59"></a><span id="l6.59">       {name: &quot;wsm_persist&quot;, value: &quot;true&quot;},</span>
<a href="#l6.60"></a><span id="l6.60">       {name: &quot;preftype&quot;, value: &quot;int&quot;},</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineminus">-      {name: &quot;genericattr&quot;, value: &quot;true&quot;}</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineplus">+      {name: &quot;genericattr&quot;, value: &quot;true&quot;},</span>
<a href="#l6.63"></a><span id="l6.63">     ];</span>
<a href="#l6.64"></a><span id="l6.64">     attributes[Ci.prplIPref.typeString] = attributes[Ci.prplIPref.typeList] = [</span>
<a href="#l6.65"></a><span id="l6.65">       {name: &quot;wsm_persist&quot;, value: &quot;true&quot;},</span>
<a href="#l6.66"></a><span id="l6.66">       {name: &quot;preftype&quot;, value: &quot;wstring&quot;},</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineminus">-      {name: &quot;genericattr&quot;, value: &quot;true&quot;}</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineplus">+      {name: &quot;genericattr&quot;, value: &quot;true&quot;},</span>
<a href="#l6.69"></a><span id="l6.69">     ];</span>
<a href="#l6.70"></a><span id="l6.70">     let haveOptions =</span>
<a href="#l6.71"></a><span id="l6.71">       accountOptionsHelper.addOptions(&quot;server.&quot;, this.getProtoOptions(),</span>
<a href="#l6.72"></a><span id="l6.72">                                       attributes);</span>
<a href="#l6.73"></a><span id="l6.73">     let advanced = document.getElementById(&quot;advanced&quot;);</span>
<a href="#l6.74"></a><span id="l6.74">     if (advanced.hidden &amp;&amp; haveOptions) {</span>
<a href="#l6.75"></a><span id="l6.75">       advanced.hidden = false;</span>
<a href="#l6.76"></a><span id="l6.76">       // Force textbox XBL binding attachment by forcing layout,</span>
<a href="#l6.77"></a><span id="l6.77">       // otherwise setFormElementValue from AccountManager.js sets</span>
<a href="#l6.78"></a><span id="l6.78">       // properties that don't exist when restoring values.</span>
<a href="#l6.79"></a><span id="l6.79">       document.getElementById(&quot;protoSpecific&quot;).getBoundingClientRect();</span>
<a href="#l6.80"></a><span id="l6.80" class="difflineminus">-    }</span>
<a href="#l6.81"></a><span id="l6.81" class="difflineminus">-    else if (!haveOptions)</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineplus">+    } else if (!haveOptions) {</span>
<a href="#l6.83"></a><span id="l6.83">       advanced.hidden = true;</span>
<a href="#l6.84"></a><span id="l6.84" class="difflineminus">-  }</span>
<a href="#l6.85"></a><span id="l6.85" class="difflineplus">+    }</span>
<a href="#l6.86"></a><span id="l6.86" class="difflineplus">+  },</span>
<a href="#l6.87"></a><span id="l6.87"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mail/components/im/content/chat-messenger.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mail/components/im/content/chat-messenger.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -1,21 +1,22 @@</span>
<a href="#l7.4"></a><span id="l7.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l7.5"></a><span id="l7.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l7.6"></a><span id="l7.6">  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l7.7"></a><span id="l7.7"> </span>
<a href="#l7.8"></a><span id="l7.8" class="difflineminus">-var imServices = {};</span>
<a href="#l7.9"></a><span id="l7.9" class="difflineplus">+// This file is loaded in messenger.xul.</span>
<a href="#l7.10"></a><span id="l7.10" class="difflineplus">+/* globals fixIterator, MailToolboxCustomizeDone, Notifications, openIMAccountMgr,</span>
<a href="#l7.11"></a><span id="l7.11" class="difflineplus">+   PROTO_TREE_VIEW, Services, Status, statusSelector, ZoomManager */</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+</span>
<a href="#l7.13"></a><span id="l7.13"> ChromeUtils.import(&quot;resource:///modules/chatNotifications.jsm&quot;);</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;, imServices);</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+var { Services: imServices } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;, null);</span>
<a href="#l7.16"></a><span id="l7.16"> ChromeUtils.import(&quot;resource://gre/modules/AppConstants.jsm&quot;);</span>
<a href="#l7.17"></a><span id="l7.17"> </span>
<a href="#l7.18"></a><span id="l7.18"> ChromeUtils.defineModuleGetter(this, &quot;OS&quot;, &quot;resource://gre/modules/osfile.jsm&quot;);</span>
<a href="#l7.19"></a><span id="l7.19"> </span>
<a href="#l7.20"></a><span id="l7.20" class="difflineminus">-imServices = imServices.Services;</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineminus">-</span>
<a href="#l7.22"></a><span id="l7.22"> var gBuddyListContextMenu = null;</span>
<a href="#l7.23"></a><span id="l7.23"> </span>
<a href="#l7.24"></a><span id="l7.24"> function buddyListContextMenu(aXulMenu) {</span>
<a href="#l7.25"></a><span id="l7.25">   this.target = aXulMenu.triggerNode;</span>
<a href="#l7.26"></a><span id="l7.26">   this.menu = aXulMenu;</span>
<a href="#l7.27"></a><span id="l7.27">   let localName = this.target.localName;</span>
<a href="#l7.28"></a><span id="l7.28">   this.onContact = localName == &quot;imcontact&quot;;</span>
<a href="#l7.29"></a><span id="l7.29">   this.onConv = localName == &quot;imconv&quot;;</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineat">@@ -66,49 +67,49 @@ buddyListContextMenu.prototype = {</span>
<a href="#l7.31"></a><span id="l7.31">     let flags = prompts.BUTTON_TITLE_IS_STRING * prompts.BUTTON_POS_0 +</span>
<a href="#l7.32"></a><span id="l7.32">                 prompts.BUTTON_TITLE_CANCEL * prompts.BUTTON_POS_1 +</span>
<a href="#l7.33"></a><span id="l7.33">                 prompts.BUTTON_POS_1_DEFAULT;</span>
<a href="#l7.34"></a><span id="l7.34">     if (prompts.confirmEx(window, promptTitle, promptMessage, flags,</span>
<a href="#l7.35"></a><span id="l7.35">                           deleteButton, null, null, null, {}))</span>
<a href="#l7.36"></a><span id="l7.36">       return;</span>
<a href="#l7.37"></a><span id="l7.37"> </span>
<a href="#l7.38"></a><span id="l7.38">     this.target.deleteContact();</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineminus">-  }</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineplus">+  },</span>
<a href="#l7.41"></a><span id="l7.41"> };</span>
<a href="#l7.42"></a><span id="l7.42"> </span>
<a href="#l7.43"></a><span id="l7.43"> var gChatTab = null;</span>
<a href="#l7.44"></a><span id="l7.44"> </span>
<a href="#l7.45"></a><span id="l7.45"> var chatTabType = {</span>
<a href="#l7.46"></a><span id="l7.46">   name: &quot;chat&quot;,</span>
<a href="#l7.47"></a><span id="l7.47">   panelId: &quot;chatTabPanel&quot;,</span>
<a href="#l7.48"></a><span id="l7.48">   hasBeenOpened: false,</span>
<a href="#l7.49"></a><span id="l7.49">   modes: {</span>
<a href="#l7.50"></a><span id="l7.50">     chat: {</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineminus">-      type: &quot;chat&quot;</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineminus">-    }</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineplus">+      type: &quot;chat&quot;,</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineplus">+    },</span>
<a href="#l7.55"></a><span id="l7.55">   },</span>
<a href="#l7.56"></a><span id="l7.56"> </span>
<a href="#l7.57"></a><span id="l7.57">   tabMonitor: {</span>
<a href="#l7.58"></a><span id="l7.58">     monitorName: &quot;chattab&quot;,</span>
<a href="#l7.59"></a><span id="l7.59"> </span>
<a href="#l7.60"></a><span id="l7.60">     // Unused, but needed functions</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineminus">-    onTabTitleChanged: function() {},</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineminus">-    onTabOpened: function(aTab) {},</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineminus">-    onTabClosing: function() {},</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineminus">-    onTabPersist: function() {},</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineminus">-    onTabRestored: function() {},</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineplus">+    onTabTitleChanged() {},</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineplus">+    onTabOpened(aTab) {},</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineplus">+    onTabClosing() {},</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineplus">+    onTabPersist() {},</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineplus">+    onTabRestored() {},</span>
<a href="#l7.71"></a><span id="l7.71"> </span>
<a href="#l7.72"></a><span id="l7.72">     onTabSwitched(aNewTab, aOldTab) {</span>
<a href="#l7.73"></a><span id="l7.73">       // aNewTab == chat is handled earlier by showTab() below.</span>
<a href="#l7.74"></a><span id="l7.74">       if (aOldTab.mode.name == &quot;chat&quot;)</span>
<a href="#l7.75"></a><span id="l7.75">         chatHandler._onTabDeactivated();</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineminus">-    }</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineplus">+    },</span>
<a href="#l7.78"></a><span id="l7.78">   },</span>
<a href="#l7.79"></a><span id="l7.79"> </span>
<a href="#l7.80"></a><span id="l7.80" class="difflineminus">-  _handleArgs: function(aArgs) {</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineplus">+  _handleArgs(aArgs) {</span>
<a href="#l7.82"></a><span id="l7.82">     if (!aArgs || !(&quot;convType&quot; in aArgs) ||</span>
<a href="#l7.83"></a><span id="l7.83">         (aArgs.convType != &quot;log&quot; &amp;&amp; aArgs.convType != &quot;focus&quot;))</span>
<a href="#l7.84"></a><span id="l7.84">       return;</span>
<a href="#l7.85"></a><span id="l7.85"> </span>
<a href="#l7.86"></a><span id="l7.86">     if (aArgs.convType == &quot;focus&quot;) {</span>
<a href="#l7.87"></a><span id="l7.87">       chatHandler.focusConversation(aArgs.conv);</span>
<a href="#l7.88"></a><span id="l7.88">       return;</span>
<a href="#l7.89"></a><span id="l7.89">     }</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineat">@@ -130,17 +131,17 @@ var chatTabType = {</span>
<a href="#l7.91"></a><span id="l7.91">     if (tabmail.currentTabInfo.mode.name == &quot;chat&quot;)</span>
<a href="#l7.92"></a><span id="l7.92">       chatHandler._onTabActivated();</span>
<a href="#l7.93"></a><span id="l7.93">   },</span>
<a href="#l7.94"></a><span id="l7.94">   _onWindowDeactivated() {</span>
<a href="#l7.95"></a><span id="l7.95">     let tabmail = document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l7.96"></a><span id="l7.96">     if (tabmail.currentTabInfo.mode.name == &quot;chat&quot;)</span>
<a href="#l7.97"></a><span id="l7.97">       chatHandler._onTabDeactivated();</span>
<a href="#l7.98"></a><span id="l7.98">   },</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineminus">-  openTab: function(aTab, aArgs) {</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineplus">+  openTab(aTab, aArgs) {</span>
<a href="#l7.101"></a><span id="l7.101">     if (!this.hasBeenOpened) {</span>
<a href="#l7.102"></a><span id="l7.102">       if (chatHandler.ChatCore &amp;&amp; chatHandler.ChatCore.initialized) {</span>
<a href="#l7.103"></a><span id="l7.103">         let convs = imServices.conversations.getUIConversations();</span>
<a href="#l7.104"></a><span id="l7.104">         if (convs.length != 0) {</span>
<a href="#l7.105"></a><span id="l7.105">           convs.sort((a, b) =&gt;</span>
<a href="#l7.106"></a><span id="l7.106">                      a.title.toLowerCase().localeCompare(b.title.toLowerCase()));</span>
<a href="#l7.107"></a><span id="l7.107">           for (let conv of convs)</span>
<a href="#l7.108"></a><span id="l7.108">             chatHandler._addConversation(conv);</span>
<a href="#l7.109"></a><span id="l7.109" class="difflineat">@@ -156,41 +157,41 @@ var chatTabType = {</span>
<a href="#l7.110"></a><span id="l7.110"> </span>
<a href="#l7.111"></a><span id="l7.111">     gChatTab = aTab;</span>
<a href="#l7.112"></a><span id="l7.112">     aTab.tabNode.setAttribute(&quot;type&quot;, &quot;chat&quot;);</span>
<a href="#l7.113"></a><span id="l7.113">     this._handleArgs(aArgs);</span>
<a href="#l7.114"></a><span id="l7.114">     this.showTab(aTab);</span>
<a href="#l7.115"></a><span id="l7.115">     chatHandler.updateTitle();</span>
<a href="#l7.116"></a><span id="l7.116">     this.hasBeenOpened = true;</span>
<a href="#l7.117"></a><span id="l7.117">   },</span>
<a href="#l7.118"></a><span id="l7.118" class="difflineminus">-  shouldSwitchTo: function(aArgs) {</span>
<a href="#l7.119"></a><span id="l7.119" class="difflineplus">+  shouldSwitchTo(aArgs) {</span>
<a href="#l7.120"></a><span id="l7.120">     if (!gChatTab)</span>
<a href="#l7.121"></a><span id="l7.121">       return -1;</span>
<a href="#l7.122"></a><span id="l7.122">     this._handleArgs(aArgs);</span>
<a href="#l7.123"></a><span id="l7.123">     return document.getElementById(&quot;tabmail&quot;).tabInfo.indexOf(gChatTab);</span>
<a href="#l7.124"></a><span id="l7.124">   },</span>
<a href="#l7.125"></a><span id="l7.125" class="difflineminus">-  showTab: function(aTab) {</span>
<a href="#l7.126"></a><span id="l7.126" class="difflineplus">+  showTab(aTab) {</span>
<a href="#l7.127"></a><span id="l7.127">     gChatTab = aTab;</span>
<a href="#l7.128"></a><span id="l7.128">     chatHandler._onTabActivated();</span>
<a href="#l7.129"></a><span id="l7.129">     // The next call may change the selected conversation, but that</span>
<a href="#l7.130"></a><span id="l7.130">     // will be handled by the selected mutation observer of the imconv.</span>
<a href="#l7.131"></a><span id="l7.131">     chatHandler._updateSelectedConversation();</span>
<a href="#l7.132"></a><span id="l7.132">     chatHandler._updateFocus();</span>
<a href="#l7.133"></a><span id="l7.133">   },</span>
<a href="#l7.134"></a><span id="l7.134" class="difflineminus">-  closeTab: function(aTab) {</span>
<a href="#l7.135"></a><span id="l7.135" class="difflineplus">+  closeTab(aTab) {</span>
<a href="#l7.136"></a><span id="l7.136">     gChatTab = null;</span>
<a href="#l7.137"></a><span id="l7.137">     let tabmail = document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l7.138"></a><span id="l7.138">     tabmail.unregisterTabMonitor(this.tabMonitor);</span>
<a href="#l7.139"></a><span id="l7.139">     window.removeEventListener(&quot;deactivate&quot;, chatTabType._onWindowDeactivated);</span>
<a href="#l7.140"></a><span id="l7.140">     window.removeEventListener(&quot;activate&quot;, chatTabType._onWindowActivated);</span>
<a href="#l7.141"></a><span id="l7.141">   },</span>
<a href="#l7.142"></a><span id="l7.142" class="difflineminus">-  persistTab: function(aTab) {</span>
<a href="#l7.143"></a><span id="l7.143" class="difflineplus">+  persistTab(aTab) {</span>
<a href="#l7.144"></a><span id="l7.144">     return {};</span>
<a href="#l7.145"></a><span id="l7.145">   },</span>
<a href="#l7.146"></a><span id="l7.146" class="difflineminus">-  restoreTab: function(aTabmail, aPersistedState) {</span>
<a href="#l7.147"></a><span id="l7.147" class="difflineplus">+  restoreTab(aTabmail, aPersistedState) {</span>
<a href="#l7.148"></a><span id="l7.148">     aTabmail.openTab(&quot;chat&quot;, {});</span>
<a href="#l7.149"></a><span id="l7.149">   },</span>
<a href="#l7.150"></a><span id="l7.150"> </span>
<a href="#l7.151"></a><span id="l7.151">   supportsCommand: function ct_supportsCommand(aCommand, aTab) {</span>
<a href="#l7.152"></a><span id="l7.152">     switch (aCommand) {</span>
<a href="#l7.153"></a><span id="l7.153">       case &quot;cmd_fullZoomReduce&quot;:</span>
<a href="#l7.154"></a><span id="l7.154">       case &quot;cmd_fullZoomEnlarge&quot;:</span>
<a href="#l7.155"></a><span id="l7.155">       case &quot;cmd_fullZoomReset&quot;:</span>
<a href="#l7.156"></a><span id="l7.156" class="difflineat">@@ -238,47 +239,45 @@ var chatTabType = {</span>
<a href="#l7.157"></a><span id="l7.157">       case &quot;cmd_findAgain&quot;:</span>
<a href="#l7.158"></a><span id="l7.158">         this.getFindbar().onFindAgainCommand(false);</span>
<a href="#l7.159"></a><span id="l7.159">         break;</span>
<a href="#l7.160"></a><span id="l7.160">       case &quot;cmd_findPrevious&quot;:</span>
<a href="#l7.161"></a><span id="l7.161">         this.getFindbar().onFindAgainCommand(true);</span>
<a href="#l7.162"></a><span id="l7.162">         break;</span>
<a href="#l7.163"></a><span id="l7.163">     }</span>
<a href="#l7.164"></a><span id="l7.164">   },</span>
<a href="#l7.165"></a><span id="l7.165" class="difflineminus">-  onEvent: function(aEvent, aTab) { },</span>
<a href="#l7.166"></a><span id="l7.166" class="difflineplus">+  onEvent(aEvent, aTab) {},</span>
<a href="#l7.167"></a><span id="l7.167">   getBrowser: function ct_getBrowser(aTab) {</span>
<a href="#l7.168"></a><span id="l7.168">     let panel = document.getElementById(&quot;conversationsDeck&quot;).selectedPanel;</span>
<a href="#l7.169"></a><span id="l7.169">     if (panel == document.getElementById(&quot;logDisplay&quot;)) {</span>
<a href="#l7.170"></a><span id="l7.170">       if (document.getElementById(&quot;logDisplayDeck&quot;).selectedPanel ==</span>
<a href="#l7.171"></a><span id="l7.171">           document.getElementById(&quot;logDisplayBrowserBox&quot;))</span>
<a href="#l7.172"></a><span id="l7.172">         return document.getElementById(&quot;conv-log-browser&quot;);</span>
<a href="#l7.173"></a><span id="l7.173" class="difflineminus">-    }</span>
<a href="#l7.174"></a><span id="l7.174" class="difflineminus">-    else if (panel &amp;&amp; panel.localName == &quot;imconversation&quot;) {</span>
<a href="#l7.175"></a><span id="l7.175" class="difflineplus">+    } else if (panel &amp;&amp; panel.localName == &quot;imconversation&quot;) {</span>
<a href="#l7.176"></a><span id="l7.176">       return panel.browser;</span>
<a href="#l7.177"></a><span id="l7.177">     }</span>
<a href="#l7.178"></a><span id="l7.178">     return null;</span>
<a href="#l7.179"></a><span id="l7.179">   },</span>
<a href="#l7.180"></a><span id="l7.180">   getFindbar: function ct_getFindbar(aTab) {</span>
<a href="#l7.181"></a><span id="l7.181">     let panel = document.getElementById(&quot;conversationsDeck&quot;).selectedPanel;</span>
<a href="#l7.182"></a><span id="l7.182">     if (panel == document.getElementById(&quot;logDisplay&quot;)) {</span>
<a href="#l7.183"></a><span id="l7.183">       if (document.getElementById(&quot;logDisplayDeck&quot;).selectedPanel ==</span>
<a href="#l7.184"></a><span id="l7.184">           document.getElementById(&quot;logDisplayBrowserBox&quot;))</span>
<a href="#l7.185"></a><span id="l7.185">         return document.getElementById(&quot;log-findbar&quot;);</span>
<a href="#l7.186"></a><span id="l7.186" class="difflineminus">-    }</span>
<a href="#l7.187"></a><span id="l7.187" class="difflineminus">-    else if (panel &amp;&amp; panel.localName == &quot;imconversation&quot;) {</span>
<a href="#l7.188"></a><span id="l7.188" class="difflineplus">+    } else if (panel &amp;&amp; panel.localName == &quot;imconversation&quot;) {</span>
<a href="#l7.189"></a><span id="l7.189">       return panel.findbar;</span>
<a href="#l7.190"></a><span id="l7.190">     }</span>
<a href="#l7.191"></a><span id="l7.191">     return null;</span>
<a href="#l7.192"></a><span id="l7.192">   },</span>
<a href="#l7.193"></a><span id="l7.193"> </span>
<a href="#l7.194"></a><span id="l7.194" class="difflineminus">-  saveTabState: function(aTab) { }</span>
<a href="#l7.195"></a><span id="l7.195" class="difflineplus">+  saveTabState(aTab) {},</span>
<a href="#l7.196"></a><span id="l7.196"> };</span>
<a href="#l7.197"></a><span id="l7.197"> </span>
<a href="#l7.198"></a><span id="l7.198"> var chatHandler = {</span>
<a href="#l7.199"></a><span id="l7.199" class="difflineminus">-  _addConversation: function(aConv) {</span>
<a href="#l7.200"></a><span id="l7.200" class="difflineplus">+  _addConversation(aConv) {</span>
<a href="#l7.201"></a><span id="l7.201">     let list = document.getElementById(&quot;contactlistbox&quot;);</span>
<a href="#l7.202"></a><span id="l7.202">     let convs = document.getElementById(&quot;conversationsGroup&quot;);</span>
<a href="#l7.203"></a><span id="l7.203">     let selectedItem = list.selectedItem;</span>
<a href="#l7.204"></a><span id="l7.204">     let shouldSelect =</span>
<a href="#l7.205"></a><span id="l7.205">       gChatTab &amp;&amp; gChatTab.tabNode.selected &amp;&amp;</span>
<a href="#l7.206"></a><span id="l7.206">       (!selectedItem || (selectedItem == convs &amp;&amp;</span>
<a href="#l7.207"></a><span id="l7.207">                         convs.nextSibling.localName != &quot;imconv&quot;));</span>
<a href="#l7.208"></a><span id="l7.208">     let elt = convs.addContact(aConv, &quot;imconv&quot;);</span>
<a href="#l7.209"></a><span id="l7.209" class="difflineat">@@ -291,35 +290,35 @@ var chatHandler = {</span>
<a href="#l7.210"></a><span id="l7.210">     let contact = aConv.buddy.buddy.contact;</span>
<a href="#l7.211"></a><span id="l7.211">     elt.imContact = contact;</span>
<a href="#l7.212"></a><span id="l7.212">     let groupName = (contact.online ? &quot;on&quot; : &quot;off&quot;) + &quot;linecontactsGroup&quot;;</span>
<a href="#l7.213"></a><span id="l7.213">     let item = document.getElementById(groupName).removeContact(contact);</span>
<a href="#l7.214"></a><span id="l7.214">     if (list.selectedItem == item)</span>
<a href="#l7.215"></a><span id="l7.215">       list.selectedItem = elt;</span>
<a href="#l7.216"></a><span id="l7.216">   },</span>
<a href="#l7.217"></a><span id="l7.217"> </span>
<a href="#l7.218"></a><span id="l7.218" class="difflineminus">-  _hasConversationForContact: function(aContact) {</span>
<a href="#l7.219"></a><span id="l7.219" class="difflineplus">+  _hasConversationForContact(aContact) {</span>
<a href="#l7.220"></a><span id="l7.220">     let convs = document.getElementById(&quot;conversationsGroup&quot;).contacts;</span>
<a href="#l7.221"></a><span id="l7.221">     return convs.some(aConversation =&gt;</span>
<a href="#l7.222"></a><span id="l7.222">       aConversation.hasOwnProperty(&quot;imContact&quot;) &amp;&amp;</span>
<a href="#l7.223"></a><span id="l7.223">       aConversation.imContact.id == aContact.id);</span>
<a href="#l7.224"></a><span id="l7.224">   },</span>
<a href="#l7.225"></a><span id="l7.225"> </span>
<a href="#l7.226"></a><span id="l7.226">   _chatButtonUpdatePending: false,</span>
<a href="#l7.227"></a><span id="l7.227" class="difflineminus">-  updateChatButtonState: function() {</span>
<a href="#l7.228"></a><span id="l7.228" class="difflineplus">+  updateChatButtonState() {</span>
<a href="#l7.229"></a><span id="l7.229">     if (this._chatButtonUpdatePending)</span>
<a href="#l7.230"></a><span id="l7.230">       return;</span>
<a href="#l7.231"></a><span id="l7.231">     this._chatButtonUpdatePending = true;</span>
<a href="#l7.232"></a><span id="l7.232">     Services.tm.mainThread.dispatch(this._updateChatButtonState.bind(this),</span>
<a href="#l7.233"></a><span id="l7.233">                                     Ci.nsIEventTarget.DISPATCH_NORMAL);</span>
<a href="#l7.234"></a><span id="l7.234">   },</span>
<a href="#l7.235"></a><span id="l7.235">   // This is the unread count that was part of the latest</span>
<a href="#l7.236"></a><span id="l7.236">   // unread-im-count-changed notification.</span>
<a href="#l7.237"></a><span id="l7.237">   _notifiedUnreadCount: 0,</span>
<a href="#l7.238"></a><span id="l7.238" class="difflineminus">-  _updateChatButtonState: function() {</span>
<a href="#l7.239"></a><span id="l7.239" class="difflineplus">+  _updateChatButtonState() {</span>
<a href="#l7.240"></a><span id="l7.240">     delete this._chatButtonUpdatePending;</span>
<a href="#l7.241"></a><span id="l7.241">     let chatButton = document.getElementById(&quot;button-chat&quot;);</span>
<a href="#l7.242"></a><span id="l7.242">     if (!chatButton)</span>
<a href="#l7.243"></a><span id="l7.243">       return;</span>
<a href="#l7.244"></a><span id="l7.244"> </span>
<a href="#l7.245"></a><span id="l7.245">     let [unreadTargettedCount, unreadTotalCount] = this.countUnreadMessages();</span>
<a href="#l7.246"></a><span id="l7.246">     chatButton.badgeCount = unreadTargettedCount;</span>
<a href="#l7.247"></a><span id="l7.247"> </span>
<a href="#l7.248"></a><span id="l7.248" class="difflineat">@@ -332,28 +331,28 @@ var chatHandler = {</span>
<a href="#l7.249"></a><span id="l7.249">       let unreadInt = Cc[&quot;@mozilla.org/supports-PRInt32;1&quot;]</span>
<a href="#l7.250"></a><span id="l7.250">                         .createInstance(Ci.nsISupportsPRInt32);</span>
<a href="#l7.251"></a><span id="l7.251">       unreadInt.data = unreadTargettedCount;</span>
<a href="#l7.252"></a><span id="l7.252">       Services.obs.notifyObservers(unreadInt, &quot;unread-im-count-changed&quot;, unreadTargettedCount);</span>
<a href="#l7.253"></a><span id="l7.253">       this._notifiedUnreadCount = unreadTargettedCount;</span>
<a href="#l7.254"></a><span id="l7.254">     }</span>
<a href="#l7.255"></a><span id="l7.255">   },</span>
<a href="#l7.256"></a><span id="l7.256"> </span>
<a href="#l7.257"></a><span id="l7.257" class="difflineminus">-  countUnreadMessages: function() {</span>
<a href="#l7.258"></a><span id="l7.258" class="difflineplus">+  countUnreadMessages() {</span>
<a href="#l7.259"></a><span id="l7.259">     let convs = imServices.conversations.getUIConversations();</span>
<a href="#l7.260"></a><span id="l7.260">     let unreadTargettedCount = 0;</span>
<a href="#l7.261"></a><span id="l7.261">     let unreadTotalCount = 0;</span>
<a href="#l7.262"></a><span id="l7.262">     for (let conv of convs) {</span>
<a href="#l7.263"></a><span id="l7.263">       unreadTargettedCount += conv.unreadTargetedMessageCount;</span>
<a href="#l7.264"></a><span id="l7.264">       unreadTotalCount += conv.unreadIncomingMessageCount;</span>
<a href="#l7.265"></a><span id="l7.265">     }</span>
<a href="#l7.266"></a><span id="l7.266">     return [unreadTargettedCount, unreadTotalCount];</span>
<a href="#l7.267"></a><span id="l7.267">   },</span>
<a href="#l7.268"></a><span id="l7.268"> </span>
<a href="#l7.269"></a><span id="l7.269" class="difflineminus">-  updateTitle: function() {</span>
<a href="#l7.270"></a><span id="l7.270" class="difflineplus">+  updateTitle() {</span>
<a href="#l7.271"></a><span id="l7.271">     if (!gChatTab)</span>
<a href="#l7.272"></a><span id="l7.272">       return;</span>
<a href="#l7.273"></a><span id="l7.273"> </span>
<a href="#l7.274"></a><span id="l7.274">     let title =</span>
<a href="#l7.275"></a><span id="l7.275">       document.getElementById(&quot;chatBundle&quot;).getString(&quot;chatTabTitle&quot;);</span>
<a href="#l7.276"></a><span id="l7.276">     let [unreadTargettedCount] = this.countUnreadMessages();</span>
<a href="#l7.277"></a><span id="l7.277">     if (unreadTargettedCount) {</span>
<a href="#l7.278"></a><span id="l7.278">       title += &quot; (&quot; + unreadTargettedCount + &quot;)&quot;;</span>
<a href="#l7.279"></a><span id="l7.279" class="difflineat">@@ -362,47 +361,47 @@ var chatHandler = {</span>
<a href="#l7.280"></a><span id="l7.280">       if (selectedItem &amp;&amp; selectedItem.localName == &quot;imconv&quot; &amp;&amp;</span>
<a href="#l7.281"></a><span id="l7.281">           !selectedItem.hidden)</span>
<a href="#l7.282"></a><span id="l7.282">         title += &quot; - &quot; + selectedItem.getAttribute(&quot;displayname&quot;);</span>
<a href="#l7.283"></a><span id="l7.283">     }</span>
<a href="#l7.284"></a><span id="l7.284">     gChatTab.title = title;</span>
<a href="#l7.285"></a><span id="l7.285">     document.getElementById(&quot;tabmail&quot;).setTabTitle(gChatTab);</span>
<a href="#l7.286"></a><span id="l7.286">   },</span>
<a href="#l7.287"></a><span id="l7.287"> </span>
<a href="#l7.288"></a><span id="l7.288" class="difflineminus">-  onConvResize: function() {</span>
<a href="#l7.289"></a><span id="l7.289" class="difflineplus">+  onConvResize() {</span>
<a href="#l7.290"></a><span id="l7.290">     let convDeck = document.getElementById(&quot;conversationsDeck&quot;);</span>
<a href="#l7.291"></a><span id="l7.291">     let panel = convDeck.selectedPanel;</span>
<a href="#l7.292"></a><span id="l7.292">     if (panel &amp;&amp; panel.localName == &quot;imconversation&quot;)</span>
<a href="#l7.293"></a><span id="l7.293">       panel.onConvResize();</span>
<a href="#l7.294"></a><span id="l7.294">   },</span>
<a href="#l7.295"></a><span id="l7.295"> </span>
<a href="#l7.296"></a><span id="l7.296" class="difflineminus">-  setStatusMenupopupCommand: function(aEvent) {</span>
<a href="#l7.297"></a><span id="l7.297" class="difflineplus">+  setStatusMenupopupCommand(aEvent) {</span>
<a href="#l7.298"></a><span id="l7.298">     let target = aEvent.originalTarget;</span>
<a href="#l7.299"></a><span id="l7.299">     if (target.getAttribute(&quot;id&quot;) == &quot;imStatusShowAccounts&quot; ||</span>
<a href="#l7.300"></a><span id="l7.300">         target.getAttribute(&quot;id&quot;) == &quot;appmenu_imStatusShowAccounts&quot;) {</span>
<a href="#l7.301"></a><span id="l7.301">       openIMAccountMgr();</span>
<a href="#l7.302"></a><span id="l7.302">       return;</span>
<a href="#l7.303"></a><span id="l7.303">     }</span>
<a href="#l7.304"></a><span id="l7.304"> </span>
<a href="#l7.305"></a><span id="l7.305">     let status = target.getAttribute(&quot;status&quot;);</span>
<a href="#l7.306"></a><span id="l7.306">     if (!status)</span>
<a href="#l7.307"></a><span id="l7.307">       return; // Can status really be null? Maybe because of an add-on...</span>
<a href="#l7.308"></a><span id="l7.308"> </span>
<a href="#l7.309"></a><span id="l7.309">     let us = imServices.core.globalUserStatus;</span>
<a href="#l7.310"></a><span id="l7.310">     us.setStatus(Status.toFlag(status), us.statusText);</span>
<a href="#l7.311"></a><span id="l7.311">   },</span>
<a href="#l7.312"></a><span id="l7.312"> </span>
<a href="#l7.313"></a><span id="l7.313">   _pendingLogBrowserLoad: false,</span>
<a href="#l7.314"></a><span id="l7.314" class="difflineminus">-  _showLogPanel: function() {</span>
<a href="#l7.315"></a><span id="l7.315" class="difflineplus">+  _showLogPanel() {</span>
<a href="#l7.316"></a><span id="l7.316">     document.getElementById(&quot;conversationsDeck&quot;).selectedPanel =</span>
<a href="#l7.317"></a><span id="l7.317">       document.getElementById(&quot;logDisplay&quot;);</span>
<a href="#l7.318"></a><span id="l7.318">     document.getElementById(&quot;logDisplayDeck&quot;).selectedPanel =</span>
<a href="#l7.319"></a><span id="l7.319">       document.getElementById(&quot;logDisplayBrowserBox&quot;);</span>
<a href="#l7.320"></a><span id="l7.320">   },</span>
<a href="#l7.321"></a><span id="l7.321" class="difflineminus">-  _showLog: function(aConversation, aSearchTerm) {</span>
<a href="#l7.322"></a><span id="l7.322" class="difflineplus">+  _showLog(aConversation, aSearchTerm) {</span>
<a href="#l7.323"></a><span id="l7.323">     if (!aConversation)</span>
<a href="#l7.324"></a><span id="l7.324">       return;</span>
<a href="#l7.325"></a><span id="l7.325">     this._showLogPanel();</span>
<a href="#l7.326"></a><span id="l7.326">     let browser = document.getElementById(&quot;conv-log-browser&quot;);</span>
<a href="#l7.327"></a><span id="l7.327">     browser._autoScrollEnabled = false;</span>
<a href="#l7.328"></a><span id="l7.328">     if (this._pendingLogBrowserLoad) {</span>
<a href="#l7.329"></a><span id="l7.329">       browser._conv = aConversation;</span>
<a href="#l7.330"></a><span id="l7.330">       return;</span>
<a href="#l7.331"></a><span id="l7.331" class="difflineat">@@ -454,17 +453,17 @@ var chatHandler = {</span>
<a href="#l7.332"></a><span id="l7.332">    * Display a list of logs into a tree, and optionally handle a default selection.</span>
<a href="#l7.333"></a><span id="l7.333">    *</span>
<a href="#l7.334"></a><span id="l7.334">    * @param aLogs An nsISimpleEnumerator of imILog.</span>
<a href="#l7.335"></a><span id="l7.335">    * @param aShouldSelect Either a boolean (true means select the first log</span>
<a href="#l7.336"></a><span id="l7.336">    * of the list, false or undefined means don't mess with the selection) or a log</span>
<a href="#l7.337"></a><span id="l7.337">    * item that needs to be selected.</span>
<a href="#l7.338"></a><span id="l7.338">    * @returns true if there's at least one log in the list, false if empty.</span>
<a href="#l7.339"></a><span id="l7.339">    */</span>
<a href="#l7.340"></a><span id="l7.340" class="difflineminus">-  _showLogList: function(aLogs, aShouldSelect) {</span>
<a href="#l7.341"></a><span id="l7.341" class="difflineplus">+  _showLogList(aLogs, aShouldSelect) {</span>
<a href="#l7.342"></a><span id="l7.342">     let logTree = document.getElementById(&quot;logTree&quot;);</span>
<a href="#l7.343"></a><span id="l7.343">     let treeView = this._treeView = new chatLogTreeView(logTree, aLogs);</span>
<a href="#l7.344"></a><span id="l7.344">     if (!treeView._rowMap.length)</span>
<a href="#l7.345"></a><span id="l7.345">       return false;</span>
<a href="#l7.346"></a><span id="l7.346">     if (!aShouldSelect)</span>
<a href="#l7.347"></a><span id="l7.347">       return true;</span>
<a href="#l7.348"></a><span id="l7.348">     if (aShouldSelect === true) {</span>
<a href="#l7.349"></a><span id="l7.349">       // Select the first line.</span>
<a href="#l7.350"></a><span id="l7.350" class="difflineat">@@ -494,20 +493,20 @@ var chatHandler = {</span>
<a href="#l7.351"></a><span id="l7.351">              treeView._rowMap[index].log.time != logTime)</span>
<a href="#l7.352"></a><span id="l7.352">         ++index;</span>
<a href="#l7.353"></a><span id="l7.353">       if (treeView._rowMap[index].log.time == logTime) {</span>
<a href="#l7.354"></a><span id="l7.354">         logTree.view.selection.select(index);</span>
<a href="#l7.355"></a><span id="l7.355">         logTree.treeBoxObject.ensureRowIsVisible(index);</span>
<a href="#l7.356"></a><span id="l7.356">       }</span>
<a href="#l7.357"></a><span id="l7.357">       return true;</span>
<a href="#l7.358"></a><span id="l7.358">     }</span>
<a href="#l7.359"></a><span id="l7.359" class="difflineminus">-    throw(&quot;Couldn't find the log to select among the set of logs passed.&quot;);</span>
<a href="#l7.360"></a><span id="l7.360" class="difflineplus">+    throw &quot;Couldn't find the log to select among the set of logs passed.&quot;;</span>
<a href="#l7.361"></a><span id="l7.361">   },</span>
<a href="#l7.362"></a><span id="l7.362"> </span>
<a href="#l7.363"></a><span id="l7.363" class="difflineminus">-  onLogSelect: function() {</span>
<a href="#l7.364"></a><span id="l7.364" class="difflineplus">+  onLogSelect() {</span>
<a href="#l7.365"></a><span id="l7.365">     let selection = this._treeView.selection;</span>
<a href="#l7.366"></a><span id="l7.366">     let currentIndex = selection.currentIndex;</span>
<a href="#l7.367"></a><span id="l7.367">     // The current (focused) row may not be actually selected...</span>
<a href="#l7.368"></a><span id="l7.368">     if (!selection.isSelected(currentIndex))</span>
<a href="#l7.369"></a><span id="l7.369">       return;</span>
<a href="#l7.370"></a><span id="l7.370"> </span>
<a href="#l7.371"></a><span id="l7.371">     let log = this._treeView._rowMap[currentIndex].log;</span>
<a href="#l7.372"></a><span id="l7.372">     if (!log)</span>
<a href="#l7.373"></a><span id="l7.373" class="difflineat">@@ -517,57 +516,57 @@ var chatHandler = {</span>
<a href="#l7.374"></a><span id="l7.374">     if (list.selectedItem.getAttribute(&quot;id&quot;) != &quot;searchResultConv&quot;)</span>
<a href="#l7.375"></a><span id="l7.375">       document.getElementById(&quot;goToConversation&quot;).hidden = false;</span>
<a href="#l7.376"></a><span id="l7.376">     log.getConversation().then(aLogConv =&gt; {</span>
<a href="#l7.377"></a><span id="l7.377">       this._showLog(aLogConv);</span>
<a href="#l7.378"></a><span id="l7.378">     });</span>
<a href="#l7.379"></a><span id="l7.379">   },</span>
<a href="#l7.380"></a><span id="l7.380"> </span>
<a href="#l7.381"></a><span id="l7.381">   _contactObserver: {</span>
<a href="#l7.382"></a><span id="l7.382" class="difflineminus">-    observe: function(aSubject, aTopic, aData) {</span>
<a href="#l7.383"></a><span id="l7.383" class="difflineplus">+    observe(aSubject, aTopic, aData) {</span>
<a href="#l7.384"></a><span id="l7.384">       if (aTopic == &quot;contact-status-changed&quot; ||</span>
<a href="#l7.385"></a><span id="l7.385">           aTopic == &quot;contact-display-name-changed&quot; ||</span>
<a href="#l7.386"></a><span id="l7.386">           aTopic == &quot;contact-icon-changed&quot;)</span>
<a href="#l7.387"></a><span id="l7.387">         chatHandler.showContactInfo(aSubject);</span>
<a href="#l7.388"></a><span id="l7.388" class="difflineminus">-    }</span>
<a href="#l7.389"></a><span id="l7.389" class="difflineplus">+    },</span>
<a href="#l7.390"></a><span id="l7.390">   },</span>
<a href="#l7.391"></a><span id="l7.391">   _observedContact: null,</span>
<a href="#l7.392"></a><span id="l7.392">   get observedContact() { return this._observedContact; },</span>
<a href="#l7.393"></a><span id="l7.393">   set observedContact(aContact) {</span>
<a href="#l7.394"></a><span id="l7.394">     if (aContact == this._observedContact)</span>
<a href="#l7.395"></a><span id="l7.395">       return aContact;</span>
<a href="#l7.396"></a><span id="l7.396">     if (this._observedContact) {</span>
<a href="#l7.397"></a><span id="l7.397">       this._observedContact.removeObserver(this._contactObserver);</span>
<a href="#l7.398"></a><span id="l7.398">       delete this._observedContact;</span>
<a href="#l7.399"></a><span id="l7.399">     }</span>
<a href="#l7.400"></a><span id="l7.400">     this._observedContact = aContact;</span>
<a href="#l7.401"></a><span id="l7.401">     if (aContact)</span>
<a href="#l7.402"></a><span id="l7.402">       aContact.addObserver(this._contactObserver);</span>
<a href="#l7.403"></a><span id="l7.403">     return aContact;</span>
<a href="#l7.404"></a><span id="l7.404">   },</span>
<a href="#l7.405"></a><span id="l7.405" class="difflineminus">-  showCurrentConversation: function() {</span>
<a href="#l7.406"></a><span id="l7.406" class="difflineplus">+  showCurrentConversation() {</span>
<a href="#l7.407"></a><span id="l7.407">     let item = document.getElementById(&quot;contactlistbox&quot;).selectedItem;</span>
<a href="#l7.408"></a><span id="l7.408">     if (!item)</span>
<a href="#l7.409"></a><span id="l7.409">       return;</span>
<a href="#l7.410"></a><span id="l7.410">     if (item.localName == &quot;imconv&quot;) {</span>
<a href="#l7.411"></a><span id="l7.411">       document.getElementById(&quot;conversationsDeck&quot;).selectedPanel = item.convView;</span>
<a href="#l7.412"></a><span id="l7.412">       document.getElementById(&quot;logTree&quot;).view.selection.clearSelection();</span>
<a href="#l7.413"></a><span id="l7.413">       item.convView.focus();</span>
<a href="#l7.414"></a><span id="l7.414" class="difflineminus">-    }</span>
<a href="#l7.415"></a><span id="l7.415" class="difflineminus">-    else if (item.localName == &quot;imcontact&quot;)</span>
<a href="#l7.416"></a><span id="l7.416" class="difflineplus">+    } else if (item.localName == &quot;imcontact&quot;) {</span>
<a href="#l7.417"></a><span id="l7.417">       item.openConversation();</span>
<a href="#l7.418"></a><span id="l7.418" class="difflineplus">+    }</span>
<a href="#l7.419"></a><span id="l7.419">   },</span>
<a href="#l7.420"></a><span id="l7.420" class="difflineminus">-  focusConversation: function(aUIConv) {</span>
<a href="#l7.421"></a><span id="l7.421" class="difflineplus">+  focusConversation(aUIConv) {</span>
<a href="#l7.422"></a><span id="l7.422">     let conv =</span>
<a href="#l7.423"></a><span id="l7.423">       document.getElementById(&quot;conversationsGroup&quot;).contactsById[aUIConv.id];</span>
<a href="#l7.424"></a><span id="l7.424">     document.getElementById(&quot;contactlistbox&quot;).selectedItem = conv;</span>
<a href="#l7.425"></a><span id="l7.425">     if (conv.convView)</span>
<a href="#l7.426"></a><span id="l7.426">       conv.convView.focus();</span>
<a href="#l7.427"></a><span id="l7.427">   },</span>
<a href="#l7.428"></a><span id="l7.428" class="difflineminus">-  showContactInfo: function(aContact) {</span>
<a href="#l7.429"></a><span id="l7.429" class="difflineplus">+  showContactInfo(aContact) {</span>
<a href="#l7.430"></a><span id="l7.430">     let cti = document.getElementById(&quot;conv-top-info&quot;);</span>
<a href="#l7.431"></a><span id="l7.431">     cti.setAttribute(&quot;userIcon&quot;, aContact.buddyIconFilename);</span>
<a href="#l7.432"></a><span id="l7.432">     cti.setAttribute(&quot;displayName&quot;, aContact.displayName);</span>
<a href="#l7.433"></a><span id="l7.433">     let proto = aContact.preferredBuddy.protocol;</span>
<a href="#l7.434"></a><span id="l7.434">     cti.setAttribute(&quot;prplIcon&quot;, proto.iconBaseURI + &quot;icon.png&quot;);</span>
<a href="#l7.435"></a><span id="l7.435">     let statusText = aContact.statusText;</span>
<a href="#l7.436"></a><span id="l7.436">     let statusType = aContact.statusType;</span>
<a href="#l7.437"></a><span id="l7.437">     if (statusText)</span>
<a href="#l7.438"></a><span id="l7.438" class="difflineat">@@ -584,29 +583,29 @@ var chatHandler = {</span>
<a href="#l7.439"></a><span id="l7.439">     cti.removeAttribute(&quot;noTopic&quot;);</span>
<a href="#l7.440"></a><span id="l7.440"> </span>
<a href="#l7.441"></a><span id="l7.441">     let bundle = document.getElementById(&quot;chatBundle&quot;);</span>
<a href="#l7.442"></a><span id="l7.442">     let button = document.getElementById(&quot;goToConversation&quot;);</span>
<a href="#l7.443"></a><span id="l7.443">     button.label = bundle.getFormattedString(&quot;startAConversationWith.button&quot;,</span>
<a href="#l7.444"></a><span id="l7.444">                                              [aContact.displayName]);</span>
<a href="#l7.445"></a><span id="l7.445">     button.disabled = !aContact.canSendMessage;</span>
<a href="#l7.446"></a><span id="l7.446">   },</span>
<a href="#l7.447"></a><span id="l7.447" class="difflineminus">-  _hideContextPane: function(aHide) {</span>
<a href="#l7.448"></a><span id="l7.448" class="difflineplus">+  _hideContextPane(aHide) {</span>
<a href="#l7.449"></a><span id="l7.449">     document.getElementById(&quot;contextSplitter&quot;).hidden = aHide;</span>
<a href="#l7.450"></a><span id="l7.450">     document.getElementById(&quot;contextPane&quot;).hidden = aHide;</span>
<a href="#l7.451"></a><span id="l7.451">   },</span>
<a href="#l7.452"></a><span id="l7.452" class="difflineminus">-  onListItemClick: function(aEvent) {</span>
<a href="#l7.453"></a><span id="l7.453" class="difflineplus">+  onListItemClick(aEvent) {</span>
<a href="#l7.454"></a><span id="l7.454">     // We only care about single clicks of the left button.</span>
<a href="#l7.455"></a><span id="l7.455">     if (aEvent.button != 0 || aEvent.detail != 1)</span>
<a href="#l7.456"></a><span id="l7.456">       return;</span>
<a href="#l7.457"></a><span id="l7.457">     let item = document.getElementById(&quot;contactlistbox&quot;).selectedItem;</span>
<a href="#l7.458"></a><span id="l7.458">     if (item.localName == &quot;imconv&quot; &amp;&amp; item.convView)</span>
<a href="#l7.459"></a><span id="l7.459">       item.convView.focus();</span>
<a href="#l7.460"></a><span id="l7.460">   },</span>
<a href="#l7.461"></a><span id="l7.461" class="difflineminus">-  onListItemSelected: function() {</span>
<a href="#l7.462"></a><span id="l7.462" class="difflineplus">+  onListItemSelected() {</span>
<a href="#l7.463"></a><span id="l7.463">     let contactlistbox = document.getElementById(&quot;contactlistbox&quot;);</span>
<a href="#l7.464"></a><span id="l7.464">     let item = contactlistbox.selectedItem;</span>
<a href="#l7.465"></a><span id="l7.465">     if (!item || item.hidden || item.localName == &quot;imgroup&quot;) {</span>
<a href="#l7.466"></a><span id="l7.466">       this._hideContextPane(true);</span>
<a href="#l7.467"></a><span id="l7.467">       document.getElementById(&quot;conversationsDeck&quot;).selectedPanel =</span>
<a href="#l7.468"></a><span id="l7.468">         document.getElementById(&quot;noConvScreen&quot;);</span>
<a href="#l7.469"></a><span id="l7.469">       this.updateTitle();</span>
<a href="#l7.470"></a><span id="l7.470">       this.observedContact = null;</span>
<a href="#l7.471"></a><span id="l7.471" class="difflineat">@@ -635,65 +634,64 @@ var chatHandler = {</span>
<a href="#l7.472"></a><span id="l7.472">       imServices.logs.getLogFromFile(path, true).then(aLog =&gt; {</span>
<a href="#l7.473"></a><span id="l7.473">         imServices.logs.getSimilarLogs(aLog, true).then(aSimilarLogs =&gt; {</span>
<a href="#l7.474"></a><span id="l7.474">           if (contactlistbox.selectedItem != item)</span>
<a href="#l7.475"></a><span id="l7.475">             return;</span>
<a href="#l7.476"></a><span id="l7.476">           this._pendingSearchTerm = item.searchTerm || undefined;</span>
<a href="#l7.477"></a><span id="l7.477">           this._showLogList(aSimilarLogs, aLog);</span>
<a href="#l7.478"></a><span id="l7.478">         });</span>
<a href="#l7.479"></a><span id="l7.479">       });</span>
<a href="#l7.480"></a><span id="l7.480" class="difflineminus">-    }</span>
<a href="#l7.481"></a><span id="l7.481" class="difflineminus">-    else if (item.localName == &quot;imconv&quot;) {</span>
<a href="#l7.482"></a><span id="l7.482" class="difflineplus">+    } else if (item.localName == &quot;imconv&quot;) {</span>
<a href="#l7.483"></a><span id="l7.483">       let convDeck = document.getElementById(&quot;conversationsDeck&quot;);</span>
<a href="#l7.484"></a><span id="l7.484">       if (!item.convView) {</span>
<a href="#l7.485"></a><span id="l7.485">         // Create new conversation binding.</span>
<a href="#l7.486"></a><span id="l7.486">         let conv = document.createElement(&quot;imconversation&quot;);</span>
<a href="#l7.487"></a><span id="l7.487">         convDeck.appendChild(conv);</span>
<a href="#l7.488"></a><span id="l7.488">         conv.conv = item.conv;</span>
<a href="#l7.489"></a><span id="l7.489">         conv.tab = item;</span>
<a href="#l7.490"></a><span id="l7.490">         conv.setAttribute(&quot;contentcontextmenu&quot;, &quot;chatConversationContextMenu&quot;);</span>
<a href="#l7.491"></a><span id="l7.491">         conv.setAttribute(&quot;contenttooltip&quot;, &quot;imTooltip&quot;);</span>
<a href="#l7.492"></a><span id="l7.492">         item.convView = conv;</span>
<a href="#l7.493"></a><span id="l7.493">         document.getElementById(&quot;contextSplitter&quot;).hidden = false;</span>
<a href="#l7.494"></a><span id="l7.494">         document.getElementById(&quot;contextPane&quot;).hidden = false;</span>
<a href="#l7.495"></a><span id="l7.495" class="difflineplus">+      } else {</span>
<a href="#l7.496"></a><span id="l7.496" class="difflineplus">+        item.convView.onConvResize();</span>
<a href="#l7.497"></a><span id="l7.497">       }</span>
<a href="#l7.498"></a><span id="l7.498" class="difflineminus">-      else</span>
<a href="#l7.499"></a><span id="l7.499" class="difflineminus">-        item.convView.onConvResize();</span>
<a href="#l7.500"></a><span id="l7.500"> </span>
<a href="#l7.501"></a><span id="l7.501">       convDeck.selectedPanel = item.convView;</span>
<a href="#l7.502"></a><span id="l7.502">       item.convView.updateConvStatus();</span>
<a href="#l7.503"></a><span id="l7.503">       item.update();</span>
<a href="#l7.504"></a><span id="l7.504"> </span>
<a href="#l7.505"></a><span id="l7.505">       imServices.logs.getLogsForConversation(item.conv, true).then(aLogs =&gt; {</span>
<a href="#l7.506"></a><span id="l7.506">         if (contactlistbox.selectedItem != item)</span>
<a href="#l7.507"></a><span id="l7.507">           return;</span>
<a href="#l7.508"></a><span id="l7.508">         this._showLogList(aLogs);</span>
<a href="#l7.509"></a><span id="l7.509">       });</span>
<a href="#l7.510"></a><span id="l7.510"> </span>
<a href="#l7.511"></a><span id="l7.511">       let contextPane = document.getElementById(&quot;contextPane&quot;);</span>
<a href="#l7.512"></a><span id="l7.512">       if (item.conv.isChat) {</span>
<a href="#l7.513"></a><span id="l7.513">         contextPane.setAttribute(&quot;chat&quot;, &quot;true&quot;);</span>
<a href="#l7.514"></a><span id="l7.514">         item.convView.showParticipants();</span>
<a href="#l7.515"></a><span id="l7.515" class="difflineplus">+      } else {</span>
<a href="#l7.516"></a><span id="l7.516" class="difflineplus">+        contextPane.removeAttribute(&quot;chat&quot;);</span>
<a href="#l7.517"></a><span id="l7.517">       }</span>
<a href="#l7.518"></a><span id="l7.518" class="difflineminus">-      else</span>
<a href="#l7.519"></a><span id="l7.519" class="difflineminus">-        contextPane.removeAttribute(&quot;chat&quot;);</span>
<a href="#l7.520"></a><span id="l7.520"> </span>
<a href="#l7.521"></a><span id="l7.521">       let button = document.getElementById(&quot;goToConversation&quot;);</span>
<a href="#l7.522"></a><span id="l7.522">       let bundle = document.getElementById(&quot;chatBundle&quot;);</span>
<a href="#l7.523"></a><span id="l7.523">       button.label = bundle.getString(&quot;goBackToCurrentConversation.button&quot;);</span>
<a href="#l7.524"></a><span id="l7.524">       button.disabled = false;</span>
<a href="#l7.525"></a><span id="l7.525">       this.observedContact = null;</span>
<a href="#l7.526"></a><span id="l7.526" class="difflineminus">-    }</span>
<a href="#l7.527"></a><span id="l7.527" class="difflineminus">-    else if (item.localName == &quot;imcontact&quot;) {</span>
<a href="#l7.528"></a><span id="l7.528" class="difflineplus">+    } else if (item.localName == &quot;imcontact&quot;) {</span>
<a href="#l7.529"></a><span id="l7.529">       let contact = item.contact;</span>
<a href="#l7.530"></a><span id="l7.530">       if (this.observedContact &amp;&amp; contact &amp;&amp;</span>
<a href="#l7.531"></a><span id="l7.531" class="difflineminus">-          this.observedContact.id == contact.id)</span>
<a href="#l7.532"></a><span id="l7.532" class="difflineplus">+          this.observedContact.id == contact.id) {</span>
<a href="#l7.533"></a><span id="l7.533">         return; // onselect has just been fired again because a status</span>
<a href="#l7.534"></a><span id="l7.534">                 // change caused the imcontact to move.</span>
<a href="#l7.535"></a><span id="l7.535">                 // Return early to avoid flickering and changing the selected log.</span>
<a href="#l7.536"></a><span id="l7.536" class="difflineplus">+      }</span>
<a href="#l7.537"></a><span id="l7.537"> </span>
<a href="#l7.538"></a><span id="l7.538">       this.showContactInfo(contact);</span>
<a href="#l7.539"></a><span id="l7.539">       this.observedContact = contact;</span>
<a href="#l7.540"></a><span id="l7.540"> </span>
<a href="#l7.541"></a><span id="l7.541">       document.getElementById(&quot;contextPane&quot;).removeAttribute(&quot;chat&quot;);</span>
<a href="#l7.542"></a><span id="l7.542"> </span>
<a href="#l7.543"></a><span id="l7.543">       imServices.logs.getLogsForContact(contact, true).then(aLogs =&gt; {</span>
<a href="#l7.544"></a><span id="l7.544">         if (contactlistbox.selectedItem != item)</span>
<a href="#l7.545"></a><span id="l7.545" class="difflineat">@@ -704,31 +702,31 @@ var chatHandler = {</span>
<a href="#l7.546"></a><span id="l7.546">           document.getElementById(&quot;logDisplayDeck&quot;).selectedPanel =</span>
<a href="#l7.547"></a><span id="l7.547">             document.getElementById(&quot;noPreviousConvScreen&quot;);</span>
<a href="#l7.548"></a><span id="l7.548">         }</span>
<a href="#l7.549"></a><span id="l7.549">       });</span>
<a href="#l7.550"></a><span id="l7.550">     }</span>
<a href="#l7.551"></a><span id="l7.551">     this.updateTitle();</span>
<a href="#l7.552"></a><span id="l7.552">   },</span>
<a href="#l7.553"></a><span id="l7.553"> </span>
<a href="#l7.554"></a><span id="l7.554" class="difflineminus">-  onNickClick: function(aEvent) {</span>
<a href="#l7.555"></a><span id="l7.555" class="difflineplus">+  onNickClick(aEvent) {</span>
<a href="#l7.556"></a><span id="l7.556">     // Open a private conversation only for a middle or double click.</span>
<a href="#l7.557"></a><span id="l7.557">     if (aEvent.button != 1 &amp;&amp; (aEvent.button != 0 || aEvent.detail != 2))</span>
<a href="#l7.558"></a><span id="l7.558">       return;</span>
<a href="#l7.559"></a><span id="l7.559"> </span>
<a href="#l7.560"></a><span id="l7.560">     let conv = document.getElementById(&quot;contactlistbox&quot;).selectedItem.conv;</span>
<a href="#l7.561"></a><span id="l7.561">     let nick = aEvent.originalTarget.chatBuddy.name;</span>
<a href="#l7.562"></a><span id="l7.562">     let name = conv.target.getNormalizedChatBuddyName(nick);</span>
<a href="#l7.563"></a><span id="l7.563">     try {</span>
<a href="#l7.564"></a><span id="l7.564">       let newconv = conv.account.createConversation(name);</span>
<a href="#l7.565"></a><span id="l7.565">       this.focusConversation(newconv);</span>
<a href="#l7.566"></a><span id="l7.566">     } catch (e) {}</span>
<a href="#l7.567"></a><span id="l7.567">   },</span>
<a href="#l7.568"></a><span id="l7.568"> </span>
<a href="#l7.569"></a><span id="l7.569" class="difflineminus">-  onNicklistKeyPress: function(aEvent) {</span>
<a href="#l7.570"></a><span id="l7.570" class="difflineplus">+  onNicklistKeyPress(aEvent) {</span>
<a href="#l7.571"></a><span id="l7.571">     if (aEvent.keyCode != aEvent.DOM_VK_RETURN)</span>
<a href="#l7.572"></a><span id="l7.572">       return;</span>
<a href="#l7.573"></a><span id="l7.573"> </span>
<a href="#l7.574"></a><span id="l7.574">     let listbox = aEvent.originalTarget;</span>
<a href="#l7.575"></a><span id="l7.575">     if (listbox.selectedCount == 0)</span>
<a href="#l7.576"></a><span id="l7.576">       return;</span>
<a href="#l7.577"></a><span id="l7.577"> </span>
<a href="#l7.578"></a><span id="l7.578">     let conv = document.getElementById(&quot;contactlistbox&quot;).selectedItem.conv;</span>
<a href="#l7.579"></a><span id="l7.579" class="difflineat">@@ -740,31 +738,31 @@ var chatHandler = {</span>
<a href="#l7.580"></a><span id="l7.580">         newconv = conv.account.createConversation(name);</span>
<a href="#l7.581"></a><span id="l7.581">       } catch (e) {}</span>
<a href="#l7.582"></a><span id="l7.582">     }</span>
<a href="#l7.583"></a><span id="l7.583">     // Only focus last of the opened conversations.</span>
<a href="#l7.584"></a><span id="l7.584">     if (newconv)</span>
<a href="#l7.585"></a><span id="l7.585">       this.focusConversation(newconv);</span>
<a href="#l7.586"></a><span id="l7.586">   },</span>
<a href="#l7.587"></a><span id="l7.587"> </span>
<a href="#l7.588"></a><span id="l7.588" class="difflineminus">-  _openDialog: function(aType) {</span>
<a href="#l7.589"></a><span id="l7.589" class="difflineplus">+  _openDialog(aType) {</span>
<a href="#l7.590"></a><span id="l7.590">     let features = &quot;chrome,modal,titlebar,centerscreen&quot;;</span>
<a href="#l7.591"></a><span id="l7.591">     window.openDialog(&quot;chrome://messenger/content/chat/&quot; + aType + &quot;.xul&quot;, &quot;&quot;,</span>
<a href="#l7.592"></a><span id="l7.592">                       features);</span>
<a href="#l7.593"></a><span id="l7.593">   },</span>
<a href="#l7.594"></a><span id="l7.594" class="difflineminus">-  addBuddy: function() {</span>
<a href="#l7.595"></a><span id="l7.595" class="difflineplus">+  addBuddy() {</span>
<a href="#l7.596"></a><span id="l7.596">      this._openDialog(&quot;addbuddy&quot;);</span>
<a href="#l7.597"></a><span id="l7.597">   },</span>
<a href="#l7.598"></a><span id="l7.598" class="difflineminus">-  joinChat: function() {</span>
<a href="#l7.599"></a><span id="l7.599" class="difflineplus">+  joinChat() {</span>
<a href="#l7.600"></a><span id="l7.600">     this._openDialog(&quot;joinchat&quot;);</span>
<a href="#l7.601"></a><span id="l7.601">   },</span>
<a href="#l7.602"></a><span id="l7.602"> </span>
<a href="#l7.603"></a><span id="l7.603">   _colorCache: {},</span>
<a href="#l7.604"></a><span id="l7.604">   // Duplicated code from imconversation.xml :-(</span>
<a href="#l7.605"></a><span id="l7.605" class="difflineminus">-  _computeColor: function(aName) {</span>
<a href="#l7.606"></a><span id="l7.606" class="difflineplus">+  _computeColor(aName) {</span>
<a href="#l7.607"></a><span id="l7.607">     if (Object.prototype.hasOwnProperty.call(this._colorCache, aName))</span>
<a href="#l7.608"></a><span id="l7.608">       return this._colorCache[aName];</span>
<a href="#l7.609"></a><span id="l7.609"> </span>
<a href="#l7.610"></a><span id="l7.610">     // Compute the color based on the nick</span>
<a href="#l7.611"></a><span id="l7.611">     var nick = aName.match(/[a-zA-Z0-9]+/);</span>
<a href="#l7.612"></a><span id="l7.612">     nick = nick ? nick[0].toLowerCase() : nick = aName;</span>
<a href="#l7.613"></a><span id="l7.613">     // We compute a hue value (between 0 and 359) based on the</span>
<a href="#l7.614"></a><span id="l7.614">     // characters of the nick.</span>
<a href="#l7.615"></a><span id="l7.615" class="difflineat">@@ -782,17 +780,17 @@ var chatHandler = {</span>
<a href="#l7.616"></a><span id="l7.616">       // now char contains a value between 1 and 36</span>
<a href="#l7.617"></a><span id="l7.617">       res += char * weight;</span>
<a href="#l7.618"></a><span id="l7.618">       weight *= kWeightReductionPerChar;</span>
<a href="#l7.619"></a><span id="l7.619">     }</span>
<a href="#l7.620"></a><span id="l7.620">     return (this._colorCache[aName] = Math.round(res) % 360);</span>
<a href="#l7.621"></a><span id="l7.621">   },</span>
<a href="#l7.622"></a><span id="l7.622"> </span>
<a href="#l7.623"></a><span id="l7.623">   _placeHolderButtonId: &quot;&quot;,</span>
<a href="#l7.624"></a><span id="l7.624" class="difflineminus">-  _updateNoConvPlaceHolder: function() {</span>
<a href="#l7.625"></a><span id="l7.625" class="difflineplus">+  _updateNoConvPlaceHolder() {</span>
<a href="#l7.626"></a><span id="l7.626">     let connected = false;</span>
<a href="#l7.627"></a><span id="l7.627">     let hasAccount = false;</span>
<a href="#l7.628"></a><span id="l7.628">     let canJoinChat = false;</span>
<a href="#l7.629"></a><span id="l7.629">     for (let account of fixIterator(imServices.accounts.getAccounts())) {</span>
<a href="#l7.630"></a><span id="l7.630">       hasAccount = true;</span>
<a href="#l7.631"></a><span id="l7.631">       if (account.connected) {</span>
<a href="#l7.632"></a><span id="l7.632">         connected = true;</span>
<a href="#l7.633"></a><span id="l7.633">         if (account.canJoinChat) {</span>
<a href="#l7.634"></a><span id="l7.634" class="difflineat">@@ -802,18 +800,17 @@ var chatHandler = {</span>
<a href="#l7.635"></a><span id="l7.635">       }</span>
<a href="#l7.636"></a><span id="l7.636">     }</span>
<a href="#l7.637"></a><span id="l7.637">     document.getElementById(&quot;noConvInnerBox&quot;).hidden = !connected;</span>
<a href="#l7.638"></a><span id="l7.638">     document.getElementById(&quot;noAccountInnerBox&quot;).hidden = hasAccount;</span>
<a href="#l7.639"></a><span id="l7.639">     document.getElementById(&quot;noConnectedAccountInnerBox&quot;).hidden =</span>
<a href="#l7.640"></a><span id="l7.640">       connected || !hasAccount;</span>
<a href="#l7.641"></a><span id="l7.641">     if (connected) {</span>
<a href="#l7.642"></a><span id="l7.642">       delete this._placeHolderButtonId;</span>
<a href="#l7.643"></a><span id="l7.643" class="difflineminus">-    }</span>
<a href="#l7.644"></a><span id="l7.644" class="difflineminus">-    else {</span>
<a href="#l7.645"></a><span id="l7.645" class="difflineplus">+    } else {</span>
<a href="#l7.646"></a><span id="l7.646">       this._placeHolderButtonId =</span>
<a href="#l7.647"></a><span id="l7.647">         hasAccount ? &quot;openIMAccountManagerButton&quot; : &quot;openIMAccountWizardButton&quot;;</span>
<a href="#l7.648"></a><span id="l7.648">     }</span>
<a href="#l7.649"></a><span id="l7.649">     for (let id of [&quot;statusTypeIcon&quot;, &quot;statusMessage&quot;, &quot;button-chat-accounts&quot;]) {</span>
<a href="#l7.650"></a><span id="l7.650">       let elt = document.getElementById(id);</span>
<a href="#l7.651"></a><span id="l7.651">       if (elt)</span>
<a href="#l7.652"></a><span id="l7.652">         elt.disabled = !hasAccount;</span>
<a href="#l7.653"></a><span id="l7.653">     }</span>
<a href="#l7.654"></a><span id="l7.654" class="difflineat">@@ -829,23 +826,22 @@ var chatHandler = {</span>
<a href="#l7.655"></a><span id="l7.655">       if (elt)</span>
<a href="#l7.656"></a><span id="l7.656">         elt.disabled = !canJoinChat;</span>
<a href="#l7.657"></a><span id="l7.657">     }</span>
<a href="#l7.658"></a><span id="l7.658">     let groupIds = [&quot;conversations&quot;, &quot;onlinecontacts&quot;, &quot;offlinecontacts&quot;];</span>
<a href="#l7.659"></a><span id="l7.659">     let contactlist = document.getElementById(&quot;contactlistbox&quot;);</span>
<a href="#l7.660"></a><span id="l7.660">     if (!hasAccount || !connected &amp;&amp; groupIds.every(id =&gt;</span>
<a href="#l7.661"></a><span id="l7.661">         document.getElementById(id + &quot;Group&quot;).contacts.length)) {</span>
<a href="#l7.662"></a><span id="l7.662">       contactlist.disabled = true;</span>
<a href="#l7.663"></a><span id="l7.663" class="difflineminus">-    }</span>
<a href="#l7.664"></a><span id="l7.664" class="difflineminus">-    else {</span>
<a href="#l7.665"></a><span id="l7.665" class="difflineplus">+    } else {</span>
<a href="#l7.666"></a><span id="l7.666">       contactlist.disabled = false;</span>
<a href="#l7.667"></a><span id="l7.667">       this._updateSelectedConversation();</span>
<a href="#l7.668"></a><span id="l7.668">     }</span>
<a href="#l7.669"></a><span id="l7.669">   },</span>
<a href="#l7.670"></a><span id="l7.670" class="difflineminus">-  _updateSelectedConversation: function() {</span>
<a href="#l7.671"></a><span id="l7.671" class="difflineplus">+  _updateSelectedConversation() {</span>
<a href="#l7.672"></a><span id="l7.672">     let list = document.getElementById(&quot;contactlistbox&quot;);</span>
<a href="#l7.673"></a><span id="l7.673">     // We can't select anything if there's no account.</span>
<a href="#l7.674"></a><span id="l7.674">     if (list.disabled)</span>
<a href="#l7.675"></a><span id="l7.675">       return;</span>
<a href="#l7.676"></a><span id="l7.676"> </span>
<a href="#l7.677"></a><span id="l7.677">     // If the selection is already a conversation with unread messages, keep it.</span>
<a href="#l7.678"></a><span id="l7.678">     let selectedItem = list.selectedItem;</span>
<a href="#l7.679"></a><span id="l7.679">     if (selectedItem &amp;&amp; selectedItem.localName == &quot;imconv&quot; &amp;&amp;</span>
<a href="#l7.680"></a><span id="l7.680" class="difflineat">@@ -885,17 +881,17 @@ var chatHandler = {</span>
<a href="#l7.681"></a><span id="l7.681">     for (let id of groupIds) {</span>
<a href="#l7.682"></a><span id="l7.682">       let item = document.getElementById(id + &quot;Group&quot;);</span>
<a href="#l7.683"></a><span id="l7.683">       if (item.collapsed)</span>
<a href="#l7.684"></a><span id="l7.684">         continue;</span>
<a href="#l7.685"></a><span id="l7.685">       list.selectedItem = item;</span>
<a href="#l7.686"></a><span id="l7.686">       return;</span>
<a href="#l7.687"></a><span id="l7.687">     }</span>
<a href="#l7.688"></a><span id="l7.688">   },</span>
<a href="#l7.689"></a><span id="l7.689" class="difflineminus">-  _updateFocus: function() {</span>
<a href="#l7.690"></a><span id="l7.690" class="difflineplus">+  _updateFocus() {</span>
<a href="#l7.691"></a><span id="l7.691">     let focusId = this._placeHolderButtonId || &quot;contactlistbox&quot;;</span>
<a href="#l7.692"></a><span id="l7.692">     document.getElementById(focusId).focus();</span>
<a href="#l7.693"></a><span id="l7.693">   },</span>
<a href="#l7.694"></a><span id="l7.694">   _getActiveConvView() {</span>
<a href="#l7.695"></a><span id="l7.695">     let list = document.getElementById(&quot;contactlistbox&quot;);</span>
<a href="#l7.696"></a><span id="l7.696">     if (list.disabled)</span>
<a href="#l7.697"></a><span id="l7.697">       return null;</span>
<a href="#l7.698"></a><span id="l7.698">     let selectedItem = list.selectedItem;</span>
<a href="#l7.699"></a><span id="l7.699" class="difflineat">@@ -911,17 +907,17 @@ var chatHandler = {</span>
<a href="#l7.700"></a><span id="l7.700">     if (convView)</span>
<a href="#l7.701"></a><span id="l7.701">       convView.switchingToPanel();</span>
<a href="#l7.702"></a><span id="l7.702">   },</span>
<a href="#l7.703"></a><span id="l7.703">   _onTabDeactivated() {</span>
<a href="#l7.704"></a><span id="l7.704">     let convView = chatHandler._getActiveConvView();</span>
<a href="#l7.705"></a><span id="l7.705">     if (convView)</span>
<a href="#l7.706"></a><span id="l7.706">       convView.switchingAwayFromPanel();</span>
<a href="#l7.707"></a><span id="l7.707">   },</span>
<a href="#l7.708"></a><span id="l7.708" class="difflineminus">-  observe: function(aSubject, aTopic, aData) {</span>
<a href="#l7.709"></a><span id="l7.709" class="difflineplus">+  observe(aSubject, aTopic, aData) {</span>
<a href="#l7.710"></a><span id="l7.710">     if (aTopic == &quot;chat-core-initialized&quot;) {</span>
<a href="#l7.711"></a><span id="l7.711">       this.initAfterChatCore();</span>
<a href="#l7.712"></a><span id="l7.712">       return;</span>
<a href="#l7.713"></a><span id="l7.713">     }</span>
<a href="#l7.714"></a><span id="l7.714"> </span>
<a href="#l7.715"></a><span id="l7.715">     if (aTopic == &quot;conversation-loaded&quot;) {</span>
<a href="#l7.716"></a><span id="l7.716">       let browser = document.getElementById(&quot;conv-log-browser&quot;);</span>
<a href="#l7.717"></a><span id="l7.717">       if (aSubject != browser)</span>
<a href="#l7.718"></a><span id="l7.718" class="difflineat">@@ -1019,22 +1015,22 @@ var chatHandler = {</span>
<a href="#l7.719"></a><span id="l7.719">       let bundle = document.getElementById(&quot;chatBundle&quot;);</span>
<a href="#l7.720"></a><span id="l7.720">       let label = bundle.getFormattedString(&quot;buddy.authRequest.label&quot;,</span>
<a href="#l7.721"></a><span id="l7.721">                                             [aSubject.userName]);</span>
<a href="#l7.722"></a><span id="l7.722">       let value =</span>
<a href="#l7.723"></a><span id="l7.723">         &quot;buddy-auth-request-&quot; + aSubject.account.id + aSubject.userName;</span>
<a href="#l7.724"></a><span id="l7.724">       let acceptButton = {</span>
<a href="#l7.725"></a><span id="l7.725">         accessKey: bundle.getString(&quot;buddy.authRequest.allow.accesskey&quot;),</span>
<a href="#l7.726"></a><span id="l7.726">         label: bundle.getString(&quot;buddy.authRequest.allow.label&quot;),</span>
<a href="#l7.727"></a><span id="l7.727" class="difflineminus">-        callback: function() { aSubject.grant(); }</span>
<a href="#l7.728"></a><span id="l7.728" class="difflineplus">+        callback() { aSubject.grant(); },</span>
<a href="#l7.729"></a><span id="l7.729">       };</span>
<a href="#l7.730"></a><span id="l7.730">       let denyButton = {</span>
<a href="#l7.731"></a><span id="l7.731">         accessKey: bundle.getString(&quot;buddy.authRequest.deny.accesskey&quot;),</span>
<a href="#l7.732"></a><span id="l7.732">         label: bundle.getString(&quot;buddy.authRequest.deny.label&quot;),</span>
<a href="#l7.733"></a><span id="l7.733" class="difflineminus">-        callback: function() { aSubject.deny(); }</span>
<a href="#l7.734"></a><span id="l7.734" class="difflineplus">+        callback() { aSubject.deny(); },</span>
<a href="#l7.735"></a><span id="l7.735">       };</span>
<a href="#l7.736"></a><span id="l7.736">       let box = document.getElementById(&quot;chatTabPanel&quot;);</span>
<a href="#l7.737"></a><span id="l7.737">       box.appendNotification(label, value, null, box.PRIORITY_INFO_HIGH,</span>
<a href="#l7.738"></a><span id="l7.738">                             [acceptButton, denyButton]);</span>
<a href="#l7.739"></a><span id="l7.739">       if (!gChatTab) {</span>
<a href="#l7.740"></a><span id="l7.740">         let tabmail = document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l7.741"></a><span id="l7.741">         tabmail.openTab(&quot;chat&quot;, {background: true});</span>
<a href="#l7.742"></a><span id="l7.742">       }</span>
<a href="#l7.743"></a><span id="l7.743" class="difflineat">@@ -1044,56 +1040,55 @@ var chatHandler = {</span>
<a href="#l7.744"></a><span id="l7.744">       aSubject.QueryInterface(Ci.prplIBuddyRequest);</span>
<a href="#l7.745"></a><span id="l7.745">       let value =</span>
<a href="#l7.746"></a><span id="l7.746">         &quot;buddy-auth-request-&quot; + aSubject.account.id + aSubject.userName;</span>
<a href="#l7.747"></a><span id="l7.747">       let notification =</span>
<a href="#l7.748"></a><span id="l7.748">         document.getElementById(&quot;chatTabPanel&quot;)</span>
<a href="#l7.749"></a><span id="l7.749">                 .getNotificationWithValue(value);</span>
<a href="#l7.750"></a><span id="l7.750">       if (notification)</span>
<a href="#l7.751"></a><span id="l7.751">         notification.close();</span>
<a href="#l7.752"></a><span id="l7.752" class="difflineminus">-      return;</span>
<a href="#l7.753"></a><span id="l7.753">     }</span>
<a href="#l7.754"></a><span id="l7.754">   },</span>
<a href="#l7.755"></a><span id="l7.755" class="difflineminus">-  initAfterChatCore: function() {</span>
<a href="#l7.756"></a><span id="l7.756" class="difflineplus">+  initAfterChatCore() {</span>
<a href="#l7.757"></a><span id="l7.757">     let onGroup = document.getElementById(&quot;onlinecontactsGroup&quot;);</span>
<a href="#l7.758"></a><span id="l7.758">     let offGroup = document.getElementById(&quot;offlinecontactsGroup&quot;);</span>
<a href="#l7.759"></a><span id="l7.759"> </span>
<a href="#l7.760"></a><span id="l7.760">     for (let name in chatHandler.allContacts) {</span>
<a href="#l7.761"></a><span id="l7.761">       let contact = chatHandler.allContacts[name];</span>
<a href="#l7.762"></a><span id="l7.762">       let group = contact.online ? onGroup : offGroup;</span>
<a href="#l7.763"></a><span id="l7.763">       group.addContact(contact);</span>
<a href="#l7.764"></a><span id="l7.764">     }</span>
<a href="#l7.765"></a><span id="l7.765"> </span>
<a href="#l7.766"></a><span id="l7.766">     onGroup._updateGroupLabel();</span>
<a href="#l7.767"></a><span id="l7.767">     offGroup._updateGroupLabel();</span>
<a href="#l7.768"></a><span id="l7.768"> </span>
<a href="#l7.769"></a><span id="l7.769">     [&quot;new-text&quot;, &quot;new-ui-conversation&quot;, &quot;ui-conversation-closed&quot;,</span>
<a href="#l7.770"></a><span id="l7.770">      &quot;contact-signed-on&quot;, &quot;contact-signed-off&quot;,</span>
<a href="#l7.771"></a><span id="l7.771">      &quot;contact-added&quot;, &quot;contact-removed&quot;, &quot;contact-no-longer-dummy&quot;,</span>
<a href="#l7.772"></a><span id="l7.772">      &quot;account-connected&quot;, &quot;account-disconnected&quot;,</span>
<a href="#l7.773"></a><span id="l7.773" class="difflineminus">-     &quot;account-added&quot;,&quot;account-removed&quot;</span>
<a href="#l7.774"></a><span id="l7.774" class="difflineplus">+     &quot;account-added&quot;, &quot;account-removed&quot;,</span>
<a href="#l7.775"></a><span id="l7.775">     ].forEach(chatHandler._addObserver);</span>
<a href="#l7.776"></a><span id="l7.776"> </span>
<a href="#l7.777"></a><span id="l7.777">     chatHandler._updateNoConvPlaceHolder();</span>
<a href="#l7.778"></a><span id="l7.778">     statusSelector.init();</span>
<a href="#l7.779"></a><span id="l7.779">   },</span>
<a href="#l7.780"></a><span id="l7.780">   _observedTopics: [],</span>
<a href="#l7.781"></a><span id="l7.781" class="difflineminus">-  _addObserver: function(aTopic) {</span>
<a href="#l7.782"></a><span id="l7.782" class="difflineplus">+  _addObserver(aTopic) {</span>
<a href="#l7.783"></a><span id="l7.783">     imServices.obs.addObserver(chatHandler, aTopic);</span>
<a href="#l7.784"></a><span id="l7.784">     chatHandler._observedTopics.push(aTopic);</span>
<a href="#l7.785"></a><span id="l7.785">   },</span>
<a href="#l7.786"></a><span id="l7.786" class="difflineminus">-  _removeObservers: function() {</span>
<a href="#l7.787"></a><span id="l7.787" class="difflineplus">+  _removeObservers() {</span>
<a href="#l7.788"></a><span id="l7.788">     for (let topic of this._observedTopics)</span>
<a href="#l7.789"></a><span id="l7.789">       imServices.obs.removeObserver(this, topic);</span>
<a href="#l7.790"></a><span id="l7.790">   },</span>
<a href="#l7.791"></a><span id="l7.791">   // TODO move this function away from here and test it.</span>
<a href="#l7.792"></a><span id="l7.792">   _getNextUnreadConversation(aConversations, aCurrent, aReverse) {</span>
<a href="#l7.793"></a><span id="l7.793">     let convCount = aConversations.length;</span>
<a href="#l7.794"></a><span id="l7.794">     if (!convCount)</span>
<a href="#l7.795"></a><span id="l7.795" class="difflineminus">-      return;</span>
<a href="#l7.796"></a><span id="l7.796" class="difflineplus">+      return -1;</span>
<a href="#l7.797"></a><span id="l7.797"> </span>
<a href="#l7.798"></a><span id="l7.798">     let direction = aReverse ? -1 : 1;</span>
<a href="#l7.799"></a><span id="l7.799">     let next = (i) =&gt; {</span>
<a href="#l7.800"></a><span id="l7.800">       i += direction;</span>
<a href="#l7.801"></a><span id="l7.801">       if (i &lt; 0)</span>
<a href="#l7.802"></a><span id="l7.802">         return i + convCount;</span>
<a href="#l7.803"></a><span id="l7.803">       if (i &gt;= convCount)</span>
<a href="#l7.804"></a><span id="l7.804">         return i - convCount;</span>
<a href="#l7.805"></a><span id="l7.805" class="difflineat">@@ -1125,17 +1120,17 @@ var chatHandler = {</span>
<a href="#l7.806"></a><span id="l7.806">     let rawConversations = conversations.map((c) =&gt; c.conv);</span>
<a href="#l7.807"></a><span id="l7.807">     let current;</span>
<a href="#l7.808"></a><span id="l7.808">     if (aList.selectedItem.localName === &quot;imconv&quot;)</span>
<a href="#l7.809"></a><span id="l7.809">       current = aList.selectedIndex - aList.getIndexOfItem(conversations[0]);</span>
<a href="#l7.810"></a><span id="l7.810">     let newIndex = this._getNextUnreadConversation(rawConversations, current, aReverse);</span>
<a href="#l7.811"></a><span id="l7.811">     if (newIndex !== -1)</span>
<a href="#l7.812"></a><span id="l7.812">       aList.selectedItem = conversations[newIndex];</span>
<a href="#l7.813"></a><span id="l7.813">   },</span>
<a href="#l7.814"></a><span id="l7.814" class="difflineminus">-  init: function() {</span>
<a href="#l7.815"></a><span id="l7.815" class="difflineplus">+  init() {</span>
<a href="#l7.816"></a><span id="l7.816">     Notifications.init();</span>
<a href="#l7.817"></a><span id="l7.817">     if (!Services.prefs.getBoolPref(&quot;mail.chat.enabled&quot;)) {</span>
<a href="#l7.818"></a><span id="l7.818">       [&quot;button-chat&quot;, &quot;menu_goChat&quot;, &quot;goChatSeparator&quot;,</span>
<a href="#l7.819"></a><span id="l7.819">        &quot;imAccountsStatus&quot;, &quot;joinChatMenuItem&quot;, &quot;newIMAccountMenuItem&quot;,</span>
<a href="#l7.820"></a><span id="l7.820">        &quot;newIMContactMenuItem&quot;, &quot;appmenu_joinChatMenuItem&quot;, &quot;appmenu_afterChatSeparator&quot;,</span>
<a href="#l7.821"></a><span id="l7.821">        &quot;appmenu_goChat&quot;, &quot;appmenu_imAccountsStatus&quot;, &quot;appmenu_goChatSeparator&quot;,</span>
<a href="#l7.822"></a><span id="l7.822">        &quot;appmenu_newIMAccountMenuItem&quot;, &quot;appmenu_newIMContactMenuItem&quot;].forEach(function(aId) {</span>
<a href="#l7.823"></a><span id="l7.823">          let elt = document.getElementById(aId);</span>
<a href="#l7.824"></a><span id="l7.824" class="difflineat">@@ -1191,48 +1186,48 @@ var chatHandler = {</span>
<a href="#l7.825"></a><span id="l7.825"> </span>
<a href="#l7.826"></a><span id="l7.826">     ChromeUtils.import(&quot;resource:///modules/chatHandler.jsm&quot;, this);</span>
<a href="#l7.827"></a><span id="l7.827">     if (this.ChatCore.initialized)</span>
<a href="#l7.828"></a><span id="l7.828">       this.initAfterChatCore();</span>
<a href="#l7.829"></a><span id="l7.829">     else {</span>
<a href="#l7.830"></a><span id="l7.830">       this.ChatCore.init();</span>
<a href="#l7.831"></a><span id="l7.831">       this._addObserver(&quot;chat-core-initialized&quot;);</span>
<a href="#l7.832"></a><span id="l7.832">     }</span>
<a href="#l7.833"></a><span id="l7.833" class="difflineminus">-  }</span>
<a href="#l7.834"></a><span id="l7.834" class="difflineplus">+  },</span>
<a href="#l7.835"></a><span id="l7.835"> };</span>
<a href="#l7.836"></a><span id="l7.836"> </span>
<a href="#l7.837"></a><span id="l7.837"> function chatLogTreeGroupItem(aTitle, aLogItems) {</span>
<a href="#l7.838"></a><span id="l7.838">   this._title = aTitle;</span>
<a href="#l7.839"></a><span id="l7.839">   this._children = aLogItems;</span>
<a href="#l7.840"></a><span id="l7.840">   for (let child of this._children)</span>
<a href="#l7.841"></a><span id="l7.841">     child._parent = this;</span>
<a href="#l7.842"></a><span id="l7.842">   this._open = false;</span>
<a href="#l7.843"></a><span id="l7.843"> }</span>
<a href="#l7.844"></a><span id="l7.844"> chatLogTreeGroupItem.prototype = {</span>
<a href="#l7.845"></a><span id="l7.845" class="difflineminus">-  getText: function() { return this._title; },</span>
<a href="#l7.846"></a><span id="l7.846" class="difflineplus">+  getText() { return this._title; },</span>
<a href="#l7.847"></a><span id="l7.847">   get id() { return this._title; },</span>
<a href="#l7.848"></a><span id="l7.848">   get open() { return this._open; },</span>
<a href="#l7.849"></a><span id="l7.849">   get level() { return 0; },</span>
<a href="#l7.850"></a><span id="l7.850">   get _parent() { return null; },</span>
<a href="#l7.851"></a><span id="l7.851">   get children() { return this._children; },</span>
<a href="#l7.852"></a><span id="l7.852" class="difflineminus">-  getProperties: function() { return &quot;&quot;; }</span>
<a href="#l7.853"></a><span id="l7.853" class="difflineplus">+  getProperties() { return &quot;&quot;; },</span>
<a href="#l7.854"></a><span id="l7.854"> };</span>
<a href="#l7.855"></a><span id="l7.855"> </span>
<a href="#l7.856"></a><span id="l7.856"> function chatLogTreeLogItem(aLog, aText, aLevel) {</span>
<a href="#l7.857"></a><span id="l7.857">   this.log = aLog;</span>
<a href="#l7.858"></a><span id="l7.858">   this._text = aText;</span>
<a href="#l7.859"></a><span id="l7.859">   this._level = aLevel;</span>
<a href="#l7.860"></a><span id="l7.860"> }</span>
<a href="#l7.861"></a><span id="l7.861"> chatLogTreeLogItem.prototype = {</span>
<a href="#l7.862"></a><span id="l7.862" class="difflineminus">-  getText: function() { return this._text; },</span>
<a href="#l7.863"></a><span id="l7.863" class="difflineplus">+  getText() { return this._text; },</span>
<a href="#l7.864"></a><span id="l7.864">   get id() { return this.log.title; },</span>
<a href="#l7.865"></a><span id="l7.865">   get open() { return false; },</span>
<a href="#l7.866"></a><span id="l7.866">   get level() { return this._level; },</span>
<a href="#l7.867"></a><span id="l7.867">   get children() { return []; },</span>
<a href="#l7.868"></a><span id="l7.868" class="difflineminus">-  getProperties: function() { return &quot;&quot;; }</span>
<a href="#l7.869"></a><span id="l7.869" class="difflineplus">+  getProperties() { return &quot;&quot;; },</span>
<a href="#l7.870"></a><span id="l7.870"> };</span>
<a href="#l7.871"></a><span id="l7.871"> </span>
<a href="#l7.872"></a><span id="l7.872"> function chatLogTreeView(aTree, aLogs) {</span>
<a href="#l7.873"></a><span id="l7.873">   this._tree = aTree;</span>
<a href="#l7.874"></a><span id="l7.874">   this._logs = aLogs;</span>
<a href="#l7.875"></a><span id="l7.875">   this._tree.view = this;</span>
<a href="#l7.876"></a><span id="l7.876">   this._rebuild();</span>
<a href="#l7.877"></a><span id="l7.877"> }</span>
<a href="#l7.878"></a><span id="l7.878" class="difflineat">@@ -1251,23 +1246,23 @@ chatLogTreeView.prototype = {</span>
<a href="#l7.879"></a><span id="l7.879">     this._rowMap = [];</span>
<a href="#l7.880"></a><span id="l7.880"> </span>
<a href="#l7.881"></a><span id="l7.881">     // Used to show the dates in the log list in the locale of the application.</span>
<a href="#l7.882"></a><span id="l7.882">     let chatBundle = document.getElementById(&quot;chatBundle&quot;);</span>
<a href="#l7.883"></a><span id="l7.883">     let dateFormatBundle = document.getElementById(&quot;bundle_dateformat&quot;);</span>
<a href="#l7.884"></a><span id="l7.884">     let placesBundle = document.getElementById(&quot;bundle_places&quot;);</span>
<a href="#l7.885"></a><span id="l7.885">     let formatDate = function(aDate) {</span>
<a href="#l7.886"></a><span id="l7.886">       const dateFormatter = new Services.intl.DateTimeFormat(undefined, {</span>
<a href="#l7.887"></a><span id="l7.887" class="difflineminus">-        dateStyle: &quot;short&quot;</span>
<a href="#l7.888"></a><span id="l7.888" class="difflineplus">+        dateStyle: &quot;short&quot;,</span>
<a href="#l7.889"></a><span id="l7.889">       });</span>
<a href="#l7.890"></a><span id="l7.890">       return dateFormatter.format(aDate);</span>
<a href="#l7.891"></a><span id="l7.891">     };</span>
<a href="#l7.892"></a><span id="l7.892">     let formatDateTime = function(aDate) {</span>
<a href="#l7.893"></a><span id="l7.893">       const dateTimeFormatter = new Services.intl.DateTimeFormat(undefined, {</span>
<a href="#l7.894"></a><span id="l7.894" class="difflineminus">-        dateStyle: &quot;short&quot;, timeStyle: &quot;short&quot;</span>
<a href="#l7.895"></a><span id="l7.895" class="difflineplus">+        dateStyle: &quot;short&quot;, timeStyle: &quot;short&quot;,</span>
<a href="#l7.896"></a><span id="l7.896">       });</span>
<a href="#l7.897"></a><span id="l7.897">       return dateTimeFormatter.format(aDate);</span>
<a href="#l7.898"></a><span id="l7.898">     };</span>
<a href="#l7.899"></a><span id="l7.899">     let formatMonthYear = function(aDate) {</span>
<a href="#l7.900"></a><span id="l7.900">       let month = formatMonth(aDate);</span>
<a href="#l7.901"></a><span id="l7.901">       return dateFormatBundle.getFormattedString(&quot;finduri-MonthYear&quot;,</span>
<a href="#l7.902"></a><span id="l7.902">                                                  [month, aDate.getFullYear()]);</span>
<a href="#l7.903"></a><span id="l7.903">     };</span>
<a href="#l7.904"></a><span id="l7.904" class="difflineat">@@ -1282,17 +1277,17 @@ chatLogTreeView.prototype = {</span>
<a href="#l7.905"></a><span id="l7.905"> </span>
<a href="#l7.906"></a><span id="l7.906">     // The keys used in the 'firstgroups' object should match string ids.</span>
<a href="#l7.907"></a><span id="l7.907">     // The order is the reverse of that in which they will appear</span>
<a href="#l7.908"></a><span id="l7.908">     // in the logTree.</span>
<a href="#l7.909"></a><span id="l7.909">     let firstgroups = {</span>
<a href="#l7.910"></a><span id="l7.910">       previousWeek: [],</span>
<a href="#l7.911"></a><span id="l7.911">       currentWeek: [],</span>
<a href="#l7.912"></a><span id="l7.912">       yesterday: [],</span>
<a href="#l7.913"></a><span id="l7.913" class="difflineminus">-      today: []</span>
<a href="#l7.914"></a><span id="l7.914" class="difflineplus">+      today: [],</span>
<a href="#l7.915"></a><span id="l7.915">     };</span>
<a href="#l7.916"></a><span id="l7.916"> </span>
<a href="#l7.917"></a><span id="l7.917">     // today and yesterday are treated differently, because for JSON logs they</span>
<a href="#l7.918"></a><span id="l7.918">     // represent individual logs, and are not &quot;groups&quot;.</span>
<a href="#l7.919"></a><span id="l7.919">     let today = null, yesterday = null;</span>
<a href="#l7.920"></a><span id="l7.920"> </span>
<a href="#l7.921"></a><span id="l7.921">     // Build a chatLogTreeLogItem for each log, and put it in the right group.</span>
<a href="#l7.922"></a><span id="l7.922">     let groups = {};</span>
<a href="#l7.923"></a><span id="l7.923" class="difflineat">@@ -1305,51 +1300,48 @@ chatLogTreeView.prototype = {</span>
<a href="#l7.924"></a><span id="l7.924">       let title = (isJSON ? formatDate : formatDateTime)(logDate);</span>
<a href="#l7.925"></a><span id="l7.925">       let group;</span>
<a href="#l7.926"></a><span id="l7.926">       if (timeFromToday &lt;= 0) {</span>
<a href="#l7.927"></a><span id="l7.927">         if (isJSON) {</span>
<a href="#l7.928"></a><span id="l7.928">           today = new chatLogTreeLogItem(log, chatBundle.getString(&quot;log.today&quot;), 0);</span>
<a href="#l7.929"></a><span id="l7.929">           continue;</span>
<a href="#l7.930"></a><span id="l7.930">         }</span>
<a href="#l7.931"></a><span id="l7.931">         group = firstgroups.today;</span>
<a href="#l7.932"></a><span id="l7.932" class="difflineminus">-      }</span>
<a href="#l7.933"></a><span id="l7.933" class="difflineminus">-      else if (timeFromToday &lt;= kDayInMsecs) {</span>
<a href="#l7.934"></a><span id="l7.934" class="difflineplus">+      } else if (timeFromToday &lt;= kDayInMsecs) {</span>
<a href="#l7.935"></a><span id="l7.935">         if (isJSON) {</span>
<a href="#l7.936"></a><span id="l7.936">           yesterday = new chatLogTreeLogItem(log, chatBundle.getString(&quot;log.yesterday&quot;), 0);</span>
<a href="#l7.937"></a><span id="l7.937">           continue;</span>
<a href="#l7.938"></a><span id="l7.938">         }</span>
<a href="#l7.939"></a><span id="l7.939">         group = firstgroups.yesterday;</span>
<a href="#l7.940"></a><span id="l7.940" class="difflineminus">-      }</span>
<a href="#l7.941"></a><span id="l7.941" class="difflineminus">-      // Note that the 7 days of the current week include today.</span>
<a href="#l7.942"></a><span id="l7.942" class="difflineminus">-      else if (timeFromToday &lt;= kWeekInMsecs - kDayInMsecs) {</span>
<a href="#l7.943"></a><span id="l7.943" class="difflineplus">+      } else if (timeFromToday &lt;= kWeekInMsecs - kDayInMsecs) {</span>
<a href="#l7.944"></a><span id="l7.944" class="difflineplus">+        // Note that the 7 days of the current week include today.</span>
<a href="#l7.945"></a><span id="l7.945">         group = firstgroups.currentWeek;</span>
<a href="#l7.946"></a><span id="l7.946">         if (isJSON)</span>
<a href="#l7.947"></a><span id="l7.947">           title = formatWeekday(logDate);</span>
<a href="#l7.948"></a><span id="l7.948" class="difflineminus">-      }</span>
<a href="#l7.949"></a><span id="l7.949" class="difflineminus">-      else if (timeFromToday &lt;= kTwoWeeksInMsecs - kDayInMsecs)</span>
<a href="#l7.950"></a><span id="l7.950" class="difflineplus">+      } else if (timeFromToday &lt;= kTwoWeeksInMsecs - kDayInMsecs) {</span>
<a href="#l7.951"></a><span id="l7.951">         group = firstgroups.previousWeek;</span>
<a href="#l7.952"></a><span id="l7.952" class="difflineminus">-      else {</span>
<a href="#l7.953"></a><span id="l7.953" class="difflineplus">+      } else {</span>
<a href="#l7.954"></a><span id="l7.954">         logDate.setHours(0);</span>
<a href="#l7.955"></a><span id="l7.955">         logDate.setMinutes(0);</span>
<a href="#l7.956"></a><span id="l7.956">         logDate.setSeconds(0);</span>
<a href="#l7.957"></a><span id="l7.957">         logDate.setDate(1);</span>
<a href="#l7.958"></a><span id="l7.958">         let groupID = logDate.toISOString();</span>
<a href="#l7.959"></a><span id="l7.959">         if (!(groupID in groups)) {</span>
<a href="#l7.960"></a><span id="l7.960">           let groupname;</span>
<a href="#l7.961"></a><span id="l7.961">           if (logDate.getFullYear() == nowDate.getFullYear()) {</span>
<a href="#l7.962"></a><span id="l7.962">             if (logDate.getMonth() == nowDate.getMonth())</span>
<a href="#l7.963"></a><span id="l7.963">               groupname = placesBundle.getString(&quot;finduri-AgeInMonths-is-0&quot;);</span>
<a href="#l7.964"></a><span id="l7.964">             else</span>
<a href="#l7.965"></a><span id="l7.965">               groupname = formatMonth(logDate);</span>
<a href="#l7.966"></a><span id="l7.966" class="difflineplus">+          } else {</span>
<a href="#l7.967"></a><span id="l7.967" class="difflineplus">+            groupname = formatMonthYear(logDate);</span>
<a href="#l7.968"></a><span id="l7.968">           }</span>
<a href="#l7.969"></a><span id="l7.969" class="difflineminus">-          else</span>
<a href="#l7.970"></a><span id="l7.970" class="difflineminus">-            groupname = formatMonthYear(logDate);</span>
<a href="#l7.971"></a><span id="l7.971">           groups[groupID] = {</span>
<a href="#l7.972"></a><span id="l7.972">             entries: [],</span>
<a href="#l7.973"></a><span id="l7.973" class="difflineminus">-            name: groupname</span>
<a href="#l7.974"></a><span id="l7.974" class="difflineplus">+            name: groupname,</span>
<a href="#l7.975"></a><span id="l7.975">           };</span>
<a href="#l7.976"></a><span id="l7.976">         }</span>
<a href="#l7.977"></a><span id="l7.977">         group = groups[groupID].entries;</span>
<a href="#l7.978"></a><span id="l7.978">       }</span>
<a href="#l7.979"></a><span id="l7.979">       group.push(new chatLogTreeLogItem(log, title, 1));</span>
<a href="#l7.980"></a><span id="l7.980">     }</span>
<a href="#l7.981"></a><span id="l7.981"> </span>
<a href="#l7.982"></a><span id="l7.982">     let groupIDs = Object.keys(groups).sort().reverse();</span>
<a href="#l7.983"></a><span id="l7.983" class="difflineat">@@ -1357,30 +1349,30 @@ chatLogTreeView.prototype = {</span>
<a href="#l7.984"></a><span id="l7.984">     // Add firstgroups to groups and groupIDs.</span>
<a href="#l7.985"></a><span id="l7.985">     for (let groupID in firstgroups) {</span>
<a href="#l7.986"></a><span id="l7.986">       let group = firstgroups[groupID];</span>
<a href="#l7.987"></a><span id="l7.987">       if (!group.length)</span>
<a href="#l7.988"></a><span id="l7.988">         continue;</span>
<a href="#l7.989"></a><span id="l7.989">       groupIDs.unshift(groupID);</span>
<a href="#l7.990"></a><span id="l7.990">       groups[groupID] = {</span>
<a href="#l7.991"></a><span id="l7.991">         entries: firstgroups[groupID],</span>
<a href="#l7.992"></a><span id="l7.992" class="difflineminus">-        name: chatBundle.getString(&quot;log.&quot; + groupID)</span>
<a href="#l7.993"></a><span id="l7.993" class="difflineplus">+        name: chatBundle.getString(&quot;log.&quot; + groupID),</span>
<a href="#l7.994"></a><span id="l7.994">       };</span>
<a href="#l7.995"></a><span id="l7.995">     }</span>
<a href="#l7.996"></a><span id="l7.996"> </span>
<a href="#l7.997"></a><span id="l7.997">     // Build tree.</span>
<a href="#l7.998"></a><span id="l7.998">     if (today)</span>
<a href="#l7.999"></a><span id="l7.999">       this._rowMap.push(today);</span>
<a href="#l7.1000"></a><span id="l7.1000">     if (yesterday)</span>
<a href="#l7.1001"></a><span id="l7.1001">       this._rowMap.push(yesterday);</span>
<a href="#l7.1002"></a><span id="l7.1002" class="difflineminus">-    groupIDs.forEach(function (aGroupID) {</span>
<a href="#l7.1003"></a><span id="l7.1003" class="difflineplus">+    groupIDs.forEach(function(aGroupID) {</span>
<a href="#l7.1004"></a><span id="l7.1004">       let group = groups[aGroupID];</span>
<a href="#l7.1005"></a><span id="l7.1005">       group.entries.sort((l1, l2) =&gt; l2.log.time - l1.log.time);</span>
<a href="#l7.1006"></a><span id="l7.1006">       this._rowMap.push(new chatLogTreeGroupItem(group.name, group.entries));</span>
<a href="#l7.1007"></a><span id="l7.1007">     }, this);</span>
<a href="#l7.1008"></a><span id="l7.1008"> </span>
<a href="#l7.1009"></a><span id="l7.1009">     // Finally, notify the tree.</span>
<a href="#l7.1010"></a><span id="l7.1010">     if (this._tree)</span>
<a href="#l7.1011"></a><span id="l7.1011">       this._tree.rowCountChanged(0, this._rowMap.length);</span>
<a href="#l7.1012"></a><span id="l7.1012" class="difflineminus">-  }</span>
<a href="#l7.1013"></a><span id="l7.1013" class="difflineplus">+  },</span>
<a href="#l7.1014"></a><span id="l7.1014"> };</span>
<a href="#l7.1015"></a><span id="l7.1015"> </span>
<a href="#l7.1016"></a><span id="l7.1016"> window.addEventListener(&quot;load&quot;, chatHandler.init.bind(chatHandler));</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mail/components/im/content/imAccountWizard.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mail/components/im/content/imAccountWizard.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -1,29 +1,36 @@</span>
<a href="#l8.4"></a><span id="l8.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l8.5"></a><span id="l8.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l8.6"></a><span id="l8.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l8.7"></a><span id="l8.7"> </span>
<a href="#l8.8"></a><span id="l8.8" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l8.9"></a><span id="l8.9" class="difflineplus">+// chat/content/imAccountOptionsHelper.js</span>
<a href="#l8.10"></a><span id="l8.10" class="difflineplus">+/* globals accountOptionsHelper */</span>
<a href="#l8.11"></a><span id="l8.11" class="difflineplus">+</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+var { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;, null);</span>
<a href="#l8.13"></a><span id="l8.13"> ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l8.14"></a><span id="l8.14"> </span>
<a href="#l8.15"></a><span id="l8.15"> var PREF_EXTENSIONS_GETMOREPROTOCOLSURL = &quot;extensions.getMoreProtocolsURL&quot;;</span>
<a href="#l8.16"></a><span id="l8.16"> </span>
<a href="#l8.17"></a><span id="l8.17"> var accountWizard = {</span>
<a href="#l8.18"></a><span id="l8.18">   onload: function aw_onload() {</span>
<a href="#l8.19"></a><span id="l8.19">     // Ensure the im core is initialized before we get a list of protocols.</span>
<a href="#l8.20"></a><span id="l8.20">     Services.core.init();</span>
<a href="#l8.21"></a><span id="l8.21"> </span>
<a href="#l8.22"></a><span id="l8.22">     accountWizard.setGetMoreProtocols();</span>
<a href="#l8.23"></a><span id="l8.23"> </span>
<a href="#l8.24"></a><span id="l8.24">     var protoList = document.getElementById(&quot;protolist&quot;);</span>
<a href="#l8.25"></a><span id="l8.25">     var protos = [];</span>
<a href="#l8.26"></a><span id="l8.26">     for (let proto of this.getProtocols())</span>
<a href="#l8.27"></a><span id="l8.27">       protos.push(proto);</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineminus">-    protos.sort((a, b) =&gt; a.name &lt; b.name ? -1 : a.name &gt; b.name ? 1 : 0);</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineplus">+    protos.sort((a, b) =&gt; {</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineplus">+      if (a.name &lt; b.name)</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineplus">+        return -1;</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+      return a.name &gt; b.name ? 1 : 0;</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineplus">+    });</span>
<a href="#l8.34"></a><span id="l8.34">     protos.forEach(function(proto) {</span>
<a href="#l8.35"></a><span id="l8.35">       let image = document.createElement(&quot;image&quot;);</span>
<a href="#l8.36"></a><span id="l8.36">       image.setAttribute(&quot;src&quot;, proto.iconBaseURI + &quot;icon.png&quot;);</span>
<a href="#l8.37"></a><span id="l8.37"> </span>
<a href="#l8.38"></a><span id="l8.38">       let label = document.createElement(&quot;label&quot;);</span>
<a href="#l8.39"></a><span id="l8.39">       label.setAttribute(&quot;value&quot;, proto.name);</span>
<a href="#l8.40"></a><span id="l8.40"> </span>
<a href="#l8.41"></a><span id="l8.41">       let item = document.createElement(&quot;richlistitem&quot;);</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineat">@@ -119,18 +126,17 @@ var accountWizard = {</span>
<a href="#l8.43"></a><span id="l8.43"> </span>
<a href="#l8.44"></a><span id="l8.44">     var bundle = document.getElementById(&quot;accountsBundle&quot;);</span>
<a href="#l8.45"></a><span id="l8.45">     var usernameInfo;</span>
<a href="#l8.46"></a><span id="l8.46">     var emptyText = this.proto.usernameEmptyText;</span>
<a href="#l8.47"></a><span id="l8.47">     if (emptyText) {</span>
<a href="#l8.48"></a><span id="l8.48">       usernameInfo =</span>
<a href="#l8.49"></a><span id="l8.49">         bundle.getFormattedString(&quot;accountUsernameInfoWithDescription&quot;,</span>
<a href="#l8.50"></a><span id="l8.50">                                   [emptyText, this.proto.name]);</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineminus">-    }</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineminus">-    else {</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineplus">+    } else {</span>
<a href="#l8.54"></a><span id="l8.54">       usernameInfo =</span>
<a href="#l8.55"></a><span id="l8.55">         bundle.getFormattedString(&quot;accountUsernameInfo&quot;, [this.proto.name]);</span>
<a href="#l8.56"></a><span id="l8.56">     }</span>
<a href="#l8.57"></a><span id="l8.57">     document.getElementById(&quot;usernameInfo&quot;).textContent = usernameInfo;</span>
<a href="#l8.58"></a><span id="l8.58"> </span>
<a href="#l8.59"></a><span id="l8.59">     var vbox = document.getElementById(&quot;userNameBox&quot;);</span>
<a href="#l8.60"></a><span id="l8.60">     // remove anything that may be there for another protocol</span>
<a href="#l8.61"></a><span id="l8.61">     while (vbox.hasChildNodes())</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineat">@@ -250,29 +256,29 @@ var accountWizard = {</span>
<a href="#l8.63"></a><span id="l8.63">       let eltName = id + &quot;-&quot; + name;</span>
<a href="#l8.64"></a><span id="l8.64">       let val = this.getValue(eltName);</span>
<a href="#l8.65"></a><span id="l8.65">       // The value will be undefined if the proto specific groupbox has never been opened</span>
<a href="#l8.66"></a><span id="l8.66">       if (val === undefined)</span>
<a href="#l8.67"></a><span id="l8.67">         continue;</span>
<a href="#l8.68"></a><span id="l8.68">       switch (opt.type) {</span>
<a href="#l8.69"></a><span id="l8.69">       case opt.typeBool:</span>
<a href="#l8.70"></a><span id="l8.70">         if (val != opt.getBool())</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineminus">-          this.prefs.push({opt: opt, name: name, value: !!val});</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineplus">+          this.prefs.push({opt, name, value: !!val});</span>
<a href="#l8.73"></a><span id="l8.73">         break;</span>
<a href="#l8.74"></a><span id="l8.74">       case opt.typeInt:</span>
<a href="#l8.75"></a><span id="l8.75">         if (val != opt.getInt())</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineminus">-          this.prefs.push({opt: opt, name: name, value: val});</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineplus">+          this.prefs.push({opt, name, value: val});</span>
<a href="#l8.78"></a><span id="l8.78">         break;</span>
<a href="#l8.79"></a><span id="l8.79">       case opt.typeString:</span>
<a href="#l8.80"></a><span id="l8.80">         if (val != opt.getString())</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineminus">-          this.prefs.push({opt: opt, name: name, value: val});</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineplus">+          this.prefs.push({opt, name, value: val});</span>
<a href="#l8.83"></a><span id="l8.83">         break;</span>
<a href="#l8.84"></a><span id="l8.84">       case opt.typeList:</span>
<a href="#l8.85"></a><span id="l8.85">         if (val != opt.getListDefault())</span>
<a href="#l8.86"></a><span id="l8.86" class="difflineminus">-          this.prefs.push({opt: opt, name: name, value: val});</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineplus">+          this.prefs.push({opt, name, value: val});</span>
<a href="#l8.88"></a><span id="l8.88">         break;</span>
<a href="#l8.89"></a><span id="l8.89">       default:</span>
<a href="#l8.90"></a><span id="l8.90">         throw &quot;unknown preference type &quot; + opt.type;</span>
<a href="#l8.91"></a><span id="l8.91">       }</span>
<a href="#l8.92"></a><span id="l8.92">     }</span>
<a href="#l8.93"></a><span id="l8.93"> </span>
<a href="#l8.94"></a><span id="l8.94">     for (let i = 0; i &lt; this.prefs.length; ++i) {</span>
<a href="#l8.95"></a><span id="l8.95">       let opt = this.prefs[i];</span>
<a href="#l8.96"></a><span id="l8.96" class="difflineat">@@ -286,17 +292,17 @@ var accountWizard = {</span>
<a href="#l8.97"></a><span id="l8.97">     if (!this.proto.noPassword &amp;&amp; this.password)</span>
<a href="#l8.98"></a><span id="l8.98">       acc.password = this.password;</span>
<a href="#l8.99"></a><span id="l8.99">     if (this.alias)</span>
<a href="#l8.100"></a><span id="l8.100">       acc.alias = this.alias;</span>
<a href="#l8.101"></a><span id="l8.101"> </span>
<a href="#l8.102"></a><span id="l8.102">     for (let i = 0; i &lt; this.prefs.length; ++i) {</span>
<a href="#l8.103"></a><span id="l8.103">       let option = this.prefs[i];</span>
<a href="#l8.104"></a><span id="l8.104">       let opt = option.opt;</span>
<a href="#l8.105"></a><span id="l8.105" class="difflineminus">-      switch(opt.type) {</span>
<a href="#l8.106"></a><span id="l8.106" class="difflineplus">+      switch (opt.type) {</span>
<a href="#l8.107"></a><span id="l8.107">       case opt.typeBool:</span>
<a href="#l8.108"></a><span id="l8.108">         acc.setBool(option.name, option.value);</span>
<a href="#l8.109"></a><span id="l8.109">         break;</span>
<a href="#l8.110"></a><span id="l8.110">       case opt.typeInt:</span>
<a href="#l8.111"></a><span id="l8.111">         acc.setInt(option.name, option.value);</span>
<a href="#l8.112"></a><span id="l8.112">         break;</span>
<a href="#l8.113"></a><span id="l8.113">       case opt.typeString:</span>
<a href="#l8.114"></a><span id="l8.114">       case opt.typeList:</span>
<a href="#l8.115"></a><span id="l8.115" class="difflineat">@@ -350,17 +356,17 @@ var accountWizard = {</span>
<a href="#l8.116"></a><span id="l8.116">     if (&quot;value&quot; in elt)</span>
<a href="#l8.117"></a><span id="l8.117">       return elt.value;</span>
<a href="#l8.118"></a><span id="l8.118">     // If the groupbox has never been opened, the binding isn't attached</span>
<a href="#l8.119"></a><span id="l8.119">     // so the attributes don't exist. The calling code in showSummary</span>
<a href="#l8.120"></a><span id="l8.120">     // has a special handling of the undefined value for this case.</span>
<a href="#l8.121"></a><span id="l8.121">     return undefined;</span>
<a href="#l8.122"></a><span id="l8.122">   },</span>
<a href="#l8.123"></a><span id="l8.123"> </span>
<a href="#l8.124"></a><span id="l8.124" class="difflineminus">-  getIter: function*(aEnumerator) {</span>
<a href="#l8.125"></a><span id="l8.125" class="difflineplus">+  * getIter(aEnumerator) {</span>
<a href="#l8.126"></a><span id="l8.126">     while (aEnumerator.hasMoreElements())</span>
<a href="#l8.127"></a><span id="l8.127">       yield aEnumerator.getNext();</span>
<a href="#l8.128"></a><span id="l8.128">   },</span>
<a href="#l8.129"></a><span id="l8.129">   getProtocols: function aw_getProtocols() {</span>
<a href="#l8.130"></a><span id="l8.130">     return this.getIter(Services.core.getProtocols());</span>
<a href="#l8.131"></a><span id="l8.131">   },</span>
<a href="#l8.132"></a><span id="l8.132">   getProtoOptions: function aw_getProtoOptions() {</span>
<a href="#l8.133"></a><span id="l8.133">     return this.getIter(this.proto.getOptions());</span>
<a href="#l8.134"></a><span id="l8.134" class="difflineat">@@ -379,44 +385,42 @@ var accountWizard = {</span>
<a href="#l8.135"></a><span id="l8.135">   },</span>
<a href="#l8.136"></a><span id="l8.136"> </span>
<a href="#l8.137"></a><span id="l8.137">   toggleGroupbox: function aw_toggleGroupbox(id) {</span>
<a href="#l8.138"></a><span id="l8.138">     var elt = document.getElementById(id);</span>
<a href="#l8.139"></a><span id="l8.139">     if (elt.hasAttribute(&quot;closed&quot;)) {</span>
<a href="#l8.140"></a><span id="l8.140">       elt.removeAttribute(&quot;closed&quot;);</span>
<a href="#l8.141"></a><span id="l8.141">       if (elt.flexWhenOpened)</span>
<a href="#l8.142"></a><span id="l8.142">         elt.flex = elt.flexWhenOpened;</span>
<a href="#l8.143"></a><span id="l8.143" class="difflineminus">-    }</span>
<a href="#l8.144"></a><span id="l8.144" class="difflineminus">-    else {</span>
<a href="#l8.145"></a><span id="l8.145" class="difflineplus">+    } else {</span>
<a href="#l8.146"></a><span id="l8.146">       elt.setAttribute(&quot;closed&quot;, &quot;true&quot;);</span>
<a href="#l8.147"></a><span id="l8.147">       if (elt.flex) {</span>
<a href="#l8.148"></a><span id="l8.148">         elt.flexWhenOpened = elt.flex;</span>
<a href="#l8.149"></a><span id="l8.149">         elt.flex = 0;</span>
<a href="#l8.150"></a><span id="l8.150">       }</span>
<a href="#l8.151"></a><span id="l8.151">     }</span>
<a href="#l8.152"></a><span id="l8.152">   },</span>
<a href="#l8.153"></a><span id="l8.153"> </span>
<a href="#l8.154"></a><span id="l8.154">   /* Check for correctness and set URL for the &quot;Get more protocols...&quot;-link</span>
<a href="#l8.155"></a><span id="l8.155">    *  Stripped down code from preferences/themes.js</span>
<a href="#l8.156"></a><span id="l8.156">    */</span>
<a href="#l8.157"></a><span id="l8.157" class="difflineminus">-  setGetMoreProtocols: function (){</span>
<a href="#l8.158"></a><span id="l8.158" class="difflineplus">+  setGetMoreProtocols() {</span>
<a href="#l8.159"></a><span id="l8.159">     let prefURL = PREF_EXTENSIONS_GETMOREPROTOCOLSURL;</span>
<a href="#l8.160"></a><span id="l8.160">     var getMore = document.getElementById(&quot;getMoreProtocols&quot;);</span>
<a href="#l8.161"></a><span id="l8.161">     var showGetMore = false;</span>
<a href="#l8.162"></a><span id="l8.162">     const nsIPrefBranch = Ci.nsIPrefBranch;</span>
<a href="#l8.163"></a><span id="l8.163"> </span>
<a href="#l8.164"></a><span id="l8.164">     if (Services.prefs.getPrefType(prefURL) != nsIPrefBranch.PREF_INVALID) {</span>
<a href="#l8.165"></a><span id="l8.165">       try {</span>
<a href="#l8.166"></a><span id="l8.166">         var getMoreURL = Services.urlFormatter.formatURLPref(prefURL);</span>
<a href="#l8.167"></a><span id="l8.167">         getMore.setAttribute(&quot;getMoreURL&quot;, getMoreURL);</span>
<a href="#l8.168"></a><span id="l8.168">         showGetMore = getMoreURL != &quot;about:blank&quot;;</span>
<a href="#l8.169"></a><span id="l8.169" class="difflineminus">-      }</span>
<a href="#l8.170"></a><span id="l8.170" class="difflineminus">-      catch (e) { }</span>
<a href="#l8.171"></a><span id="l8.171" class="difflineplus">+      } catch (e) {}</span>
<a href="#l8.172"></a><span id="l8.172">     }</span>
<a href="#l8.173"></a><span id="l8.173">     getMore.hidden = !showGetMore;</span>
<a href="#l8.174"></a><span id="l8.174">   },</span>
<a href="#l8.175"></a><span id="l8.175"> </span>
<a href="#l8.176"></a><span id="l8.176" class="difflineminus">-  openURL: function (aURL) {</span>
<a href="#l8.177"></a><span id="l8.177" class="difflineplus">+  openURL(aURL) {</span>
<a href="#l8.178"></a><span id="l8.178">     Cc[&quot;@mozilla.org/uriloader/external-protocol-service;1&quot;]</span>
<a href="#l8.179"></a><span id="l8.179">       .getService(Ci.nsIExternalProtocolService)</span>
<a href="#l8.180"></a><span id="l8.180">       .loadURI(Services.io.newURI(aURL));</span>
<a href="#l8.181"></a><span id="l8.181" class="difflineminus">-  }</span>
<a href="#l8.182"></a><span id="l8.182" class="difflineplus">+  },</span>
<a href="#l8.183"></a><span id="l8.183"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mail/components/im/content/imAccounts.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mail/components/im/content/imAccounts.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -1,14 +1,19 @@</span>
<a href="#l9.4"></a><span id="l9.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l9.5"></a><span id="l9.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l9.6"></a><span id="l9.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l9.7"></a><span id="l9.7"> </span>
<a href="#l9.8"></a><span id="l9.8" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l9.9"></a><span id="l9.9" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l9.10"></a><span id="l9.10" class="difflineplus">+// mail/base/content/nsDragAndDrop.js</span>
<a href="#l9.11"></a><span id="l9.11" class="difflineplus">+/* globals FlavourSet, TransferData */</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+// imStatusSelector.js</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+/* globals statusSelector */</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+var { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;, null);</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+var { fixIterator } = ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;, null);</span>
<a href="#l9.17"></a><span id="l9.17"> ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l9.18"></a><span id="l9.18"> ChromeUtils.import(&quot;resource://gre/modules/DownloadUtils.jsm&quot;);</span>
<a href="#l9.19"></a><span id="l9.19"> </span>
<a href="#l9.20"></a><span id="l9.20"> // This is the list of notifications that the account manager window observes</span>
<a href="#l9.21"></a><span id="l9.21"> var events = [</span>
<a href="#l9.22"></a><span id="l9.22">   &quot;prpl-quit&quot;,</span>
<a href="#l9.23"></a><span id="l9.23">   &quot;account-list-updated&quot;,</span>
<a href="#l9.24"></a><span id="l9.24">   &quot;account-added&quot;,</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineat">@@ -17,17 +22,17 @@ var events = [</span>
<a href="#l9.26"></a><span id="l9.26">   &quot;account-connected&quot;,</span>
<a href="#l9.27"></a><span id="l9.27">   &quot;account-connecting&quot;,</span>
<a href="#l9.28"></a><span id="l9.28">   &quot;account-disconnected&quot;,</span>
<a href="#l9.29"></a><span id="l9.29">   &quot;account-disconnecting&quot;,</span>
<a href="#l9.30"></a><span id="l9.30">   &quot;account-connect-progress&quot;,</span>
<a href="#l9.31"></a><span id="l9.31">   &quot;account-connect-error&quot;,</span>
<a href="#l9.32"></a><span id="l9.32">   &quot;autologin-processed&quot;,</span>
<a href="#l9.33"></a><span id="l9.33">   &quot;status-changed&quot;,</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineminus">-  &quot;network:offline-status-changed&quot;</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineplus">+  &quot;network:offline-status-changed&quot;,</span>
<a href="#l9.36"></a><span id="l9.36"> ];</span>
<a href="#l9.37"></a><span id="l9.37"> </span>
<a href="#l9.38"></a><span id="l9.38"> var gAccountManager = {</span>
<a href="#l9.39"></a><span id="l9.39">   // Sets the delay after connect() or disconnect() during which</span>
<a href="#l9.40"></a><span id="l9.40">   // it is impossible to perform disconnect() and connect()</span>
<a href="#l9.41"></a><span id="l9.41">   _disabledDelay: 500,</span>
<a href="#l9.42"></a><span id="l9.42">   disableTimerID: 0,</span>
<a href="#l9.43"></a><span id="l9.43">   _connectedLabelInterval: 0,</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineat">@@ -105,50 +110,45 @@ var gAccountManager = {</span>
<a href="#l9.45"></a><span id="l9.45">     this.disableCommandItems();</span>
<a href="#l9.46"></a><span id="l9.46">   },</span>
<a href="#l9.47"></a><span id="l9.47">   observe: function am_observe(aObject, aTopic, aData) {</span>
<a href="#l9.48"></a><span id="l9.48">     if (aTopic == &quot;prpl-quit&quot;) {</span>
<a href="#l9.49"></a><span id="l9.49">       // libpurple is being uninitialized. We don't need the account</span>
<a href="#l9.50"></a><span id="l9.50">       // manager window anymore, close it.</span>
<a href="#l9.51"></a><span id="l9.51">       this.close();</span>
<a href="#l9.52"></a><span id="l9.52">       return;</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineminus">-    }</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineminus">-    else if (aTopic == &quot;autologin-processed&quot;) {</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineplus">+    } else if (aTopic == &quot;autologin-processed&quot;) {</span>
<a href="#l9.56"></a><span id="l9.56">       var notification = document.getElementById(&quot;accountsNotificationBox&quot;)</span>
<a href="#l9.57"></a><span id="l9.57">                                  .getNotificationWithValue(&quot;autoLoginStatus&quot;);</span>
<a href="#l9.58"></a><span id="l9.58">       if (notification)</span>
<a href="#l9.59"></a><span id="l9.59">         notification.close();</span>
<a href="#l9.60"></a><span id="l9.60">       return;</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineminus">-    }</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineminus">-    else if (aTopic == &quot;network:offline-status-changed&quot;) {</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineplus">+    } else if (aTopic == &quot;network:offline-status-changed&quot;) {</span>
<a href="#l9.64"></a><span id="l9.64">       this.setOffline(aData == &quot;offline&quot;);</span>
<a href="#l9.65"></a><span id="l9.65">       return;</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineminus">-    }</span>
<a href="#l9.67"></a><span id="l9.67" class="difflineminus">-    else if (aTopic == &quot;status-changed&quot;) {</span>
<a href="#l9.68"></a><span id="l9.68" class="difflineplus">+    } else if (aTopic == &quot;status-changed&quot;) {</span>
<a href="#l9.69"></a><span id="l9.69">       this.setOffline(aObject.statusType == Ci.imIStatusInfo.STATUS_OFFLINE);</span>
<a href="#l9.70"></a><span id="l9.70">       return;</span>
<a href="#l9.71"></a><span id="l9.71" class="difflineminus">-    }</span>
<a href="#l9.72"></a><span id="l9.72" class="difflineminus">-    else if (aTopic == &quot;account-list-updated&quot;) {</span>
<a href="#l9.73"></a><span id="l9.73" class="difflineplus">+    } else if (aTopic == &quot;account-list-updated&quot;) {</span>
<a href="#l9.74"></a><span id="l9.74">       this._updateAccountList();</span>
<a href="#l9.75"></a><span id="l9.75">       return;</span>
<a href="#l9.76"></a><span id="l9.76">     }</span>
<a href="#l9.77"></a><span id="l9.77"> </span>
<a href="#l9.78"></a><span id="l9.78">     // The following notification handlers need an account.</span>
<a href="#l9.79"></a><span id="l9.79">     aObject.QueryInterface(Ci.imIAccount);</span>
<a href="#l9.80"></a><span id="l9.80"> </span>
<a href="#l9.81"></a><span id="l9.81">     if (aTopic == &quot;account-added&quot;) {</span>
<a href="#l9.82"></a><span id="l9.82">       document.getElementById(&quot;accountsDesk&quot;).selectedIndex = 1;</span>
<a href="#l9.83"></a><span id="l9.83" class="difflineminus">-      var elt = document.createElement(&quot;richlistitem&quot;);</span>
<a href="#l9.84"></a><span id="l9.84" class="difflineplus">+      let elt = document.createElement(&quot;richlistitem&quot;);</span>
<a href="#l9.85"></a><span id="l9.85">       this.accountList.appendChild(elt);</span>
<a href="#l9.86"></a><span id="l9.86">       elt.build(aObject);</span>
<a href="#l9.87"></a><span id="l9.87">       if (this.accountList.getRowCount() == 1)</span>
<a href="#l9.88"></a><span id="l9.88">         this.accountList.selectedIndex = 0;</span>
<a href="#l9.89"></a><span id="l9.89" class="difflineminus">-    }</span>
<a href="#l9.90"></a><span id="l9.90" class="difflineminus">-    else if (aTopic == &quot;account-removed&quot;) {</span>
<a href="#l9.91"></a><span id="l9.91" class="difflineminus">-      var elt = document.getElementById(aObject.id);</span>
<a href="#l9.92"></a><span id="l9.92" class="difflineplus">+    } else if (aTopic == &quot;account-removed&quot;) {</span>
<a href="#l9.93"></a><span id="l9.93" class="difflineplus">+      let elt = document.getElementById(aObject.id);</span>
<a href="#l9.94"></a><span id="l9.94">       elt.destroy();</span>
<a href="#l9.95"></a><span id="l9.95">       if (!elt.selected) {</span>
<a href="#l9.96"></a><span id="l9.96">         elt.remove();</span>
<a href="#l9.97"></a><span id="l9.97">         return;</span>
<a href="#l9.98"></a><span id="l9.98">       }</span>
<a href="#l9.99"></a><span id="l9.99">       // The currently selected element is removed,</span>
<a href="#l9.100"></a><span id="l9.100">       // ensure another element gets selected (if the list is not empty)</span>
<a href="#l9.101"></a><span id="l9.101">       var selectedIndex = this.accountList.selectedIndex;</span>
<a href="#l9.102"></a><span id="l9.102" class="difflineat">@@ -159,44 +159,40 @@ var gAccountManager = {</span>
<a href="#l9.103"></a><span id="l9.103">       var count = this.accountList.getRowCount();</span>
<a href="#l9.104"></a><span id="l9.104">       if (!count) {</span>
<a href="#l9.105"></a><span id="l9.105">         document.getElementById(&quot;accountsDesk&quot;).selectedIndex = 0;</span>
<a href="#l9.106"></a><span id="l9.106">         return;</span>
<a href="#l9.107"></a><span id="l9.107">       }</span>
<a href="#l9.108"></a><span id="l9.108">       if (selectedIndex == count)</span>
<a href="#l9.109"></a><span id="l9.109">         --selectedIndex;</span>
<a href="#l9.110"></a><span id="l9.110">       this.accountList.selectedIndex = selectedIndex;</span>
<a href="#l9.111"></a><span id="l9.111" class="difflineminus">-    }</span>
<a href="#l9.112"></a><span id="l9.112" class="difflineminus">-    else if (aTopic == &quot;account-updated&quot;) {</span>
<a href="#l9.113"></a><span id="l9.113" class="difflineplus">+    } else if (aTopic == &quot;account-updated&quot;) {</span>
<a href="#l9.114"></a><span id="l9.114">       document.getElementById(aObject.id).build(aObject);</span>
<a href="#l9.115"></a><span id="l9.115">       this.disableCommandItems();</span>
<a href="#l9.116"></a><span id="l9.116" class="difflineminus">-    }</span>
<a href="#l9.117"></a><span id="l9.117" class="difflineminus">-    else if (aTopic == &quot;account-connect-progress&quot;)</span>
<a href="#l9.118"></a><span id="l9.118" class="difflineplus">+    } else if (aTopic == &quot;account-connect-progress&quot;) {</span>
<a href="#l9.119"></a><span id="l9.119">       document.getElementById(aObject.id).updateConnectionState();</span>
<a href="#l9.120"></a><span id="l9.120" class="difflineminus">-    else if (aTopic == &quot;account-connect-error&quot;)</span>
<a href="#l9.121"></a><span id="l9.121" class="difflineplus">+    } else if (aTopic == &quot;account-connect-error&quot;) {</span>
<a href="#l9.122"></a><span id="l9.122">       document.getElementById(aObject.id).updateConnectionError();</span>
<a href="#l9.123"></a><span id="l9.123" class="difflineminus">-    else {</span>
<a href="#l9.124"></a><span id="l9.124" class="difflineplus">+    } else {</span>
<a href="#l9.125"></a><span id="l9.125">       const stateEvents = {</span>
<a href="#l9.126"></a><span id="l9.126">         &quot;account-connected&quot;: &quot;connected&quot;,</span>
<a href="#l9.127"></a><span id="l9.127">         &quot;account-connecting&quot;: &quot;connecting&quot;,</span>
<a href="#l9.128"></a><span id="l9.128">         &quot;account-disconnected&quot;: &quot;disconnected&quot;,</span>
<a href="#l9.129"></a><span id="l9.129" class="difflineminus">-        &quot;account-disconnecting&quot;: &quot;disconnecting&quot;</span>
<a href="#l9.130"></a><span id="l9.130" class="difflineplus">+        &quot;account-disconnecting&quot;: &quot;disconnecting&quot;,</span>
<a href="#l9.131"></a><span id="l9.131">       };</span>
<a href="#l9.132"></a><span id="l9.132">       if (aTopic in stateEvents) {</span>
<a href="#l9.133"></a><span id="l9.133">         let elt = document.getElementById(aObject.id);</span>
<a href="#l9.134"></a><span id="l9.134">         if (!elt)</span>
<a href="#l9.135"></a><span id="l9.135">           return; // probably disconnecting a removed account.</span>
<a href="#l9.136"></a><span id="l9.136"> </span>
<a href="#l9.137"></a><span id="l9.137">         if (aTopic == &quot;account-connecting&quot;) {</span>
<a href="#l9.138"></a><span id="l9.138">           elt.removeAttribute(&quot;error&quot;);</span>
<a href="#l9.139"></a><span id="l9.139">           elt.updateConnectionState();</span>
<a href="#l9.140"></a><span id="l9.140" class="difflineminus">-        }</span>
<a href="#l9.141"></a><span id="l9.141" class="difflineminus">-        else {</span>
<a href="#l9.142"></a><span id="l9.142" class="difflineminus">-          if (aTopic == &quot;account-connected&quot;)</span>
<a href="#l9.143"></a><span id="l9.143" class="difflineminus">-            elt.refreshConnectedLabel();</span>
<a href="#l9.144"></a><span id="l9.144" class="difflineplus">+        } else if (aTopic == &quot;account-connected&quot;) {</span>
<a href="#l9.145"></a><span id="l9.145" class="difflineplus">+          elt.refreshConnectedLabel();</span>
<a href="#l9.146"></a><span id="l9.146">         }</span>
<a href="#l9.147"></a><span id="l9.147"> </span>
<a href="#l9.148"></a><span id="l9.148">         elt.setAttribute(&quot;state&quot;, stateEvents[aTopic]);</span>
<a href="#l9.149"></a><span id="l9.149">       }</span>
<a href="#l9.150"></a><span id="l9.150">     }</span>
<a href="#l9.151"></a><span id="l9.151">   },</span>
<a href="#l9.152"></a><span id="l9.152">   cancelReconnection: function am_cancelReconnection() {</span>
<a href="#l9.153"></a><span id="l9.153">     this.accountList.selectedItem.cancelReconnection();</span>
<a href="#l9.154"></a><span id="l9.154" class="difflineat">@@ -221,44 +217,44 @@ var gAccountManager = {</span>
<a href="#l9.155"></a><span id="l9.155">     if (!account.disconnected || !prplAccount.connectionTarget)</span>
<a href="#l9.156"></a><span id="l9.156">       return;</span>
<a href="#l9.157"></a><span id="l9.157"> </span>
<a href="#l9.158"></a><span id="l9.158">     // Open the Gecko SSL exception dialog.</span>
<a href="#l9.159"></a><span id="l9.159">     let params = {</span>
<a href="#l9.160"></a><span id="l9.160">       exceptionAdded: false,</span>
<a href="#l9.161"></a><span id="l9.161">       securityInfo: prplAccount.secInfo,</span>
<a href="#l9.162"></a><span id="l9.162">       prefetchCert: true,</span>
<a href="#l9.163"></a><span id="l9.163" class="difflineminus">-      location: prplAccount.connectionTarget</span>
<a href="#l9.164"></a><span id="l9.164" class="difflineplus">+      location: prplAccount.connectionTarget,</span>
<a href="#l9.165"></a><span id="l9.165">     };</span>
<a href="#l9.166"></a><span id="l9.166">     window.openDialog(&quot;chrome://pippki/content/exceptionDialog.xul&quot;, &quot;&quot;,</span>
<a href="#l9.167"></a><span id="l9.167">                       &quot;chrome,centerscreen,modal&quot;, params);</span>
<a href="#l9.168"></a><span id="l9.168">     // Reconnect the account if an exception was added.</span>
<a href="#l9.169"></a><span id="l9.169">     if (params.exceptionAdded)</span>
<a href="#l9.170"></a><span id="l9.170">       account.connect();</span>
<a href="#l9.171"></a><span id="l9.171">   },</span>
<a href="#l9.172"></a><span id="l9.172">   copyDebugLog: function am_copyDebugLog() {</span>
<a href="#l9.173"></a><span id="l9.173">     let account = this.accountList.selectedItem.account;</span>
<a href="#l9.174"></a><span id="l9.174">     let text = account.getDebugMessages().map(function(dbgMsg) {</span>
<a href="#l9.175"></a><span id="l9.175">       let m = dbgMsg.message;</span>
<a href="#l9.176"></a><span id="l9.176">       let time = new Date(m.timeStamp);</span>
<a href="#l9.177"></a><span id="l9.177">       const dateTimeFormatter = new Services.intl.DateTimeFormat(undefined, {</span>
<a href="#l9.178"></a><span id="l9.178" class="difflineminus">-        dateStyle: &quot;short&quot;, timeStyle: &quot;long&quot;</span>
<a href="#l9.179"></a><span id="l9.179" class="difflineplus">+        dateStyle: &quot;short&quot;, timeStyle: &quot;long&quot;,</span>
<a href="#l9.180"></a><span id="l9.180">       });</span>
<a href="#l9.181"></a><span id="l9.181">       time = dateTimeFormatter.format(time);</span>
<a href="#l9.182"></a><span id="l9.182">       let level = dbgMsg.logLevel;</span>
<a href="#l9.183"></a><span id="l9.183">       if (!level)</span>
<a href="#l9.184"></a><span id="l9.184">         return &quot;(&quot; + m.errorMessage + &quot;)&quot;;</span>
<a href="#l9.185"></a><span id="l9.185">       if (level == dbgMsg.LEVEL_ERROR)</span>
<a href="#l9.186"></a><span id="l9.186">         level = &quot;ERROR&quot;;</span>
<a href="#l9.187"></a><span id="l9.187">       else if (level == dbgMsg.LEVEL_WARNING)</span>
<a href="#l9.188"></a><span id="l9.188">         level = &quot;WARN.&quot;;</span>
<a href="#l9.189"></a><span id="l9.189">       else if (level == dbgMsg.LEVEL_LOG)</span>
<a href="#l9.190"></a><span id="l9.190">         level = &quot;LOG  &quot;;</span>
<a href="#l9.191"></a><span id="l9.191">       else</span>
<a href="#l9.192"></a><span id="l9.192" class="difflineminus">-        level = &quot;DEBUG&quot;</span>
<a href="#l9.193"></a><span id="l9.193" class="difflineplus">+        level = &quot;DEBUG&quot;;</span>
<a href="#l9.194"></a><span id="l9.194">       return &quot;[&quot; + time + &quot;] &quot; + level + &quot; (@ &quot; + m.sourceLine +</span>
<a href="#l9.195"></a><span id="l9.195">              &quot; &quot; + m.sourceName + &quot;:&quot; + m.lineNumber + &quot;)\n&quot; +</span>
<a href="#l9.196"></a><span id="l9.196">              m.errorMessage;</span>
<a href="#l9.197"></a><span id="l9.197">     }).join(&quot;\n&quot;);</span>
<a href="#l9.198"></a><span id="l9.198">     Cc[&quot;@mozilla.org/widget/clipboardhelper;1&quot;]</span>
<a href="#l9.199"></a><span id="l9.199">       .getService(Ci.nsIClipboardHelper).copyString(text);</span>
<a href="#l9.200"></a><span id="l9.200">   },</span>
<a href="#l9.201"></a><span id="l9.201">   updateConnectedLabels: function am_updateConnectedLabels() {</span>
<a href="#l9.202"></a><span id="l9.202" class="difflineat">@@ -301,32 +297,31 @@ var gAccountManager = {</span>
<a href="#l9.203"></a><span id="l9.203">         break;</span>
<a href="#l9.204"></a><span id="l9.204">       }</span>
<a href="#l9.205"></a><span id="l9.205">     }</span>
<a href="#l9.206"></a><span id="l9.206"> </span>
<a href="#l9.207"></a><span id="l9.207">     let win = Services.wm.getMostRecentWindow(&quot;mailnews:accountmanager&quot;);</span>
<a href="#l9.208"></a><span id="l9.208">     if (win) {</span>
<a href="#l9.209"></a><span id="l9.209">       win.focus();</span>
<a href="#l9.210"></a><span id="l9.210">       win.selectServer(server);</span>
<a href="#l9.211"></a><span id="l9.211" class="difflineminus">-    }</span>
<a href="#l9.212"></a><span id="l9.212" class="difflineminus">-    else {</span>
<a href="#l9.213"></a><span id="l9.213" class="difflineplus">+    } else {</span>
<a href="#l9.214"></a><span id="l9.214">       window.openDialog(&quot;chrome://messenger/content/AccountManager.xul&quot;,</span>
<a href="#l9.215"></a><span id="l9.215">                         &quot;AccountManager&quot;,</span>
<a href="#l9.216"></a><span id="l9.216">                         &quot;chrome,centerscreen,modal,titlebar,resizable&quot;,</span>
<a href="#l9.217"></a><span id="l9.217" class="difflineminus">-                        { server: server, selectPage: null });</span>
<a href="#l9.218"></a><span id="l9.218" class="difflineplus">+                        { server, selectPage: null });</span>
<a href="#l9.219"></a><span id="l9.219">     }</span>
<a href="#l9.220"></a><span id="l9.220">   },</span>
<a href="#l9.221"></a><span id="l9.221">   autologin: function am_autologin() {</span>
<a href="#l9.222"></a><span id="l9.222">     var elt = this.accountList.selectedItem;</span>
<a href="#l9.223"></a><span id="l9.223">     elt.autoLogin = !elt.autoLogin;</span>
<a href="#l9.224"></a><span id="l9.224">   },</span>
<a href="#l9.225"></a><span id="l9.225">   close: function am_close() {</span>
<a href="#l9.226"></a><span id="l9.226">     // If a modal dialog is opened, we can't close this window now</span>
<a href="#l9.227"></a><span id="l9.227">     if (this.modalDialog)</span>
<a href="#l9.228"></a><span id="l9.228" class="difflineminus">-      setTimeout(function() { window.close();}, 0);</span>
<a href="#l9.229"></a><span id="l9.229" class="difflineplus">+      setTimeout(function() { window.close(); }, 0);</span>
<a href="#l9.230"></a><span id="l9.230">     else</span>
<a href="#l9.231"></a><span id="l9.231">       window.close();</span>
<a href="#l9.232"></a><span id="l9.232">   },</span>
<a href="#l9.233"></a><span id="l9.233"> </span>
<a href="#l9.234"></a><span id="l9.234">   /* This function disables or enables the currently selected button and</span>
<a href="#l9.235"></a><span id="l9.235">      the corresponding context menu item */</span>
<a href="#l9.236"></a><span id="l9.236">   disableCommandItems: function am_disableCommandItems() {</span>
<a href="#l9.237"></a><span id="l9.237">     let accountList = this.accountList;</span>
<a href="#l9.238"></a><span id="l9.238" class="difflineat">@@ -367,17 +362,17 @@ var gAccountManager = {</span>
<a href="#l9.239"></a><span id="l9.239">     let isAccount = targetElt instanceof Ci.nsIDOMXULSelectControlItemElement;</span>
<a href="#l9.240"></a><span id="l9.240">     document.getElementById(&quot;contextAccountsItems&quot;).hidden = !isAccount;</span>
<a href="#l9.241"></a><span id="l9.241">     if (isAccount) {</span>
<a href="#l9.242"></a><span id="l9.242">       let account = targetElt.account;</span>
<a href="#l9.243"></a><span id="l9.243">       let hiddenItems = {</span>
<a href="#l9.244"></a><span id="l9.244">         connect: !account.disconnected,</span>
<a href="#l9.245"></a><span id="l9.245">         disconnect: account.disconnected || account.disconnecting,</span>
<a href="#l9.246"></a><span id="l9.246">         cancelReconnection: !targetElt.hasAttribute(&quot;reconnectPending&quot;),</span>
<a href="#l9.247"></a><span id="l9.247" class="difflineminus">-        accountsItemsSeparator: account.disconnecting</span>
<a href="#l9.248"></a><span id="l9.248" class="difflineplus">+        accountsItemsSeparator: account.disconnecting,</span>
<a href="#l9.249"></a><span id="l9.249">       };</span>
<a href="#l9.250"></a><span id="l9.250">       for (let name in hiddenItems)</span>
<a href="#l9.251"></a><span id="l9.251">         document.getElementById(&quot;context_&quot; + name).hidden = hiddenItems[name];</span>
<a href="#l9.252"></a><span id="l9.252">     }</span>
<a href="#l9.253"></a><span id="l9.253">   },</span>
<a href="#l9.254"></a><span id="l9.254"> </span>
<a href="#l9.255"></a><span id="l9.255">   selectAccount: function am_selectAccount(aAccountId) {</span>
<a href="#l9.256"></a><span id="l9.256">     this.accountList.selectedItem = document.getElementById(aAccountId);</span>
<a href="#l9.257"></a><span id="l9.257" class="difflineat">@@ -428,17 +423,16 @@ var gAccountManager = {</span>
<a href="#l9.258"></a><span id="l9.258">     }</span>
<a href="#l9.259"></a><span id="l9.259"> </span>
<a href="#l9.260"></a><span id="l9.260">     if (event.keyCode == event.DOM_VK_RETURN) {</span>
<a href="#l9.261"></a><span id="l9.261">       let target = event.originalTarget;</span>
<a href="#l9.262"></a><span id="l9.262">       if (target.localName != &quot;checkbox&quot; &amp;&amp;</span>
<a href="#l9.263"></a><span id="l9.263">           (target.localName != &quot;button&quot; ||</span>
<a href="#l9.264"></a><span id="l9.264">            /^(dis)?connect$/.test(target.getAttribute(&quot;anonid&quot;))))</span>
<a href="#l9.265"></a><span id="l9.265">         this.selectedItem.buttons.proceedDefaultAction();</span>
<a href="#l9.266"></a><span id="l9.266" class="difflineminus">-      return;</span>
<a href="#l9.267"></a><span id="l9.267">     }</span>
<a href="#l9.268"></a><span id="l9.268">   },</span>
<a href="#l9.269"></a><span id="l9.269"> </span>
<a href="#l9.270"></a><span id="l9.270">   moveCurrentItem: function am_moveCurrentItem(aOffset) {</span>
<a href="#l9.271"></a><span id="l9.271">     let accountList = this.accountList;</span>
<a href="#l9.272"></a><span id="l9.272">     if (!aOffset || !accountList.selectedItem)</span>
<a href="#l9.273"></a><span id="l9.273">       return;</span>
<a href="#l9.274"></a><span id="l9.274"> </span>
<a href="#l9.275"></a><span id="l9.275" class="difflineat">@@ -487,17 +481,17 @@ var gAccountManager = {</span>
<a href="#l9.276"></a><span id="l9.276">     }</span>
<a href="#l9.277"></a><span id="l9.277"> </span>
<a href="#l9.278"></a><span id="l9.278">     var bundle = document.getElementById(&quot;accountsBundle&quot;);</span>
<a href="#l9.279"></a><span id="l9.279">     var box = document.getElementById(&quot;accountsNotificationBox&quot;);</span>
<a href="#l9.280"></a><span id="l9.280">     var priority = box.PRIORITY_INFO_HIGH;</span>
<a href="#l9.281"></a><span id="l9.281">     var connectNowButton = {</span>
<a href="#l9.282"></a><span id="l9.282">       accessKey: bundle.getString(&quot;accountsManager.notification.button.accessKey&quot;),</span>
<a href="#l9.283"></a><span id="l9.283">       callback: this.processAutoLogin,</span>
<a href="#l9.284"></a><span id="l9.284" class="difflineminus">-      label: bundle.getString(&quot;accountsManager.notification.button.label&quot;)</span>
<a href="#l9.285"></a><span id="l9.285" class="difflineplus">+      label: bundle.getString(&quot;accountsManager.notification.button.label&quot;),</span>
<a href="#l9.286"></a><span id="l9.286">     };</span>
<a href="#l9.287"></a><span id="l9.287">     var label;</span>
<a href="#l9.288"></a><span id="l9.288"> </span>
<a href="#l9.289"></a><span id="l9.289">     switch (autoLoginStatus) {</span>
<a href="#l9.290"></a><span id="l9.290">       case as.AUTOLOGIN_USER_DISABLED:</span>
<a href="#l9.291"></a><span id="l9.291">         label = bundle.getString(&quot;accountsManager.notification.userDisabled.label&quot;);</span>
<a href="#l9.292"></a><span id="l9.292">         break;</span>
<a href="#l9.293"></a><span id="l9.293"> </span>
<a href="#l9.294"></a><span id="l9.294" class="difflineat">@@ -560,35 +554,29 @@ var gAccountManager = {</span>
<a href="#l9.295"></a><span id="l9.295">   },</span>
<a href="#l9.296"></a><span id="l9.296">   setOffline: function am_setOffline(aState) {</span>
<a href="#l9.297"></a><span id="l9.297">     this.isOffline = aState;</span>
<a href="#l9.298"></a><span id="l9.298">     if (aState)</span>
<a href="#l9.299"></a><span id="l9.299">       this.accountList.setAttribute(&quot;offline&quot;, &quot;true&quot;);</span>
<a href="#l9.300"></a><span id="l9.300">     else</span>
<a href="#l9.301"></a><span id="l9.301">       this.accountList.removeAttribute(&quot;offline&quot;);</span>
<a href="#l9.302"></a><span id="l9.302">     this.disableCommandItems();</span>
<a href="#l9.303"></a><span id="l9.303" class="difflineminus">-  }</span>
<a href="#l9.304"></a><span id="l9.304" class="difflineplus">+  },</span>
<a href="#l9.305"></a><span id="l9.305"> };</span>
<a href="#l9.306"></a><span id="l9.306"> </span>
<a href="#l9.307"></a><span id="l9.307"> </span>
<a href="#l9.308"></a><span id="l9.308"> var gAMDragAndDrop = {</span>
<a href="#l9.309"></a><span id="l9.309">   ACCOUNT_MIME_TYPE: &quot;application/x-moz-richlistitem&quot;,</span>
<a href="#l9.310"></a><span id="l9.310">   // Size of the scroll zone on the top and on the bottom of the account list</span>
<a href="#l9.311"></a><span id="l9.311">   MAGIC_SCROLL_HEIGHT: 20,</span>
<a href="#l9.312"></a><span id="l9.312"> </span>
<a href="#l9.313"></a><span id="l9.313">   // A preference already exists to define scroll speed, let's use it.</span>
<a href="#l9.314"></a><span id="l9.314">   get SCROLL_SPEED() {</span>
<a href="#l9.315"></a><span id="l9.315">     delete this.SCROLL_SPEED;</span>
<a href="#l9.316"></a><span id="l9.316" class="difflineminus">-    try {</span>
<a href="#l9.317"></a><span id="l9.317" class="difflineminus">-      this.SCROLL_SPEED =</span>
<a href="#l9.318"></a><span id="l9.318" class="difflineminus">-        Services.prefs.getIntPref(&quot;toolkit.scrollbox.scrollIncrement&quot;);</span>
<a href="#l9.319"></a><span id="l9.319" class="difflineminus">-    }</span>
<a href="#l9.320"></a><span id="l9.320" class="difflineminus">-    catch (e) {</span>
<a href="#l9.321"></a><span id="l9.321" class="difflineminus">-      this.SCROLL_SPEED = 20;</span>
<a href="#l9.322"></a><span id="l9.322" class="difflineminus">-    }</span>
<a href="#l9.323"></a><span id="l9.323" class="difflineplus">+    this.SCROLL_SPEED = Services.prefs.getIntPref(&quot;toolkit.scrollbox.scrollIncrement&quot;, 20);</span>
<a href="#l9.324"></a><span id="l9.324">     return this.SCROLL_SPEED;</span>
<a href="#l9.325"></a><span id="l9.325">   },</span>
<a href="#l9.326"></a><span id="l9.326"> </span>
<a href="#l9.327"></a><span id="l9.327">   onDragStart: function amdnd_onDragStart(aEvent, aTransferData, aAction) {</span>
<a href="#l9.328"></a><span id="l9.328">     let accountElement = aEvent.explicitOriginalTarget;</span>
<a href="#l9.329"></a><span id="l9.329">     // This stops the dragging session.</span>
<a href="#l9.330"></a><span id="l9.330">     if (!(accountElement instanceof Ci.nsIDOMXULSelectControlItemElement))</span>
<a href="#l9.331"></a><span id="l9.331">       throw &quot;Element is not draggable!&quot;;</span>
<a href="#l9.332"></a><span id="l9.332" class="difflineat">@@ -622,18 +610,17 @@ var gAMDragAndDrop = {</span>
<a href="#l9.333"></a><span id="l9.333"> </span>
<a href="#l9.334"></a><span id="l9.334">     if (aEvent.clientY &lt; accountElement.getBoundingClientRect().top +</span>
<a href="#l9.335"></a><span id="l9.335">                          accountElement.clientHeight / 2) {</span>
<a href="#l9.336"></a><span id="l9.336">       // we don't want the previous item to show its default bottom-border</span>
<a href="#l9.337"></a><span id="l9.337">       let previousItem = accountElement.previousSibling;</span>
<a href="#l9.338"></a><span id="l9.338">       if (previousItem)</span>
<a href="#l9.339"></a><span id="l9.339">         previousItem.style.borderBottom = &quot;none&quot;;</span>
<a href="#l9.340"></a><span id="l9.340">       accountElement.setAttribute(&quot;dragover&quot;, &quot;up&quot;);</span>
<a href="#l9.341"></a><span id="l9.341" class="difflineminus">-    }</span>
<a href="#l9.342"></a><span id="l9.342" class="difflineminus">-    else {</span>
<a href="#l9.343"></a><span id="l9.343" class="difflineplus">+    } else {</span>
<a href="#l9.344"></a><span id="l9.344">       if ((&quot;_accountElement&quot; in this) &amp;&amp;</span>
<a href="#l9.345"></a><span id="l9.345">           this._accountElement == accountElement &amp;&amp;</span>
<a href="#l9.346"></a><span id="l9.346">           accountElement.getAttribute(&quot;dragover&quot;) == &quot;up&quot;)</span>
<a href="#l9.347"></a><span id="l9.347">         this.cleanBorders();</span>
<a href="#l9.348"></a><span id="l9.348">       accountElement.setAttribute(&quot;dragover&quot;, &quot;down&quot;);</span>
<a href="#l9.349"></a><span id="l9.349">     }</span>
<a href="#l9.350"></a><span id="l9.350"> </span>
<a href="#l9.351"></a><span id="l9.351">     this._accountElement = accountElement;</span>
<a href="#l9.352"></a><span id="l9.352" class="difflineat">@@ -698,12 +685,12 @@ var gAMDragAndDrop = {</span>
<a href="#l9.353"></a><span id="l9.353">     gAccountManager.moveCurrentItem(offset);</span>
<a href="#l9.354"></a><span id="l9.354">   },</span>
<a href="#l9.355"></a><span id="l9.355"> </span>
<a href="#l9.356"></a><span id="l9.356">   getSupportedFlavours: function amdnd_getSupportedFlavours() {</span>
<a href="#l9.357"></a><span id="l9.357">     var flavours = new FlavourSet();</span>
<a href="#l9.358"></a><span id="l9.358">     flavours.appendFlavour(this.ACCOUNT_MIME_TYPE,</span>
<a href="#l9.359"></a><span id="l9.359">                            &quot;nsIDOMXULSelectControlItemElement&quot;);</span>
<a href="#l9.360"></a><span id="l9.360">     return flavours;</span>
<a href="#l9.361"></a><span id="l9.361" class="difflineminus">-  }</span>
<a href="#l9.362"></a><span id="l9.362" class="difflineplus">+  },</span>
<a href="#l9.363"></a><span id="l9.363"> };</span>
<a href="#l9.364"></a><span id="l9.364"> </span>
<a href="#l9.365"></a><span id="l9.365"> window.addEventListener(&quot;DOMContentLoaded&quot;, () =&gt; { gAccountManager.load(); });</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mail/components/im/content/imContextMenu.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mail/components/im/content/imContextMenu.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -1,12 +1,15 @@</span>
<a href="#l10.4"></a><span id="l10.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l10.5"></a><span id="l10.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l10.6"></a><span id="l10.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l10.7"></a><span id="l10.7"> </span>
<a href="#l10.8"></a><span id="l10.8" class="difflineplus">+// This file is loaded in messenger.xul.</span>
<a href="#l10.9"></a><span id="l10.9" class="difflineplus">+/* globals gatherTextUnder, goUpdateGlobalEditMenuItems, makeURLAbsolute, Services */</span>
<a href="#l10.10"></a><span id="l10.10" class="difflineplus">+</span>
<a href="#l10.11"></a><span id="l10.11"> var gChatContextMenu = null;</span>
<a href="#l10.12"></a><span id="l10.12"> </span>
<a href="#l10.13"></a><span id="l10.13"> function imContextMenu(aXulMenu) {</span>
<a href="#l10.14"></a><span id="l10.14">   this.target            = null;</span>
<a href="#l10.15"></a><span id="l10.15">   this.menu              = null;</span>
<a href="#l10.16"></a><span id="l10.16">   this.onLink            = false;</span>
<a href="#l10.17"></a><span id="l10.17">   this.onMailtoLink      = false;</span>
<a href="#l10.18"></a><span id="l10.18">   this.onSaveableLink    = false;</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineat">@@ -18,25 +21,25 @@ function imContextMenu(aXulMenu) {</span>
<a href="#l10.20"></a><span id="l10.20">   this.isContentSelected = false;</span>
<a href="#l10.21"></a><span id="l10.21">   this.shouldDisplay     = true;</span>
<a href="#l10.22"></a><span id="l10.22">   this.ellipsis = &quot;\u2026&quot;;</span>
<a href="#l10.23"></a><span id="l10.23"> </span>
<a href="#l10.24"></a><span id="l10.24">   try {</span>
<a href="#l10.25"></a><span id="l10.25">     this.ellipsis =</span>
<a href="#l10.26"></a><span id="l10.26">       Services.prefs.getComplexValue(&quot;intl.ellipsis&quot;,</span>
<a href="#l10.27"></a><span id="l10.27">                                      Ci.nsIPrefLocalizedString).data;</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineminus">-  } catch (e) { }</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineplus">+  } catch (e) {}</span>
<a href="#l10.30"></a><span id="l10.30"> </span>
<a href="#l10.31"></a><span id="l10.31">   // Initialize new menu.</span>
<a href="#l10.32"></a><span id="l10.32">   this.initMenu(aXulMenu);</span>
<a href="#l10.33"></a><span id="l10.33"> }</span>
<a href="#l10.34"></a><span id="l10.34"> </span>
<a href="#l10.35"></a><span id="l10.35"> // Prototype for nsContextMenu &quot;class.&quot;</span>
<a href="#l10.36"></a><span id="l10.36"> imContextMenu.prototype = {</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineminus">-  cleanup: function() {</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineplus">+  cleanup() {</span>
<a href="#l10.39"></a><span id="l10.39">     let elt = document.getElementById(&quot;context-sep-messageactions&quot;).nextSibling;</span>
<a href="#l10.40"></a><span id="l10.40">     // remove the action menuitems added last time we opened the popup</span>
<a href="#l10.41"></a><span id="l10.41">     while (elt &amp;&amp; elt.localName != &quot;menuseparator&quot;) {</span>
<a href="#l10.42"></a><span id="l10.42">       let tmp = elt.nextSibling;</span>
<a href="#l10.43"></a><span id="l10.43">       elt.remove();</span>
<a href="#l10.44"></a><span id="l10.44">       elt = tmp;</span>
<a href="#l10.45"></a><span id="l10.45">     }</span>
<a href="#l10.46"></a><span id="l10.46">   },</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineat">@@ -92,31 +95,30 @@ imContextMenu.prototype = {</span>
<a href="#l10.48"></a><span id="l10.48">       menuitem.setAttribute(&quot;label&quot;, action.label);</span>
<a href="#l10.49"></a><span id="l10.49">       menuitem.setAttribute(&quot;oncommand&quot;, &quot;this.action.run();&quot;);</span>
<a href="#l10.50"></a><span id="l10.50">       menuitem.action = action;</span>
<a href="#l10.51"></a><span id="l10.51">       sep.parentNode.appendChild(menuitem);</span>
<a href="#l10.52"></a><span id="l10.52">     }</span>
<a href="#l10.53"></a><span id="l10.53">   },</span>
<a href="#l10.54"></a><span id="l10.54"> </span>
<a href="#l10.55"></a><span id="l10.55">   // Set various context menu attributes based on the state of the world.</span>
<a href="#l10.56"></a><span id="l10.56" class="difflineminus">-  setTarget: function (aNode) {</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineplus">+  setTarget(aNode) {</span>
<a href="#l10.58"></a><span id="l10.58"> </span>
<a href="#l10.59"></a><span id="l10.59">     // Initialize contextual info.</span>
<a href="#l10.60"></a><span id="l10.60">     this.onLink            = false;</span>
<a href="#l10.61"></a><span id="l10.61">     this.linkURL           = &quot;&quot;;</span>
<a href="#l10.62"></a><span id="l10.62">     this.linkURI           = null;</span>
<a href="#l10.63"></a><span id="l10.63">     this.linkProtocol      = &quot;&quot;;</span>
<a href="#l10.64"></a><span id="l10.64"> </span>
<a href="#l10.65"></a><span id="l10.65">     // Remember the node that was clicked.</span>
<a href="#l10.66"></a><span id="l10.66">     this.target = aNode;</span>
<a href="#l10.67"></a><span id="l10.67"> </span>
<a href="#l10.68"></a><span id="l10.68">     // First, do checks for nodes that never have children.</span>
<a href="#l10.69"></a><span id="l10.69">     // Second, bubble out, looking for items of interest that can have children.</span>
<a href="#l10.70"></a><span id="l10.70">     // Always pick the innermost link, background image, etc.</span>
<a href="#l10.71"></a><span id="l10.71" class="difflineminus">-    const XMLNS = &quot;http://www.w3.org/XML/1998/namespace&quot;;</span>
<a href="#l10.72"></a><span id="l10.72">     var elem = this.target;</span>
<a href="#l10.73"></a><span id="l10.73">     while (elem) {</span>
<a href="#l10.74"></a><span id="l10.74">       if (elem.nodeType == Node.ELEMENT_NODE) {</span>
<a href="#l10.75"></a><span id="l10.75">         // Link?</span>
<a href="#l10.76"></a><span id="l10.76">         if (!this.onLink &amp;&amp;</span>
<a href="#l10.77"></a><span id="l10.77">              ((elem instanceof HTMLAnchorElement &amp;&amp; elem.href) ||</span>
<a href="#l10.78"></a><span id="l10.78">               (elem instanceof HTMLAreaElement &amp;&amp; elem.href) ||</span>
<a href="#l10.79"></a><span id="l10.79">               elem instanceof HTMLLinkElement ||</span>
<a href="#l10.80"></a><span id="l10.80" class="difflineat">@@ -133,17 +135,17 @@ imContextMenu.prototype = {</span>
<a href="#l10.81"></a><span id="l10.81">           while ((parent = parent.parentNode) &amp;&amp;</span>
<a href="#l10.82"></a><span id="l10.82">                  (parent.nodeType == Node.ELEMENT_NODE)) {</span>
<a href="#l10.83"></a><span id="l10.83">             try {</span>
<a href="#l10.84"></a><span id="l10.84">               if ((parent instanceof HTMLAnchorElement &amp;&amp; parent.href) ||</span>
<a href="#l10.85"></a><span id="l10.85">                   (parent instanceof HTMLAreaElement &amp;&amp; parent.href) ||</span>
<a href="#l10.86"></a><span id="l10.86">                   parent instanceof HTMLLinkElement ||</span>
<a href="#l10.87"></a><span id="l10.87">                   parent.getAttributeNS(&quot;http://www.w3.org/1999/xlink&quot;, &quot;type&quot;) == &quot;simple&quot;)</span>
<a href="#l10.88"></a><span id="l10.88">                 realLink = parent;</span>
<a href="#l10.89"></a><span id="l10.89" class="difflineminus">-            } catch (e) { }</span>
<a href="#l10.90"></a><span id="l10.90" class="difflineplus">+            } catch (e) {}</span>
<a href="#l10.91"></a><span id="l10.91">           }</span>
<a href="#l10.92"></a><span id="l10.92"> </span>
<a href="#l10.93"></a><span id="l10.93">           // Remember corresponding element.</span>
<a href="#l10.94"></a><span id="l10.94">           this.link = realLink;</span>
<a href="#l10.95"></a><span id="l10.95">           this.linkURL = this.getLinkURL();</span>
<a href="#l10.96"></a><span id="l10.96">           this.linkURI = this.getLinkURI();</span>
<a href="#l10.97"></a><span id="l10.97">           this.linkProtocol = this.getLinkProtocol();</span>
<a href="#l10.98"></a><span id="l10.98">           this.onMailtoLink = (this.linkProtocol == &quot;mailto&quot;);</span>
<a href="#l10.99"></a><span id="l10.99" class="difflineat">@@ -151,158 +153,150 @@ imContextMenu.prototype = {</span>
<a href="#l10.100"></a><span id="l10.100">         }</span>
<a href="#l10.101"></a><span id="l10.101">       }</span>
<a href="#l10.102"></a><span id="l10.102"> </span>
<a href="#l10.103"></a><span id="l10.103">       elem = elem.parentNode;</span>
<a href="#l10.104"></a><span id="l10.104">     }</span>
<a href="#l10.105"></a><span id="l10.105">   },</span>
<a href="#l10.106"></a><span id="l10.106"> </span>
<a href="#l10.107"></a><span id="l10.107">   // Returns true if clicked-on link targets a resource that can be saved.</span>
<a href="#l10.108"></a><span id="l10.108" class="difflineminus">-  isLinkSaveable: function(aLink) {</span>
<a href="#l10.109"></a><span id="l10.109" class="difflineminus">-    return this.linkProtocol &amp;&amp; !(</span>
<a href="#l10.110"></a><span id="l10.110" class="difflineminus">-             this.linkProtocol == &quot;mailto&quot;     ||</span>
<a href="#l10.111"></a><span id="l10.111" class="difflineminus">-             this.linkProtocol == &quot;javascript&quot; ||</span>
<a href="#l10.112"></a><span id="l10.112" class="difflineminus">-             this.linkProtocol == &quot;news&quot;       ||</span>
<a href="#l10.113"></a><span id="l10.113" class="difflineminus">-             this.linkProtocol == &quot;snews&quot;      );</span>
<a href="#l10.114"></a><span id="l10.114" class="difflineplus">+  isLinkSaveable(aLink) {</span>
<a href="#l10.115"></a><span id="l10.115" class="difflineplus">+    return this.linkProtocol &amp;&amp;</span>
<a href="#l10.116"></a><span id="l10.116" class="difflineplus">+      ![&quot;mailto&quot;, &quot;javascript&quot;, &quot;news&quot;, &quot;snews&quot;].includes(this.linkProtocol);</span>
<a href="#l10.117"></a><span id="l10.117">   },</span>
<a href="#l10.118"></a><span id="l10.118"> </span>
<a href="#l10.119"></a><span id="l10.119">   // Open linked-to URL in a new window.</span>
<a href="#l10.120"></a><span id="l10.120" class="difflineminus">-  openLink: function (aURI) {</span>
<a href="#l10.121"></a><span id="l10.121" class="difflineplus">+  openLink(aURI) {</span>
<a href="#l10.122"></a><span id="l10.122">     Cc[&quot;@mozilla.org/uriloader/external-protocol-service;1&quot;].</span>
<a href="#l10.123"></a><span id="l10.123">     getService(Ci.nsIExternalProtocolService).</span>
<a href="#l10.124"></a><span id="l10.124">     loadURI(aURI || this.linkURI, window);</span>
<a href="#l10.125"></a><span id="l10.125">   },</span>
<a href="#l10.126"></a><span id="l10.126"> </span>
<a href="#l10.127"></a><span id="l10.127">   // Generate email address and put it on clipboard.</span>
<a href="#l10.128"></a><span id="l10.128" class="difflineminus">-  copyEmail: function() {</span>
<a href="#l10.129"></a><span id="l10.129" class="difflineplus">+  copyEmail() {</span>
<a href="#l10.130"></a><span id="l10.130">     // Copy the comma-separated list of email addresses only.</span>
<a href="#l10.131"></a><span id="l10.131">     // There are other ways of embedding email addresses in a mailto:</span>
<a href="#l10.132"></a><span id="l10.132">     // link, but such complex parsing is beyond us.</span>
<a href="#l10.133"></a><span id="l10.133">     var url = this.linkURL;</span>
<a href="#l10.134"></a><span id="l10.134">     var qmark = url.indexOf(&quot;?&quot;);</span>
<a href="#l10.135"></a><span id="l10.135">     var addresses;</span>
<a href="#l10.136"></a><span id="l10.136"> </span>
<a href="#l10.137"></a><span id="l10.137">     // 7 == length of &quot;mailto:&quot;</span>
<a href="#l10.138"></a><span id="l10.138">     addresses = qmark &gt; 7 ? url.substring(7, qmark) : url.substr(7);</span>
<a href="#l10.139"></a><span id="l10.139"> </span>
<a href="#l10.140"></a><span id="l10.140">     // Let's try to unescape it using a character set</span>
<a href="#l10.141"></a><span id="l10.141">     // in case the address is not ASCII.</span>
<a href="#l10.142"></a><span id="l10.142">     try {</span>
<a href="#l10.143"></a><span id="l10.143">       var characterSet = this.target.ownerDocument.characterSet;</span>
<a href="#l10.144"></a><span id="l10.144" class="difflineminus">-      const textToSubURI = Cc[&quot;@mozilla.org/intl/texttosuburi;1&quot;].</span>
<a href="#l10.145"></a><span id="l10.145" class="difflineminus">-                           getService(Ci.nsITextToSubURI);</span>
<a href="#l10.146"></a><span id="l10.146" class="difflineminus">-      addresses = textToSubURI.unEscapeURIForUI(characterSet, addresses);</span>
<a href="#l10.147"></a><span id="l10.147" class="difflineminus">-    }</span>
<a href="#l10.148"></a><span id="l10.148" class="difflineminus">-    catch(ex) {</span>
<a href="#l10.149"></a><span id="l10.149" class="difflineplus">+      addresses = Services.textToSubURI.unEscapeURIForUI(characterSet, addresses);</span>
<a href="#l10.150"></a><span id="l10.150" class="difflineplus">+    } catch (ex) {</span>
<a href="#l10.151"></a><span id="l10.151">       // Do nothing.</span>
<a href="#l10.152"></a><span id="l10.152">     }</span>
<a href="#l10.153"></a><span id="l10.153"> </span>
<a href="#l10.154"></a><span id="l10.154">     var clipboard = Cc[&quot;@mozilla.org/widget/clipboardhelper;1&quot;].</span>
<a href="#l10.155"></a><span id="l10.155">                     getService(Ci.nsIClipboardHelper);</span>
<a href="#l10.156"></a><span id="l10.156">     clipboard.copyString(addresses);</span>
<a href="#l10.157"></a><span id="l10.157">   },</span>
<a href="#l10.158"></a><span id="l10.158"> </span>
<a href="#l10.159"></a><span id="l10.159" class="difflineminus">-  ///////////////</span>
<a href="#l10.160"></a><span id="l10.160" class="difflineminus">-  // Utilities //</span>
<a href="#l10.161"></a><span id="l10.161" class="difflineminus">-  ///////////////</span>
<a href="#l10.162"></a><span id="l10.162" class="difflineplus">+  // ---------</span>
<a href="#l10.163"></a><span id="l10.163" class="difflineplus">+  // Utilities</span>
<a href="#l10.164"></a><span id="l10.164"> </span>
<a href="#l10.165"></a><span id="l10.165">   // Show/hide one item (specified via name or the item element itself).</span>
<a href="#l10.166"></a><span id="l10.166" class="difflineminus">-  showItem: function(aItemOrId, aShow) {</span>
<a href="#l10.167"></a><span id="l10.167" class="difflineplus">+  showItem(aItemOrId, aShow) {</span>
<a href="#l10.168"></a><span id="l10.168">     var item = aItemOrId.constructor == String ?</span>
<a href="#l10.169"></a><span id="l10.169">       document.getElementById(aItemOrId) : aItemOrId;</span>
<a href="#l10.170"></a><span id="l10.170">     if (item)</span>
<a href="#l10.171"></a><span id="l10.171">       item.hidden = !aShow;</span>
<a href="#l10.172"></a><span id="l10.172">   },</span>
<a href="#l10.173"></a><span id="l10.173"> </span>
<a href="#l10.174"></a><span id="l10.174">   // Temporary workaround for DOM api not yet implemented by XUL nodes.</span>
<a href="#l10.175"></a><span id="l10.175" class="difflineminus">-  cloneNode: function(aItem) {</span>
<a href="#l10.176"></a><span id="l10.176" class="difflineplus">+  cloneNode(aItem) {</span>
<a href="#l10.177"></a><span id="l10.177">     // Create another element like the one we're cloning.</span>
<a href="#l10.178"></a><span id="l10.178">     var node = document.createElement(aItem.tagName);</span>
<a href="#l10.179"></a><span id="l10.179"> </span>
<a href="#l10.180"></a><span id="l10.180">     // Copy attributes from argument item to the new one.</span>
<a href="#l10.181"></a><span id="l10.181">     var attrs = aItem.attributes;</span>
<a href="#l10.182"></a><span id="l10.182">     for (var i = 0; i &lt; attrs.length; i++) {</span>
<a href="#l10.183"></a><span id="l10.183">       var attr = attrs.item(i);</span>
<a href="#l10.184"></a><span id="l10.184">       node.setAttribute(attr.nodeName, attr.nodeValue);</span>
<a href="#l10.185"></a><span id="l10.185">     }</span>
<a href="#l10.186"></a><span id="l10.186"> </span>
<a href="#l10.187"></a><span id="l10.187">     // Voila!</span>
<a href="#l10.188"></a><span id="l10.188">     return node;</span>
<a href="#l10.189"></a><span id="l10.189">   },</span>
<a href="#l10.190"></a><span id="l10.190"> </span>
<a href="#l10.191"></a><span id="l10.191">   // Generate fully qualified URL for clicked-on link.</span>
<a href="#l10.192"></a><span id="l10.192" class="difflineminus">-  getLinkURL: function() {</span>
<a href="#l10.193"></a><span id="l10.193" class="difflineplus">+  getLinkURL() {</span>
<a href="#l10.194"></a><span id="l10.194">     var href = this.link.href;</span>
<a href="#l10.195"></a><span id="l10.195">     if (href)</span>
<a href="#l10.196"></a><span id="l10.196">       return href;</span>
<a href="#l10.197"></a><span id="l10.197"> </span>
<a href="#l10.198"></a><span id="l10.198">     href = this.link.getAttributeNS(&quot;http://www.w3.org/1999/xlink&quot;,</span>
<a href="#l10.199"></a><span id="l10.199">                                     &quot;href&quot;);</span>
<a href="#l10.200"></a><span id="l10.200"> </span>
<a href="#l10.201"></a><span id="l10.201">     if (!href || (href.trim() == &quot;&quot;)) {</span>
<a href="#l10.202"></a><span id="l10.202">       // Without this we try to save as the current doc,</span>
<a href="#l10.203"></a><span id="l10.203">       // for example, HTML case also throws if empty</span>
<a href="#l10.204"></a><span id="l10.204">       throw &quot;Empty href&quot;;</span>
<a href="#l10.205"></a><span id="l10.205">     }</span>
<a href="#l10.206"></a><span id="l10.206"> </span>
<a href="#l10.207"></a><span id="l10.207">     return makeURLAbsolute(this.link.baseURI, href);</span>
<a href="#l10.208"></a><span id="l10.208">   },</span>
<a href="#l10.209"></a><span id="l10.209"> </span>
<a href="#l10.210"></a><span id="l10.210" class="difflineminus">-  getLinkURI: function() {</span>
<a href="#l10.211"></a><span id="l10.211" class="difflineplus">+  getLinkURI() {</span>
<a href="#l10.212"></a><span id="l10.212">     try {</span>
<a href="#l10.213"></a><span id="l10.213">       return Services.io.newURI(this.linkURL);</span>
<a href="#l10.214"></a><span id="l10.214" class="difflineminus">-    }</span>
<a href="#l10.215"></a><span id="l10.215" class="difflineminus">-    catch (ex) {</span>
<a href="#l10.216"></a><span id="l10.216" class="difflineminus">-     // e.g. empty URL string</span>
<a href="#l10.217"></a><span id="l10.217" class="difflineplus">+    } catch (ex) {</span>
<a href="#l10.218"></a><span id="l10.218" class="difflineplus">+      // e.g. empty URL string</span>
<a href="#l10.219"></a><span id="l10.219">     }</span>
<a href="#l10.220"></a><span id="l10.220"> </span>
<a href="#l10.221"></a><span id="l10.221">     return null;</span>
<a href="#l10.222"></a><span id="l10.222">   },</span>
<a href="#l10.223"></a><span id="l10.223"> </span>
<a href="#l10.224"></a><span id="l10.224" class="difflineminus">-  getLinkProtocol: function() {</span>
<a href="#l10.225"></a><span id="l10.225" class="difflineplus">+  getLinkProtocol() {</span>
<a href="#l10.226"></a><span id="l10.226">     if (this.linkURI)</span>
<a href="#l10.227"></a><span id="l10.227">       return this.linkURI.scheme; // can be |undefined|</span>
<a href="#l10.228"></a><span id="l10.228"> </span>
<a href="#l10.229"></a><span id="l10.229">     return null;</span>
<a href="#l10.230"></a><span id="l10.230">   },</span>
<a href="#l10.231"></a><span id="l10.231"> </span>
<a href="#l10.232"></a><span id="l10.232">   // Get text of link.</span>
<a href="#l10.233"></a><span id="l10.233" class="difflineminus">-  linkText: function() {</span>
<a href="#l10.234"></a><span id="l10.234" class="difflineplus">+  linkText() {</span>
<a href="#l10.235"></a><span id="l10.235">     var text = gatherTextUnder(this.link);</span>
<a href="#l10.236"></a><span id="l10.236">     if (text == &quot;&quot;) {</span>
<a href="#l10.237"></a><span id="l10.237">       text = this.link.getAttribute(&quot;title&quot;);</span>
<a href="#l10.238"></a><span id="l10.238">       if (!text || (text.trim() == &quot;&quot;)) {</span>
<a href="#l10.239"></a><span id="l10.239">         text = this.link.getAttribute(&quot;alt&quot;);</span>
<a href="#l10.240"></a><span id="l10.240">         if (!text || (text.trim() == &quot;&quot;))</span>
<a href="#l10.241"></a><span id="l10.241">           text = this.linkURL;</span>
<a href="#l10.242"></a><span id="l10.242">       }</span>
<a href="#l10.243"></a><span id="l10.243">     }</span>
<a href="#l10.244"></a><span id="l10.244"> </span>
<a href="#l10.245"></a><span id="l10.245">     return text;</span>
<a href="#l10.246"></a><span id="l10.246">   },</span>
<a href="#l10.247"></a><span id="l10.247"> </span>
<a href="#l10.248"></a><span id="l10.248">   // Get selected text. Only display the first 15 chars.</span>
<a href="#l10.249"></a><span id="l10.249" class="difflineminus">-  isTextSelection: function() {</span>
<a href="#l10.250"></a><span id="l10.250" class="difflineplus">+  isTextSelection() {</span>
<a href="#l10.251"></a><span id="l10.251">     // Get 16 characters, so that we can trim the selection if it's greater</span>
<a href="#l10.252"></a><span id="l10.252">     // than 15 chars</span>
<a href="#l10.253"></a><span id="l10.253">     var selectedText = getBrowserSelection(16);</span>
<a href="#l10.254"></a><span id="l10.254"> </span>
<a href="#l10.255"></a><span id="l10.255">     if (!selectedText)</span>
<a href="#l10.256"></a><span id="l10.256">       return false;</span>
<a href="#l10.257"></a><span id="l10.257"> </span>
<a href="#l10.258"></a><span id="l10.258">     if (selectedText.length &gt; 15)</span>
<a href="#l10.259"></a><span id="l10.259" class="difflineminus">-      selectedText = selectedText.substr(0,15) + this.ellipsis;</span>
<a href="#l10.260"></a><span id="l10.260" class="difflineplus">+      selectedText = selectedText.substr(0, 15) + this.ellipsis;</span>
<a href="#l10.261"></a><span id="l10.261"> </span>
<a href="#l10.262"></a><span id="l10.262">     return true;</span>
<a href="#l10.263"></a><span id="l10.263">   },</span>
<a href="#l10.264"></a><span id="l10.264"> </span>
<a href="#l10.265"></a><span id="l10.265">   // Returns true if anything is selected.</span>
<a href="#l10.266"></a><span id="l10.266" class="difflineminus">-  isContentSelection: function() {</span>
<a href="#l10.267"></a><span id="l10.267" class="difflineplus">+  isContentSelection() {</span>
<a href="#l10.268"></a><span id="l10.268">     return !document.commandDispatcher.focusedWindow.getSelection().isCollapsed;</span>
<a href="#l10.269"></a><span id="l10.269" class="difflineminus">-  }</span>
<a href="#l10.270"></a><span id="l10.270" class="difflineplus">+  },</span>
<a href="#l10.271"></a><span id="l10.271"> };</span>
<a href="#l10.272"></a><span id="l10.272"> </span>
<a href="#l10.273"></a><span id="l10.273"> /**</span>
<a href="#l10.274"></a><span id="l10.274">  * Gets the selected text in the active browser. Leading and trailing</span>
<a href="#l10.275"></a><span id="l10.275">  * whitespace is removed, and consecutive whitespace is replaced by a single</span>
<a href="#l10.276"></a><span id="l10.276">  * space. A maximum of 150 characters will be returned, regardless of the value</span>
<a href="#l10.277"></a><span id="l10.277">  * of aCharLen.</span>
<a href="#l10.278"></a><span id="l10.278">  *</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mail/components/im/content/imStatusSelector.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mail/components/im/content/imStatusSelector.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -1,13 +1,17 @@</span>
<a href="#l11.4"></a><span id="l11.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l11.5"></a><span id="l11.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l11.6"></a><span id="l11.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l11.7"></a><span id="l11.7"> </span>
<a href="#l11.8"></a><span id="l11.8" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/imStatusUtils.jsm&quot;);</span>
<a href="#l11.9"></a><span id="l11.9" class="difflineplus">+// chat/modules/imTextboxUtils.jsm</span>
<a href="#l11.10"></a><span id="l11.10" class="difflineplus">+/* globals TextboxSpellChecker */</span>
<a href="#l11.11"></a><span id="l11.11" class="difflineplus">+</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+var { Status } = ChromeUtils.import(&quot;resource:///modules/imStatusUtils.jsm&quot;, null);</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+var { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;, null);</span>
<a href="#l11.14"></a><span id="l11.14"> </span>
<a href="#l11.15"></a><span id="l11.15"> var statusSelector = {</span>
<a href="#l11.16"></a><span id="l11.16">   observe: function ss_observe(aSubject, aTopic, aMsg) {</span>
<a href="#l11.17"></a><span id="l11.17">     if (aTopic == &quot;status-changed&quot;)</span>
<a href="#l11.18"></a><span id="l11.18">       this.displayCurrentStatus();</span>
<a href="#l11.19"></a><span id="l11.19">     else if (aTopic == &quot;user-icon-changed&quot;)</span>
<a href="#l11.20"></a><span id="l11.20">       this.displayUserIcon();</span>
<a href="#l11.21"></a><span id="l11.21">     else if (aTopic == &quot;user-display-name-changed&quot;)</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineat">@@ -159,18 +163,17 @@ var statusSelector = {</span>
<a href="#l11.23"></a><span id="l11.23">           newStatus = Ci.imIStatusInfo.STATUS_OFFLINE;</span>
<a href="#l11.24"></a><span id="l11.24">         delete this._statusTypeBeforeEditing;</span>
<a href="#l11.25"></a><span id="l11.25">         delete this._statusTypeEditing;</span>
<a href="#l11.26"></a><span id="l11.26">       }</span>
<a href="#l11.27"></a><span id="l11.27">       // apply the new status only if it is different from the current one</span>
<a href="#l11.28"></a><span id="l11.28">       if (newStatus != Ci.imIStatusInfo.STATUS_UNKNOWN ||</span>
<a href="#l11.29"></a><span id="l11.29">           elt.value != elt.getAttribute(&quot;value&quot;))</span>
<a href="#l11.30"></a><span id="l11.30">         Services.core.globalUserStatus.setStatus(newStatus, elt.value);</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineminus">-    }</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineminus">-    else if (&quot;_statusTypeBeforeEditing&quot; in this) {</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineplus">+    } else if (&quot;_statusTypeBeforeEditing&quot; in this) {</span>
<a href="#l11.34"></a><span id="l11.34">       this.displayStatusType(this._statusTypeBeforeEditing);</span>
<a href="#l11.35"></a><span id="l11.35">       delete this._statusTypeBeforeEditing;</span>
<a href="#l11.36"></a><span id="l11.36">       delete this._statusTypeEditing;</span>
<a href="#l11.37"></a><span id="l11.37">     }</span>
<a href="#l11.38"></a><span id="l11.38"> </span>
<a href="#l11.39"></a><span id="l11.39">     if (elt.hasAttribute(&quot;usingDefault&quot;))</span>
<a href="#l11.40"></a><span id="l11.40">       elt.setAttribute(&quot;value&quot;, elt.getAttribute(&quot;usingDefault&quot;));</span>
<a href="#l11.41"></a><span id="l11.41">     TextboxSpellChecker.unregisterTextbox(elt);</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineat">@@ -282,10 +285,10 @@ var statusSelector = {</span>
<a href="#l11.43"></a><span id="l11.43">     statusSelector._events = events;</span>
<a href="#l11.44"></a><span id="l11.44"> </span>
<a href="#l11.45"></a><span id="l11.45">     window.addEventListener(&quot;unload&quot;, statusSelector.unload);</span>
<a href="#l11.46"></a><span id="l11.46">   },</span>
<a href="#l11.47"></a><span id="l11.47"> </span>
<a href="#l11.48"></a><span id="l11.48">   unload: function ss_unload() {</span>
<a href="#l11.49"></a><span id="l11.49">     for (let event of statusSelector._events)</span>
<a href="#l11.50"></a><span id="l11.50">       Services.obs.removeObserver(statusSelector, event);</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineminus">-   }</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineplus">+   },</span>
<a href="#l11.53"></a><span id="l11.53"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mail/components/im/content/imcontact.xml</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mail/components/im/content/imcontact.xml</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -215,33 +215,33 @@</span>
<a href="#l12.4"></a><span id="l12.4">     &lt;/implementation&gt;</span>
<a href="#l12.5"></a><span id="l12.5">     &lt;handlers&gt;</span>
<a href="#l12.6"></a><span id="l12.6">      &lt;handler event=&quot;blur&quot;&gt;</span>
<a href="#l12.7"></a><span id="l12.7">        &lt;![CDATA[</span>
<a href="#l12.8"></a><span id="l12.8">          if (!this.hasAttribute(&quot;aliasing&quot;))</span>
<a href="#l12.9"></a><span id="l12.9">            return;</span>
<a href="#l12.10"></a><span id="l12.10"> </span>
<a href="#l12.11"></a><span id="l12.11">          if (Services.focus.activeWindow == document.defaultView)</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-           finishAliasing(true);</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+           this.finishAliasing(true);</span>
<a href="#l12.14"></a><span id="l12.14">        ]]&gt;</span>
<a href="#l12.15"></a><span id="l12.15">      &lt;/handler&gt;</span>
<a href="#l12.16"></a><span id="l12.16"> </span>
<a href="#l12.17"></a><span id="l12.17">      &lt;handler event=&quot;mousedown&quot;&gt;</span>
<a href="#l12.18"></a><span id="l12.18">        &lt;![CDATA[</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineminus">-         if (!this.hasAttribute(&quot;aliasing&quot;) &amp;&amp; canOpenConversation() &amp;&amp;</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineplus">+         if (!this.hasAttribute(&quot;aliasing&quot;) &amp;&amp; this.canOpenConversation() &amp;&amp;</span>
<a href="#l12.21"></a><span id="l12.21">              event.originalTarget.getAttribute(&quot;anonid&quot;) == &quot;startChatBubble&quot;) {</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineminus">-           openConversation();</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineplus">+           this.openConversation();</span>
<a href="#l12.24"></a><span id="l12.24">            event.preventDefault();</span>
<a href="#l12.25"></a><span id="l12.25">          }</span>
<a href="#l12.26"></a><span id="l12.26">        ]]&gt;</span>
<a href="#l12.27"></a><span id="l12.27">      &lt;/handler&gt;</span>
<a href="#l12.28"></a><span id="l12.28"> </span>
<a href="#l12.29"></a><span id="l12.29">      &lt;handler event=&quot;click&quot;&gt;</span>
<a href="#l12.30"></a><span id="l12.30">        &lt;![CDATA[</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineminus">-         if (!this.hasAttribute(&quot;aliasing&quot;) &amp;&amp; canOpenConversation() &amp;&amp;</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineplus">+         if (!this.hasAttribute(&quot;aliasing&quot;) &amp;&amp; this.canOpenConversation() &amp;&amp;</span>
<a href="#l12.33"></a><span id="l12.33">              event.detail == 2 &amp;&amp;</span>
<a href="#l12.34"></a><span id="l12.34">              event.originalTarget.getAttribute(&quot;anonid&quot;) != &quot;expander&quot;)</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineminus">-           openConversation();</span>
<a href="#l12.36"></a><span id="l12.36" class="difflineplus">+           this.openConversation();</span>
<a href="#l12.37"></a><span id="l12.37">        ]]&gt;</span>
<a href="#l12.38"></a><span id="l12.38">      &lt;/handler&gt;</span>
<a href="#l12.39"></a><span id="l12.39">     &lt;/handlers&gt;</span>
<a href="#l12.40"></a><span id="l12.40">   &lt;/binding&gt;</span>
<a href="#l12.41"></a><span id="l12.41"> &lt;/bindings&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mail/components/im/content/imconv.xml</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mail/components/im/content/imconv.xml</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -127,18 +127,17 @@</span>
<a href="#l13.4"></a><span id="l13.4">             this.directedUnreadCount = 0;</span>
<a href="#l13.5"></a><span id="l13.5">             chatHandler.updateTitle();</span>
<a href="#l13.6"></a><span id="l13.6">             chatHandler.updateChatButtonState();</span>
<a href="#l13.7"></a><span id="l13.7">           }</span>
<a href="#l13.8"></a><span id="l13.8">           this.setAttribute(&quot;unreadCount&quot;, &quot;0&quot;);</span>
<a href="#l13.9"></a><span id="l13.9">           this.setAttribute(&quot;unreadTargetedCount&quot;, &quot;0&quot;);</span>
<a href="#l13.10"></a><span id="l13.10">           this.removeAttribute(&quot;unread&quot;);</span>
<a href="#l13.11"></a><span id="l13.11">           this.removeAttribute(&quot;attention&quot;);</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-        }</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineminus">-        else {</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineplus">+        } else {</span>
<a href="#l13.15"></a><span id="l13.15">           let unreadCount = this.conv.unreadIncomingMessageCount;</span>
<a href="#l13.16"></a><span id="l13.16">           let directedMessages = unreadCount;</span>
<a href="#l13.17"></a><span id="l13.17">           if (unreadCount) {</span>
<a href="#l13.18"></a><span id="l13.18">             this.setAttribute(&quot;unread&quot;, &quot;true&quot;);</span>
<a href="#l13.19"></a><span id="l13.19">             if (this.conv.isChat) {</span>
<a href="#l13.20"></a><span id="l13.20">               directedMessages = this.conv.unreadTargetedMessageCount;</span>
<a href="#l13.21"></a><span id="l13.21">               if (directedMessages)</span>
<a href="#l13.22"></a><span id="l13.22">                 this.setAttribute(&quot;attention&quot;, &quot;true&quot;);</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineat">@@ -159,18 +158,17 @@</span>
<a href="#l13.24"></a><span id="l13.24"> </span>
<a href="#l13.25"></a><span id="l13.25">         if (this.conv.isChat) {</span>
<a href="#l13.26"></a><span id="l13.26">           if (this.conv.joining)</span>
<a href="#l13.27"></a><span id="l13.27">             this.setAttribute(&quot;status&quot;, &quot;joining&quot;);</span>
<a href="#l13.28"></a><span id="l13.28">           else if (!this.conv.account.connected || this.conv.left)</span>
<a href="#l13.29"></a><span id="l13.29">             this.setAttribute(&quot;status&quot;, &quot;left&quot;);</span>
<a href="#l13.30"></a><span id="l13.30">           else</span>
<a href="#l13.31"></a><span id="l13.31">             this.removeAttribute(&quot;status&quot;);</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineminus">-        }</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineminus">-        else {</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineplus">+        } else {</span>
<a href="#l13.35"></a><span id="l13.35">           let statusType = Ci.imIStatusInfo.STATUS_UNKNOWN;</span>
<a href="#l13.36"></a><span id="l13.36">           let buddy = this.conv.buddy;</span>
<a href="#l13.37"></a><span id="l13.37">           if (buddy &amp;&amp; buddy.account.connected)</span>
<a href="#l13.38"></a><span id="l13.38">             statusType = buddy.statusType;</span>
<a href="#l13.39"></a><span id="l13.39">           if (!(&quot;Status&quot; in window))</span>
<a href="#l13.40"></a><span id="l13.40">             ChromeUtils.import(&quot;resource:///modules/imStatusUtils.jsm&quot;);</span>
<a href="#l13.41"></a><span id="l13.41">           this.setAttribute(&quot;status&quot;, Status.toAttribute(statusType));</span>
<a href="#l13.42"></a><span id="l13.42">         }</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineat">@@ -201,18 +199,17 @@</span>
<a href="#l13.44"></a><span id="l13.44">         let newSelectedItem;</span>
<a href="#l13.45"></a><span id="l13.45">         let list = this.parentNode;</span>
<a href="#l13.46"></a><span id="l13.46">         if (list.selectedItem == this)</span>
<a href="#l13.47"></a><span id="l13.47">           newSelectedItem = this.previousSibling;</span>
<a href="#l13.48"></a><span id="l13.48"> </span>
<a href="#l13.49"></a><span id="l13.49">         if (this.log) {</span>
<a href="#l13.50"></a><span id="l13.50">           this.hidden = true;</span>
<a href="#l13.51"></a><span id="l13.51">           delete this.log;</span>
<a href="#l13.52"></a><span id="l13.52" class="difflineminus">-        }</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineminus">-        else {</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineplus">+        } else {</span>
<a href="#l13.55"></a><span id="l13.55">           this.remove();</span>
<a href="#l13.56"></a><span id="l13.56">           delete this.conv;</span>
<a href="#l13.57"></a><span id="l13.57">         }</span>
<a href="#l13.58"></a><span id="l13.58">         if (newSelectedItem)</span>
<a href="#l13.59"></a><span id="l13.59">           list.selectedItem = newSelectedItem;</span>
<a href="#l13.60"></a><span id="l13.60">       ]]&gt;</span>
<a href="#l13.61"></a><span id="l13.61">       &lt;/body&gt;</span>
<a href="#l13.62"></a><span id="l13.62">      &lt;/method&gt;</span>
<a href="#l13.63"></a><span id="l13.63" class="difflineat">@@ -238,34 +235,34 @@</span>
<a href="#l13.64"></a><span id="l13.64">           return;</span>
<a href="#l13.65"></a><span id="l13.65">         }</span>
<a href="#l13.66"></a><span id="l13.66"> </span>
<a href="#l13.67"></a><span id="l13.67">         let isMac = &quot;nsILocalFileMac&quot; in Ci;</span>
<a href="#l13.68"></a><span id="l13.68">         let accelKeyPressed = isMac ? aEvent.metaKey : aEvent.ctrlKey;</span>
<a href="#l13.69"></a><span id="l13.69">         // If a character was typed or the accel+v copy shortcut was used,</span>
<a href="#l13.70"></a><span id="l13.70">         // focus the input box and resend the key event.</span>
<a href="#l13.71"></a><span id="l13.71">         if (aEvent.charCode != 0 &amp;&amp; !aEvent.altKey &amp;&amp;</span>
<a href="#l13.72"></a><span id="l13.72" class="difflineminus">-            (accelKeyPressed &amp;&amp; aEvent.charCode == 'v'.charCodeAt(0) ||</span>
<a href="#l13.73"></a><span id="l13.73" class="difflineplus">+            (accelKeyPressed &amp;&amp; aEvent.charCode == &quot;v&quot;.charCodeAt(0) ||</span>
<a href="#l13.74"></a><span id="l13.74">              !aEvent.ctrlKey &amp;&amp; !aEvent.metaKey)) {</span>
<a href="#l13.75"></a><span id="l13.75">           this.convView.focus();</span>
<a href="#l13.76"></a><span id="l13.76"> </span>
<a href="#l13.77"></a><span id="l13.77">           let clonedEvent = new KeyboardEvent(&quot;keypress&quot;, aEvent);</span>
<a href="#l13.78"></a><span id="l13.78">           this.convView.editor.inputField.dispatchEvent(clonedEvent);</span>
<a href="#l13.79"></a><span id="l13.79">           aEvent.preventDefault();</span>
<a href="#l13.80"></a><span id="l13.80">         }</span>
<a href="#l13.81"></a><span id="l13.81">       ]]&gt;</span>
<a href="#l13.82"></a><span id="l13.82">       &lt;/body&gt;</span>
<a href="#l13.83"></a><span id="l13.83">      &lt;/method&gt;</span>
<a href="#l13.84"></a><span id="l13.84">     &lt;/implementation&gt;</span>
<a href="#l13.85"></a><span id="l13.85">     &lt;handlers&gt;</span>
<a href="#l13.86"></a><span id="l13.86">      &lt;handler event=&quot;mousedown&quot; phase=&quot;capturing&quot;&gt;</span>
<a href="#l13.87"></a><span id="l13.87">        &lt;![CDATA[</span>
<a href="#l13.88"></a><span id="l13.88">          let anonid = event.originalTarget.getAttribute(&quot;anonid&quot;);</span>
<a href="#l13.89"></a><span id="l13.89">          if (anonid == &quot;closeConversationButton&quot;) {</span>
<a href="#l13.90"></a><span id="l13.90" class="difflineminus">-           closeConversation();</span>
<a href="#l13.91"></a><span id="l13.91" class="difflineplus">+           this.closeConversation();</span>
<a href="#l13.92"></a><span id="l13.92">            event.stopPropagation();</span>
<a href="#l13.93"></a><span id="l13.93">            event.preventDefault();</span>
<a href="#l13.94"></a><span id="l13.94">          }</span>
<a href="#l13.95"></a><span id="l13.95">        ]]&gt;</span>
<a href="#l13.96"></a><span id="l13.96">      &lt;/handler&gt;</span>
<a href="#l13.97"></a><span id="l13.97">     &lt;/handlers&gt;</span>
<a href="#l13.98"></a><span id="l13.98">   &lt;/binding&gt;</span>
<a href="#l13.99"></a><span id="l13.99"> &lt;/bindings&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mail/components/im/content/imconversation.xml</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mail/components/im/content/imconversation.xml</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -159,18 +159,17 @@</span>
<a href="#l14.4"></a><span id="l14.4">         if (!aMsg.system &amp;&amp; conv.isChat) {</span>
<a href="#l14.5"></a><span id="l14.5">           let name = aMsg.who;</span>
<a href="#l14.6"></a><span id="l14.6">           let color;</span>
<a href="#l14.7"></a><span id="l14.7">           if (this.buddies.has(name)) {</span>
<a href="#l14.8"></a><span id="l14.8">             let buddy = this.buddies.get(name);</span>
<a href="#l14.9"></a><span id="l14.9">             color = buddy.color;</span>
<a href="#l14.10"></a><span id="l14.10">             buddy.removeAttribute(&quot;inactive&quot;);</span>
<a href="#l14.11"></a><span id="l14.11">             this._activeBuddies[name] = true;</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-          }</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineminus">-          else {</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+          } else {</span>
<a href="#l14.15"></a><span id="l14.15">             // Buddy no longer in the room</span>
<a href="#l14.16"></a><span id="l14.16">             color = this._computeColor(name);</span>
<a href="#l14.17"></a><span id="l14.17">           }</span>
<a href="#l14.18"></a><span id="l14.18">           aMsg.color = &quot;color: hsl(&quot; + color + &quot;, 100%, 40%);&quot;;</span>
<a href="#l14.19"></a><span id="l14.19">         }</span>
<a href="#l14.20"></a><span id="l14.20"> </span>
<a href="#l14.21"></a><span id="l14.21">         // Porting note: In TB, this.tab points at the imconv richlistitem element.</span>
<a href="#l14.22"></a><span id="l14.22">         let read = this._readCount &gt; 0;</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineat">@@ -235,28 +234,26 @@</span>
<a href="#l14.24"></a><span id="l14.24">           let convToFocus = {};</span>
<a href="#l14.25"></a><span id="l14.25"> </span>
<a href="#l14.26"></a><span id="l14.26">           // The /say command is used to bypass command processing</span>
<a href="#l14.27"></a><span id="l14.27">           // (/say can be shortened to just /).</span>
<a href="#l14.28"></a><span id="l14.28">           // &quot;/say&quot; or &quot;/say &quot; should be ignored, as should &quot;/&quot; and &quot;/ &quot;.</span>
<a href="#l14.29"></a><span id="l14.29">           if (aMsg.match(/^\/(?:say)? ?$/)) {</span>
<a href="#l14.30"></a><span id="l14.30">             this.resetInput();</span>
<a href="#l14.31"></a><span id="l14.31">             return;</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineminus">-          }</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineminus">-          else if (aMsg.match(/^\/(?:say)? .*/))</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineplus">+          } else if (aMsg.match(/^\/(?:say)? .*/)) {</span>
<a href="#l14.35"></a><span id="l14.35">             aMsg = aMsg.slice(aMsg.indexOf(&quot; &quot;) + 1);</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineminus">-          else if (Services.cmd.executeCommand(aMsg, this._conv.target,</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineminus">-                                               convToFocus)) {</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineplus">+          } else if (Services.cmd.executeCommand(aMsg, this._conv.target,</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineplus">+                                                 convToFocus)) {</span>
<a href="#l14.40"></a><span id="l14.40">             this._conv.sendTyping(&quot;&quot;);</span>
<a href="#l14.41"></a><span id="l14.41">             this.resetInput();</span>
<a href="#l14.42"></a><span id="l14.42">             if (convToFocus.value)</span>
<a href="#l14.43"></a><span id="l14.43">               chatHandler.focusConversation(convToFocus.value);</span>
<a href="#l14.44"></a><span id="l14.44">             return;</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineminus">-          }</span>
<a href="#l14.46"></a><span id="l14.46" class="difflineminus">-          else if (account.protocol.slashCommandsNative &amp;&amp; account.connected) {</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineplus">+          } else if (account.protocol.slashCommandsNative &amp;&amp; account.connected) {</span>
<a href="#l14.48"></a><span id="l14.48">             let cmd = aMsg.match(/^\/[^ ]+/);</span>
<a href="#l14.49"></a><span id="l14.49">             if (cmd &amp;&amp; cmd != &quot;/me&quot;) {</span>
<a href="#l14.50"></a><span id="l14.50">               this._conv.systemMessage(</span>
<a href="#l14.51"></a><span id="l14.51">                 this.bundle.formatStringFromName(&quot;unknownCommand&quot;, [cmd], 1),</span>
<a href="#l14.52"></a><span id="l14.52">                 true);</span>
<a href="#l14.53"></a><span id="l14.53">               return;</span>
<a href="#l14.54"></a><span id="l14.54">             }</span>
<a href="#l14.55"></a><span id="l14.55">           }</span>
<a href="#l14.56"></a><span id="l14.56" class="difflineat">@@ -272,70 +269,67 @@</span>
<a href="#l14.57"></a><span id="l14.57">             let style = MessageFormat.getMessageStyle();</span>
<a href="#l14.58"></a><span id="l14.58">             let proto = this._conv.account.protocol.id;</span>
<a href="#l14.59"></a><span id="l14.59">             if (proto == &quot;prpl-msn&quot;) {</span>
<a href="#l14.60"></a><span id="l14.60">               if (&quot;color&quot; in style)</span>
<a href="#l14.61"></a><span id="l14.61">                 msg = &quot;&lt;font color=\&quot;&quot; + style.color + &quot;\&quot;&gt;&quot; + msg + &quot;&lt;/font&gt;&quot;;</span>
<a href="#l14.62"></a><span id="l14.62">               if (&quot;fontFamily&quot; in style)</span>
<a href="#l14.63"></a><span id="l14.63">                 msg = &quot;&lt;font face=\&quot;&quot; + style.fontFamily + &quot;\&quot;&gt;&quot; + msg + &quot;&lt;/font&gt;&quot;;</span>
<a href="#l14.64"></a><span id="l14.64">               // MSN doesn't support font size info in messages...</span>
<a href="#l14.65"></a><span id="l14.65" class="difflineminus">-            }</span>
<a href="#l14.66"></a><span id="l14.66" class="difflineminus">-            else if (proto == &quot;prpl-aim&quot; || proto == &quot;prpl-icq&quot;) {</span>
<a href="#l14.67"></a><span id="l14.67" class="difflineminus">-              let styleAttributes = &quot;&quot;</span>
<a href="#l14.68"></a><span id="l14.68" class="difflineplus">+            } else if (proto == &quot;prpl-aim&quot; || proto == &quot;prpl-icq&quot;) {</span>
<a href="#l14.69"></a><span id="l14.69" class="difflineplus">+              let styleAttributes = &quot;&quot;;</span>
<a href="#l14.70"></a><span id="l14.70">               if (&quot;color&quot; in style)</span>
<a href="#l14.71"></a><span id="l14.71">                 styleAttributes += &quot; color=\&quot;&quot; + style.color + &quot;\&quot;&quot;;</span>
<a href="#l14.72"></a><span id="l14.72">               if (&quot;fontFamily&quot; in style)</span>
<a href="#l14.73"></a><span id="l14.73">                 styleAttributes += &quot; face=\&quot;&quot; + style.fontFamily + &quot;\&quot;&quot;;</span>
<a href="#l14.74"></a><span id="l14.74">               if (&quot;fontSize&quot; in style) {</span>
<a href="#l14.75"></a><span id="l14.75">                 let size = style.fontSize - style.defaultFontSize;</span>
<a href="#l14.76"></a><span id="l14.76">                 if (size &lt; -4)</span>
<a href="#l14.77"></a><span id="l14.77">                   size = 1;</span>
<a href="#l14.78"></a><span id="l14.78">                 else if (size &lt; 0)</span>
<a href="#l14.79"></a><span id="l14.79">                   size = 2;</span>
<a href="#l14.80"></a><span id="l14.80">                 else if (size &lt; 3)</span>
<a href="#l14.81"></a><span id="l14.81" class="difflineminus">-                  size = 3</span>
<a href="#l14.82"></a><span id="l14.82" class="difflineplus">+                  size = 3;</span>
<a href="#l14.83"></a><span id="l14.83">                 else if (size &lt; 7)</span>
<a href="#l14.84"></a><span id="l14.84">                   size = 4;</span>
<a href="#l14.85"></a><span id="l14.85">                 else if (size &lt; 15)</span>
<a href="#l14.86"></a><span id="l14.86">                   size = 5;</span>
<a href="#l14.87"></a><span id="l14.87">                 else if (size &lt; 25)</span>
<a href="#l14.88"></a><span id="l14.88">                   size = 6;</span>
<a href="#l14.89"></a><span id="l14.89">                 else</span>
<a href="#l14.90"></a><span id="l14.90">                   size = 7;</span>
<a href="#l14.91"></a><span id="l14.91">                 styleAttributes += &quot; size=\&quot;&quot; + size + &quot;\&quot;&quot;</span>
<a href="#l14.92"></a><span id="l14.92">                                  + &quot; style=\&quot;font-size: &quot; + style.fontSize + &quot;px;\&quot;&quot;;</span>
<a href="#l14.93"></a><span id="l14.93">               }</span>
<a href="#l14.94"></a><span id="l14.94">               if (styleAttributes)</span>
<a href="#l14.95"></a><span id="l14.95">                 msg = &quot;&lt;font&quot; + styleAttributes + &quot;&gt;&quot; + msg + &quot;&lt;/font&gt;&quot;;</span>
<a href="#l14.96"></a><span id="l14.96" class="difflineminus">-            }</span>
<a href="#l14.97"></a><span id="l14.97" class="difflineminus">-            else {</span>
<a href="#l14.98"></a><span id="l14.98" class="difflineplus">+            } else {</span>
<a href="#l14.99"></a><span id="l14.99">               let styleProperties = [];</span>
<a href="#l14.100"></a><span id="l14.100">               if (&quot;color&quot; in style)</span>
<a href="#l14.101"></a><span id="l14.101">                 styleProperties.push(&quot;color: &quot; + style.color);</span>
<a href="#l14.102"></a><span id="l14.102">               if (&quot;fontFamily&quot; in style)</span>
<a href="#l14.103"></a><span id="l14.103">                 styleProperties.push(&quot;font-family: &quot; + style.fontFamily);</span>
<a href="#l14.104"></a><span id="l14.104">               if (&quot;fontSize&quot; in style)</span>
<a href="#l14.105"></a><span id="l14.105">                 styleProperties.push(&quot;font-size: &quot; + style.fontSize + &quot;px&quot;);</span>
<a href="#l14.106"></a><span id="l14.106">               style = styleProperties.join(&quot;; &quot;);</span>
<a href="#l14.107"></a><span id="l14.107">               if (style)</span>
<a href="#l14.108"></a><span id="l14.108">                 msg = &quot;&lt;span style=\&quot;&quot; + style + &quot;\&quot;&gt;&quot; + msg + &quot;&lt;/span&gt;&quot;;</span>
<a href="#l14.109"></a><span id="l14.109">             }</span>
<a href="#l14.110"></a><span id="l14.110">           }</span>
<a href="#l14.111"></a><span id="l14.111">           this._conv.sendMsg(msg);</span>
<a href="#l14.112"></a><span id="l14.112" class="difflineminus">-        }</span>
<a href="#l14.113"></a><span id="l14.113" class="difflineminus">-        else {</span>
<a href="#l14.114"></a><span id="l14.114" class="difflineplus">+        } else {</span>
<a href="#l14.115"></a><span id="l14.115">           msg = account.HTMLEscapePlainText ? msg : aMsg;</span>
<a href="#l14.116"></a><span id="l14.116"> </span>
<a href="#l14.117"></a><span id="l14.117">           if (account.noNewlines) {</span>
<a href="#l14.118"></a><span id="l14.118">             // 'Illegal operation on WrappedNative prototype object' if the this</span>
<a href="#l14.119"></a><span id="l14.119">             // object is not specified (since this._conv implements nsIClassInfo)</span>
<a href="#l14.120"></a><span id="l14.120">             msg.split(&quot;\n&quot;).forEach(this._conv.sendMsg, this._conv);</span>
<a href="#l14.121"></a><span id="l14.121" class="difflineplus">+          } else {</span>
<a href="#l14.122"></a><span id="l14.122" class="difflineplus">+            this._conv.sendMsg(msg);</span>
<a href="#l14.123"></a><span id="l14.123">           }</span>
<a href="#l14.124"></a><span id="l14.124" class="difflineminus">-          else</span>
<a href="#l14.125"></a><span id="l14.125" class="difflineminus">-            this._conv.sendMsg(msg);</span>
<a href="#l14.126"></a><span id="l14.126">         }</span>
<a href="#l14.127"></a><span id="l14.127">         // reset the textbox to its original size</span>
<a href="#l14.128"></a><span id="l14.128">         this.resetInput();</span>
<a href="#l14.129"></a><span id="l14.129">       ]]&gt;</span>
<a href="#l14.130"></a><span id="l14.130">       &lt;/body&gt;</span>
<a href="#l14.131"></a><span id="l14.131">      &lt;/method&gt;</span>
<a href="#l14.132"></a><span id="l14.132"> </span>
<a href="#l14.133"></a><span id="l14.133">      &lt;method name=&quot;_onSplitterChange&quot;&gt;</span>
<a href="#l14.134"></a><span id="l14.134" class="difflineat">@@ -360,20 +354,20 @@</span>
<a href="#l14.135"></a><span id="l14.135">        0.1 means that the textbox's height is 10% of the conversation's height.</span>
<a href="#l14.136"></a><span id="l14.136">      --&gt;</span>
<a href="#l14.137"></a><span id="l14.137">      &lt;field name=&quot;_TEXTBOX_RATIO&quot; readonly=&quot;true&quot;&gt;0.1&lt;/field&gt;</span>
<a href="#l14.138"></a><span id="l14.138"> </span>
<a href="#l14.139"></a><span id="l14.139"> </span>
<a href="#l14.140"></a><span id="l14.140">      &lt;method name=&quot;calculateTextboxDefaultHeight&quot;&gt;</span>
<a href="#l14.141"></a><span id="l14.141">       &lt;body&gt;</span>
<a href="#l14.142"></a><span id="l14.142">       &lt;![CDATA[</span>
<a href="#l14.143"></a><span id="l14.143" class="difflineminus">-        let totalSpace = parseInt(window.getComputedStyle(this, null)</span>
<a href="#l14.144"></a><span id="l14.144" class="difflineplus">+        let totalSpace = parseInt(window.getComputedStyle(this)</span>
<a href="#l14.145"></a><span id="l14.145">                                         .getPropertyValue(&quot;height&quot;));</span>
<a href="#l14.146"></a><span id="l14.146">         let textbox = this.editor;</span>
<a href="#l14.147"></a><span id="l14.147" class="difflineminus">-        let textboxStyle = window.getComputedStyle(textbox, null);</span>
<a href="#l14.148"></a><span id="l14.148" class="difflineplus">+        let textboxStyle = window.getComputedStyle(textbox);</span>
<a href="#l14.149"></a><span id="l14.149">         let lineHeight = parseInt(textboxStyle.getPropertyValue(&quot;line-height&quot;));</span>
<a href="#l14.150"></a><span id="l14.150"> </span>
<a href="#l14.151"></a><span id="l14.151">         // Compute the overhead size.</span>
<a href="#l14.152"></a><span id="l14.152">         let textboxHeight = textbox.inputField.clientHeight;</span>
<a href="#l14.153"></a><span id="l14.153">         let deckHeight = textbox.parentNode.boxObject.height;</span>
<a href="#l14.154"></a><span id="l14.154">         this._TEXTBOX_VERTICAL_OVERHEAD = deckHeight - textboxHeight;</span>
<a href="#l14.155"></a><span id="l14.155"> </span>
<a href="#l14.156"></a><span id="l14.156">         // Calculate the number of lines to display.</span>
<a href="#l14.157"></a><span id="l14.157" class="difflineat">@@ -469,18 +463,17 @@</span>
<a href="#l14.158"></a><span id="l14.158"> </span>
<a href="#l14.159"></a><span id="l14.159">         // Undo tab complete.</span>
<a href="#l14.160"></a><span id="l14.160">         if (noSelection &amp;&amp; this._completions &amp;&amp;</span>
<a href="#l14.161"></a><span id="l14.161">             event.keyCode == KeyEvent.DOM_VK_BACK_SPACE &amp;&amp;</span>
<a href="#l14.162"></a><span id="l14.162">             !event.altKey &amp;&amp; !event.ctrlKey &amp;&amp; !event.metaKey &amp;&amp; !event.shiftKey) {</span>
<a href="#l14.163"></a><span id="l14.163">           if (text == this._beforeTabComplete) {</span>
<a href="#l14.164"></a><span id="l14.164">             // Nothing to undo, so let backspace act normally.</span>
<a href="#l14.165"></a><span id="l14.165">             delete this._completions;</span>
<a href="#l14.166"></a><span id="l14.166" class="difflineminus">-          }</span>
<a href="#l14.167"></a><span id="l14.167" class="difflineminus">-          else {</span>
<a href="#l14.168"></a><span id="l14.168" class="difflineplus">+          } else {</span>
<a href="#l14.169"></a><span id="l14.169">             event.preventDefault();</span>
<a href="#l14.170"></a><span id="l14.170"> </span>
<a href="#l14.171"></a><span id="l14.171">             // First undo the comma separating multiple nicks or the suffix.</span>
<a href="#l14.172"></a><span id="l14.172">             // More than one nick:</span>
<a href="#l14.173"></a><span id="l14.173">             //   &quot;nick1, nick2: &quot; -&gt; &quot;nick1: nick2&quot;</span>
<a href="#l14.174"></a><span id="l14.174">             // Single nick: remove the suffix</span>
<a href="#l14.175"></a><span id="l14.175">             //   &quot;nick1: &quot; -&gt; &quot;nick1&quot;</span>
<a href="#l14.176"></a><span id="l14.176">             let pos = inputBox.selectionStart;</span>
<a href="#l14.177"></a><span id="l14.177" class="difflineat">@@ -564,18 +557,17 @@</span>
<a href="#l14.178"></a><span id="l14.178">           if (completingCommand) {</span>
<a href="#l14.179"></a><span id="l14.179">             for (let cmd of Services.cmd.listCommandsForConversation(this._conv)) {</span>
<a href="#l14.180"></a><span id="l14.180">               // It's possible to have a global and a protocol specific command</span>
<a href="#l14.181"></a><span id="l14.181">               // with the same name. Avoid duplicates in the |completions| array.</span>
<a href="#l14.182"></a><span id="l14.182">               let name = &quot;/&quot; + cmd.name;</span>
<a href="#l14.183"></a><span id="l14.183">               if (!completions.includes(name))</span>
<a href="#l14.184"></a><span id="l14.184">                 completions.push(name);</span>
<a href="#l14.185"></a><span id="l14.185">             }</span>
<a href="#l14.186"></a><span id="l14.186" class="difflineminus">-          }</span>
<a href="#l14.187"></a><span id="l14.187" class="difflineminus">-          else {</span>
<a href="#l14.188"></a><span id="l14.188" class="difflineplus">+          } else {</span>
<a href="#l14.189"></a><span id="l14.189">             // If it's not a command, the only thing we can complete is a nick.</span>
<a href="#l14.190"></a><span id="l14.190">             if (!this._conv.isChat)</span>
<a href="#l14.191"></a><span id="l14.191">               return;</span>
<a href="#l14.192"></a><span id="l14.192"> </span>
<a href="#l14.193"></a><span id="l14.193">             firstWordSuffix = &quot;: &quot;;</span>
<a href="#l14.194"></a><span id="l14.194"> </span>
<a href="#l14.195"></a><span id="l14.195">             completions = Array.from(this.buddies.keys());</span>
<a href="#l14.196"></a><span id="l14.196"> </span>
<a href="#l14.197"></a><span id="l14.197" class="difflineat">@@ -691,40 +683,39 @@</span>
<a href="#l14.198"></a><span id="l14.198">           delete this._shouldListCompletionsLater;</span>
<a href="#l14.199"></a><span id="l14.199">           if (this._completions.length &gt; 1) {</span>
<a href="#l14.200"></a><span id="l14.200">             let completionsList = this._completions.join(&quot; &quot;);</span>
<a href="#l14.201"></a><span id="l14.201">             if (preferredNick) {</span>
<a href="#l14.202"></a><span id="l14.202">               // If we have a preferred nick (which is completed as a whole</span>
<a href="#l14.203"></a><span id="l14.203">               // even if there are alternatives), only show the list of</span>
<a href="#l14.204"></a><span id="l14.204">               // completions on the next &lt;tab&gt; press.</span>
<a href="#l14.205"></a><span id="l14.205">               this._shouldListCompletionsLater = completionsList;</span>
<a href="#l14.206"></a><span id="l14.206" class="difflineplus">+            } else {</span>
<a href="#l14.207"></a><span id="l14.207" class="difflineplus">+              this._conv.systemMessage(completionsList);</span>
<a href="#l14.208"></a><span id="l14.208">             }</span>
<a href="#l14.209"></a><span id="l14.209" class="difflineminus">-            else</span>
<a href="#l14.210"></a><span id="l14.210" class="difflineminus">-              this._conv.systemMessage(completionsList);</span>
<a href="#l14.211"></a><span id="l14.211">           }</span>
<a href="#l14.212"></a><span id="l14.212"> </span>
<a href="#l14.213"></a><span id="l14.213">           let suffix = (isFirstWord ? firstWordSuffix : &quot;&quot;);</span>
<a href="#l14.214"></a><span id="l14.214">           this._completions = this._completions.map(c =&gt; c + suffix);</span>
<a href="#l14.215"></a><span id="l14.215"> </span>
<a href="#l14.216"></a><span id="l14.216">           let completion;</span>
<a href="#l14.217"></a><span id="l14.217">           if (this._completions.length == 1 || preferredNick) {</span>
<a href="#l14.218"></a><span id="l14.218">             // Only one possible completion? Apply it! :-)</span>
<a href="#l14.219"></a><span id="l14.219">             completion = this._completions[this._completionsIndex++];</span>
<a href="#l14.220"></a><span id="l14.220">             this._completionsIndex %= this._completions.length;</span>
<a href="#l14.221"></a><span id="l14.221" class="difflineminus">-          }</span>
<a href="#l14.222"></a><span id="l14.222" class="difflineminus">-          else {</span>
<a href="#l14.223"></a><span id="l14.223" class="difflineplus">+          } else {</span>
<a href="#l14.224"></a><span id="l14.224">             // We have several possible completions, attempt to find a common prefix.</span>
<a href="#l14.225"></a><span id="l14.225">             let maxLength = Math.min(firstCompletion.length, lastCompletion.length);</span>
<a href="#l14.226"></a><span id="l14.226">             let i = 0;</span>
<a href="#l14.227"></a><span id="l14.227">             while (i &lt; maxLength &amp;&amp; firstCompletion[i] == lastCompletion[i])</span>
<a href="#l14.228"></a><span id="l14.228">               ++i;</span>
<a href="#l14.229"></a><span id="l14.229"> </span>
<a href="#l14.230"></a><span id="l14.230" class="difflineminus">-            if (i)</span>
<a href="#l14.231"></a><span id="l14.231" class="difflineplus">+            if (i) {</span>
<a href="#l14.232"></a><span id="l14.232">               completion = firstCompletion.substring(0, i);</span>
<a href="#l14.233"></a><span id="l14.233" class="difflineminus">-            else {</span>
<a href="#l14.234"></a><span id="l14.234" class="difflineplus">+            } else {</span>
<a href="#l14.235"></a><span id="l14.235">               // Include this case so that secondNick is applied anyway,</span>
<a href="#l14.236"></a><span id="l14.236">               // in case a completion is added by another tab press.</span>
<a href="#l14.237"></a><span id="l14.237">               completion = word;</span>
<a href="#l14.238"></a><span id="l14.238">             }</span>
<a href="#l14.239"></a><span id="l14.239">           }</span>
<a href="#l14.240"></a><span id="l14.240"> </span>
<a href="#l14.241"></a><span id="l14.241">           // Always replace what the user typed as its upper/lowercase may</span>
<a href="#l14.242"></a><span id="l14.242">           // not be correct.</span>
<a href="#l14.243"></a><span id="l14.243" class="difflineat">@@ -733,31 +724,31 @@</span>
<a href="#l14.244"></a><span id="l14.244"> </span>
<a href="#l14.245"></a><span id="l14.245">           if (secondNick) {</span>
<a href="#l14.246"></a><span id="l14.246">             // Replace the trailing colon with a comma before the completed nick.</span>
<a href="#l14.247"></a><span id="l14.247">             inputBox.selectionStart -= 2;</span>
<a href="#l14.248"></a><span id="l14.248">             completion = &quot;, &quot; + completion;</span>
<a href="#l14.249"></a><span id="l14.249">           }</span>
<a href="#l14.250"></a><span id="l14.250"> </span>
<a href="#l14.251"></a><span id="l14.251">           this.addString(completion);</span>
<a href="#l14.252"></a><span id="l14.252" class="difflineplus">+        } else if (this._completions) {</span>
<a href="#l14.253"></a><span id="l14.253" class="difflineplus">+          delete this._completions;</span>
<a href="#l14.254"></a><span id="l14.254">         }</span>
<a href="#l14.255"></a><span id="l14.255" class="difflineminus">-        else if (this._completions)</span>
<a href="#l14.256"></a><span id="l14.256" class="difflineminus">-          delete this._completions;</span>
<a href="#l14.257"></a><span id="l14.257"> </span>
<a href="#l14.258"></a><span id="l14.258">         if (event.keyCode != 13)</span>
<a href="#l14.259"></a><span id="l14.259">           return;</span>
<a href="#l14.260"></a><span id="l14.260"> </span>
<a href="#l14.261"></a><span id="l14.261">         if (!event.ctrlKey &amp;&amp; !event.shiftKey &amp;&amp; !event.altKey) {</span>
<a href="#l14.262"></a><span id="l14.262">           // Prevent the default action before calling sendMsg to avoid having</span>
<a href="#l14.263"></a><span id="l14.263">           // a line break inserted in the textbox if sendMsg throws.</span>
<a href="#l14.264"></a><span id="l14.264">           event.preventDefault();</span>
<a href="#l14.265"></a><span id="l14.265">           this.sendMsg(text);</span>
<a href="#l14.266"></a><span id="l14.266" class="difflineplus">+        } else if (!event.shiftKey) {</span>
<a href="#l14.267"></a><span id="l14.267" class="difflineplus">+          this.addString(&quot;\n&quot;);</span>
<a href="#l14.268"></a><span id="l14.268">         }</span>
<a href="#l14.269"></a><span id="l14.269" class="difflineminus">-        else if (!event.shiftKey)</span>
<a href="#l14.270"></a><span id="l14.270" class="difflineminus">-          this.addString(&quot;\n&quot;);</span>
<a href="#l14.271"></a><span id="l14.271">       ]]&gt;</span>
<a href="#l14.272"></a><span id="l14.272">       &lt;/body&gt;</span>
<a href="#l14.273"></a><span id="l14.273">      &lt;/method&gt;</span>
<a href="#l14.274"></a><span id="l14.274"> </span>
<a href="#l14.275"></a><span id="l14.275">      &lt;field name=&quot;_pendingValueChangedCall&quot;&gt;false&lt;/field&gt;</span>
<a href="#l14.276"></a><span id="l14.276">      &lt;method name=&quot;inputValueChanged&quot;&gt;</span>
<a href="#l14.277"></a><span id="l14.277">        &lt;body&gt;</span>
<a href="#l14.278"></a><span id="l14.278">        &lt;![CDATA[</span>
<a href="#l14.279"></a><span id="l14.279" class="difflineat">@@ -799,18 +790,17 @@</span>
<a href="#l14.280"></a><span id="l14.280">            left = this._conv.sendTyping(text.slice(4));</span>
<a href="#l14.281"></a><span id="l14.281"> </span>
<a href="#l14.282"></a><span id="l14.282">          // When the input box is cleared or there is no character limit,</span>
<a href="#l14.283"></a><span id="l14.283">          // don't show the character limit.</span>
<a href="#l14.284"></a><span id="l14.284">          let charCounter = this.getElt(&quot;charCounter&quot;);</span>
<a href="#l14.285"></a><span id="l14.285">          if (left == Ci.prplIConversation.NO_TYPING_LIMIT || !text.length) {</span>
<a href="#l14.286"></a><span id="l14.286">            charCounter.setAttribute(&quot;value&quot;, &quot;&quot;);</span>
<a href="#l14.287"></a><span id="l14.287">            inputBox.removeAttribute(&quot;invalidInput&quot;);</span>
<a href="#l14.288"></a><span id="l14.288" class="difflineminus">-         }</span>
<a href="#l14.289"></a><span id="l14.289" class="difflineminus">-         else {</span>
<a href="#l14.290"></a><span id="l14.290" class="difflineplus">+         } else {</span>
<a href="#l14.291"></a><span id="l14.291">            // 200 is a 'magic' constant to avoid showing big numbers.</span>
<a href="#l14.292"></a><span id="l14.292">            charCounter.setAttribute(&quot;value&quot;, (left &lt; 200 ? left : &quot;&quot;));</span>
<a href="#l14.293"></a><span id="l14.293"> </span>
<a href="#l14.294"></a><span id="l14.294">            if (left &gt;= 0)</span>
<a href="#l14.295"></a><span id="l14.295">              inputBox.removeAttribute(&quot;invalidInput&quot;);</span>
<a href="#l14.296"></a><span id="l14.296">            else if (left &lt; 0)</span>
<a href="#l14.297"></a><span id="l14.297">              inputBox.setAttribute(&quot;invalidInput&quot;, &quot;true&quot;);</span>
<a href="#l14.298"></a><span id="l14.298">          }</span>
<a href="#l14.299"></a><span id="l14.299" class="difflineat">@@ -857,30 +847,29 @@</span>
<a href="#l14.300"></a><span id="l14.300">             this.getElt(&quot;splitter-bottom&quot;).getAttribute(&quot;state&quot;) == &quot;dragging&quot;) {</span>
<a href="#l14.301"></a><span id="l14.301">           input.style.overflowY = &quot;&quot;;</span>
<a href="#l14.302"></a><span id="l14.302">           return;</span>
<a href="#l14.303"></a><span id="l14.303">         }</span>
<a href="#l14.304"></a><span id="l14.304"> </span>
<a href="#l14.305"></a><span id="l14.305">         // Check whether we can increase the height without hiding the status bar</span>
<a href="#l14.306"></a><span id="l14.306">         // (ensure the min-height property on the top part of this dialog)</span>
<a href="#l14.307"></a><span id="l14.307">         let topBox = this.getElt(&quot;conv-top&quot;);</span>
<a href="#l14.308"></a><span id="l14.308" class="difflineminus">-        let topBoxStyle = window.getComputedStyle(topBox, null);</span>
<a href="#l14.309"></a><span id="l14.309" class="difflineplus">+        let topBoxStyle = window.getComputedStyle(topBox);</span>
<a href="#l14.310"></a><span id="l14.310">         let topMinSize = parseInt(topBoxStyle.getPropertyValue(&quot;min-height&quot;));</span>
<a href="#l14.311"></a><span id="l14.311">         let topSize = parseInt(topBoxStyle.getPropertyValue(&quot;height&quot;));</span>
<a href="#l14.312"></a><span id="l14.312">         let deck = textbox.parentNode;</span>
<a href="#l14.313"></a><span id="l14.313">         let oldDeckHeight = parseInt(deck.height);</span>
<a href="#l14.314"></a><span id="l14.314">         let newDeckHeight =</span>
<a href="#l14.315"></a><span id="l14.315">           parseInt(input.scrollHeight) + this._TEXTBOX_VERTICAL_OVERHEAD;</span>
<a href="#l14.316"></a><span id="l14.316"> </span>
<a href="#l14.317"></a><span id="l14.317">         if (!topMinSize || topSize - topMinSize &gt; newDeckHeight - oldDeckHeight) {</span>
<a href="#l14.318"></a><span id="l14.318">           // Hide a possible vertical scrollbar.</span>
<a href="#l14.319"></a><span id="l14.319">           input.style.overflowY = &quot;hidden&quot;;</span>
<a href="#l14.320"></a><span id="l14.320">           deck.height = newDeckHeight;</span>
<a href="#l14.321"></a><span id="l14.321" class="difflineminus">-        }</span>
<a href="#l14.322"></a><span id="l14.322" class="difflineminus">-        else {</span>
<a href="#l14.323"></a><span id="l14.323" class="difflineplus">+        } else {</span>
<a href="#l14.324"></a><span id="l14.324">           input.style.overflowY = &quot;&quot;;</span>
<a href="#l14.325"></a><span id="l14.325">           // Set it to the maximum possible value.</span>
<a href="#l14.326"></a><span id="l14.326">           deck.height = oldDeckHeight + (topSize - topMinSize);</span>
<a href="#l14.327"></a><span id="l14.327">         }</span>
<a href="#l14.328"></a><span id="l14.328">       ]]&gt;</span>
<a href="#l14.329"></a><span id="l14.329">       &lt;/body&gt;</span>
<a href="#l14.330"></a><span id="l14.330">      &lt;/method&gt;</span>
<a href="#l14.331"></a><span id="l14.331"> </span>
<a href="#l14.332"></a><span id="l14.332" class="difflineat">@@ -889,22 +878,21 @@</span>
<a href="#l14.333"></a><span id="l14.333">       &lt;![CDATA[</span>
<a href="#l14.334"></a><span id="l14.334">         let splitter = this.getElt(&quot;splitter-bottom&quot;);</span>
<a href="#l14.335"></a><span id="l14.335">         let textbox = this.editor;</span>
<a href="#l14.336"></a><span id="l14.336"> </span>
<a href="#l14.337"></a><span id="l14.337">         if (!splitter.hasAttribute(&quot;state&quot;)) {</span>
<a href="#l14.338"></a><span id="l14.338">           this.calculateTextboxDefaultHeight();</span>
<a href="#l14.339"></a><span id="l14.339">           textbox.parentNode.height = textbox.defaultHeight +</span>
<a href="#l14.340"></a><span id="l14.340">                                       this._TEXTBOX_VERTICAL_OVERHEAD;</span>
<a href="#l14.341"></a><span id="l14.341" class="difflineminus">-        }</span>
<a href="#l14.342"></a><span id="l14.342" class="difflineminus">-        else {</span>
<a href="#l14.343"></a><span id="l14.343" class="difflineplus">+        } else {</span>
<a href="#l14.344"></a><span id="l14.344">           // Used in case the browser is already on its min-height, resize the</span>
<a href="#l14.345"></a><span id="l14.345">           // textbox to avoid hiding the status bar.</span>
<a href="#l14.346"></a><span id="l14.346">           let convTop = this.getElt(&quot;conv-top&quot;);</span>
<a href="#l14.347"></a><span id="l14.347" class="difflineminus">-          let convTopStyle = window.getComputedStyle(convTop, null);</span>
<a href="#l14.348"></a><span id="l14.348" class="difflineplus">+          let convTopStyle = window.getComputedStyle(convTop);</span>
<a href="#l14.349"></a><span id="l14.349">           let convTopHeight = parseInt(convTopStyle.getPropertyValue(&quot;height&quot;));</span>
<a href="#l14.350"></a><span id="l14.350">           let convTopMinHeight =</span>
<a href="#l14.351"></a><span id="l14.351">             parseInt(convTopStyle.getPropertyValue(&quot;min-height&quot;));</span>
<a href="#l14.352"></a><span id="l14.352"> </span>
<a href="#l14.353"></a><span id="l14.353">           if (convTopHeight == convTopMinHeight) {</span>
<a href="#l14.354"></a><span id="l14.354">             textbox.parentNode.height = parseInt(textbox.parentNode.minHeight);</span>
<a href="#l14.355"></a><span id="l14.355">             convTopHeight = parseInt(convTopStyle.getPropertyValue(&quot;height&quot;));</span>
<a href="#l14.356"></a><span id="l14.356">             textbox.parentNode.height = parseInt(textbox.parentNode.minHeight) +</span>
<a href="#l14.357"></a><span id="l14.357" class="difflineat">@@ -927,21 +915,18 @@</span>
<a href="#l14.358"></a><span id="l14.358">       ]]&gt;</span>
<a href="#l14.359"></a><span id="l14.359">       &lt;/body&gt;</span>
<a href="#l14.360"></a><span id="l14.360">      &lt;/method&gt;</span>
<a href="#l14.361"></a><span id="l14.361"> </span>
<a href="#l14.362"></a><span id="l14.362">      &lt;method name=&quot;browserKeyPress&quot;&gt;</span>
<a href="#l14.363"></a><span id="l14.363">      &lt;parameter name=&quot;event&quot;/&gt;</span>
<a href="#l14.364"></a><span id="l14.364">       &lt;body&gt;</span>
<a href="#l14.365"></a><span id="l14.365">       &lt;![CDATA[</span>
<a href="#l14.366"></a><span id="l14.366" class="difflineminus">-#ifndef XP_MACOSX</span>
<a href="#l14.367"></a><span id="l14.367" class="difflineminus">-        var accelKeyPressed = event.ctrlKey;</span>
<a href="#l14.368"></a><span id="l14.368" class="difflineminus">-#else</span>
<a href="#l14.369"></a><span id="l14.369" class="difflineminus">-        var accelKeyPressed = event.metaKey;</span>
<a href="#l14.370"></a><span id="l14.370" class="difflineminus">-#endif</span>
<a href="#l14.371"></a><span id="l14.371" class="difflineplus">+        var accelKeyPressed = AppConstants.platform == &quot;macosx&quot; ? event.metaKey : event.ctrlKey;</span>
<a href="#l14.372"></a><span id="l14.372" class="difflineplus">+</span>
<a href="#l14.373"></a><span id="l14.373">         // 118 is the decimal code for &quot;v&quot; character, 13 keyCode for &quot;return&quot; key</span>
<a href="#l14.374"></a><span id="l14.374">         if (((accelKeyPressed &amp;&amp; event.charCode != 118) || event.altKey) &amp;&amp;</span>
<a href="#l14.375"></a><span id="l14.375">             event.keyCode != 13)</span>
<a href="#l14.376"></a><span id="l14.376">           return;</span>
<a href="#l14.377"></a><span id="l14.377"> </span>
<a href="#l14.378"></a><span id="l14.378">         if (event.charCode == 0 &amp;&amp;  // it's not a character, it's a command key</span>
<a href="#l14.379"></a><span id="l14.379">             (event.keyCode != 13 &amp;&amp; // Return</span>
<a href="#l14.380"></a><span id="l14.380">              event.keyCode != 8 &amp;&amp;  // Backspace</span>
<a href="#l14.381"></a><span id="l14.381" class="difflineat">@@ -1238,35 +1223,34 @@</span>
<a href="#l14.382"></a><span id="l14.382">          }</span>
<a href="#l14.383"></a><span id="l14.383">        ]]&gt;</span>
<a href="#l14.384"></a><span id="l14.384">        &lt;/body&gt;</span>
<a href="#l14.385"></a><span id="l14.385">      &lt;/method&gt;</span>
<a href="#l14.386"></a><span id="l14.386"> </span>
<a href="#l14.387"></a><span id="l14.387">      &lt;method name=&quot;getShowNickModifier&quot;&gt;</span>
<a href="#l14.388"></a><span id="l14.388">        &lt;body&gt;</span>
<a href="#l14.389"></a><span id="l14.389">        &lt;![CDATA[</span>
<a href="#l14.390"></a><span id="l14.390" class="difflineminus">-         return (function (aNode) {</span>
<a href="#l14.391"></a><span id="l14.391" class="difflineplus">+         return (function(aNode) {</span>
<a href="#l14.392"></a><span id="l14.392">            if (!(&quot;_showNickRegExp&quot; in this)) {</span>
<a href="#l14.393"></a><span id="l14.393">              if (!(&quot;_showNickList&quot; in this)) {</span>
<a href="#l14.394"></a><span id="l14.394">                this._showNickList = {};</span>
<a href="#l14.395"></a><span id="l14.395">                for (let n of this.buddies.keys())</span>
<a href="#l14.396"></a><span id="l14.396">                  this._showNickList[n.replace(this._nickEscape, &quot;\\$&amp;&quot;)] = true;</span>
<a href="#l14.397"></a><span id="l14.397">              }</span>
<a href="#l14.398"></a><span id="l14.398"> </span>
<a href="#l14.399"></a><span id="l14.399">              // The reverse sort ensures that if we have &quot;foo&quot; and &quot;foobar&quot;,</span>
<a href="#l14.400"></a><span id="l14.400">              // &quot;foobar&quot; will be matched first by the regexp.</span>
<a href="#l14.401"></a><span id="l14.401">              let nicks = Object.keys(this._showNickList).sort().reverse().join(&quot;|&quot;);</span>
<a href="#l14.402"></a><span id="l14.402">              if (nicks) {</span>
<a href="#l14.403"></a><span id="l14.403">                // We use \W to match for word-boundaries, as \b will not match the</span>
<a href="#l14.404"></a><span id="l14.404">                // nick if it starts/ends with \W characters.</span>
<a href="#l14.405"></a><span id="l14.405">                // XXX Ideally we would use unicode word boundaries:</span>
<a href="#l14.406"></a><span id="l14.406">                // http://www.unicode.org/reports/tr29/#Word_Boundaries</span>
<a href="#l14.407"></a><span id="l14.407">                this._showNickRegExp = new RegExp(&quot;\\W(?:&quot; + nicks + &quot;)\\W&quot;);</span>
<a href="#l14.408"></a><span id="l14.408" class="difflineminus">-             }</span>
<a href="#l14.409"></a><span id="l14.409" class="difflineminus">-             else {</span>
<a href="#l14.410"></a><span id="l14.410" class="difflineplus">+             } else {</span>
<a href="#l14.411"></a><span id="l14.411">                // nobody, disable...</span>
<a href="#l14.412"></a><span id="l14.412">                this._showNickRegExp = {exec: () =&gt; null};</span>
<a href="#l14.413"></a><span id="l14.413">                return 0;</span>
<a href="#l14.414"></a><span id="l14.414">              }</span>
<a href="#l14.415"></a><span id="l14.415">            }</span>
<a href="#l14.416"></a><span id="l14.416">            let exp = this._showNickRegExp;</span>
<a href="#l14.417"></a><span id="l14.417">            let result = 0;</span>
<a href="#l14.418"></a><span id="l14.418">            let match;</span>
<a href="#l14.419"></a><span id="l14.419" class="difflineat">@@ -1284,45 +1268,43 @@</span>
<a href="#l14.420"></a><span id="l14.420">              // the nick. The text in aNode hasn't been processed yet.</span>
<a href="#l14.421"></a><span id="l14.421">              let nick = nickNode.data;</span>
<a href="#l14.422"></a><span id="l14.422">              let elt = aNode.ownerDocument.createElement(&quot;span&quot;);</span>
<a href="#l14.423"></a><span id="l14.423">              elt.setAttribute(&quot;class&quot;, &quot;ib-nick&quot;);</span>
<a href="#l14.424"></a><span id="l14.424">              if (this.buddies.has(nick)) {</span>
<a href="#l14.425"></a><span id="l14.425">                let buddy = this.buddies.get(nick);</span>
<a href="#l14.426"></a><span id="l14.426">                elt.setAttribute(&quot;style&quot;, buddy.colorStyle);</span>
<a href="#l14.427"></a><span id="l14.427">                elt.setAttribute(&quot;data-nickColor&quot;, buddy.color);</span>
<a href="#l14.428"></a><span id="l14.428" class="difflineplus">+             } else {</span>
<a href="#l14.429"></a><span id="l14.429" class="difflineplus">+               elt.setAttribute(&quot;data-left&quot;, &quot;true&quot;);</span>
<a href="#l14.430"></a><span id="l14.430">              }</span>
<a href="#l14.431"></a><span id="l14.431" class="difflineminus">-             else</span>
<a href="#l14.432"></a><span id="l14.432" class="difflineminus">-               elt.setAttribute(&quot;data-left&quot;, &quot;true&quot;);</span>
<a href="#l14.433"></a><span id="l14.433">              nickNode.parentNode.replaceChild(elt, nickNode);</span>
<a href="#l14.434"></a><span id="l14.434">              elt.textContent = nick;</span>
<a href="#l14.435"></a><span id="l14.435">              result += 2;</span>
<a href="#l14.436"></a><span id="l14.436">            }</span>
<a href="#l14.437"></a><span id="l14.437">            return result;</span>
<a href="#l14.438"></a><span id="l14.438">          }).bind(this);</span>
<a href="#l14.439"></a><span id="l14.439">        ]]&gt;</span>
<a href="#l14.440"></a><span id="l14.440">        &lt;/body&gt;</span>
<a href="#l14.441"></a><span id="l14.441">      &lt;/method&gt;</span>
<a href="#l14.442"></a><span id="l14.442"> </span>
<a href="#l14.443"></a><span id="l14.443">      &lt;method name=&quot;updateTopic&quot;&gt;</span>
<a href="#l14.444"></a><span id="l14.444">        &lt;body&gt;</span>
<a href="#l14.445"></a><span id="l14.445">        &lt;![CDATA[</span>
<a href="#l14.446"></a><span id="l14.446">           let cti = document.getElementById(&quot;conv-top-info&quot;);</span>
<a href="#l14.447"></a><span id="l14.447" class="difflineminus">-          let statusMessage = this.getElt(&quot;statusMessage&quot;);</span>
<a href="#l14.448"></a><span id="l14.448">           if (this._conv.topicSettable)</span>
<a href="#l14.449"></a><span id="l14.449">             cti.setAttribute(&quot;topicEditable&quot;, &quot;true&quot;);</span>
<a href="#l14.450"></a><span id="l14.450">           else</span>
<a href="#l14.451"></a><span id="l14.451">             cti.removeAttribute(&quot;topicEditable&quot;);</span>
<a href="#l14.452"></a><span id="l14.452"> </span>
<a href="#l14.453"></a><span id="l14.453">           var topic = this._conv.topic;</span>
<a href="#l14.454"></a><span id="l14.454">           if (topic) {</span>
<a href="#l14.455"></a><span id="l14.455">             cti.setAttribute(&quot;statusTooltiptext&quot;, topic);</span>
<a href="#l14.456"></a><span id="l14.456">             cti.removeAttribute(&quot;noTopic&quot;);</span>
<a href="#l14.457"></a><span id="l14.457" class="difflineminus">-          }</span>
<a href="#l14.458"></a><span id="l14.458" class="difflineminus">-          else {</span>
<a href="#l14.459"></a><span id="l14.459" class="difflineplus">+          } else {</span>
<a href="#l14.460"></a><span id="l14.460">             topic = this._conv.noTopicString;</span>
<a href="#l14.461"></a><span id="l14.461">             cti.setAttribute(&quot;noTopic&quot;, &quot;true&quot;);</span>
<a href="#l14.462"></a><span id="l14.462">             cti.setAttribute(&quot;statusTooltiptext&quot;, topic);</span>
<a href="#l14.463"></a><span id="l14.463">           }</span>
<a href="#l14.464"></a><span id="l14.464">           cti.setAttribute(&quot;statusMessage&quot;, topic);</span>
<a href="#l14.465"></a><span id="l14.465">           cti.setAttribute(&quot;statusMessageWithDash&quot;, &quot; - &quot; + topic);</span>
<a href="#l14.466"></a><span id="l14.466">           cti.removeAttribute(&quot;userIcon&quot;);</span>
<a href="#l14.467"></a><span id="l14.467">        ]]&gt;</span>
<a href="#l14.468"></a><span id="l14.468" class="difflineat">@@ -1352,27 +1334,26 @@</span>
<a href="#l14.469"></a><span id="l14.469">        &lt;![CDATA[</span>
<a href="#l14.470"></a><span id="l14.470">           let typingState = this._conv.typingState;</span>
<a href="#l14.471"></a><span id="l14.471">           let cti = document.getElementById(&quot;conv-top-info&quot;);</span>
<a href="#l14.472"></a><span id="l14.472">           cti.removeAttribute(&quot;typing&quot;);</span>
<a href="#l14.473"></a><span id="l14.473">           cti.removeAttribute(&quot;typed&quot;);</span>
<a href="#l14.474"></a><span id="l14.474"> </span>
<a href="#l14.475"></a><span id="l14.475">           let name = this._currentTypingName;</span>
<a href="#l14.476"></a><span id="l14.476">           if (!this._currentTypingName)</span>
<a href="#l14.477"></a><span id="l14.477" class="difflineminus">-            name = this._conv.title;//.replace(/^([a-zA-Z0-9.]+)[@\s].*/, &quot;$1&quot;);</span>
<a href="#l14.478"></a><span id="l14.478" class="difflineplus">+            name = this._conv.title; // .replace(/^([a-zA-Z0-9.]+)[@\s].*/, &quot;$1&quot;);</span>
<a href="#l14.479"></a><span id="l14.479">           if (typingState == Ci.prplIConvIM.TYPING) {</span>
<a href="#l14.480"></a><span id="l14.480">             cti.setAttribute(&quot;typing&quot;, &quot;true&quot;);</span>
<a href="#l14.481"></a><span id="l14.481">             let typingMsg = this.bundle.formatStringFromName(&quot;chat.contactIsTyping&quot;,</span>
<a href="#l14.482"></a><span id="l14.482">                                                              [name], 1);</span>
<a href="#l14.483"></a><span id="l14.483">             cti.setAttribute(&quot;statusTypeTooltiptext&quot;, typingMsg);</span>
<a href="#l14.484"></a><span id="l14.484">             cti.setAttribute(&quot;statusTooltiptext&quot;, typingMsg);</span>
<a href="#l14.485"></a><span id="l14.485">             cti.setAttribute(&quot;statusMessage&quot;,</span>
<a href="#l14.486"></a><span id="l14.486">                              this.bundle.GetStringFromName(&quot;chat.isTyping&quot;));</span>
<a href="#l14.487"></a><span id="l14.487" class="difflineminus">-          }</span>
<a href="#l14.488"></a><span id="l14.488" class="difflineminus">-          else if (typingState == Ci.prplIConvIM.TYPED) {</span>
<a href="#l14.489"></a><span id="l14.489" class="difflineplus">+          } else if (typingState == Ci.prplIConvIM.TYPED) {</span>
<a href="#l14.490"></a><span id="l14.490">             cti.setAttribute(&quot;typed&quot;, &quot;true&quot;);</span>
<a href="#l14.491"></a><span id="l14.491"> </span>
<a href="#l14.492"></a><span id="l14.492">             let typedMsg = this.bundle.formatStringFromName(&quot;chat.contactHasStoppedTyping&quot;,</span>
<a href="#l14.493"></a><span id="l14.493">                                                             [name], 1);</span>
<a href="#l14.494"></a><span id="l14.494">             cti.setAttribute(&quot;statusTypeTooltiptext&quot;, typedMsg);</span>
<a href="#l14.495"></a><span id="l14.495">             cti.setAttribute(&quot;statusTooltiptext&quot;, typedMsg);</span>
<a href="#l14.496"></a><span id="l14.496">             cti.setAttribute(&quot;statusMessage&quot;,</span>
<a href="#l14.497"></a><span id="l14.497">                              this.bundle.GetStringFromName(&quot;chat.hasStoppedTyping&quot;));</span>
<a href="#l14.498"></a><span id="l14.498" class="difflineat">@@ -1433,26 +1414,25 @@</span>
<a href="#l14.499"></a><span id="l14.499">           let cti = document.getElementById(&quot;conv-top-info&quot;);</span>
<a href="#l14.500"></a><span id="l14.500">           cti.setAttribute(&quot;prplIcon&quot;,</span>
<a href="#l14.501"></a><span id="l14.501">                            this._conv.account.protocol.iconBaseURI + &quot;icon.png&quot;);</span>
<a href="#l14.502"></a><span id="l14.502"> </span>
<a href="#l14.503"></a><span id="l14.503">           if (this._conv.isChat) {</span>
<a href="#l14.504"></a><span id="l14.504">             this.updateTopic();</span>
<a href="#l14.505"></a><span id="l14.505">             cti.setAttribute(&quot;status&quot;, &quot;chat&quot;);</span>
<a href="#l14.506"></a><span id="l14.506">             cti.setAttribute(&quot;displayName&quot;, this._conv.title);</span>
<a href="#l14.507"></a><span id="l14.507" class="difflineminus">-          }</span>
<a href="#l14.508"></a><span id="l14.508" class="difflineminus">-          else {</span>
<a href="#l14.509"></a><span id="l14.509" class="difflineplus">+          } else {</span>
<a href="#l14.510"></a><span id="l14.510">             let displayName = this._conv.title;</span>
<a href="#l14.511"></a><span id="l14.511">             let statusText = &quot;&quot;;</span>
<a href="#l14.512"></a><span id="l14.512">             let statusType = Ci.imIStatusInfo.STATUS_UNKNOWN;</span>
<a href="#l14.513"></a><span id="l14.513"> </span>
<a href="#l14.514"></a><span id="l14.514">             let buddy = this._conv.buddy;</span>
<a href="#l14.515"></a><span id="l14.515" class="difflineminus">-            if (!buddy || !buddy.account.connected)</span>
<a href="#l14.516"></a><span id="l14.516" class="difflineplus">+            if (!buddy || !buddy.account.connected) {</span>
<a href="#l14.517"></a><span id="l14.517">               cti.removeAttribute(&quot;userIcon&quot;);</span>
<a href="#l14.518"></a><span id="l14.518" class="difflineminus">-            else {</span>
<a href="#l14.519"></a><span id="l14.519" class="difflineplus">+            } else {</span>
<a href="#l14.520"></a><span id="l14.520">               displayName = buddy.displayName;</span>
<a href="#l14.521"></a><span id="l14.521">               statusText = buddy.statusText;</span>
<a href="#l14.522"></a><span id="l14.522">               statusType = buddy.statusType;</span>
<a href="#l14.523"></a><span id="l14.523">               cti.setAttribute(&quot;userIcon&quot;, buddy.buddyIconFilename);</span>
<a href="#l14.524"></a><span id="l14.524">             }</span>
<a href="#l14.525"></a><span id="l14.525"> </span>
<a href="#l14.526"></a><span id="l14.526">             cti.setAttribute(&quot;displayName&quot;, displayName);</span>
<a href="#l14.527"></a><span id="l14.527">             if (statusText)</span>
<a href="#l14.528"></a><span id="l14.528" class="difflineat">@@ -1536,17 +1516,17 @@</span>
<a href="#l14.529"></a><span id="l14.529">            // modifiers can be added with observers for this notification.</span>
<a href="#l14.530"></a><span id="l14.530">            if (!this.loaded)</span>
<a href="#l14.531"></a><span id="l14.531">              setTimeout(this._showFirstMessages.bind(this), 0);</span>
<a href="#l14.532"></a><span id="l14.532"> </span>
<a href="#l14.533"></a><span id="l14.533">            Services.obs.removeObserver(this, &quot;conversation-loaded&quot;);</span>
<a href="#l14.534"></a><span id="l14.534">            return;</span>
<a href="#l14.535"></a><span id="l14.535">          }</span>
<a href="#l14.536"></a><span id="l14.536"> </span>
<a href="#l14.537"></a><span id="l14.537" class="difflineminus">-         switch(aTopic) {</span>
<a href="#l14.538"></a><span id="l14.538" class="difflineplus">+         switch (aTopic) {</span>
<a href="#l14.539"></a><span id="l14.539">          case &quot;new-text&quot;:</span>
<a href="#l14.540"></a><span id="l14.540">            if (this.loaded)</span>
<a href="#l14.541"></a><span id="l14.541">              this.addMsg(aSubject);</span>
<a href="#l14.542"></a><span id="l14.542">            break;</span>
<a href="#l14.543"></a><span id="l14.543"> </span>
<a href="#l14.544"></a><span id="l14.544">          case &quot;status-text-changed&quot;:</span>
<a href="#l14.545"></a><span id="l14.545">            this._statusText = aData || &quot;&quot;;</span>
<a href="#l14.546"></a><span id="l14.546">            this.displayStatusText();</span>
<a href="#l14.547"></a><span id="l14.547" class="difflineat">@@ -1639,17 +1619,17 @@</span>
<a href="#l14.548"></a><span id="l14.548">        &lt;getter&gt;</span>
<a href="#l14.549"></a><span id="l14.549">          &lt;![CDATA[</span>
<a href="#l14.550"></a><span id="l14.550">            return this._conv;</span>
<a href="#l14.551"></a><span id="l14.551">          ]]&gt;</span>
<a href="#l14.552"></a><span id="l14.552">        &lt;/getter&gt;</span>
<a href="#l14.553"></a><span id="l14.553">        &lt;setter&gt;</span>
<a href="#l14.554"></a><span id="l14.554">          &lt;![CDATA[</span>
<a href="#l14.555"></a><span id="l14.555">            if (this._conv &amp;&amp; val)</span>
<a href="#l14.556"></a><span id="l14.556" class="difflineminus">-             throw(&quot;Already initialized&quot;);</span>
<a href="#l14.557"></a><span id="l14.557" class="difflineplus">+             throw &quot;Already initialized&quot;;</span>
<a href="#l14.558"></a><span id="l14.558">            if (!val) {</span>
<a href="#l14.559"></a><span id="l14.559">              // this conversation has probably been moved to another</span>
<a href="#l14.560"></a><span id="l14.560">              // tab. Forget the prplConversation so that it isn't</span>
<a href="#l14.561"></a><span id="l14.561">              // closed when destroying this binding.</span>
<a href="#l14.562"></a><span id="l14.562">              this._forgetConv();</span>
<a href="#l14.563"></a><span id="l14.563">              return val;</span>
<a href="#l14.564"></a><span id="l14.564">            }</span>
<a href="#l14.565"></a><span id="l14.565">            this._conv = val;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mail/components/im/content/imgroup.xml</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mail/components/im/content/imgroup.xml</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -69,17 +69,17 @@</span>
<a href="#l15.4"></a><span id="l15.4">             if (this.sortComparator(aContact, this.contacts[middle].contact) &lt; 0)</span>
<a href="#l15.5"></a><span id="l15.5">               end = middle;</span>
<a href="#l15.6"></a><span id="l15.6">             else</span>
<a href="#l15.7"></a><span id="l15.7">               start = middle + 1;</span>
<a href="#l15.8"></a><span id="l15.8">           }</span>
<a href="#l15.9"></a><span id="l15.9">         }</span>
<a href="#l15.10"></a><span id="l15.10">         let last = end == 0 ? this : this.contacts[end - 1];</span>
<a href="#l15.11"></a><span id="l15.11">         this.parentNode.insertBefore(contactElt, last.nextSibling);</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-        contactElt.build(aContact);//, this);</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+        contactElt.build(aContact);</span>
<a href="#l15.14"></a><span id="l15.14">         contactElt.group = this;</span>
<a href="#l15.15"></a><span id="l15.15">         this.contacts.splice(end, 0, contactElt);</span>
<a href="#l15.16"></a><span id="l15.16">         this.contactsById[aContact.id] = contactElt;</span>
<a href="#l15.17"></a><span id="l15.17">         this.removeAttribute(&quot;collapsed&quot;);</span>
<a href="#l15.18"></a><span id="l15.18">         this._updateGroupLabel();</span>
<a href="#l15.19"></a><span id="l15.19">         return contactElt;</span>
<a href="#l15.20"></a><span id="l15.20">       ]]&gt;</span>
<a href="#l15.21"></a><span id="l15.21">       &lt;/body&gt;</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineat">@@ -148,18 +148,17 @@</span>
<a href="#l15.23"></a><span id="l15.23"> </span>
<a href="#l15.24"></a><span id="l15.24">      &lt;method name=&quot;close&quot;&gt;</span>
<a href="#l15.25"></a><span id="l15.25">       &lt;body&gt;</span>
<a href="#l15.26"></a><span id="l15.26">       &lt;![CDATA[</span>
<a href="#l15.27"></a><span id="l15.27">         if (this.hasAttribute(&quot;closed&quot;)) {</span>
<a href="#l15.28"></a><span id="l15.28">           this.removeAttribute(&quot;closed&quot;);</span>
<a href="#l15.29"></a><span id="l15.29">           this.setAttribute(&quot;aria-expanded&quot;, &quot;true&quot;);</span>
<a href="#l15.30"></a><span id="l15.30">           this._updateClosedState(false);</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineminus">-        }</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineminus">-        else {</span>
<a href="#l15.33"></a><span id="l15.33" class="difflineplus">+        } else {</span>
<a href="#l15.34"></a><span id="l15.34">           this.setAttribute(&quot;closed&quot;, &quot;true&quot;);</span>
<a href="#l15.35"></a><span id="l15.35">           this.setAttribute(&quot;aria-expanded&quot;, &quot;false&quot;);</span>
<a href="#l15.36"></a><span id="l15.36">           this._updateClosedState(true);</span>
<a href="#l15.37"></a><span id="l15.37">         }</span>
<a href="#l15.38"></a><span id="l15.38"> </span>
<a href="#l15.39"></a><span id="l15.39">         this._updateGroupLabel();</span>
<a href="#l15.40"></a><span id="l15.40">       ]]&gt;</span>
<a href="#l15.41"></a><span id="l15.41">       &lt;/body&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mail/components/im/content/joinchat.js</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mail/components/im/content/joinchat.js</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -1,14 +1,14 @@</span>
<a href="#l16.4"></a><span id="l16.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l16.5"></a><span id="l16.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l16.6"></a><span id="l16.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l16.7"></a><span id="l16.7"> </span>
<a href="#l16.8"></a><span id="l16.8" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l16.9"></a><span id="l16.9" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l16.10"></a><span id="l16.10" class="difflineplus">+var { fixIterator } = ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;, null);</span>
<a href="#l16.11"></a><span id="l16.11" class="difflineplus">+var { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;, null);</span>
<a href="#l16.12"></a><span id="l16.12"> </span>
<a href="#l16.13"></a><span id="l16.13"> var autoJoinPref = &quot;autoJoin&quot;;</span>
<a href="#l16.14"></a><span id="l16.14"> </span>
<a href="#l16.15"></a><span id="l16.15"> var joinChat = {</span>
<a href="#l16.16"></a><span id="l16.16">   onload: function jc_onload() {</span>
<a href="#l16.17"></a><span id="l16.17">     var accountList = document.getElementById(&quot;accountlist&quot;);</span>
<a href="#l16.18"></a><span id="l16.18">     for (let acc of fixIterator(Services.accounts.getAccounts())) {</span>
<a href="#l16.19"></a><span id="l16.19">       if (!acc.connected || !acc.canJoinChat)</span>
<a href="#l16.20"></a><span id="l16.20" class="difflineat">@@ -76,31 +76,31 @@ var joinChat = {</span>
<a href="#l16.21"></a><span id="l16.21">         text = document.getElementById(&quot;optionalcolumn&quot;)</span>
<a href="#l16.22"></a><span id="l16.22">                        .getAttribute(&quot;labeltxt&quot;);</span>
<a href="#l16.23"></a><span id="l16.23">         label.setAttribute(&quot;value&quot;, text);</span>
<a href="#l16.24"></a><span id="l16.24">         row.appendChild(label);</span>
<a href="#l16.25"></a><span id="l16.25">       }</span>
<a href="#l16.26"></a><span id="l16.26"> </span>
<a href="#l16.27"></a><span id="l16.27">       row.setAttribute(&quot;align&quot;, &quot;baseline&quot;);</span>
<a href="#l16.28"></a><span id="l16.28">       sep.parentNode.insertBefore(row, sep);</span>
<a href="#l16.29"></a><span id="l16.29" class="difflineminus">-      joinChat._fields.push({field: field, textbox: textbox});</span>
<a href="#l16.30"></a><span id="l16.30" class="difflineplus">+      joinChat._fields.push({field, textbox});</span>
<a href="#l16.31"></a><span id="l16.31">     }</span>
<a href="#l16.32"></a><span id="l16.32"> </span>
<a href="#l16.33"></a><span id="l16.33">     window.sizeToContent();</span>
<a href="#l16.34"></a><span id="l16.34">   },</span>
<a href="#l16.35"></a><span id="l16.35"> </span>
<a href="#l16.36"></a><span id="l16.36">   join: function jc_join() {</span>
<a href="#l16.37"></a><span id="l16.37">     let values = joinChat._values;</span>
<a href="#l16.38"></a><span id="l16.38">     for (let field of joinChat._fields) {</span>
<a href="#l16.39"></a><span id="l16.39">       let val = field.textbox.value.trim();</span>
<a href="#l16.40"></a><span id="l16.40">       if (!val &amp;&amp; field.field.required) {</span>
<a href="#l16.41"></a><span id="l16.41">         field.textbox.focus();</span>
<a href="#l16.42"></a><span id="l16.42" class="difflineminus">-        //FIXME: why isn't the return false enough?</span>
<a href="#l16.43"></a><span id="l16.43" class="difflineplus">+        // FIXME: why isn't the return false enough?</span>
<a href="#l16.44"></a><span id="l16.44">         throw &quot;Some required fields are empty!&quot;;</span>
<a href="#l16.45"></a><span id="l16.45" class="difflineminus">-        return false;</span>
<a href="#l16.46"></a><span id="l16.46" class="difflineplus">+        // return false;</span>
<a href="#l16.47"></a><span id="l16.47">       }</span>
<a href="#l16.48"></a><span id="l16.48">       if (val)</span>
<a href="#l16.49"></a><span id="l16.49">         values.setValue(field.field.identifier, val);</span>
<a href="#l16.50"></a><span id="l16.50">     }</span>
<a href="#l16.51"></a><span id="l16.51">     let account = joinChat._account;</span>
<a href="#l16.52"></a><span id="l16.52">     account.joinChat(values);</span>
<a href="#l16.53"></a><span id="l16.53"> </span>
<a href="#l16.54"></a><span id="l16.54">     let protoId = account.protocol.id;</span>
<a href="#l16.55"></a><span id="l16.55" class="difflineat">@@ -117,17 +117,17 @@ var joinChat = {</span>
<a href="#l16.56"></a><span id="l16.56">     let conv = Services.conversations.getConversationByNameAndAccount(name,</span>
<a href="#l16.57"></a><span id="l16.57">                                                                       account,</span>
<a href="#l16.58"></a><span id="l16.58">                                                                       true);</span>
<a href="#l16.59"></a><span id="l16.59">     if (conv) {</span>
<a href="#l16.60"></a><span id="l16.60">       let mailWindow = Services.wm.getMostRecentWindow(&quot;mail:3pane&quot;);</span>
<a href="#l16.61"></a><span id="l16.61">       if (mailWindow) {</span>
<a href="#l16.62"></a><span id="l16.62">         mailWindow.focus();</span>
<a href="#l16.63"></a><span id="l16.63">         let tabmail = mailWindow.document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l16.64"></a><span id="l16.64" class="difflineminus">-        tabmail.openTab(&quot;chat&quot;, {convType: &quot;focus&quot;, conv: conv});</span>
<a href="#l16.65"></a><span id="l16.65" class="difflineplus">+        tabmail.openTab(&quot;chat&quot;, {convType: &quot;focus&quot;, conv});</span>
<a href="#l16.66"></a><span id="l16.66">       }</span>
<a href="#l16.67"></a><span id="l16.67">     }</span>
<a href="#l16.68"></a><span id="l16.68"> </span>
<a href="#l16.69"></a><span id="l16.69">     if (document.getElementById(&quot;autojoin&quot;).checked) {</span>
<a href="#l16.70"></a><span id="l16.70">       // &quot;nick&quot; for JS-XMPP, &quot;handle&quot; for libpurple prpls.</span>
<a href="#l16.71"></a><span id="l16.71">       let nick = values.getValue(&quot;nick&quot;) || values.getValue(&quot;handle&quot;);</span>
<a href="#l16.72"></a><span id="l16.72">       if (nick)</span>
<a href="#l16.73"></a><span id="l16.73">         name += &quot;/&quot; + nick;</span>
<a href="#l16.74"></a><span id="l16.74" class="difflineat">@@ -144,10 +144,10 @@ var joinChat = {</span>
<a href="#l16.75"></a><span id="l16.75"> </span>
<a href="#l16.76"></a><span id="l16.76">       if (!autojoin.includes(name)) {</span>
<a href="#l16.77"></a><span id="l16.77">         autojoin.push(name);</span>
<a href="#l16.78"></a><span id="l16.78">         prefBranch.setStringPref(autoJoinPref, autojoin.join(&quot;,&quot;));</span>
<a href="#l16.79"></a><span id="l16.79">       }</span>
<a href="#l16.80"></a><span id="l16.80">     }</span>
<a href="#l16.81"></a><span id="l16.81"> </span>
<a href="#l16.82"></a><span id="l16.82">     return true;</span>
<a href="#l16.83"></a><span id="l16.83" class="difflineminus">-  }</span>
<a href="#l16.84"></a><span id="l16.84" class="difflineplus">+  },</span>
<a href="#l16.85"></a><span id="l16.85"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mail/components/im/imIncomingServer.js</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mail/components/im/imIncomingServer.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -1,16 +1,19 @@</span>
<a href="#l17.4"></a><span id="l17.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l17.5"></a><span id="l17.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l17.6"></a><span id="l17.6">  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l17.7"></a><span id="l17.7"> </span>
<a href="#l17.8"></a><span id="l17.8" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l17.9"></a><span id="l17.9" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l17.10"></a><span id="l17.10" class="difflineplus">+const {</span>
<a href="#l17.11"></a><span id="l17.11" class="difflineplus">+  EmptyEnumerator,</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineplus">+  XPCOMUtils,</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+} = ChromeUtils.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;, null);</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineplus">+const { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;, null);</span>
<a href="#l17.15"></a><span id="l17.15"> </span>
<a href="#l17.16"></a><span id="l17.16" class="difflineminus">-function imIncomingServer() { }</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineplus">+function imIncomingServer() {}</span>
<a href="#l17.18"></a><span id="l17.18"> </span>
<a href="#l17.19"></a><span id="l17.19"> imIncomingServer.prototype = {</span>
<a href="#l17.20"></a><span id="l17.20">   get wrappedJSObject() { return this; },</span>
<a href="#l17.21"></a><span id="l17.21">   _imAccount: null,</span>
<a href="#l17.22"></a><span id="l17.22">   get imAccount() {</span>
<a href="#l17.23"></a><span id="l17.23">     if (this._imAccount)</span>
<a href="#l17.24"></a><span id="l17.24">       return this._imAccount;</span>
<a href="#l17.25"></a><span id="l17.25"> </span>
<a href="#l17.26"></a><span id="l17.26" class="difflineat">@@ -30,21 +33,21 @@ imIncomingServer.prototype = {</span>
<a href="#l17.27"></a><span id="l17.27">   get offlineSupportLevel() { return 0; },</span>
<a href="#l17.28"></a><span id="l17.28">   get supportsDiskSpace() { return false; },</span>
<a href="#l17.29"></a><span id="l17.29">   _key: &quot;&quot;,</span>
<a href="#l17.30"></a><span id="l17.30">   get key() { return this._key; },</span>
<a href="#l17.31"></a><span id="l17.31">   set key(aKey) {</span>
<a href="#l17.32"></a><span id="l17.32">     this._key = aKey;</span>
<a href="#l17.33"></a><span id="l17.33">     this._prefBranch = Services.prefs.getBranch(&quot;mail.server.&quot; + aKey + &quot;.&quot;);</span>
<a href="#l17.34"></a><span id="l17.34">   },</span>
<a href="#l17.35"></a><span id="l17.35" class="difflineminus">-  equals: function (aServer) {</span>
<a href="#l17.36"></a><span id="l17.36" class="difflineplus">+  equals(aServer) {</span>
<a href="#l17.37"></a><span id="l17.37">     return &quot;wrappedJSObject&quot; in aServer &amp;&amp; aServer.wrappedJSObject == this;</span>
<a href="#l17.38"></a><span id="l17.38">   },</span>
<a href="#l17.39"></a><span id="l17.39"> </span>
<a href="#l17.40"></a><span id="l17.40" class="difflineminus">-  clearAllValues: function() {</span>
<a href="#l17.41"></a><span id="l17.41" class="difflineplus">+  clearAllValues() {</span>
<a href="#l17.42"></a><span id="l17.42">     Services.accounts.deleteAccount(this.imAccount.id);</span>
<a href="#l17.43"></a><span id="l17.43">     this._prefBranch.deleteBranch(&quot;&quot;);</span>
<a href="#l17.44"></a><span id="l17.44">     delete this._prefBranch;</span>
<a href="#l17.45"></a><span id="l17.45">     delete this._imAccount;</span>
<a href="#l17.46"></a><span id="l17.46">   },</span>
<a href="#l17.47"></a><span id="l17.47"> </span>
<a href="#l17.48"></a><span id="l17.48">   // Returns the directory where the account would have its data stored.</span>
<a href="#l17.49"></a><span id="l17.49">   // There are currently conversation logs only.</span>
<a href="#l17.50"></a><span id="l17.50" class="difflineat">@@ -54,45 +57,45 @@ imIncomingServer.prototype = {</span>
<a href="#l17.51"></a><span id="l17.51">   get localPath() {</span>
<a href="#l17.52"></a><span id="l17.52">     let logPath = Services.logs.getLogFolderPathForAccount(this.imAccount);</span>
<a href="#l17.53"></a><span id="l17.53">     let file = Cc[&quot;@mozilla.org/file/local;1&quot;].createInstance(Ci.nsIFile);</span>
<a href="#l17.54"></a><span id="l17.54">     file.initWithPath(logPath);</span>
<a href="#l17.55"></a><span id="l17.55">     return file;</span>
<a href="#l17.56"></a><span id="l17.56">   },</span>
<a href="#l17.57"></a><span id="l17.57"> </span>
<a href="#l17.58"></a><span id="l17.58">   // Removes files created by this account.</span>
<a href="#l17.59"></a><span id="l17.59" class="difflineminus">-  removeFiles: function() {</span>
<a href="#l17.60"></a><span id="l17.60" class="difflineplus">+  removeFiles() {</span>
<a href="#l17.61"></a><span id="l17.61">     Services.logs.deleteLogFolderForAccount(this.imAccount);</span>
<a href="#l17.62"></a><span id="l17.62">   },</span>
<a href="#l17.63"></a><span id="l17.63"> </span>
<a href="#l17.64"></a><span id="l17.64">   // called by nsMsgAccountManager while deleting an account:</span>
<a href="#l17.65"></a><span id="l17.65" class="difflineminus">-  forgetSessionPassword: function() { },</span>
<a href="#l17.66"></a><span id="l17.66" class="difflineplus">+  forgetSessionPassword() {},</span>
<a href="#l17.67"></a><span id="l17.67"> </span>
<a href="#l17.68"></a><span id="l17.68" class="difflineminus">-  forgetPassword: function() {</span>
<a href="#l17.69"></a><span id="l17.69" class="difflineplus">+  forgetPassword() {</span>
<a href="#l17.70"></a><span id="l17.70">     // Password is cleared in imAccount.remove()</span>
<a href="#l17.71"></a><span id="l17.71">     // TODO: this may need to be implemented here as a separate function</span>
<a href="#l17.72"></a><span id="l17.72">     // once IM accounts support changing username/hostname.</span>
<a href="#l17.73"></a><span id="l17.73">   },</span>
<a href="#l17.74"></a><span id="l17.74"> </span>
<a href="#l17.75"></a><span id="l17.75">   // Shown in the &quot;Remove Account&quot; confirm prompt.</span>
<a href="#l17.76"></a><span id="l17.76">   get prettyName() {</span>
<a href="#l17.77"></a><span id="l17.77">     let protocol = this.imAccount.protocol.name || this.imAccount.protocol.id;</span>
<a href="#l17.78"></a><span id="l17.78">     return protocol + &quot; - &quot; + this.imAccount.name;</span>
<a href="#l17.79"></a><span id="l17.79">   },</span>
<a href="#l17.80"></a><span id="l17.80"> </span>
<a href="#l17.81"></a><span id="l17.81" class="difflineminus">-  //XXX Flo: I don't think constructedPrettyName is visible in the UI</span>
<a href="#l17.82"></a><span id="l17.82" class="difflineplus">+  // XXX Flo: I don't think constructedPrettyName is visible in the UI</span>
<a href="#l17.83"></a><span id="l17.83">   get constructedPrettyName() { return &quot;constructedPrettyName FIXME&quot;; },</span>
<a href="#l17.84"></a><span id="l17.84">   get realHostName() { return this.hostName; },</span>
<a href="#l17.85"></a><span id="l17.85">   set realHostName(aValue) {},</span>
<a href="#l17.86"></a><span id="l17.86"> </span>
<a href="#l17.87"></a><span id="l17.87">   port: -1,</span>
<a href="#l17.88"></a><span id="l17.88">   accountManagerChrome: &quot;am-im.xul&quot;,</span>
<a href="#l17.89"></a><span id="l17.89"> </span>
<a href="#l17.90"></a><span id="l17.90"> </span>
<a href="#l17.91"></a><span id="l17.91" class="difflineminus">-  //FIXME need a new imIIncomingService iface + classinfo for these 3 properties :(</span>
<a href="#l17.92"></a><span id="l17.92" class="difflineplus">+  // FIXME need a new imIIncomingService iface + classinfo for these 3 properties :(</span>
<a href="#l17.93"></a><span id="l17.93">   get password() { return this.imAccount.password; },</span>
<a href="#l17.94"></a><span id="l17.94">   set password(aPassword) {</span>
<a href="#l17.95"></a><span id="l17.95">     this.imAccount.password = aPassword;</span>
<a href="#l17.96"></a><span id="l17.96">   },</span>
<a href="#l17.97"></a><span id="l17.97">   get alias() { return this.imAccount.alias; },</span>
<a href="#l17.98"></a><span id="l17.98">   set alias(aAlias) {</span>
<a href="#l17.99"></a><span id="l17.99">     this.imAccount.alias = aAlias;</span>
<a href="#l17.100"></a><span id="l17.100">   },</span>
<a href="#l17.101"></a><span id="l17.101" class="difflineat">@@ -105,68 +108,68 @@ imIncomingServer.prototype = {</span>
<a href="#l17.102"></a><span id="l17.102">     }</span>
<a href="#l17.103"></a><span id="l17.103">   },</span>
<a href="#l17.104"></a><span id="l17.104">   set autojoin(aAutoJoin) {</span>
<a href="#l17.105"></a><span id="l17.105">     let prefName = &quot;messenger.account.&quot; + this.imAccount.id + &quot;.autoJoin&quot;;</span>
<a href="#l17.106"></a><span id="l17.106">     Services.prefs.setStringPref(prefName, aAutoJoin);</span>
<a href="#l17.107"></a><span id="l17.107">   },</span>
<a href="#l17.108"></a><span id="l17.108"> </span>
<a href="#l17.109"></a><span id="l17.109">   // This is used for user-visible advanced preferences.</span>
<a href="#l17.110"></a><span id="l17.110" class="difflineminus">-  setUnicharValue: function(aPrefName, aValue) {</span>
<a href="#l17.111"></a><span id="l17.111" class="difflineplus">+  setUnicharValue(aPrefName, aValue) {</span>
<a href="#l17.112"></a><span id="l17.112">     if (aPrefName == &quot;autojoin&quot;)</span>
<a href="#l17.113"></a><span id="l17.113">       this.autojoin = aValue;</span>
<a href="#l17.114"></a><span id="l17.114">     else if (aPrefName == &quot;alias&quot;)</span>
<a href="#l17.115"></a><span id="l17.115">       this.alias = aValue;</span>
<a href="#l17.116"></a><span id="l17.116">     else if (aPrefName == &quot;password&quot;)</span>
<a href="#l17.117"></a><span id="l17.117">       this.password = aValue;</span>
<a href="#l17.118"></a><span id="l17.118">     else</span>
<a href="#l17.119"></a><span id="l17.119">       this.imAccount.setString(aPrefName, aValue);</span>
<a href="#l17.120"></a><span id="l17.120">   },</span>
<a href="#l17.121"></a><span id="l17.121" class="difflineminus">-  getUnicharValue: function(aPrefName) {</span>
<a href="#l17.122"></a><span id="l17.122" class="difflineplus">+  getUnicharValue(aPrefName) {</span>
<a href="#l17.123"></a><span id="l17.123">     if (aPrefName == &quot;autojoin&quot;)</span>
<a href="#l17.124"></a><span id="l17.124">       return this.autojoin;</span>
<a href="#l17.125"></a><span id="l17.125">     if (aPrefName == &quot;alias&quot;)</span>
<a href="#l17.126"></a><span id="l17.126">       return this.alias;</span>
<a href="#l17.127"></a><span id="l17.127">     if (aPrefName == &quot;password&quot;)</span>
<a href="#l17.128"></a><span id="l17.128">       return this.password;</span>
<a href="#l17.129"></a><span id="l17.129"> </span>
<a href="#l17.130"></a><span id="l17.130">     try {</span>
<a href="#l17.131"></a><span id="l17.131">       let prefName =</span>
<a href="#l17.132"></a><span id="l17.132">         &quot;messenger.account.&quot; + this.imAccount.id + &quot;.options.&quot; + aPrefName;</span>
<a href="#l17.133"></a><span id="l17.133">       return Services.prefs.getStringPref(prefName);</span>
<a href="#l17.134"></a><span id="l17.134">     } catch (x) {</span>
<a href="#l17.135"></a><span id="l17.135">       return this._getDefault(aPrefName);</span>
<a href="#l17.136"></a><span id="l17.136">     }</span>
<a href="#l17.137"></a><span id="l17.137">   },</span>
<a href="#l17.138"></a><span id="l17.138" class="difflineminus">-  setBoolValue: function(aPrefName, aValue) {</span>
<a href="#l17.139"></a><span id="l17.139" class="difflineplus">+  setBoolValue(aPrefName, aValue) {</span>
<a href="#l17.140"></a><span id="l17.140">     this.imAccount.setBool(aPrefName, aValue);</span>
<a href="#l17.141"></a><span id="l17.141">   },</span>
<a href="#l17.142"></a><span id="l17.142" class="difflineminus">-  getBoolValue: function(aPrefName) {</span>
<a href="#l17.143"></a><span id="l17.143" class="difflineplus">+  getBoolValue(aPrefName) {</span>
<a href="#l17.144"></a><span id="l17.144">     try {</span>
<a href="#l17.145"></a><span id="l17.145">       let prefName =</span>
<a href="#l17.146"></a><span id="l17.146">         &quot;messenger.account.&quot; + this.imAccount.id + &quot;.options.&quot; + aPrefName;</span>
<a href="#l17.147"></a><span id="l17.147">       return Services.prefs.getBoolPref(prefName);</span>
<a href="#l17.148"></a><span id="l17.148">     } catch (x) {</span>
<a href="#l17.149"></a><span id="l17.149">       return this._getDefault(aPrefName);</span>
<a href="#l17.150"></a><span id="l17.150">     }</span>
<a href="#l17.151"></a><span id="l17.151">   },</span>
<a href="#l17.152"></a><span id="l17.152" class="difflineminus">-  setIntValue: function(aPrefName, aValue) {</span>
<a href="#l17.153"></a><span id="l17.153" class="difflineplus">+  setIntValue(aPrefName, aValue) {</span>
<a href="#l17.154"></a><span id="l17.154">     this.imAccount.setInt(aPrefName, aValue);</span>
<a href="#l17.155"></a><span id="l17.155">   },</span>
<a href="#l17.156"></a><span id="l17.156" class="difflineminus">-  getIntValue: function(aPrefName) {</span>
<a href="#l17.157"></a><span id="l17.157" class="difflineplus">+  getIntValue(aPrefName) {</span>
<a href="#l17.158"></a><span id="l17.158">     try {</span>
<a href="#l17.159"></a><span id="l17.159">       let prefName =</span>
<a href="#l17.160"></a><span id="l17.160">         &quot;messenger.account.&quot; + this.imAccount.id + &quot;.options.&quot; + aPrefName;</span>
<a href="#l17.161"></a><span id="l17.161">       return Services.prefs.getIntPref(prefName);</span>
<a href="#l17.162"></a><span id="l17.162">     } catch (x) {</span>
<a href="#l17.163"></a><span id="l17.163">       return this._getDefault(aPrefName);</span>
<a href="#l17.164"></a><span id="l17.164">     }</span>
<a href="#l17.165"></a><span id="l17.165">   },</span>
<a href="#l17.166"></a><span id="l17.166">   _defaultOptionValues: null,</span>
<a href="#l17.167"></a><span id="l17.167" class="difflineminus">-  _getDefault: function(aPrefName) {</span>
<a href="#l17.168"></a><span id="l17.168" class="difflineplus">+  _getDefault(aPrefName) {</span>
<a href="#l17.169"></a><span id="l17.169">     if (this._defaultOptionValues)</span>
<a href="#l17.170"></a><span id="l17.170">       return this._defaultOptionValues[aPrefName];</span>
<a href="#l17.171"></a><span id="l17.171"> </span>
<a href="#l17.172"></a><span id="l17.172">     this._defaultOptionValues = {};</span>
<a href="#l17.173"></a><span id="l17.173">     let options = this.imAccount.protocol.getOptions();</span>
<a href="#l17.174"></a><span id="l17.174">     while (options.hasMoreElements()) {</span>
<a href="#l17.175"></a><span id="l17.175">       let opt = options.getNext();</span>
<a href="#l17.176"></a><span id="l17.176">       let type = opt.type;</span>
<a href="#l17.177"></a><span id="l17.177" class="difflineat">@@ -178,20 +181,20 @@ imIncomingServer.prototype = {</span>
<a href="#l17.178"></a><span id="l17.178">         this._defaultOptionValues[opt.name] = opt.getString();</span>
<a href="#l17.179"></a><span id="l17.179">       else if (type == opt.typeList)</span>
<a href="#l17.180"></a><span id="l17.180">         this._defaultOptionValues[opt.name] = opt.getListDefault();</span>
<a href="#l17.181"></a><span id="l17.181">     }</span>
<a href="#l17.182"></a><span id="l17.182">     return this._defaultOptionValues[aPrefName];</span>
<a href="#l17.183"></a><span id="l17.183">   },</span>
<a href="#l17.184"></a><span id="l17.184"> </span>
<a href="#l17.185"></a><span id="l17.185">   // the &quot;Char&quot; type will be used only for &quot;imAccount&quot; and internally.</span>
<a href="#l17.186"></a><span id="l17.186" class="difflineminus">-  setCharValue: function(aPrefName, aValue) {</span>
<a href="#l17.187"></a><span id="l17.187" class="difflineplus">+  setCharValue(aPrefName, aValue) {</span>
<a href="#l17.188"></a><span id="l17.188">     this._prefBranch.setCharPref(aPrefName, aValue);</span>
<a href="#l17.189"></a><span id="l17.189">   },</span>
<a href="#l17.190"></a><span id="l17.190" class="difflineminus">-  getCharValue: function(aPrefName) {</span>
<a href="#l17.191"></a><span id="l17.191" class="difflineplus">+  getCharValue(aPrefName) {</span>
<a href="#l17.192"></a><span id="l17.192">     try {</span>
<a href="#l17.193"></a><span id="l17.193">       return this._prefBranch.getCharPref(aPrefName);</span>
<a href="#l17.194"></a><span id="l17.194">     } catch (x) {</span>
<a href="#l17.195"></a><span id="l17.195">       return &quot;&quot;;</span>
<a href="#l17.196"></a><span id="l17.196">     }</span>
<a href="#l17.197"></a><span id="l17.197">   },</span>
<a href="#l17.198"></a><span id="l17.198"> </span>
<a href="#l17.199"></a><span id="l17.199">   get type() { return this._prefBranch.getCharPref(&quot;type&quot;); },</span>
<a href="#l17.200"></a><span id="l17.200" class="difflineat">@@ -210,46 +213,46 @@ imIncomingServer.prototype = {</span>
<a href="#l17.201"></a><span id="l17.201">     this._prefBranch.setCharPref(&quot;userName&quot;, aUsername);</span>
<a href="#l17.202"></a><span id="l17.202">   },</span>
<a href="#l17.203"></a><span id="l17.203"> </span>
<a href="#l17.204"></a><span id="l17.204">   get hostName() { return this._prefBranch.getCharPref(&quot;hostname&quot;); },</span>
<a href="#l17.205"></a><span id="l17.205">   set hostName(aHostName) {</span>
<a href="#l17.206"></a><span id="l17.206">     this._prefBranch.setCharPref(&quot;hostname&quot;, aHostName);</span>
<a href="#l17.207"></a><span id="l17.207">   },</span>
<a href="#l17.208"></a><span id="l17.208"> </span>
<a href="#l17.209"></a><span id="l17.209" class="difflineminus">-  writeToFolderCache: function() { },</span>
<a href="#l17.210"></a><span id="l17.210" class="difflineminus">-  closeCachedConnections: function() { },</span>
<a href="#l17.211"></a><span id="l17.211" class="difflineplus">+  writeToFolderCache() {},</span>
<a href="#l17.212"></a><span id="l17.212" class="difflineplus">+  closeCachedConnections() {},</span>
<a href="#l17.213"></a><span id="l17.213"> </span>
<a href="#l17.214"></a><span id="l17.214">   // Shutdown the server instance so at least disconnect from the server.</span>
<a href="#l17.215"></a><span id="l17.215" class="difflineminus">-  shutdown: function() {</span>
<a href="#l17.216"></a><span id="l17.216" class="difflineplus">+  shutdown() {</span>
<a href="#l17.217"></a><span id="l17.217">     // Ensure this account has not been destroyed already.</span>
<a href="#l17.218"></a><span id="l17.218">     if (this.imAccount.prplAccount)</span>
<a href="#l17.219"></a><span id="l17.219">       this.imAccount.disconnect();</span>
<a href="#l17.220"></a><span id="l17.220">   },</span>
<a href="#l17.221"></a><span id="l17.221"> </span>
<a href="#l17.222"></a><span id="l17.222" class="difflineminus">-  setFilterList: function() { },</span>
<a href="#l17.223"></a><span id="l17.223" class="difflineplus">+  setFilterList() {},</span>
<a href="#l17.224"></a><span id="l17.224"> </span>
<a href="#l17.225"></a><span id="l17.225">   get canBeDefaultServer() { return false; },</span>
<a href="#l17.226"></a><span id="l17.226"> </span>
<a href="#l17.227"></a><span id="l17.227">   // AccountManager.js verifies that spamSettings is non-null before</span>
<a href="#l17.228"></a><span id="l17.228">   // using the initialize method, but we can't just use a null value</span>
<a href="#l17.229"></a><span id="l17.229">   // because that would crash nsMsgPurgeService::PerformPurge which</span>
<a href="#l17.230"></a><span id="l17.230">   // only verifies the nsresult return value of the spamSettings</span>
<a href="#l17.231"></a><span id="l17.231">   // getter before accessing the level property.</span>
<a href="#l17.232"></a><span id="l17.232">   get spamSettings() {</span>
<a href="#l17.233"></a><span id="l17.233">     return {</span>
<a href="#l17.234"></a><span id="l17.234">       level: 0,</span>
<a href="#l17.235"></a><span id="l17.235" class="difflineminus">-      initialize: function(aServer) {},</span>
<a href="#l17.236"></a><span id="l17.236" class="difflineminus">-      QueryInterface: ChromeUtils.generateQI([Ci.nsISpamSettings])</span>
<a href="#l17.237"></a><span id="l17.237" class="difflineplus">+      initialize(aServer) {},</span>
<a href="#l17.238"></a><span id="l17.238" class="difflineplus">+      QueryInterface: ChromeUtils.generateQI([Ci.nsISpamSettings]),</span>
<a href="#l17.239"></a><span id="l17.239">     };</span>
<a href="#l17.240"></a><span id="l17.240">   },</span>
<a href="#l17.241"></a><span id="l17.241"> </span>
<a href="#l17.242"></a><span id="l17.242">   // nsMsgDBFolder.cpp crashes in HandleAutoCompactEvent if this doesn't exist:</span>
<a href="#l17.243"></a><span id="l17.243">   msgStore: {</span>
<a href="#l17.244"></a><span id="l17.244" class="difflineminus">-    supportsCompaction: false</span>
<a href="#l17.245"></a><span id="l17.245" class="difflineplus">+    supportsCompaction: false,</span>
<a href="#l17.246"></a><span id="l17.246">   },</span>
<a href="#l17.247"></a><span id="l17.247"> </span>
<a href="#l17.248"></a><span id="l17.248">   get serverURI() { return &quot;im://&quot; + this.imAccount.protocol.id + &quot;/&quot; + this.imAccount.name; },</span>
<a href="#l17.249"></a><span id="l17.249">   _rootFolder: null,</span>
<a href="#l17.250"></a><span id="l17.250">   get rootMsgFolder() { return this.rootFolder; },</span>
<a href="#l17.251"></a><span id="l17.251">   get rootFolder() {</span>
<a href="#l17.252"></a><span id="l17.252">     if (this._rootFolder)</span>
<a href="#l17.253"></a><span id="l17.253">       return this._rootFolder;</span>
<a href="#l17.254"></a><span id="l17.254" class="difflineat">@@ -257,40 +260,40 @@ imIncomingServer.prototype = {</span>
<a href="#l17.255"></a><span id="l17.255">     return (this._rootFolder = {</span>
<a href="#l17.256"></a><span id="l17.256">       isServer: true,</span>
<a href="#l17.257"></a><span id="l17.257">       server: this,</span>
<a href="#l17.258"></a><span id="l17.258">       get URI() { return this.server.serverURI; },</span>
<a href="#l17.259"></a><span id="l17.259">       get prettyName() { return this.server.prettyName; }, // used in the account manager tree</span>
<a href="#l17.260"></a><span id="l17.260">       get name() { return this.server.prettyName + &quot; name&quot;; }, // never displayed?</span>
<a href="#l17.261"></a><span id="l17.261">       // used in the folder pane tree, if we don't hide the IM accounts:</span>
<a href="#l17.262"></a><span id="l17.262">       get abbreviatedName() { return this.server.prettyName + &quot;abbreviatedName&quot;; },</span>
<a href="#l17.263"></a><span id="l17.263" class="difflineminus">-      AddFolderListener: function() {},</span>
<a href="#l17.264"></a><span id="l17.264" class="difflineminus">-      RemoveFolderListener: function() {},</span>
<a href="#l17.265"></a><span id="l17.265" class="difflineplus">+      AddFolderListener() {},</span>
<a href="#l17.266"></a><span id="l17.266" class="difflineplus">+      RemoveFolderListener() {},</span>
<a href="#l17.267"></a><span id="l17.267">       descendants: Cc[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l17.268"></a><span id="l17.268">                   .createInstance(Ci.nsIArray),</span>
<a href="#l17.269"></a><span id="l17.269" class="difflineminus">-      ListDescendants: function(descendants) {},</span>
<a href="#l17.270"></a><span id="l17.270" class="difflineplus">+      ListDescendants(descendants) {},</span>
<a href="#l17.271"></a><span id="l17.271">       getFlag: () =&gt; false,</span>
<a href="#l17.272"></a><span id="l17.272">       getFolderWithFlags: aFlags =&gt; null,</span>
<a href="#l17.273"></a><span id="l17.273">       getFoldersWithFlags: aFlags =&gt;</span>
<a href="#l17.274"></a><span id="l17.274">         Cc[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l17.275"></a><span id="l17.275">           .createInstance(Ci.nsIArray),</span>
<a href="#l17.276"></a><span id="l17.276">       get subFolders() { return EmptyEnumerator; },</span>
<a href="#l17.277"></a><span id="l17.277">       getStringProperty: aPropertyName =&gt; &quot;&quot;,</span>
<a href="#l17.278"></a><span id="l17.278">       getNumUnread: aDeep =&gt; 0,</span>
<a href="#l17.279"></a><span id="l17.279" class="difflineminus">-      Shutdown: function() {},</span>
<a href="#l17.280"></a><span id="l17.280" class="difflineminus">-      QueryInterface: ChromeUtils.generateQI([Ci.nsIMsgFolder])</span>
<a href="#l17.281"></a><span id="l17.281" class="difflineplus">+      Shutdown() {},</span>
<a href="#l17.282"></a><span id="l17.282" class="difflineplus">+      QueryInterface: ChromeUtils.generateQI([Ci.nsIMsgFolder]),</span>
<a href="#l17.283"></a><span id="l17.283">     });</span>
<a href="#l17.284"></a><span id="l17.284">   },</span>
<a href="#l17.285"></a><span id="l17.285"> </span>
<a href="#l17.286"></a><span id="l17.286">   get sortOrder() { return 300000000; },</span>
<a href="#l17.287"></a><span id="l17.287"> </span>
<a href="#l17.288"></a><span id="l17.288">   get protocolInfo() {</span>
<a href="#l17.289"></a><span id="l17.289">     return Cc[&quot;@mozilla.org/messenger/protocol/info;1?type=im&quot;]</span>
<a href="#l17.290"></a><span id="l17.290">              .getService(Ci.nsIMsgProtocolInfo);</span>
<a href="#l17.291"></a><span id="l17.291">   },</span>
<a href="#l17.292"></a><span id="l17.292"> </span>
<a href="#l17.293"></a><span id="l17.293">   classDescription: &quot;IM Msg Incoming Server implementation&quot;,</span>
<a href="#l17.294"></a><span id="l17.294">   classID: Components.ID(&quot;{9dd7f36b-5960-4f0a-8789-f5f516bd083d}&quot;),</span>
<a href="#l17.295"></a><span id="l17.295">   contractID: &quot;@mozilla.org/messenger/server;1?type=im&quot;,</span>
<a href="#l17.296"></a><span id="l17.296" class="difflineminus">-  QueryInterface: ChromeUtils.generateQI([Ci.nsIMsgIncomingServer])</span>
<a href="#l17.297"></a><span id="l17.297" class="difflineplus">+  QueryInterface: ChromeUtils.generateQI([Ci.nsIMsgIncomingServer]),</span>
<a href="#l17.298"></a><span id="l17.298"> };</span>
<a href="#l17.299"></a><span id="l17.299"> </span>
<a href="#l17.300"></a><span id="l17.300"> var NSGetFactory = XPCOMUtils.generateNSGetFactory([imIncomingServer]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mail/components/im/imProtocolInfo.js</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mail/components/im/imProtocolInfo.js</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -1,35 +1,35 @@</span>
<a href="#l18.4"></a><span id="l18.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l18.5"></a><span id="l18.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l18.6"></a><span id="l18.6">  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l18.7"></a><span id="l18.7"> </span>
<a href="#l18.8"></a><span id="l18.8"> ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l18.9"></a><span id="l18.9"> </span>
<a href="#l18.10"></a><span id="l18.10" class="difflineminus">-function imProtocolInfo() { }</span>
<a href="#l18.11"></a><span id="l18.11" class="difflineplus">+function imProtocolInfo() {}</span>
<a href="#l18.12"></a><span id="l18.12"> </span>
<a href="#l18.13"></a><span id="l18.13"> imProtocolInfo.prototype = {</span>
<a href="#l18.14"></a><span id="l18.14"> </span>
<a href="#l18.15"></a><span id="l18.15">   defaultLocalPath: null,</span>
<a href="#l18.16"></a><span id="l18.16">   get serverIID() { return null; },</span>
<a href="#l18.17"></a><span id="l18.17">   get requiresUsername() { return true; },</span>
<a href="#l18.18"></a><span id="l18.18">   get preflightPrettyNameWithEmailAddress() { return false; },</span>
<a href="#l18.19"></a><span id="l18.19">   get canDelete() { return true; },</span>
<a href="#l18.20"></a><span id="l18.20">   // Even though IM accounts can login at startup, canLoginAtStartUp</span>
<a href="#l18.21"></a><span id="l18.21">   // should be false as it's used to decide if new messages should be</span>
<a href="#l18.22"></a><span id="l18.22">   // fetched at startup and that concept of message doesn't apply to</span>
<a href="#l18.23"></a><span id="l18.23">   // IM accounts.</span>
<a href="#l18.24"></a><span id="l18.24">   get canLoginAtStartUp() { return false; },</span>
<a href="#l18.25"></a><span id="l18.25">   get canDuplicate() { return false; },</span>
<a href="#l18.26"></a><span id="l18.26" class="difflineminus">-  getDefaultServerPort: () =&gt;  0,</span>
<a href="#l18.27"></a><span id="l18.27" class="difflineplus">+  getDefaultServerPort: () =&gt; 0,</span>
<a href="#l18.28"></a><span id="l18.28">   get canGetMessages() { return false; },</span>
<a href="#l18.29"></a><span id="l18.29">   get canGetIncomingMessages() { return false; },</span>
<a href="#l18.30"></a><span id="l18.30">   get defaultDoBiff() { return false; },</span>
<a href="#l18.31"></a><span id="l18.31">   get showComposeMsgLink() { return false; },</span>
<a href="#l18.32"></a><span id="l18.32">   get foldersCreatedAsync() { return false; },</span>
<a href="#l18.33"></a><span id="l18.33"> </span>
<a href="#l18.34"></a><span id="l18.34">   classDescription: &quot;IM Msg Protocol Info implementation&quot;,</span>
<a href="#l18.35"></a><span id="l18.35">   classID: Components.ID(&quot;{13118758-dad2-418c-a03d-1acbfed0cd01}&quot;),</span>
<a href="#l18.36"></a><span id="l18.36">   contractID: &quot;@mozilla.org/messenger/protocol/info;1?type=im&quot;,</span>
<a href="#l18.37"></a><span id="l18.37" class="difflineminus">-  QueryInterface: ChromeUtils.generateQI([Ci.nsIMsgProtocolInfo])</span>
<a href="#l18.38"></a><span id="l18.38" class="difflineplus">+  QueryInterface: ChromeUtils.generateQI([Ci.nsIMsgProtocolInfo]),</span>
<a href="#l18.39"></a><span id="l18.39"> };</span>
<a href="#l18.40"></a><span id="l18.40"> </span>
<a href="#l18.41"></a><span id="l18.41"> var NSGetFactory = XPCOMUtils.generateNSGetFactory([imProtocolInfo]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mail/components/im/jar.mn</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mail/components/im/jar.mn</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -15,17 +15,17 @@ messenger.jar:</span>
<a href="#l19.4"></a><span id="l19.4">     content/messenger/chat/imAccounts.css                (content/imAccounts.css)</span>
<a href="#l19.5"></a><span id="l19.5">     content/messenger/chat/imAccounts.js                 (content/imAccounts.js)</span>
<a href="#l19.6"></a><span id="l19.6">     content/messenger/chat/imAccounts.xul                (content/imAccounts.xul)</span>
<a href="#l19.7"></a><span id="l19.7">     content/messenger/chat/imAccountWizard.xul           (content/imAccountWizard.xul)</span>
<a href="#l19.8"></a><span id="l19.8">     content/messenger/chat/imAccountWizard.js            (content/imAccountWizard.js)</span>
<a href="#l19.9"></a><span id="l19.9">     content/messenger/chat/imContextMenu.js              (content/imContextMenu.js)</span>
<a href="#l19.10"></a><span id="l19.10">     content/messenger/chat/imStatusSelector.js           (content/imStatusSelector.js)</span>
<a href="#l19.11"></a><span id="l19.11">     content/messenger/chat/imcontact.xml                 (content/imcontact.xml)</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-*   content/messenger/chat/imconversation.xml            (content/imconversation.xml)</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+    content/messenger/chat/imconversation.xml            (content/imconversation.xml)</span>
<a href="#l19.14"></a><span id="l19.14">     content/messenger/chat/imconv.xml                    (content/imconv.xml)</span>
<a href="#l19.15"></a><span id="l19.15">     content/messenger/chat/imgroup.xml                   (content/imgroup.xml)</span>
<a href="#l19.16"></a><span id="l19.16"> % skin messenger-messagestyles classic/1.0 %skin/classic/messenger/messages/</span>
<a href="#l19.17"></a><span id="l19.17"> 	skin/classic/messenger/messages/mail/Bitmaps/minus-hover.png          (messages/mail/Bitmaps/minus-hover.png)</span>
<a href="#l19.18"></a><span id="l19.18"> 	skin/classic/messenger/messages/mail/Bitmaps/minus.png                (messages/mail/Bitmaps/minus.png)</span>
<a href="#l19.19"></a><span id="l19.19"> 	skin/classic/messenger/messages/mail/Bitmaps/plus-hover.png           (messages/mail/Bitmaps/plus-hover.png)</span>
<a href="#l19.20"></a><span id="l19.20"> 	skin/classic/messenger/messages/mail/Bitmaps/plus.png                 (messages/mail/Bitmaps/plus.png)</span>
<a href="#l19.21"></a><span id="l19.21"> 	skin/classic/messenger/messages/mail/Footer.html                      (messages/mail/Footer.html)</span>
<a href="#l19.22"></a><span id="l19.22" class="difflineat">@@ -184,17 +184,17 @@ messenger.jar:</span>
<a href="#l19.23"></a><span id="l19.23"> 	skin/classic/messenger/messages/simple/Incoming/Context.html (messages/simple/Incoming/Context.html)</span>
<a href="#l19.24"></a><span id="l19.24"> 	skin/classic/messenger/messages/simple/Incoming/NextContext.html (messages/simple/Incoming/NextContext.html)</span>
<a href="#l19.25"></a><span id="l19.25"> 	skin/classic/messenger/messages/simple/Info.plist            (messages/simple/Info.plist)</span>
<a href="#l19.26"></a><span id="l19.26"> 	skin/classic/messenger/messages/simple/main.css              (messages/simple/main.css)</span>
<a href="#l19.27"></a><span id="l19.27"> 	skin/classic/messenger/messages/simple/Status.html           (messages/simple/Status.html)</span>
<a href="#l19.28"></a><span id="l19.28"> 	skin/classic/messenger/messages/simple/Variants/Normal.css   (messages/simple/Variants/Normal.css)</span>
<a href="#l19.29"></a><span id="l19.29"> 	skin/classic/messenger/messages/simple/Variants/Dark.css     (messages/simple/Variants/Dark.css)</span>
<a href="#l19.30"></a><span id="l19.30"> % skin messenger-emoticons classic/1.0 %skin/classic/messenger/smileys/</span>
<a href="#l19.31"></a><span id="l19.31" class="difflineminus">-	skin/classic/messenger/smileys/theme.js              (smileys/theme.js)</span>
<a href="#l19.32"></a><span id="l19.32" class="difflineplus">+	skin/classic/messenger/smileys/theme.json            (smileys/theme.json)</span>
<a href="#l19.33"></a><span id="l19.33"> 	skin/classic/messenger/smileys/angry.png             (smileys/angry.png)</span>
<a href="#l19.34"></a><span id="l19.34"> 	skin/classic/messenger/smileys/confused.png          (smileys/confused.png)</span>
<a href="#l19.35"></a><span id="l19.35"> 	skin/classic/messenger/smileys/cool.png              (smileys/cool.png)</span>
<a href="#l19.36"></a><span id="l19.36"> 	skin/classic/messenger/smileys/cry.png               (smileys/cry.png)</span>
<a href="#l19.37"></a><span id="l19.37"> 	skin/classic/messenger/smileys/embarrassed.png       (smileys/embarrassed.png)</span>
<a href="#l19.38"></a><span id="l19.38"> 	skin/classic/messenger/smileys/grin.png              (smileys/grin.png)</span>
<a href="#l19.39"></a><span id="l19.39"> 	skin/classic/messenger/smileys/heart.png             (smileys/heart.png)</span>
<a href="#l19.40"></a><span id="l19.40"> 	skin/classic/messenger/smileys/manga_annoyed.png     (smileys/manga_annoyed.png)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mail/components/im/messages/bubbles/Footer.html</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mail/components/im/messages/bubbles/Footer.html</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -1,38 +1,40 @@</span>
<a href="#l20.4"></a><span id="l20.4"> &lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l20.5"></a><span id="l20.5">    - License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l20.6"></a><span id="l20.6">    - file, You can obtain one at http://mozilla.org/MPL/2.0/. --&gt;</span>
<a href="#l20.7"></a><span id="l20.7"> </span>
<a href="#l20.8"></a><span id="l20.8"> &lt;script type=&quot;application/javascript&quot;&gt;</span>
<a href="#l20.9"></a><span id="l20.9" class="difflineplus">+// chat/content/convbrowser.xml</span>
<a href="#l20.10"></a><span id="l20.10" class="difflineplus">+/* globals autoScrollEnabled, scrollToElement */</span>
<a href="#l20.11"></a><span id="l20.11" class="difflineplus">+</span>
<a href="#l20.12"></a><span id="l20.12"> /* [pseudo_color, pseudo_background, bubble_borders] */</span>
<a href="#l20.13"></a><span id="l20.13"> const elements_lightness = [[75, 94, 80], [75, 94, 80], [70, 93, 75], [65, 92, 70], [55, 90, 65], [48, 90, 60], [44, 86, 50], [44, 88, 60], [45, 88, 70], [45, 90, 70], [45, 92, 70], [45, 92, 70], [45, 92, 70], [45, 92, 70], [45, 92, 70], [45, 92, 70], [45, 92, 70], [45, 92, 70], [45, 92, 70], [60, 92, 70], [70, 93, 75], [75, 94, 80], [75, 94, 80], [75, 94, 80], [75, 94, 80], [75, 94, 80], [75, 94, 80], [75, 94, 80], [75, 94, 80], [75, 94, 80], [75, 94, 80], [75, 94, 80], [75, 94, 80], [75, 94, 80], [75, 94, 80], [75, 94, 80]];</span>
<a href="#l20.14"></a><span id="l20.14"> </span>
<a href="#l20.15"></a><span id="l20.15"> const bubble_background = &quot;hsl(#, 100%, 97%)&quot;;</span>
<a href="#l20.16"></a><span id="l20.16"> const bubble_borders = &quot;hsl(#, 100%, #%)&quot;;</span>
<a href="#l20.17"></a><span id="l20.17"> const pseudo_color = &quot;hsl(#, 100%, #%)&quot;;</span>
<a href="#l20.18"></a><span id="l20.18"> const pseudo_background = &quot;hsl(#, 100%, #%)&quot;;</span>
<a href="#l20.19"></a><span id="l20.19"> </span>
<a href="#l20.20"></a><span id="l20.20"> var alternating = null;</span>
<a href="#l20.21"></a><span id="l20.21"> </span>
<a href="#l20.22"></a><span id="l20.22" class="difflineminus">-function setColors(target)</span>
<a href="#l20.23"></a><span id="l20.23" class="difflineminus">-{</span>
<a href="#l20.24"></a><span id="l20.24" class="difflineplus">+function setColors(target) {</span>
<a href="#l20.25"></a><span id="l20.25">   var senderColor = target.getAttribute(&quot;data-senderColor&quot;);</span>
<a href="#l20.26"></a><span id="l20.26"> </span>
<a href="#l20.27"></a><span id="l20.27">   if (!senderColor)</span>
<a href="#l20.28"></a><span id="l20.28">     return;</span>
<a href="#l20.29"></a><span id="l20.29"> </span>
<a href="#l20.30"></a><span id="l20.30">   var regexp = /color:\s*hsl\(\s*(\d{1,3})\s*,\s*\d{1,3}\%\s*,\s*\d{1,3}\%\s*\)/;</span>
<a href="#l20.31"></a><span id="l20.31">   var parsed = regexp.exec(senderColor);</span>
<a href="#l20.32"></a><span id="l20.32"> </span>
<a href="#l20.33"></a><span id="l20.33">   if (!parsed)</span>
<a href="#l20.34"></a><span id="l20.34">     return;</span>
<a href="#l20.35"></a><span id="l20.35"> </span>
<a href="#l20.36"></a><span id="l20.36" class="difflineminus">-  var senderHue = ((Math.round(parsed[1]/10))*10)%360;</span>
<a href="#l20.37"></a><span id="l20.37" class="difflineminus">-  var lightness = elements_lightness[senderHue/10];</span>
<a href="#l20.38"></a><span id="l20.38" class="difflineplus">+  var senderHue = ((Math.round(parsed[1] / 10)) * 10) % 360;</span>
<a href="#l20.39"></a><span id="l20.39" class="difflineplus">+  var lightness = elements_lightness[senderHue / 10];</span>
<a href="#l20.40"></a><span id="l20.40"> </span>
<a href="#l20.41"></a><span id="l20.41">   target.style.backgroundColor = bubble_background.replace(&quot;#&quot;, senderHue);</span>
<a href="#l20.42"></a><span id="l20.42">   target.style.borderColor = bubble_borders.replace(&quot;#&quot;, senderHue)</span>
<a href="#l20.43"></a><span id="l20.43">                                            .replace(&quot;#&quot;, lightness[2]);</span>
<a href="#l20.44"></a><span id="l20.44"> </span>
<a href="#l20.45"></a><span id="l20.45">   var pseudo = target.getElementsByClassName(&quot;pseudo&quot;)[0];</span>
<a href="#l20.46"></a><span id="l20.46">   pseudo.style.color = pseudo_color.replace(&quot;#&quot;, senderHue)</span>
<a href="#l20.47"></a><span id="l20.47">                                    .replace(&quot;#&quot;, lightness[0]);</span>
<a href="#l20.48"></a><span id="l20.48" class="difflineat">@@ -40,17 +42,17 @@ function setColors(target)</span>
<a href="#l20.49"></a><span id="l20.49">                                                   .replace(&quot;#&quot;, lightness[1]);</span>
<a href="#l20.50"></a><span id="l20.50"> </span>
<a href="#l20.51"></a><span id="l20.51">   var div_indicator = target.getElementsByClassName(&quot;indicator&quot;)[0];</span>
<a href="#l20.52"></a><span id="l20.52">   var imageURL = &quot;url('Bitmaps/indicator_&quot; + senderHue;</span>
<a href="#l20.53"></a><span id="l20.53">   if (target.classList.contains(&quot;incoming&quot;)) {</span>
<a href="#l20.54"></a><span id="l20.54">     // getComputedStyle is prohibitively expensive, and we need it only to</span>
<a href="#l20.55"></a><span id="l20.55">     // know if we are using an alternating variant, so we cache the result.</span>
<a href="#l20.56"></a><span id="l20.56">     if (alternating === null) {</span>
<a href="#l20.57"></a><span id="l20.57" class="difflineminus">-      alternating = document.defaultView.getComputedStyle(div_indicator, null)</span>
<a href="#l20.58"></a><span id="l20.58" class="difflineplus">+      alternating = document.defaultView.getComputedStyle(div_indicator)</span>
<a href="#l20.59"></a><span id="l20.59">                             .backgroundImage.endsWith('_alt.png&quot;)') ? &quot;_alt&quot; : &quot;&quot;;</span>
<a href="#l20.60"></a><span id="l20.60">     }</span>
<a href="#l20.61"></a><span id="l20.61">     imageURL += alternating;</span>
<a href="#l20.62"></a><span id="l20.62">   }</span>
<a href="#l20.63"></a><span id="l20.63">   div_indicator.style.backgroundImage = imageURL + &quot;.png')&quot;;</span>
<a href="#l20.64"></a><span id="l20.64"> }</span>
<a href="#l20.65"></a><span id="l20.65"> </span>
<a href="#l20.66"></a><span id="l20.66"> </span>
<a href="#l20.67"></a><span id="l20.67" class="difflineat">@@ -92,18 +94,17 @@ var lastMessageTimeoutTime = -1;</span>
<a href="#l20.68"></a><span id="l20.68">  * When the last message is more than timebeforetextdisplay old, we display</span>
<a href="#l20.69"></a><span id="l20.69">  * the time in text. To avoid blinking Mac scrollbar and visual distractions</span>
<a href="#l20.70"></a><span id="l20.70">  * for some very sensitive users, we update the whitespace only when a new</span>
<a href="#l20.71"></a><span id="l20.71">  * message is displayed or when the user switches between tabs. While the</span>
<a href="#l20.72"></a><span id="l20.72">  * conversation is visible, this function is called by timers, but we will</span>
<a href="#l20.73"></a><span id="l20.73">  * only update the time displayed in text (this behavior is obtained by</span>
<a href="#l20.74"></a><span id="l20.74">  * setting the aUpdateTextOnly parameter to true; otherwise it is omitted).</span>
<a href="#l20.75"></a><span id="l20.75">  */</span>
<a href="#l20.76"></a><span id="l20.76" class="difflineminus">-function handleLastMessage(aUpdateTextOnly)</span>
<a href="#l20.77"></a><span id="l20.77" class="difflineminus">-{</span>
<a href="#l20.78"></a><span id="l20.78" class="difflineplus">+function handleLastMessage(aUpdateTextOnly) {</span>
<a href="#l20.79"></a><span id="l20.79">   if (window.messageInsertPending)</span>
<a href="#l20.80"></a><span id="l20.80">     return;</span>
<a href="#l20.81"></a><span id="l20.81"> </span>
<a href="#l20.82"></a><span id="l20.82">   var intervalInMs = Date.now() - lastMsgTime * 1000;</span>
<a href="#l20.83"></a><span id="l20.83">   var interval = Math.round(intervalInMs / 1000);</span>
<a href="#l20.84"></a><span id="l20.84">   var p = document.getElementById(&quot;lastMessage&quot;);</span>
<a href="#l20.85"></a><span id="l20.85">   var margin;</span>
<a href="#l20.86"></a><span id="l20.86">   if (!aUpdateTextOnly) {</span>
<a href="#l20.87"></a><span id="l20.87" class="difflineat">@@ -137,40 +138,37 @@ function handleLastMessage(aUpdateTextOn</span>
<a href="#l20.88"></a><span id="l20.88">   // The setTimeout callbacks are frequently called a few ms early,</span>
<a href="#l20.89"></a><span id="l20.89">   // but our code prefers being called a little late, so add 20ms.</span>
<a href="#l20.90"></a><span id="l20.90">   lastMessageTimeoutTime = next + 20;</span>
<a href="#l20.91"></a><span id="l20.91">   lastMessageTimeout =</span>
<a href="#l20.92"></a><span id="l20.92">     setTimeout(handleLastMessage, lastMessageTimeoutTime, aUpdateTextOnly);</span>
<a href="#l20.93"></a><span id="l20.93"> }</span>
<a href="#l20.94"></a><span id="l20.94"> </span>
<a href="#l20.95"></a><span id="l20.95"> var lastMsgTime = 0;</span>
<a href="#l20.96"></a><span id="l20.96" class="difflineminus">-function updateLastMsgTime(aMsgTime)</span>
<a href="#l20.97"></a><span id="l20.97" class="difflineminus">-{</span>
<a href="#l20.98"></a><span id="l20.98" class="difflineplus">+function updateLastMsgTime(aMsgTime) {</span>
<a href="#l20.99"></a><span id="l20.99">   if (aMsgTime &gt; lastMsgTime)</span>
<a href="#l20.100"></a><span id="l20.100">     lastMsgTime = aMsgTime;</span>
<a href="#l20.101"></a><span id="l20.101"> </span>
<a href="#l20.102"></a><span id="l20.102">   if (lastMsgTime &amp;&amp; lastMessageTimeoutTime != 0 &amp;&amp; !document.hidden) {</span>
<a href="#l20.103"></a><span id="l20.103">     clearTimeout(lastMessageTimeout);</span>
<a href="#l20.104"></a><span id="l20.104">     setTimeout(handleLastMessage, 0);</span>
<a href="#l20.105"></a><span id="l20.105">     lastMessageTimeoutTime = 0;</span>
<a href="#l20.106"></a><span id="l20.106">   }</span>
<a href="#l20.107"></a><span id="l20.107"> }</span>
<a href="#l20.108"></a><span id="l20.108"> </span>
<a href="#l20.109"></a><span id="l20.109" class="difflineminus">-function visibilityChanged()</span>
<a href="#l20.110"></a><span id="l20.110" class="difflineminus">-{</span>
<a href="#l20.111"></a><span id="l20.111" class="difflineplus">+function visibilityChanged() {</span>
<a href="#l20.112"></a><span id="l20.112">   if (document.hidden) {</span>
<a href="#l20.113"></a><span id="l20.113">     clearTimeout(lastMessageTimeout);</span>
<a href="#l20.114"></a><span id="l20.114">     lastMessageTimeoutTime = -1;</span>
<a href="#l20.115"></a><span id="l20.115" class="difflineplus">+  } else if (lastMsgTime) {</span>
<a href="#l20.116"></a><span id="l20.116" class="difflineplus">+    handleLastMessage();</span>
<a href="#l20.117"></a><span id="l20.117">   }</span>
<a href="#l20.118"></a><span id="l20.118" class="difflineminus">-  else if (lastMsgTime)</span>
<a href="#l20.119"></a><span id="l20.119" class="difflineminus">-    handleLastMessage();</span>
<a href="#l20.120"></a><span id="l20.120"> }</span>
<a href="#l20.121"></a><span id="l20.121"> </span>
<a href="#l20.122"></a><span id="l20.122" class="difflineminus">-function checkNewText(target)</span>
<a href="#l20.123"></a><span id="l20.123" class="difflineminus">-{</span>
<a href="#l20.124"></a><span id="l20.124" class="difflineplus">+function checkNewText(target) {</span>
<a href="#l20.125"></a><span id="l20.125">   var nicks = target.getElementsByClassName(&quot;ib-nick&quot;);</span>
<a href="#l20.126"></a><span id="l20.126">   for (var i = 0; i &lt; nicks.length; ++i) {</span>
<a href="#l20.127"></a><span id="l20.127">     var nick = nicks[i];</span>
<a href="#l20.128"></a><span id="l20.128">     if (nick.hasAttribute(&quot;data-left&quot;))</span>
<a href="#l20.129"></a><span id="l20.129">       continue;</span>
<a href="#l20.130"></a><span id="l20.130">     var hue = nick.getAttribute(&quot;data-nickColor&quot;);</span>
<a href="#l20.131"></a><span id="l20.131">     var senderHue = ((Math.round(hue / 10)) * 10) % 360;</span>
<a href="#l20.132"></a><span id="l20.132">     var lightness = elements_lightness[senderHue / 10];</span>
<a href="#l20.133"></a><span id="l20.133" class="difflineat">@@ -192,17 +190,17 @@ function checkNewText(target)</span>
<a href="#l20.134"></a><span id="l20.134">     // to be of equal size, since the preceding bubble will have a shadow.</span>
<a href="#l20.135"></a><span id="l20.135">     var rulerMarginBottom = kRulerMarginTop - 1;</span>
<a href="#l20.136"></a><span id="l20.136"> </span>
<a href="#l20.137"></a><span id="l20.137">     if (lastMsgTime &amp;&amp; msgTime &gt;= lastMsgTime) {</span>
<a href="#l20.138"></a><span id="l20.138">       var interval = msgTime - lastMsgTime;</span>
<a href="#l20.139"></a><span id="l20.139">       var margin = computeSpace(interval);</span>
<a href="#l20.140"></a><span id="l20.140">       let isTimetext = interval &gt;= timebeforetextdisplay;</span>
<a href="#l20.141"></a><span id="l20.141">       if (isTimetext) {</span>
<a href="#l20.142"></a><span id="l20.142" class="difflineminus">-        var p = document.createElement(&quot;p&quot;);</span>
<a href="#l20.143"></a><span id="l20.143" class="difflineplus">+        let p = document.createElement(&quot;p&quot;);</span>
<a href="#l20.144"></a><span id="l20.144">         p.className = &quot;interval&quot;;</span>
<a href="#l20.145"></a><span id="l20.145">         if (shouldSetSessionRuler) {</span>
<a href="#l20.146"></a><span id="l20.146">           // Hide the hr and style the time text accordingly instead.</span>
<a href="#l20.147"></a><span id="l20.147">           prev.classList.remove(&quot;sessionstart-ruler&quot;);</span>
<a href="#l20.148"></a><span id="l20.148">           prev.style.border = &quot;none&quot;;</span>
<a href="#l20.149"></a><span id="l20.149">           p.classList.add(&quot;sessionstart-ruler&quot;);</span>
<a href="#l20.150"></a><span id="l20.150">           margin += 6;</span>
<a href="#l20.151"></a><span id="l20.151">           prev = p;</span>
<a href="#l20.152"></a><span id="l20.152" class="difflineat">@@ -226,23 +224,22 @@ function checkNewText(target)</span>
<a href="#l20.153"></a><span id="l20.153">           rulerMarginBottom = shadow - 1;</span>
<a href="#l20.154"></a><span id="l20.154">         }</span>
<a href="#l20.155"></a><span id="l20.155">       }</span>
<a href="#l20.156"></a><span id="l20.156">     }</span>
<a href="#l20.157"></a><span id="l20.157">     if (shouldSetUnreadRuler || shouldSetSessionRuler) {</span>
<a href="#l20.158"></a><span id="l20.158">       prev.style.marginBottom = rulerMarginBottom + &quot;px&quot;;</span>
<a href="#l20.159"></a><span id="l20.159">       prev.style.marginTop = kRulerMarginTop + &quot;px&quot;;</span>
<a href="#l20.160"></a><span id="l20.160">     }</span>
<a href="#l20.161"></a><span id="l20.161" class="difflineminus">-  }</span>
<a href="#l20.162"></a><span id="l20.162" class="difflineminus">-  else if (target.tagName == &quot;P&quot; &amp;&amp; target.className == &quot;event&quot;) {</span>
<a href="#l20.163"></a><span id="l20.163" class="difflineplus">+  } else if (target.tagName == &quot;P&quot; &amp;&amp; target.className == &quot;event&quot;) {</span>
<a href="#l20.164"></a><span id="l20.164">     let parent = target.parentNode;</span>
<a href="#l20.165"></a><span id="l20.165">     // We need to start a group with this element if there are at least 4</span>
<a href="#l20.166"></a><span id="l20.166">     // system messages and they aren't already grouped.</span>
<a href="#l20.167"></a><span id="l20.167">     if (!parent.grouped &amp;&amp; parent.querySelector(&quot;p.event:nth-of-type(4)&quot;)) {</span>
<a href="#l20.168"></a><span id="l20.168" class="difflineminus">-      var p = document.createElement(&quot;p&quot;);</span>
<a href="#l20.169"></a><span id="l20.169" class="difflineplus">+      let p = document.createElement(&quot;p&quot;);</span>
<a href="#l20.170"></a><span id="l20.170">       p.className = &quot;eventToggle&quot;;</span>
<a href="#l20.171"></a><span id="l20.171">       p.addEventListener(&quot;click&quot;, event =&gt;</span>
<a href="#l20.172"></a><span id="l20.172">         event.target.parentNode.classList.toggle(&quot;hide-children&quot;));</span>
<a href="#l20.173"></a><span id="l20.173">       parent.insertBefore(p, parent.querySelector(&quot;p.event:nth-of-type(2)&quot;));</span>
<a href="#l20.174"></a><span id="l20.174">       parent.classList.add(&quot;hide-children&quot;);</span>
<a href="#l20.175"></a><span id="l20.175">       parent.grouped = true;</span>
<a href="#l20.176"></a><span id="l20.176">     }</span>
<a href="#l20.177"></a><span id="l20.177">   }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mail/components/im/messages/dark/Footer.html</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mail/components/im/messages/dark/Footer.html</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -2,18 +2,17 @@</span>
<a href="#l21.4"></a><span id="l21.4">    - License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l21.5"></a><span id="l21.5">    - file, You can obtain one at http://mozilla.org/MPL/2.0/. --&gt;</span>
<a href="#l21.6"></a><span id="l21.6"> </span>
<a href="#l21.7"></a><span id="l21.7"> &lt;script type=&quot;application/javascript&quot;&gt;</span>
<a href="#l21.8"></a><span id="l21.8"> const p_border_top = &quot;1px solid hsla(#, 100%, 80%, 0.4)&quot;;</span>
<a href="#l21.9"></a><span id="l21.9"> const p_background = &quot;-moz-linear-gradient(top, hsla(#, 100%, 80%, 0.3), hsla(#, 100%, 80%, 0.1) 30px)&quot;;</span>
<a href="#l21.10"></a><span id="l21.10"> const nick_background = &quot;-moz-linear-gradient(top, hsla(#, 100%, 80%, 0.3), hsla(#, 100%, 80%, 0.1) 1em)&quot;;</span>
<a href="#l21.11"></a><span id="l21.11"> </span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-function setColors(target)</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineminus">-{</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineplus">+function setColors(target) {</span>
<a href="#l21.15"></a><span id="l21.15">   var senderColor = target.getAttribute(&quot;data-senderColor&quot;);</span>
<a href="#l21.16"></a><span id="l21.16"> </span>
<a href="#l21.17"></a><span id="l21.17">   if (!senderColor)</span>
<a href="#l21.18"></a><span id="l21.18">     return;</span>
<a href="#l21.19"></a><span id="l21.19"> </span>
<a href="#l21.20"></a><span id="l21.20">   var regexp = /color:\s*hsl\(\s*(\d{1,3})\s*,\s*\d{1,3}\%\s*,\s*\d{1,3}\%\s*\)/;</span>
<a href="#l21.21"></a><span id="l21.21">   var parsed = regexp.exec(senderColor);</span>
<a href="#l21.22"></a><span id="l21.22"> </span>
<a href="#l21.23"></a><span id="l21.23" class="difflineat">@@ -21,18 +20,17 @@ function setColors(target)</span>
<a href="#l21.24"></a><span id="l21.24">     return;</span>
<a href="#l21.25"></a><span id="l21.25"> </span>
<a href="#l21.26"></a><span id="l21.26">   var senderHue = parsed[1];</span>
<a href="#l21.27"></a><span id="l21.27"> </span>
<a href="#l21.28"></a><span id="l21.28">   target.style.borderTop = p_border_top.replace(&quot;#&quot;, senderHue);</span>
<a href="#l21.29"></a><span id="l21.29">   target.style.background = p_background.replace(/#/g, senderHue);</span>
<a href="#l21.30"></a><span id="l21.30"> }</span>
<a href="#l21.31"></a><span id="l21.31"> </span>
<a href="#l21.32"></a><span id="l21.32" class="difflineminus">-function checkNewText(target)</span>
<a href="#l21.33"></a><span id="l21.33" class="difflineminus">-{</span>
<a href="#l21.34"></a><span id="l21.34" class="difflineplus">+function checkNewText(target) {</span>
<a href="#l21.35"></a><span id="l21.35">   if (target.tagName == &quot;P&quot; &amp;&amp; target.className != &quot;event-messages&quot;)</span>
<a href="#l21.36"></a><span id="l21.36">     setColors(target);</span>
<a href="#l21.37"></a><span id="l21.37"> </span>
<a href="#l21.38"></a><span id="l21.38">   var nicks = target.getElementsByClassName(&quot;ib-nick&quot;);</span>
<a href="#l21.39"></a><span id="l21.39">   for (var i = 0; i &lt; nicks.length; ++i) {</span>
<a href="#l21.40"></a><span id="l21.40">     var nick = nicks[i];</span>
<a href="#l21.41"></a><span id="l21.41">     if (!nick.hasAttribute(&quot;data-left&quot;))</span>
<a href="#l21.42"></a><span id="l21.42">       nick.style.background = nick_background.replace(/#/g, nick.getAttribute(&quot;data-nickColor&quot;));</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mail/components/im/messages/mail/Footer.html</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mail/components/im/messages/mail/Footer.html</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -1,16 +1,15 @@</span>
<a href="#l22.4"></a><span id="l22.4"> &lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l22.5"></a><span id="l22.5">    - License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l22.6"></a><span id="l22.6">    - file, You can obtain one at http://mozilla.org/MPL/2.0/. --&gt;</span>
<a href="#l22.7"></a><span id="l22.7"> </span>
<a href="#l22.8"></a><span id="l22.8"> &lt;script type=&quot;application/javascript&quot;&gt;</span>
<a href="#l22.9"></a><span id="l22.9"> </span>
<a href="#l22.10"></a><span id="l22.10" class="difflineminus">-function checkNewText(target)</span>
<a href="#l22.11"></a><span id="l22.11" class="difflineminus">-{</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineplus">+function checkNewText(target) {</span>
<a href="#l22.13"></a><span id="l22.13">   if (target.tagName == &quot;P&quot; &amp;&amp; target.className == &quot;event&quot;) {</span>
<a href="#l22.14"></a><span id="l22.14">     let parent = target.parentNode;</span>
<a href="#l22.15"></a><span id="l22.15">     // We need to start a group with this element if there are at least 4</span>
<a href="#l22.16"></a><span id="l22.16">     // system messages and they aren't already grouped.</span>
<a href="#l22.17"></a><span id="l22.17">     if (!parent.grouped &amp;&amp; parent.querySelector(&quot;p.event:nth-of-type(4)&quot;)) {</span>
<a href="#l22.18"></a><span id="l22.18">       var p = document.createElement(&quot;p&quot;);</span>
<a href="#l22.19"></a><span id="l22.19">       p.className = &quot;eventToggle&quot;;</span>
<a href="#l22.20"></a><span id="l22.20">       p.addEventListener(&quot;click&quot;, event =&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mail/components/im/messages/papersheets/Footer.html</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mail/components/im/messages/papersheets/Footer.html</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -6,18 +6,17 @@</span>
<a href="#l23.4"></a><span id="l23.4"> </span>
<a href="#l23.5"></a><span id="l23.5"> const bg_gradient = &quot;background: -moz-linear-gradient(top, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.1) 15px, hsla(#, 100%, 98%, 1) 15px, hsla(#, 100%, 98%, 1));&quot;;</span>
<a href="#l23.6"></a><span id="l23.6"> const bg_context_gradient = &quot;background: -moz-linear-gradient(top, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.05) 15px, hsla(#, 20%, 98%, 1) 15px, hsla(#, 20%, 98%, 1));&quot;;</span>
<a href="#l23.7"></a><span id="l23.7"> const bg_color = &quot;background-color: hsl(#, 100%, 98%);&quot;;</span>
<a href="#l23.8"></a><span id="l23.8"> </span>
<a href="#l23.9"></a><span id="l23.9"> var body = document.getElementById(&quot;ibcontent&quot;);</span>
<a href="#l23.10"></a><span id="l23.10"> </span>
<a href="#l23.11"></a><span id="l23.11"> </span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-function setColors(target)</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineminus">-{</span>
<a href="#l23.14"></a><span id="l23.14" class="difflineplus">+function setColors(target) {</span>
<a href="#l23.15"></a><span id="l23.15">   var senderColor = target.getAttribute(&quot;data-senderColor&quot;);</span>
<a href="#l23.16"></a><span id="l23.16"> </span>
<a href="#l23.17"></a><span id="l23.17">   if (senderColor) {</span>
<a href="#l23.18"></a><span id="l23.18">     var regexp = /color:\s*hsl\(\s*(\d{1,3})\s*,\s*\d{1,3}\%\s*,\s*\d{1,3}\%\s*\)/;</span>
<a href="#l23.19"></a><span id="l23.19">     var parsed = regexp.exec(senderColor);</span>
<a href="#l23.20"></a><span id="l23.20"> </span>
<a href="#l23.21"></a><span id="l23.21">     if (parsed) {</span>
<a href="#l23.22"></a><span id="l23.22">       var senderHue = parsed[1];</span>
<a href="#l23.23"></a><span id="l23.23" class="difflineat">@@ -26,35 +25,31 @@ function setColors(target)</span>
<a href="#l23.24"></a><span id="l23.24">       else</span>
<a href="#l23.25"></a><span id="l23.25">         target.setAttribute(&quot;style&quot;, bg_gradient.replace(/#/g, senderHue));</span>
<a href="#l23.26"></a><span id="l23.26">     }</span>
<a href="#l23.27"></a><span id="l23.27">   }</span>
<a href="#l23.28"></a><span id="l23.28"> </span>
<a href="#l23.29"></a><span id="l23.29">   if (body.scrollHeight &lt;= screen.height) {</span>
<a href="#l23.30"></a><span id="l23.30">     if (senderHue) {</span>
<a href="#l23.31"></a><span id="l23.31">       body.setAttribute(&quot;style&quot;, bg_color.replace(&quot;#&quot;, senderHue));</span>
<a href="#l23.32"></a><span id="l23.32" class="difflineminus">-    }</span>
<a href="#l23.33"></a><span id="l23.33" class="difflineminus">-    else if (target.classList.contains(&quot;outgoing&quot;)) {</span>
<a href="#l23.34"></a><span id="l23.34" class="difflineplus">+    } else if (target.classList.contains(&quot;outgoing&quot;)) {</span>
<a href="#l23.35"></a><span id="l23.35">       body.className = &quot;outgoing-color&quot;;</span>
<a href="#l23.36"></a><span id="l23.36">       body.removeAttribute(&quot;style&quot;);</span>
<a href="#l23.37"></a><span id="l23.37" class="difflineminus">-    }</span>
<a href="#l23.38"></a><span id="l23.38" class="difflineminus">-    else if (target.classList.contains(&quot;incoming&quot;)) {</span>
<a href="#l23.39"></a><span id="l23.39" class="difflineplus">+    } else if (target.classList.contains(&quot;incoming&quot;)) {</span>
<a href="#l23.40"></a><span id="l23.40">       body.className = &quot;incoming-color&quot;;</span>
<a href="#l23.41"></a><span id="l23.41">       body.removeAttribute(&quot;style&quot;);</span>
<a href="#l23.42"></a><span id="l23.42" class="difflineminus">-    }</span>
<a href="#l23.43"></a><span id="l23.43" class="difflineminus">-    else if (target.classList.contains(&quot;event&quot;)) {</span>
<a href="#l23.44"></a><span id="l23.44" class="difflineplus">+    } else if (target.classList.contains(&quot;event&quot;)) {</span>
<a href="#l23.45"></a><span id="l23.45">       body.className = &quot;event-color&quot;;</span>
<a href="#l23.46"></a><span id="l23.46">       body.removeAttribute(&quot;style&quot;);</span>
<a href="#l23.47"></a><span id="l23.47">     }</span>
<a href="#l23.48"></a><span id="l23.48">   }</span>
<a href="#l23.49"></a><span id="l23.49"> }</span>
<a href="#l23.50"></a><span id="l23.50"> </span>
<a href="#l23.51"></a><span id="l23.51"> </span>
<a href="#l23.52"></a><span id="l23.52" class="difflineminus">-function checkNewText(target)</span>
<a href="#l23.53"></a><span id="l23.53" class="difflineminus">-{</span>
<a href="#l23.54"></a><span id="l23.54" class="difflineplus">+function checkNewText(target) {</span>
<a href="#l23.55"></a><span id="l23.55">   if (target.tagName == &quot;DIV&quot;)</span>
<a href="#l23.56"></a><span id="l23.56">     setColors(target);</span>
<a href="#l23.57"></a><span id="l23.57">   else if (target.tagName == &quot;P&quot; &amp;&amp; target.className == &quot;event&quot;) {</span>
<a href="#l23.58"></a><span id="l23.58">     let parent = target.parentNode;</span>
<a href="#l23.59"></a><span id="l23.59">     // We need to start a group with this element if there are at least 3</span>
<a href="#l23.60"></a><span id="l23.60">     // system messages and they aren't already grouped.</span>
<a href="#l23.61"></a><span id="l23.61">     if (!parent.grouped &amp;&amp; parent.querySelector(&quot;p.event:nth-of-type(3)&quot;)) {</span>
<a href="#l23.62"></a><span id="l23.62">       var div = document.createElement(&quot;div&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mail/components/im/modules/chatHandler.jsm</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mail/components/im/modules/chatHandler.jsm</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -1,47 +1,47 @@</span>
<a href="#l24.4"></a><span id="l24.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l24.5"></a><span id="l24.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l24.6"></a><span id="l24.6">  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l24.7"></a><span id="l24.7"> </span>
<a href="#l24.8"></a><span id="l24.8"> this.EXPORTED_SYMBOLS = [&quot;allContacts&quot;, &quot;onlineContacts&quot;, &quot;ChatCore&quot;];</span>
<a href="#l24.9"></a><span id="l24.9"> </span>
<a href="#l24.10"></a><span id="l24.10" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l24.11"></a><span id="l24.11" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineplus">+const { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;, null);</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineplus">+const { fixIterator } = ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;, null);</span>
<a href="#l24.14"></a><span id="l24.14"> ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l24.15"></a><span id="l24.15"> </span>
<a href="#l24.16"></a><span id="l24.16"> var allContacts = {};</span>
<a href="#l24.17"></a><span id="l24.17"> var onlineContacts = {};</span>
<a href="#l24.18"></a><span id="l24.18"> </span>
<a href="#l24.19"></a><span id="l24.19"> var ChatCore = {</span>
<a href="#l24.20"></a><span id="l24.20">   initialized: false,</span>
<a href="#l24.21"></a><span id="l24.21">   _initializing: false,</span>
<a href="#l24.22"></a><span id="l24.22" class="difflineminus">-  init: function() {</span>
<a href="#l24.23"></a><span id="l24.23" class="difflineplus">+  init() {</span>
<a href="#l24.24"></a><span id="l24.24">     if (this._initializing)</span>
<a href="#l24.25"></a><span id="l24.25">       return;</span>
<a href="#l24.26"></a><span id="l24.26">     this._initializing = true;</span>
<a href="#l24.27"></a><span id="l24.27"> </span>
<a href="#l24.28"></a><span id="l24.28" class="difflineminus">-    ChromeUtils.import(&quot;resource:///modules/index_im.js&quot;);</span>
<a href="#l24.29"></a><span id="l24.29" class="difflineplus">+    ChromeUtils.import(&quot;resource:///modules/index_im.jsm&quot;, null);</span>
<a href="#l24.30"></a><span id="l24.30"> </span>
<a href="#l24.31"></a><span id="l24.31">     Services.obs.addObserver(this, &quot;browser-request&quot;);</span>
<a href="#l24.32"></a><span id="l24.32">     Services.obs.addObserver(this, &quot;contact-signed-on&quot;);</span>
<a href="#l24.33"></a><span id="l24.33">     Services.obs.addObserver(this, &quot;contact-signed-off&quot;);</span>
<a href="#l24.34"></a><span id="l24.34">     Services.obs.addObserver(this, &quot;contact-added&quot;);</span>
<a href="#l24.35"></a><span id="l24.35">     Services.obs.addObserver(this, &quot;contact-removed&quot;);</span>
<a href="#l24.36"></a><span id="l24.36"> </span>
<a href="#l24.37"></a><span id="l24.37">     // The initialization of the im core may trigger a master password prompt,</span>
<a href="#l24.38"></a><span id="l24.38">     // so wrap it with the async prompter service. Note this service already</span>
<a href="#l24.39"></a><span id="l24.39">     // waits for the asynchronous initialization of the password service.</span>
<a href="#l24.40"></a><span id="l24.40">     Cc[&quot;@mozilla.org/messenger/msgAsyncPrompter;1&quot;]</span>
<a href="#l24.41"></a><span id="l24.41">       .getService(Ci.nsIMsgAsyncPrompter)</span>
<a href="#l24.42"></a><span id="l24.42">       .queueAsyncAuthPrompt(&quot;im&quot;, false, {</span>
<a href="#l24.43"></a><span id="l24.43" class="difflineminus">-      onPromptStartAsync: function(callback) {</span>
<a href="#l24.44"></a><span id="l24.44" class="difflineplus">+      onPromptStartAsync(callback) {</span>
<a href="#l24.45"></a><span id="l24.45">         callback.onAuthResult(this.onPromptStart());</span>
<a href="#l24.46"></a><span id="l24.46">       },</span>
<a href="#l24.47"></a><span id="l24.47" class="difflineminus">-      onPromptStart: function() {</span>
<a href="#l24.48"></a><span id="l24.48" class="difflineplus">+      onPromptStart() {</span>
<a href="#l24.49"></a><span id="l24.49">         Services.core.init();</span>
<a href="#l24.50"></a><span id="l24.50"> </span>
<a href="#l24.51"></a><span id="l24.51">         // Find the accounts that exist in the im account service but</span>
<a href="#l24.52"></a><span id="l24.52">         // not in nsMsgAccountManager. They have probably been lost if</span>
<a href="#l24.53"></a><span id="l24.53">         // the user has used an older version of Thunderbird on a</span>
<a href="#l24.54"></a><span id="l24.54">         // profile with IM accounts. See bug 736035.</span>
<a href="#l24.55"></a><span id="l24.55">         let accountsById = {};</span>
<a href="#l24.56"></a><span id="l24.56">         for (let account of fixIterator(Services.accounts.getAccounts()))</span>
<a href="#l24.57"></a><span id="l24.57" class="difflineat">@@ -63,33 +63,33 @@ var ChatCore = {</span>
<a href="#l24.58"></a><span id="l24.58">           let acc = mgr.createAccount();</span>
<a href="#l24.59"></a><span id="l24.59">           // Avoid new folder notifications.</span>
<a href="#l24.60"></a><span id="l24.60">           inServer.valid = false;</span>
<a href="#l24.61"></a><span id="l24.61">           acc.incomingServer = inServer;</span>
<a href="#l24.62"></a><span id="l24.62">           inServer.valid = true;</span>
<a href="#l24.63"></a><span id="l24.63">           mgr.notifyServerLoaded(inServer);</span>
<a href="#l24.64"></a><span id="l24.64">         }</span>
<a href="#l24.65"></a><span id="l24.65"> </span>
<a href="#l24.66"></a><span id="l24.66" class="difflineminus">-        Services.tags.getTags().forEach(function (aTag) {</span>
<a href="#l24.67"></a><span id="l24.67" class="difflineplus">+        Services.tags.getTags().forEach(function(aTag) {</span>
<a href="#l24.68"></a><span id="l24.68">           aTag.getContacts().forEach(function(aContact) {</span>
<a href="#l24.69"></a><span id="l24.69">             let name = aContact.preferredBuddy.normalizedName;</span>
<a href="#l24.70"></a><span id="l24.70">             allContacts[name] = aContact;</span>
<a href="#l24.71"></a><span id="l24.71">           });</span>
<a href="#l24.72"></a><span id="l24.72">         });</span>
<a href="#l24.73"></a><span id="l24.73"> </span>
<a href="#l24.74"></a><span id="l24.74">         ChatCore.initialized = true;</span>
<a href="#l24.75"></a><span id="l24.75">         Services.obs.notifyObservers(null, &quot;chat-core-initialized&quot;);</span>
<a href="#l24.76"></a><span id="l24.76">         ChatCore._initializing = false;</span>
<a href="#l24.77"></a><span id="l24.77">         return true;</span>
<a href="#l24.78"></a><span id="l24.78">       },</span>
<a href="#l24.79"></a><span id="l24.79" class="difflineminus">-      onPromptAuthAvailable: function() { },</span>
<a href="#l24.80"></a><span id="l24.80" class="difflineminus">-      onPromptCanceled: function() { }</span>
<a href="#l24.81"></a><span id="l24.81" class="difflineplus">+      onPromptAuthAvailable() {},</span>
<a href="#l24.82"></a><span id="l24.82" class="difflineplus">+      onPromptCanceled() {},</span>
<a href="#l24.83"></a><span id="l24.83">     });</span>
<a href="#l24.84"></a><span id="l24.84">   },</span>
<a href="#l24.85"></a><span id="l24.85" class="difflineminus">-  observe: function(aSubject, aTopic, aData) {</span>
<a href="#l24.86"></a><span id="l24.86" class="difflineplus">+  observe(aSubject, aTopic, aData) {</span>
<a href="#l24.87"></a><span id="l24.87">     if (aTopic == &quot;browser-request&quot;) {</span>
<a href="#l24.88"></a><span id="l24.88">       Services.ww.openWindow(null,</span>
<a href="#l24.89"></a><span id="l24.89">                              &quot;chrome://chat/content/browserRequest.xul&quot;,</span>
<a href="#l24.90"></a><span id="l24.90">                              null, &quot;chrome&quot;, aSubject);</span>
<a href="#l24.91"></a><span id="l24.91">       return;</span>
<a href="#l24.92"></a><span id="l24.92">     }</span>
<a href="#l24.93"></a><span id="l24.93"> </span>
<a href="#l24.94"></a><span id="l24.94">     if (aTopic == &quot;contact-signed-on&quot;) {</span>
<a href="#l24.95"></a><span id="l24.95" class="difflineat">@@ -104,12 +104,11 @@ var ChatCore = {</span>
<a href="#l24.96"></a><span id="l24.96"> </span>
<a href="#l24.97"></a><span id="l24.97">     if (aTopic == &quot;contact-added&quot;) {</span>
<a href="#l24.98"></a><span id="l24.98">       allContacts[aSubject.preferredBuddy.normalizedName] = aSubject;</span>
<a href="#l24.99"></a><span id="l24.99">       return;</span>
<a href="#l24.100"></a><span id="l24.100">     }</span>
<a href="#l24.101"></a><span id="l24.101"> </span>
<a href="#l24.102"></a><span id="l24.102">     if (aTopic == &quot;contact-removed&quot;) {</span>
<a href="#l24.103"></a><span id="l24.103">       delete allContacts[aSubject.preferredBuddy.normalizedName];</span>
<a href="#l24.104"></a><span id="l24.104" class="difflineminus">-      return;</span>
<a href="#l24.105"></a><span id="l24.105">     }</span>
<a href="#l24.106"></a><span id="l24.106" class="difflineminus">-  }</span>
<a href="#l24.107"></a><span id="l24.107" class="difflineplus">+  },</span>
<a href="#l24.108"></a><span id="l24.108"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/mail/components/im/modules/chatNotifications.jsm</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/mail/components/im/modules/chatNotifications.jsm</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -1,52 +1,51 @@</span>
<a href="#l25.4"></a><span id="l25.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l25.5"></a><span id="l25.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l25.6"></a><span id="l25.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l25.7"></a><span id="l25.7"> </span>
<a href="#l25.8"></a><span id="l25.8"> this.EXPORTED_SYMBOLS = [&quot;Notifications&quot;];</span>
<a href="#l25.9"></a><span id="l25.9"> </span>
<a href="#l25.10"></a><span id="l25.10" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l25.11"></a><span id="l25.11" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/hiddenWindow.jsm&quot;);</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineplus">+const { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;, null);</span>
<a href="#l25.13"></a><span id="l25.13"> ChromeUtils.import(&quot;resource:///modules/StringBundle.js&quot;);</span>
<a href="#l25.14"></a><span id="l25.14"> ChromeUtils.import(&quot;resource://gre/modules/AppConstants.jsm&quot;);</span>
<a href="#l25.15"></a><span id="l25.15"> ChromeUtils.import(&quot;resource://gre/modules/PluralForm.jsm&quot;);</span>
<a href="#l25.16"></a><span id="l25.16"> ChromeUtils.import(&quot;resource://gre/modules/Timer.jsm&quot;);</span>
<a href="#l25.17"></a><span id="l25.17"> Cu.importGlobalProperties([&quot;DOMParser&quot;]);</span>
<a href="#l25.18"></a><span id="l25.18"> </span>
<a href="#l25.19"></a><span id="l25.19"> // Time in seconds: it is the minimum time of inactivity</span>
<a href="#l25.20"></a><span id="l25.20"> // needed to show the bundled notification.</span>
<a href="#l25.21"></a><span id="l25.21"> var kTimeToWaitForMoreMsgs = 3;</span>
<a href="#l25.22"></a><span id="l25.22"> </span>
<a href="#l25.23"></a><span id="l25.23"> var Notifications = {</span>
<a href="#l25.24"></a><span id="l25.24" class="difflineminus">-  get ellipsis () {</span>
<a href="#l25.25"></a><span id="l25.25" class="difflineplus">+  get ellipsis() {</span>
<a href="#l25.26"></a><span id="l25.26">     let ellipsis = &quot;[\u2026]&quot;;</span>
<a href="#l25.27"></a><span id="l25.27"> </span>
<a href="#l25.28"></a><span id="l25.28">     try {</span>
<a href="#l25.29"></a><span id="l25.29">       ellipsis =</span>
<a href="#l25.30"></a><span id="l25.30">         Services.prefs.getComplexValue(&quot;intl.ellipsis&quot;,</span>
<a href="#l25.31"></a><span id="l25.31">                                        Ci.nsIPrefLocalizedString).data;</span>
<a href="#l25.32"></a><span id="l25.32" class="difflineminus">-    } catch (e) { }</span>
<a href="#l25.33"></a><span id="l25.33" class="difflineplus">+    } catch (e) {}</span>
<a href="#l25.34"></a><span id="l25.34">     return ellipsis;</span>
<a href="#l25.35"></a><span id="l25.35">   },</span>
<a href="#l25.36"></a><span id="l25.36"> </span>
<a href="#l25.37"></a><span id="l25.37">   // Holds the first direct message of a bundle while we wait for further</span>
<a href="#l25.38"></a><span id="l25.38">   // messages from the same sender to arrive.</span>
<a href="#l25.39"></a><span id="l25.39">   _heldMessage: null,</span>
<a href="#l25.40"></a><span id="l25.40">   // Number of messages to be bundled in the notification (excluding</span>
<a href="#l25.41"></a><span id="l25.41">   // _heldMessage).</span>
<a href="#l25.42"></a><span id="l25.42">   _msgCounter: 0,</span>
<a href="#l25.43"></a><span id="l25.43">   // Time the last message was received.</span>
<a href="#l25.44"></a><span id="l25.44">   _lastMessageTime: 0,</span>
<a href="#l25.45"></a><span id="l25.45">   // Sender of the last message.</span>
<a href="#l25.46"></a><span id="l25.46">   _lastMessageSender: null,</span>
<a href="#l25.47"></a><span id="l25.47">   // timeout Id for the set timeout for showing notification.</span>
<a href="#l25.48"></a><span id="l25.48">   _timeoutId: null,</span>
<a href="#l25.49"></a><span id="l25.49"> </span>
<a href="#l25.50"></a><span id="l25.50" class="difflineminus">-  _showMessageNotification: function(aMessage, aCounter = 0) {</span>
<a href="#l25.51"></a><span id="l25.51" class="difflineplus">+  _showMessageNotification(aMessage, aCounter = 0) {</span>
<a href="#l25.52"></a><span id="l25.52">     // We are about to show the notification, so let's play the notification sound.</span>
<a href="#l25.53"></a><span id="l25.53">     // We play the sound if the user is away from TB window or even away from chat tab.</span>
<a href="#l25.54"></a><span id="l25.54">     let win = Services.wm.getMostRecentWindow(&quot;mail:3pane&quot;);</span>
<a href="#l25.55"></a><span id="l25.55">     if (!Services.focus.activeWindow ||</span>
<a href="#l25.56"></a><span id="l25.56">         win.document.getElementById(&quot;tabmail&quot;).currentTabInfo.mode.name != &quot;chat&quot;)</span>
<a href="#l25.57"></a><span id="l25.57">       Services.obs.notifyObservers(aMessage, &quot;play-chat-notification-sound&quot;);</span>
<a href="#l25.58"></a><span id="l25.58"> </span>
<a href="#l25.59"></a><span id="l25.59">     // If TB window has focus, there's no need to show the notification..</span>
<a href="#l25.60"></a><span id="l25.60" class="difflineat">@@ -143,23 +142,23 @@ var Notifications = {</span>
<a href="#l25.61"></a><span id="l25.61">           .activateApplication(true);</span>
<a href="#l25.62"></a><span id="l25.62">       }</span>
<a href="#l25.63"></a><span id="l25.63">     });</span>
<a href="#l25.64"></a><span id="l25.64"> </span>
<a href="#l25.65"></a><span id="l25.65">     this._heldMessage = null;</span>
<a href="#l25.66"></a><span id="l25.66">     this._msgCounter = 0;</span>
<a href="#l25.67"></a><span id="l25.67">   },</span>
<a href="#l25.68"></a><span id="l25.68"> </span>
<a href="#l25.69"></a><span id="l25.69" class="difflineminus">-  init: function() {</span>
<a href="#l25.70"></a><span id="l25.70" class="difflineplus">+  init() {</span>
<a href="#l25.71"></a><span id="l25.71">     Services.obs.addObserver(Notifications, &quot;new-directed-incoming-message&quot;);</span>
<a href="#l25.72"></a><span id="l25.72">     Services.obs.addObserver(Notifications, &quot;alertclickcallback&quot;);</span>
<a href="#l25.73"></a><span id="l25.73">   },</span>
<a href="#l25.74"></a><span id="l25.74"> </span>
<a href="#l25.75"></a><span id="l25.75">   _notificationPrefName: &quot;mail.chat.show_desktop_notifications&quot;,</span>
<a href="#l25.76"></a><span id="l25.76" class="difflineminus">-  observe: function(aSubject, aTopic, aData) {</span>
<a href="#l25.77"></a><span id="l25.77" class="difflineplus">+  observe(aSubject, aTopic, aData) {</span>
<a href="#l25.78"></a><span id="l25.78">     if (aTopic == &quot;new-directed-incoming-message&quot; &amp;&amp;</span>
<a href="#l25.79"></a><span id="l25.79">         Services.prefs.getBoolPref(this._notificationPrefName)) {</span>
<a href="#l25.80"></a><span id="l25.80">       // If this is the first message, we show the notification and</span>
<a href="#l25.81"></a><span id="l25.81">       // store the sender's name.</span>
<a href="#l25.82"></a><span id="l25.82">       let sender = aSubject.who || aSubject.alias;</span>
<a href="#l25.83"></a><span id="l25.83">       if (this._lastMessageSender == null) {</span>
<a href="#l25.84"></a><span id="l25.84">         this._lastMessageSender = sender;</span>
<a href="#l25.85"></a><span id="l25.85">         this._lastMessageTime = aSubject.time;</span>
<a href="#l25.86"></a><span id="l25.86" class="difflineat">@@ -188,14 +187,14 @@ var Notifications = {</span>
<a href="#l25.87"></a><span id="l25.87">         if (!this._heldMessage)</span>
<a href="#l25.88"></a><span id="l25.88">           this._heldMessage = aSubject;</span>
<a href="#l25.89"></a><span id="l25.89">         else</span>
<a href="#l25.90"></a><span id="l25.90">           this._msgCounter++;</span>
<a href="#l25.91"></a><span id="l25.91"> </span>
<a href="#l25.92"></a><span id="l25.92">         clearTimeout(this._timeoutId);</span>
<a href="#l25.93"></a><span id="l25.93">         this._timeoutId = setTimeout(function() {</span>
<a href="#l25.94"></a><span id="l25.94">             Notifications._showMessageNotification(Notifications._heldMessage,</span>
<a href="#l25.95"></a><span id="l25.95" class="difflineminus">-                                                   Notifications._msgCounter)</span>
<a href="#l25.96"></a><span id="l25.96" class="difflineplus">+                                                   Notifications._msgCounter);</span>
<a href="#l25.97"></a><span id="l25.97">           }, kTimeToWaitForMoreMsgs * 1000);</span>
<a href="#l25.98"></a><span id="l25.98">       }</span>
<a href="#l25.99"></a><span id="l25.99">     }</span>
<a href="#l25.100"></a><span id="l25.100" class="difflineminus">-  }</span>
<a href="#l25.101"></a><span id="l25.101" class="difflineplus">+  },</span>
<a href="#l25.102"></a><span id="l25.102"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1">rename from mail/components/im/modules/index_im.js</span>
<a href="#l26.2"></a><span id="l26.2">rename to mail/components/im/modules/index_im.jsm</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineminus">--- a/mail/components/im/modules/index_im.js</span>
<a href="#l26.4"></a><span id="l26.4" class="difflineplus">+++ b/mail/components/im/modules/index_im.jsm</span>
<a href="#l26.5"></a><span id="l26.5" class="difflineat">@@ -1,26 +1,31 @@</span>
<a href="#l26.6"></a><span id="l26.6"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l26.7"></a><span id="l26.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l26.8"></a><span id="l26.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l26.9"></a><span id="l26.9"> </span>
<a href="#l26.10"></a><span id="l26.10"> this.EXPORTED_SYMBOLS = [];</span>
<a href="#l26.11"></a><span id="l26.11"> </span>
<a href="#l26.12"></a><span id="l26.12"> var CC = Components.Constructor;</span>
<a href="#l26.13"></a><span id="l26.13"> </span>
<a href="#l26.14"></a><span id="l26.14" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/gloda/public.js&quot;);</span>
<a href="#l26.15"></a><span id="l26.15" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/gloda/datamodel.js&quot;);</span>
<a href="#l26.16"></a><span id="l26.16" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/gloda/indexer.js&quot;);</span>
<a href="#l26.17"></a><span id="l26.17" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l26.18"></a><span id="l26.18" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l26.19"></a><span id="l26.19" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l26.20"></a><span id="l26.20" class="difflineplus">+const { Gloda } = ChromeUtils.import(&quot;resource:///modules/gloda/public.js&quot;, null);</span>
<a href="#l26.21"></a><span id="l26.21" class="difflineplus">+const { GlodaAccount } = ChromeUtils.import(&quot;resource:///modules/gloda/datamodel.js&quot;, null);</span>
<a href="#l26.22"></a><span id="l26.22" class="difflineplus">+const {</span>
<a href="#l26.23"></a><span id="l26.23" class="difflineplus">+  GlodaIndexer,</span>
<a href="#l26.24"></a><span id="l26.24" class="difflineplus">+  IndexingJob,</span>
<a href="#l26.25"></a><span id="l26.25" class="difflineplus">+} = ChromeUtils.import(&quot;resource:///modules/gloda/indexer.js&quot;, null);</span>
<a href="#l26.26"></a><span id="l26.26" class="difflineplus">+const { fixIterator } = ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;, null);</span>
<a href="#l26.27"></a><span id="l26.27" class="difflineplus">+const { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;, null);</span>
<a href="#l26.28"></a><span id="l26.28"> ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l26.29"></a><span id="l26.29"> ChromeUtils.import(&quot;resource://gre/modules/FileUtils.jsm&quot;);</span>
<a href="#l26.30"></a><span id="l26.30" class="difflineminus">-ChromeUtils.import(&quot;resource://gre/modules/NetUtil.jsm&quot;);</span>
<a href="#l26.31"></a><span id="l26.31" class="difflineminus">-ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l26.32"></a><span id="l26.32" class="difflineplus">+ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l26.33"></a><span id="l26.33" class="difflineplus">+const {</span>
<a href="#l26.34"></a><span id="l26.34" class="difflineplus">+  clearTimeout,</span>
<a href="#l26.35"></a><span id="l26.35" class="difflineplus">+  setTimeout,</span>
<a href="#l26.36"></a><span id="l26.36" class="difflineplus">+} = ChromeUtils.import(&quot;resource://gre/modules/Timer.jsm&quot;, null);</span>
<a href="#l26.37"></a><span id="l26.37"> </span>
<a href="#l26.38"></a><span id="l26.38"> ChromeUtils.defineModuleGetter(this, &quot;OS&quot;, &quot;resource://gre/modules/osfile.jsm&quot;);</span>
<a href="#l26.39"></a><span id="l26.39"> ChromeUtils.defineModuleGetter(this, &quot;Task&quot;, &quot;resource://gre/modules/Task.jsm&quot;);</span>
<a href="#l26.40"></a><span id="l26.40"> ChromeUtils.defineModuleGetter(this, &quot;AsyncShutdown&quot;,</span>
<a href="#l26.41"></a><span id="l26.41">                                &quot;resource://gre/modules/AsyncShutdown.jsm&quot;);</span>
<a href="#l26.42"></a><span id="l26.42"> ChromeUtils.defineModuleGetter(this, &quot;GlodaDatastore&quot;,</span>
<a href="#l26.43"></a><span id="l26.43">                                &quot;resource:///modules/gloda/datastore.js&quot;);</span>
<a href="#l26.44"></a><span id="l26.44"> </span>
<a href="#l26.45"></a><span id="l26.45" class="difflineat">@@ -38,18 +43,17 @@ var ScriptableInputStream = CC(&quot;@mozilla</span>
<a href="#l26.46"></a><span id="l26.46"> var kIndexingDelay = 5000; // in milliseconds</span>
<a href="#l26.47"></a><span id="l26.47"> </span>
<a href="#l26.48"></a><span id="l26.48"> XPCOMUtils.defineLazyGetter(this, &quot;MailFolder&quot;, () =&gt;</span>
<a href="#l26.49"></a><span id="l26.49">   Cc[&quot;@mozilla.org/rdf/resource-factory;1?name=mailbox&quot;].createInstance(Ci.nsIMsgFolder)</span>
<a href="#l26.50"></a><span id="l26.50"> );</span>
<a href="#l26.51"></a><span id="l26.51"> </span>
<a href="#l26.52"></a><span id="l26.52"> var gIMAccounts = {};</span>
<a href="#l26.53"></a><span id="l26.53"> </span>
<a href="#l26.54"></a><span id="l26.54" class="difflineminus">-function GlodaIMConversation(aTitle, aTime, aPath, aContent)</span>
<a href="#l26.55"></a><span id="l26.55" class="difflineminus">-{</span>
<a href="#l26.56"></a><span id="l26.56" class="difflineplus">+function GlodaIMConversation(aTitle, aTime, aPath, aContent) {</span>
<a href="#l26.57"></a><span id="l26.57">   // grokNounItem from gloda.js puts automatically the values of all</span>
<a href="#l26.58"></a><span id="l26.58">   // JS properties in the jsonAttributes magic attribute, except if</span>
<a href="#l26.59"></a><span id="l26.59">   // they start with _, so we put the values in _-prefixed properties,</span>
<a href="#l26.60"></a><span id="l26.60">   // and have getters in the prototype.</span>
<a href="#l26.61"></a><span id="l26.61">   this._title = aTitle;</span>
<a href="#l26.62"></a><span id="l26.62">   this._time = aTime;</span>
<a href="#l26.63"></a><span id="l26.63">   this._path = aPath;</span>
<a href="#l26.64"></a><span id="l26.64">   this._content = aContent;</span>
<a href="#l26.65"></a><span id="l26.65" class="difflineat">@@ -105,41 +109,41 @@ GlodaIMConversation.prototype = {</span>
<a href="#l26.66"></a><span id="l26.66">   get tags() { return []; },</span>
<a href="#l26.67"></a><span id="l26.67">   get starred() { return false; },</span>
<a href="#l26.68"></a><span id="l26.68">   get attachmentNames() { return null; },</span>
<a href="#l26.69"></a><span id="l26.69">   get indexedBodyText() { return this._content; },</span>
<a href="#l26.70"></a><span id="l26.70">   get read() { return true; },</span>
<a href="#l26.71"></a><span id="l26.71">   get folder() { return Gloda.IGNORE_FACET; },</span>
<a href="#l26.72"></a><span id="l26.72"> </span>
<a href="#l26.73"></a><span id="l26.73">   // for glodaFacetView.js _removeDupes</span>
<a href="#l26.74"></a><span id="l26.74" class="difflineminus">-  get headerMessageID() { return this.id; }</span>
<a href="#l26.75"></a><span id="l26.75" class="difflineplus">+  get headerMessageID() { return this.id; },</span>
<a href="#l26.76"></a><span id="l26.76"> };</span>
<a href="#l26.77"></a><span id="l26.77"> </span>
<a href="#l26.78"></a><span id="l26.78"> // FIXME</span>
<a href="#l26.79"></a><span id="l26.79"> var WidgetProvider = {</span>
<a href="#l26.80"></a><span id="l26.80">   providerName: &quot;widget&quot;,</span>
<a href="#l26.81"></a><span id="l26.81" class="difflineminus">-  process: function*() {</span>
<a href="#l26.82"></a><span id="l26.82" class="difflineminus">-    //XXX What is this supposed to do?</span>
<a href="#l26.83"></a><span id="l26.83" class="difflineplus">+  * process() {</span>
<a href="#l26.84"></a><span id="l26.84" class="difflineplus">+    // XXX What is this supposed to do?</span>
<a href="#l26.85"></a><span id="l26.85">     yield Gloda.kWorkDone;</span>
<a href="#l26.86"></a><span id="l26.86" class="difflineminus">-  }</span>
<a href="#l26.87"></a><span id="l26.87" class="difflineplus">+  },</span>
<a href="#l26.88"></a><span id="l26.88"> };</span>
<a href="#l26.89"></a><span id="l26.89"> </span>
<a href="#l26.90"></a><span id="l26.90"> var IMConversationNoun = {</span>
<a href="#l26.91"></a><span id="l26.91">   name: &quot;im-conversation&quot;,</span>
<a href="#l26.92"></a><span id="l26.92">   clazz: GlodaIMConversation,</span>
<a href="#l26.93"></a><span id="l26.93">   allowsArbitraryAttrs: true,</span>
<a href="#l26.94"></a><span id="l26.94">   tableName: &quot;imConversations&quot;,</span>
<a href="#l26.95"></a><span id="l26.95">   schema: {</span>
<a href="#l26.96"></a><span id="l26.96" class="difflineminus">-    columns: [['id', 'INTEGER PRIMARY KEY'],</span>
<a href="#l26.97"></a><span id="l26.97" class="difflineminus">-              ['title', 'STRING'],</span>
<a href="#l26.98"></a><span id="l26.98" class="difflineminus">-              ['time', 'NUMBER'],</span>
<a href="#l26.99"></a><span id="l26.99" class="difflineminus">-              ['path', 'STRING']</span>
<a href="#l26.100"></a><span id="l26.100" class="difflineplus">+    columns: [[&quot;id&quot;, &quot;INTEGER PRIMARY KEY&quot;],</span>
<a href="#l26.101"></a><span id="l26.101" class="difflineplus">+              [&quot;title&quot;, &quot;STRING&quot;],</span>
<a href="#l26.102"></a><span id="l26.102" class="difflineplus">+              [&quot;time&quot;, &quot;NUMBER&quot;],</span>
<a href="#l26.103"></a><span id="l26.103" class="difflineplus">+              [&quot;path&quot;, &quot;STRING&quot;],</span>
<a href="#l26.104"></a><span id="l26.104">              ],</span>
<a href="#l26.105"></a><span id="l26.105" class="difflineminus">-    fulltextColumns: [['content', 'STRING']]</span>
<a href="#l26.106"></a><span id="l26.106" class="difflineminus">-  }</span>
<a href="#l26.107"></a><span id="l26.107" class="difflineplus">+    fulltextColumns: [[&quot;content&quot;, &quot;STRING&quot;]],</span>
<a href="#l26.108"></a><span id="l26.108" class="difflineplus">+  },</span>
<a href="#l26.109"></a><span id="l26.109"> };</span>
<a href="#l26.110"></a><span id="l26.110"> Gloda.defineNoun(IMConversationNoun);</span>
<a href="#l26.111"></a><span id="l26.111"> </span>
<a href="#l26.112"></a><span id="l26.112"> // Needs to be set after calling defineNoun, otherwise it's replaced</span>
<a href="#l26.113"></a><span id="l26.113"> // by databind.js' implementation.</span>
<a href="#l26.114"></a><span id="l26.114"> IMConversationNoun.objFromRow = function(aRow) {</span>
<a href="#l26.115"></a><span id="l26.115">   // Row columns are:</span>
<a href="#l26.116"></a><span id="l26.116">   // 0 id</span>
<a href="#l26.117"></a><span id="l26.117" class="difflineat">@@ -163,100 +167,100 @@ Gloda.defineAttribute({</span>
<a href="#l26.118"></a><span id="l26.118">   provider: WidgetProvider, extensionName: EXT_NAME,</span>
<a href="#l26.119"></a><span id="l26.119">   attributeType: Gloda.kAttrFundamental,</span>
<a href="#l26.120"></a><span id="l26.120">   attributeName: &quot;time&quot;,</span>
<a href="#l26.121"></a><span id="l26.121">   singular: true,</span>
<a href="#l26.122"></a><span id="l26.122">   special: Gloda.kSpecialColumn,</span>
<a href="#l26.123"></a><span id="l26.123">   specialColumnName: &quot;time&quot;,</span>
<a href="#l26.124"></a><span id="l26.124">   subjectNouns: [IMConversationNoun.id],</span>
<a href="#l26.125"></a><span id="l26.125">   objectNoun: Gloda.NOUN_NUMBER,</span>
<a href="#l26.126"></a><span id="l26.126" class="difflineminus">-  canQuery: true</span>
<a href="#l26.127"></a><span id="l26.127" class="difflineplus">+  canQuery: true,</span>
<a href="#l26.128"></a><span id="l26.128"> });</span>
<a href="#l26.129"></a><span id="l26.129"> Gloda.defineAttribute({</span>
<a href="#l26.130"></a><span id="l26.130">   provider: WidgetProvider, extensionName: EXT_NAME,</span>
<a href="#l26.131"></a><span id="l26.131">   attributeType: Gloda.kAttrFundamental,</span>
<a href="#l26.132"></a><span id="l26.132">   attributeName: &quot;title&quot;,</span>
<a href="#l26.133"></a><span id="l26.133">   singular: true,</span>
<a href="#l26.134"></a><span id="l26.134">   special: Gloda.kSpecialString,</span>
<a href="#l26.135"></a><span id="l26.135">   specialColumnName: &quot;title&quot;,</span>
<a href="#l26.136"></a><span id="l26.136">   subjectNouns: [IMConversationNoun.id],</span>
<a href="#l26.137"></a><span id="l26.137">   objectNoun: Gloda.NOUN_STRING,</span>
<a href="#l26.138"></a><span id="l26.138" class="difflineminus">-  canQuery: true</span>
<a href="#l26.139"></a><span id="l26.139" class="difflineplus">+  canQuery: true,</span>
<a href="#l26.140"></a><span id="l26.140"> });</span>
<a href="#l26.141"></a><span id="l26.141"> Gloda.defineAttribute({</span>
<a href="#l26.142"></a><span id="l26.142">   provider: WidgetProvider, extensionName: EXT_NAME,</span>
<a href="#l26.143"></a><span id="l26.143">   attributeType: Gloda.kAttrFundamental,</span>
<a href="#l26.144"></a><span id="l26.144">   attributeName: &quot;path&quot;,</span>
<a href="#l26.145"></a><span id="l26.145">   singular: true,</span>
<a href="#l26.146"></a><span id="l26.146">   special: Gloda.kSpecialString,</span>
<a href="#l26.147"></a><span id="l26.147">   specialColumnName: &quot;path&quot;,</span>
<a href="#l26.148"></a><span id="l26.148">   subjectNouns: [IMConversationNoun.id],</span>
<a href="#l26.149"></a><span id="l26.149">   objectNoun: Gloda.NOUN_STRING,</span>
<a href="#l26.150"></a><span id="l26.150" class="difflineminus">-  canQuery: true</span>
<a href="#l26.151"></a><span id="l26.151" class="difflineplus">+  canQuery: true,</span>
<a href="#l26.152"></a><span id="l26.152"> });</span>
<a href="#l26.153"></a><span id="l26.153"> </span>
<a href="#l26.154"></a><span id="l26.154"> // --- fulltext attributes</span>
<a href="#l26.155"></a><span id="l26.155"> Gloda.defineAttribute({</span>
<a href="#l26.156"></a><span id="l26.156">   provider: WidgetProvider, extensionName: EXT_NAME,</span>
<a href="#l26.157"></a><span id="l26.157">   attributeType: Gloda.kAttrFundamental,</span>
<a href="#l26.158"></a><span id="l26.158">   attributeName: &quot;content&quot;,</span>
<a href="#l26.159"></a><span id="l26.159">   singular: true,</span>
<a href="#l26.160"></a><span id="l26.160">   special: Gloda.kSpecialFulltext,</span>
<a href="#l26.161"></a><span id="l26.161">   specialColumnName: &quot;content&quot;,</span>
<a href="#l26.162"></a><span id="l26.162">   subjectNouns: [IMConversationNoun.id],</span>
<a href="#l26.163"></a><span id="l26.163">   objectNoun: Gloda.NOUN_FULLTEXT,</span>
<a href="#l26.164"></a><span id="l26.164" class="difflineminus">-  canQuery: true</span>
<a href="#l26.165"></a><span id="l26.165" class="difflineplus">+  canQuery: true,</span>
<a href="#l26.166"></a><span id="l26.166"> });</span>
<a href="#l26.167"></a><span id="l26.167"> </span>
<a href="#l26.168"></a><span id="l26.168"> // -- fulltext search helper</span>
<a href="#l26.169"></a><span id="l26.169"> // fulltextMatches.  Match over message subject, body, and attachments</span>
<a href="#l26.170"></a><span id="l26.170"> // @testpoint gloda.noun.message.attr.fulltextMatches</span>
<a href="#l26.171"></a><span id="l26.171"> this._attrFulltext = Gloda.defineAttribute({</span>
<a href="#l26.172"></a><span id="l26.172">   provider: WidgetProvider,</span>
<a href="#l26.173"></a><span id="l26.173">   extensionName: EXT_NAME,</span>
<a href="#l26.174"></a><span id="l26.174">   attributeType: Gloda.kAttrDerived,</span>
<a href="#l26.175"></a><span id="l26.175">   attributeName: &quot;fulltextMatches&quot;,</span>
<a href="#l26.176"></a><span id="l26.176">   singular: true,</span>
<a href="#l26.177"></a><span id="l26.177">   special: Gloda.kSpecialFulltext,</span>
<a href="#l26.178"></a><span id="l26.178">   specialColumnName: &quot;imConversationsText&quot;,</span>
<a href="#l26.179"></a><span id="l26.179">   subjectNouns: [IMConversationNoun.id],</span>
<a href="#l26.180"></a><span id="l26.180" class="difflineminus">-  objectNoun: Gloda.NOUN_FULLTEXT</span>
<a href="#l26.181"></a><span id="l26.181" class="difflineplus">+  objectNoun: Gloda.NOUN_FULLTEXT,</span>
<a href="#l26.182"></a><span id="l26.182"> });</span>
<a href="#l26.183"></a><span id="l26.183"> // For facet.js DateFaceter</span>
<a href="#l26.184"></a><span id="l26.184"> Gloda.defineAttribute({</span>
<a href="#l26.185"></a><span id="l26.185">   provider: WidgetProvider, extensionName: EXT_NAME,</span>
<a href="#l26.186"></a><span id="l26.186">   attributeType: Gloda.kAttrDerived,</span>
<a href="#l26.187"></a><span id="l26.187">   attributeName: &quot;date&quot;,</span>
<a href="#l26.188"></a><span id="l26.188">   singular: true,</span>
<a href="#l26.189"></a><span id="l26.189">   special: Gloda.kSpecialColumn,</span>
<a href="#l26.190"></a><span id="l26.190">   subjectNouns: [IMConversationNoun.id],</span>
<a href="#l26.191"></a><span id="l26.191">   objectNoun: Gloda.NOUN_NUMBER,</span>
<a href="#l26.192"></a><span id="l26.192">   facet: {</span>
<a href="#l26.193"></a><span id="l26.193" class="difflineminus">-    type: &quot;date&quot;</span>
<a href="#l26.194"></a><span id="l26.194" class="difflineplus">+    type: &quot;date&quot;,</span>
<a href="#l26.195"></a><span id="l26.195">   },</span>
<a href="#l26.196"></a><span id="l26.196" class="difflineminus">-  canQuery: true</span>
<a href="#l26.197"></a><span id="l26.197" class="difflineplus">+  canQuery: true,</span>
<a href="#l26.198"></a><span id="l26.198"> });</span>
<a href="#l26.199"></a><span id="l26.199"> </span>
<a href="#l26.200"></a><span id="l26.200"> var GlodaIMIndexer = {</span>
<a href="#l26.201"></a><span id="l26.201">   name: &quot;index_im&quot;,</span>
<a href="#l26.202"></a><span id="l26.202">   cacheVersion: 1,</span>
<a href="#l26.203"></a><span id="l26.203" class="difflineminus">-  enable: function() {</span>
<a href="#l26.204"></a><span id="l26.204" class="difflineplus">+  enable() {</span>
<a href="#l26.205"></a><span id="l26.205">     Services.obs.addObserver(this, &quot;conversation-closed&quot;);</span>
<a href="#l26.206"></a><span id="l26.206">     Services.obs.addObserver(this, &quot;new-ui-conversation&quot;);</span>
<a href="#l26.207"></a><span id="l26.207">     Services.obs.addObserver(this, &quot;ui-conversation-closed&quot;);</span>
<a href="#l26.208"></a><span id="l26.208"> </span>
<a href="#l26.209"></a><span id="l26.209">     // The shutdown blocker ensures pending saves happen even if the app</span>
<a href="#l26.210"></a><span id="l26.210">     // gets shut down before the timer fires.</span>
<a href="#l26.211"></a><span id="l26.211">     if (this._shutdownBlockerAdded)</span>
<a href="#l26.212"></a><span id="l26.212">       return;</span>
<a href="#l26.213"></a><span id="l26.213">     this._shutdownBlockerAdded = true;</span>
<a href="#l26.214"></a><span id="l26.214">     AsyncShutdown.profileBeforeChange.addBlocker(&quot;GlodaIMIndexer cache save&quot;,</span>
<a href="#l26.215"></a><span id="l26.215">       () =&gt; {</span>
<a href="#l26.216"></a><span id="l26.216">         if (!this._cacheSaveTimer)</span>
<a href="#l26.217"></a><span id="l26.217" class="difflineminus">-          return;</span>
<a href="#l26.218"></a><span id="l26.218" class="difflineplus">+          return Promise.resolve();</span>
<a href="#l26.219"></a><span id="l26.219">         clearTimeout(this._cacheSaveTimer);</span>
<a href="#l26.220"></a><span id="l26.220">         return this._saveCacheNow();</span>
<a href="#l26.221"></a><span id="l26.221">       });</span>
<a href="#l26.222"></a><span id="l26.222"> </span>
<a href="#l26.223"></a><span id="l26.223">     this._knownFiles = {};</span>
<a href="#l26.224"></a><span id="l26.224"> </span>
<a href="#l26.225"></a><span id="l26.225">     let dir = FileUtils.getFile(&quot;ProfD&quot;, [&quot;logs&quot;]);</span>
<a href="#l26.226"></a><span id="l26.226">     if (!dir.exists() || !dir.isDirectory())</span>
<a href="#l26.227"></a><span id="l26.227" class="difflineat">@@ -289,17 +293,17 @@ var GlodaIMIndexer = {</span>
<a href="#l26.228"></a><span id="l26.228"> </span>
<a href="#l26.229"></a><span id="l26.229">     this.cacheVersion = data.version;</span>
<a href="#l26.230"></a><span id="l26.230"> </span>
<a href="#l26.231"></a><span id="l26.231">     // If there was no version set on the cache, there is a chance that the index</span>
<a href="#l26.232"></a><span id="l26.232">     // is affected by bug 1069845. fixEntriesWithAbsolutePaths() sets the version to 1.</span>
<a href="#l26.233"></a><span id="l26.233">     if (!this.cacheVersion)</span>
<a href="#l26.234"></a><span id="l26.234">       this.fixEntriesWithAbsolutePaths();</span>
<a href="#l26.235"></a><span id="l26.235">   },</span>
<a href="#l26.236"></a><span id="l26.236" class="difflineminus">-  disable: function() {</span>
<a href="#l26.237"></a><span id="l26.237" class="difflineplus">+  disable() {</span>
<a href="#l26.238"></a><span id="l26.238">     Services.obs.removeObserver(this, &quot;conversation-closed&quot;);</span>
<a href="#l26.239"></a><span id="l26.239">     Services.obs.removeObserver(this, &quot;new-ui-conversation&quot;);</span>
<a href="#l26.240"></a><span id="l26.240">     Services.obs.removeObserver(this, &quot;ui-conversation-closed&quot;);</span>
<a href="#l26.241"></a><span id="l26.241">   },</span>
<a href="#l26.242"></a><span id="l26.242"> </span>
<a href="#l26.243"></a><span id="l26.243">   /* _knownFiles is a tree whose leaves are the last modified times of</span>
<a href="#l26.244"></a><span id="l26.244">    * log files when they were last indexed.</span>
<a href="#l26.245"></a><span id="l26.245">    * Each level of the tree is stored as an object. The root node is an</span>
<a href="#l26.246"></a><span id="l26.246" class="difflineat">@@ -310,28 +314,28 @@ var GlodaIMIndexer = {</span>
<a href="#l26.247"></a><span id="l26.247">    * protocol names -&gt; account names -&gt; conv names  -&gt; file names -&gt; last modified time</span>
<a href="#l26.248"></a><span id="l26.248">    * convObj maps ALL previously indexed log files of a chat buddy or MUC to</span>
<a href="#l26.249"></a><span id="l26.249">    * their last modified times. Note that gloda knows nothing about log grouping</span>
<a href="#l26.250"></a><span id="l26.250">    * done by logger.js.</span>
<a href="#l26.251"></a><span id="l26.251">    */</span>
<a href="#l26.252"></a><span id="l26.252">   _knownFiles: {},</span>
<a href="#l26.253"></a><span id="l26.253">   _cacheSaveTimer: null,</span>
<a href="#l26.254"></a><span id="l26.254">   _shutdownBlockerAdded: false,</span>
<a href="#l26.255"></a><span id="l26.255" class="difflineminus">-  _scheduleCacheSave: function() {</span>
<a href="#l26.256"></a><span id="l26.256" class="difflineplus">+  _scheduleCacheSave() {</span>
<a href="#l26.257"></a><span id="l26.257">     if (this._cacheSaveTimer)</span>
<a href="#l26.258"></a><span id="l26.258">       return;</span>
<a href="#l26.259"></a><span id="l26.259">     this._cacheSaveTimer = setTimeout(this._saveCacheNow, 5000);</span>
<a href="#l26.260"></a><span id="l26.260">   },</span>
<a href="#l26.261"></a><span id="l26.261" class="difflineminus">-  _saveCacheNow: function() {</span>
<a href="#l26.262"></a><span id="l26.262" class="difflineplus">+  _saveCacheNow() {</span>
<a href="#l26.263"></a><span id="l26.263">     GlodaIMIndexer._cacheSaveTimer = null;</span>
<a href="#l26.264"></a><span id="l26.264"> </span>
<a href="#l26.265"></a><span id="l26.265">     let data = {</span>
<a href="#l26.266"></a><span id="l26.266">       knownFiles: GlodaIMIndexer._knownFiles,</span>
<a href="#l26.267"></a><span id="l26.267">       datastoreID: Gloda.datastoreID,</span>
<a href="#l26.268"></a><span id="l26.268" class="difflineminus">-      version: GlodaIMIndexer.cacheVersion</span>
<a href="#l26.269"></a><span id="l26.269" class="difflineplus">+      version: GlodaIMIndexer.cacheVersion,</span>
<a href="#l26.270"></a><span id="l26.270">     };</span>
<a href="#l26.271"></a><span id="l26.271"> </span>
<a href="#l26.272"></a><span id="l26.272">     // Asynchronously copy the data to the file.</span>
<a href="#l26.273"></a><span id="l26.273">     let path = OS.Path.join(OS.Constants.Path.profileDir, &quot;logs&quot;, kCacheFileName);</span>
<a href="#l26.274"></a><span id="l26.274">     return OS.File.writeAtomic(path, JSON.stringify(data),</span>
<a href="#l26.275"></a><span id="l26.275">                                {encoding: &quot;utf-8&quot;, tmpPath: path + &quot;.tmp&quot;})</span>
<a href="#l26.276"></a><span id="l26.276">              .catch(aError =&gt; Cu.reportError(&quot;Failed to write cache file: &quot; + aError));</span>
<a href="#l26.277"></a><span id="l26.277">   },</span>
<a href="#l26.278"></a><span id="l26.278" class="difflineat">@@ -340,51 +344,51 @@ var GlodaIMIndexer = {</span>
<a href="#l26.279"></a><span id="l26.279">   // Promise queue for indexing jobs. The next indexing job is queued using this</span>
<a href="#l26.280"></a><span id="l26.280">   // promise's then() to ensure we only load logs for one conv at a time.</span>
<a href="#l26.281"></a><span id="l26.281">   _indexingJobPromise: null,</span>
<a href="#l26.282"></a><span id="l26.282">   // Maps a conv id to the function that resolves the promise representing the</span>
<a href="#l26.283"></a><span id="l26.283">   // ongoing indexing job on it. This is called from indexIMConversation when it</span>
<a href="#l26.284"></a><span id="l26.284">   // finishes and will trigger the next queued indexing job.</span>
<a href="#l26.285"></a><span id="l26.285">   _indexingJobCallbacks: new Map(),</span>
<a href="#l26.286"></a><span id="l26.286"> </span>
<a href="#l26.287"></a><span id="l26.287" class="difflineminus">-  _scheduleIndexingJob: function(aConversation) {</span>
<a href="#l26.288"></a><span id="l26.288" class="difflineplus">+  _scheduleIndexingJob(aConversation) {</span>
<a href="#l26.289"></a><span id="l26.289">     let convId = aConversation.id;</span>
<a href="#l26.290"></a><span id="l26.290"> </span>
<a href="#l26.291"></a><span id="l26.291">     // If we've already scheduled this conversation to be indexed, let's</span>
<a href="#l26.292"></a><span id="l26.292">     // not repeat.</span>
<a href="#l26.293"></a><span id="l26.293">     if (!(convId in this._knownConversations)) {</span>
<a href="#l26.294"></a><span id="l26.294">       this._knownConversations[convId] = {</span>
<a href="#l26.295"></a><span id="l26.295">         id: convId,</span>
<a href="#l26.296"></a><span id="l26.296">         scheduledIndex: null,</span>
<a href="#l26.297"></a><span id="l26.297">         logFileCount: null,</span>
<a href="#l26.298"></a><span id="l26.298" class="difflineminus">-        convObj: {}</span>
<a href="#l26.299"></a><span id="l26.299" class="difflineplus">+        convObj: {},</span>
<a href="#l26.300"></a><span id="l26.300">       };</span>
<a href="#l26.301"></a><span id="l26.301">     }</span>
<a href="#l26.302"></a><span id="l26.302"> </span>
<a href="#l26.303"></a><span id="l26.303">     if (!this._knownConversations[convId].scheduledIndex) {</span>
<a href="#l26.304"></a><span id="l26.304">       // Ok, let's schedule the job.</span>
<a href="#l26.305"></a><span id="l26.305">       this._knownConversations[convId].scheduledIndex = setTimeout(</span>
<a href="#l26.306"></a><span id="l26.306">         this._beginIndexingJob.bind(this, aConversation),</span>
<a href="#l26.307"></a><span id="l26.307">         kIndexingDelay);</span>
<a href="#l26.308"></a><span id="l26.308">     }</span>
<a href="#l26.309"></a><span id="l26.309">   },</span>
<a href="#l26.310"></a><span id="l26.310"> </span>
<a href="#l26.311"></a><span id="l26.311" class="difflineminus">-  _beginIndexingJob: function(aConversation) {</span>
<a href="#l26.312"></a><span id="l26.312" class="difflineplus">+  _beginIndexingJob(aConversation) {</span>
<a href="#l26.313"></a><span id="l26.313">     let convId = aConversation.id;</span>
<a href="#l26.314"></a><span id="l26.314"> </span>
<a href="#l26.315"></a><span id="l26.315">     // In the event that we're triggering this indexing job manually, without</span>
<a href="#l26.316"></a><span id="l26.316">     // bothering to schedule it (for example, when a conversation is closed),</span>
<a href="#l26.317"></a><span id="l26.317">     // we give the conversation an entry in _knownConversations, which would</span>
<a href="#l26.318"></a><span id="l26.318">     // normally have been done in _scheduleIndexingJob.</span>
<a href="#l26.319"></a><span id="l26.319">     if (!(convId in this._knownConversations)) {</span>
<a href="#l26.320"></a><span id="l26.320">       this._knownConversations[convId] = {</span>
<a href="#l26.321"></a><span id="l26.321">         id: convId,</span>
<a href="#l26.322"></a><span id="l26.322">         scheduledIndex: null,</span>
<a href="#l26.323"></a><span id="l26.323">         logFileCount: null,</span>
<a href="#l26.324"></a><span id="l26.324" class="difflineminus">-        convObj: {}</span>
<a href="#l26.325"></a><span id="l26.325" class="difflineplus">+        convObj: {},</span>
<a href="#l26.326"></a><span id="l26.326">       };</span>
<a href="#l26.327"></a><span id="l26.327">     }</span>
<a href="#l26.328"></a><span id="l26.328"> </span>
<a href="#l26.329"></a><span id="l26.329">     let conv = this._knownConversations[convId];</span>
<a href="#l26.330"></a><span id="l26.330">     Task.spawn(function* () {</span>
<a href="#l26.331"></a><span id="l26.331">       // We need to get the log files every time, because a new log file might</span>
<a href="#l26.332"></a><span id="l26.332">       // have been started since we last got them.</span>
<a href="#l26.333"></a><span id="l26.333">       let logFiles =</span>
<a href="#l26.334"></a><span id="l26.334" class="difflineat">@@ -505,52 +509,50 @@ var GlodaIMIndexer = {</span>
<a href="#l26.335"></a><span id="l26.335"> </span>
<a href="#l26.336"></a><span id="l26.336">       // We only want to schedule an indexing job if this message is</span>
<a href="#l26.337"></a><span id="l26.337">       // immediately visible to the user. We figure this out by finding</span>
<a href="#l26.338"></a><span id="l26.338">       // the unread message count on the associated UIConversation for this</span>
<a href="#l26.339"></a><span id="l26.339">       // message. If the unread count is 0, we know that the message has been</span>
<a href="#l26.340"></a><span id="l26.340">       // displayed to the user.</span>
<a href="#l26.341"></a><span id="l26.341">       if (uiConv.unreadIncomingMessageCount == 0)</span>
<a href="#l26.342"></a><span id="l26.342">         this._scheduleIndexingJob(conv);</span>
<a href="#l26.343"></a><span id="l26.343" class="difflineminus">-</span>
<a href="#l26.344"></a><span id="l26.344" class="difflineminus">-      return;</span>
<a href="#l26.345"></a><span id="l26.345">     }</span>
<a href="#l26.346"></a><span id="l26.346">   },</span>
<a href="#l26.347"></a><span id="l26.347"> </span>
<a href="#l26.348"></a><span id="l26.348"> </span>
<a href="#l26.349"></a><span id="l26.349">   /* If there is an existing gloda conversation for the given path,</span>
<a href="#l26.350"></a><span id="l26.350">    * find its id.</span>
<a href="#l26.351"></a><span id="l26.351">    */</span>
<a href="#l26.352"></a><span id="l26.352" class="difflineminus">-  _getIdFromPath: function(aPath) {</span>
<a href="#l26.353"></a><span id="l26.353" class="difflineplus">+  _getIdFromPath(aPath) {</span>
<a href="#l26.354"></a><span id="l26.354">     let selectStatement = GlodaDatastore._createAsyncStatement(</span>
<a href="#l26.355"></a><span id="l26.355">       &quot;SELECT id FROM imConversations WHERE path = ?1&quot;);</span>
<a href="#l26.356"></a><span id="l26.356">     selectStatement.bindByIndex(0, aPath);</span>
<a href="#l26.357"></a><span id="l26.357">     let id;</span>
<a href="#l26.358"></a><span id="l26.358">     return new Promise((resolve, reject) =&gt; {</span>
<a href="#l26.359"></a><span id="l26.359">       selectStatement.executeAsync({</span>
<a href="#l26.360"></a><span id="l26.360">         handleResult: aResultSet =&gt; {</span>
<a href="#l26.361"></a><span id="l26.361">           let row = aResultSet.getNextRow();</span>
<a href="#l26.362"></a><span id="l26.362">           if (!row)</span>
<a href="#l26.363"></a><span id="l26.363">             return;</span>
<a href="#l26.364"></a><span id="l26.364">           if (id || aResultSet.getNextRow()) {</span>
<a href="#l26.365"></a><span id="l26.365">             Cu.reportError(&quot;Warning: found more than one gloda conv id for &quot; +</span>
<a href="#l26.366"></a><span id="l26.366" class="difflineminus">-              aPath  + &quot;\n&quot;);</span>
<a href="#l26.367"></a><span id="l26.367" class="difflineplus">+              aPath + &quot;\n&quot;);</span>
<a href="#l26.368"></a><span id="l26.368">           }</span>
<a href="#l26.369"></a><span id="l26.369">           id = id || row.getInt64(0); // We use the first found id.</span>
<a href="#l26.370"></a><span id="l26.370">         },</span>
<a href="#l26.371"></a><span id="l26.371">         handleError: aError =&gt;</span>
<a href="#l26.372"></a><span id="l26.372">           Cu.reportError(&quot;Error finding gloda id from path:\n&quot; + aError),</span>
<a href="#l26.373"></a><span id="l26.373" class="difflineminus">-        handleCompletion: () =&gt; {resolve(id);}</span>
<a href="#l26.374"></a><span id="l26.374" class="difflineplus">+        handleCompletion: () =&gt; { resolve(id); },</span>
<a href="#l26.375"></a><span id="l26.375">       });</span>
<a href="#l26.376"></a><span id="l26.376">     });</span>
<a href="#l26.377"></a><span id="l26.377">   },</span>
<a href="#l26.378"></a><span id="l26.378"> </span>
<a href="#l26.379"></a><span id="l26.379">   // Get the path of a log file relative to the logs directory - the last 4</span>
<a href="#l26.380"></a><span id="l26.380">   // components of the path.</span>
<a href="#l26.381"></a><span id="l26.381" class="difflineminus">-  _getRelativePath: function(aLogPath) {</span>
<a href="#l26.382"></a><span id="l26.382" class="difflineplus">+  _getRelativePath(aLogPath) {</span>
<a href="#l26.383"></a><span id="l26.383">     return OS.Path.split(aLogPath).components.slice(-4).join(&quot;/&quot;);</span>
<a href="#l26.384"></a><span id="l26.384">   },</span>
<a href="#l26.385"></a><span id="l26.385"> </span>
<a href="#l26.386"></a><span id="l26.386">   /* aGlodaConv is an optional inout param that lets the caller save and reuse</span>
<a href="#l26.387"></a><span id="l26.387">    * the GlodaIMConversation instance created when the conversation is indexed</span>
<a href="#l26.388"></a><span id="l26.388">    * the first time. After a conversation is indexed for the first time,</span>
<a href="#l26.389"></a><span id="l26.389">    * the GlodaIMConversation instance has its id property set to the row id of</span>
<a href="#l26.390"></a><span id="l26.390">    * the conversation in the database. This id is required to later update the</span>
<a href="#l26.391"></a><span id="l26.391" class="difflineat">@@ -582,46 +584,45 @@ var GlodaIMIndexer = {</span>
<a href="#l26.392"></a><span id="l26.392">                            let prefix = who ? who + &quot;: &quot; : &quot;&quot;;</span>
<a href="#l26.393"></a><span id="l26.393">                            return prefix + MailFolder.convertMsgSnippetToPlainText(m.message);</span>
<a href="#l26.394"></a><span id="l26.394">                          })</span>
<a href="#l26.395"></a><span id="l26.395">                          .join(&quot;\n\n&quot;);</span>
<a href="#l26.396"></a><span id="l26.396">     let glodaConv;</span>
<a href="#l26.397"></a><span id="l26.397">     if (aGlodaConv &amp;&amp; aGlodaConv.value) {</span>
<a href="#l26.398"></a><span id="l26.398">       glodaConv = aGlodaConv.value;</span>
<a href="#l26.399"></a><span id="l26.399">       glodaConv._content = content;</span>
<a href="#l26.400"></a><span id="l26.400" class="difflineminus">-    }</span>
<a href="#l26.401"></a><span id="l26.401" class="difflineminus">-    else {</span>
<a href="#l26.402"></a><span id="l26.402" class="difflineplus">+    } else {</span>
<a href="#l26.403"></a><span id="l26.403">       let relativePath = this._getRelativePath(aLogPath);</span>
<a href="#l26.404"></a><span id="l26.404">       glodaConv = new GlodaIMConversation(logConv.title, log.time, relativePath, content);</span>
<a href="#l26.405"></a><span id="l26.405">       // If we've indexed this file before, we need the id of the existing</span>
<a href="#l26.406"></a><span id="l26.406">       // gloda conversation so that the existing entry gets updated. This can</span>
<a href="#l26.407"></a><span id="l26.407">       // happen if the log sweep detects that the last messages in an open</span>
<a href="#l26.408"></a><span id="l26.408">       // chat were not in fact indexed before that session was shut down.</span>
<a href="#l26.409"></a><span id="l26.409">       let id = yield this._getIdFromPath(relativePath);</span>
<a href="#l26.410"></a><span id="l26.410">       if (id)</span>
<a href="#l26.411"></a><span id="l26.411">         glodaConv.id = id;</span>
<a href="#l26.412"></a><span id="l26.412">       if (aGlodaConv)</span>
<a href="#l26.413"></a><span id="l26.413">         aGlodaConv.value = glodaConv;</span>
<a href="#l26.414"></a><span id="l26.414">     }</span>
<a href="#l26.415"></a><span id="l26.415"> </span>
<a href="#l26.416"></a><span id="l26.416">     if (!aCache)</span>
<a href="#l26.417"></a><span id="l26.417" class="difflineminus">-      throw(&quot;indexIMConversation called without aCache parameter.&quot;);</span>
<a href="#l26.418"></a><span id="l26.418" class="difflineplus">+      throw &quot;indexIMConversation called without aCache parameter.&quot;;</span>
<a href="#l26.419"></a><span id="l26.419">     let isNew = !Object.prototype.hasOwnProperty.call(aCache, fileName) &amp;&amp; !glodaConv.id;</span>
<a href="#l26.420"></a><span id="l26.420">     let rv = aCallbackHandle.pushAndGo(</span>
<a href="#l26.421"></a><span id="l26.421">       Gloda.grokNounItem(glodaConv, {}, true, isNew, aCallbackHandle));</span>
<a href="#l26.422"></a><span id="l26.422"> </span>
<a href="#l26.423"></a><span id="l26.423">     if (!aLastModifiedTime)</span>
<a href="#l26.424"></a><span id="l26.424">       Cu.reportError(&quot;indexIMConversation called without lastModifiedTime parameter.&quot;);</span>
<a href="#l26.425"></a><span id="l26.425">     aCache[fileName] = aLastModifiedTime || 1;</span>
<a href="#l26.426"></a><span id="l26.426">     this._scheduleCacheSave();</span>
<a href="#l26.427"></a><span id="l26.427"> </span>
<a href="#l26.428"></a><span id="l26.428">     return rv;</span>
<a href="#l26.429"></a><span id="l26.429">   }),</span>
<a href="#l26.430"></a><span id="l26.430"> </span>
<a href="#l26.431"></a><span id="l26.431" class="difflineminus">-  _worker_indexIMConversation: function*(aJob, aCallbackHandle) {</span>
<a href="#l26.432"></a><span id="l26.432" class="difflineplus">+  * _worker_indexIMConversation(aJob, aCallbackHandle) {</span>
<a href="#l26.433"></a><span id="l26.433">     let glodaConv = {};</span>
<a href="#l26.434"></a><span id="l26.434">     let existingGlodaConv = aJob.conversation.glodaConv;</span>
<a href="#l26.435"></a><span id="l26.435">     if (existingGlodaConv &amp;&amp;</span>
<a href="#l26.436"></a><span id="l26.436">         existingGlodaConv.path == this._getRelativePath(aJob.path))</span>
<a href="#l26.437"></a><span id="l26.437">       glodaConv.value = aJob.conversation.glodaConv;</span>
<a href="#l26.438"></a><span id="l26.438"> </span>
<a href="#l26.439"></a><span id="l26.439">     // indexIMConversation may initiate an async grokNounItem sub-job.</span>
<a href="#l26.440"></a><span id="l26.440">     this.indexIMConversation(aCallbackHandle, aJob.path, aJob.lastModifiedTime,</span>
<a href="#l26.441"></a><span id="l26.441" class="difflineat">@@ -635,17 +636,17 @@ var GlodaIMIndexer = {</span>
<a href="#l26.442"></a><span id="l26.442">     this._indexingJobCallbacks.get(aJob.conversation.id)();</span>
<a href="#l26.443"></a><span id="l26.443">     this._indexingJobCallbacks.delete(aJob.conversation.id);</span>
<a href="#l26.444"></a><span id="l26.444">     this._indexingJobPromise = null;</span>
<a href="#l26.445"></a><span id="l26.445">     aJob.conversation.indexPending = false;</span>
<a href="#l26.446"></a><span id="l26.446">     aJob.conversation.glodaConv = glodaConv.value;</span>
<a href="#l26.447"></a><span id="l26.447">     yield Gloda.kWorkDone;</span>
<a href="#l26.448"></a><span id="l26.448">   },</span>
<a href="#l26.449"></a><span id="l26.449"> </span>
<a href="#l26.450"></a><span id="l26.450" class="difflineminus">-  _worker_logsFolderSweep: function*(aJob) {</span>
<a href="#l26.451"></a><span id="l26.451" class="difflineplus">+  * _worker_logsFolderSweep(aJob) {</span>
<a href="#l26.452"></a><span id="l26.452">     let dir = FileUtils.getFile(&quot;ProfD&quot;, [&quot;logs&quot;]);</span>
<a href="#l26.453"></a><span id="l26.453">     if (!dir.exists() || !dir.isDirectory()) {</span>
<a href="#l26.454"></a><span id="l26.454">       // If the folder does not exist, then we are done.</span>
<a href="#l26.455"></a><span id="l26.455">       yield GlodaIndexer.kWorkDone;</span>
<a href="#l26.456"></a><span id="l26.456">     }</span>
<a href="#l26.457"></a><span id="l26.457"> </span>
<a href="#l26.458"></a><span id="l26.458">     // Sweep the logs directory for log files, adding any new entries to the</span>
<a href="#l26.459"></a><span id="l26.459">     // _knownFiles tree as we traverse.</span>
<a href="#l26.460"></a><span id="l26.460" class="difflineat">@@ -681,17 +682,17 @@ var GlodaIMIndexer = {</span>
<a href="#l26.461"></a><span id="l26.461">           GlodaIndexer.indexJob(job);</span>
<a href="#l26.462"></a><span id="l26.462">         }</span>
<a href="#l26.463"></a><span id="l26.463">       }</span>
<a href="#l26.464"></a><span id="l26.464">     }</span>
<a href="#l26.465"></a><span id="l26.465"> </span>
<a href="#l26.466"></a><span id="l26.466">     yield GlodaIndexer.kWorkDone;</span>
<a href="#l26.467"></a><span id="l26.467">   },</span>
<a href="#l26.468"></a><span id="l26.468"> </span>
<a href="#l26.469"></a><span id="l26.469" class="difflineminus">-  _worker_convFolderSweep: function*(aJob, aCallbackHandle) {</span>
<a href="#l26.470"></a><span id="l26.470" class="difflineplus">+  * _worker_convFolderSweep(aJob, aCallbackHandle) {</span>
<a href="#l26.471"></a><span id="l26.471">     let folder = aJob.folder;</span>
<a href="#l26.472"></a><span id="l26.472"> </span>
<a href="#l26.473"></a><span id="l26.473">     let sessions = folder.directoryEntries;</span>
<a href="#l26.474"></a><span id="l26.474">     while (sessions.hasMoreElements()) {</span>
<a href="#l26.475"></a><span id="l26.475">       let file = sessions.getNext().QueryInterface(Ci.nsIFile);</span>
<a href="#l26.476"></a><span id="l26.476">       let fileName = file.leafName;</span>
<a href="#l26.477"></a><span id="l26.477">       if (!file.isFile() || !file.isReadable() || !fileName.endsWith(&quot;.json&quot;) ||</span>
<a href="#l26.478"></a><span id="l26.478">           (Object.prototype.hasOwnProperty.call(aJob.convObj, fileName) &amp;&amp;</span>
<a href="#l26.479"></a><span id="l26.479" class="difflineat">@@ -705,37 +706,31 @@ var GlodaIMIndexer = {</span>
<a href="#l26.480"></a><span id="l26.480">       // until callbackDriver() is called above.</span>
<a href="#l26.481"></a><span id="l26.481">       yield Gloda.kWorkAsync;</span>
<a href="#l26.482"></a><span id="l26.482">     }</span>
<a href="#l26.483"></a><span id="l26.483">     yield Gloda.kWorkDone;</span>
<a href="#l26.484"></a><span id="l26.484">   },</span>
<a href="#l26.485"></a><span id="l26.485"> </span>
<a href="#l26.486"></a><span id="l26.486">   get workers() {</span>
<a href="#l26.487"></a><span id="l26.487">     return [</span>
<a href="#l26.488"></a><span id="l26.488" class="difflineminus">-      [&quot;indexIMConversation&quot;, {</span>
<a href="#l26.489"></a><span id="l26.489" class="difflineminus">-         worker: this._worker_indexIMConversation</span>
<a href="#l26.490"></a><span id="l26.490" class="difflineminus">-       }],</span>
<a href="#l26.491"></a><span id="l26.491" class="difflineminus">-      [&quot;logsFolderSweep&quot;, {</span>
<a href="#l26.492"></a><span id="l26.492" class="difflineminus">-         worker: this._worker_logsFolderSweep</span>
<a href="#l26.493"></a><span id="l26.493" class="difflineminus">-       }],</span>
<a href="#l26.494"></a><span id="l26.494" class="difflineminus">-      [&quot;convFolderSweep&quot;, {</span>
<a href="#l26.495"></a><span id="l26.495" class="difflineminus">-         worker: this._worker_convFolderSweep</span>
<a href="#l26.496"></a><span id="l26.496" class="difflineminus">-       }]</span>
<a href="#l26.497"></a><span id="l26.497" class="difflineplus">+      [&quot;indexIMConversation&quot;, { worker: this._worker_indexIMConversation }],</span>
<a href="#l26.498"></a><span id="l26.498" class="difflineplus">+      [&quot;logsFolderSweep&quot;, { worker: this._worker_logsFolderSweep }],</span>
<a href="#l26.499"></a><span id="l26.499" class="difflineplus">+      [&quot;convFolderSweep&quot;, { worker: this._worker_convFolderSweep }],</span>
<a href="#l26.500"></a><span id="l26.500">     ];</span>
<a href="#l26.501"></a><span id="l26.501">   },</span>
<a href="#l26.502"></a><span id="l26.502"> </span>
<a href="#l26.503"></a><span id="l26.503" class="difflineminus">-  initialSweep: function() {</span>
<a href="#l26.504"></a><span id="l26.504" class="difflineplus">+  initialSweep() {</span>
<a href="#l26.505"></a><span id="l26.505">     let job = new IndexingJob(&quot;logsFolderSweep&quot;, null);</span>
<a href="#l26.506"></a><span id="l26.506">     GlodaIndexer.indexJob(job);</span>
<a href="#l26.507"></a><span id="l26.507">   },</span>
<a href="#l26.508"></a><span id="l26.508"> </span>
<a href="#l26.509"></a><span id="l26.509">   // Due to bug 1069845, some logs were indexed against their full paths instead</span>
<a href="#l26.510"></a><span id="l26.510">   // of their path relative to the logs directory. These entries are updated to</span>
<a href="#l26.511"></a><span id="l26.511">   // use relative paths below.</span>
<a href="#l26.512"></a><span id="l26.512" class="difflineminus">-  fixEntriesWithAbsolutePaths: function() {</span>
<a href="#l26.513"></a><span id="l26.513" class="difflineplus">+  fixEntriesWithAbsolutePaths() {</span>
<a href="#l26.514"></a><span id="l26.514">     let store = GlodaDatastore;</span>
<a href="#l26.515"></a><span id="l26.515">     let selectStatement = store._createAsyncStatement(</span>
<a href="#l26.516"></a><span id="l26.516">       &quot;SELECT id, path FROM imConversations&quot;);</span>
<a href="#l26.517"></a><span id="l26.517">     let updateStatement = store._createAsyncStatement(</span>
<a href="#l26.518"></a><span id="l26.518">       &quot;UPDATE imConversations SET path = ?1 WHERE id = ?2&quot;);</span>
<a href="#l26.519"></a><span id="l26.519"> </span>
<a href="#l26.520"></a><span id="l26.520">     store._beginTransaction();</span>
<a href="#l26.521"></a><span id="l26.521">     selectStatement.executeAsync({</span>
<a href="#l26.522"></a><span id="l26.522" class="difflineat">@@ -752,29 +747,29 @@ var GlodaIMIndexer = {</span>
<a href="#l26.523"></a><span id="l26.523">           if (pathComponents.length &gt; 4) {</span>
<a href="#l26.524"></a><span id="l26.524">             updateStatement.bindByIndex(1, row.getInt64(0)); // id</span>
<a href="#l26.525"></a><span id="l26.525">             updateStatement.bindByIndex(0,</span>
<a href="#l26.526"></a><span id="l26.526">               pathComponents.slice(-4).join(&quot;/&quot;)); // Last 4 path components</span>
<a href="#l26.527"></a><span id="l26.527">             updateStatement.executeAsync({</span>
<a href="#l26.528"></a><span id="l26.528">               handleResult: () =&gt; {},</span>
<a href="#l26.529"></a><span id="l26.529">               handleError: aError =&gt;</span>
<a href="#l26.530"></a><span id="l26.530">                 Cu.reportError(&quot;Error updating bad entry:\n&quot; + aError),</span>
<a href="#l26.531"></a><span id="l26.531" class="difflineminus">-              handleCompletion: () =&gt; {}</span>
<a href="#l26.532"></a><span id="l26.532" class="difflineplus">+              handleCompletion: () =&gt; {},</span>
<a href="#l26.533"></a><span id="l26.533">             });</span>
<a href="#l26.534"></a><span id="l26.534">           }</span>
<a href="#l26.535"></a><span id="l26.535">         }</span>
<a href="#l26.536"></a><span id="l26.536">       },</span>
<a href="#l26.537"></a><span id="l26.537"> </span>
<a href="#l26.538"></a><span id="l26.538">       handleError: aError =&gt;</span>
<a href="#l26.539"></a><span id="l26.539">         Cu.reportError(&quot;Error looking for bad entries:\n&quot; + aError),</span>
<a href="#l26.540"></a><span id="l26.540"> </span>
<a href="#l26.541"></a><span id="l26.541">       handleCompletion: () =&gt; {</span>
<a href="#l26.542"></a><span id="l26.542">         store.runPostCommit(() =&gt; {</span>
<a href="#l26.543"></a><span id="l26.543">           this.cacheVersion = 1;</span>
<a href="#l26.544"></a><span id="l26.544">           this._scheduleCacheSave();</span>
<a href="#l26.545"></a><span id="l26.545">         });</span>
<a href="#l26.546"></a><span id="l26.546">         store._commitTransaction();</span>
<a href="#l26.547"></a><span id="l26.547" class="difflineminus">-      }</span>
<a href="#l26.548"></a><span id="l26.548" class="difflineplus">+      },</span>
<a href="#l26.549"></a><span id="l26.549">     });</span>
<a href="#l26.550"></a><span id="l26.550" class="difflineminus">-  }</span>
<a href="#l26.551"></a><span id="l26.551" class="difflineplus">+  },</span>
<a href="#l26.552"></a><span id="l26.552"> };</span>
<a href="#l26.553"></a><span id="l26.553"> </span>
<a href="#l26.554"></a><span id="l26.554"> GlodaIndexer.registerIndexer(GlodaIMIndexer);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1">rename from mail/components/im/modules/search_im.js</span>
<a href="#l27.2"></a><span id="l27.2">rename to mail/components/im/modules/search_im.jsm</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineminus">--- a/mail/components/im/modules/search_im.js</span>
<a href="#l27.4"></a><span id="l27.4" class="difflineplus">+++ b/mail/components/im/modules/search_im.jsm</span>
<a href="#l27.5"></a><span id="l27.5" class="difflineat">@@ -1,28 +1,28 @@</span>
<a href="#l27.6"></a><span id="l27.6"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l27.7"></a><span id="l27.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l27.8"></a><span id="l27.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l27.9"></a><span id="l27.9"> </span>
<a href="#l27.10"></a><span id="l27.10"> this.EXPORTED_SYMBOLS = [&quot;GlodaIMSearcher&quot;];</span>
<a href="#l27.11"></a><span id="l27.11"> </span>
<a href="#l27.12"></a><span id="l27.12"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/gloda/public.js&quot;);</span>
<a href="#l27.14"></a><span id="l27.14" class="difflineplus">+const { Gloda } = ChromeUtils.import(&quot;resource:///modules/gloda/public.js&quot;, null);</span>
<a href="#l27.15"></a><span id="l27.15"> </span>
<a href="#l27.16"></a><span id="l27.16"> /**</span>
<a href="#l27.17"></a><span id="l27.17">  * How much time boost should a 'score point' amount to?  The authoritative,</span>
<a href="#l27.18"></a><span id="l27.18">  *  incontrivertible answer, across all time and space, is a week.</span>
<a href="#l27.19"></a><span id="l27.19">  *  Note that gloda stores conversation timestamps in seconds.</span>
<a href="#l27.20"></a><span id="l27.20">  */</span>
<a href="#l27.21"></a><span id="l27.21" class="difflineminus">-var FUZZSCORE_TIMESTAMP_FACTOR = 60 * 60 * 24 * 7;</span>
<a href="#l27.22"></a><span id="l27.22" class="difflineplus">+// var FUZZSCORE_TIMESTAMP_FACTOR = 60 * 60 * 24 * 7;</span>
<a href="#l27.23"></a><span id="l27.23"> </span>
<a href="#l27.24"></a><span id="l27.24" class="difflineminus">-var RANK_USAGE =</span>
<a href="#l27.25"></a><span id="l27.25" class="difflineminus">-  &quot;glodaRank(matchinfo(imConversationsText), 1.0, 2.0, 2.0, 1.5, 1.5)&quot;;</span>
<a href="#l27.26"></a><span id="l27.26" class="difflineplus">+// var RANK_USAGE =</span>
<a href="#l27.27"></a><span id="l27.27" class="difflineplus">+//   &quot;glodaRank(matchinfo(imConversationsText), 1.0, 2.0, 2.0, 1.5, 1.5)&quot;;</span>
<a href="#l27.28"></a><span id="l27.28"> </span>
<a href="#l27.29"></a><span id="l27.29" class="difflineminus">-var DASCORE =&quot;imConversations.time&quot;;</span>
<a href="#l27.30"></a><span id="l27.30" class="difflineplus">+var DASCORE = &quot;imConversations.time&quot;;</span>
<a href="#l27.31"></a><span id="l27.31"> //  &quot;(((&quot; + RANK_USAGE + &quot;) * &quot; +</span>
<a href="#l27.32"></a><span id="l27.32"> //    FUZZSCORE_TIMESTAMP_FACTOR +</span>
<a href="#l27.33"></a><span id="l27.33"> //   &quot;) + imConversations.time)&quot;;</span>
<a href="#l27.34"></a><span id="l27.34"> </span>
<a href="#l27.35"></a><span id="l27.35"> /**</span>
<a href="#l27.36"></a><span id="l27.36">  * A new optimization decision we are making is that we do not want to carry</span>
<a href="#l27.37"></a><span id="l27.37">  *  around any data in our ephemeral tables that is not used for whittling the</span>
<a href="#l27.38"></a><span id="l27.38">  *  result set.  The idea is that the btree page cache or OS cache is going to</span>
<a href="#l27.39"></a><span id="l27.39" class="difflineat">@@ -83,18 +83,17 @@ var NUEVO_FULLTEXT_SQL =</span>
<a href="#l27.40"></a><span id="l27.40"> </span>
<a href="#l27.41"></a><span id="l27.41"> function identityFunc(x) {</span>
<a href="#l27.42"></a><span id="l27.42">   return x;</span>
<a href="#l27.43"></a><span id="l27.43"> }</span>
<a href="#l27.44"></a><span id="l27.44"> </span>
<a href="#l27.45"></a><span id="l27.45"> function oneLessMaxZero(x) {</span>
<a href="#l27.46"></a><span id="l27.46">   if (x &lt;= 1)</span>
<a href="#l27.47"></a><span id="l27.47">     return 0;</span>
<a href="#l27.48"></a><span id="l27.48" class="difflineminus">-  else</span>
<a href="#l27.49"></a><span id="l27.49" class="difflineminus">-    return x - 1;</span>
<a href="#l27.50"></a><span id="l27.50" class="difflineplus">+  return x - 1;</span>
<a href="#l27.51"></a><span id="l27.51"> }</span>
<a href="#l27.52"></a><span id="l27.52"> </span>
<a href="#l27.53"></a><span id="l27.53"> function reduceSum(accum, curValue) {</span>
<a href="#l27.54"></a><span id="l27.54">   return accum + curValue;</span>
<a href="#l27.55"></a><span id="l27.55"> }</span>
<a href="#l27.56"></a><span id="l27.56"> </span>
<a href="#l27.57"></a><span id="l27.57"> /*</span>
<a href="#l27.58"></a><span id="l27.58">  * Columns are: body, subject, attachment names, author, recipients</span>
<a href="#l27.59"></a><span id="l27.59" class="difflineat">@@ -141,19 +140,19 @@ function scoreOffsets(aMessage, aContext</span>
<a href="#l27.60"></a><span id="l27.60">                              termTemplate.concat(),</span>
<a href="#l27.61"></a><span id="l27.61">                              termTemplate.concat(),</span>
<a href="#l27.62"></a><span id="l27.62">                              termTemplate.concat()];</span>
<a href="#l27.63"></a><span id="l27.63"> </span>
<a href="#l27.64"></a><span id="l27.64">   // we need a friendlyParseInt because otherwise the radix stuff happens</span>
<a href="#l27.65"></a><span id="l27.65">   //  because of the extra arguments map parses.  curse you, map!</span>
<a href="#l27.66"></a><span id="l27.66">   let offsetNums =</span>
<a href="#l27.67"></a><span id="l27.67">     aContext.stashedColumns[aMessage.id][0].split(&quot; &quot;).map(x =&gt; parseInt(x));</span>
<a href="#l27.68"></a><span id="l27.68" class="difflineminus">-  for (let i=0; i &lt; offsetNums.length; i += 4) {</span>
<a href="#l27.69"></a><span id="l27.69" class="difflineplus">+  for (let i = 0; i &lt; offsetNums.length; i += 4) {</span>
<a href="#l27.70"></a><span id="l27.70">     let columnIndex = offsetNums[i];</span>
<a href="#l27.71"></a><span id="l27.71" class="difflineminus">-    let termIndex = offsetNums[i+1];</span>
<a href="#l27.72"></a><span id="l27.72" class="difflineplus">+    let termIndex = offsetNums[i + 1];</span>
<a href="#l27.73"></a><span id="l27.73">     columnTermIncidence[columnIndex][termIndex]++;</span>
<a href="#l27.74"></a><span id="l27.74">   }</span>
<a href="#l27.75"></a><span id="l27.75"> </span>
<a href="#l27.76"></a><span id="l27.76">   for (let iColumn = 0; iColumn &lt; COLUMN_ALL_MATCH_SCORES.length; iColumn++) {</span>
<a href="#l27.77"></a><span id="l27.77">     let termIncidence = columnTermIncidence[iColumn];</span>
<a href="#l27.78"></a><span id="l27.78">     // bestow all match credit</span>
<a href="#l27.79"></a><span id="l27.79">     if (termIncidence.every(identityFunc))</span>
<a href="#l27.80"></a><span id="l27.80">       score += COLUMN_ALL_MATCH_SCORES[iColumn];</span>
<a href="#l27.81"></a><span id="l27.81" class="difflineat">@@ -236,30 +235,30 @@ GlodaIMSearcher.prototype = {</span>
<a href="#l27.82"></a><span id="l27.82"> </span>
<a href="#l27.83"></a><span id="l27.83">       let spaceIndex = aSearchString.indexOf(&quot; &quot;);</span>
<a href="#l27.84"></a><span id="l27.84">       if (spaceIndex == -1) {</span>
<a href="#l27.85"></a><span id="l27.85">         addTerm(aSearchString);</span>
<a href="#l27.86"></a><span id="l27.86">         break;</span>
<a href="#l27.87"></a><span id="l27.87">       }</span>
<a href="#l27.88"></a><span id="l27.88"> </span>
<a href="#l27.89"></a><span id="l27.89">       addTerm(aSearchString.substring(0, spaceIndex));</span>
<a href="#l27.90"></a><span id="l27.90" class="difflineminus">-      aSearchString = aSearchString.substring(spaceIndex+1);</span>
<a href="#l27.91"></a><span id="l27.91" class="difflineplus">+      aSearchString = aSearchString.substring(spaceIndex + 1);</span>
<a href="#l27.92"></a><span id="l27.92">     }</span>
<a href="#l27.93"></a><span id="l27.93"> </span>
<a href="#l27.94"></a><span id="l27.94">     return terms;</span>
<a href="#l27.95"></a><span id="l27.95">   },</span>
<a href="#l27.96"></a><span id="l27.96"> </span>
<a href="#l27.97"></a><span id="l27.97">   buildFulltextQuery: function GlodaIMSearcher_buildFulltextQuery() {</span>
<a href="#l27.98"></a><span id="l27.98">     let query = Gloda.newQuery(Gloda.lookupNoun(&quot;im-conversation&quot;), {</span>
<a href="#l27.99"></a><span id="l27.99">       noMagic: true,</span>
<a href="#l27.100"></a><span id="l27.100">       explicitSQL: NUEVO_FULLTEXT_SQL,</span>
<a href="#l27.101"></a><span id="l27.101">       limitClauseAlreadyIncluded: true,</span>
<a href="#l27.102"></a><span id="l27.102">       // osets is 0-based column number 4 (volatile to column changes)</span>
<a href="#l27.103"></a><span id="l27.103">       // save the offset column for extra analysis</span>
<a href="#l27.104"></a><span id="l27.104" class="difflineminus">-      stashColumns: [6]</span>
<a href="#l27.105"></a><span id="l27.105" class="difflineplus">+      stashColumns: [6],</span>
<a href="#l27.106"></a><span id="l27.106">     });</span>
<a href="#l27.107"></a><span id="l27.107"> </span>
<a href="#l27.108"></a><span id="l27.108">     let fulltextQueryString = &quot;&quot;;</span>
<a href="#l27.109"></a><span id="l27.109"> </span>
<a href="#l27.110"></a><span id="l27.110">     for (let [iTerm, term] of this.fulltextTerms.entries()) {</span>
<a href="#l27.111"></a><span id="l27.111">       if (iTerm)</span>
<a href="#l27.112"></a><span id="l27.112">         fulltextQueryString += this.andTerms ? &quot; &quot; : &quot; OR &quot;;</span>
<a href="#l27.113"></a><span id="l27.113"> </span>
<a href="#l27.114"></a><span id="l27.114" class="difflineat">@@ -296,24 +295,24 @@ GlodaIMSearcher.prototype = {</span>
<a href="#l27.115"></a><span id="l27.115"> </span>
<a href="#l27.116"></a><span id="l27.116">     this.query = this.buildFulltextQuery();</span>
<a href="#l27.117"></a><span id="l27.117">     this.collection = this.query.getCollection(this, aData);</span>
<a href="#l27.118"></a><span id="l27.118">     this.completed = false;</span>
<a href="#l27.119"></a><span id="l27.119"> </span>
<a href="#l27.120"></a><span id="l27.120">     return this.collection;</span>
<a href="#l27.121"></a><span id="l27.121">   },</span>
<a href="#l27.122"></a><span id="l27.122"> </span>
<a href="#l27.123"></a><span id="l27.123" class="difflineminus">-  sortBy: '-dascore',</span>
<a href="#l27.124"></a><span id="l27.124" class="difflineplus">+  sortBy: &quot;-dascore&quot;,</span>
<a href="#l27.125"></a><span id="l27.125"> </span>
<a href="#l27.126"></a><span id="l27.126">   onItemsAdded: function GlodaIMSearcher_onItemsAdded(aItems, aCollection) {</span>
<a href="#l27.127"></a><span id="l27.127">     let newScores = Gloda.scoreNounItems(</span>
<a href="#l27.128"></a><span id="l27.128">       aItems,</span>
<a href="#l27.129"></a><span id="l27.129">       {</span>
<a href="#l27.130"></a><span id="l27.130">         terms: this.fulltextTerms,</span>
<a href="#l27.131"></a><span id="l27.131" class="difflineminus">-        stashedColumns: aCollection.stashedColumns</span>
<a href="#l27.132"></a><span id="l27.132" class="difflineplus">+        stashedColumns: aCollection.stashedColumns,</span>
<a href="#l27.133"></a><span id="l27.133">       },</span>
<a href="#l27.134"></a><span id="l27.134">       [scoreOffsets]);</span>
<a href="#l27.135"></a><span id="l27.135">     if (this.scores)</span>
<a href="#l27.136"></a><span id="l27.136">       this.scores = this.scores.concat(newScores);</span>
<a href="#l27.137"></a><span id="l27.137">     else</span>
<a href="#l27.138"></a><span id="l27.138">       this.scores = newScores;</span>
<a href="#l27.139"></a><span id="l27.139"> </span>
<a href="#l27.140"></a><span id="l27.140">     if (this.listener)</span>
<a href="#l27.141"></a><span id="l27.141" class="difflineat">@@ -328,10 +327,10 @@ GlodaIMSearcher.prototype = {</span>
<a href="#l27.142"></a><span id="l27.142">                                                           aCollection) {</span>
<a href="#l27.143"></a><span id="l27.143">     if (this.listener)</span>
<a href="#l27.144"></a><span id="l27.144">       this.listener.onItemsRemoved(aItems, aCollection);</span>
<a href="#l27.145"></a><span id="l27.145">   },</span>
<a href="#l27.146"></a><span id="l27.146">   onQueryCompleted: function GlodaIMSearcher_onQueryCompleted(aCollection) {</span>
<a href="#l27.147"></a><span id="l27.147">     this.completed = true;</span>
<a href="#l27.148"></a><span id="l27.148">     if (this.listener)</span>
<a href="#l27.149"></a><span id="l27.149">       this.listener.onQueryCompleted(aCollection);</span>
<a href="#l27.150"></a><span id="l27.150" class="difflineminus">-  }</span>
<a href="#l27.151"></a><span id="l27.151" class="difflineplus">+  },</span>
<a href="#l27.152"></a><span id="l27.152"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/mail/components/im/moz.build</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/mail/components/im/moz.build</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -7,18 +7,18 @@ EXTRA_COMPONENTS += [</span>
<a href="#l28.4"></a><span id="l28.4">     'im.manifest',</span>
<a href="#l28.5"></a><span id="l28.5">     'imIncomingServer.js',</span>
<a href="#l28.6"></a><span id="l28.6">     'imProtocolInfo.js',</span>
<a href="#l28.7"></a><span id="l28.7"> ]</span>
<a href="#l28.8"></a><span id="l28.8"> </span>
<a href="#l28.9"></a><span id="l28.9"> EXTRA_JS_MODULES += [</span>
<a href="#l28.10"></a><span id="l28.10">     'modules/chatHandler.jsm',</span>
<a href="#l28.11"></a><span id="l28.11">     'modules/chatNotifications.jsm',</span>
<a href="#l28.12"></a><span id="l28.12" class="difflineminus">-    'modules/index_im.js',</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineminus">-    'modules/search_im.js',</span>
<a href="#l28.14"></a><span id="l28.14" class="difflineplus">+    'modules/index_im.jsm',</span>
<a href="#l28.15"></a><span id="l28.15" class="difflineplus">+    'modules/search_im.jsm',</span>
<a href="#l28.16"></a><span id="l28.16"> ]</span>
<a href="#l28.17"></a><span id="l28.17"> </span>
<a href="#l28.18"></a><span id="l28.18"> JAR_MANIFESTS += ['jar.mn']</span>
<a href="#l28.19"></a><span id="l28.19"> </span>
<a href="#l28.20"></a><span id="l28.20"> JS_PREFERENCE_FILES += [</span>
<a href="#l28.21"></a><span id="l28.21">     'all-im.js',</span>
<a href="#l28.22"></a><span id="l28.22"> ]</span>
<a href="#l28.23"></a><span id="l28.23"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1">rename from mail/components/im/smileys/theme.js</span>
<a href="#l29.2"></a><span id="l29.2">rename to mail/components/im/smileys/theme.json</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:32Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

