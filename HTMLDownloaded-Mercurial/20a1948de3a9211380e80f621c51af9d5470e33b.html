<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 7675:20a1948de3a9211380e80f621c51af9d5470e33b</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 20a1948de3a9211380e80f621c51af9d5470e33b" />
<meta property="og:url" content="/comm-central/rev/20a1948de3a9211380e80f621c51af9d5470e33b" />
<meta property="og:description" content="First patch for bug 646226 (sent messages not indexed anymore with IMAP) r=asuth" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 20a1948de3a9211380e80f621c51af9d5470e33b 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/20a1948de3a9211380e80f621c51af9d5470e33b">shortlog</a> |
<a href="/comm-central/log/20a1948de3a9211380e80f621c51af9d5470e33b">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/20a1948de3a9211380e80f621c51af9d5470e33b">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/20a1948de3a9211380e80f621c51af9d5470e33b">files</a> |
changeset |
<a href="/comm-central/raw-rev/20a1948de3a9211380e80f621c51af9d5470e33b">raw</a>  | <a href="/comm-central/archive/20a1948de3a9211380e80f621c51af9d5470e33b.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
First patch for <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=646226">bug 646226</a> (sent messages not indexed anymore with IMAP) r=asuth
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#74;&#111;&#110;&#97;&#116;&#104;&#97;&#110;&#32;&#80;&#114;&#111;&#116;&#122;&#101;&#110;&#107;&#111;&#32;&#60;&#106;&#111;&#110;&#97;&#116;&#104;&#97;&#110;&#46;&#112;&#114;&#111;&#116;&#122;&#101;&#110;&#107;&#111;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Tue, 03 May 2011 10:25:39 +0200</td></tr>

<tr>
 <td>changeset 7675</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/20a1948de3a9211380e80f621c51af9d5470e33b">20a1948de3a9211380e80f621c51af9d5470e33b</a></td>
</tr>



<tr>
<td>parent 7674</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/8ecd228f3bd80d5f7ed0235187f4b61c269cc2a6">8ecd228f3bd80d5f7ed0235187f4b61c269cc2a6</a>
</td>
</tr>

<tr>
<td>child 7676</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/bdd02cca51f547456eaafb000bfbd70859936f81">bdd02cca51f547456eaafb000bfbd70859936f81</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=20a1948de3a9211380e80f621c51af9d5470e33b">5890</a></td></tr>
<tr><td>push user</td><td>jonathan.protzenko@gmail.com</td></tr>
<tr><td>push date</td><td class="date age">Tue, 03 May 2011 08:26:45 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@20a1948de3a9 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=20a1948de3a9211380e80f621c51af9d5470e33b">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=20a1948de3a9211380e80f621c51af9d5470e33b&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=20a1948de3a9211380e80f621c51af9d5470e33b&newProject=comm-central&newRevision=20a1948de3a9211380e80f621c51af9d5470e33b&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=20a1948de3a9211380e80f621c51af9d5470e33b&newProject=comm-central&newRevision=20a1948de3a9211380e80f621c51af9d5470e33b&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=20a1948de3a9211380e80f621c51af9d5470e33b&newProject=comm-central&newRevision=20a1948de3a9211380e80f621c51af9d5470e33b&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28asuth%29&revcount=50">asuth</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=646226">646226</a></td></tr>




</table></div>

<div class="page_body description">First patch for <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=646226">bug 646226</a> (sent messages not indexed anymore with IMAP) r=asuth

David Bienvenu's recent patches introduced fake sent headers for IMAP, i.e.
headers that are added because we sent the message, and that are bound to be
replaced with the real IMAP header as soon as we figure that one out from the
remote IMAP server. Gloda needed a few tweaks to properly recognize and index
these fake headers.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/20a1948de3a9211380e80f621c51af9d5470e33b/mailnews/db/gloda/modules/index_msg.js">mailnews/db/gloda/modules/index_msg.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/20a1948de3a9211380e80f621c51af9d5470e33b/mailnews/db/gloda/modules/index_msg.js">file</a> |
<a href="/comm-central/annotate/20a1948de3a9211380e80f621c51af9d5470e33b/mailnews/db/gloda/modules/index_msg.js">annotate</a> |
<a href="/comm-central/diff/20a1948de3a9211380e80f621c51af9d5470e33b/mailnews/db/gloda/modules/index_msg.js">diff</a> |
<a href="/comm-central/comparison/20a1948de3a9211380e80f621c51af9d5470e33b/mailnews/db/gloda/modules/index_msg.js">comparison</a> |
<a href="/comm-central/log/20a1948de3a9211380e80f621c51af9d5470e33b/mailnews/db/gloda/modules/index_msg.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/db/gloda/modules/index_msg.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/index_msg.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -2403,16 +2403,20 @@ var GlodaMsgIndexer = {</span>
<a href="#l1.4"></a><span id="l1.4">      *  should already have been classified) and so can fast-path them.</span>
<a href="#l1.5"></a><span id="l1.5">      */</span>
<a href="#l1.6"></a><span id="l1.6">     msgKeyChanged: function gloda_indexer_msgKeyChangeded(aOldMsgKey,</span>
<a href="#l1.7"></a><span id="l1.7">                              aNewMsgHdr) {</span>
<a href="#l1.8"></a><span id="l1.8">       try {</span>
<a href="#l1.9"></a><span id="l1.9">         let val = null, newKey = aNewMsgHdr.messageKey;</span>
<a href="#l1.10"></a><span id="l1.10">         let [glodaId, glodaDirty] =</span>
<a href="#l1.11"></a><span id="l1.11">           PendingCommitTracker.getGlodaState(aNewMsgHdr);</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+        // If we haven't indexed this message yet, take no action, and leave it</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+        // up to msgsClassified to take proper action.</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+        if (glodaId &lt; GLODA_FIRST_VALID_MESSAGE_ID)</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+          return;</span>
<a href="#l1.16"></a><span id="l1.16">         // take no action on filthy messages,</span>
<a href="#l1.17"></a><span id="l1.17">         // generate an entry if dirty or the keys don't match.</span>
<a href="#l1.18"></a><span id="l1.18">         if ((glodaDirty !== GlodaMsgIndexer.kMessageFilthy) &amp;&amp;</span>
<a href="#l1.19"></a><span id="l1.19">             ((glodaDirty === GlodaMsgIndexer.kMessageDirty) ||</span>
<a href="#l1.20"></a><span id="l1.20">              (aOldMsgKey !== newKey))) {</span>
<a href="#l1.21"></a><span id="l1.21">           val = {</span>
<a href="#l1.22"></a><span id="l1.22">             id: glodaId,</span>
<a href="#l1.23"></a><span id="l1.23">             key: (aOldMsgKey !== newKey) ? newKey : null,</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

