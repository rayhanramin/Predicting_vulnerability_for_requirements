<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 839:81ffe51a097d5c27bf6f37be1a5e970bf7ca0bb1</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 81ffe51a097d5c27bf6f37be1a5e970bf7ca0bb1" />
<meta property="og:url" content="/comm-central/rev/81ffe51a097d5c27bf6f37be1a5e970bf7ca0bb1" />
<meta property="og:description" content="status commit: localization, documentation, API change for attribute" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 81ffe51a097d5c27bf6f37be1a5e970bf7ca0bb1 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/81ffe51a097d5c27bf6f37be1a5e970bf7ca0bb1">shortlog</a> |
<a href="/comm-central/log/81ffe51a097d5c27bf6f37be1a5e970bf7ca0bb1">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/81ffe51a097d5c27bf6f37be1a5e970bf7ca0bb1">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/81ffe51a097d5c27bf6f37be1a5e970bf7ca0bb1">files</a> |
changeset |
<a href="/comm-central/raw-rev/81ffe51a097d5c27bf6f37be1a5e970bf7ca0bb1">raw</a>  | <a href="/comm-central/archive/81ffe51a097d5c27bf6f37be1a5e970bf7ca0bb1.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
status commit: localization, documentation, API change for attribute
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#65;&#110;&#100;&#114;&#101;&#119;&#32;&#83;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#32;&#60;&#97;&#115;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#64;&#97;&#115;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#46;&#111;&#114;&#103;&#62;</td></tr>
<tr><td></td><td class="date age">Sat, 12 Jul 2008 16:18:48 -0700</td></tr>

<tr>
 <td>changeset 839</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/81ffe51a097d5c27bf6f37be1a5e970bf7ca0bb1">81ffe51a097d5c27bf6f37be1a5e970bf7ca0bb1</a></td>
</tr>



<tr>
<td>parent 838</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/512b57925e95027a669716b14cacbde4266cd85b">512b57925e95027a669716b14cacbde4266cd85b</a>
</td>
</tr>

<tr>
<td>child 840</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/fbf0137bde248eb9e058f55d4f77ae54e0aa33f0">fbf0137bde248eb9e058f55d4f77ae54e0aa33f0</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=81ffe51a097d5c27bf6f37be1a5e970bf7ca0bb1">743</a></td></tr>
<tr><td>push user</td><td>dmosedale@mozilla.com</td></tr>
<tr><td>push date</td><td class="date age">Tue, 04 Nov 2008 20:01:44 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@a79b923a9cba [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=a79b923a9cba395cb3911b27c9599ffb8c997caf">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=a79b923a9cba395cb3911b27c9599ffb8c997caf&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a79b923a9cba395cb3911b27c9599ffb8c997caf&newProject=comm-central&newRevision=d32b4cc6f46d1195ae66fd0cf8395c60b9259ca6&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a79b923a9cba395cb3911b27c9599ffb8c997caf&newProject=comm-central&newRevision=d32b4cc6f46d1195ae66fd0cf8395c60b9259ca6&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a79b923a9cba395cb3911b27c9599ffb8c997caf&newProject=comm-central&newRevision=d32b4cc6f46d1195ae66fd0cf8395c60b9259ca6&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>






</table></div>

<div class="page_body description">status commit: localization, documentation, API change for attribute
definition, very in-progress continuous indexing efforts, other.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/81ffe51a097d5c27bf6f37be1a5e970bf7ca0bb1/content/overlay.js">content/overlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/81ffe51a097d5c27bf6f37be1a5e970bf7ca0bb1/content/overlay.js">file</a> |
<a href="/comm-central/annotate/81ffe51a097d5c27bf6f37be1a5e970bf7ca0bb1/content/overlay.js">annotate</a> |
<a href="/comm-central/diff/81ffe51a097d5c27bf6f37be1a5e970bf7ca0bb1/content/overlay.js">diff</a> |
<a href="/comm-central/comparison/81ffe51a097d5c27bf6f37be1a5e970bf7ca0bb1/content/overlay.js">comparison</a> |
<a href="/comm-central/log/81ffe51a097d5c27bf6f37be1a5e970bf7ca0bb1/content/overlay.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/81ffe51a097d5c27bf6f37be1a5e970bf7ca0bb1/locale/en-US/gloda.properties">locale/en-US/gloda.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/81ffe51a097d5c27bf6f37be1a5e970bf7ca0bb1/locale/en-US/gloda.properties">file</a> |
<a href="/comm-central/annotate/81ffe51a097d5c27bf6f37be1a5e970bf7ca0bb1/locale/en-US/gloda.properties">annotate</a> |
<a href="/comm-central/diff/81ffe51a097d5c27bf6f37be1a5e970bf7ca0bb1/locale/en-US/gloda.properties">diff</a> |
<a href="/comm-central/comparison/81ffe51a097d5c27bf6f37be1a5e970bf7ca0bb1/locale/en-US/gloda.properties">comparison</a> |
<a href="/comm-central/log/81ffe51a097d5c27bf6f37be1a5e970bf7ca0bb1/locale/en-US/gloda.properties">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/81ffe51a097d5c27bf6f37be1a5e970bf7ca0bb1/locale/en-US/prefwindow.dtd">locale/en-US/prefwindow.dtd</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/81ffe51a097d5c27bf6f37be1a5e970bf7ca0bb1/locale/en-US/prefwindow.dtd">file</a> |
<a href="/comm-central/annotate/81ffe51a097d5c27bf6f37be1a5e970bf7ca0bb1/locale/en-US/prefwindow.dtd">annotate</a> |
<a href="/comm-central/diff/81ffe51a097d5c27bf6f37be1a5e970bf7ca0bb1/locale/en-US/prefwindow.dtd">diff</a> |
<a href="/comm-central/comparison/81ffe51a097d5c27bf6f37be1a5e970bf7ca0bb1/locale/en-US/prefwindow.dtd">comparison</a> |
<a href="/comm-central/log/81ffe51a097d5c27bf6f37be1a5e970bf7ca0bb1/locale/en-US/prefwindow.dtd">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/81ffe51a097d5c27bf6f37be1a5e970bf7ca0bb1/modules/datamodel.js">modules/datamodel.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/81ffe51a097d5c27bf6f37be1a5e970bf7ca0bb1/modules/datamodel.js">file</a> |
<a href="/comm-central/annotate/81ffe51a097d5c27bf6f37be1a5e970bf7ca0bb1/modules/datamodel.js">annotate</a> |
<a href="/comm-central/diff/81ffe51a097d5c27bf6f37be1a5e970bf7ca0bb1/modules/datamodel.js">diff</a> |
<a href="/comm-central/comparison/81ffe51a097d5c27bf6f37be1a5e970bf7ca0bb1/modules/datamodel.js">comparison</a> |
<a href="/comm-central/log/81ffe51a097d5c27bf6f37be1a5e970bf7ca0bb1/modules/datamodel.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/81ffe51a097d5c27bf6f37be1a5e970bf7ca0bb1/modules/datastore.js">modules/datastore.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/81ffe51a097d5c27bf6f37be1a5e970bf7ca0bb1/modules/datastore.js">file</a> |
<a href="/comm-central/annotate/81ffe51a097d5c27bf6f37be1a5e970bf7ca0bb1/modules/datastore.js">annotate</a> |
<a href="/comm-central/diff/81ffe51a097d5c27bf6f37be1a5e970bf7ca0bb1/modules/datastore.js">diff</a> |
<a href="/comm-central/comparison/81ffe51a097d5c27bf6f37be1a5e970bf7ca0bb1/modules/datastore.js">comparison</a> |
<a href="/comm-central/log/81ffe51a097d5c27bf6f37be1a5e970bf7ca0bb1/modules/datastore.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/81ffe51a097d5c27bf6f37be1a5e970bf7ca0bb1/modules/explattr.js">modules/explattr.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/81ffe51a097d5c27bf6f37be1a5e970bf7ca0bb1/modules/explattr.js">file</a> |
<a href="/comm-central/annotate/81ffe51a097d5c27bf6f37be1a5e970bf7ca0bb1/modules/explattr.js">annotate</a> |
<a href="/comm-central/diff/81ffe51a097d5c27bf6f37be1a5e970bf7ca0bb1/modules/explattr.js">diff</a> |
<a href="/comm-central/comparison/81ffe51a097d5c27bf6f37be1a5e970bf7ca0bb1/modules/explattr.js">comparison</a> |
<a href="/comm-central/log/81ffe51a097d5c27bf6f37be1a5e970bf7ca0bb1/modules/explattr.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/81ffe51a097d5c27bf6f37be1a5e970bf7ca0bb1/modules/fundattr.js">modules/fundattr.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/81ffe51a097d5c27bf6f37be1a5e970bf7ca0bb1/modules/fundattr.js">file</a> |
<a href="/comm-central/annotate/81ffe51a097d5c27bf6f37be1a5e970bf7ca0bb1/modules/fundattr.js">annotate</a> |
<a href="/comm-central/diff/81ffe51a097d5c27bf6f37be1a5e970bf7ca0bb1/modules/fundattr.js">diff</a> |
<a href="/comm-central/comparison/81ffe51a097d5c27bf6f37be1a5e970bf7ca0bb1/modules/fundattr.js">comparison</a> |
<a href="/comm-central/log/81ffe51a097d5c27bf6f37be1a5e970bf7ca0bb1/modules/fundattr.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/81ffe51a097d5c27bf6f37be1a5e970bf7ca0bb1/modules/gloda.js">modules/gloda.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/81ffe51a097d5c27bf6f37be1a5e970bf7ca0bb1/modules/gloda.js">file</a> |
<a href="/comm-central/annotate/81ffe51a097d5c27bf6f37be1a5e970bf7ca0bb1/modules/gloda.js">annotate</a> |
<a href="/comm-central/diff/81ffe51a097d5c27bf6f37be1a5e970bf7ca0bb1/modules/gloda.js">diff</a> |
<a href="/comm-central/comparison/81ffe51a097d5c27bf6f37be1a5e970bf7ca0bb1/modules/gloda.js">comparison</a> |
<a href="/comm-central/log/81ffe51a097d5c27bf6f37be1a5e970bf7ca0bb1/modules/gloda.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/81ffe51a097d5c27bf6f37be1a5e970bf7ca0bb1/modules/indexer.js">modules/indexer.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/81ffe51a097d5c27bf6f37be1a5e970bf7ca0bb1/modules/indexer.js">file</a> |
<a href="/comm-central/annotate/81ffe51a097d5c27bf6f37be1a5e970bf7ca0bb1/modules/indexer.js">annotate</a> |
<a href="/comm-central/diff/81ffe51a097d5c27bf6f37be1a5e970bf7ca0bb1/modules/indexer.js">diff</a> |
<a href="/comm-central/comparison/81ffe51a097d5c27bf6f37be1a5e970bf7ca0bb1/modules/indexer.js">comparison</a> |
<a href="/comm-central/log/81ffe51a097d5c27bf6f37be1a5e970bf7ca0bb1/modules/indexer.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/content/overlay.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/content/overlay.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -31,30 +31,27 @@</span>
<a href="#l1.4"></a><span id="l1.4">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l1.5"></a><span id="l1.5">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l1.6"></a><span id="l1.6">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l1.7"></a><span id="l1.7">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l1.8"></a><span id="l1.8">  * </span>
<a href="#l1.9"></a><span id="l1.9">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l1.10"></a><span id="l1.10"> </span>
<a href="#l1.11"></a><span id="l1.11"> // get the core</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-dump(&quot;pre-gloda\n&quot;);</span>
<a href="#l1.13"></a><span id="l1.13"> Components.utils.import(&quot;resource://gloda/modules/gloda.js&quot;);</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-dump(&quot;post-gloda\n&quot;);</span>
<a href="#l1.15"></a><span id="l1.15"> // make all the built-in plugins join the party</span>
<a href="#l1.16"></a><span id="l1.16"> Components.utils.import(&quot;resource://gloda/modules/everybody.js&quot;);</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineminus">-dump(&quot;post-everybody\n&quot;);</span>
<a href="#l1.18"></a><span id="l1.18"> </span>
<a href="#l1.19"></a><span id="l1.19"> Components.utils.import(&quot;resource://gloda/modules/indexer.js&quot;);</span>
<a href="#l1.20"></a><span id="l1.20"> </span>
<a href="#l1.21"></a><span id="l1.21"> var gloda = {</span>
<a href="#l1.22"></a><span id="l1.22">   onLoad: function() {</span>
<a href="#l1.23"></a><span id="l1.23">     // initialization code</span>
<a href="#l1.24"></a><span id="l1.24">     this.initialized = true;</span>
<a href="#l1.25"></a><span id="l1.25">     this.strings = document.getElementById(&quot;gloda-strings&quot;);</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineplus">+    GlodaIndexer.init(window, msgWindow, this.strings);</span>
<a href="#l1.27"></a><span id="l1.27">   },</span>
<a href="#l1.28"></a><span id="l1.28">   onMenuItemCommand: function(e) {</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineminus">-    GlodaIndexer.init(window, msgWindow);</span>
<a href="#l1.30"></a><span id="l1.30">     GlodaIndexer.indexEverything();</span>
<a href="#l1.31"></a><span id="l1.31">   },</span>
<a href="#l1.32"></a><span id="l1.32"> </span>
<a href="#l1.33"></a><span id="l1.33"> };</span>
<a href="#l1.34"></a><span id="l1.34"> window.addEventListener(&quot;load&quot;, function(e) { gloda.onLoad(e); }, false);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/locale/en-US/gloda.properties</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/locale/en-US/gloda.properties</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -1,4 +1,10 @@</span>
<a href="#l2.4"></a><span id="l2.4" class="difflineminus">-helloMessage=Hello World!</span>
<a href="#l2.5"></a><span id="l2.5" class="difflineminus">-helloMessageTitle=Hello</span>
<a href="#l2.6"></a><span id="l2.6"> prefMessage=Int Pref Value: %d</span>
<a href="#l2.7"></a><span id="l2.7"> extensions.gloda.description=Adds a global database to Thunderbird</span>
<a href="#l2.8"></a><span id="l2.8" class="difflineplus">+shutdownTaskName=Global Database Indexer</span>
<a href="#l2.9"></a><span id="l2.9" class="difflineplus">+attrFromExplanation=%{subject} was sent by %{object}</span>
<a href="#l2.10"></a><span id="l2.10" class="difflineplus">+attrToExplanation=%{subject} was sent to %{object}</span>
<a href="#l2.11"></a><span id="l2.11" class="difflineplus">+attrCcExplanation=%{subject} was carbon-copied to %{object}</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+attrDateExplanation=%{subject} was sent on %{object}</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+attrTagExplanation=%{subject} was tagged %{parameter} on %{object}</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+attrStarExplanation=%{subject} has a star state of %{object}</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+attrReadExplanation=%{subject} has a read state of %{object}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/locale/en-US/prefwindow.dtd</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/locale/en-US/prefwindow.dtd</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -1,8 +1,8 @@</span>
<a href="#l3.4"></a><span id="l3.4" class="difflineminus">-&lt;!ENTITY prefwindow.title &quot;Global Database preferences&quot;&gt;</span>
<a href="#l3.5"></a><span id="l3.5" class="difflineminus">-&lt;!ENTITY pane1.title &quot;Global Database preferences&quot;&gt;</span>
<a href="#l3.6"></a><span id="l3.6" class="difflineminus">-&lt;!ENTITY checkboolpref.label &quot;A Boolean Preference&quot;&gt;</span>
<a href="#l3.7"></a><span id="l3.7" class="difflineminus">-&lt;!ENTITY checkboolpref.accesskey &quot;B&quot;&gt;</span>
<a href="#l3.8"></a><span id="l3.8" class="difflineminus">-&lt;!ENTITY intpref.label &quot;An Integer Preference&quot;&gt;</span>
<a href="#l3.9"></a><span id="l3.9" class="difflineminus">-&lt;!ENTITY intpref.accesskey &quot;I&quot;&gt;</span>
<a href="#l3.10"></a><span id="l3.10" class="difflineminus">-&lt;!ENTITY stringpref.label &quot;A String Preference&quot;&gt;</span>
<a href="#l3.11"></a><span id="l3.11" class="difflineminus">-&lt;!ENTITY stringpref.accesskey &quot;S&quot;&gt;</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+&lt;!ENTITY prefwindow.title &quot;Global Database Has No Preferences&quot;&gt;</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+&lt;!ENTITY pane1.title &quot;Global Database Has No Preferences&quot;&gt;</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+&lt;!ENTITY checkboolpref.label &quot;I like cookies&quot;&gt;</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+&lt;!ENTITY checkboolpref.accesskey &quot;l&quot;&gt;</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+&lt;!ENTITY intpref.label &quot;I would eat this many cookies&quot;&gt;</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+&lt;!ENTITY intpref.accesskey &quot;e&quot;&gt;</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+&lt;!ENTITY stringpref.label &quot;Name of my favorite cookie&quot;&gt;</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+&lt;!ENTITY stringpref.accesskey &quot;f&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/modules/datamodel.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/modules/datamodel.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -42,26 +42,26 @@ const Cc = Components.classes;</span>
<a href="#l4.4"></a><span id="l4.4"> const Ci = Components.interfaces;</span>
<a href="#l4.5"></a><span id="l4.5"> const Cr = Components.results;</span>
<a href="#l4.6"></a><span id="l4.6"> const Cu = Components.utils;</span>
<a href="#l4.7"></a><span id="l4.7"> </span>
<a href="#l4.8"></a><span id="l4.8"> Cu.import(&quot;resource://gloda/modules/log4moz.js&quot;);</span>
<a href="#l4.9"></a><span id="l4.9"> const LOG = Log4Moz.Service.getLogger(&quot;gloda.datamodel&quot;);</span>
<a href="#l4.10"></a><span id="l4.10"> </span>
<a href="#l4.11"></a><span id="l4.11"> function GlodaAttributeDef(aDatastore, aID, aCompoundName, aProvider, aAttrType,</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-                           aPluginName, aAttrName, aSubjectType, aObjectType,</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+                           aPluginName, aAttrName, aSubjectTypes, aObjectType,</span>
<a href="#l4.14"></a><span id="l4.14">                            aParameterType, aExplanationFormat) {</span>
<a href="#l4.15"></a><span id="l4.15">   this._datastore = aDatastore;</span>
<a href="#l4.16"></a><span id="l4.16">   this._id = aID;</span>
<a href="#l4.17"></a><span id="l4.17">   this._compoundName = aCompoundName;</span>
<a href="#l4.18"></a><span id="l4.18">   this._provider = aProvider;</span>
<a href="#l4.19"></a><span id="l4.19">   this._attrType = aAttrType;</span>
<a href="#l4.20"></a><span id="l4.20">   this._pluginName = aPluginName;</span>
<a href="#l4.21"></a><span id="l4.21">   this._attrName = aAttrName;</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineminus">-  this._subjectType = aSubjectType;</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineplus">+  this._subjectTypes = aSubjectTypes;</span>
<a href="#l4.24"></a><span id="l4.24">   this._objectType = aObjectType;</span>
<a href="#l4.25"></a><span id="l4.25">   this._parameterType = aParameterType;</span>
<a href="#l4.26"></a><span id="l4.26">   this._explanationFormat = aExplanationFormat;</span>
<a href="#l4.27"></a><span id="l4.27">   </span>
<a href="#l4.28"></a><span id="l4.28">   /** Map parameter values to the underlying database id. */</span>
<a href="#l4.29"></a><span id="l4.29">   this._parameterBindings = {};</span>
<a href="#l4.30"></a><span id="l4.30"> }</span>
<a href="#l4.31"></a><span id="l4.31"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/modules/datastore.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/modules/datastore.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -51,41 +51,49 @@ Cu.import(&quot;resource://gloda/modules/log4</span>
<a href="#l5.4"></a><span id="l5.4"> </span>
<a href="#l5.5"></a><span id="l5.5"> Cu.import(&quot;resource://gloda/modules/datamodel.js&quot;);</span>
<a href="#l5.6"></a><span id="l5.6"> </span>
<a href="#l5.7"></a><span id="l5.7"> let GlodaDatastore = {</span>
<a href="#l5.8"></a><span id="l5.8">   _log: null,</span>
<a href="#l5.9"></a><span id="l5.9"> </span>
<a href="#l5.10"></a><span id="l5.10">   /* ******************* SCHEMA ******************* */</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-  _schemaVersion: 2,</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+  _schemaVersion: 3,</span>
<a href="#l5.14"></a><span id="l5.14">   _schema: {</span>
<a href="#l5.15"></a><span id="l5.15">     tables: {</span>
<a href="#l5.16"></a><span id="l5.16">       </span>
<a href="#l5.17"></a><span id="l5.17">       // ----- Messages</span>
<a href="#l5.18"></a><span id="l5.18">       folderLocations: {</span>
<a href="#l5.19"></a><span id="l5.19">         columns: [</span>
<a href="#l5.20"></a><span id="l5.20">           &quot;id INTEGER PRIMARY KEY&quot;,</span>
<a href="#l5.21"></a><span id="l5.21">           &quot;folderURI TEXT&quot;,</span>
<a href="#l5.22"></a><span id="l5.22">         ],</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineplus">+        </span>
<a href="#l5.24"></a><span id="l5.24" class="difflineplus">+        triggers: {</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineplus">+          delete: &quot;DELETE from messages WHERE folderID = OLD.id&quot;,</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineplus">+        },</span>
<a href="#l5.27"></a><span id="l5.27">       },</span>
<a href="#l5.28"></a><span id="l5.28">       </span>
<a href="#l5.29"></a><span id="l5.29">       conversations: {</span>
<a href="#l5.30"></a><span id="l5.30">         columns: [</span>
<a href="#l5.31"></a><span id="l5.31">           &quot;id INTEGER PRIMARY KEY&quot;,</span>
<a href="#l5.32"></a><span id="l5.32">           &quot;subject TEXT&quot;,</span>
<a href="#l5.33"></a><span id="l5.33">           &quot;oldestMessageDate INTEGER&quot;,</span>
<a href="#l5.34"></a><span id="l5.34">           &quot;newestMessageDate INTEGER&quot;,</span>
<a href="#l5.35"></a><span id="l5.35">         ],</span>
<a href="#l5.36"></a><span id="l5.36">         </span>
<a href="#l5.37"></a><span id="l5.37">         indices: {</span>
<a href="#l5.38"></a><span id="l5.38">           subject: ['subject'],</span>
<a href="#l5.39"></a><span id="l5.39">           oldestMessageDate: ['oldestMessageDate'],</span>
<a href="#l5.40"></a><span id="l5.40">           newestMessageDate: ['newestMessageDate'],</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineminus">-        }</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineplus">+        },</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineplus">+        </span>
<a href="#l5.44"></a><span id="l5.44" class="difflineplus">+        triggers: {</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineplus">+          delete: &quot;DELETE from messages WHERE conversationID = OLD.id&quot;,</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineplus">+        },</span>
<a href="#l5.47"></a><span id="l5.47">       },</span>
<a href="#l5.48"></a><span id="l5.48">       </span>
<a href="#l5.49"></a><span id="l5.49">       /**</span>
<a href="#l5.50"></a><span id="l5.50">        * A message record correspond to an actual message stored in a folder</span>
<a href="#l5.51"></a><span id="l5.51">        *  somewhere, or is a ghost record indicating a message that we know</span>
<a href="#l5.52"></a><span id="l5.52">        *  should exist, but which we have not seen (and which we may never see).</span>
<a href="#l5.53"></a><span id="l5.53">        *  We represent these ghost messages by storing NULL values in the</span>
<a href="#l5.54"></a><span id="l5.54">        *  folderID and messageKey fields; this may need to change to other</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineat">@@ -102,27 +110,35 @@ let GlodaDatastore = {</span>
<a href="#l5.56"></a><span id="l5.56">           &quot;bodySnippet TEXT&quot;,</span>
<a href="#l5.57"></a><span id="l5.57">         ],</span>
<a href="#l5.58"></a><span id="l5.58">         </span>
<a href="#l5.59"></a><span id="l5.59">         indices: {</span>
<a href="#l5.60"></a><span id="l5.60">           messageLocation: ['folderID', 'messageKey'],</span>
<a href="#l5.61"></a><span id="l5.61">           headerMessageID: ['headerMessageID'],</span>
<a href="#l5.62"></a><span id="l5.62">           conversationID: ['conversationID'],</span>
<a href="#l5.63"></a><span id="l5.63">         },</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineplus">+        </span>
<a href="#l5.65"></a><span id="l5.65" class="difflineplus">+        triggers: {</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineplus">+          delete: &quot;DELETE FROM messageAttributes WHERE messageID = OLD.id&quot;,</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineplus">+        },</span>
<a href="#l5.68"></a><span id="l5.68">       },</span>
<a href="#l5.69"></a><span id="l5.69">       </span>
<a href="#l5.70"></a><span id="l5.70">       // ----- Attributes</span>
<a href="#l5.71"></a><span id="l5.71">       attributeDefinitions: {</span>
<a href="#l5.72"></a><span id="l5.72">         columns: [</span>
<a href="#l5.73"></a><span id="l5.73">           &quot;id INTEGER PRIMARY KEY&quot;,</span>
<a href="#l5.74"></a><span id="l5.74">           &quot;attributeType INTEGER&quot;,</span>
<a href="#l5.75"></a><span id="l5.75">           &quot;extensionName TEXT&quot;,</span>
<a href="#l5.76"></a><span id="l5.76">           &quot;name TEXT&quot;,</span>
<a href="#l5.77"></a><span id="l5.77">           &quot;parameter BLOB&quot;,</span>
<a href="#l5.78"></a><span id="l5.78">         ],</span>
<a href="#l5.79"></a><span id="l5.79" class="difflineplus">+        </span>
<a href="#l5.80"></a><span id="l5.80" class="difflineplus">+        triggers: [</span>
<a href="#l5.81"></a><span id="l5.81" class="difflineplus">+          delete: &quot;DELETE FROM messageAttributes WHERE attributeID = OLD.id&quot;,</span>
<a href="#l5.82"></a><span id="l5.82" class="difflineplus">+        ],</span>
<a href="#l5.83"></a><span id="l5.83">       },</span>
<a href="#l5.84"></a><span id="l5.84">       </span>
<a href="#l5.85"></a><span id="l5.85">       messageAttributes: {</span>
<a href="#l5.86"></a><span id="l5.86">         columns: [</span>
<a href="#l5.87"></a><span id="l5.87">           &quot;conversationID INTEGER NOT NULL REFERENCES conversations(id)&quot;,</span>
<a href="#l5.88"></a><span id="l5.88">           &quot;messageID INTEGER NOT NULL REFERENCES messages(id)&quot;,</span>
<a href="#l5.89"></a><span id="l5.89">           &quot;attributeID INTEGER NOT NULL REFERENCES attributeDefinitions(id)&quot;,</span>
<a href="#l5.90"></a><span id="l5.90">           &quot;value NUMERIC&quot;,</span>
<a href="#l5.91"></a><span id="l5.91" class="difflineat">@@ -214,16 +230,18 @@ let GlodaDatastore = {</span>
<a href="#l5.92"></a><span id="l5.92">                         dbConnection.schemaVersion, this._schemaVersion);</span>
<a href="#l5.93"></a><span id="l5.93">         }</span>
<a href="#l5.94"></a><span id="l5.94">       }</span>
<a href="#l5.95"></a><span id="l5.95">       // Handle corrupt databases, other oddities</span>
<a href="#l5.96"></a><span id="l5.96">       // ... in the future. for now, let us die</span>
<a href="#l5.97"></a><span id="l5.97">     }</span>
<a href="#l5.98"></a><span id="l5.98">     </span>
<a href="#l5.99"></a><span id="l5.99">     this.dbConnection = dbConnection;</span>
<a href="#l5.100"></a><span id="l5.100" class="difflineplus">+    </span>
<a href="#l5.101"></a><span id="l5.101" class="difflineplus">+    this._getAllFolderMappings();</span>
<a href="#l5.102"></a><span id="l5.102">   },</span>
<a href="#l5.103"></a><span id="l5.103">   </span>
<a href="#l5.104"></a><span id="l5.104">   _createDB: function gloda_ds_createDB(aDBService, aDBFile) {</span>
<a href="#l5.105"></a><span id="l5.105">     var dbConnection = aDBService.openDatabase(aDBFile);</span>
<a href="#l5.106"></a><span id="l5.106">     </span>
<a href="#l5.107"></a><span id="l5.107">     dbConnection.beginTransaction();</span>
<a href="#l5.108"></a><span id="l5.108">     try {</span>
<a href="#l5.109"></a><span id="l5.109">       this._createSchema(dbConnection);</span>
<a href="#l5.110"></a><span id="l5.110" class="difflineat">@@ -430,48 +448,51 @@ let GlodaDatastore = {</span>
<a href="#l5.111"></a><span id="l5.111">   get _insertFolderLocationStatement() {</span>
<a href="#l5.112"></a><span id="l5.112">     let statement = this._createStatement(</span>
<a href="#l5.113"></a><span id="l5.113">       &quot;INSERT INTO folderLocations (folderURI) VALUES (:folderURI)&quot;);</span>
<a href="#l5.114"></a><span id="l5.114">     this.__defineGetter__(&quot;_insertFolderLocationStatement&quot;,</span>
<a href="#l5.115"></a><span id="l5.115">       function() statement);</span>
<a href="#l5.116"></a><span id="l5.116">     return this._insertFolderLocationStatement;</span>
<a href="#l5.117"></a><span id="l5.117">   },</span>
<a href="#l5.118"></a><span id="l5.118">   </span>
<a href="#l5.119"></a><span id="l5.119" class="difflineminus">-  get _selectFolderLocationByURIStatement() {</span>
<a href="#l5.120"></a><span id="l5.120" class="difflineminus">-    let statement = this._createStatement(</span>
<a href="#l5.121"></a><span id="l5.121" class="difflineminus">-      &quot;SELECT id FROM folderLocations WHERE folderURI = :folderURI&quot;);</span>
<a href="#l5.122"></a><span id="l5.122" class="difflineminus">-    this.__defineGetter__(&quot;_selectFolderLocationByURIStatement&quot;,</span>
<a href="#l5.123"></a><span id="l5.123" class="difflineminus">-      function() statement);</span>
<a href="#l5.124"></a><span id="l5.124" class="difflineminus">-    return this._selectFolderLocationByURIStatement;</span>
<a href="#l5.125"></a><span id="l5.125" class="difflineminus">-  },</span>
<a href="#l5.126"></a><span id="l5.126" class="difflineminus">-</span>
<a href="#l5.127"></a><span id="l5.127">   // memoizing this is arguably overkill... fix along with _mapFolderID idiom.</span>
<a href="#l5.128"></a><span id="l5.128">   get _selectAllFolderLocations() {</span>
<a href="#l5.129"></a><span id="l5.129">     let statement = this._createStatement(</span>
<a href="#l5.130"></a><span id="l5.130">       &quot;SELECT id, folderURI FROM folderLocations&quot;);</span>
<a href="#l5.131"></a><span id="l5.131">     this.__defineGetter__(&quot;_selectAllFolderLocations&quot;,</span>
<a href="#l5.132"></a><span id="l5.132">       function() statement);</span>
<a href="#l5.133"></a><span id="l5.133">     return this._selectAllFolderLocations;</span>
<a href="#l5.134"></a><span id="l5.134">   },</span>
<a href="#l5.135"></a><span id="l5.135">   </span>
<a href="#l5.136"></a><span id="l5.136">   /** Authoritative map from folder URI to folder ID */</span>
<a href="#l5.137"></a><span id="l5.137">   _folderURIs: {},</span>
<a href="#l5.138"></a><span id="l5.138">   /** Authoritative map from folder ID to folder URI */</span>
<a href="#l5.139"></a><span id="l5.139">   _folderIDs: {},</span>
<a href="#l5.140"></a><span id="l5.140">   </span>
<a href="#l5.141"></a><span id="l5.141" class="difflineplus">+  /** Intialize our _folderURIs/_folderIDs mappings, called by _init(). */</span>
<a href="#l5.142"></a><span id="l5.142" class="difflineplus">+  _getAllFolderMappings: function gloda_ds_getAllFolderMappings() {</span>
<a href="#l5.143"></a><span id="l5.143" class="difflineplus">+    while (this._selectAllFolderLocations.step()) {</span>
<a href="#l5.144"></a><span id="l5.144" class="difflineplus">+      let folderID = this._selectAllFolderLocations.row[&quot;id&quot;];</span>
<a href="#l5.145"></a><span id="l5.145" class="difflineplus">+      let folderURI = this._selectAllFolderLocations.row[&quot;folderURI&quot;];</span>
<a href="#l5.146"></a><span id="l5.146" class="difflineplus">+      this._folderURIs[folderURI] = folderID;</span>
<a href="#l5.147"></a><span id="l5.147" class="difflineplus">+      this._folderIDs[folderID] = folderURI;</span>
<a href="#l5.148"></a><span id="l5.148" class="difflineplus">+    }</span>
<a href="#l5.149"></a><span id="l5.149" class="difflineplus">+    this._selectAllFolderLocations.reset();</span>
<a href="#l5.150"></a><span id="l5.150" class="difflineplus">+  },</span>
<a href="#l5.151"></a><span id="l5.151" class="difflineplus">+  </span>
<a href="#l5.152"></a><span id="l5.152">   /**</span>
<a href="#l5.153"></a><span id="l5.153">    * Map a folder URI to a folder ID, creating the mapping if it does not yet</span>
<a href="#l5.154"></a><span id="l5.154">    *  exist.</span>
<a href="#l5.155"></a><span id="l5.155">    */</span>
<a href="#l5.156"></a><span id="l5.156">   _mapFolderURI: function gloda_ds_mapFolderURI(aFolderURI) {</span>
<a href="#l5.157"></a><span id="l5.157">     if (aFolderURI in this._folderURIs) {</span>
<a href="#l5.158"></a><span id="l5.158">       return this._folderURIs[aFolderURI];</span>
<a href="#l5.159"></a><span id="l5.159">     }</span>
<a href="#l5.160"></a><span id="l5.160">     </span>
<a href="#l5.161"></a><span id="l5.161" class="difflineminus">-    var folderID;</span>
<a href="#l5.162"></a><span id="l5.162" class="difflineplus">+    let folderID;</span>
<a href="#l5.163"></a><span id="l5.163">     this._selectFolderLocationByURIStatement.params.folderURI = aFolderURI;</span>
<a href="#l5.164"></a><span id="l5.164">     if (this._selectFolderLocationByURIStatement.step()) {</span>
<a href="#l5.165"></a><span id="l5.165">       folderID = this._selectFolderLocationByURIStatement.row[&quot;id&quot;];</span>
<a href="#l5.166"></a><span id="l5.166">     }</span>
<a href="#l5.167"></a><span id="l5.167">     else {</span>
<a href="#l5.168"></a><span id="l5.168">       this._insertFolderLocationStatement.params.folderURI = aFolderURI;</span>
<a href="#l5.169"></a><span id="l5.169">       this._insertFolderLocationStatement.execute();</span>
<a href="#l5.170"></a><span id="l5.170">       folderID = this.dbConnection.lastInsertRowID;</span>
<a href="#l5.171"></a><span id="l5.171" class="difflineat">@@ -479,39 +500,42 @@ let GlodaDatastore = {</span>
<a href="#l5.172"></a><span id="l5.172">     this._selectFolderLocationByURIStatement.reset();</span>
<a href="#l5.173"></a><span id="l5.173"> </span>
<a href="#l5.174"></a><span id="l5.174">     this._folderURIs[aFolderURI] = folderID;</span>
<a href="#l5.175"></a><span id="l5.175">     this._folderIDs[folderID] = aFolderURI;</span>
<a href="#l5.176"></a><span id="l5.176">     this._log.info(&quot;mapping URI &quot; + aFolderURI + &quot; to &quot; + folderID);</span>
<a href="#l5.177"></a><span id="l5.177">     return folderID;</span>
<a href="#l5.178"></a><span id="l5.178">   },</span>
<a href="#l5.179"></a><span id="l5.179">   </span>
<a href="#l5.180"></a><span id="l5.180" class="difflineminus">-  // perhaps a better approach is to just have the _folderIDs load everything</span>
<a href="#l5.181"></a><span id="l5.181" class="difflineminus">-  //  from the database the first time it is accessed, and then rely on</span>
<a href="#l5.182"></a><span id="l5.182" class="difflineminus">-  //  invariant maintenance to ensure that its state keeps up-to-date with the</span>
<a href="#l5.183"></a><span id="l5.183" class="difflineminus">-  //  actual database.</span>
<a href="#l5.184"></a><span id="l5.184">   _mapFolderID: function gloda_ds_mapFolderID(aFolderID) {</span>
<a href="#l5.185"></a><span id="l5.185">     if (aFolderID == null)</span>
<a href="#l5.186"></a><span id="l5.186">       return null;</span>
<a href="#l5.187"></a><span id="l5.187">     if (aFolderID in this._folderIDs)</span>
<a href="#l5.188"></a><span id="l5.188">       return this._folderIDs[aFolderID];</span>
<a href="#l5.189"></a><span id="l5.189" class="difflineminus">-    </span>
<a href="#l5.190"></a><span id="l5.190" class="difflineminus">-    while (this._selectAllFolderLocations.step()) {</span>
<a href="#l5.191"></a><span id="l5.191" class="difflineminus">-      let folderID = this._selectAllFolderLocations.row[&quot;id&quot;];</span>
<a href="#l5.192"></a><span id="l5.192" class="difflineminus">-      let folderURI = this._selectAllFolderLocations.row[&quot;folderURI&quot;];</span>
<a href="#l5.193"></a><span id="l5.193" class="difflineminus">-      this._log.info(&quot;defining mapping:&quot; + folderURI + &quot; to &quot; + folderID);</span>
<a href="#l5.194"></a><span id="l5.194" class="difflineminus">-      this._folderURIs[folderURI] = folderID;</span>
<a href="#l5.195"></a><span id="l5.195" class="difflineminus">-      this._folderIDs[folderID] = folderURI;</span>
<a href="#l5.196"></a><span id="l5.196" class="difflineminus">-    }</span>
<a href="#l5.197"></a><span id="l5.197" class="difflineminus">-    this._selectAllFolderLocations.reset();</span>
<a href="#l5.198"></a><span id="l5.198" class="difflineminus">-    </span>
<a href="#l5.199"></a><span id="l5.199" class="difflineminus">-    if (aFolderID in this._folderIDs)</span>
<a href="#l5.200"></a><span id="l5.200" class="difflineminus">-      return this._folderIDs[aFolderID];</span>
<a href="#l5.201"></a><span id="l5.201">     throw &quot;Got impossible folder ID: &quot; + aFolderID;</span>
<a href="#l5.202"></a><span id="l5.202">   },</span>
<a href="#l5.203"></a><span id="l5.203" class="difflineplus">+</span>
<a href="#l5.204"></a><span id="l5.204" class="difflineplus">+  get _updateFolderLocationStatement() {</span>
<a href="#l5.205"></a><span id="l5.205" class="difflineplus">+    let statement = this._createStatement(</span>
<a href="#l5.206"></a><span id="l5.206" class="difflineplus">+      &quot;UPDATE folderLocations SET folderURI = :newFolderURI \</span>
<a href="#l5.207"></a><span id="l5.207" class="difflineplus">+              WHERE folderURI = :oldFolderURI&quot;);</span>
<a href="#l5.208"></a><span id="l5.208" class="difflineplus">+    this.__defineGetter__(&quot;_updateFolderLocationStatement&quot;,</span>
<a href="#l5.209"></a><span id="l5.209" class="difflineplus">+      function() statement);</span>
<a href="#l5.210"></a><span id="l5.210" class="difflineplus">+    return this._updateFolderLocationStatement;</span>
<a href="#l5.211"></a><span id="l5.211" class="difflineplus">+  },</span>
<a href="#l5.212"></a><span id="l5.212" class="difflineplus">+  </span>
<a href="#l5.213"></a><span id="l5.213" class="difflineplus">+  renameFolder: function gloda_ds_renameFolder(aOldURI, aNewURI) {</span>
<a href="#l5.214"></a><span id="l5.214" class="difflineplus">+    let folderID = this._folderURIs[aOldURI];</span>
<a href="#l5.215"></a><span id="l5.215" class="difflineplus">+    this._folderURIs[aNewURI] = folderID;</span>
<a href="#l5.216"></a><span id="l5.216" class="difflineplus">+    this._folderIDs[folderID] = aNewURI;</span>
<a href="#l5.217"></a><span id="l5.217" class="difflineplus">+    this._updateFolderLocationStatement.params.oldFolderURI = aOldURI;</span>
<a href="#l5.218"></a><span id="l5.218" class="difflineplus">+    this._updateFolderLocationStatement.params.newFolderURI = aNewURI;</span>
<a href="#l5.219"></a><span id="l5.219" class="difflineplus">+    this._updateFolderLocationStatement.execute();</span>
<a href="#l5.220"></a><span id="l5.220" class="difflineplus">+    delete this._folderURIs[aOldURI];</span>
<a href="#l5.221"></a><span id="l5.221" class="difflineplus">+  },</span>
<a href="#l5.222"></a><span id="l5.222">   </span>
<a href="#l5.223"></a><span id="l5.223">   /* ********** Conversation ********** */</span>
<a href="#l5.224"></a><span id="l5.224">   get _insertConversationStatement() {</span>
<a href="#l5.225"></a><span id="l5.225">     let statement = this._createStatement(</span>
<a href="#l5.226"></a><span id="l5.226">       &quot;INSERT INTO conversations (subject, oldestMessageDate, \</span>
<a href="#l5.227"></a><span id="l5.227">                                   newestMessageDate) \</span>
<a href="#l5.228"></a><span id="l5.228">               VALUES (:subject, :oldestMessageDate, :newestMessageDate)&quot;);</span>
<a href="#l5.229"></a><span id="l5.229">     this.__defineGetter__(&quot;_insertConversationStatement&quot;, function() statement);</span>
<a href="#l5.230"></a><span id="l5.230" class="difflineat">@@ -708,16 +732,25 @@ let GlodaDatastore = {</span>
<a href="#l5.231"></a><span id="l5.231">     while (statement.step()) {</span>
<a href="#l5.232"></a><span id="l5.232">       results[msgIDToIndex[statement.row[&quot;headerMessageID&quot;]]] =</span>
<a href="#l5.233"></a><span id="l5.233">         this._messageFromRow(statement.row);</span>
<a href="#l5.234"></a><span id="l5.234">     }</span>
<a href="#l5.235"></a><span id="l5.235">     statement.reset();</span>
<a href="#l5.236"></a><span id="l5.236">     </span>
<a href="#l5.237"></a><span id="l5.237">     return results;</span>
<a href="#l5.238"></a><span id="l5.238">   },</span>
<a href="#l5.239"></a><span id="l5.239" class="difflineplus">+</span>
<a href="#l5.240"></a><span id="l5.240" class="difflineplus">+  /**</span>
<a href="#l5.241"></a><span id="l5.241" class="difflineplus">+   * Delete messages by databse ID.  This is the ONLY form of message deletion</span>
<a href="#l5.242"></a><span id="l5.242" class="difflineplus">+   *  we support because attribute clean-up demands that we actually know the</span>
<a href="#l5.243"></a><span id="l5.243" class="difflineplus">+   *  IDs of the messages we are deleting (so that we can delete attributes that</span>
<a href="#l5.244"></a><span id="l5.244" class="difflineplus">+   *  reference those message IDs. </span>
<a href="#l5.245"></a><span id="l5.245" class="difflineplus">+   */</span>
<a href="#l5.246"></a><span id="l5.246" class="difflineplus">+  deleteMessagesByID: function gloda_ds_deleteMessagesByID(aFolderID){</span>
<a href="#l5.247"></a><span id="l5.247" class="difflineplus">+  },</span>
<a href="#l5.248"></a><span id="l5.248">   </span>
<a href="#l5.249"></a><span id="l5.249">   // could probably do with an optimized version of this...</span>
<a href="#l5.250"></a><span id="l5.250">   getMessageByMessageID: function gloda_ds_getMessageByMessageID(aMessageID) {</span>
<a href="#l5.251"></a><span id="l5.251">     var ids = [aMessageID];</span>
<a href="#l5.252"></a><span id="l5.252">     var messages = this.getMessagesByMessageID(ids);</span>
<a href="#l5.253"></a><span id="l5.253">     return messages.pop();</span>
<a href="#l5.254"></a><span id="l5.254">   },</span>
<a href="#l5.255"></a><span id="l5.255"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/modules/explattr.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/modules/explattr.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -75,30 +75,63 @@ let GlodaExplicitAttr = {</span>
<a href="#l6.4"></a><span id="l6.4">   },</span>
<a href="#l6.5"></a><span id="l6.5"> </span>
<a href="#l6.6"></a><span id="l6.6">   _attrTag: null,</span>
<a href="#l6.7"></a><span id="l6.7">   _attrStar: null,</span>
<a href="#l6.8"></a><span id="l6.8">   _attrRead: null,</span>
<a href="#l6.9"></a><span id="l6.9">   </span>
<a href="#l6.10"></a><span id="l6.10">   defineAttributes: function() {</span>
<a href="#l6.11"></a><span id="l6.11">     // Tag</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-    this._attrTag = Gloda.defineAttr(this, Gloda.kAttrExplicit,</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+    this._attrTag = Gloda.defineAttribute({</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+                        provider: this,</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+                        extensionName: Gloda.BUILT_IN,</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+                        attributeType: Gloda.kAttrExplicit,</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineplus">+                        attributeName: &quot;tag&quot;,</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineplus">+                        bind: true,</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineplus">+                        bindName: &quot;tags&quot;,</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineplus">+                        singular: true,</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineplus">+                        subjectNouns: [Gloda.NOUN_MESSAGE],</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+                        objectNoun: Gloda.NOUN_DATE,</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineplus">+                        parameterNoun: Gloda.NOUN_TAG,</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineplus">+                        explanation: this._strBundle.getString(</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineplus">+                                       &quot;attrTagExplanation&quot;),</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineplus">+                        });</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineplus">+                        this, Gloda.kAttrExplicit,</span>
<a href="#l6.28"></a><span id="l6.28">                         Gloda.BUILT_IN, FA_TAG, Gloda.kMultiple,</span>
<a href="#l6.29"></a><span id="l6.29">                         Gloda.NOUN_MESSAGE, Gloda.NOUN_DATE, Gloda.NOUN_TAG,</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineminus">-                        &quot;%{subject} was tagged %{parameter} on %{object}&quot;);</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineplus">+                        &quot;&quot;);</span>
<a href="#l6.32"></a><span id="l6.32">     // Star</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineminus">-    this._attrStar = Gloda.defineAttr(this, Gloda.kAttrExplicit,</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineminus">-                        Gloda.BUILT_IN, FA_STAR, Gloda.kSingular,</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineminus">-                        Gloda.NOUN_MESSAGE, Gloda.NOUN_BOOLEAN, null,</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineminus">-                        &quot;%{subject} has a star state of %{object}&quot;);</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineplus">+    this._attrStar = Gloda.defineAttribute({</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineplus">+                        provider: this,</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineplus">+                        extensionName: Gloda.BUILT_IN,</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineplus">+                        attributeType: Gloda.kAttrExplicit,</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineplus">+                        attributeName: &quot;star&quot;,</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineplus">+                        bind: true,</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineplus">+                        bindName: &quot;starred&quot;,</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineplus">+                        singular: true,</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineplus">+                        subjectNouns: [Gloda.NOUN_MESSAGE],</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineplus">+                        objectNoun: Gloda.NOUN_BOOLEAN,</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineplus">+                        parameterNoun: null,</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineplus">+                        explanation: this._strBundle.getString(</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineplus">+                                       &quot;attrStarExplanation&quot;),</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineplus">+                        });</span>
<a href="#l6.51"></a><span id="l6.51">     // Read/Unread</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineminus">-    this._attrRead = Gloda.defineAttr(this, Gloda.kAttrExplicit,</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineminus">-                        Gloda.BUILT_IN, FA_READ, Gloda.kSingular,</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineminus">-                        Gloda.NOUN_MESSAGE, Gloda.NOUN_BOOLEAN, null,</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineminus">-                        &quot;%{subject} has a read state of %{object}&quot;);</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineplus">+    this._attrRead = Gloda.defineAttribute({</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineplus">+                        provider: this,</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineplus">+                        extensionName: Gloda.BUILT_IN,</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineplus">+                        attributeType: Gloda.kAttrExplicit,</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineplus">+                        attributeName: &quot;read&quot;,</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineplus">+                        bind: true,</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineplus">+                        singular: true,</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineplus">+                        subjectNouns: [Gloda.NOUN_MESSAGE],</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineplus">+                        objectNoun: Gloda.NOUN_BOOLEAN,</span>
<a href="#l6.65"></a><span id="l6.65" class="difflineplus">+                        parameterNoun: null,</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineplus">+                        explanation: this._strBundle.getString(</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineplus">+                                       &quot;attrReadExplanation&quot;),</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineplus">+                        });</span>
<a href="#l6.69"></a><span id="l6.69">     </span>
<a href="#l6.70"></a><span id="l6.70">   },</span>
<a href="#l6.71"></a><span id="l6.71">   </span>
<a href="#l6.72"></a><span id="l6.72">   process: function Gloda_explattr_process(aGlodaMessage, aMsgHdr) {</span>
<a href="#l6.73"></a><span id="l6.73">     let attribs = [];</span>
<a href="#l6.74"></a><span id="l6.74">     </span>
<a href="#l6.75"></a><span id="l6.75">     // -- Tag</span>
<a href="#l6.76"></a><span id="l6.76">     let keywords = aMsgHdr.getStringProperty(&quot;keywords&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/modules/fundattr.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/modules/fundattr.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -43,33 +43,30 @@ const Cr = Components.results;</span>
<a href="#l7.4"></a><span id="l7.4"> const Cu = Components.utils;</span>
<a href="#l7.5"></a><span id="l7.5"> </span>
<a href="#l7.6"></a><span id="l7.6"> Cu.import(&quot;resource://gloda/modules/log4moz.js&quot;);</span>
<a href="#l7.7"></a><span id="l7.7"> </span>
<a href="#l7.8"></a><span id="l7.8"> Cu.import(&quot;resource://gloda/modules/utils.js&quot;);</span>
<a href="#l7.9"></a><span id="l7.9"> Cu.import(&quot;resource://gloda/modules/gloda.js&quot;);</span>
<a href="#l7.10"></a><span id="l7.10"> Cu.import(&quot;resource://gloda/modules/datastore.js&quot;);</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-const FA_FROM = &quot;FROM&quot;;</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-const FA_TO = &quot;TO&quot;;</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineminus">-const FA_CC = &quot;CC&quot;;</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineminus">-const FA_DATE = &quot;DATE&quot;;</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineminus">-</span>
<a href="#l7.17"></a><span id="l7.17"> /**</span>
<a href="#l7.18"></a><span id="l7.18">  * The Gloda Fundamental Attribute provider is a special-case attribute</span>
<a href="#l7.19"></a><span id="l7.19">  *  provider; it provides attributes that the rest of the providers should be</span>
<a href="#l7.20"></a><span id="l7.20">  *  able to assume exist.  Also, it may end up accessing things at a lower level</span>
<a href="#l7.21"></a><span id="l7.21">  *  than most extension providers should do.  In summary, don't mimic this code</span>
<a href="#l7.22"></a><span id="l7.22">  *  unless you won't complain when your code breaks.</span>
<a href="#l7.23"></a><span id="l7.23">  */</span>
<a href="#l7.24"></a><span id="l7.24"> let GlodaFundAttr = {</span>
<a href="#l7.25"></a><span id="l7.25">   _log: null,</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineplus">+  _strBundle: null,</span>
<a href="#l7.27"></a><span id="l7.27"> </span>
<a href="#l7.28"></a><span id="l7.28" class="difflineminus">-  _init: function gloda_explattr_init() {</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineplus">+  _init: function gloda_explattr_init(aStrBundle) {</span>
<a href="#l7.30"></a><span id="l7.30">     this._log =  Log4Moz.Service.getLogger(&quot;gloda.fundattr&quot;);</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineplus">+    this._strBundle = aStrBundle;</span>
<a href="#l7.32"></a><span id="l7.32">   </span>
<a href="#l7.33"></a><span id="l7.33">     try {</span>
<a href="#l7.34"></a><span id="l7.34">       this.defineAttributes();</span>
<a href="#l7.35"></a><span id="l7.35">     }</span>
<a href="#l7.36"></a><span id="l7.36">     catch (ex) {</span>
<a href="#l7.37"></a><span id="l7.37">       this._log.error(&quot;Error in init: &quot; + ex);</span>
<a href="#l7.38"></a><span id="l7.38">       throw ex;</span>
<a href="#l7.39"></a><span id="l7.39">     }</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineat">@@ -77,39 +74,71 @@ let GlodaFundAttr = {</span>
<a href="#l7.41"></a><span id="l7.41"> </span>
<a href="#l7.42"></a><span id="l7.42">   _attrFrom: null,</span>
<a href="#l7.43"></a><span id="l7.43">   _attrTo: null,</span>
<a href="#l7.44"></a><span id="l7.44">   _attrCc: null,</span>
<a href="#l7.45"></a><span id="l7.45">   _attrDate: null,</span>
<a href="#l7.46"></a><span id="l7.46">   </span>
<a href="#l7.47"></a><span id="l7.47">   defineAttributes: function() {</span>
<a href="#l7.48"></a><span id="l7.48">     // From</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineminus">-    this._attrFrom = Gloda.defineAttr(this, Gloda.kAttrFundamental,</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineminus">-                        Gloda.BUILT_IN, FA_FROM, Gloda.kSingular,</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineminus">-                        Gloda.NOUN_MESSAGE, Gloda.NOUN_IDENTITY, null,</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineminus">-                        &quot;from&quot;,</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineminus">-                        &quot;%{subject} was sent by %{object}&quot;);</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineplus">+    this._attrFrom = Gloda.defineAttribute({</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineplus">+                        provider: this,</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineplus">+                        extensionName: Gloda.BUILT_IN,</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineplus">+                        attributeType: Gloda.kAttrFundamental,</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineplus">+                        attributeName: &quot;from&quot;,</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineplus">+                        bind: true,</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineplus">+                        singular: true,</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineplus">+                        subjectNouns: [Gloda.NOUN_MESSAGE],</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineplus">+                        objectNoun: Gloda.NOUN_IDENTITY,</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineplus">+                        parameterNoun: null,</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineplus">+                        explanation: this._strBundle.getString(</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineplus">+                                       &quot;attrFromExplanation&quot;),</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineplus">+                        });</span>
<a href="#l7.67"></a><span id="l7.67">     // To</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineminus">-    this._attrTo = Gloda.defineAttr(this, Gloda.kAttrFundamental,</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineminus">-                        Gloda.BUILT_IN, FA_TO, Gloda.kMultiple,</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineminus">-                        Gloda.NOUN_MESSAGE, Gloda.NOUN_IDENTITY, null,</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineminus">-                        &quot;to&quot;,</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineminus">-                        &quot;%{subject} was sent to %{object}&quot;);</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineplus">+    this._attrTo = Gloda.defineAttribute({</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineplus">+                        provider: this,</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineplus">+                        extensionName: Gloda.BUILT_IN,</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineplus">+                        attributeType: Gloda.kAttrFundamental,</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineplus">+                        attributeName: &quot;to&quot;,</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineplus">+                        bind: true,</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineplus">+                        singular: false,</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineplus">+                        subjectNouns: [Gloda.NOUN_MESSAGE],</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineplus">+                        objectNoun: Gloda.NOUN_IDENTITY,</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineplus">+                        parameterNoun: null,</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineplus">+                        explanation: this._strBundle.getString(</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineplus">+                                       &quot;attrToExplanation&quot;),</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineplus">+                        });</span>
<a href="#l7.86"></a><span id="l7.86">     // Cc</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineminus">-    this._attrCc = Gloda.defineAttr(this, Gloda.kAttrFundamental,</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineminus">-                        Gloda.BUILT_IN, FA_CC, Gloda.kMultiple,</span>
<a href="#l7.89"></a><span id="l7.89" class="difflineminus">-                        Gloda.NOUN_MESSAGE, Gloda.NOUN_IDENTITY, null,</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineminus">-                        &quot;cc&quot;,</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineminus">-                        &quot;%{subject} was carbon-copied to %{object}&quot;);</span>
<a href="#l7.92"></a><span id="l7.92" class="difflineplus">+    this._attrCc = Gloda.defineAttribute({</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineplus">+                        provider: this,</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineplus">+                        extensionName: Gloda.BUILT_IN,</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineplus">+                        attributeType: Gloda.kAttrFundamental,</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineplus">+                        attributeName: &quot;cc&quot;,</span>
<a href="#l7.97"></a><span id="l7.97" class="difflineplus">+                        bind: true,</span>
<a href="#l7.98"></a><span id="l7.98" class="difflineplus">+                        singular: false,</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineplus">+                        subjectNouns: [Gloda.NOUN_MESSAGE],</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineplus">+                        objectNoun: Gloda.NOUN_IDENTITY,</span>
<a href="#l7.101"></a><span id="l7.101" class="difflineplus">+                        parameterNoun: null,</span>
<a href="#l7.102"></a><span id="l7.102" class="difflineplus">+                        explanation: this._strBundle.getString(</span>
<a href="#l7.103"></a><span id="l7.103" class="difflineplus">+                                       &quot;attrCcExplanation&quot;),</span>
<a href="#l7.104"></a><span id="l7.104" class="difflineplus">+                        });</span>
<a href="#l7.105"></a><span id="l7.105">     // Date</span>
<a href="#l7.106"></a><span id="l7.106" class="difflineminus">-    this._attrDate = Gloda.defineAttr(this, Gloda.kAttrFundamental,</span>
<a href="#l7.107"></a><span id="l7.107" class="difflineminus">-                        Gloda.BUILT_IN, FA_DATE, Gloda.kSingular,</span>
<a href="#l7.108"></a><span id="l7.108" class="difflineminus">-                        Gloda.NOUN_MESSAGE, Gloda.NOUN_DATE, null,</span>
<a href="#l7.109"></a><span id="l7.109" class="difflineminus">-                        &quot;date&quot;,</span>
<a href="#l7.110"></a><span id="l7.110" class="difflineminus">-                        &quot;%{subject} was sent on %{object}&quot;);</span>
<a href="#l7.111"></a><span id="l7.111" class="difflineplus">+    this._attrDate = Gloda.defineAttribute({</span>
<a href="#l7.112"></a><span id="l7.112" class="difflineplus">+                        provider: this,</span>
<a href="#l7.113"></a><span id="l7.113" class="difflineplus">+                        extensionName: Gloda.BUILT_IN,</span>
<a href="#l7.114"></a><span id="l7.114" class="difflineplus">+                        attributeType: Gloda.kAttrFundamental,</span>
<a href="#l7.115"></a><span id="l7.115" class="difflineplus">+                        attributeName: &quot;date&quot;,</span>
<a href="#l7.116"></a><span id="l7.116" class="difflineplus">+                        bind: true,</span>
<a href="#l7.117"></a><span id="l7.117" class="difflineplus">+                        singular: true,</span>
<a href="#l7.118"></a><span id="l7.118" class="difflineplus">+                        subjectNouns: [Gloda.NOUN_MESSAGE],</span>
<a href="#l7.119"></a><span id="l7.119" class="difflineplus">+                        objectNoun: Gloda.NOUN_DATE,</span>
<a href="#l7.120"></a><span id="l7.120" class="difflineplus">+                        parameterNoun: null,</span>
<a href="#l7.121"></a><span id="l7.121" class="difflineplus">+                        explanation: this._strBundle.getString(</span>
<a href="#l7.122"></a><span id="l7.122" class="difflineplus">+                                       &quot;attrDateExplanation&quot;),</span>
<a href="#l7.123"></a><span id="l7.123" class="difflineplus">+                        });</span>
<a href="#l7.124"></a><span id="l7.124">     </span>
<a href="#l7.125"></a><span id="l7.125">   },</span>
<a href="#l7.126"></a><span id="l7.126">   </span>
<a href="#l7.127"></a><span id="l7.127">   process: function gloda_fundattr_process(aGlodaMessage, aMsgHdr) {</span>
<a href="#l7.128"></a><span id="l7.128">     let attribs = [];</span>
<a href="#l7.129"></a><span id="l7.129">     </span>
<a href="#l7.130"></a><span id="l7.130">     // -- From</span>
<a href="#l7.131"></a><span id="l7.131">     // Let's use replyTo if available.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/modules/gloda.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/modules/gloda.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -43,17 +43,19 @@ const Cr = Components.results;</span>
<a href="#l8.4"></a><span id="l8.4"> const Cu = Components.utils;</span>
<a href="#l8.5"></a><span id="l8.5"> </span>
<a href="#l8.6"></a><span id="l8.6"> Cu.import(&quot;resource://gloda/modules/log4moz.js&quot;);</span>
<a href="#l8.7"></a><span id="l8.7"> </span>
<a href="#l8.8"></a><span id="l8.8"> Cu.import(&quot;resource://gloda/modules/datastore.js&quot;);</span>
<a href="#l8.9"></a><span id="l8.9"> Cu.import(&quot;resource://gloda/modules/datamodel.js&quot;);</span>
<a href="#l8.10"></a><span id="l8.10"> Cu.import(&quot;resource://gloda/modules/utils.js&quot;);</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+/**</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+ * </span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+ */</span>
<a href="#l8.16"></a><span id="l8.16"> let Gloda = {</span>
<a href="#l8.17"></a><span id="l8.17">   _init: function gloda_ns_init() {</span>
<a href="#l8.18"></a><span id="l8.18">     this._initLogging();</span>
<a href="#l8.19"></a><span id="l8.19">     GlodaDatastore._init();</span>
<a href="#l8.20"></a><span id="l8.20">     this._initAttributes();</span>
<a href="#l8.21"></a><span id="l8.21">   },</span>
<a href="#l8.22"></a><span id="l8.22">   </span>
<a href="#l8.23"></a><span id="l8.23">   _log: null,</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineat">@@ -125,29 +127,49 @@ let Gloda = {</span>
<a href="#l8.25"></a><span id="l8.25">       this._log.error(&quot;Expected exactly 1 address, got &quot; + identities.length +</span>
<a href="#l8.26"></a><span id="l8.26">                       &quot; for address: &quot; + aMailAddress);</span>
<a href="#l8.27"></a><span id="l8.27">       return null;</span>
<a href="#l8.28"></a><span id="l8.28">     }    </span>
<a href="#l8.29"></a><span id="l8.29">     </span>
<a href="#l8.30"></a><span id="l8.30">     return identities[0];</span>
<a href="#l8.31"></a><span id="l8.31">   },</span>
<a href="#l8.32"></a><span id="l8.32">   </span>
<a href="#l8.33"></a><span id="l8.33" class="difflineplus">+  /**</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineplus">+   * An attribute that is a defining characteristic of the subject.</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineplus">+   */</span>
<a href="#l8.36"></a><span id="l8.36">   kAttrFundamental: 0,</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineplus">+  /**</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineplus">+   * An attribute that is an optimization derived from two or more fundamental</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineplus">+   *  attributes and exists solely to improve database query performance.</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineplus">+   */</span>
<a href="#l8.41"></a><span id="l8.41">   kAttrOptimization: 1,</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineplus">+  /**</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineplus">+   * An attribute that is derived from the content of the subject.  For example,</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineplus">+   *  a message that references a bugzilla bug could have a &quot;derived&quot; attribute</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineplus">+   *  that captures the bugzilla reference.  This is not </span>
<a href="#l8.46"></a><span id="l8.46" class="difflineplus">+   */</span>
<a href="#l8.47"></a><span id="l8.47">   kAttrDerived: 2,</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineplus">+  /**</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineplus">+   * An attribute that is the result of an explicit and intentional user action</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineplus">+   *  upon the subject.  For example, a tag placed on a message by a user (or</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineplus">+   *  at the user's request by a filter) is explicit.</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineplus">+   */</span>
<a href="#l8.53"></a><span id="l8.53">   kAttrExplicit: 3,</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineplus">+  /**</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineplus">+   * An attribute that is indirectly the result of a user's behaviour.  For</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineplus">+   *  example, if a user consults a message multiple times, we may conclude that</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineplus">+   *  the user finds the message interesting.  It is &quot;implied&quot;, if you will,</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineplus">+   *  that the message is interesting.</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineplus">+   */</span>
<a href="#l8.60"></a><span id="l8.60">   kAttrImplicit: 4,</span>
<a href="#l8.61"></a><span id="l8.61">   </span>
<a href="#l8.62"></a><span id="l8.62" class="difflineminus">-  kSingular: 0,</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineminus">-  kMultiple: 1,</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineminus">-  </span>
<a href="#l8.65"></a><span id="l8.65">   BUILT_IN: &quot;built-in&quot;,</span>
<a href="#l8.66"></a><span id="l8.66">   </span>
<a href="#l8.67"></a><span id="l8.67">   NOUN_BOOLEAN: 1,</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineminus">-  /** A date, encoded as a PRTime */</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineplus">+  /** A date, encoded as a PRTime, represented as a js Date object. */</span>
<a href="#l8.70"></a><span id="l8.70">   NOUN_DATE: 10,</span>
<a href="#l8.71"></a><span id="l8.71">   NOUN_TAG: 50,</span>
<a href="#l8.72"></a><span id="l8.72">   NOUN_CONVERSATION: 101,</span>
<a href="#l8.73"></a><span id="l8.73">   NOUN_MESSAGE: 102,</span>
<a href="#l8.74"></a><span id="l8.74">   NOUN_CONTACT: 103,</span>
<a href="#l8.75"></a><span id="l8.75">   NOUN_IDENTITY: 104,</span>
<a href="#l8.76"></a><span id="l8.76">   </span>
<a href="#l8.77"></a><span id="l8.77">   /** Attribute providers in the sequence to process them. */</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineat">@@ -230,90 +252,159 @@ let Gloda = {</span>
<a href="#l8.79"></a><span id="l8.79">     subjectProto.__defineGetter__(aBindName, getter);</span>
<a href="#l8.80"></a><span id="l8.80">     // no setters for now; manipulation comes later, and will require the attr</span>
<a href="#l8.81"></a><span id="l8.81">     //  definer to provide the actual logic, since we need to affect reality,</span>
<a href="#l8.82"></a><span id="l8.82">     //  not just the data-store.  we may also just punt that all off onto</span>
<a href="#l8.83"></a><span id="l8.83">     //  STEEL...</span>
<a href="#l8.84"></a><span id="l8.84">   },</span>
<a href="#l8.85"></a><span id="l8.85">   </span>
<a href="#l8.86"></a><span id="l8.86">   /**</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineminus">-   * @param aProvider</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineminus">-   * @param aAttrType</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineminus">-   * @param aPluginName</span>
<a href="#l8.90"></a><span id="l8.90" class="difflineminus">-   * @param aAttrName</span>
<a href="#l8.91"></a><span id="l8.91" class="difflineminus">-   * @param aSingular Is the attribute going to happen at most once (kSingular),</span>
<a href="#l8.92"></a><span id="l8.92" class="difflineminus">-   *     or potentially multiple times (kMultiple).  This affects whether</span>
<a href="#l8.93"></a><span id="l8.93" class="difflineminus">-   *     the binding (as defined by aBindName) returns a list or just a single</span>
<a href="#l8.94"></a><span id="l8.94" class="difflineminus">-   *     item.</span>
<a href="#l8.95"></a><span id="l8.95" class="difflineminus">-   * @param aSubjectType</span>
<a href="#l8.96"></a><span id="l8.96" class="difflineminus">-   * @param aObjectType</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineminus">-   * @param aBindName The name to which to bind the attribute on the underlying</span>
<a href="#l8.98"></a><span id="l8.98" class="difflineminus">-   *     data model object.  For example, for an aObjectType of NOUN_MESSAGE</span>
<a href="#l8.99"></a><span id="l8.99" class="difflineminus">-   *     with an aBindName of &quot;date&quot;, we will create a getter on GlodaMessage so</span>
<a href="#l8.100"></a><span id="l8.100" class="difflineminus">-   *     that message.date returns the value of the date attribute (with the</span>
<a href="#l8.101"></a><span id="l8.101" class="difflineminus">-   *     specific return type depending on what was passed for </span>
<a href="#l8.102"></a><span id="l8.102" class="difflineminus">-   * @param aParameterType</span>
<a href="#l8.103"></a><span id="l8.103" class="difflineplus">+   * Define an attribute and all its meta-data.  Takes a single dictionary as</span>
<a href="#l8.104"></a><span id="l8.104" class="difflineplus">+   *  its argument, with the following required properties:</span>
<a href="#l8.105"></a><span id="l8.105" class="difflineplus">+   *</span>
<a href="#l8.106"></a><span id="l8.106" class="difflineplus">+   * @param provider The object instance providing a 'process' method.</span>
<a href="#l8.107"></a><span id="l8.107" class="difflineplus">+   * @param extensionName The name of the extension providing these attributes.</span>
<a href="#l8.108"></a><span id="l8.108" class="difflineplus">+   * @param attributeType The type of attribute, one of the values from the </span>
<a href="#l8.109"></a><span id="l8.109" class="difflineplus">+   *     kAttr* enumeration.</span>
<a href="#l8.110"></a><span id="l8.110" class="difflineplus">+   * @param attributeName The name of the attribute, which also doubles as the</span>
<a href="#l8.111"></a><span id="l8.111" class="difflineplus">+   *     bound property name if you pass 'bind' a value of true.  You are</span>
<a href="#l8.112"></a><span id="l8.112" class="difflineplus">+   *     responsible for avoiding collisions, which presumably will mean</span>
<a href="#l8.113"></a><span id="l8.113" class="difflineplus">+   *     checking/updating a wiki page in the future, or just prefixing your</span>
<a href="#l8.114"></a><span id="l8.114" class="difflineplus">+   *     attribute name with your extension name or something like that.</span>
<a href="#l8.115"></a><span id="l8.115" class="difflineplus">+   * @param bind Should this attribute be 'bound' as a convenience attribute</span>
<a href="#l8.116"></a><span id="l8.116" class="difflineplus">+   *     on the subject's object (true/false)?  For example, with an</span>
<a href="#l8.117"></a><span id="l8.117" class="difflineplus">+   *     attributeName of &quot;foo&quot; and passing true for 'bind' with a subject noun</span>
<a href="#l8.118"></a><span id="l8.118" class="difflineplus">+   *     of NOUN_MESSAGE, GlodaMessage instances will expose a &quot;foo&quot; getter</span>
<a href="#l8.119"></a><span id="l8.119" class="difflineplus">+   *     that returns the value of the attribute.  If 'singular' is true, this</span>
<a href="#l8.120"></a><span id="l8.120" class="difflineplus">+   *     means an instance of the object class corresponding to the noun type or</span>
<a href="#l8.121"></a><span id="l8.121" class="difflineplus">+   *     null if the attribute does not exist.  If 'singular' is false, this</span>
<a href="#l8.122"></a><span id="l8.122" class="difflineplus">+   *     means a list of instances of the object class corresponding to the noun</span>
<a href="#l8.123"></a><span id="l8.123" class="difflineplus">+   *     type, where the list may be empty if no instances of the attribute are</span>
<a href="#l8.124"></a><span id="l8.124" class="difflineplus">+   *     present. </span>
<a href="#l8.125"></a><span id="l8.125" class="difflineplus">+   * @param bindName Optional override of attributeName for purposes of the</span>
<a href="#l8.126"></a><span id="l8.126" class="difflineplus">+   *     binding property's name.</span>
<a href="#l8.127"></a><span id="l8.127" class="difflineplus">+   * @param singular Is the attribute going to happen at most once (true),</span>
<a href="#l8.128"></a><span id="l8.128" class="difflineplus">+   *     or potentially multiple times (false).  This affects whether</span>
<a href="#l8.129"></a><span id="l8.129" class="difflineplus">+   *     the binding  returns a list or just a single item (which is null when</span>
<a href="#l8.130"></a><span id="l8.130" class="difflineplus">+   *     the attribute is not present).</span>
<a href="#l8.131"></a><span id="l8.131" class="difflineplus">+   * @param subjectNouns A list of object types (NOUNs) that this attribute can</span>
<a href="#l8.132"></a><span id="l8.132" class="difflineplus">+   *     be set on.  Each element in the list should be one of the NOUN_*</span>
<a href="#l8.133"></a><span id="l8.133" class="difflineplus">+   *     constants or a dynamically registered noun type.</span>
<a href="#l8.134"></a><span id="l8.134" class="difflineplus">+   * @param objectNoun The object type (one of the NOUN_* constants or a</span>
<a href="#l8.135"></a><span id="l8.135" class="difflineplus">+   *     dynamically registered noun types) that is the 'object' in the</span>
<a href="#l8.136"></a><span id="l8.136" class="difflineplus">+   *     traditional RDF triple.  More pragmatically, in the database row used</span>
<a href="#l8.137"></a><span id="l8.137" class="difflineplus">+   *     to represent an attribute, we store the subject (ex: message ID),</span>
<a href="#l8.138"></a><span id="l8.138" class="difflineplus">+   *     attribute ID, and an integer which is the integer representation of the</span>
<a href="#l8.139"></a><span id="l8.139" class="difflineplus">+   *     'object' whose type you are defining right here.</span>
<a href="#l8.140"></a><span id="l8.140" class="difflineplus">+   * @param parameterNoun The object type (NOUN_* or dynamic) or 'null' that</span>
<a href="#l8.141"></a><span id="l8.141" class="difflineplus">+   *     parameterizes this attribute.  The attribute ID we mentioned on the</span>
<a href="#l8.142"></a><span id="l8.142" class="difflineplus">+   *     'objectNoun' could actually be one of many possible attribute IDs</span>
<a href="#l8.143"></a><span id="l8.143" class="difflineplus">+   *     spawned by a single attribute definition.  For each parameter for each</span>
<a href="#l8.144"></a><span id="l8.144" class="difflineplus">+   *     attribute, we add an extra row to the attributes table, resulting in</span>
<a href="#l8.145"></a><span id="l8.145" class="difflineplus">+   *     a new attribute ID.  The parameter can actually be represented as a</span>
<a href="#l8.146"></a><span id="l8.146" class="difflineplus">+   *     BLOB allowing slightly more choices, although implementation realities</span>
<a href="#l8.147"></a><span id="l8.147" class="difflineplus">+   *     demand that the number of parameters per attribute be kept reasonably</span>
<a href="#l8.148"></a><span id="l8.148" class="difflineplus">+   *     small (preferably no more than 32, definitely no more than 256).</span>
<a href="#l8.149"></a><span id="l8.149" class="difflineplus">+   * @param explanation A string (hopefully retrieved from a string bundle) that</span>
<a href="#l8.150"></a><span id="l8.150" class="difflineplus">+   *     is used to provide a textual explanation of what this attribute means.</span>
<a href="#l8.151"></a><span id="l8.151" class="difflineplus">+   *     Strings may contain &quot;%{subject}&quot; to expand a textual representation</span>
<a href="#l8.152"></a><span id="l8.152" class="difflineplus">+   *     of the attribute's subject, &quot;%{object}&quot; to expand a textual</span>
<a href="#l8.153"></a><span id="l8.153" class="difflineplus">+   *     representation of the object, and &quot;%{parameter}&quot; to expand a textual</span>
<a href="#l8.154"></a><span id="l8.154" class="difflineplus">+   *     representation of the parameter.</span>
<a href="#l8.155"></a><span id="l8.155">    */</span>
<a href="#l8.156"></a><span id="l8.156" class="difflineminus">-  defineAttr: function gloda_ns_defineAttr(aProvider, aAttrType,</span>
<a href="#l8.157"></a><span id="l8.157" class="difflineminus">-                                           aPluginName, aAttrName, aSingular,</span>
<a href="#l8.158"></a><span id="l8.158" class="difflineminus">-                                           aSubjectType, aObjectType,</span>
<a href="#l8.159"></a><span id="l8.159" class="difflineminus">-                                           aParameterType,</span>
<a href="#l8.160"></a><span id="l8.160" class="difflineminus">-                                           aBindName,</span>
<a href="#l8.161"></a><span id="l8.161" class="difflineminus">-                                           aExplanationFormat) {</span>
<a href="#l8.162"></a><span id="l8.162" class="difflineplus">+  defineAttribute: function gloda_ns_defineAttribute(aAttrDef) {</span>
<a href="#l8.163"></a><span id="l8.163" class="difflineplus">+    // ensure required properties exist on aAttrDef</span>
<a href="#l8.164"></a><span id="l8.164" class="difflineplus">+    if (!(&quot;provider&quot; in aAttrDef) ||</span>
<a href="#l8.165"></a><span id="l8.165" class="difflineplus">+        !(&quot;extensionName&quot; in aAttrDef) ||</span>
<a href="#l8.166"></a><span id="l8.166" class="difflineplus">+        !(&quot;attributeType&quot; in aAttrDef) ||</span>
<a href="#l8.167"></a><span id="l8.167" class="difflineplus">+        !(&quot;attributeName&quot; in aAttrDef) ||</span>
<a href="#l8.168"></a><span id="l8.168" class="difflineplus">+        !(&quot;bind&quot; in aAttrDef) ||</span>
<a href="#l8.169"></a><span id="l8.169" class="difflineplus">+        !(&quot;singular&quot; in aAttrDef) ||</span>
<a href="#l8.170"></a><span id="l8.170" class="difflineplus">+        !(&quot;subjectNouns&quot; in aAttrDef) ||</span>
<a href="#l8.171"></a><span id="l8.171" class="difflineplus">+        !(&quot;objectNoun&quot; in aAttrDef) ||</span>
<a href="#l8.172"></a><span id="l8.172" class="difflineplus">+        !(&quot;parameterNoun&quot; in aAttrDef) ||</span>
<a href="#l8.173"></a><span id="l8.173" class="difflineplus">+        !(&quot;explanation&quot; in aAttrDef))</span>
<a href="#l8.174"></a><span id="l8.174" class="difflineplus">+      // perhaps we should have a list of required attributes, perchance with</span>
<a href="#l8.175"></a><span id="l8.175" class="difflineplus">+      //  and explanation of what it holds, and use that to be friendlier?</span>
<a href="#l8.176"></a><span id="l8.176" class="difflineplus">+      throw Error(&quot;You omitted a required attribute defining property, please&quot; +</span>
<a href="#l8.177"></a><span id="l8.177" class="difflineplus">+                  &quot; consult the documentation as penance.&quot;)</span>
<a href="#l8.178"></a><span id="l8.178" class="difflineplus">+</span>
<a href="#l8.179"></a><span id="l8.179">     // provider tracking</span>
<a href="#l8.180"></a><span id="l8.180" class="difflineminus">-    if (!(aProvider in this._attrProviders)) {</span>
<a href="#l8.181"></a><span id="l8.181" class="difflineminus">-      this._attrProviderOrder.push(aProvider);</span>
<a href="#l8.182"></a><span id="l8.182" class="difflineminus">-      this._attrProviders[aProvider] = [];</span>
<a href="#l8.183"></a><span id="l8.183" class="difflineplus">+    if (!(aAttrDef.provider in this._attrProviders)) {</span>
<a href="#l8.184"></a><span id="l8.184" class="difflineplus">+      this._attrProviderOrder.push(aAttrDef.provider);</span>
<a href="#l8.185"></a><span id="l8.185" class="difflineplus">+      this._attrProviders[aAttrDef.provider] = [];</span>
<a href="#l8.186"></a><span id="l8.186">     } </span>
<a href="#l8.187"></a><span id="l8.187">     </span>
<a href="#l8.188"></a><span id="l8.188" class="difflineminus">-    let compoundName = aPluginName + &quot;:&quot; + aAttrName;</span>
<a href="#l8.189"></a><span id="l8.189" class="difflineplus">+    let bindName;</span>
<a href="#l8.190"></a><span id="l8.190" class="difflineplus">+    if (&quot;bindName&quot; in aAttrDef)</span>
<a href="#l8.191"></a><span id="l8.191" class="difflineplus">+      bindName = aAttrDef.bindName;</span>
<a href="#l8.192"></a><span id="l8.192" class="difflineplus">+    else</span>
<a href="#l8.193"></a><span id="l8.193" class="difflineplus">+      bindName = aAttrDef.attributeName;</span>
<a href="#l8.194"></a><span id="l8.194" class="difflineplus">+    </span>
<a href="#l8.195"></a><span id="l8.195" class="difflineplus">+    let compoundName = aAttrDef.extensionName + &quot;:&quot; + aAttrDef.attributeName;</span>
<a href="#l8.196"></a><span id="l8.196">     let attr = null;</span>
<a href="#l8.197"></a><span id="l8.197">     if (compoundName in GlodaDatastore._attributes) {</span>
<a href="#l8.198"></a><span id="l8.198">       // the existence of the GlodaAttributeDef means that either it has</span>
<a href="#l8.199"></a><span id="l8.199">       //  already been fully defined, or has been loaded from the database but</span>
<a href="#l8.200"></a><span id="l8.200">       //  not yet 'bound' to a provider (and had important meta-info that</span>
<a href="#l8.201"></a><span id="l8.201">       //  doesn't go in the db copied over)</span>
<a href="#l8.202"></a><span id="l8.202">       attr = GlodaDatastore._attributes[compoundName];</span>
<a href="#l8.203"></a><span id="l8.203">       if (attr.provider != null) {</span>
<a href="#l8.204"></a><span id="l8.204">         return attr;</span>
<a href="#l8.205"></a><span id="l8.205">       }</span>
<a href="#l8.206"></a><span id="l8.206">       </span>
<a href="#l8.207"></a><span id="l8.207">       // we are behind the abstraction veil and can set these things</span>
<a href="#l8.208"></a><span id="l8.208" class="difflineminus">-      attr._provider = aProvider;</span>
<a href="#l8.209"></a><span id="l8.209" class="difflineminus">-      attr._subjectType = aSubjectType;</span>
<a href="#l8.210"></a><span id="l8.210" class="difflineminus">-      attr._objectType = aObjectType;</span>
<a href="#l8.211"></a><span id="l8.211" class="difflineminus">-      attr._parameterType = aParameterType;</span>
<a href="#l8.212"></a><span id="l8.212" class="difflineminus">-      attr._explanationFormat = aExplanationFormat;</span>
<a href="#l8.213"></a><span id="l8.213" class="difflineplus">+      attr._provider = aAttrDef.provider;</span>
<a href="#l8.214"></a><span id="l8.214" class="difflineplus">+      attr._subjectTypes = aAttrDef.subjectNouns;</span>
<a href="#l8.215"></a><span id="l8.215" class="difflineplus">+      attr._objectType = aAttrDef.objectNoun;</span>
<a href="#l8.216"></a><span id="l8.216" class="difflineplus">+      attr._parameterType = aAttrDef.parameterNoun;</span>
<a href="#l8.217"></a><span id="l8.217" class="difflineplus">+      attr._explanationFormat = aAttrDef.explanation;</span>
<a href="#l8.218"></a><span id="l8.218">       </span>
<a href="#l8.219"></a><span id="l8.219" class="difflineminus">-      this._bindAttribute(attr, aSubjectType, aObjectType, aSingular,</span>
<a href="#l8.220"></a><span id="l8.220" class="difflineminus">-                          aBindName);</span>
<a href="#l8.221"></a><span id="l8.221" class="difflineplus">+      if (aAttrDef.bind) {</span>
<a href="#l8.222"></a><span id="l8.222" class="difflineplus">+        for (let iSubject=0; iSubject &lt; aAttrDef.subjectNouns.length;</span>
<a href="#l8.223"></a><span id="l8.223" class="difflineplus">+             iSubject++) {</span>
<a href="#l8.224"></a><span id="l8.224" class="difflineplus">+          let subjectType = aAttrDef.subjectNouns[iSubject];</span>
<a href="#l8.225"></a><span id="l8.225" class="difflineplus">+          this._bindAttribute(attr, subjectType, aAttrDef.objectNoun,</span>
<a href="#l8.226"></a><span id="l8.226" class="difflineplus">+                              aAttrDef.singular, bindName);</span>
<a href="#l8.227"></a><span id="l8.227" class="difflineplus">+        }</span>
<a href="#l8.228"></a><span id="l8.228" class="difflineplus">+      }</span>
<a href="#l8.229"></a><span id="l8.229">       </span>
<a href="#l8.230"></a><span id="l8.230" class="difflineminus">-      this._attrProviders[aProvider].push(attr);</span>
<a href="#l8.231"></a><span id="l8.231" class="difflineplus">+      this._attrProviders[aAttrDef.provider].push(attr);</span>
<a href="#l8.232"></a><span id="l8.232">       return attr; </span>
<a href="#l8.233"></a><span id="l8.233">     }</span>
<a href="#l8.234"></a><span id="l8.234">     </span>
<a href="#l8.235"></a><span id="l8.235">     // Being here means the attribute def does not exist in the database.</span>
<a href="#l8.236"></a><span id="l8.236">     // Of course, we only want to create something in the database if the</span>
<a href="#l8.237"></a><span id="l8.237">     //  parameter is forever un-bound (type is null).</span>
<a href="#l8.238"></a><span id="l8.238">     let attrID = null;</span>
<a href="#l8.239"></a><span id="l8.239" class="difflineminus">-    if (aParameterType == null) {</span>
<a href="#l8.240"></a><span id="l8.240" class="difflineminus">-      attrID = GlodaDatastore._createAttributeDef(aAttrType, aPluginName,</span>
<a href="#l8.241"></a><span id="l8.241" class="difflineminus">-                                                  aAttrName, null);</span>
<a href="#l8.242"></a><span id="l8.242" class="difflineplus">+    if (aAttrDef.parameterNoun == null) {</span>
<a href="#l8.243"></a><span id="l8.243" class="difflineplus">+      attrID = GlodaDatastore._createAttributeDef(aAttrDef.attributeType,</span>
<a href="#l8.244"></a><span id="l8.244" class="difflineplus">+                                                  aAttrDef.extensionName,</span>
<a href="#l8.245"></a><span id="l8.245" class="difflineplus">+                                                  aAttrDef.attributeName,</span>
<a href="#l8.246"></a><span id="l8.246" class="difflineplus">+                                                  null);</span>
<a href="#l8.247"></a><span id="l8.247">     }</span>
<a href="#l8.248"></a><span id="l8.248">     </span>
<a href="#l8.249"></a><span id="l8.249">     attr = new GlodaAttributeDef(GlodaDatastore, attrID, compoundName,</span>
<a href="#l8.250"></a><span id="l8.250" class="difflineminus">-                                 aProvider, aAttrType, aPluginName, aAttrName,</span>
<a href="#l8.251"></a><span id="l8.251" class="difflineminus">-                                 aSubjectType, aObjectType, aParameterType,</span>
<a href="#l8.252"></a><span id="l8.252" class="difflineminus">-                                 aExplanationFormat);</span>
<a href="#l8.253"></a><span id="l8.253" class="difflineplus">+                                 aAttrDef.provider, aAttrDef.attributeType,</span>
<a href="#l8.254"></a><span id="l8.254" class="difflineplus">+                                 aAttrDef.extensionName, aAttrDef.attributeName,</span>
<a href="#l8.255"></a><span id="l8.255" class="difflineplus">+                                 aAttrDef.subjectNouns, aAttrDef.objectNoun,</span>
<a href="#l8.256"></a><span id="l8.256" class="difflineplus">+                                 aAttrDef.parameterNoun, aAttrDef.explanation);</span>
<a href="#l8.257"></a><span id="l8.257">     GlodaDatastore._attributes[compoundName] = attr;</span>
<a href="#l8.258"></a><span id="l8.258"> </span>
<a href="#l8.259"></a><span id="l8.259" class="difflineminus">-    this._bindAttribute(attr, aSubjectType, aObjectType, aSingular, aBindName);</span>
<a href="#l8.260"></a><span id="l8.260" class="difflineplus">+    if (aAttrDef.bind) {</span>
<a href="#l8.261"></a><span id="l8.261" class="difflineplus">+      for (let iSubject=0; iSubject &lt; aAttrDef.subjectNouns.length;</span>
<a href="#l8.262"></a><span id="l8.262" class="difflineplus">+           iSubject++) {</span>
<a href="#l8.263"></a><span id="l8.263" class="difflineplus">+        let subjectType = aAttrDef.subjectNouns[iSubject];</span>
<a href="#l8.264"></a><span id="l8.264" class="difflineplus">+        this._bindAttribute(attr, subjectType, aAttrDef.objectNoun,</span>
<a href="#l8.265"></a><span id="l8.265" class="difflineplus">+                            aAttrDef.singular, bindName);</span>
<a href="#l8.266"></a><span id="l8.266" class="difflineplus">+      }</span>
<a href="#l8.267"></a><span id="l8.267" class="difflineplus">+    }</span>
<a href="#l8.268"></a><span id="l8.268"> </span>
<a href="#l8.269"></a><span id="l8.269" class="difflineminus">-    this._attrProviders[aProvider].push(attr);</span>
<a href="#l8.270"></a><span id="l8.270" class="difflineminus">-    if (aParameterType == null)    </span>
<a href="#l8.271"></a><span id="l8.271" class="difflineplus">+    this._attrProviders[aAttrDef.provider].push(attr);</span>
<a href="#l8.272"></a><span id="l8.272" class="difflineplus">+    if (aAttrDef.parameterNoun == null)    </span>
<a href="#l8.273"></a><span id="l8.273">       GlodaDatastore._attributeIDToDef[attrID] = [attr, null];</span>
<a href="#l8.274"></a><span id="l8.274">     return attr;</span>
<a href="#l8.275"></a><span id="l8.275">   },</span>
<a href="#l8.276"></a><span id="l8.276">   </span>
<a href="#l8.277"></a><span id="l8.277">   getAttrDef: function gloda_ns_getAttrDef(aPluginName, aAttrName) {</span>
<a href="#l8.278"></a><span id="l8.278">     let compoundName = aPluginName + &quot;:&quot; + aAttrName;</span>
<a href="#l8.279"></a><span id="l8.279">     return GlodaDatastore._attributes[compoundName];</span>
<a href="#l8.280"></a><span id="l8.280">   },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/modules/indexer.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/modules/indexer.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -160,17 +160,19 @@ let GlodaIndexer = {</span>
<a href="#l9.4"></a><span id="l9.4">   _indexingMessageCount: 0,</span>
<a href="#l9.5"></a><span id="l9.5">   _indexingMessageGoal: 0,</span>
<a href="#l9.6"></a><span id="l9.6">   </span>
<a href="#l9.7"></a><span id="l9.7">   /**</span>
<a href="#l9.8"></a><span id="l9.8">    * A list of things yet to index.  Contents will be lists matching one of the</span>
<a href="#l9.9"></a><span id="l9.9">    *  following patterns:</span>
<a href="#l9.10"></a><span id="l9.10">    * - ['account', account object]</span>
<a href="#l9.11"></a><span id="l9.11">    * - ['folder', folder URI]</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-   * - ['message', folder URI, message key, message ID]</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+   * - ['message', delta type, message header, folder ID, message key,</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+   *      message ID]</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+   *   (we use folder ID instead of URI so that renames can't trick us)</span>
<a href="#l9.16"></a><span id="l9.16">    */</span>
<a href="#l9.17"></a><span id="l9.17">   _indexQueue: [],</span>
<a href="#l9.18"></a><span id="l9.18">   </span>
<a href="#l9.19"></a><span id="l9.19">   /**</span>
<a href="#l9.20"></a><span id="l9.20">    * The time interval, in milliseconds between performing indexing work.</span>
<a href="#l9.21"></a><span id="l9.21">    *  This may be altered by user session (in)activity.</span>
<a href="#l9.22"></a><span id="l9.22">    */ </span>
<a href="#l9.23"></a><span id="l9.23">   _indexInterval: 100,</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineat">@@ -353,16 +355,195 @@ let GlodaIndexer = {</span>
<a href="#l9.25"></a><span id="l9.25">   },</span>
<a href="#l9.26"></a><span id="l9.26"> </span>
<a href="#l9.27"></a><span id="l9.27">   indexFolder: function glodaIndexFolder(aFolder) {</span>
<a href="#l9.28"></a><span id="l9.28">     this._log.info(&quot;Queue-ing folder for indexing: &quot; + aFolder.prettiestName);</span>
<a href="#l9.29"></a><span id="l9.29">     </span>
<a href="#l9.30"></a><span id="l9.30">     this._indexQueue.push([&quot;folder&quot;, aFolder.URI]);</span>
<a href="#l9.31"></a><span id="l9.31">     this.indexing = true;</span>
<a href="#l9.32"></a><span id="l9.32">   },</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineplus">+</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineplus">+  </span>
<a href="#l9.35"></a><span id="l9.35" class="difflineplus">+  /* *********** Event Processing *********** */</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineplus">+</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineplus">+  /* ***** Folder Changes ***** */  </span>
<a href="#l9.38"></a><span id="l9.38" class="difflineplus">+  /**</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineplus">+   * All additions and removals are queued for processing.  Indexing messages</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineplus">+   *  is potentially phenomenally expensive, and deletion can still be</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineplus">+   *  relatively expensive due to our need to delete the message, its</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineplus">+   *  attributes, and all attributes that reference it.  Additionally,</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineplus">+   *  attribute deletion costs are higher than attribute look-up because</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineplus">+   *  there is the actual row plus its 3 indices, and our covering indices are</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineplus">+   *  no help there.</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineplus">+   *  </span>
<a href="#l9.47"></a><span id="l9.47" class="difflineplus">+   */</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineplus">+  _msgFolderListener: {</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineplus">+    indexer: null,</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineplus">+    </span>
<a href="#l9.51"></a><span id="l9.51" class="difflineplus">+    /**</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineplus">+     * Handle a new-to-thunderbird message, meaning a newly fetched message</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineplus">+     *  (local folder) one revealed by synching with the server (IMAP).  Because</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineplus">+     *  the new-to-IMAP case requires Thunderbird to have opened the folder,</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineplus">+     *  we either need to depend on MailNews to be aggressive about looking</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineplus">+     *  for new messages in folders or try and do it ourselves.  For now, we</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineplus">+     *  leave it up to MailNews proper.</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineplus">+     *</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineplus">+     * For the time being, we post the message header as received to our</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineplus">+     *  indexing queue.  Depending on experience, it may be more suitable to</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineplus">+     *  try and index the message immediately, or hold onto a less specific</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineplus">+     *  form of message information than the nsIMsgDBHdr.  (If we were to</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineplus">+     *  process immediately, it might appropriate to consider having a</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineplus">+     *  transaction open that is commited by timer/sufficient activity, since it</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineplus">+     *  is conceivable we will see a number of these events in fairly rapid</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineplus">+     *  succession.)</span>
<a href="#l9.67"></a><span id="l9.67" class="difflineplus">+     */</span>
<a href="#l9.68"></a><span id="l9.68" class="difflineplus">+    msgAdded: function gloda_indexer_msgAdded(aMsgHdr) {</span>
<a href="#l9.69"></a><span id="l9.69" class="difflineplus">+      this.indexer._indexQueue.push([&quot;message&quot;, 1, aMsgHdr]);</span>
<a href="#l9.70"></a><span id="l9.70" class="difflineplus">+      this.indexer.indexing = true; </span>
<a href="#l9.71"></a><span id="l9.71" class="difflineplus">+    },</span>
<a href="#l9.72"></a><span id="l9.72" class="difflineplus">+    </span>
<a href="#l9.73"></a><span id="l9.73" class="difflineplus">+    /**</span>
<a href="#l9.74"></a><span id="l9.74" class="difflineplus">+     * Handle real, actual deletion (move to trash and IMAP deletion model</span>
<a href="#l9.75"></a><span id="l9.75" class="difflineplus">+     *  don't count; we only see the deletion here when it becomes forever,</span>
<a href="#l9.76"></a><span id="l9.76" class="difflineplus">+     *  or rather _just before_ it becomes forever.  Because the header is</span>
<a href="#l9.77"></a><span id="l9.77" class="difflineplus">+     *  going away, we need to either process things immediately or extract the</span>
<a href="#l9.78"></a><span id="l9.78" class="difflineplus">+     *  information required to purge it later without the header.</span>
<a href="#l9.79"></a><span id="l9.79" class="difflineplus">+     *</span>
<a href="#l9.80"></a><span id="l9.80" class="difflineplus">+     * We opt to process all of the headers immediately, inside a transaction.</span>
<a href="#l9.81"></a><span id="l9.81" class="difflineplus">+     *  We do this because deletions may actually be a batch deletion of many,</span>
<a href="#l9.82"></a><span id="l9.82" class="difflineplus">+     *  many messages, which could be a lot to queue</span>
<a href="#l9.83"></a><span id="l9.83" class="difflineplus">+     */</span>
<a href="#l9.84"></a><span id="l9.84" class="difflineplus">+    msgsDeleted: function gloda_indexer_msgsDeleted(aMsgHdrs) {</span>
<a href="#l9.85"></a><span id="l9.85" class="difflineplus">+      for (let iMsgHdr=0; iMsgHdr &lt; aMsgHdrs.length; iMsgHdr++) {</span>
<a href="#l9.86"></a><span id="l9.86" class="difflineplus">+        let msgHdr = aMsgHdrs.queryElementAt(iMsgHdr, Ci.nsIMsgDBHdr);</span>
<a href="#l9.87"></a><span id="l9.87" class="difflineplus">+        this.indexer._indexQueue.push([&quot;message&quot;, -1, msgHdr]);</span>
<a href="#l9.88"></a><span id="l9.88" class="difflineplus">+      }</span>
<a href="#l9.89"></a><span id="l9.89" class="difflineplus">+      this.indexer.indexing = true;</span>
<a href="#l9.90"></a><span id="l9.90" class="difflineplus">+    },</span>
<a href="#l9.91"></a><span id="l9.91" class="difflineplus">+    </span>
<a href="#l9.92"></a><span id="l9.92" class="difflineplus">+    /**</span>
<a href="#l9.93"></a><span id="l9.93" class="difflineplus">+     * Process a move or copy.  Moves are immediately processed, while copies</span>
<a href="#l9.94"></a><span id="l9.94" class="difflineplus">+     *  are treated as additions and accordingly queued for subsequent indexing.</span>
<a href="#l9.95"></a><span id="l9.95" class="difflineplus">+     */</span>
<a href="#l9.96"></a><span id="l9.96" class="difflineplus">+    msgsMoveCopyCompleted: function gloda_indexer_msgsMoveCopyCompleted(aMove,</span>
<a href="#l9.97"></a><span id="l9.97" class="difflineplus">+                             aSrcMsgHdrs, aDestFolder) {</span>
<a href="#l9.98"></a><span id="l9.98" class="difflineplus">+      for () {</span>
<a href="#l9.99"></a><span id="l9.99" class="difflineplus">+        let msgHdr;</span>
<a href="#l9.100"></a><span id="l9.100" class="difflineplus">+        this.indexer._indexQueue.push([&quot;message&quot;, 1, msgHdr]);</span>
<a href="#l9.101"></a><span id="l9.101" class="difflineplus">+      }</span>
<a href="#l9.102"></a><span id="l9.102" class="difflineplus">+    },</span>
<a href="#l9.103"></a><span id="l9.103" class="difflineplus">+    </span>
<a href="#l9.104"></a><span id="l9.104" class="difflineplus">+    /**</span>
<a href="#l9.105"></a><span id="l9.105" class="difflineplus">+     * Handles folder no-longer-exists-ence.  We want to delete all messages</span>
<a href="#l9.106"></a><span id="l9.106" class="difflineplus">+     *  located in the folder.</span>
<a href="#l9.107"></a><span id="l9.107" class="difflineplus">+     */</span>
<a href="#l9.108"></a><span id="l9.108" class="difflineplus">+    folderDeleted: function gloda_indexer_folderDeleted(aFolder) {</span>
<a href="#l9.109"></a><span id="l9.109" class="difflineplus">+    },</span>
<a href="#l9.110"></a><span id="l9.110" class="difflineplus">+    </span>
<a href="#l9.111"></a><span id="l9.111" class="difflineplus">+    /**</span>
<a href="#l9.112"></a><span id="l9.112" class="difflineplus">+     * Handle a folder being copied.  I do not believe the MailNews code is</span>
<a href="#l9.113"></a><span id="l9.113" class="difflineplus">+     *  capable of generating a case where aMove is true, but just in case we'll</span>
<a href="#l9.114"></a><span id="l9.114" class="difflineplus">+     *  dispatch to our sibling method, folderRenamed.</span>
<a href="#l9.115"></a><span id="l9.115" class="difflineplus">+     *</span>
<a href="#l9.116"></a><span id="l9.116" class="difflineplus">+     * Folder copying is conceptually all kinds of annoying (I mean, why would</span>
<a href="#l9.117"></a><span id="l9.117" class="difflineplus">+     *  you really need to duplicate all those messages?) but is easily dealt</span>
<a href="#l9.118"></a><span id="l9.118" class="difflineplus">+     *  with by queueing the destination folder for initial indexing. </span>
<a href="#l9.119"></a><span id="l9.119" class="difflineplus">+     */</span>
<a href="#l9.120"></a><span id="l9.120" class="difflineplus">+    folderMoveCopyCompleted: function gloda_indexer_folderMoveCopyCompleted(</span>
<a href="#l9.121"></a><span id="l9.121" class="difflineplus">+                               aMove, aSrcFolder, aDestFolder) {</span>
<a href="#l9.122"></a><span id="l9.122" class="difflineplus">+      if (aMove) {</span>
<a href="#l9.123"></a><span id="l9.123" class="difflineplus">+        return this.folderRenamed(aSrcFolder, aDestFolder);</span>
<a href="#l9.124"></a><span id="l9.124" class="difflineplus">+      }</span>
<a href="#l9.125"></a><span id="l9.125" class="difflineplus">+      this.indexer._indexQueue.push([&quot;folder&quot;, aDestFolder.URI]);</span>
<a href="#l9.126"></a><span id="l9.126" class="difflineplus">+      this.indexer.indexing = true;</span>
<a href="#l9.127"></a><span id="l9.127" class="difflineplus">+    },</span>
<a href="#l9.128"></a><span id="l9.128" class="difflineplus">+    </span>
<a href="#l9.129"></a><span id="l9.129" class="difflineplus">+    /**</span>
<a href="#l9.130"></a><span id="l9.130" class="difflineplus">+     * We just need to update the URI &lt;-&gt; ID maps and the row in the database,</span>
<a href="#l9.131"></a><span id="l9.131" class="difflineplus">+     *  all of which is actually done by the datastore for us.</span>
<a href="#l9.132"></a><span id="l9.132" class="difflineplus">+     */</span>
<a href="#l9.133"></a><span id="l9.133" class="difflineplus">+    folderRenamed: function gloda_indexer_folderRenamed(aOrigFolder,</span>
<a href="#l9.134"></a><span id="l9.134" class="difflineplus">+                                                        aNewFolder) {</span>
<a href="#l9.135"></a><span id="l9.135" class="difflineplus">+      GlodaDatastore.renameFolder(aOrigFolder.URI, aNewFolder.URI);</span>
<a href="#l9.136"></a><span id="l9.136" class="difflineplus">+    },</span>
<a href="#l9.137"></a><span id="l9.137" class="difflineplus">+    </span>
<a href="#l9.138"></a><span id="l9.138" class="difflineplus">+    itemEvent: function gloda_indexer_itemEvent(aItem, aEvent, aData) {</span>
<a href="#l9.139"></a><span id="l9.139" class="difflineplus">+      // nop.  this is an expansion method on the part of the interface and has</span>
<a href="#l9.140"></a><span id="l9.140" class="difflineplus">+      //  no known events that we need to handle.</span>
<a href="#l9.141"></a><span id="l9.141" class="difflineplus">+    },</span>
<a href="#l9.142"></a><span id="l9.142" class="difflineplus">+  },</span>
<a href="#l9.143"></a><span id="l9.143" class="difflineplus">+  </span>
<a href="#l9.144"></a><span id="l9.144" class="difflineplus">+  /* ***** Rebuilding / Reindexing ***** */</span>
<a href="#l9.145"></a><span id="l9.145" class="difflineplus">+  // TODO: implement a folder observer doodad to handle rebuilding / reindexing</span>
<a href="#l9.146"></a><span id="l9.146" class="difflineplus">+  /**</span>
<a href="#l9.147"></a><span id="l9.147" class="difflineplus">+   * Allow us to invalidate an outstanding folder traversal because the</span>
<a href="#l9.148"></a><span id="l9.148" class="difflineplus">+   *  underlying database is going away.  We use other means for detecting </span>
<a href="#l9.149"></a><span id="l9.149" class="difflineplus">+   *  modifications of the message (labeling, marked (un)read, starred, etc.)</span>
<a href="#l9.150"></a><span id="l9.150" class="difflineplus">+   *</span>
<a href="#l9.151"></a><span id="l9.151" class="difflineplus">+   * This is an nsIDBChangeListener listening to an nsIDBChangeAnnouncer.  To</span>
<a href="#l9.152"></a><span id="l9.152" class="difflineplus">+   *  add ourselves, we get us a nice nsMsgDatabase, query it to the announcer,</span>
<a href="#l9.153"></a><span id="l9.153" class="difflineplus">+   *  then call AddListener.</span>
<a href="#l9.154"></a><span id="l9.154" class="difflineplus">+   */</span>
<a href="#l9.155"></a><span id="l9.155" class="difflineplus">+  _databaseAnnouncerListener: {</span>
<a href="#l9.156"></a><span id="l9.156" class="difflineplus">+    onAnnouncerGoingAway: function gloda_indexer_dbGoingAway(</span>
<a href="#l9.157"></a><span id="l9.157" class="difflineplus">+                                         aDBChangeAnnouncer) {</span>
<a href="#l9.158"></a><span id="l9.158" class="difflineplus">+      // TODO: work</span>
<a href="#l9.159"></a><span id="l9.159" class="difflineplus">+    },</span>
<a href="#l9.160"></a><span id="l9.160" class="difflineplus">+    </span>
<a href="#l9.161"></a><span id="l9.161" class="difflineplus">+    onHdrChange: function(aHdrChanged, aOldFlags, aNewFlags, aInstigator) {},</span>
<a href="#l9.162"></a><span id="l9.162" class="difflineplus">+    onHdrDeleted: function(aHdrChanged, aParentKey, aFlags, aInstigator) {},</span>
<a href="#l9.163"></a><span id="l9.163" class="difflineplus">+    onHdrAdded: function(aHdrChanged, aParentKey, aFlags, aInstigator) {},</span>
<a href="#l9.164"></a><span id="l9.164" class="difflineplus">+    onParentChanged: function(aKeyChanged, aOldParent, aNewParent, </span>
<a href="#l9.165"></a><span id="l9.165" class="difflineplus">+                              aInstigator) {},</span>
<a href="#l9.166"></a><span id="l9.166" class="difflineplus">+    onReadChanged: function(aInstigator) {},</span>
<a href="#l9.167"></a><span id="l9.167" class="difflineplus">+    onJunkScoreChanged: function(aInstigator) {}</span>
<a href="#l9.168"></a><span id="l9.168" class="difflineplus">+  },</span>
<a href="#l9.169"></a><span id="l9.169" class="difflineplus">+  </span>
<a href="#l9.170"></a><span id="l9.170" class="difflineplus">+  /* ***** MailNews Shutdown ***** */</span>
<a href="#l9.171"></a><span id="l9.171" class="difflineplus">+  // TODO: implement a shutdown/pre-shutdown listener that attempts to either</span>
<a href="#l9.172"></a><span id="l9.172" class="difflineplus">+  //  drain the indexing queue or persist it.</span>
<a href="#l9.173"></a><span id="l9.173" class="difflineplus">+  /**</span>
<a href="#l9.174"></a><span id="l9.174" class="difflineplus">+   * Shutdown task.</span>
<a href="#l9.175"></a><span id="l9.175" class="difflineplus">+   *</span>
<a href="#l9.176"></a><span id="l9.176" class="difflineplus">+   * We implement nsIMsgShutdownTask, served up by nsIMsgShutdownService.  We</span>
<a href="#l9.177"></a><span id="l9.177" class="difflineplus">+   *  offer our services by registering ourselves as a &quot;msg-shutdown&quot; observer</span>
<a href="#l9.178"></a><span id="l9.178" class="difflineplus">+   *  with the observer service.</span>
<a href="#l9.179"></a><span id="l9.179" class="difflineplus">+   */</span>
<a href="#l9.180"></a><span id="l9.180" class="difflineplus">+  _shutdownTask: {</span>
<a href="#l9.181"></a><span id="l9.181" class="difflineplus">+    indexer: null,</span>
<a href="#l9.182"></a><span id="l9.182" class="difflineplus">+    </span>
<a href="#l9.183"></a><span id="l9.183" class="difflineplus">+    get needsToRunTask {</span>
<a href="#l9.184"></a><span id="l9.184" class="difflineplus">+      return this.indexer.indexing;</span>
<a href="#l9.185"></a><span id="l9.185" class="difflineplus">+    },</span>
<a href="#l9.186"></a><span id="l9.186" class="difflineplus">+    </span>
<a href="#l9.187"></a><span id="l9.187" class="difflineplus">+    /**</span>
<a href="#l9.188"></a><span id="l9.188" class="difflineplus">+     * So we could either go all out finishing our indexing, or write down what</span>
<a href="#l9.189"></a><span id="l9.189" class="difflineplus">+     *  we need to index next time around.  For now, we opt to complete our</span>
<a href="#l9.190"></a><span id="l9.190" class="difflineplus">+     *  indexing since it greatly simplifies our lives, but it probably would</span>
<a href="#l9.191"></a><span id="l9.191" class="difflineplus">+     *  be friendly to simply persist our state.</span>
<a href="#l9.192"></a><span id="l9.192" class="difflineplus">+     *</span>
<a href="#l9.193"></a><span id="l9.193" class="difflineplus">+     * XXX: so we can either return false and be done with it, or return true</span>
<a href="#l9.194"></a><span id="l9.194" class="difflineplus">+     *  and provide the stop running notification.</span>
<a href="#l9.195"></a><span id="l9.195" class="difflineplus">+     * We call aUrlListener's OnStopRunningUrl(null, NS_OK) when we are done,</span>
<a href="#l9.196"></a><span id="l9.196" class="difflineplus">+     *  and can provide status updates by calling the shutdown service</span>
<a href="#l9.197"></a><span id="l9.197" class="difflineplus">+     *  (nsIMsgShutdownService)'s setStatusText method. </span>
<a href="#l9.198"></a><span id="l9.198" class="difflineplus">+     */</span>
<a href="#l9.199"></a><span id="l9.199" class="difflineplus">+    doShutdownTask: function gloda_indexer_doShutdownTask(aUrlListener,</span>
<a href="#l9.200"></a><span id="l9.200" class="difflineplus">+                                                          aMsgWingow) {</span>
<a href="#l9.201"></a><span id="l9.201" class="difflineplus">+      this.indexer._onStopIndexingUrlListener = aUrlListener;</span>
<a href="#l9.202"></a><span id="l9.202" class="difflineplus">+      </span>
<a href="#l9.203"></a><span id="l9.203" class="difflineplus">+      </span>
<a href="#l9.204"></a><span id="l9.204" class="difflineplus">+      </span>
<a href="#l9.205"></a><span id="l9.205" class="difflineplus">+      return true;</span>
<a href="#l9.206"></a><span id="l9.206" class="difflineplus">+    },</span>
<a href="#l9.207"></a><span id="l9.207" class="difflineplus">+    </span>
<a href="#l9.208"></a><span id="l9.208" class="difflineplus">+    getCurrentTaskName: function gloda_indexer_getCurrentTaskName() {</span>
<a href="#l9.209"></a><span id="l9.209" class="difflineplus">+      return this.indexer.strBundle.getString(&quot;shutdownTaskName&quot;);</span>
<a href="#l9.210"></a><span id="l9.210" class="difflineplus">+    },</span>
<a href="#l9.211"></a><span id="l9.211" class="difflineplus">+  }, </span>
<a href="#l9.212"></a><span id="l9.212">   </span>
<a href="#l9.213"></a><span id="l9.213">   /**</span>
<a href="#l9.214"></a><span id="l9.214">    * Attempt to extract the original subject from a message.  For replies, this</span>
<a href="#l9.215"></a><span id="l9.215">    *  means either taking off the 're[#]:' (or variant, including other language</span>
<a href="#l9.216"></a><span id="l9.216">    *  variants), or in a Microsoft specific-ism, from the Thread-Topic header.</span>
<a href="#l9.217"></a><span id="l9.217">    *</span>
<a href="#l9.218"></a><span id="l9.218">    * Ideally, we would just be able to call NS_MsgStripRE to do the bulk of the</span>
<a href="#l9.219"></a><span id="l9.219">    *  work for us, especially since the subject may be encoded.</span>
<a href="#l9.220"></a><span id="l9.220" class="difflineat">@@ -407,65 +588,65 @@ let GlodaIndexer = {</span>
<a href="#l9.221"></a><span id="l9.221">     </span>
<a href="#l9.222"></a><span id="l9.222">     let conversationID = null;</span>
<a href="#l9.223"></a><span id="l9.223">     </span>
<a href="#l9.224"></a><span id="l9.224">     // (walk from closest to furthest ancestor)</span>
<a href="#l9.225"></a><span id="l9.225">     for (let iAncestor=ancestors.length-1; iAncestor &gt;= 0; --iAncestor) {</span>
<a href="#l9.226"></a><span id="l9.226">       let ancestor = ancestors[iAncestor];</span>
<a href="#l9.227"></a><span id="l9.227">       </span>
<a href="#l9.228"></a><span id="l9.228">       if (ancestor != null) { // ancestor.conversationID cannot be null</span>
<a href="#l9.229"></a><span id="l9.229" class="difflineminus">-        if (conversationID == null)</span>
<a href="#l9.230"></a><span id="l9.230" class="difflineplus">+        if (conversationID === null)</span>
<a href="#l9.231"></a><span id="l9.231">           conversationID = ancestor.conversationID;</span>
<a href="#l9.232"></a><span id="l9.232">         else if (conversationID != ancestor.conversationID)</span>
<a href="#l9.233"></a><span id="l9.233">           this._log.error(&quot;Inconsistency in conversations invariant on &quot; +</span>
<a href="#l9.234"></a><span id="l9.234">                           ancestor.messageID + &quot;.  It has conv id &quot; +</span>
<a href="#l9.235"></a><span id="l9.235">                           ancestor.conversationID + &quot; but expected &quot; + </span>
<a href="#l9.236"></a><span id="l9.236">                           conversationID);</span>
<a href="#l9.237"></a><span id="l9.237">       }</span>
<a href="#l9.238"></a><span id="l9.238">     }</span>
<a href="#l9.239"></a><span id="l9.239">     </span>
<a href="#l9.240"></a><span id="l9.240">     let conversation = null;</span>
<a href="#l9.241"></a><span id="l9.241" class="difflineminus">-    if (conversationID == null) {</span>
<a href="#l9.242"></a><span id="l9.242" class="difflineplus">+    if (conversationID === null) {</span>
<a href="#l9.243"></a><span id="l9.243">       // (the create method could issue the id, making the call return</span>
<a href="#l9.244"></a><span id="l9.244">       //  without waiting for the database...)</span>
<a href="#l9.245"></a><span id="l9.245">       conversation = this._datastore.createConversation(</span>
<a href="#l9.246"></a><span id="l9.246">           this._extractOriginalSubject(aMsgHdr), null, null);</span>
<a href="#l9.247"></a><span id="l9.247">       conversationID = conversation.id;</span>
<a href="#l9.248"></a><span id="l9.248">     }</span>
<a href="#l9.249"></a><span id="l9.249">     </span>
<a href="#l9.250"></a><span id="l9.250">     // Walk from furthest to closest ancestor, creating the ancestors that don't</span>
<a href="#l9.251"></a><span id="l9.251">     //  exist, and updating any to have correct parentID's if they don't have</span>
<a href="#l9.252"></a><span id="l9.252">     //  one.  (This is possible if previous messages that were consumed in this</span>
<a href="#l9.253"></a><span id="l9.253">     //  thread only had an in-reply-to or for some reason did not otherwise</span>
<a href="#l9.254"></a><span id="l9.254">     //  provide the full references chain.)</span>
<a href="#l9.255"></a><span id="l9.255">     let lastAncestorId = null;</span>
<a href="#l9.256"></a><span id="l9.256">     for (let iAncestor=0; iAncestor &lt; ancestors.length; ++iAncestor) {</span>
<a href="#l9.257"></a><span id="l9.257">       let ancestor = ancestors[iAncestor];</span>
<a href="#l9.258"></a><span id="l9.258">       </span>
<a href="#l9.259"></a><span id="l9.259" class="difflineminus">-      if (ancestor == null) {</span>
<a href="#l9.260"></a><span id="l9.260" class="difflineplus">+      if (ancestor === null) {</span>
<a href="#l9.261"></a><span id="l9.261">         this._log.debug(&quot;creating message with: null, &quot; + conversationID +</span>
<a href="#l9.262"></a><span id="l9.262">                         &quot;, &quot; + lastAncestorId + &quot;, &quot; + references[iAncestor] +</span>
<a href="#l9.263"></a><span id="l9.263">                         &quot;, null.&quot;);</span>
<a href="#l9.264"></a><span id="l9.264">         ancestor = this._datastore.createMessage(null, null, // no folder loc</span>
<a href="#l9.265"></a><span id="l9.265">                                                  conversationID,</span>
<a href="#l9.266"></a><span id="l9.266">                                                  lastAncestorId,</span>
<a href="#l9.267"></a><span id="l9.267">                                                  references[iAncestor],</span>
<a href="#l9.268"></a><span id="l9.268">                                                  null); // no snippet</span>
<a href="#l9.269"></a><span id="l9.269">         ancestors[iAncestor] = ancestor;</span>
<a href="#l9.270"></a><span id="l9.270">       }</span>
<a href="#l9.271"></a><span id="l9.271" class="difflineminus">-      else if (ancestor.parentID == null) {</span>
<a href="#l9.272"></a><span id="l9.272" class="difflineplus">+      else if (ancestor.parentID === null) {</span>
<a href="#l9.273"></a><span id="l9.273">         ancestor._parentID = lastAncestorId;</span>
<a href="#l9.274"></a><span id="l9.274">         this._datastore.updateMessage(ancestor);</span>
<a href="#l9.275"></a><span id="l9.275">       }</span>
<a href="#l9.276"></a><span id="l9.276">       </span>
<a href="#l9.277"></a><span id="l9.277">       lastAncestorId = ancestor.id;</span>
<a href="#l9.278"></a><span id="l9.278">     }</span>
<a href="#l9.279"></a><span id="l9.279">     // now all our ancestors exist, though they may be ghost-like...</span>
<a href="#l9.280"></a><span id="l9.280">     </span>
<a href="#l9.281"></a><span id="l9.281" class="difflineminus">-    if (curMsg == null) {</span>
<a href="#l9.282"></a><span id="l9.282" class="difflineplus">+    if (curMsg === null) {</span>
<a href="#l9.283"></a><span id="l9.283">       this._log.debug(&quot;creating message with: &quot; + aMsgHdr.folder.URI +</span>
<a href="#l9.284"></a><span id="l9.284">                       &quot;, &quot; + conversationID +</span>
<a href="#l9.285"></a><span id="l9.285">                       &quot;, &quot; + lastAncestorId + &quot;, &quot; + aMsgHdr.messageId +</span>
<a href="#l9.286"></a><span id="l9.286">                       &quot;, null.&quot;);</span>
<a href="#l9.287"></a><span id="l9.287">       curMsg = this._datastore.createMessage(aMsgHdr.folder.URI,</span>
<a href="#l9.288"></a><span id="l9.288">                                              aMsgHdr.messageKey,                </span>
<a href="#l9.289"></a><span id="l9.289">                                              conversationID,</span>
<a href="#l9.290"></a><span id="l9.290">                                              lastAncestorId,</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

