<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 10107:f31b8ad31c08269274a7c70e18aa97ec37674bd0</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ f31b8ad31c08269274a7c70e18aa97ec37674bd0" />
<meta property="og:url" content="/comm-central/rev/f31b8ad31c08269274a7c70e18aa97ec37674bd0" />
<meta property="og:description" content="Bug 743235 - Search emails and IM conversations at once with gloda, r+ui-r=bwinton, r=asuth." />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / f31b8ad31c08269274a7c70e18aa97ec37674bd0 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/f31b8ad31c08269274a7c70e18aa97ec37674bd0">shortlog</a> |
<a href="/comm-central/log/f31b8ad31c08269274a7c70e18aa97ec37674bd0">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/f31b8ad31c08269274a7c70e18aa97ec37674bd0">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/f31b8ad31c08269274a7c70e18aa97ec37674bd0">files</a> |
changeset |
<a href="/comm-central/raw-rev/f31b8ad31c08269274a7c70e18aa97ec37674bd0">raw</a>  | <a href="/comm-central/archive/f31b8ad31c08269274a7c70e18aa97ec37674bd0.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=743235">Bug 743235</a> - Search emails and IM conversations at once with gloda, r+ui-r=bwinton, r=asuth.
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#70;&#108;&#111;&#114;&#105;&#97;&#110;&#32;&#81;&#117;&#232;&#122;&#101;&#32;&#60;&#102;&#108;&#111;&#114;&#105;&#97;&#110;&#64;&#113;&#117;&#101;&#122;&#101;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Wed, 09 May 2012 15:06:31 +0200</td></tr>

<tr>
 <td>changeset 10107</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/f31b8ad31c08269274a7c70e18aa97ec37674bd0">f31b8ad31c08269274a7c70e18aa97ec37674bd0</a></td>
</tr>



<tr>
<td>parent 10106</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/e2a736a2a7b0b61152bf8ee11809c877a4dde39c">e2a736a2a7b0b61152bf8ee11809c877a4dde39c</a>
</td>
</tr>

<tr>
<td>child 10108</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/3a60b791073307b5f91ad663ad53ac581694fddb">3a60b791073307b5f91ad663ad53ac581694fddb</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=f31b8ad31c08269274a7c70e18aa97ec37674bd0">7691</a></td></tr>
<tr><td>push user</td><td>florian@queze.net</td></tr>
<tr><td>push date</td><td class="date age">Wed, 09 May 2012 13:22:24 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@a15efa119675 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=a15efa119675c833dcd05cb719cafee436c88b28">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=a15efa119675c833dcd05cb719cafee436c88b28&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a15efa119675c833dcd05cb719cafee436c88b28&newProject=comm-central&newRevision=f31b8ad31c08269274a7c70e18aa97ec37674bd0&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a15efa119675c833dcd05cb719cafee436c88b28&newProject=comm-central&newRevision=f31b8ad31c08269274a7c70e18aa97ec37674bd0&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a15efa119675c833dcd05cb719cafee436c88b28&newProject=comm-central&newRevision=f31b8ad31c08269274a7c70e18aa97ec37674bd0&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28asuth%29&revcount=50">asuth</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=743235">743235</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=743235">Bug 743235</a> - Search emails and IM conversations at once with gloda, r+ui-r=bwinton, r=asuth.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mail/base/content/glodaFacetBindings.xml">mail/base/content/glodaFacetBindings.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mail/base/content/glodaFacetBindings.xml">file</a> |
<a href="/comm-central/annotate/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mail/base/content/glodaFacetBindings.xml">annotate</a> |
<a href="/comm-central/diff/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mail/base/content/glodaFacetBindings.xml">diff</a> |
<a href="/comm-central/comparison/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mail/base/content/glodaFacetBindings.xml">comparison</a> |
<a href="/comm-central/log/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mail/base/content/glodaFacetBindings.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mail/base/content/glodaFacetTab.js">mail/base/content/glodaFacetTab.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mail/base/content/glodaFacetTab.js">file</a> |
<a href="/comm-central/annotate/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mail/base/content/glodaFacetTab.js">annotate</a> |
<a href="/comm-central/diff/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mail/base/content/glodaFacetTab.js">diff</a> |
<a href="/comm-central/comparison/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mail/base/content/glodaFacetTab.js">comparison</a> |
<a href="/comm-central/log/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mail/base/content/glodaFacetTab.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mail/base/content/glodaFacetView.js">mail/base/content/glodaFacetView.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mail/base/content/glodaFacetView.js">file</a> |
<a href="/comm-central/annotate/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mail/base/content/glodaFacetView.js">annotate</a> |
<a href="/comm-central/diff/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mail/base/content/glodaFacetView.js">diff</a> |
<a href="/comm-central/comparison/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mail/base/content/glodaFacetView.js">comparison</a> |
<a href="/comm-central/log/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mail/base/content/glodaFacetView.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mail/base/content/search.xml">mail/base/content/search.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mail/base/content/search.xml">file</a> |
<a href="/comm-central/annotate/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mail/base/content/search.xml">annotate</a> |
<a href="/comm-central/diff/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mail/base/content/search.xml">diff</a> |
<a href="/comm-central/comparison/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mail/base/content/search.xml">comparison</a> |
<a href="/comm-central/log/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mail/base/content/search.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mail/components/im/content/chat-messenger-overlay.xul">mail/components/im/content/chat-messenger-overlay.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mail/components/im/content/chat-messenger-overlay.xul">file</a> |
<a href="/comm-central/annotate/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mail/components/im/content/chat-messenger-overlay.xul">annotate</a> |
<a href="/comm-central/diff/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mail/components/im/content/chat-messenger-overlay.xul">diff</a> |
<a href="/comm-central/comparison/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mail/components/im/content/chat-messenger-overlay.xul">comparison</a> |
<a href="/comm-central/log/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mail/components/im/content/chat-messenger-overlay.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mail/components/im/content/chat.css">mail/components/im/content/chat.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mail/components/im/content/chat.css">file</a> |
<a href="/comm-central/annotate/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mail/components/im/content/chat.css">annotate</a> |
<a href="/comm-central/diff/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mail/components/im/content/chat.css">diff</a> |
<a href="/comm-central/comparison/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mail/components/im/content/chat.css">comparison</a> |
<a href="/comm-central/log/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mail/components/im/content/chat.css">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mail/components/im/content/imsearch.xml">mail/components/im/content/imsearch.xml</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mail/components/im/content/imsearch.xml">diff</a> |
<a href="/comm-central/comparison/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mail/components/im/content/imsearch.xml">comparison</a> |
<a href="/comm-central/log/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mail/components/im/content/imsearch.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mail/components/im/jar.mn">mail/components/im/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mail/components/im/jar.mn">file</a> |
<a href="/comm-central/annotate/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mail/components/im/jar.mn">annotate</a> |
<a href="/comm-central/diff/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mail/components/im/jar.mn">diff</a> |
<a href="/comm-central/comparison/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mail/components/im/jar.mn">comparison</a> |
<a href="/comm-central/log/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mail/components/im/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mail/components/im/modules/index_im.js">mail/components/im/modules/index_im.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mail/components/im/modules/index_im.js">file</a> |
<a href="/comm-central/annotate/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mail/components/im/modules/index_im.js">annotate</a> |
<a href="/comm-central/diff/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mail/components/im/modules/index_im.js">diff</a> |
<a href="/comm-central/comparison/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mail/components/im/modules/index_im.js">comparison</a> |
<a href="/comm-central/log/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mail/components/im/modules/index_im.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mail/locales/en-US/chrome/messenger/chat.dtd">mail/locales/en-US/chrome/messenger/chat.dtd</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mail/locales/en-US/chrome/messenger/chat.dtd">file</a> |
<a href="/comm-central/annotate/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mail/locales/en-US/chrome/messenger/chat.dtd">annotate</a> |
<a href="/comm-central/diff/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mail/locales/en-US/chrome/messenger/chat.dtd">diff</a> |
<a href="/comm-central/comparison/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mail/locales/en-US/chrome/messenger/chat.dtd">comparison</a> |
<a href="/comm-central/log/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mail/locales/en-US/chrome/messenger/chat.dtd">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mail/locales/en-US/chrome/messenger/glodaFacetView.properties">mail/locales/en-US/chrome/messenger/glodaFacetView.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mail/locales/en-US/chrome/messenger/glodaFacetView.properties">file</a> |
<a href="/comm-central/annotate/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mail/locales/en-US/chrome/messenger/glodaFacetView.properties">annotate</a> |
<a href="/comm-central/diff/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mail/locales/en-US/chrome/messenger/glodaFacetView.properties">diff</a> |
<a href="/comm-central/comparison/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mail/locales/en-US/chrome/messenger/glodaFacetView.properties">comparison</a> |
<a href="/comm-central/log/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mail/locales/en-US/chrome/messenger/glodaFacetView.properties">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mailnews/db/gloda/modules/datamodel.js">mailnews/db/gloda/modules/datamodel.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mailnews/db/gloda/modules/datamodel.js">file</a> |
<a href="/comm-central/annotate/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mailnews/db/gloda/modules/datamodel.js">annotate</a> |
<a href="/comm-central/diff/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mailnews/db/gloda/modules/datamodel.js">diff</a> |
<a href="/comm-central/comparison/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mailnews/db/gloda/modules/datamodel.js">comparison</a> |
<a href="/comm-central/log/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mailnews/db/gloda/modules/datamodel.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mailnews/db/gloda/modules/datastore.js">mailnews/db/gloda/modules/datastore.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mailnews/db/gloda/modules/datastore.js">file</a> |
<a href="/comm-central/annotate/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mailnews/db/gloda/modules/datastore.js">annotate</a> |
<a href="/comm-central/diff/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mailnews/db/gloda/modules/datastore.js">diff</a> |
<a href="/comm-central/comparison/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mailnews/db/gloda/modules/datastore.js">comparison</a> |
<a href="/comm-central/log/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mailnews/db/gloda/modules/datastore.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mailnews/db/gloda/modules/facet.js">mailnews/db/gloda/modules/facet.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mailnews/db/gloda/modules/facet.js">file</a> |
<a href="/comm-central/annotate/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mailnews/db/gloda/modules/facet.js">annotate</a> |
<a href="/comm-central/diff/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mailnews/db/gloda/modules/facet.js">diff</a> |
<a href="/comm-central/comparison/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mailnews/db/gloda/modules/facet.js">comparison</a> |
<a href="/comm-central/log/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mailnews/db/gloda/modules/facet.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mailnews/db/gloda/modules/fundattr.js">mailnews/db/gloda/modules/fundattr.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mailnews/db/gloda/modules/fundattr.js">file</a> |
<a href="/comm-central/annotate/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mailnews/db/gloda/modules/fundattr.js">annotate</a> |
<a href="/comm-central/diff/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mailnews/db/gloda/modules/fundattr.js">diff</a> |
<a href="/comm-central/comparison/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mailnews/db/gloda/modules/fundattr.js">comparison</a> |
<a href="/comm-central/log/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mailnews/db/gloda/modules/fundattr.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mailnews/db/gloda/modules/gloda.js">mailnews/db/gloda/modules/gloda.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mailnews/db/gloda/modules/gloda.js">file</a> |
<a href="/comm-central/annotate/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mailnews/db/gloda/modules/gloda.js">annotate</a> |
<a href="/comm-central/diff/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mailnews/db/gloda/modules/gloda.js">diff</a> |
<a href="/comm-central/comparison/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mailnews/db/gloda/modules/gloda.js">comparison</a> |
<a href="/comm-central/log/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mailnews/db/gloda/modules/gloda.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mailnews/db/gloda/modules/query.js">mailnews/db/gloda/modules/query.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mailnews/db/gloda/modules/query.js">file</a> |
<a href="/comm-central/annotate/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mailnews/db/gloda/modules/query.js">annotate</a> |
<a href="/comm-central/diff/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mailnews/db/gloda/modules/query.js">diff</a> |
<a href="/comm-central/comparison/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mailnews/db/gloda/modules/query.js">comparison</a> |
<a href="/comm-central/log/f31b8ad31c08269274a7c70e18aa97ec37674bd0/mailnews/db/gloda/modules/query.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/base/content/glodaFacetBindings.xml</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/base/content/glodaFacetBindings.xml</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -1400,18 +1400,23 @@</span>
<a href="#l1.4"></a><span id="l1.4">                                       outOfPluralFormat)</span>
<a href="#l1.5"></a><span id="l1.5">                                  .replace(&quot;#1&quot;, totalCount.toLocaleString());</span>
<a href="#l1.6"></a><span id="l1.6">         countNode.textContent = groupingFormat.replace(&quot;#1&quot;, topMessagesStr)</span>
<a href="#l1.7"></a><span id="l1.7">                                               .replace(&quot;#2&quot;, outOfStr);</span>
<a href="#l1.8"></a><span id="l1.8"> </span>
<a href="#l1.9"></a><span id="l1.9">         // -- Show All</span>
<a href="#l1.10"></a><span id="l1.10">         let showNode = document.getAnonymousElementByAttribute(</span>
<a href="#l1.11"></a><span id="l1.11">                           this, &quot;anonid&quot;, &quot;showall&quot;);</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+        const GlodaMessage = Gloda.lookupNounDef(&quot;message&quot;).clazz;</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+        let visble = aMessages.some(function(m) m instanceof GlodaMessage);</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+        showNode.style.display = visble ? &quot;inline&quot; : &quot;none&quot;;</span>
<a href="#l1.15"></a><span id="l1.15">         showNode.textContent = glodaFacetStrings.get(</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineminus">-          &quot;glodaFacetView.results.message.openAsList.label&quot;);</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+          &quot;glodaFacetView.results.message.openEmailAsList.label&quot;);</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+        showNode.setAttribute(&quot;title&quot;, glodaFacetStrings.get(</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+          &quot;glodaFacetView.results.message.openEmailAsList.tooltip&quot;));</span>
<a href="#l1.20"></a><span id="l1.20">         showNode.onkeypress = function(event) {</span>
<a href="#l1.21"></a><span id="l1.21">           if (event.charCode == KeyEvent.DOM_VK_SPACE) {</span>
<a href="#l1.22"></a><span id="l1.22">             FacetContext.showActiveSetInTab()</span>
<a href="#l1.23"></a><span id="l1.23">             event.preventDefault();</span>
<a href="#l1.24"></a><span id="l1.24">           }</span>
<a href="#l1.25"></a><span id="l1.25">         }</span>
<a href="#l1.26"></a><span id="l1.26"> </span>
<a href="#l1.27"></a><span id="l1.27">         let sortLabelNode = document.getAnonymousElementByAttribute(</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineat">@@ -1542,37 +1547,24 @@</span>
<a href="#l1.29"></a><span id="l1.29">         let message = this.message;</span>
<a href="#l1.30"></a><span id="l1.30">         let dis = this;</span>
<a href="#l1.31"></a><span id="l1.31">         function anonElem(aAnonId) {</span>
<a href="#l1.32"></a><span id="l1.32">           return document.getAnonymousElementByAttribute(dis, &quot;anonid&quot;,</span>
<a href="#l1.33"></a><span id="l1.33">                                                          aAnonId);</span>
<a href="#l1.34"></a><span id="l1.34">         }</span>
<a href="#l1.35"></a><span id="l1.35">         let subject = anonElem(&quot;subject&quot;);</span>
<a href="#l1.36"></a><span id="l1.36">         // -- eventify</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineminus">-        if (FacetContext.searcher instanceof GlodaIMSearcher) {</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineminus">-          subject.onclick = function(aEvent) {</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineminus">-            FacetContext.showIMConversationInTab(message,</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineminus">-                                                 aEvent.button == 1);</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineminus">-          }</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineminus">-          subject.onkeypress = function(aEvent) {</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineminus">-            if (aEvent.keyCode == aEvent.DOM_VK_RETURN)</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineminus">-              FacetContext.showIMConversationInTab(message,</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineminus">-                                                   aEvent.shiftKey == true);</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineminus">-          }</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineplus">+        subject.onclick = function(aEvent) {</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineplus">+          FacetContext.showConversationInTab(message,</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineplus">+                                             aEvent.button == 1);</span>
<a href="#l1.50"></a><span id="l1.50">         }</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineminus">-        else {</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineminus">-          subject.onclick = function(aEvent) {</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineplus">+        subject.onkeypress = function(aEvent) {</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineplus">+          if (aEvent.keyCode == aEvent.DOM_VK_RETURN)</span>
<a href="#l1.55"></a><span id="l1.55">             FacetContext.showConversationInTab(message,</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineminus">-                                               aEvent.button == 1);</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineminus">-          }</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineminus">-          subject.onkeypress = function(aEvent) {</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineminus">-            if (aEvent.keyCode == aEvent.DOM_VK_RETURN)</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineminus">-              FacetContext.showConversationInTab(message,</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineminus">-                                                 aEvent.shiftKey == true);</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineminus">-          }</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineplus">+                                               aEvent.shiftKey == true);</span>
<a href="#l1.64"></a><span id="l1.64">         }</span>
<a href="#l1.65"></a><span id="l1.65"> </span>
<a href="#l1.66"></a><span id="l1.66">         // -- Content Poking</span>
<a href="#l1.67"></a><span id="l1.67">         if (message.subject.trim() == &quot;&quot;)</span>
<a href="#l1.68"></a><span id="l1.68">           subject.textContent = glodaFacetStrings.get(&quot;glodaFacetView.result.message.noSubject&quot;);</span>
<a href="#l1.69"></a><span id="l1.69">         else</span>
<a href="#l1.70"></a><span id="l1.70">           subject.textContent = message.subject;</span>
<a href="#l1.71"></a><span id="l1.71">         let authorNode = anonElem(&quot;author&quot;);</span>
<a href="#l1.72"></a><span id="l1.72" class="difflineat">@@ -1663,17 +1655,22 @@</span>
<a href="#l1.73"></a><span id="l1.73">         }</span>
<a href="#l1.74"></a><span id="l1.74"> </span>
<a href="#l1.75"></a><span id="l1.75">         // - Body</span>
<a href="#l1.76"></a><span id="l1.76">         if (message.indexedBodyText) {</span>
<a href="#l1.77"></a><span id="l1.77">           let bodyText = message.indexedBodyText;</span>
<a href="#l1.78"></a><span id="l1.78"> </span>
<a href="#l1.79"></a><span id="l1.79">           let matches = [];</span>
<a href="#l1.80"></a><span id="l1.80">           if (&quot;stashedColumns&quot; in FacetContext.collection) {</span>
<a href="#l1.81"></a><span id="l1.81" class="difflineminus">-            let offsets = FacetContext.collection.stashedColumns[message.id][0];</span>
<a href="#l1.82"></a><span id="l1.82" class="difflineplus">+            let collection;</span>
<a href="#l1.83"></a><span id="l1.83" class="difflineplus">+            if (message instanceof Gloda.lookupNounDef(&quot;im-conversation&quot;).clazz)</span>
<a href="#l1.84"></a><span id="l1.84" class="difflineplus">+              collection = FacetContext.IMCollection;</span>
<a href="#l1.85"></a><span id="l1.85" class="difflineplus">+            else</span>
<a href="#l1.86"></a><span id="l1.86" class="difflineplus">+              collection = FacetContext.collection;</span>
<a href="#l1.87"></a><span id="l1.87" class="difflineplus">+            let offsets = collection.stashedColumns[message.id][0];</span>
<a href="#l1.88"></a><span id="l1.88">             let offsetNums = [parseInt(x) for each (x in offsets.split(&quot; &quot;))];</span>
<a href="#l1.89"></a><span id="l1.89">             for (let i = 0; i &lt; offsetNums.length; i += 4) {</span>
<a href="#l1.90"></a><span id="l1.90">               // i is the column index. The indexedBodyText is in the column 0.</span>
<a href="#l1.91"></a><span id="l1.91">               // Ignore matches for other columns.</span>
<a href="#l1.92"></a><span id="l1.92">               if (offsetNums[i] != 0)</span>
<a href="#l1.93"></a><span id="l1.93">                 continue;</span>
<a href="#l1.94"></a><span id="l1.94"> </span>
<a href="#l1.95"></a><span id="l1.95">               // i+1 is the term index, indicating which queried term was found.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/base/content/glodaFacetTab.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/base/content/glodaFacetTab.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -40,16 +40,21 @@ var glodaFacetTabType = {</span>
<a href="#l2.4"></a><span id="l2.4"> </span>
<a href="#l2.5"></a><span id="l2.5">       aTab.title = this.strings.get(&quot;glodaFacetView.tab.query.label&quot;);</span>
<a href="#l2.6"></a><span id="l2.6">       aTab.searchString = null;</span>
<a href="#l2.7"></a><span id="l2.7">     }</span>
<a href="#l2.8"></a><span id="l2.8">     else if (&quot;searcher&quot; in aArgs) {</span>
<a href="#l2.9"></a><span id="l2.9">       aTab.searcher = aArgs.searcher;</span>
<a href="#l2.10"></a><span id="l2.10">       aTab.collection = aTab.searcher.getCollection();</span>
<a href="#l2.11"></a><span id="l2.11">       aTab.query = aTab.searcher.query;</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+      if (&quot;IMSearcher&quot; in aArgs) {</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+        aTab.IMSearcher = aArgs.IMSearcher;</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+        aTab.IMCollection = aArgs.IMSearcher.getCollection();</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+        aTab.IMQuery = aTab.IMSearcher.query;</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+      }</span>
<a href="#l2.17"></a><span id="l2.17"> </span>
<a href="#l2.18"></a><span id="l2.18">       let searchString = aTab.searcher.searchString;</span>
<a href="#l2.19"></a><span id="l2.19">       aTab.title = aTab.searchInputValue = aTab.searchString =</span>
<a href="#l2.20"></a><span id="l2.20">         searchString;</span>
<a href="#l2.21"></a><span id="l2.21">     }</span>
<a href="#l2.22"></a><span id="l2.22">     else if (&quot;collection&quot; in aArgs) {</span>
<a href="#l2.23"></a><span id="l2.23">       aTab.collection = aArgs.collection;</span>
<a href="#l2.24"></a><span id="l2.24"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/base/content/glodaFacetView.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/base/content/glodaFacetView.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -324,25 +324,17 @@ ActiveNonSingularConstraint.prototype = </span>
<a href="#l3.4"></a><span id="l3.4">   },</span>
<a href="#l3.5"></a><span id="l3.5">   isExcludedGroup: function(aGroupValue) {</span>
<a href="#l3.6"></a><span id="l3.6">     let valId = aGroupValue[this.facetDef.groupIdAttr];</span>
<a href="#l3.7"></a><span id="l3.7">     return (valId in this.excludedGroupIds);</span>
<a href="#l3.8"></a><span id="l3.8">   }</span>
<a href="#l3.9"></a><span id="l3.9"> };</span>
<a href="#l3.10"></a><span id="l3.10"> </span>
<a href="#l3.11"></a><span id="l3.11"> var FacetContext = {</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-  get facetDriver() {</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-    if (!(&quot;GlodaIMSearcher&quot; in window))</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-      Cu.import(&quot;resource:///modules/search_im.js&quot;);</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">-    let nounName =</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineminus">-      this.searcher instanceof GlodaIMSearcher ? &quot;im-conversation&quot; : &quot;message&quot;;</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineminus">-    delete this.facetDriver;</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineminus">-    this.facetDriver = new FacetDriver(Gloda.lookupNounDef(nounName), window);</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineminus">-    return this.facetDriver;</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineminus">-  },</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+  facetDriver: new FacetDriver(Gloda.lookupNounDef(&quot;message&quot;), window),</span>
<a href="#l3.22"></a><span id="l3.22"> </span>
<a href="#l3.23"></a><span id="l3.23">   /**</span>
<a href="#l3.24"></a><span id="l3.24">    * The root collection which our active set is a subset of.  We hold onto this</span>
<a href="#l3.25"></a><span id="l3.25">    *  for garbage collection reasons, although the tab that owns us should also</span>
<a href="#l3.26"></a><span id="l3.26">    *  be holding on.</span>
<a href="#l3.27"></a><span id="l3.27">    */</span>
<a href="#l3.28"></a><span id="l3.28">   _collection: null,</span>
<a href="#l3.29"></a><span id="l3.29">   set collection(aCollection) {</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineat">@@ -415,16 +407,18 @@ var FacetContext = {</span>
<a href="#l3.31"></a><span id="l3.31"> </span>
<a href="#l3.32"></a><span id="l3.32">     this.everFaceted = false;</span>
<a href="#l3.33"></a><span id="l3.33">     this._activeConstraints = {};</span>
<a href="#l3.34"></a><span id="l3.34">     if (this.searcher)</span>
<a href="#l3.35"></a><span id="l3.35">       this._sortBy = '-dascore';</span>
<a href="#l3.36"></a><span id="l3.36">     else</span>
<a href="#l3.37"></a><span id="l3.37">       this._sortBy = '-date';</span>
<a href="#l3.38"></a><span id="l3.38">     this.fullSet = this._removeDupes(this._collection.items.concat());</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+    if (&quot;IMCollection&quot; in this)</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+      this.fullSet = this.fullSet.concat(this.IMCollection.items);</span>
<a href="#l3.41"></a><span id="l3.41">     this.build(this.fullSet);</span>
<a href="#l3.42"></a><span id="l3.42">   },</span>
<a href="#l3.43"></a><span id="l3.43"> </span>
<a href="#l3.44"></a><span id="l3.44">   /**</span>
<a href="#l3.45"></a><span id="l3.45">    * Remove duplicate messages from search results.</span>
<a href="#l3.46"></a><span id="l3.46">    *</span>
<a href="#l3.47"></a><span id="l3.47">    * @param aItems the initial set of messages to deduplicate</span>
<a href="#l3.48"></a><span id="l3.48">    * @return the subset of those, with duplicates removed.</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineat">@@ -838,40 +832,33 @@ var FacetContext = {</span>
<a href="#l3.50"></a><span id="l3.50">   /**</span>
<a href="#l3.51"></a><span id="l3.51">    * Show the conversation in a new glodaList tab.</span>
<a href="#l3.52"></a><span id="l3.52">    *</span>
<a href="#l3.53"></a><span id="l3.53">    * @param {GlodaConversation} aConversation The conversation to show.</span>
<a href="#l3.54"></a><span id="l3.54">    * @param {Boolean} [aBackground] Whether it should be in the background.</span>
<a href="#l3.55"></a><span id="l3.55">    */</span>
<a href="#l3.56"></a><span id="l3.56">   showConversationInTab: function(aMessage, aBackground) {</span>
<a href="#l3.57"></a><span id="l3.57">     let tabmail = this.rootWin.document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineplus">+    if (aMessage instanceof Gloda.lookupNounDef(&quot;im-conversation&quot;).clazz) {</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineplus">+      tabmail.openTab(&quot;chat&quot;, {</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineplus">+        convType: &quot;log&quot;,</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineplus">+        conv: aMessage,</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineplus">+        background: aBackground</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineplus">+      });</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineplus">+      return;</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineplus">+    }</span>
<a href="#l3.66"></a><span id="l3.66">     tabmail.openTab(&quot;glodaList&quot;, {</span>
<a href="#l3.67"></a><span id="l3.67">       conversation: aMessage.conversation,</span>
<a href="#l3.68"></a><span id="l3.68">       message: aMessage,</span>
<a href="#l3.69"></a><span id="l3.69">       title: aMessage.conversation.subject,</span>
<a href="#l3.70"></a><span id="l3.70">       background: aBackground</span>
<a href="#l3.71"></a><span id="l3.71">     });</span>
<a href="#l3.72"></a><span id="l3.72">   },</span>
<a href="#l3.73"></a><span id="l3.73"> </span>
<a href="#l3.74"></a><span id="l3.74">   /**</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineminus">-   * Show the conversation in a new glodaList tab.</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineminus">-   *</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineminus">-   * @param {GlodaIMConversation} aConversation The conversation to show.</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineminus">-   * @param {Boolean} [aBackground] Whether it should be in the background.</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineminus">-   */</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineminus">-  showIMConversationInTab: function(aConversation, aBackground) {</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineminus">-    let tabmail = this.rootWin.document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineminus">-    tabmail.openTab(&quot;chat&quot;, {</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineminus">-      convType: &quot;log&quot;,</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineminus">-      conv: aConversation,</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineminus">-      background: aBackground</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineminus">-    });</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineminus">-  },</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineminus">-</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineminus">-  /**</span>
<a href="#l3.90"></a><span id="l3.90">    * Show the message in a new tab.</span>
<a href="#l3.91"></a><span id="l3.91">    *</span>
<a href="#l3.92"></a><span id="l3.92">    * @param {GlodaMessage} aMessage The message to show.</span>
<a href="#l3.93"></a><span id="l3.93">    * @param {Boolean} [aBackground] Whether it should be in the background.</span>
<a href="#l3.94"></a><span id="l3.94">    */</span>
<a href="#l3.95"></a><span id="l3.95">   showMessageInTab: function(aMessage, aBackground) {</span>
<a href="#l3.96"></a><span id="l3.96">     let tabmail = this.rootWin.document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l3.97"></a><span id="l3.97">     let msgHdr = aMessage.folderMessage;</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineat">@@ -885,17 +872,19 @@ var FacetContext = {</span>
<a href="#l3.99"></a><span id="l3.99"> </span>
<a href="#l3.100"></a><span id="l3.100">   onItemsAdded: function(aItems, aCollection) {</span>
<a href="#l3.101"></a><span id="l3.101">   },</span>
<a href="#l3.102"></a><span id="l3.102">   onItemsModified: function(aItems, aCollection) {</span>
<a href="#l3.103"></a><span id="l3.103">   },</span>
<a href="#l3.104"></a><span id="l3.104">   onItemsRemoved: function(aItems, aCollection) {</span>
<a href="#l3.105"></a><span id="l3.105">   },</span>
<a href="#l3.106"></a><span id="l3.106">   onQueryCompleted: function(aCollection) {</span>
<a href="#l3.107"></a><span id="l3.107" class="difflineminus">-    this.initialBuild();</span>
<a href="#l3.108"></a><span id="l3.108" class="difflineplus">+    if (this.tab.query.completed &amp;&amp;</span>
<a href="#l3.109"></a><span id="l3.109" class="difflineplus">+        (!(&quot;IMQuery&quot; in aTab) || this.tab.IMQuery.completed))</span>
<a href="#l3.110"></a><span id="l3.110" class="difflineplus">+      this.initialBuild();</span>
<a href="#l3.111"></a><span id="l3.111">   }</span>
<a href="#l3.112"></a><span id="l3.112"> };</span>
<a href="#l3.113"></a><span id="l3.113"> </span>
<a href="#l3.114"></a><span id="l3.114"> /**</span>
<a href="#l3.115"></a><span id="l3.115">  * addEventListener betrayals compel us to establish our link with the</span>
<a href="#l3.116"></a><span id="l3.116">  *  outside world from inside.  NeilAway suggests the problem might have</span>
<a href="#l3.117"></a><span id="l3.117">  *  been the registration of the listener prior to initiating the load.  Which</span>
<a href="#l3.118"></a><span id="l3.118">  *  is odd considering it works for the XUL case, but I could see how that might</span>
<a href="#l3.119"></a><span id="l3.119" class="difflineat">@@ -912,31 +901,37 @@ function reachOutAndTouchFrame() {</span>
<a href="#l3.120"></a><span id="l3.120"> </span>
<a href="#l3.121"></a><span id="l3.121">   let parentWin = us.parent</span>
<a href="#l3.122"></a><span id="l3.122">                     .QueryInterface(Ci.nsIInterfaceRequestor)</span>
<a href="#l3.123"></a><span id="l3.123">                     .getInterface(Ci.nsIDOMWindow);</span>
<a href="#l3.124"></a><span id="l3.124">   let aTab = FacetContext.tab = parentWin.tab;</span>
<a href="#l3.125"></a><span id="l3.125">   parentWin.tab = null;</span>
<a href="#l3.126"></a><span id="l3.126">   $(window).resize(function() {</span>
<a href="#l3.127"></a><span id="l3.127">     document.getElementById(&quot;facet-date&quot;).build(true);</span>
<a href="#l3.128"></a><span id="l3.128" class="difflineminus">-  })</span>
<a href="#l3.129"></a><span id="l3.129" class="difflineplus">+  });</span>
<a href="#l3.130"></a><span id="l3.130">   // we need to hook the context up as a listener in all cases since</span>
<a href="#l3.131"></a><span id="l3.131">   //  removal notifications are required.</span>
<a href="#l3.132"></a><span id="l3.132">   if (&quot;searcher&quot; in aTab) {</span>
<a href="#l3.133"></a><span id="l3.133">     FacetContext.searcher = aTab.searcher;</span>
<a href="#l3.134"></a><span id="l3.134">     aTab.searcher.listener = FacetContext;</span>
<a href="#l3.135"></a><span id="l3.135" class="difflineplus">+    if (&quot;IMSearcher&quot; in aTab) {</span>
<a href="#l3.136"></a><span id="l3.136" class="difflineplus">+      FacetContext.IMSearcher = aTab.IMSearcher;</span>
<a href="#l3.137"></a><span id="l3.137" class="difflineplus">+      aTab.IMSearcher.listener = FacetContext;</span>
<a href="#l3.138"></a><span id="l3.138" class="difflineplus">+    }</span>
<a href="#l3.139"></a><span id="l3.139">   }</span>
<a href="#l3.140"></a><span id="l3.140">   else {</span>
<a href="#l3.141"></a><span id="l3.141">     FacetContext.searcher = null;</span>
<a href="#l3.142"></a><span id="l3.142">     aTab.collection.listener = FacetContext;</span>
<a href="#l3.143"></a><span id="l3.143">   }</span>
<a href="#l3.144"></a><span id="l3.144">   FacetContext.collection = aTab.collection;</span>
<a href="#l3.145"></a><span id="l3.145" class="difflineplus">+  if (&quot;IMCollection&quot; in aTab)</span>
<a href="#l3.146"></a><span id="l3.146" class="difflineplus">+    FacetContext.IMCollection = aTab.IMCollection;</span>
<a href="#l3.147"></a><span id="l3.147"> </span>
<a href="#l3.148"></a><span id="l3.148">   // if it has already completed, we need to prod things</span>
<a href="#l3.149"></a><span id="l3.149" class="difflineminus">-  if (aTab.query.completed)</span>
<a href="#l3.150"></a><span id="l3.150" class="difflineplus">+  if (aTab.query.completed &amp;&amp; (!(&quot;IMQuery&quot; in aTab) || aTab.IMQuery.completed))</span>
<a href="#l3.151"></a><span id="l3.151">     FacetContext.initialBuild();</span>
<a href="#l3.152"></a><span id="l3.152"> }</span>
<a href="#l3.153"></a><span id="l3.153"> </span>
<a href="#l3.154"></a><span id="l3.154"> function clickOnBody(event) {</span>
<a href="#l3.155"></a><span id="l3.155">   if (event.bubbles) {</span>
<a href="#l3.156"></a><span id="l3.156">     document.getElementById('popup-menu').hide();</span>
<a href="#l3.157"></a><span id="l3.157">   }</span>
<a href="#l3.158"></a><span id="l3.158">   return 0;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/base/content/search.xml</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/base/content/search.xml</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -281,19 +281,28 @@</span>
<a href="#l4.4"></a><span id="l4.4">               if (tabmail.currentTabInfo.mode.name == &quot;glodaFacet&quot;) {</span>
<a href="#l4.5"></a><span id="l4.5">                 // we'd rather reuse the existing tab (and somehow do something</span>
<a href="#l4.6"></a><span id="l4.6">                 // smart with any preexisting facet choices, but that's a</span>
<a href="#l4.7"></a><span id="l4.7">                 // bit hard right now, so doing the cheap thing and closing</span>
<a href="#l4.8"></a><span id="l4.8">                 // this tab and starting over</span>
<a href="#l4.9"></a><span id="l4.9">                 tabmail.closeTab();</span>
<a href="#l4.10"></a><span id="l4.10">               }</span>
<a href="#l4.11"></a><span id="l4.11">               this.value = ''; // clear our value, to avoid persistence</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-              tabmail.openTab(&quot;glodaFacet&quot;, {</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+              let args = {</span>
<a href="#l4.14"></a><span id="l4.14">                 searcher: new GlodaMsgSearcher(null, searchString)</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineminus">-              });</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+              };</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+              let prefBranch =</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+                Components.classes['@mozilla.org/preferences-service;1'].</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+                getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+              if (prefBranch.getBoolPref(&quot;mail.chat.enabled&quot;)) {</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+                if (!(&quot;GlodaIMSearcher&quot; in window))</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+                  Cu.import(&quot;resource:///modules/search_im.js&quot;);</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineplus">+                args.IMSearcher = new GlodaIMSearcher(null, searchString);</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineplus">+              }</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineplus">+              tabmail.openTab(&quot;glodaFacet&quot;, args);</span>
<a href="#l4.26"></a><span id="l4.26">             }</span>
<a href="#l4.27"></a><span id="l4.27">           } catch (e) {</span>
<a href="#l4.28"></a><span id="l4.28">             logException(e);</span>
<a href="#l4.29"></a><span id="l4.29">           }</span>
<a href="#l4.30"></a><span id="l4.30">         ]]&gt;</span>
<a href="#l4.31"></a><span id="l4.31">         &lt;/body&gt;</span>
<a href="#l4.32"></a><span id="l4.32">       &lt;/method&gt;</span>
<a href="#l4.33"></a><span id="l4.33">       &lt;method name=&quot;clearSearch&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/components/im/content/chat-messenger-overlay.xul</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/components/im/content/chat-messenger-overlay.xul</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -182,17 +182,17 @@</span>
<a href="#l5.4"></a><span id="l5.4">             &lt;textbox id=&quot;IMSearchInput&quot; </span>
<a href="#l5.5"></a><span id="l5.5">                      flex=&quot;1&quot;</span>
<a href="#l5.6"></a><span id="l5.6">                      type=&quot;glodacomplete&quot;</span>
<a href="#l5.7"></a><span id="l5.7">                      searchbutton=&quot;true&quot;</span>
<a href="#l5.8"></a><span id="l5.8">                      enablehistory=&quot;false&quot;</span>
<a href="#l5.9"></a><span id="l5.9">                      timeout=&quot;200&quot;</span>
<a href="#l5.10"></a><span id="l5.10">                      maxlength=&quot;192&quot;</span>
<a href="#l5.11"></a><span id="l5.11">                      placeholder=&quot;&quot;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-                     emptytextbase=&quot;&amp;searchAllChatMessages.label.base;&quot;</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+                     emptytextbase=&quot;&amp;search.label.base;&quot;</span>
<a href="#l5.14"></a><span id="l5.14">                      keyLabelNonMac=&quot;&amp;search.keyLabel.nonmac;&quot;</span>
<a href="#l5.15"></a><span id="l5.15">                      keyLabelMac=&quot;&amp;search.keyLabel.mac;&quot;</span>
<a href="#l5.16"></a><span id="l5.16">                      &gt;</span>
<a href="#l5.17"></a><span id="l5.17">               &lt;!-- Mimic the search/clear buttons of the standard search textbox,</span>
<a href="#l5.18"></a><span id="l5.18">                    but adjust for the reality that clear doesn't make much sense</span>
<a href="#l5.19"></a><span id="l5.19">                    since gloda results only show in a tab and the idiom for closing</span>
<a href="#l5.20"></a><span id="l5.20">                    tabs is closing the tab.  Our binding does process escape to</span>
<a href="#l5.21"></a><span id="l5.21">                    clear the box, if people want to clear it that way...</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/components/im/content/chat.css</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/components/im/content/chat.css</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -81,17 +81,17 @@ browser[type=&quot;content-conversation&quot;] {</span>
<a href="#l6.4"></a><span id="l6.4">   display: none;</span>
<a href="#l6.5"></a><span id="l6.5"> }</span>
<a href="#l6.6"></a><span id="l6.6"> </span>
<a href="#l6.7"></a><span id="l6.7"> .conv-top-info {</span>
<a href="#l6.8"></a><span id="l6.8">   -moz-binding: url(&quot;chrome://messenger/content/chat/imconversation.xml#conv-info-large&quot;) !important;</span>
<a href="#l6.9"></a><span id="l6.9"> }</span>
<a href="#l6.10"></a><span id="l6.10"> </span>
<a href="#l6.11"></a><span id="l6.11"> #IMSearchInput {</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-  -moz-binding: url(&quot;chrome://messenger/content/chat/imsearch.xml#IMGlodaSearch&quot;);</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+  -moz-binding: url(&quot;chrome://messenger/content/search.xml#glodaSearch&quot;);</span>
<a href="#l6.14"></a><span id="l6.14"> }</span>
<a href="#l6.15"></a><span id="l6.15"> </span>
<a href="#l6.16"></a><span id="l6.16"> </span>
<a href="#l6.17"></a><span id="l6.17"> #statusTypeIcon {</span>
<a href="#l6.18"></a><span id="l6.18">   cursor: pointer;</span>
<a href="#l6.19"></a><span id="l6.19"> }</span>
<a href="#l6.20"></a><span id="l6.20"> </span>
<a href="#l6.21"></a><span id="l6.21"> #statusMessage {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1">deleted file mode 100644</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineminus">--- a/mail/components/im/content/imsearch.xml</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineplus">+++ /dev/null</span>
<a href="#l7.4"></a><span id="l7.4" class="difflineat">@@ -1,258 +0,0 @@</span>
<a href="#l7.5"></a><span id="l7.5" class="difflineminus">-&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<a href="#l7.6"></a><span id="l7.6" class="difflineminus">-</span>
<a href="#l7.7"></a><span id="l7.7" class="difflineminus">-&lt;!-- ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l7.8"></a><span id="l7.8" class="difflineminus">-  - Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l7.9"></a><span id="l7.9" class="difflineminus">-  -</span>
<a href="#l7.10"></a><span id="l7.10" class="difflineminus">-  - The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l7.11"></a><span id="l7.11" class="difflineminus">-  - 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-  - the License. You may obtain a copy of the License at</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-  - http://www.mozilla.org/MPL/</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineminus">-  -</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineminus">-  - Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineminus">-  - WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineminus">-  - for the specific language governing rights and limitations under the</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineminus">-  - License.</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineminus">-  -</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineminus">-  - The Original Code is Mozilla Communicator client code, released</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineminus">-  - March 31, 1998.</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineminus">-  -</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineminus">-  - The Initial Developer of the Original Code is</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineminus">-  - Netscape Communications Corporation.</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineminus">-  - Portions created by the Initial Developer are Copyright (C) 1998-1999</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineminus">-  - the Initial Developer. All Rights Reserved.</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineminus">-  -</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineminus">-  - Contributor(s):</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineminus">-  -   Scott MacGregor &lt;mscott@mozilla.org&gt;</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineminus">-  -   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">-  -   David Ascher &lt;dascher@mozillamessaging.com&gt;</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineminus">-  -   Thomas Dllmann &lt;bugzilla2009@duellmann24.net&gt;</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineminus">-  -</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineminus">-  - Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineminus">-  - either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineminus">-  - or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineminus">-  - in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineminus">-  - of those above. If you wish to allow use of your version of this file only</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineminus">-  - under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineminus">-  - use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineminus">-  - decision by deleting the provisions above and replace them with the notice</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineminus">-  - and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineminus">-  - the provisions above, a recipient may use your version of this file under</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineminus">-  - the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineminus">-  - ***** END LICENSE BLOCK ***** --&gt;</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineminus">-</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineminus">-&lt;!DOCTYPE bindings [</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineminus">-&lt;!ENTITY % messengerDTD SYSTEM &quot;chrome://messenger/locale/messenger.dtd&quot;&gt;</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineminus">-%messengerDTD;</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineminus">-]&gt;</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineminus">-</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineminus">-&lt;bindings id=&quot;SearchBindings&quot;</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineminus">-   xmlns=&quot;http://www.mozilla.org/xbl&quot;</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineminus">-   xmlns:html=&quot;http://www.w3.org/1999/xhtml&quot;</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineminus">-   xmlns:xul=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineminus">-   xmlns:xbl=&quot;http://www.mozilla.org/xbl&quot;&gt;</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineminus">-</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineminus">-  &lt;!--</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineminus">-    - The glodaSearch binding implements a gloda-backed search mechanism.  The</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineminus">-    -  actual search logic comes from the glodaFacet tab mode in the</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineminus">-    -  glodaFacetTabType definition.  This binding serves as a means to display</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineminus">-    -  and alter the current search query if a &quot;glodaFacet&quot; tab is displayed,</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineminus">-    -  or enter a search query and spawn a new &quot;glodaFacet&quot; tab if one is</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineminus">-    -  currently not displayed.</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineminus">-    -</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineminus">-    - This widget used to have many weird implementation nuances.  Now we are</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineminus">-    -  just a little bit of extra stuff on top of the toolkit autocomplete</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineminus">-    -  implementation.  Our deviations are:</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineminus">-    -  - We collapse ourselves when gloda is disabled; we track the state.</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineminus">-    -  -</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineminus">-    --&gt;</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineminus">-  &lt;binding id=&quot;IMGlodaSearch&quot;</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineminus">-           extends=&quot;chrome://global/content/bindings/autocomplete.xml#autocomplete&quot;&gt;</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineminus">-    &lt;resources&gt;</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineminus">-      &lt;stylesheet src=&quot;chrome://messenger/skin/searchBox.css&quot;/&gt;</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineminus">-    &lt;/resources&gt;</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineminus">-</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineminus">-    &lt;handlers&gt;</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineminus">-      &lt;handler event=&quot;drop&quot; phase=&quot;capturing&quot;&gt;&lt;![CDATA[</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineminus">-        nsDragAndDrop.drop(event, this.searchInputDNDObserver);</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineminus">-      ]]&gt;&lt;/handler&gt;</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineminus">-</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineminus">-      &lt;handler event=&quot;keypress&quot; keycode=&quot;VK_RETURN&quot;&gt;&lt;![CDATA[</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineminus">-        this.doSearch();</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineminus">-        event.preventDefault();</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineminus">-        event.stopPropagation();</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineminus">-      ]]&gt;&lt;/handler&gt;</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineminus">-      &lt;handler event=&quot;keypress&quot; keycode=&quot;VK_ESCAPE&quot;&gt;&lt;![CDATA[</span>
<a href="#l7.89"></a><span id="l7.89" class="difflineminus">-        this.clearSearch();</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineminus">-        event.preventDefault();</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineminus">-        event.stopPropagation();</span>
<a href="#l7.92"></a><span id="l7.92" class="difflineminus">-      ]]&gt;&lt;/handler&gt;</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineminus">-    &lt;/handlers&gt;</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineminus">-</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineminus">-    &lt;implementation implements=&quot;nsIObserver&quot;&gt;</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineminus">-      &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l7.97"></a><span id="l7.97" class="difflineminus">-        const Cc = Components.classes;</span>
<a href="#l7.98"></a><span id="l7.98" class="difflineminus">-        const Ci = Components.interfaces;</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineminus">-        const Cu = Components.utils;</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineminus">-        Cu.import(&quot;resource:///modules/errUtils.js&quot;);</span>
<a href="#l7.101"></a><span id="l7.101" class="difflineminus">-        try {</span>
<a href="#l7.102"></a><span id="l7.102" class="difflineminus">-          this.setAttribute(</span>
<a href="#l7.103"></a><span id="l7.103" class="difflineminus">-            &quot;placeholder&quot;,</span>
<a href="#l7.104"></a><span id="l7.104" class="difflineminus">-            this.getAttribute(&quot;emptytextbase&quot;)</span>
<a href="#l7.105"></a><span id="l7.105" class="difflineminus">-                 .replace(&quot;#1&quot;, this.getAttribute(</span>
<a href="#l7.106"></a><span id="l7.106" class="difflineminus">-                                  Application.platformIsMac ?</span>
<a href="#l7.107"></a><span id="l7.107" class="difflineminus">-                                  &quot;keyLabelMac&quot; : &quot;keyLabelNonMac&quot;)));</span>
<a href="#l7.108"></a><span id="l7.108" class="difflineminus">-</span>
<a href="#l7.109"></a><span id="l7.109" class="difflineminus">-          var prefBranch =</span>
<a href="#l7.110"></a><span id="l7.110" class="difflineminus">-              Components.classes['@mozilla.org/preferences-service;1'].</span>
<a href="#l7.111"></a><span id="l7.111" class="difflineminus">-              getService(Components.interfaces.nsIPrefBranch2);</span>
<a href="#l7.112"></a><span id="l7.112" class="difflineminus">-</span>
<a href="#l7.113"></a><span id="l7.113" class="difflineminus">-          if (typeof gSearchInputObserversRegistered != &quot;undefined&quot;) {</span>
<a href="#l7.114"></a><span id="l7.114" class="difflineminus">-            // due to a bug in XBL that means that destructors don't get</span>
<a href="#l7.115"></a><span id="l7.115" class="difflineminus">-            // called reliably, the customize toolbar path will end up creating</span>
<a href="#l7.116"></a><span id="l7.116" class="difflineminus">-            // two clones of this widget, and never destroy them.  So the destructor</span>
<a href="#l7.117"></a><span id="l7.117" class="difflineminus">-            // isn't reliably called, and so we must use a global to avoid</span>
<a href="#l7.118"></a><span id="l7.118" class="difflineminus">-            // registering ourselves for the same event multiple times (twice</span>
<a href="#l7.119"></a><span id="l7.119" class="difflineminus">-            // per invocation of the customize-toolbar).</span>
<a href="#l7.120"></a><span id="l7.120" class="difflineminus">-</span>
<a href="#l7.121"></a><span id="l7.121" class="difflineminus">-            // We need to test for undefined above because if the widget is</span>
<a href="#l7.122"></a><span id="l7.122" class="difflineminus">-            // created from the customize toolbar, its namespace won't include</span>
<a href="#l7.123"></a><span id="l7.123" class="difflineminus">-            // a definition of gSearchInputObserversRegistered -- and we don't</span>
<a href="#l7.124"></a><span id="l7.124" class="difflineminus">-            // care, since we don't want to register observers in that scope.</span>
<a href="#l7.125"></a><span id="l7.125" class="difflineminus">-</span>
<a href="#l7.126"></a><span id="l7.126" class="difflineminus">-            prefBranch.addObserver(&quot;mailnews.database.global.indexer.enabled&quot;,</span>
<a href="#l7.127"></a><span id="l7.127" class="difflineminus">-                                   this._prefObserver, false);</span>
<a href="#l7.128"></a><span id="l7.128" class="difflineminus">-          }</span>
<a href="#l7.129"></a><span id="l7.129" class="difflineminus">-</span>
<a href="#l7.130"></a><span id="l7.130" class="difflineminus">-          this.glodaEnabled =</span>
<a href="#l7.131"></a><span id="l7.131" class="difflineminus">-            prefBranch.getBoolPref(&quot;mailnews.database.global.indexer.enabled&quot;);</span>
<a href="#l7.132"></a><span id="l7.132" class="difflineminus">-          this.collapsed = !this.glodaEnabled;</span>
<a href="#l7.133"></a><span id="l7.133" class="difflineminus">-</span>
<a href="#l7.134"></a><span id="l7.134" class="difflineminus">-          // make sure we set our emptytext here from the get-go</span>
<a href="#l7.135"></a><span id="l7.135" class="difflineminus">-        if (this.hasAttribute(&quot;placeholder&quot;))</span>
<a href="#l7.136"></a><span id="l7.136" class="difflineminus">-          this.placeholder = this.getAttribute(&quot;placeholder&quot;);</span>
<a href="#l7.137"></a><span id="l7.137" class="difflineminus">-        } catch (e) {</span>
<a href="#l7.138"></a><span id="l7.138" class="difflineminus">-          logException(e, true);</span>
<a href="#l7.139"></a><span id="l7.139" class="difflineminus">-        }</span>
<a href="#l7.140"></a><span id="l7.140" class="difflineminus">-      ]]&gt;&lt;/constructor&gt;</span>
<a href="#l7.141"></a><span id="l7.141" class="difflineminus">-</span>
<a href="#l7.142"></a><span id="l7.142" class="difflineminus">-      &lt;destructor&gt;</span>
<a href="#l7.143"></a><span id="l7.143" class="difflineminus">-        &lt;![CDATA[</span>
<a href="#l7.144"></a><span id="l7.144" class="difflineminus">-          var prefBranch =</span>
<a href="#l7.145"></a><span id="l7.145" class="difflineminus">-              Components.classes['@mozilla.org/preferences-service;1'].</span>
<a href="#l7.146"></a><span id="l7.146" class="difflineminus">-              getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l7.147"></a><span id="l7.147" class="difflineminus">-          prefBranch.removeObserver(&quot;mailnews.database.global.indexer.enabled&quot;,</span>
<a href="#l7.148"></a><span id="l7.148" class="difflineminus">-                                    this._prefObserver);</span>
<a href="#l7.149"></a><span id="l7.149" class="difflineminus">-        ]]&gt;</span>
<a href="#l7.150"></a><span id="l7.150" class="difflineminus">-      &lt;/destructor&gt;</span>
<a href="#l7.151"></a><span id="l7.151" class="difflineminus">-</span>
<a href="#l7.152"></a><span id="l7.152" class="difflineminus">-      &lt;field name=&quot;_prefObserver&quot;&gt;({</span>
<a href="#l7.153"></a><span id="l7.153" class="difflineminus">-        inputSearch: this,</span>
<a href="#l7.154"></a><span id="l7.154" class="difflineminus">-        observe: function(subject, topic, data)</span>
<a href="#l7.155"></a><span id="l7.155" class="difflineminus">-        {</span>
<a href="#l7.156"></a><span id="l7.156" class="difflineminus">-          if (topic == &quot;nsPref:changed&quot;) {</span>
<a href="#l7.157"></a><span id="l7.157" class="difflineminus">-            subject.QueryInterface(Components.interfaces.nsIPrefBranch);</span>
<a href="#l7.158"></a><span id="l7.158" class="difflineminus">-            switch (data) {</span>
<a href="#l7.159"></a><span id="l7.159" class="difflineminus">-            case &quot;mailnews.database.global.indexer.enabled&quot;:</span>
<a href="#l7.160"></a><span id="l7.160" class="difflineminus">-              this.inputSearch.glodaEnabled =</span>
<a href="#l7.161"></a><span id="l7.161" class="difflineminus">-                gPrefBranch.getBoolPref(</span>
<a href="#l7.162"></a><span id="l7.162" class="difflineminus">-                  &quot;mailnews.database.global.indexer.enabled&quot;);</span>
<a href="#l7.163"></a><span id="l7.163" class="difflineminus">-              this.inputSearch.collapsed = !this.inputSearch.glodaEnabled;</span>
<a href="#l7.164"></a><span id="l7.164" class="difflineminus">-              break;</span>
<a href="#l7.165"></a><span id="l7.165" class="difflineminus">-            }</span>
<a href="#l7.166"></a><span id="l7.166" class="difflineminus">-          }</span>
<a href="#l7.167"></a><span id="l7.167" class="difflineminus">-        },</span>
<a href="#l7.168"></a><span id="l7.168" class="difflineminus">-</span>
<a href="#l7.169"></a><span id="l7.169" class="difflineminus">-        QueryInterface: function(aIID)</span>
<a href="#l7.170"></a><span id="l7.170" class="difflineminus">-        {</span>
<a href="#l7.171"></a><span id="l7.171" class="difflineminus">-          if (aIID.equals(Components.interfaces.nsIObserver) ||</span>
<a href="#l7.172"></a><span id="l7.172" class="difflineminus">-              aIID.equals(Components.interfaces.nsISupports))</span>
<a href="#l7.173"></a><span id="l7.173" class="difflineminus">-            return this;</span>
<a href="#l7.174"></a><span id="l7.174" class="difflineminus">-          throw Components.results.NS_NOINTERFACE;</span>
<a href="#l7.175"></a><span id="l7.175" class="difflineminus">-        }</span>
<a href="#l7.176"></a><span id="l7.176" class="difflineminus">-        });</span>
<a href="#l7.177"></a><span id="l7.177" class="difflineminus">-      &lt;/field&gt;</span>
<a href="#l7.178"></a><span id="l7.178" class="difflineminus">-      &lt;property name=&quot;menupopup&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l7.179"></a><span id="l7.179" class="difflineminus">-        &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l7.180"></a><span id="l7.180" class="difflineminus">-          return document.getAnonymousElementByAttribute(</span>
<a href="#l7.181"></a><span id="l7.181" class="difflineminus">-                   this, 'anonid', 'quick-search-menupopup');</span>
<a href="#l7.182"></a><span id="l7.182" class="difflineminus">-        ]]&gt;&lt;/getter&gt;</span>
<a href="#l7.183"></a><span id="l7.183" class="difflineminus">-      &lt;/property&gt;</span>
<a href="#l7.184"></a><span id="l7.184" class="difflineminus">-</span>
<a href="#l7.185"></a><span id="l7.185" class="difflineminus">-      &lt;property name=&quot;state&quot;&gt;</span>
<a href="#l7.186"></a><span id="l7.186" class="difflineminus">-        &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l7.187"></a><span id="l7.187" class="difflineminus">-          return {</span>
<a href="#l7.188"></a><span id="l7.188" class="difflineminus">-            'string': this.value</span>
<a href="#l7.189"></a><span id="l7.189" class="difflineminus">-          };</span>
<a href="#l7.190"></a><span id="l7.190" class="difflineminus">-        ]]&gt;&lt;/getter&gt;</span>
<a href="#l7.191"></a><span id="l7.191" class="difflineminus">-        &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l7.192"></a><span id="l7.192" class="difflineminus">-          this.value = val['string'];</span>
<a href="#l7.193"></a><span id="l7.193" class="difflineminus">-        ]]&gt;&lt;/setter&gt;</span>
<a href="#l7.194"></a><span id="l7.194" class="difflineminus">-      &lt;/property&gt;</span>
<a href="#l7.195"></a><span id="l7.195" class="difflineminus">-</span>
<a href="#l7.196"></a><span id="l7.196" class="difflineminus">-      // DND Observer</span>
<a href="#l7.197"></a><span id="l7.197" class="difflineminus">-      &lt;field name=&quot;searchInputDNDObserver&quot; readonly=&quot;true&quot;&gt;&lt;![CDATA[</span>
<a href="#l7.198"></a><span id="l7.198" class="difflineminus">-      ({</span>
<a href="#l7.199"></a><span id="l7.199" class="difflineminus">-        inputSearch: this,</span>
<a href="#l7.200"></a><span id="l7.200" class="difflineminus">-</span>
<a href="#l7.201"></a><span id="l7.201" class="difflineminus">-        onDrop: function (aEvent, aXferData, aDragSession) {</span>
<a href="#l7.202"></a><span id="l7.202" class="difflineminus">-          try {</span>
<a href="#l7.203"></a><span id="l7.203" class="difflineminus">-            if (aXferData.data) {</span>
<a href="#l7.204"></a><span id="l7.204" class="difflineminus">-              this.inputSearch.focus();</span>
<a href="#l7.205"></a><span id="l7.205" class="difflineminus">-              this.inputSearch.value = aXferData.data;</span>
<a href="#l7.206"></a><span id="l7.206" class="difflineminus">-              // XXX for some reason the input field is _cleared_ even though</span>
<a href="#l7.207"></a><span id="l7.207" class="difflineminus">-              // the search works.</span>
<a href="#l7.208"></a><span id="l7.208" class="difflineminus">-              this.inputSearch.doSearch();</span>
<a href="#l7.209"></a><span id="l7.209" class="difflineminus">-            }</span>
<a href="#l7.210"></a><span id="l7.210" class="difflineminus">-          } catch (e) {</span>
<a href="#l7.211"></a><span id="l7.211" class="difflineminus">-            logException(e);</span>
<a href="#l7.212"></a><span id="l7.212" class="difflineminus">-          }</span>
<a href="#l7.213"></a><span id="l7.213" class="difflineminus">-        },</span>
<a href="#l7.214"></a><span id="l7.214" class="difflineminus">-</span>
<a href="#l7.215"></a><span id="l7.215" class="difflineminus">-        getSupportedFlavours: function () {</span>
<a href="#l7.216"></a><span id="l7.216" class="difflineminus">-          var flavourSet = new FlavourSet();</span>
<a href="#l7.217"></a><span id="l7.217" class="difflineminus">-          flavourSet.appendFlavour(&quot;text/unicode&quot;);</span>
<a href="#l7.218"></a><span id="l7.218" class="difflineminus">-          return flavourSet;</span>
<a href="#l7.219"></a><span id="l7.219" class="difflineminus">-        }</span>
<a href="#l7.220"></a><span id="l7.220" class="difflineminus">-      })</span>
<a href="#l7.221"></a><span id="l7.221" class="difflineminus">-      ]]&gt;&lt;/field&gt;</span>
<a href="#l7.222"></a><span id="l7.222" class="difflineminus">-</span>
<a href="#l7.223"></a><span id="l7.223" class="difflineminus">-      &lt;method name=&quot;doSearch&quot;&gt;</span>
<a href="#l7.224"></a><span id="l7.224" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.225"></a><span id="l7.225" class="difflineminus">-          try {</span>
<a href="#l7.226"></a><span id="l7.226" class="difflineminus">-            if (this.value) {</span>
<a href="#l7.227"></a><span id="l7.227" class="difflineminus">-              let tabmail = document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l7.228"></a><span id="l7.228" class="difflineminus">-              // If the current tab is a gloda search tab, reset the value</span>
<a href="#l7.229"></a><span id="l7.229" class="difflineminus">-              //  to the initial search value.  Otherwise, clear it.  This</span>
<a href="#l7.230"></a><span id="l7.230" class="difflineminus">-              //  is the value that 3is going to be saved with the current</span>
<a href="#l7.231"></a><span id="l7.231" class="difflineminus">-              //  tab when we switch back to it next.</span>
<a href="#l7.232"></a><span id="l7.232" class="difflineminus">-              let searchString = this.value;</span>
<a href="#l7.233"></a><span id="l7.233" class="difflineminus">-</span>
<a href="#l7.234"></a><span id="l7.234" class="difflineminus">-              if (tabmail.currentTabInfo.mode.name == &quot;glodaFacet&quot;) {</span>
<a href="#l7.235"></a><span id="l7.235" class="difflineminus">-                // we'd rather reuse the existing tab (and somehow do something</span>
<a href="#l7.236"></a><span id="l7.236" class="difflineminus">-                // smart with any preexisting facet choices, but that's a</span>
<a href="#l7.237"></a><span id="l7.237" class="difflineminus">-                // bit hard right now, so doing the cheap thing and closing</span>
<a href="#l7.238"></a><span id="l7.238" class="difflineminus">-                // this tab and starting over</span>
<a href="#l7.239"></a><span id="l7.239" class="difflineminus">-                tabmail.closeTab();</span>
<a href="#l7.240"></a><span id="l7.240" class="difflineminus">-              }</span>
<a href="#l7.241"></a><span id="l7.241" class="difflineminus">-              this.value = ''; // clear our value, to avoid persistence</span>
<a href="#l7.242"></a><span id="l7.242" class="difflineminus">-              if (!(&quot;GlodaIMSearcher&quot; in window))</span>
<a href="#l7.243"></a><span id="l7.243" class="difflineminus">-                Cu.import(&quot;resource:///modules/search_im.js&quot;);</span>
<a href="#l7.244"></a><span id="l7.244" class="difflineminus">-              tabmail.openTab(&quot;glodaFacet&quot;, {</span>
<a href="#l7.245"></a><span id="l7.245" class="difflineminus">-                searcher: new GlodaIMSearcher(null, searchString)</span>
<a href="#l7.246"></a><span id="l7.246" class="difflineminus">-              });</span>
<a href="#l7.247"></a><span id="l7.247" class="difflineminus">-            }</span>
<a href="#l7.248"></a><span id="l7.248" class="difflineminus">-          } catch (e) {</span>
<a href="#l7.249"></a><span id="l7.249" class="difflineminus">-            logException(e);</span>
<a href="#l7.250"></a><span id="l7.250" class="difflineminus">-          }</span>
<a href="#l7.251"></a><span id="l7.251" class="difflineminus">-        ]]&gt;</span>
<a href="#l7.252"></a><span id="l7.252" class="difflineminus">-        &lt;/body&gt;</span>
<a href="#l7.253"></a><span id="l7.253" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l7.254"></a><span id="l7.254" class="difflineminus">-      &lt;method name=&quot;clearSearch&quot;&gt;</span>
<a href="#l7.255"></a><span id="l7.255" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.256"></a><span id="l7.256" class="difflineminus">-          this.value = &quot;&quot;;</span>
<a href="#l7.257"></a><span id="l7.257" class="difflineminus">-        ]]&gt;&lt;/body&gt;</span>
<a href="#l7.258"></a><span id="l7.258" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l7.259"></a><span id="l7.259" class="difflineminus">-    &lt;/implementation&gt;</span>
<a href="#l7.260"></a><span id="l7.260" class="difflineminus">-  &lt;/binding&gt;</span>
<a href="#l7.261"></a><span id="l7.261" class="difflineminus">-</span>
<a href="#l7.262"></a><span id="l7.262" class="difflineminus">-&lt;/bindings&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mail/components/im/jar.mn</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mail/components/im/jar.mn</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -18,17 +18,16 @@ messenger.jar:</span>
<a href="#l8.4"></a><span id="l8.4">     content/messenger/chat/imAccountWizard.js            (content/imAccountWizard.js)</span>
<a href="#l8.5"></a><span id="l8.5"> *   content/messenger/chat/imContextMenu.js              (content/imContextMenu.js)</span>
<a href="#l8.6"></a><span id="l8.6">     content/messenger/chat/imStatusSelector.js           (content/imStatusSelector.js)</span>
<a href="#l8.7"></a><span id="l8.7">     content/messenger/chat/imbuddytooltip.xml            (content/imbuddytooltip.xml)</span>
<a href="#l8.8"></a><span id="l8.8">     content/messenger/chat/imcontact.xml                 (content/imcontact.xml)</span>
<a href="#l8.9"></a><span id="l8.9"> *   content/messenger/chat/imconversation.xml            (content/imconversation.xml)</span>
<a href="#l8.10"></a><span id="l8.10">     content/messenger/chat/imconv.xml                    (content/imconv.xml)</span>
<a href="#l8.11"></a><span id="l8.11">     content/messenger/chat/imgroup.xml                   (content/imgroup.xml)</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-    content/messenger/chat/imsearch.xml                  (content/imsearch.xml)</span>
<a href="#l8.13"></a><span id="l8.13"> % skin messenger-messagestyles classic/1.0 %skin/classic/messenger/messages/</span>
<a href="#l8.14"></a><span id="l8.14"> 	skin/classic/messenger/messages/Bitmaps/minus-hover.png       (messages/Bitmaps/minus-hover.png)</span>
<a href="#l8.15"></a><span id="l8.15"> 	skin/classic/messenger/messages/Bitmaps/minus.png             (messages/Bitmaps/minus.png)</span>
<a href="#l8.16"></a><span id="l8.16"> 	skin/classic/messenger/messages/Bitmaps/plus-hover.png        (messages/Bitmaps/plus-hover.png)</span>
<a href="#l8.17"></a><span id="l8.17"> 	skin/classic/messenger/messages/Bitmaps/plus.png              (messages/Bitmaps/plus.png)</span>
<a href="#l8.18"></a><span id="l8.18"> 	skin/classic/messenger/messages/Footer.html                   (messages/Footer.html)</span>
<a href="#l8.19"></a><span id="l8.19"> 	skin/classic/messenger/messages/Incoming/Content.html         (messages/Incoming/Content.html)</span>
<a href="#l8.20"></a><span id="l8.20"> 	skin/classic/messenger/messages/Incoming/Context.html         (messages/Incoming/Context.html)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mail/components/im/modules/index_im.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mail/components/im/modules/index_im.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -34,35 +34,39 @@</span>
<a href="#l9.4"></a><span id="l9.4">  *</span>
<a href="#l9.5"></a><span id="l9.5">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l9.6"></a><span id="l9.6"> </span>
<a href="#l9.7"></a><span id="l9.7"> const EXPORTED_SYMBOLS = [];</span>
<a href="#l9.8"></a><span id="l9.8"> </span>
<a href="#l9.9"></a><span id="l9.9"> const {classes: Cc, interfaces: Ci, utils: Cu, Constructor: CC} = Components;</span>
<a href="#l9.10"></a><span id="l9.10"> </span>
<a href="#l9.11"></a><span id="l9.11"> Cu.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+Cu.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l9.13"></a><span id="l9.13"> Cu.import(&quot;resource://gre/modules/FileUtils.jsm&quot;);</span>
<a href="#l9.14"></a><span id="l9.14"> Cu.import(&quot;resource://gre/modules/NetUtil.jsm&quot;);</span>
<a href="#l9.15"></a><span id="l9.15"> Cu.import(&quot;resource:///modules/gloda/public.js&quot;);</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+Cu.import(&quot;resource:///modules/gloda/datamodel.js&quot;);</span>
<a href="#l9.17"></a><span id="l9.17"> Cu.import(&quot;resource:///modules/gloda/indexer.js&quot;);</span>
<a href="#l9.18"></a><span id="l9.18"> Cu.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l9.19"></a><span id="l9.19"> </span>
<a href="#l9.20"></a><span id="l9.20"> const kCacheFileName = &quot;indexedFiles.json&quot;;</span>
<a href="#l9.21"></a><span id="l9.21"> </span>
<a href="#l9.22"></a><span id="l9.22"> const FileInputStream = CC(&quot;@mozilla.org/network/file-input-stream;1&quot;,</span>
<a href="#l9.23"></a><span id="l9.23">                            &quot;nsIFileInputStream&quot;,</span>
<a href="#l9.24"></a><span id="l9.24">                            &quot;init&quot;);</span>
<a href="#l9.25"></a><span id="l9.25"> const ScriptableInputStream = CC(&quot;@mozilla.org/scriptableinputstream;1&quot;,</span>
<a href="#l9.26"></a><span id="l9.26">                                  &quot;nsIScriptableInputStream&quot;,</span>
<a href="#l9.27"></a><span id="l9.27">                                  &quot;init&quot;);</span>
<a href="#l9.28"></a><span id="l9.28"> </span>
<a href="#l9.29"></a><span id="l9.29"> XPCOMUtils.defineLazyGetter(this, &quot;MailFolder&quot;, function()</span>
<a href="#l9.30"></a><span id="l9.30">   Cc[&quot;@mozilla.org/rdf/resource-factory;1?name=mailbox&quot;].createInstance(Ci.nsIMsgFolder)</span>
<a href="#l9.31"></a><span id="l9.31"> );</span>
<a href="#l9.32"></a><span id="l9.32"> </span>
<a href="#l9.33"></a><span id="l9.33" class="difflineplus">+var gIMAccounts = {};</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineplus">+</span>
<a href="#l9.35"></a><span id="l9.35"> function GlodaIMConversation(aTitle, aTime, aPath, aContent)</span>
<a href="#l9.36"></a><span id="l9.36"> {</span>
<a href="#l9.37"></a><span id="l9.37">   // grokNounItem from gloda.js puts automatically the values of all</span>
<a href="#l9.38"></a><span id="l9.38">   // JS properties in the jsonAttributes magic attribute, except if</span>
<a href="#l9.39"></a><span id="l9.39">   // they start with _, so we put the values in _-prefixed properties,</span>
<a href="#l9.40"></a><span id="l9.40">   // and have getters in the prototype.</span>
<a href="#l9.41"></a><span id="l9.41">   this._title = aTitle;</span>
<a href="#l9.42"></a><span id="l9.42">   this._time = aTime;</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineat">@@ -71,24 +75,64 @@ function GlodaIMConversation(aTitle, aTi</span>
<a href="#l9.44"></a><span id="l9.44"> }</span>
<a href="#l9.45"></a><span id="l9.45"> GlodaIMConversation.prototype = {</span>
<a href="#l9.46"></a><span id="l9.46">   get title() this._title,</span>
<a href="#l9.47"></a><span id="l9.47">   get time() this._time,</span>
<a href="#l9.48"></a><span id="l9.48">   get path() this._path,</span>
<a href="#l9.49"></a><span id="l9.49">   get content() this._content,</span>
<a href="#l9.50"></a><span id="l9.50"> </span>
<a href="#l9.51"></a><span id="l9.51">   // for glodaFacetBindings.xml compatibility (pretend we are a message object)</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineplus">+  get account() {</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineplus">+    let [protocol, username] = this._path.split(&quot;/&quot;, 2);</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineplus">+</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineplus">+    let cacheName = protocol + &quot;/&quot; + username;</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineplus">+    if (cacheName in gIMAccounts)</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineplus">+      return gIMAccounts[cacheName];</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineplus">+</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineplus">+    // Find the nsIIncomingServer for the current imIAccount.</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineplus">+    let mgr = Components.classes[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineplus">+                        .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineplus">+    for each (let account in fixIterator(mgr.accounts, Ci.nsIMsgAccount)) {</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineplus">+      let incomingServer = account.incomingServer;</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineplus">+      if (!incomingServer || incomingServer.type != &quot;im&quot;)</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineplus">+        continue;</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineplus">+      let imAccount = incomingServer.wrappedJSObject.imAccount;</span>
<a href="#l9.67"></a><span id="l9.67" class="difflineplus">+      if (imAccount.protocol.normalizedName == protocol &amp;&amp;</span>
<a href="#l9.68"></a><span id="l9.68" class="difflineplus">+          imAccount.normalizedName == username)</span>
<a href="#l9.69"></a><span id="l9.69" class="difflineplus">+        return (gIMAccounts[cacheName] = new GlodaAccount(incomingServer));</span>
<a href="#l9.70"></a><span id="l9.70" class="difflineplus">+    }</span>
<a href="#l9.71"></a><span id="l9.71" class="difflineplus">+    // The IM conversation is probably for an account that no longer exists.</span>
<a href="#l9.72"></a><span id="l9.72" class="difflineplus">+    return null;</span>
<a href="#l9.73"></a><span id="l9.73" class="difflineplus">+  },</span>
<a href="#l9.74"></a><span id="l9.74">   get subject() this._title,</span>
<a href="#l9.75"></a><span id="l9.75">   get date() new Date(this._time * 1000),</span>
<a href="#l9.76"></a><span id="l9.76" class="difflineminus">-  get recipient() null,</span>
<a href="#l9.77"></a><span id="l9.77" class="difflineminus">-  get from() ({value: &quot;&quot;, contact: {name: &quot;&quot;}}),</span>
<a href="#l9.78"></a><span id="l9.78" class="difflineplus">+  get involves() Gloda.IGNORE_FACET,</span>
<a href="#l9.79"></a><span id="l9.79" class="difflineplus">+  _recipients: null,</span>
<a href="#l9.80"></a><span id="l9.80" class="difflineplus">+  get recipients() {</span>
<a href="#l9.81"></a><span id="l9.81" class="difflineplus">+    if (!this._recipients)</span>
<a href="#l9.82"></a><span id="l9.82" class="difflineplus">+      this._recipients = [{contact: {name: this._path.split(&quot;/&quot;, 2)[1]}}];</span>
<a href="#l9.83"></a><span id="l9.83" class="difflineplus">+    return this._recipients;</span>
<a href="#l9.84"></a><span id="l9.84" class="difflineplus">+  },</span>
<a href="#l9.85"></a><span id="l9.85" class="difflineplus">+  _from: null,</span>
<a href="#l9.86"></a><span id="l9.86" class="difflineplus">+  get from() {</span>
<a href="#l9.87"></a><span id="l9.87" class="difflineplus">+    if (!this._from) {</span>
<a href="#l9.88"></a><span id="l9.88" class="difflineplus">+      let from = &quot;&quot;;</span>
<a href="#l9.89"></a><span id="l9.89" class="difflineplus">+      let account = this._account;</span>
<a href="#l9.90"></a><span id="l9.90" class="difflineplus">+      if (account)</span>
<a href="#l9.91"></a><span id="l9.91" class="difflineplus">+        from = account.incomingServer.wrappedJSObject.imAccount.protocol.name;</span>
<a href="#l9.92"></a><span id="l9.92" class="difflineplus">+      this._from = {value: &quot;&quot;, contact: {name: from}};</span>
<a href="#l9.93"></a><span id="l9.93" class="difflineplus">+    }</span>
<a href="#l9.94"></a><span id="l9.94" class="difflineplus">+    return this._from;</span>
<a href="#l9.95"></a><span id="l9.95" class="difflineplus">+  },</span>
<a href="#l9.96"></a><span id="l9.96" class="difflineplus">+  get tags() [],</span>
<a href="#l9.97"></a><span id="l9.97">   get starred() false,</span>
<a href="#l9.98"></a><span id="l9.98">   get attachmentNames() null,</span>
<a href="#l9.99"></a><span id="l9.99">   get indexedBodyText() this._content,</span>
<a href="#l9.100"></a><span id="l9.100">   get read() true,</span>
<a href="#l9.101"></a><span id="l9.101" class="difflineplus">+  get folder() Gloda.IGNORE_FACET,</span>
<a href="#l9.102"></a><span id="l9.102"> </span>
<a href="#l9.103"></a><span id="l9.103">   // for glodaFacetView.js _removeDupes</span>
<a href="#l9.104"></a><span id="l9.104">   get headerMessageID() this.id</span>
<a href="#l9.105"></a><span id="l9.105"> };</span>
<a href="#l9.106"></a><span id="l9.106"> </span>
<a href="#l9.107"></a><span id="l9.107"> // FIXME</span>
<a href="#l9.108"></a><span id="l9.108"> var WidgetProvider = {</span>
<a href="#l9.109"></a><span id="l9.109">   providerName: &quot;widget&quot;,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/chat.dtd</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/chat.dtd</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -27,25 +27,14 @@</span>
<a href="#l10.4"></a><span id="l10.4"> </span>
<a href="#l10.5"></a><span id="l10.5"> &lt;!ENTITY openConversationButton.tooltip  &quot;Start a conversation&quot;&gt;</span>
<a href="#l10.6"></a><span id="l10.6"> &lt;!ENTITY closeConversationButton.tooltip &quot;Close conversation&quot;&gt;</span>
<a href="#l10.7"></a><span id="l10.7"> </span>
<a href="#l10.8"></a><span id="l10.8"> &lt;!ENTITY addBuddyButton.label          &quot;Add Contact&quot;&gt;</span>
<a href="#l10.9"></a><span id="l10.9"> &lt;!ENTITY joinChatButton.label          &quot;Join Chat&quot;&gt;</span>
<a href="#l10.10"></a><span id="l10.10"> &lt;!ENTITY chatAccountsButton.label      &quot;Show Accounts&quot;&gt;</span>
<a href="#l10.11"></a><span id="l10.11"> </span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-&lt;!-- LOCALIZATION NOTE (searchAllChatMessages.label.base):</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-     This is the base of the empty text for the chat search box.  We replace</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineminus">-     #1 with the contents of the appropriate search.keyLabel.* value for the</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineminus">-     platform (defined in messenger/messenger.dtd).</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineminus">-     The goal is to convey to the user that typing in the box will allow them</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineminus">-     to search for conversations and that there is a hotkey they can press</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineminus">-     to get to the box faster.  If the global indexer is disabled, the search</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineminus">-     box will be collapsed and the user will never see this message.</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineminus">-     --&gt;</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineminus">-&lt;!ENTITY searchAllChatMessages.label.base &quot;Search all conversations #1&quot;&gt;</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineminus">-</span>
<a href="#l10.23"></a><span id="l10.23"> &lt;!ENTITY status.available          &quot;Available&quot;&gt;</span>
<a href="#l10.24"></a><span id="l10.24"> &lt;!ENTITY status.unavailable        &quot;Unavailable&quot;&gt;</span>
<a href="#l10.25"></a><span id="l10.25"> &lt;!ENTITY status.offline            &quot;Offline&quot;&gt;</span>
<a href="#l10.26"></a><span id="l10.26"> </span>
<a href="#l10.27"></a><span id="l10.27"> &lt;!ENTITY openLinkCmd.label            &quot;Open Link&quot;&gt;</span>
<a href="#l10.28"></a><span id="l10.28"> &lt;!ENTITY openLinkCmd.accesskey        &quot;O&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/glodaFacetView.properties</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/glodaFacetView.properties</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -166,24 +166,23 @@ glodaFacetView.results.header.countLabel</span>
<a href="#l11.4"></a><span id="l11.4"> glodaFacetView.results.header.countLabel.ofN=of #1;of #1</span>
<a href="#l11.5"></a><span id="l11.5"> # LOCALIZATION NOTE(glodaFacetView.results.header.countLabel.grouping):</span>
<a href="#l11.6"></a><span id="l11.6"> #  Combines the pluralized</span>
<a href="#l11.7"></a><span id="l11.7"> #  &quot;glodaFacetView.results.header.countLabel.NMessages&quot; string (as #1) with</span>
<a href="#l11.8"></a><span id="l11.8"> #  the pluralized &quot;glodaFacetView.results.header.countLabel.ofN&quot; (as #2)</span>
<a href="#l11.9"></a><span id="l11.9"> #  to make a single label.</span>
<a href="#l11.10"></a><span id="l11.10"> glodaFacetView.results.header.countLabel.grouping=#1 #2</span>
<a href="#l11.11"></a><span id="l11.11"> </span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-# LOCALIZATION NOTE(glodaFacetView.results.message.openAsList.label): The</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-#  label for the button/link that causes us to display all of the messages in</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineminus">-#  the active set in a new thread pane display tab, closing the current faceting</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineminus">-#  tab.</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineminus">-glodaFacetView.results.message.openAsList.label=Open as list</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineminus">-# LOCALIZATION NOTE(glodaFacetView.results.message.openAsList.tooltip): The</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineminus">-#  tooltip to display when hovering over the openAsList label.</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineminus">-glodaFacetView.results.message.openAsList.tooltip=Show all of the messages in the active set in a new tab, closing this tab.</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineplus">+# LOCALIZATION NOTE(glodaFacetView.results.message.openEmailAsList.label): The</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineplus">+#  label for the button/link that causes us to display all of the emails in</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineplus">+#  the active set in a new thread pane display tab.</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineplus">+glodaFacetView.results.message.openEmailAsList.label=Open email as list</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineplus">+# LOCALIZATION NOTE(glodaFacetView.results.message.openEmailAsList.tooltip):</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineplus">+#  The tooltip to display when hovering over the openEmailAsList label.</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineplus">+glodaFacetView.results.message.openEmailAsList.tooltip=Show all of the email messages in the active set in a new tab.</span>
<a href="#l11.27"></a><span id="l11.27"> </span>
<a href="#l11.28"></a><span id="l11.28"> # LOCALIZATION NOTE(glodaFacetView.results.message.sort.label): The</span>
<a href="#l11.29"></a><span id="l11.29"> #  label next to the choice of sort order</span>
<a href="#l11.30"></a><span id="l11.30"> glodaFacetView.results.message.sort.label=sort by:</span>
<a href="#l11.31"></a><span id="l11.31"> # LOCALIZATION NOTE(glodaFacetView.results.message.sort.relevance):</span>
<a href="#l11.32"></a><span id="l11.32"> # a clickable label causing the sort to be done by most relevant messages first.</span>
<a href="#l11.33"></a><span id="l11.33"> glodaFacetView.results.message.sort.relevance=relevance</span>
<a href="#l11.34"></a><span id="l11.34"> # LOCALIZATION NOTE(glodaFacetView.results.message.sort.date):</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/db/gloda/modules/datamodel.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/datamodel.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -30,17 +30,17 @@</span>
<a href="#l12.4"></a><span id="l12.4">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l12.5"></a><span id="l12.5">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l12.6"></a><span id="l12.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l12.7"></a><span id="l12.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l12.8"></a><span id="l12.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l12.9"></a><span id="l12.9">  *</span>
<a href="#l12.10"></a><span id="l12.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l12.11"></a><span id="l12.11"> </span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-const EXPORTED_SYMBOLS = [&quot;GlodaAttributeDBDef&quot;,</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+const EXPORTED_SYMBOLS = [&quot;GlodaAttributeDBDef&quot;, &quot;GlodaAccount&quot;,</span>
<a href="#l12.14"></a><span id="l12.14">                     &quot;GlodaConversation&quot;, &quot;GlodaFolder&quot;, &quot;GlodaMessage&quot;,</span>
<a href="#l12.15"></a><span id="l12.15">                     &quot;GlodaContact&quot;, &quot;GlodaIdentity&quot;, &quot;GlodaAttachment&quot;];</span>
<a href="#l12.16"></a><span id="l12.16"> </span>
<a href="#l12.17"></a><span id="l12.17"> const Cc = Components.classes;</span>
<a href="#l12.18"></a><span id="l12.18"> const Ci = Components.interfaces;</span>
<a href="#l12.19"></a><span id="l12.19"> const Cr = Components.results;</span>
<a href="#l12.20"></a><span id="l12.20"> const Cu = Components.utils;</span>
<a href="#l12.21"></a><span id="l12.21"> </span>
<a href="#l12.22"></a><span id="l12.22" class="difflineat">@@ -190,16 +190,37 @@ function MixIn(aConstructor, aMixIn) {</span>
<a href="#l12.23"></a><span id="l12.23">     if (name.substring(0, 4) == &quot;get_&quot;)</span>
<a href="#l12.24"></a><span id="l12.24">       proto.__defineGetter__(name.substring(4), func);</span>
<a href="#l12.25"></a><span id="l12.25">     else</span>
<a href="#l12.26"></a><span id="l12.26">       proto[name] = func;</span>
<a href="#l12.27"></a><span id="l12.27">   }</span>
<a href="#l12.28"></a><span id="l12.28"> }</span>
<a href="#l12.29"></a><span id="l12.29"> </span>
<a href="#l12.30"></a><span id="l12.30"> /**</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineplus">+ * @class A gloda wrapper around nsIMsgIncomingServer.</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineplus">+ */</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineplus">+function GlodaAccount(aIncomingServer) {</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineplus">+  this._incomingServer = aIncomingServer;</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineplus">+}</span>
<a href="#l12.36"></a><span id="l12.36" class="difflineplus">+</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineplus">+GlodaAccount.prototype = {</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineplus">+  NOUN_ID: 106,</span>
<a href="#l12.39"></a><span id="l12.39" class="difflineplus">+  get id() { return this._incomingServer.key; },</span>
<a href="#l12.40"></a><span id="l12.40" class="difflineplus">+  get name() { return this._incomingServer.prettyName; },</span>
<a href="#l12.41"></a><span id="l12.41" class="difflineplus">+  get incomingServer() { return this._incomingServer; },</span>
<a href="#l12.42"></a><span id="l12.42" class="difflineplus">+  toString: function gloda_account_toString() {</span>
<a href="#l12.43"></a><span id="l12.43" class="difflineplus">+    return &quot;Account: &quot; + this.id;</span>
<a href="#l12.44"></a><span id="l12.44" class="difflineplus">+  },</span>
<a href="#l12.45"></a><span id="l12.45" class="difflineplus">+</span>
<a href="#l12.46"></a><span id="l12.46" class="difflineplus">+  toLocaleString: function gloda_account_toLocaleString() {</span>
<a href="#l12.47"></a><span id="l12.47" class="difflineplus">+    return this.name;</span>
<a href="#l12.48"></a><span id="l12.48" class="difflineplus">+  }</span>
<a href="#l12.49"></a><span id="l12.49" class="difflineplus">+};</span>
<a href="#l12.50"></a><span id="l12.50" class="difflineplus">+</span>
<a href="#l12.51"></a><span id="l12.51" class="difflineplus">+/**</span>
<a href="#l12.52"></a><span id="l12.52">  * @class A gloda conversation (thread) exists so that messages can belong.</span>
<a href="#l12.53"></a><span id="l12.53">  */</span>
<a href="#l12.54"></a><span id="l12.54"> function GlodaConversation(aDatastore, aID, aSubject, aOldestMessageDate,</span>
<a href="#l12.55"></a><span id="l12.55">                            aNewestMessageDate) {</span>
<a href="#l12.56"></a><span id="l12.56">   // _datastore is now set on the prototype by GlodaDatastore</span>
<a href="#l12.57"></a><span id="l12.57">   this._id = aID;</span>
<a href="#l12.58"></a><span id="l12.58">   this._subject = aSubject;</span>
<a href="#l12.59"></a><span id="l12.59">   this._oldestMessageDate = aOldestMessageDate;</span>
<a href="#l12.60"></a><span id="l12.60" class="difflineat">@@ -234,16 +255,17 @@ GlodaConversation.prototype = {</span>
<a href="#l12.61"></a><span id="l12.61"> function GlodaFolder(aDatastore, aID, aURI, aDirtyStatus, aPrettyName,</span>
<a href="#l12.62"></a><span id="l12.62">                      aIndexingPriority) {</span>
<a href="#l12.63"></a><span id="l12.63">   // _datastore is now set by GlodaDatastore</span>
<a href="#l12.64"></a><span id="l12.64">   this._id = aID;</span>
<a href="#l12.65"></a><span id="l12.65">   this._uri = aURI;</span>
<a href="#l12.66"></a><span id="l12.66">   this._dirtyStatus = aDirtyStatus;</span>
<a href="#l12.67"></a><span id="l12.67">   this._prettyName = aPrettyName;</span>
<a href="#l12.68"></a><span id="l12.68">   this._xpcomFolder = null;</span>
<a href="#l12.69"></a><span id="l12.69" class="difflineplus">+  this._account = null;</span>
<a href="#l12.70"></a><span id="l12.70">   this._activeIndexing = false;</span>
<a href="#l12.71"></a><span id="l12.71">   this._activeHeaderRetrievalLastStamp = 0;</span>
<a href="#l12.72"></a><span id="l12.72">   this._indexingPriority = aIndexingPriority;</span>
<a href="#l12.73"></a><span id="l12.73">   this._deleted = false;</span>
<a href="#l12.74"></a><span id="l12.74">   this._compacting = false;</span>
<a href="#l12.75"></a><span id="l12.75"> }</span>
<a href="#l12.76"></a><span id="l12.76"> </span>
<a href="#l12.77"></a><span id="l12.77"> GlodaFolder.prototype = {</span>
<a href="#l12.78"></a><span id="l12.78" class="difflineat">@@ -429,16 +451,29 @@ GlodaFolder.prototype = {</span>
<a href="#l12.79"></a><span id="l12.79">         // we don't have to do anything here.</span>
<a href="#l12.80"></a><span id="l12.80">         break;</span>
<a href="#l12.81"></a><span id="l12.81">     }</span>
<a href="#l12.82"></a><span id="l12.82"> </span>
<a href="#l12.83"></a><span id="l12.83">     return this._xpcomFolder;</span>
<a href="#l12.84"></a><span id="l12.84">   },</span>
<a href="#l12.85"></a><span id="l12.85"> </span>
<a href="#l12.86"></a><span id="l12.86">   /**</span>
<a href="#l12.87"></a><span id="l12.87" class="difflineplus">+   * Retrieve a GlodaAccount instance corresponding to this folder.</span>
<a href="#l12.88"></a><span id="l12.88" class="difflineplus">+   *</span>
<a href="#l12.89"></a><span id="l12.89" class="difflineplus">+   * @return The GlodaAccount instance.</span>
<a href="#l12.90"></a><span id="l12.90" class="difflineplus">+   */</span>
<a href="#l12.91"></a><span id="l12.91" class="difflineplus">+  getAccount: function gloda_folder_getAccount() {</span>
<a href="#l12.92"></a><span id="l12.92" class="difflineplus">+    if (!this._account) {</span>
<a href="#l12.93"></a><span id="l12.93" class="difflineplus">+      let msgFolder = this.getXPCOMFolder(this.kActivityFolderOnlyNoData);</span>
<a href="#l12.94"></a><span id="l12.94" class="difflineplus">+      this._account = new GlodaAccount(msgFolder.server);</span>
<a href="#l12.95"></a><span id="l12.95" class="difflineplus">+    }</span>
<a href="#l12.96"></a><span id="l12.96" class="difflineplus">+    return this._account;</span>
<a href="#l12.97"></a><span id="l12.97" class="difflineplus">+  },</span>
<a href="#l12.98"></a><span id="l12.98" class="difflineplus">+</span>
<a href="#l12.99"></a><span id="l12.99" class="difflineplus">+  /**</span>
<a href="#l12.100"></a><span id="l12.100">    * How many milliseconds must a folder have not had any header retrieval</span>
<a href="#l12.101"></a><span id="l12.101">    *  activity before it's okay to lose the database reference?</span>
<a href="#l12.102"></a><span id="l12.102">    */</span>
<a href="#l12.103"></a><span id="l12.103">   ACCEPTABLY_OLD_THRESHOLD: 10000,</span>
<a href="#l12.104"></a><span id="l12.104"> </span>
<a href="#l12.105"></a><span id="l12.105">   /**</span>
<a href="#l12.106"></a><span id="l12.106">    * Cleans up our nsIMsgFolder reference if we have one and it's not &quot;in use&quot;.</span>
<a href="#l12.107"></a><span id="l12.107">    * In use, from our perspective, means that it is not being used for indexing</span>
<a href="#l12.108"></a><span id="l12.108" class="difflineat">@@ -475,24 +510,16 @@ GlodaFolder.prototype = {</span>
<a href="#l12.109"></a><span id="l12.109">       this._xpcomFolder.msgDatabase = null;</span>
<a href="#l12.110"></a><span id="l12.110">       this._xpcomFolder = null;</span>
<a href="#l12.111"></a><span id="l12.111">       // since the last retrieval time tracks whether we have marked live or</span>
<a href="#l12.112"></a><span id="l12.112">       //  not, this needs to be reset to 0 too.</span>
<a href="#l12.113"></a><span id="l12.113">       this._activeHeaderRetrievalLastStamp = 0;</span>
<a href="#l12.114"></a><span id="l12.114">     }</span>
<a href="#l12.115"></a><span id="l12.115"> </span>
<a href="#l12.116"></a><span id="l12.116">     return true;</span>
<a href="#l12.117"></a><span id="l12.117" class="difflineminus">-  },</span>
<a href="#l12.118"></a><span id="l12.118" class="difflineminus">-</span>
<a href="#l12.119"></a><span id="l12.119" class="difflineminus">-  /**</span>
<a href="#l12.120"></a><span id="l12.120" class="difflineminus">-   * Return the string associated with this account.</span>
<a href="#l12.121"></a><span id="l12.121" class="difflineminus">-   */</span>
<a href="#l12.122"></a><span id="l12.122" class="difflineminus">-  get accountLabel() {</span>
<a href="#l12.123"></a><span id="l12.123" class="difflineminus">-    let msgFolder = this.getXPCOMFolder(this.kActivityFolderOnlyNoData);</span>
<a href="#l12.124"></a><span id="l12.124" class="difflineminus">-    return msgFolder.server.prettyName;</span>
<a href="#l12.125"></a><span id="l12.125">   }</span>
<a href="#l12.126"></a><span id="l12.126"> };</span>
<a href="#l12.127"></a><span id="l12.127"> </span>
<a href="#l12.128"></a><span id="l12.128"> /**</span>
<a href="#l12.129"></a><span id="l12.129">  * @class A message representation.</span>
<a href="#l12.130"></a><span id="l12.130">  */</span>
<a href="#l12.131"></a><span id="l12.131"> function GlodaMessage(aDatastore, aID, aFolderID, aMessageKey,</span>
<a href="#l12.132"></a><span id="l12.132">                       aConversationID, aConversation, aDate,</span>
<a href="#l12.133"></a><span id="l12.133" class="difflineat">@@ -556,16 +583,29 @@ GlodaMessage.prototype = {</span>
<a href="#l12.134"></a><span id="l12.134">     try {</span>
<a href="#l12.135"></a><span id="l12.135">       if (this._folderID != null)</span>
<a href="#l12.136"></a><span id="l12.136">         return this._datastore._mapFolderID(this._folderID).uri;</span>
<a href="#l12.137"></a><span id="l12.137">     }</span>
<a href="#l12.138"></a><span id="l12.138">     catch (ex) {</span>
<a href="#l12.139"></a><span id="l12.139">     }</span>
<a href="#l12.140"></a><span id="l12.140">     return null;</span>
<a href="#l12.141"></a><span id="l12.141">   },</span>
<a href="#l12.142"></a><span id="l12.142" class="difflineplus">+  get account() {</span>
<a href="#l12.143"></a><span id="l12.143" class="difflineplus">+    // XXX due to a deletion bug it is currently possible to get in a state</span>
<a href="#l12.144"></a><span id="l12.144" class="difflineplus">+    //  where we have an illegal folderID value.  This will result in an</span>
<a href="#l12.145"></a><span id="l12.145" class="difflineplus">+    //  exception.  As a workaround, let's just return null in that case.</span>
<a href="#l12.146"></a><span id="l12.146" class="difflineplus">+    try {</span>
<a href="#l12.147"></a><span id="l12.147" class="difflineplus">+      if (this._folderID == null)</span>
<a href="#l12.148"></a><span id="l12.148" class="difflineplus">+        return null;</span>
<a href="#l12.149"></a><span id="l12.149" class="difflineplus">+      let folder = this._datastore._mapFolderID(this._folderID);</span>
<a href="#l12.150"></a><span id="l12.150" class="difflineplus">+      return folder.getAccount();</span>
<a href="#l12.151"></a><span id="l12.151" class="difflineplus">+    }</span>
<a href="#l12.152"></a><span id="l12.152" class="difflineplus">+    catch (ex) { }</span>
<a href="#l12.153"></a><span id="l12.153" class="difflineplus">+    return null;</span>
<a href="#l12.154"></a><span id="l12.154" class="difflineplus">+  },</span>
<a href="#l12.155"></a><span id="l12.155">   get conversation() {</span>
<a href="#l12.156"></a><span id="l12.156">     return this._conversation;</span>
<a href="#l12.157"></a><span id="l12.157">   },</span>
<a href="#l12.158"></a><span id="l12.158"> </span>
<a href="#l12.159"></a><span id="l12.159">   toString: function gloda_message_toString() {</span>
<a href="#l12.160"></a><span id="l12.160">     // uh, this is a tough one...</span>
<a href="#l12.161"></a><span id="l12.161">     return &quot;Message:&quot; + this._id;</span>
<a href="#l12.162"></a><span id="l12.162">   },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/db/gloda/modules/datastore.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/datastore.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -712,16 +712,17 @@ var GlodaDatastore = {</span>
<a href="#l13.4"></a><span id="l13.4"> </span>
<a href="#l13.5"></a><span id="l13.5">   /* see Gloda's documentation for these constants */</span>
<a href="#l13.6"></a><span id="l13.6">   kSpecialNotAtAll: 0,</span>
<a href="#l13.7"></a><span id="l13.7">   kSpecialColumn: 16,</span>
<a href="#l13.8"></a><span id="l13.8">   kSpecialColumnChildren: 16|1,</span>
<a href="#l13.9"></a><span id="l13.9">   kSpecialColumnParent: 16|2,</span>
<a href="#l13.10"></a><span id="l13.10">   kSpecialString: 32,</span>
<a href="#l13.11"></a><span id="l13.11">   kSpecialFulltext: 64,</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+  IGNORE_FACET: {},</span>
<a href="#l13.13"></a><span id="l13.13"> </span>
<a href="#l13.14"></a><span id="l13.14">   kConstraintIdIn: 0,</span>
<a href="#l13.15"></a><span id="l13.15">   kConstraintIn: 1,</span>
<a href="#l13.16"></a><span id="l13.16">   kConstraintRanges: 2,</span>
<a href="#l13.17"></a><span id="l13.17">   kConstraintEquals: 3,</span>
<a href="#l13.18"></a><span id="l13.18">   kConstraintStringLike: 4,</span>
<a href="#l13.19"></a><span id="l13.19">   kConstraintFulltext: 5,</span>
<a href="#l13.20"></a><span id="l13.20"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/db/gloda/modules/facet.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/facet.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -211,16 +211,18 @@ DiscreteFaceter.prototype = {</span>
<a href="#l14.4"></a><span id="l14.4">     let filter = this.facetDef.filter;</span>
<a href="#l14.5"></a><span id="l14.5"> </span>
<a href="#l14.6"></a><span id="l14.6">     let valStrToVal = {};</span>
<a href="#l14.7"></a><span id="l14.7">     let groups = this.groups = {};</span>
<a href="#l14.8"></a><span id="l14.8">     this.groupCount = 0;</span>
<a href="#l14.9"></a><span id="l14.9"> </span>
<a href="#l14.10"></a><span id="l14.10">     for each (let [, item] in Iterator(aItems)) {</span>
<a href="#l14.11"></a><span id="l14.11">       let val = (attrKey in item) ? item[attrKey] : null;</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineplus">+      if (val === Gloda.IGNORE_FACET)</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+        continue;</span>
<a href="#l14.14"></a><span id="l14.14"> </span>
<a href="#l14.15"></a><span id="l14.15">       // skip items the filter tells us to ignore</span>
<a href="#l14.16"></a><span id="l14.16">       if (filter &amp;&amp; !filter(val))</span>
<a href="#l14.17"></a><span id="l14.17">         continue;</span>
<a href="#l14.18"></a><span id="l14.18"> </span>
<a href="#l14.19"></a><span id="l14.19">       // We need to use hasOwnProperty because we cannot guarantee that the</span>
<a href="#l14.20"></a><span id="l14.20">       //  contents of val won't collide with the attributes in Object.prototype.</span>
<a href="#l14.21"></a><span id="l14.21">       if (groups.hasOwnProperty(val))</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineat">@@ -253,16 +255,18 @@ DiscreteFaceter.prototype = {</span>
<a href="#l14.23"></a><span id="l14.23">     let idAttr = this.facetDef.groupIdAttr;</span>
<a href="#l14.24"></a><span id="l14.24"> </span>
<a href="#l14.25"></a><span id="l14.25">     let groups = this.groups = {};</span>
<a href="#l14.26"></a><span id="l14.26">     let groupMap = this.groupMap = {};</span>
<a href="#l14.27"></a><span id="l14.27">     this.groupCount = 0;</span>
<a href="#l14.28"></a><span id="l14.28"> </span>
<a href="#l14.29"></a><span id="l14.29">     for each (let [, item] in Iterator(aItems)) {</span>
<a href="#l14.30"></a><span id="l14.30">       let val = (attrKey in item) ? item[attrKey] : null;</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineplus">+      if (val === Gloda.IGNORE_FACET)</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineplus">+        continue;</span>
<a href="#l14.33"></a><span id="l14.33"> </span>
<a href="#l14.34"></a><span id="l14.34">       // skip items the filter tells us to ignore</span>
<a href="#l14.35"></a><span id="l14.35">       if (filter &amp;&amp; !filter(val))</span>
<a href="#l14.36"></a><span id="l14.36">         continue;</span>
<a href="#l14.37"></a><span id="l14.37"> </span>
<a href="#l14.38"></a><span id="l14.38">       let valId = (val == null) ? null : val[idAttr];</span>
<a href="#l14.39"></a><span id="l14.39">       // We need to use hasOwnProperty because tag nouns are complex objects</span>
<a href="#l14.40"></a><span id="l14.40">       //  with id's that are non-numeric and so can collide with the contents</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineat">@@ -322,16 +326,19 @@ DiscreteSetFaceter.prototype = {</span>
<a href="#l14.42"></a><span id="l14.42">     let filter = this.facetDef.filter;</span>
<a href="#l14.43"></a><span id="l14.43"> </span>
<a href="#l14.44"></a><span id="l14.44">     let groups = this.groups = {};</span>
<a href="#l14.45"></a><span id="l14.45">     let valStrToVal = {};</span>
<a href="#l14.46"></a><span id="l14.46">     this.groupCount = 0;</span>
<a href="#l14.47"></a><span id="l14.47"> </span>
<a href="#l14.48"></a><span id="l14.48">     for each (let [, item] in Iterator(aItems)) {</span>
<a href="#l14.49"></a><span id="l14.49">       let vals = (attrKey in item) ? item[attrKey] : null;</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineplus">+      if (vals === Gloda.IGNORE_FACET)</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineplus">+        continue;</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineplus">+</span>
<a href="#l14.53"></a><span id="l14.53">       if (vals == null || vals.length == 0) {</span>
<a href="#l14.54"></a><span id="l14.54">         vals = [null];</span>
<a href="#l14.55"></a><span id="l14.55">       }</span>
<a href="#l14.56"></a><span id="l14.56">       for each (let [, val] in Iterator(vals)) {</span>
<a href="#l14.57"></a><span id="l14.57">         // skip items the filter tells us to ignore</span>
<a href="#l14.58"></a><span id="l14.58">         if (filter &amp;&amp; !filter(val))</span>
<a href="#l14.59"></a><span id="l14.59">           continue;</span>
<a href="#l14.60"></a><span id="l14.60"> </span>
<a href="#l14.61"></a><span id="l14.61" class="difflineat">@@ -369,16 +376,19 @@ DiscreteSetFaceter.prototype = {</span>
<a href="#l14.62"></a><span id="l14.62">     let idAttr = this.facetDef.groupIdAttr;</span>
<a href="#l14.63"></a><span id="l14.63"> </span>
<a href="#l14.64"></a><span id="l14.64">     let groups = this.groups = {};</span>
<a href="#l14.65"></a><span id="l14.65">     let groupMap = this.groupMap = {};</span>
<a href="#l14.66"></a><span id="l14.66">     this.groupCount = 0;</span>
<a href="#l14.67"></a><span id="l14.67"> </span>
<a href="#l14.68"></a><span id="l14.68">     for each (let [, item] in Iterator(aItems)) {</span>
<a href="#l14.69"></a><span id="l14.69">       let vals = (attrKey in item) ? item[attrKey] : null;</span>
<a href="#l14.70"></a><span id="l14.70" class="difflineplus">+      if (vals === Gloda.IGNORE_FACET)</span>
<a href="#l14.71"></a><span id="l14.71" class="difflineplus">+        continue;</span>
<a href="#l14.72"></a><span id="l14.72" class="difflineplus">+</span>
<a href="#l14.73"></a><span id="l14.73">       if (vals == null || vals.length == 0) {</span>
<a href="#l14.74"></a><span id="l14.74">         vals = [null];</span>
<a href="#l14.75"></a><span id="l14.75">       }</span>
<a href="#l14.76"></a><span id="l14.76">       for each (let [, val] in Iterator(vals)) {</span>
<a href="#l14.77"></a><span id="l14.77">         // skip items the filter tells us to ignore</span>
<a href="#l14.78"></a><span id="l14.78">         if (filter &amp;&amp; !filter(val))</span>
<a href="#l14.79"></a><span id="l14.79">           continue;</span>
<a href="#l14.80"></a><span id="l14.80"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/db/gloda/modules/fundattr.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/fundattr.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -114,39 +114,33 @@ var GlodaFundAttr = {</span>
<a href="#l15.4"></a><span id="l15.4">     // folder</span>
<a href="#l15.5"></a><span id="l15.5">     this._attrFolder = Gloda.defineAttribute({</span>
<a href="#l15.6"></a><span id="l15.6">       provider: this,</span>
<a href="#l15.7"></a><span id="l15.7">       extensionName: Gloda.BUILT_IN,</span>
<a href="#l15.8"></a><span id="l15.8">       attributeType: Gloda.kAttrFundamental,</span>
<a href="#l15.9"></a><span id="l15.9">       attributeName: &quot;folder&quot;,</span>
<a href="#l15.10"></a><span id="l15.10">       singular: true,</span>
<a href="#l15.11"></a><span id="l15.11">       facet: true,</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-      extraFacets: [</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineminus">-        {</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineminus">-          type: &quot;default&quot;,</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineminus">-          alias: &quot;account&quot;,</span>
<a href="#l15.16"></a><span id="l15.16" class="difflineminus">-          // Group the folders by their account (label)...</span>
<a href="#l15.17"></a><span id="l15.17" class="difflineminus">-          groupIdAttr: &quot;accountLabel&quot;,</span>
<a href="#l15.18"></a><span id="l15.18" class="difflineminus">-          // sort the groups by string using magic convenience value</span>
<a href="#l15.19"></a><span id="l15.19" class="difflineminus">-          groupComparator: function(a, b) {</span>
<a href="#l15.20"></a><span id="l15.20" class="difflineminus">-            return a.accountLabel.localeCompare(b.accountLabel);</span>
<a href="#l15.21"></a><span id="l15.21" class="difflineminus">-          },</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineminus">-          queryHelper: &quot;Account&quot;,</span>
<a href="#l15.23"></a><span id="l15.23" class="difflineminus">-          // Display the account label for the facet</span>
<a href="#l15.24"></a><span id="l15.24" class="difflineminus">-          labelFunc: function(aGlodaFolder) {</span>
<a href="#l15.25"></a><span id="l15.25" class="difflineminus">-            return aGlodaFolder.accountLabel;</span>
<a href="#l15.26"></a><span id="l15.26" class="difflineminus">-          }</span>
<a href="#l15.27"></a><span id="l15.27" class="difflineminus">-        },</span>
<a href="#l15.28"></a><span id="l15.28" class="difflineminus">-      ],</span>
<a href="#l15.29"></a><span id="l15.29">       special: Gloda.kSpecialColumn,</span>
<a href="#l15.30"></a><span id="l15.30">       specialColumnName: &quot;folderID&quot;,</span>
<a href="#l15.31"></a><span id="l15.31">       subjectNouns: [Gloda.NOUN_MESSAGE],</span>
<a href="#l15.32"></a><span id="l15.32">       objectNoun: Gloda.NOUN_FOLDER,</span>
<a href="#l15.33"></a><span id="l15.33">       }); // tested-by: test_attributes_fundamental</span>
<a href="#l15.34"></a><span id="l15.34" class="difflineminus">-    this._attrFolder = Gloda.defineAttribute({</span>
<a href="#l15.35"></a><span id="l15.35" class="difflineplus">+    this._attrAccount = Gloda.defineAttribute({</span>
<a href="#l15.36"></a><span id="l15.36" class="difflineplus">+      provider: this,</span>
<a href="#l15.37"></a><span id="l15.37" class="difflineplus">+      extensionName: Gloda.BUILT_IN,</span>
<a href="#l15.38"></a><span id="l15.38" class="difflineplus">+      attributeType: Gloda.kAttrDerived,</span>
<a href="#l15.39"></a><span id="l15.39" class="difflineplus">+      attributeName: &quot;account&quot;,</span>
<a href="#l15.40"></a><span id="l15.40" class="difflineplus">+      canQuery: &quot;memory&quot;,</span>
<a href="#l15.41"></a><span id="l15.41" class="difflineplus">+      singular: true,</span>
<a href="#l15.42"></a><span id="l15.42" class="difflineplus">+      facet: true,</span>
<a href="#l15.43"></a><span id="l15.43" class="difflineplus">+      subjectNouns: [Gloda.NOUN_MESSAGE],</span>
<a href="#l15.44"></a><span id="l15.44" class="difflineplus">+      objectNoun: Gloda.NOUN_ACCOUNT</span>
<a href="#l15.45"></a><span id="l15.45" class="difflineplus">+      });</span>
<a href="#l15.46"></a><span id="l15.46" class="difflineplus">+    this._attrMessageKey = Gloda.defineAttribute({</span>
<a href="#l15.47"></a><span id="l15.47">       provider: this,</span>
<a href="#l15.48"></a><span id="l15.48">       extensionName: Gloda.BUILT_IN,</span>
<a href="#l15.49"></a><span id="l15.49">       attributeType: Gloda.kAttrFundamental,</span>
<a href="#l15.50"></a><span id="l15.50">       attributeName: &quot;messageKey&quot;,</span>
<a href="#l15.51"></a><span id="l15.51">       singular: true,</span>
<a href="#l15.52"></a><span id="l15.52">       special: Gloda.kSpecialColumn,</span>
<a href="#l15.53"></a><span id="l15.53">       specialColumnName: &quot;messageKey&quot;,</span>
<a href="#l15.54"></a><span id="l15.54">       subjectNouns: [Gloda.NOUN_MESSAGE],</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/db/gloda/modules/gloda.js</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/gloda.js</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -691,16 +691,21 @@ var Gloda = {</span>
<a href="#l16.4"></a><span id="l16.4">   kSpecialFulltext: GlodaDatastore.kSpecialFulltext,</span>
<a href="#l16.5"></a><span id="l16.5"> </span>
<a href="#l16.6"></a><span id="l16.6">   /**</span>
<a href="#l16.7"></a><span id="l16.7">    * The extensionName used for the attributes defined by core gloda plugins</span>
<a href="#l16.8"></a><span id="l16.8">    *  such as fundattr.js and explattr.js.</span>
<a href="#l16.9"></a><span id="l16.9">    */</span>
<a href="#l16.10"></a><span id="l16.10">   BUILT_IN: &quot;built-in&quot;,</span>
<a href="#l16.11"></a><span id="l16.11"> </span>
<a href="#l16.12"></a><span id="l16.12" class="difflineplus">+  /**</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+   * Special sentinel value that will cause facets to skip a noun instance</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineplus">+   * when an attribute has this value.</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineplus">+   */</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineplus">+  IGNORE_FACET: GlodaDatastore.IGNORE_FACET,</span>
<a href="#l16.17"></a><span id="l16.17"> </span>
<a href="#l16.18"></a><span id="l16.18">   /*</span>
<a href="#l16.19"></a><span id="l16.19">    * The following are explicit noun IDs.  While most extension-provided nouns</span>
<a href="#l16.20"></a><span id="l16.20">    *  will have dynamically allocated id's that are looked up by name, these</span>
<a href="#l16.21"></a><span id="l16.21">    *  id's can be relied upon to exist and be accessible via these</span>
<a href="#l16.22"></a><span id="l16.22">    *  pseudo-constants.  It's not really clear that we need these, although it</span>
<a href="#l16.23"></a><span id="l16.23">    *  does potentially simplify code to not have to look up all of their nouns</span>
<a href="#l16.24"></a><span id="l16.24">    *  at initialization time.</span>
<a href="#l16.25"></a><span id="l16.25" class="difflineat">@@ -790,16 +795,20 @@ var Gloda = {</span>
<a href="#l16.26"></a><span id="l16.26">    *  identities.  See datamodel.js for the definition of the GlodaIdentity</span>
<a href="#l16.27"></a><span id="l16.27">    *  class.</span>
<a href="#l16.28"></a><span id="l16.28">    */</span>
<a href="#l16.29"></a><span id="l16.29">   NOUN_IDENTITY: GlodaIdentity.prototype.NOUN_ID, // 104</span>
<a href="#l16.30"></a><span id="l16.30">   /**</span>
<a href="#l16.31"></a><span id="l16.31">    * An attachment to a message. A message may have many different attachments.</span>
<a href="#l16.32"></a><span id="l16.32">    */</span>
<a href="#l16.33"></a><span id="l16.33">   NOUN_ATTACHMENT: GlodaAttachment.prototype.NOUN_ID, // 105</span>
<a href="#l16.34"></a><span id="l16.34" class="difflineplus">+  /**</span>
<a href="#l16.35"></a><span id="l16.35" class="difflineplus">+   * An account related to a message. A message can have only one account.</span>
<a href="#l16.36"></a><span id="l16.36" class="difflineplus">+   */</span>
<a href="#l16.37"></a><span id="l16.37" class="difflineplus">+  NOUN_ACCOUNT: GlodaAccount.prototype.NOUN_ID, // 106</span>
<a href="#l16.38"></a><span id="l16.38"> </span>
<a href="#l16.39"></a><span id="l16.39">   /**</span>
<a href="#l16.40"></a><span id="l16.40">    * Parameterized identities, for use in the from-me, to-me, cc-me optimization</span>
<a href="#l16.41"></a><span id="l16.41">    *  cases.  Not for reuse without some thought.  These nouns use the parameter</span>
<a href="#l16.42"></a><span id="l16.42">    *  to store the 'me' identity that we are talking about, and the value to</span>
<a href="#l16.43"></a><span id="l16.43">    *  store the identity of the other party.  So in both the from-me and to-me</span>
<a href="#l16.44"></a><span id="l16.44">    *  cases involving 'me' and 'foo@bar', the 'me' identity is always stored via</span>
<a href="#l16.45"></a><span id="l16.45">    *  the attribute parameter, and the 'foo@bar' identity is always stored as</span>
<a href="#l16.46"></a><span id="l16.46" class="difflineat">@@ -1236,16 +1245,40 @@ var Gloda = {</span>
<a href="#l16.47"></a><span id="l16.47">       },</span>
<a href="#l16.48"></a><span id="l16.48">       toParamAndValue: function(aFolderOrGlodaFolder) {</span>
<a href="#l16.49"></a><span id="l16.49">         if (aFolderOrGlodaFolder instanceof GlodaFolder)</span>
<a href="#l16.50"></a><span id="l16.50">           return [null, aFolderOrGlodaFolder.id];</span>
<a href="#l16.51"></a><span id="l16.51">         else</span>
<a href="#l16.52"></a><span id="l16.52">           return [null, GlodaDatastore._mapFolder(aFolderOrGlodaFolder).id];</span>
<a href="#l16.53"></a><span id="l16.53">       }}, this.NOUN_FOLDER);</span>
<a href="#l16.54"></a><span id="l16.54">     this.defineNoun({</span>
<a href="#l16.55"></a><span id="l16.55" class="difflineplus">+      name: &quot;account&quot;,</span>
<a href="#l16.56"></a><span id="l16.56" class="difflineplus">+      clazz: GlodaAccount,</span>
<a href="#l16.57"></a><span id="l16.57" class="difflineplus">+      allowsArbitraryAttrs: false,</span>
<a href="#l16.58"></a><span id="l16.58" class="difflineplus">+      isPrimitive: false,</span>
<a href="#l16.59"></a><span id="l16.59" class="difflineplus">+      equals: function(a, b) {</span>
<a href="#l16.60"></a><span id="l16.60" class="difflineplus">+        if (a &amp;&amp; !b || !a &amp;&amp; b)</span>
<a href="#l16.61"></a><span id="l16.61" class="difflineplus">+          return false;</span>
<a href="#l16.62"></a><span id="l16.62" class="difflineplus">+        if (!a &amp;&amp; !b)</span>
<a href="#l16.63"></a><span id="l16.63" class="difflineplus">+          return true;</span>
<a href="#l16.64"></a><span id="l16.64" class="difflineplus">+        return a.id == b.id;</span>
<a href="#l16.65"></a><span id="l16.65" class="difflineplus">+      },</span>
<a href="#l16.66"></a><span id="l16.66" class="difflineplus">+      comparator: function gloda_account_comparator(a, b) {</span>
<a href="#l16.67"></a><span id="l16.67" class="difflineplus">+        if (a == null) {</span>
<a href="#l16.68"></a><span id="l16.68" class="difflineplus">+          if (b == null)</span>
<a href="#l16.69"></a><span id="l16.69" class="difflineplus">+            return 0;</span>
<a href="#l16.70"></a><span id="l16.70" class="difflineplus">+          else</span>
<a href="#l16.71"></a><span id="l16.71" class="difflineplus">+            return 1;</span>
<a href="#l16.72"></a><span id="l16.72" class="difflineplus">+        }</span>
<a href="#l16.73"></a><span id="l16.73" class="difflineplus">+        else if (b == null) {</span>
<a href="#l16.74"></a><span id="l16.74" class="difflineplus">+          return -1;</span>
<a href="#l16.75"></a><span id="l16.75" class="difflineplus">+        }</span>
<a href="#l16.76"></a><span id="l16.76" class="difflineplus">+        return a.name.localeCompare(b.name);</span>
<a href="#l16.77"></a><span id="l16.77" class="difflineplus">+      }}, this.NOUN_ACCOUNT);</span>
<a href="#l16.78"></a><span id="l16.78" class="difflineplus">+    this.defineNoun({</span>
<a href="#l16.79"></a><span id="l16.79">       name: &quot;conversation&quot;,</span>
<a href="#l16.80"></a><span id="l16.80">       clazz: GlodaConversation,</span>
<a href="#l16.81"></a><span id="l16.81">       allowsArbitraryAttrs: false,</span>
<a href="#l16.82"></a><span id="l16.82">       isPrimitive: false,</span>
<a href="#l16.83"></a><span id="l16.83">       cache: true, cacheCost: 512,</span>
<a href="#l16.84"></a><span id="l16.84">       tableName: &quot;conversations&quot;,</span>
<a href="#l16.85"></a><span id="l16.85">       attrTableName: &quot;messageAttributes&quot;, attrIDColumnName: &quot;conversationID&quot;,</span>
<a href="#l16.86"></a><span id="l16.86">       datastore: GlodaDatastore,</span>
<a href="#l16.87"></a><span id="l16.87" class="difflineat">@@ -2056,19 +2089,21 @@ var Gloda = {</span>
<a href="#l16.88"></a><span id="l16.88"> </span>
<a href="#l16.89"></a><span id="l16.89">       // the 'old' item is still the canonical one; update it</span>
<a href="#l16.90"></a><span id="l16.90">       // do the update now, because we may skip operations on addDBAttribs and</span>
<a href="#l16.91"></a><span id="l16.91">       //  removeDBattribs, if the attribute is not to generate entries in</span>
<a href="#l16.92"></a><span id="l16.92">       //  messageAttributes</span>
<a href="#l16.93"></a><span id="l16.93">       if (oldValue !== undefined || !aIsConceptuallyNew)</span>
<a href="#l16.94"></a><span id="l16.94">         aOldItem[key] = value;</span>
<a href="#l16.95"></a><span id="l16.95"> </span>
<a href="#l16.96"></a><span id="l16.96" class="difflineminus">-      // the new canQuery property has to be explicitly set to generate entries</span>
<a href="#l16.97"></a><span id="l16.97" class="difflineminus">-      // in the messageAttributes table, hence making the message query-able.</span>
<a href="#l16.98"></a><span id="l16.98" class="difflineminus">-      if (!attrib.canQuery) {</span>
<a href="#l16.99"></a><span id="l16.99" class="difflineplus">+      // the new canQuery property has to be set to true to generate entries</span>
<a href="#l16.100"></a><span id="l16.100" class="difflineplus">+      // in the messageAttributes table. Any other truthy value (like a non</span>
<a href="#l16.101"></a><span id="l16.101" class="difflineplus">+      // empty string), will still make the message query-able but without</span>
<a href="#l16.102"></a><span id="l16.102" class="difflineplus">+      // using the database.</span>
<a href="#l16.103"></a><span id="l16.103" class="difflineplus">+      if (attrib.canQuery !== true) {</span>
<a href="#l16.104"></a><span id="l16.104">         continue;</span>
<a href="#l16.105"></a><span id="l16.105">       }</span>
<a href="#l16.106"></a><span id="l16.106"> </span>
<a href="#l16.107"></a><span id="l16.107">       // - database index attributes</span>
<a href="#l16.108"></a><span id="l16.108"> </span>
<a href="#l16.109"></a><span id="l16.109">       // perform a delta analysis against the old value, if we have one</span>
<a href="#l16.110"></a><span id="l16.110">       if (oldValue !== undefined) {</span>
<a href="#l16.111"></a><span id="l16.111">         // in the singular case if they don't match, it's one add and one remove</span>
<a href="#l16.112"></a><span id="l16.112" class="difflineat">@@ -2163,17 +2198,17 @@ var Gloda = {</span>
<a href="#l16.113"></a><span id="l16.113">       if (attrib === undefined) {</span>
<a href="#l16.114"></a><span id="l16.114">         continue;</span>
<a href="#l16.115"></a><span id="l16.115">       }</span>
<a href="#l16.116"></a><span id="l16.116"> </span>
<a href="#l16.117"></a><span id="l16.117">       // delete these from the old item, as the old item is canonical, and</span>
<a href="#l16.118"></a><span id="l16.118">       //  should no longer have these values</span>
<a href="#l16.119"></a><span id="l16.119">       delete aOldItem[key];</span>
<a href="#l16.120"></a><span id="l16.120"> </span>
<a href="#l16.121"></a><span id="l16.121" class="difflineminus">-      if (!attrib.canQuery) {</span>
<a href="#l16.122"></a><span id="l16.122" class="difflineplus">+      if (attrib.canQuery !== true) {</span>
<a href="#l16.123"></a><span id="l16.123">         this._log.debug(&quot;Not inserting attribute &quot;+attrib.attributeName</span>
<a href="#l16.124"></a><span id="l16.124">             +&quot; into the db, since we don't plan on querying on it&quot;);</span>
<a href="#l16.125"></a><span id="l16.125">         continue;</span>
<a href="#l16.126"></a><span id="l16.126">       }</span>
<a href="#l16.127"></a><span id="l16.127"> </span>
<a href="#l16.128"></a><span id="l16.128">       if (attrib.singular)</span>
<a href="#l16.129"></a><span id="l16.129">         value = [value];</span>
<a href="#l16.130"></a><span id="l16.130">       let attribDB = attrib.dbDef;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/db/gloda/modules/query.js</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/query.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -173,16 +173,22 @@ GlodaQueryClass.prototype = {</span>
<a href="#l17.4"></a><span id="l17.4"> </span>
<a href="#l17.5"></a><span id="l17.5">       // assume success until a specific (or) constraint proves us wrong</span>
<a href="#l17.6"></a><span id="l17.6">       let querySatisfied = true;</span>
<a href="#l17.7"></a><span id="l17.7">       for (let iConstraint = 0; iConstraint &lt; curQuery._constraints.length;</span>
<a href="#l17.8"></a><span id="l17.8">            iConstraint++) {</span>
<a href="#l17.9"></a><span id="l17.9">         let constraint = curQuery._constraints[iConstraint];</span>
<a href="#l17.10"></a><span id="l17.10">         let [constraintType, attrDef] = constraint;</span>
<a href="#l17.11"></a><span id="l17.11">         let boundName = attrDef ? attrDef.boundName : &quot;id&quot;;</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineplus">+        if ((boundName in aObj) &amp;&amp;</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+            aObj[boundName] === GlodaDatastore.IGNORE_FACET) {</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineplus">+          querySatisfied = false;</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineplus">+          break;</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineplus">+        }</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineplus">+</span>
<a href="#l17.18"></a><span id="l17.18">         let constraintValues = constraint.slice(2);</span>
<a href="#l17.19"></a><span id="l17.19"> </span>
<a href="#l17.20"></a><span id="l17.20">         if (constraintType === GlodaDatastore.kConstraintIdIn) {</span>
<a href="#l17.21"></a><span id="l17.21">           if (constraintValues.indexOf(aObj.id) == -1) {</span>
<a href="#l17.22"></a><span id="l17.22">             querySatisfied = false;</span>
<a href="#l17.23"></a><span id="l17.23">             break;</span>
<a href="#l17.24"></a><span id="l17.24">           }</span>
<a href="#l17.25"></a><span id="l17.25">         }</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

