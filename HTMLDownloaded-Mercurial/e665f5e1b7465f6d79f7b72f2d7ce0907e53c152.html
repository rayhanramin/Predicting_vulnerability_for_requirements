<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 17453:e665f5e1b7465f6d79f7b72f2d7ce0907e53c152</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ e665f5e1b7465f6d79f7b72f2d7ce0907e53c152" />
<meta property="og:url" content="/comm-central/rev/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152" />
<meta property="og:description" content="Bug 1121107, part 3: Use the newer m-c version of mozrunner in mozmill, r=Callek, extra feedback=whimboo" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / e665f5e1b7465f6d79f7b72f2d7ce0907e53c152 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152">shortlog</a> |
<a href="/comm-central/log/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152">files</a> |
changeset |
<a href="/comm-central/raw-rev/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152">raw</a>  | <a href="/comm-central/archive/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1121107">Bug 1121107</a>, part 3: Use the newer m-c version of mozrunner in mozmill, r=Callek, extra feedback=whimboo
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#74;&#111;&#115;&#104;&#117;&#97;&#32;&#67;&#114;&#97;&#110;&#109;&#101;&#114;&#32;&#60;&#80;&#105;&#100;&#103;&#101;&#111;&#116;&#49;&#56;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 06 Feb 2015 17:33:28 -0600</td></tr>

<tr>
 <td>changeset 17453</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152">e665f5e1b7465f6d79f7b72f2d7ce0907e53c152</a></td>
</tr>



<tr>
<td>parent 17452</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/b8f7415c632cae0ecb7405f8d5b6a08eb31151a0">b8f7415c632cae0ecb7405f8d5b6a08eb31151a0</a>
</td>
</tr>

<tr>
<td>child 17454</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/b3e8878f2691902490c7f30ef64fd5c506f8fb8b">b3e8878f2691902490c7f30ef64fd5c506f8fb8b</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=e665f5e1b7465f6d79f7b72f2d7ce0907e53c152">10752</a></td></tr>
<tr><td>push user</td><td>Pidgeot18@gmail.com</td></tr>
<tr><td>push date</td><td class="date age">Fri, 06 Feb 2015 23:34:02 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@e665f5e1b746 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=e665f5e1b7465f6d79f7b72f2d7ce0907e53c152">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=e665f5e1b7465f6d79f7b72f2d7ce0907e53c152&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=e665f5e1b7465f6d79f7b72f2d7ce0907e53c152&newProject=comm-central&newRevision=241f8377859e682d46c61ca06163fbe48bdc0ca2&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=e665f5e1b7465f6d79f7b72f2d7ce0907e53c152&newProject=comm-central&newRevision=241f8377859e682d46c61ca06163fbe48bdc0ca2&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=e665f5e1b7465f6d79f7b72f2d7ce0907e53c152&newProject=comm-central&newRevision=241f8377859e682d46c61ca06163fbe48bdc0ca2&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28Callek%29&revcount=50">Callek</a>, <a href="/comm-central/log?rev=reviewer%28extra%29&revcount=50">extra</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1121107">1121107</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1121107">Bug 1121107</a>, part 3: Use the newer m-c version of mozrunner in mozmill, r=Callek, extra feedback=whimboo</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/mozmill/Makefile.in">mail/test/mozmill/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/mozmill/Makefile.in">file</a> |
<a href="/comm-central/annotate/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/mozmill/Makefile.in">annotate</a> |
<a href="/comm-central/diff/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/mozmill/Makefile.in">diff</a> |
<a href="/comm-central/comparison/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/mozmill/Makefile.in">comparison</a> |
<a href="/comm-central/log/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/mozmill/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/mozmill/folder-tree-modes/wrapper.py">mail/test/mozmill/folder-tree-modes/wrapper.py</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/mozmill/folder-tree-modes/wrapper.py">file</a> |
<a href="/comm-central/annotate/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/mozmill/folder-tree-modes/wrapper.py">annotate</a> |
<a href="/comm-central/diff/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/mozmill/folder-tree-modes/wrapper.py">diff</a> |
<a href="/comm-central/comparison/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/mozmill/folder-tree-modes/wrapper.py">comparison</a> |
<a href="/comm-central/log/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/mozmill/folder-tree-modes/wrapper.py">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/mozmill/moz.build">mail/test/mozmill/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/mozmill/moz.build">file</a> |
<a href="/comm-central/annotate/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/mozmill/moz.build">annotate</a> |
<a href="/comm-central/diff/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/mozmill/moz.build">diff</a> |
<a href="/comm-central/comparison/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/mozmill/moz.build">comparison</a> |
<a href="/comm-central/log/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/mozmill/moz.build">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/mozmill/runtest.py">mail/test/mozmill/runtest.py</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/mozmill/runtest.py">file</a> |
<a href="/comm-central/annotate/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/mozmill/runtest.py">annotate</a> |
<a href="/comm-central/diff/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/mozmill/runtest.py">diff</a> |
<a href="/comm-central/comparison/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/mozmill/runtest.py">comparison</a> |
<a href="/comm-central/log/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/mozmill/runtest.py">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/resources/installmozmill.py">mail/test/resources/installmozmill.py</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/resources/installmozmill.py">file</a> |
<a href="/comm-central/annotate/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/resources/installmozmill.py">annotate</a> |
<a href="/comm-central/diff/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/resources/installmozmill.py">diff</a> |
<a href="/comm-central/comparison/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/resources/installmozmill.py">comparison</a> |
<a href="/comm-central/log/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/resources/installmozmill.py">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/resources/jsbridge/jsbridge/__init__.py">mail/test/resources/jsbridge/jsbridge/__init__.py</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/resources/jsbridge/jsbridge/__init__.py">file</a> |
<a href="/comm-central/annotate/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/resources/jsbridge/jsbridge/__init__.py">annotate</a> |
<a href="/comm-central/diff/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/resources/jsbridge/jsbridge/__init__.py">diff</a> |
<a href="/comm-central/comparison/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/resources/jsbridge/jsbridge/__init__.py">comparison</a> |
<a href="/comm-central/log/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/resources/jsbridge/jsbridge/__init__.py">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/resources/jsbridge/setup.py">mail/test/resources/jsbridge/setup.py</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/resources/jsbridge/setup.py">file</a> |
<a href="/comm-central/annotate/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/resources/jsbridge/setup.py">annotate</a> |
<a href="/comm-central/diff/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/resources/jsbridge/setup.py">diff</a> |
<a href="/comm-central/comparison/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/resources/jsbridge/setup.py">comparison</a> |
<a href="/comm-central/log/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/resources/jsbridge/setup.py">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/resources/mozmill/mozmill/__init__.py">mail/test/resources/mozmill/mozmill/__init__.py</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/resources/mozmill/mozmill/__init__.py">file</a> |
<a href="/comm-central/annotate/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/resources/mozmill/mozmill/__init__.py">annotate</a> |
<a href="/comm-central/diff/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/resources/mozmill/mozmill/__init__.py">diff</a> |
<a href="/comm-central/comparison/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/resources/mozmill/mozmill/__init__.py">comparison</a> |
<a href="/comm-central/log/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/resources/mozmill/mozmill/__init__.py">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/resources/mozmill/setup.py">mail/test/resources/mozmill/setup.py</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/resources/mozmill/setup.py">file</a> |
<a href="/comm-central/annotate/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/resources/mozmill/setup.py">annotate</a> |
<a href="/comm-central/diff/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/resources/mozmill/setup.py">diff</a> |
<a href="/comm-central/comparison/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/resources/mozmill/setup.py">comparison</a> |
<a href="/comm-central/log/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/resources/mozmill/setup.py">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/resources/mozrunner/mozrunner/__init__.py">mail/test/resources/mozrunner/mozrunner/__init__.py</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/resources/mozrunner/mozrunner/__init__.py">diff</a> |
<a href="/comm-central/comparison/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/resources/mozrunner/mozrunner/__init__.py">comparison</a> |
<a href="/comm-central/log/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/resources/mozrunner/mozrunner/__init__.py">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/resources/mozrunner/mozrunner/killableprocess.py">mail/test/resources/mozrunner/mozrunner/killableprocess.py</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/resources/mozrunner/mozrunner/killableprocess.py">diff</a> |
<a href="/comm-central/comparison/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/resources/mozrunner/mozrunner/killableprocess.py">comparison</a> |
<a href="/comm-central/log/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/resources/mozrunner/mozrunner/killableprocess.py">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/resources/mozrunner/mozrunner/qijo.py">mail/test/resources/mozrunner/mozrunner/qijo.py</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/resources/mozrunner/mozrunner/qijo.py">diff</a> |
<a href="/comm-central/comparison/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/resources/mozrunner/mozrunner/qijo.py">comparison</a> |
<a href="/comm-central/log/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/resources/mozrunner/mozrunner/qijo.py">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/resources/mozrunner/mozrunner/winprocess.py">mail/test/resources/mozrunner/mozrunner/winprocess.py</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/resources/mozrunner/mozrunner/winprocess.py">diff</a> |
<a href="/comm-central/comparison/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/resources/mozrunner/mozrunner/winprocess.py">comparison</a> |
<a href="/comm-central/log/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/resources/mozrunner/mozrunner/winprocess.py">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/resources/mozrunner/mozrunner/wpk.py">mail/test/resources/mozrunner/mozrunner/wpk.py</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/resources/mozrunner/mozrunner/wpk.py">diff</a> |
<a href="/comm-central/comparison/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/resources/mozrunner/mozrunner/wpk.py">comparison</a> |
<a href="/comm-central/log/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/resources/mozrunner/mozrunner/wpk.py">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/resources/mozrunner/setup.py">mail/test/resources/mozrunner/setup.py</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/resources/mozrunner/setup.py">diff</a> |
<a href="/comm-central/comparison/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/resources/mozrunner/setup.py">comparison</a> |
<a href="/comm-central/log/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/resources/mozrunner/setup.py">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/resources/mozrunner/tests/debub_settings.py">mail/test/resources/mozrunner/tests/debub_settings.py</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/resources/mozrunner/tests/debub_settings.py">diff</a> |
<a href="/comm-central/comparison/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/resources/mozrunner/tests/debub_settings.py">comparison</a> |
<a href="/comm-central/log/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/resources/mozrunner/tests/debub_settings.py">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/resources/mozrunner/tests/jss_settings.py">mail/test/resources/mozrunner/tests/jss_settings.py</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/resources/mozrunner/tests/jss_settings.py">diff</a> |
<a href="/comm-central/comparison/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/resources/mozrunner/tests/jss_settings.py">comparison</a> |
<a href="/comm-central/log/e665f5e1b7465f6d79f7b72f2d7ce0907e53c152/mail/test/resources/mozrunner/tests/jss_settings.py">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/test/mozmill/Makefile.in</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/test/mozmill/Makefile.in</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -9,43 +9,23 @@ srcdir		= @srcdir@</span>
<a href="#l1.4"></a><span id="l1.4"> VPATH		= @srcdir@</span>
<a href="#l1.5"></a><span id="l1.5"> relativesrcdir = @relativesrcdir@</span>
<a href="#l1.6"></a><span id="l1.6"> </span>
<a href="#l1.7"></a><span id="l1.7"> include $(DEPTH)/config/autoconf.mk</span>
<a href="#l1.8"></a><span id="l1.8"> </span>
<a href="#l1.9"></a><span id="l1.9"> include $(topsrcdir)/config/rules.mk</span>
<a href="#l1.10"></a><span id="l1.10"> </span>
<a href="#l1.11"></a><span id="l1.11"> # We're installing to _tests/mozmill</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-TARGET_DEPTH = ../..</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-include $(MOZILLA_DIR)/build/automation-build.mk</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-</span>
<a href="#l1.15"></a><span id="l1.15"> _DEST_DIR = $(DEPTH)/_tests/mozmill</span>
<a href="#l1.16"></a><span id="l1.16"> </span>
<a href="#l1.17"></a><span id="l1.17" class="difflineminus">-_HARNESS_FILES = \</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineminus">-	$(srcdir)/runtest.py \</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineminus">-	$(srcdir)/runtestlist.py \</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineminus">-	$(srcdir)/mozmilltests.list \</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineminus">-	automation.py \</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineminus">-	$(MOZILLA_DIR)/build/automationutils.py \</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineminus">-	$(NULL)</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineminus">-</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineminus">-GARBAGE += automation.py</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineminus">-</span>
<a href="#l1.27"></a><span id="l1.27"> $(_DEST_DIR):</span>
<a href="#l1.28"></a><span id="l1.28"> 	$(NSINSTALL) -D $@</span>
<a href="#l1.29"></a><span id="l1.29"> </span>
<a href="#l1.30"></a><span id="l1.30" class="difflineminus">-$(_HARNESS_FILES): $(_DEST_DIR)</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineminus">-# Copy the mozmill bits to $(_DEST_DIR)</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineminus">-libs:: $(_HARNESS_FILES)</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineminus">-	echo $(_HARNESS_FILES)</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineminus">-	$(INSTALL) $(_HARNESS_FILES) $(_DEST_DIR)</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineminus">-</span>
<a href="#l1.37"></a><span id="l1.37"> # Copy the mailnews and mail resources that we require.</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineminus">-libs::</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineplus">+libs:: $(_DEST_DIR)</span>
<a href="#l1.40"></a><span id="l1.40"> 	$(INSTALL) $(topsrcdir)/mailnews/test/resources/* $(_DEST_DIR)/resources</span>
<a href="#l1.41"></a><span id="l1.41"> 	$(INSTALL) $(topsrcdir)/mailnews/test/fakeserver/* $(_DEST_DIR)/resources</span>
<a href="#l1.42"></a><span id="l1.42"> 	$(INSTALL) $(topsrcdir)/mail/base/test/unit/resources/* $(_DEST_DIR)/resources</span>
<a href="#l1.43"></a><span id="l1.43"> </span>
<a href="#l1.44"></a><span id="l1.44"> # Copy MozMill and its dependencies over, and set up a virtualenv. The</span>
<a href="#l1.45"></a><span id="l1.45"> # virtualenv directory is outside because we don't want to bundle it up during</span>
<a href="#l1.46"></a><span id="l1.46"> # stage-package.</span>
<a href="#l1.47"></a><span id="l1.47"> VIRTUALENV_DIR = $(_DEST_DIR)/../mozmill-virtualenv</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/test/mozmill/folder-tree-modes/wrapper.py</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/test/mozmill/folder-tree-modes/wrapper.py</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -8,15 +8,11 @@ import os</span>
<a href="#l2.4"></a><span id="l2.4"> </span>
<a href="#l2.5"></a><span id="l2.5"> def on_before_start(profile):</span>
<a href="#l2.6"></a><span id="l2.6">     &quot;&quot;&quot;</span>
<a href="#l2.7"></a><span id="l2.7">     This installs the extension in the test-extension subdirectory into the</span>
<a href="#l2.8"></a><span id="l2.8">     profile folder. We cannot use on_profile_created here because</span>
<a href="#l2.9"></a><span id="l2.9">     install_plugin/install_addon depends on the profile object being fully</span>
<a href="#l2.10"></a><span id="l2.10">     initalized.</span>
<a href="#l2.11"></a><span id="l2.11">     &quot;&quot;&quot;</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-    # Newer mozmill renames install_plugin to install_addon</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-    if hasattr(profile, &quot;install_addon&quot;):</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-        install_addon = profile.install_addon</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineminus">-    else:</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineminus">-        install_addon = profile.install_plugin</span>
<a href="#l2.17"></a><span id="l2.17"> </span>
<a href="#l2.18"></a><span id="l2.18" class="difflineminus">-    install_addon(os.path.join(os.path.dirname(__file__), &quot;test-extension&quot;))</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+    profile.addon_manager.install_addons(</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+        [os.path.join(os.path.dirname(__file__), &quot;test-extension&quot;)])</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/test/mozmill/moz.build</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/test/mozmill/moz.build</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -1,5 +1,10 @@</span>
<a href="#l3.4"></a><span id="l3.4"> # vim: set filetype=python:</span>
<a href="#l3.5"></a><span id="l3.5"> # This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l3.6"></a><span id="l3.6"> # License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l3.7"></a><span id="l3.7"> # file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l3.8"></a><span id="l3.8"> </span>
<a href="#l3.9"></a><span id="l3.9" class="difflineplus">+TEST_HARNESS_FILES.mozmill += [</span>
<a href="#l3.10"></a><span id="l3.10" class="difflineplus">+    'mozmilltests.list',</span>
<a href="#l3.11"></a><span id="l3.11" class="difflineplus">+    'runtest.py',</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+    'runtestlist.py',</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/test/mozmill/runtest.py</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/test/mozmill/runtest.py</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -5,51 +5,33 @@</span>
<a href="#l4.4"></a><span id="l4.4"> </span>
<a href="#l4.5"></a><span id="l4.5"> &quot;&quot;&quot;</span>
<a href="#l4.6"></a><span id="l4.6"> Runs the Bloat test harness</span>
<a href="#l4.7"></a><span id="l4.7"> &quot;&quot;&quot;</span>
<a href="#l4.8"></a><span id="l4.8"> </span>
<a href="#l4.9"></a><span id="l4.9"> import sys</span>
<a href="#l4.10"></a><span id="l4.10"> import os, os.path, platform, subprocess, signal</span>
<a href="#l4.11"></a><span id="l4.11"> import shutil</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+import mozprofile</span>
<a href="#l4.13"></a><span id="l4.13"> import mozrunner</span>
<a href="#l4.14"></a><span id="l4.14"> import jsbridge</span>
<a href="#l4.15"></a><span id="l4.15"> import mozmill</span>
<a href="#l4.16"></a><span id="l4.16"> import socket</span>
<a href="#l4.17"></a><span id="l4.17"> import copy</span>
<a href="#l4.18"></a><span id="l4.18"> </span>
<a href="#l4.19"></a><span id="l4.19"> # Python 2.6 has the json module, but Python 2.5 doesn't.</span>
<a href="#l4.20"></a><span id="l4.20"> try:</span>
<a href="#l4.21"></a><span id="l4.21">     import json</span>
<a href="#l4.22"></a><span id="l4.22"> except ImportError:</span>
<a href="#l4.23"></a><span id="l4.23">     import simplejson as json</span>
<a href="#l4.24"></a><span id="l4.24"> </span>
<a href="#l4.25"></a><span id="l4.25"> SCRIPT_DIRECTORY = os.path.abspath(os.path.realpath(os.path.dirname(sys.argv[0])))</span>
<a href="#l4.26"></a><span id="l4.26"> sys.path.append(SCRIPT_DIRECTORY)</span>
<a href="#l4.27"></a><span id="l4.27"> </span>
<a href="#l4.28"></a><span id="l4.28" class="difflineminus">-from automation import Automation</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineminus">-automation = Automation()</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineminus">-</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineminus">-# --------------------------------------------------------------</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineminus">-# TODO: this is a hack for mozbase without virtualenv, remove with bug 849900</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineminus">-#</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineminus">-here = os.path.dirname(__file__)</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineminus">-mozbase = os.path.realpath(os.path.join(os.path.dirname(here), 'mozbase'))</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineminus">-</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineminus">-try:</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineminus">-    import mozcrash</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineminus">-except:</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineminus">-    deps = ['mozcrash',</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineminus">-            'mozlog']</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineminus">-    for dep in deps:</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineminus">-        module = os.path.join(mozbase, dep)</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineminus">-        if module not in sys.path:</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineminus">-            sys.path.append(module)</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineminus">-    import mozcrash</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineminus">-# ---------------------------------------------------------------</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineplus">+import mozcrash</span>
<a href="#l4.49"></a><span id="l4.49"> </span>
<a href="#l4.50"></a><span id="l4.50"> from time import sleep</span>
<a href="#l4.51"></a><span id="l4.51"> import imp</span>
<a href="#l4.52"></a><span id="l4.52"> </span>
<a href="#l4.53"></a><span id="l4.53"> PROFILE_DIR = os.path.join(SCRIPT_DIRECTORY, 'mozmillprofile')</span>
<a href="#l4.54"></a><span id="l4.54"> SYMBOLS_PATH = None</span>
<a href="#l4.55"></a><span id="l4.55"> PLUGINS_PATH = None</span>
<a href="#l4.56"></a><span id="l4.56"> # XXX This breaks any semblance of test runner modularity, and only works</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineat">@@ -73,28 +55,28 @@ USE_RICH_FAILURES = False</span>
<a href="#l4.58"></a><span id="l4.58"> def rmtree_onerror(func, path, exc_info):</span>
<a href="#l4.59"></a><span id="l4.59">     &quot;&quot;&quot;</span>
<a href="#l4.60"></a><span id="l4.60">     Error handler for ``shutil.rmtree``.</span>
<a href="#l4.61"></a><span id="l4.61"> </span>
<a href="#l4.62"></a><span id="l4.62">     If the error is due to an access error (read only file)</span>
<a href="#l4.63"></a><span id="l4.63">     it attempts to add write permission and then retries.</span>
<a href="#l4.64"></a><span id="l4.64"> </span>
<a href="#l4.65"></a><span id="l4.65">     If the error is for another reason it re-raises the error.</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineminus">-    </span>
<a href="#l4.67"></a><span id="l4.67" class="difflineplus">+</span>
<a href="#l4.68"></a><span id="l4.68">     Usage : ``shutil.rmtree(path, onerror=rmtree_onerror)``</span>
<a href="#l4.69"></a><span id="l4.69">     &quot;&quot;&quot;</span>
<a href="#l4.70"></a><span id="l4.70">     import stat</span>
<a href="#l4.71"></a><span id="l4.71">     if not os.access(path, os.W_OK):</span>
<a href="#l4.72"></a><span id="l4.72">         # Is the error an access error ?</span>
<a href="#l4.73"></a><span id="l4.73">         os.chmod(path, stat.S_IWUSR)</span>
<a href="#l4.74"></a><span id="l4.74">         func(path)</span>
<a href="#l4.75"></a><span id="l4.75">     else:</span>
<a href="#l4.76"></a><span id="l4.76">         raise</span>
<a href="#l4.77"></a><span id="l4.77"> </span>
<a href="#l4.78"></a><span id="l4.78" class="difflineminus">-class ThunderTestProfile(mozrunner.ThunderbirdProfile):</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineplus">+class ThunderTestProfile(mozprofile.ThunderbirdProfile):</span>
<a href="#l4.80"></a><span id="l4.80">     preferences = {</span>
<a href="#l4.81"></a><span id="l4.81">         # say yes to debug output via dump</span>
<a href="#l4.82"></a><span id="l4.82">         'browser.dom.window.dump.enabled': True,</span>
<a href="#l4.83"></a><span id="l4.83">         # say no to slow script warnings</span>
<a href="#l4.84"></a><span id="l4.84">         'dom.max_chrome_script_run_time': 0,</span>
<a href="#l4.85"></a><span id="l4.85">         'dom.max_script_run_time': 0,</span>
<a href="#l4.86"></a><span id="l4.86">         # disable extension stuffs</span>
<a href="#l4.87"></a><span id="l4.87">         'extensions.update.enabled'    : False,</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineat">@@ -189,17 +171,29 @@ class ThunderTestProfile(mozrunner.Thund</span>
<a href="#l4.89"></a><span id="l4.89">         'mail.smtpservers' :  &quot;smtp1&quot;,</span>
<a href="#l4.90"></a><span id="l4.90">         'messenger.account.account1.autoLogin' :  False,</span>
<a href="#l4.91"></a><span id="l4.91">         'messenger.account.account1.firstConnectionState' :  1,</span>
<a href="#l4.92"></a><span id="l4.92">         'messenger.account.account1.name' :  &quot;mozmilltest@irc.mozilla.invalid&quot;,</span>
<a href="#l4.93"></a><span id="l4.93">         'messenger.account.account1.prpl' :  &quot;prpl-irc&quot;,</span>
<a href="#l4.94"></a><span id="l4.94">         'messenger.accounts' :  &quot;account1&quot;,</span>
<a href="#l4.95"></a><span id="l4.95">     }</span>
<a href="#l4.96"></a><span id="l4.96"> </span>
<a href="#l4.97"></a><span id="l4.97" class="difflineminus">-    def create_new_profile(self, binary):</span>
<a href="#l4.98"></a><span id="l4.98" class="difflineplus">+    def __init__(self, *args, **kwargs):</span>
<a href="#l4.99"></a><span id="l4.99" class="difflineplus">+        kwargs['profile'] = self.get_profile_dir()</span>
<a href="#l4.100"></a><span id="l4.100" class="difflineplus">+        super(ThunderTestProfile, self).__init__(*args, **kwargs)</span>
<a href="#l4.101"></a><span id="l4.101" class="difflineplus">+        self.set_preferences(self.preferences)</span>
<a href="#l4.102"></a><span id="l4.102" class="difflineplus">+</span>
<a href="#l4.103"></a><span id="l4.103" class="difflineplus">+        if (wrapper is not None and hasattr(wrapper, &quot;NO_ACCOUNTS&quot;)</span>
<a href="#l4.104"></a><span id="l4.104" class="difflineplus">+            and wrapper.NO_ACCOUNTS):</span>
<a href="#l4.105"></a><span id="l4.105" class="difflineplus">+            pass</span>
<a href="#l4.106"></a><span id="l4.106" class="difflineplus">+        else:</span>
<a href="#l4.107"></a><span id="l4.107" class="difflineplus">+            self.set_preferences(self.account_preferences)</span>
<a href="#l4.108"></a><span id="l4.108" class="difflineplus">+</span>
<a href="#l4.109"></a><span id="l4.109" class="difflineplus">+</span>
<a href="#l4.110"></a><span id="l4.110" class="difflineplus">+    def get_profile_dir(self):</span>
<a href="#l4.111"></a><span id="l4.111">         '''</span>
<a href="#l4.112"></a><span id="l4.112">         We always put our profile in the same location.  We only clear it out</span>
<a href="#l4.113"></a><span id="l4.113">         when we are creating a new profile so that we can go in after the run</span>
<a href="#l4.114"></a><span id="l4.114">         and examine things for debugging or general interest.</span>
<a href="#l4.115"></a><span id="l4.115">         '''</span>
<a href="#l4.116"></a><span id="l4.116">         # create a clean directory</span>
<a href="#l4.117"></a><span id="l4.117">         if os.path.exists(PROFILE_DIR):</span>
<a href="#l4.118"></a><span id="l4.118">             shutil.rmtree(PROFILE_DIR, onerror=rmtree_onerror)</span>
<a href="#l4.119"></a><span id="l4.119" class="difflineat">@@ -215,94 +209,97 @@ class ThunderTestProfile(mozrunner.Thund</span>
<a href="#l4.120"></a><span id="l4.120">           dest = os.path.join(PROFILE_DIR, &quot;plugins&quot;)</span>
<a href="#l4.121"></a><span id="l4.121">           shutil.copytree(PLUGINS_PATH, dest)</span>
<a href="#l4.122"></a><span id="l4.122"> </span>
<a href="#l4.123"></a><span id="l4.123">         if wrapper is not None and hasattr(wrapper, &quot;on_profile_created&quot;):</span>
<a href="#l4.124"></a><span id="l4.124">             # It's a little dangerous to allow on_profile_created access to the</span>
<a href="#l4.125"></a><span id="l4.125">             # profile object, because it isn't fully initalized yet</span>
<a href="#l4.126"></a><span id="l4.126">             wrapper.on_profile_created(PROFILE_DIR)</span>
<a href="#l4.127"></a><span id="l4.127"> </span>
<a href="#l4.128"></a><span id="l4.128" class="difflineminus">-        if (wrapper is not None and hasattr(wrapper, &quot;NO_ACCOUNTS&quot;)</span>
<a href="#l4.129"></a><span id="l4.129" class="difflineminus">-            and wrapper.NO_ACCOUNTS):</span>
<a href="#l4.130"></a><span id="l4.130" class="difflineminus">-            pass</span>
<a href="#l4.131"></a><span id="l4.131" class="difflineminus">-        else:</span>
<a href="#l4.132"></a><span id="l4.132" class="difflineminus">-            self.preferences.update(self.account_preferences)</span>
<a href="#l4.133"></a><span id="l4.133" class="difflineminus">-</span>
<a href="#l4.134"></a><span id="l4.134">         return PROFILE_DIR</span>
<a href="#l4.135"></a><span id="l4.135"> </span>
<a href="#l4.136"></a><span id="l4.136">     def cleanup(self):</span>
<a href="#l4.137"></a><span id="l4.137">         '''</span>
<a href="#l4.138"></a><span id="l4.138">         Do not cleanup at all.  The next iteration will cleanup for us, but</span>
<a href="#l4.139"></a><span id="l4.139">         until that time it's useful for debugging failures to leave everything</span>
<a href="#l4.140"></a><span id="l4.140">         around.</span>
<a href="#l4.141"></a><span id="l4.141">         '''</span>
<a href="#l4.142"></a><span id="l4.142">         pass</span>
<a href="#l4.143"></a><span id="l4.143"> </span>
<a href="#l4.144"></a><span id="l4.144" class="difflineminus">-class ThunderTestRunner(mozrunner.ThunderbirdRunner):</span>
<a href="#l4.145"></a><span id="l4.145" class="difflineplus">+def ThunderTestRunner(*args, **kwargs):</span>
<a href="#l4.146"></a><span id="l4.146" class="difflineplus">+    kwargs['env'] = env = dict(os.environ)</span>
<a href="#l4.147"></a><span id="l4.147" class="difflineplus">+    # note, we do NOT want to set NO_EM_RESTART or jsbridge wouldn't work</span>
<a href="#l4.148"></a><span id="l4.148" class="difflineplus">+    # avoid dialogs on windows</span>
<a href="#l4.149"></a><span id="l4.149" class="difflineplus">+    if 'NO_EM_RESTART' in env:</span>
<a href="#l4.150"></a><span id="l4.150" class="difflineplus">+        del env['NO_EM_RESTART']</span>
<a href="#l4.151"></a><span id="l4.151" class="difflineplus">+    if 'XPCOM_DEBUG_BREAK' not in env:</span>
<a href="#l4.152"></a><span id="l4.152" class="difflineplus">+        env['XPCOM_DEBUG_BREAK'] = 'stack'</span>
<a href="#l4.153"></a><span id="l4.153" class="difflineplus">+    # do not reuse an existing instance</span>
<a href="#l4.154"></a><span id="l4.154" class="difflineplus">+    env['MOZ_NO_REMOTE'] = '1'</span>
<a href="#l4.155"></a><span id="l4.155" class="difflineplus">+</span>
<a href="#l4.156"></a><span id="l4.156" class="difflineplus">+    return mozrunner.ThunderbirdRunner(*args, **kwargs)</span>
<a href="#l4.157"></a><span id="l4.157" class="difflineplus">+</span>
<a href="#l4.158"></a><span id="l4.158" class="difflineplus">+class ThunderTestMozmill(mozmill.MozMill):</span>
<a href="#l4.159"></a><span id="l4.159">     VNC_SERVER_PATH = '/usr/bin/vncserver'</span>
<a href="#l4.160"></a><span id="l4.160">     VNC_PASSWD_PATH = '~/.vnc/passwd'</span>
<a href="#l4.161"></a><span id="l4.161"> </span>
<a href="#l4.162"></a><span id="l4.162">     def __init__(self, *args, **kwargs):</span>
<a href="#l4.163"></a><span id="l4.163" class="difflineminus">-        kwargs['env'] = env = dict(os.environ)</span>
<a href="#l4.164"></a><span id="l4.164" class="difflineminus">-        # note, we do NOT want to set NO_EM_RESTART or jsbridge wouldn't work</span>
<a href="#l4.165"></a><span id="l4.165" class="difflineminus">-        # avoid dialogs on windows</span>
<a href="#l4.166"></a><span id="l4.166" class="difflineminus">-        if 'NO_EM_RESTART' in env:</span>
<a href="#l4.167"></a><span id="l4.167" class="difflineminus">-            del env['NO_EM_RESTART']</span>
<a href="#l4.168"></a><span id="l4.168" class="difflineminus">-        if 'XPCOM_DEBUG_BREAK' not in env:</span>
<a href="#l4.169"></a><span id="l4.169" class="difflineminus">-            env['XPCOM_DEBUG_BREAK'] = 'stack'</span>
<a href="#l4.170"></a><span id="l4.170" class="difflineminus">-        # do not reuse an existing instance</span>
<a href="#l4.171"></a><span id="l4.171" class="difflineminus">-        env['MOZ_NO_REMOTE'] = '1'</span>
<a href="#l4.172"></a><span id="l4.172" class="difflineminus">-</span>
<a href="#l4.173"></a><span id="l4.173">         # Only use the VNC server if the capability is available and a password</span>
<a href="#l4.174"></a><span id="l4.174">         # is already defined so this can run without prompting the user.</span>
<a href="#l4.175"></a><span id="l4.175">         self.use_vnc_server = (</span>
<a href="#l4.176"></a><span id="l4.176">             platform.system() == 'Linux' and</span>
<a href="#l4.177"></a><span id="l4.177">             os.path.isfile(self.VNC_SERVER_PATH) and</span>
<a href="#l4.178"></a><span id="l4.178">             os.path.isfile(os.path.expanduser(self.VNC_PASSWD_PATH)) and</span>
<a href="#l4.179"></a><span id="l4.179">             env.get('MOZMILL_NO_VNC') != '1')</span>
<a href="#l4.180"></a><span id="l4.180"> </span>
<a href="#l4.181"></a><span id="l4.181">         global USE_RICH_FAILURES</span>
<a href="#l4.182"></a><span id="l4.182" class="difflineminus">-        USE_RICH_FAILURES = (env.get('MOZMILL_RICH_FAILURES') == '1')</span>
<a href="#l4.183"></a><span id="l4.183" class="difflineplus">+        USE_RICH_FAILURES = (os.environ.get('MOZMILL_RICH_FAILURES') == '1')</span>
<a href="#l4.184"></a><span id="l4.184"> </span>
<a href="#l4.185"></a><span id="l4.185" class="difflineminus">-        mozrunner.Runner.__init__(self, *args, **kwargs)</span>
<a href="#l4.186"></a><span id="l4.186" class="difflineplus">+        super(ThunderTestMozmill, self).__init__(*args, **kwargs)</span>
<a href="#l4.187"></a><span id="l4.187"> </span>
<a href="#l4.188"></a><span id="l4.188" class="difflineminus">-    def find_binary(self):</span>
<a href="#l4.189"></a><span id="l4.189" class="difflineminus">-        return self.profile.app_path</span>
<a href="#l4.190"></a><span id="l4.190" class="difflineplus">+    def start(self, profile=None, runner=None):</span>
<a href="#l4.191"></a><span id="l4.191" class="difflineplus">+        if not profile:</span>
<a href="#l4.192"></a><span id="l4.192" class="difflineplus">+            profile = self.profile_class(addons=[jsbridge.extension_path, extension_path])</span>
<a href="#l4.193"></a><span id="l4.193" class="difflineplus">+        self.profile = profile</span>
<a href="#l4.194"></a><span id="l4.194" class="difflineplus">+        </span>
<a href="#l4.195"></a><span id="l4.195" class="difflineplus">+        if not runner:</span>
<a href="#l4.196"></a><span id="l4.196" class="difflineplus">+            runner = self.runner_class(profile=self.profile, </span>
<a href="#l4.197"></a><span id="l4.197" class="difflineplus">+                                       cmdargs=[&quot;-jsbridge&quot;, str(self.jsbridge_port)])</span>
<a href="#l4.198"></a><span id="l4.198" class="difflineplus">+        self.runner = runner</span>
<a href="#l4.199"></a><span id="l4.199"> </span>
<a href="#l4.200"></a><span id="l4.200" class="difflineminus">-    def start(self):</span>
<a href="#l4.201"></a><span id="l4.201">         if self.use_vnc_server:</span>
<a href="#l4.202"></a><span id="l4.202">             try:</span>
<a href="#l4.203"></a><span id="l4.203">                 subprocess.check_call([self.VNC_SERVER_PATH, ':99'])</span>
<a href="#l4.204"></a><span id="l4.204">             except subprocess.CalledProcessError, ex:</span>
<a href="#l4.205"></a><span id="l4.205">                 # Okay, so that display probably already exists.  We can either</span>
<a href="#l4.206"></a><span id="l4.206">                 # use it as-is or kill it.  I'm deciding we want to kill it</span>
<a href="#l4.207"></a><span id="l4.207">                 # since there might be other processes alive in there that</span>
<a href="#l4.208"></a><span id="l4.208">                 # want to make trouble for us.</span>
<a href="#l4.209"></a><span id="l4.209">                 subprocess.check_call([self.VNC_SERVER_PATH, '-kill', ':99'])</span>
<a href="#l4.210"></a><span id="l4.210">                 # Now let's try again.  if this didn't work, let's just let</span>
<a href="#l4.211"></a><span id="l4.211">                 # the exception kill us.</span>
<a href="#l4.212"></a><span id="l4.212">                 subprocess.check_call([self.VNC_SERVER_PATH, ':99'])</span>
<a href="#l4.213"></a><span id="l4.213">             self.vnc_alive = True</span>
<a href="#l4.214"></a><span id="l4.214" class="difflineminus">-            self.env['DISPLAY'] = ':99'</span>
<a href="#l4.215"></a><span id="l4.215" class="difflineplus">+            self.runner.env['DISPLAY'] = ':99'</span>
<a href="#l4.216"></a><span id="l4.216"> </span>
<a href="#l4.217"></a><span id="l4.217">         if wrapper is not None and hasattr(wrapper, &quot;on_before_start&quot;):</span>
<a href="#l4.218"></a><span id="l4.218" class="difflineminus">-            wrapper.on_before_start(self.profile)</span>
<a href="#l4.219"></a><span id="l4.219" class="difflineplus">+            wrapper.on_before_start(self.runner.profile)</span>
<a href="#l4.220"></a><span id="l4.220"> </span>
<a href="#l4.221"></a><span id="l4.221" class="difflineminus">-        return mozrunner.ThunderbirdRunner.start(self)</span>
<a href="#l4.222"></a><span id="l4.222" class="difflineplus">+        return super(ThunderTestMozmill, self).start(profile, runner)</span>
<a href="#l4.223"></a><span id="l4.223"> </span>
<a href="#l4.224"></a><span id="l4.224" class="difflineminus">-    def wait(self, timeout=None):</span>
<a href="#l4.225"></a><span id="l4.225" class="difflineplus">+    def stop_runner(self, *args, **kwargs):</span>
<a href="#l4.226"></a><span id="l4.226">         '''</span>
<a href="#l4.227"></a><span id="l4.227">         Wrap the call to wait in logic that kills the VNC server when we are</span>
<a href="#l4.228"></a><span id="l4.228">         done waiting.  During normal operation, wait is the last thing.  In</span>
<a href="#l4.229"></a><span id="l4.229">         the keyboard interrupt case wait will die due to the interrupt and</span>
<a href="#l4.230"></a><span id="l4.230">         stop/kill will be killed.  Since we are wrapping wait, we don't need</span>
<a href="#l4.231"></a><span id="l4.231">         to specialize for stop/kill though.</span>
<a href="#l4.232"></a><span id="l4.232">         '''</span>
<a href="#l4.233"></a><span id="l4.233">         try:</span>
<a href="#l4.234"></a><span id="l4.234" class="difflineminus">-            return mozrunner.ThunderbirdRunner.wait(self, timeout)</span>
<a href="#l4.235"></a><span id="l4.235" class="difflineplus">+            return super(ThunderTestMozmill, self).stop_runner(*args, **kwargs)</span>
<a href="#l4.236"></a><span id="l4.236">         finally:</span>
<a href="#l4.237"></a><span id="l4.237">             try:</span>
<a href="#l4.238"></a><span id="l4.238">                 if self.use_vnc_server and self.vnc_alive:</span>
<a href="#l4.239"></a><span id="l4.239">                     subprocess.check_call([self.VNC_SERVER_PATH,</span>
<a href="#l4.240"></a><span id="l4.240">                                            '-kill', ':99'])</span>
<a href="#l4.241"></a><span id="l4.241">             except Exception, ex:</span>
<a href="#l4.242"></a><span id="l4.242">                 print '!!! Exception during killing VNC server:', ex</span>
<a href="#l4.243"></a><span id="l4.243"> </span>
<a href="#l4.244"></a><span id="l4.244" class="difflineat">@@ -327,39 +324,44 @@ def monkeypatched_15_run_tests(self, tes</span>
<a href="#l4.245"></a><span id="l4.245">     # Give a second for any callbacks to finish.</span>
<a href="#l4.246"></a><span id="l4.246">     sleep(1)</span>
<a href="#l4.247"></a><span id="l4.247"> if hasattr(mozmill.MozMill, 'find_tests'):</span>
<a href="#l4.248"></a><span id="l4.248">     # Monkey-patch run_tests</span>
<a href="#l4.249"></a><span id="l4.249">     mozmill.MozMill.old_run_tests = mozmill.MozMill.run_tests</span>
<a href="#l4.250"></a><span id="l4.250">     mozmill.MozMill.run_tests = monkeypatched_15_run_tests</span>
<a href="#l4.251"></a><span id="l4.251"> </span>
<a href="#l4.252"></a><span id="l4.252"> class ThunderTestCLI(mozmill.CLI):</span>
<a href="#l4.253"></a><span id="l4.253" class="difflineplus">+    mozmill_class = ThunderTestMozmill</span>
<a href="#l4.254"></a><span id="l4.254"> </span>
<a href="#l4.255"></a><span id="l4.255" class="difflineminus">-    profile_class = ThunderTestProfile</span>
<a href="#l4.256"></a><span id="l4.256" class="difflineminus">-    runner_class = ThunderTestRunner</span>
<a href="#l4.257"></a><span id="l4.257" class="difflineminus">-    parser_options = copy.copy(mozmill.CLI.parser_options)</span>
<a href="#l4.258"></a><span id="l4.258" class="difflineminus">-    parser_options[('--symbols-path',)] = {&quot;default&quot;: None, &quot;dest&quot;: &quot;symbols&quot;,</span>
<a href="#l4.259"></a><span id="l4.259" class="difflineminus">-                                           &quot;help&quot;: &quot;The path to the symbol files from build_symbols&quot;}</span>
<a href="#l4.260"></a><span id="l4.260" class="difflineminus">-    parser_options[('--plugins-path',)] = {&quot;default&quot;: None, &quot;dest&quot;: &quot;plugins&quot;,</span>
<a href="#l4.261"></a><span id="l4.261" class="difflineminus">-                                           &quot;help&quot;: &quot;The path to the plugins directory for the created profile&quot;}</span>
<a href="#l4.262"></a><span id="l4.262" class="difflineplus">+    def add_options(self, parser):</span>
<a href="#l4.263"></a><span id="l4.263" class="difflineplus">+        mozmill.CLI.add_options(self, parser)</span>
<a href="#l4.264"></a><span id="l4.264" class="difflineplus">+        parser.add_option('--symbols-path', default=None, dest=&quot;symbols&quot;,</span>
<a href="#l4.265"></a><span id="l4.265" class="difflineplus">+                          help=&quot;The path to the symbol files from build_symbols&quot;)</span>
<a href="#l4.266"></a><span id="l4.266" class="difflineplus">+        parser.add_option('--plugins-path', default=None, dest=&quot;plugins&quot;,</span>
<a href="#l4.267"></a><span id="l4.267" class="difflineplus">+                          help=&quot;The path to the plugins directory for the created profile&quot;)</span>
<a href="#l4.268"></a><span id="l4.268"> </span>
<a href="#l4.269"></a><span id="l4.269">     def __init__(self, *args, **kwargs):</span>
<a href="#l4.270"></a><span id="l4.270">         global SYMBOLS_PATH, PLUGINS_PATH, TEST_NAME</span>
<a href="#l4.271"></a><span id="l4.271"> </span>
<a href="#l4.272"></a><span id="l4.272" class="difflineminus">-        # mozmill 1.5.4 still explicitly hardcodes references to Firefox; in</span>
<a href="#l4.273"></a><span id="l4.273" class="difflineminus">-        # order to avoid missing out on initializer logic or needing to copy</span>
<a href="#l4.274"></a><span id="l4.274" class="difflineminus">-        # it, we monkeypatch mozmill's view of mozrunner.  (Keep in mind that</span>
<a href="#l4.275"></a><span id="l4.275" class="difflineminus">-        # the python module import process shallow copies dictionaries...)</span>
<a href="#l4.276"></a><span id="l4.276" class="difflineminus">-        mozmill.mozrunner.FirefoxRunner = self.runner_class</span>
<a href="#l4.277"></a><span id="l4.277" class="difflineminus">-        mozmill.mozrunner.FirefoxProfile = self.profile_class</span>
<a href="#l4.278"></a><span id="l4.278" class="difflineminus">-</span>
<a href="#l4.279"></a><span id="l4.279">         # note: we previously hardcoded a JS bridge timeout of 300 seconds,</span>
<a href="#l4.280"></a><span id="l4.280">         # but the default is now 60 seconds...</span>
<a href="#l4.281"></a><span id="l4.281">         mozmill.CLI.__init__(self, *args, **kwargs)</span>
<a href="#l4.282"></a><span id="l4.282"> </span>
<a href="#l4.283"></a><span id="l4.283" class="difflineplus">+        # Mozrunner expects the filename on OS X to point to the executable, but</span>
<a href="#l4.284"></a><span id="l4.284" class="difflineplus">+        # we only have the directory passed in. Remedy this.</span>
<a href="#l4.285"></a><span id="l4.285" class="difflineplus">+        if (sys.platform == 'darwin' and</span>
<a href="#l4.286"></a><span id="l4.286" class="difflineplus">+                self.options.binary.find('Contents/MacOS/') == -1):</span>
<a href="#l4.287"></a><span id="l4.287" class="difflineplus">+            self.options.binary = os.path.join(self.options.binary,</span>
<a href="#l4.288"></a><span id="l4.288" class="difflineplus">+                'Contents/MacOS/thunderbird-bin')</span>
<a href="#l4.289"></a><span id="l4.289" class="difflineplus">+</span>
<a href="#l4.290"></a><span id="l4.290" class="difflineplus">+        # Add these manually after the fact. No way to override the defaults</span>
<a href="#l4.291"></a><span id="l4.291" class="difflineplus">+        # from mozrunner that I can see.</span>
<a href="#l4.292"></a><span id="l4.292" class="difflineplus">+        self.runner_class = ThunderTestRunner</span>
<a href="#l4.293"></a><span id="l4.293" class="difflineplus">+        self.profile_class = ThunderTestProfile</span>
<a href="#l4.294"></a><span id="l4.294" class="difflineplus">+</span>
<a href="#l4.295"></a><span id="l4.295">         SYMBOLS_PATH = self.options.symbols</span>
<a href="#l4.296"></a><span id="l4.296">         PLUGINS_PATH = self.options.plugins</span>
<a href="#l4.297"></a><span id="l4.297">         if isinstance(self.options.test, basestring):</span>
<a href="#l4.298"></a><span id="l4.298">             test_paths = [self.options.test]</span>
<a href="#l4.299"></a><span id="l4.299">         else:</span>
<a href="#l4.300"></a><span id="l4.300">             test_paths = self.options.test</span>
<a href="#l4.301"></a><span id="l4.301">         TEST_NAME = ', '.join([os.path.basename(t) for t in test_paths])</span>
<a href="#l4.302"></a><span id="l4.302"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/test/resources/installmozmill.py</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/test/resources/installmozmill.py</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -66,31 +66,33 @@ def main(args=None):</span>
<a href="#l5.4"></a><span id="l5.4">   os.chdir(source)</span>
<a href="#l5.5"></a><span id="l5.5"> </span>
<a href="#l5.6"></a><span id="l5.6">   # check for existence of necessary files</span>
<a href="#l5.7"></a><span id="l5.7">   if not os.path.exists('virtualenv'):</span>
<a href="#l5.8"></a><span id="l5.8">     print &quot;File not found: virtualenv&quot;</span>
<a href="#l5.9"></a><span id="l5.9">     sys.exit(1)</span>
<a href="#l5.10"></a><span id="l5.10"> </span>
<a href="#l5.11"></a><span id="l5.11">   # packages to install in dependency order</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-  packages = [&quot;mozrunner&quot;, &quot;jsbridge&quot;, &quot;mozmill&quot;]</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+  packages = [&quot;jsbridge&quot;, &quot;mozmill&quot;]</span>
<a href="#l5.14"></a><span id="l5.14"> </span>
<a href="#l5.15"></a><span id="l5.15">   # create the virtualenv and install packages</span>
<a href="#l5.16"></a><span id="l5.16">   env = os.environ.copy()</span>
<a href="#l5.17"></a><span id="l5.17">   env.pop('PYTHONHOME', None)</span>
<a href="#l5.18"></a><span id="l5.18">   # The --no-site-packages is because of https://github.com/pypa/virtualenv/issues/165</span>
<a href="#l5.19"></a><span id="l5.19">   returncode = call([sys.executable, os.path.join('virtualenv', 'virtualenv.py'),</span>
<a href="#l5.20"></a><span id="l5.20">                      destination], env=env)</span>
<a href="#l5.21"></a><span id="l5.21">   if returncode:</span>
<a href="#l5.22"></a><span id="l5.22">     print 'Failure to install virtualenv'</span>
<a href="#l5.23"></a><span id="l5.23">     sys.exit(returncode)</span>
<a href="#l5.24"></a><span id="l5.24">   pip = entry_point_path(destination, 'pip')</span>
<a href="#l5.25"></a><span id="l5.25"> </span>
<a href="#l5.26"></a><span id="l5.26">   # Install mozbase packages to the virtualenv</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineminus">-  mozbase_packages = ['manifestparser', 'mozfile', 'mozinfo']</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineplus">+  mozbase_packages = ['manifestparser', 'mozfile', 'mozinfo', 'mozlog',</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineplus">+    'mozprofile', 'mozcrash', 'moznetwork', 'mozprocess', 'mozdevice',</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineplus">+    'mozrunner']</span>
<a href="#l5.31"></a><span id="l5.31">   returncode = call([pip, 'install'] +</span>
<a href="#l5.32"></a><span id="l5.32">     [os.path.join(mozbase, package) for package in mozbase_packages], env=env)</span>
<a href="#l5.33"></a><span id="l5.33">   if returncode:</span>
<a href="#l5.34"></a><span id="l5.34">     print 'Failure to install packages'</span>
<a href="#l5.35"></a><span id="l5.35">     sys.exit(returncode)</span>
<a href="#l5.36"></a><span id="l5.36"> </span>
<a href="#l5.37"></a><span id="l5.37">   # Install mozmill</span>
<a href="#l5.38"></a><span id="l5.38">   returncode = call([pip, 'install'] + [os.path.abspath(package) for package in packages], env=env)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/test/resources/jsbridge/jsbridge/__init__.py</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/test/resources/jsbridge/jsbridge/__init__.py</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -83,51 +83,56 @@ def wait_and_create_network(host, port, </span>
<a href="#l6.4"></a><span id="l6.4">     </span>
<a href="#l6.5"></a><span id="l6.5">     return back_channel, bridge</span>
<a href="#l6.6"></a><span id="l6.6"> </span>
<a href="#l6.7"></a><span id="l6.7"> class CLI(mozrunner.CLI):</span>
<a href="#l6.8"></a><span id="l6.8">     &quot;&quot;&quot;Command line interface.&quot;&quot;&quot;</span>
<a href="#l6.9"></a><span id="l6.9">     </span>
<a href="#l6.10"></a><span id="l6.10">     module = &quot;jsbridge&quot;</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-    parser_options = copy.copy(mozrunner.CLI.parser_options)</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-    parser_options[('-D', '--debug',)] = dict(dest=&quot;debug&quot;, </span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-                                             action=&quot;store_true&quot;,</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineminus">-                                             help=&quot;Debug mode&quot;, </span>
<a href="#l6.16"></a><span id="l6.16" class="difflineminus">-                                             metavar=&quot;JSBRIDGE_DEBUG&quot;,</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineminus">-                                             default=False )</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineminus">-    parser_options[('-s', '--shell',)] = dict(dest=&quot;shell&quot;, </span>
<a href="#l6.19"></a><span id="l6.19" class="difflineminus">-                                             action=&quot;store_true&quot;,</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineminus">-                                             help=&quot;Start a Python shell&quot;,</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineminus">-                                             metavar=&quot;JSBRIDGE_SHELL&quot;,</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineminus">-                                             default=False )</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineminus">-    parser_options[('-u', '--usecode',)] = dict(dest=&quot;usecode&quot;, action=&quot;store_true&quot;,</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineminus">-                                               help=&quot;Use code module instead of iPython&quot;,</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineminus">-                                               default=False)</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineminus">-    parser_options[('-P', '--port')] = dict(dest=&quot;port&quot;, default=&quot;24242&quot;,</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineminus">-                                            help=&quot;TCP port to run jsbridge on.&quot;)</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineplus">+    def add_options(self, parser):</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineplus">+        &quot;&quot;&quot;add options to parser&quot;&quot;&quot;</span>
<a href="#l6.30"></a><span id="l6.30"> </span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">-    def get_profile(self, *args, **kwargs):</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+        mozrunner.CLI.add_options(self, parser)</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineplus">+        parser.add_option('-D', '--debug', dest=&quot;debug&quot;, </span>
<a href="#l6.34"></a><span id="l6.34" class="difflineplus">+                          action=&quot;store_true&quot;,</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineplus">+                          help=&quot;Debug mode&quot;, </span>
<a href="#l6.36"></a><span id="l6.36" class="difflineplus">+                          metavar=&quot;JSBRIDGE_DEBUG&quot;,</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineplus">+                          default=False)</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineplus">+        parser.add_option('-s', '--shell', dest=&quot;shell&quot;, </span>
<a href="#l6.39"></a><span id="l6.39" class="difflineplus">+                          action=&quot;store_true&quot;,</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineplus">+                          help=&quot;Start a Python shell&quot;,</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineplus">+                          metavar=&quot;JSBRIDGE_SHELL&quot;,</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineplus">+                          default=False)</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineplus">+        parser.add_option('-u', '--usecode', dest=&quot;usecode&quot;,</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineplus">+                          action=&quot;store_true&quot;,</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineplus">+                          help=&quot;Use code module instead of iPython&quot;,</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineplus">+                          default=False)</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineplus">+        parser.add_option('-P', '--port', dest=&quot;port&quot;, default=&quot;24242&quot;,</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineplus">+                          help=&quot;TCP port to run jsbridge on.&quot;)</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineplus">+</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineplus">+    def profile_args(self):</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineplus">+        profargs = super(CLI, self).profile_args()</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineplus">+        # Bug 1103551: re-enable these preferences.</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineplus">+        #if self.options.debug:</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineplus">+        #    profargs.setdefault('prefences', []).update({</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineplus">+        #      'extensions.checkCompatibility':False,</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineplus">+        #      'devtools.errorconsole.enabled':True,</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineplus">+        #      'javascript.options.strict': True</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineplus">+        #    })</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineplus">+        profargs.setdefault('addons', []).append(extension_path)</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineplus">+        return profargs</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineplus">+</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineplus">+    def command_args(self):</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineplus">+        args = super(CLI, self).command_args()</span>
<a href="#l6.64"></a><span id="l6.64">         if self.options.debug:</span>
<a href="#l6.65"></a><span id="l6.65" class="difflineminus">-            kwargs.setdefault('preferences', {}).update({</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineminus">-              'extensions.checkCompatibility':False,</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineminus">-              'devtools.errorconsole.enabled':True,</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineminus">-              'javascript.options.strict': True</span>
<a href="#l6.69"></a><span id="l6.69" class="difflineminus">-            })</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineminus">-        profile = mozrunner.CLI.get_profile(self, *args, **kwargs)</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineminus">-        profile.install_addon(extension_path)</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineminus">-        return profile</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineminus">-        </span>
<a href="#l6.74"></a><span id="l6.74" class="difflineminus">-    def get_runner(self, *args, **kwargs):</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineminus">-        runner = super(CLI, self).get_runner(*args, **kwargs)</span>
<a href="#l6.76"></a><span id="l6.76" class="difflineminus">-        if self.options.debug:</span>
<a href="#l6.77"></a><span id="l6.77" class="difflineminus">-            runner.cmdargs.append('-jsconsole')</span>
<a href="#l6.78"></a><span id="l6.78" class="difflineminus">-        if not '-jsbridge' in runner.cmdargs: </span>
<a href="#l6.79"></a><span id="l6.79" class="difflineminus">-            runner.cmdargs += ['-jsbridge', self.options.port]</span>
<a href="#l6.80"></a><span id="l6.80" class="difflineminus">-        return runner</span>
<a href="#l6.81"></a><span id="l6.81" class="difflineplus">+            args.append('-jsconsole')</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineplus">+        if not 'jsbridge' in args:</span>
<a href="#l6.83"></a><span id="l6.83" class="difflineplus">+            args += ['-jsbridge', self.options.port]</span>
<a href="#l6.84"></a><span id="l6.84" class="difflineplus">+        return args</span>
<a href="#l6.85"></a><span id="l6.85">         </span>
<a href="#l6.86"></a><span id="l6.86">     def run(self):</span>
<a href="#l6.87"></a><span id="l6.87">         runner = self.create_runner()</span>
<a href="#l6.88"></a><span id="l6.88">         runner.start()</span>
<a href="#l6.89"></a><span id="l6.89">         self.start_jsbridge_network()</span>
<a href="#l6.90"></a><span id="l6.90">         if self.options.shell:</span>
<a href="#l6.91"></a><span id="l6.91">             self.start_shell(runner)</span>
<a href="#l6.92"></a><span id="l6.92">         else:</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mail/test/resources/jsbridge/setup.py</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mail/test/resources/jsbridge/setup.py</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -39,17 +39,17 @@ import sys</span>
<a href="#l7.4"></a><span id="l7.4"> from setuptools import setup, find_packages</span>
<a href="#l7.5"></a><span id="l7.5"> </span>
<a href="#l7.6"></a><span id="l7.6"> desc = &quot;&quot;&quot;Python to JavaScript bridge interface.&quot;&quot;&quot;</span>
<a href="#l7.7"></a><span id="l7.7"> summ = &quot;&quot;&quot;A powerful and extensible Python to JavaScript bridge interface.&quot;&quot;&quot;</span>
<a href="#l7.8"></a><span id="l7.8"> </span>
<a href="#l7.9"></a><span id="l7.9"> PACKAGE_NAME = &quot;jsbridge&quot;</span>
<a href="#l7.10"></a><span id="l7.10"> PACKAGE_VERSION = &quot;2.4.14&quot;</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-requires = ['mozrunner == 2.5.13']</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+requires = ['mozrunner &gt;= 6.0']</span>
<a href="#l7.14"></a><span id="l7.14"> </span>
<a href="#l7.15"></a><span id="l7.15"> setup(name=PACKAGE_NAME,</span>
<a href="#l7.16"></a><span id="l7.16">       version=PACKAGE_VERSION,</span>
<a href="#l7.17"></a><span id="l7.17">       description=desc,</span>
<a href="#l7.18"></a><span id="l7.18">       long_description=summ,</span>
<a href="#l7.19"></a><span id="l7.19">       author='Mikeal Rogers, Mozilla',</span>
<a href="#l7.20"></a><span id="l7.20">       author_email='mikeal.rogers@gmail.com',</span>
<a href="#l7.21"></a><span id="l7.21">       url='http://github.com/mozautomation/mozmill',</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mail/test/resources/mozmill/mozmill/__init__.py</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mail/test/resources/mozmill/mozmill/__init__.py</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -54,16 +54,17 @@ except:</span>
<a href="#l8.4"></a><span id="l8.4">     import simplejson as json</span>
<a href="#l8.5"></a><span id="l8.5"> </span>
<a href="#l8.6"></a><span id="l8.6"> # setup logger</span>
<a href="#l8.7"></a><span id="l8.7"> import logging</span>
<a href="#l8.8"></a><span id="l8.8"> logger = logging.getLogger('mozmill')</span>
<a href="#l8.9"></a><span id="l8.9"> </span>
<a href="#l8.10"></a><span id="l8.10"> import jsbridge</span>
<a href="#l8.11"></a><span id="l8.11"> from jsbridge.network import JSBridgeDisconnectError</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+import mozprofile</span>
<a href="#l8.13"></a><span id="l8.13"> import mozrunner</span>
<a href="#l8.14"></a><span id="l8.14"> </span>
<a href="#l8.15"></a><span id="l8.15"> from time import sleep</span>
<a href="#l8.16"></a><span id="l8.16"> </span>
<a href="#l8.17"></a><span id="l8.17"> basedir = os.path.abspath(os.path.dirname(__file__))</span>
<a href="#l8.18"></a><span id="l8.18"> </span>
<a href="#l8.19"></a><span id="l8.19"> extension_path = os.path.join(basedir, 'extension')</span>
<a href="#l8.20"></a><span id="l8.20"> </span>
<a href="#l8.21"></a><span id="l8.21" class="difflineat">@@ -119,17 +120,17 @@ class MozMill(object):</span>
<a href="#l8.22"></a><span id="l8.22">     You should *NOT* vary from this order of execution.  If you have need to</span>
<a href="#l8.23"></a><span id="l8.23">     run different sets of tests, create a new instantiation of MozMill</span>
<a href="#l8.24"></a><span id="l8.24">     &quot;&quot;&quot;</span>
<a href="#l8.25"></a><span id="l8.25"> </span>
<a href="#l8.26"></a><span id="l8.26">     report_type = 'mozmill-test'</span>
<a href="#l8.27"></a><span id="l8.27"> </span>
<a href="#l8.28"></a><span id="l8.28">     def __init__(self,</span>
<a href="#l8.29"></a><span id="l8.29">                  runner_class=mozrunner.FirefoxRunner, </span>
<a href="#l8.30"></a><span id="l8.30" class="difflineminus">-                 profile_class=mozrunner.FirefoxProfile,</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineplus">+                 profile_class=mozprofile.FirefoxProfile,</span>
<a href="#l8.32"></a><span id="l8.32">                  jsbridge_port=24242,</span>
<a href="#l8.33"></a><span id="l8.33">                  jsbridge_timeout=60):</span>
<a href="#l8.34"></a><span id="l8.34">         &quot;&quot;&quot;</span>
<a href="#l8.35"></a><span id="l8.35">         - runner_class : which mozrunner class to use</span>
<a href="#l8.36"></a><span id="l8.36">         - profile_class : which class to use to generate application profiles</span>
<a href="#l8.37"></a><span id="l8.37">         - jsbridge_port : port jsbridge uses to connect to to the application</span>
<a href="#l8.38"></a><span id="l8.38">         - jsbridge_timeout : how long to go without jsbridge communication</span>
<a href="#l8.39"></a><span id="l8.39">         &quot;&quot;&quot;</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineat">@@ -699,40 +700,44 @@ class MozMillRestart(MozMill):</span>
<a href="#l8.41"></a><span id="l8.41">         if fatal:</span>
<a href="#l8.42"></a><span id="l8.42">             self.runner.cleanup()</span>
<a href="#l8.43"></a><span id="l8.43"> </span>
<a href="#l8.44"></a><span id="l8.44"> </span>
<a href="#l8.45"></a><span id="l8.45"> class CLI(jsbridge.CLI):</span>
<a href="#l8.46"></a><span id="l8.46">     mozmill_class = MozMill</span>
<a href="#l8.47"></a><span id="l8.47">     module = &quot;mozmill&quot;</span>
<a href="#l8.48"></a><span id="l8.48"> </span>
<a href="#l8.49"></a><span id="l8.49" class="difflineminus">-    parser_options = copy.copy(jsbridge.CLI.parser_options)</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineminus">-    parser_options[(&quot;-t&quot;, &quot;--test&quot;,)] = dict(dest=&quot;test&quot;, action='append', default=[],</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineminus">-                                             help=&quot;Run test&quot;)</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineminus">-    parser_options[(&quot;-l&quot;, &quot;--logfile&quot;,)] = dict(dest=&quot;logfile&quot;, default=None,</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineminus">-                                                help=&quot;Log all events to file.&quot;)</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineminus">-    parser_options[(&quot;--show-errors&quot;,)] = dict(dest=&quot;showerrors&quot;, default=False, </span>
<a href="#l8.55"></a><span id="l8.55" class="difflineminus">-                                              action=&quot;store_true&quot;,</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineminus">-                                              help=&quot;Print logger errors to the console.&quot;)</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineminus">-    parser_options[(&quot;--report&quot;,)] = dict(dest=&quot;report&quot;, default=False,</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineminus">-                                         help=&quot;Report the results. Requires url to results server. Use 'stdout' for stdout.&quot;)</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineminus">-    parser_options[(&quot;--show-all&quot;,)] = dict(dest=&quot;showall&quot;, default=False, action=&quot;store_true&quot;,</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineminus">-                                         help=&quot;Show all test output.&quot;)</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineminus">-    parser_options[(&quot;--timeout&quot;,)] = dict(dest=&quot;timeout&quot;, type=&quot;float&quot;,</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineminus">-                                          default=60., </span>
<a href="#l8.63"></a><span id="l8.63" class="difflineminus">-                                          help=&quot;seconds before harness timeout if no communication is taking place&quot;)</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineminus">-    parser_options[(&quot;-m&quot;, &quot;--manifest&quot;)] = dict(dest='manifests', action='append',</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineminus">-                                                help='test manifest .ini file')</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineminus">-    parser_options[(&quot;--app-arg&quot;,)] = dict(dest='appArgs', action='append', default=[],</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineminus">-                                          help='provides an argument to the test application')</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineplus">+    def add_options(self, parser):</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineplus">+        jsbridge.CLI.add_options(self, parser)</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineplus">+        parser.add_option(&quot;-t&quot;, &quot;--test&quot;, dest=&quot;test&quot;, action='append',</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineplus">+                          default=[],</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineplus">+                          help=&quot;Run test&quot;)</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineplus">+        parser.add_option(&quot;-l&quot;, &quot;--logfile&quot;, dest=&quot;logfile&quot;,</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineplus">+                          default=None,</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineplus">+                          help=&quot;Log all events to file.&quot;)</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineplus">+        parser.add_option(&quot;--show-errors&quot;, dest=&quot;showerrors&quot;,</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineplus">+                          default=False, </span>
<a href="#l8.78"></a><span id="l8.78" class="difflineplus">+                          action=&quot;store_true&quot;,</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineplus">+                          help=&quot;Print logger errors to the console.&quot;)</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineplus">+        parser.add_option(&quot;--report&quot;, dest=&quot;report&quot;, default=False,</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineplus">+                          help=&quot;Report the results. Requires url to results server. Use 'stdout' for stdout.&quot;)</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineplus">+        parser.add_option(&quot;--show-all&quot;, dest=&quot;showall&quot;, default=False,</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineplus">+                          action=&quot;store_true&quot;,</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineplus">+                          help=&quot;Show all test output.&quot;)</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineplus">+        parser.add_option(&quot;--timeout&quot;, dest=&quot;timeout&quot;, type=&quot;float&quot;,</span>
<a href="#l8.86"></a><span id="l8.86" class="difflineplus">+                          default=60., </span>
<a href="#l8.87"></a><span id="l8.87" class="difflineplus">+                          help=&quot;seconds before harness timeout if no communication is taking place&quot;)</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineplus">+        parser.add_option(&quot;-m&quot;, &quot;--manifest&quot;, dest='manifests',</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineplus">+                          action='append',</span>
<a href="#l8.90"></a><span id="l8.90" class="difflineplus">+                          help='test manifest .ini file')</span>
<a href="#l8.91"></a><span id="l8.91"> </span>
<a href="#l8.92"></a><span id="l8.92">     def __init__(self, *args, **kwargs):</span>
<a href="#l8.93"></a><span id="l8.93">         jsbridge.CLI.__init__(self, *args, **kwargs)</span>
<a href="#l8.94"></a><span id="l8.94">         self.mozmill = self.mozmill_class(runner_class=mozrunner.FirefoxRunner,</span>
<a href="#l8.95"></a><span id="l8.95" class="difflineminus">-                                          profile_class=mozrunner.FirefoxProfile,</span>
<a href="#l8.96"></a><span id="l8.96" class="difflineplus">+                                          profile_class=mozprofile.FirefoxProfile,</span>
<a href="#l8.97"></a><span id="l8.97">                                           jsbridge_port=int(self.options.port),</span>
<a href="#l8.98"></a><span id="l8.98">                                           jsbridge_timeout=self.options.timeout,</span>
<a href="#l8.99"></a><span id="l8.99">                                           )</span>
<a href="#l8.100"></a><span id="l8.100"> </span>
<a href="#l8.101"></a><span id="l8.101">         self.tests = []</span>
<a href="#l8.102"></a><span id="l8.102"> </span>
<a href="#l8.103"></a><span id="l8.103">         # setup log formatting</span>
<a href="#l8.104"></a><span id="l8.104">         self.mozmill.add_global_listener(LoggerListener())</span>
<a href="#l8.105"></a><span id="l8.105" class="difflineat">@@ -743,20 +748,20 @@ class CLI(jsbridge.CLI):</span>
<a href="#l8.106"></a><span id="l8.106">         if self.options.logfile:</span>
<a href="#l8.107"></a><span id="l8.107">             log_options['filename'] = self.options.logfile</span>
<a href="#l8.108"></a><span id="l8.108">             log_options['filemode'] = 'w'</span>
<a href="#l8.109"></a><span id="l8.109">             log_options['level'] = logging.DEBUG</span>
<a href="#l8.110"></a><span id="l8.110">         if self.options.test and self.options.showall:</span>
<a href="#l8.111"></a><span id="l8.111">             log_options['level'] = logging.DEBUG    </span>
<a href="#l8.112"></a><span id="l8.112">         logging.basicConfig(**log_options)</span>
<a href="#l8.113"></a><span id="l8.113"> </span>
<a href="#l8.114"></a><span id="l8.114" class="difflineminus">-    def get_profile(self, *args, **kwargs):</span>
<a href="#l8.115"></a><span id="l8.115" class="difflineminus">-        profile = jsbridge.CLI.get_profile(self, *args, **kwargs)</span>
<a href="#l8.116"></a><span id="l8.116" class="difflineminus">-        profile.install_addon(extension_path)</span>
<a href="#l8.117"></a><span id="l8.117" class="difflineminus">-        return profile</span>
<a href="#l8.118"></a><span id="l8.118" class="difflineplus">+    def profile_args(self):</span>
<a href="#l8.119"></a><span id="l8.119" class="difflineplus">+        profargs = super(CLI, self).profile_args()</span>
<a href="#l8.120"></a><span id="l8.120" class="difflineplus">+        profargs.setdefault('addons', []).append(extension_path)</span>
<a href="#l8.121"></a><span id="l8.121" class="difflineplus">+        return profargs</span>
<a href="#l8.122"></a><span id="l8.122"> </span>
<a href="#l8.123"></a><span id="l8.123">     def run(self):</span>
<a href="#l8.124"></a><span id="l8.124"> </span>
<a href="#l8.125"></a><span id="l8.125">         # read tests from manifests</span>
<a href="#l8.126"></a><span id="l8.126">         if self.options.manifests:</span>
<a href="#l8.127"></a><span id="l8.127">             manifest_parser = manifestparser.TestManifest(manifests=self.options.manifests)</span>
<a href="#l8.128"></a><span id="l8.128"> </span>
<a href="#l8.129"></a><span id="l8.129">             self.tests.extend(manifest_parser.test_paths())</span>
<a href="#l8.130"></a><span id="l8.130" class="difflineat">@@ -826,21 +831,21 @@ class CLI(jsbridge.CLI):</span>
<a href="#l8.131"></a><span id="l8.131">                 self.mozmill.runner.cleanup()</span>
<a href="#l8.132"></a><span id="l8.132"> </span>
<a href="#l8.133"></a><span id="l8.133"> </span>
<a href="#l8.134"></a><span id="l8.134"> class RestartCLI(CLI):</span>
<a href="#l8.135"></a><span id="l8.135">     mozmill_class = MozMillRestart</span>
<a href="#l8.136"></a><span id="l8.136"> </span>
<a href="#l8.137"></a><span id="l8.137"> </span>
<a href="#l8.138"></a><span id="l8.138"> class ThunderbirdCLI(CLI):</span>
<a href="#l8.139"></a><span id="l8.139" class="difflineminus">-    profile_class = mozrunner.ThunderbirdProfile</span>
<a href="#l8.140"></a><span id="l8.140" class="difflineplus">+    profile_class = mozprofile.ThunderbirdProfile</span>
<a href="#l8.141"></a><span id="l8.141">     runner_class = mozrunner.ThunderbirdRunner</span>
<a href="#l8.142"></a><span id="l8.142"> </span>
<a href="#l8.143"></a><span id="l8.143"> class ThunderbirdRestartCLI(RestartCLI):</span>
<a href="#l8.144"></a><span id="l8.144" class="difflineminus">-    profile_class = mozrunner.ThunderbirdProfile</span>
<a href="#l8.145"></a><span id="l8.145" class="difflineplus">+    profile_class = mozprofile.ThunderbirdProfile</span>
<a href="#l8.146"></a><span id="l8.146">     runner_class = mozrunner.ThunderbirdRunner</span>
<a href="#l8.147"></a><span id="l8.147"> </span>
<a href="#l8.148"></a><span id="l8.148"> def enum(*sequential, **named):</span>
<a href="#l8.149"></a><span id="l8.149">     enums = dict(zip(sequential, range(len(sequential))), **named)</span>
<a href="#l8.150"></a><span id="l8.150">     return type('Enum', (), enums)</span>
<a href="#l8.151"></a><span id="l8.151"> </span>
<a href="#l8.152"></a><span id="l8.152"> def cli():</span>
<a href="#l8.153"></a><span id="l8.153">     CLI().run()</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mail/test/resources/mozmill/setup.py</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mail/test/resources/mozmill/setup.py</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -58,17 +58,17 @@ setup(name=PACKAGE_NAME,</span>
<a href="#l9.4"></a><span id="l9.4">       entry_points=&quot;&quot;&quot;</span>
<a href="#l9.5"></a><span id="l9.5">           [console_scripts]</span>
<a href="#l9.6"></a><span id="l9.6">           mozmill = mozmill:cli</span>
<a href="#l9.7"></a><span id="l9.7">           mozmill-thunderbird = mozmill:tbird_cli</span>
<a href="#l9.8"></a><span id="l9.8">           mozmill-restart = mozmill:restart_cli</span>
<a href="#l9.9"></a><span id="l9.9">         &quot;&quot;&quot;,</span>
<a href="#l9.10"></a><span id="l9.10">       platforms =['Any'],</span>
<a href="#l9.11"></a><span id="l9.11">       install_requires = ['jsbridge == 2.4.14',</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-                          'mozrunner == 2.5.13',</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+                          'mozrunner &gt;= 6.0',</span>
<a href="#l9.14"></a><span id="l9.14">                           'manifestparser &gt;= 0.9'],</span>
<a href="#l9.15"></a><span id="l9.15">       classifiers=['Development Status :: 4 - Beta',</span>
<a href="#l9.16"></a><span id="l9.16">                    'Environment :: Console',</span>
<a href="#l9.17"></a><span id="l9.17">                    'Intended Audience :: Developers',</span>
<a href="#l9.18"></a><span id="l9.18">                    'License :: OSI Approved :: Apache Software License',</span>
<a href="#l9.19"></a><span id="l9.19">                    'Operating System :: OS Independent',</span>
<a href="#l9.20"></a><span id="l9.20">                    'Topic :: Software Development :: Libraries :: Python Modules',</span>
<a href="#l9.21"></a><span id="l9.21">                   ]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1">deleted file mode 100644</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineminus">--- a/mail/test/resources/mozrunner/mozrunner/__init__.py</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineplus">+++ /dev/null</span>
<a href="#l10.4"></a><span id="l10.4" class="difflineat">@@ -1,673 +0,0 @@</span>
<a href="#l10.5"></a><span id="l10.5" class="difflineminus">-# ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l10.6"></a><span id="l10.6" class="difflineminus">-# Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l10.7"></a><span id="l10.7" class="difflineminus">-#</span>
<a href="#l10.8"></a><span id="l10.8" class="difflineminus">-# The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l10.9"></a><span id="l10.9" class="difflineminus">-# 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l10.10"></a><span id="l10.10" class="difflineminus">-# the License. You may obtain a copy of the License at</span>
<a href="#l10.11"></a><span id="l10.11" class="difflineminus">-# http://www.mozilla.org/MPL/</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-#</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-# Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineminus">-# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineminus">-# for the specific language governing rights and limitations under the</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineminus">-# License.</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineminus">-#</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineminus">-# The Original Code is Mozilla Corporation Code.</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineminus">-#</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineminus">-# The Initial Developer of the Original Code is</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineminus">-# Mikeal Rogers.</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineminus">-# Portions created by the Initial Developer are Copyright (C) 2008-2009</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineminus">-# the Initial Developer. All Rights Reserved.</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineminus">-#</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineminus">-# Contributor(s):</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineminus">-#  Mikeal Rogers &lt;mikeal.rogers@gmail.com&gt;</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineminus">-#  Clint Talbert &lt;ctalbert@mozilla.com&gt;</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineminus">-#  Henrik Skupin &lt;hskupin@mozilla.com&gt;</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineminus">-#</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineminus">-# Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineminus">-# either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineminus">-# the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineminus">-# in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineminus">-# of those above. If you wish to allow use of your version of this file only</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineminus">-# under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineminus">-# use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineminus">-# decision by deleting the provisions above and replace them with the notice</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineminus">-# and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineminus">-# the provisions above, a recipient may use your version of this file under</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineminus">-# the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineminus">-#</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineminus">-# ***** END LICENSE BLOCK *****</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineminus">-</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineminus">-import os</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineminus">-import sys</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineminus">-import copy</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineminus">-import tempfile</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineminus">-import commands</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineminus">-import zipfile</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineminus">-import optparse</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineminus">-import killableprocess</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineminus">-import subprocess</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineminus">-import platform</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineminus">-import shutil</span>
<a href="#l10.55"></a><span id="l10.55" class="difflineminus">-</span>
<a href="#l10.56"></a><span id="l10.56" class="difflineminus">-from distutils import dir_util</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineminus">-from time import sleep</span>
<a href="#l10.58"></a><span id="l10.58" class="difflineminus">-from xml.dom import minidom</span>
<a href="#l10.59"></a><span id="l10.59" class="difflineminus">-</span>
<a href="#l10.60"></a><span id="l10.60" class="difflineminus">-# conditional (version-dependent) imports</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineminus">-try:</span>
<a href="#l10.62"></a><span id="l10.62" class="difflineminus">-    import simplejson</span>
<a href="#l10.63"></a><span id="l10.63" class="difflineminus">-except ImportError:</span>
<a href="#l10.64"></a><span id="l10.64" class="difflineminus">-    import json as simplejson</span>
<a href="#l10.65"></a><span id="l10.65" class="difflineminus">-</span>
<a href="#l10.66"></a><span id="l10.66" class="difflineminus">-import logging</span>
<a href="#l10.67"></a><span id="l10.67" class="difflineminus">-logger = logging.getLogger(__name__)</span>
<a href="#l10.68"></a><span id="l10.68" class="difflineminus">-</span>
<a href="#l10.69"></a><span id="l10.69" class="difflineminus">-# Use dir_util for copy/rm operations because shutil is all kinds of broken</span>
<a href="#l10.70"></a><span id="l10.70" class="difflineminus">-copytree = dir_util.copy_tree</span>
<a href="#l10.71"></a><span id="l10.71" class="difflineminus">-rmtree = dir_util.remove_tree</span>
<a href="#l10.72"></a><span id="l10.72" class="difflineminus">-</span>
<a href="#l10.73"></a><span id="l10.73" class="difflineminus">-def findInPath(fileName, path=os.environ['PATH']):</span>
<a href="#l10.74"></a><span id="l10.74" class="difflineminus">-    dirs = path.split(os.pathsep)</span>
<a href="#l10.75"></a><span id="l10.75" class="difflineminus">-    for dir in dirs:</span>
<a href="#l10.76"></a><span id="l10.76" class="difflineminus">-        if os.path.isfile(os.path.join(dir, fileName)):</span>
<a href="#l10.77"></a><span id="l10.77" class="difflineminus">-            return os.path.join(dir, fileName)</span>
<a href="#l10.78"></a><span id="l10.78" class="difflineminus">-        if os.name == 'nt' or sys.platform == 'cygwin':</span>
<a href="#l10.79"></a><span id="l10.79" class="difflineminus">-            if os.path.isfile(os.path.join(dir, fileName + &quot;.exe&quot;)):</span>
<a href="#l10.80"></a><span id="l10.80" class="difflineminus">-                return os.path.join(dir, fileName + &quot;.exe&quot;)</span>
<a href="#l10.81"></a><span id="l10.81" class="difflineminus">-    return None</span>
<a href="#l10.82"></a><span id="l10.82" class="difflineminus">-</span>
<a href="#l10.83"></a><span id="l10.83" class="difflineminus">-stdout = sys.stdout</span>
<a href="#l10.84"></a><span id="l10.84" class="difflineminus">-stderr = sys.stderr</span>
<a href="#l10.85"></a><span id="l10.85" class="difflineminus">-stdin = sys.stdin</span>
<a href="#l10.86"></a><span id="l10.86" class="difflineminus">-</span>
<a href="#l10.87"></a><span id="l10.87" class="difflineminus">-def run_command(cmd, env=None, **kwargs):</span>
<a href="#l10.88"></a><span id="l10.88" class="difflineminus">-    &quot;&quot;&quot;Run the given command in killable process.&quot;&quot;&quot;</span>
<a href="#l10.89"></a><span id="l10.89" class="difflineminus">-    killable_kwargs = {'stdout':stdout ,'stderr':stderr, 'stdin':stdin}</span>
<a href="#l10.90"></a><span id="l10.90" class="difflineminus">-    killable_kwargs.update(kwargs)</span>
<a href="#l10.91"></a><span id="l10.91" class="difflineminus">-</span>
<a href="#l10.92"></a><span id="l10.92" class="difflineminus">-    if sys.platform != &quot;win32&quot;:</span>
<a href="#l10.93"></a><span id="l10.93" class="difflineminus">-        return killableprocess.Popen(cmd, preexec_fn=lambda : os.setpgid(0, 0),</span>
<a href="#l10.94"></a><span id="l10.94" class="difflineminus">-                                     env=env, **killable_kwargs)</span>
<a href="#l10.95"></a><span id="l10.95" class="difflineminus">-    else:</span>
<a href="#l10.96"></a><span id="l10.96" class="difflineminus">-        return killableprocess.Popen(cmd, env=env, **killable_kwargs)</span>
<a href="#l10.97"></a><span id="l10.97" class="difflineminus">-</span>
<a href="#l10.98"></a><span id="l10.98" class="difflineminus">-def getoutput(l):</span>
<a href="#l10.99"></a><span id="l10.99" class="difflineminus">-    tmp = tempfile.mktemp()</span>
<a href="#l10.100"></a><span id="l10.100" class="difflineminus">-    x = open(tmp, 'w')</span>
<a href="#l10.101"></a><span id="l10.101" class="difflineminus">-    subprocess.call(l, stdout=x, stderr=x)</span>
<a href="#l10.102"></a><span id="l10.102" class="difflineminus">-    x.close(); x = open(tmp, 'r')</span>
<a href="#l10.103"></a><span id="l10.103" class="difflineminus">-    r = x.read() ; x.close()</span>
<a href="#l10.104"></a><span id="l10.104" class="difflineminus">-    os.remove(tmp)</span>
<a href="#l10.105"></a><span id="l10.105" class="difflineminus">-    return r</span>
<a href="#l10.106"></a><span id="l10.106" class="difflineminus">-</span>
<a href="#l10.107"></a><span id="l10.107" class="difflineminus">-def get_pids(name, minimun_pid=0):</span>
<a href="#l10.108"></a><span id="l10.108" class="difflineminus">-    &quot;&quot;&quot;Get all the pids matching name, exclude any pids below minimum_pid.&quot;&quot;&quot;</span>
<a href="#l10.109"></a><span id="l10.109" class="difflineminus">-    if os.name == 'nt' or sys.platform == 'cygwin':</span>
<a href="#l10.110"></a><span id="l10.110" class="difflineminus">-        import wpk</span>
<a href="#l10.111"></a><span id="l10.111" class="difflineminus">-        pids = wpk.get_pids(name)</span>
<a href="#l10.112"></a><span id="l10.112" class="difflineminus">-    else:</span>
<a href="#l10.113"></a><span id="l10.113" class="difflineminus">-        data = getoutput(['ps', 'ax']).splitlines()</span>
<a href="#l10.114"></a><span id="l10.114" class="difflineminus">-        pids = [int(line.split()[0]) for line in data if line.find(name) is not -1]</span>
<a href="#l10.115"></a><span id="l10.115" class="difflineminus">-</span>
<a href="#l10.116"></a><span id="l10.116" class="difflineminus">-    matching_pids = [m for m in pids if m &gt; minimun_pid]</span>
<a href="#l10.117"></a><span id="l10.117" class="difflineminus">-    return matching_pids</span>
<a href="#l10.118"></a><span id="l10.118" class="difflineminus">-</span>
<a href="#l10.119"></a><span id="l10.119" class="difflineminus">-def makedirs(name):</span>
<a href="#l10.120"></a><span id="l10.120" class="difflineminus">-</span>
<a href="#l10.121"></a><span id="l10.121" class="difflineminus">-    head, tail = os.path.split(name)</span>
<a href="#l10.122"></a><span id="l10.122" class="difflineminus">-    if not tail:</span>
<a href="#l10.123"></a><span id="l10.123" class="difflineminus">-        head, tail = os.path.split(head)</span>
<a href="#l10.124"></a><span id="l10.124" class="difflineminus">-    if head and tail and not os.path.exists(head):</span>
<a href="#l10.125"></a><span id="l10.125" class="difflineminus">-        try:</span>
<a href="#l10.126"></a><span id="l10.126" class="difflineminus">-            makedirs(head)</span>
<a href="#l10.127"></a><span id="l10.127" class="difflineminus">-        except OSError, e:</span>
<a href="#l10.128"></a><span id="l10.128" class="difflineminus">-            pass</span>
<a href="#l10.129"></a><span id="l10.129" class="difflineminus">-        if tail == os.curdir:           # xxx/newdir/. exists if xxx/newdir exists</span>
<a href="#l10.130"></a><span id="l10.130" class="difflineminus">-            return</span>
<a href="#l10.131"></a><span id="l10.131" class="difflineminus">-    try:</span>
<a href="#l10.132"></a><span id="l10.132" class="difflineminus">-        os.mkdir(name)</span>
<a href="#l10.133"></a><span id="l10.133" class="difflineminus">-    except:</span>
<a href="#l10.134"></a><span id="l10.134" class="difflineminus">-        pass</span>
<a href="#l10.135"></a><span id="l10.135" class="difflineminus">-</span>
<a href="#l10.136"></a><span id="l10.136" class="difflineminus">-class Profile(object):</span>
<a href="#l10.137"></a><span id="l10.137" class="difflineminus">-    &quot;&quot;&quot;Handles all operations regarding profile. Created new profiles, installs extensions,</span>
<a href="#l10.138"></a><span id="l10.138" class="difflineminus">-    sets preferences and handles cleanup.&quot;&quot;&quot;</span>
<a href="#l10.139"></a><span id="l10.139" class="difflineminus">-</span>
<a href="#l10.140"></a><span id="l10.140" class="difflineminus">-    def __init__(self, binary=None, profile=None, addons=None,</span>
<a href="#l10.141"></a><span id="l10.141" class="difflineminus">-                 preferences=None):</span>
<a href="#l10.142"></a><span id="l10.142" class="difflineminus">-</span>
<a href="#l10.143"></a><span id="l10.143" class="difflineminus">-        self.binary = binary</span>
<a href="#l10.144"></a><span id="l10.144" class="difflineminus">-</span>
<a href="#l10.145"></a><span id="l10.145" class="difflineminus">-        self.create_new = not(bool(profile))</span>
<a href="#l10.146"></a><span id="l10.146" class="difflineminus">-        if profile:</span>
<a href="#l10.147"></a><span id="l10.147" class="difflineminus">-            # Ensure we have a full path to the profile</span>
<a href="#l10.148"></a><span id="l10.148" class="difflineminus">-            self.profile = os.path.abspath(os.path.expanduser(profile))</span>
<a href="#l10.149"></a><span id="l10.149" class="difflineminus">-            if not os.path.exists(self.profile):</span>
<a href="#l10.150"></a><span id="l10.150" class="difflineminus">-                os.makedirs(self.profile)</span>
<a href="#l10.151"></a><span id="l10.151" class="difflineminus">-        else:</span>
<a href="#l10.152"></a><span id="l10.152" class="difflineminus">-            self.profile = self.create_new_profile(self.binary)</span>
<a href="#l10.153"></a><span id="l10.153" class="difflineminus">-</span>
<a href="#l10.154"></a><span id="l10.154" class="difflineminus">-        self.addons_installed = []</span>
<a href="#l10.155"></a><span id="l10.155" class="difflineminus">-        self.addons = addons or []</span>
<a href="#l10.156"></a><span id="l10.156" class="difflineminus">-</span>
<a href="#l10.157"></a><span id="l10.157" class="difflineminus">-        ### set preferences from class preferences</span>
<a href="#l10.158"></a><span id="l10.158" class="difflineminus">-        preferences = preferences or {}</span>
<a href="#l10.159"></a><span id="l10.159" class="difflineminus">-        if hasattr(self.__class__, 'preferences'):</span>
<a href="#l10.160"></a><span id="l10.160" class="difflineminus">-            self.preferences = self.__class__.preferences.copy()</span>
<a href="#l10.161"></a><span id="l10.161" class="difflineminus">-        else:</span>
<a href="#l10.162"></a><span id="l10.162" class="difflineminus">-            self.preferences = {}</span>
<a href="#l10.163"></a><span id="l10.163" class="difflineminus">-        self.preferences.update(preferences)</span>
<a href="#l10.164"></a><span id="l10.164" class="difflineminus">-</span>
<a href="#l10.165"></a><span id="l10.165" class="difflineminus">-        for addon in self.addons:</span>
<a href="#l10.166"></a><span id="l10.166" class="difflineminus">-            self.install_addon(addon)</span>
<a href="#l10.167"></a><span id="l10.167" class="difflineminus">-</span>
<a href="#l10.168"></a><span id="l10.168" class="difflineminus">-        self.set_preferences(self.preferences)</span>
<a href="#l10.169"></a><span id="l10.169" class="difflineminus">-</span>
<a href="#l10.170"></a><span id="l10.170" class="difflineminus">-    def create_new_profile(self, binary):</span>
<a href="#l10.171"></a><span id="l10.171" class="difflineminus">-        &quot;&quot;&quot;Create a new clean profile in tmp which is a simple empty folder&quot;&quot;&quot;</span>
<a href="#l10.172"></a><span id="l10.172" class="difflineminus">-        profile = tempfile.mkdtemp(suffix='.mozrunner')</span>
<a href="#l10.173"></a><span id="l10.173" class="difflineminus">-        return profile</span>
<a href="#l10.174"></a><span id="l10.174" class="difflineminus">-</span>
<a href="#l10.175"></a><span id="l10.175" class="difflineminus">-    ### methods related to addons</span>
<a href="#l10.176"></a><span id="l10.176" class="difflineminus">-</span>
<a href="#l10.177"></a><span id="l10.177" class="difflineminus">-    @classmethod</span>
<a href="#l10.178"></a><span id="l10.178" class="difflineminus">-    def addon_id(self, addon_path):</span>
<a href="#l10.179"></a><span id="l10.179" class="difflineminus">-        &quot;&quot;&quot;</span>
<a href="#l10.180"></a><span id="l10.180" class="difflineminus">-        return the id for a given addon, or None if not found</span>
<a href="#l10.181"></a><span id="l10.181" class="difflineminus">-        - addon_path : path to the addon directory</span>
<a href="#l10.182"></a><span id="l10.182" class="difflineminus">-        &quot;&quot;&quot;</span>
<a href="#l10.183"></a><span id="l10.183" class="difflineminus">-        </span>
<a href="#l10.184"></a><span id="l10.184" class="difflineminus">-        def find_id(desc):</span>
<a href="#l10.185"></a><span id="l10.185" class="difflineminus">-            &quot;&quot;&quot;finds the addon id give its description&quot;&quot;&quot;</span>
<a href="#l10.186"></a><span id="l10.186" class="difflineminus">-            </span>
<a href="#l10.187"></a><span id="l10.187" class="difflineminus">-            addon_id = None</span>
<a href="#l10.188"></a><span id="l10.188" class="difflineminus">-            for elem in desc:</span>
<a href="#l10.189"></a><span id="l10.189" class="difflineminus">-</span>
<a href="#l10.190"></a><span id="l10.190" class="difflineminus">-                # remove targetApplication nodes, they contain id's we aren't interested in</span>
<a href="#l10.191"></a><span id="l10.191" class="difflineminus">-                apps = elem.getElementsByTagName('em:targetApplication')</span>
<a href="#l10.192"></a><span id="l10.192" class="difflineminus">-                apps.extend(elem.getElementsByTagName('targetApplication'))</span>
<a href="#l10.193"></a><span id="l10.193" class="difflineminus">-                if apps:</span>
<a href="#l10.194"></a><span id="l10.194" class="difflineminus">-                    for app in apps:</span>
<a href="#l10.195"></a><span id="l10.195" class="difflineminus">-                        elem.removeChild(app)</span>
<a href="#l10.196"></a><span id="l10.196" class="difflineminus">-                        </span>
<a href="#l10.197"></a><span id="l10.197" class="difflineminus">-                    # find the id tag</span>
<a href="#l10.198"></a><span id="l10.198" class="difflineminus">-                    if elem.getElementsByTagName('em:id'):</span>
<a href="#l10.199"></a><span id="l10.199" class="difflineminus">-                        addon_id = str(elem.getElementsByTagName('em:id')[0].firstChild.data)</span>
<a href="#l10.200"></a><span id="l10.200" class="difflineminus">-                    elif elem.hasAttribute('em:id'):</span>
<a href="#l10.201"></a><span id="l10.201" class="difflineminus">-                        addon_id = str(elem.getAttribute('em:id'))</span>
<a href="#l10.202"></a><span id="l10.202" class="difflineminus">-                    elif elem.getElementsByTagName('id'):</span>
<a href="#l10.203"></a><span id="l10.203" class="difflineminus">-                        addon_id = str(elem.getElementsByTagName('id')[0].firstChild.data)</span>
<a href="#l10.204"></a><span id="l10.204" class="difflineminus">-                        </span>
<a href="#l10.205"></a><span id="l10.205" class="difflineminus">-            return addon_id</span>
<a href="#l10.206"></a><span id="l10.206" class="difflineminus">-</span>
<a href="#l10.207"></a><span id="l10.207" class="difflineminus">-        doc = minidom.parse(os.path.join(addon_path, 'install.rdf')) </span>
<a href="#l10.208"></a><span id="l10.208" class="difflineminus">-        </span>
<a href="#l10.209"></a><span id="l10.209" class="difflineminus">-        for tag in 'Description', 'RDF:Description':</span>
<a href="#l10.210"></a><span id="l10.210" class="difflineminus">-            desc = doc.getElementsByTagName(tag)</span>
<a href="#l10.211"></a><span id="l10.211" class="difflineminus">-            addon_id = find_id(desc)</span>
<a href="#l10.212"></a><span id="l10.212" class="difflineminus">-            if addon_id:</span>
<a href="#l10.213"></a><span id="l10.213" class="difflineminus">-                return addon_id</span>
<a href="#l10.214"></a><span id="l10.214" class="difflineminus">-</span>
<a href="#l10.215"></a><span id="l10.215" class="difflineminus">-</span>
<a href="#l10.216"></a><span id="l10.216" class="difflineminus">-    def install_addon(self, path):</span>
<a href="#l10.217"></a><span id="l10.217" class="difflineminus">-        &quot;&quot;&quot;Installs the given addon or directory of addons in the profile.&quot;&quot;&quot;</span>
<a href="#l10.218"></a><span id="l10.218" class="difflineminus">-        </span>
<a href="#l10.219"></a><span id="l10.219" class="difflineminus">-        # if the addon is a directory, install all addons in it</span>
<a href="#l10.220"></a><span id="l10.220" class="difflineminus">-        addons = [path]</span>
<a href="#l10.221"></a><span id="l10.221" class="difflineminus">-        if not path.endswith('.xpi') and not os.path.exists(os.path.join(path, 'install.rdf')):</span>
<a href="#l10.222"></a><span id="l10.222" class="difflineminus">-            addons = [os.path.join(path, x) for x in os.listdir(path)]</span>
<a href="#l10.223"></a><span id="l10.223" class="difflineminus">-</span>
<a href="#l10.224"></a><span id="l10.224" class="difflineminus">-        # install each addon</span>
<a href="#l10.225"></a><span id="l10.225" class="difflineminus">-        for addon in addons:</span>
<a href="#l10.226"></a><span id="l10.226" class="difflineminus">-            tmpdir = None</span>
<a href="#l10.227"></a><span id="l10.227" class="difflineminus">-</span>
<a href="#l10.228"></a><span id="l10.228" class="difflineminus">-            # if the addon is an .xpi, uncompress it to a temporary directory</span>
<a href="#l10.229"></a><span id="l10.229" class="difflineminus">-            if addon.endswith('.xpi'):</span>
<a href="#l10.230"></a><span id="l10.230" class="difflineminus">-                tmpdir = tempfile.mkdtemp(suffix = &quot;.&quot; + os.path.split(addon)[-1])</span>
<a href="#l10.231"></a><span id="l10.231" class="difflineminus">-                compressed_file = zipfile.ZipFile(addon, &quot;r&quot;)</span>
<a href="#l10.232"></a><span id="l10.232" class="difflineminus">-                for name in compressed_file.namelist():</span>
<a href="#l10.233"></a><span id="l10.233" class="difflineminus">-                    if name.endswith('/'):</span>
<a href="#l10.234"></a><span id="l10.234" class="difflineminus">-                        makedirs(os.path.join(tmpdir, name))</span>
<a href="#l10.235"></a><span id="l10.235" class="difflineminus">-                    else:</span>
<a href="#l10.236"></a><span id="l10.236" class="difflineminus">-                        if not os.path.isdir(os.path.dirname(os.path.join(tmpdir, name))):</span>
<a href="#l10.237"></a><span id="l10.237" class="difflineminus">-                            makedirs(os.path.dirname(os.path.join(tmpdir, name)))</span>
<a href="#l10.238"></a><span id="l10.238" class="difflineminus">-                        data = compressed_file.read(name)</span>
<a href="#l10.239"></a><span id="l10.239" class="difflineminus">-                        f = open(os.path.join(tmpdir, name), 'wb')</span>
<a href="#l10.240"></a><span id="l10.240" class="difflineminus">-                        f.write(data) ; f.close()</span>
<a href="#l10.241"></a><span id="l10.241" class="difflineminus">-                addon = tmpdir</span>
<a href="#l10.242"></a><span id="l10.242" class="difflineminus">-</span>
<a href="#l10.243"></a><span id="l10.243" class="difflineminus">-            # determine the addon id</span>
<a href="#l10.244"></a><span id="l10.244" class="difflineminus">-            addon_id = Profile.addon_id(addon)</span>
<a href="#l10.245"></a><span id="l10.245" class="difflineminus">-            assert addon_id is not None, &quot;The addon id could not be found: %s&quot; % addon</span>
<a href="#l10.246"></a><span id="l10.246" class="difflineminus">-</span>
<a href="#l10.247"></a><span id="l10.247" class="difflineminus">-            # copy the addon to the profile</span>
<a href="#l10.248"></a><span id="l10.248" class="difflineminus">-            addon_path = os.path.join(self.profile, 'extensions', addon_id)</span>
<a href="#l10.249"></a><span id="l10.249" class="difflineminus">-            copytree(addon, addon_path, preserve_symlinks=1)</span>
<a href="#l10.250"></a><span id="l10.250" class="difflineminus">-            self.addons_installed.append(addon_path)</span>
<a href="#l10.251"></a><span id="l10.251" class="difflineminus">-</span>
<a href="#l10.252"></a><span id="l10.252" class="difflineminus">-            # remove the temporary directory, if any</span>
<a href="#l10.253"></a><span id="l10.253" class="difflineminus">-            if tmpdir:</span>
<a href="#l10.254"></a><span id="l10.254" class="difflineminus">-                rmtree(tmpdir)</span>
<a href="#l10.255"></a><span id="l10.255" class="difflineminus">-</span>
<a href="#l10.256"></a><span id="l10.256" class="difflineminus">-    def clean_addons(self):</span>
<a href="#l10.257"></a><span id="l10.257" class="difflineminus">-        &quot;&quot;&quot;Cleans up addons in the profile.&quot;&quot;&quot;</span>
<a href="#l10.258"></a><span id="l10.258" class="difflineminus">-        for addon in self.addons_installed:</span>
<a href="#l10.259"></a><span id="l10.259" class="difflineminus">-            if os.path.isdir(addon):</span>
<a href="#l10.260"></a><span id="l10.260" class="difflineminus">-                rmtree(addon)</span>
<a href="#l10.261"></a><span id="l10.261" class="difflineminus">-</span>
<a href="#l10.262"></a><span id="l10.262" class="difflineminus">-    ### methods related to preferences</span>
<a href="#l10.263"></a><span id="l10.263" class="difflineminus">-</span>
<a href="#l10.264"></a><span id="l10.264" class="difflineminus">-    def set_preferences(self, preferences):</span>
<a href="#l10.265"></a><span id="l10.265" class="difflineminus">-        &quot;&quot;&quot;Adds preferences dict to profile preferences&quot;&quot;&quot;</span>
<a href="#l10.266"></a><span id="l10.266" class="difflineminus">-</span>
<a href="#l10.267"></a><span id="l10.267" class="difflineminus">-        prefs_file = os.path.join(self.profile, 'user.js')</span>
<a href="#l10.268"></a><span id="l10.268" class="difflineminus">-</span>
<a href="#l10.269"></a><span id="l10.269" class="difflineminus">-        # Ensure that the file exists first otherwise create an empty file</span>
<a href="#l10.270"></a><span id="l10.270" class="difflineminus">-        if os.path.isfile(prefs_file):</span>
<a href="#l10.271"></a><span id="l10.271" class="difflineminus">-            f = open(prefs_file, 'a+')</span>
<a href="#l10.272"></a><span id="l10.272" class="difflineminus">-        else:</span>
<a href="#l10.273"></a><span id="l10.273" class="difflineminus">-            f = open(prefs_file, 'w')</span>
<a href="#l10.274"></a><span id="l10.274" class="difflineminus">-</span>
<a href="#l10.275"></a><span id="l10.275" class="difflineminus">-        f.write('\n#MozRunner Prefs Start\n')</span>
<a href="#l10.276"></a><span id="l10.276" class="difflineminus">-</span>
<a href="#l10.277"></a><span id="l10.277" class="difflineminus">-        pref_lines = ['user_pref(%s, %s);' %</span>
<a href="#l10.278"></a><span id="l10.278" class="difflineminus">-                      (simplejson.dumps(k), simplejson.dumps(v) ) for k, v in</span>
<a href="#l10.279"></a><span id="l10.279" class="difflineminus">-                       preferences.items()]</span>
<a href="#l10.280"></a><span id="l10.280" class="difflineminus">-        for line in pref_lines:</span>
<a href="#l10.281"></a><span id="l10.281" class="difflineminus">-            f.write(line+'\n')</span>
<a href="#l10.282"></a><span id="l10.282" class="difflineminus">-        f.write('#MozRunner Prefs End\n')</span>
<a href="#l10.283"></a><span id="l10.283" class="difflineminus">-        f.flush() ; f.close()</span>
<a href="#l10.284"></a><span id="l10.284" class="difflineminus">-</span>
<a href="#l10.285"></a><span id="l10.285" class="difflineminus">-    def clean_preferences(self):</span>
<a href="#l10.286"></a><span id="l10.286" class="difflineminus">-        &quot;&quot;&quot;Removed preferences added by mozrunner.&quot;&quot;&quot;</span>
<a href="#l10.287"></a><span id="l10.287" class="difflineminus">-        lines = open(os.path.join(self.profile, 'user.js'), 'r').read().splitlines()</span>
<a href="#l10.288"></a><span id="l10.288" class="difflineminus">-        s = lines.index('#MozRunner Prefs Start') ; e = lines.index('#MozRunner Prefs End')</span>
<a href="#l10.289"></a><span id="l10.289" class="difflineminus">-        cleaned_prefs = '\n'.join(lines[:s] + lines[e+1:])</span>
<a href="#l10.290"></a><span id="l10.290" class="difflineminus">-        f = open(os.path.join(self.profile, 'user.js'), 'w')</span>
<a href="#l10.291"></a><span id="l10.291" class="difflineminus">-        f.write(cleaned_prefs) ; f.flush() ; f.close()</span>
<a href="#l10.292"></a><span id="l10.292" class="difflineminus">-</span>
<a href="#l10.293"></a><span id="l10.293" class="difflineminus">-    ### cleanup </span>
<a href="#l10.294"></a><span id="l10.294" class="difflineminus">-</span>
<a href="#l10.295"></a><span id="l10.295" class="difflineminus">-    def cleanup(self):</span>
<a href="#l10.296"></a><span id="l10.296" class="difflineminus">-        &quot;&quot;&quot;Cleanup operations on the profile.&quot;&quot;&quot;</span>
<a href="#l10.297"></a><span id="l10.297" class="difflineminus">-        def oncleanup_error(function, path, excinfo):</span>
<a href="#l10.298"></a><span id="l10.298" class="difflineminus">-            print &gt;&gt; sys.stderr, &quot;Error Cleaning up: &quot; + str(excinfo[1])</span>
<a href="#l10.299"></a><span id="l10.299" class="difflineminus">-</span>
<a href="#l10.300"></a><span id="l10.300" class="difflineminus">-        if self.create_new:</span>
<a href="#l10.301"></a><span id="l10.301" class="difflineminus">-            if os.path.exists(self.profile):</span>
<a href="#l10.302"></a><span id="l10.302" class="difflineminus">-                shutil.rmtree(self.profile, False, oncleanup_error)</span>
<a href="#l10.303"></a><span id="l10.303" class="difflineminus">-        else:</span>
<a href="#l10.304"></a><span id="l10.304" class="difflineminus">-            self.clean_preferences()</span>
<a href="#l10.305"></a><span id="l10.305" class="difflineminus">-            self.clean_addons()</span>
<a href="#l10.306"></a><span id="l10.306" class="difflineminus">-</span>
<a href="#l10.307"></a><span id="l10.307" class="difflineminus">-    __del__ = cleanup</span>
<a href="#l10.308"></a><span id="l10.308" class="difflineminus">-    </span>
<a href="#l10.309"></a><span id="l10.309" class="difflineminus">-</span>
<a href="#l10.310"></a><span id="l10.310" class="difflineminus">-class FirefoxProfile(Profile):</span>
<a href="#l10.311"></a><span id="l10.311" class="difflineminus">-    &quot;&quot;&quot;Specialized Profile subclass for Firefox&quot;&quot;&quot;</span>
<a href="#l10.312"></a><span id="l10.312" class="difflineminus">-    preferences = {# Don't automatically update the application</span>
<a href="#l10.313"></a><span id="l10.313" class="difflineminus">-                   'app.update.enabled' : False,</span>
<a href="#l10.314"></a><span id="l10.314" class="difflineminus">-                   # Don't restore the last open set of tabs if the browser has crashed</span>
<a href="#l10.315"></a><span id="l10.315" class="difflineminus">-                   'browser.sessionstore.resume_from_crash': False,</span>
<a href="#l10.316"></a><span id="l10.316" class="difflineminus">-                   # Don't check for the default web browser</span>
<a href="#l10.317"></a><span id="l10.317" class="difflineminus">-                   'browser.shell.checkDefaultBrowser' : False,</span>
<a href="#l10.318"></a><span id="l10.318" class="difflineminus">-                   # Don't warn on exit when multiple tabs are open</span>
<a href="#l10.319"></a><span id="l10.319" class="difflineminus">-                   'browser.tabs.warnOnClose' : False,</span>
<a href="#l10.320"></a><span id="l10.320" class="difflineminus">-                   # Don't warn when exiting the browser</span>
<a href="#l10.321"></a><span id="l10.321" class="difflineminus">-                   'browser.warnOnQuit': False,</span>
<a href="#l10.322"></a><span id="l10.322" class="difflineminus">-                   # Only install add-ons from the profile and the application scope</span>
<a href="#l10.323"></a><span id="l10.323" class="difflineminus">-                   # Also ensure that those are not getting disabled.</span>
<a href="#l10.324"></a><span id="l10.324" class="difflineminus">-                   # see: https://developer.mozilla.org/en/Installing_extensions</span>
<a href="#l10.325"></a><span id="l10.325" class="difflineminus">-                   'extensions.enabledScopes' : 5,</span>
<a href="#l10.326"></a><span id="l10.326" class="difflineminus">-                   'extensions.autoDisableScopes' : 10,</span>
<a href="#l10.327"></a><span id="l10.327" class="difflineminus">-                   # Don't install distribution add-ons from the app folder</span>
<a href="#l10.328"></a><span id="l10.328" class="difflineminus">-                   'extensions.installDistroAddons' : False,</span>
<a href="#l10.329"></a><span id="l10.329" class="difflineminus">-                   # Dont' run the add-on compatibility check during start-up</span>
<a href="#l10.330"></a><span id="l10.330" class="difflineminus">-                   'extensions.showMismatchUI' : False,</span>
<a href="#l10.331"></a><span id="l10.331" class="difflineminus">-                   # Don't automatically update add-ons</span>
<a href="#l10.332"></a><span id="l10.332" class="difflineminus">-                   'extensions.update.enabled' : False,</span>
<a href="#l10.333"></a><span id="l10.333" class="difflineminus">-                   # Don't open a dialog to show available add-on updates</span>
<a href="#l10.334"></a><span id="l10.334" class="difflineminus">-                   'extensions.update.notifyUser' : False,</span>
<a href="#l10.335"></a><span id="l10.335" class="difflineminus">-                   # Enable test mode to run multiple tests in parallel</span>
<a href="#l10.336"></a><span id="l10.336" class="difflineminus">-                   'focusmanager.testmode' : True,</span>
<a href="#l10.337"></a><span id="l10.337" class="difflineminus">-</span>
<a href="#l10.338"></a><span id="l10.338" class="difflineminus">-                   # Disable addon compatibility checks</span>
<a href="#l10.339"></a><span id="l10.339" class="difflineminus">-                   'extensions.checkCompatibility' : False,</span>
<a href="#l10.340"></a><span id="l10.340" class="difflineminus">-                   'extensions.checkCompatibility.4.0' : False,</span>
<a href="#l10.341"></a><span id="l10.341" class="difflineminus">-                   'extensions.checkCompatibility.4.0b' : False,</span>
<a href="#l10.342"></a><span id="l10.342" class="difflineminus">-                   'extensions.checkCompatibility.4.2' : False,</span>
<a href="#l10.343"></a><span id="l10.343" class="difflineminus">-                   'extensions.checkCompatibility.4.2a' : False,</span>
<a href="#l10.344"></a><span id="l10.344" class="difflineminus">-                   'extensions.checkCompatibility.4.2b' : False,</span>
<a href="#l10.345"></a><span id="l10.345" class="difflineminus">-                   'extensions.checkCompatibility.4.2pre' : False,</span>
<a href="#l10.346"></a><span id="l10.346" class="difflineminus">-                   'extensions.checkCompatibility.5.0' : False,</span>
<a href="#l10.347"></a><span id="l10.347" class="difflineminus">-                   'extensions.checkCompatibility.5.0a' : False,</span>
<a href="#l10.348"></a><span id="l10.348" class="difflineminus">-                   'extensions.checkCompatibility.5.0b' : False,</span>
<a href="#l10.349"></a><span id="l10.349" class="difflineminus">-                   'extensions.checkCompatibility.5.0pre' : False,</span>
<a href="#l10.350"></a><span id="l10.350" class="difflineminus">-                   'extensions.checkCompatibility.6.0' : False,</span>
<a href="#l10.351"></a><span id="l10.351" class="difflineminus">-                   'extensions.checkCompatibility.6.0a' : False,</span>
<a href="#l10.352"></a><span id="l10.352" class="difflineminus">-                   'extensions.checkCompatibility.6.0b' : False,</span>
<a href="#l10.353"></a><span id="l10.353" class="difflineminus">-                   'extensions.checkCompatibility.6.0pre' : False,</span>
<a href="#l10.354"></a><span id="l10.354" class="difflineminus">-                   'extensions.checkCompatibility.7.0' : False,</span>
<a href="#l10.355"></a><span id="l10.355" class="difflineminus">-                   'extensions.checkCompatibility.7.0a' : False,</span>
<a href="#l10.356"></a><span id="l10.356" class="difflineminus">-                   'extensions.checkCompatibility.8.0' : False,</span>
<a href="#l10.357"></a><span id="l10.357" class="difflineminus">-                   'extensions.checkCompatibility.8.0a' : False,</span>
<a href="#l10.358"></a><span id="l10.358" class="difflineminus">-                   'extensions.checkCompatibility.9.0' : False,</span>
<a href="#l10.359"></a><span id="l10.359" class="difflineminus">-                   'extensions.checkCompatibility.9.0a' : False,</span>
<a href="#l10.360"></a><span id="l10.360" class="difflineminus">-                   'extensions.checkCompatibility.nightly' : False,</span>
<a href="#l10.361"></a><span id="l10.361" class="difflineminus">-                   }</span>
<a href="#l10.362"></a><span id="l10.362" class="difflineminus">-</span>
<a href="#l10.363"></a><span id="l10.363" class="difflineminus">-    @property</span>
<a href="#l10.364"></a><span id="l10.364" class="difflineminus">-    def names(self):</span>
<a href="#l10.365"></a><span id="l10.365" class="difflineminus">-        if sys.platform == 'darwin':</span>
<a href="#l10.366"></a><span id="l10.366" class="difflineminus">-            return ['firefox', 'minefield', 'shiretoko']</span>
<a href="#l10.367"></a><span id="l10.367" class="difflineminus">-        if sys.platform.startswith('linux') or sys.platform in ('sunos5', 'solaris'):</span>
<a href="#l10.368"></a><span id="l10.368" class="difflineminus">-            return ['firefox', 'mozilla-firefox', 'iceweasel']</span>
<a href="#l10.369"></a><span id="l10.369" class="difflineminus">-        if os.name == 'nt' or sys.platform == 'cygwin':</span>
<a href="#l10.370"></a><span id="l10.370" class="difflineminus">-            return ['firefox']</span>
<a href="#l10.371"></a><span id="l10.371" class="difflineminus">-</span>
<a href="#l10.372"></a><span id="l10.372" class="difflineminus">-class ThunderbirdProfile(Profile):</span>
<a href="#l10.373"></a><span id="l10.373" class="difflineminus">-    preferences = {'extensions.update.enabled'    : False,</span>
<a href="#l10.374"></a><span id="l10.374" class="difflineminus">-                   'extensions.update.notifyUser' : False,</span>
<a href="#l10.375"></a><span id="l10.375" class="difflineminus">-                   'browser.shell.checkDefaultBrowser' : False,</span>
<a href="#l10.376"></a><span id="l10.376" class="difflineminus">-                   'browser.tabs.warnOnClose' : False,</span>
<a href="#l10.377"></a><span id="l10.377" class="difflineminus">-                   'browser.warnOnQuit': False,</span>
<a href="#l10.378"></a><span id="l10.378" class="difflineminus">-                   'browser.sessionstore.resume_from_crash': False,</span>
<a href="#l10.379"></a><span id="l10.379" class="difflineminus">-                   }</span>
<a href="#l10.380"></a><span id="l10.380" class="difflineminus">-    names = [&quot;thunderbird&quot;, &quot;shredder&quot;]</span>
<a href="#l10.381"></a><span id="l10.381" class="difflineminus">-</span>
<a href="#l10.382"></a><span id="l10.382" class="difflineminus">-</span>
<a href="#l10.383"></a><span id="l10.383" class="difflineminus">-class Runner(object):</span>
<a href="#l10.384"></a><span id="l10.384" class="difflineminus">-    &quot;&quot;&quot;Handles all running operations. Finds bins, runs and kills the process.&quot;&quot;&quot;</span>
<a href="#l10.385"></a><span id="l10.385" class="difflineminus">-</span>
<a href="#l10.386"></a><span id="l10.386" class="difflineminus">-    def __init__(self, binary=None, profile=None, cmdargs=None, env=None, kp_kwargs={}):</span>
<a href="#l10.387"></a><span id="l10.387" class="difflineminus">-</span>
<a href="#l10.388"></a><span id="l10.388" class="difflineminus">-        self.process_handler = None</span>
<a href="#l10.389"></a><span id="l10.389" class="difflineminus">-</span>
<a href="#l10.390"></a><span id="l10.390" class="difflineminus">-        # find the binary</span>
<a href="#l10.391"></a><span id="l10.391" class="difflineminus">-        if binary is None:</span>
<a href="#l10.392"></a><span id="l10.392" class="difflineminus">-            self.binary = self.find_binary()</span>
<a href="#l10.393"></a><span id="l10.393" class="difflineminus">-        elif sys.platform == 'darwin' and binary.find('Contents/MacOS/') == -1:</span>
<a href="#l10.394"></a><span id="l10.394" class="difflineminus">-            self.binary = os.path.join(binary, 'Contents/MacOS/%s-bin' % self.names[0])</span>
<a href="#l10.395"></a><span id="l10.395" class="difflineminus">-        else:</span>
<a href="#l10.396"></a><span id="l10.396" class="difflineminus">-            self.binary = binary</span>
<a href="#l10.397"></a><span id="l10.397" class="difflineminus">-        if not os.path.exists(self.binary):</span>
<a href="#l10.398"></a><span id="l10.398" class="difflineminus">-            raise Exception(&quot;Binary path does not exist &quot;+self.binary)</span>
<a href="#l10.399"></a><span id="l10.399" class="difflineminus">-</span>
<a href="#l10.400"></a><span id="l10.400" class="difflineminus">-        if sys.platform.startswith('linux') and self.binary.endswith('-bin'):</span>
<a href="#l10.401"></a><span id="l10.401" class="difflineminus">-            dirname = os.path.dirname(self.binary)</span>
<a href="#l10.402"></a><span id="l10.402" class="difflineminus">-            if os.environ.get('LD_LIBRARY_PATH', None):</span>
<a href="#l10.403"></a><span id="l10.403" class="difflineminus">-                os.environ['LD_LIBRARY_PATH'] = '%s:%s' % (os.environ['LD_LIBRARY_PATH'], dirname)</span>
<a href="#l10.404"></a><span id="l10.404" class="difflineminus">-            else:</span>
<a href="#l10.405"></a><span id="l10.405" class="difflineminus">-                os.environ['LD_LIBRARY_PATH'] = dirname</span>
<a href="#l10.406"></a><span id="l10.406" class="difflineminus">-</span>
<a href="#l10.407"></a><span id="l10.407" class="difflineminus">-        self.profile = profile</span>
<a href="#l10.408"></a><span id="l10.408" class="difflineminus">-</span>
<a href="#l10.409"></a><span id="l10.409" class="difflineminus">-        self.cmdargs = cmdargs or []</span>
<a href="#l10.410"></a><span id="l10.410" class="difflineminus">-        if env is None:</span>
<a href="#l10.411"></a><span id="l10.411" class="difflineminus">-            self.env = copy.copy(os.environ)</span>
<a href="#l10.412"></a><span id="l10.412" class="difflineminus">-            self.env.update({'MOZ_NO_REMOTE':&quot;1&quot;,})</span>
<a href="#l10.413"></a><span id="l10.413" class="difflineminus">-        else:</span>
<a href="#l10.414"></a><span id="l10.414" class="difflineminus">-            self.env = env</span>
<a href="#l10.415"></a><span id="l10.415" class="difflineminus">-        self.kp_kwargs = kp_kwargs</span>
<a href="#l10.416"></a><span id="l10.416" class="difflineminus">-</span>
<a href="#l10.417"></a><span id="l10.417" class="difflineminus">-    def find_binary(self):</span>
<a href="#l10.418"></a><span id="l10.418" class="difflineminus">-        &quot;&quot;&quot;Finds the binary for self.names if one was not provided.&quot;&quot;&quot;</span>
<a href="#l10.419"></a><span id="l10.419" class="difflineminus">-        binary = None</span>
<a href="#l10.420"></a><span id="l10.420" class="difflineminus">-        if sys.platform.startswith('linux') or sys.platform in ('sunos5', 'solaris'):</span>
<a href="#l10.421"></a><span id="l10.421" class="difflineminus">-            for name in reversed(self.names):</span>
<a href="#l10.422"></a><span id="l10.422" class="difflineminus">-                binary = findInPath(name)</span>
<a href="#l10.423"></a><span id="l10.423" class="difflineminus">-        elif os.name == 'nt' or sys.platform == 'cygwin':</span>
<a href="#l10.424"></a><span id="l10.424" class="difflineminus">-</span>
<a href="#l10.425"></a><span id="l10.425" class="difflineminus">-            # find the default executable from the windows registry</span>
<a href="#l10.426"></a><span id="l10.426" class="difflineminus">-            try:</span>
<a href="#l10.427"></a><span id="l10.427" class="difflineminus">-                # assumes self.app_name is defined, as it should be for</span>
<a href="#l10.428"></a><span id="l10.428" class="difflineminus">-                # implementors</span>
<a href="#l10.429"></a><span id="l10.429" class="difflineminus">-                import _winreg</span>
<a href="#l10.430"></a><span id="l10.430" class="difflineminus">-                app_key = _winreg.OpenKey(_winreg.HKEY_LOCAL_MACHINE, r&quot;Software\Mozilla\Mozilla %s&quot; % self.app_name)</span>
<a href="#l10.431"></a><span id="l10.431" class="difflineminus">-                version, _type = _winreg.QueryValueEx(app_key, &quot;CurrentVersion&quot;)</span>
<a href="#l10.432"></a><span id="l10.432" class="difflineminus">-                version_key = _winreg.OpenKey(app_key, version + r&quot;\Main&quot;)</span>
<a href="#l10.433"></a><span id="l10.433" class="difflineminus">-                path, _ = _winreg.QueryValueEx(version_key, &quot;PathToExe&quot;)</span>
<a href="#l10.434"></a><span id="l10.434" class="difflineminus">-                return path</span>
<a href="#l10.435"></a><span id="l10.435" class="difflineminus">-            except: # XXX not sure what type of exception this should be</span>
<a href="#l10.436"></a><span id="l10.436" class="difflineminus">-                pass</span>
<a href="#l10.437"></a><span id="l10.437" class="difflineminus">-</span>
<a href="#l10.438"></a><span id="l10.438" class="difflineminus">-            # search for the binary in the path            </span>
<a href="#l10.439"></a><span id="l10.439" class="difflineminus">-            for name in reversed(self.names):</span>
<a href="#l10.440"></a><span id="l10.440" class="difflineminus">-                binary = findInPath(name)</span>
<a href="#l10.441"></a><span id="l10.441" class="difflineminus">-                if sys.platform == 'cygwin':</span>
<a href="#l10.442"></a><span id="l10.442" class="difflineminus">-                    program_files = os.environ['PROGRAMFILES']</span>
<a href="#l10.443"></a><span id="l10.443" class="difflineminus">-                else:</span>
<a href="#l10.444"></a><span id="l10.444" class="difflineminus">-                    program_files = os.environ['ProgramFiles']</span>
<a href="#l10.445"></a><span id="l10.445" class="difflineminus">-</span>
<a href="#l10.446"></a><span id="l10.446" class="difflineminus">-                if binary is None:</span>
<a href="#l10.447"></a><span id="l10.447" class="difflineminus">-                    for bin in [(program_files, 'Mozilla Firefox', 'firefox.exe'),</span>
<a href="#l10.448"></a><span id="l10.448" class="difflineminus">-                                (os.environ.get(&quot;ProgramFiles(x86)&quot;),'Mozilla Firefox', 'firefox.exe'),</span>
<a href="#l10.449"></a><span id="l10.449" class="difflineminus">-                                (program_files,'Minefield', 'firefox.exe'),</span>
<a href="#l10.450"></a><span id="l10.450" class="difflineminus">-                                (os.environ.get(&quot;ProgramFiles(x86)&quot;),'Minefield', 'firefox.exe')</span>
<a href="#l10.451"></a><span id="l10.451" class="difflineminus">-                                ]:</span>
<a href="#l10.452"></a><span id="l10.452" class="difflineminus">-                        path = os.path.join(*bin)</span>
<a href="#l10.453"></a><span id="l10.453" class="difflineminus">-                        if os.path.isfile(path):</span>
<a href="#l10.454"></a><span id="l10.454" class="difflineminus">-                            binary = path</span>
<a href="#l10.455"></a><span id="l10.455" class="difflineminus">-                            break</span>
<a href="#l10.456"></a><span id="l10.456" class="difflineminus">-        elif sys.platform == 'darwin':</span>
<a href="#l10.457"></a><span id="l10.457" class="difflineminus">-            for name in reversed(self.names):</span>
<a href="#l10.458"></a><span id="l10.458" class="difflineminus">-                appdir = os.path.join('Applications', name.capitalize()+'.app')</span>
<a href="#l10.459"></a><span id="l10.459" class="difflineminus">-                if os.path.isdir(os.path.join(os.path.expanduser('~/'), appdir)):</span>
<a href="#l10.460"></a><span id="l10.460" class="difflineminus">-                    binary = os.path.join(os.path.expanduser('~/'), appdir,</span>
<a href="#l10.461"></a><span id="l10.461" class="difflineminus">-                                          'Contents/MacOS/'+name+'-bin')</span>
<a href="#l10.462"></a><span id="l10.462" class="difflineminus">-                elif os.path.isdir('/'+appdir):</span>
<a href="#l10.463"></a><span id="l10.463" class="difflineminus">-                    binary = os.path.join(&quot;/&quot;+appdir, 'Contents/MacOS/'+name+'-bin')</span>
<a href="#l10.464"></a><span id="l10.464" class="difflineminus">-</span>
<a href="#l10.465"></a><span id="l10.465" class="difflineminus">-                if binary is not None:</span>
<a href="#l10.466"></a><span id="l10.466" class="difflineminus">-                    if not os.path.isfile(binary):</span>
<a href="#l10.467"></a><span id="l10.467" class="difflineminus">-                        binary = binary.replace(name+'-bin', 'firefox-bin')</span>
<a href="#l10.468"></a><span id="l10.468" class="difflineminus">-                    if not os.path.isfile(binary):</span>
<a href="#l10.469"></a><span id="l10.469" class="difflineminus">-                        binary = None</span>
<a href="#l10.470"></a><span id="l10.470" class="difflineminus">-        if binary is None:</span>
<a href="#l10.471"></a><span id="l10.471" class="difflineminus">-            raise Exception('Mozrunner could not locate your binary, you will need to set it.')</span>
<a href="#l10.472"></a><span id="l10.472" class="difflineminus">-        return binary</span>
<a href="#l10.473"></a><span id="l10.473" class="difflineminus">-</span>
<a href="#l10.474"></a><span id="l10.474" class="difflineminus">-    @property</span>
<a href="#l10.475"></a><span id="l10.475" class="difflineminus">-    def command(self):</span>
<a href="#l10.476"></a><span id="l10.476" class="difflineminus">-        &quot;&quot;&quot;Returns the command list to run.&quot;&quot;&quot;</span>
<a href="#l10.477"></a><span id="l10.477" class="difflineminus">-        cmd = [self.binary, '-profile', self.profile.profile]</span>
<a href="#l10.478"></a><span id="l10.478" class="difflineminus">-        # On i386 OS X machines, i386+x86_64 universal binaries need to be told</span>
<a href="#l10.479"></a><span id="l10.479" class="difflineminus">-        # to run as i386 binaries.  If we're not running a i386+x86_64 universal</span>
<a href="#l10.480"></a><span id="l10.480" class="difflineminus">-        # binary, then this command modification is harmless.</span>
<a href="#l10.481"></a><span id="l10.481" class="difflineminus">-        if sys.platform == 'darwin':</span>
<a href="#l10.482"></a><span id="l10.482" class="difflineminus">-            if hasattr(platform, 'architecture') and platform.architecture()[0] == '32bit':</span>
<a href="#l10.483"></a><span id="l10.483" class="difflineminus">-                cmd = ['arch', '-i386'] + cmd</span>
<a href="#l10.484"></a><span id="l10.484" class="difflineminus">-        return cmd</span>
<a href="#l10.485"></a><span id="l10.485" class="difflineminus">-</span>
<a href="#l10.486"></a><span id="l10.486" class="difflineminus">-    def get_repositoryInfo(self):</span>
<a href="#l10.487"></a><span id="l10.487" class="difflineminus">-        &quot;&quot;&quot;Read repository information from application.ini and platform.ini.&quot;&quot;&quot;</span>
<a href="#l10.488"></a><span id="l10.488" class="difflineminus">-        import ConfigParser</span>
<a href="#l10.489"></a><span id="l10.489" class="difflineminus">-</span>
<a href="#l10.490"></a><span id="l10.490" class="difflineminus">-        config = ConfigParser.RawConfigParser()</span>
<a href="#l10.491"></a><span id="l10.491" class="difflineminus">-        dirname = os.path.dirname(self.binary)</span>
<a href="#l10.492"></a><span id="l10.492" class="difflineminus">-        repository = { }</span>
<a href="#l10.493"></a><span id="l10.493" class="difflineminus">-</span>
<a href="#l10.494"></a><span id="l10.494" class="difflineminus">-        for entry in [['application', 'App'], ['platform', 'Build']]:</span>
<a href="#l10.495"></a><span id="l10.495" class="difflineminus">-            (file, section) = entry</span>
<a href="#l10.496"></a><span id="l10.496" class="difflineminus">-            config.read(os.path.join(dirname, '%s.ini' % file))</span>
<a href="#l10.497"></a><span id="l10.497" class="difflineminus">-</span>
<a href="#l10.498"></a><span id="l10.498" class="difflineminus">-            for entry in [['SourceRepository', 'repository'], ['SourceStamp', 'changeset']]:</span>
<a href="#l10.499"></a><span id="l10.499" class="difflineminus">-                (key, id) = entry</span>
<a href="#l10.500"></a><span id="l10.500" class="difflineminus">-</span>
<a href="#l10.501"></a><span id="l10.501" class="difflineminus">-                try:</span>
<a href="#l10.502"></a><span id="l10.502" class="difflineminus">-                    repository['%s_%s' % (file, id)] = config.get(section, key);</span>
<a href="#l10.503"></a><span id="l10.503" class="difflineminus">-                except:</span>
<a href="#l10.504"></a><span id="l10.504" class="difflineminus">-                    repository['%s_%s' % (file, id)] = None</span>
<a href="#l10.505"></a><span id="l10.505" class="difflineminus">-</span>
<a href="#l10.506"></a><span id="l10.506" class="difflineminus">-        return repository</span>
<a href="#l10.507"></a><span id="l10.507" class="difflineminus">-</span>
<a href="#l10.508"></a><span id="l10.508" class="difflineminus">-    def start(self):</span>
<a href="#l10.509"></a><span id="l10.509" class="difflineminus">-        &quot;&quot;&quot;Run self.command in the proper environment.&quot;&quot;&quot;</span>
<a href="#l10.510"></a><span id="l10.510" class="difflineminus">-        if self.profile is None:</span>
<a href="#l10.511"></a><span id="l10.511" class="difflineminus">-            self.profile = self.profile_class()</span>
<a href="#l10.512"></a><span id="l10.512" class="difflineminus">-        self.process_handler = run_command(self.command+self.cmdargs, self.env, **self.kp_kwargs)</span>
<a href="#l10.513"></a><span id="l10.513" class="difflineminus">-</span>
<a href="#l10.514"></a><span id="l10.514" class="difflineminus">-    def wait(self, timeout=None):</span>
<a href="#l10.515"></a><span id="l10.515" class="difflineminus">-        &quot;&quot;&quot;Wait for the browser to exit.&quot;&quot;&quot;</span>
<a href="#l10.516"></a><span id="l10.516" class="difflineminus">-        self.process_handler.wait(timeout=timeout)</span>
<a href="#l10.517"></a><span id="l10.517" class="difflineminus">-</span>
<a href="#l10.518"></a><span id="l10.518" class="difflineminus">-        if sys.platform != 'win32':</span>
<a href="#l10.519"></a><span id="l10.519" class="difflineminus">-            for name in self.names:</span>
<a href="#l10.520"></a><span id="l10.520" class="difflineminus">-                for pid in get_pids(name, self.process_handler.pid):</span>
<a href="#l10.521"></a><span id="l10.521" class="difflineminus">-                    self.process_handler.pid = pid  # bad touch!</span>
<a href="#l10.522"></a><span id="l10.522" class="difflineminus">-                    self.process_handler.wait(timeout=timeout)</span>
<a href="#l10.523"></a><span id="l10.523" class="difflineminus">-</span>
<a href="#l10.524"></a><span id="l10.524" class="difflineminus">-    def stop(self):</span>
<a href="#l10.525"></a><span id="l10.525" class="difflineminus">-        &quot;&quot;&quot;Kill the browser&quot;&quot;&quot;</span>
<a href="#l10.526"></a><span id="l10.526" class="difflineminus">-</span>
<a href="#l10.527"></a><span id="l10.527" class="difflineminus">-        if not self.process_handler:</span>
<a href="#l10.528"></a><span id="l10.528" class="difflineminus">-            return</span>
<a href="#l10.529"></a><span id="l10.529" class="difflineminus">-        </span>
<a href="#l10.530"></a><span id="l10.530" class="difflineminus">-        if sys.platform != 'win32':</span>
<a href="#l10.531"></a><span id="l10.531" class="difflineminus">-            self.process_handler.kill()</span>
<a href="#l10.532"></a><span id="l10.532" class="difflineminus">-            for name in self.names:</span>
<a href="#l10.533"></a><span id="l10.533" class="difflineminus">-                for pid in get_pids(name, self.process_handler.pid):</span>
<a href="#l10.534"></a><span id="l10.534" class="difflineminus">-                    self.process_handler.pid = pid  # bad touch!</span>
<a href="#l10.535"></a><span id="l10.535" class="difflineminus">-                    self.process_handler.kill()</span>
<a href="#l10.536"></a><span id="l10.536" class="difflineminus">-        else:</span>
<a href="#l10.537"></a><span id="l10.537" class="difflineminus">-            try:</span>
<a href="#l10.538"></a><span id="l10.538" class="difflineminus">-                self.process_handler.kill(group=True)</span>
<a href="#l10.539"></a><span id="l10.539" class="difflineminus">-                # On windows, it sometimes behooves one to wait for dust to settle</span>
<a href="#l10.540"></a><span id="l10.540" class="difflineminus">-                # after killing processes.  Let's try that.</span>
<a href="#l10.541"></a><span id="l10.541" class="difflineminus">-                # TODO: Bug 640047 is invesitgating the correct way to handle this case</span>
<a href="#l10.542"></a><span id="l10.542" class="difflineminus">-                self.process_handler.wait(timeout=10)</span>
<a href="#l10.543"></a><span id="l10.543" class="difflineminus">-</span>
<a href="#l10.544"></a><span id="l10.544" class="difflineminus">-            except Exception, e:</span>
<a href="#l10.545"></a><span id="l10.545" class="difflineminus">-                logger.error('Cannot kill process, '+type(e).__name__+' '+e.message)</span>
<a href="#l10.546"></a><span id="l10.546" class="difflineminus">-</span>
<a href="#l10.547"></a><span id="l10.547" class="difflineminus">-    def cleanup(self):</span>
<a href="#l10.548"></a><span id="l10.548" class="difflineminus">-        self.stop()</span>
<a href="#l10.549"></a><span id="l10.549" class="difflineminus">-        if self.profile:</span>
<a href="#l10.550"></a><span id="l10.550" class="difflineminus">-            self.profile.cleanup()</span>
<a href="#l10.551"></a><span id="l10.551" class="difflineminus">-</span>
<a href="#l10.552"></a><span id="l10.552" class="difflineminus">-    __del__ = cleanup</span>
<a href="#l10.553"></a><span id="l10.553" class="difflineminus">-    </span>
<a href="#l10.554"></a><span id="l10.554" class="difflineminus">-</span>
<a href="#l10.555"></a><span id="l10.555" class="difflineminus">-class FirefoxRunner(Runner):</span>
<a href="#l10.556"></a><span id="l10.556" class="difflineminus">-    &quot;&quot;&quot;Specialized Runner subclass for running Firefox.&quot;&quot;&quot;</span>
<a href="#l10.557"></a><span id="l10.557" class="difflineminus">-</span>
<a href="#l10.558"></a><span id="l10.558" class="difflineminus">-    app_name = 'Firefox'</span>
<a href="#l10.559"></a><span id="l10.559" class="difflineminus">-    profile_class = FirefoxProfile</span>
<a href="#l10.560"></a><span id="l10.560" class="difflineminus">-</span>
<a href="#l10.561"></a><span id="l10.561" class="difflineminus">-    @property</span>
<a href="#l10.562"></a><span id="l10.562" class="difflineminus">-    def names(self):</span>
<a href="#l10.563"></a><span id="l10.563" class="difflineminus">-        if sys.platform == 'darwin':</span>
<a href="#l10.564"></a><span id="l10.564" class="difflineminus">-            return ['firefox', 'minefield', 'shiretoko']</span>
<a href="#l10.565"></a><span id="l10.565" class="difflineminus">-        if sys.platform.startswith('linux') or (sys.platform in ('sunos5', 'solaris')):</span>
<a href="#l10.566"></a><span id="l10.566" class="difflineminus">-            return ['firefox', 'mozilla-firefox', 'iceweasel']</span>
<a href="#l10.567"></a><span id="l10.567" class="difflineminus">-        if os.name == 'nt' or sys.platform == 'cygwin':</span>
<a href="#l10.568"></a><span id="l10.568" class="difflineminus">-            return ['firefox']</span>
<a href="#l10.569"></a><span id="l10.569" class="difflineminus">-</span>
<a href="#l10.570"></a><span id="l10.570" class="difflineminus">-class ThunderbirdRunner(Runner):</span>
<a href="#l10.571"></a><span id="l10.571" class="difflineminus">-    &quot;&quot;&quot;Specialized Runner subclass for running Thunderbird&quot;&quot;&quot;</span>
<a href="#l10.572"></a><span id="l10.572" class="difflineminus">-</span>
<a href="#l10.573"></a><span id="l10.573" class="difflineminus">-    app_name = 'Thunderbird'</span>
<a href="#l10.574"></a><span id="l10.574" class="difflineminus">-    profile_class = ThunderbirdProfile</span>
<a href="#l10.575"></a><span id="l10.575" class="difflineminus">-</span>
<a href="#l10.576"></a><span id="l10.576" class="difflineminus">-    names = [&quot;thunderbird&quot;, &quot;shredder&quot;]</span>
<a href="#l10.577"></a><span id="l10.577" class="difflineminus">-</span>
<a href="#l10.578"></a><span id="l10.578" class="difflineminus">-class CLI(object):</span>
<a href="#l10.579"></a><span id="l10.579" class="difflineminus">-    &quot;&quot;&quot;Command line interface.&quot;&quot;&quot;</span>
<a href="#l10.580"></a><span id="l10.580" class="difflineminus">-</span>
<a href="#l10.581"></a><span id="l10.581" class="difflineminus">-    runner_class = FirefoxRunner</span>
<a href="#l10.582"></a><span id="l10.582" class="difflineminus">-    profile_class = FirefoxProfile</span>
<a href="#l10.583"></a><span id="l10.583" class="difflineminus">-    module = &quot;mozrunner&quot;</span>
<a href="#l10.584"></a><span id="l10.584" class="difflineminus">-</span>
<a href="#l10.585"></a><span id="l10.585" class="difflineminus">-    parser_options = {(&quot;-b&quot;, &quot;--binary&quot;,): dict(dest=&quot;binary&quot;, help=&quot;Binary path.&quot;,</span>
<a href="#l10.586"></a><span id="l10.586" class="difflineminus">-                                                metavar=None, default=None),</span>
<a href="#l10.587"></a><span id="l10.587" class="difflineminus">-                      ('-p', &quot;--profile&quot;,): dict(dest=&quot;profile&quot;, help=&quot;Profile path.&quot;,</span>
<a href="#l10.588"></a><span id="l10.588" class="difflineminus">-                                                 metavar=None, default=None),</span>
<a href="#l10.589"></a><span id="l10.589" class="difflineminus">-                      ('-a', &quot;--addons&quot;,): dict(dest=&quot;addons&quot;, </span>
<a href="#l10.590"></a><span id="l10.590" class="difflineminus">-                                                help=&quot;Addons paths to install.&quot;,</span>
<a href="#l10.591"></a><span id="l10.591" class="difflineminus">-                                                metavar=None, default=None),</span>
<a href="#l10.592"></a><span id="l10.592" class="difflineminus">-                      (&quot;--info&quot;,): dict(dest=&quot;info&quot;, default=False,</span>
<a href="#l10.593"></a><span id="l10.593" class="difflineminus">-                                        action=&quot;store_true&quot;,</span>
<a href="#l10.594"></a><span id="l10.594" class="difflineminus">-                                        help=&quot;Print module information&quot;)</span>
<a href="#l10.595"></a><span id="l10.595" class="difflineminus">-                     }</span>
<a href="#l10.596"></a><span id="l10.596" class="difflineminus">-</span>
<a href="#l10.597"></a><span id="l10.597" class="difflineminus">-    def __init__(self):</span>
<a href="#l10.598"></a><span id="l10.598" class="difflineminus">-        &quot;&quot;&quot; Setup command line parser and parse arguments &quot;&quot;&quot;</span>
<a href="#l10.599"></a><span id="l10.599" class="difflineminus">-        self.metadata = self.get_metadata_from_egg()</span>
<a href="#l10.600"></a><span id="l10.600" class="difflineminus">-        self.parser = optparse.OptionParser(version=&quot;%prog &quot; + self.metadata[&quot;Version&quot;])</span>
<a href="#l10.601"></a><span id="l10.601" class="difflineminus">-        for names, opts in self.parser_options.items():</span>
<a href="#l10.602"></a><span id="l10.602" class="difflineminus">-            self.parser.add_option(*names, **opts)</span>
<a href="#l10.603"></a><span id="l10.603" class="difflineminus">-        (self.options, self.args) = self.parser.parse_args()</span>
<a href="#l10.604"></a><span id="l10.604" class="difflineminus">-</span>
<a href="#l10.605"></a><span id="l10.605" class="difflineminus">-        if self.options.info:</span>
<a href="#l10.606"></a><span id="l10.606" class="difflineminus">-            self.print_metadata()</span>
<a href="#l10.607"></a><span id="l10.607" class="difflineminus">-            sys.exit(0)</span>
<a href="#l10.608"></a><span id="l10.608" class="difflineminus">-            </span>
<a href="#l10.609"></a><span id="l10.609" class="difflineminus">-        # XXX should use action='append' instead of rolling our own</span>
<a href="#l10.610"></a><span id="l10.610" class="difflineminus">-        try:</span>
<a href="#l10.611"></a><span id="l10.611" class="difflineminus">-            self.addons = self.options.addons.split(',')</span>
<a href="#l10.612"></a><span id="l10.612" class="difflineminus">-        except:</span>
<a href="#l10.613"></a><span id="l10.613" class="difflineminus">-            self.addons = []</span>
<a href="#l10.614"></a><span id="l10.614" class="difflineminus">-            </span>
<a href="#l10.615"></a><span id="l10.615" class="difflineminus">-    def get_metadata_from_egg(self):</span>
<a href="#l10.616"></a><span id="l10.616" class="difflineminus">-        import pkg_resources</span>
<a href="#l10.617"></a><span id="l10.617" class="difflineminus">-        ret = {}</span>
<a href="#l10.618"></a><span id="l10.618" class="difflineminus">-        dist = pkg_resources.get_distribution(self.module)</span>
<a href="#l10.619"></a><span id="l10.619" class="difflineminus">-        if dist.has_metadata(&quot;PKG-INFO&quot;):</span>
<a href="#l10.620"></a><span id="l10.620" class="difflineminus">-            for line in dist.get_metadata_lines(&quot;PKG-INFO&quot;):</span>
<a href="#l10.621"></a><span id="l10.621" class="difflineminus">-                key, value = line.split(':', 1)</span>
<a href="#l10.622"></a><span id="l10.622" class="difflineminus">-                ret[key] = value</span>
<a href="#l10.623"></a><span id="l10.623" class="difflineminus">-        if dist.has_metadata(&quot;requires.txt&quot;):</span>
<a href="#l10.624"></a><span id="l10.624" class="difflineminus">-            ret[&quot;Dependencies&quot;] = &quot;\n&quot; + dist.get_metadata(&quot;requires.txt&quot;)    </span>
<a href="#l10.625"></a><span id="l10.625" class="difflineminus">-        return ret</span>
<a href="#l10.626"></a><span id="l10.626" class="difflineminus">-        </span>
<a href="#l10.627"></a><span id="l10.627" class="difflineminus">-    def print_metadata(self, data=(&quot;Name&quot;, &quot;Version&quot;, &quot;Summary&quot;, &quot;Home-page&quot;, </span>
<a href="#l10.628"></a><span id="l10.628" class="difflineminus">-                                   &quot;Author&quot;, &quot;Author-email&quot;, &quot;License&quot;, &quot;Platform&quot;, &quot;Dependencies&quot;)):</span>
<a href="#l10.629"></a><span id="l10.629" class="difflineminus">-        for key in data:</span>
<a href="#l10.630"></a><span id="l10.630" class="difflineminus">-            if key in self.metadata:</span>
<a href="#l10.631"></a><span id="l10.631" class="difflineminus">-                print key + &quot;: &quot; + self.metadata[key]</span>
<a href="#l10.632"></a><span id="l10.632" class="difflineminus">-</span>
<a href="#l10.633"></a><span id="l10.633" class="difflineminus">-    def create_runner(self):</span>
<a href="#l10.634"></a><span id="l10.634" class="difflineminus">-        &quot;&quot;&quot; Get the runner object &quot;&quot;&quot;</span>
<a href="#l10.635"></a><span id="l10.635" class="difflineminus">-        runner = self.get_runner(binary=self.options.binary)</span>
<a href="#l10.636"></a><span id="l10.636" class="difflineminus">-        profile = self.get_profile(binary=runner.binary,</span>
<a href="#l10.637"></a><span id="l10.637" class="difflineminus">-                                   profile=self.options.profile,</span>
<a href="#l10.638"></a><span id="l10.638" class="difflineminus">-                                   addons=self.addons)</span>
<a href="#l10.639"></a><span id="l10.639" class="difflineminus">-        runner.profile = profile</span>
<a href="#l10.640"></a><span id="l10.640" class="difflineminus">-        return runner</span>
<a href="#l10.641"></a><span id="l10.641" class="difflineminus">-</span>
<a href="#l10.642"></a><span id="l10.642" class="difflineminus">-    def get_runner(self, binary=None, profile=None):</span>
<a href="#l10.643"></a><span id="l10.643" class="difflineminus">-        &quot;&quot;&quot;Returns the runner instance for the given command line binary argument</span>
<a href="#l10.644"></a><span id="l10.644" class="difflineminus">-        the profile instance returned from self.get_profile().&quot;&quot;&quot;</span>
<a href="#l10.645"></a><span id="l10.645" class="difflineminus">-        return self.runner_class(binary, profile)</span>
<a href="#l10.646"></a><span id="l10.646" class="difflineminus">-</span>
<a href="#l10.647"></a><span id="l10.647" class="difflineminus">-    def get_profile(self, binary=None, profile=None, addons=None, preferences=None):</span>
<a href="#l10.648"></a><span id="l10.648" class="difflineminus">-        &quot;&quot;&quot;Returns the profile instance for the given command line arguments.&quot;&quot;&quot;</span>
<a href="#l10.649"></a><span id="l10.649" class="difflineminus">-        addons = addons or []</span>
<a href="#l10.650"></a><span id="l10.650" class="difflineminus">-        preferences = preferences or {}</span>
<a href="#l10.651"></a><span id="l10.651" class="difflineminus">-        return self.profile_class(binary, profile, addons, preferences)</span>
<a href="#l10.652"></a><span id="l10.652" class="difflineminus">-</span>
<a href="#l10.653"></a><span id="l10.653" class="difflineminus">-    def run(self):</span>
<a href="#l10.654"></a><span id="l10.654" class="difflineminus">-        runner = self.create_runner()</span>
<a href="#l10.655"></a><span id="l10.655" class="difflineminus">-        self.start(runner)</span>
<a href="#l10.656"></a><span id="l10.656" class="difflineminus">-        runner.profile.cleanup()</span>
<a href="#l10.657"></a><span id="l10.657" class="difflineminus">-</span>
<a href="#l10.658"></a><span id="l10.658" class="difflineminus">-    def start(self, runner):</span>
<a href="#l10.659"></a><span id="l10.659" class="difflineminus">-        &quot;&quot;&quot;Starts the runner and waits for Firefox to exitor Keyboard Interrupt.</span>
<a href="#l10.660"></a><span id="l10.660" class="difflineminus">-        Shoule be overwritten to provide custom running of the runner instance.&quot;&quot;&quot;</span>
<a href="#l10.661"></a><span id="l10.661" class="difflineminus">-        runner.start()</span>
<a href="#l10.662"></a><span id="l10.662" class="difflineminus">-        print 'Started:', ' '.join(runner.command)</span>
<a href="#l10.663"></a><span id="l10.663" class="difflineminus">-        try:</span>
<a href="#l10.664"></a><span id="l10.664" class="difflineminus">-            runner.wait()</span>
<a href="#l10.665"></a><span id="l10.665" class="difflineminus">-        except KeyboardInterrupt:</span>
<a href="#l10.666"></a><span id="l10.666" class="difflineminus">-            runner.stop()</span>
<a href="#l10.667"></a><span id="l10.667" class="difflineminus">-</span>
<a href="#l10.668"></a><span id="l10.668" class="difflineminus">-</span>
<a href="#l10.669"></a><span id="l10.669" class="difflineminus">-def cli():</span>
<a href="#l10.670"></a><span id="l10.670" class="difflineminus">-    CLI().run()</span>
<a href="#l10.671"></a><span id="l10.671" class="difflineminus">-</span>
<a href="#l10.672"></a><span id="l10.672" class="difflineminus">-def print_addon_ids(args=sys.argv[1:]):</span>
<a href="#l10.673"></a><span id="l10.673" class="difflineminus">-    &quot;&quot;&quot;print addon ids for testing&quot;&quot;&quot;</span>
<a href="#l10.674"></a><span id="l10.674" class="difflineminus">-    for arg in args:</span>
<a href="#l10.675"></a><span id="l10.675" class="difflineminus">-        print Profile.addon_id(arg)</span>
<a href="#l10.676"></a><span id="l10.676" class="difflineminus">-    </span>
<a href="#l10.677"></a><span id="l10.677" class="difflineminus">-    </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1">deleted file mode 100644</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineminus">--- a/mail/test/resources/mozrunner/mozrunner/killableprocess.py</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineplus">+++ /dev/null</span>
<a href="#l11.4"></a><span id="l11.4" class="difflineat">@@ -1,352 +0,0 @@</span>
<a href="#l11.5"></a><span id="l11.5" class="difflineminus">-# killableprocess - subprocesses which can be reliably killed</span>
<a href="#l11.6"></a><span id="l11.6" class="difflineminus">-#</span>
<a href="#l11.7"></a><span id="l11.7" class="difflineminus">-# Parts of this module are copied from the subprocess.py file contained</span>
<a href="#l11.8"></a><span id="l11.8" class="difflineminus">-# in the Python distribution.</span>
<a href="#l11.9"></a><span id="l11.9" class="difflineminus">-#</span>
<a href="#l11.10"></a><span id="l11.10" class="difflineminus">-# Copyright (c) 2003-2004 by Peter Astrand &lt;astrand@lysator.liu.se&gt;</span>
<a href="#l11.11"></a><span id="l11.11" class="difflineminus">-#</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-# Additions and modifications written by Benjamin Smedberg</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-# &lt;benjamin@smedbergs.us&gt; are Copyright (c) 2006 by the Mozilla Foundation</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineminus">-# &lt;http://www.mozilla.org/&gt;</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineminus">-#</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineminus">-# More Modifications</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineminus">-# Copyright (c) 2006-2007 by Mike Taylor &lt;bear@code-bear.com&gt;</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineminus">-# Copyright (c) 2007-2008 by Mikeal Rogers &lt;mikeal@mozilla.com&gt;</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineminus">-#</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineminus">-# By obtaining, using, and/or copying this software and/or its</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineminus">-# associated documentation, you agree that you have read, understood,</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineminus">-# and will comply with the following terms and conditions:</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineminus">-#</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineminus">-# Permission to use, copy, modify, and distribute this software and</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineminus">-# its associated documentation for any purpose and without fee is</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineminus">-# hereby granted, provided that the above copyright notice appears in</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineminus">-# all copies, and that both that copyright notice and this permission</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineminus">-# notice appear in supporting documentation, and that the name of the</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineminus">-# author not be used in advertising or publicity pertaining to</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineminus">-# distribution of the software without specific, written prior</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineminus">-# permission.</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineminus">-#</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineminus">-# THE AUTHOR DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE,</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineminus">-# INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS.</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineminus">-# IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, INDIRECT OR</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineminus">-# CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineminus">-# OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT,</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineminus">-# NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineminus">-# WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineminus">-</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineminus">-&quot;&quot;&quot;killableprocess - Subprocesses which can be reliably killed</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineminus">-</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineminus">-This module is a subclass of the builtin &quot;subprocess&quot; module. It allows</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineminus">-processes that launch subprocesses to be reliably killed on Windows (via the Popen.kill() method.</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineminus">-</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineminus">-It also adds a timeout argument to Wait() for a limited period of time before</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineminus">-forcefully killing the process.</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineminus">-</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineminus">-Note: On Windows, this module requires Windows 2000 or higher (no support for</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineminus">-Windows 95, 98, or NT 4.0). It also requires ctypes, which is bundled with</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineminus">-Python 2.5+ or available from http://python.net/crew/theller/ctypes/</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineminus">-&quot;&quot;&quot;</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineminus">-</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineminus">-import subprocess</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineminus">-import sys</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineminus">-import os</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineminus">-import time</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineminus">-import datetime</span>
<a href="#l11.59"></a><span id="l11.59" class="difflineminus">-import types</span>
<a href="#l11.60"></a><span id="l11.60" class="difflineminus">-import exceptions</span>
<a href="#l11.61"></a><span id="l11.61" class="difflineminus">-</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineminus">-try:</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineminus">-    from subprocess import CalledProcessError</span>
<a href="#l11.64"></a><span id="l11.64" class="difflineminus">-except ImportError:</span>
<a href="#l11.65"></a><span id="l11.65" class="difflineminus">-    # Python 2.4 doesn't implement CalledProcessError</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineminus">-    class CalledProcessError(Exception):</span>
<a href="#l11.67"></a><span id="l11.67" class="difflineminus">-        &quot;&quot;&quot;This exception is raised when a process run by check_call() returns</span>
<a href="#l11.68"></a><span id="l11.68" class="difflineminus">-        a non-zero exit status. The exit status will be stored in the</span>
<a href="#l11.69"></a><span id="l11.69" class="difflineminus">-        returncode attribute.&quot;&quot;&quot;</span>
<a href="#l11.70"></a><span id="l11.70" class="difflineminus">-        def __init__(self, returncode, cmd):</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineminus">-            self.returncode = returncode</span>
<a href="#l11.72"></a><span id="l11.72" class="difflineminus">-            self.cmd = cmd</span>
<a href="#l11.73"></a><span id="l11.73" class="difflineminus">-        def __str__(self):</span>
<a href="#l11.74"></a><span id="l11.74" class="difflineminus">-            return &quot;Command '%s' returned non-zero exit status %d&quot; % (self.cmd, self.returncode)</span>
<a href="#l11.75"></a><span id="l11.75" class="difflineminus">-</span>
<a href="#l11.76"></a><span id="l11.76" class="difflineminus">-mswindows = (sys.platform == &quot;win32&quot;)</span>
<a href="#l11.77"></a><span id="l11.77" class="difflineminus">-</span>
<a href="#l11.78"></a><span id="l11.78" class="difflineminus">-if mswindows:</span>
<a href="#l11.79"></a><span id="l11.79" class="difflineminus">-    from ctypes import sizeof, addressof, c_ulong, byref, POINTER, WinError, c_longlong</span>
<a href="#l11.80"></a><span id="l11.80" class="difflineminus">-    import winprocess</span>
<a href="#l11.81"></a><span id="l11.81" class="difflineminus">-    from qijo import JobObjectExtendedLimitInformation, JOBOBJECT_BASIC_LIMIT_INFORMATION,\</span>
<a href="#l11.82"></a><span id="l11.82" class="difflineminus">-    JOBOBJECT_EXTENDED_LIMIT_INFORMATION, IO_COUNTERS</span>
<a href="#l11.83"></a><span id="l11.83" class="difflineminus">-else:</span>
<a href="#l11.84"></a><span id="l11.84" class="difflineminus">-    import signal</span>
<a href="#l11.85"></a><span id="l11.85" class="difflineminus">-</span>
<a href="#l11.86"></a><span id="l11.86" class="difflineminus">-def call(*args, **kwargs):</span>
<a href="#l11.87"></a><span id="l11.87" class="difflineminus">-    waitargs = {}</span>
<a href="#l11.88"></a><span id="l11.88" class="difflineminus">-    if &quot;timeout&quot; in kwargs:</span>
<a href="#l11.89"></a><span id="l11.89" class="difflineminus">-        waitargs[&quot;timeout&quot;] = kwargs.pop(&quot;timeout&quot;)</span>
<a href="#l11.90"></a><span id="l11.90" class="difflineminus">-</span>
<a href="#l11.91"></a><span id="l11.91" class="difflineminus">-    return Popen(*args, **kwargs).wait(**waitargs)</span>
<a href="#l11.92"></a><span id="l11.92" class="difflineminus">-</span>
<a href="#l11.93"></a><span id="l11.93" class="difflineminus">-def check_call(*args, **kwargs):</span>
<a href="#l11.94"></a><span id="l11.94" class="difflineminus">-    &quot;&quot;&quot;Call a program with an optional timeout. If the program has a non-zero</span>
<a href="#l11.95"></a><span id="l11.95" class="difflineminus">-    exit status, raises a CalledProcessError.&quot;&quot;&quot;</span>
<a href="#l11.96"></a><span id="l11.96" class="difflineminus">-</span>
<a href="#l11.97"></a><span id="l11.97" class="difflineminus">-    retcode = call(*args, **kwargs)</span>
<a href="#l11.98"></a><span id="l11.98" class="difflineminus">-    if retcode:</span>
<a href="#l11.99"></a><span id="l11.99" class="difflineminus">-        cmd = kwargs.get(&quot;args&quot;)</span>
<a href="#l11.100"></a><span id="l11.100" class="difflineminus">-        if cmd is None:</span>
<a href="#l11.101"></a><span id="l11.101" class="difflineminus">-            cmd = args[0]</span>
<a href="#l11.102"></a><span id="l11.102" class="difflineminus">-        raise CalledProcessError(retcode, cmd)</span>
<a href="#l11.103"></a><span id="l11.103" class="difflineminus">-</span>
<a href="#l11.104"></a><span id="l11.104" class="difflineminus">-if not mswindows:</span>
<a href="#l11.105"></a><span id="l11.105" class="difflineminus">-    def DoNothing(*args):</span>
<a href="#l11.106"></a><span id="l11.106" class="difflineminus">-        pass</span>
<a href="#l11.107"></a><span id="l11.107" class="difflineminus">-</span>
<a href="#l11.108"></a><span id="l11.108" class="difflineminus">-class Popen(subprocess.Popen):</span>
<a href="#l11.109"></a><span id="l11.109" class="difflineminus">-    kill_called = False</span>
<a href="#l11.110"></a><span id="l11.110" class="difflineminus">-    if mswindows:</span>
<a href="#l11.111"></a><span id="l11.111" class="difflineminus">-        def _execute_child(self, args, executable, preexec_fn, close_fds,</span>
<a href="#l11.112"></a><span id="l11.112" class="difflineminus">-                           cwd, env, universal_newlines, startupinfo,</span>
<a href="#l11.113"></a><span id="l11.113" class="difflineminus">-                           creationflags, shell,</span>
<a href="#l11.114"></a><span id="l11.114" class="difflineminus">-                           p2cread, p2cwrite,</span>
<a href="#l11.115"></a><span id="l11.115" class="difflineminus">-                           c2pread, c2pwrite,</span>
<a href="#l11.116"></a><span id="l11.116" class="difflineminus">-                           errread, errwrite):</span>
<a href="#l11.117"></a><span id="l11.117" class="difflineminus">-            if not isinstance(args, types.StringTypes):</span>
<a href="#l11.118"></a><span id="l11.118" class="difflineminus">-                args = subprocess.list2cmdline(args)</span>
<a href="#l11.119"></a><span id="l11.119" class="difflineminus">-            </span>
<a href="#l11.120"></a><span id="l11.120" class="difflineminus">-            # Always or in the create new process group</span>
<a href="#l11.121"></a><span id="l11.121" class="difflineminus">-            creationflags |= winprocess.CREATE_NEW_PROCESS_GROUP</span>
<a href="#l11.122"></a><span id="l11.122" class="difflineminus">-</span>
<a href="#l11.123"></a><span id="l11.123" class="difflineminus">-            if startupinfo is None:</span>
<a href="#l11.124"></a><span id="l11.124" class="difflineminus">-                startupinfo = winprocess.STARTUPINFO()</span>
<a href="#l11.125"></a><span id="l11.125" class="difflineminus">-</span>
<a href="#l11.126"></a><span id="l11.126" class="difflineminus">-            if None not in (p2cread, c2pwrite, errwrite):</span>
<a href="#l11.127"></a><span id="l11.127" class="difflineminus">-                startupinfo.dwFlags |= winprocess.STARTF_USESTDHANDLES</span>
<a href="#l11.128"></a><span id="l11.128" class="difflineminus">-                </span>
<a href="#l11.129"></a><span id="l11.129" class="difflineminus">-                startupinfo.hStdInput = int(p2cread)</span>
<a href="#l11.130"></a><span id="l11.130" class="difflineminus">-                startupinfo.hStdOutput = int(c2pwrite)</span>
<a href="#l11.131"></a><span id="l11.131" class="difflineminus">-                startupinfo.hStdError = int(errwrite)</span>
<a href="#l11.132"></a><span id="l11.132" class="difflineminus">-            if shell:</span>
<a href="#l11.133"></a><span id="l11.133" class="difflineminus">-                startupinfo.dwFlags |= winprocess.STARTF_USESHOWWINDOW</span>
<a href="#l11.134"></a><span id="l11.134" class="difflineminus">-                startupinfo.wShowWindow = winprocess.SW_HIDE</span>
<a href="#l11.135"></a><span id="l11.135" class="difflineminus">-                comspec = os.environ.get(&quot;COMSPEC&quot;, &quot;cmd.exe&quot;)</span>
<a href="#l11.136"></a><span id="l11.136" class="difflineminus">-                args = comspec + &quot; /c &quot; + args</span>
<a href="#l11.137"></a><span id="l11.137" class="difflineminus">-</span>
<a href="#l11.138"></a><span id="l11.138" class="difflineminus">-            # determine if we can create create a job</span>
<a href="#l11.139"></a><span id="l11.139" class="difflineminus">-            canCreateJob = winprocess.CanCreateJobObject()</span>
<a href="#l11.140"></a><span id="l11.140" class="difflineminus">-</span>
<a href="#l11.141"></a><span id="l11.141" class="difflineminus">-            # set process creation flags</span>
<a href="#l11.142"></a><span id="l11.142" class="difflineminus">-            creationflags |= winprocess.CREATE_SUSPENDED</span>
<a href="#l11.143"></a><span id="l11.143" class="difflineminus">-            creationflags |= winprocess.CREATE_UNICODE_ENVIRONMENT</span>
<a href="#l11.144"></a><span id="l11.144" class="difflineminus">-            if canCreateJob:</span>
<a href="#l11.145"></a><span id="l11.145" class="difflineminus">-                # Uncomment this line below to discover very useful things about your environment</span>
<a href="#l11.146"></a><span id="l11.146" class="difflineminus">-                #print &quot;++++ killableprocess: releng twistd patch not applied, we can create job objects&quot;</span>
<a href="#l11.147"></a><span id="l11.147" class="difflineminus">-                creationflags |= winprocess.CREATE_BREAKAWAY_FROM_JOB</span>
<a href="#l11.148"></a><span id="l11.148" class="difflineminus">-</span>
<a href="#l11.149"></a><span id="l11.149" class="difflineminus">-            # create the process</span>
<a href="#l11.150"></a><span id="l11.150" class="difflineminus">-            hp, ht, pid, tid = winprocess.CreateProcess(</span>
<a href="#l11.151"></a><span id="l11.151" class="difflineminus">-                executable, args,</span>
<a href="#l11.152"></a><span id="l11.152" class="difflineminus">-                None, None, # No special security</span>
<a href="#l11.153"></a><span id="l11.153" class="difflineminus">-                1, # Must inherit handles!</span>
<a href="#l11.154"></a><span id="l11.154" class="difflineminus">-                creationflags,</span>
<a href="#l11.155"></a><span id="l11.155" class="difflineminus">-                winprocess.EnvironmentBlock(env),</span>
<a href="#l11.156"></a><span id="l11.156" class="difflineminus">-                cwd, startupinfo)</span>
<a href="#l11.157"></a><span id="l11.157" class="difflineminus">-            self._child_created = True</span>
<a href="#l11.158"></a><span id="l11.158" class="difflineminus">-            self._handle = hp</span>
<a href="#l11.159"></a><span id="l11.159" class="difflineminus">-            self._thread = ht</span>
<a href="#l11.160"></a><span id="l11.160" class="difflineminus">-            self.pid = pid</span>
<a href="#l11.161"></a><span id="l11.161" class="difflineminus">-            self.tid = tid</span>
<a href="#l11.162"></a><span id="l11.162" class="difflineminus">-</span>
<a href="#l11.163"></a><span id="l11.163" class="difflineminus">-            if canCreateJob:</span>
<a href="#l11.164"></a><span id="l11.164" class="difflineminus">-                # We create a new job for this process, so that we can kill</span>
<a href="#l11.165"></a><span id="l11.165" class="difflineminus">-                # the process and any sub-processes </span>
<a href="#l11.166"></a><span id="l11.166" class="difflineminus">-                self._job = winprocess.CreateJobObject()</span>
<a href="#l11.167"></a><span id="l11.167" class="difflineminus">-                # Allow subprocesses to break away from us - necessary for</span>
<a href="#l11.168"></a><span id="l11.168" class="difflineminus">-                # flash with protected mode</span>
<a href="#l11.169"></a><span id="l11.169" class="difflineminus">-                jbli = JOBOBJECT_BASIC_LIMIT_INFORMATION(</span>
<a href="#l11.170"></a><span id="l11.170" class="difflineminus">-                                c_longlong(0), # per process time limit (ignored)</span>
<a href="#l11.171"></a><span id="l11.171" class="difflineminus">-                                c_longlong(0), # per job user time limit (ignored)</span>
<a href="#l11.172"></a><span id="l11.172" class="difflineminus">-                                winprocess.JOB_OBJECT_LIMIT_BREAKAWAY_OK,</span>
<a href="#l11.173"></a><span id="l11.173" class="difflineminus">-                                0, # min working set (ignored)</span>
<a href="#l11.174"></a><span id="l11.174" class="difflineminus">-                                0, # max working set (ignored)</span>
<a href="#l11.175"></a><span id="l11.175" class="difflineminus">-                                0, # active process limit (ignored)</span>
<a href="#l11.176"></a><span id="l11.176" class="difflineminus">-                                None, # affinity (ignored)</span>
<a href="#l11.177"></a><span id="l11.177" class="difflineminus">-                                0, # Priority class (ignored)</span>
<a href="#l11.178"></a><span id="l11.178" class="difflineminus">-                                0, # Scheduling class (ignored)</span>
<a href="#l11.179"></a><span id="l11.179" class="difflineminus">-                                )</span>
<a href="#l11.180"></a><span id="l11.180" class="difflineminus">-</span>
<a href="#l11.181"></a><span id="l11.181" class="difflineminus">-                iocntr = IO_COUNTERS()</span>
<a href="#l11.182"></a><span id="l11.182" class="difflineminus">-                jeli = JOBOBJECT_EXTENDED_LIMIT_INFORMATION(</span>
<a href="#l11.183"></a><span id="l11.183" class="difflineminus">-                                jbli, # basic limit info struct</span>
<a href="#l11.184"></a><span id="l11.184" class="difflineminus">-                                iocntr,    # io_counters (ignored)</span>
<a href="#l11.185"></a><span id="l11.185" class="difflineminus">-                                0,    # process mem limit (ignored)</span>
<a href="#l11.186"></a><span id="l11.186" class="difflineminus">-                                0,    # job mem limit (ignored)</span>
<a href="#l11.187"></a><span id="l11.187" class="difflineminus">-                                0,    # peak process limit (ignored)</span>
<a href="#l11.188"></a><span id="l11.188" class="difflineminus">-                                0)    # peak job limit (ignored)</span>
<a href="#l11.189"></a><span id="l11.189" class="difflineminus">-</span>
<a href="#l11.190"></a><span id="l11.190" class="difflineminus">-                winprocess.SetInformationJobObject(self._job,</span>
<a href="#l11.191"></a><span id="l11.191" class="difflineminus">-                                JobObjectExtendedLimitInformation,</span>
<a href="#l11.192"></a><span id="l11.192" class="difflineminus">-                                addressof(jeli),</span>
<a href="#l11.193"></a><span id="l11.193" class="difflineminus">-                                sizeof(jeli)</span>
<a href="#l11.194"></a><span id="l11.194" class="difflineminus">-                                )</span>
<a href="#l11.195"></a><span id="l11.195" class="difflineminus">-                winprocess.AssignProcessToJobObject(self._job, int(hp))</span>
<a href="#l11.196"></a><span id="l11.196" class="difflineminus">-            else:</span>
<a href="#l11.197"></a><span id="l11.197" class="difflineminus">-                self._job = None</span>
<a href="#l11.198"></a><span id="l11.198" class="difflineminus">-</span>
<a href="#l11.199"></a><span id="l11.199" class="difflineminus">-            winprocess.ResumeThread(int(ht))</span>
<a href="#l11.200"></a><span id="l11.200" class="difflineminus">-            ht.Close()</span>
<a href="#l11.201"></a><span id="l11.201" class="difflineminus">-</span>
<a href="#l11.202"></a><span id="l11.202" class="difflineminus">-            if p2cread is not None:</span>
<a href="#l11.203"></a><span id="l11.203" class="difflineminus">-                p2cread.Close()</span>
<a href="#l11.204"></a><span id="l11.204" class="difflineminus">-            if c2pwrite is not None:</span>
<a href="#l11.205"></a><span id="l11.205" class="difflineminus">-                c2pwrite.Close()</span>
<a href="#l11.206"></a><span id="l11.206" class="difflineminus">-            if errwrite is not None:</span>
<a href="#l11.207"></a><span id="l11.207" class="difflineminus">-                errwrite.Close()</span>
<a href="#l11.208"></a><span id="l11.208" class="difflineminus">-            time.sleep(.1)</span>
<a href="#l11.209"></a><span id="l11.209" class="difflineminus">-</span>
<a href="#l11.210"></a><span id="l11.210" class="difflineminus">-    def kill(self, group=True):</span>
<a href="#l11.211"></a><span id="l11.211" class="difflineminus">-        &quot;&quot;&quot;Kill the process. If group=True, all sub-processes will also be killed.&quot;&quot;&quot;</span>
<a href="#l11.212"></a><span id="l11.212" class="difflineminus">-        self.kill_called = True</span>
<a href="#l11.213"></a><span id="l11.213" class="difflineminus">-</span>
<a href="#l11.214"></a><span id="l11.214" class="difflineminus">-        if mswindows:</span>
<a href="#l11.215"></a><span id="l11.215" class="difflineminus">-            if group and self._job:</span>
<a href="#l11.216"></a><span id="l11.216" class="difflineminus">-                winprocess.TerminateJobObject(self._job, 127)</span>
<a href="#l11.217"></a><span id="l11.217" class="difflineminus">-            else:</span>
<a href="#l11.218"></a><span id="l11.218" class="difflineminus">-                winprocess.TerminateProcess(self._handle, 127)</span>
<a href="#l11.219"></a><span id="l11.219" class="difflineminus">-            self.returncode = 127    </span>
<a href="#l11.220"></a><span id="l11.220" class="difflineminus">-        else:</span>
<a href="#l11.221"></a><span id="l11.221" class="difflineminus">-            if group:</span>
<a href="#l11.222"></a><span id="l11.222" class="difflineminus">-                try:</span>
<a href="#l11.223"></a><span id="l11.223" class="difflineminus">-                    os.killpg(self.pid, signal.SIGKILL)</span>
<a href="#l11.224"></a><span id="l11.224" class="difflineminus">-                except: pass</span>
<a href="#l11.225"></a><span id="l11.225" class="difflineminus">-            else:</span>
<a href="#l11.226"></a><span id="l11.226" class="difflineminus">-                os.kill(self.pid, signal.SIGKILL)</span>
<a href="#l11.227"></a><span id="l11.227" class="difflineminus">-</span>
<a href="#l11.228"></a><span id="l11.228" class="difflineminus">-            # If we don't call os.wait() we end up with zombie processes</span>
<a href="#l11.229"></a><span id="l11.229" class="difflineminus">-            # see bug 658509, but it seems to traceback on linux</span>
<a href="#l11.230"></a><span id="l11.230" class="difflineminus">-            if sys.platform == &quot;darwin&quot;:</span>
<a href="#l11.231"></a><span id="l11.231" class="difflineminus">-                try:</span>
<a href="#l11.232"></a><span id="l11.232" class="difflineminus">-                    os.wait()</span>
<a href="#l11.233"></a><span id="l11.233" class="difflineminus">-                except OSError, e:</span>
<a href="#l11.234"></a><span id="l11.234" class="difflineminus">-                    # The process doesn't exist anymore so we can ignore it</span>
<a href="#l11.235"></a><span id="l11.235" class="difflineminus">-                    pass</span>
<a href="#l11.236"></a><span id="l11.236" class="difflineminus">-</span>
<a href="#l11.237"></a><span id="l11.237" class="difflineminus">-            self.returncode = -9</span>
<a href="#l11.238"></a><span id="l11.238" class="difflineminus">-</span>
<a href="#l11.239"></a><span id="l11.239" class="difflineminus">-    def wait(self, timeout=None, group=True):</span>
<a href="#l11.240"></a><span id="l11.240" class="difflineminus">-        &quot;&quot;&quot;Wait for the process to terminate. Returns returncode attribute.</span>
<a href="#l11.241"></a><span id="l11.241" class="difflineminus">-        If timeout seconds are reached and the process has not terminated,</span>
<a href="#l11.242"></a><span id="l11.242" class="difflineminus">-        it will be forcefully killed. If timeout is -1, wait will not</span>
<a href="#l11.243"></a><span id="l11.243" class="difflineminus">-        time out.&quot;&quot;&quot;</span>
<a href="#l11.244"></a><span id="l11.244" class="difflineminus">-        if timeout is not None:</span>
<a href="#l11.245"></a><span id="l11.245" class="difflineminus">-            # timeout is now in milliseconds</span>
<a href="#l11.246"></a><span id="l11.246" class="difflineminus">-            timeout = timeout * 1000</span>
<a href="#l11.247"></a><span id="l11.247" class="difflineminus">-</span>
<a href="#l11.248"></a><span id="l11.248" class="difflineminus">-        starttime = datetime.datetime.now()</span>
<a href="#l11.249"></a><span id="l11.249" class="difflineminus">-</span>
<a href="#l11.250"></a><span id="l11.250" class="difflineminus">-        if mswindows:</span>
<a href="#l11.251"></a><span id="l11.251" class="difflineminus">-            if timeout is None:</span>
<a href="#l11.252"></a><span id="l11.252" class="difflineminus">-                timeout = -1</span>
<a href="#l11.253"></a><span id="l11.253" class="difflineminus">-            rc = winprocess.WaitForSingleObject(self._handle, timeout)</span>
<a href="#l11.254"></a><span id="l11.254" class="difflineminus">-            </span>
<a href="#l11.255"></a><span id="l11.255" class="difflineminus">-            if (rc == winprocess.WAIT_OBJECT_0 or</span>
<a href="#l11.256"></a><span id="l11.256" class="difflineminus">-                rc == winprocess.WAIT_ABANDONED or</span>
<a href="#l11.257"></a><span id="l11.257" class="difflineminus">-                rc == winprocess.WAIT_FAILED):</span>
<a href="#l11.258"></a><span id="l11.258" class="difflineminus">-                # Object has either signaled, or the API call has failed.  In </span>
<a href="#l11.259"></a><span id="l11.259" class="difflineminus">-                # both cases we want to give the OS the benefit of the doubt</span>
<a href="#l11.260"></a><span id="l11.260" class="difflineminus">-                # and supply a little time before we start shooting processes</span>
<a href="#l11.261"></a><span id="l11.261" class="difflineminus">-                # with an M-16.</span>
<a href="#l11.262"></a><span id="l11.262" class="difflineminus">-</span>
<a href="#l11.263"></a><span id="l11.263" class="difflineminus">-                # Returns 1 if running, 0 if not, -1 if timed out                </span>
<a href="#l11.264"></a><span id="l11.264" class="difflineminus">-                def check():</span>
<a href="#l11.265"></a><span id="l11.265" class="difflineminus">-                    now = datetime.datetime.now()</span>
<a href="#l11.266"></a><span id="l11.266" class="difflineminus">-                    diff = now - starttime</span>
<a href="#l11.267"></a><span id="l11.267" class="difflineminus">-                    if (diff.seconds * 1000 * 1000 + diff.microseconds) &lt; (timeout * 1000):</span>
<a href="#l11.268"></a><span id="l11.268" class="difflineminus">-                        if self._job:</span>
<a href="#l11.269"></a><span id="l11.269" class="difflineminus">-                            if (winprocess.QueryInformationJobObject(self._job, 8)['BasicInfo']['ActiveProcesses'] &gt; 0):</span>
<a href="#l11.270"></a><span id="l11.270" class="difflineminus">-                                # Job Object is still containing active processes</span>
<a href="#l11.271"></a><span id="l11.271" class="difflineminus">-                                return 1</span>
<a href="#l11.272"></a><span id="l11.272" class="difflineminus">-                        else:</span>
<a href="#l11.273"></a><span id="l11.273" class="difflineminus">-                            # No job, we use GetExitCodeProcess, which will tell us if the process is still active</span>
<a href="#l11.274"></a><span id="l11.274" class="difflineminus">-                            self.returncode = winprocess.GetExitCodeProcess(self._handle)</span>
<a href="#l11.275"></a><span id="l11.275" class="difflineminus">-                            if (self.returncode == winprocess.STILL_ACTIVE):</span>
<a href="#l11.276"></a><span id="l11.276" class="difflineminus">-                                # Process still active, continue waiting</span>
<a href="#l11.277"></a><span id="l11.277" class="difflineminus">-                                return 1</span>
<a href="#l11.278"></a><span id="l11.278" class="difflineminus">-                        # Process not active, return 0</span>
<a href="#l11.279"></a><span id="l11.279" class="difflineminus">-                        return 0</span>
<a href="#l11.280"></a><span id="l11.280" class="difflineminus">-                    else:</span>
<a href="#l11.281"></a><span id="l11.281" class="difflineminus">-                        # Timed out, return -1</span>
<a href="#l11.282"></a><span id="l11.282" class="difflineminus">-                        return -1</span>
<a href="#l11.283"></a><span id="l11.283" class="difflineminus">-</span>
<a href="#l11.284"></a><span id="l11.284" class="difflineminus">-                notdone = check()</span>
<a href="#l11.285"></a><span id="l11.285" class="difflineminus">-                while notdone == 1:</span>
<a href="#l11.286"></a><span id="l11.286" class="difflineminus">-                    time.sleep(.5)</span>
<a href="#l11.287"></a><span id="l11.287" class="difflineminus">-                    notdone = check()</span>
<a href="#l11.288"></a><span id="l11.288" class="difflineminus">-</span>
<a href="#l11.289"></a><span id="l11.289" class="difflineminus">-                if notdone == -1:</span>
<a href="#l11.290"></a><span id="l11.290" class="difflineminus">-                    # Then check timed out, we have a hung process, attempt</span>
<a href="#l11.291"></a><span id="l11.291" class="difflineminus">-                    # last ditch kill with explosives</span>
<a href="#l11.292"></a><span id="l11.292" class="difflineminus">-                    self.kill(group)</span>
<a href="#l11.293"></a><span id="l11.293" class="difflineminus">-                                </span>
<a href="#l11.294"></a><span id="l11.294" class="difflineminus">-            else:</span>
<a href="#l11.295"></a><span id="l11.295" class="difflineminus">-                # In this case waitforsingleobject timed out.  We have to</span>
<a href="#l11.296"></a><span id="l11.296" class="difflineminus">-                # take the process behind the woodshed and shoot it.</span>
<a href="#l11.297"></a><span id="l11.297" class="difflineminus">-                self.kill(group)</span>
<a href="#l11.298"></a><span id="l11.298" class="difflineminus">-</span>
<a href="#l11.299"></a><span id="l11.299" class="difflineminus">-        else:</span>
<a href="#l11.300"></a><span id="l11.300" class="difflineminus">-            if sys.platform.startswith('linux') or (sys.platform in ('sunos5', 'solaris')):</span>
<a href="#l11.301"></a><span id="l11.301" class="difflineminus">-                def group_wait(timeout):</span>
<a href="#l11.302"></a><span id="l11.302" class="difflineminus">-                    try:</span>
<a href="#l11.303"></a><span id="l11.303" class="difflineminus">-                        os.waitpid(self.pid, 0)</span>
<a href="#l11.304"></a><span id="l11.304" class="difflineminus">-                    except OSError, e:</span>
<a href="#l11.305"></a><span id="l11.305" class="difflineminus">-                        pass # If wait has already been called on this pid, bad things happen</span>
<a href="#l11.306"></a><span id="l11.306" class="difflineminus">-                    return self.returncode</span>
<a href="#l11.307"></a><span id="l11.307" class="difflineminus">-            elif sys.platform == 'darwin':</span>
<a href="#l11.308"></a><span id="l11.308" class="difflineminus">-                def group_wait(timeout):</span>
<a href="#l11.309"></a><span id="l11.309" class="difflineminus">-                    try:</span>
<a href="#l11.310"></a><span id="l11.310" class="difflineminus">-                        count = 0</span>
<a href="#l11.311"></a><span id="l11.311" class="difflineminus">-                        if timeout is None and self.kill_called:</span>
<a href="#l11.312"></a><span id="l11.312" class="difflineminus">-                            timeout = 10 # Have to set some kind of timeout or else this could go on forever</span>
<a href="#l11.313"></a><span id="l11.313" class="difflineminus">-                        if timeout is None:</span>
<a href="#l11.314"></a><span id="l11.314" class="difflineminus">-                            while 1:</span>
<a href="#l11.315"></a><span id="l11.315" class="difflineminus">-                                os.killpg(self.pid, signal.SIG_DFL)</span>
<a href="#l11.316"></a><span id="l11.316" class="difflineminus">-                        while ((count * 2) &lt;= timeout):</span>
<a href="#l11.317"></a><span id="l11.317" class="difflineminus">-                            os.killpg(self.pid, signal.SIG_DFL)</span>
<a href="#l11.318"></a><span id="l11.318" class="difflineminus">-                            # count is increased by 500ms for every 0.5s of sleep</span>
<a href="#l11.319"></a><span id="l11.319" class="difflineminus">-                            time.sleep(.5); count += 500</span>
<a href="#l11.320"></a><span id="l11.320" class="difflineminus">-                    except exceptions.OSError:</span>
<a href="#l11.321"></a><span id="l11.321" class="difflineminus">-                        return self.returncode</span>
<a href="#l11.322"></a><span id="l11.322" class="difflineminus">-                        </span>
<a href="#l11.323"></a><span id="l11.323" class="difflineminus">-            if timeout is None:</span>
<a href="#l11.324"></a><span id="l11.324" class="difflineminus">-                if group is True:</span>
<a href="#l11.325"></a><span id="l11.325" class="difflineminus">-                    return group_wait(timeout)</span>
<a href="#l11.326"></a><span id="l11.326" class="difflineminus">-                else:</span>
<a href="#l11.327"></a><span id="l11.327" class="difflineminus">-                    subprocess.Popen.wait(self)</span>
<a href="#l11.328"></a><span id="l11.328" class="difflineminus">-                    return self.returncode</span>
<a href="#l11.329"></a><span id="l11.329" class="difflineminus">-</span>
<a href="#l11.330"></a><span id="l11.330" class="difflineminus">-            returncode = False</span>
<a href="#l11.331"></a><span id="l11.331" class="difflineminus">-</span>
<a href="#l11.332"></a><span id="l11.332" class="difflineminus">-            now = datetime.datetime.now()</span>
<a href="#l11.333"></a><span id="l11.333" class="difflineminus">-            diff = now - starttime</span>
<a href="#l11.334"></a><span id="l11.334" class="difflineminus">-            while (diff.seconds * 1000 * 1000 + diff.microseconds) &lt; (timeout * 1000) and ( returncode is False ):</span>
<a href="#l11.335"></a><span id="l11.335" class="difflineminus">-                if group is True:</span>
<a href="#l11.336"></a><span id="l11.336" class="difflineminus">-                    return group_wait(timeout)</span>
<a href="#l11.337"></a><span id="l11.337" class="difflineminus">-                else:</span>
<a href="#l11.338"></a><span id="l11.338" class="difflineminus">-                    if subprocess.poll() is not None:</span>
<a href="#l11.339"></a><span id="l11.339" class="difflineminus">-                        returncode = self.returncode</span>
<a href="#l11.340"></a><span id="l11.340" class="difflineminus">-                time.sleep(.5)</span>
<a href="#l11.341"></a><span id="l11.341" class="difflineminus">-                now = datetime.datetime.now()</span>
<a href="#l11.342"></a><span id="l11.342" class="difflineminus">-                diff = now - starttime</span>
<a href="#l11.343"></a><span id="l11.343" class="difflineminus">-            return self.returncode</span>
<a href="#l11.344"></a><span id="l11.344" class="difflineminus">-                </span>
<a href="#l11.345"></a><span id="l11.345" class="difflineminus">-        return self.returncode</span>
<a href="#l11.346"></a><span id="l11.346" class="difflineminus">-    # We get random maxint errors from subprocesses __del__</span>
<a href="#l11.347"></a><span id="l11.347" class="difflineminus">-    __del__ = lambda self: None        </span>
<a href="#l11.348"></a><span id="l11.348" class="difflineminus">-        </span>
<a href="#l11.349"></a><span id="l11.349" class="difflineminus">-def setpgid_preexec_fn():</span>
<a href="#l11.350"></a><span id="l11.350" class="difflineminus">-    os.setpgid(0, 0)</span>
<a href="#l11.351"></a><span id="l11.351" class="difflineminus">-        </span>
<a href="#l11.352"></a><span id="l11.352" class="difflineminus">-def runCommand(cmd, **kwargs):</span>
<a href="#l11.353"></a><span id="l11.353" class="difflineminus">-    if sys.platform != &quot;win32&quot;:</span>
<a href="#l11.354"></a><span id="l11.354" class="difflineminus">-        return Popen(cmd, preexec_fn=setpgid_preexec_fn, **kwargs)</span>
<a href="#l11.355"></a><span id="l11.355" class="difflineminus">-    else:</span>
<a href="#l11.356"></a><span id="l11.356" class="difflineminus">-        return Popen(cmd, **kwargs)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1">deleted file mode 100644</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineminus">--- a/mail/test/resources/mozrunner/mozrunner/qijo.py</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineplus">+++ /dev/null</span>
<a href="#l12.4"></a><span id="l12.4" class="difflineat">@@ -1,162 +0,0 @@</span>
<a href="#l12.5"></a><span id="l12.5" class="difflineminus">-from ctypes import c_void_p, POINTER, sizeof, Structure, windll, WinError, WINFUNCTYPE, addressof, c_size_t, c_ulong</span>
<a href="#l12.6"></a><span id="l12.6" class="difflineminus">-from ctypes.wintypes import BOOL, BYTE, DWORD, HANDLE, LARGE_INTEGER</span>
<a href="#l12.7"></a><span id="l12.7" class="difflineminus">-</span>
<a href="#l12.8"></a><span id="l12.8" class="difflineminus">-LPVOID = c_void_p</span>
<a href="#l12.9"></a><span id="l12.9" class="difflineminus">-LPDWORD = POINTER(DWORD)</span>
<a href="#l12.10"></a><span id="l12.10" class="difflineminus">-SIZE_T = c_size_t</span>
<a href="#l12.11"></a><span id="l12.11" class="difflineminus">-ULONG_PTR = POINTER(c_ulong)</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineminus">-# A ULONGLONG is a 64-bit unsigned integer.</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineminus">-# Thus there are 8 bytes in a ULONGLONG.</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineminus">-# XXX why not import c_ulonglong ?</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineminus">-ULONGLONG = BYTE * 8</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineminus">-</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineminus">-class IO_COUNTERS(Structure):</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineminus">-    # The IO_COUNTERS struct is 6 ULONGLONGs.</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineminus">-    # TODO: Replace with non-dummy fields.</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineminus">-    _fields_ = [('dummy', ULONGLONG * 6)]</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineminus">-</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineminus">-class JOBOBJECT_BASIC_ACCOUNTING_INFORMATION(Structure):</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineminus">-    _fields_ = [('TotalUserTime', LARGE_INTEGER),</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineminus">-                ('TotalKernelTime', LARGE_INTEGER),</span>
<a href="#l12.26"></a><span id="l12.26" class="difflineminus">-                ('ThisPeriodTotalUserTime', LARGE_INTEGER),</span>
<a href="#l12.27"></a><span id="l12.27" class="difflineminus">-                ('ThisPeriodTotalKernelTime', LARGE_INTEGER),</span>
<a href="#l12.28"></a><span id="l12.28" class="difflineminus">-                ('TotalPageFaultCount', DWORD),</span>
<a href="#l12.29"></a><span id="l12.29" class="difflineminus">-                ('TotalProcesses', DWORD),</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineminus">-                ('ActiveProcesses', DWORD),</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineminus">-                ('TotalTerminatedProcesses', DWORD)]</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineminus">-</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineminus">-class JOBOBJECT_BASIC_AND_IO_ACCOUNTING_INFORMATION(Structure):</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineminus">-    _fields_ = [('BasicInfo', JOBOBJECT_BASIC_ACCOUNTING_INFORMATION),</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineminus">-                ('IoInfo', IO_COUNTERS)]</span>
<a href="#l12.36"></a><span id="l12.36" class="difflineminus">-</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineminus">-# see http://msdn.microsoft.com/en-us/library/ms684147%28VS.85%29.aspx</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineminus">-class JOBOBJECT_BASIC_LIMIT_INFORMATION(Structure):</span>
<a href="#l12.39"></a><span id="l12.39" class="difflineminus">-    _fields_ = [('PerProcessUserTimeLimit', LARGE_INTEGER),</span>
<a href="#l12.40"></a><span id="l12.40" class="difflineminus">-                ('PerJobUserTimeLimit', LARGE_INTEGER),</span>
<a href="#l12.41"></a><span id="l12.41" class="difflineminus">-                ('LimitFlags', DWORD),</span>
<a href="#l12.42"></a><span id="l12.42" class="difflineminus">-                ('MinimumWorkingSetSize', SIZE_T),</span>
<a href="#l12.43"></a><span id="l12.43" class="difflineminus">-                ('MaximumWorkingSetSize', SIZE_T),</span>
<a href="#l12.44"></a><span id="l12.44" class="difflineminus">-                ('ActiveProcessLimit', DWORD),</span>
<a href="#l12.45"></a><span id="l12.45" class="difflineminus">-                ('Affinity', ULONG_PTR),</span>
<a href="#l12.46"></a><span id="l12.46" class="difflineminus">-                ('PriorityClass', DWORD),</span>
<a href="#l12.47"></a><span id="l12.47" class="difflineminus">-                ('SchedulingClass', DWORD)</span>
<a href="#l12.48"></a><span id="l12.48" class="difflineminus">-                ]</span>
<a href="#l12.49"></a><span id="l12.49" class="difflineminus">-</span>
<a href="#l12.50"></a><span id="l12.50" class="difflineminus">-# see http://msdn.microsoft.com/en-us/library/ms684156%28VS.85%29.aspx</span>
<a href="#l12.51"></a><span id="l12.51" class="difflineminus">-class JOBOBJECT_EXTENDED_LIMIT_INFORMATION(Structure):</span>
<a href="#l12.52"></a><span id="l12.52" class="difflineminus">-    _fields_ = [('BasicLimitInformation', JOBOBJECT_BASIC_LIMIT_INFORMATION),</span>
<a href="#l12.53"></a><span id="l12.53" class="difflineminus">-                ('IoInfo', IO_COUNTERS),</span>
<a href="#l12.54"></a><span id="l12.54" class="difflineminus">-                ('ProcessMemoryLimit', SIZE_T),</span>
<a href="#l12.55"></a><span id="l12.55" class="difflineminus">-                ('JobMemoryLimit', SIZE_T),</span>
<a href="#l12.56"></a><span id="l12.56" class="difflineminus">-                ('PeakProcessMemoryUsed', SIZE_T),</span>
<a href="#l12.57"></a><span id="l12.57" class="difflineminus">-                ('PeakJobMemoryUsed', SIZE_T)]</span>
<a href="#l12.58"></a><span id="l12.58" class="difflineminus">-</span>
<a href="#l12.59"></a><span id="l12.59" class="difflineminus">-# XXX Magical numbers like 8 should be documented</span>
<a href="#l12.60"></a><span id="l12.60" class="difflineminus">-JobObjectBasicAndIoAccountingInformation = 8</span>
<a href="#l12.61"></a><span id="l12.61" class="difflineminus">-</span>
<a href="#l12.62"></a><span id="l12.62" class="difflineminus">-# ...like magical number 9 comes from</span>
<a href="#l12.63"></a><span id="l12.63" class="difflineminus">-# http://community.flexerasoftware.com/archive/index.php?t-181670.html</span>
<a href="#l12.64"></a><span id="l12.64" class="difflineminus">-# I wish I had a more canonical source</span>
<a href="#l12.65"></a><span id="l12.65" class="difflineminus">-JobObjectExtendedLimitInformation = 9</span>
<a href="#l12.66"></a><span id="l12.66" class="difflineminus">-</span>
<a href="#l12.67"></a><span id="l12.67" class="difflineminus">-class JobObjectInfo(object):</span>
<a href="#l12.68"></a><span id="l12.68" class="difflineminus">-    mapping = { 'JobObjectBasicAndIoAccountingInformation': 8,</span>
<a href="#l12.69"></a><span id="l12.69" class="difflineminus">-                'JobObjectExtendedLimitInformation': 9</span>
<a href="#l12.70"></a><span id="l12.70" class="difflineminus">-                }</span>
<a href="#l12.71"></a><span id="l12.71" class="difflineminus">-    structures = { 8: JOBOBJECT_BASIC_AND_IO_ACCOUNTING_INFORMATION,</span>
<a href="#l12.72"></a><span id="l12.72" class="difflineminus">-                   9: JOBOBJECT_EXTENDED_LIMIT_INFORMATION</span>
<a href="#l12.73"></a><span id="l12.73" class="difflineminus">-                   }</span>
<a href="#l12.74"></a><span id="l12.74" class="difflineminus">-    def __init__(self, _class):</span>
<a href="#l12.75"></a><span id="l12.75" class="difflineminus">-        if isinstance(_class, basestring):</span>
<a href="#l12.76"></a><span id="l12.76" class="difflineminus">-            assert _class in self.mapping, 'Class should be one of %s; you gave %s' % (self.mapping, _class)</span>
<a href="#l12.77"></a><span id="l12.77" class="difflineminus">-            _class = self.mapping[_class]</span>
<a href="#l12.78"></a><span id="l12.78" class="difflineminus">-        assert _class in self.structures, 'Class should be one of %s; you gave %s' % (self.structures, _class)</span>
<a href="#l12.79"></a><span id="l12.79" class="difflineminus">-        self.code = _class</span>
<a href="#l12.80"></a><span id="l12.80" class="difflineminus">-        self.info = self.structures[_class]()</span>
<a href="#l12.81"></a><span id="l12.81" class="difflineminus">-    </span>
<a href="#l12.82"></a><span id="l12.82" class="difflineminus">-</span>
<a href="#l12.83"></a><span id="l12.83" class="difflineminus">-QueryInformationJobObjectProto = WINFUNCTYPE(</span>
<a href="#l12.84"></a><span id="l12.84" class="difflineminus">-    BOOL,        # Return type</span>
<a href="#l12.85"></a><span id="l12.85" class="difflineminus">-    HANDLE,      # hJob</span>
<a href="#l12.86"></a><span id="l12.86" class="difflineminus">-    DWORD,       # JobObjectInfoClass</span>
<a href="#l12.87"></a><span id="l12.87" class="difflineminus">-    LPVOID,      # lpJobObjectInfo</span>
<a href="#l12.88"></a><span id="l12.88" class="difflineminus">-    DWORD,       # cbJobObjectInfoLength</span>
<a href="#l12.89"></a><span id="l12.89" class="difflineminus">-    LPDWORD      # lpReturnLength</span>
<a href="#l12.90"></a><span id="l12.90" class="difflineminus">-    )</span>
<a href="#l12.91"></a><span id="l12.91" class="difflineminus">-</span>
<a href="#l12.92"></a><span id="l12.92" class="difflineminus">-QueryInformationJobObjectFlags = (</span>
<a href="#l12.93"></a><span id="l12.93" class="difflineminus">-    (1, 'hJob'),</span>
<a href="#l12.94"></a><span id="l12.94" class="difflineminus">-    (1, 'JobObjectInfoClass'),</span>
<a href="#l12.95"></a><span id="l12.95" class="difflineminus">-    (1, 'lpJobObjectInfo'),</span>
<a href="#l12.96"></a><span id="l12.96" class="difflineminus">-    (1, 'cbJobObjectInfoLength'),</span>
<a href="#l12.97"></a><span id="l12.97" class="difflineminus">-    (1, 'lpReturnLength', None)</span>
<a href="#l12.98"></a><span id="l12.98" class="difflineminus">-    )</span>
<a href="#l12.99"></a><span id="l12.99" class="difflineminus">-</span>
<a href="#l12.100"></a><span id="l12.100" class="difflineminus">-_QueryInformationJobObject = QueryInformationJobObjectProto(</span>
<a href="#l12.101"></a><span id="l12.101" class="difflineminus">-    ('QueryInformationJobObject', windll.kernel32),</span>
<a href="#l12.102"></a><span id="l12.102" class="difflineminus">-    QueryInformationJobObjectFlags</span>
<a href="#l12.103"></a><span id="l12.103" class="difflineminus">-    )</span>
<a href="#l12.104"></a><span id="l12.104" class="difflineminus">-</span>
<a href="#l12.105"></a><span id="l12.105" class="difflineminus">-class SubscriptableReadOnlyStruct(object):</span>
<a href="#l12.106"></a><span id="l12.106" class="difflineminus">-    def __init__(self, struct):</span>
<a href="#l12.107"></a><span id="l12.107" class="difflineminus">-        self._struct = struct</span>
<a href="#l12.108"></a><span id="l12.108" class="difflineminus">-</span>
<a href="#l12.109"></a><span id="l12.109" class="difflineminus">-    def _delegate(self, name):</span>
<a href="#l12.110"></a><span id="l12.110" class="difflineminus">-        result = getattr(self._struct, name)</span>
<a href="#l12.111"></a><span id="l12.111" class="difflineminus">-        if isinstance(result, Structure):</span>
<a href="#l12.112"></a><span id="l12.112" class="difflineminus">-            return SubscriptableReadOnlyStruct(result)</span>
<a href="#l12.113"></a><span id="l12.113" class="difflineminus">-        return result</span>
<a href="#l12.114"></a><span id="l12.114" class="difflineminus">-</span>
<a href="#l12.115"></a><span id="l12.115" class="difflineminus">-    def __getitem__(self, name):</span>
<a href="#l12.116"></a><span id="l12.116" class="difflineminus">-        match = [fname for fname, ftype in self._struct._fields_</span>
<a href="#l12.117"></a><span id="l12.117" class="difflineminus">-                 if fname == name]</span>
<a href="#l12.118"></a><span id="l12.118" class="difflineminus">-        if match:</span>
<a href="#l12.119"></a><span id="l12.119" class="difflineminus">-            return self._delegate(name)</span>
<a href="#l12.120"></a><span id="l12.120" class="difflineminus">-        raise KeyError(name)</span>
<a href="#l12.121"></a><span id="l12.121" class="difflineminus">-</span>
<a href="#l12.122"></a><span id="l12.122" class="difflineminus">-    def __getattr__(self, name):</span>
<a href="#l12.123"></a><span id="l12.123" class="difflineminus">-        return self._delegate(name)</span>
<a href="#l12.124"></a><span id="l12.124" class="difflineminus">-</span>
<a href="#l12.125"></a><span id="l12.125" class="difflineminus">-def QueryInformationJobObject(hJob, JobObjectInfoClass):</span>
<a href="#l12.126"></a><span id="l12.126" class="difflineminus">-    jobinfo = JobObjectInfo(JobObjectInfoClass)</span>
<a href="#l12.127"></a><span id="l12.127" class="difflineminus">-    result = _QueryInformationJobObject(</span>
<a href="#l12.128"></a><span id="l12.128" class="difflineminus">-        hJob=hJob,</span>
<a href="#l12.129"></a><span id="l12.129" class="difflineminus">-        JobObjectInfoClass=jobinfo.code,</span>
<a href="#l12.130"></a><span id="l12.130" class="difflineminus">-        lpJobObjectInfo=addressof(jobinfo.info),</span>
<a href="#l12.131"></a><span id="l12.131" class="difflineminus">-        cbJobObjectInfoLength=sizeof(jobinfo.info)</span>
<a href="#l12.132"></a><span id="l12.132" class="difflineminus">-        )</span>
<a href="#l12.133"></a><span id="l12.133" class="difflineminus">-    if not result:</span>
<a href="#l12.134"></a><span id="l12.134" class="difflineminus">-        raise WinError()</span>
<a href="#l12.135"></a><span id="l12.135" class="difflineminus">-    return SubscriptableReadOnlyStruct(jobinfo.info)</span>
<a href="#l12.136"></a><span id="l12.136" class="difflineminus">-</span>
<a href="#l12.137"></a><span id="l12.137" class="difflineminus">-def test_qijo():</span>
<a href="#l12.138"></a><span id="l12.138" class="difflineminus">-    from killableprocess import Popen</span>
<a href="#l12.139"></a><span id="l12.139" class="difflineminus">-</span>
<a href="#l12.140"></a><span id="l12.140" class="difflineminus">-    popen = Popen('c:\\windows\\notepad.exe')</span>
<a href="#l12.141"></a><span id="l12.141" class="difflineminus">-</span>
<a href="#l12.142"></a><span id="l12.142" class="difflineminus">-    try:</span>
<a href="#l12.143"></a><span id="l12.143" class="difflineminus">-        result = QueryInformationJobObject(0, 8)</span>
<a href="#l12.144"></a><span id="l12.144" class="difflineminus">-        raise AssertionError('throw should occur')</span>
<a href="#l12.145"></a><span id="l12.145" class="difflineminus">-    except WindowsError, e:</span>
<a href="#l12.146"></a><span id="l12.146" class="difflineminus">-        pass</span>
<a href="#l12.147"></a><span id="l12.147" class="difflineminus">-</span>
<a href="#l12.148"></a><span id="l12.148" class="difflineminus">-    try:</span>
<a href="#l12.149"></a><span id="l12.149" class="difflineminus">-        result = QueryInformationJobObject(0, 1)</span>
<a href="#l12.150"></a><span id="l12.150" class="difflineminus">-        raise AssertionError('throw should occur')</span>
<a href="#l12.151"></a><span id="l12.151" class="difflineminus">-    except NotImplementedError, e:</span>
<a href="#l12.152"></a><span id="l12.152" class="difflineminus">-        pass</span>
<a href="#l12.153"></a><span id="l12.153" class="difflineminus">-</span>
<a href="#l12.154"></a><span id="l12.154" class="difflineminus">-    result = QueryInformationJobObject(popen._job, 8)</span>
<a href="#l12.155"></a><span id="l12.155" class="difflineminus">-    if result['BasicInfo']['ActiveProcesses'] != 1:</span>
<a href="#l12.156"></a><span id="l12.156" class="difflineminus">-        raise AssertionError('expected ActiveProcesses to be 1')</span>
<a href="#l12.157"></a><span id="l12.157" class="difflineminus">-    popen.kill()</span>
<a href="#l12.158"></a><span id="l12.158" class="difflineminus">-</span>
<a href="#l12.159"></a><span id="l12.159" class="difflineminus">-    result = QueryInformationJobObject(popen._job, 8)</span>
<a href="#l12.160"></a><span id="l12.160" class="difflineminus">-    if result.BasicInfo.ActiveProcesses != 0:</span>
<a href="#l12.161"></a><span id="l12.161" class="difflineminus">-        raise AssertionError('expected ActiveProcesses to be 0')</span>
<a href="#l12.162"></a><span id="l12.162" class="difflineminus">-</span>
<a href="#l12.163"></a><span id="l12.163" class="difflineminus">-if __name__ == '__main__':</span>
<a href="#l12.164"></a><span id="l12.164" class="difflineminus">-    print &quot;testing.&quot;</span>
<a href="#l12.165"></a><span id="l12.165" class="difflineminus">-    test_qijo()</span>
<a href="#l12.166"></a><span id="l12.166" class="difflineminus">-    print &quot;success!&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1">deleted file mode 100644</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineminus">--- a/mail/test/resources/mozrunner/mozrunner/winprocess.py</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineplus">+++ /dev/null</span>
<a href="#l13.4"></a><span id="l13.4" class="difflineat">@@ -1,403 +0,0 @@</span>
<a href="#l13.5"></a><span id="l13.5" class="difflineminus">-# A module to expose various thread/process/job related structures and</span>
<a href="#l13.6"></a><span id="l13.6" class="difflineminus">-# methods from kernel32</span>
<a href="#l13.7"></a><span id="l13.7" class="difflineminus">-#</span>
<a href="#l13.8"></a><span id="l13.8" class="difflineminus">-# The MIT License</span>
<a href="#l13.9"></a><span id="l13.9" class="difflineminus">-#</span>
<a href="#l13.10"></a><span id="l13.10" class="difflineminus">-# Copyright (c) 2003-2004 by Peter Astrand &lt;astrand@lysator.liu.se&gt;</span>
<a href="#l13.11"></a><span id="l13.11" class="difflineminus">-#</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-# Additions and modifications written by Benjamin Smedberg</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineminus">-# &lt;benjamin@smedbergs.us&gt; are Copyright (c) 2006 by the Mozilla Foundation</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineminus">-# &lt;http://www.mozilla.org/&gt;</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineminus">-#</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineminus">-# More Modifications</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineminus">-# Copyright (c) 2006-2007 by Mike Taylor &lt;bear@code-bear.com&gt;</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineminus">-# Copyright (c) 2007-2008 by Mikeal Rogers &lt;mikeal@mozilla.com&gt;</span>
<a href="#l13.19"></a><span id="l13.19" class="difflineminus">-#</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineminus">-# By obtaining, using, and/or copying this software and/or its</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineminus">-# associated documentation, you agree that you have read, understood,</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineminus">-# and will comply with the following terms and conditions:</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineminus">-#</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineminus">-# Permission to use, copy, modify, and distribute this software and</span>
<a href="#l13.25"></a><span id="l13.25" class="difflineminus">-# its associated documentation for any purpose and without fee is</span>
<a href="#l13.26"></a><span id="l13.26" class="difflineminus">-# hereby granted, provided that the above copyright notice appears in</span>
<a href="#l13.27"></a><span id="l13.27" class="difflineminus">-# all copies, and that both that copyright notice and this permission</span>
<a href="#l13.28"></a><span id="l13.28" class="difflineminus">-# notice appear in supporting documentation, and that the name of the</span>
<a href="#l13.29"></a><span id="l13.29" class="difflineminus">-# author not be used in advertising or publicity pertaining to</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineminus">-# distribution of the software without specific, written prior</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineminus">-# permission.</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineminus">-#</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineminus">-# THE AUTHOR DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE,</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineminus">-# INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS.</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineminus">-# IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, INDIRECT OR</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineminus">-# CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineminus">-# OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT,</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineminus">-# NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineminus">-# WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.</span>
<a href="#l13.40"></a><span id="l13.40" class="difflineminus">-</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineminus">-from ctypes import c_void_p, POINTER, sizeof, Structure, windll, WinError, WINFUNCTYPE</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineminus">-from ctypes.wintypes import BOOL, BYTE, DWORD, HANDLE, LPCWSTR, LPWSTR, UINT, WORD</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineminus">-from qijo import QueryInformationJobObject</span>
<a href="#l13.44"></a><span id="l13.44" class="difflineminus">-</span>
<a href="#l13.45"></a><span id="l13.45" class="difflineminus">-# Because we do not want to depend on pywin32, we cannot get win32con which </span>
<a href="#l13.46"></a><span id="l13.46" class="difflineminus">-# contains this nifty little constant.  The constant has had the magic value</span>
<a href="#l13.47"></a><span id="l13.47" class="difflineminus">-# of 259 for a long time (since win2k as far as I can tell).</span>
<a href="#l13.48"></a><span id="l13.48" class="difflineminus">-STILL_ACTIVE = 259</span>
<a href="#l13.49"></a><span id="l13.49" class="difflineminus">-</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineminus">-LPVOID = c_void_p</span>
<a href="#l13.51"></a><span id="l13.51" class="difflineminus">-LPBYTE = POINTER(BYTE)</span>
<a href="#l13.52"></a><span id="l13.52" class="difflineminus">-LPDWORD = POINTER(DWORD)</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineminus">-LPBOOL = POINTER(BOOL)</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineminus">-</span>
<a href="#l13.55"></a><span id="l13.55" class="difflineminus">-def ErrCheckBool(result, func, args):</span>
<a href="#l13.56"></a><span id="l13.56" class="difflineminus">-    &quot;&quot;&quot;errcheck function for Windows functions that return a BOOL True</span>
<a href="#l13.57"></a><span id="l13.57" class="difflineminus">-    on success&quot;&quot;&quot;</span>
<a href="#l13.58"></a><span id="l13.58" class="difflineminus">-    if not result:</span>
<a href="#l13.59"></a><span id="l13.59" class="difflineminus">-        raise WinError()</span>
<a href="#l13.60"></a><span id="l13.60" class="difflineminus">-    return args</span>
<a href="#l13.61"></a><span id="l13.61" class="difflineminus">-</span>
<a href="#l13.62"></a><span id="l13.62" class="difflineminus">-</span>
<a href="#l13.63"></a><span id="l13.63" class="difflineminus">-# AutoHANDLE</span>
<a href="#l13.64"></a><span id="l13.64" class="difflineminus">-</span>
<a href="#l13.65"></a><span id="l13.65" class="difflineminus">-class AutoHANDLE(HANDLE):</span>
<a href="#l13.66"></a><span id="l13.66" class="difflineminus">-    &quot;&quot;&quot;Subclass of HANDLE which will call CloseHandle() on deletion.&quot;&quot;&quot;</span>
<a href="#l13.67"></a><span id="l13.67" class="difflineminus">-    </span>
<a href="#l13.68"></a><span id="l13.68" class="difflineminus">-    CloseHandleProto = WINFUNCTYPE(BOOL, HANDLE)</span>
<a href="#l13.69"></a><span id="l13.69" class="difflineminus">-    CloseHandle = CloseHandleProto((&quot;CloseHandle&quot;, windll.kernel32))</span>
<a href="#l13.70"></a><span id="l13.70" class="difflineminus">-    CloseHandle.errcheck = ErrCheckBool</span>
<a href="#l13.71"></a><span id="l13.71" class="difflineminus">-    </span>
<a href="#l13.72"></a><span id="l13.72" class="difflineminus">-    def Close(self):</span>
<a href="#l13.73"></a><span id="l13.73" class="difflineminus">-        if self.value and self.value != HANDLE(-1).value:</span>
<a href="#l13.74"></a><span id="l13.74" class="difflineminus">-            self.CloseHandle(self)</span>
<a href="#l13.75"></a><span id="l13.75" class="difflineminus">-            self.value = 0</span>
<a href="#l13.76"></a><span id="l13.76" class="difflineminus">-    </span>
<a href="#l13.77"></a><span id="l13.77" class="difflineminus">-    def __del__(self):</span>
<a href="#l13.78"></a><span id="l13.78" class="difflineminus">-        self.Close()</span>
<a href="#l13.79"></a><span id="l13.79" class="difflineminus">-</span>
<a href="#l13.80"></a><span id="l13.80" class="difflineminus">-    def __int__(self):</span>
<a href="#l13.81"></a><span id="l13.81" class="difflineminus">-        return self.value</span>
<a href="#l13.82"></a><span id="l13.82" class="difflineminus">-</span>
<a href="#l13.83"></a><span id="l13.83" class="difflineminus">-def ErrCheckHandle(result, func, args):</span>
<a href="#l13.84"></a><span id="l13.84" class="difflineminus">-    &quot;&quot;&quot;errcheck function for Windows functions that return a HANDLE.&quot;&quot;&quot;</span>
<a href="#l13.85"></a><span id="l13.85" class="difflineminus">-    if not result:</span>
<a href="#l13.86"></a><span id="l13.86" class="difflineminus">-        raise WinError()</span>
<a href="#l13.87"></a><span id="l13.87" class="difflineminus">-    return AutoHANDLE(result)</span>
<a href="#l13.88"></a><span id="l13.88" class="difflineminus">-</span>
<a href="#l13.89"></a><span id="l13.89" class="difflineminus">-# PROCESS_INFORMATION structure</span>
<a href="#l13.90"></a><span id="l13.90" class="difflineminus">-</span>
<a href="#l13.91"></a><span id="l13.91" class="difflineminus">-class PROCESS_INFORMATION(Structure):</span>
<a href="#l13.92"></a><span id="l13.92" class="difflineminus">-    _fields_ = [(&quot;hProcess&quot;, HANDLE),</span>
<a href="#l13.93"></a><span id="l13.93" class="difflineminus">-                (&quot;hThread&quot;, HANDLE),</span>
<a href="#l13.94"></a><span id="l13.94" class="difflineminus">-                (&quot;dwProcessID&quot;, DWORD),</span>
<a href="#l13.95"></a><span id="l13.95" class="difflineminus">-                (&quot;dwThreadID&quot;, DWORD)]</span>
<a href="#l13.96"></a><span id="l13.96" class="difflineminus">-</span>
<a href="#l13.97"></a><span id="l13.97" class="difflineminus">-    def __init__(self):</span>
<a href="#l13.98"></a><span id="l13.98" class="difflineminus">-        Structure.__init__(self)</span>
<a href="#l13.99"></a><span id="l13.99" class="difflineminus">-        </span>
<a href="#l13.100"></a><span id="l13.100" class="difflineminus">-        self.cb = sizeof(self)</span>
<a href="#l13.101"></a><span id="l13.101" class="difflineminus">-</span>
<a href="#l13.102"></a><span id="l13.102" class="difflineminus">-LPPROCESS_INFORMATION = POINTER(PROCESS_INFORMATION)</span>
<a href="#l13.103"></a><span id="l13.103" class="difflineminus">-</span>
<a href="#l13.104"></a><span id="l13.104" class="difflineminus">-# STARTUPINFO structure</span>
<a href="#l13.105"></a><span id="l13.105" class="difflineminus">-</span>
<a href="#l13.106"></a><span id="l13.106" class="difflineminus">-class STARTUPINFO(Structure):</span>
<a href="#l13.107"></a><span id="l13.107" class="difflineminus">-    _fields_ = [(&quot;cb&quot;, DWORD),</span>
<a href="#l13.108"></a><span id="l13.108" class="difflineminus">-                (&quot;lpReserved&quot;, LPWSTR),</span>
<a href="#l13.109"></a><span id="l13.109" class="difflineminus">-                (&quot;lpDesktop&quot;, LPWSTR),</span>
<a href="#l13.110"></a><span id="l13.110" class="difflineminus">-                (&quot;lpTitle&quot;, LPWSTR),</span>
<a href="#l13.111"></a><span id="l13.111" class="difflineminus">-                (&quot;dwX&quot;, DWORD),</span>
<a href="#l13.112"></a><span id="l13.112" class="difflineminus">-                (&quot;dwY&quot;, DWORD),</span>
<a href="#l13.113"></a><span id="l13.113" class="difflineminus">-                (&quot;dwXSize&quot;, DWORD),</span>
<a href="#l13.114"></a><span id="l13.114" class="difflineminus">-                (&quot;dwYSize&quot;, DWORD),</span>
<a href="#l13.115"></a><span id="l13.115" class="difflineminus">-                (&quot;dwXCountChars&quot;, DWORD),</span>
<a href="#l13.116"></a><span id="l13.116" class="difflineminus">-                (&quot;dwYCountChars&quot;, DWORD),</span>
<a href="#l13.117"></a><span id="l13.117" class="difflineminus">-                (&quot;dwFillAttribute&quot;, DWORD),</span>
<a href="#l13.118"></a><span id="l13.118" class="difflineminus">-                (&quot;dwFlags&quot;, DWORD),</span>
<a href="#l13.119"></a><span id="l13.119" class="difflineminus">-                (&quot;wShowWindow&quot;, WORD),</span>
<a href="#l13.120"></a><span id="l13.120" class="difflineminus">-                (&quot;cbReserved2&quot;, WORD),</span>
<a href="#l13.121"></a><span id="l13.121" class="difflineminus">-                (&quot;lpReserved2&quot;, LPBYTE),</span>
<a href="#l13.122"></a><span id="l13.122" class="difflineminus">-                (&quot;hStdInput&quot;, HANDLE),</span>
<a href="#l13.123"></a><span id="l13.123" class="difflineminus">-                (&quot;hStdOutput&quot;, HANDLE),</span>
<a href="#l13.124"></a><span id="l13.124" class="difflineminus">-                (&quot;hStdError&quot;, HANDLE)</span>
<a href="#l13.125"></a><span id="l13.125" class="difflineminus">-                ]</span>
<a href="#l13.126"></a><span id="l13.126" class="difflineminus">-LPSTARTUPINFO = POINTER(STARTUPINFO)</span>
<a href="#l13.127"></a><span id="l13.127" class="difflineminus">-</span>
<a href="#l13.128"></a><span id="l13.128" class="difflineminus">-SW_HIDE                 = 0</span>
<a href="#l13.129"></a><span id="l13.129" class="difflineminus">-</span>
<a href="#l13.130"></a><span id="l13.130" class="difflineminus">-STARTF_USESHOWWINDOW    = 0x01</span>
<a href="#l13.131"></a><span id="l13.131" class="difflineminus">-STARTF_USESIZE          = 0x02</span>
<a href="#l13.132"></a><span id="l13.132" class="difflineminus">-STARTF_USEPOSITION      = 0x04</span>
<a href="#l13.133"></a><span id="l13.133" class="difflineminus">-STARTF_USECOUNTCHARS    = 0x08</span>
<a href="#l13.134"></a><span id="l13.134" class="difflineminus">-STARTF_USEFILLATTRIBUTE = 0x10</span>
<a href="#l13.135"></a><span id="l13.135" class="difflineminus">-STARTF_RUNFULLSCREEN    = 0x20</span>
<a href="#l13.136"></a><span id="l13.136" class="difflineminus">-STARTF_FORCEONFEEDBACK  = 0x40</span>
<a href="#l13.137"></a><span id="l13.137" class="difflineminus">-STARTF_FORCEOFFFEEDBACK = 0x80</span>
<a href="#l13.138"></a><span id="l13.138" class="difflineminus">-STARTF_USESTDHANDLES    = 0x100</span>
<a href="#l13.139"></a><span id="l13.139" class="difflineminus">-</span>
<a href="#l13.140"></a><span id="l13.140" class="difflineminus">-# EnvironmentBlock</span>
<a href="#l13.141"></a><span id="l13.141" class="difflineminus">-</span>
<a href="#l13.142"></a><span id="l13.142" class="difflineminus">-class EnvironmentBlock:</span>
<a href="#l13.143"></a><span id="l13.143" class="difflineminus">-    &quot;&quot;&quot;An object which can be passed as the lpEnv parameter of CreateProcess.</span>
<a href="#l13.144"></a><span id="l13.144" class="difflineminus">-    It is initialized with a dictionary.&quot;&quot;&quot;</span>
<a href="#l13.145"></a><span id="l13.145" class="difflineminus">-</span>
<a href="#l13.146"></a><span id="l13.146" class="difflineminus">-    def __init__(self, dict):</span>
<a href="#l13.147"></a><span id="l13.147" class="difflineminus">-        if not dict:</span>
<a href="#l13.148"></a><span id="l13.148" class="difflineminus">-            self._as_parameter_ = None</span>
<a href="#l13.149"></a><span id="l13.149" class="difflineminus">-        else:</span>
<a href="#l13.150"></a><span id="l13.150" class="difflineminus">-            values = [&quot;%s=%s&quot; % (key, value)</span>
<a href="#l13.151"></a><span id="l13.151" class="difflineminus">-                      for (key, value) in dict.iteritems()]</span>
<a href="#l13.152"></a><span id="l13.152" class="difflineminus">-            values.append(&quot;&quot;)</span>
<a href="#l13.153"></a><span id="l13.153" class="difflineminus">-            self._as_parameter_ = LPCWSTR(&quot;\0&quot;.join(values))</span>
<a href="#l13.154"></a><span id="l13.154" class="difflineminus">-        </span>
<a href="#l13.155"></a><span id="l13.155" class="difflineminus">-# CreateProcess()</span>
<a href="#l13.156"></a><span id="l13.156" class="difflineminus">-</span>
<a href="#l13.157"></a><span id="l13.157" class="difflineminus">-CreateProcessProto = WINFUNCTYPE(BOOL,                  # Return type</span>
<a href="#l13.158"></a><span id="l13.158" class="difflineminus">-                                 LPCWSTR,               # lpApplicationName</span>
<a href="#l13.159"></a><span id="l13.159" class="difflineminus">-                                 LPWSTR,                # lpCommandLine</span>
<a href="#l13.160"></a><span id="l13.160" class="difflineminus">-                                 LPVOID,                # lpProcessAttributes</span>
<a href="#l13.161"></a><span id="l13.161" class="difflineminus">-                                 LPVOID,                # lpThreadAttributes</span>
<a href="#l13.162"></a><span id="l13.162" class="difflineminus">-                                 BOOL,                  # bInheritHandles</span>
<a href="#l13.163"></a><span id="l13.163" class="difflineminus">-                                 DWORD,                 # dwCreationFlags</span>
<a href="#l13.164"></a><span id="l13.164" class="difflineminus">-                                 LPVOID,                # lpEnvironment</span>
<a href="#l13.165"></a><span id="l13.165" class="difflineminus">-                                 LPCWSTR,               # lpCurrentDirectory</span>
<a href="#l13.166"></a><span id="l13.166" class="difflineminus">-                                 LPSTARTUPINFO,         # lpStartupInfo</span>
<a href="#l13.167"></a><span id="l13.167" class="difflineminus">-                                 LPPROCESS_INFORMATION  # lpProcessInformation</span>
<a href="#l13.168"></a><span id="l13.168" class="difflineminus">-                                 )</span>
<a href="#l13.169"></a><span id="l13.169" class="difflineminus">-</span>
<a href="#l13.170"></a><span id="l13.170" class="difflineminus">-CreateProcessFlags = ((1, &quot;lpApplicationName&quot;, None),</span>
<a href="#l13.171"></a><span id="l13.171" class="difflineminus">-                      (1, &quot;lpCommandLine&quot;),</span>
<a href="#l13.172"></a><span id="l13.172" class="difflineminus">-                      (1, &quot;lpProcessAttributes&quot;, None),</span>
<a href="#l13.173"></a><span id="l13.173" class="difflineminus">-                      (1, &quot;lpThreadAttributes&quot;, None),</span>
<a href="#l13.174"></a><span id="l13.174" class="difflineminus">-                      (1, &quot;bInheritHandles&quot;, True),</span>
<a href="#l13.175"></a><span id="l13.175" class="difflineminus">-                      (1, &quot;dwCreationFlags&quot;, 0),</span>
<a href="#l13.176"></a><span id="l13.176" class="difflineminus">-                      (1, &quot;lpEnvironment&quot;, None),</span>
<a href="#l13.177"></a><span id="l13.177" class="difflineminus">-                      (1, &quot;lpCurrentDirectory&quot;, None),</span>
<a href="#l13.178"></a><span id="l13.178" class="difflineminus">-                      (1, &quot;lpStartupInfo&quot;),</span>
<a href="#l13.179"></a><span id="l13.179" class="difflineminus">-                      (2, &quot;lpProcessInformation&quot;))</span>
<a href="#l13.180"></a><span id="l13.180" class="difflineminus">-</span>
<a href="#l13.181"></a><span id="l13.181" class="difflineminus">-def ErrCheckCreateProcess(result, func, args):</span>
<a href="#l13.182"></a><span id="l13.182" class="difflineminus">-    ErrCheckBool(result, func, args)</span>
<a href="#l13.183"></a><span id="l13.183" class="difflineminus">-    # return a tuple (hProcess, hThread, dwProcessID, dwThreadID)</span>
<a href="#l13.184"></a><span id="l13.184" class="difflineminus">-    pi = args[9]</span>
<a href="#l13.185"></a><span id="l13.185" class="difflineminus">-    return AutoHANDLE(pi.hProcess), AutoHANDLE(pi.hThread), pi.dwProcessID, pi.dwThreadID</span>
<a href="#l13.186"></a><span id="l13.186" class="difflineminus">-</span>
<a href="#l13.187"></a><span id="l13.187" class="difflineminus">-CreateProcess = CreateProcessProto((&quot;CreateProcessW&quot;, windll.kernel32),</span>
<a href="#l13.188"></a><span id="l13.188" class="difflineminus">-                                   CreateProcessFlags)</span>
<a href="#l13.189"></a><span id="l13.189" class="difflineminus">-CreateProcess.errcheck = ErrCheckCreateProcess</span>
<a href="#l13.190"></a><span id="l13.190" class="difflineminus">-</span>
<a href="#l13.191"></a><span id="l13.191" class="difflineminus">-# flags for CreateProcess</span>
<a href="#l13.192"></a><span id="l13.192" class="difflineminus">-CREATE_BREAKAWAY_FROM_JOB = 0x01000000</span>
<a href="#l13.193"></a><span id="l13.193" class="difflineminus">-CREATE_DEFAULT_ERROR_MODE = 0x04000000</span>
<a href="#l13.194"></a><span id="l13.194" class="difflineminus">-CREATE_NEW_CONSOLE = 0x00000010</span>
<a href="#l13.195"></a><span id="l13.195" class="difflineminus">-CREATE_NEW_PROCESS_GROUP = 0x00000200</span>
<a href="#l13.196"></a><span id="l13.196" class="difflineminus">-CREATE_NO_WINDOW = 0x08000000</span>
<a href="#l13.197"></a><span id="l13.197" class="difflineminus">-CREATE_SUSPENDED = 0x00000004</span>
<a href="#l13.198"></a><span id="l13.198" class="difflineminus">-CREATE_UNICODE_ENVIRONMENT = 0x00000400</span>
<a href="#l13.199"></a><span id="l13.199" class="difflineminus">-</span>
<a href="#l13.200"></a><span id="l13.200" class="difflineminus">-# flags for job limit information</span>
<a href="#l13.201"></a><span id="l13.201" class="difflineminus">-# see http://msdn.microsoft.com/en-us/library/ms684147%28VS.85%29.aspx</span>
<a href="#l13.202"></a><span id="l13.202" class="difflineminus">-JOB_OBJECT_LIMIT_BREAKAWAY_OK = 0x00000800</span>
<a href="#l13.203"></a><span id="l13.203" class="difflineminus">-JOB_OBJECT_LIMIT_SILENT_BREAKAWAY_OK = 0x00001000</span>
<a href="#l13.204"></a><span id="l13.204" class="difflineminus">-</span>
<a href="#l13.205"></a><span id="l13.205" class="difflineminus">-# XXX these flags should be documented</span>
<a href="#l13.206"></a><span id="l13.206" class="difflineminus">-DEBUG_ONLY_THIS_PROCESS = 0x00000002</span>
<a href="#l13.207"></a><span id="l13.207" class="difflineminus">-DEBUG_PROCESS = 0x00000001</span>
<a href="#l13.208"></a><span id="l13.208" class="difflineminus">-DETACHED_PROCESS = 0x00000008</span>
<a href="#l13.209"></a><span id="l13.209" class="difflineminus">-</span>
<a href="#l13.210"></a><span id="l13.210" class="difflineminus">-# SetInformationJobObject</span>
<a href="#l13.211"></a><span id="l13.211" class="difflineminus">-SetInformationJobObjectProto = WINFUNCTYPE(BOOL, # Return Type</span>
<a href="#l13.212"></a><span id="l13.212" class="difflineminus">-                                           HANDLE, # Job Handle</span>
<a href="#l13.213"></a><span id="l13.213" class="difflineminus">-                                           DWORD, # Type of Class next param is</span>
<a href="#l13.214"></a><span id="l13.214" class="difflineminus">-                                           LPVOID, # Job Object Class</span>
<a href="#l13.215"></a><span id="l13.215" class="difflineminus">-                                           DWORD # Job Object Class Length</span>
<a href="#l13.216"></a><span id="l13.216" class="difflineminus">-                                          )</span>
<a href="#l13.217"></a><span id="l13.217" class="difflineminus">-SetInformationJobObjectProtoFlags = ((1, &quot;hJob&quot;, None),</span>
<a href="#l13.218"></a><span id="l13.218" class="difflineminus">-                                     (1, &quot;JobObjectInfoClass&quot;, None),</span>
<a href="#l13.219"></a><span id="l13.219" class="difflineminus">-                                     (1, &quot;lpJobObjectInfo&quot;, None),</span>
<a href="#l13.220"></a><span id="l13.220" class="difflineminus">-                                     (1, &quot;cbJobObjectInfoLength&quot;, 0))</span>
<a href="#l13.221"></a><span id="l13.221" class="difflineminus">-SetInformationJobObject = SetInformationJobObjectProto((&quot;SetInformationJobObject&quot;,</span>
<a href="#l13.222"></a><span id="l13.222" class="difflineminus">-                                                        windll.kernel32),</span>
<a href="#l13.223"></a><span id="l13.223" class="difflineminus">-                                                        SetInformationJobObjectProtoFlags)</span>
<a href="#l13.224"></a><span id="l13.224" class="difflineminus">-SetInformationJobObject.errcheck = ErrCheckBool</span>
<a href="#l13.225"></a><span id="l13.225" class="difflineminus">-</span>
<a href="#l13.226"></a><span id="l13.226" class="difflineminus">-# CreateJobObject()</span>
<a href="#l13.227"></a><span id="l13.227" class="difflineminus">-</span>
<a href="#l13.228"></a><span id="l13.228" class="difflineminus">-CreateJobObjectProto = WINFUNCTYPE(HANDLE,             # Return type</span>
<a href="#l13.229"></a><span id="l13.229" class="difflineminus">-                                   LPVOID,             # lpJobAttributes</span>
<a href="#l13.230"></a><span id="l13.230" class="difflineminus">-                                   LPCWSTR             # lpName</span>
<a href="#l13.231"></a><span id="l13.231" class="difflineminus">-                                   )</span>
<a href="#l13.232"></a><span id="l13.232" class="difflineminus">-</span>
<a href="#l13.233"></a><span id="l13.233" class="difflineminus">-CreateJobObjectFlags = ((1, &quot;lpJobAttributes&quot;, None),</span>
<a href="#l13.234"></a><span id="l13.234" class="difflineminus">-                        (1, &quot;lpName&quot;, None))</span>
<a href="#l13.235"></a><span id="l13.235" class="difflineminus">-</span>
<a href="#l13.236"></a><span id="l13.236" class="difflineminus">-CreateJobObject = CreateJobObjectProto((&quot;CreateJobObjectW&quot;, windll.kernel32),</span>
<a href="#l13.237"></a><span id="l13.237" class="difflineminus">-                                       CreateJobObjectFlags)</span>
<a href="#l13.238"></a><span id="l13.238" class="difflineminus">-CreateJobObject.errcheck = ErrCheckHandle</span>
<a href="#l13.239"></a><span id="l13.239" class="difflineminus">-</span>
<a href="#l13.240"></a><span id="l13.240" class="difflineminus">-# AssignProcessToJobObject()</span>
<a href="#l13.241"></a><span id="l13.241" class="difflineminus">-</span>
<a href="#l13.242"></a><span id="l13.242" class="difflineminus">-AssignProcessToJobObjectProto = WINFUNCTYPE(BOOL,      # Return type</span>
<a href="#l13.243"></a><span id="l13.243" class="difflineminus">-                                            HANDLE,    # hJob</span>
<a href="#l13.244"></a><span id="l13.244" class="difflineminus">-                                            HANDLE     # hProcess</span>
<a href="#l13.245"></a><span id="l13.245" class="difflineminus">-                                            )</span>
<a href="#l13.246"></a><span id="l13.246" class="difflineminus">-AssignProcessToJobObjectFlags = ((1, &quot;hJob&quot;),</span>
<a href="#l13.247"></a><span id="l13.247" class="difflineminus">-                                 (1, &quot;hProcess&quot;))</span>
<a href="#l13.248"></a><span id="l13.248" class="difflineminus">-AssignProcessToJobObject = AssignProcessToJobObjectProto(</span>
<a href="#l13.249"></a><span id="l13.249" class="difflineminus">-    (&quot;AssignProcessToJobObject&quot;, windll.kernel32),</span>
<a href="#l13.250"></a><span id="l13.250" class="difflineminus">-    AssignProcessToJobObjectFlags)</span>
<a href="#l13.251"></a><span id="l13.251" class="difflineminus">-AssignProcessToJobObject.errcheck = ErrCheckBool</span>
<a href="#l13.252"></a><span id="l13.252" class="difflineminus">-</span>
<a href="#l13.253"></a><span id="l13.253" class="difflineminus">-# GetCurrentProcess()</span>
<a href="#l13.254"></a><span id="l13.254" class="difflineminus">-# because os.getPid() is way too easy</span>
<a href="#l13.255"></a><span id="l13.255" class="difflineminus">-GetCurrentProcessProto = WINFUNCTYPE(HANDLE    # Return type</span>
<a href="#l13.256"></a><span id="l13.256" class="difflineminus">-                                     )</span>
<a href="#l13.257"></a><span id="l13.257" class="difflineminus">-GetCurrentProcessFlags = ()</span>
<a href="#l13.258"></a><span id="l13.258" class="difflineminus">-GetCurrentProcess = GetCurrentProcessProto(</span>
<a href="#l13.259"></a><span id="l13.259" class="difflineminus">-    (&quot;GetCurrentProcess&quot;, windll.kernel32),</span>
<a href="#l13.260"></a><span id="l13.260" class="difflineminus">-    GetCurrentProcessFlags)</span>
<a href="#l13.261"></a><span id="l13.261" class="difflineminus">-GetCurrentProcess.errcheck = ErrCheckHandle</span>
<a href="#l13.262"></a><span id="l13.262" class="difflineminus">-</span>
<a href="#l13.263"></a><span id="l13.263" class="difflineminus">-# IsProcessInJob()</span>
<a href="#l13.264"></a><span id="l13.264" class="difflineminus">-try:</span>
<a href="#l13.265"></a><span id="l13.265" class="difflineminus">-    IsProcessInJobProto = WINFUNCTYPE(BOOL,     # Return type</span>
<a href="#l13.266"></a><span id="l13.266" class="difflineminus">-                                      HANDLE,   # Process Handle</span>
<a href="#l13.267"></a><span id="l13.267" class="difflineminus">-                                      HANDLE,   # Job Handle</span>
<a href="#l13.268"></a><span id="l13.268" class="difflineminus">-                                      LPBOOL      # Result</span>
<a href="#l13.269"></a><span id="l13.269" class="difflineminus">-                                      )</span>
<a href="#l13.270"></a><span id="l13.270" class="difflineminus">-    IsProcessInJobFlags = ((1, &quot;ProcessHandle&quot;),</span>
<a href="#l13.271"></a><span id="l13.271" class="difflineminus">-                           (1, &quot;JobHandle&quot;, HANDLE(0)),</span>
<a href="#l13.272"></a><span id="l13.272" class="difflineminus">-                           (2, &quot;Result&quot;))</span>
<a href="#l13.273"></a><span id="l13.273" class="difflineminus">-    IsProcessInJob = IsProcessInJobProto(</span>
<a href="#l13.274"></a><span id="l13.274" class="difflineminus">-        (&quot;IsProcessInJob&quot;, windll.kernel32),</span>
<a href="#l13.275"></a><span id="l13.275" class="difflineminus">-        IsProcessInJobFlags)</span>
<a href="#l13.276"></a><span id="l13.276" class="difflineminus">-    IsProcessInJob.errcheck = ErrCheckBool </span>
<a href="#l13.277"></a><span id="l13.277" class="difflineminus">-except AttributeError:</span>
<a href="#l13.278"></a><span id="l13.278" class="difflineminus">-    # windows 2k doesn't have this API</span>
<a href="#l13.279"></a><span id="l13.279" class="difflineminus">-    def IsProcessInJob(process):</span>
<a href="#l13.280"></a><span id="l13.280" class="difflineminus">-        return False</span>
<a href="#l13.281"></a><span id="l13.281" class="difflineminus">-</span>
<a href="#l13.282"></a><span id="l13.282" class="difflineminus">-</span>
<a href="#l13.283"></a><span id="l13.283" class="difflineminus">-# ResumeThread()</span>
<a href="#l13.284"></a><span id="l13.284" class="difflineminus">-</span>
<a href="#l13.285"></a><span id="l13.285" class="difflineminus">-def ErrCheckResumeThread(result, func, args):</span>
<a href="#l13.286"></a><span id="l13.286" class="difflineminus">-    if result == -1:</span>
<a href="#l13.287"></a><span id="l13.287" class="difflineminus">-        raise WinError()</span>
<a href="#l13.288"></a><span id="l13.288" class="difflineminus">-</span>
<a href="#l13.289"></a><span id="l13.289" class="difflineminus">-    return args</span>
<a href="#l13.290"></a><span id="l13.290" class="difflineminus">-</span>
<a href="#l13.291"></a><span id="l13.291" class="difflineminus">-ResumeThreadProto = WINFUNCTYPE(DWORD,      # Return type</span>
<a href="#l13.292"></a><span id="l13.292" class="difflineminus">-                                HANDLE      # hThread</span>
<a href="#l13.293"></a><span id="l13.293" class="difflineminus">-                                )</span>
<a href="#l13.294"></a><span id="l13.294" class="difflineminus">-ResumeThreadFlags = ((1, &quot;hThread&quot;),)</span>
<a href="#l13.295"></a><span id="l13.295" class="difflineminus">-ResumeThread = ResumeThreadProto((&quot;ResumeThread&quot;, windll.kernel32),</span>
<a href="#l13.296"></a><span id="l13.296" class="difflineminus">-                                 ResumeThreadFlags)</span>
<a href="#l13.297"></a><span id="l13.297" class="difflineminus">-ResumeThread.errcheck = ErrCheckResumeThread</span>
<a href="#l13.298"></a><span id="l13.298" class="difflineminus">-</span>
<a href="#l13.299"></a><span id="l13.299" class="difflineminus">-# TerminateProcess()</span>
<a href="#l13.300"></a><span id="l13.300" class="difflineminus">-</span>
<a href="#l13.301"></a><span id="l13.301" class="difflineminus">-TerminateProcessProto = WINFUNCTYPE(BOOL,   # Return type</span>
<a href="#l13.302"></a><span id="l13.302" class="difflineminus">-                                    HANDLE, # hProcess</span>
<a href="#l13.303"></a><span id="l13.303" class="difflineminus">-                                    UINT    # uExitCode</span>
<a href="#l13.304"></a><span id="l13.304" class="difflineminus">-                                    )</span>
<a href="#l13.305"></a><span id="l13.305" class="difflineminus">-TerminateProcessFlags = ((1, &quot;hProcess&quot;),</span>
<a href="#l13.306"></a><span id="l13.306" class="difflineminus">-                         (1, &quot;uExitCode&quot;, 127))</span>
<a href="#l13.307"></a><span id="l13.307" class="difflineminus">-TerminateProcess = TerminateProcessProto(</span>
<a href="#l13.308"></a><span id="l13.308" class="difflineminus">-    (&quot;TerminateProcess&quot;, windll.kernel32),</span>
<a href="#l13.309"></a><span id="l13.309" class="difflineminus">-    TerminateProcessFlags)</span>
<a href="#l13.310"></a><span id="l13.310" class="difflineminus">-TerminateProcess.errcheck = ErrCheckBool</span>
<a href="#l13.311"></a><span id="l13.311" class="difflineminus">-</span>
<a href="#l13.312"></a><span id="l13.312" class="difflineminus">-# TerminateJobObject()</span>
<a href="#l13.313"></a><span id="l13.313" class="difflineminus">-</span>
<a href="#l13.314"></a><span id="l13.314" class="difflineminus">-TerminateJobObjectProto = WINFUNCTYPE(BOOL,   # Return type</span>
<a href="#l13.315"></a><span id="l13.315" class="difflineminus">-                                      HANDLE, # hJob</span>
<a href="#l13.316"></a><span id="l13.316" class="difflineminus">-                                      UINT    # uExitCode</span>
<a href="#l13.317"></a><span id="l13.317" class="difflineminus">-                                      )</span>
<a href="#l13.318"></a><span id="l13.318" class="difflineminus">-TerminateJobObjectFlags = ((1, &quot;hJob&quot;),</span>
<a href="#l13.319"></a><span id="l13.319" class="difflineminus">-                           (1, &quot;uExitCode&quot;, 127))</span>
<a href="#l13.320"></a><span id="l13.320" class="difflineminus">-TerminateJobObject = TerminateJobObjectProto(</span>
<a href="#l13.321"></a><span id="l13.321" class="difflineminus">-    (&quot;TerminateJobObject&quot;, windll.kernel32),</span>
<a href="#l13.322"></a><span id="l13.322" class="difflineminus">-    TerminateJobObjectFlags)</span>
<a href="#l13.323"></a><span id="l13.323" class="difflineminus">-TerminateJobObject.errcheck = ErrCheckBool</span>
<a href="#l13.324"></a><span id="l13.324" class="difflineminus">-</span>
<a href="#l13.325"></a><span id="l13.325" class="difflineminus">-# WaitForSingleObject()</span>
<a href="#l13.326"></a><span id="l13.326" class="difflineminus">-</span>
<a href="#l13.327"></a><span id="l13.327" class="difflineminus">-WaitForSingleObjectProto = WINFUNCTYPE(DWORD,  # Return type</span>
<a href="#l13.328"></a><span id="l13.328" class="difflineminus">-                                       HANDLE, # hHandle</span>
<a href="#l13.329"></a><span id="l13.329" class="difflineminus">-                                       DWORD,  # dwMilliseconds</span>
<a href="#l13.330"></a><span id="l13.330" class="difflineminus">-                                       )</span>
<a href="#l13.331"></a><span id="l13.331" class="difflineminus">-WaitForSingleObjectFlags = ((1, &quot;hHandle&quot;),</span>
<a href="#l13.332"></a><span id="l13.332" class="difflineminus">-                            (1, &quot;dwMilliseconds&quot;, -1))</span>
<a href="#l13.333"></a><span id="l13.333" class="difflineminus">-WaitForSingleObject = WaitForSingleObjectProto(</span>
<a href="#l13.334"></a><span id="l13.334" class="difflineminus">-    (&quot;WaitForSingleObject&quot;, windll.kernel32),</span>
<a href="#l13.335"></a><span id="l13.335" class="difflineminus">-    WaitForSingleObjectFlags)</span>
<a href="#l13.336"></a><span id="l13.336" class="difflineminus">-</span>
<a href="#l13.337"></a><span id="l13.337" class="difflineminus">-INFINITE = -1</span>
<a href="#l13.338"></a><span id="l13.338" class="difflineminus">-WAIT_TIMEOUT = 0x0102</span>
<a href="#l13.339"></a><span id="l13.339" class="difflineminus">-WAIT_OBJECT_0 = 0x0</span>
<a href="#l13.340"></a><span id="l13.340" class="difflineminus">-WAIT_ABANDONED = 0x0080</span>
<a href="#l13.341"></a><span id="l13.341" class="difflineminus">-WAIT_FAILED = 0xFFFFFFFF</span>
<a href="#l13.342"></a><span id="l13.342" class="difflineminus">-</span>
<a href="#l13.343"></a><span id="l13.343" class="difflineminus">-# GetExitCodeProcess()</span>
<a href="#l13.344"></a><span id="l13.344" class="difflineminus">-</span>
<a href="#l13.345"></a><span id="l13.345" class="difflineminus">-GetExitCodeProcessProto = WINFUNCTYPE(BOOL,    # Return type</span>
<a href="#l13.346"></a><span id="l13.346" class="difflineminus">-                                      HANDLE,  # hProcess</span>
<a href="#l13.347"></a><span id="l13.347" class="difflineminus">-                                      LPDWORD, # lpExitCode</span>
<a href="#l13.348"></a><span id="l13.348" class="difflineminus">-                                      )</span>
<a href="#l13.349"></a><span id="l13.349" class="difflineminus">-GetExitCodeProcessFlags = ((1, &quot;hProcess&quot;),</span>
<a href="#l13.350"></a><span id="l13.350" class="difflineminus">-                           (2, &quot;lpExitCode&quot;))</span>
<a href="#l13.351"></a><span id="l13.351" class="difflineminus">-GetExitCodeProcess = GetExitCodeProcessProto(</span>
<a href="#l13.352"></a><span id="l13.352" class="difflineminus">-    (&quot;GetExitCodeProcess&quot;, windll.kernel32),</span>
<a href="#l13.353"></a><span id="l13.353" class="difflineminus">-    GetExitCodeProcessFlags)</span>
<a href="#l13.354"></a><span id="l13.354" class="difflineminus">-GetExitCodeProcess.errcheck = ErrCheckBool</span>
<a href="#l13.355"></a><span id="l13.355" class="difflineminus">-</span>
<a href="#l13.356"></a><span id="l13.356" class="difflineminus">-def CanCreateJobObject():</span>
<a href="#l13.357"></a><span id="l13.357" class="difflineminus">-    currentProc = GetCurrentProcess()</span>
<a href="#l13.358"></a><span id="l13.358" class="difflineminus">-    if IsProcessInJob(currentProc):</span>
<a href="#l13.359"></a><span id="l13.359" class="difflineminus">-        jobinfo = QueryInformationJobObject(HANDLE(0), 'JobObjectExtendedLimitInformation')</span>
<a href="#l13.360"></a><span id="l13.360" class="difflineminus">-        limitflags = jobinfo['BasicLimitInformation']['LimitFlags']</span>
<a href="#l13.361"></a><span id="l13.361" class="difflineminus">-        return bool(limitflags &amp; JOB_OBJECT_LIMIT_BREAKAWAY_OK) or bool(limitflags &amp; JOB_OBJECT_LIMIT_SILENT_BREAKAWAY_OK)</span>
<a href="#l13.362"></a><span id="l13.362" class="difflineminus">-    else:</span>
<a href="#l13.363"></a><span id="l13.363" class="difflineminus">-        return True</span>
<a href="#l13.364"></a><span id="l13.364" class="difflineminus">-</span>
<a href="#l13.365"></a><span id="l13.365" class="difflineminus">-### testing functions</span>
<a href="#l13.366"></a><span id="l13.366" class="difflineminus">-</span>
<a href="#l13.367"></a><span id="l13.367" class="difflineminus">-def parent():</span>
<a href="#l13.368"></a><span id="l13.368" class="difflineminus">-    print 'Starting parent'</span>
<a href="#l13.369"></a><span id="l13.369" class="difflineminus">-    currentProc = GetCurrentProcess()</span>
<a href="#l13.370"></a><span id="l13.370" class="difflineminus">-    if IsProcessInJob(currentProc):</span>
<a href="#l13.371"></a><span id="l13.371" class="difflineminus">-        print &gt;&gt; sys.stderr, &quot;You should not be in a job object to test&quot;</span>
<a href="#l13.372"></a><span id="l13.372" class="difflineminus">-        sys.exit(1)</span>
<a href="#l13.373"></a><span id="l13.373" class="difflineminus">-    assert CanCreateJobObject()</span>
<a href="#l13.374"></a><span id="l13.374" class="difflineminus">-    print 'File: %s' % __file__</span>
<a href="#l13.375"></a><span id="l13.375" class="difflineminus">-    command = [sys.executable, __file__, '-child']</span>
<a href="#l13.376"></a><span id="l13.376" class="difflineminus">-    print 'Running command: %s' % command</span>
<a href="#l13.377"></a><span id="l13.377" class="difflineminus">-    process = Popen(command)</span>
<a href="#l13.378"></a><span id="l13.378" class="difflineminus">-    process.kill()</span>
<a href="#l13.379"></a><span id="l13.379" class="difflineminus">-    code = process.returncode</span>
<a href="#l13.380"></a><span id="l13.380" class="difflineminus">-    print 'Child code: %s' % code</span>
<a href="#l13.381"></a><span id="l13.381" class="difflineminus">-    assert code == 127</span>
<a href="#l13.382"></a><span id="l13.382" class="difflineminus">-        </span>
<a href="#l13.383"></a><span id="l13.383" class="difflineminus">-def child():</span>
<a href="#l13.384"></a><span id="l13.384" class="difflineminus">-    print 'Starting child'</span>
<a href="#l13.385"></a><span id="l13.385" class="difflineminus">-    currentProc = GetCurrentProcess()</span>
<a href="#l13.386"></a><span id="l13.386" class="difflineminus">-    injob = IsProcessInJob(currentProc)</span>
<a href="#l13.387"></a><span id="l13.387" class="difflineminus">-    print &quot;Is in a job?: %s&quot; % injob</span>
<a href="#l13.388"></a><span id="l13.388" class="difflineminus">-    can_create = CanCreateJobObject()</span>
<a href="#l13.389"></a><span id="l13.389" class="difflineminus">-    print 'Can create job?: %s' % can_create</span>
<a href="#l13.390"></a><span id="l13.390" class="difflineminus">-    process = Popen('c:\\windows\\notepad.exe')</span>
<a href="#l13.391"></a><span id="l13.391" class="difflineminus">-    assert process._job</span>
<a href="#l13.392"></a><span id="l13.392" class="difflineminus">-    jobinfo = QueryInformationJobObject(process._job, 'JobObjectExtendedLimitInformation')</span>
<a href="#l13.393"></a><span id="l13.393" class="difflineminus">-    print 'Job info: %s' % jobinfo</span>
<a href="#l13.394"></a><span id="l13.394" class="difflineminus">-    limitflags = jobinfo['BasicLimitInformation']['LimitFlags']</span>
<a href="#l13.395"></a><span id="l13.395" class="difflineminus">-    print 'LimitFlags: %s' % limitflags</span>
<a href="#l13.396"></a><span id="l13.396" class="difflineminus">-    process.kill()</span>
<a href="#l13.397"></a><span id="l13.397" class="difflineminus">-</span>
<a href="#l13.398"></a><span id="l13.398" class="difflineminus">-if __name__ == '__main__':</span>
<a href="#l13.399"></a><span id="l13.399" class="difflineminus">-    import sys</span>
<a href="#l13.400"></a><span id="l13.400" class="difflineminus">-    from killableprocess import Popen</span>
<a href="#l13.401"></a><span id="l13.401" class="difflineminus">-    nargs = len(sys.argv[1:])</span>
<a href="#l13.402"></a><span id="l13.402" class="difflineminus">-    if nargs:</span>
<a href="#l13.403"></a><span id="l13.403" class="difflineminus">-        if nargs != 1 or sys.argv[1] != '-child':</span>
<a href="#l13.404"></a><span id="l13.404" class="difflineminus">-            raise AssertionError('Wrong flags; run like `python /path/to/winprocess.py`')</span>
<a href="#l13.405"></a><span id="l13.405" class="difflineminus">-        child()</span>
<a href="#l13.406"></a><span id="l13.406" class="difflineminus">-    else:</span>
<a href="#l13.407"></a><span id="l13.407" class="difflineminus">-        parent()</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1">deleted file mode 100644</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineminus">--- a/mail/test/resources/mozrunner/mozrunner/wpk.py</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineplus">+++ /dev/null</span>
<a href="#l14.4"></a><span id="l14.4" class="difflineat">@@ -1,76 +0,0 @@</span>
<a href="#l14.5"></a><span id="l14.5" class="difflineminus">-from ctypes import sizeof, windll, addressof, c_wchar, create_unicode_buffer</span>
<a href="#l14.6"></a><span id="l14.6" class="difflineminus">-from ctypes.wintypes import DWORD, HANDLE</span>
<a href="#l14.7"></a><span id="l14.7" class="difflineminus">-</span>
<a href="#l14.8"></a><span id="l14.8" class="difflineminus">-PROCESS_TERMINATE = 0x0001</span>
<a href="#l14.9"></a><span id="l14.9" class="difflineminus">-PROCESS_QUERY_INFORMATION = 0x0400</span>
<a href="#l14.10"></a><span id="l14.10" class="difflineminus">-PROCESS_VM_READ = 0x0010</span>
<a href="#l14.11"></a><span id="l14.11" class="difflineminus">-</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-def get_pids(process_name):</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineminus">-    BIG_ARRAY = DWORD * 4096</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineminus">-    processes = BIG_ARRAY()</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineminus">-    needed = DWORD()</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineminus">-</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineminus">-    pids = []</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineminus">-    result = windll.psapi.EnumProcesses(processes,</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineminus">-                                        sizeof(processes),</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineminus">-                                        addressof(needed))</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineminus">-    if not result:</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineminus">-        return pids</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineminus">-</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineminus">-    num_results = needed.value / sizeof(DWORD)</span>
<a href="#l14.25"></a><span id="l14.25" class="difflineminus">-</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineminus">-    for i in range(num_results):</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineminus">-        pid = processes[i]</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineminus">-        process = windll.kernel32.OpenProcess(PROCESS_QUERY_INFORMATION |</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineminus">-                                              PROCESS_VM_READ,</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineminus">-                                              0, pid)</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineminus">-        if process:</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineminus">-            module = HANDLE()</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineminus">-            result = windll.psapi.EnumProcessModules(process,</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineminus">-                                                     addressof(module),</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineminus">-                                                     sizeof(module),</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineminus">-                                                     addressof(needed))</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineminus">-            if result:</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineminus">-                name = create_unicode_buffer(1024)</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineminus">-                result = windll.psapi.GetModuleBaseNameW(process, module,</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineminus">-                                                         name, len(name))</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineminus">-                # TODO: This might not be the best way to</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineminus">-                # match a process name; maybe use a regexp instead.</span>
<a href="#l14.43"></a><span id="l14.43" class="difflineminus">-                if name.value.startswith(process_name):</span>
<a href="#l14.44"></a><span id="l14.44" class="difflineminus">-                    pids.append(pid)</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineminus">-                windll.kernel32.CloseHandle(module)</span>
<a href="#l14.46"></a><span id="l14.46" class="difflineminus">-            windll.kernel32.CloseHandle(process)</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineminus">-</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineminus">-    return pids</span>
<a href="#l14.49"></a><span id="l14.49" class="difflineminus">-</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineminus">-def kill_pid(pid):</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineminus">-    process = windll.kernel32.OpenProcess(PROCESS_TERMINATE, 0, pid)</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineminus">-    if process:</span>
<a href="#l14.53"></a><span id="l14.53" class="difflineminus">-        windll.kernel32.TerminateProcess(process, 0)</span>
<a href="#l14.54"></a><span id="l14.54" class="difflineminus">-        windll.kernel32.CloseHandle(process)</span>
<a href="#l14.55"></a><span id="l14.55" class="difflineminus">-</span>
<a href="#l14.56"></a><span id="l14.56" class="difflineminus">-if __name__ == '__main__':</span>
<a href="#l14.57"></a><span id="l14.57" class="difflineminus">-    import subprocess</span>
<a href="#l14.58"></a><span id="l14.58" class="difflineminus">-    import time</span>
<a href="#l14.59"></a><span id="l14.59" class="difflineminus">-</span>
<a href="#l14.60"></a><span id="l14.60" class="difflineminus">-    # This test just opens a new notepad instance and kills it.</span>
<a href="#l14.61"></a><span id="l14.61" class="difflineminus">-</span>
<a href="#l14.62"></a><span id="l14.62" class="difflineminus">-    name = 'notepad'</span>
<a href="#l14.63"></a><span id="l14.63" class="difflineminus">-</span>
<a href="#l14.64"></a><span id="l14.64" class="difflineminus">-    old_pids = set(get_pids(name))</span>
<a href="#l14.65"></a><span id="l14.65" class="difflineminus">-    subprocess.Popen([name])</span>
<a href="#l14.66"></a><span id="l14.66" class="difflineminus">-    time.sleep(0.25)</span>
<a href="#l14.67"></a><span id="l14.67" class="difflineminus">-    new_pids = set(get_pids(name)).difference(old_pids)</span>
<a href="#l14.68"></a><span id="l14.68" class="difflineminus">-</span>
<a href="#l14.69"></a><span id="l14.69" class="difflineminus">-    if len(new_pids) != 1:</span>
<a href="#l14.70"></a><span id="l14.70" class="difflineminus">-        raise Exception('%s was not opened or get_pids() is '</span>
<a href="#l14.71"></a><span id="l14.71" class="difflineminus">-                        'malfunctioning' % name)</span>
<a href="#l14.72"></a><span id="l14.72" class="difflineminus">-</span>
<a href="#l14.73"></a><span id="l14.73" class="difflineminus">-    kill_pid(tuple(new_pids)[0])</span>
<a href="#l14.74"></a><span id="l14.74" class="difflineminus">-</span>
<a href="#l14.75"></a><span id="l14.75" class="difflineminus">-    newest_pids = set(get_pids(name)).difference(old_pids)</span>
<a href="#l14.76"></a><span id="l14.76" class="difflineminus">-</span>
<a href="#l14.77"></a><span id="l14.77" class="difflineminus">-    if len(newest_pids) != 0:</span>
<a href="#l14.78"></a><span id="l14.78" class="difflineminus">-        raise Exception('kill_pid() is malfunctioning')</span>
<a href="#l14.79"></a><span id="l14.79" class="difflineminus">-</span>
<a href="#l14.80"></a><span id="l14.80" class="difflineminus">-    print &quot;Test passed.&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1">deleted file mode 100644</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineminus">--- a/mail/test/resources/mozrunner/setup.py</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineplus">+++ /dev/null</span>
<a href="#l15.4"></a><span id="l15.4" class="difflineat">@@ -1,79 +0,0 @@</span>
<a href="#l15.5"></a><span id="l15.5" class="difflineminus">-# ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l15.6"></a><span id="l15.6" class="difflineminus">-# Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l15.7"></a><span id="l15.7" class="difflineminus">-#</span>
<a href="#l15.8"></a><span id="l15.8" class="difflineminus">-# The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l15.9"></a><span id="l15.9" class="difflineminus">-# 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l15.10"></a><span id="l15.10" class="difflineminus">-# the License. You may obtain a copy of the License at</span>
<a href="#l15.11"></a><span id="l15.11" class="difflineminus">-# http://www.mozilla.org/MPL/</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-#</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineminus">-# Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineminus">-# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineminus">-# for the specific language governing rights and limitations under the</span>
<a href="#l15.16"></a><span id="l15.16" class="difflineminus">-# License.</span>
<a href="#l15.17"></a><span id="l15.17" class="difflineminus">-#</span>
<a href="#l15.18"></a><span id="l15.18" class="difflineminus">-# The Original Code is Mozilla Corporation Code.</span>
<a href="#l15.19"></a><span id="l15.19" class="difflineminus">-#</span>
<a href="#l15.20"></a><span id="l15.20" class="difflineminus">-# The Initial Developer of the Original Code is</span>
<a href="#l15.21"></a><span id="l15.21" class="difflineminus">-# Mikeal Rogers.</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineminus">-# Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l15.23"></a><span id="l15.23" class="difflineminus">-# the Initial Developer. All Rights Reserved.</span>
<a href="#l15.24"></a><span id="l15.24" class="difflineminus">-#</span>
<a href="#l15.25"></a><span id="l15.25" class="difflineminus">-# Contributor(s):</span>
<a href="#l15.26"></a><span id="l15.26" class="difflineminus">-#  Mikeal Rogers &lt;mikeal.rogers@gmail.com&gt;</span>
<a href="#l15.27"></a><span id="l15.27" class="difflineminus">-#</span>
<a href="#l15.28"></a><span id="l15.28" class="difflineminus">-# Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l15.29"></a><span id="l15.29" class="difflineminus">-# either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l15.30"></a><span id="l15.30" class="difflineminus">-# the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineminus">-# in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineminus">-# of those above. If you wish to allow use of your version of this file only</span>
<a href="#l15.33"></a><span id="l15.33" class="difflineminus">-# under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l15.34"></a><span id="l15.34" class="difflineminus">-# use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l15.35"></a><span id="l15.35" class="difflineminus">-# decision by deleting the provisions above and replace them with the notice</span>
<a href="#l15.36"></a><span id="l15.36" class="difflineminus">-# and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l15.37"></a><span id="l15.37" class="difflineminus">-# the provisions above, a recipient may use your version of this file under</span>
<a href="#l15.38"></a><span id="l15.38" class="difflineminus">-# the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l15.39"></a><span id="l15.39" class="difflineminus">-#</span>
<a href="#l15.40"></a><span id="l15.40" class="difflineminus">-# ***** END LICENSE BLOCK *****</span>
<a href="#l15.41"></a><span id="l15.41" class="difflineminus">-</span>
<a href="#l15.42"></a><span id="l15.42" class="difflineminus">-from setuptools import setup, find_packages</span>
<a href="#l15.43"></a><span id="l15.43" class="difflineminus">-import sys</span>
<a href="#l15.44"></a><span id="l15.44" class="difflineminus">-</span>
<a href="#l15.45"></a><span id="l15.45" class="difflineminus">-desc = &quot;&quot;&quot;Reliable start/stop/configuration of Mozilla Applications (Firefox, Thunderbird, etc.)&quot;&quot;&quot;</span>
<a href="#l15.46"></a><span id="l15.46" class="difflineminus">-</span>
<a href="#l15.47"></a><span id="l15.47" class="difflineminus">-PACKAGE_NAME = &quot;mozrunner&quot;</span>
<a href="#l15.48"></a><span id="l15.48" class="difflineminus">-PACKAGE_VERSION = &quot;2.5.13&quot;</span>
<a href="#l15.49"></a><span id="l15.49" class="difflineminus">-</span>
<a href="#l15.50"></a><span id="l15.50" class="difflineminus">-deps = []</span>
<a href="#l15.51"></a><span id="l15.51" class="difflineminus">-</span>
<a href="#l15.52"></a><span id="l15.52" class="difflineminus">-# we only support python 2 right now</span>
<a href="#l15.53"></a><span id="l15.53" class="difflineminus">-assert sys.version_info[0] == 2</span>
<a href="#l15.54"></a><span id="l15.54" class="difflineminus">-</span>
<a href="#l15.55"></a><span id="l15.55" class="difflineminus">-# version-dependent dependencies</span>
<a href="#l15.56"></a><span id="l15.56" class="difflineminus">-if sys.version_info[1] &lt; 6:</span>
<a href="#l15.57"></a><span id="l15.57" class="difflineminus">-    deps.append('simplejson')</span>
<a href="#l15.58"></a><span id="l15.58" class="difflineminus">-</span>
<a href="#l15.59"></a><span id="l15.59" class="difflineminus">-setup(name=PACKAGE_NAME,</span>
<a href="#l15.60"></a><span id="l15.60" class="difflineminus">-      version=PACKAGE_VERSION,</span>
<a href="#l15.61"></a><span id="l15.61" class="difflineminus">-      description=desc,</span>
<a href="#l15.62"></a><span id="l15.62" class="difflineminus">-      long_description=desc,</span>
<a href="#l15.63"></a><span id="l15.63" class="difflineminus">-      author='Mikeal Rogers, Mozilla',</span>
<a href="#l15.64"></a><span id="l15.64" class="difflineminus">-      author_email='mikeal.rogers@gmail.com',</span>
<a href="#l15.65"></a><span id="l15.65" class="difflineminus">-      url='http://github.com/mozautomation/mozmill',</span>
<a href="#l15.66"></a><span id="l15.66" class="difflineminus">-      license='MPL 1.1/GPL 2.0/LGPL 2.1',</span>
<a href="#l15.67"></a><span id="l15.67" class="difflineminus">-      packages=find_packages(exclude=['legacy']),</span>
<a href="#l15.68"></a><span id="l15.68" class="difflineminus">-      zip_safe=False,</span>
<a href="#l15.69"></a><span id="l15.69" class="difflineminus">-      entry_points=&quot;&quot;&quot;</span>
<a href="#l15.70"></a><span id="l15.70" class="difflineminus">-          [console_scripts]</span>
<a href="#l15.71"></a><span id="l15.71" class="difflineminus">-          mozrunner = mozrunner:cli</span>
<a href="#l15.72"></a><span id="l15.72" class="difflineminus">-          addon_id = mozrunner:print_addon_ids</span>
<a href="#l15.73"></a><span id="l15.73" class="difflineminus">-        &quot;&quot;&quot;,</span>
<a href="#l15.74"></a><span id="l15.74" class="difflineminus">-      platforms =['Any'],</span>
<a href="#l15.75"></a><span id="l15.75" class="difflineminus">-      install_requires = deps,</span>
<a href="#l15.76"></a><span id="l15.76" class="difflineminus">-      classifiers=['Development Status :: 4 - Beta',</span>
<a href="#l15.77"></a><span id="l15.77" class="difflineminus">-                   'Environment :: Console',</span>
<a href="#l15.78"></a><span id="l15.78" class="difflineminus">-                   'Intended Audience :: Developers',</span>
<a href="#l15.79"></a><span id="l15.79" class="difflineminus">-                   'License :: OSI Approved :: Mozilla Public License 1.1 (MPL 1.1)',</span>
<a href="#l15.80"></a><span id="l15.80" class="difflineminus">-                   'Operating System :: OS Independent',</span>
<a href="#l15.81"></a><span id="l15.81" class="difflineminus">-                   'Topic :: Software Development :: Libraries :: Python Modules',</span>
<a href="#l15.82"></a><span id="l15.82" class="difflineminus">-                  ]</span>
<a href="#l15.83"></a><span id="l15.83" class="difflineminus">-     )</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1">deleted file mode 100644</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineminus">--- a/mail/test/resources/mozrunner/tests/debub_settings.py</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineplus">+++ /dev/null</span>
<a href="#l16.4"></a><span id="l16.4" class="difflineat">@@ -1,4 +0,0 @@</span>
<a href="#l16.5"></a><span id="l16.5" class="difflineminus">-</span>
<a href="#l16.6"></a><span id="l16.6" class="difflineminus">-MOZILLA_CMD_ARGS = ['-jsconsole']</span>
<a href="#l16.7"></a><span id="l16.7" class="difflineminus">-</span>
<a href="#l16.8"></a><span id="l16.8" class="difflineminus">-MOZILLA_CREATE_NEW_PROFILE = True</span>
<a href="#l16.9"></a><span id="l16.9">\ No newline at end of file</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1">deleted file mode 100644</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineminus">--- a/mail/test/resources/mozrunner/tests/jss_settings.py</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineplus">+++ /dev/null</span>
<a href="#l17.4"></a><span id="l17.4" class="difflineat">@@ -1,7 +0,0 @@</span>
<a href="#l17.5"></a><span id="l17.5" class="difflineminus">-</span>
<a href="#l17.6"></a><span id="l17.6" class="difflineminus">-</span>
<a href="#l17.7"></a><span id="l17.7" class="difflineminus">-MOZILLA_PLUGINS = ['/Users/mikeal/Desktop/jssh-firefox-3.x.xpi']</span>
<a href="#l17.8"></a><span id="l17.8" class="difflineminus">-</span>
<a href="#l17.9"></a><span id="l17.9" class="difflineminus">-MOZILLA_CMD_ARGS = ['-jssh', '-jsconsole']</span>
<a href="#l17.10"></a><span id="l17.10" class="difflineminus">-</span>
<a href="#l17.11"></a><span id="l17.11" class="difflineminus">-MOZILLA_CREATE_NEW_PROFILE = True</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

