<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 7513:000c04a87624ce94e1efbb9ee22c4a1184f2bb14</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 000c04a87624ce94e1efbb9ee22c4a1184f2bb14" />
<meta property="og:url" content="/comm-central/rev/000c04a87624ce94e1efbb9ee22c4a1184f2bb14" />
<meta property="og:description" content="Bug 647003 - Remove use of nsAutoLock from LDAP SDK code r=standard8 f=neil" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 000c04a87624ce94e1efbb9ee22c4a1184f2bb14 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/000c04a87624ce94e1efbb9ee22c4a1184f2bb14">shortlog</a> |
<a href="/comm-central/log/000c04a87624ce94e1efbb9ee22c4a1184f2bb14">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/000c04a87624ce94e1efbb9ee22c4a1184f2bb14">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/000c04a87624ce94e1efbb9ee22c4a1184f2bb14">files</a> |
changeset |
<a href="/comm-central/raw-rev/000c04a87624ce94e1efbb9ee22c4a1184f2bb14">raw</a>  | <a href="/comm-central/archive/000c04a87624ce94e1efbb9ee22c4a1184f2bb14.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=647003">Bug 647003</a> - Remove use of nsAutoLock from LDAP SDK code r=standard8 f=neil
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#73;&#97;&#110;&#32;&#78;&#101;&#97;&#108;&#32;&#60;&#105;&#97;&#110;&#110;&#95;&#99;&#118;&#115;&#64;&#98;&#108;&#117;&#101;&#121;&#111;&#110;&#100;&#101;&#114;&#46;&#99;&#111;&#46;&#117;&#107;&#62;</td></tr>
<tr><td></td><td class="date age">Wed, 06 Apr 2011 22:16:28 +0100</td></tr>

<tr>
 <td>changeset 7513</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/000c04a87624ce94e1efbb9ee22c4a1184f2bb14">000c04a87624ce94e1efbb9ee22c4a1184f2bb14</a></td>
</tr>



<tr>
<td>parent 7512</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/c831c107de255938939497b8b70e07da333410f7">c831c107de255938939497b8b70e07da333410f7</a>
</td>
</tr>

<tr>
<td>child 7514</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/85be50c0b00f108108926331c1a9db77e901f530">85be50c0b00f108108926331c1a9db77e901f530</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=000c04a87624ce94e1efbb9ee22c4a1184f2bb14">5757</a></td></tr>
<tr><td>push user</td><td>iann_cvs@blueyonder.co.uk</td></tr>
<tr><td>push date</td><td class="date age">Wed, 06 Apr 2011 21:15:50 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@000c04a87624 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=000c04a87624ce94e1efbb9ee22c4a1184f2bb14">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=000c04a87624ce94e1efbb9ee22c4a1184f2bb14&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=000c04a87624ce94e1efbb9ee22c4a1184f2bb14&newProject=comm-central&newRevision=000c04a87624ce94e1efbb9ee22c4a1184f2bb14&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=000c04a87624ce94e1efbb9ee22c4a1184f2bb14&newProject=comm-central&newRevision=000c04a87624ce94e1efbb9ee22c4a1184f2bb14&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=000c04a87624ce94e1efbb9ee22c4a1184f2bb14&newProject=comm-central&newRevision=000c04a87624ce94e1efbb9ee22c4a1184f2bb14&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28standard8%29&revcount=50">standard8</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=647003">647003</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=647003">Bug 647003</a> - Remove use of nsAutoLock from LDAP SDK code r=standard8 f=neil</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/000c04a87624ce94e1efbb9ee22c4a1184f2bb14/ldap/xpcom/src/nsLDAPModification.cpp">ldap/xpcom/src/nsLDAPModification.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/000c04a87624ce94e1efbb9ee22c4a1184f2bb14/ldap/xpcom/src/nsLDAPModification.cpp">file</a> |
<a href="/comm-central/annotate/000c04a87624ce94e1efbb9ee22c4a1184f2bb14/ldap/xpcom/src/nsLDAPModification.cpp">annotate</a> |
<a href="/comm-central/diff/000c04a87624ce94e1efbb9ee22c4a1184f2bb14/ldap/xpcom/src/nsLDAPModification.cpp">diff</a> |
<a href="/comm-central/comparison/000c04a87624ce94e1efbb9ee22c4a1184f2bb14/ldap/xpcom/src/nsLDAPModification.cpp">comparison</a> |
<a href="/comm-central/log/000c04a87624ce94e1efbb9ee22c4a1184f2bb14/ldap/xpcom/src/nsLDAPModification.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/000c04a87624ce94e1efbb9ee22c4a1184f2bb14/ldap/xpcom/src/nsLDAPModification.h">ldap/xpcom/src/nsLDAPModification.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/000c04a87624ce94e1efbb9ee22c4a1184f2bb14/ldap/xpcom/src/nsLDAPModification.h">file</a> |
<a href="/comm-central/annotate/000c04a87624ce94e1efbb9ee22c4a1184f2bb14/ldap/xpcom/src/nsLDAPModification.h">annotate</a> |
<a href="/comm-central/diff/000c04a87624ce94e1efbb9ee22c4a1184f2bb14/ldap/xpcom/src/nsLDAPModification.h">diff</a> |
<a href="/comm-central/comparison/000c04a87624ce94e1efbb9ee22c4a1184f2bb14/ldap/xpcom/src/nsLDAPModification.h">comparison</a> |
<a href="/comm-central/log/000c04a87624ce94e1efbb9ee22c4a1184f2bb14/ldap/xpcom/src/nsLDAPModification.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/000c04a87624ce94e1efbb9ee22c4a1184f2bb14/ldap/xpcom/src/nsLDAPService.cpp">ldap/xpcom/src/nsLDAPService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/000c04a87624ce94e1efbb9ee22c4a1184f2bb14/ldap/xpcom/src/nsLDAPService.cpp">file</a> |
<a href="/comm-central/annotate/000c04a87624ce94e1efbb9ee22c4a1184f2bb14/ldap/xpcom/src/nsLDAPService.cpp">annotate</a> |
<a href="/comm-central/diff/000c04a87624ce94e1efbb9ee22c4a1184f2bb14/ldap/xpcom/src/nsLDAPService.cpp">diff</a> |
<a href="/comm-central/comparison/000c04a87624ce94e1efbb9ee22c4a1184f2bb14/ldap/xpcom/src/nsLDAPService.cpp">comparison</a> |
<a href="/comm-central/log/000c04a87624ce94e1efbb9ee22c4a1184f2bb14/ldap/xpcom/src/nsLDAPService.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/000c04a87624ce94e1efbb9ee22c4a1184f2bb14/ldap/xpcom/src/nsLDAPService.h">ldap/xpcom/src/nsLDAPService.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/000c04a87624ce94e1efbb9ee22c4a1184f2bb14/ldap/xpcom/src/nsLDAPService.h">file</a> |
<a href="/comm-central/annotate/000c04a87624ce94e1efbb9ee22c4a1184f2bb14/ldap/xpcom/src/nsLDAPService.h">annotate</a> |
<a href="/comm-central/diff/000c04a87624ce94e1efbb9ee22c4a1184f2bb14/ldap/xpcom/src/nsLDAPService.h">diff</a> |
<a href="/comm-central/comparison/000c04a87624ce94e1efbb9ee22c4a1184f2bb14/ldap/xpcom/src/nsLDAPService.h">comparison</a> |
<a href="/comm-central/log/000c04a87624ce94e1efbb9ee22c4a1184f2bb14/ldap/xpcom/src/nsLDAPService.h">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/ldap/xpcom/src/nsLDAPModification.cpp</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/ldap/xpcom/src/nsLDAPModification.cpp</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -33,49 +33,40 @@</span>
<a href="#l1.4"></a><span id="l1.4">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l1.5"></a><span id="l1.5">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l1.6"></a><span id="l1.6">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l1.7"></a><span id="l1.7">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l1.8"></a><span id="l1.8">  *</span>
<a href="#l1.9"></a><span id="l1.9">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l1.10"></a><span id="l1.10"> </span>
<a href="#l1.11"></a><span id="l1.11"> #include &quot;nsLDAPModification.h&quot;</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-#include &quot;nsAutoLock.h&quot;</span>
<a href="#l1.13"></a><span id="l1.13"> #include &quot;nsILDAPBERValue.h&quot;</span>
<a href="#l1.14"></a><span id="l1.14"> #include &quot;nsISimpleEnumerator.h&quot;</span>
<a href="#l1.15"></a><span id="l1.15"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l1.16"></a><span id="l1.16"> </span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+using namespace mozilla;</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+</span>
<a href="#l1.19"></a><span id="l1.19"> NS_IMPL_THREADSAFE_ISUPPORTS1(nsLDAPModification, nsILDAPModification)</span>
<a href="#l1.20"></a><span id="l1.20"> </span>
<a href="#l1.21"></a><span id="l1.21"> // constructor</span>
<a href="#l1.22"></a><span id="l1.22"> //</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineminus">-nsLDAPModification::nsLDAPModification() : mValuesLock(nsnull)</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineplus">+nsLDAPModification::nsLDAPModification()</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineplus">+    : mValuesLock(&quot;nsLDAPModification.mValuesLock&quot;)</span>
<a href="#l1.26"></a><span id="l1.26"> {</span>
<a href="#l1.27"></a><span id="l1.27"> }</span>
<a href="#l1.28"></a><span id="l1.28"> </span>
<a href="#l1.29"></a><span id="l1.29"> // destructor</span>
<a href="#l1.30"></a><span id="l1.30"> //</span>
<a href="#l1.31"></a><span id="l1.31"> nsLDAPModification::~nsLDAPModification()</span>
<a href="#l1.32"></a><span id="l1.32"> {</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineminus">-  if (mValuesLock) {</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineminus">-    PR_DestroyLock(mValuesLock);</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineminus">-  }</span>
<a href="#l1.36"></a><span id="l1.36"> }</span>
<a href="#l1.37"></a><span id="l1.37"> </span>
<a href="#l1.38"></a><span id="l1.38"> nsresult</span>
<a href="#l1.39"></a><span id="l1.39"> nsLDAPModification::Init()</span>
<a href="#l1.40"></a><span id="l1.40"> {</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineminus">-  if (!mValuesLock) {</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineminus">-    mValuesLock = PR_NewLock();</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineminus">-    if (!mValuesLock) {</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineminus">-      NS_ERROR(&quot;nsLDAPModification::Init: out of memory&quot;);</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineminus">-      return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineminus">-    }</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineminus">-  }</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineminus">-</span>
<a href="#l1.49"></a><span id="l1.49">   return NS_OK;</span>
<a href="#l1.50"></a><span id="l1.50"> }</span>
<a href="#l1.51"></a><span id="l1.51"> </span>
<a href="#l1.52"></a><span id="l1.52"> NS_IMETHODIMP</span>
<a href="#l1.53"></a><span id="l1.53"> nsLDAPModification::GetOperation(PRInt32 *aOperation)</span>
<a href="#l1.54"></a><span id="l1.54"> {</span>
<a href="#l1.55"></a><span id="l1.55">   NS_ENSURE_ARG_POINTER(aOperation);</span>
<a href="#l1.56"></a><span id="l1.56"> </span>
<a href="#l1.57"></a><span id="l1.57" class="difflineat">@@ -103,32 +94,32 @@ nsLDAPModification::SetType(const nsACSt</span>
<a href="#l1.58"></a><span id="l1.58">   return NS_OK;</span>
<a href="#l1.59"></a><span id="l1.59"> }</span>
<a href="#l1.60"></a><span id="l1.60"> </span>
<a href="#l1.61"></a><span id="l1.61"> NS_IMETHODIMP</span>
<a href="#l1.62"></a><span id="l1.62"> nsLDAPModification::GetValues(nsIArray** aResult)</span>
<a href="#l1.63"></a><span id="l1.63"> {</span>
<a href="#l1.64"></a><span id="l1.64">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l1.65"></a><span id="l1.65"> </span>
<a href="#l1.66"></a><span id="l1.66" class="difflineminus">-  nsAutoLock lock(mValuesLock);</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineplus">+  MutexAutoLock lock(mValuesLock);</span>
<a href="#l1.68"></a><span id="l1.68"> </span>
<a href="#l1.69"></a><span id="l1.69">   if (!mValues)</span>
<a href="#l1.70"></a><span id="l1.70">     return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l1.71"></a><span id="l1.71"> </span>
<a href="#l1.72"></a><span id="l1.72">   NS_ADDREF(*aResult = mValues);</span>
<a href="#l1.73"></a><span id="l1.73"> </span>
<a href="#l1.74"></a><span id="l1.74">   return NS_OK;</span>
<a href="#l1.75"></a><span id="l1.75"> }</span>
<a href="#l1.76"></a><span id="l1.76"> </span>
<a href="#l1.77"></a><span id="l1.77"> NS_IMETHODIMP</span>
<a href="#l1.78"></a><span id="l1.78"> nsLDAPModification::SetValues(nsIArray* aValues)</span>
<a href="#l1.79"></a><span id="l1.79"> {</span>
<a href="#l1.80"></a><span id="l1.80">   NS_ENSURE_ARG_POINTER(aValues);</span>
<a href="#l1.81"></a><span id="l1.81"> </span>
<a href="#l1.82"></a><span id="l1.82" class="difflineminus">-  nsAutoLock lock(mValuesLock);</span>
<a href="#l1.83"></a><span id="l1.83" class="difflineplus">+  MutexAutoLock lock(mValuesLock);</span>
<a href="#l1.84"></a><span id="l1.84">   nsresult rv;</span>
<a href="#l1.85"></a><span id="l1.85"> </span>
<a href="#l1.86"></a><span id="l1.86">   if (!mValues)</span>
<a href="#l1.87"></a><span id="l1.87">     mValues = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l1.88"></a><span id="l1.88">   else</span>
<a href="#l1.89"></a><span id="l1.89">     rv = mValues-&gt;Clear();</span>
<a href="#l1.90"></a><span id="l1.90"> </span>
<a href="#l1.91"></a><span id="l1.91">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.92"></a><span id="l1.92" class="difflineat">@@ -162,32 +153,32 @@ NS_IMETHODIMP</span>
<a href="#l1.93"></a><span id="l1.93"> nsLDAPModification::SetUpModification(PRInt32 aOperation,</span>
<a href="#l1.94"></a><span id="l1.94">                                       const nsACString &amp;aType,</span>
<a href="#l1.95"></a><span id="l1.95">                                       nsIArray *aValues)</span>
<a href="#l1.96"></a><span id="l1.96"> {</span>
<a href="#l1.97"></a><span id="l1.97">   // Set the values using our local function before entering lock</span>
<a href="#l1.98"></a><span id="l1.98">   // to avoid deadlocks due to holding the same lock twice.</span>
<a href="#l1.99"></a><span id="l1.99">   nsresult rv = SetValues(aValues);</span>
<a href="#l1.100"></a><span id="l1.100"> </span>
<a href="#l1.101"></a><span id="l1.101" class="difflineminus">-  nsAutoLock lock(mValuesLock);</span>
<a href="#l1.102"></a><span id="l1.102" class="difflineplus">+  MutexAutoLock lock(mValuesLock);</span>
<a href="#l1.103"></a><span id="l1.103"> </span>
<a href="#l1.104"></a><span id="l1.104">   mOperation = aOperation;</span>
<a href="#l1.105"></a><span id="l1.105">   mType.Assign(aType);</span>
<a href="#l1.106"></a><span id="l1.106"> </span>
<a href="#l1.107"></a><span id="l1.107">   return rv;</span>
<a href="#l1.108"></a><span id="l1.108"> }</span>
<a href="#l1.109"></a><span id="l1.109"> </span>
<a href="#l1.110"></a><span id="l1.110"> NS_IMETHODIMP</span>
<a href="#l1.111"></a><span id="l1.111"> nsLDAPModification::SetUpModificationOneValue(PRInt32 aOperation,</span>
<a href="#l1.112"></a><span id="l1.112">                                               const nsACString &amp;aType,</span>
<a href="#l1.113"></a><span id="l1.113">                                               nsILDAPBERValue *aValue)</span>
<a href="#l1.114"></a><span id="l1.114"> {</span>
<a href="#l1.115"></a><span id="l1.115">   NS_ENSURE_ARG_POINTER(aValue);</span>
<a href="#l1.116"></a><span id="l1.116"> </span>
<a href="#l1.117"></a><span id="l1.117" class="difflineminus">-  nsAutoLock lock(mValuesLock);</span>
<a href="#l1.118"></a><span id="l1.118" class="difflineplus">+  MutexAutoLock lock(mValuesLock);</span>
<a href="#l1.119"></a><span id="l1.119"> </span>
<a href="#l1.120"></a><span id="l1.120">   mOperation = aOperation;</span>
<a href="#l1.121"></a><span id="l1.121">   mType.Assign(aType);</span>
<a href="#l1.122"></a><span id="l1.122"> </span>
<a href="#l1.123"></a><span id="l1.123">   nsresult rv;</span>
<a href="#l1.124"></a><span id="l1.124"> </span>
<a href="#l1.125"></a><span id="l1.125">   if (!mValues)</span>
<a href="#l1.126"></a><span id="l1.126">     mValues = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/ldap/xpcom/src/nsLDAPModification.h</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/ldap/xpcom/src/nsLDAPModification.h</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -38,16 +38,17 @@</span>
<a href="#l2.4"></a><span id="l2.4"> </span>
<a href="#l2.5"></a><span id="l2.5"> #ifndef _nsLDAPModification_h_</span>
<a href="#l2.6"></a><span id="l2.6"> #define _nsLDAPModification_h_</span>
<a href="#l2.7"></a><span id="l2.7"> </span>
<a href="#l2.8"></a><span id="l2.8"> #include &quot;nsILDAPModification.h&quot;</span>
<a href="#l2.9"></a><span id="l2.9"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l2.10"></a><span id="l2.10"> #include &quot;nsString.h&quot;</span>
<a href="#l2.11"></a><span id="l2.11"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+#include &quot;mozilla/Mutex.h&quot;</span>
<a href="#l2.13"></a><span id="l2.13"> </span>
<a href="#l2.14"></a><span id="l2.14"> // 5b0f4d00-062e-11d6-a7f2-fc943c3c039c</span>
<a href="#l2.15"></a><span id="l2.15"> //</span>
<a href="#l2.16"></a><span id="l2.16"> #define NS_LDAPMODIFICATION_CID \</span>
<a href="#l2.17"></a><span id="l2.17"> { 0x5b0f4d00, 0x062e, 0x11d6, \</span>
<a href="#l2.18"></a><span id="l2.18">   { 0xa7, 0xf2, 0xfc, 0x94, 0x3c, 0x3c, 0x03, 0x9c }}</span>
<a href="#l2.19"></a><span id="l2.19"> </span>
<a href="#l2.20"></a><span id="l2.20"> class nsLDAPModification : public nsILDAPModification</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineat">@@ -62,12 +63,12 @@ public:</span>
<a href="#l2.22"></a><span id="l2.22">   virtual ~nsLDAPModification();</span>
<a href="#l2.23"></a><span id="l2.23"> </span>
<a href="#l2.24"></a><span id="l2.24">   nsresult Init();</span>
<a href="#l2.25"></a><span id="l2.25"> </span>
<a href="#l2.26"></a><span id="l2.26"> private:</span>
<a href="#l2.27"></a><span id="l2.27">   PRInt32 mOperation;</span>
<a href="#l2.28"></a><span id="l2.28">   nsCString mType;</span>
<a href="#l2.29"></a><span id="l2.29">   nsCOMPtr&lt;nsIMutableArray&gt; mValues;</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineminus">-  PRLock* mValuesLock;</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+  mozilla::Mutex mValuesLock;</span>
<a href="#l2.32"></a><span id="l2.32"> };</span>
<a href="#l2.33"></a><span id="l2.33"> </span>
<a href="#l2.34"></a><span id="l2.34"> #endif // _nsLDAPModification_h_</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/ldap/xpcom/src/nsLDAPService.cpp</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/ldap/xpcom/src/nsLDAPService.cpp</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -42,20 +42,21 @@</span>
<a href="#l3.4"></a><span id="l3.4"> #include &quot;nsLDAPService.h&quot;</span>
<a href="#l3.5"></a><span id="l3.5"> #include &quot;nsLDAPConnection.h&quot;</span>
<a href="#l3.6"></a><span id="l3.6"> #include &quot;nsLDAPOperation.h&quot;</span>
<a href="#l3.7"></a><span id="l3.7"> #include &quot;nsXPIDLString.h&quot;</span>
<a href="#l3.8"></a><span id="l3.8"> #include &quot;nsReadableUtils.h&quot;</span>
<a href="#l3.9"></a><span id="l3.9"> #include &quot;nsIServiceManager.h&quot;</span>
<a href="#l3.10"></a><span id="l3.10"> #include &quot;nsIConsoleService.h&quot;</span>
<a href="#l3.11"></a><span id="l3.11"> #include &quot;nsILDAPURL.h&quot;</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-#include &quot;nsAutoLock.h&quot;</span>
<a href="#l3.13"></a><span id="l3.13"> #include &quot;nsCRT.h&quot;</span>
<a href="#l3.14"></a><span id="l3.14"> #include &quot;nsILDAPErrors.h&quot;</span>
<a href="#l3.15"></a><span id="l3.15"> </span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+using namespace mozilla;</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+</span>
<a href="#l3.18"></a><span id="l3.18"> // Constants for CIDs used here.</span>
<a href="#l3.19"></a><span id="l3.19"> //</span>
<a href="#l3.20"></a><span id="l3.20"> static NS_DEFINE_CID(kLDAPConnectionCID, NS_LDAPCONNECTION_CID);</span>
<a href="#l3.21"></a><span id="l3.21"> static NS_DEFINE_CID(kLDAPOperationCID, NS_LDAPOPERATION_CID);</span>
<a href="#l3.22"></a><span id="l3.22"> </span>
<a href="#l3.23"></a><span id="l3.23"> // First we provide all the methods for the &quot;local&quot; class</span>
<a href="#l3.24"></a><span id="l3.24"> // nsLDAPServiceEntry.</span>
<a href="#l3.25"></a><span id="l3.25"> //</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineat">@@ -222,17 +223,17 @@ PRBool nsLDAPServiceEntry::DeleteEntry()</span>
<a href="#l3.27"></a><span id="l3.27"> NS_IMPL_THREADSAFE_ISUPPORTS2(nsLDAPService,</span>
<a href="#l3.28"></a><span id="l3.28">                               nsILDAPService,</span>
<a href="#l3.29"></a><span id="l3.29">                               nsILDAPMessageListener)</span>
<a href="#l3.30"></a><span id="l3.30"> </span>
<a href="#l3.31"></a><span id="l3.31"> </span>
<a href="#l3.32"></a><span id="l3.32"> // constructor</span>
<a href="#l3.33"></a><span id="l3.33"> //</span>
<a href="#l3.34"></a><span id="l3.34"> nsLDAPService::nsLDAPService()</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineminus">-    : mLock(0),</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+    : mLock(&quot;nsLDAPService.mLock&quot;),</span>
<a href="#l3.37"></a><span id="l3.37">       mServers(0),</span>
<a href="#l3.38"></a><span id="l3.38">       mConnections(0)</span>
<a href="#l3.39"></a><span id="l3.39"> {</span>
<a href="#l3.40"></a><span id="l3.40"> }</span>
<a href="#l3.41"></a><span id="l3.41"> </span>
<a href="#l3.42"></a><span id="l3.42"> // destructor</span>
<a href="#l3.43"></a><span id="l3.43"> //</span>
<a href="#l3.44"></a><span id="l3.44"> nsLDAPService::~nsLDAPService()</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineat">@@ -241,35 +242,22 @@ nsLDAPService::~nsLDAPService()</span>
<a href="#l3.46"></a><span id="l3.46">     if (mServers) {</span>
<a href="#l3.47"></a><span id="l3.47">         delete mServers;</span>
<a href="#l3.48"></a><span id="l3.48">     }</span>
<a href="#l3.49"></a><span id="l3.49"> </span>
<a href="#l3.50"></a><span id="l3.50">     // Delete the hash holding the &quot;reverse&quot; lookups from conn to server</span>
<a href="#l3.51"></a><span id="l3.51">     if (mConnections) {</span>
<a href="#l3.52"></a><span id="l3.52">         delete mConnections;</span>
<a href="#l3.53"></a><span id="l3.53">     }</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineminus">-</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineminus">-    // Delete the lock object</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineminus">-    if (mLock) {</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineminus">-        PR_DestroyLock(mLock);</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineminus">-    }</span>
<a href="#l3.59"></a><span id="l3.59"> }</span>
<a href="#l3.60"></a><span id="l3.60"> </span>
<a href="#l3.61"></a><span id="l3.61"> // Initializer, create some internal hash tables etc.</span>
<a href="#l3.62"></a><span id="l3.62"> //</span>
<a href="#l3.63"></a><span id="l3.63"> nsresult nsLDAPService::Init()</span>
<a href="#l3.64"></a><span id="l3.64"> {</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineminus">-    if (!mLock) {</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineminus">-        mLock = PR_NewLock();</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineminus">-        if (!mLock) {</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineminus">-            NS_ERROR(&quot;nsLDAPService::Init: out of memory &quot;);</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineminus">-            return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineminus">-        }</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineminus">-    }</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineminus">-</span>
<a href="#l3.73"></a><span id="l3.73">     if (!mServers) {</span>
<a href="#l3.74"></a><span id="l3.74">         mServers = new nsHashtable(16, PR_FALSE);</span>
<a href="#l3.75"></a><span id="l3.75">         if (!mServers) {</span>
<a href="#l3.76"></a><span id="l3.76">             NS_ERROR(&quot;nsLDAPService::Init: out of memory &quot;);</span>
<a href="#l3.77"></a><span id="l3.77">             return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l3.78"></a><span id="l3.78">         }</span>
<a href="#l3.79"></a><span id="l3.79">     }</span>
<a href="#l3.80"></a><span id="l3.80"> </span>
<a href="#l3.81"></a><span id="l3.81" class="difflineat">@@ -331,17 +319,17 @@ NS_IMETHODIMP nsLDAPService::AddServer(n</span>
<a href="#l3.82"></a><span id="l3.82">     }</span>
<a href="#l3.83"></a><span id="l3.83"> </span>
<a href="#l3.84"></a><span id="l3.84">     // We increment the refcount here for the server entry, when</span>
<a href="#l3.85"></a><span id="l3.85">     // we purge a server completely from the service (TBD), we</span>
<a href="#l3.86"></a><span id="l3.86">     // need to decrement the counter as well.</span>
<a href="#l3.87"></a><span id="l3.87">     //</span>
<a href="#l3.88"></a><span id="l3.88">     {</span>
<a href="#l3.89"></a><span id="l3.89">         nsStringKey hashKey(key);</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineminus">-        nsAutoLock lock(mLock);</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineplus">+        MutexAutoLock lock(mLock);</span>
<a href="#l3.92"></a><span id="l3.92"> </span>
<a href="#l3.93"></a><span id="l3.93">         if (mServers-&gt;Exists(&amp;hashKey)) {</span>
<a href="#l3.94"></a><span id="l3.94">             // Collision detected, lets just throw away this service entry</span>
<a href="#l3.95"></a><span id="l3.95">             // and keep the old one.</span>
<a href="#l3.96"></a><span id="l3.96">             //</span>
<a href="#l3.97"></a><span id="l3.97">             delete entry;</span>
<a href="#l3.98"></a><span id="l3.98">             return NS_ERROR_FAILURE;</span>
<a href="#l3.99"></a><span id="l3.99">         }</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineat">@@ -352,17 +340,17 @@ NS_IMETHODIMP nsLDAPService::AddServer(n</span>
<a href="#l3.101"></a><span id="l3.101">     return NS_OK;</span>
<a href="#l3.102"></a><span id="l3.102"> }</span>
<a href="#l3.103"></a><span id="l3.103"> </span>
<a href="#l3.104"></a><span id="l3.104"> // void deleteServer (in wstring aKey);</span>
<a href="#l3.105"></a><span id="l3.105"> NS_IMETHODIMP nsLDAPService::DeleteServer(const PRUnichar *aKey)</span>
<a href="#l3.106"></a><span id="l3.106"> {</span>
<a href="#l3.107"></a><span id="l3.107">     nsLDAPServiceEntry *entry;</span>
<a href="#l3.108"></a><span id="l3.108">     nsStringKey hashKey(aKey, -1, nsStringKey::NEVER_OWN);</span>
<a href="#l3.109"></a><span id="l3.109" class="difflineminus">-    nsAutoLock lock(mLock);</span>
<a href="#l3.110"></a><span id="l3.110" class="difflineplus">+    MutexAutoLock lock(mLock);</span>
<a href="#l3.111"></a><span id="l3.111">         </span>
<a href="#l3.112"></a><span id="l3.112">     // We should probably rename the key for this entry now that it's</span>
<a href="#l3.113"></a><span id="l3.113">     // &quot;deleted&quot;, so that we can add in a new one with the same ID.</span>
<a href="#l3.114"></a><span id="l3.114">     // This is bug #77669.</span>
<a href="#l3.115"></a><span id="l3.115">     //</span>
<a href="#l3.116"></a><span id="l3.116">     entry = static_cast&lt;nsLDAPServiceEntry *&gt;(mServers-&gt;Get(&amp;hashKey));</span>
<a href="#l3.117"></a><span id="l3.117">     if (entry) {</span>
<a href="#l3.118"></a><span id="l3.118">         if (entry-&gt;GetLeases() &gt; 0) {</span>
<a href="#l3.119"></a><span id="l3.119" class="difflineat">@@ -379,17 +367,17 @@ NS_IMETHODIMP nsLDAPService::DeleteServe</span>
<a href="#l3.120"></a><span id="l3.120"> }</span>
<a href="#l3.121"></a><span id="l3.121"> </span>
<a href="#l3.122"></a><span id="l3.122"> // nsILDAPServer getServer (in wstring aKey);</span>
<a href="#l3.123"></a><span id="l3.123"> NS_IMETHODIMP nsLDAPService::GetServer(const PRUnichar *aKey,</span>
<a href="#l3.124"></a><span id="l3.124">                                        nsILDAPServer **_retval)</span>
<a href="#l3.125"></a><span id="l3.125"> {</span>
<a href="#l3.126"></a><span id="l3.126">     nsLDAPServiceEntry *entry;</span>
<a href="#l3.127"></a><span id="l3.127">     nsStringKey hashKey(aKey, -1, nsStringKey::NEVER_OWN);</span>
<a href="#l3.128"></a><span id="l3.128" class="difflineminus">-    nsAutoLock lock(mLock);</span>
<a href="#l3.129"></a><span id="l3.129" class="difflineplus">+    MutexAutoLock lock(mLock);</span>
<a href="#l3.130"></a><span id="l3.130"> </span>
<a href="#l3.131"></a><span id="l3.131">     if (!_retval) {</span>
<a href="#l3.132"></a><span id="l3.132">         NS_ERROR(&quot;nsLDAPService::GetServer: null pointer &quot;);</span>
<a href="#l3.133"></a><span id="l3.133">         return NS_ERROR_NULL_POINTER;</span>
<a href="#l3.134"></a><span id="l3.134">     }</span>
<a href="#l3.135"></a><span id="l3.135"> </span>
<a href="#l3.136"></a><span id="l3.136">     entry = static_cast&lt;nsLDAPServiceEntry *&gt;(mServers-&gt;Get(&amp;hashKey));</span>
<a href="#l3.137"></a><span id="l3.137">     if (!entry) {</span>
<a href="#l3.138"></a><span id="l3.138" class="difflineat">@@ -417,17 +405,17 @@ NS_IMETHODIMP nsLDAPService::RequestConn</span>
<a href="#l3.139"></a><span id="l3.139">     if (!aListener) {</span>
<a href="#l3.140"></a><span id="l3.140">         NS_ERROR(&quot;nsLDAPService::RequestConection: null pointer &quot;);</span>
<a href="#l3.141"></a><span id="l3.141">         return NS_ERROR_NULL_POINTER;</span>
<a href="#l3.142"></a><span id="l3.142">     }</span>
<a href="#l3.143"></a><span id="l3.143"> </span>
<a href="#l3.144"></a><span id="l3.144">     // Try to find a possibly cached connection and LDAP message.</span>
<a href="#l3.145"></a><span id="l3.145">     //</span>
<a href="#l3.146"></a><span id="l3.146">     {</span>
<a href="#l3.147"></a><span id="l3.147" class="difflineminus">-        nsAutoLock lock(mLock);</span>
<a href="#l3.148"></a><span id="l3.148" class="difflineplus">+        MutexAutoLock lock(mLock);</span>
<a href="#l3.149"></a><span id="l3.149"> </span>
<a href="#l3.150"></a><span id="l3.150">         entry = static_cast&lt;nsLDAPServiceEntry *&gt;(mServers-&gt;Get(&amp;hashKey));</span>
<a href="#l3.151"></a><span id="l3.151">         if (!entry) {</span>
<a href="#l3.152"></a><span id="l3.152">             return NS_ERROR_FAILURE;</span>
<a href="#l3.153"></a><span id="l3.153">         }</span>
<a href="#l3.154"></a><span id="l3.154">         entry-&gt;SetTimestamp();</span>
<a href="#l3.155"></a><span id="l3.155"> </span>
<a href="#l3.156"></a><span id="l3.156">         conn = entry-&gt;GetConnection();</span>
<a href="#l3.157"></a><span id="l3.157" class="difflineat">@@ -450,17 +438,17 @@ NS_IMETHODIMP nsLDAPService::RequestConn</span>
<a href="#l3.158"></a><span id="l3.158">         }</span>
<a href="#l3.159"></a><span id="l3.159"> </span>
<a href="#l3.160"></a><span id="l3.160">     }</span>
<a href="#l3.161"></a><span id="l3.161"> </span>
<a href="#l3.162"></a><span id="l3.162">     // We got a new connection, now push the listeners on our stack,</span>
<a href="#l3.163"></a><span id="l3.163">     // until we get the LDAP message back.</span>
<a href="#l3.164"></a><span id="l3.164">     //</span>
<a href="#l3.165"></a><span id="l3.165">     {</span>
<a href="#l3.166"></a><span id="l3.166" class="difflineminus">-        nsAutoLock lock(mLock);</span>
<a href="#l3.167"></a><span id="l3.167" class="difflineplus">+        MutexAutoLock lock(mLock);</span>
<a href="#l3.168"></a><span id="l3.168">             </span>
<a href="#l3.169"></a><span id="l3.169">         entry = static_cast&lt;nsLDAPServiceEntry *&gt;(mServers-&gt;Get(&amp;hashKey));</span>
<a href="#l3.170"></a><span id="l3.170">         if (!entry ||</span>
<a href="#l3.171"></a><span id="l3.171">             !entry-&gt;PushListener(static_cast&lt;nsILDAPMessageListener *&gt;</span>
<a href="#l3.172"></a><span id="l3.172">                                             (aListener))) {</span>
<a href="#l3.173"></a><span id="l3.173">             return NS_ERROR_FAILURE;</span>
<a href="#l3.174"></a><span id="l3.174">         }</span>
<a href="#l3.175"></a><span id="l3.175">     }</span>
<a href="#l3.176"></a><span id="l3.176" class="difflineat">@@ -469,17 +457,17 @@ NS_IMETHODIMP nsLDAPService::RequestConn</span>
<a href="#l3.177"></a><span id="l3.177"> }</span>
<a href="#l3.178"></a><span id="l3.178"> </span>
<a href="#l3.179"></a><span id="l3.179"> // nsILDAPConnection getConnection (in wstring aKey);</span>
<a href="#l3.180"></a><span id="l3.180"> NS_IMETHODIMP nsLDAPService::GetConnection(const PRUnichar *aKey,</span>
<a href="#l3.181"></a><span id="l3.181">                                            nsILDAPConnection **_retval)</span>
<a href="#l3.182"></a><span id="l3.182"> {</span>
<a href="#l3.183"></a><span id="l3.183">     nsLDAPServiceEntry *entry;</span>
<a href="#l3.184"></a><span id="l3.184">     nsStringKey hashKey(aKey, -1, nsStringKey::NEVER_OWN);</span>
<a href="#l3.185"></a><span id="l3.185" class="difflineminus">-    nsAutoLock lock(mLock);</span>
<a href="#l3.186"></a><span id="l3.186" class="difflineplus">+    MutexAutoLock lock(mLock);</span>
<a href="#l3.187"></a><span id="l3.187"> </span>
<a href="#l3.188"></a><span id="l3.188">     if (!_retval) {</span>
<a href="#l3.189"></a><span id="l3.189">         NS_ERROR(&quot;nsLDAPService::GetConnection: null pointer &quot;);</span>
<a href="#l3.190"></a><span id="l3.190">         return NS_ERROR_NULL_POINTER;</span>
<a href="#l3.191"></a><span id="l3.191">     }</span>
<a href="#l3.192"></a><span id="l3.192"> </span>
<a href="#l3.193"></a><span id="l3.193">     entry = static_cast&lt;nsLDAPServiceEntry *&gt;(mServers-&gt;Get(&amp;hashKey));</span>
<a href="#l3.194"></a><span id="l3.194">     if (!entry) {</span>
<a href="#l3.195"></a><span id="l3.195" class="difflineat">@@ -495,17 +483,17 @@ NS_IMETHODIMP nsLDAPService::GetConnecti</span>
<a href="#l3.196"></a><span id="l3.196">     return NS_OK;</span>
<a href="#l3.197"></a><span id="l3.197"> }</span>
<a href="#l3.198"></a><span id="l3.198"> </span>
<a href="#l3.199"></a><span id="l3.199"> // void releaseConnection (in wstring aKey);</span>
<a href="#l3.200"></a><span id="l3.200"> NS_IMETHODIMP nsLDAPService::ReleaseConnection(const PRUnichar *aKey)</span>
<a href="#l3.201"></a><span id="l3.201"> {</span>
<a href="#l3.202"></a><span id="l3.202">     nsLDAPServiceEntry *entry;</span>
<a href="#l3.203"></a><span id="l3.203">     nsStringKey hashKey(aKey, -1, nsStringKey::NEVER_OWN);</span>
<a href="#l3.204"></a><span id="l3.204" class="difflineminus">-    nsAutoLock lock(mLock);</span>
<a href="#l3.205"></a><span id="l3.205" class="difflineplus">+    MutexAutoLock lock(mLock);</span>
<a href="#l3.206"></a><span id="l3.206"> </span>
<a href="#l3.207"></a><span id="l3.207">     entry = static_cast&lt;nsLDAPServiceEntry *&gt;(mServers-&gt;Get(&amp;hashKey));</span>
<a href="#l3.208"></a><span id="l3.208">     if (!entry) {</span>
<a href="#l3.209"></a><span id="l3.209">         return NS_ERROR_FAILURE;</span>
<a href="#l3.210"></a><span id="l3.210">     }</span>
<a href="#l3.211"></a><span id="l3.211"> </span>
<a href="#l3.212"></a><span id="l3.212">     if (entry-&gt;GetLeases() &gt; 0) {</span>
<a href="#l3.213"></a><span id="l3.213">         entry-&gt;SetTimestamp();</span>
<a href="#l3.214"></a><span id="l3.214" class="difflineat">@@ -528,17 +516,17 @@ NS_IMETHODIMP nsLDAPService::ReconnectCo</span>
<a href="#l3.215"></a><span id="l3.215">     nsStringKey hashKey(aKey, -1, nsStringKey::NEVER_OWN);</span>
<a href="#l3.216"></a><span id="l3.216"> </span>
<a href="#l3.217"></a><span id="l3.217">     if (!aListener) {</span>
<a href="#l3.218"></a><span id="l3.218">         NS_ERROR(&quot;nsLDAPService::ReconnectConnection: null pointer &quot;);</span>
<a href="#l3.219"></a><span id="l3.219">         return NS_ERROR_NULL_POINTER;</span>
<a href="#l3.220"></a><span id="l3.220">     }</span>
<a href="#l3.221"></a><span id="l3.221"> </span>
<a href="#l3.222"></a><span id="l3.222">     {</span>
<a href="#l3.223"></a><span id="l3.223" class="difflineminus">-        nsAutoLock lock(mLock);</span>
<a href="#l3.224"></a><span id="l3.224" class="difflineplus">+        MutexAutoLock lock(mLock);</span>
<a href="#l3.225"></a><span id="l3.225">         </span>
<a href="#l3.226"></a><span id="l3.226">         entry = static_cast&lt;nsLDAPServiceEntry *&gt;(mServers-&gt;Get(&amp;hashKey));</span>
<a href="#l3.227"></a><span id="l3.227">         if (!entry) {</span>
<a href="#l3.228"></a><span id="l3.228">             return NS_ERROR_FAILURE;</span>
<a href="#l3.229"></a><span id="l3.229">         }</span>
<a href="#l3.230"></a><span id="l3.230">         entry-&gt;SetTimestamp();</span>
<a href="#l3.231"></a><span id="l3.231"> </span>
<a href="#l3.232"></a><span id="l3.232">         if (entry-&gt;IsRebinding()) {</span>
<a href="#l3.233"></a><span id="l3.233" class="difflineat">@@ -563,17 +551,17 @@ NS_IMETHODIMP nsLDAPService::ReconnectCo</span>
<a href="#l3.234"></a><span id="l3.234">     }</span>
<a href="#l3.235"></a><span id="l3.235"> </span>
<a href="#l3.236"></a><span id="l3.236">     rv = EstablishConnection(entry, aListener);</span>
<a href="#l3.237"></a><span id="l3.237">     if (NS_FAILED(rv)) {</span>
<a href="#l3.238"></a><span id="l3.238">         return rv;</span>
<a href="#l3.239"></a><span id="l3.239">     }</span>
<a href="#l3.240"></a><span id="l3.240"> </span>
<a href="#l3.241"></a><span id="l3.241">     {</span>
<a href="#l3.242"></a><span id="l3.242" class="difflineminus">-        nsAutoLock lock(mLock);</span>
<a href="#l3.243"></a><span id="l3.243" class="difflineplus">+        MutexAutoLock lock(mLock);</span>
<a href="#l3.244"></a><span id="l3.244">         </span>
<a href="#l3.245"></a><span id="l3.245">         if (!entry-&gt;PushListener(static_cast&lt;nsILDAPMessageListener *&gt;</span>
<a href="#l3.246"></a><span id="l3.246">                                             (aListener))) {</span>
<a href="#l3.247"></a><span id="l3.247">             entry-&gt;SetRebinding(PR_FALSE);</span>
<a href="#l3.248"></a><span id="l3.248">             return NS_ERROR_FAILURE;</span>
<a href="#l3.249"></a><span id="l3.249">         }</span>
<a href="#l3.250"></a><span id="l3.250">     }</span>
<a href="#l3.251"></a><span id="l3.251"> </span>
<a href="#l3.252"></a><span id="l3.252" class="difflineat">@@ -630,17 +618,17 @@ nsLDAPService::OnLDAPMessage(nsILDAPMess</span>
<a href="#l3.253"></a><span id="l3.253">         // server entry in the Service.</span>
<a href="#l3.254"></a><span id="l3.254">         //</span>
<a href="#l3.255"></a><span id="l3.255">         {</span>
<a href="#l3.256"></a><span id="l3.256">             nsCOMPtr&lt;nsILDAPMessageListener&gt; listener;</span>
<a href="#l3.257"></a><span id="l3.257">             nsCOMPtr&lt;nsILDAPMessage&gt; message;</span>
<a href="#l3.258"></a><span id="l3.258">             nsLDAPServiceEntry *entry;</span>
<a href="#l3.259"></a><span id="l3.259">             nsVoidKey connKey(static_cast&lt;nsILDAPConnection *&gt;</span>
<a href="#l3.260"></a><span id="l3.260">                                          (connection));</span>
<a href="#l3.261"></a><span id="l3.261" class="difflineminus">-            nsAutoLock lock(mLock);</span>
<a href="#l3.262"></a><span id="l3.262" class="difflineplus">+            MutexAutoLock lock(mLock);</span>
<a href="#l3.263"></a><span id="l3.263"> </span>
<a href="#l3.264"></a><span id="l3.264">             entry = static_cast&lt;nsLDAPServiceEntry *&gt;</span>
<a href="#l3.265"></a><span id="l3.265">                                (mConnections-&gt;Get(&amp;connKey));</span>
<a href="#l3.266"></a><span id="l3.266">             if (!entry) {</span>
<a href="#l3.267"></a><span id="l3.267">                 return NS_ERROR_FAILURE;</span>
<a href="#l3.268"></a><span id="l3.268">             }</span>
<a href="#l3.269"></a><span id="l3.269"> </span>
<a href="#l3.270"></a><span id="l3.270">             message = entry-&gt;GetMessage();</span>
<a href="#l3.271"></a><span id="l3.271" class="difflineat">@@ -653,19 +641,18 @@ nsLDAPService::OnLDAPMessage(nsILDAPMess</span>
<a href="#l3.272"></a><span id="l3.272">             entry-&gt;SetRebinding(PR_FALSE);</span>
<a href="#l3.273"></a><span id="l3.273">             entry-&gt;SetMessage(aMessage);</span>
<a href="#l3.274"></a><span id="l3.274"> </span>
<a href="#l3.275"></a><span id="l3.275">             // Now process all the pending callbacks/listeners. We</span>
<a href="#l3.276"></a><span id="l3.276">             // have to make sure to unlock before calling a listener,</span>
<a href="#l3.277"></a><span id="l3.277">             // since it's likely to call back into us again.</span>
<a href="#l3.278"></a><span id="l3.278">             //</span>
<a href="#l3.279"></a><span id="l3.279">             while (listener = entry-&gt;PopListener()) {</span>
<a href="#l3.280"></a><span id="l3.280" class="difflineminus">-                lock.unlock();</span>
<a href="#l3.281"></a><span id="l3.281" class="difflineplus">+                MutexAutoUnlock unlock(mLock);</span>
<a href="#l3.282"></a><span id="l3.282">                 listener-&gt;OnLDAPMessage(aMessage);</span>
<a href="#l3.283"></a><span id="l3.283" class="difflineminus">-                lock.lock();</span>
<a href="#l3.284"></a><span id="l3.284">             }</span>
<a href="#l3.285"></a><span id="l3.285">         }</span>
<a href="#l3.286"></a><span id="l3.286">         break;</span>
<a href="#l3.287"></a><span id="l3.287"> </span>
<a href="#l3.288"></a><span id="l3.288">     default:</span>
<a href="#l3.289"></a><span id="l3.289">         NS_WARNING(&quot;nsLDAPService::OnLDAPMessage(): unexpected LDAP message &quot;</span>
<a href="#l3.290"></a><span id="l3.290">                    &quot;received&quot;);</span>
<a href="#l3.291"></a><span id="l3.291"> </span>
<a href="#l3.292"></a><span id="l3.292" class="difflineat">@@ -768,50 +755,50 @@ nsLDAPService::EstablishConnection(nsLDA</span>
<a href="#l3.293"></a><span id="l3.293"> </span>
<a href="#l3.294"></a><span id="l3.294">     // Try to detect a collision, i.e. someone established a connection</span>
<a href="#l3.295"></a><span id="l3.295">     // just before we did. If so, we drop ours. This code is somewhat</span>
<a href="#l3.296"></a><span id="l3.296">     // similar to what happens in RequestConnection(), i.e. we try to</span>
<a href="#l3.297"></a><span id="l3.297">     // call the listener directly if possible, and if not, push it on</span>
<a href="#l3.298"></a><span id="l3.298">     // the stack of pending requests.</span>
<a href="#l3.299"></a><span id="l3.299">     //</span>
<a href="#l3.300"></a><span id="l3.300">     {</span>
<a href="#l3.301"></a><span id="l3.301" class="difflineminus">-        nsAutoLock lock(mLock);</span>
<a href="#l3.302"></a><span id="l3.302" class="difflineplus">+        MutexAutoLock lock(mLock);</span>
<a href="#l3.303"></a><span id="l3.303"> </span>
<a href="#l3.304"></a><span id="l3.304">         conn2 = aEntry-&gt;GetConnection();</span>
<a href="#l3.305"></a><span id="l3.305">         message = aEntry-&gt;GetMessage();</span>
<a href="#l3.306"></a><span id="l3.306">     }</span>
<a href="#l3.307"></a><span id="l3.307"> </span>
<a href="#l3.308"></a><span id="l3.308">     if (conn2) {</span>
<a href="#l3.309"></a><span id="l3.309">         // Drop the new connection, we can't use it.</span>
<a href="#l3.310"></a><span id="l3.310">         //</span>
<a href="#l3.311"></a><span id="l3.311">         conn = 0;</span>
<a href="#l3.312"></a><span id="l3.312">         if (message) {</span>
<a href="#l3.313"></a><span id="l3.313">             aListener-&gt;OnLDAPMessage(message);</span>
<a href="#l3.314"></a><span id="l3.314">             return NS_OK;</span>
<a href="#l3.315"></a><span id="l3.315">         }</span>
<a href="#l3.316"></a><span id="l3.316"> </span>
<a href="#l3.317"></a><span id="l3.317">         {</span>
<a href="#l3.318"></a><span id="l3.318" class="difflineminus">-            nsAutoLock lock(mLock);</span>
<a href="#l3.319"></a><span id="l3.319" class="difflineplus">+            MutexAutoLock lock(mLock);</span>
<a href="#l3.320"></a><span id="l3.320"> </span>
<a href="#l3.321"></a><span id="l3.321">             if (!aEntry-&gt;PushListener(static_cast&lt;nsILDAPMessageListener *&gt;</span>
<a href="#l3.322"></a><span id="l3.322">                                                  (aListener))) {</span>
<a href="#l3.323"></a><span id="l3.323">                 return NS_ERROR_FAILURE;</span>
<a href="#l3.324"></a><span id="l3.324">             }</span>
<a href="#l3.325"></a><span id="l3.325">         }</span>
<a href="#l3.326"></a><span id="l3.326"> </span>
<a href="#l3.327"></a><span id="l3.327">         return NS_OK;</span>
<a href="#l3.328"></a><span id="l3.328">     }</span>
<a href="#l3.329"></a><span id="l3.329"> </span>
<a href="#l3.330"></a><span id="l3.330">     // We made the connection, lets store it to the server entry,</span>
<a href="#l3.331"></a><span id="l3.331">     // and also update the reverse lookup tables (for finding the</span>
<a href="#l3.332"></a><span id="l3.332">     // server entry related to a particular connection).</span>
<a href="#l3.333"></a><span id="l3.333">     //</span>
<a href="#l3.334"></a><span id="l3.334">     {</span>
<a href="#l3.335"></a><span id="l3.335">         nsVoidKey connKey(static_cast&lt;nsILDAPConnection *&gt;(conn));</span>
<a href="#l3.336"></a><span id="l3.336" class="difflineminus">-        nsAutoLock lock(mLock);</span>
<a href="#l3.337"></a><span id="l3.337" class="difflineplus">+        MutexAutoLock lock(mLock);</span>
<a href="#l3.338"></a><span id="l3.338"> </span>
<a href="#l3.339"></a><span id="l3.339">         aEntry-&gt;SetConnection(conn);</span>
<a href="#l3.340"></a><span id="l3.340">         mConnections-&gt;Put(&amp;connKey, aEntry);</span>
<a href="#l3.341"></a><span id="l3.341">     }</span>
<a href="#l3.342"></a><span id="l3.342"> </span>
<a href="#l3.343"></a><span id="l3.343">     // Setup the bind() operation.</span>
<a href="#l3.344"></a><span id="l3.344">     //</span>
<a href="#l3.345"></a><span id="l3.345">     operation = do_CreateInstance(kLDAPOperationCID, &amp;rv);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/ldap/xpcom/src/nsLDAPService.h</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/ldap/xpcom/src/nsLDAPService.h</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -43,17 +43,17 @@</span>
<a href="#l4.4"></a><span id="l4.4"> #include &quot;nsHashtable.h&quot;</span>
<a href="#l4.5"></a><span id="l4.5"> #include &quot;nsILDAPService.h&quot;</span>
<a href="#l4.6"></a><span id="l4.6"> #include &quot;nsILDAPMessage.h&quot;</span>
<a href="#l4.7"></a><span id="l4.7"> #include &quot;nsILDAPMessageListener.h&quot;</span>
<a href="#l4.8"></a><span id="l4.8"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l4.9"></a><span id="l4.9"> #include &quot;nsILDAPServer.h&quot;</span>
<a href="#l4.10"></a><span id="l4.10"> #include &quot;nsILDAPConnection.h&quot;</span>
<a href="#l4.11"></a><span id="l4.11"> #include &quot;nsILDAPMessage.h&quot;</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+#include &quot;mozilla/Mutex.h&quot;</span>
<a href="#l4.14"></a><span id="l4.14"> </span>
<a href="#l4.15"></a><span id="l4.15"> // 6a89ae33-7a90-430d-888c-0dede53a951a </span>
<a href="#l4.16"></a><span id="l4.16"> //</span>
<a href="#l4.17"></a><span id="l4.17"> #define NS_LDAPSERVICE_CID \</span>
<a href="#l4.18"></a><span id="l4.18"> { \</span>
<a href="#l4.19"></a><span id="l4.19">   0x6a89ae33, 0x7a90, 0x430d, \</span>
<a href="#l4.20"></a><span id="l4.20">   {0x88, 0x8c, 0x0d, 0xed, 0xe5, 0x3a, 0x95, 0x1a} \</span>
<a href="#l4.21"></a><span id="l4.21"> }</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineat">@@ -137,13 +137,13 @@ class nsLDAPService : public nsILDAPServ</span>
<a href="#l4.23"></a><span id="l4.23">     // count how many tokens are in this string; for use by</span>
<a href="#l4.24"></a><span id="l4.24">     // createFilter; note that unlike with NextToken, these params</span>
<a href="#l4.25"></a><span id="l4.25">     // are copies, not references.</span>
<a href="#l4.26"></a><span id="l4.26">     //</span>
<a href="#l4.27"></a><span id="l4.27">     PRUint32 CountTokens(nsReadingIterator&lt;char&gt; aIter,</span>
<a href="#l4.28"></a><span id="l4.28">                          nsReadingIterator&lt;char&gt; aIterEnd);</span>
<a href="#l4.29"></a><span id="l4.29">                    </span>
<a href="#l4.30"></a><span id="l4.30">     </span>
<a href="#l4.31"></a><span id="l4.31" class="difflineminus">-    PRLock *mLock;              // Lock mechanism</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+    mozilla::Mutex mLock;       // Lock mechanism</span>
<a href="#l4.33"></a><span id="l4.33">     nsHashtable *mServers;      // Hash table holding server entries</span>
<a href="#l4.34"></a><span id="l4.34">     nsHashtable *mConnections;  // Hash table holding &quot;reverse&quot;</span>
<a href="#l4.35"></a><span id="l4.35">                                 // lookups from connection to server</span>
<a href="#l4.36"></a><span id="l4.36"> };</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

