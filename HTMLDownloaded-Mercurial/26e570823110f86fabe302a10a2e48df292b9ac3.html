<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 254:26e570823110f86fabe302a10a2e48df292b9ac3</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 26e570823110f86fabe302a10a2e48df292b9ac3" />
<meta property="og:url" content="/comm-central/rev/26e570823110f86fabe302a10a2e48df292b9ac3" />
<meta property="og:description" content="Bug 441050 - Kill winhooks UI, create something better, r=Neil" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 26e570823110f86fabe302a10a2e48df292b9ac3 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/26e570823110f86fabe302a10a2e48df292b9ac3">shortlog</a> |
<a href="/comm-central/log/26e570823110f86fabe302a10a2e48df292b9ac3">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/26e570823110f86fabe302a10a2e48df292b9ac3">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/26e570823110f86fabe302a10a2e48df292b9ac3">files</a> |
changeset |
<a href="/comm-central/raw-rev/26e570823110f86fabe302a10a2e48df292b9ac3">raw</a>  | <a href="/comm-central/archive/26e570823110f86fabe302a10a2e48df292b9ac3.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=441050">Bug 441050</a> - Kill winhooks UI, create something better, r=Neil
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#70;&#114;&#97;&#110;&#107;&#32;&#87;&#101;&#105;&#110;&#32;&#60;&#109;&#99;&#115;&#109;&#117;&#114;&#102;&#64;&#109;&#99;&#115;&#109;&#117;&#114;&#102;&#46;&#100;&#101;&#62;</td></tr>
<tr><td></td><td class="date age">Wed, 03 Sep 2008 23:57:29 +0200</td></tr>

<tr>
 <td>changeset 254</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/26e570823110f86fabe302a10a2e48df292b9ac3">26e570823110f86fabe302a10a2e48df292b9ac3</a></td>
</tr>



<tr>
<td>parent 253</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/e8fdf415c5710e10b4c0c11aab206f06a6c707da">e8fdf415c5710e10b4c0c11aab206f06a6c707da</a>
</td>
</tr>

<tr>
<td>child 255</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/bd65ac0df8c2379e5bf38c6091b5f1afe72edf66">bd65ac0df8c2379e5bf38c6091b5f1afe72edf66</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=26e570823110f86fabe302a10a2e48df292b9ac3">226</a></td></tr>
<tr><td>push user</td><td>mcsmurf@mcsmurf.de</td></tr>
<tr><td>push date</td><td class="date age">Thu, 04 Sep 2008 00:20:05 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@26e570823110 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=26e570823110f86fabe302a10a2e48df292b9ac3">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=26e570823110f86fabe302a10a2e48df292b9ac3&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=26e570823110f86fabe302a10a2e48df292b9ac3&newProject=comm-central&newRevision=26e570823110f86fabe302a10a2e48df292b9ac3&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=26e570823110f86fabe302a10a2e48df292b9ac3&newProject=comm-central&newRevision=26e570823110f86fabe302a10a2e48df292b9ac3&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=26e570823110f86fabe302a10a2e48df292b9ac3&newProject=comm-central&newRevision=26e570823110f86fabe302a10a2e48df292b9ac3&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28Neil%29&revcount=50">Neil</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=441050">441050</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=441050">Bug 441050</a> - Kill winhooks UI, create something better, r=Neil</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/26e570823110f86fabe302a10a2e48df292b9ac3/mailnews/base/prefs/resources/content/accountUtils.js">mailnews/base/prefs/resources/content/accountUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/26e570823110f86fabe302a10a2e48df292b9ac3/mailnews/base/prefs/resources/content/accountUtils.js">file</a> |
<a href="/comm-central/annotate/26e570823110f86fabe302a10a2e48df292b9ac3/mailnews/base/prefs/resources/content/accountUtils.js">annotate</a> |
<a href="/comm-central/diff/26e570823110f86fabe302a10a2e48df292b9ac3/mailnews/base/prefs/resources/content/accountUtils.js">diff</a> |
<a href="/comm-central/comparison/26e570823110f86fabe302a10a2e48df292b9ac3/mailnews/base/prefs/resources/content/accountUtils.js">comparison</a> |
<a href="/comm-central/log/26e570823110f86fabe302a10a2e48df292b9ac3/mailnews/base/prefs/resources/content/accountUtils.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/26e570823110f86fabe302a10a2e48df292b9ac3/mailnews/base/prefs/resources/content/pref-mailnews.js">mailnews/base/prefs/resources/content/pref-mailnews.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/26e570823110f86fabe302a10a2e48df292b9ac3/mailnews/base/prefs/resources/content/pref-mailnews.js">file</a> |
<a href="/comm-central/annotate/26e570823110f86fabe302a10a2e48df292b9ac3/mailnews/base/prefs/resources/content/pref-mailnews.js">annotate</a> |
<a href="/comm-central/diff/26e570823110f86fabe302a10a2e48df292b9ac3/mailnews/base/prefs/resources/content/pref-mailnews.js">diff</a> |
<a href="/comm-central/comparison/26e570823110f86fabe302a10a2e48df292b9ac3/mailnews/base/prefs/resources/content/pref-mailnews.js">comparison</a> |
<a href="/comm-central/log/26e570823110f86fabe302a10a2e48df292b9ac3/mailnews/base/prefs/resources/content/pref-mailnews.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/26e570823110f86fabe302a10a2e48df292b9ac3/mailnews/base/prefs/resources/content/pref-mailnews.xul">mailnews/base/prefs/resources/content/pref-mailnews.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/26e570823110f86fabe302a10a2e48df292b9ac3/mailnews/base/prefs/resources/content/pref-mailnews.xul">file</a> |
<a href="/comm-central/annotate/26e570823110f86fabe302a10a2e48df292b9ac3/mailnews/base/prefs/resources/content/pref-mailnews.xul">annotate</a> |
<a href="/comm-central/diff/26e570823110f86fabe302a10a2e48df292b9ac3/mailnews/base/prefs/resources/content/pref-mailnews.xul">diff</a> |
<a href="/comm-central/comparison/26e570823110f86fabe302a10a2e48df292b9ac3/mailnews/base/prefs/resources/content/pref-mailnews.xul">comparison</a> |
<a href="/comm-central/log/26e570823110f86fabe302a10a2e48df292b9ac3/mailnews/base/prefs/resources/content/pref-mailnews.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/26e570823110f86fabe302a10a2e48df292b9ac3/mailnews/mapi/mapihook/src/Makefile.in">mailnews/mapi/mapihook/src/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/26e570823110f86fabe302a10a2e48df292b9ac3/mailnews/mapi/mapihook/src/Makefile.in">file</a> |
<a href="/comm-central/annotate/26e570823110f86fabe302a10a2e48df292b9ac3/mailnews/mapi/mapihook/src/Makefile.in">annotate</a> |
<a href="/comm-central/diff/26e570823110f86fabe302a10a2e48df292b9ac3/mailnews/mapi/mapihook/src/Makefile.in">diff</a> |
<a href="/comm-central/comparison/26e570823110f86fabe302a10a2e48df292b9ac3/mailnews/mapi/mapihook/src/Makefile.in">comparison</a> |
<a href="/comm-central/log/26e570823110f86fabe302a10a2e48df292b9ac3/mailnews/mapi/mapihook/src/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/26e570823110f86fabe302a10a2e48df292b9ac3/mailnews/mapi/mapihook/src/msgMapiSupport.cpp">mailnews/mapi/mapihook/src/msgMapiSupport.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/26e570823110f86fabe302a10a2e48df292b9ac3/mailnews/mapi/mapihook/src/msgMapiSupport.cpp">file</a> |
<a href="/comm-central/annotate/26e570823110f86fabe302a10a2e48df292b9ac3/mailnews/mapi/mapihook/src/msgMapiSupport.cpp">annotate</a> |
<a href="/comm-central/diff/26e570823110f86fabe302a10a2e48df292b9ac3/mailnews/mapi/mapihook/src/msgMapiSupport.cpp">diff</a> |
<a href="/comm-central/comparison/26e570823110f86fabe302a10a2e48df292b9ac3/mailnews/mapi/mapihook/src/msgMapiSupport.cpp">comparison</a> |
<a href="/comm-central/log/26e570823110f86fabe302a10a2e48df292b9ac3/mailnews/mapi/mapihook/src/msgMapiSupport.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/26e570823110f86fabe302a10a2e48df292b9ac3/mailnews/mapi/mapihook/src/nsMapiRegistry.cpp">mailnews/mapi/mapihook/src/nsMapiRegistry.cpp</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/26e570823110f86fabe302a10a2e48df292b9ac3/mailnews/mapi/mapihook/src/nsMapiRegistry.cpp">diff</a> |
<a href="/comm-central/comparison/26e570823110f86fabe302a10a2e48df292b9ac3/mailnews/mapi/mapihook/src/nsMapiRegistry.cpp">comparison</a> |
<a href="/comm-central/log/26e570823110f86fabe302a10a2e48df292b9ac3/mailnews/mapi/mapihook/src/nsMapiRegistry.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/26e570823110f86fabe302a10a2e48df292b9ac3/mailnews/mapi/mapihook/src/nsMapiRegistry.h">mailnews/mapi/mapihook/src/nsMapiRegistry.h</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/26e570823110f86fabe302a10a2e48df292b9ac3/mailnews/mapi/mapihook/src/nsMapiRegistry.h">diff</a> |
<a href="/comm-central/comparison/26e570823110f86fabe302a10a2e48df292b9ac3/mailnews/mapi/mapihook/src/nsMapiRegistry.h">comparison</a> |
<a href="/comm-central/log/26e570823110f86fabe302a10a2e48df292b9ac3/mailnews/mapi/mapihook/src/nsMapiRegistry.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/26e570823110f86fabe302a10a2e48df292b9ac3/mailnews/mapi/mapihook/src/nsMapiRegistryUtils.cpp">mailnews/mapi/mapihook/src/nsMapiRegistryUtils.cpp</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/26e570823110f86fabe302a10a2e48df292b9ac3/mailnews/mapi/mapihook/src/nsMapiRegistryUtils.cpp">diff</a> |
<a href="/comm-central/comparison/26e570823110f86fabe302a10a2e48df292b9ac3/mailnews/mapi/mapihook/src/nsMapiRegistryUtils.cpp">comparison</a> |
<a href="/comm-central/log/26e570823110f86fabe302a10a2e48df292b9ac3/mailnews/mapi/mapihook/src/nsMapiRegistryUtils.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/26e570823110f86fabe302a10a2e48df292b9ac3/mailnews/mapi/mapihook/src/nsMapiRegistryUtils.h">mailnews/mapi/mapihook/src/nsMapiRegistryUtils.h</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/26e570823110f86fabe302a10a2e48df292b9ac3/mailnews/mapi/mapihook/src/nsMapiRegistryUtils.h">diff</a> |
<a href="/comm-central/comparison/26e570823110f86fabe302a10a2e48df292b9ac3/mailnews/mapi/mapihook/src/nsMapiRegistryUtils.h">comparison</a> |
<a href="/comm-central/log/26e570823110f86fabe302a10a2e48df292b9ac3/mailnews/mapi/mapihook/src/nsMapiRegistryUtils.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/26e570823110f86fabe302a10a2e48df292b9ac3/suite/browser/navigator.js">suite/browser/navigator.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/26e570823110f86fabe302a10a2e48df292b9ac3/suite/browser/navigator.js">file</a> |
<a href="/comm-central/annotate/26e570823110f86fabe302a10a2e48df292b9ac3/suite/browser/navigator.js">annotate</a> |
<a href="/comm-central/diff/26e570823110f86fabe302a10a2e48df292b9ac3/suite/browser/navigator.js">diff</a> |
<a href="/comm-central/comparison/26e570823110f86fabe302a10a2e48df292b9ac3/suite/browser/navigator.js">comparison</a> |
<a href="/comm-central/log/26e570823110f86fabe302a10a2e48df292b9ac3/suite/browser/navigator.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/26e570823110f86fabe302a10a2e48df292b9ac3/suite/common/defaultClientDialog.js">suite/common/defaultClientDialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/26e570823110f86fabe302a10a2e48df292b9ac3/suite/common/defaultClientDialog.js">file</a> |
<a href="/comm-central/annotate/26e570823110f86fabe302a10a2e48df292b9ac3/suite/common/defaultClientDialog.js">annotate</a> |
<a href="/comm-central/diff/26e570823110f86fabe302a10a2e48df292b9ac3/suite/common/defaultClientDialog.js">diff</a> |
<a href="/comm-central/comparison/26e570823110f86fabe302a10a2e48df292b9ac3/suite/common/defaultClientDialog.js">comparison</a> |
<a href="/comm-central/log/26e570823110f86fabe302a10a2e48df292b9ac3/suite/common/defaultClientDialog.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/26e570823110f86fabe302a10a2e48df292b9ac3/suite/common/defaultClientDialog.xul">suite/common/defaultClientDialog.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/26e570823110f86fabe302a10a2e48df292b9ac3/suite/common/defaultClientDialog.xul">file</a> |
<a href="/comm-central/annotate/26e570823110f86fabe302a10a2e48df292b9ac3/suite/common/defaultClientDialog.xul">annotate</a> |
<a href="/comm-central/diff/26e570823110f86fabe302a10a2e48df292b9ac3/suite/common/defaultClientDialog.xul">diff</a> |
<a href="/comm-central/comparison/26e570823110f86fabe302a10a2e48df292b9ac3/suite/common/defaultClientDialog.xul">comparison</a> |
<a href="/comm-central/log/26e570823110f86fabe302a10a2e48df292b9ac3/suite/common/defaultClientDialog.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/26e570823110f86fabe302a10a2e48df292b9ac3/suite/common/jar.mn">suite/common/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/26e570823110f86fabe302a10a2e48df292b9ac3/suite/common/jar.mn">file</a> |
<a href="/comm-central/annotate/26e570823110f86fabe302a10a2e48df292b9ac3/suite/common/jar.mn">annotate</a> |
<a href="/comm-central/diff/26e570823110f86fabe302a10a2e48df292b9ac3/suite/common/jar.mn">diff</a> |
<a href="/comm-central/comparison/26e570823110f86fabe302a10a2e48df292b9ac3/suite/common/jar.mn">comparison</a> |
<a href="/comm-central/log/26e570823110f86fabe302a10a2e48df292b9ac3/suite/common/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/26e570823110f86fabe302a10a2e48df292b9ac3/suite/common/pref/pref-advanced.xul">suite/common/pref/pref-advanced.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/26e570823110f86fabe302a10a2e48df292b9ac3/suite/common/pref/pref-advanced.xul">file</a> |
<a href="/comm-central/annotate/26e570823110f86fabe302a10a2e48df292b9ac3/suite/common/pref/pref-advanced.xul">annotate</a> |
<a href="/comm-central/diff/26e570823110f86fabe302a10a2e48df292b9ac3/suite/common/pref/pref-advanced.xul">diff</a> |
<a href="/comm-central/comparison/26e570823110f86fabe302a10a2e48df292b9ac3/suite/common/pref/pref-advanced.xul">comparison</a> |
<a href="/comm-central/log/26e570823110f86fabe302a10a2e48df292b9ac3/suite/common/pref/pref-advanced.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/26e570823110f86fabe302a10a2e48df292b9ac3/suite/common/pref/pref-navigator.js">suite/common/pref/pref-navigator.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/26e570823110f86fabe302a10a2e48df292b9ac3/suite/common/pref/pref-navigator.js">file</a> |
<a href="/comm-central/annotate/26e570823110f86fabe302a10a2e48df292b9ac3/suite/common/pref/pref-navigator.js">annotate</a> |
<a href="/comm-central/diff/26e570823110f86fabe302a10a2e48df292b9ac3/suite/common/pref/pref-navigator.js">diff</a> |
<a href="/comm-central/comparison/26e570823110f86fabe302a10a2e48df292b9ac3/suite/common/pref/pref-navigator.js">comparison</a> |
<a href="/comm-central/log/26e570823110f86fabe302a10a2e48df292b9ac3/suite/common/pref/pref-navigator.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/26e570823110f86fabe302a10a2e48df292b9ac3/suite/locales/en-US/chrome/common/defaultClientDialog.dtd">suite/locales/en-US/chrome/common/defaultClientDialog.dtd</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/26e570823110f86fabe302a10a2e48df292b9ac3/suite/locales/en-US/chrome/common/defaultClientDialog.dtd">file</a> |
<a href="/comm-central/annotate/26e570823110f86fabe302a10a2e48df292b9ac3/suite/locales/en-US/chrome/common/defaultClientDialog.dtd">annotate</a> |
<a href="/comm-central/diff/26e570823110f86fabe302a10a2e48df292b9ac3/suite/locales/en-US/chrome/common/defaultClientDialog.dtd">diff</a> |
<a href="/comm-central/comparison/26e570823110f86fabe302a10a2e48df292b9ac3/suite/locales/en-US/chrome/common/defaultClientDialog.dtd">comparison</a> |
<a href="/comm-central/log/26e570823110f86fabe302a10a2e48df292b9ac3/suite/locales/en-US/chrome/common/defaultClientDialog.dtd">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/26e570823110f86fabe302a10a2e48df292b9ac3/suite/locales/en-US/chrome/common/pref/pref-advanced.dtd">suite/locales/en-US/chrome/common/pref/pref-advanced.dtd</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/26e570823110f86fabe302a10a2e48df292b9ac3/suite/locales/en-US/chrome/common/pref/pref-advanced.dtd">file</a> |
<a href="/comm-central/annotate/26e570823110f86fabe302a10a2e48df292b9ac3/suite/locales/en-US/chrome/common/pref/pref-advanced.dtd">annotate</a> |
<a href="/comm-central/diff/26e570823110f86fabe302a10a2e48df292b9ac3/suite/locales/en-US/chrome/common/pref/pref-advanced.dtd">diff</a> |
<a href="/comm-central/comparison/26e570823110f86fabe302a10a2e48df292b9ac3/suite/locales/en-US/chrome/common/pref/pref-advanced.dtd">comparison</a> |
<a href="/comm-central/log/26e570823110f86fabe302a10a2e48df292b9ac3/suite/locales/en-US/chrome/common/pref/pref-advanced.dtd">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/26e570823110f86fabe302a10a2e48df292b9ac3/suite/locales/jar.mn">suite/locales/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/26e570823110f86fabe302a10a2e48df292b9ac3/suite/locales/jar.mn">file</a> |
<a href="/comm-central/annotate/26e570823110f86fabe302a10a2e48df292b9ac3/suite/locales/jar.mn">annotate</a> |
<a href="/comm-central/diff/26e570823110f86fabe302a10a2e48df292b9ac3/suite/locales/jar.mn">diff</a> |
<a href="/comm-central/comparison/26e570823110f86fabe302a10a2e48df292b9ac3/suite/locales/jar.mn">comparison</a> |
<a href="/comm-central/log/26e570823110f86fabe302a10a2e48df292b9ac3/suite/locales/jar.mn">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/base/prefs/resources/content/accountUtils.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/base/prefs/resources/content/accountUtils.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -71,58 +71,35 @@ function getInvalidAccounts(accounts)</span>
<a href="#l1.4"></a><span id="l1.4">             else {</span>
<a href="#l1.5"></a><span id="l1.5">               invalidAccounts[invalidAccounts.length] = account;</span>
<a href="#l1.6"></a><span id="l1.6">             }</span>
<a href="#l1.7"></a><span id="l1.7">         }</span>
<a href="#l1.8"></a><span id="l1.8">     }</span>
<a href="#l1.9"></a><span id="l1.9">     return invalidAccounts;</span>
<a href="#l1.10"></a><span id="l1.10"> }</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-// This function gets called from verifyAccounts.</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-// We do not have to do anything on</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-// unix and mac but on windows we have to bring up a </span>
<a href="#l1.15"></a><span id="l1.15" class="difflineminus">-// dialog based on the settings the user has.</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineminus">-// This will bring up the dialog only once per session and only if we</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineminus">-// are not the default mail client.</span>
<a href="#l1.18"></a><span id="l1.18"> function showMailIntegrationDialog() {</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineminus">-    var mapiRegistry = null;</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineminus">-    try {</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineminus">-        var mapiRegistryProgID = &quot;@mozilla.org/mapiregistry;1&quot; </span>
<a href="#l1.22"></a><span id="l1.22" class="difflineminus">-        if (mapiRegistryProgID in Components.classes) {</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineminus">-          mapiRegistry = Components.classes[mapiRegistryProgID].getService(Components.interfaces.nsIMapiRegistry);</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineminus">-        }</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineminus">-    }</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineminus">-    catch (ex) { </span>
<a href="#l1.27"></a><span id="l1.27" class="difflineminus">-    }</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineplus">+  const nsIShellService = Components.interfaces.nsIShellService;</span>
<a href="#l1.29"></a><span id="l1.29"> </span>
<a href="#l1.30"></a><span id="l1.30" class="difflineminus">-    // showDialog is TRUE only if we did not bring up this dialog already</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-    // and we are not the default mail client</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineminus">-    var prefLocked = false;</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineminus">-    if (mapiRegistry &amp;&amp; mapiRegistry.showDialog) {</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineminus">-        const prefbase = &quot;system.windows.lock_ui.&quot;;</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineminus">-        try {</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineminus">-            var prefService = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineminus">-                          .getService()</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineminus">-                          .QueryInterface(Components.interfaces.nsIPrefService);</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineminus">-            var prefBranch = prefService.getBranch(prefbase);</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineminus">-        </span>
<a href="#l1.41"></a><span id="l1.41" class="difflineminus">-            if (prefBranch &amp;&amp; prefBranch.prefIsLocked(&quot;defaultMailClient&quot;)) {</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineminus">-                prefLocked = true;</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineminus">-                mapiRegistry.isDefaultMailClient = prefBranch.getBoolPref(&quot;defaultMailClient&quot;) ;</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineminus">-            }</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineminus">-        }</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineminus">-        catch (ex) {}</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineminus">-        try {</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineminus">-          if (!prefLocked)</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineminus">-            mapiRegistry.showMailIntegrationDialog(window /* parent window */);</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineminus">-        }</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineminus">-        catch (ex) {</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineminus">-          dump(&quot;mapi code failed:  &quot; + ex + &quot;\n&quot;);</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineminus">-        }</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineminus">-    }</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineplus">+  try {</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineplus">+    var shellService = Components.classes[&quot;@mozilla.org/suite/shell-service;1&quot;]</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineplus">+                                 .getService(nsIShellService);</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineplus">+    var accountManager = Components.classes[accountManagerContractID].getService(Components.interfaces.nsIMsgAccountManager);</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineplus">+    var defaultAccount = accountManager.defaultAccount;</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineplus">+    var appTypesCheck = shellService.shouldBeDefaultClientFor &amp;</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineplus">+                        (nsIShellService.MAIL | nsIShellService.NEWS);</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineplus">+</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineplus">+    // show the default client dialog only if we have at least one account,</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineplus">+    // if we should check for the default client, and we want to check if we are </span>
<a href="#l1.65"></a><span id="l1.65" class="difflineplus">+    // the default for mail/news and are not the default client for mail/news</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineplus">+    if (appTypesCheck &amp;&amp; shellService.shouldCheckDefaultClient &amp;&amp;</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineplus">+        !shellService.isDefaultClient(true, appTypesCheck))</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineplus">+        window.openDialog(&quot;chrome://communicator/content/defaultClientDialog.xul&quot;,</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineplus">+                        &quot;DefaultClient&quot;, &quot;modal,centerscreen,chrome,resizable=no&quot;);</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineplus">+  } catch (ex) {}</span>
<a href="#l1.71"></a><span id="l1.71"> }</span>
<a href="#l1.72"></a><span id="l1.72"> </span>
<a href="#l1.73"></a><span id="l1.73"> function verifyAccounts(wizardCallback) </span>
<a href="#l1.74"></a><span id="l1.74"> {</span>
<a href="#l1.75"></a><span id="l1.75"> 	var openWizard = false;</span>
<a href="#l1.76"></a><span id="l1.76">   var prefillAccount;</span>
<a href="#l1.77"></a><span id="l1.77"> 	var state=true;</span>
<a href="#l1.78"></a><span id="l1.78"> 	var ret = true;</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineat">@@ -190,25 +167,24 @@ function verifyAccounts(wizardCallback)</span>
<a href="#l1.80"></a><span id="l1.80">           {</span>
<a href="#l1.81"></a><span id="l1.81">             localFoldersExists = false;</span>
<a href="#l1.82"></a><span id="l1.82">           }</span>
<a href="#l1.83"></a><span id="l1.83"> </span>
<a href="#l1.84"></a><span id="l1.84">           // we didn't create the MsgAccountWizard - we need to verify that local folders exists.</span>
<a href="#l1.85"></a><span id="l1.85">           if (!localFoldersExists)</span>
<a href="#l1.86"></a><span id="l1.86">             am.createLocalMailAccount();</span>
<a href="#l1.87"></a><span id="l1.87">         }</span>
<a href="#l1.88"></a><span id="l1.88" class="difflineminus">-        </span>
<a href="#l1.89"></a><span id="l1.89" class="difflineminus">-        // This will only succeed on SeaMonkey windows builds</span>
<a href="#l1.90"></a><span id="l1.90" class="difflineminus">-        var mapiRegistryProgID = &quot;@mozilla.org/mapiregistry;1&quot; </span>
<a href="#l1.91"></a><span id="l1.91" class="difflineminus">-        if (mapiRegistryProgID in Components.classes)</span>
<a href="#l1.92"></a><span id="l1.92" class="difflineplus">+</span>
<a href="#l1.93"></a><span id="l1.93" class="difflineplus">+        // This will do nothing on platforms without a shell service</span>
<a href="#l1.94"></a><span id="l1.94" class="difflineplus">+        const NS_SHELLSERVICE_CID = &quot;@mozilla.org/suite/shell-service;1&quot;</span>
<a href="#l1.95"></a><span id="l1.95" class="difflineplus">+        if (NS_SHELLSERVICE_CID in Components.classes)</span>
<a href="#l1.96"></a><span id="l1.96">         {</span>
<a href="#l1.97"></a><span id="l1.97">           // hack, set a time out to do this, so that the window can load first</span>
<a href="#l1.98"></a><span id="l1.98">           setTimeout(showMailIntegrationDialog, 0);</span>
<a href="#l1.99"></a><span id="l1.99">         }</span>
<a href="#l1.100"></a><span id="l1.100" class="difflineminus">-</span>
<a href="#l1.101"></a><span id="l1.101">         return ret;</span>
<a href="#l1.102"></a><span id="l1.102">     }</span>
<a href="#l1.103"></a><span id="l1.103">     catch (ex) {</span>
<a href="#l1.104"></a><span id="l1.104">         dump(&quot;error verifying accounts &quot; + ex + &quot;\n&quot;);</span>
<a href="#l1.105"></a><span id="l1.105">         return false;</span>
<a href="#l1.106"></a><span id="l1.106">     }</span>
<a href="#l1.107"></a><span id="l1.107"> }</span>
<a href="#l1.108"></a><span id="l1.108"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/base/prefs/resources/content/pref-mailnews.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/base/prefs/resources/content/pref-mailnews.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -15,38 +15,38 @@</span>
<a href="#l2.4"></a><span id="l2.4">  * The Original Code is mozilla.org code.</span>
<a href="#l2.5"></a><span id="l2.5">  *</span>
<a href="#l2.6"></a><span id="l2.6">  * The Initial Developer of the Original Code is</span>
<a href="#l2.7"></a><span id="l2.7">  * Mark Banner &lt;bugzilla@standard8.plus.com&gt;</span>
<a href="#l2.8"></a><span id="l2.8">  * Portions created by the Initial Developer are Copyright (C) 2007</span>
<a href="#l2.9"></a><span id="l2.9">  * the Initial Developer. All Rights Reserved.</span>
<a href="#l2.10"></a><span id="l2.10">  *</span>
<a href="#l2.11"></a><span id="l2.11">  * Contributor(s):</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+ *   Frank Wein &lt;mcsmurf@mcsmurf.de&gt;</span>
<a href="#l2.13"></a><span id="l2.13">  *</span>
<a href="#l2.14"></a><span id="l2.14">  * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l2.15"></a><span id="l2.15">  * either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l2.16"></a><span id="l2.16">  * or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l2.17"></a><span id="l2.17">  * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l2.18"></a><span id="l2.18">  * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l2.19"></a><span id="l2.19">  * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l2.20"></a><span id="l2.20">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l2.21"></a><span id="l2.21">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l2.22"></a><span id="l2.22">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l2.23"></a><span id="l2.23">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l2.24"></a><span id="l2.24">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l2.25"></a><span id="l2.25">  *</span>
<a href="#l2.26"></a><span id="l2.26">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l2.27"></a><span id="l2.27"> </span>
<a href="#l2.28"></a><span id="l2.28" class="difflineminus">-if (&quot;@mozilla.org/browser/shell-service;1&quot; in Components.classes)</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineplus">+if (&quot;@mozilla.org/suite/shell-service;1&quot; in Components.classes)</span>
<a href="#l2.30"></a><span id="l2.30">   const nsIShellService = Components.interfaces.nsIShellService;</span>
<a href="#l2.31"></a><span id="l2.31"> </span>
<a href="#l2.32"></a><span id="l2.32"> function Startup()</span>
<a href="#l2.33"></a><span id="l2.33"> {</span>
<a href="#l2.34"></a><span id="l2.34">   startPageCheck();</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineminus">-</span>
<a href="#l2.36"></a><span id="l2.36">   defaultClientSetup();</span>
<a href="#l2.37"></a><span id="l2.37"> }</span>
<a href="#l2.38"></a><span id="l2.38"> </span>
<a href="#l2.39"></a><span id="l2.39"> function startPageCheck()</span>
<a href="#l2.40"></a><span id="l2.40"> {</span>
<a href="#l2.41"></a><span id="l2.41">   var checked = document.getElementById(&quot;mailnews.start_page.enabled&quot;).value;</span>
<a href="#l2.42"></a><span id="l2.42">   var urlElement = document.getElementById(&quot;mailnewsStartPageUrl&quot;);</span>
<a href="#l2.43"></a><span id="l2.43">   var prefLocked = document.getElementById(&quot;mailnews.start_page.url&quot;).locked;</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineat">@@ -58,70 +58,45 @@ function setHomePageToDefaultPage()</span>
<a href="#l2.45"></a><span id="l2.45"> {</span>
<a href="#l2.46"></a><span id="l2.46">   var startPagePref = document.getElementById(&quot;mailnews.start_page.url&quot;);</span>
<a href="#l2.47"></a><span id="l2.47"> </span>
<a href="#l2.48"></a><span id="l2.48">   startPagePref.value = startPagePref.defaultValue;</span>
<a href="#l2.49"></a><span id="l2.49"> }</span>
<a href="#l2.50"></a><span id="l2.50"> </span>
<a href="#l2.51"></a><span id="l2.51"> function defaultClientSetup()</span>
<a href="#l2.52"></a><span id="l2.52"> {</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineminus">-  if (&quot;@mozilla.org/browser/shell-service;1&quot; in Components.classes) {</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineminus">-    var shellService = Components.classes[&quot;@mozilla.org/browser/shell-service;1&quot;]</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineplus">+  if (&quot;@mozilla.org/suite/shell-service;1&quot; in Components.classes) {</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineplus">+    var shellService = Components.classes[&quot;@mozilla.org/suite/shell-service;1&quot;]</span>
<a href="#l2.57"></a><span id="l2.57">                                  .getService(nsIShellService);</span>
<a href="#l2.58"></a><span id="l2.58"> </span>
<a href="#l2.59"></a><span id="l2.59">     document.getElementById(&quot;setDefaultMail&quot;).disabled =</span>
<a href="#l2.60"></a><span id="l2.60">       shellService.isDefaultClient(false, nsIShellService.MAIL);</span>
<a href="#l2.61"></a><span id="l2.61"> </span>
<a href="#l2.62"></a><span id="l2.62">     document.getElementById(&quot;setDefaultNews&quot;).disabled =</span>
<a href="#l2.63"></a><span id="l2.63">       shellService.isDefaultClient(false, nsIShellService.NEWS);</span>
<a href="#l2.64"></a><span id="l2.64"> </span>
<a href="#l2.65"></a><span id="l2.65" class="difflineminus">-    return;</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineplus">+    document.getElementById(&quot;defaultMailPrefs&quot;).hidden = false;</span>
<a href="#l2.67"></a><span id="l2.67">   }</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineminus">-  if (&quot;@mozilla.org/mapiregistry;1&quot; in Components.classes) {</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineminus">-    var mapiRegistry = Components.classes[&quot;@mozilla.org/mapiregistry;1&quot;]</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineminus">-                     .getService(Components.interfaces.nsIMapiRegistry);</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineminus">-</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineminus">-    document.getElementById(&quot;setDefaultMail&quot;).disabled =</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineminus">-      mapiRegistry.isDefaultMailClient;</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineminus">-</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineminus">-    document.getElementById(&quot;setDefaultNews&quot;).disabled =</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineminus">-      mapiRegistry.isDefaultNewsClient;</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineminus">-</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineminus">-    return;</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineminus">-  }</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineminus">-</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineminus">-  document.getElementById(&quot;defaultMailPrefs&quot;).hidden = true;</span>
<a href="#l2.82"></a><span id="l2.82"> }</span>
<a href="#l2.83"></a><span id="l2.83"> </span>
<a href="#l2.84"></a><span id="l2.84"> function onSetDefaultMail()</span>
<a href="#l2.85"></a><span id="l2.85"> {</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineminus">-  if (&quot;@mozilla.org/browser/shell-service;1&quot; in Components.classes) {</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineminus">-    var shellService = Components.classes[&quot;@mozilla.org/browser/shell-service;1&quot;]</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineminus">-                                 .getService(nsIShellService);</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineplus">+  var shellService = Components.classes[&quot;@mozilla.org/suite/shell-service;1&quot;]</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineplus">+                               .getService(nsIShellService);</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineplus">+  var appTypes = shellService.shouldBeDefaultClientFor;</span>
<a href="#l2.92"></a><span id="l2.92"> </span>
<a href="#l2.93"></a><span id="l2.93" class="difflineminus">-    shellService.setDefaultClient(false, false, nsIShellService.MAIL);</span>
<a href="#l2.94"></a><span id="l2.94" class="difflineminus">-  }</span>
<a href="#l2.95"></a><span id="l2.95" class="difflineminus">-  else if (&quot;@mozilla.org/mapiregistry;1&quot; in Components.classes) {</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineminus">-    var mapiRegistry = Components.classes[&quot;@mozilla.org/mapiregistry;1&quot;]</span>
<a href="#l2.97"></a><span id="l2.97" class="difflineminus">-                     .getService(Components.interfaces.nsIMapiRegistry);</span>
<a href="#l2.98"></a><span id="l2.98" class="difflineplus">+  shellService.setDefaultClient(false, false, nsIShellService.MAIL);</span>
<a href="#l2.99"></a><span id="l2.99" class="difflineplus">+  shellService.shouldBeDefaultClientFor |= nsIShellService.MAIL;</span>
<a href="#l2.100"></a><span id="l2.100"> </span>
<a href="#l2.101"></a><span id="l2.101" class="difflineminus">-    mapiRegistry.isDefaultMailClient = true;</span>
<a href="#l2.102"></a><span id="l2.102" class="difflineminus">-</span>
<a href="#l2.103"></a><span id="l2.103" class="difflineminus">-  }</span>
<a href="#l2.104"></a><span id="l2.104">   document.getElementById(&quot;setDefaultMail&quot;).disabled = true;</span>
<a href="#l2.105"></a><span id="l2.105"> }</span>
<a href="#l2.106"></a><span id="l2.106"> </span>
<a href="#l2.107"></a><span id="l2.107"> function onSetDefaultNews()</span>
<a href="#l2.108"></a><span id="l2.108"> {</span>
<a href="#l2.109"></a><span id="l2.109" class="difflineminus">-  if (&quot;@mozilla.org/browser/shell-service;1&quot; in Components.classes) {</span>
<a href="#l2.110"></a><span id="l2.110" class="difflineminus">-    var shellService = Components.classes[&quot;@mozilla.org/browser/shell-service;1&quot;]</span>
<a href="#l2.111"></a><span id="l2.111" class="difflineminus">-                                 .getService(nsIShellService);</span>
<a href="#l2.112"></a><span id="l2.112" class="difflineplus">+  var shellService = Components.classes[&quot;@mozilla.org/suite/shell-service;1&quot;]</span>
<a href="#l2.113"></a><span id="l2.113" class="difflineplus">+                               .getService(nsIShellService);</span>
<a href="#l2.114"></a><span id="l2.114" class="difflineplus">+  var appTypes = shellService.shouldBeDefaultClientFor;</span>
<a href="#l2.115"></a><span id="l2.115"> </span>
<a href="#l2.116"></a><span id="l2.116" class="difflineminus">-    shellService.setDefaultClient(false, false, nsIShellService.NEWS);</span>
<a href="#l2.117"></a><span id="l2.117" class="difflineminus">-  }</span>
<a href="#l2.118"></a><span id="l2.118" class="difflineminus">-  else if (&quot;@mozilla.org/mapiregistry;1&quot; in Components.classes) {</span>
<a href="#l2.119"></a><span id="l2.119" class="difflineminus">-    var mapiRegistry = Components.classes[&quot;@mozilla.org/mapiregistry;1&quot;]</span>
<a href="#l2.120"></a><span id="l2.120" class="difflineminus">-                     .getService(Components.interfaces.nsIMapiRegistry);</span>
<a href="#l2.121"></a><span id="l2.121" class="difflineplus">+  shellService.setDefaultClient(false, false, nsIShellService.NEWS);</span>
<a href="#l2.122"></a><span id="l2.122" class="difflineplus">+  shellService.shouldBeDefaultClientFor |= nsIShellService.NEWS;</span>
<a href="#l2.123"></a><span id="l2.123"> </span>
<a href="#l2.124"></a><span id="l2.124" class="difflineminus">-    mapiRegistry.isDefaultNewsClient = true;</span>
<a href="#l2.125"></a><span id="l2.125" class="difflineminus">-  }</span>
<a href="#l2.126"></a><span id="l2.126">   document.getElementById(&quot;setDefaultNews&quot;).disabled = true;</span>
<a href="#l2.127"></a><span id="l2.127"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/base/prefs/resources/content/pref-mailnews.xul</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/base/prefs/resources/content/pref-mailnews.xul</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -99,17 +99,17 @@</span>
<a href="#l3.4"></a><span id="l3.4"> </span>
<a href="#l3.5"></a><span id="l3.5">       &lt;hbox align=&quot;center&quot;&gt;</span>
<a href="#l3.6"></a><span id="l3.6">         &lt;checkbox id=&quot;mailPreserveThreading&quot;</span>
<a href="#l3.7"></a><span id="l3.7">                   label=&quot;&amp;preserveThreading.label;&quot;</span>
<a href="#l3.8"></a><span id="l3.8">                   accesskey=&quot;&amp;preserveThreading.accesskey;&quot;</span>
<a href="#l3.9"></a><span id="l3.9">                   preference=&quot;mailnews.thread_pane_column_unthreads&quot;</span>
<a href="#l3.10"></a><span id="l3.10">                   reversed=&quot;true&quot; /&gt;</span>
<a href="#l3.11"></a><span id="l3.11">       &lt;/hbox&gt;</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-      &lt;vbox id=&quot;defaultMailPrefs&quot;&gt;</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+      &lt;vbox id=&quot;defaultMailPrefs&quot; hidden=&quot;true&quot;&gt;</span>
<a href="#l3.14"></a><span id="l3.14">         &lt;separator class=&quot;thin&quot;/&gt;</span>
<a href="#l3.15"></a><span id="l3.15"> </span>
<a href="#l3.16"></a><span id="l3.16">         &lt;description&gt;&amp;defaultMailSettings.description;&lt;/description&gt;</span>
<a href="#l3.17"></a><span id="l3.17">         &lt;hbox class=&quot;indent&quot; align=&quot;center&quot;&gt;</span>
<a href="#l3.18"></a><span id="l3.18">           &lt;button id=&quot;setDefaultMail&quot; accesskey=&quot;&amp;setDefaultMail.accesskey;&quot;</span>
<a href="#l3.19"></a><span id="l3.19">                   label=&quot;&amp;setDefaultMail.label;&quot; oncommand=&quot;onSetDefaultMail();&quot;</span>
<a href="#l3.20"></a><span id="l3.20">                   preference=&quot;system.windows.lock_ui.defaultMailClient&quot;/&gt;</span>
<a href="#l3.21"></a><span id="l3.21">           &lt;button id=&quot;setDefaultNews&quot; accesskey=&quot;&amp;setDefaultNews.accesskey;&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/mapi/mapihook/src/Makefile.in</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/mapi/mapihook/src/Makefile.in</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -79,20 +79,16 @@ CPPSRCS		= \</span>
<a href="#l4.4"></a><span id="l4.4"> 		msgMapiFactory.cpp \</span>
<a href="#l4.5"></a><span id="l4.5"> 		msgMapiHook.cpp \</span>
<a href="#l4.6"></a><span id="l4.6"> 		msgMapiImp.cpp \</span>
<a href="#l4.7"></a><span id="l4.7"> 		msgMapiMain.cpp \</span>
<a href="#l4.8"></a><span id="l4.8"> 		msgMapiSupport.cpp \</span>
<a href="#l4.9"></a><span id="l4.9"> 		Registry.cpp \</span>
<a href="#l4.10"></a><span id="l4.10"> 		$(NULL)</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-ifndef MOZ_THUNDERBIRD</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-CPPSRCS        += nsMapiRegistry.cpp nsMapiRegistryUtils.cpp</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">-endif</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineminus">-</span>
<a href="#l4.16"></a><span id="l4.16"> LOBJS		= ../build/msgMapi_i.$(OBJ_SUFFIX)</span>
<a href="#l4.17"></a><span id="l4.17"> </span>
<a href="#l4.18"></a><span id="l4.18"> ifndef MOZ_STATIC_MAIL_BUILD</span>
<a href="#l4.19"></a><span id="l4.19"> </span>
<a href="#l4.20"></a><span id="l4.20"> ifdef USE_SHORT_LIBNAME</span>
<a href="#l4.21"></a><span id="l4.21"> EXTRA_DSO_LIBS	= msgbsutl</span>
<a href="#l4.22"></a><span id="l4.22"> else</span>
<a href="#l4.23"></a><span id="l4.23"> EXTRA_DSO_LIBS	= msgbaseutil</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/mapi/mapihook/src/msgMapiSupport.cpp</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/mapi/mapihook/src/msgMapiSupport.cpp</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -42,21 +42,16 @@</span>
<a href="#l5.4"></a><span id="l5.4"> #include &quot;nsIObserverService.h&quot;</span>
<a href="#l5.5"></a><span id="l5.5"> #include &quot;nsIAppStartupNotifier.h&quot;</span>
<a href="#l5.6"></a><span id="l5.6"> #include &quot;nsIServiceManager.h&quot;</span>
<a href="#l5.7"></a><span id="l5.7"> #include &quot;nsIComponentManager.h&quot;</span>
<a href="#l5.8"></a><span id="l5.8"> #include &quot;nsICategoryManager.h&quot;</span>
<a href="#l5.9"></a><span id="l5.9"> #include &quot;Registry.h&quot;</span>
<a href="#l5.10"></a><span id="l5.10"> #include &quot;msgMapiSupport.h&quot;</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-#ifndef MOZ_THUNDERBIRD</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-#include &quot;nsMapiRegistryUtils.h&quot; </span>
<a href="#l5.14"></a><span id="l5.14" class="difflineminus">-#include &quot;nsMapiRegistry.h&quot;</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineminus">-#endif</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineminus">-</span>
<a href="#l5.17"></a><span id="l5.17"> #include &quot;msgMapiImp.h&quot;</span>
<a href="#l5.18"></a><span id="l5.18"> </span>
<a href="#l5.19"></a><span id="l5.19"> /** Implementation of the nsIMapiSupport interface.</span>
<a href="#l5.20"></a><span id="l5.20">  *  Use standard implementation of nsISupports stuff.</span>
<a href="#l5.21"></a><span id="l5.21">  */</span>
<a href="#l5.22"></a><span id="l5.22"> </span>
<a href="#l5.23"></a><span id="l5.23"> NS_IMPL_THREADSAFE_ISUPPORTS2(nsMapiSupport, nsIMapiSupport, nsIObserver)</span>
<a href="#l5.24"></a><span id="l5.24"> </span>
<a href="#l5.25"></a><span id="l5.25" class="difflineat">@@ -167,38 +162,25 @@ nsMapiSupport::RegisterServer()</span>
<a href="#l5.26"></a><span id="l5.26"> NS_IMETHODIMP</span>
<a href="#l5.27"></a><span id="l5.27"> nsMapiSupport::UnRegisterServer()</span>
<a href="#l5.28"></a><span id="l5.28"> {</span>
<a href="#l5.29"></a><span id="l5.29">   // TODO: Figure out what kind of error propogation to pass back</span>
<a href="#l5.30"></a><span id="l5.30">   ::UnregisterServer(CLSID_CMapiImp, &quot;MozillaMapi&quot;, &quot;MozillaMapi.1&quot;);</span>
<a href="#l5.31"></a><span id="l5.31">   return NS_OK;</span>
<a href="#l5.32"></a><span id="l5.32"> }</span>
<a href="#l5.33"></a><span id="l5.33"> </span>
<a href="#l5.34"></a><span id="l5.34" class="difflineminus">-</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineminus">-#ifndef MOZ_THUNDERBIRD</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineminus">-NS_GENERIC_FACTORY_CONSTRUCTOR(nsMapiRegistry)</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineminus">-#endif</span>
<a href="#l5.38"></a><span id="l5.38"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsMapiSupport)</span>
<a href="#l5.39"></a><span id="l5.39"> </span>
<a href="#l5.40"></a><span id="l5.40"> // The list of components we register</span>
<a href="#l5.41"></a><span id="l5.41"> static const nsModuleComponentInfo components[] = </span>
<a href="#l5.42"></a><span id="l5.42"> {</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineminus">-#ifndef MOZ_THUNDERBIRD</span>
<a href="#l5.44"></a><span id="l5.44">   {</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineminus">-    NS_IMAPIREGISTRY_CLASSNAME, </span>
<a href="#l5.46"></a><span id="l5.46" class="difflineminus">-    NS_IMAPIREGISTRY_CID,</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineminus">-    NS_IMAPIREGISTRY_CONTRACTID, </span>
<a href="#l5.48"></a><span id="l5.48" class="difflineminus">-    nsMapiRegistryConstructor</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineminus">-  },</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineminus">-#endif</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineminus">-</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineminus">-{</span>
<a href="#l5.53"></a><span id="l5.53">     NS_IMAPISUPPORT_CLASSNAME,</span>
<a href="#l5.54"></a><span id="l5.54">     NS_IMAPISUPPORT_CID,</span>
<a href="#l5.55"></a><span id="l5.55">     NS_IMAPISUPPORT_CONTRACTID,</span>
<a href="#l5.56"></a><span id="l5.56">     nsMapiSupportConstructor,</span>
<a href="#l5.57"></a><span id="l5.57">     nsMapiRegistrationProc,</span>
<a href="#l5.58"></a><span id="l5.58">     nsnull</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineminus">-}</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineplus">+  }</span>
<a href="#l5.61"></a><span id="l5.61"> };</span>
<a href="#l5.62"></a><span id="l5.62"> </span>
<a href="#l5.63"></a><span id="l5.63"> NS_IMPL_NSGETMODULE(msgMapiModule, components)</span>
<a href="#l5.64"></a><span id="l5.64"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1">deleted file mode 100644</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineminus">--- a/mailnews/mapi/mapihook/src/nsMapiRegistry.cpp</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineplus">+++ /dev/null</span>
<a href="#l6.4"></a><span id="l6.4" class="difflineat">@@ -1,238 +0,0 @@</span>
<a href="#l6.5"></a><span id="l6.5" class="difflineminus">-/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l6.6"></a><span id="l6.6" class="difflineminus">- * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l6.7"></a><span id="l6.7" class="difflineminus">- *</span>
<a href="#l6.8"></a><span id="l6.8" class="difflineminus">- * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l6.9"></a><span id="l6.9" class="difflineminus">- * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l6.10"></a><span id="l6.10" class="difflineminus">- * the License. You may obtain a copy of the License at</span>
<a href="#l6.11"></a><span id="l6.11" class="difflineminus">- * http://www.mozilla.org/MPL/</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">- *</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">- * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineminus">- * for the specific language governing rights and limitations under the</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineminus">- * License.</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineminus">- *</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineminus">- * The Original Code is mozilla.org code.</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineminus">- *</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineminus">- * The Initial Developer of the Original Code is</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineminus">- * Netscape Communications Corporation.</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineminus">- * Portions created by the Initial Developer are Copyright (C) 2001</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineminus">- * the Initial Developer. All Rights Reserved.</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineminus">- *</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineminus">- * Contributor(s):</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineminus">- *   Srilatha Moturi &lt;srilatha@netscape.com&gt;</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineminus">- *   Rajiv Dayal &lt;rdayal@netscape.com&gt;</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineminus">- *</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineminus">- * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineminus">- * either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">- * or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineminus">- * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineminus">- * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineminus">- * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineminus">- * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineminus">- * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineminus">- * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineminus">- * the provisions above, a recipient may use your version of this file under</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineminus">- * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineminus">- *</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineminus">- * ***** END LICENSE BLOCK ***** */</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineminus">- </span>
<a href="#l6.43"></a><span id="l6.43" class="difflineminus">-/***************************************************************************</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineminus">-*</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineminus">-* This File is no longer used by Thunderbird. Seamonkey is the only consumer.</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineminus">-* See mozilla/mail/components/shell for the Thunderbird registry code</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineminus">-*</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineminus">-*****************************************************************************/</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineminus">-</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineminus">-#include &quot;nsIServiceManager.h&quot;</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineminus">-#include &quot;nsIPromptService.h&quot;</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineminus">-#include &quot;nsIProxyObjectManager.h&quot;</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineminus">-#include &quot;nsProxiedService.h&quot;</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineminus">-</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineminus">-#include &quot;nsMapiRegistryUtils.h&quot; </span>
<a href="#l6.56"></a><span id="l6.56" class="difflineminus">-#include &quot;nsMapiRegistry.h&quot;</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineminus">-</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineminus">-#include &quot;nsIPrefService.h&quot;</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineminus">-#include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineminus">-</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineminus">-#include &quot;nsEmbedCID.h&quot;</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineminus">-</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineminus">-/** Implementation of the nsIMapiRegistry interface.</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineminus">- *  Use standard implementation of nsISupports stuff.</span>
<a href="#l6.65"></a><span id="l6.65" class="difflineminus">- */</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineminus">-NS_IMPL_ISUPPORTS1(nsMapiRegistry, nsIMapiRegistry)</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineminus">-</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineminus">-nsMapiRegistry::nsMapiRegistry() {</span>
<a href="#l6.69"></a><span id="l6.69" class="difflineminus">-    m_DefaultMailClient = m_registryUtils.IsDefaultMailClient();</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineminus">-    m_DefaultNewsClient = m_registryUtils.IsDefaultNewsClient(); </span>
<a href="#l6.71"></a><span id="l6.71" class="difflineminus">-    // m_ShowDialog should be initialized to false </span>
<a href="#l6.72"></a><span id="l6.72" class="difflineminus">-    // if we are the default mail client.</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineminus">-    m_ShowDialog = !m_registryUtils.HasRestrictedRegistryAccess() &amp;&amp; !m_DefaultMailClient;</span>
<a href="#l6.74"></a><span id="l6.74" class="difflineminus">-}</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineminus">-</span>
<a href="#l6.76"></a><span id="l6.76" class="difflineminus">-nsMapiRegistry::~nsMapiRegistry() {</span>
<a href="#l6.77"></a><span id="l6.77" class="difflineminus">-}</span>
<a href="#l6.78"></a><span id="l6.78" class="difflineminus">-</span>
<a href="#l6.79"></a><span id="l6.79" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l6.80"></a><span id="l6.80" class="difflineminus">-nsMapiRegistry::GetIsDefaultMailClient(PRBool * retval) {</span>
<a href="#l6.81"></a><span id="l6.81" class="difflineminus">-    // we need to get the value from registry everytime</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineminus">-    // because the registry settings can be changed from</span>
<a href="#l6.83"></a><span id="l6.83" class="difflineminus">-    // other mail applications.</span>
<a href="#l6.84"></a><span id="l6.84" class="difflineminus">-    *retval = m_registryUtils.IsDefaultMailClient();</span>
<a href="#l6.85"></a><span id="l6.85" class="difflineminus">-    return NS_OK;</span>
<a href="#l6.86"></a><span id="l6.86" class="difflineminus">-}</span>
<a href="#l6.87"></a><span id="l6.87" class="difflineminus">-</span>
<a href="#l6.88"></a><span id="l6.88" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l6.89"></a><span id="l6.89" class="difflineminus">-nsMapiRegistry::GetIsDefaultNewsClient(PRBool * retval) {</span>
<a href="#l6.90"></a><span id="l6.90" class="difflineminus">-    // we need to get the value from registry everytime</span>
<a href="#l6.91"></a><span id="l6.91" class="difflineminus">-    // because the registry settings can be changed from</span>
<a href="#l6.92"></a><span id="l6.92" class="difflineminus">-    // other mail applications.</span>
<a href="#l6.93"></a><span id="l6.93" class="difflineminus">-    *retval = m_registryUtils.IsDefaultNewsClient();</span>
<a href="#l6.94"></a><span id="l6.94" class="difflineminus">-    return NS_OK;</span>
<a href="#l6.95"></a><span id="l6.95" class="difflineminus">-}</span>
<a href="#l6.96"></a><span id="l6.96" class="difflineminus">-</span>
<a href="#l6.97"></a><span id="l6.97" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l6.98"></a><span id="l6.98" class="difflineminus">-nsMapiRegistry::GetIsDefaultFeedClient(PRBool * retval) {</span>
<a href="#l6.99"></a><span id="l6.99" class="difflineminus">-    // we need to get the value from registry everytime</span>
<a href="#l6.100"></a><span id="l6.100" class="difflineminus">-    // because the registry settings can be changed from</span>
<a href="#l6.101"></a><span id="l6.101" class="difflineminus">-    // other applications.</span>
<a href="#l6.102"></a><span id="l6.102" class="difflineminus">-    *retval = m_registryUtils.IsDefaultFeedClient();</span>
<a href="#l6.103"></a><span id="l6.103" class="difflineminus">-    return NS_OK;</span>
<a href="#l6.104"></a><span id="l6.104" class="difflineminus">-}</span>
<a href="#l6.105"></a><span id="l6.105" class="difflineminus">-</span>
<a href="#l6.106"></a><span id="l6.106" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l6.107"></a><span id="l6.107" class="difflineminus">-nsMapiRegistry::GetShowDialog(PRBool * retval) {</span>
<a href="#l6.108"></a><span id="l6.108" class="difflineminus">-    *retval = m_ShowDialog;</span>
<a href="#l6.109"></a><span id="l6.109" class="difflineminus">-    return NS_OK;</span>
<a href="#l6.110"></a><span id="l6.110" class="difflineminus">-}</span>
<a href="#l6.111"></a><span id="l6.111" class="difflineminus">-</span>
<a href="#l6.112"></a><span id="l6.112" class="difflineminus">-</span>
<a href="#l6.113"></a><span id="l6.113" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l6.114"></a><span id="l6.114" class="difflineminus">-nsMapiRegistry::SetIsDefaultMailClient(PRBool aIsDefaultMailClient) </span>
<a href="#l6.115"></a><span id="l6.115" class="difflineminus">-{</span>
<a href="#l6.116"></a><span id="l6.116" class="difflineminus">-    nsresult rv = NS_OK ;</span>
<a href="#l6.117"></a><span id="l6.117" class="difflineminus">-</span>
<a href="#l6.118"></a><span id="l6.118" class="difflineminus">-    if (aIsDefaultMailClient)</span>
<a href="#l6.119"></a><span id="l6.119" class="difflineminus">-    {</span>
<a href="#l6.120"></a><span id="l6.120" class="difflineminus">-        rv = m_registryUtils.setDefaultMailClient();</span>
<a href="#l6.121"></a><span id="l6.121" class="difflineminus">-        if (NS_SUCCEEDED(rv))</span>
<a href="#l6.122"></a><span id="l6.122" class="difflineminus">-            m_DefaultMailClient = PR_TRUE;</span>
<a href="#l6.123"></a><span id="l6.123" class="difflineminus">-        else</span>
<a href="#l6.124"></a><span id="l6.124" class="difflineminus">-            m_registryUtils.ShowMapiErrorDialog(PR_TRUE);</span>
<a href="#l6.125"></a><span id="l6.125" class="difflineminus">-    }</span>
<a href="#l6.126"></a><span id="l6.126" class="difflineminus">-    else</span>
<a href="#l6.127"></a><span id="l6.127" class="difflineminus">-    {</span>
<a href="#l6.128"></a><span id="l6.128" class="difflineminus">-        rv = m_registryUtils.unsetDefaultMailClient();</span>
<a href="#l6.129"></a><span id="l6.129" class="difflineminus">-        if (NS_SUCCEEDED(rv))</span>
<a href="#l6.130"></a><span id="l6.130" class="difflineminus">-            m_DefaultMailClient = PR_FALSE;</span>
<a href="#l6.131"></a><span id="l6.131" class="difflineminus">-        else</span>
<a href="#l6.132"></a><span id="l6.132" class="difflineminus">-            m_registryUtils.ShowMapiErrorDialog(PR_TRUE);</span>
<a href="#l6.133"></a><span id="l6.133" class="difflineminus">-    }</span>
<a href="#l6.134"></a><span id="l6.134" class="difflineminus">-</span>
<a href="#l6.135"></a><span id="l6.135" class="difflineminus">-    return rv ;</span>
<a href="#l6.136"></a><span id="l6.136" class="difflineminus">-}</span>
<a href="#l6.137"></a><span id="l6.137" class="difflineminus">-</span>
<a href="#l6.138"></a><span id="l6.138" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l6.139"></a><span id="l6.139" class="difflineminus">-nsMapiRegistry::SetIsDefaultNewsClient(PRBool aIsDefaultNewsClient) </span>
<a href="#l6.140"></a><span id="l6.140" class="difflineminus">-{</span>
<a href="#l6.141"></a><span id="l6.141" class="difflineminus">-    nsresult rv = NS_OK ;</span>
<a href="#l6.142"></a><span id="l6.142" class="difflineminus">-</span>
<a href="#l6.143"></a><span id="l6.143" class="difflineminus">-    if (aIsDefaultNewsClient)</span>
<a href="#l6.144"></a><span id="l6.144" class="difflineminus">-    {</span>
<a href="#l6.145"></a><span id="l6.145" class="difflineminus">-        rv = m_registryUtils.setDefaultNewsClient();</span>
<a href="#l6.146"></a><span id="l6.146" class="difflineminus">-        if (NS_SUCCEEDED(rv))</span>
<a href="#l6.147"></a><span id="l6.147" class="difflineminus">-            m_DefaultNewsClient = PR_TRUE;</span>
<a href="#l6.148"></a><span id="l6.148" class="difflineminus">-        else</span>
<a href="#l6.149"></a><span id="l6.149" class="difflineminus">-            m_registryUtils.ShowMapiErrorDialog(PR_FALSE);</span>
<a href="#l6.150"></a><span id="l6.150" class="difflineminus">-    }</span>
<a href="#l6.151"></a><span id="l6.151" class="difflineminus">-    else</span>
<a href="#l6.152"></a><span id="l6.152" class="difflineminus">-    {</span>
<a href="#l6.153"></a><span id="l6.153" class="difflineminus">-        rv = m_registryUtils.unsetDefaultNewsClient();</span>
<a href="#l6.154"></a><span id="l6.154" class="difflineminus">-        if (NS_SUCCEEDED(rv))</span>
<a href="#l6.155"></a><span id="l6.155" class="difflineminus">-            m_DefaultNewsClient = PR_FALSE;</span>
<a href="#l6.156"></a><span id="l6.156" class="difflineminus">-        else</span>
<a href="#l6.157"></a><span id="l6.157" class="difflineminus">-            m_registryUtils.ShowMapiErrorDialog(PR_FALSE);</span>
<a href="#l6.158"></a><span id="l6.158" class="difflineminus">-    }</span>
<a href="#l6.159"></a><span id="l6.159" class="difflineminus">-</span>
<a href="#l6.160"></a><span id="l6.160" class="difflineminus">-    return rv ;</span>
<a href="#l6.161"></a><span id="l6.161" class="difflineminus">-}</span>
<a href="#l6.162"></a><span id="l6.162" class="difflineminus">-</span>
<a href="#l6.163"></a><span id="l6.163" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l6.164"></a><span id="l6.164" class="difflineminus">-nsMapiRegistry::SetIsDefaultFeedClient(PRBool aIsDefaultFeedClient) </span>
<a href="#l6.165"></a><span id="l6.165" class="difflineminus">-{</span>
<a href="#l6.166"></a><span id="l6.166" class="difflineminus">-    nsresult rv = NS_OK;</span>
<a href="#l6.167"></a><span id="l6.167" class="difflineminus">-    return aIsDefaultFeedClient ? m_registryUtils.setDefaultFeedClient() : m_registryUtils.unsetDefaultFeedClient();</span>
<a href="#l6.168"></a><span id="l6.168" class="difflineminus">-}</span>
<a href="#l6.169"></a><span id="l6.169" class="difflineminus">-</span>
<a href="#l6.170"></a><span id="l6.170" class="difflineminus">-NS_IMETHODIMP nsMapiRegistry::RegisterMailAndNewsClient()</span>
<a href="#l6.171"></a><span id="l6.171" class="difflineminus">-{</span>
<a href="#l6.172"></a><span id="l6.172" class="difflineminus">-  m_registryUtils.registerNewsApp(PR_FALSE);</span>
<a href="#l6.173"></a><span id="l6.173" class="difflineminus">-  m_registryUtils.registerMailApp(PR_FALSE);</span>
<a href="#l6.174"></a><span id="l6.174" class="difflineminus">-  return NS_OK;</span>
<a href="#l6.175"></a><span id="l6.175" class="difflineminus">-}</span>
<a href="#l6.176"></a><span id="l6.176" class="difflineminus">-</span>
<a href="#l6.177"></a><span id="l6.177" class="difflineminus">-/** This will bring up the dialog box only once per session and </span>
<a href="#l6.178"></a><span id="l6.178" class="difflineminus">- * only if the current app is not default Mail Client.</span>
<a href="#l6.179"></a><span id="l6.179" class="difflineminus">- * This also checks the registry if the registry key</span>
<a href="#l6.180"></a><span id="l6.180" class="difflineminus">- * showMapiDialog is set</span>
<a href="#l6.181"></a><span id="l6.181" class="difflineminus">- */</span>
<a href="#l6.182"></a><span id="l6.182" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l6.183"></a><span id="l6.183" class="difflineminus">-nsMapiRegistry::ShowMailIntegrationDialog(nsIDOMWindow *aParentWindow) {</span>
<a href="#l6.184"></a><span id="l6.184" class="difflineminus">-    if (!m_ShowDialog || !m_registryUtils.getShowDialog() ||</span>
<a href="#l6.185"></a><span id="l6.185" class="difflineminus">-        m_registryUtils.IsDefaultMailClient()) {</span>
<a href="#l6.186"></a><span id="l6.186" class="difflineminus">-      return NS_OK;</span>
<a href="#l6.187"></a><span id="l6.187" class="difflineminus">-    }</span>
<a href="#l6.188"></a><span id="l6.188" class="difflineminus">-</span>
<a href="#l6.189"></a><span id="l6.189" class="difflineminus">-    nsresult rv;</span>
<a href="#l6.190"></a><span id="l6.190" class="difflineminus">-    nsCOMPtr&lt;nsIPromptService&gt; promptService(do_GetService(</span>
<a href="#l6.191"></a><span id="l6.191" class="difflineminus">-                  NS_PROMPTSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l6.192"></a><span id="l6.192" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; promptService)</span>
<a href="#l6.193"></a><span id="l6.193" class="difflineminus">-    {</span>
<a href="#l6.194"></a><span id="l6.194" class="difflineminus">-        nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l6.195"></a><span id="l6.195" class="difflineminus">-        rv = m_registryUtils.MakeMapiStringBundle (getter_AddRefs (bundle)) ;</span>
<a href="#l6.196"></a><span id="l6.196" class="difflineminus">-        if (NS_FAILED(rv)) return NS_ERROR_FAILURE;</span>
<a href="#l6.197"></a><span id="l6.197" class="difflineminus">-</span>
<a href="#l6.198"></a><span id="l6.198" class="difflineminus">-        nsString dialogTitle;</span>
<a href="#l6.199"></a><span id="l6.199" class="difflineminus">-        const PRUnichar *brandStrings[] = { m_registryUtils.brandName() };</span>
<a href="#l6.200"></a><span id="l6.200" class="difflineminus">-        NS_NAMED_LITERAL_STRING(dialogTitlePropertyTag, &quot;dialogTitle&quot;);</span>
<a href="#l6.201"></a><span id="l6.201" class="difflineminus">-        rv = bundle-&gt;FormatStringFromName(dialogTitlePropertyTag.get(),</span>
<a href="#l6.202"></a><span id="l6.202" class="difflineminus">-                                          brandStrings, 1,</span>
<a href="#l6.203"></a><span id="l6.203" class="difflineminus">-                                          getter_Copies(dialogTitle));</span>
<a href="#l6.204"></a><span id="l6.204" class="difflineminus">-        if (NS_FAILED(rv)) return NS_ERROR_FAILURE;</span>
<a href="#l6.205"></a><span id="l6.205" class="difflineminus">-        </span>
<a href="#l6.206"></a><span id="l6.206" class="difflineminus">-        nsString dialogText;</span>
<a href="#l6.207"></a><span id="l6.207" class="difflineminus">-        NS_NAMED_LITERAL_STRING(dialogTextPropertyTag, &quot;dialogText&quot;);</span>
<a href="#l6.208"></a><span id="l6.208" class="difflineminus">-        rv = bundle-&gt;FormatStringFromName(dialogTextPropertyTag.get(),</span>
<a href="#l6.209"></a><span id="l6.209" class="difflineminus">-                                          brandStrings, 1,</span>
<a href="#l6.210"></a><span id="l6.210" class="difflineminus">-                                          getter_Copies(dialogText));</span>
<a href="#l6.211"></a><span id="l6.211" class="difflineminus">-        if (NS_FAILED(rv)) return NS_ERROR_FAILURE;</span>
<a href="#l6.212"></a><span id="l6.212" class="difflineminus">-</span>
<a href="#l6.213"></a><span id="l6.213" class="difflineminus">-        nsString checkboxText;</span>
<a href="#l6.214"></a><span id="l6.214" class="difflineminus">-        rv = bundle-&gt;GetStringFromName(</span>
<a href="#l6.215"></a><span id="l6.215" class="difflineminus">-                           NS_LITERAL_STRING(&quot;checkboxText&quot;).get(),</span>
<a href="#l6.216"></a><span id="l6.216" class="difflineminus">-                           getter_Copies(checkboxText));</span>
<a href="#l6.217"></a><span id="l6.217" class="difflineminus">-        if (NS_FAILED(rv)) return NS_ERROR_FAILURE;</span>
<a href="#l6.218"></a><span id="l6.218" class="difflineminus">-</span>
<a href="#l6.219"></a><span id="l6.219" class="difflineminus">-        PRBool checkValue = PR_FALSE;</span>
<a href="#l6.220"></a><span id="l6.220" class="difflineminus">-        PRInt32 buttonPressed = 0;</span>
<a href="#l6.221"></a><span id="l6.221" class="difflineminus">-        rv = promptService-&gt;ConfirmEx(aParentWindow,</span>
<a href="#l6.222"></a><span id="l6.222" class="difflineminus">-                                      dialogTitle.get(),</span>
<a href="#l6.223"></a><span id="l6.223" class="difflineminus">-                                      dialogText.get(),</span>
<a href="#l6.224"></a><span id="l6.224" class="difflineminus">-                                      nsIPromptService::STD_YES_NO_BUTTONS,</span>
<a href="#l6.225"></a><span id="l6.225" class="difflineminus">-                                      nsnull,</span>
<a href="#l6.226"></a><span id="l6.226" class="difflineminus">-                                      nsnull,</span>
<a href="#l6.227"></a><span id="l6.227" class="difflineminus">-                                      nsnull,</span>
<a href="#l6.228"></a><span id="l6.228" class="difflineminus">-                                      checkboxText.get(),</span>
<a href="#l6.229"></a><span id="l6.229" class="difflineminus">-                                      &amp;checkValue,</span>
<a href="#l6.230"></a><span id="l6.230" class="difflineminus">-                                      &amp;buttonPressed);</span>
<a href="#l6.231"></a><span id="l6.231" class="difflineminus">-        if (NS_FAILED(rv)) return NS_ERROR_FAILURE;</span>
<a href="#l6.232"></a><span id="l6.232" class="difflineminus">-        rv = m_registryUtils.SetRegistryKey(HKEY_LOCAL_MACHINE, kAppDesktopKey, </span>
<a href="#l6.233"></a><span id="l6.233" class="difflineminus">-                                &quot;showMapiDialog&quot;, (checkValue) ? &quot;0&quot; : &quot;1&quot;);</span>
<a href="#l6.234"></a><span id="l6.234" class="difflineminus">-        if (NS_FAILED(rv)) return NS_ERROR_FAILURE;</span>
<a href="#l6.235"></a><span id="l6.235" class="difflineminus">-</span>
<a href="#l6.236"></a><span id="l6.236" class="difflineminus">-        m_ShowDialog = PR_FALSE;</span>
<a href="#l6.237"></a><span id="l6.237" class="difflineminus">-        if (!buttonPressed)</span>
<a href="#l6.238"></a><span id="l6.238" class="difflineminus">-            rv = SetIsDefaultMailClient(PR_TRUE);</span>
<a href="#l6.239"></a><span id="l6.239" class="difflineminus">-    }</span>
<a href="#l6.240"></a><span id="l6.240" class="difflineminus">-    return rv;</span>
<a href="#l6.241"></a><span id="l6.241" class="difflineminus">-}</span>
<a href="#l6.242"></a><span id="l6.242" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1">deleted file mode 100644</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineminus">--- a/mailnews/mapi/mapihook/src/nsMapiRegistry.h</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineplus">+++ /dev/null</span>
<a href="#l7.4"></a><span id="l7.4" class="difflineat">@@ -1,82 +0,0 @@</span>
<a href="#l7.5"></a><span id="l7.5" class="difflineminus">-/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l7.6"></a><span id="l7.6" class="difflineminus">- * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l7.7"></a><span id="l7.7" class="difflineminus">- *</span>
<a href="#l7.8"></a><span id="l7.8" class="difflineminus">- * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l7.9"></a><span id="l7.9" class="difflineminus">- * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l7.10"></a><span id="l7.10" class="difflineminus">- * the License. You may obtain a copy of the License at</span>
<a href="#l7.11"></a><span id="l7.11" class="difflineminus">- * http://www.mozilla.org/MPL/</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">- *</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">- * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineminus">- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineminus">- * for the specific language governing rights and limitations under the</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineminus">- * License.</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineminus">- *</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineminus">- * The Original Code is mozilla.org code.</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineminus">- *</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineminus">- * The Initial Developer of the Original Code is</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineminus">- * Netscape Communications Corporation.</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineminus">- * Portions created by the Initial Developer are Copyright (C) 2001</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineminus">- * the Initial Developer. All Rights Reserved.</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineminus">- *</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineminus">- * Contributor(s):</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineminus">- *   Srilatha Moturi &lt;srilatha@netscape.com&gt;</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineminus">- *</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineminus">- * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineminus">- * either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineminus">- * or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">- * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineminus">- * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineminus">- * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineminus">- * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineminus">- * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineminus">- * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineminus">- * the provisions above, a recipient may use your version of this file under</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineminus">- * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineminus">- *</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineminus">- * ***** END LICENSE BLOCK ***** */</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineminus">-</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineminus">-/***************************************************************************</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineminus">-*</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineminus">-* This File is no longer used by Thunderbird. Seamonkey is the only consumer.</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineminus">-* See mozilla/mail/components/shell for the Thunderbird registry code</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineminus">-*</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineminus">-*****************************************************************************/</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineminus">-</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineminus">-#ifndef nsmapiregistry_h____</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineminus">-#define nsmapiregistry_h____</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineminus">-</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineminus">-#include &quot;nsIMapiRegistry.h&quot;</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineminus">-</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineminus">-#ifndef MAX_BUF</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineminus">-#define MAX_BUF 4096</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineminus">-#endif</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineminus">-</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineminus">-/* c5be14ba-4e0a-4eec-a1b8-04363761d63c */</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineminus">-#define NS_IMAPIREGISTRY_CID \</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineminus">- { 0xc5be14ba, 0x4e0a, 0x4eec, {0xa1, 0xb8, 0x04, 0x36, 0x37, 0x61, 0xd6, 0x3c} }</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineminus">-#define NS_IMAPIREGISTRY_CONTRACTID    &quot;@mozilla.org/mapiregistry;1&quot;</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineminus">-#define NS_IMAPIREGISTRY_CLASSNAME &quot;Mozilla MAPI Registry&quot;</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineminus">-</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineminus">-class nsMapiRegistry : public nsIMapiRegistry {</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineminus">-public:</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineminus">-    // ctor/dtor</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineminus">-    nsMapiRegistry();</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineminus">-    virtual ~nsMapiRegistry();</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineminus">-</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineminus">-    // Declare all interface methods we must implement.</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineminus">-    NS_DECL_ISUPPORTS</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineminus">-    NS_DECL_NSIMAPIREGISTRY</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineminus">-</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineminus">-protected:</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineminus">-    </span>
<a href="#l7.76"></a><span id="l7.76" class="difflineminus">-    PRBool m_DefaultMailClient;</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineminus">-    PRBool m_DefaultNewsClient;</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineminus">-    PRBool m_ShowDialog;</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineminus">-    nsMapiRegistryUtils m_registryUtils ;</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineminus">-</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineminus">-private:</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineminus">-    // Special member to handle initialization.</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineminus">-    PRBool mHaveBeenSet;</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineminus">-}; // nsMapiRegistry</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineminus">-</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineminus">-#endif // nsmapiregistry_h____</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1">deleted file mode 100644</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineminus">--- a/mailnews/mapi/mapihook/src/nsMapiRegistryUtils.cpp</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineplus">+++ /dev/null</span>
<a href="#l8.4"></a><span id="l8.4" class="difflineat">@@ -1,1287 +0,0 @@</span>
<a href="#l8.5"></a><span id="l8.5" class="difflineminus">-/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l8.6"></a><span id="l8.6" class="difflineminus">- * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l8.7"></a><span id="l8.7" class="difflineminus">- *</span>
<a href="#l8.8"></a><span id="l8.8" class="difflineminus">- * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l8.9"></a><span id="l8.9" class="difflineminus">- * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l8.10"></a><span id="l8.10" class="difflineminus">- * the License. You may obtain a copy of the License at</span>
<a href="#l8.11"></a><span id="l8.11" class="difflineminus">- * http://www.mozilla.org/MPL/</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">- *</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">- * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineminus">- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineminus">- * for the specific language governing rights and limitations under the</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineminus">- * License.</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineminus">- *</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineminus">- * The Original Code is mozilla.org code.</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineminus">- *</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineminus">- * The Initial Developer of the Original Code is</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineminus">- * Netscape Communications Corporation.</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineminus">- * Portions created by the Initial Developer are Copyright (C) 2001</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineminus">- * the Initial Developer. All Rights Reserved.</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineminus">- *</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineminus">- * Contributor(s):</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineminus">- *   Srilatha Moturi &lt;srilatha@netscape.com&gt;</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineminus">- *   Jungshik Shin &lt;jshin@mailaps.org&gt;</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineminus">- *   Scott MacGregor &lt;mscott@mozilla.org&gt;</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineminus">- *   David Bienvenu &lt; bienvenu@mozilla.org&gt;</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineminus">- *</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">- * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineminus">- * either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineminus">- * or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineminus">- * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineminus">- * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineminus">- * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineminus">- * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineminus">- * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineminus">- * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineminus">- * the provisions above, a recipient may use your version of this file under</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineminus">- * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineminus">- *</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineminus">- * ***** END LICENSE BLOCK ***** */</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineminus">-</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineminus">-/***************************************************************************</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineminus">-*</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineminus">-* This File is no longer used by Thunderbird. Seamonkey is the only consumer.</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineminus">-* See mozilla/mail/components/shell for the Thunderbird registry code</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineminus">-*</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineminus">-*****************************************************************************/</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineminus">-</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineminus">-#undef UNICODE</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineminus">-#undef _UNICODE</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineminus">-</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineminus">-#include &quot;nsIServiceManager.h&quot;</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineminus">-#include &quot;msgMapiImp.h&quot;</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineminus">-#include &quot;msgMapiMain.h&quot;</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineminus">-#include &quot;nsMapiRegistryUtils.h&quot;</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineminus">-#include &quot;nsString.h&quot;</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineminus">-#include &quot;nsIStringBundle.h&quot;</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineminus">-#include &quot;nsIPromptService.h&quot;</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineminus">-#include &quot;plstr.h&quot;</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineminus">-#include &quot;nsDirectoryService.h&quot;</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineminus">-#include &quot;nsDirectoryServiceDefs.h&quot;</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineminus">-#include &quot;nsAppDirectoryServiceDefs.h&quot;</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineminus">-#include &quot;nsNativeCharsetUtils.h&quot;</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineminus">-#include &quot;nsEmbedCID.h&quot;</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineminus">-#include &quot;nsIMapiSupport.h&quot;</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineminus">-#include &lt;mbstring.h&gt;</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineminus">-</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineminus">-#define EXE_EXTENSION &quot;.EXE&quot;</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineminus">-#define MOZ_HWND_BROADCAST_MSG_TIMEOUT 5000</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineminus">-#define MOZ_CLIENT_MAIL_KEY &quot;Software\\Clients\\Mail&quot;</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineminus">-#define MOZ_CLIENT_NEWS_KEY &quot;Software\\Clients\\News&quot;</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineminus">-</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineminus">-nsMapiRegistryUtils::nsMapiRegistryUtils()</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineminus">-{</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineminus">-   m_mapiStringBundle = nsnull ;</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineminus">-</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineminus">-   mRestrictedRegAccess = verifyRestrictedAccess();</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineminus">-}</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineminus">-</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineminus">-const char * nsMapiRegistryUtils::thisApplication()</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineminus">-{</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineminus">-    if (m_thisApp.IsEmpty()) {</span>
<a href="#l8.86"></a><span id="l8.86" class="difflineminus">-        char buffer[MAX_PATH] = {0};</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineminus">-        DWORD len = ::GetModuleFileName(NULL, buffer, MAX_PATH);</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineminus">-        if (!len) return nsnull ;</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineminus">-        len = ::GetShortPathName(buffer, buffer, MAX_PATH);</span>
<a href="#l8.90"></a><span id="l8.90" class="difflineminus">-        if (!len) return nsnull ;</span>
<a href="#l8.91"></a><span id="l8.91" class="difflineminus">-        m_thisApp = buffer;</span>
<a href="#l8.92"></a><span id="l8.92" class="difflineminus">-        ToUpperCase(m_thisApp);</span>
<a href="#l8.93"></a><span id="l8.93" class="difflineminus">-    }</span>
<a href="#l8.94"></a><span id="l8.94" class="difflineminus">-</span>
<a href="#l8.95"></a><span id="l8.95" class="difflineminus">-    return m_thisApp.get() ;</span>
<a href="#l8.96"></a><span id="l8.96" class="difflineminus">-}</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineminus">-</span>
<a href="#l8.98"></a><span id="l8.98" class="difflineminus">-void nsMapiRegistryUtils::getVarValue(const PRUnichar * varName, nsString &amp; result)</span>
<a href="#l8.99"></a><span id="l8.99" class="difflineminus">-{</span>
<a href="#l8.100"></a><span id="l8.100" class="difflineminus">-  nsresult rv;</span>
<a href="#l8.101"></a><span id="l8.101" class="difflineminus">-  nsCOMPtr&lt;nsIStringBundleService&gt; bundleService(do_GetService(</span>
<a href="#l8.102"></a><span id="l8.102" class="difflineminus">-                                       NS_STRINGBUNDLE_CONTRACTID, &amp;rv));</span>
<a href="#l8.103"></a><span id="l8.103" class="difflineminus">-  if (NS_FAILED(rv)) return;</span>
<a href="#l8.104"></a><span id="l8.104" class="difflineminus">-  nsCOMPtr&lt;nsIStringBundle&gt; brandBundle;</span>
<a href="#l8.105"></a><span id="l8.105" class="difflineminus">-  rv = bundleService-&gt;CreateBundle(</span>
<a href="#l8.106"></a><span id="l8.106" class="difflineminus">-              &quot;chrome://branding/locale/brand.properties&quot;,</span>
<a href="#l8.107"></a><span id="l8.107" class="difflineminus">-              getter_AddRefs(brandBundle));</span>
<a href="#l8.108"></a><span id="l8.108" class="difflineminus">-  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l8.109"></a><span id="l8.109" class="difflineminus">-    brandBundle-&gt;GetStringFromName(</span>
<a href="#l8.110"></a><span id="l8.110" class="difflineminus">-               varName,</span>
<a href="#l8.111"></a><span id="l8.111" class="difflineminus">-               getter_Copies(result));</span>
<a href="#l8.112"></a><span id="l8.112" class="difflineminus">-  }</span>
<a href="#l8.113"></a><span id="l8.113" class="difflineminus">-}</span>
<a href="#l8.114"></a><span id="l8.114" class="difflineminus">-</span>
<a href="#l8.115"></a><span id="l8.115" class="difflineminus">-const PRUnichar * nsMapiRegistryUtils::brandName()</span>
<a href="#l8.116"></a><span id="l8.116" class="difflineminus">-{</span>
<a href="#l8.117"></a><span id="l8.117" class="difflineminus">-  if (m_brand.IsEmpty())</span>
<a href="#l8.118"></a><span id="l8.118" class="difflineminus">-    getVarValue(NS_LITERAL_STRING(&quot;brandFullName&quot;).get(), m_brand);</span>
<a href="#l8.119"></a><span id="l8.119" class="difflineminus">-  return m_brand.get();</span>
<a href="#l8.120"></a><span id="l8.120" class="difflineminus">-}</span>
<a href="#l8.121"></a><span id="l8.121" class="difflineminus">-</span>
<a href="#l8.122"></a><span id="l8.122" class="difflineminus">-const nsString&amp; nsMapiRegistryUtils::vendorName()</span>
<a href="#l8.123"></a><span id="l8.123" class="difflineminus">-{</span>
<a href="#l8.124"></a><span id="l8.124" class="difflineminus">-  if (m_vendor.IsEmpty())</span>
<a href="#l8.125"></a><span id="l8.125" class="difflineminus">-    getVarValue(NS_LITERAL_STRING(&quot;vendorShortName&quot;).get(), m_vendor);</span>
<a href="#l8.126"></a><span id="l8.126" class="difflineminus">-  return m_vendor;</span>
<a href="#l8.127"></a><span id="l8.127" class="difflineminus">-}</span>
<a href="#l8.128"></a><span id="l8.128" class="difflineminus">-</span>
<a href="#l8.129"></a><span id="l8.129" class="difflineminus">-</span>
<a href="#l8.130"></a><span id="l8.130" class="difflineminus">-PRBool nsMapiRegistryUtils::verifyRestrictedAccess() {</span>
<a href="#l8.131"></a><span id="l8.131" class="difflineminus">-  char   subKey[] = &quot;Software\\Mozilla - Test Key&quot;;</span>
<a href="#l8.132"></a><span id="l8.132" class="difflineminus">-  PRBool result = PR_FALSE;</span>
<a href="#l8.133"></a><span id="l8.133" class="difflineminus">-  DWORD  dwDisp = 0;</span>
<a href="#l8.134"></a><span id="l8.134" class="difflineminus">-  HKEY   key;</span>
<a href="#l8.135"></a><span id="l8.135" class="difflineminus">-  // Try to create/open a subkey under HKLM.</span>
<a href="#l8.136"></a><span id="l8.136" class="difflineminus">-  DWORD rc = ::RegCreateKeyEx(HKEY_LOCAL_MACHINE,</span>
<a href="#l8.137"></a><span id="l8.137" class="difflineminus">-                              subKey,</span>
<a href="#l8.138"></a><span id="l8.138" class="difflineminus">-                              0,</span>
<a href="#l8.139"></a><span id="l8.139" class="difflineminus">-                              NULL,</span>
<a href="#l8.140"></a><span id="l8.140" class="difflineminus">-                              REG_OPTION_NON_VOLATILE,</span>
<a href="#l8.141"></a><span id="l8.141" class="difflineminus">-                              KEY_WRITE,</span>
<a href="#l8.142"></a><span id="l8.142" class="difflineminus">-                              NULL,</span>
<a href="#l8.143"></a><span id="l8.143" class="difflineminus">-                              &amp;key,</span>
<a href="#l8.144"></a><span id="l8.144" class="difflineminus">-                              &amp;dwDisp);</span>
<a href="#l8.145"></a><span id="l8.145" class="difflineminus">-</span>
<a href="#l8.146"></a><span id="l8.146" class="difflineminus">-  if (rc == ERROR_SUCCESS) {</span>
<a href="#l8.147"></a><span id="l8.147" class="difflineminus">-    // Key was opened; first close it.</span>
<a href="#l8.148"></a><span id="l8.148" class="difflineminus">-    ::RegCloseKey(key);</span>
<a href="#l8.149"></a><span id="l8.149" class="difflineminus">-    // Delete it if we just created it.</span>
<a href="#l8.150"></a><span id="l8.150" class="difflineminus">-    switch(dwDisp) {</span>
<a href="#l8.151"></a><span id="l8.151" class="difflineminus">-        case REG_CREATED_NEW_KEY:</span>
<a href="#l8.152"></a><span id="l8.152" class="difflineminus">-            ::RegDeleteKey(HKEY_LOCAL_MACHINE, subKey);</span>
<a href="#l8.153"></a><span id="l8.153" class="difflineminus">-            break;</span>
<a href="#l8.154"></a><span id="l8.154" class="difflineminus">-        case REG_OPENED_EXISTING_KEY:</span>
<a href="#l8.155"></a><span id="l8.155" class="difflineminus">-            break;</span>
<a href="#l8.156"></a><span id="l8.156" class="difflineminus">-    }</span>
<a href="#l8.157"></a><span id="l8.157" class="difflineminus">-  } else {</span>
<a href="#l8.158"></a><span id="l8.158" class="difflineminus">-    // Can't create/open it; we don't have access.</span>
<a href="#l8.159"></a><span id="l8.159" class="difflineminus">-    result = PR_TRUE;</span>
<a href="#l8.160"></a><span id="l8.160" class="difflineminus">-  }</span>
<a href="#l8.161"></a><span id="l8.161" class="difflineminus">-  return result;</span>
<a href="#l8.162"></a><span id="l8.162" class="difflineminus">-}</span>
<a href="#l8.163"></a><span id="l8.163" class="difflineminus">-</span>
<a href="#l8.164"></a><span id="l8.164" class="difflineminus">-nsresult nsMapiRegistryUtils::SetRegistryKey(HKEY baseKey, const char * keyName,</span>
<a href="#l8.165"></a><span id="l8.165" class="difflineminus">-                        const char * valueName, char * value)</span>
<a href="#l8.166"></a><span id="l8.166" class="difflineminus">-{</span>
<a href="#l8.167"></a><span id="l8.167" class="difflineminus">-    nsresult result = NS_ERROR_FAILURE;</span>
<a href="#l8.168"></a><span id="l8.168" class="difflineminus">-    HKEY   key;</span>
<a href="#l8.169"></a><span id="l8.169" class="difflineminus">-    LONG   rc = ::RegCreateKey(baseKey, keyName, &amp;key);</span>
<a href="#l8.170"></a><span id="l8.170" class="difflineminus">-</span>
<a href="#l8.171"></a><span id="l8.171" class="difflineminus">-    if (rc == ERROR_SUCCESS) {</span>
<a href="#l8.172"></a><span id="l8.172" class="difflineminus">-        rc = ::RegSetValueEx(key, valueName, NULL, REG_SZ,</span>
<a href="#l8.173"></a><span id="l8.173" class="difflineminus">-                                 (LPBYTE)(const char*)value, strlen(value));</span>
<a href="#l8.174"></a><span id="l8.174" class="difflineminus">-        if (rc == ERROR_SUCCESS) {</span>
<a href="#l8.175"></a><span id="l8.175" class="difflineminus">-            result = NS_OK;</span>
<a href="#l8.176"></a><span id="l8.176" class="difflineminus">-        }</span>
<a href="#l8.177"></a><span id="l8.177" class="difflineminus">-        ::RegCloseKey(key);</span>
<a href="#l8.178"></a><span id="l8.178" class="difflineminus">-    }</span>
<a href="#l8.179"></a><span id="l8.179" class="difflineminus">-    return result;</span>
<a href="#l8.180"></a><span id="l8.180" class="difflineminus">-}</span>
<a href="#l8.181"></a><span id="l8.181" class="difflineminus">-</span>
<a href="#l8.182"></a><span id="l8.182" class="difflineminus">-nsresult nsMapiRegistryUtils::DeleteRegistryValue(HKEY baseKey, const char * keyName,</span>
<a href="#l8.183"></a><span id="l8.183" class="difflineminus">-                        const char * valueName)</span>
<a href="#l8.184"></a><span id="l8.184" class="difflineminus">-{</span>
<a href="#l8.185"></a><span id="l8.185" class="difflineminus">-    nsresult result = NS_ERROR_FAILURE;</span>
<a href="#l8.186"></a><span id="l8.186" class="difflineminus">-    HKEY   key;</span>
<a href="#l8.187"></a><span id="l8.187" class="difflineminus">-    LONG   rc = ::RegOpenKey(baseKey, keyName, &amp;key);</span>
<a href="#l8.188"></a><span id="l8.188" class="difflineminus">-</span>
<a href="#l8.189"></a><span id="l8.189" class="difflineminus">-    if (rc == ERROR_SUCCESS) {</span>
<a href="#l8.190"></a><span id="l8.190" class="difflineminus">-        rc = ::RegDeleteValue(key, valueName);</span>
<a href="#l8.191"></a><span id="l8.191" class="difflineminus">-        if (rc == ERROR_SUCCESS)</span>
<a href="#l8.192"></a><span id="l8.192" class="difflineminus">-            result = NS_OK;</span>
<a href="#l8.193"></a><span id="l8.193" class="difflineminus">-        ::RegCloseKey(key);</span>
<a href="#l8.194"></a><span id="l8.194" class="difflineminus">-    }</span>
<a href="#l8.195"></a><span id="l8.195" class="difflineminus">-    return result;</span>
<a href="#l8.196"></a><span id="l8.196" class="difflineminus">-}</span>
<a href="#l8.197"></a><span id="l8.197" class="difflineminus">-</span>
<a href="#l8.198"></a><span id="l8.198" class="difflineminus">-void nsMapiRegistryUtils::GetRegistryKey(HKEY baseKey, const char * keyName,</span>
<a href="#l8.199"></a><span id="l8.199" class="difflineminus">-                         const char * valueName, nsCAutoString &amp; value)</span>
<a href="#l8.200"></a><span id="l8.200" class="difflineminus">-{</span>
<a href="#l8.201"></a><span id="l8.201" class="difflineminus">-    HKEY   key;</span>
<a href="#l8.202"></a><span id="l8.202" class="difflineminus">-    LONG   rc = ::RegOpenKey(baseKey, keyName, &amp;key);</span>
<a href="#l8.203"></a><span id="l8.203" class="difflineminus">-    if (rc == ERROR_SUCCESS) {</span>
<a href="#l8.204"></a><span id="l8.204" class="difflineminus">-        char buffer[MAX_PATH] = {0};</span>
<a href="#l8.205"></a><span id="l8.205" class="difflineminus">-        DWORD len = sizeof buffer;</span>
<a href="#l8.206"></a><span id="l8.206" class="difflineminus">-        rc = ::RegQueryValueEx(key, valueName, NULL, NULL,</span>
<a href="#l8.207"></a><span id="l8.207" class="difflineminus">-                               (LPBYTE)buffer, &amp;len);</span>
<a href="#l8.208"></a><span id="l8.208" class="difflineminus">-        if (rc == ERROR_SUCCESS) {</span>
<a href="#l8.209"></a><span id="l8.209" class="difflineminus">-            if (len)</span>
<a href="#l8.210"></a><span id="l8.210" class="difflineminus">-                value = buffer;</span>
<a href="#l8.211"></a><span id="l8.211" class="difflineminus">-        }</span>
<a href="#l8.212"></a><span id="l8.212" class="difflineminus">-        ::RegCloseKey(key);</span>
<a href="#l8.213"></a><span id="l8.213" class="difflineminus">-     }</span>
<a href="#l8.214"></a><span id="l8.214" class="difflineminus">-}</span>
<a href="#l8.215"></a><span id="l8.215" class="difflineminus">-</span>
<a href="#l8.216"></a><span id="l8.216" class="difflineminus">-nsresult nsMapiRegistryUtils::recursiveDeleteKey(HKEY hKeyParent, const char* lpszKeyChild)</span>
<a href="#l8.217"></a><span id="l8.217" class="difflineminus">-{</span>
<a href="#l8.218"></a><span id="l8.218" class="difflineminus">-    // Open the child.</span>
<a href="#l8.219"></a><span id="l8.219" class="difflineminus">-    HKEY hKeyChild ;</span>
<a href="#l8.220"></a><span id="l8.220" class="difflineminus">-    nsresult rv = NS_OK;</span>
<a href="#l8.221"></a><span id="l8.221" class="difflineminus">-</span>
<a href="#l8.222"></a><span id="l8.222" class="difflineminus">-    LONG lRes = ::RegOpenKeyEx(hKeyParent, lpszKeyChild, 0, KEY_ALL_ACCESS, &amp;hKeyChild);</span>
<a href="#l8.223"></a><span id="l8.223" class="difflineminus">-    if (lRes != ERROR_SUCCESS)</span>
<a href="#l8.224"></a><span id="l8.224" class="difflineminus">-        return NS_ERROR_FAILURE;</span>
<a href="#l8.225"></a><span id="l8.225" class="difflineminus">-</span>
<a href="#l8.226"></a><span id="l8.226" class="difflineminus">-    // Enumerate all of the decendents of this child.</span>
<a href="#l8.227"></a><span id="l8.227" class="difflineminus">-    FILETIME time;</span>
<a href="#l8.228"></a><span id="l8.228" class="difflineminus">-    char szBuffer[MAX_PATH+1];</span>
<a href="#l8.229"></a><span id="l8.229" class="difflineminus">-    DWORD dwSize = MAX_PATH+1;</span>
<a href="#l8.230"></a><span id="l8.230" class="difflineminus">-    while (::RegEnumKeyEx(hKeyChild, 0, szBuffer, &amp;dwSize, NULL, NULL, NULL, &amp;time) == S_OK)</span>
<a href="#l8.231"></a><span id="l8.231" class="difflineminus">-    {</span>
<a href="#l8.232"></a><span id="l8.232" class="difflineminus">-        // Delete the decendents of this child.</span>
<a href="#l8.233"></a><span id="l8.233" class="difflineminus">-        rv = recursiveDeleteKey(hKeyChild, szBuffer);</span>
<a href="#l8.234"></a><span id="l8.234" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l8.235"></a><span id="l8.235" class="difflineminus">-        {</span>
<a href="#l8.236"></a><span id="l8.236" class="difflineminus">-            // Cleanup before exiting.</span>
<a href="#l8.237"></a><span id="l8.237" class="difflineminus">-            ::RegCloseKey(hKeyChild);</span>
<a href="#l8.238"></a><span id="l8.238" class="difflineminus">-            return rv;</span>
<a href="#l8.239"></a><span id="l8.239" class="difflineminus">-        }</span>
<a href="#l8.240"></a><span id="l8.240" class="difflineminus">-</span>
<a href="#l8.241"></a><span id="l8.241" class="difflineminus">-        dwSize = MAX_PATH+1;</span>
<a href="#l8.242"></a><span id="l8.242" class="difflineminus">-    }</span>
<a href="#l8.243"></a><span id="l8.243" class="difflineminus">-</span>
<a href="#l8.244"></a><span id="l8.244" class="difflineminus">-    // Close the child.</span>
<a href="#l8.245"></a><span id="l8.245" class="difflineminus">-    ::RegCloseKey(hKeyChild);</span>
<a href="#l8.246"></a><span id="l8.246" class="difflineminus">-</span>
<a href="#l8.247"></a><span id="l8.247" class="difflineminus">-    // Delete this child.</span>
<a href="#l8.248"></a><span id="l8.248" class="difflineminus">-    ::RegDeleteKey(hKeyParent, lpszKeyChild);</span>
<a href="#l8.249"></a><span id="l8.249" class="difflineminus">-    return rv;</span>
<a href="#l8.250"></a><span id="l8.250" class="difflineminus">-}</span>
<a href="#l8.251"></a><span id="l8.251" class="difflineminus">-</span>
<a href="#l8.252"></a><span id="l8.252" class="difflineminus">-/* static */</span>
<a href="#l8.253"></a><span id="l8.253" class="difflineminus">-void nsMapiRegistryUtils::RegCopyKey(HKEY aSrcKey, HKEY aDestKey, const char* aSubKeyName)</span>
<a href="#l8.254"></a><span id="l8.254" class="difflineminus">-{</span>
<a href="#l8.255"></a><span id="l8.255" class="difflineminus">-  HKEY srcSubKey, destSubKey;</span>
<a href="#l8.256"></a><span id="l8.256" class="difflineminus">-  char valueName[MAX_PATH + 1], keyName[MAX_PATH + 1];</span>
<a href="#l8.257"></a><span id="l8.257" class="difflineminus">-  BYTE valueData[MAX_PATH + 1];</span>
<a href="#l8.258"></a><span id="l8.258" class="difflineminus">-  DWORD nameSize, dataSize, keySize, valueType;</span>
<a href="#l8.259"></a><span id="l8.259" class="difflineminus">-</span>
<a href="#l8.260"></a><span id="l8.260" class="difflineminus">-  // open source key</span>
<a href="#l8.261"></a><span id="l8.261" class="difflineminus">-  if (::RegOpenKeyEx(aSrcKey, aSubKeyName, NULL, KEY_ALL_ACCESS, &amp;srcSubKey) != ERROR_SUCCESS)</span>
<a href="#l8.262"></a><span id="l8.262" class="difflineminus">-    return;</span>
<a href="#l8.263"></a><span id="l8.263" class="difflineminus">-</span>
<a href="#l8.264"></a><span id="l8.264" class="difflineminus">-  // create target key</span>
<a href="#l8.265"></a><span id="l8.265" class="difflineminus">-  if (::RegCreateKeyEx(aDestKey, aSubKeyName, NULL, NULL, REG_OPTION_NON_VOLATILE, KEY_ALL_ACCESS, NULL, &amp;destSubKey, NULL) == ERROR_SUCCESS) {</span>
<a href="#l8.266"></a><span id="l8.266" class="difflineminus">-    for (DWORD valueIndex = 0;</span>
<a href="#l8.267"></a><span id="l8.267" class="difflineminus">-         nameSize = MAX_PATH + 1,</span>
<a href="#l8.268"></a><span id="l8.268" class="difflineminus">-         dataSize = MAX_PATH + 1,</span>
<a href="#l8.269"></a><span id="l8.269" class="difflineminus">-         ::RegEnumValue(srcSubKey, valueIndex, valueName, &amp;nameSize, NULL, &amp;valueType, valueData, &amp;dataSize) == ERROR_SUCCESS;</span>
<a href="#l8.270"></a><span id="l8.270" class="difflineminus">-         valueIndex++)</span>
<a href="#l8.271"></a><span id="l8.271" class="difflineminus">-      ::RegSetValueEx(destSubKey, valueName, NULL, valueType, valueData, dataSize);</span>
<a href="#l8.272"></a><span id="l8.272" class="difflineminus">-</span>
<a href="#l8.273"></a><span id="l8.273" class="difflineminus">-    for (DWORD keyIndex = 0;</span>
<a href="#l8.274"></a><span id="l8.274" class="difflineminus">-         keySize = MAX_PATH + 1,</span>
<a href="#l8.275"></a><span id="l8.275" class="difflineminus">-         ::RegEnumKeyEx(srcSubKey, keyIndex, keyName, &amp;keySize, NULL, NULL, NULL, NULL) == ERROR_SUCCESS;</span>
<a href="#l8.276"></a><span id="l8.276" class="difflineminus">-         keyIndex++)</span>
<a href="#l8.277"></a><span id="l8.277" class="difflineminus">-      RegCopyKey(srcSubKey, destSubKey, keyName);</span>
<a href="#l8.278"></a><span id="l8.278" class="difflineminus">-</span>
<a href="#l8.279"></a><span id="l8.279" class="difflineminus">-    ::RegCloseKey(destSubKey);</span>
<a href="#l8.280"></a><span id="l8.280" class="difflineminus">-  }</span>
<a href="#l8.281"></a><span id="l8.281" class="difflineminus">-  ::RegCloseKey(srcSubKey);</span>
<a href="#l8.282"></a><span id="l8.282" class="difflineminus">-}</span>
<a href="#l8.283"></a><span id="l8.283" class="difflineminus">-</span>
<a href="#l8.284"></a><span id="l8.284" class="difflineminus">-PRBool nsMapiRegistryUtils::IsDefaultMailClient()</span>
<a href="#l8.285"></a><span id="l8.285" class="difflineminus">-{</span>
<a href="#l8.286"></a><span id="l8.286" class="difflineminus">-    if (!isSmartDll() &amp;&amp; !isMozDll())</span>
<a href="#l8.287"></a><span id="l8.287" class="difflineminus">-        return PR_FALSE;</span>
<a href="#l8.288"></a><span id="l8.288" class="difflineminus">-</span>
<a href="#l8.289"></a><span id="l8.289" class="difflineminus">-    //first try to get the users default mail client</span>
<a href="#l8.290"></a><span id="l8.290" class="difflineminus">-    nsCAutoString name;</span>
<a href="#l8.291"></a><span id="l8.291" class="difflineminus">-    // old mail clients like netscape 4.x never channge the current user key, so it is possible for them to become</span>
<a href="#l8.292"></a><span id="l8.292" class="difflineminus">-    // the default mail client and we don't notice because we see that thunderbird still owns the HKCU key...</span>
<a href="#l8.293"></a><span id="l8.293" class="difflineminus">-    // doh!</span>
<a href="#l8.294"></a><span id="l8.294" class="difflineminus">-    // GetRegistryKey(HKEY_CURRENT_USER, &quot;Software\\Clients\\Mail&quot;, &quot;&quot;, name);</span>
<a href="#l8.295"></a><span id="l8.295" class="difflineminus">-</span>
<a href="#l8.296"></a><span id="l8.296" class="difflineminus">-    //if that fails then get the machine's default client</span>
<a href="#l8.297"></a><span id="l8.297" class="difflineminus">-    GetRegistryKey(HKEY_LOCAL_MACHINE, &quot;Software\\Clients\\Mail&quot;, &quot;&quot;, name);</span>
<a href="#l8.298"></a><span id="l8.298" class="difflineminus">-</span>
<a href="#l8.299"></a><span id="l8.299" class="difflineminus">-    if (!name.IsEmpty()) {</span>
<a href="#l8.300"></a><span id="l8.300" class="difflineminus">-         nsCAutoString keyName(&quot;Software\\Clients\\Mail\\&quot;);</span>
<a href="#l8.301"></a><span id="l8.301" class="difflineminus">-         keyName += name.get();</span>
<a href="#l8.302"></a><span id="l8.302" class="difflineminus">-         keyName += &quot;\\Protocols\\mailto\\shell\\open\\command&quot;;</span>
<a href="#l8.303"></a><span id="l8.303" class="difflineminus">-</span>
<a href="#l8.304"></a><span id="l8.304" class="difflineminus">-         nsCAutoString result;</span>
<a href="#l8.305"></a><span id="l8.305" class="difflineminus">-         GetRegistryKey(HKEY_LOCAL_MACHINE, keyName.get(), &quot;&quot;, result);</span>
<a href="#l8.306"></a><span id="l8.306" class="difflineminus">-         if (!result.IsEmpty()) {</span>
<a href="#l8.307"></a><span id="l8.307" class="difflineminus">-             nsCAutoString strExtension;</span>
<a href="#l8.308"></a><span id="l8.308" class="difflineminus">-             strExtension.Assign(EXE_EXTENSION);</span>
<a href="#l8.309"></a><span id="l8.309" class="difflineminus">-             ToUpperCase(result);</span>
<a href="#l8.310"></a><span id="l8.310" class="difflineminus">-             PRInt32 index = result.RFind(strExtension.get());</span>
<a href="#l8.311"></a><span id="l8.311" class="difflineminus">-             if (index != kNotFound) {</span>
<a href="#l8.312"></a><span id="l8.312" class="difflineminus">-                 result.Truncate(index + strExtension.Length());</span>
<a href="#l8.313"></a><span id="l8.313" class="difflineminus">-             }</span>
<a href="#l8.314"></a><span id="l8.314" class="difflineminus">-</span>
<a href="#l8.315"></a><span id="l8.315" class="difflineminus">-             nsCAutoString thisApp (thisApplication());</span>
<a href="#l8.316"></a><span id="l8.316" class="difflineminus">-             // if result == thisApp, that by itself isn't a strong enough indication that everything</span>
<a href="#l8.317"></a><span id="l8.317" class="difflineminus">-             // is ok...also check HKLM\Software\Classes\mailto\shell\open\command</span>
<a href="#l8.318"></a><span id="l8.318" class="difflineminus">-             if (result == thisApp)</span>
<a href="#l8.319"></a><span id="l8.319" class="difflineminus">-             {</span>
<a href="#l8.320"></a><span id="l8.320" class="difflineminus">-               keyName = &quot;Software\\Classes\\mailto\\shell\\open\\command&quot;;</span>
<a href="#l8.321"></a><span id="l8.321" class="difflineminus">-               nsCAutoString result;</span>
<a href="#l8.322"></a><span id="l8.322" class="difflineminus">-               GetRegistryKey(HKEY_LOCAL_MACHINE, keyName.get(), &quot;&quot;, result);</span>
<a href="#l8.323"></a><span id="l8.323" class="difflineminus">-               if (!result.IsEmpty()) {</span>
<a href="#l8.324"></a><span id="l8.324" class="difflineminus">-                  nsCAutoString strExtension;</span>
<a href="#l8.325"></a><span id="l8.325" class="difflineminus">-                  strExtension.Assign(EXE_EXTENSION);</span>
<a href="#l8.326"></a><span id="l8.326" class="difflineminus">-                  ToUpperCase(result);</span>
<a href="#l8.327"></a><span id="l8.327" class="difflineminus">-                  PRInt32 index = result.RFind(strExtension.get());</span>
<a href="#l8.328"></a><span id="l8.328" class="difflineminus">-                  if (index != kNotFound)</span>
<a href="#l8.329"></a><span id="l8.329" class="difflineminus">-                    result.Truncate(index + strExtension.Length());</span>
<a href="#l8.330"></a><span id="l8.330" class="difflineminus">-                  return (result == thisApp);</span>
<a href="#l8.331"></a><span id="l8.331" class="difflineminus">-               }</span>
<a href="#l8.332"></a><span id="l8.332" class="difflineminus">-             }</span>
<a href="#l8.333"></a><span id="l8.333" class="difflineminus">-        }</span>
<a href="#l8.334"></a><span id="l8.334" class="difflineminus">-    }</span>
<a href="#l8.335"></a><span id="l8.335" class="difflineminus">-    return PR_FALSE;</span>
<a href="#l8.336"></a><span id="l8.336" class="difflineminus">-</span>
<a href="#l8.337"></a><span id="l8.337" class="difflineminus">-}</span>
<a href="#l8.338"></a><span id="l8.338" class="difflineminus">-</span>
<a href="#l8.339"></a><span id="l8.339" class="difflineminus">-PRBool nsMapiRegistryUtils::IsDefaultNewsClient()</span>
<a href="#l8.340"></a><span id="l8.340" class="difflineminus">-{</span>
<a href="#l8.341"></a><span id="l8.341" class="difflineminus">-    //first try to get the users default news client</span>
<a href="#l8.342"></a><span id="l8.342" class="difflineminus">-    nsCAutoString name;</span>
<a href="#l8.343"></a><span id="l8.343" class="difflineminus">-    GetRegistryKey(HKEY_CURRENT_USER, &quot;Software\\Clients\\News&quot;, &quot;&quot;, name);</span>
<a href="#l8.344"></a><span id="l8.344" class="difflineminus">-</span>
<a href="#l8.345"></a><span id="l8.345" class="difflineminus">-     //if that fails then get the machine's default client</span>
<a href="#l8.346"></a><span id="l8.346" class="difflineminus">-    if(name.IsEmpty()) {</span>
<a href="#l8.347"></a><span id="l8.347" class="difflineminus">-        GetRegistryKey(HKEY_LOCAL_MACHINE, &quot;Software\\Clients\\News&quot;, &quot;&quot;, name);</span>
<a href="#l8.348"></a><span id="l8.348" class="difflineminus">-    }</span>
<a href="#l8.349"></a><span id="l8.349" class="difflineminus">-</span>
<a href="#l8.350"></a><span id="l8.350" class="difflineminus">-    if (!name.IsEmpty()) {</span>
<a href="#l8.351"></a><span id="l8.351" class="difflineminus">-         nsCAutoString keyName(&quot;Software\\Clients\\News\\&quot;);</span>
<a href="#l8.352"></a><span id="l8.352" class="difflineminus">-         keyName += name.get();</span>
<a href="#l8.353"></a><span id="l8.353" class="difflineminus">-</span>
<a href="#l8.354"></a><span id="l8.354" class="difflineminus">-         // let's only check news and instead of news, nntp and snews.</span>
<a href="#l8.355"></a><span id="l8.355" class="difflineminus">-         keyName += &quot;\\Protocols\\news\\shell\\open\\command&quot;;</span>
<a href="#l8.356"></a><span id="l8.356" class="difflineminus">-         nsCAutoString result;</span>
<a href="#l8.357"></a><span id="l8.357" class="difflineminus">-         GetRegistryKey(HKEY_LOCAL_MACHINE, keyName.get(), &quot;&quot;, result);</span>
<a href="#l8.358"></a><span id="l8.358" class="difflineminus">-         if (!result.IsEmpty()) {</span>
<a href="#l8.359"></a><span id="l8.359" class="difflineminus">-             nsCAutoString strExtension;</span>
<a href="#l8.360"></a><span id="l8.360" class="difflineminus">-             strExtension.Assign(EXE_EXTENSION);</span>
<a href="#l8.361"></a><span id="l8.361" class="difflineminus">-             ToUpperCase(result);</span>
<a href="#l8.362"></a><span id="l8.362" class="difflineminus">-             PRInt32 index = result.RFind(strExtension.get());</span>
<a href="#l8.363"></a><span id="l8.363" class="difflineminus">-             if (index != kNotFound) {</span>
<a href="#l8.364"></a><span id="l8.364" class="difflineminus">-                 result.Truncate(index + strExtension.Length());</span>
<a href="#l8.365"></a><span id="l8.365" class="difflineminus">-             }</span>
<a href="#l8.366"></a><span id="l8.366" class="difflineminus">-             nsCAutoString thisApp (thisApplication()) ;</span>
<a href="#l8.367"></a><span id="l8.367" class="difflineminus">-             return (result == thisApp);</span>
<a href="#l8.368"></a><span id="l8.368" class="difflineminus">-        }</span>
<a href="#l8.369"></a><span id="l8.369" class="difflineminus">-    }</span>
<a href="#l8.370"></a><span id="l8.370" class="difflineminus">-</span>
<a href="#l8.371"></a><span id="l8.371" class="difflineminus">-    return PR_FALSE;</span>
<a href="#l8.372"></a><span id="l8.372" class="difflineminus">-}</span>
<a href="#l8.373"></a><span id="l8.373" class="difflineminus">-</span>
<a href="#l8.374"></a><span id="l8.374" class="difflineminus">-nsresult nsMapiRegistryUtils::saveDefaultNewsClient()</span>
<a href="#l8.375"></a><span id="l8.375" class="difflineminus">-{</span>
<a href="#l8.376"></a><span id="l8.376" class="difflineminus">-    nsCAutoString name ;</span>
<a href="#l8.377"></a><span id="l8.377" class="difflineminus">-    GetRegistryKey(HKEY_LOCAL_MACHINE,&quot;Software\\Clients\\News&quot;, &quot;&quot;, name);</span>
<a href="#l8.378"></a><span id="l8.378" class="difflineminus">-    return SetRegistryKey(HKEY_LOCAL_MACHINE,</span>
<a href="#l8.379"></a><span id="l8.379" class="difflineminus">-                            kAppDesktopKey,</span>
<a href="#l8.380"></a><span id="l8.380" class="difflineminus">-                            &quot;HKEY_LOCAL_MACHINE\\Software\\Clients\\News&quot;,</span>
<a href="#l8.381"></a><span id="l8.381" class="difflineminus">-                            name.IsEmpty() ? &quot;&quot; : (char *)name.get());</span>
<a href="#l8.382"></a><span id="l8.382" class="difflineminus">-}</span>
<a href="#l8.383"></a><span id="l8.383" class="difflineminus">-</span>
<a href="#l8.384"></a><span id="l8.384" class="difflineminus">-nsresult nsMapiRegistryUtils::saveDefaultMailClient()</span>
<a href="#l8.385"></a><span id="l8.385" class="difflineminus">-{</span>
<a href="#l8.386"></a><span id="l8.386" class="difflineminus">-    nsCAutoString name ;</span>
<a href="#l8.387"></a><span id="l8.387" class="difflineminus">-    GetRegistryKey(HKEY_LOCAL_MACHINE,&quot;Software\\Clients\\Mail&quot;, &quot;&quot;, name);</span>
<a href="#l8.388"></a><span id="l8.388" class="difflineminus">-    return SetRegistryKey(HKEY_LOCAL_MACHINE,</span>
<a href="#l8.389"></a><span id="l8.389" class="difflineminus">-                            kAppDesktopKey,</span>
<a href="#l8.390"></a><span id="l8.390" class="difflineminus">-                            &quot;HKEY_LOCAL_MACHINE\\Software\\Clients\\Mail&quot;,</span>
<a href="#l8.391"></a><span id="l8.391" class="difflineminus">-                            name.IsEmpty() ? &quot;&quot; : (char *)name.get());</span>
<a href="#l8.392"></a><span id="l8.392" class="difflineminus">-}</span>
<a href="#l8.393"></a><span id="l8.393" class="difflineminus">-</span>
<a href="#l8.394"></a><span id="l8.394" class="difflineminus">-nsresult nsMapiRegistryUtils::saveUserDefaultNewsClient()</span>
<a href="#l8.395"></a><span id="l8.395" class="difflineminus">-{</span>
<a href="#l8.396"></a><span id="l8.396" class="difflineminus">-    nsCAutoString name ;</span>
<a href="#l8.397"></a><span id="l8.397" class="difflineminus">-    GetRegistryKey(HKEY_CURRENT_USER,&quot;Software\\Clients\\News&quot;, &quot;&quot;, name);</span>
<a href="#l8.398"></a><span id="l8.398" class="difflineminus">-    return SetRegistryKey(HKEY_LOCAL_MACHINE,</span>
<a href="#l8.399"></a><span id="l8.399" class="difflineminus">-                            kAppDesktopKey,</span>
<a href="#l8.400"></a><span id="l8.400" class="difflineminus">-                            &quot;HKEY_CURRENT_USER\\Software\\Clients\\News&quot;,</span>
<a href="#l8.401"></a><span id="l8.401" class="difflineminus">-                            name.IsEmpty() ? &quot;&quot; : (char *)name.get());</span>
<a href="#l8.402"></a><span id="l8.402" class="difflineminus">-}</span>
<a href="#l8.403"></a><span id="l8.403" class="difflineminus">-</span>
<a href="#l8.404"></a><span id="l8.404" class="difflineminus">-nsresult nsMapiRegistryUtils::saveUserDefaultMailClient()</span>
<a href="#l8.405"></a><span id="l8.405" class="difflineminus">-{</span>
<a href="#l8.406"></a><span id="l8.406" class="difflineminus">-    nsCAutoString name ;</span>
<a href="#l8.407"></a><span id="l8.407" class="difflineminus">-    GetRegistryKey(HKEY_CURRENT_USER,&quot;Software\\Clients\\Mail&quot;, &quot;&quot;, name);</span>
<a href="#l8.408"></a><span id="l8.408" class="difflineminus">-    return SetRegistryKey(HKEY_LOCAL_MACHINE,</span>
<a href="#l8.409"></a><span id="l8.409" class="difflineminus">-                            kAppDesktopKey,</span>
<a href="#l8.410"></a><span id="l8.410" class="difflineminus">-                            &quot;HKEY_CURRENT_USER\\Software\\Clients\\Mail&quot;,</span>
<a href="#l8.411"></a><span id="l8.411" class="difflineminus">-                            name.IsEmpty() ? &quot;&quot; : (char *)name.get());</span>
<a href="#l8.412"></a><span id="l8.412" class="difflineminus">-}</span>
<a href="#l8.413"></a><span id="l8.413" class="difflineminus">-</span>
<a href="#l8.414"></a><span id="l8.414" class="difflineminus">-/**</span>
<a href="#l8.415"></a><span id="l8.415" class="difflineminus">- * Check whether it is a smart dll or not. Smart dll is the one installed by</span>
<a href="#l8.416"></a><span id="l8.416" class="difflineminus">- * IE5 or Outlook Express which forwards the MAPI calls to the dll based on the</span>
<a href="#l8.417"></a><span id="l8.417" class="difflineminus">- * registry key setttings.</span>
<a href="#l8.418"></a><span id="l8.418" class="difflineminus">- * Returns TRUE if is a smart dll.</span>
<a href="#l8.419"></a><span id="l8.419" class="difflineminus">- */</span>
<a href="#l8.420"></a><span id="l8.420" class="difflineminus">-</span>
<a href="#l8.421"></a><span id="l8.421" class="difflineminus">-typedef HRESULT (FAR PASCAL GetOutlookVersionFunc)();</span>
<a href="#l8.422"></a><span id="l8.422" class="difflineminus">-PRBool nsMapiRegistryUtils::isSmartDll()</span>
<a href="#l8.423"></a><span id="l8.423" class="difflineminus">-{</span>
<a href="#l8.424"></a><span id="l8.424" class="difflineminus">-    char buffer[MAX_PATH] = {0};</span>
<a href="#l8.425"></a><span id="l8.425" class="difflineminus">-    if (GetSystemDirectory(buffer, sizeof(buffer)) == 0)</span>
<a href="#l8.426"></a><span id="l8.426" class="difflineminus">-        return PR_FALSE;</span>
<a href="#l8.427"></a><span id="l8.427" class="difflineminus">-    PL_strcatn(buffer, sizeof(buffer), &quot;\\Mapi32.dll&quot;);</span>
<a href="#l8.428"></a><span id="l8.428" class="difflineminus">-</span>
<a href="#l8.429"></a><span id="l8.429" class="difflineminus">-    HINSTANCE hInst;</span>
<a href="#l8.430"></a><span id="l8.430" class="difflineminus">-    GetOutlookVersionFunc *doesExist = nsnull;</span>
<a href="#l8.431"></a><span id="l8.431" class="difflineminus">-    hInst = LoadLibrary(buffer);</span>
<a href="#l8.432"></a><span id="l8.432" class="difflineminus">-    if (hInst == nsnull)</span>
<a href="#l8.433"></a><span id="l8.433" class="difflineminus">-        return PR_FALSE;</span>
<a href="#l8.434"></a><span id="l8.434" class="difflineminus">-</span>
<a href="#l8.435"></a><span id="l8.435" class="difflineminus">-    doesExist = (GetOutlookVersionFunc *) GetProcAddress (hInst, &quot;GetOutlookVersion&quot;);</span>
<a href="#l8.436"></a><span id="l8.436" class="difflineminus">-    FreeLibrary(hInst);</span>
<a href="#l8.437"></a><span id="l8.437" class="difflineminus">-</span>
<a href="#l8.438"></a><span id="l8.438" class="difflineminus">-    return (doesExist != nsnull);</span>
<a href="#l8.439"></a><span id="l8.439" class="difflineminus">-}</span>
<a href="#l8.440"></a><span id="l8.440" class="difflineminus">-</span>
<a href="#l8.441"></a><span id="l8.441" class="difflineminus">-typedef HRESULT (FAR PASCAL GetMapiDllVersion)();</span>
<a href="#l8.442"></a><span id="l8.442" class="difflineminus">-/**</span>
<a href="#l8.443"></a><span id="l8.443" class="difflineminus">- * Checks whether mapi32.dll is installed by this app.</span>
<a href="#l8.444"></a><span id="l8.444" class="difflineminus">- * Returns TRUE if it is.</span>
<a href="#l8.445"></a><span id="l8.445" class="difflineminus">- */</span>
<a href="#l8.446"></a><span id="l8.446" class="difflineminus">-PRBool nsMapiRegistryUtils::isMozDll()</span>
<a href="#l8.447"></a><span id="l8.447" class="difflineminus">-{</span>
<a href="#l8.448"></a><span id="l8.448" class="difflineminus">-    char buffer[MAX_PATH] = {0};</span>
<a href="#l8.449"></a><span id="l8.449" class="difflineminus">-    if (GetSystemDirectory(buffer, sizeof(buffer)) == 0)</span>
<a href="#l8.450"></a><span id="l8.450" class="difflineminus">-        return PR_FALSE;</span>
<a href="#l8.451"></a><span id="l8.451" class="difflineminus">-    PL_strcatn(buffer, sizeof(buffer), &quot;\\Mapi32.dll&quot;);</span>
<a href="#l8.452"></a><span id="l8.452" class="difflineminus">-</span>
<a href="#l8.453"></a><span id="l8.453" class="difflineminus">-    HINSTANCE hInst;</span>
<a href="#l8.454"></a><span id="l8.454" class="difflineminus">-    GetMapiDllVersion *doesExist = nsnull;</span>
<a href="#l8.455"></a><span id="l8.455" class="difflineminus">-    hInst = LoadLibrary(buffer);</span>
<a href="#l8.456"></a><span id="l8.456" class="difflineminus">-    if (hInst == nsnull)</span>
<a href="#l8.457"></a><span id="l8.457" class="difflineminus">-        return PR_FALSE;</span>
<a href="#l8.458"></a><span id="l8.458" class="difflineminus">-</span>
<a href="#l8.459"></a><span id="l8.459" class="difflineminus">-    doesExist = (GetMapiDllVersion *) GetProcAddress (hInst, &quot;GetMapiDllVersion&quot;);</span>
<a href="#l8.460"></a><span id="l8.460" class="difflineminus">-    FreeLibrary(hInst);</span>
<a href="#l8.461"></a><span id="l8.461" class="difflineminus">-</span>
<a href="#l8.462"></a><span id="l8.462" class="difflineminus">-    return (doesExist != nsnull);</span>
<a href="#l8.463"></a><span id="l8.463" class="difflineminus">-}</span>
<a href="#l8.464"></a><span id="l8.464" class="difflineminus">-</span>
<a href="#l8.465"></a><span id="l8.465" class="difflineminus">-/** Renames Mapi32.dl in system directory to Mapi32_moz_bak.dll</span>
<a href="#l8.466"></a><span id="l8.466" class="difflineminus">- *  copies the mozMapi32.dll from bin directory to the system directory</span>
<a href="#l8.467"></a><span id="l8.467" class="difflineminus">- */</span>
<a href="#l8.468"></a><span id="l8.468" class="difflineminus">-nsresult nsMapiRegistryUtils::CopyMozMapiToWinSysDir()</span>
<a href="#l8.469"></a><span id="l8.469" class="difflineminus">-{</span>
<a href="#l8.470"></a><span id="l8.470" class="difflineminus">-    nsresult rv;</span>
<a href="#l8.471"></a><span id="l8.471" class="difflineminus">-    char buffer[MAX_PATH] = {0};</span>
<a href="#l8.472"></a><span id="l8.472" class="difflineminus">-    if (GetSystemDirectory(buffer, sizeof(buffer)) == 0)</span>
<a href="#l8.473"></a><span id="l8.473" class="difflineminus">-        return NS_ERROR_FAILURE;</span>
<a href="#l8.474"></a><span id="l8.474" class="difflineminus">-</span>
<a href="#l8.475"></a><span id="l8.475" class="difflineminus">-    nsCAutoString filePath(buffer);</span>
<a href="#l8.476"></a><span id="l8.476" class="difflineminus">-    filePath.AppendLiteral(&quot;\\Mapi32_moz_bak.dll&quot;);</span>
<a href="#l8.477"></a><span id="l8.477" class="difflineminus">-</span>
<a href="#l8.478"></a><span id="l8.478" class="difflineminus">-    nsCOMPtr&lt;nsILocalFile&gt; pCurrentMapiFile = do_CreateInstance (NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l8.479"></a><span id="l8.479" class="difflineminus">-    if (NS_FAILED(rv) || !pCurrentMapiFile) return rv;</span>
<a href="#l8.480"></a><span id="l8.480" class="difflineminus">-    pCurrentMapiFile-&gt;InitWithNativePath(filePath);</span>
<a href="#l8.481"></a><span id="l8.481" class="difflineminus">-</span>
<a href="#l8.482"></a><span id="l8.482" class="difflineminus">-    nsCOMPtr&lt;nsIFile&gt; pMozMapiFile;</span>
<a href="#l8.483"></a><span id="l8.483" class="difflineminus">-    nsCOMPtr&lt;nsIProperties&gt; directoryService =</span>
<a href="#l8.484"></a><span id="l8.484" class="difflineminus">-          do_GetService(NS_DIRECTORY_SERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l8.485"></a><span id="l8.485" class="difflineminus">-    if (!directoryService) return NS_ERROR_FAILURE;</span>
<a href="#l8.486"></a><span id="l8.486" class="difflineminus">-    rv = directoryService-&gt;Get(NS_OS_CURRENT_PROCESS_DIR,</span>
<a href="#l8.487"></a><span id="l8.487" class="difflineminus">-                              NS_GET_IID(nsIFile),</span>
<a href="#l8.488"></a><span id="l8.488" class="difflineminus">-                              getter_AddRefs(pMozMapiFile));</span>
<a href="#l8.489"></a><span id="l8.489" class="difflineminus">-</span>
<a href="#l8.490"></a><span id="l8.490" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l8.491"></a><span id="l8.491" class="difflineminus">-    pMozMapiFile-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;mozMapi32.dll&quot;));</span>
<a href="#l8.492"></a><span id="l8.492" class="difflineminus">-</span>
<a href="#l8.493"></a><span id="l8.493" class="difflineminus">-    PRBool bExist;</span>
<a href="#l8.494"></a><span id="l8.494" class="difflineminus">-    rv = pMozMapiFile-&gt;Exists(&amp;bExist);</span>
<a href="#l8.495"></a><span id="l8.495" class="difflineminus">-    if (NS_FAILED(rv) || !bExist) return rv;</span>
<a href="#l8.496"></a><span id="l8.496" class="difflineminus">-</span>
<a href="#l8.497"></a><span id="l8.497" class="difflineminus">-    rv = pCurrentMapiFile-&gt;Exists(&amp;bExist);</span>
<a href="#l8.498"></a><span id="l8.498" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; bExist)</span>
<a href="#l8.499"></a><span id="l8.499" class="difflineminus">-    {</span>
<a href="#l8.500"></a><span id="l8.500" class="difflineminus">-        rv = pCurrentMapiFile-&gt;Remove(PR_FALSE);</span>
<a href="#l8.501"></a><span id="l8.501" class="difflineminus">-    }</span>
<a href="#l8.502"></a><span id="l8.502" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l8.503"></a><span id="l8.503" class="difflineminus">-    filePath.Assign(buffer);</span>
<a href="#l8.504"></a><span id="l8.504" class="difflineminus">-    filePath.AppendLiteral(&quot;\\Mapi32.dll&quot;);</span>
<a href="#l8.505"></a><span id="l8.505" class="difflineminus">-    pCurrentMapiFile-&gt;InitWithNativePath(filePath);</span>
<a href="#l8.506"></a><span id="l8.506" class="difflineminus">-    rv = pCurrentMapiFile-&gt;Exists(&amp;bExist);</span>
<a href="#l8.507"></a><span id="l8.507" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; bExist)</span>
<a href="#l8.508"></a><span id="l8.508" class="difflineminus">-    {</span>
<a href="#l8.509"></a><span id="l8.509" class="difflineminus">-        rv = pCurrentMapiFile-&gt;MoveToNative(nsnull, NS_LITERAL_CSTRING(&quot;Mapi32_moz_bak.dll&quot;));</span>
<a href="#l8.510"></a><span id="l8.510" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l8.511"></a><span id="l8.511" class="difflineminus">-        nsCAutoString fullFilePath(buffer);</span>
<a href="#l8.512"></a><span id="l8.512" class="difflineminus">-        fullFilePath.AppendLiteral(&quot;\\Mapi32_moz_bak.dll&quot;);</span>
<a href="#l8.513"></a><span id="l8.513" class="difflineminus">-        rv = SetRegistryKey(HKEY_LOCAL_MACHINE,</span>
<a href="#l8.514"></a><span id="l8.514" class="difflineminus">-                            kAppDesktopKey,</span>
<a href="#l8.515"></a><span id="l8.515" class="difflineminus">-                            &quot;Mapi_backup_dll&quot;,</span>
<a href="#l8.516"></a><span id="l8.516" class="difflineminus">-                            (char *)fullFilePath.get());</span>
<a href="#l8.517"></a><span id="l8.517" class="difflineminus">-        if (NS_FAILED(rv)) {</span>
<a href="#l8.518"></a><span id="l8.518" class="difflineminus">-             RestoreBackedUpMapiDll();</span>
<a href="#l8.519"></a><span id="l8.519" class="difflineminus">-             return rv;</span>
<a href="#l8.520"></a><span id="l8.520" class="difflineminus">-        }</span>
<a href="#l8.521"></a><span id="l8.521" class="difflineminus">-    }</span>
<a href="#l8.522"></a><span id="l8.522" class="difflineminus">-</span>
<a href="#l8.523"></a><span id="l8.523" class="difflineminus">-    NS_NAMED_LITERAL_CSTRING(fileName, &quot;Mapi32.dll&quot;);</span>
<a href="#l8.524"></a><span id="l8.524" class="difflineminus">-    filePath.Assign(buffer);</span>
<a href="#l8.525"></a><span id="l8.525" class="difflineminus">-    pCurrentMapiFile-&gt;InitWithNativePath(filePath);</span>
<a href="#l8.526"></a><span id="l8.526" class="difflineminus">-    rv = pMozMapiFile-&gt;CopyToNative(pCurrentMapiFile, fileName);</span>
<a href="#l8.527"></a><span id="l8.527" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l8.528"></a><span id="l8.528" class="difflineminus">-        RestoreBackedUpMapiDll();</span>
<a href="#l8.529"></a><span id="l8.529" class="difflineminus">-    return rv;</span>
<a href="#l8.530"></a><span id="l8.530" class="difflineminus">-}</span>
<a href="#l8.531"></a><span id="l8.531" class="difflineminus">-</span>
<a href="#l8.532"></a><span id="l8.532" class="difflineminus">-/** deletes the Mapi32.dll in system directory and renames Mapi32_moz_bak.dll</span>
<a href="#l8.533"></a><span id="l8.533" class="difflineminus">- *  to Mapi32.dll</span>
<a href="#l8.534"></a><span id="l8.534" class="difflineminus">- */</span>
<a href="#l8.535"></a><span id="l8.535" class="difflineminus">-nsresult nsMapiRegistryUtils::RestoreBackedUpMapiDll()</span>
<a href="#l8.536"></a><span id="l8.536" class="difflineminus">-{</span>
<a href="#l8.537"></a><span id="l8.537" class="difflineminus">-    nsresult rv;</span>
<a href="#l8.538"></a><span id="l8.538" class="difflineminus">-    char buffer[MAX_PATH] = {0};</span>
<a href="#l8.539"></a><span id="l8.539" class="difflineminus">-    if (GetSystemDirectory(buffer, sizeof(buffer)) == 0)</span>
<a href="#l8.540"></a><span id="l8.540" class="difflineminus">-        return NS_ERROR_FAILURE;</span>
<a href="#l8.541"></a><span id="l8.541" class="difflineminus">-</span>
<a href="#l8.542"></a><span id="l8.542" class="difflineminus">-    nsCAutoString filePath(buffer);</span>
<a href="#l8.543"></a><span id="l8.543" class="difflineminus">-    nsCAutoString previousFileName(buffer);</span>
<a href="#l8.544"></a><span id="l8.544" class="difflineminus">-    filePath.AppendLiteral(&quot;\\Mapi32.dll&quot;);</span>
<a href="#l8.545"></a><span id="l8.545" class="difflineminus">-    previousFileName.AppendLiteral(&quot;\\Mapi32_moz_bak.dll&quot;);</span>
<a href="#l8.546"></a><span id="l8.546" class="difflineminus">-</span>
<a href="#l8.547"></a><span id="l8.547" class="difflineminus">-    nsCOMPtr &lt;nsILocalFile&gt; pCurrentMapiFile = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l8.548"></a><span id="l8.548" class="difflineminus">-    if (NS_FAILED(rv) || !pCurrentMapiFile) return NS_ERROR_FAILURE;</span>
<a href="#l8.549"></a><span id="l8.549" class="difflineminus">-    pCurrentMapiFile-&gt;InitWithNativePath(filePath);</span>
<a href="#l8.550"></a><span id="l8.550" class="difflineminus">-</span>
<a href="#l8.551"></a><span id="l8.551" class="difflineminus">-    nsCOMPtr&lt;nsILocalFile&gt; pPreviousMapiFile = do_CreateInstance (NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l8.552"></a><span id="l8.552" class="difflineminus">-    if (NS_FAILED(rv) || !pPreviousMapiFile) return NS_ERROR_FAILURE;</span>
<a href="#l8.553"></a><span id="l8.553" class="difflineminus">-    pPreviousMapiFile-&gt;InitWithNativePath(previousFileName);</span>
<a href="#l8.554"></a><span id="l8.554" class="difflineminus">-</span>
<a href="#l8.555"></a><span id="l8.555" class="difflineminus">-    PRBool bExist;</span>
<a href="#l8.556"></a><span id="l8.556" class="difflineminus">-    rv = pCurrentMapiFile-&gt;Exists(&amp;bExist);</span>
<a href="#l8.557"></a><span id="l8.557" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; bExist) {</span>
<a href="#l8.558"></a><span id="l8.558" class="difflineminus">-        rv = pCurrentMapiFile-&gt;Remove(PR_FALSE);</span>
<a href="#l8.559"></a><span id="l8.559" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l8.560"></a><span id="l8.560" class="difflineminus">-    }</span>
<a href="#l8.561"></a><span id="l8.561" class="difflineminus">-</span>
<a href="#l8.562"></a><span id="l8.562" class="difflineminus">-    rv = pPreviousMapiFile-&gt;Exists(&amp;bExist);</span>
<a href="#l8.563"></a><span id="l8.563" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; bExist)</span>
<a href="#l8.564"></a><span id="l8.564" class="difflineminus">-        rv = pPreviousMapiFile-&gt;MoveToNative(nsnull, NS_LITERAL_CSTRING(&quot;Mapi32.dll&quot;));</span>
<a href="#l8.565"></a><span id="l8.565" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l8.566"></a><span id="l8.566" class="difflineminus">-        DeleteRegistryValue(HKEY_LOCAL_MACHINE,</span>
<a href="#l8.567"></a><span id="l8.567" class="difflineminus">-                            kAppDesktopKey,</span>
<a href="#l8.568"></a><span id="l8.568" class="difflineminus">-                            &quot;Mapi_backup_dll&quot;);</span>
<a href="#l8.569"></a><span id="l8.569" class="difflineminus">-    return rv;</span>
<a href="#l8.570"></a><span id="l8.570" class="difflineminus">-}</span>
<a href="#l8.571"></a><span id="l8.571" class="difflineminus">-</span>
<a href="#l8.572"></a><span id="l8.572" class="difflineminus">-// aDefaultAppRegKey points to something like Software\Clients\News\Mozilla\Protocols</span>
<a href="#l8.573"></a><span id="l8.573" class="difflineminus">-// we will copy the keys into Software\Clases</span>
<a href="#l8.574"></a><span id="l8.574" class="difflineminus">-nsresult nsMapiRegistryUtils::setProtocolHandler(const char * aDefaultAppRegKey, const char * protocolName)</span>
<a href="#l8.575"></a><span id="l8.575" class="difflineminus">-{</span>
<a href="#l8.576"></a><span id="l8.576" class="difflineminus">-    HKEY srcKey;</span>
<a href="#l8.577"></a><span id="l8.577" class="difflineminus">-    HKEY trgKey;</span>
<a href="#l8.578"></a><span id="l8.578" class="difflineminus">-</span>
<a href="#l8.579"></a><span id="l8.579" class="difflineminus">-    ::RegOpenKeyEx(HKEY_LOCAL_MACHINE, aDefaultAppRegKey, 0, KEY_READ, &amp;srcKey);</span>
<a href="#l8.580"></a><span id="l8.580" class="difflineminus">-    ::RegOpenKeyEx(HKEY_LOCAL_MACHINE,&quot;Software\\Classes&quot;, 0, KEY_READ, &amp;trgKey);</span>
<a href="#l8.581"></a><span id="l8.581" class="difflineminus">-</span>
<a href="#l8.582"></a><span id="l8.582" class="difflineminus">-    RegCopyKey(srcKey, trgKey, protocolName);</span>
<a href="#l8.583"></a><span id="l8.583" class="difflineminus">-</span>
<a href="#l8.584"></a><span id="l8.584" class="difflineminus">-    RegCloseKey(srcKey);</span>
<a href="#l8.585"></a><span id="l8.585" class="difflineminus">-    RegCloseKey(trgKey);</span>
<a href="#l8.586"></a><span id="l8.586" class="difflineminus">-    return NS_OK;</span>
<a href="#l8.587"></a><span id="l8.587" class="difflineminus">-}</span>
<a href="#l8.588"></a><span id="l8.588" class="difflineminus">-</span>
<a href="#l8.589"></a><span id="l8.589" class="difflineminus">-nsresult nsMapiRegistryUtils::setupFileExtension(const char * aDefaultAppRegKey, const char * aExtension)</span>
<a href="#l8.590"></a><span id="l8.590" class="difflineminus">-{</span>
<a href="#l8.591"></a><span id="l8.591" class="difflineminus">-</span>
<a href="#l8.592"></a><span id="l8.592" class="difflineminus">-  // aDefaultAppRegKey is &quot;Software\\Classes\\&quot;</span>
<a href="#l8.593"></a><span id="l8.593" class="difflineminus">-    nsCAutoString keyName;</span>
<a href="#l8.594"></a><span id="l8.594" class="difflineminus">-    keyName = aDefaultAppRegKey;</span>
<a href="#l8.595"></a><span id="l8.595" class="difflineminus">-    keyName.Append(aExtension);</span>
<a href="#l8.596"></a><span id="l8.596" class="difflineminus">-</span>
<a href="#l8.597"></a><span id="l8.597" class="difflineminus">-</span>
<a href="#l8.598"></a><span id="l8.598" class="difflineminus">-    nsCAutoString appName;</span>
<a href="#l8.599"></a><span id="l8.599" class="difflineminus">-    LossyCopyUTF16toASCII(brandName(), appName);</span>
<a href="#l8.600"></a><span id="l8.600" class="difflineminus">-</span>
<a href="#l8.601"></a><span id="l8.601" class="difflineminus">-    // save the current file extension settings to HKEY_LOCAL_MACHINE\Software\Clients\Thunderbird\&lt;extension&gt;</span>
<a href="#l8.602"></a><span id="l8.602" class="difflineminus">-    nsCAutoString saveKeyName(&quot;Software\\Clients\\Mail\\&quot;);</span>
<a href="#l8.603"></a><span id="l8.603" class="difflineminus">-    saveKeyName.Append(appName);</span>
<a href="#l8.604"></a><span id="l8.604" class="difflineminus">-    saveKeyName.AppendLiteral(&quot;\\&quot;);</span>
<a href="#l8.605"></a><span id="l8.605" class="difflineminus">-</span>
<a href="#l8.606"></a><span id="l8.606" class="difflineminus">-    HKEY srcKey;</span>
<a href="#l8.607"></a><span id="l8.607" class="difflineminus">-    HKEY trgKey;</span>
<a href="#l8.608"></a><span id="l8.608" class="difflineminus">-    ::RegOpenKeyEx(HKEY_LOCAL_MACHINE, aDefaultAppRegKey, 0, KEY_READ, &amp;srcKey);</span>
<a href="#l8.609"></a><span id="l8.609" class="difflineminus">-    ::RegOpenKeyEx(HKEY_LOCAL_MACHINE,saveKeyName.get(), 0, KEY_READ, &amp;trgKey);</span>
<a href="#l8.610"></a><span id="l8.610" class="difflineminus">-</span>
<a href="#l8.611"></a><span id="l8.611" class="difflineminus">-    RegCopyKey(srcKey, trgKey, aExtension);</span>
<a href="#l8.612"></a><span id="l8.612" class="difflineminus">-</span>
<a href="#l8.613"></a><span id="l8.613" class="difflineminus">-    nsresult rv = SetRegistryKey(HKEY_LOCAL_MACHINE, keyName.get(), &quot;&quot;, &quot;&quot;);</span>
<a href="#l8.614"></a><span id="l8.614" class="difflineminus">-</span>
<a href="#l8.615"></a><span id="l8.615" class="difflineminus">-</span>
<a href="#l8.616"></a><span id="l8.616" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l8.617"></a><span id="l8.617" class="difflineminus">-    {</span>
<a href="#l8.618"></a><span id="l8.618" class="difflineminus">-      // Classes\&lt;extension&gt;\shell\open\command value</span>
<a href="#l8.619"></a><span id="l8.619" class="difflineminus">-      nsCAutoString appPath (thisApplication());</span>
<a href="#l8.620"></a><span id="l8.620" class="difflineminus">-</span>
<a href="#l8.621"></a><span id="l8.621" class="difflineminus">-      appPath += &quot; &quot;;</span>
<a href="#l8.622"></a><span id="l8.622" class="difflineminus">-</span>
<a href="#l8.623"></a><span id="l8.623" class="difflineminus">-      appPath += &quot;\&quot;%1\&quot;&quot;;</span>
<a href="#l8.624"></a><span id="l8.624" class="difflineminus">-      nsCAutoString shellOpenKey (keyName);</span>
<a href="#l8.625"></a><span id="l8.625" class="difflineminus">-      shellOpenKey.AppendLiteral(&quot;\\shell\\open\\command&quot;);</span>
<a href="#l8.626"></a><span id="l8.626" class="difflineminus">-</span>
<a href="#l8.627"></a><span id="l8.627" class="difflineminus">-      rv = SetRegistryKey(HKEY_LOCAL_MACHINE, shellOpenKey.get(), &quot;&quot;, (char *)appPath.get());</span>
<a href="#l8.628"></a><span id="l8.628" class="difflineminus">-</span>
<a href="#l8.629"></a><span id="l8.629" class="difflineminus">-      // Classes\&lt;extension&gt;\DefaultIcon value</span>
<a href="#l8.630"></a><span id="l8.630" class="difflineminus">-      nsCAutoString iconPath(thisApplication());</span>
<a href="#l8.631"></a><span id="l8.631" class="difflineminus">-      iconPath += &quot;,0&quot;;</span>
<a href="#l8.632"></a><span id="l8.632" class="difflineminus">-      nsCAutoString iconKey (keyName);</span>
<a href="#l8.633"></a><span id="l8.633" class="difflineminus">-      iconKey.AppendLiteral(&quot;\\DefaultIcon&quot;);</span>
<a href="#l8.634"></a><span id="l8.634" class="difflineminus">-      rv = SetRegistryKey(HKEY_LOCAL_MACHINE, iconKey.get(), &quot;&quot;, (char *)iconPath.get());</span>
<a href="#l8.635"></a><span id="l8.635" class="difflineminus">-    }</span>
<a href="#l8.636"></a><span id="l8.636" class="difflineminus">-</span>
<a href="#l8.637"></a><span id="l8.637" class="difflineminus">-    return rv;</span>
<a href="#l8.638"></a><span id="l8.638" class="difflineminus">-}</span>
<a href="#l8.639"></a><span id="l8.639" class="difflineminus">-</span>
<a href="#l8.640"></a><span id="l8.640" class="difflineminus">-nsresult nsMapiRegistryUtils::restoreFileExtension(const char * aDefaultAppRegKey, const char * aExtension)</span>
<a href="#l8.641"></a><span id="l8.641" class="difflineminus">-{</span>
<a href="#l8.642"></a><span id="l8.642" class="difflineminus">-</span>
<a href="#l8.643"></a><span id="l8.643" class="difflineminus">-  // aDefaultAppRegKey is &quot;Software\\Classes\\&quot;</span>
<a href="#l8.644"></a><span id="l8.644" class="difflineminus">-  nsCAutoString keyName;</span>
<a href="#l8.645"></a><span id="l8.645" class="difflineminus">-  keyName = aDefaultAppRegKey;</span>
<a href="#l8.646"></a><span id="l8.646" class="difflineminus">-  keyName.Append(aExtension);</span>
<a href="#l8.647"></a><span id="l8.647" class="difflineminus">-</span>
<a href="#l8.648"></a><span id="l8.648" class="difflineminus">-  nsCAutoString appName;</span>
<a href="#l8.649"></a><span id="l8.649" class="difflineminus">-  LossyCopyUTF16toASCII(brandName(), appName);</span>
<a href="#l8.650"></a><span id="l8.650" class="difflineminus">-</span>
<a href="#l8.651"></a><span id="l8.651" class="difflineminus">-  // restore the file extension settings from HKEY_LOCAL_MACHINE\Software\Clients\Mail\Mail &amp; News\&lt;extension&gt;</span>
<a href="#l8.652"></a><span id="l8.652" class="difflineminus">-</span>
<a href="#l8.653"></a><span id="l8.653" class="difflineminus">-  nsCAutoString saveKeyName(&quot;Software\\Clients\\Mail\\&quot;);</span>
<a href="#l8.654"></a><span id="l8.654" class="difflineminus">-  saveKeyName.Append(appName);</span>
<a href="#l8.655"></a><span id="l8.655" class="difflineminus">-  saveKeyName.AppendLiteral(&quot;\\&quot;);</span>
<a href="#l8.656"></a><span id="l8.656" class="difflineminus">-</span>
<a href="#l8.657"></a><span id="l8.657" class="difflineminus">-  recursiveDeleteKey(HKEY_LOCAL_MACHINE, keyName.get());</span>
<a href="#l8.658"></a><span id="l8.658" class="difflineminus">-  nsresult rv = SetRegistryKey(HKEY_LOCAL_MACHINE, keyName.get(), &quot;&quot;, &quot;&quot;);</span>
<a href="#l8.659"></a><span id="l8.659" class="difflineminus">-</span>
<a href="#l8.660"></a><span id="l8.660" class="difflineminus">-  HKEY srcKey;</span>
<a href="#l8.661"></a><span id="l8.661" class="difflineminus">-  HKEY trgKey;</span>
<a href="#l8.662"></a><span id="l8.662" class="difflineminus">-  ::RegOpenKeyEx(HKEY_LOCAL_MACHINE, saveKeyName.get(), 0, KEY_READ, &amp;srcKey);</span>
<a href="#l8.663"></a><span id="l8.663" class="difflineminus">-  ::RegOpenKeyEx(HKEY_LOCAL_MACHINE, aDefaultAppRegKey, 0, KEY_READ, &amp;trgKey);</span>
<a href="#l8.664"></a><span id="l8.664" class="difflineminus">-</span>
<a href="#l8.665"></a><span id="l8.665" class="difflineminus">-  RegCopyKey(srcKey, trgKey, aExtension);</span>
<a href="#l8.666"></a><span id="l8.666" class="difflineminus">-</span>
<a href="#l8.667"></a><span id="l8.667" class="difflineminus">-  return rv;</span>
<a href="#l8.668"></a><span id="l8.668" class="difflineminus">-}</span>
<a href="#l8.669"></a><span id="l8.669" class="difflineminus">-</span>
<a href="#l8.670"></a><span id="l8.670" class="difflineminus">-</span>
<a href="#l8.671"></a><span id="l8.671" class="difflineminus">-nsresult nsMapiRegistryUtils::setupDefaultProtocolKey(const char * aDefaultAppRegKey, const char * aProtocol, const char * aProtocolEntryValue, const char * aCmdLineText)</span>
<a href="#l8.672"></a><span id="l8.672" class="difflineminus">-{</span>
<a href="#l8.673"></a><span id="l8.673" class="difflineminus">-    nsCAutoString keyName;</span>
<a href="#l8.674"></a><span id="l8.674" class="difflineminus">-    keyName = aDefaultAppRegKey;</span>
<a href="#l8.675"></a><span id="l8.675" class="difflineminus">-    keyName.Append(aProtocol);</span>
<a href="#l8.676"></a><span id="l8.676" class="difflineminus">-</span>
<a href="#l8.677"></a><span id="l8.677" class="difflineminus">-    nsCAutoString temp;</span>
<a href="#l8.678"></a><span id="l8.678" class="difflineminus">-    temp = aProtocolEntryValue;  // XXX this is bogus. SetRegistryKey should not require a char *..it should take a const char *</span>
<a href="#l8.679"></a><span id="l8.679" class="difflineminus">-</span>
<a href="#l8.680"></a><span id="l8.680" class="difflineminus">-    // Protocols\&lt;proto scheme&gt; default value (i.e. URL:News Protocol)</span>
<a href="#l8.681"></a><span id="l8.681" class="difflineminus">-    nsresult rv = SetRegistryKey(HKEY_LOCAL_MACHINE, keyName.get(), &quot;&quot;, (char *) temp.get());</span>
<a href="#l8.682"></a><span id="l8.682" class="difflineminus">-</span>
<a href="#l8.683"></a><span id="l8.683" class="difflineminus">-    SetRegistryKey(HKEY_LOCAL_MACHINE, keyName.get(), &quot;URL Protocol&quot;, &quot;&quot;);</span>
<a href="#l8.684"></a><span id="l8.684" class="difflineminus">-</span>
<a href="#l8.685"></a><span id="l8.685" class="difflineminus">-</span>
<a href="#l8.686"></a><span id="l8.686" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l8.687"></a><span id="l8.687" class="difflineminus">-    {</span>
<a href="#l8.688"></a><span id="l8.688" class="difflineminus">-      // Protocols\&lt;protocol scheme&gt;\shell\open\command value</span>
<a href="#l8.689"></a><span id="l8.689" class="difflineminus">-      nsCAutoString appPath (thisApplication());</span>
<a href="#l8.690"></a><span id="l8.690" class="difflineminus">-</span>
<a href="#l8.691"></a><span id="l8.691" class="difflineminus">-      appPath += &quot; &quot;;</span>
<a href="#l8.692"></a><span id="l8.692" class="difflineminus">-      if (aCmdLineText)</span>
<a href="#l8.693"></a><span id="l8.693" class="difflineminus">-      {</span>
<a href="#l8.694"></a><span id="l8.694" class="difflineminus">-        appPath += aCmdLineText;</span>
<a href="#l8.695"></a><span id="l8.695" class="difflineminus">-        appPath += &quot; &quot;;</span>
<a href="#l8.696"></a><span id="l8.696" class="difflineminus">-      }</span>
<a href="#l8.697"></a><span id="l8.697" class="difflineminus">-</span>
<a href="#l8.698"></a><span id="l8.698" class="difflineminus">-      appPath += &quot;%1&quot;;</span>
<a href="#l8.699"></a><span id="l8.699" class="difflineminus">-      nsCAutoString shellOpenKey (keyName);</span>
<a href="#l8.700"></a><span id="l8.700" class="difflineminus">-      shellOpenKey.AppendLiteral(&quot;\\shell\\open\\command&quot;);</span>
<a href="#l8.701"></a><span id="l8.701" class="difflineminus">-</span>
<a href="#l8.702"></a><span id="l8.702" class="difflineminus">-      rv = SetRegistryKey(HKEY_LOCAL_MACHINE, shellOpenKey.get(), &quot;&quot;, (char *)appPath.get());</span>
<a href="#l8.703"></a><span id="l8.703" class="difflineminus">-</span>
<a href="#l8.704"></a><span id="l8.704" class="difflineminus">-      // Protocols\&lt;protocol scheme&gt;\DefaultIcon value</span>
<a href="#l8.705"></a><span id="l8.705" class="difflineminus">-      nsCAutoString iconPath(thisApplication());</span>
<a href="#l8.706"></a><span id="l8.706" class="difflineminus">-      iconPath += &quot;,0&quot;;</span>
<a href="#l8.707"></a><span id="l8.707" class="difflineminus">-      nsCAutoString iconKey (keyName);</span>
<a href="#l8.708"></a><span id="l8.708" class="difflineminus">-      iconKey.AppendLiteral(&quot;\\DefaultIcon&quot;);</span>
<a href="#l8.709"></a><span id="l8.709" class="difflineminus">-      rv = SetRegistryKey(HKEY_LOCAL_MACHINE, iconKey.get(),&quot;&quot;, (char *)iconPath.get());</span>
<a href="#l8.710"></a><span id="l8.710" class="difflineminus">-    }</span>
<a href="#l8.711"></a><span id="l8.711" class="difflineminus">-</span>
<a href="#l8.712"></a><span id="l8.712" class="difflineminus">-    return rv;</span>
<a href="#l8.713"></a><span id="l8.713" class="difflineminus">-}</span>
<a href="#l8.714"></a><span id="l8.714" class="difflineminus">-</span>
<a href="#l8.715"></a><span id="l8.715" class="difflineminus">-nsresult nsMapiRegistryUtils::registerMailApp(PRBool aForceRegistration)</span>
<a href="#l8.716"></a><span id="l8.716" class="difflineminus">-{</span>
<a href="#l8.717"></a><span id="l8.717" class="difflineminus">-    nsCAutoString keyName(&quot;Software\\Clients\\Mail\\&quot;);</span>
<a href="#l8.718"></a><span id="l8.718" class="difflineminus">-    nsCAutoString appName;</span>
<a href="#l8.719"></a><span id="l8.719" class="difflineminus">-    NS_CopyUnicodeToNative(vendorName(), appName);</span>
<a href="#l8.720"></a><span id="l8.720" class="difflineminus">-    nsresult rv = NS_OK;</span>
<a href="#l8.721"></a><span id="l8.721" class="difflineminus">-</span>
<a href="#l8.722"></a><span id="l8.722" class="difflineminus">-    if (mRestrictedRegAccess)</span>
<a href="#l8.723"></a><span id="l8.723" class="difflineminus">-      return NS_ERROR_FAILURE;</span>
<a href="#l8.724"></a><span id="l8.724" class="difflineminus">-</span>
<a href="#l8.725"></a><span id="l8.725" class="difflineminus">-    // Be SMART! If we have already set these keys up, don't do it again. Check the registeredAsNewsApp flag</span>
<a href="#l8.726"></a><span id="l8.726" class="difflineminus">-    // that we stored in our desktop registry scratchpad</span>
<a href="#l8.727"></a><span id="l8.727" class="difflineminus">-    nsCAutoString registeredAsMailApp;</span>
<a href="#l8.728"></a><span id="l8.728" class="difflineminus">-    GetRegistryKey(HKEY_LOCAL_MACHINE, kAppDesktopKey, &quot;registeredAsMailApp&quot;, registeredAsMailApp);</span>
<a href="#l8.729"></a><span id="l8.729" class="difflineminus">-</span>
<a href="#l8.730"></a><span id="l8.730" class="difflineminus">-    if (!aForceRegistration &amp;&amp; registeredAsMailApp.Equals(&quot;1&quot;))</span>
<a href="#l8.731"></a><span id="l8.731" class="difflineminus">-        return NS_OK;</span>
<a href="#l8.732"></a><span id="l8.732" class="difflineminus">-</span>
<a href="#l8.733"></a><span id="l8.733" class="difflineminus">-    // (1) Add our app to the list of keys under Software\\Clients\\Mail so we show up as a possible News application</span>
<a href="#l8.734"></a><span id="l8.734" class="difflineminus">-    if (!appName.IsEmpty()) {</span>
<a href="#l8.735"></a><span id="l8.735" class="difflineminus">-        keyName.Append(appName.get());</span>
<a href="#l8.736"></a><span id="l8.736" class="difflineminus">-</span>
<a href="#l8.737"></a><span id="l8.737" class="difflineminus">-        nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l8.738"></a><span id="l8.738" class="difflineminus">-        rv = MakeMapiStringBundle (getter_AddRefs (bundle)) ;</span>
<a href="#l8.739"></a><span id="l8.739" class="difflineminus">-        if (NS_FAILED(rv)) return NS_ERROR_FAILURE;</span>
<a href="#l8.740"></a><span id="l8.740" class="difflineminus">-</span>
<a href="#l8.741"></a><span id="l8.741" class="difflineminus">-        nsString defaultMailTitle;</span>
<a href="#l8.742"></a><span id="l8.742" class="difflineminus">-        // Use vendorName instead of brandname since brandName is product name</span>
<a href="#l8.743"></a><span id="l8.743" class="difflineminus">-        // and has more than just the name of the application</span>
<a href="#l8.744"></a><span id="l8.744" class="difflineminus">-        const PRUnichar *keyValuePrefixStr[] = { vendorName().get() };</span>
<a href="#l8.745"></a><span id="l8.745" class="difflineminus">-        NS_NAMED_LITERAL_STRING(defaultMailTitleTag, &quot;defaultMailDisplayTitle&quot;);</span>
<a href="#l8.746"></a><span id="l8.746" class="difflineminus">-        rv = bundle-&gt;FormatStringFromName(defaultMailTitleTag.get(), keyValuePrefixStr, 1, getter_Copies(defaultMailTitle));</span>
<a href="#l8.747"></a><span id="l8.747" class="difflineminus">-        if (NS_FAILED(rv)) return NS_ERROR_FAILURE;</span>
<a href="#l8.748"></a><span id="l8.748" class="difflineminus">-</span>
<a href="#l8.749"></a><span id="l8.749" class="difflineminus">-        nsCAutoString nativeTitle;</span>
<a href="#l8.750"></a><span id="l8.750" class="difflineminus">-        NS_CopyUnicodeToNative(defaultMailTitle, nativeTitle);</span>
<a href="#l8.751"></a><span id="l8.751" class="difflineminus">-        rv = SetRegistryKey(HKEY_LOCAL_MACHINE, keyName.get(), &quot;&quot;, const_cast&lt;char *&gt;(nativeTitle.get()) );</span>
<a href="#l8.752"></a><span id="l8.752" class="difflineminus">-    }</span>
<a href="#l8.753"></a><span id="l8.753" class="difflineminus">-    else</span>
<a href="#l8.754"></a><span id="l8.754" class="difflineminus">-        rv = NS_ERROR_FAILURE;</span>
<a href="#l8.755"></a><span id="l8.755" class="difflineminus">-</span>
<a href="#l8.756"></a><span id="l8.756" class="difflineminus">-    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l8.757"></a><span id="l8.757" class="difflineminus">-        nsCAutoString thisApp (thisApplication()) ;</span>
<a href="#l8.758"></a><span id="l8.758" class="difflineminus">-        nsCAutoString dllPath (thisApp) ;</span>
<a href="#l8.759"></a><span id="l8.759" class="difflineminus">-        char* pathSep = (char *) _mbsrchr((const unsigned char *) thisApp.get(), '\\');</span>
<a href="#l8.760"></a><span id="l8.760" class="difflineminus">-        if (pathSep)</span>
<a href="#l8.761"></a><span id="l8.761" class="difflineminus">-            dllPath.Truncate(pathSep - thisApp.get() + 1);</span>
<a href="#l8.762"></a><span id="l8.762" class="difflineminus">-        dllPath += &quot;mozMapi32.dll&quot;;</span>
<a href="#l8.763"></a><span id="l8.763" class="difflineminus">-</span>
<a href="#l8.764"></a><span id="l8.764" class="difflineminus">-        // (2) set the DllPath attribute on our new entry for MAPI</span>
<a href="#l8.765"></a><span id="l8.765" class="difflineminus">-        SetRegistryKey(HKEY_LOCAL_MACHINE, keyName.get(), &quot;DLLPath&quot;, (char *)dllPath.get());</span>
<a href="#l8.766"></a><span id="l8.766" class="difflineminus">-</span>
<a href="#l8.767"></a><span id="l8.767" class="difflineminus">-        // (3) now that we have added Software\\Clients\\Mail\\&lt;app name&gt; add subkeys for each protocol mail supports</span>
<a href="#l8.768"></a><span id="l8.768" class="difflineminus">-        setupDefaultProtocolKey(nsCString(keyName + NS_LITERAL_CSTRING(&quot;\\Protocols\\&quot;)).get(), &quot;mailto&quot;, &quot;URL:MailTo Protocol&quot;, &quot;-compose&quot;);</span>
<a href="#l8.769"></a><span id="l8.769" class="difflineminus">-</span>
<a href="#l8.770"></a><span id="l8.770" class="difflineminus">-</span>
<a href="#l8.771"></a><span id="l8.771" class="difflineminus">-        setupFileExtension(&quot;Software\\Classes\\&quot;, &quot;.eml&quot;);</span>
<a href="#l8.772"></a><span id="l8.772" class="difflineminus">-</span>
<a href="#l8.773"></a><span id="l8.773" class="difflineminus">-        // (4) Software\Clients\News\&lt;app name&gt;\shell\open\command value</span>
<a href="#l8.774"></a><span id="l8.774" class="difflineminus">-        nsCAutoString appKeyName;</span>
<a href="#l8.775"></a><span id="l8.775" class="difflineminus">-        appKeyName.Assign(keyName);</span>
<a href="#l8.776"></a><span id="l8.776" class="difflineminus">-        appKeyName.AppendLiteral(&quot;\\shell\\open\\command&quot;);</span>
<a href="#l8.777"></a><span id="l8.777" class="difflineminus">-        nsCAutoString mailAppPath(thisApp);</span>
<a href="#l8.778"></a><span id="l8.778" class="difflineminus">-        mailAppPath += &quot; -mail&quot;;</span>
<a href="#l8.779"></a><span id="l8.779" class="difflineminus">-        SetRegistryKey(HKEY_LOCAL_MACHINE, appKeyName.get(), &quot;&quot;, (char *)mailAppPath.get());</span>
<a href="#l8.780"></a><span id="l8.780" class="difflineminus">-</span>
<a href="#l8.781"></a><span id="l8.781" class="difflineminus">-        // (5) Add a properties key that launches our options chrome</span>
<a href="#l8.782"></a><span id="l8.782" class="difflineminus">-#ifdef MOZ_THUNDERBIRD</span>
<a href="#l8.783"></a><span id="l8.783" class="difflineminus">-        appKeyName.Assign(keyName);</span>
<a href="#l8.784"></a><span id="l8.784" class="difflineminus">-        appKeyName.AppendLiteral(&quot;\\shell\\properties\\command&quot;);</span>
<a href="#l8.785"></a><span id="l8.785" class="difflineminus">-        nsCAutoString optionsPath(thisApp);</span>
<a href="#l8.786"></a><span id="l8.786" class="difflineminus">-        optionsPath += &quot; -options&quot;;</span>
<a href="#l8.787"></a><span id="l8.787" class="difflineminus">-        SetRegistryKey(HKEY_LOCAL_MACHINE, appKeyName.get(), &quot;&quot;, (char *)optionsPath.get());</span>
<a href="#l8.788"></a><span id="l8.788" class="difflineminus">-</span>
<a href="#l8.789"></a><span id="l8.789" class="difflineminus">-        nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l8.790"></a><span id="l8.790" class="difflineminus">-        rv = MakeMapiStringBundle (getter_AddRefs (bundle));</span>
<a href="#l8.791"></a><span id="l8.791" class="difflineminus">-        if (bundle)</span>
<a href="#l8.792"></a><span id="l8.792" class="difflineminus">-        {</span>
<a href="#l8.793"></a><span id="l8.793" class="difflineminus">-          appKeyName.Assign(keyName);</span>
<a href="#l8.794"></a><span id="l8.794" class="difflineminus">-          appKeyName.AppendLiteral(&quot;\\shell\\properties&quot;);</span>
<a href="#l8.795"></a><span id="l8.795" class="difflineminus">-</span>
<a href="#l8.796"></a><span id="l8.796" class="difflineminus">-          nsString brandShortName;</span>
<a href="#l8.797"></a><span id="l8.797" class="difflineminus">-          getVarValue(NS_LITERAL_STRING(&quot;brandShortName&quot;).get(), brandShortName);</span>
<a href="#l8.798"></a><span id="l8.798" class="difflineminus">-</span>
<a href="#l8.799"></a><span id="l8.799" class="difflineminus">-          const PRUnichar* brandNameStrings[] = { brandShortName.get() };</span>
<a href="#l8.800"></a><span id="l8.800" class="difflineminus">-</span>
<a href="#l8.801"></a><span id="l8.801" class="difflineminus">-          nsString optionsTitle;</span>
<a href="#l8.802"></a><span id="l8.802" class="difflineminus">-          bundle-&gt;FormatStringFromName(NS_LITERAL_STRING(&quot;optionsLabel&quot;).get(),</span>
<a href="#l8.803"></a><span id="l8.803" class="difflineminus">-                                       brandNameStrings, 1, getter_Copies(optionsTitle));</span>
<a href="#l8.804"></a><span id="l8.804" class="difflineminus">-          nsCAutoString nativeOptionsTitle;</span>
<a href="#l8.805"></a><span id="l8.805" class="difflineminus">-          NS_CopyUnicodeToNative(optionsTitle, nativeOptionsTitle);</span>
<a href="#l8.806"></a><span id="l8.806" class="difflineminus">-          SetRegistryKey(HKEY_LOCAL_MACHINE, appKeyName.get(), &quot;&quot;, (char *) nativeOptionsTitle.get());</span>
<a href="#l8.807"></a><span id="l8.807" class="difflineminus">-        }</span>
<a href="#l8.808"></a><span id="l8.808" class="difflineminus">-#endif</span>
<a href="#l8.809"></a><span id="l8.809" class="difflineminus">-</span>
<a href="#l8.810"></a><span id="l8.810" class="difflineminus">-        // (5) add a default icon entry to Software\\Clients\\Mail\\&lt;app name&gt;</span>
<a href="#l8.811"></a><span id="l8.811" class="difflineminus">-        nsCAutoString iconPath(thisApp);</span>
<a href="#l8.812"></a><span id="l8.812" class="difflineminus">-        iconPath += &quot;,0&quot;;</span>
<a href="#l8.813"></a><span id="l8.813" class="difflineminus">-        nsCAutoString iconKeyName (keyName);</span>
<a href="#l8.814"></a><span id="l8.814" class="difflineminus">-        iconKeyName.AppendLiteral(&quot;\\DefaultIcon&quot;);</span>
<a href="#l8.815"></a><span id="l8.815" class="difflineminus">-        SetRegistryKey(HKEY_LOCAL_MACHINE, iconKeyName.get(),&quot;&quot;, (char *)iconPath.get());</span>
<a href="#l8.816"></a><span id="l8.816" class="difflineminus">-</span>
<a href="#l8.817"></a><span id="l8.817" class="difflineminus">-        // if we got this far, set a flag in the registry so we know we have registered ourself as a default mail application</span>
<a href="#l8.818"></a><span id="l8.818" class="difflineminus">-        SetRegistryKey(HKEY_LOCAL_MACHINE, kAppDesktopKey, &quot;registeredAsMailApp&quot;, &quot;1&quot;);</span>
<a href="#l8.819"></a><span id="l8.819" class="difflineminus">-    }</span>
<a href="#l8.820"></a><span id="l8.820" class="difflineminus">-</span>
<a href="#l8.821"></a><span id="l8.821" class="difflineminus">-    return rv;</span>
<a href="#l8.822"></a><span id="l8.822" class="difflineminus">-}</span>
<a href="#l8.823"></a><span id="l8.823" class="difflineminus">-</span>
<a href="#l8.824"></a><span id="l8.824" class="difflineminus">-nsresult nsMapiRegistryUtils::registerNewsApp(PRBool aForceRegistration)</span>
<a href="#l8.825"></a><span id="l8.825" class="difflineminus">-{</span>
<a href="#l8.826"></a><span id="l8.826" class="difflineminus">-    nsresult rv = NS_OK;</span>
<a href="#l8.827"></a><span id="l8.827" class="difflineminus">-    nsCAutoString keyName(&quot;Software\\Clients\\News\\&quot;);</span>
<a href="#l8.828"></a><span id="l8.828" class="difflineminus">-    nsCAutoString appName;</span>
<a href="#l8.829"></a><span id="l8.829" class="difflineminus">-    NS_CopyUnicodeToNative(vendorName(), appName);</span>
<a href="#l8.830"></a><span id="l8.830" class="difflineminus">-</span>
<a href="#l8.831"></a><span id="l8.831" class="difflineminus">-    // Be SMART! If we have already set these keys up, don't do it again. Check the registeredAsNewsApp flag</span>
<a href="#l8.832"></a><span id="l8.832" class="difflineminus">-    // that we stored in our desktop registry scratchpad</span>
<a href="#l8.833"></a><span id="l8.833" class="difflineminus">-    nsCAutoString registeredAsNewsApp;</span>
<a href="#l8.834"></a><span id="l8.834" class="difflineminus">-    GetRegistryKey(HKEY_LOCAL_MACHINE, kAppDesktopKey, &quot;registeredAsNewsApp&quot;, registeredAsNewsApp);</span>
<a href="#l8.835"></a><span id="l8.835" class="difflineminus">-</span>
<a href="#l8.836"></a><span id="l8.836" class="difflineminus">-    if (!aForceRegistration &amp;&amp; registeredAsNewsApp.Equals(&quot;1&quot;))</span>
<a href="#l8.837"></a><span id="l8.837" class="difflineminus">-        return NS_OK;</span>
<a href="#l8.838"></a><span id="l8.838" class="difflineminus">-</span>
<a href="#l8.839"></a><span id="l8.839" class="difflineminus">-    // (1) Add our app to the list of keys under Software\\Clients\\News so we show up as a possible News application</span>
<a href="#l8.840"></a><span id="l8.840" class="difflineminus">-    if (!appName.IsEmpty()) {</span>
<a href="#l8.841"></a><span id="l8.841" class="difflineminus">-        keyName.Append(appName.get());</span>
<a href="#l8.842"></a><span id="l8.842" class="difflineminus">-</span>
<a href="#l8.843"></a><span id="l8.843" class="difflineminus">-        nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l8.844"></a><span id="l8.844" class="difflineminus">-        rv = MakeMapiStringBundle (getter_AddRefs (bundle)) ;</span>
<a href="#l8.845"></a><span id="l8.845" class="difflineminus">-        if (NS_FAILED(rv)) return NS_ERROR_FAILURE;</span>
<a href="#l8.846"></a><span id="l8.846" class="difflineminus">-</span>
<a href="#l8.847"></a><span id="l8.847" class="difflineminus">-        nsString defaultMailTitle;</span>
<a href="#l8.848"></a><span id="l8.848" class="difflineminus">-        // Use vendorName instead of brandname since brandName is product name</span>
<a href="#l8.849"></a><span id="l8.849" class="difflineminus">-        // and has more than just the name of the application</span>
<a href="#l8.850"></a><span id="l8.850" class="difflineminus">-        const PRUnichar *keyValuePrefixStr[] = { vendorName().get() };</span>
<a href="#l8.851"></a><span id="l8.851" class="difflineminus">-        NS_NAMED_LITERAL_STRING(defaultMailTitleTag, &quot;defaultMailDisplayTitle&quot;);</span>
<a href="#l8.852"></a><span id="l8.852" class="difflineminus">-        rv = bundle-&gt;FormatStringFromName(defaultMailTitleTag.get(),</span>
<a href="#l8.853"></a><span id="l8.853" class="difflineminus">-                                      keyValuePrefixStr, 1,</span>
<a href="#l8.854"></a><span id="l8.854" class="difflineminus">-                                      getter_Copies(defaultMailTitle));</span>
<a href="#l8.855"></a><span id="l8.855" class="difflineminus">-        if (NS_FAILED(rv)) return NS_ERROR_FAILURE;</span>
<a href="#l8.856"></a><span id="l8.856" class="difflineminus">-        nsCAutoString nativeTitle;</span>
<a href="#l8.857"></a><span id="l8.857" class="difflineminus">-        NS_CopyUnicodeToNative(defaultMailTitle, nativeTitle);</span>
<a href="#l8.858"></a><span id="l8.858" class="difflineminus">-</span>
<a href="#l8.859"></a><span id="l8.859" class="difflineminus">-        rv = SetRegistryKey(HKEY_LOCAL_MACHINE, keyName.get(), &quot;&quot;, const_cast&lt;char *&gt;(nativeTitle.get()) );</span>
<a href="#l8.860"></a><span id="l8.860" class="difflineminus">-    }</span>
<a href="#l8.861"></a><span id="l8.861" class="difflineminus">-    else</span>
<a href="#l8.862"></a><span id="l8.862" class="difflineminus">-        rv = NS_ERROR_FAILURE;</span>
<a href="#l8.863"></a><span id="l8.863" class="difflineminus">-</span>
<a href="#l8.864"></a><span id="l8.864" class="difflineminus">-    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l8.865"></a><span id="l8.865" class="difflineminus">-        nsCAutoString thisApp (thisApplication());</span>
<a href="#l8.866"></a><span id="l8.866" class="difflineminus">-        if (NS_SUCCEEDED(rv)) {</span>
<a href="#l8.867"></a><span id="l8.867" class="difflineminus">-</span>
<a href="#l8.868"></a><span id="l8.868" class="difflineminus">-            // (3) now that we have added Software\\Clients\\News\\&lt;app name&gt;</span>
<a href="#l8.869"></a><span id="l8.869" class="difflineminus">-            //     add subkeys for each protocol news supports</span>
<a href="#l8.870"></a><span id="l8.870" class="difflineminus">-            nsCString protocolKeyName(keyName + NS_LITERAL_CSTRING(&quot;\\Protocols\\&quot;));</span>
<a href="#l8.871"></a><span id="l8.871" class="difflineminus">-            setupDefaultProtocolKey(protocolKeyName.get(), &quot;news&quot;, &quot;URL:News Protocol&quot;, &quot;-mail&quot;);</span>
<a href="#l8.872"></a><span id="l8.872" class="difflineminus">-            setupDefaultProtocolKey(protocolKeyName.get(), &quot;nntp&quot;, &quot;URL:NNTP Protocol&quot;, &quot;-mail&quot;);</span>
<a href="#l8.873"></a><span id="l8.873" class="difflineminus">-            setupDefaultProtocolKey(protocolKeyName.get(), &quot;snews&quot;, &quot;URL:Snews Protocol&quot;, &quot;-mail&quot;);</span>
<a href="#l8.874"></a><span id="l8.874" class="difflineminus">-</span>
<a href="#l8.875"></a><span id="l8.875" class="difflineminus">-            // (4) Software\Clients\News\&lt;app name&gt;\shell\open\command value</span>
<a href="#l8.876"></a><span id="l8.876" class="difflineminus">-            nsCAutoString appKeyName;</span>
<a href="#l8.877"></a><span id="l8.877" class="difflineminus">-            appKeyName.Assign(keyName);</span>
<a href="#l8.878"></a><span id="l8.878" class="difflineminus">-            appKeyName.AppendLiteral(&quot;\\shell\\open\\command&quot;);</span>
<a href="#l8.879"></a><span id="l8.879" class="difflineminus">-            rv = SetRegistryKey(HKEY_LOCAL_MACHINE, appKeyName.get(), &quot;&quot;, (char *)thisApp.get());</span>
<a href="#l8.880"></a><span id="l8.880" class="difflineminus">-</span>
<a href="#l8.881"></a><span id="l8.881" class="difflineminus">-            // (5) add a default icon entry to Software\\Clients\\News\\&lt;app name&gt;</span>
<a href="#l8.882"></a><span id="l8.882" class="difflineminus">-                if (NS_SUCCEEDED(rv)) {</span>
<a href="#l8.883"></a><span id="l8.883" class="difflineminus">-                    nsCAutoString iconPath(thisApp);</span>
<a href="#l8.884"></a><span id="l8.884" class="difflineminus">-                    iconPath += &quot;,0&quot;;</span>
<a href="#l8.885"></a><span id="l8.885" class="difflineminus">-                 nsCAutoString iconKeyName (keyName);</span>
<a href="#l8.886"></a><span id="l8.886" class="difflineminus">-                    iconKeyName.AppendLiteral(&quot;\\DefaultIcon&quot;);</span>
<a href="#l8.887"></a><span id="l8.887" class="difflineminus">-                 rv = SetRegistryKey(HKEY_LOCAL_MACHINE, iconKeyName.get(),&quot;&quot;, (char *)iconPath.get());</span>
<a href="#l8.888"></a><span id="l8.888" class="difflineminus">-                }</span>
<a href="#l8.889"></a><span id="l8.889" class="difflineminus">-            }</span>
<a href="#l8.890"></a><span id="l8.890" class="difflineminus">-</span>
<a href="#l8.891"></a><span id="l8.891" class="difflineminus">-        // if we got this far, set a flag in the registry so we know we have registered ourself as a default news application</span>
<a href="#l8.892"></a><span id="l8.892" class="difflineminus">-        SetRegistryKey(HKEY_LOCAL_MACHINE, kAppDesktopKey, &quot;registeredAsNewsApp&quot;, &quot;1&quot;);</span>
<a href="#l8.893"></a><span id="l8.893" class="difflineminus">-                }</span>
<a href="#l8.894"></a><span id="l8.894" class="difflineminus">-</span>
<a href="#l8.895"></a><span id="l8.895" class="difflineminus">-    return rv;</span>
<a href="#l8.896"></a><span id="l8.896" class="difflineminus">-}</span>
<a href="#l8.897"></a><span id="l8.897" class="difflineminus">-</span>
<a href="#l8.898"></a><span id="l8.898" class="difflineminus">-/** Sets Mozilla as the default News Client</span>
<a href="#l8.899"></a><span id="l8.899" class="difflineminus">- */</span>
<a href="#l8.900"></a><span id="l8.900" class="difflineminus">-nsresult nsMapiRegistryUtils::setDefaultNewsClient()</span>
<a href="#l8.901"></a><span id="l8.901" class="difflineminus">-{</span>
<a href="#l8.902"></a><span id="l8.902" class="difflineminus">-    nsresult rv;</span>
<a href="#l8.903"></a><span id="l8.903" class="difflineminus">-    nsresult mailKeySet=NS_ERROR_FAILURE;</span>
<a href="#l8.904"></a><span id="l8.904" class="difflineminus">-</span>
<a href="#l8.905"></a><span id="l8.905" class="difflineminus">-    if (mRestrictedRegAccess)</span>
<a href="#l8.906"></a><span id="l8.906" class="difflineminus">-      return NS_ERROR_FAILURE;</span>
<a href="#l8.907"></a><span id="l8.907" class="difflineminus">-</span>
<a href="#l8.908"></a><span id="l8.908" class="difflineminus">-    rv = saveDefaultNewsClient();</span>
<a href="#l8.909"></a><span id="l8.909" class="difflineminus">-</span>
<a href="#l8.910"></a><span id="l8.910" class="difflineminus">-    if (NS_FAILED(saveUserDefaultNewsClient()) || NS_FAILED(rv))</span>
<a href="#l8.911"></a><span id="l8.911" class="difflineminus">-      return NS_ERROR_FAILURE;</span>
<a href="#l8.912"></a><span id="l8.912" class="difflineminus">-</span>
<a href="#l8.913"></a><span id="l8.913" class="difflineminus">-    // make sure we have already registered ourself as a potential news application with the OS:</span>
<a href="#l8.914"></a><span id="l8.914" class="difflineminus">-    registerNewsApp(PR_TRUE);</span>
<a href="#l8.915"></a><span id="l8.915" class="difflineminus">-</span>
<a href="#l8.916"></a><span id="l8.916" class="difflineminus">-    // give Software\Clients\News a default value of our application name.</span>
<a href="#l8.917"></a><span id="l8.917" class="difflineminus">-    nsCAutoString appName;</span>
<a href="#l8.918"></a><span id="l8.918" class="difflineminus">-    NS_CopyUnicodeToNative(vendorName(), appName);</span>
<a href="#l8.919"></a><span id="l8.919" class="difflineminus">-</span>
<a href="#l8.920"></a><span id="l8.920" class="difflineminus">-    SetRegistryKey(HKEY_LOCAL_MACHINE, &quot;Software\\Clients\\News&quot;, &quot;&quot;, (char *)appName.get());</span>
<a href="#l8.921"></a><span id="l8.921" class="difflineminus">-</span>
<a href="#l8.922"></a><span id="l8.922" class="difflineminus">-    // delete the existing news related protocol keys from HKEY_LOCAL_MACHINE\Classes</span>
<a href="#l8.923"></a><span id="l8.923" class="difflineminus">-    recursiveDeleteKey(HKEY_LOCAL_MACHINE, &quot;Software\\Classes\\news&quot;);</span>
<a href="#l8.924"></a><span id="l8.924" class="difflineminus">-    recursiveDeleteKey(HKEY_LOCAL_MACHINE, &quot;Software\\Classes\\nntp&quot;);</span>
<a href="#l8.925"></a><span id="l8.925" class="difflineminus">-    recursiveDeleteKey(HKEY_LOCAL_MACHINE, &quot;Software\\Classes\\snews&quot;);</span>
<a href="#l8.926"></a><span id="l8.926" class="difflineminus">-</span>
<a href="#l8.927"></a><span id="l8.927" class="difflineminus">-    // copy our protocol handlers out to HKEY_LOCAL_MACHINE\Classes\&lt;protocol&gt;</span>
<a href="#l8.928"></a><span id="l8.928" class="difflineminus">-    nsCAutoString keyName(&quot;Software\\Clients\\News\\&quot;);</span>
<a href="#l8.929"></a><span id="l8.929" class="difflineminus">-    keyName.Append(appName);</span>
<a href="#l8.930"></a><span id="l8.930" class="difflineminus">-    keyName.AppendLiteral(&quot;\\Protocols\\&quot;);</span>
<a href="#l8.931"></a><span id="l8.931" class="difflineminus">-</span>
<a href="#l8.932"></a><span id="l8.932" class="difflineminus">-    rv = setProtocolHandler(keyName.get(), &quot;news&quot;);</span>
<a href="#l8.933"></a><span id="l8.933" class="difflineminus">-    rv = setProtocolHandler(keyName.get(), &quot;snews&quot;);</span>
<a href="#l8.934"></a><span id="l8.934" class="difflineminus">-    rv = setProtocolHandler(keyName.get(), &quot;nntp&quot;);</span>
<a href="#l8.935"></a><span id="l8.935" class="difflineminus">-</span>
<a href="#l8.936"></a><span id="l8.936" class="difflineminus">-    rv = SetRegistryKey(HKEY_CURRENT_USER, &quot;Software\\Clients\\News&quot;, &quot;&quot;, (char *)appName.get());</span>
<a href="#l8.937"></a><span id="l8.937" class="difflineminus">-</span>
<a href="#l8.938"></a><span id="l8.938" class="difflineminus">-    // send out a system notifcation to let everyone know the default news client has changed</span>
<a href="#l8.939"></a><span id="l8.939" class="difflineminus">-    ::SendMessageTimeout( HWND_BROADCAST,</span>
<a href="#l8.940"></a><span id="l8.940" class="difflineminus">-                          WM_SETTINGCHANGE,</span>
<a href="#l8.941"></a><span id="l8.941" class="difflineminus">-                          0,</span>
<a href="#l8.942"></a><span id="l8.942" class="difflineminus">-                          (LPARAM)MOZ_CLIENT_NEWS_KEY,</span>
<a href="#l8.943"></a><span id="l8.943" class="difflineminus">-                          SMTO_NORMAL|SMTO_ABORTIFHUNG,</span>
<a href="#l8.944"></a><span id="l8.944" class="difflineminus">-                          MOZ_HWND_BROADCAST_MSG_TIMEOUT,</span>
<a href="#l8.945"></a><span id="l8.945" class="difflineminus">-                          NULL);</span>
<a href="#l8.946"></a><span id="l8.946" class="difflineminus">-    return rv;</span>
<a href="#l8.947"></a><span id="l8.947" class="difflineminus">-}</span>
<a href="#l8.948"></a><span id="l8.948" class="difflineminus">-</span>
<a href="#l8.949"></a><span id="l8.949" class="difflineminus">-nsresult nsMapiRegistryUtils::setDefaultFeedClient()</span>
<a href="#l8.950"></a><span id="l8.950" class="difflineminus">-{</span>
<a href="#l8.951"></a><span id="l8.951" class="difflineminus">-    return setupDefaultProtocolKey(&quot;Software\\Classes\\&quot;, &quot;feed&quot;, &quot;URL:Feed Protocol&quot;, &quot;-mail&quot;);</span>
<a href="#l8.952"></a><span id="l8.952" class="difflineminus">-}</span>
<a href="#l8.953"></a><span id="l8.953" class="difflineminus">-</span>
<a href="#l8.954"></a><span id="l8.954" class="difflineminus">-nsresult nsMapiRegistryUtils::unsetDefaultFeedClient()</span>
<a href="#l8.955"></a><span id="l8.955" class="difflineminus">-{</span>
<a href="#l8.956"></a><span id="l8.956" class="difflineminus">-    // delete the existing mail related protocol keys from HKEY_LOCAL_MACHINE\Software\Classes</span>
<a href="#l8.957"></a><span id="l8.957" class="difflineminus">-    return recursiveDeleteKey(HKEY_LOCAL_MACHINE, &quot;Software\\Classes\\feed&quot;);</span>
<a href="#l8.958"></a><span id="l8.958" class="difflineminus">-}</span>
<a href="#l8.959"></a><span id="l8.959" class="difflineminus">-</span>
<a href="#l8.960"></a><span id="l8.960" class="difflineminus">-PRBool nsMapiRegistryUtils::IsDefaultFeedClient()</span>
<a href="#l8.961"></a><span id="l8.961" class="difflineminus">-{</span>
<a href="#l8.962"></a><span id="l8.962" class="difflineminus">-    //first try to get the users default news client</span>
<a href="#l8.963"></a><span id="l8.963" class="difflineminus">-    nsCAutoString result;</span>
<a href="#l8.964"></a><span id="l8.964" class="difflineminus">-    GetRegistryKey(HKEY_LOCAL_MACHINE, &quot;Software\\Classes\\feed\\shell\\open\\command&quot;, &quot;&quot;, result);</span>
<a href="#l8.965"></a><span id="l8.965" class="difflineminus">-</span>
<a href="#l8.966"></a><span id="l8.966" class="difflineminus">-    if (!result.IsEmpty()) {</span>
<a href="#l8.967"></a><span id="l8.967" class="difflineminus">-       nsCAutoString strExtension;</span>
<a href="#l8.968"></a><span id="l8.968" class="difflineminus">-       strExtension.Assign(EXE_EXTENSION);</span>
<a href="#l8.969"></a><span id="l8.969" class="difflineminus">-       ToUpperCase(result);</span>
<a href="#l8.970"></a><span id="l8.970" class="difflineminus">-       PRInt32 index = result.RFind(strExtension.get());</span>
<a href="#l8.971"></a><span id="l8.971" class="difflineminus">-       if (index != kNotFound)</span>
<a href="#l8.972"></a><span id="l8.972" class="difflineminus">-           result.Truncate(index + strExtension.Length());</span>
<a href="#l8.973"></a><span id="l8.973" class="difflineminus">-</span>
<a href="#l8.974"></a><span id="l8.974" class="difflineminus">-       nsCAutoString thisApp (thisApplication()) ;</span>
<a href="#l8.975"></a><span id="l8.975" class="difflineminus">-       return (result == thisApp);</span>
<a href="#l8.976"></a><span id="l8.976" class="difflineminus">-    }</span>
<a href="#l8.977"></a><span id="l8.977" class="difflineminus">-</span>
<a href="#l8.978"></a><span id="l8.978" class="difflineminus">-    return PR_FALSE;</span>
<a href="#l8.979"></a><span id="l8.979" class="difflineminus">-}</span>
<a href="#l8.980"></a><span id="l8.980" class="difflineminus">-</span>
<a href="#l8.981"></a><span id="l8.981" class="difflineminus">-/** Sets Mozilla as default Mail Client</span>
<a href="#l8.982"></a><span id="l8.982" class="difflineminus">- */</span>
<a href="#l8.983"></a><span id="l8.983" class="difflineminus">-nsresult nsMapiRegistryUtils::setDefaultMailClient()</span>
<a href="#l8.984"></a><span id="l8.984" class="difflineminus">-{</span>
<a href="#l8.985"></a><span id="l8.985" class="difflineminus">-  nsresult rv = NS_OK;</span>
<a href="#l8.986"></a><span id="l8.986" class="difflineminus">-  if (mRestrictedRegAccess)</span>
<a href="#l8.987"></a><span id="l8.987" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l8.988"></a><span id="l8.988" class="difflineminus">-</span>
<a href="#l8.989"></a><span id="l8.989" class="difflineminus">-  if (!isSmartDll()) {</span>
<a href="#l8.990"></a><span id="l8.990" class="difflineminus">-    if (NS_FAILED(CopyMozMapiToWinSysDir()))</span>
<a href="#l8.991"></a><span id="l8.991" class="difflineminus">-      return NS_ERROR_FAILURE;</span>
<a href="#l8.992"></a><span id="l8.992" class="difflineminus">-  }</span>
<a href="#l8.993"></a><span id="l8.993" class="difflineminus">-</span>
<a href="#l8.994"></a><span id="l8.994" class="difflineminus">-  rv = saveDefaultMailClient();</span>
<a href="#l8.995"></a><span id="l8.995" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l8.996"></a><span id="l8.996" class="difflineminus">-    rv = saveUserDefaultMailClient();</span>
<a href="#l8.997"></a><span id="l8.997" class="difflineminus">-</span>
<a href="#l8.998"></a><span id="l8.998" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.999"></a><span id="l8.999" class="difflineminus">-</span>
<a href="#l8.1000"></a><span id="l8.1000" class="difflineminus">-  // make sure we have already registered ourself as a potential mail application with the OS:</span>
<a href="#l8.1001"></a><span id="l8.1001" class="difflineminus">-  registerMailApp(PR_TRUE);</span>
<a href="#l8.1002"></a><span id="l8.1002" class="difflineminus">-</span>
<a href="#l8.1003"></a><span id="l8.1003" class="difflineminus">-  // give Software\Clients\Mail a default value of our application name.</span>
<a href="#l8.1004"></a><span id="l8.1004" class="difflineminus">-  nsCAutoString appName;</span>
<a href="#l8.1005"></a><span id="l8.1005" class="difflineminus">-  NS_CopyUnicodeToNative(vendorName(), appName);</span>
<a href="#l8.1006"></a><span id="l8.1006" class="difflineminus">-  SetRegistryKey(HKEY_LOCAL_MACHINE, &quot;Software\\Clients\\Mail&quot;, &quot;&quot;, (char *)appName.get());</span>
<a href="#l8.1007"></a><span id="l8.1007" class="difflineminus">-</span>
<a href="#l8.1008"></a><span id="l8.1008" class="difflineminus">-  // if we succeeded in setting ourselves as the default mapi client, then</span>
<a href="#l8.1009"></a><span id="l8.1009" class="difflineminus">-  // make sure we also set ourselves as the mailto protocol handler for the user...</span>
<a href="#l8.1010"></a><span id="l8.1010" class="difflineminus">-  nsCAutoString keyName(&quot;Software\\Clients\\Mail\\&quot;);</span>
<a href="#l8.1011"></a><span id="l8.1011" class="difflineminus">-  keyName.Append(appName);</span>
<a href="#l8.1012"></a><span id="l8.1012" class="difflineminus">-  keyName.AppendLiteral(&quot;\\Protocols\\&quot;);</span>
<a href="#l8.1013"></a><span id="l8.1013" class="difflineminus">-</span>
<a href="#l8.1014"></a><span id="l8.1014" class="difflineminus">-  // delete the existing mail related protocol keys from HKEY_LOCAL_MACHINE\Software\Classes</span>
<a href="#l8.1015"></a><span id="l8.1015" class="difflineminus">-  recursiveDeleteKey(HKEY_LOCAL_MACHINE, &quot;Software\\Classes\\mailto&quot;);</span>
<a href="#l8.1016"></a><span id="l8.1016" class="difflineminus">-  rv = setProtocolHandler(keyName.get(), &quot;mailto&quot;);</span>
<a href="#l8.1017"></a><span id="l8.1017" class="difflineminus">-</span>
<a href="#l8.1018"></a><span id="l8.1018" class="difflineminus">-  rv = SetRegistryKey(HKEY_CURRENT_USER, &quot;Software\\Clients\\Mail&quot;, &quot;&quot;, (char *)appName.get());</span>
<a href="#l8.1019"></a><span id="l8.1019" class="difflineminus">-</span>
<a href="#l8.1020"></a><span id="l8.1020" class="difflineminus">-  // We are now the default mail client so set defaultMailHasBeenSet</span>
<a href="#l8.1021"></a><span id="l8.1021" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l8.1022"></a><span id="l8.1022" class="difflineminus">-    rv = SetRegistryKey(HKEY_LOCAL_MACHINE, kAppDesktopKey, &quot;defaultMailHasBeenSet&quot;, &quot;1&quot;);</span>
<a href="#l8.1023"></a><span id="l8.1023" class="difflineminus">-</span>
<a href="#l8.1024"></a><span id="l8.1024" class="difflineminus">-  // now notify anyone listening that there is a new default mail client in town</span>
<a href="#l8.1025"></a><span id="l8.1025" class="difflineminus">-  ::SendMessageTimeout( HWND_BROADCAST,</span>
<a href="#l8.1026"></a><span id="l8.1026" class="difflineminus">-                        WM_SETTINGCHANGE,</span>
<a href="#l8.1027"></a><span id="l8.1027" class="difflineminus">-                        0,</span>
<a href="#l8.1028"></a><span id="l8.1028" class="difflineminus">-                        (LPARAM)MOZ_CLIENT_MAIL_KEY,</span>
<a href="#l8.1029"></a><span id="l8.1029" class="difflineminus">-                        SMTO_NORMAL|SMTO_ABORTIFHUNG,</span>
<a href="#l8.1030"></a><span id="l8.1030" class="difflineminus">-                        MOZ_HWND_BROADCAST_MSG_TIMEOUT,</span>
<a href="#l8.1031"></a><span id="l8.1031" class="difflineminus">-                        NULL);</span>
<a href="#l8.1032"></a><span id="l8.1032" class="difflineminus">-</span>
<a href="#l8.1033"></a><span id="l8.1033" class="difflineminus">-  // Tell the MAPI Service to register the mapi proxy dll now that we are the default mail application</span>
<a href="#l8.1034"></a><span id="l8.1034" class="difflineminus">-  nsCOMPtr&lt;nsIMapiSupport&gt; mapiService (do_GetService(NS_IMAPISUPPORT_CONTRACTID, &amp;rv));</span>
<a href="#l8.1035"></a><span id="l8.1035" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.1036"></a><span id="l8.1036" class="difflineminus">-  return mapiService-&gt;RegisterServer();</span>
<a href="#l8.1037"></a><span id="l8.1037" class="difflineminus">-}</span>
<a href="#l8.1038"></a><span id="l8.1038" class="difflineminus">-</span>
<a href="#l8.1039"></a><span id="l8.1039" class="difflineminus">-nsresult nsMapiRegistryUtils::unsetDefaultNewsClient() {</span>
<a href="#l8.1040"></a><span id="l8.1040" class="difflineminus">-  nsresult rv = NS_OK;</span>
<a href="#l8.1041"></a><span id="l8.1041" class="difflineminus">-  nsresult mailKeySet = NS_ERROR_FAILURE;</span>
<a href="#l8.1042"></a><span id="l8.1042" class="difflineminus">-</span>
<a href="#l8.1043"></a><span id="l8.1043" class="difflineminus">-  if (mRestrictedRegAccess)</span>
<a href="#l8.1044"></a><span id="l8.1044" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l8.1045"></a><span id="l8.1045" class="difflineminus">-</span>
<a href="#l8.1046"></a><span id="l8.1046" class="difflineminus">-  nsCAutoString name ;</span>
<a href="#l8.1047"></a><span id="l8.1047" class="difflineminus">-</span>
<a href="#l8.1048"></a><span id="l8.1048" class="difflineminus">-  // get the name of the default news client</span>
<a href="#l8.1049"></a><span id="l8.1049" class="difflineminus">-  GetRegistryKey(HKEY_LOCAL_MACHINE, kAppDesktopKey, &quot;HKEY_LOCAL_MACHINE\\Software\\Clients\\News&quot;, name);</span>
<a href="#l8.1050"></a><span id="l8.1050" class="difflineminus">-</span>
<a href="#l8.1051"></a><span id="l8.1051" class="difflineminus">-  // Use vendorName instead of brandname since brandName is product name</span>
<a href="#l8.1052"></a><span id="l8.1052" class="difflineminus">-  // and has more than just the name of the application</span>
<a href="#l8.1053"></a><span id="l8.1053" class="difflineminus">-  nsCAutoString appName;</span>
<a href="#l8.1054"></a><span id="l8.1054" class="difflineminus">-  NS_CopyUnicodeToNative(vendorName(), appName);</span>
<a href="#l8.1055"></a><span id="l8.1055" class="difflineminus">-</span>
<a href="#l8.1056"></a><span id="l8.1056" class="difflineminus">-  // if we are the current default client....</span>
<a href="#l8.1057"></a><span id="l8.1057" class="difflineminus">-  if (!name.IsEmpty() &amp;&amp; !appName.IsEmpty() &amp;&amp; name.Equals(appName))</span>
<a href="#l8.1058"></a><span id="l8.1058" class="difflineminus">-  {</span>
<a href="#l8.1059"></a><span id="l8.1059" class="difflineminus">-    // XXX Do we need to do anything here? Maybe we want to clear out name. If we were the previous default news client</span>
<a href="#l8.1060"></a><span id="l8.1060" class="difflineminus">-    // and the user is trying to unset us as the current default news client, we probably don't want to re-store ourselves</span>
<a href="#l8.1061"></a><span id="l8.1061" class="difflineminus">-    // again?</span>
<a href="#l8.1062"></a><span id="l8.1062" class="difflineminus">-</span>
<a href="#l8.1063"></a><span id="l8.1063" class="difflineminus">-    name = &quot;&quot;;</span>
<a href="#l8.1064"></a><span id="l8.1064" class="difflineminus">-  }</span>
<a href="#l8.1065"></a><span id="l8.1065" class="difflineminus">-</span>
<a href="#l8.1066"></a><span id="l8.1066" class="difflineminus">-  // delete the protocol keys we copied to HKEY_LOCAL_MACHINE\Classes when we were made the default news application</span>
<a href="#l8.1067"></a><span id="l8.1067" class="difflineminus">-</span>
<a href="#l8.1068"></a><span id="l8.1068" class="difflineminus">-  recursiveDeleteKey(HKEY_LOCAL_MACHINE, &quot;Software\\Classes\\news&quot;);</span>
<a href="#l8.1069"></a><span id="l8.1069" class="difflineminus">-  recursiveDeleteKey(HKEY_LOCAL_MACHINE, &quot;Software\\Classes\\nntp&quot;);</span>
<a href="#l8.1070"></a><span id="l8.1070" class="difflineminus">-  recursiveDeleteKey(HKEY_LOCAL_MACHINE, &quot;Software\\Classes\\snews&quot;);</span>
<a href="#l8.1071"></a><span id="l8.1071" class="difflineminus">-</span>
<a href="#l8.1072"></a><span id="l8.1072" class="difflineminus">-  // set HKEY_LOCAL_MACHINE\Software\Clients\News</span>
<a href="#l8.1073"></a><span id="l8.1073" class="difflineminus">-  if (!name.IsEmpty())</span>
<a href="#l8.1074"></a><span id="l8.1074" class="difflineminus">-  {</span>
<a href="#l8.1075"></a><span id="l8.1075" class="difflineminus">-    mailKeySet = SetRegistryKey(HKEY_LOCAL_MACHINE, &quot;Software\\Clients\\News&quot;, &quot;&quot;, (char *)name.get());</span>
<a href="#l8.1076"></a><span id="l8.1076" class="difflineminus">-</span>
<a href="#l8.1077"></a><span id="l8.1077" class="difflineminus">-    // copy the protocol handlers for the original default news app out to HKEY_LOCAL_MACHINE\Classes\&lt;protocol&gt;</span>
<a href="#l8.1078"></a><span id="l8.1078" class="difflineminus">-    nsCAutoString keyName(&quot;Software\\Clients\\News\\&quot;);</span>
<a href="#l8.1079"></a><span id="l8.1079" class="difflineminus">-    keyName.Append(name);</span>
<a href="#l8.1080"></a><span id="l8.1080" class="difflineminus">-    keyName.AppendLiteral(&quot;\\Protocols\\&quot;);</span>
<a href="#l8.1081"></a><span id="l8.1081" class="difflineminus">-</span>
<a href="#l8.1082"></a><span id="l8.1082" class="difflineminus">-    rv = setProtocolHandler(keyName.get(), &quot;news&quot;);</span>
<a href="#l8.1083"></a><span id="l8.1083" class="difflineminus">-    rv = setProtocolHandler(keyName.get(), &quot;snews&quot;);</span>
<a href="#l8.1084"></a><span id="l8.1084" class="difflineminus">-    rv = setProtocolHandler(keyName.get(), &quot;nntp&quot;);</span>
<a href="#l8.1085"></a><span id="l8.1085" class="difflineminus">-  }</span>
<a href="#l8.1086"></a><span id="l8.1086" class="difflineminus">-  else</span>
<a href="#l8.1087"></a><span id="l8.1087" class="difflineminus">-    mailKeySet = SetRegistryKey(HKEY_LOCAL_MACHINE, &quot;Software\\Clients\\News&quot;,&quot;&quot;, &quot;&quot;);</span>
<a href="#l8.1088"></a><span id="l8.1088" class="difflineminus">-</span>
<a href="#l8.1089"></a><span id="l8.1089" class="difflineminus">-  // change HKEY_CURRENT_USER\\Software\\Clients\\News</span>
<a href="#l8.1090"></a><span id="l8.1090" class="difflineminus">-  nsCAutoString userAppName ;</span>
<a href="#l8.1091"></a><span id="l8.1091" class="difflineminus">-  GetRegistryKey(HKEY_LOCAL_MACHINE, kAppDesktopKey, &quot;HKEY_CURRENT_USER\\Software\\Clients\\News&quot;, userAppName);</span>
<a href="#l8.1092"></a><span id="l8.1092" class="difflineminus">-</span>
<a href="#l8.1093"></a><span id="l8.1093" class="difflineminus">-  if (!userAppName.IsEmpty())</span>
<a href="#l8.1094"></a><span id="l8.1094" class="difflineminus">-    SetRegistryKey(HKEY_CURRENT_USER, &quot;Software\\Clients\\News&quot;, &quot;&quot;, (char *)userAppName.get());</span>
<a href="#l8.1095"></a><span id="l8.1095" class="difflineminus">-  else</span>
<a href="#l8.1096"></a><span id="l8.1096" class="difflineminus">-    DeleteRegistryValue(HKEY_CURRENT_USER, &quot;Software\\Clients\\News&quot;, &quot;&quot;);</span>
<a href="#l8.1097"></a><span id="l8.1097" class="difflineminus">-</span>
<a href="#l8.1098"></a><span id="l8.1098" class="difflineminus">-</span>
<a href="#l8.1099"></a><span id="l8.1099" class="difflineminus">-   // send out a system notifcation to let everyone know the default news client has changed</span>
<a href="#l8.1100"></a><span id="l8.1100" class="difflineminus">-  ::SendMessageTimeout( HWND_BROADCAST,</span>
<a href="#l8.1101"></a><span id="l8.1101" class="difflineminus">-                        WM_SETTINGCHANGE,</span>
<a href="#l8.1102"></a><span id="l8.1102" class="difflineminus">-                        0,</span>
<a href="#l8.1103"></a><span id="l8.1103" class="difflineminus">-                        (LPARAM)MOZ_CLIENT_NEWS_KEY,</span>
<a href="#l8.1104"></a><span id="l8.1104" class="difflineminus">-                        SMTO_NORMAL|SMTO_ABORTIFHUNG,</span>
<a href="#l8.1105"></a><span id="l8.1105" class="difflineminus">-                        MOZ_HWND_BROADCAST_MSG_TIMEOUT,</span>
<a href="#l8.1106"></a><span id="l8.1106" class="difflineminus">-                        NULL);</span>
<a href="#l8.1107"></a><span id="l8.1107" class="difflineminus">-  return mailKeySet;</span>
<a href="#l8.1108"></a><span id="l8.1108" class="difflineminus">-}</span>
<a href="#l8.1109"></a><span id="l8.1109" class="difflineminus">-</span>
<a href="#l8.1110"></a><span id="l8.1110" class="difflineminus">-/** Removes Mozilla as the default Mail client and restores the previous setting</span>
<a href="#l8.1111"></a><span id="l8.1111" class="difflineminus">- */</span>
<a href="#l8.1112"></a><span id="l8.1112" class="difflineminus">-nsresult nsMapiRegistryUtils::unsetDefaultMailClient() {</span>
<a href="#l8.1113"></a><span id="l8.1113" class="difflineminus">-  nsresult result = NS_OK;</span>
<a href="#l8.1114"></a><span id="l8.1114" class="difflineminus">-  nsresult mailKeySet = NS_ERROR_FAILURE;</span>
<a href="#l8.1115"></a><span id="l8.1115" class="difflineminus">-</span>
<a href="#l8.1116"></a><span id="l8.1116" class="difflineminus">-  if (mRestrictedRegAccess)</span>
<a href="#l8.1117"></a><span id="l8.1117" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l8.1118"></a><span id="l8.1118" class="difflineminus">-</span>
<a href="#l8.1119"></a><span id="l8.1119" class="difflineminus">-  if (!isSmartDll())</span>
<a href="#l8.1120"></a><span id="l8.1120" class="difflineminus">-  {</span>
<a href="#l8.1121"></a><span id="l8.1121" class="difflineminus">-    result = RestoreBackedUpMapiDll();</span>
<a href="#l8.1122"></a><span id="l8.1122" class="difflineminus">-    NS_ENSURE_SUCCESS(result, result);</span>
<a href="#l8.1123"></a><span id="l8.1123" class="difflineminus">-  }</span>
<a href="#l8.1124"></a><span id="l8.1124" class="difflineminus">-</span>
<a href="#l8.1125"></a><span id="l8.1125" class="difflineminus">-  nsCAutoString name ;</span>
<a href="#l8.1126"></a><span id="l8.1126" class="difflineminus">-  GetRegistryKey(HKEY_LOCAL_MACHINE, kAppDesktopKey, &quot;HKEY_LOCAL_MACHINE\\Software\\Clients\\Mail&quot;, name);</span>
<a href="#l8.1127"></a><span id="l8.1127" class="difflineminus">-</span>
<a href="#l8.1128"></a><span id="l8.1128" class="difflineminus">-  // Use vendorName instead of brandname since brandName is product name</span>
<a href="#l8.1129"></a><span id="l8.1129" class="difflineminus">-  // and has more than just the name of the application</span>
<a href="#l8.1130"></a><span id="l8.1130" class="difflineminus">-  nsCAutoString appName;</span>
<a href="#l8.1131"></a><span id="l8.1131" class="difflineminus">-  NS_CopyUnicodeToNative(vendorName(), appName);</span>
<a href="#l8.1132"></a><span id="l8.1132" class="difflineminus">-</span>
<a href="#l8.1133"></a><span id="l8.1133" class="difflineminus">-  if (!name.IsEmpty() &amp;&amp; !appName.IsEmpty() &amp;&amp; name.Equals(appName)) {</span>
<a href="#l8.1134"></a><span id="l8.1134" class="difflineminus">-    nsCAutoString keyName(&quot;HKEY_LOCAL_MACHINE\\Software\\Clients\\Mail\\&quot;);</span>
<a href="#l8.1135"></a><span id="l8.1135" class="difflineminus">-    keyName.Append(appName.get());</span>
<a href="#l8.1136"></a><span id="l8.1136" class="difflineminus">-    keyName.AppendLiteral(&quot;\\Protocols\\mailto\\shell\\open\\command&quot;);</span>
<a href="#l8.1137"></a><span id="l8.1137" class="difflineminus">-    nsCAutoString appPath ;</span>
<a href="#l8.1138"></a><span id="l8.1138" class="difflineminus">-    GetRegistryKey(HKEY_LOCAL_MACHINE, kAppDesktopKey, keyName.get(), appPath);</span>
<a href="#l8.1139"></a><span id="l8.1139" class="difflineminus">-    if (!appPath.IsEmpty()) {</span>
<a href="#l8.1140"></a><span id="l8.1140" class="difflineminus">-      keyName.Assign(&quot;Software\\Clients\\Mail\\&quot;);</span>
<a href="#l8.1141"></a><span id="l8.1141" class="difflineminus">-      keyName.Append(appName.get());</span>
<a href="#l8.1142"></a><span id="l8.1142" class="difflineminus">-      keyName.AppendLiteral(&quot;\\Protocols\\mailto\\shell\\open\\command&quot;);</span>
<a href="#l8.1143"></a><span id="l8.1143" class="difflineminus">-      result = SetRegistryKey(HKEY_LOCAL_MACHINE,</span>
<a href="#l8.1144"></a><span id="l8.1144" class="difflineminus">-                 keyName.get(),</span>
<a href="#l8.1145"></a><span id="l8.1145" class="difflineminus">-                 &quot;&quot;, (char *)appPath.get());</span>
<a href="#l8.1146"></a><span id="l8.1146" class="difflineminus">-      if (NS_SUCCEEDED(result)) {</span>
<a href="#l8.1147"></a><span id="l8.1147" class="difflineminus">-        char* pathSep = (char *)</span>
<a href="#l8.1148"></a><span id="l8.1148" class="difflineminus">-            _mbsrchr((const unsigned char *) appPath.get(), '\\');</span>
<a href="#l8.1149"></a><span id="l8.1149" class="difflineminus">-        if (pathSep)</span>
<a href="#l8.1150"></a><span id="l8.1150" class="difflineminus">-            appPath.Truncate(pathSep - appPath.get() + 1);</span>
<a href="#l8.1151"></a><span id="l8.1151" class="difflineminus">-        appPath += &quot;mozMapi32.dll&quot;;</span>
<a href="#l8.1152"></a><span id="l8.1152" class="difflineminus">-        keyName.Assign(&quot;Software\\Clients\\Mail\\&quot;);</span>
<a href="#l8.1153"></a><span id="l8.1153" class="difflineminus">-        keyName.Append(appName.get());</span>
<a href="#l8.1154"></a><span id="l8.1154" class="difflineminus">-        result = SetRegistryKey(HKEY_LOCAL_MACHINE,</span>
<a href="#l8.1155"></a><span id="l8.1155" class="difflineminus">-                                keyName.get(),</span>
<a href="#l8.1156"></a><span id="l8.1156" class="difflineminus">-                                &quot;DLLPath&quot;, (char *) appPath.get());</span>
<a href="#l8.1157"></a><span id="l8.1157" class="difflineminus">-      }</span>
<a href="#l8.1158"></a><span id="l8.1158" class="difflineminus">-    }</span>
<a href="#l8.1159"></a><span id="l8.1159" class="difflineminus">-  }</span>
<a href="#l8.1160"></a><span id="l8.1160" class="difflineminus">-</span>
<a href="#l8.1161"></a><span id="l8.1161" class="difflineminus">-  recursiveDeleteKey(HKEY_LOCAL_MACHINE, &quot;Software\\Classes\\mailto&quot;);</span>
<a href="#l8.1162"></a><span id="l8.1162" class="difflineminus">-</span>
<a href="#l8.1163"></a><span id="l8.1163" class="difflineminus">-  if (!name.IsEmpty())  // Restore the previous default app for Software\Clients\Mail</span>
<a href="#l8.1164"></a><span id="l8.1164" class="difflineminus">-  {</span>
<a href="#l8.1165"></a><span id="l8.1165" class="difflineminus">-    // copy the protocol handlers for the original default mail app out to HKEY_LOCAL_MACHINE\Classes\&lt;protocol&gt;</span>
<a href="#l8.1166"></a><span id="l8.1166" class="difflineminus">-</span>
<a href="#l8.1167"></a><span id="l8.1167" class="difflineminus">-    nsCAutoString keyName(&quot;Software\\Clients\\Mail\\&quot;);</span>
<a href="#l8.1168"></a><span id="l8.1168" class="difflineminus">-    keyName.Append(name);</span>
<a href="#l8.1169"></a><span id="l8.1169" class="difflineminus">-    keyName.AppendLiteral(&quot;\\Protocols\\&quot;);</span>
<a href="#l8.1170"></a><span id="l8.1170" class="difflineminus">-    setProtocolHandler(keyName.get(), &quot;mailto&quot;);</span>
<a href="#l8.1171"></a><span id="l8.1171" class="difflineminus">-</span>
<a href="#l8.1172"></a><span id="l8.1172" class="difflineminus">-    mailKeySet = SetRegistryKey(HKEY_LOCAL_MACHINE, &quot;Software\\Clients\\Mail&quot;, &quot;&quot;, (char *)name.get());</span>
<a href="#l8.1173"></a><span id="l8.1173" class="difflineminus">-  }</span>
<a href="#l8.1174"></a><span id="l8.1174" class="difflineminus">-  else</span>
<a href="#l8.1175"></a><span id="l8.1175" class="difflineminus">-    mailKeySet = SetRegistryKey(HKEY_LOCAL_MACHINE, &quot;Software\\Clients\\Mail&quot;, &quot;&quot;, &quot;&quot;);</span>
<a href="#l8.1176"></a><span id="l8.1176" class="difflineminus">-</span>
<a href="#l8.1177"></a><span id="l8.1177" class="difflineminus">-  // change HKEY_CURRENT_USER\\Software\\Clients\\Mail</span>
<a href="#l8.1178"></a><span id="l8.1178" class="difflineminus">-  nsCAutoString userAppName ;</span>
<a href="#l8.1179"></a><span id="l8.1179" class="difflineminus">-  GetRegistryKey(HKEY_LOCAL_MACHINE, kAppDesktopKey, &quot;HKEY_CURRENT_USER\\Software\\Clients\\Mail&quot;, userAppName);</span>
<a href="#l8.1180"></a><span id="l8.1180" class="difflineminus">-</span>
<a href="#l8.1181"></a><span id="l8.1181" class="difflineminus">-  restoreFileExtension(&quot;Software\\Classes\\&quot;, &quot;.eml&quot;);</span>
<a href="#l8.1182"></a><span id="l8.1182" class="difflineminus">-</span>
<a href="#l8.1183"></a><span id="l8.1183" class="difflineminus">-  if (!userAppName.IsEmpty())</span>
<a href="#l8.1184"></a><span id="l8.1184" class="difflineminus">-    SetRegistryKey(HKEY_CURRENT_USER, &quot;Software\\Clients\\Mail&quot;, &quot;&quot;, (char *)userAppName.get());</span>
<a href="#l8.1185"></a><span id="l8.1185" class="difflineminus">-  else</span>
<a href="#l8.1186"></a><span id="l8.1186" class="difflineminus">-    DeleteRegistryValue(HKEY_CURRENT_USER, &quot;Software\\Clients\\Mail&quot;, &quot;&quot;);</span>
<a href="#l8.1187"></a><span id="l8.1187" class="difflineminus">-</span>
<a href="#l8.1188"></a><span id="l8.1188" class="difflineminus">-  SetRegistryKey(HKEY_LOCAL_MACHINE, kAppDesktopKey,&quot;defaultMailHasBeenSet&quot;, &quot;0&quot;);</span>
<a href="#l8.1189"></a><span id="l8.1189" class="difflineminus">-</span>
<a href="#l8.1190"></a><span id="l8.1190" class="difflineminus">-  ::SendMessageTimeout( HWND_BROADCAST,</span>
<a href="#l8.1191"></a><span id="l8.1191" class="difflineminus">-                        WM_SETTINGCHANGE,</span>
<a href="#l8.1192"></a><span id="l8.1192" class="difflineminus">-                        0,</span>
<a href="#l8.1193"></a><span id="l8.1193" class="difflineminus">-                        (LPARAM)MOZ_CLIENT_MAIL_KEY,</span>
<a href="#l8.1194"></a><span id="l8.1194" class="difflineminus">-                        SMTO_NORMAL|SMTO_ABORTIFHUNG,</span>
<a href="#l8.1195"></a><span id="l8.1195" class="difflineminus">-                        MOZ_HWND_BROADCAST_MSG_TIMEOUT,</span>
<a href="#l8.1196"></a><span id="l8.1196" class="difflineminus">-                        NULL);</span>
<a href="#l8.1197"></a><span id="l8.1197" class="difflineminus">-  // Tell the MAPI Service to unregister the mapi proxy dll now that we are the default mail application</span>
<a href="#l8.1198"></a><span id="l8.1198" class="difflineminus">-  nsCOMPtr&lt;nsIMapiSupport&gt; mapiService (do_GetService(NS_IMAPISUPPORT_CONTRACTID, &amp;result));</span>
<a href="#l8.1199"></a><span id="l8.1199" class="difflineminus">-  NS_ENSURE_SUCCESS(result, result);</span>
<a href="#l8.1200"></a><span id="l8.1200" class="difflineminus">-  mapiService-&gt;UnRegisterServer();</span>
<a href="#l8.1201"></a><span id="l8.1201" class="difflineminus">-  return mailKeySet;</span>
<a href="#l8.1202"></a><span id="l8.1202" class="difflineminus">-}</span>
<a href="#l8.1203"></a><span id="l8.1203" class="difflineminus">-</span>
<a href="#l8.1204"></a><span id="l8.1204" class="difflineminus">-/** Returns FALSE if showMapiDialog is set to 0.</span>
<a href="#l8.1205"></a><span id="l8.1205" class="difflineminus">- *  Returns TRUE otherwise</span>
<a href="#l8.1206"></a><span id="l8.1206" class="difflineminus">- *  Also returns TRUE if the Mozilla has been set as the default mail client</span>
<a href="#l8.1207"></a><span id="l8.1207" class="difflineminus">- *  and some other application has changed that setting.</span>
<a href="#l8.1208"></a><span id="l8.1208" class="difflineminus">- *  This function gets called only if the current app is not the default mail</span>
<a href="#l8.1209"></a><span id="l8.1209" class="difflineminus">- *  client</span>
<a href="#l8.1210"></a><span id="l8.1210" class="difflineminus">- */</span>
<a href="#l8.1211"></a><span id="l8.1211" class="difflineminus">-PRBool nsMapiRegistryUtils::getShowDialog() {</span>
<a href="#l8.1212"></a><span id="l8.1212" class="difflineminus">-  PRBool rv = PR_FALSE;</span>
<a href="#l8.1213"></a><span id="l8.1213" class="difflineminus">-  nsCAutoString showDialog ;</span>
<a href="#l8.1214"></a><span id="l8.1214" class="difflineminus">-  GetRegistryKey(HKEY_LOCAL_MACHINE, kAppDesktopKey,</span>
<a href="#l8.1215"></a><span id="l8.1215" class="difflineminus">-                                      &quot;showMapiDialog&quot;, showDialog);</span>
<a href="#l8.1216"></a><span id="l8.1216" class="difflineminus">-  // if the user has not selected the checkbox, show dialog</span>
<a href="#l8.1217"></a><span id="l8.1217" class="difflineminus">-  if (showDialog.IsEmpty() || showDialog.Equals(&quot;1&quot;))</span>
<a href="#l8.1218"></a><span id="l8.1218" class="difflineminus">-    rv = PR_TRUE;</span>
<a href="#l8.1219"></a><span id="l8.1219" class="difflineminus">-</span>
<a href="#l8.1220"></a><span id="l8.1220" class="difflineminus">-  if (!rv)</span>
<a href="#l8.1221"></a><span id="l8.1221" class="difflineminus">-  {</span>
<a href="#l8.1222"></a><span id="l8.1222" class="difflineminus">-    // even if the user has selected the checkbox</span>
<a href="#l8.1223"></a><span id="l8.1223" class="difflineminus">-    // show it if some other application has changed the</span>
<a href="#l8.1224"></a><span id="l8.1224" class="difflineminus">-    // default setting.</span>
<a href="#l8.1225"></a><span id="l8.1225" class="difflineminus">-    nsCAutoString setMailDefault ;</span>
<a href="#l8.1226"></a><span id="l8.1226" class="difflineminus">-    GetRegistryKey(HKEY_LOCAL_MACHINE,kAppDesktopKey,</span>
<a href="#l8.1227"></a><span id="l8.1227" class="difflineminus">-                                   &quot;defaultMailHasBeenSet&quot;, setMailDefault);</span>
<a href="#l8.1228"></a><span id="l8.1228" class="difflineminus">-    if (setMailDefault.Equals(&quot;1&quot;))</span>
<a href="#l8.1229"></a><span id="l8.1229" class="difflineminus">-    {</span>
<a href="#l8.1230"></a><span id="l8.1230" class="difflineminus">-      // need to reset the defaultMailHasBeenSet to &quot;0&quot;</span>
<a href="#l8.1231"></a><span id="l8.1231" class="difflineminus">-      // so that after the dialog is displayed once,</span>
<a href="#l8.1232"></a><span id="l8.1232" class="difflineminus">-      // we do not keep displaying this dialog after the user has</span>
<a href="#l8.1233"></a><span id="l8.1233" class="difflineminus">-      // selected the checkbox</span>
<a href="#l8.1234"></a><span id="l8.1234" class="difflineminus">-      rv = SetRegistryKey(HKEY_LOCAL_MACHINE,</span>
<a href="#l8.1235"></a><span id="l8.1235" class="difflineminus">-                          kAppDesktopKey,</span>
<a href="#l8.1236"></a><span id="l8.1236" class="difflineminus">-                          &quot;defaultMailHasBeenSet&quot;, &quot;0&quot;);</span>
<a href="#l8.1237"></a><span id="l8.1237" class="difflineminus">-      rv = PR_TRUE;</span>
<a href="#l8.1238"></a><span id="l8.1238" class="difflineminus">-    }</span>
<a href="#l8.1239"></a><span id="l8.1239" class="difflineminus">-  }</span>
<a href="#l8.1240"></a><span id="l8.1240" class="difflineminus">-  return rv;</span>
<a href="#l8.1241"></a><span id="l8.1241" class="difflineminus">-}</span>
<a href="#l8.1242"></a><span id="l8.1242" class="difflineminus">-</span>
<a href="#l8.1243"></a><span id="l8.1243" class="difflineminus">-nsresult nsMapiRegistryUtils::MakeMapiStringBundle(nsIStringBundle ** aMapiStringBundle)</span>
<a href="#l8.1244"></a><span id="l8.1244" class="difflineminus">-{</span>
<a href="#l8.1245"></a><span id="l8.1245" class="difflineminus">-  nsresult rv;</span>
<a href="#l8.1246"></a><span id="l8.1246" class="difflineminus">-</span>
<a href="#l8.1247"></a><span id="l8.1247" class="difflineminus">-  if (m_mapiStringBundle)</span>
<a href="#l8.1248"></a><span id="l8.1248" class="difflineminus">-  {</span>
<a href="#l8.1249"></a><span id="l8.1249" class="difflineminus">-    NS_ADDREF(*aMapiStringBundle = m_mapiStringBundle);</span>
<a href="#l8.1250"></a><span id="l8.1250" class="difflineminus">-    return NS_OK;</span>
<a href="#l8.1251"></a><span id="l8.1251" class="difflineminus">-  }</span>
<a href="#l8.1252"></a><span id="l8.1252" class="difflineminus">-</span>
<a href="#l8.1253"></a><span id="l8.1253" class="difflineminus">-  nsCOMPtr&lt;nsIStringBundleService&gt; bundleService(do_GetService(NS_STRINGBUNDLE_CONTRACTID, &amp;rv));</span>
<a href="#l8.1254"></a><span id="l8.1254" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.1255"></a><span id="l8.1255" class="difflineminus">-</span>
<a href="#l8.1256"></a><span id="l8.1256" class="difflineminus">-  rv = bundleService-&gt;CreateBundle(MAPI_PROPERTIES_CHROME, getter_AddRefs(m_mapiStringBundle));</span>
<a href="#l8.1257"></a><span id="l8.1257" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.1258"></a><span id="l8.1258" class="difflineminus">-  NS_ADDREF(*aMapiStringBundle = m_mapiStringBundle) ;</span>
<a href="#l8.1259"></a><span id="l8.1259" class="difflineminus">-  return rv ;</span>
<a href="#l8.1260"></a><span id="l8.1260" class="difflineminus">-}</span>
<a href="#l8.1261"></a><span id="l8.1261" class="difflineminus">-</span>
<a href="#l8.1262"></a><span id="l8.1262" class="difflineminus">-nsresult nsMapiRegistryUtils::ShowMapiErrorDialog(PRBool aForMail)</span>
<a href="#l8.1263"></a><span id="l8.1263" class="difflineminus">-{</span>
<a href="#l8.1264"></a><span id="l8.1264" class="difflineminus">-  nsresult rv;</span>
<a href="#l8.1265"></a><span id="l8.1265" class="difflineminus">-  nsCOMPtr&lt;nsIPromptService&gt; promptService(do_GetService(NS_PROMPTSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l8.1266"></a><span id="l8.1266" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.1267"></a><span id="l8.1267" class="difflineminus">-</span>
<a href="#l8.1268"></a><span id="l8.1268" class="difflineminus">-  nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l8.1269"></a><span id="l8.1269" class="difflineminus">-  rv = MakeMapiStringBundle (getter_AddRefs (bundle)) ;</span>
<a href="#l8.1270"></a><span id="l8.1270" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.1271"></a><span id="l8.1271" class="difflineminus">-</span>
<a href="#l8.1272"></a><span id="l8.1272" class="difflineminus">-  nsString dialogTitle;</span>
<a href="#l8.1273"></a><span id="l8.1273" class="difflineminus">-  const PRUnichar *brandStrings[] = { brandName() };</span>
<a href="#l8.1274"></a><span id="l8.1274" class="difflineminus">-  NS_NAMED_LITERAL_STRING(dialogTitlePropertyTag, &quot;errorMessageTitle&quot;);</span>
<a href="#l8.1275"></a><span id="l8.1275" class="difflineminus">-  rv = bundle-&gt;FormatStringFromName(dialogTitlePropertyTag.get(),</span>
<a href="#l8.1276"></a><span id="l8.1276" class="difflineminus">-                                    brandStrings, 1,</span>
<a href="#l8.1277"></a><span id="l8.1277" class="difflineminus">-                                    getter_Copies(dialogTitle));</span>
<a href="#l8.1278"></a><span id="l8.1278" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.1279"></a><span id="l8.1279" class="difflineminus">-</span>
<a href="#l8.1280"></a><span id="l8.1280" class="difflineminus">-  nsString dialogText;</span>
<a href="#l8.1281"></a><span id="l8.1281" class="difflineminus">-</span>
<a href="#l8.1282"></a><span id="l8.1282" class="difflineminus">-  NS_NAMED_LITERAL_STRING(dialogTextPropertyTag, &quot;errorMessage&quot;);</span>
<a href="#l8.1283"></a><span id="l8.1283" class="difflineminus">-  NS_NAMED_LITERAL_STRING(dialogTextPropertyTagForNews, &quot;errorMessageNews&quot;);</span>
<a href="#l8.1284"></a><span id="l8.1284" class="difflineminus">-</span>
<a href="#l8.1285"></a><span id="l8.1285" class="difflineminus">-  rv = bundle-&gt;FormatStringFromName(aForMail ? dialogTextPropertyTag.get() : dialogTextPropertyTagForNews.get(),</span>
<a href="#l8.1286"></a><span id="l8.1286" class="difflineminus">-                                    brandStrings, 1,</span>
<a href="#l8.1287"></a><span id="l8.1287" class="difflineminus">-                                    getter_Copies(dialogText));</span>
<a href="#l8.1288"></a><span id="l8.1288" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.1289"></a><span id="l8.1289" class="difflineminus">-</span>
<a href="#l8.1290"></a><span id="l8.1290" class="difflineminus">-  return promptService-&gt;Alert(nsnull, dialogTitle.get(), dialogText.get());</span>
<a href="#l8.1291"></a><span id="l8.1291" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1">deleted file mode 100644</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineminus">--- a/mailnews/mapi/mapihook/src/nsMapiRegistryUtils.h</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineplus">+++ /dev/null</span>
<a href="#l9.4"></a><span id="l9.4" class="difflineat">@@ -1,145 +0,0 @@</span>
<a href="#l9.5"></a><span id="l9.5" class="difflineminus">-/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l9.6"></a><span id="l9.6" class="difflineminus">- * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l9.7"></a><span id="l9.7" class="difflineminus">- *</span>
<a href="#l9.8"></a><span id="l9.8" class="difflineminus">- * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l9.9"></a><span id="l9.9" class="difflineminus">- * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l9.10"></a><span id="l9.10" class="difflineminus">- * the License. You may obtain a copy of the License at</span>
<a href="#l9.11"></a><span id="l9.11" class="difflineminus">- * http://www.mozilla.org/MPL/</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">- *</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">- * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineminus">- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineminus">- * for the specific language governing rights and limitations under the</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineminus">- * License.</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineminus">- *</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineminus">- * The Original Code is mozilla.org code.</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineminus">- *</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineminus">- * The Initial Developer of the Original Code is</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineminus">- * Netscape Communications Corporation.</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineminus">- * Portions created by the Initial Developer are Copyright (C) 2001</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineminus">- * the Initial Developer. All Rights Reserved.</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineminus">- *</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineminus">- * Contributor(s):</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineminus">- *   Srilatha Moturi &lt;srilatha@netscape.com&gt;</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineminus">- *</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineminus">- * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineminus">- * either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineminus">- * or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineminus">- * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineminus">- * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineminus">- * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineminus">- * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineminus">- * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineminus">- * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineminus">- * the provisions above, a recipient may use your version of this file under</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineminus">- * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineminus">- *</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineminus">- * ***** END LICENSE BLOCK ***** */</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineminus">-</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineminus">-/***************************************************************************</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineminus">-*</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineminus">-* This File is no longer used by Thunderbird. Seamonkey is the only consumer.</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineminus">-* See mozilla/mail/components/shell for the Thunderbird registry code</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineminus">-*</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineminus">-*****************************************************************************/</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineminus">-</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineminus">-#ifndef nsmapiregistryutils_h____</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineminus">-#define nsmapiregistryutils_h____</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineminus">-</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineminus">-#include &lt;windows.h&gt;</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineminus">-#include &lt;string.h&gt;</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineminus">-#include &lt;winreg.h&gt;</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineminus">-</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineminus">-#include &quot;nsString.h&quot;</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineminus">-#include &quot;nsIStringBundle.h&quot;</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineminus">-</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineminus">-#ifndef MOZ_THUNDERBIRD</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineminus">-#define kAppDesktopKey &quot;Software\\Mozilla\\Desktop&quot;</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineminus">-#else</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineminus">-#define kAppDesktopKey &quot;Software\\Mozilla Thunderbird\\Desktop&quot;</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineminus">-#endif</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineminus">-</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineminus">-class nsMapiRegistryUtils</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineminus">-{</span>
<a href="#l9.67"></a><span id="l9.67" class="difflineminus">-private :</span>
<a href="#l9.68"></a><span id="l9.68" class="difflineminus">-    nsCString m_thisApp;</span>
<a href="#l9.69"></a><span id="l9.69" class="difflineminus">-    nsString m_brand;</span>
<a href="#l9.70"></a><span id="l9.70" class="difflineminus">-    nsString m_vendor;</span>
<a href="#l9.71"></a><span id="l9.71" class="difflineminus">-</span>
<a href="#l9.72"></a><span id="l9.72" class="difflineminus">-    nsCOMPtr&lt;nsIStringBundle&gt; m_mapiStringBundle ;</span>
<a href="#l9.73"></a><span id="l9.73" class="difflineminus">-</span>
<a href="#l9.74"></a><span id="l9.74" class="difflineminus">-    // sets result to the value of varName (as defined in brand.properties)</span>
<a href="#l9.75"></a><span id="l9.75" class="difflineminus">-    void getVarValue(const PRUnichar * varName, nsString &amp; result);</span>
<a href="#l9.76"></a><span id="l9.76" class="difflineminus">-</span>
<a href="#l9.77"></a><span id="l9.77" class="difflineminus">-    // verifyRestrictedAccess - Returns PR_TRUE if this user only has restricted access</span>
<a href="#l9.78"></a><span id="l9.78" class="difflineminus">-    // to the registry keys we need to modify. Consumers should call the public method </span>
<a href="#l9.79"></a><span id="l9.79" class="difflineminus">-    PRBool verifyRestrictedAccess() ;</span>
<a href="#l9.80"></a><span id="l9.80" class="difflineminus">-</span>
<a href="#l9.81"></a><span id="l9.81" class="difflineminus">-    PRBool mRestrictedRegAccess; // cannot write to HKLM in the registry</span>
<a href="#l9.82"></a><span id="l9.82" class="difflineminus">-</span>
<a href="#l9.83"></a><span id="l9.83" class="difflineminus">-    static void RegCopyKey(HKEY aSrcKey, HKEY aDestKey, const char* aSubKeyName); // recursively copies the given sub key from the src key to the dest key</span>
<a href="#l9.84"></a><span id="l9.84" class="difflineminus">-    nsresult recursiveDeleteKey(HKEY hKeyParent, const char* lpszKeyChild);</span>
<a href="#l9.85"></a><span id="l9.85" class="difflineminus">-</span>
<a href="#l9.86"></a><span id="l9.86" class="difflineminus">-public :</span>
<a href="#l9.87"></a><span id="l9.87" class="difflineminus">-    nsMapiRegistryUtils() ;</span>
<a href="#l9.88"></a><span id="l9.88" class="difflineminus">-</span>
<a href="#l9.89"></a><span id="l9.89" class="difflineminus">-    // returns TRUE if the Mapi32.dll is smart dll.</span>
<a href="#l9.90"></a><span id="l9.90" class="difflineminus">-    PRBool isSmartDll();</span>
<a href="#l9.91"></a><span id="l9.91" class="difflineminus">-    // returns TRUE if the Mapi32.dll is a Mozilla dll.</span>
<a href="#l9.92"></a><span id="l9.92" class="difflineminus">-    PRBool isMozDll();</span>
<a href="#l9.93"></a><span id="l9.93" class="difflineminus">-</span>
<a href="#l9.94"></a><span id="l9.94" class="difflineminus">-    PRBool HasRestrictedRegistryAccess() { return mRestrictedRegAccess; }</span>
<a href="#l9.95"></a><span id="l9.95" class="difflineminus">-</span>
<a href="#l9.96"></a><span id="l9.96" class="difflineminus">-    // Returns the (fully-qualified) name of this executable.</span>
<a href="#l9.97"></a><span id="l9.97" class="difflineminus">-    const char * thisApplication() ; </span>
<a href="#l9.98"></a><span id="l9.98" class="difflineminus">-    // This returns the brand name for this application</span>
<a href="#l9.99"></a><span id="l9.99" class="difflineminus">-    const PRUnichar * brandName() ;</span>
<a href="#l9.100"></a><span id="l9.100" class="difflineminus">-    // This returns the vendor name of this application</span>
<a href="#l9.101"></a><span id="l9.101" class="difflineminus">-    const nsString&amp; vendorName();</span>
<a href="#l9.102"></a><span id="l9.102" class="difflineminus">-</span>
<a href="#l9.103"></a><span id="l9.103" class="difflineminus">-    // set the Windows registry key</span>
<a href="#l9.104"></a><span id="l9.104" class="difflineminus">-    nsresult SetRegistryKey(HKEY baseKey, const char * keyName, </span>
<a href="#l9.105"></a><span id="l9.105" class="difflineminus">-                        const char * valueName, char * value);</span>
<a href="#l9.106"></a><span id="l9.106" class="difflineminus">-    // delete a registry key</span>
<a href="#l9.107"></a><span id="l9.107" class="difflineminus">-    nsresult DeleteRegistryValue(HKEY baseKey, const char * keyName, const char * valueName);</span>
<a href="#l9.108"></a><span id="l9.108" class="difflineminus">-</span>
<a href="#l9.109"></a><span id="l9.109" class="difflineminus">-    // get a Windows registry key</span>
<a href="#l9.110"></a><span id="l9.110" class="difflineminus">-    void GetRegistryKey(HKEY baseKey, const char * keyName, const char * valueName, nsCAutoString &amp; value);</span>
<a href="#l9.111"></a><span id="l9.111" class="difflineminus">-</span>
<a href="#l9.112"></a><span id="l9.112" class="difflineminus">-    // Returns TRUE if the current application is default mail client.</span>
<a href="#l9.113"></a><span id="l9.113" class="difflineminus">-    PRBool IsDefaultMailClient();</span>
<a href="#l9.114"></a><span id="l9.114" class="difflineminus">-    nsresult setDefaultMailClient(); // Sets Mozilla as default Mail Client</span>
<a href="#l9.115"></a><span id="l9.115" class="difflineminus">-    nsresult unsetDefaultMailClient(); // Removes Mozilla as the default Mail client and restores the previous setting</span>
<a href="#l9.116"></a><span id="l9.116" class="difflineminus">-    nsresult saveDefaultMailClient(); // Save default mail client settings in HKEY_LOCAL_MACHINE\\Software\\Mozilla\\Desktop   </span>
<a href="#l9.117"></a><span id="l9.117" class="difflineminus">-    nsresult saveUserDefaultMailClient(); // save default </span>
<a href="#l9.118"></a><span id="l9.118" class="difflineminus">-    PRBool IsDefaultFeedClient();</span>
<a href="#l9.119"></a><span id="l9.119" class="difflineminus">-    nsresult setDefaultFeedClient();</span>
<a href="#l9.120"></a><span id="l9.120" class="difflineminus">-    nsresult unsetDefaultFeedClient();</span>
<a href="#l9.121"></a><span id="l9.121" class="difflineminus">-       </span>
<a href="#l9.122"></a><span id="l9.122" class="difflineminus">-    PRBool IsDefaultNewsClient();      // Returns TRUE if the current application is default news client.  </span>
<a href="#l9.123"></a><span id="l9.123" class="difflineminus">-    nsresult setDefaultNewsClient();   // Sets Mozilla as the default News Client    </span>
<a href="#l9.124"></a><span id="l9.124" class="difflineminus">-    nsresult unsetDefaultNewsClient(); // Removes Mozilla as the default Mail client and restores the previous setting    </span>
<a href="#l9.125"></a><span id="l9.125" class="difflineminus">-    nsresult saveDefaultNewsClient();  // Saves the current setting of the default News Client in HKEY_LOCAL_MACHINE\\Software\\Mozilla\\Desktop</span>
<a href="#l9.126"></a><span id="l9.126" class="difflineminus">-    nsresult saveUserDefaultNewsClient();</span>
<a href="#l9.127"></a><span id="l9.127" class="difflineminus">-</span>
<a href="#l9.128"></a><span id="l9.128" class="difflineminus">-    nsresult setupDefaultProtocolKey(const char * aDefaultAppRegKey, const char * aProtocol, const char * aProtocolEntryValue, const char * aCmdLineParam); </span>
<a href="#l9.129"></a><span id="l9.129" class="difflineminus">-    nsresult setProtocolHandler(const char * aDefaultAppRegKey, const char * protocolName); // installs protocol handler on Software\Classes\&lt;protocolName&gt;</span>
<a href="#l9.130"></a><span id="l9.130" class="difflineminus">-</span>
<a href="#l9.131"></a><span id="l9.131" class="difflineminus">-    nsresult setupFileExtension(const char * aDefaultAppRegKey, const char * aExtension);</span>
<a href="#l9.132"></a><span id="l9.132" class="difflineminus">-    nsresult restoreFileExtension(const char * aDefaultAppRegKey, const char * aExtension);</span>
<a href="#l9.133"></a><span id="l9.133" class="difflineminus">-</span>
<a href="#l9.134"></a><span id="l9.134" class="difflineminus">-    nsresult registerNewsApp(PRBool aForceRegistration); // aForceRegistration set to TRUE if we want to force the keys to be set again</span>
<a href="#l9.135"></a><span id="l9.135" class="difflineminus">-    nsresult registerMailApp(PRBool aForceRegistration);</span>
<a href="#l9.136"></a><span id="l9.136" class="difflineminus">-</span>
<a href="#l9.137"></a><span id="l9.137" class="difflineminus">-    nsresult CopyMozMapiToWinSysDir();</span>
<a href="#l9.138"></a><span id="l9.138" class="difflineminus">-    nsresult RestoreBackedUpMapiDll();</span>
<a href="#l9.139"></a><span id="l9.139" class="difflineminus">-</span>
<a href="#l9.140"></a><span id="l9.140" class="difflineminus">-    // Returns FALSE if showMapiDialog is set to 0.</span>
<a href="#l9.141"></a><span id="l9.141" class="difflineminus">-    PRBool getShowDialog() ;</span>
<a href="#l9.142"></a><span id="l9.142" class="difflineminus">-</span>
<a href="#l9.143"></a><span id="l9.143" class="difflineminus">-    // create a string bundle for MAPI messages</span>
<a href="#l9.144"></a><span id="l9.144" class="difflineminus">-    nsresult MakeMapiStringBundle(nsIStringBundle ** aMapiStringBundle) ;</span>
<a href="#l9.145"></a><span id="l9.145" class="difflineminus">-    // display an error dialog for MAPI messages</span>
<a href="#l9.146"></a><span id="l9.146" class="difflineminus">-    nsresult ShowMapiErrorDialog(PRBool aForMail); // set to false if showing a news error</span>
<a href="#l9.147"></a><span id="l9.147" class="difflineminus">-} ;</span>
<a href="#l9.148"></a><span id="l9.148" class="difflineminus">-</span>
<a href="#l9.149"></a><span id="l9.149" class="difflineminus">-#endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/suite/browser/navigator.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/suite/browser/navigator.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -2044,34 +2044,38 @@ function URLBarMouseDownHandler(aEvent)</span>
<a href="#l10.4"></a><span id="l10.4"> </span>
<a href="#l10.5"></a><span id="l10.5"> function URLBarClickHandler(aEvent)</span>
<a href="#l10.6"></a><span id="l10.6"> {</span>
<a href="#l10.7"></a><span id="l10.7">   if (!gIgnoreClick &amp;&amp; gClickSelectsAll &amp;&amp; gURLBar.selectionStart == gURLBar.selectionEnd)</span>
<a href="#l10.8"></a><span id="l10.8">     if (gClickAtEndSelects || gURLBar.selectionStart &lt; gURLBar.value.length)</span>
<a href="#l10.9"></a><span id="l10.9">       gURLBar.select();</span>
<a href="#l10.10"></a><span id="l10.10"> }</span>
<a href="#l10.11"></a><span id="l10.11"> </span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-// This function gets the &quot;windows hooks&quot; service and has it check its setting</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-// This will do nothing on platforms other than Windows.</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+// This function gets the shell service and has it check its setting</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineplus">+// This will do nothing on platforms without a shell service.</span>
<a href="#l10.16"></a><span id="l10.16"> function checkForDefaultBrowser()</span>
<a href="#l10.17"></a><span id="l10.17"> {</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineminus">-  const NS_WINHOOKS_CONTRACTID = &quot;@mozilla.org/winhooks;1&quot;;</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineminus">-  var dialogShown = false;</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineminus">-  if (NS_WINHOOKS_CONTRACTID in Components.classes) {</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineminus">-    try {</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineminus">-      dialogShown = Components.classes[NS_WINHOOKS_CONTRACTID]</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineminus">-                      .getService(Components.interfaces.nsIWindowsHooks)</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineminus">-                      .checkSettings(window);</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineminus">-    } catch(e) {</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineminus">-    }</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineplus">+  const NS_SHELLSERVICE_CID = &quot;@mozilla.org/suite/shell-service;1&quot;;</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineplus">+  </span>
<a href="#l10.29"></a><span id="l10.29" class="difflineplus">+  if (NS_SHELLSERVICE_CID in Components.classes) {</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineplus">+    const nsIShellService = Components.interfaces.nsIShellService;</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineplus">+    var shellService = Components.classes[&quot;@mozilla.org/suite/shell-service;1&quot;]</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineplus">+                                 .getService(nsIShellService);</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineplus">+    var appTypes = shellService.shouldBeDefaultClientFor;</span>
<a href="#l10.34"></a><span id="l10.34"> </span>
<a href="#l10.35"></a><span id="l10.35" class="difflineminus">-    if (dialogShown)  </span>
<a href="#l10.36"></a><span id="l10.36" class="difflineminus">-    {</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineplus">+    // show the default client dialog only if we should check for the default</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineplus">+    // client and we aren't already the default for the stored app types in</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineplus">+    // shell.checkDefaultApps</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineplus">+    if (appTypes &amp;&amp; shellService.shouldCheckDefaultClient &amp;&amp;</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineplus">+        !shellService.isDefaultClient(true, appTypes)) {</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineplus">+      window.openDialog(&quot;chrome://communicator/content/defaultClientDialog.xul&quot;,</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineplus">+                        &quot;DefaultClient&quot;,</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineplus">+                        &quot;modal,centerscreen,chrome,resizable=no&quot;); </span>
<a href="#l10.45"></a><span id="l10.45">       // Force the sidebar to build since the windows </span>
<a href="#l10.46"></a><span id="l10.46" class="difflineminus">-      // integration dialog may have come up.</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineplus">+      // integration dialog has come up.</span>
<a href="#l10.48"></a><span id="l10.48">       SidebarRebuild();</span>
<a href="#l10.49"></a><span id="l10.49">     }</span>
<a href="#l10.50"></a><span id="l10.50">   }</span>
<a href="#l10.51"></a><span id="l10.51"> }</span>
<a href="#l10.52"></a><span id="l10.52"> </span>
<a href="#l10.53"></a><span id="l10.53"> function ShowAndSelectContentsOfURLBar()</span>
<a href="#l10.54"></a><span id="l10.54"> {</span>
<a href="#l10.55"></a><span id="l10.55">   var navBar = document.getElementById(&quot;nav-bar&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1">new file mode 100644</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineminus">--- /dev/null</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineplus">+++ b/suite/common/defaultClientDialog.js</span>
<a href="#l11.4"></a><span id="l11.4" class="difflineat">@@ -0,0 +1,93 @@</span>
<a href="#l11.5"></a><span id="l11.5" class="difflineplus">+/* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l11.6"></a><span id="l11.6" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l11.7"></a><span id="l11.7" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l11.8"></a><span id="l11.8" class="difflineplus">+ *</span>
<a href="#l11.9"></a><span id="l11.9" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l11.10"></a><span id="l11.10" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l11.11"></a><span id="l11.11" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+ *</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineplus">+ * License.</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineplus">+ *</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineplus">+ * The Original Code is Thunderbird Default Client Dialog</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineplus">+ *</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineplus">+ *   Scott MacGregor &lt;mscott@mozilla.org&gt;</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2006</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineplus">+ *</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineplus">+ *   Mark Banner &lt;bugzilla@standard8.demon.co.uk&gt;</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineplus">+ *   Frank Wein &lt;mcsmurf@mcsmurf.de&gt;</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineplus">+ *</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineplus">+ * either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineplus">+ * or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineplus">+ *</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineplus">+</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineplus">+// this dialog can only be opened if we have a shell service</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineplus">+const nsIShellService = Components.interfaces.nsIShellService;</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineplus">+const nsIPrefBranch = Components.interfaces.nsIPrefBranch;</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineplus">+</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineplus">+function onLoad()</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineplus">+{</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineplus">+  var shellSvc = Components.classes[&quot;@mozilla.org/suite/shell-service;1&quot;]</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineplus">+                           .getService(nsIShellService);</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineplus">+  var defaultList = document.getElementById(&quot;defaultList&quot;);</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineplus">+  var appTypes = shellSvc.shouldBeDefaultClientFor;</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineplus">+  /* Iterate through the list of possible default client types and check for</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineplus">+     each list item if we want to be the default for that type using the AND</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineplus">+     conjunction */</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineplus">+  for (var i = 0; i &lt; defaultList.getRowCount(); i++) {</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineplus">+    var currentItem = defaultList.getItemAtIndex(i);</span>
<a href="#l11.59"></a><span id="l11.59" class="difflineplus">+    if (nsIShellService[currentItem.value] &amp; appTypes)</span>
<a href="#l11.60"></a><span id="l11.60" class="difflineplus">+      currentItem.checked = true;</span>
<a href="#l11.61"></a><span id="l11.61" class="difflineplus">+</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineplus">+    if (shellSvc.isDefaultClient(false, nsIShellService[currentItem.value]))</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineplus">+      currentItem.disabled = true;</span>
<a href="#l11.64"></a><span id="l11.64" class="difflineplus">+  }</span>
<a href="#l11.65"></a><span id="l11.65" class="difflineplus">+}</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineplus">+</span>
<a href="#l11.67"></a><span id="l11.67" class="difflineplus">+function onAccept()</span>
<a href="#l11.68"></a><span id="l11.68" class="difflineplus">+{</span>
<a href="#l11.69"></a><span id="l11.69" class="difflineplus">+  // for each checked item, if we aren't already the default, make us the default.</span>
<a href="#l11.70"></a><span id="l11.70" class="difflineplus">+  var shellSvc = Components.classes[&quot;@mozilla.org/suite/shell-service;1&quot;]</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineplus">+                           .getService(nsIShellService);</span>
<a href="#l11.72"></a><span id="l11.72" class="difflineplus">+  var pref = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l11.73"></a><span id="l11.73" class="difflineplus">+                       .getService(nsIPrefBranch);</span>
<a href="#l11.74"></a><span id="l11.74" class="difflineplus">+  var appTypes = 0;</span>
<a href="#l11.75"></a><span id="l11.75" class="difflineplus">+  var appTypesCheck = 0;</span>
<a href="#l11.76"></a><span id="l11.76" class="difflineplus">+  var defaultList = document.getElementById(&quot;defaultList&quot;);</span>
<a href="#l11.77"></a><span id="l11.77" class="difflineplus">+</span>
<a href="#l11.78"></a><span id="l11.78" class="difflineplus">+  for (var i = 0; i &lt; defaultList.getRowCount(); i++) {</span>
<a href="#l11.79"></a><span id="l11.79" class="difflineplus">+    var currentItem = defaultList.getItemAtIndex(i);</span>
<a href="#l11.80"></a><span id="l11.80" class="difflineplus">+    var currentAppType = nsIShellService[currentItem.value];</span>
<a href="#l11.81"></a><span id="l11.81" class="difflineplus">+    </span>
<a href="#l11.82"></a><span id="l11.82" class="difflineplus">+    if (currentItem.checked) {</span>
<a href="#l11.83"></a><span id="l11.83" class="difflineplus">+      appTypesCheck |= currentAppType;</span>
<a href="#l11.84"></a><span id="l11.84" class="difflineplus">+      </span>
<a href="#l11.85"></a><span id="l11.85" class="difflineplus">+      if (!currentItem.disabled)</span>
<a href="#l11.86"></a><span id="l11.86" class="difflineplus">+        appTypes |= currentAppType;</span>
<a href="#l11.87"></a><span id="l11.87" class="difflineplus">+    }</span>
<a href="#l11.88"></a><span id="l11.88" class="difflineplus">+  }</span>
<a href="#l11.89"></a><span id="l11.89" class="difflineplus">+ </span>
<a href="#l11.90"></a><span id="l11.90" class="difflineplus">+  if (appTypes)</span>
<a href="#l11.91"></a><span id="l11.91" class="difflineplus">+    shellSvc.setDefaultClient(false, true, appTypes);</span>
<a href="#l11.92"></a><span id="l11.92" class="difflineplus">+</span>
<a href="#l11.93"></a><span id="l11.93" class="difflineplus">+  // Update the pref for which app types we should check if we are the default app</span>
<a href="#l11.94"></a><span id="l11.94" class="difflineplus">+  shellSvc.shouldBeDefaultClientFor = appTypesCheck;</span>
<a href="#l11.95"></a><span id="l11.95" class="difflineplus">+</span>
<a href="#l11.96"></a><span id="l11.96" class="difflineplus">+  shellSvc.shouldCheckDefaultClient = document.getElementById('checkOnStartup').checked;</span>
<a href="#l11.97"></a><span id="l11.97" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1">new file mode 100644</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineminus">--- /dev/null</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineplus">+++ b/suite/common/defaultClientDialog.xul</span>
<a href="#l12.4"></a><span id="l12.4" class="difflineat">@@ -0,0 +1,71 @@</span>
<a href="#l12.5"></a><span id="l12.5" class="difflineplus">+&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<a href="#l12.6"></a><span id="l12.6" class="difflineplus">+</span>
<a href="#l12.7"></a><span id="l12.7" class="difflineplus">+&lt;!-- ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l12.8"></a><span id="l12.8" class="difflineplus">+ Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l12.9"></a><span id="l12.9" class="difflineplus">+</span>
<a href="#l12.10"></a><span id="l12.10" class="difflineplus">+ The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l12.11"></a><span id="l12.11" class="difflineplus">+ 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+ the License. You may obtain a copy of the License at</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+ http://www.mozilla.org/MPL/</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+ Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineplus">+ WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineplus">+ for the specific language governing rights and limitations under the</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineplus">+ License.</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineplus">+</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineplus">+ The Original Code is Thunderbird Default Client Dialog</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineplus">+</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineplus">+ The Initial Developer of the Original Code is</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineplus">+ Scott MacGregor.</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineplus">+ Portions created by the Initial Developer are Copyright (C) 2006</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineplus">+ the Initial Developer. All Rights Reserved.</span>
<a href="#l12.26"></a><span id="l12.26" class="difflineplus">+</span>
<a href="#l12.27"></a><span id="l12.27" class="difflineplus">+ Contributor(s):</span>
<a href="#l12.28"></a><span id="l12.28" class="difflineplus">+   Scott MacGregor &lt;mscott@mozilla.org&gt;</span>
<a href="#l12.29"></a><span id="l12.29" class="difflineplus">+   Mark Banner &lt;bugzilla@standard8.demon.co.uk&gt;</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineplus">+   Frank Wein &lt;mcsmurf@mcsmurf.de&gt;</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineplus">+</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineplus">+ Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineplus">+ either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineplus">+ or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineplus">+ in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l12.36"></a><span id="l12.36" class="difflineplus">+ of those above. If you wish to allow use of your version of this file only</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineplus">+ under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineplus">+ use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l12.39"></a><span id="l12.39" class="difflineplus">+ decision by deleting the provisions above and replace them with the notice</span>
<a href="#l12.40"></a><span id="l12.40" class="difflineplus">+ and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l12.41"></a><span id="l12.41" class="difflineplus">+ the provisions above, a recipient may use your version of this file under</span>
<a href="#l12.42"></a><span id="l12.42" class="difflineplus">+ the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l12.43"></a><span id="l12.43" class="difflineplus">+</span>
<a href="#l12.44"></a><span id="l12.44" class="difflineplus">+ ***** END LICENSE BLOCK ***** --&gt;</span>
<a href="#l12.45"></a><span id="l12.45" class="difflineplus">+</span>
<a href="#l12.46"></a><span id="l12.46" class="difflineplus">+&lt;?xml-stylesheet href=&quot;chrome://global/skin/&quot;?&gt;</span>
<a href="#l12.47"></a><span id="l12.47" class="difflineplus">+</span>
<a href="#l12.48"></a><span id="l12.48" class="difflineplus">+&lt;!DOCTYPE window [</span>
<a href="#l12.49"></a><span id="l12.49" class="difflineplus">+  &lt;!ENTITY % brandDTD SYSTEM &quot;chrome://branding/locale/brand.dtd&quot; &gt;</span>
<a href="#l12.50"></a><span id="l12.50" class="difflineplus">+  %brandDTD;</span>
<a href="#l12.51"></a><span id="l12.51" class="difflineplus">+  &lt;!ENTITY % defaultClientDTD SYSTEM &quot;chrome://communicator/locale/defaultClientDialog.dtd&quot; &gt;</span>
<a href="#l12.52"></a><span id="l12.52" class="difflineplus">+  %defaultClientDTD;</span>
<a href="#l12.53"></a><span id="l12.53" class="difflineplus">+]&gt;</span>
<a href="#l12.54"></a><span id="l12.54" class="difflineplus">+</span>
<a href="#l12.55"></a><span id="l12.55" class="difflineplus">+&lt;dialog xmlns:html=&quot;http://www.w3.org/1999/xhtml&quot;</span>
<a href="#l12.56"></a><span id="l12.56" class="difflineplus">+        xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;</span>
<a href="#l12.57"></a><span id="l12.57" class="difflineplus">+        id=&quot;defaultClientDialog&quot;</span>
<a href="#l12.58"></a><span id="l12.58" class="difflineplus">+        buttons=&quot;accept,cancel&quot;</span>
<a href="#l12.59"></a><span id="l12.59" class="difflineplus">+        onload=&quot;onLoad();&quot;</span>
<a href="#l12.60"></a><span id="l12.60" class="difflineplus">+        ondialogaccept=&quot;return onAccept();&quot;</span>
<a href="#l12.61"></a><span id="l12.61" class="difflineplus">+        title=&quot;&amp;defaultClient.title;&quot;&gt;</span>
<a href="#l12.62"></a><span id="l12.62" class="difflineplus">+  </span>
<a href="#l12.63"></a><span id="l12.63" class="difflineplus">+  &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://communicator/content/defaultClientDialog.js&quot;/&gt;</span>
<a href="#l12.64"></a><span id="l12.64" class="difflineplus">+  </span>
<a href="#l12.65"></a><span id="l12.65" class="difflineplus">+  &lt;description&gt;&amp;defaultClient.intro;&lt;/description&gt;</span>
<a href="#l12.66"></a><span id="l12.66" class="difflineplus">+  &lt;listbox rows=&quot;3&quot; id=&quot;defaultList&quot;&gt;</span>
<a href="#l12.67"></a><span id="l12.67" class="difflineplus">+    &lt;listitem value=&quot;BROWSER&quot; type=&quot;checkbox&quot; label=&quot;&amp;browser.label;&quot;/&gt;</span>
<a href="#l12.68"></a><span id="l12.68" class="difflineplus">+    &lt;listitem value=&quot;MAIL&quot; type=&quot;checkbox&quot; label=&quot;&amp;email.label;&quot;/&gt;</span>
<a href="#l12.69"></a><span id="l12.69" class="difflineplus">+    &lt;listitem value=&quot;NEWS&quot; type=&quot;checkbox&quot; label=&quot;&amp;newsgroups.label;&quot;/&gt;</span>
<a href="#l12.70"></a><span id="l12.70" class="difflineplus">+  &lt;/listbox&gt;</span>
<a href="#l12.71"></a><span id="l12.71" class="difflineplus">+</span>
<a href="#l12.72"></a><span id="l12.72" class="difflineplus">+  &lt;separator class=&quot;thin&quot;/&gt;</span>
<a href="#l12.73"></a><span id="l12.73" class="difflineplus">+  &lt;checkbox id=&quot;checkOnStartup&quot; checked=&quot;true&quot; label=&quot;&amp;checkOnStartup.label;&quot; accesskey=&quot;&amp;checkOnStartup.accesskey;&quot;/&gt;</span>
<a href="#l12.74"></a><span id="l12.74" class="difflineplus">+</span>
<a href="#l12.75"></a><span id="l12.75" class="difflineplus">+&lt;/dialog&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/suite/common/jar.mn</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/suite/common/jar.mn</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -49,16 +49,18 @@ comm.jar:</span>
<a href="#l13.4"></a><span id="l13.4">    content/communicator/askViewZoom.js</span>
<a href="#l13.5"></a><span id="l13.5">    content/communicator/browserBindings.xul</span>
<a href="#l13.6"></a><span id="l13.6">    content/communicator/communicator.css</span>
<a href="#l13.7"></a><span id="l13.7">    content/communicator/consoleOverlay.xul</span>
<a href="#l13.8"></a><span id="l13.8">    content/communicator/contentAreaUtils.js</span>
<a href="#l13.9"></a><span id="l13.9">    content/communicator/contentAreaDD.js</span>
<a href="#l13.10"></a><span id="l13.10">    content/communicator/contentAreaClick.js</span>
<a href="#l13.11"></a><span id="l13.11">    content/communicator/contentAreaContextOverlay.xul</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+   content/communicator/defaultClientDialog.js</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+   content/communicator/defaultClientDialog.xul</span>
<a href="#l13.14"></a><span id="l13.14">    content/communicator/editorBindings.xul</span>
<a href="#l13.15"></a><span id="l13.15">    content/communicator/findUtils.js</span>
<a href="#l13.16"></a><span id="l13.16">    content/communicator/helpEditorOverlay.xul</span>
<a href="#l13.17"></a><span id="l13.17">    content/communicator/helpMessengerOverlay.xul</span>
<a href="#l13.18"></a><span id="l13.18">    content/communicator/helpSecurityOverlay.xul</span>
<a href="#l13.19"></a><span id="l13.19">    content/communicator/helpOverlay.js</span>
<a href="#l13.20"></a><span id="l13.20">    content/communicator/helpOverlay.xul</span>
<a href="#l13.21"></a><span id="l13.21"> # the following file is a suite-specific override of the generic license.html, using suite/common/app-license.html as input:</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/suite/common/pref/pref-advanced.xul</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/suite/common/pref/pref-advanced.xul</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -51,16 +51,19 @@</span>
<a href="#l14.4"></a><span id="l14.4"> </span>
<a href="#l14.5"></a><span id="l14.5">     &lt;preferences id=&quot;advanced_preferences&quot;&gt;</span>
<a href="#l14.6"></a><span id="l14.6">       &lt;preference id=&quot;security.enable_java&quot;</span>
<a href="#l14.7"></a><span id="l14.7">                   name=&quot;security.enable_java&quot;</span>
<a href="#l14.8"></a><span id="l14.8">                   type=&quot;bool&quot;/&gt;</span>
<a href="#l14.9"></a><span id="l14.9">       &lt;preference id=&quot;config.use_system_prefs&quot;</span>
<a href="#l14.10"></a><span id="l14.10">                   name=&quot;config.use_system_prefs&quot;</span>
<a href="#l14.11"></a><span id="l14.11">                   type=&quot;bool&quot;/&gt;</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineplus">+      &lt;preference id=&quot;shell.checkDefaultClient&quot;</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+                  name=&quot;shell.checkDefaultClient&quot;</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+                  type=&quot;bool&quot;/&gt;</span>
<a href="#l14.15"></a><span id="l14.15">     &lt;/preferences&gt;</span>
<a href="#l14.16"></a><span id="l14.16"> </span>
<a href="#l14.17"></a><span id="l14.17">     &lt;groupbox id=&quot;advancedSettings&quot;&gt;</span>
<a href="#l14.18"></a><span id="l14.18">       &lt;caption label=&quot;&amp;prefEnableJava.caption;&quot;/&gt;</span>
<a href="#l14.19"></a><span id="l14.19">       &lt;checkbox id=&quot;advancedJavaAllow&quot;</span>
<a href="#l14.20"></a><span id="l14.20">                 label=&quot;&amp;enbJavaCheck.label;&quot;</span>
<a href="#l14.21"></a><span id="l14.21">                 accesskey=&quot;&amp;enbJavaCheck.accesskey;&quot;</span>
<a href="#l14.22"></a><span id="l14.22">                 preference=&quot;security.enable_java&quot;/&gt;</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineat">@@ -70,10 +73,18 @@</span>
<a href="#l14.24"></a><span id="l14.24">       &lt;caption id=&quot;systemPrefCaption&quot; label=&quot;&amp;systemPref.caption;&quot;/&gt;</span>
<a href="#l14.25"></a><span id="l14.25">       &lt;description&gt;&amp;systemPref.desc;&lt;/description&gt;</span>
<a href="#l14.26"></a><span id="l14.26">       &lt;checkbox id=&quot;systemPrefCheck&quot;</span>
<a href="#l14.27"></a><span id="l14.27">                 label=&quot;&amp;systemPrefCheck.label;&quot;</span>
<a href="#l14.28"></a><span id="l14.28">                 accesskey=&quot;&amp;systemPrefCheck.accesskey;&quot;</span>
<a href="#l14.29"></a><span id="l14.29">                 preference=&quot;config.use_system_prefs&quot;/&gt;</span>
<a href="#l14.30"></a><span id="l14.30">     &lt;/groupbox&gt;</span>
<a href="#l14.31"></a><span id="l14.31"> </span>
<a href="#l14.32"></a><span id="l14.32" class="difflineplus">+    &lt;groupbox id=&quot;checkDefault&quot;&gt;</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineplus">+      &lt;caption label=&quot;&amp;prefCheckDefault.caption;&quot;/&gt;</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineplus">+      &lt;checkbox id=&quot;checkDefaultClient&quot;</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineplus">+                label=&quot;&amp;prefCheckDefaultClient.label;&quot;</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineplus">+                accesskey=&quot;&amp;prefCheckDefaultClient.accesskey;&quot;</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineplus">+                preference=&quot;shell.checkDefaultClient&quot;/&gt;</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineplus">+    &lt;/groupbox&gt;</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineplus">+</span>
<a href="#l14.40"></a><span id="l14.40">   &lt;/prefpane&gt;</span>
<a href="#l14.41"></a><span id="l14.41"> &lt;/overlay&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/suite/common/pref/pref-navigator.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/suite/common/pref/pref-navigator.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -290,125 +290,61 @@ function Startup()</span>
<a href="#l15.4"></a><span id="l15.4">   InitPlatformIntegration();</span>
<a href="#l15.5"></a><span id="l15.5"> }</span>
<a href="#l15.6"></a><span id="l15.6"> </span>
<a href="#l15.7"></a><span id="l15.7"> function SwitchPage(aIndex)</span>
<a href="#l15.8"></a><span id="l15.8"> {</span>
<a href="#l15.9"></a><span id="l15.9">   document.getElementById(&quot;behaviourDeck&quot;).selectedIndex = aIndex;</span>
<a href="#l15.10"></a><span id="l15.10"> }</span>
<a href="#l15.11"></a><span id="l15.11"> </span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-</span>
<a href="#l15.13"></a><span id="l15.13"> // platform integration</span>
<a href="#l15.14"></a><span id="l15.14"> </span>
<a href="#l15.15"></a><span id="l15.15"> function ApplySetAsDefaultBrowser()</span>
<a href="#l15.16"></a><span id="l15.16"> {</span>
<a href="#l15.17"></a><span id="l15.17" class="difflineminus">-  // In future, we will use the Shell Service here,</span>
<a href="#l15.18"></a><span id="l15.18" class="difflineminus">-  // for now, just use WinHooks.</span>
<a href="#l15.19"></a><span id="l15.19" class="difflineminus">-  window.gWinHooks.winhooks.settings = window.gWinHooks.prefs;</span>
<a href="#l15.20"></a><span id="l15.20" class="difflineminus">-}</span>
<a href="#l15.21"></a><span id="l15.21" class="difflineplus">+  const nsIShellService = Components.interfaces.nsIShellService;</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineplus">+  var shellSvc = Components.classes[&quot;@mozilla.org/suite/shell-service;1&quot;]</span>
<a href="#l15.23"></a><span id="l15.23" class="difflineplus">+                           .getService(nsIShellService);</span>
<a href="#l15.24"></a><span id="l15.24" class="difflineplus">+  var appTypes = shellSvc.shouldBeDefaultClientFor; </span>
<a href="#l15.25"></a><span id="l15.25"> </span>
<a href="#l15.26"></a><span id="l15.26" class="difflineminus">-function UpdateDefaultBrowserGroup()</span>
<a href="#l15.27"></a><span id="l15.27" class="difflineminus">-{</span>
<a href="#l15.28"></a><span id="l15.28" class="difflineminus">-  // set description and button state according to integration setting</span>
<a href="#l15.29"></a><span id="l15.29" class="difflineminus">-  var state = window.gWinHooks.state;</span>
<a href="#l15.30"></a><span id="l15.30" class="difflineminus">-  var desc = document.getElementById(&quot;defaultBrowserDesc&quot;);</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineminus">-  desc.textContent = desc.getAttribute(&quot;desc&quot; + state);</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineminus">-  document.getElementById(&quot;defaultBrowserButton&quot;).disabled = (state != PFINT_NOT_DEFAULT);</span>
<a href="#l15.33"></a><span id="l15.33" class="difflineplus">+  shellSvc.setDefaultClient(false, false, nsIShellService.BROWSER);</span>
<a href="#l15.34"></a><span id="l15.34" class="difflineplus">+</span>
<a href="#l15.35"></a><span id="l15.35" class="difflineplus">+  if (appTypes != (appTypes | nsIShellService.BROWSER))</span>
<a href="#l15.36"></a><span id="l15.36" class="difflineplus">+    shellSvc.shouldBeDefaultClientFor |= nsIShellService.BROWSER;</span>
<a href="#l15.37"></a><span id="l15.37"> }</span>
<a href="#l15.38"></a><span id="l15.38"> </span>
<a href="#l15.39"></a><span id="l15.39"> function InitPlatformIntegration()</span>
<a href="#l15.40"></a><span id="l15.40"> {</span>
<a href="#l15.41"></a><span id="l15.41" class="difflineminus">-  // In future, we will ask the Shell Service about platform integration here,</span>
<a href="#l15.42"></a><span id="l15.42" class="difflineminus">-  // for now, just check WinHooks.</span>
<a href="#l15.43"></a><span id="l15.43" class="difflineminus">-  var showDefaultBrowserGroup = /Win/.test(navigator.platform);</span>
<a href="#l15.44"></a><span id="l15.44" class="difflineminus">-  document.getElementById(&quot;defaultBrowserGroup&quot;).hidden = !showDefaultBrowserGroup;</span>
<a href="#l15.45"></a><span id="l15.45" class="difflineminus">-  if (!showDefaultBrowserGroup)</span>
<a href="#l15.46"></a><span id="l15.46" class="difflineminus">-    return;</span>
<a href="#l15.47"></a><span id="l15.47" class="difflineminus">-</span>
<a href="#l15.48"></a><span id="l15.48" class="difflineminus">-  // Determine if we have been selected as the default browser already, and</span>
<a href="#l15.49"></a><span id="l15.49" class="difflineminus">-  // enable/disable the &quot;Set As Default&quot; button accordingly.</span>
<a href="#l15.50"></a><span id="l15.50" class="difflineminus">-</span>
<a href="#l15.51"></a><span id="l15.51" class="difflineminus">-  // We store our state info in the same place as the code in pref-winhooks.js</span>
<a href="#l15.52"></a><span id="l15.52" class="difflineminus">-  // uses so that this panel and the Advanced/System panel are kept in sync.</span>
<a href="#l15.53"></a><span id="l15.53" class="difflineminus">-  if (!(&quot;gWinHooks&quot; in window))</span>
<a href="#l15.54"></a><span id="l15.54" class="difflineminus">-  {</span>
<a href="#l15.55"></a><span id="l15.55" class="difflineminus">-    // Neither the Advanced/System panel nor this panel has appeared.</span>
<a href="#l15.56"></a><span id="l15.56" class="difflineminus">-    // Initialize the state information.</span>
<a href="#l15.57"></a><span id="l15.57" class="difflineminus">-    window.gWinHooks = {};</span>
<a href="#l15.58"></a><span id="l15.58" class="difflineminus">-</span>
<a href="#l15.59"></a><span id="l15.59" class="difflineminus">-    // Get winhooks service.</span>
<a href="#l15.60"></a><span id="l15.60" class="difflineminus">-    window.gWinHooks.winhooks = Components.classes[&quot;@mozilla.org/winhooks;1&quot;]</span>
<a href="#l15.61"></a><span id="l15.61" class="difflineminus">-                                          .getService(Components.interfaces.nsIWindowsHooks);</span>
<a href="#l15.62"></a><span id="l15.62" class="difflineminus">-</span>
<a href="#l15.63"></a><span id="l15.63" class="difflineminus">-    // Extract current settings (these are what the user has checked on</span>
<a href="#l15.64"></a><span id="l15.64" class="difflineminus">-    // the Advanced/System panel).</span>
<a href="#l15.65"></a><span id="l15.65" class="difflineminus">-    window.gWinHooks.prefs = window.gWinHooks.winhooks.settings;</span>
<a href="#l15.66"></a><span id="l15.66" class="difflineminus">-  }</span>
<a href="#l15.67"></a><span id="l15.67" class="difflineminus">-  var winHooks = window.gWinHooks;</span>
<a href="#l15.68"></a><span id="l15.68" class="difflineminus">-  winHooks.state = PFINT_NOT_DEFAULT;</span>
<a href="#l15.69"></a><span id="l15.69" class="difflineplus">+  const NS_SHELLSERVICE_CID = &quot;@mozilla.org/suite/shell-service;1&quot;;</span>
<a href="#l15.70"></a><span id="l15.70"> </span>
<a href="#l15.71"></a><span id="l15.71" class="difflineminus">-  // Start by checking http/https/ftp and html/xhtml/xml.</span>
<a href="#l15.72"></a><span id="l15.72" class="difflineminus">-  var prefs = winHooks.prefs;</span>
<a href="#l15.73"></a><span id="l15.73" class="difflineminus">-  if (prefs.isHandlingHTTP  &amp;&amp;</span>
<a href="#l15.74"></a><span id="l15.74" class="difflineminus">-      prefs.isHandlingHTTPS &amp;&amp;</span>
<a href="#l15.75"></a><span id="l15.75" class="difflineminus">-      prefs.isHandlingFTP   &amp;&amp;</span>
<a href="#l15.76"></a><span id="l15.76" class="difflineminus">-      prefs.isHandlingHTML  &amp;&amp;</span>
<a href="#l15.77"></a><span id="l15.77" class="difflineminus">-      prefs.isHandlingXHTML &amp;&amp;</span>
<a href="#l15.78"></a><span id="l15.78" class="difflineminus">-      prefs.isHandlingXML)</span>
<a href="#l15.79"></a><span id="l15.79" class="difflineminus">-  {</span>
<a href="#l15.80"></a><span id="l15.80" class="difflineminus">-    // The user *wants* us to be the default, so look if the registry matches.</span>
<a href="#l15.81"></a><span id="l15.81" class="difflineminus">-    // We test the registry settings using a scratch copy of the settings</span>
<a href="#l15.82"></a><span id="l15.82" class="difflineminus">-    // because we don't care about some of them, but we don't want to mess up</span>
<a href="#l15.83"></a><span id="l15.83" class="difflineminus">-    // the user's choices from the Advanced/System panel.</span>
<a href="#l15.84"></a><span id="l15.84" class="difflineminus">-    var testSettings = winHooks.winhooks.settings;</span>
<a href="#l15.85"></a><span id="l15.85" class="difflineminus">-    // Test that these are set.</span>
<a href="#l15.86"></a><span id="l15.86" class="difflineminus">-    testSettings.isHandlingHTTP   = true;</span>
<a href="#l15.87"></a><span id="l15.87" class="difflineminus">-    testSettings.isHandlingHTTPS  = true;</span>
<a href="#l15.88"></a><span id="l15.88" class="difflineminus">-    testSettings.isHandlingFTP    = true;</span>
<a href="#l15.89"></a><span id="l15.89" class="difflineminus">-    testSettings.isHandlingHTML   = true;</span>
<a href="#l15.90"></a><span id="l15.90" class="difflineminus">-    testSettings.isHandlingXHTML  = true;</span>
<a href="#l15.91"></a><span id="l15.91" class="difflineminus">-    testSettings.isHandlingXML    = true;</span>
<a href="#l15.92"></a><span id="l15.92" class="difflineminus">-    // Ignore the rest.</span>
<a href="#l15.93"></a><span id="l15.93" class="difflineminus">-    testSettings.isHandlingCHROME = false;</span>
<a href="#l15.94"></a><span id="l15.94" class="difflineminus">-    testSettings.isHandlingGOPHER = false;</span>
<a href="#l15.95"></a><span id="l15.95" class="difflineminus">-    testSettings.isHandlingJPEG   = false;</span>
<a href="#l15.96"></a><span id="l15.96" class="difflineminus">-    testSettings.isHandlingGIF    = false;</span>
<a href="#l15.97"></a><span id="l15.97" class="difflineminus">-    testSettings.isHandlingPNG    = false;</span>
<a href="#l15.98"></a><span id="l15.98" class="difflineminus">-    testSettings.isHandlingBMP    = false;</span>
<a href="#l15.99"></a><span id="l15.99" class="difflineminus">-    testSettings.isHandlingICO    = false;</span>
<a href="#l15.100"></a><span id="l15.100" class="difflineminus">-    testSettings.isHandlingXUL    = false;</span>
<a href="#l15.101"></a><span id="l15.101" class="difflineminus">-    // Now test whether the registry matches that.</span>
<a href="#l15.102"></a><span id="l15.102" class="difflineminus">-    if (testSettings.registryMatches)</span>
<a href="#l15.103"></a><span id="l15.103" class="difflineminus">-      winHooks.state = PFINT_DEFAULT;</span>
<a href="#l15.104"></a><span id="l15.104" class="difflineplus">+  if (NS_SHELLSERVICE_CID in Components.classes) {</span>
<a href="#l15.105"></a><span id="l15.105" class="difflineplus">+    const nsIShellService = Components.interfaces.nsIShellService;</span>
<a href="#l15.106"></a><span id="l15.106" class="difflineplus">+    var shellSvc = Components.classes[&quot;@mozilla.org/suite/shell-service;1&quot;]</span>
<a href="#l15.107"></a><span id="l15.107" class="difflineplus">+                             .getService(nsIShellService);</span>
<a href="#l15.108"></a><span id="l15.108" class="difflineplus">+    var desc = document.getElementById(&quot;defaultBrowserDesc&quot;);</span>
<a href="#l15.109"></a><span id="l15.109" class="difflineplus">+    document.getElementById(&quot;defaultBrowserGroup&quot;).hidden = false;</span>
<a href="#l15.110"></a><span id="l15.110" class="difflineplus">+</span>
<a href="#l15.111"></a><span id="l15.111" class="difflineplus">+    if (shellSvc.isDefaultClient(false, nsIShellService.BROWSER))</span>
<a href="#l15.112"></a><span id="l15.112" class="difflineplus">+      desc.textContent = desc.getAttribute(&quot;desc1&quot;);</span>
<a href="#l15.113"></a><span id="l15.113" class="difflineplus">+    else {</span>
<a href="#l15.114"></a><span id="l15.114" class="difflineplus">+      desc.textContent = desc.getAttribute(&quot;desc0&quot;);</span>
<a href="#l15.115"></a><span id="l15.115" class="difflineplus">+      document.getElementById(&quot;defaultBrowserButton&quot;).disabled = false;</span>
<a href="#l15.116"></a><span id="l15.116" class="difflineplus">+    }</span>
<a href="#l15.117"></a><span id="l15.117">   }</span>
<a href="#l15.118"></a><span id="l15.118" class="difflineminus">-  UpdateDefaultBrowserGroup();</span>
<a href="#l15.119"></a><span id="l15.119"> }</span>
<a href="#l15.120"></a><span id="l15.120"> </span>
<a href="#l15.121"></a><span id="l15.121"> function SetAsDefaultBrowser()</span>
<a href="#l15.122"></a><span id="l15.122"> {</span>
<a href="#l15.123"></a><span id="l15.123" class="difflineminus">-  // In future, we will use the Shell Service here,</span>
<a href="#l15.124"></a><span id="l15.124" class="difflineminus">-  // for now, just process WinHooks.</span>
<a href="#l15.125"></a><span id="l15.125" class="difflineminus">-</span>
<a href="#l15.126"></a><span id="l15.126" class="difflineminus">-  // Extract current settings (these are what the</span>
<a href="#l15.127"></a><span id="l15.127" class="difflineminus">-  // user has checked on the Advanced/System panel).</span>
<a href="#l15.128"></a><span id="l15.128" class="difflineminus">-  var settings = window.gWinHooks.prefs;</span>
<a href="#l15.129"></a><span id="l15.129" class="difflineminus">-</span>
<a href="#l15.130"></a><span id="l15.130" class="difflineminus">-  // Turn on all &quot;default browser&quot; settings.</span>
<a href="#l15.131"></a><span id="l15.131" class="difflineminus">-  settings.isHandlingHTTP  = true;</span>
<a href="#l15.132"></a><span id="l15.132" class="difflineminus">-  settings.isHandlingHTTPS = true;</span>
<a href="#l15.133"></a><span id="l15.133" class="difflineminus">-  settings.isHandlingFTP   = true;</span>
<a href="#l15.134"></a><span id="l15.134" class="difflineminus">-  settings.isHandlingHTML  = true;</span>
<a href="#l15.135"></a><span id="l15.135" class="difflineminus">-  settings.isHandlingXHTML = true;</span>
<a href="#l15.136"></a><span id="l15.136" class="difflineminus">-  settings.isHandlingXML   = true;</span>
<a href="#l15.137"></a><span id="l15.137" class="difflineplus">+  document.getElementById(&quot;defaultBrowserButton&quot;).disabled = true;</span>
<a href="#l15.138"></a><span id="l15.138"> </span>
<a href="#l15.139"></a><span id="l15.139">   if (document.documentElement.instantApply)</span>
<a href="#l15.140"></a><span id="l15.140">   {</span>
<a href="#l15.141"></a><span id="l15.141" class="difflineminus">-    window.gWinHooks.state = PFINT_DEFAULT;</span>
<a href="#l15.142"></a><span id="l15.142" class="difflineplus">+    var desc = document.getElementById(&quot;defaultBrowserDesc&quot;); </span>
<a href="#l15.143"></a><span id="l15.143" class="difflineplus">+    desc.textContent = desc.getAttribute(&quot;desc1&quot;);</span>
<a href="#l15.144"></a><span id="l15.144">     ApplySetAsDefaultBrowser();</span>
<a href="#l15.145"></a><span id="l15.145">   }</span>
<a href="#l15.146"></a><span id="l15.146">   else</span>
<a href="#l15.147"></a><span id="l15.147">   {</span>
<a href="#l15.148"></a><span id="l15.148">     // register OK handler for the capturing phase</span>
<a href="#l15.149"></a><span id="l15.149" class="difflineminus">-    window.gWinHooks.state = PFINT_PENDING;</span>
<a href="#l15.150"></a><span id="l15.150" class="difflineplus">+    var desc = document.getElementById(&quot;defaultBrowserDesc&quot;);</span>
<a href="#l15.151"></a><span id="l15.151" class="difflineplus">+    desc.textContent = desc.getAttribute(&quot;desc2&quot;);</span>
<a href="#l15.152"></a><span id="l15.152">     window.addEventListener(&quot;dialogaccept&quot;, this.ApplySetAsDefaultBrowser, true);</span>
<a href="#l15.153"></a><span id="l15.153">   }</span>
<a href="#l15.154"></a><span id="l15.154" class="difflineminus">-  UpdateDefaultBrowserGroup();</span>
<a href="#l15.155"></a><span id="l15.155"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1">new file mode 100644</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineminus">--- /dev/null</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineplus">+++ b/suite/locales/en-US/chrome/common/defaultClientDialog.dtd</span>
<a href="#l16.4"></a><span id="l16.4" class="difflineat">@@ -0,0 +1,9 @@</span>
<a href="#l16.5"></a><span id="l16.5" class="difflineplus">+&lt;!ENTITY defaultClient.title  &quot;Default Client&quot;&gt;</span>
<a href="#l16.6"></a><span id="l16.6" class="difflineplus">+&lt;!ENTITY defaultClient.intro  &quot;Use &amp;brandShortName; as the default client for:&quot;&gt;</span>
<a href="#l16.7"></a><span id="l16.7" class="difflineplus">+</span>
<a href="#l16.8"></a><span id="l16.8" class="difflineplus">+&lt;!ENTITY browser.label &quot;Browser&quot;&gt;</span>
<a href="#l16.9"></a><span id="l16.9" class="difflineplus">+&lt;!ENTITY email.label &quot;E-Mail&quot;&gt;</span>
<a href="#l16.10"></a><span id="l16.10" class="difflineplus">+&lt;!ENTITY newsgroups.label &quot;Newsgroups&quot;&gt;</span>
<a href="#l16.11"></a><span id="l16.11" class="difflineplus">+</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineplus">+&lt;!ENTITY checkOnStartup.label &quot;Always perform this check when starting &amp;brandShortName;&quot;&gt;</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+&lt;!ENTITY checkOnStartup.accesskey &quot;A&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/suite/locales/en-US/chrome/common/pref/pref-advanced.dtd</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/suite/locales/en-US/chrome/common/pref/pref-advanced.dtd</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -5,8 +5,12 @@</span>
<a href="#l17.4"></a><span id="l17.4"> </span>
<a href="#l17.5"></a><span id="l17.5"> &lt;!ENTITY enbJavaCheck.label         &quot;Enable Java&quot;&gt;</span>
<a href="#l17.6"></a><span id="l17.6"> &lt;!ENTITY enbJavaCheck.accesskey     &quot;J&quot;&gt;</span>
<a href="#l17.7"></a><span id="l17.7"> </span>
<a href="#l17.8"></a><span id="l17.8"> &lt;!ENTITY systemPref.caption         &quot;System Preferences&quot;&gt;</span>
<a href="#l17.9"></a><span id="l17.9"> &lt;!ENTITY systemPrefCheck.label      &quot;Use Preferences from System&quot;&gt;</span>
<a href="#l17.10"></a><span id="l17.10"> &lt;!ENTITY systemPrefCheck.accesskey  &quot;U&quot;&gt;</span>
<a href="#l17.11"></a><span id="l17.11"> &lt;!ENTITY systemPref.desc            &quot;With this option, &amp;brandShortName; inherits preferences from the system. These system settings will override the &amp;brandShortName; preferences.&quot;&gt;</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineplus">+</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+&lt;!ENTITY prefCheckDefault.caption   &quot;System Integration&quot;&gt;</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineplus">+&lt;!ENTITY prefCheckDefaultClient.label &quot;Check default application settings on startup&quot;&gt;</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineplus">+&lt;!ENTITY prefCheckDefaultClient.accesskey &quot;C&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/suite/locales/jar.mn</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/suite/locales/jar.mn</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -17,16 +17,17 @@</span>
<a href="#l18.4"></a><span id="l18.4"> % locale navigator-platform @AB_CD@ %locale/@AB_CD@/navigator-platform/</span>
<a href="#l18.5"></a><span id="l18.5"> % locale navigator-region @AB_CD@ %locale/@AB_CD@/navigator-region/</span>
<a href="#l18.6"></a><span id="l18.6">   locale/@AB_CD@/branding/brand.dtd                                         (%chrome/branding/brand.dtd)</span>
<a href="#l18.7"></a><span id="l18.7">   locale/@AB_CD@/branding/brand.properties                                  (%chrome/branding/brand.properties)</span>
<a href="#l18.8"></a><span id="l18.8">   locale/@AB_CD@/communicator/askViewZoom.dtd                               (%chrome/common/askViewZoom.dtd)</span>
<a href="#l18.9"></a><span id="l18.9">   locale/@AB_CD@/communicator/consoleOverlay.dtd                            (%chrome/common/consoleOverlay.dtd)</span>
<a href="#l18.10"></a><span id="l18.10">   locale/@AB_CD@/communicator/contentAreaCommands.dtd                       (%chrome/common/contentAreaCommands.dtd)</span>
<a href="#l18.11"></a><span id="l18.11">   locale/@AB_CD@/communicator/contentAreaCommands.properties                (%chrome/common/contentAreaCommands.properties)</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineplus">+  locale/@AB_CD@/communicator/defaultClientDialog.dtd                       (%chrome/common/defaultClientDialog.dtd)</span>
<a href="#l18.13"></a><span id="l18.13">   locale/@AB_CD@/communicator/notification.properties                       (%chrome/common/notification.properties)</span>
<a href="#l18.14"></a><span id="l18.14">   locale/@AB_CD@/communicator/openLocation.dtd                              (%chrome/common/openLocation.dtd)</span>
<a href="#l18.15"></a><span id="l18.15">   locale/@AB_CD@/communicator/openLocation.properties                       (%chrome/common/openLocation.properties)</span>
<a href="#l18.16"></a><span id="l18.16">   locale/@AB_CD@/communicator/printPreview.dtd                              (%chrome/common/printPreview.dtd)</span>
<a href="#l18.17"></a><span id="l18.17">   locale/@AB_CD@/communicator/shellservice.properties                       (%chrome/common/shellservice.properties)</span>
<a href="#l18.18"></a><span id="l18.18">   locale/@AB_CD@/communicator/sanitize.dtd                                  (%chrome/common/sanitize.dtd)</span>
<a href="#l18.19"></a><span id="l18.19">   locale/@AB_CD@/communicator/tasksOverlay.dtd                              (%chrome/common/tasksOverlay.dtd)</span>
<a href="#l18.20"></a><span id="l18.20">   locale/@AB_CD@/communicator/typeaheadfind.properties                      (%chrome/common/typeaheadfind.properties)</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

