<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 21295:e827c30cc14f95dee4d3dfa6e3de20895db84a17</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ e827c30cc14f95dee4d3dfa6e3de20895db84a17" />
<meta property="og:url" content="/comm-central/rev/e827c30cc14f95dee4d3dfa6e3de20895db84a17" />
<meta property="og:description" content="Bug 1345141 - Part 1: Deduplicate and simplify code for new Feed object creation. r=mkmelin" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / e827c30cc14f95dee4d3dfa6e3de20895db84a17 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/e827c30cc14f95dee4d3dfa6e3de20895db84a17">shortlog</a> |
<a href="/comm-central/log/e827c30cc14f95dee4d3dfa6e3de20895db84a17">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/e827c30cc14f95dee4d3dfa6e3de20895db84a17">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/e827c30cc14f95dee4d3dfa6e3de20895db84a17">files</a> |
changeset |
<a href="/comm-central/raw-rev/e827c30cc14f95dee4d3dfa6e3de20895db84a17">raw</a>  | <a href="/comm-central/archive/e827c30cc14f95dee4d3dfa6e3de20895db84a17.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1345141">Bug 1345141</a> - Part 1: Deduplicate and simplify code for new Feed object creation. r=mkmelin
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#97;&#108;&#116;&#97;&#56;&#56;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;</td></tr>
<tr><td></td><td class="date age">Sun, 19 Feb 2017 10:03:48 -0700</td></tr>

<tr>
 <td>changeset 21295</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/e827c30cc14f95dee4d3dfa6e3de20895db84a17">e827c30cc14f95dee4d3dfa6e3de20895db84a17</a></td>
</tr>



<tr>
<td>parent 21294</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/64ba9ba1f50cb7aa00ef246d32aefdcd8a0f3890">64ba9ba1f50cb7aa00ef246d32aefdcd8a0f3890</a>
</td>
</tr>

<tr>
<td>child 21296</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/ffe69a84523a26b710e7b10053d9ccc45779e795">ffe69a84523a26b710e7b10053d9ccc45779e795</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=e827c30cc14f95dee4d3dfa6e3de20895db84a17">12944</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Tue, 14 Mar 2017 08:19:04 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@96ec0a833d31 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=96ec0a833d31c042f3410e127c59e8490c2acefd">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=96ec0a833d31c042f3410e127c59e8490c2acefd&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=96ec0a833d31c042f3410e127c59e8490c2acefd&newProject=comm-central&newRevision=e827c30cc14f95dee4d3dfa6e3de20895db84a17&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=96ec0a833d31c042f3410e127c59e8490c2acefd&newProject=comm-central&newRevision=e827c30cc14f95dee4d3dfa6e3de20895db84a17&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=96ec0a833d31c042f3410e127c59e8490c2acefd&newProject=comm-central&newRevision=e827c30cc14f95dee4d3dfa6e3de20895db84a17&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mkmelin%29&revcount=50">mkmelin</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1345141">1345141</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1345141">Bug 1345141</a> - Part 1: Deduplicate and simplify code for new Feed object creation. r=mkmelin</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e827c30cc14f95dee4d3dfa6e3de20895db84a17/mailnews/extensions/newsblog/content/Feed.js">mailnews/extensions/newsblog/content/Feed.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e827c30cc14f95dee4d3dfa6e3de20895db84a17/mailnews/extensions/newsblog/content/Feed.js">file</a> |
<a href="/comm-central/annotate/e827c30cc14f95dee4d3dfa6e3de20895db84a17/mailnews/extensions/newsblog/content/Feed.js">annotate</a> |
<a href="/comm-central/diff/e827c30cc14f95dee4d3dfa6e3de20895db84a17/mailnews/extensions/newsblog/content/Feed.js">diff</a> |
<a href="/comm-central/comparison/e827c30cc14f95dee4d3dfa6e3de20895db84a17/mailnews/extensions/newsblog/content/Feed.js">comparison</a> |
<a href="/comm-central/log/e827c30cc14f95dee4d3dfa6e3de20895db84a17/mailnews/extensions/newsblog/content/Feed.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e827c30cc14f95dee4d3dfa6e3de20895db84a17/mailnews/extensions/newsblog/content/FeedUtils.jsm">mailnews/extensions/newsblog/content/FeedUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e827c30cc14f95dee4d3dfa6e3de20895db84a17/mailnews/extensions/newsblog/content/FeedUtils.jsm">file</a> |
<a href="/comm-central/annotate/e827c30cc14f95dee4d3dfa6e3de20895db84a17/mailnews/extensions/newsblog/content/FeedUtils.jsm">annotate</a> |
<a href="/comm-central/diff/e827c30cc14f95dee4d3dfa6e3de20895db84a17/mailnews/extensions/newsblog/content/FeedUtils.jsm">diff</a> |
<a href="/comm-central/comparison/e827c30cc14f95dee4d3dfa6e3de20895db84a17/mailnews/extensions/newsblog/content/FeedUtils.jsm">comparison</a> |
<a href="/comm-central/log/e827c30cc14f95dee4d3dfa6e3de20895db84a17/mailnews/extensions/newsblog/content/FeedUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e827c30cc14f95dee4d3dfa6e3de20895db84a17/mailnews/extensions/newsblog/content/feed-subscriptions.js">mailnews/extensions/newsblog/content/feed-subscriptions.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e827c30cc14f95dee4d3dfa6e3de20895db84a17/mailnews/extensions/newsblog/content/feed-subscriptions.js">file</a> |
<a href="/comm-central/annotate/e827c30cc14f95dee4d3dfa6e3de20895db84a17/mailnews/extensions/newsblog/content/feed-subscriptions.js">annotate</a> |
<a href="/comm-central/diff/e827c30cc14f95dee4d3dfa6e3de20895db84a17/mailnews/extensions/newsblog/content/feed-subscriptions.js">diff</a> |
<a href="/comm-central/comparison/e827c30cc14f95dee4d3dfa6e3de20895db84a17/mailnews/extensions/newsblog/content/feed-subscriptions.js">comparison</a> |
<a href="/comm-central/log/e827c30cc14f95dee4d3dfa6e3de20895db84a17/mailnews/extensions/newsblog/content/feed-subscriptions.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/extensions/newsblog/content/Feed.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/extensions/newsblog/content/Feed.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -41,20 +41,32 @@ var FeedCache =</span>
<a href="#l1.4"></a><span id="l1.4">     }</span>
<a href="#l1.5"></a><span id="l1.5">     catch (ex)</span>
<a href="#l1.6"></a><span id="l1.6">     {</span>
<a href="#l1.7"></a><span id="l1.7">       return aUrl;</span>
<a href="#l1.8"></a><span id="l1.8">     }</span>
<a href="#l1.9"></a><span id="l1.9">   }</span>
<a href="#l1.10"></a><span id="l1.10"> };</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-function Feed(aResource, aRSSServer)</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+/**</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+ * A Feed object. If aFolder is the account root folder, a new subfolder</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+ * for the feed url is created otherwise the url will be subscribed to the</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+ * existing aFolder, upon successful download() completion.</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+ *</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+ * @param  string aFeedUrl        - feed url.</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+ * @param  nsIMsgFolder aFolder   - folder containing or to contain the feed</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineplus">+ *                                  subscription.</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineplus">+ */</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineplus">+function Feed(aFeedUrl, aFolder)</span>
<a href="#l1.23"></a><span id="l1.23"> {</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineminus">-  this.resource = aResource.QueryInterface(Ci.nsIRDFResource);</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineminus">-  this.server = aRSSServer;</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineplus">+  this.resource = FeedUtils.rdf.GetResource(aFeedUrl)</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineplus">+                               .QueryInterface(Ci.nsIRDFResource);</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineplus">+  this.server = aFolder.server;</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineplus">+  if (!aFolder.isServer)</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineplus">+    this.mFolder = aFolder;</span>
<a href="#l1.31"></a><span id="l1.31"> }</span>
<a href="#l1.32"></a><span id="l1.32"> </span>
<a href="#l1.33"></a><span id="l1.33"> Feed.prototype =</span>
<a href="#l1.34"></a><span id="l1.34"> {</span>
<a href="#l1.35"></a><span id="l1.35">   description: null,</span>
<a href="#l1.36"></a><span id="l1.36">   author: null,</span>
<a href="#l1.37"></a><span id="l1.37">   request: null,</span>
<a href="#l1.38"></a><span id="l1.38">   server: null,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/extensions/newsblog/content/FeedUtils.jsm</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/extensions/newsblog/content/FeedUtils.jsm</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -336,19 +336,17 @@ var FeedUtils = {</span>
<a href="#l2.4"></a><span id="l2.4">                                   aIsBiff + &quot; : &quot; + status.enabled + &quot; : &quot; +</span>
<a href="#l2.5"></a><span id="l2.5">                                   (Math.round((now - status.lastUpdateTime) / 60) / 1000) +&quot; :: &quot;+</span>
<a href="#l2.6"></a><span id="l2.6">                                   url);</span>
<a href="#l2.7"></a><span id="l2.7">               continue;</span>
<a href="#l2.8"></a><span id="l2.8">             }</span>
<a href="#l2.9"></a><span id="l2.9">           }</span>
<a href="#l2.10"></a><span id="l2.10"> </span>
<a href="#l2.11"></a><span id="l2.11">           // Create a feed object.</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-          let feedResource = FeedUtils.rdf.GetResource(url);</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-          let feed = new Feed(feedResource, folder.server);</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-          feed.folder = folder;</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+          let feed = new Feed(url, folder);</span>
<a href="#l2.16"></a><span id="l2.16"> </span>
<a href="#l2.17"></a><span id="l2.17">           // Bump our pending feed download count. From now on, all feeds will</span>
<a href="#l2.18"></a><span id="l2.18">           // be resolved and finish with progressNotifier.downloaded(). Any</span>
<a href="#l2.19"></a><span id="l2.19">           // early returns must call downloaded() so mNumPendingFeedDownloads</span>
<a href="#l2.20"></a><span id="l2.20">           // is decremented and notification/status feedback is reset.</span>
<a href="#l2.21"></a><span id="l2.21">           FeedUtils.progressNotifier.mNumPendingFeedDownloads++;</span>
<a href="#l2.22"></a><span id="l2.22"> </span>
<a href="#l2.23"></a><span id="l2.23">           // If the current active count exceeds the max desired, exit from</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineat">@@ -467,27 +465,21 @@ var FeedUtils = {</span>
<a href="#l2.25"></a><span id="l2.25">     // to subscribe to it.</span>
<a href="#l2.26"></a><span id="l2.26">     if (FeedUtils.feedAlreadyExists(aUrl, aFolder.server))</span>
<a href="#l2.27"></a><span id="l2.27">     {</span>
<a href="#l2.28"></a><span id="l2.28">       aMsgWindow.statusFeedback.showStatusString(</span>
<a href="#l2.29"></a><span id="l2.29">         FeedUtils.strings.GetStringFromName(&quot;subscribe-feedAlreadySubscribed&quot;));</span>
<a href="#l2.30"></a><span id="l2.30">       return;</span>
<a href="#l2.31"></a><span id="l2.31">     }</span>
<a href="#l2.32"></a><span id="l2.32"> </span>
<a href="#l2.33"></a><span id="l2.33" class="difflineminus">-    let itemResource = FeedUtils.rdf.GetResource(aUrl);</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineminus">-    let feed = new Feed(itemResource, aFolder.server);</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+    let feed = new Feed(aUrl, aFolder);</span>
<a href="#l2.36"></a><span id="l2.36">     // Default setting for new feeds per account settings.</span>
<a href="#l2.37"></a><span id="l2.37">     feed.quickMode = feed.server.getBoolValue(&quot;quickMode&quot;);</span>
<a href="#l2.38"></a><span id="l2.38">     feed.options = FeedUtils.getOptionsAcct(feed.server);</span>
<a href="#l2.39"></a><span id="l2.39"> </span>
<a href="#l2.40"></a><span id="l2.40" class="difflineminus">-    // If the root server, create a new folder for the feed.  The user must</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineminus">-    // want us to add this subscription url to an existing RSS folder.</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineminus">-    if (!aFolder.isServer)</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineminus">-      feed.folder = aFolder;</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineminus">-</span>
<a href="#l2.45"></a><span id="l2.45">     FeedUtils.progressNotifier.init(aMsgWindow, true);</span>
<a href="#l2.46"></a><span id="l2.46">     FeedUtils.progressNotifier.mNumPendingFeedDownloads++;</span>
<a href="#l2.47"></a><span id="l2.47">     feed.download(true, FeedUtils.progressNotifier);</span>
<a href="#l2.48"></a><span id="l2.48">   },</span>
<a href="#l2.49"></a><span id="l2.49"> </span>
<a href="#l2.50"></a><span id="l2.50"> /**</span>
<a href="#l2.51"></a><span id="l2.51">  * Enable or disable updates for all subscriptions in a folder, or all</span>
<a href="#l2.52"></a><span id="l2.52">  * subscriptions in an account if the folder is the account folder.</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineat">@@ -517,18 +509,17 @@ var FeedUtils = {</span>
<a href="#l2.54"></a><span id="l2.54">     }</span>
<a href="#l2.55"></a><span id="l2.55"> </span>
<a href="#l2.56"></a><span id="l2.56">     let feedUrls = FeedUtils.getFeedUrlsInFolder(aFolder);</span>
<a href="#l2.57"></a><span id="l2.57">     if (!feedUrls)</span>
<a href="#l2.58"></a><span id="l2.58">       return;</span>
<a href="#l2.59"></a><span id="l2.59"> </span>
<a href="#l2.60"></a><span id="l2.60">     for (let feedUrl of feedUrls)</span>
<a href="#l2.61"></a><span id="l2.61">     {</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineminus">-      let resource = FeedUtils.rdf.GetResource(feedUrl);</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineminus">-      let feed = new Feed(resource, aFolder.server);</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineplus">+      let feed = new Feed(feedUrl, aFolder);</span>
<a href="#l2.65"></a><span id="l2.65">       let options = feed.options;</span>
<a href="#l2.66"></a><span id="l2.66">       options.updates.enabled = !aPause;</span>
<a href="#l2.67"></a><span id="l2.67">       feed.options = options;</span>
<a href="#l2.68"></a><span id="l2.68">       FeedUtils.setStatus(aFolder, feedUrl, &quot;enabled&quot;, !aPause);</span>
<a href="#l2.69"></a><span id="l2.69">       FeedUtils.log.debug(&quot;pauseFeedFolderUpdates: enabled:url &quot; +</span>
<a href="#l2.70"></a><span id="l2.70">                           !aPause + &quot;: &quot; + feedUrl);</span>
<a href="#l2.71"></a><span id="l2.71">     }</span>
<a href="#l2.72"></a><span id="l2.72"> </span>
<a href="#l2.73"></a><span id="l2.73" class="difflineat">@@ -537,126 +528,116 @@ var FeedUtils = {</span>
<a href="#l2.74"></a><span id="l2.74">     {</span>
<a href="#l2.75"></a><span id="l2.75">       let curItem = win.FeedSubscriptions.mView.currentItem;</span>
<a href="#l2.76"></a><span id="l2.76">       win.FeedSubscriptions.refreshSubscriptionView();</span>
<a href="#l2.77"></a><span id="l2.77">       if (curItem.container) {</span>
<a href="#l2.78"></a><span id="l2.78">         win.FeedSubscriptions.selectFolder(curItem.folder);</span>
<a href="#l2.79"></a><span id="l2.79">       }</span>
<a href="#l2.80"></a><span id="l2.80">       else</span>
<a href="#l2.81"></a><span id="l2.81">       {</span>
<a href="#l2.82"></a><span id="l2.82" class="difflineminus">-        let resource = FeedUtils.rdf.GetResource(curItem.url);</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineminus">-        let feed = new Feed(resource, curItem.parentFolder.server);</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineminus">-        feed.folder = curItem.parentFolder;</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineplus">+        let feed = new Feed(curItem.url, curItem.parentFolder);</span>
<a href="#l2.86"></a><span id="l2.86">         win.FeedSubscriptions.selectFeed(feed);</span>
<a href="#l2.87"></a><span id="l2.87">       }</span>
<a href="#l2.88"></a><span id="l2.88">     }</span>
<a href="#l2.89"></a><span id="l2.89"> </span>
<a href="#l2.90"></a><span id="l2.90">     this.getSubscriptionsDS(aFolder.server).Flush();</span>
<a href="#l2.91"></a><span id="l2.91">   },</span>
<a href="#l2.92"></a><span id="l2.92"> </span>
<a href="#l2.93"></a><span id="l2.93"> /**</span>
<a href="#l2.94"></a><span id="l2.94">  * Add a feed record to the feeds.rdf database and update the folder's feedUrl</span>
<a href="#l2.95"></a><span id="l2.95">  * property.</span>
<a href="#l2.96"></a><span id="l2.96">  *</span>
<a href="#l2.97"></a><span id="l2.97" class="difflineminus">- * @param  object aFeed - our feed object</span>
<a href="#l2.98"></a><span id="l2.98" class="difflineplus">+ * @param  Feed aFeed - our feed object.</span>
<a href="#l2.99"></a><span id="l2.99">  */</span>
<a href="#l2.100"></a><span id="l2.100">   addFeed: function(aFeed) {</span>
<a href="#l2.101"></a><span id="l2.101" class="difflineminus">-    let ds = this.getSubscriptionsDS(aFeed.folder.server);</span>
<a href="#l2.102"></a><span id="l2.102" class="difflineplus">+    let ds = this.getSubscriptionsDS(aFeed.server);</span>
<a href="#l2.103"></a><span id="l2.103">     let feeds = this.getSubscriptionsList(ds);</span>
<a href="#l2.104"></a><span id="l2.104"> </span>
<a href="#l2.105"></a><span id="l2.105">     // Generate a unique ID for the feed.</span>
<a href="#l2.106"></a><span id="l2.106">     let id = aFeed.url;</span>
<a href="#l2.107"></a><span id="l2.107">     let i = 1;</span>
<a href="#l2.108"></a><span id="l2.108">     while (feeds.IndexOf(this.rdf.GetResource(id)) != -1 &amp;&amp; ++i &lt; 1000)</span>
<a href="#l2.109"></a><span id="l2.109">       id = aFeed.url + i;</span>
<a href="#l2.110"></a><span id="l2.110">     if (i == 1000)</span>
<a href="#l2.111"></a><span id="l2.111">       throw new Error(&quot;FeedUtils.addFeed: couldn't generate a unique ID &quot; +</span>
<a href="#l2.112"></a><span id="l2.112">                       &quot;for feed &quot; + aFeed.url);</span>
<a href="#l2.113"></a><span id="l2.113"> </span>
<a href="#l2.114"></a><span id="l2.114">     // Add the feed to the list.</span>
<a href="#l2.115"></a><span id="l2.115" class="difflineminus">-    id = this.rdf.GetResource(id);</span>
<a href="#l2.116"></a><span id="l2.116" class="difflineminus">-    feeds.AppendElement(id);</span>
<a href="#l2.117"></a><span id="l2.117" class="difflineminus">-    ds.Assert(id, this.RDF_TYPE, this.FZ_FEED, true);</span>
<a href="#l2.118"></a><span id="l2.118" class="difflineminus">-    ds.Assert(id, this.DC_IDENTIFIER, this.rdf.GetLiteral(aFeed.url), true);</span>
<a href="#l2.119"></a><span id="l2.119" class="difflineplus">+    let feedResource = this.rdf.GetResource(id);</span>
<a href="#l2.120"></a><span id="l2.120" class="difflineplus">+    feeds.AppendElement(feedResource);</span>
<a href="#l2.121"></a><span id="l2.121" class="difflineplus">+    ds.Assert(feedResource, this.RDF_TYPE, this.FZ_FEED, true);</span>
<a href="#l2.122"></a><span id="l2.122" class="difflineplus">+    ds.Assert(feedResource, this.DC_IDENTIFIER, this.rdf.GetLiteral(aFeed.url), true);</span>
<a href="#l2.123"></a><span id="l2.123">     if (aFeed.title)</span>
<a href="#l2.124"></a><span id="l2.124" class="difflineminus">-      ds.Assert(id, this.DC_TITLE, this.rdf.GetLiteral(aFeed.title), true);</span>
<a href="#l2.125"></a><span id="l2.125" class="difflineminus">-    ds.Assert(id, this.FZ_DESTFOLDER, aFeed.folder, true);</span>
<a href="#l2.126"></a><span id="l2.126" class="difflineplus">+      ds.Assert(feedResource, this.DC_TITLE, this.rdf.GetLiteral(aFeed.title), true);</span>
<a href="#l2.127"></a><span id="l2.127" class="difflineplus">+    ds.Assert(feedResource, this.FZ_DESTFOLDER, aFeed.folder, true);</span>
<a href="#l2.128"></a><span id="l2.128">     ds.Flush();</span>
<a href="#l2.129"></a><span id="l2.129"> </span>
<a href="#l2.130"></a><span id="l2.130">     // Update folderpane.</span>
<a href="#l2.131"></a><span id="l2.131">     this.setFolderPaneProperty(aFeed.folder, &quot;favicon&quot;, null, &quot;row&quot;);</span>
<a href="#l2.132"></a><span id="l2.132">   },</span>
<a href="#l2.133"></a><span id="l2.133"> </span>
<a href="#l2.134"></a><span id="l2.134"> /**</span>
<a href="#l2.135"></a><span id="l2.135">  * Delete a feed record from the feeds.rdf database and update the folder's</span>
<a href="#l2.136"></a><span id="l2.136">  * feedUrl property.</span>
<a href="#l2.137"></a><span id="l2.137">  *</span>
<a href="#l2.138"></a><span id="l2.138" class="difflineminus">- * @param  nsIRDFResource aId           - feed url as rdf resource.</span>
<a href="#l2.139"></a><span id="l2.139" class="difflineminus">- * @param  nsIMsgIncomingServer aServer - folder's account server.</span>
<a href="#l2.140"></a><span id="l2.140" class="difflineminus">- * @param  nsIMsgFolder aParentFolder   - owning folder.</span>
<a href="#l2.141"></a><span id="l2.141" class="difflineplus">+ * @param  Feed aFeed - our feed object.</span>
<a href="#l2.142"></a><span id="l2.142">  */</span>
<a href="#l2.143"></a><span id="l2.143" class="difflineminus">-  deleteFeed: function(aId, aServer, aParentFolder) {</span>
<a href="#l2.144"></a><span id="l2.144" class="difflineminus">-    let feed = new Feed(aId, aServer);</span>
<a href="#l2.145"></a><span id="l2.145" class="difflineminus">-    let ds = this.getSubscriptionsDS(aServer);</span>
<a href="#l2.146"></a><span id="l2.146" class="difflineminus">-</span>
<a href="#l2.147"></a><span id="l2.147" class="difflineminus">-    if (!feed || !ds)</span>
<a href="#l2.148"></a><span id="l2.148" class="difflineminus">-     return;</span>
<a href="#l2.149"></a><span id="l2.149" class="difflineplus">+  deleteFeed: function(aFeed) {</span>
<a href="#l2.150"></a><span id="l2.150" class="difflineplus">+    let ds = this.getSubscriptionsDS(aFeed.server);</span>
<a href="#l2.151"></a><span id="l2.151"> </span>
<a href="#l2.152"></a><span id="l2.152">     // Remove the feed from the subscriptions ds.</span>
<a href="#l2.153"></a><span id="l2.153">     let feeds = this.getSubscriptionsList(ds);</span>
<a href="#l2.154"></a><span id="l2.154" class="difflineminus">-    let index = feeds.IndexOf(aId);</span>
<a href="#l2.155"></a><span id="l2.155" class="difflineplus">+    let index = feeds.IndexOf(aFeed.resource);</span>
<a href="#l2.156"></a><span id="l2.156">     if (index != -1)</span>
<a href="#l2.157"></a><span id="l2.157">       feeds.RemoveElementAt(index, false);</span>
<a href="#l2.158"></a><span id="l2.158"> </span>
<a href="#l2.159"></a><span id="l2.159">     // Remove all assertions about the feed from the subscriptions database.</span>
<a href="#l2.160"></a><span id="l2.160" class="difflineminus">-    this.removeAssertions(ds, aId);</span>
<a href="#l2.161"></a><span id="l2.161" class="difflineplus">+    this.removeAssertions(ds, aFeed.resource);</span>
<a href="#l2.162"></a><span id="l2.162">     ds.Flush();</span>
<a href="#l2.163"></a><span id="l2.163"> </span>
<a href="#l2.164"></a><span id="l2.164">     // Remove all assertions about items in the feed from the items database.</span>
<a href="#l2.165"></a><span id="l2.165" class="difflineminus">-    let itemds = this.getItemsDS(aServer);</span>
<a href="#l2.166"></a><span id="l2.166" class="difflineminus">-    feed.invalidateItems();</span>
<a href="#l2.167"></a><span id="l2.167" class="difflineminus">-    feed.removeInvalidItems(true);</span>
<a href="#l2.168"></a><span id="l2.168" class="difflineplus">+    let itemds = this.getItemsDS(aFeed.server);</span>
<a href="#l2.169"></a><span id="l2.169" class="difflineplus">+    aFeed.invalidateItems();</span>
<a href="#l2.170"></a><span id="l2.170" class="difflineplus">+    aFeed.removeInvalidItems(true);</span>
<a href="#l2.171"></a><span id="l2.171">     itemds.Flush();</span>
<a href="#l2.172"></a><span id="l2.172"> </span>
<a href="#l2.173"></a><span id="l2.173">     // Update folderpane.</span>
<a href="#l2.174"></a><span id="l2.174" class="difflineminus">-    this.setFolderPaneProperty(aParentFolder, &quot;favicon&quot;, null, &quot;row&quot;);</span>
<a href="#l2.175"></a><span id="l2.175" class="difflineplus">+    this.setFolderPaneProperty(aFeed.folder, &quot;favicon&quot;, null, &quot;row&quot;);</span>
<a href="#l2.176"></a><span id="l2.176">     // Remove from cache.</span>
<a href="#l2.177"></a><span id="l2.177" class="difflineminus">-    delete this[aParentFolder.server.serverURI][feed.url];</span>
<a href="#l2.178"></a><span id="l2.178" class="difflineplus">+    delete this[aFeed.server.serverURI][aFeed.url];</span>
<a href="#l2.179"></a><span id="l2.179"> </span>
<a href="#l2.180"></a><span id="l2.180">     feed = null;</span>
<a href="#l2.181"></a><span id="l2.181">   },</span>
<a href="#l2.182"></a><span id="l2.182"> </span>
<a href="#l2.183"></a><span id="l2.183"> /**</span>
<a href="#l2.184"></a><span id="l2.184">  * Change an existing feed's url, as identified by FZ_FEED resource in the</span>
<a href="#l2.185"></a><span id="l2.185">  * feeds.rdf subscriptions database.</span>
<a href="#l2.186"></a><span id="l2.186">  *</span>
<a href="#l2.187"></a><span id="l2.187">  * @param  obj aFeed      - the feed object</span>
<a href="#l2.188"></a><span id="l2.188">  * @param  string aNewUrl - new url</span>
<a href="#l2.189"></a><span id="l2.189">  * @return bool           - true if successful, else false</span>
<a href="#l2.190"></a><span id="l2.190">  */</span>
<a href="#l2.191"></a><span id="l2.191">   changeUrlForFeed: function(aFeed, aNewUrl) {</span>
<a href="#l2.192"></a><span id="l2.192">     if (!aFeed || !aFeed.folder || !aNewUrl)</span>
<a href="#l2.193"></a><span id="l2.193">       return false;</span>
<a href="#l2.194"></a><span id="l2.194"> </span>
<a href="#l2.195"></a><span id="l2.195" class="difflineminus">-    if (this.feedAlreadyExists(aNewUrl, aFeed.folder.server))</span>
<a href="#l2.196"></a><span id="l2.196" class="difflineplus">+    if (this.feedAlreadyExists(aNewUrl, aFeed.server))</span>
<a href="#l2.197"></a><span id="l2.197">     {</span>
<a href="#l2.198"></a><span id="l2.198">       this.log.info(&quot;FeedUtils.changeUrlForFeed: new feed url &quot; + aNewUrl +</span>
<a href="#l2.199"></a><span id="l2.199" class="difflineminus">-                    &quot; already subscribed in account &quot; + aFeed.folder.server.prettyName);</span>
<a href="#l2.200"></a><span id="l2.200" class="difflineplus">+                    &quot; already subscribed in account &quot; + aFeed.server.prettyName);</span>
<a href="#l2.201"></a><span id="l2.201">       return false;</span>
<a href="#l2.202"></a><span id="l2.202">     }</span>
<a href="#l2.203"></a><span id="l2.203"> </span>
<a href="#l2.204"></a><span id="l2.204">     let title = aFeed.title;</span>
<a href="#l2.205"></a><span id="l2.205">     let link = aFeed.link;</span>
<a href="#l2.206"></a><span id="l2.206">     let quickMode = aFeed.quickMode;</span>
<a href="#l2.207"></a><span id="l2.207">     let options = aFeed.options;</span>
<a href="#l2.208"></a><span id="l2.208"> </span>
<a href="#l2.209"></a><span id="l2.209" class="difflineminus">-    this.deleteFeed(this.rdf.GetResource(aFeed.url),</span>
<a href="#l2.210"></a><span id="l2.210" class="difflineminus">-                    aFeed.folder.server, aFeed.folder);</span>
<a href="#l2.211"></a><span id="l2.211" class="difflineminus">-    aFeed.resource = this.rdf.GetResource(aNewUrl)</span>
<a href="#l2.212"></a><span id="l2.212" class="difflineminus">-                             .QueryInterface(Ci.nsIRDFResource);</span>
<a href="#l2.213"></a><span id="l2.213" class="difflineplus">+    this.deleteFeed(aFeed);</span>
<a href="#l2.214"></a><span id="l2.214" class="difflineplus">+    aFeed.resource = this.rdf.GetResource(aNewUrl).QueryInterface(Ci.nsIRDFResource);</span>
<a href="#l2.215"></a><span id="l2.215">     aFeed.title = title;</span>
<a href="#l2.216"></a><span id="l2.216">     aFeed.link = link;</span>
<a href="#l2.217"></a><span id="l2.217">     aFeed.quickMode = quickMode;</span>
<a href="#l2.218"></a><span id="l2.218">     aFeed.options = options;</span>
<a href="#l2.219"></a><span id="l2.219">     this.addFeed(aFeed);</span>
<a href="#l2.220"></a><span id="l2.220"> </span>
<a href="#l2.221"></a><span id="l2.221">     let win = Services.wm.getMostRecentWindow(&quot;Mail:News-BlogSubscriptions&quot;);</span>
<a href="#l2.222"></a><span id="l2.222">     if (win)</span>
<a href="#l2.223"></a><span id="l2.223" class="difflineat">@@ -825,18 +806,17 @@ var FeedUtils = {</span>
<a href="#l2.224"></a><span id="l2.224">       this[serverKey] = {};</span>
<a href="#l2.225"></a><span id="l2.225"> </span>
<a href="#l2.226"></a><span id="l2.226">     if (!this[serverKey][aUrl]) {</span>
<a href="#l2.227"></a><span id="l2.227">       // Seed the status object.</span>
<a href="#l2.228"></a><span id="l2.228">       this[serverKey][aUrl] = {};</span>
<a href="#l2.229"></a><span id="l2.229">       this[serverKey][aUrl][&quot;status&quot;] = this.statusTemplate;</span>
<a href="#l2.230"></a><span id="l2.230">       if (FeedUtils.isValidScheme(aUrl)) {</span>
<a href="#l2.231"></a><span id="l2.231">         // Seed persisted status properties for feed urls.</span>
<a href="#l2.232"></a><span id="l2.232" class="difflineminus">-        let feedResource = FeedUtils.rdf.GetResource(aUrl);</span>
<a href="#l2.233"></a><span id="l2.233" class="difflineminus">-        let feed = new Feed(feedResource, aFolder.server);</span>
<a href="#l2.234"></a><span id="l2.234" class="difflineplus">+        let feed = new Feed(aUrl, aFolder);</span>
<a href="#l2.235"></a><span id="l2.235">         this[serverKey][aUrl][&quot;status&quot;].enabled =</span>
<a href="#l2.236"></a><span id="l2.236">           feed.options.updates.enabled;</span>
<a href="#l2.237"></a><span id="l2.237">         this[serverKey][aUrl][&quot;status&quot;].updateMinutes =</span>
<a href="#l2.238"></a><span id="l2.238">           feed.options.updates.updateMinutes;</span>
<a href="#l2.239"></a><span id="l2.239">         this[serverKey][aUrl][&quot;status&quot;].lastUpdateTime =</span>
<a href="#l2.240"></a><span id="l2.240">           feed.options.updates.lastUpdateTime;</span>
<a href="#l2.241"></a><span id="l2.241">         feed = null;</span>
<a href="#l2.242"></a><span id="l2.242">       }</span>
<a href="#l2.243"></a><span id="l2.243" class="difflineat">@@ -943,22 +923,18 @@ var FeedUtils = {</span>
<a href="#l2.244"></a><span id="l2.244">       let feedUrls = this.getFeedUrlsInFolder(aFolder);</span>
<a href="#l2.245"></a><span id="l2.245">       url = feedUrls ? feedUrls[0] : null;</span>
<a href="#l2.246"></a><span id="l2.246">       if (!url)</span>
<a href="#l2.247"></a><span id="l2.247">         return useDefaultFavicon();</span>
<a href="#l2.248"></a><span id="l2.248">     }</span>
<a href="#l2.249"></a><span id="l2.249"> </span>
<a href="#l2.250"></a><span id="l2.250">     if (aFolder)</span>
<a href="#l2.251"></a><span id="l2.251">     {</span>
<a href="#l2.252"></a><span id="l2.252" class="difflineminus">-      let ds = this.getSubscriptionsDS(aFolder.server);</span>
<a href="#l2.253"></a><span id="l2.253" class="difflineminus">-      let resource = this.rdf.GetResource(url).QueryInterface(Ci.nsIRDFResource);</span>
<a href="#l2.254"></a><span id="l2.254" class="difflineminus">-      let feedLinkUrl = ds.GetTarget(resource, this.RSS_LINK, true);</span>
<a href="#l2.255"></a><span id="l2.255" class="difflineminus">-      feedLinkUrl = feedLinkUrl ?</span>
<a href="#l2.256"></a><span id="l2.256" class="difflineminus">-                      feedLinkUrl.QueryInterface(Ci.nsIRDFLiteral).Value : null;</span>
<a href="#l2.257"></a><span id="l2.257" class="difflineminus">-      url = feedLinkUrl &amp;&amp; feedLinkUrl.startsWith(&quot;http&quot;) ? feedLinkUrl : url;</span>
<a href="#l2.258"></a><span id="l2.258" class="difflineplus">+      let feed = new Feed(url, aFolder);</span>
<a href="#l2.259"></a><span id="l2.259" class="difflineplus">+      url = feed.link &amp;&amp; feed.link.startsWith(&quot;http&quot;) ? feed.link : url;</span>
<a href="#l2.260"></a><span id="l2.260">     }</span>
<a href="#l2.261"></a><span id="l2.261"> </span>
<a href="#l2.262"></a><span id="l2.262">     let uri, iconUri;</span>
<a href="#l2.263"></a><span id="l2.263">     try {</span>
<a href="#l2.264"></a><span id="l2.264">       uri = Services.io.newURI(url);</span>
<a href="#l2.265"></a><span id="l2.265">       iconUri = Services.io.newURI(uri.prePath + &quot;/favicon.ico&quot;);</span>
<a href="#l2.266"></a><span id="l2.266">     }</span>
<a href="#l2.267"></a><span id="l2.267">     catch (ex) {</span>
<a href="#l2.268"></a><span id="l2.268" class="difflineat">@@ -1067,60 +1043,57 @@ var FeedUtils = {</span>
<a href="#l2.269"></a><span id="l2.269">     }</span>
<a href="#l2.270"></a><span id="l2.270"> </span>
<a href="#l2.271"></a><span id="l2.271">     if (!feedUrlArray.length)</span>
<a href="#l2.272"></a><span id="l2.272">     {</span>
<a href="#l2.273"></a><span id="l2.273">       this.log.debug(&quot;updateFolderChangeInFeedsDS: no feedUrls in this folder&quot;);</span>
<a href="#l2.274"></a><span id="l2.274">       return;</span>
<a href="#l2.275"></a><span id="l2.275">     }</span>
<a href="#l2.276"></a><span id="l2.276"> </span>
<a href="#l2.277"></a><span id="l2.277" class="difflineminus">-    let id, resource, node;</span>
<a href="#l2.278"></a><span id="l2.278">     let ds = this.getSubscriptionsDS(aFolder.server);</span>
<a href="#l2.279"></a><span id="l2.279">     for (let feedUrl of feedUrlArray)</span>
<a href="#l2.280"></a><span id="l2.280">     {</span>
<a href="#l2.281"></a><span id="l2.281">       this.log.debug(&quot;updateFolderChangeInFeedsDS: feedUrl - &quot; + feedUrl);</span>
<a href="#l2.282"></a><span id="l2.282" class="difflineplus">+      let feed = new Feed(feedUrl, aFolder);</span>
<a href="#l2.283"></a><span id="l2.283"> </span>
<a href="#l2.284"></a><span id="l2.284" class="difflineminus">-      id = this.rdf.GetResource(feedUrl);</span>
<a href="#l2.285"></a><span id="l2.285">       // If move to trash, unsubscribe.</span>
<a href="#l2.286"></a><span id="l2.286">       if (this.isInTrash(aFolder))</span>
<a href="#l2.287"></a><span id="l2.287">       {</span>
<a href="#l2.288"></a><span id="l2.288" class="difflineminus">-        this.deleteFeed(id, aFolder.server, aFolder);</span>
<a href="#l2.289"></a><span id="l2.289" class="difflineplus">+        this.deleteFeed(feed);</span>
<a href="#l2.290"></a><span id="l2.290">       }</span>
<a href="#l2.291"></a><span id="l2.291">       else</span>
<a href="#l2.292"></a><span id="l2.292">       {</span>
<a href="#l2.293"></a><span id="l2.293" class="difflineminus">-        resource = this.rdf.GetResource(aFolder.URI);</span>
<a href="#l2.294"></a><span id="l2.294" class="difflineplus">+        let folderResource = this.rdf.GetResource(aFolder.URI);</span>
<a href="#l2.295"></a><span id="l2.295">         // Get the node for the current folder URI.</span>
<a href="#l2.296"></a><span id="l2.296" class="difflineminus">-        node = ds.GetTarget(id, this.FZ_DESTFOLDER, true);</span>
<a href="#l2.297"></a><span id="l2.297" class="difflineplus">+        let node = ds.GetTarget(feed.resource, this.FZ_DESTFOLDER, true);</span>
<a href="#l2.298"></a><span id="l2.298">         if (node)</span>
<a href="#l2.299"></a><span id="l2.299">         {</span>
<a href="#l2.300"></a><span id="l2.300" class="difflineminus">-          ds.Change(id, this.FZ_DESTFOLDER, node, resource);</span>
<a href="#l2.301"></a><span id="l2.301" class="difflineplus">+          ds.Change(feed.resource, this.FZ_DESTFOLDER, node, folderResource);</span>
<a href="#l2.302"></a><span id="l2.302">         }</span>
<a href="#l2.303"></a><span id="l2.303">         else</span>
<a href="#l2.304"></a><span id="l2.304">         {</span>
<a href="#l2.305"></a><span id="l2.305">           // If adding a new feed it's a cross account action; make sure to</span>
<a href="#l2.306"></a><span id="l2.306">           // preserve all properties from the original datasource where</span>
<a href="#l2.307"></a><span id="l2.307">           // available. Otherwise use the new folder's name and default server</span>
<a href="#l2.308"></a><span id="l2.308">           // quickMode; preserve link and options.</span>
<a href="#l2.309"></a><span id="l2.309" class="difflineminus">-          let feedTitle = dsSrc.GetTarget(id, this.DC_TITLE, true);</span>
<a href="#l2.310"></a><span id="l2.310" class="difflineplus">+          let feedTitle = dsSrc.GetTarget(feed.resource, this.DC_TITLE, true);</span>
<a href="#l2.311"></a><span id="l2.311">           feedTitle = feedTitle ? feedTitle.QueryInterface(Ci.nsIRDFLiteral).Value :</span>
<a href="#l2.312"></a><span id="l2.312" class="difflineminus">-                                  resource.name;</span>
<a href="#l2.313"></a><span id="l2.313" class="difflineminus">-          let link = dsSrc.GetTarget(id, FeedUtils.RSS_LINK, true);</span>
<a href="#l2.314"></a><span id="l2.314" class="difflineplus">+                                  folderResource.name;</span>
<a href="#l2.315"></a><span id="l2.315" class="difflineplus">+          let link = dsSrc.GetTarget(feed.resource, FeedUtils.RSS_LINK, true);</span>
<a href="#l2.316"></a><span id="l2.316">           link = link ? link.QueryInterface(Ci.nsIRDFLiteral).Value : &quot;&quot;;</span>
<a href="#l2.317"></a><span id="l2.317" class="difflineminus">-          let quickMode = dsSrc.GetTarget(id, this.FZ_QUICKMODE, true);</span>
<a href="#l2.318"></a><span id="l2.318" class="difflineplus">+          let quickMode = dsSrc.GetTarget(feed.resource, this.FZ_QUICKMODE, true);</span>
<a href="#l2.319"></a><span id="l2.319">           quickMode = quickMode ? quickMode.QueryInterface(Ci.nsIRDFLiteral).Value :</span>
<a href="#l2.320"></a><span id="l2.320">                                   null;</span>
<a href="#l2.321"></a><span id="l2.321">           quickMode = quickMode == &quot;true&quot; ? true :</span>
<a href="#l2.322"></a><span id="l2.322">                       quickMode == &quot;false&quot; ? false :</span>
<a href="#l2.323"></a><span id="l2.323" class="difflineminus">-                      aFeed.folder.server.getBoolValue(&quot;quickMode&quot;);</span>
<a href="#l2.324"></a><span id="l2.324" class="difflineminus">-          let options = dsSrc.GetTarget(id, this.FZ_OPTIONS, true);</span>
<a href="#l2.325"></a><span id="l2.325" class="difflineplus">+                      feed.server.getBoolValue(&quot;quickMode&quot;);</span>
<a href="#l2.326"></a><span id="l2.326" class="difflineplus">+          let options = dsSrc.GetTarget(feed.resource, this.FZ_OPTIONS, true);</span>
<a href="#l2.327"></a><span id="l2.327">           options = options ? JSON.parse(options.QueryInterface(Ci.nsIRDFLiteral).Value) :</span>
<a href="#l2.328"></a><span id="l2.328">                               this.optionsTemplate;</span>
<a href="#l2.329"></a><span id="l2.329" class="difflineminus">-</span>
<a href="#l2.330"></a><span id="l2.330" class="difflineminus">-          let feed = new Feed(id, aFolder.server);</span>
<a href="#l2.331"></a><span id="l2.331" class="difflineminus">-          feed.folder = aFolder;</span>
<a href="#l2.332"></a><span id="l2.332" class="difflineplus">+          // Update the feedUrl feed properties.</span>
<a href="#l2.333"></a><span id="l2.333">           feed.title = feedTitle;</span>
<a href="#l2.334"></a><span id="l2.334">           feed.link = link;</span>
<a href="#l2.335"></a><span id="l2.335">           feed.quickMode = quickMode;</span>
<a href="#l2.336"></a><span id="l2.336">           feed.options = options;</span>
<a href="#l2.337"></a><span id="l2.337">           this.addFeed(feed);</span>
<a href="#l2.338"></a><span id="l2.338">         }</span>
<a href="#l2.339"></a><span id="l2.339">       }</span>
<a href="#l2.340"></a><span id="l2.340">     }</span>
<a href="#l2.341"></a><span id="l2.341" class="difflineat">@@ -1707,17 +1680,17 @@ var FeedUtils = {</span>
<a href="#l2.342"></a><span id="l2.342">       try {</span>
<a href="#l2.343"></a><span id="l2.343">         aUri = Services.io.newURI(aUri);</span>
<a href="#l2.344"></a><span id="l2.344">       }</span>
<a href="#l2.345"></a><span id="l2.345">       catch (ex) {</span>
<a href="#l2.346"></a><span id="l2.346">         return false;</span>
<a href="#l2.347"></a><span id="l2.347">       }</span>
<a href="#l2.348"></a><span id="l2.348">     }</span>
<a href="#l2.349"></a><span id="l2.349"> </span>
<a href="#l2.350"></a><span id="l2.350" class="difflineminus">-    return (this._validSchemes.indexOf(aUri.scheme) != -1);</span>
<a href="#l2.351"></a><span id="l2.351" class="difflineplus">+    return this._validSchemes.includes(aUri.scheme);</span>
<a href="#l2.352"></a><span id="l2.352">   },</span>
<a href="#l2.353"></a><span id="l2.353"> </span>
<a href="#l2.354"></a><span id="l2.354"> /**</span>
<a href="#l2.355"></a><span id="l2.355">  * Is a folder Trash or in Trash.</span>
<a href="#l2.356"></a><span id="l2.356">  *</span>
<a href="#l2.357"></a><span id="l2.357">  * @param  nsIMsgFolder aFolder   - the folder.</span>
<a href="#l2.358"></a><span id="l2.358">  * @return boolean                - true if folder is Trash else false.</span>
<a href="#l2.359"></a><span id="l2.359">  */</span>
<a href="#l2.360"></a><span id="l2.360" class="difflineat">@@ -1865,19 +1838,17 @@ var FeedUtils = {</span>
<a href="#l2.361"></a><span id="l2.361">           if (subscriptionsWindow)</span>
<a href="#l2.362"></a><span id="l2.362">             subscriptionsWindow.FeedSubscriptions.</span>
<a href="#l2.363"></a><span id="l2.363">                                 FolderListener.folderAdded(feed.folder);</span>
<a href="#l2.364"></a><span id="l2.364">         }</span>
<a href="#l2.365"></a><span id="l2.365">         else</span>
<a href="#l2.366"></a><span id="l2.366">         {</span>
<a href="#l2.367"></a><span id="l2.367">           // Non success.  Remove intermediate traces from the feeds database.</span>
<a href="#l2.368"></a><span id="l2.368">           if (feed &amp;&amp; feed.url &amp;&amp; feed.server)</span>
<a href="#l2.369"></a><span id="l2.369" class="difflineminus">-            FeedUtils.deleteFeed(FeedUtils.rdf.GetResource(feed.url),</span>
<a href="#l2.370"></a><span id="l2.370" class="difflineminus">-                                 feed.server,</span>
<a href="#l2.371"></a><span id="l2.371" class="difflineminus">-                                 feed.server.rootFolder);</span>
<a href="#l2.372"></a><span id="l2.372" class="difflineplus">+            FeedUtils.deleteFeed(feed);</span>
<a href="#l2.373"></a><span id="l2.373">         }</span>
<a href="#l2.374"></a><span id="l2.374">       }</span>
<a href="#l2.375"></a><span id="l2.375"> </span>
<a href="#l2.376"></a><span id="l2.376">       if (aErrorCode != FeedUtils.kNewsBlogFeedIsBusy)</span>
<a href="#l2.377"></a><span id="l2.377">       {</span>
<a href="#l2.378"></a><span id="l2.378">         if (aErrorCode == FeedUtils.kNewsBlogSuccess ||</span>
<a href="#l2.379"></a><span id="l2.379">             aErrorCode == FeedUtils.kNewsBlogNoNewItems)</span>
<a href="#l2.380"></a><span id="l2.380">         {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/extensions/newsblog/content/feed-subscriptions.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/extensions/newsblog/content/feed-subscriptions.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -665,18 +665,17 @@ var FeedSubscriptions = {</span>
<a href="#l3.4"></a><span id="l3.4">     let feeds = new Array();</span>
<a href="#l3.5"></a><span id="l3.5">     let feedUrlArray = FeedUtils.getFeedUrlsInFolder(aFolder);</span>
<a href="#l3.6"></a><span id="l3.6">     if (!feedUrlArray)</span>
<a href="#l3.7"></a><span id="l3.7">       // No feedUrls in this folder.</span>
<a href="#l3.8"></a><span id="l3.8">       return feeds;</span>
<a href="#l3.9"></a><span id="l3.9"> </span>
<a href="#l3.10"></a><span id="l3.10">     for (let url of feedUrlArray)</span>
<a href="#l3.11"></a><span id="l3.11">     {</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-      let feedResource = FeedUtils.rdf.GetResource(url);</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-      let feed = new Feed(feedResource, aFolder.server);</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+      let feed = new Feed(url, aFolder);</span>
<a href="#l3.15"></a><span id="l3.15">       feeds.push(feed);</span>
<a href="#l3.16"></a><span id="l3.16">     }</span>
<a href="#l3.17"></a><span id="l3.17"> </span>
<a href="#l3.18"></a><span id="l3.18">     return feeds;</span>
<a href="#l3.19"></a><span id="l3.19">   },</span>
<a href="#l3.20"></a><span id="l3.20"> </span>
<a href="#l3.21"></a><span id="l3.21">   makeFeedObject: function (aFeed, aFolder, aLevel)</span>
<a href="#l3.22"></a><span id="l3.22">   {</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineat">@@ -907,17 +906,17 @@ var FeedSubscriptions = {</span>
<a href="#l3.24"></a><span id="l3.24">   {</span>
<a href="#l3.25"></a><span id="l3.25">     let folder = aFeed.folder;</span>
<a href="#l3.26"></a><span id="l3.26">     let found = false;</span>
<a href="#l3.27"></a><span id="l3.27"> </span>
<a href="#l3.28"></a><span id="l3.28">     if (aFeed.folder.isServer) {</span>
<a href="#l3.29"></a><span id="l3.29">       // If passed the root folder, the caller wants to get the feed's folder</span>
<a href="#l3.30"></a><span id="l3.30">       // from the db (for cases of an ancestor folder rename/move).</span>
<a href="#l3.31"></a><span id="l3.31">       let itemResource = FeedUtils.rdf.GetResource(aFeed.url);</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineminus">-      let ds = FeedUtils.getSubscriptionsDS(aFeed.folder.server);</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+      let ds = FeedUtils.getSubscriptionsDS(aFeed.server);</span>
<a href="#l3.34"></a><span id="l3.34">       folder = ds.GetTarget(itemResource, FeedUtils.FZ_DESTFOLDER, true);</span>
<a href="#l3.35"></a><span id="l3.35">     }</span>
<a href="#l3.36"></a><span id="l3.36"> </span>
<a href="#l3.37"></a><span id="l3.37">     if (this.selectFolder(folder, { parentIndex: aParentIndex }))</span>
<a href="#l3.38"></a><span id="l3.38">     {</span>
<a href="#l3.39"></a><span id="l3.39">       let seln = this.mView.selection;</span>
<a href="#l3.40"></a><span id="l3.40">       let item = this.mView.currentItem;</span>
<a href="#l3.41"></a><span id="l3.41">       if (item) {</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineat">@@ -1164,18 +1163,17 @@ var FeedSubscriptions = {</span>
<a href="#l3.43"></a><span id="l3.43">     }</span>
<a href="#l3.44"></a><span id="l3.44"> </span>
<a href="#l3.45"></a><span id="l3.45">     if (isServer)</span>
<a href="#l3.46"></a><span id="l3.46">     {</span>
<a href="#l3.47"></a><span id="l3.47">       FeedUtils.setOptionsAcct(item.folder.server, item.options)</span>
<a href="#l3.48"></a><span id="l3.48">     }</span>
<a href="#l3.49"></a><span id="l3.49">     else</span>
<a href="#l3.50"></a><span id="l3.50">     {</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineminus">-      let feedResource = FeedUtils.rdf.GetResource(item.url);</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineminus">-      let feed = new Feed(feedResource, item.parentFolder.server);</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineplus">+      let feed = new Feed(item.url, item.parentFolder);</span>
<a href="#l3.54"></a><span id="l3.54">       feed.options = item.options;</span>
<a href="#l3.55"></a><span id="l3.55">       let ds = FeedUtils.getSubscriptionsDS(item.parentFolder.server);</span>
<a href="#l3.56"></a><span id="l3.56">       ds.Flush();</span>
<a href="#l3.57"></a><span id="l3.57"> </span>
<a href="#l3.58"></a><span id="l3.58">       if (aNode.id == &quot;updateEnabled&quot;)</span>
<a href="#l3.59"></a><span id="l3.59">       {</span>
<a href="#l3.60"></a><span id="l3.60">         FeedUtils.setStatus(item.parentFolder, item.url, &quot;enabled&quot;, aNode.checked);</span>
<a href="#l3.61"></a><span id="l3.61">         this.mView.selection.tree.invalidateRow(this.mView.selection.currentIndex);</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineat">@@ -1333,19 +1331,18 @@ var FeedSubscriptions = {</span>
<a href="#l3.63"></a><span id="l3.63">       let pMessage = FeedUtils.strings.formatStringFromName(</span>
<a href="#l3.64"></a><span id="l3.64">                        &quot;subscribe-confirmFeedDeletion&quot;, [itemToRemove.name], 1);</span>
<a href="#l3.65"></a><span id="l3.65">       if (Services.prompt.confirmEx(window, pTitle, pMessage,</span>
<a href="#l3.66"></a><span id="l3.66">                                     Ci.nsIPromptService.STD_YES_NO_BUTTONS,</span>
<a href="#l3.67"></a><span id="l3.67">                                     null, null, null, null, { }))</span>
<a href="#l3.68"></a><span id="l3.68">         return;</span>
<a href="#l3.69"></a><span id="l3.69">     }</span>
<a href="#l3.70"></a><span id="l3.70"> </span>
<a href="#l3.71"></a><span id="l3.71" class="difflineminus">-    FeedUtils.deleteFeed(FeedUtils.rdf.GetResource(itemToRemove.url),</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineminus">-                         itemToRemove.parentFolder.server,</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineminus">-                         itemToRemove.parentFolder);</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineplus">+    let feed = new Feed(itemToRemove.url, itemToRemove.parentFolder);</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineplus">+    FeedUtils.deleteFeed(feed);</span>
<a href="#l3.76"></a><span id="l3.76"> </span>
<a href="#l3.77"></a><span id="l3.77">     // Now that we have removed the feed from the datasource, it is time to</span>
<a href="#l3.78"></a><span id="l3.78">     // update our view layer.  Update parent folder's quickMode if necessary</span>
<a href="#l3.79"></a><span id="l3.79">     // and remove the child from its parent folder object.</span>
<a href="#l3.80"></a><span id="l3.80">     let parentIndex = this.mView.getParentIndex(seln.currentIndex);</span>
<a href="#l3.81"></a><span id="l3.81">     let parentItem = this.mView.getItemAtIndex(parentIndex);</span>
<a href="#l3.82"></a><span id="l3.82">     this.updateFolderQuickModeInView(itemToRemove, parentItem, true);</span>
<a href="#l3.83"></a><span id="l3.83">     this.mView.removeItemAtIndex(seln.currentIndex, false);</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineat">@@ -1447,21 +1444,19 @@ var FeedSubscriptions = {</span>
<a href="#l3.85"></a><span id="l3.85">       let minutes = biffUnits == FeedUtils.kBiffUnitsMinutes ? units : units * 24 * 60;</span>
<a href="#l3.86"></a><span id="l3.86">       options.updates.updateUnits = biffUnits;</span>
<a href="#l3.87"></a><span id="l3.87">       options.updates.updateMinutes = minutes;</span>
<a href="#l3.88"></a><span id="l3.88">       options.category.enabled = document.getElementById(&quot;autotagEnable&quot;).checked;</span>
<a href="#l3.89"></a><span id="l3.89">       options.category.prefixEnabled = document.getElementById(&quot;autotagUsePrefix&quot;).checked;</span>
<a href="#l3.90"></a><span id="l3.90">       options.category.prefix = document.getElementById(&quot;autotagPrefix&quot;).value;</span>
<a href="#l3.91"></a><span id="l3.91">     }</span>
<a href="#l3.92"></a><span id="l3.92"> </span>
<a href="#l3.93"></a><span id="l3.93" class="difflineminus">-    let folderURI = addFolder.isServer ? null : addFolder.URI;</span>
<a href="#l3.94"></a><span id="l3.94">     let feedProperties = { feedName     : name,</span>
<a href="#l3.95"></a><span id="l3.95">                            feedLocation : feedLocation,</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineminus">-                           folderURI    : folderURI,</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineminus">-                           server       : addFolder.server,</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineplus">+                           feedFolder   : addFolder,</span>
<a href="#l3.99"></a><span id="l3.99">                            quickMode    : quickMode,</span>
<a href="#l3.100"></a><span id="l3.100">                            options      : options };</span>
<a href="#l3.101"></a><span id="l3.101"> </span>
<a href="#l3.102"></a><span id="l3.102">     let feed = this.storeFeed(feedProperties);</span>
<a href="#l3.103"></a><span id="l3.103">     if (!feed)</span>
<a href="#l3.104"></a><span id="l3.104">       return false;</span>
<a href="#l3.105"></a><span id="l3.105"> </span>
<a href="#l3.106"></a><span id="l3.106">     // Now validate and start downloading the feed.</span>
<a href="#l3.107"></a><span id="l3.107" class="difflineat">@@ -1472,31 +1467,17 @@ var FeedSubscriptions = {</span>
<a href="#l3.108"></a><span id="l3.108">     this.mActionMode = mode;</span>
<a href="#l3.109"></a><span id="l3.109">     feed.download(parse, this.mFeedDownloadCallback);</span>
<a href="#l3.110"></a><span id="l3.110">     return true;</span>
<a href="#l3.111"></a><span id="l3.111">   },</span>
<a href="#l3.112"></a><span id="l3.112"> </span>
<a href="#l3.113"></a><span id="l3.113">   // Helper routine used by addFeed and importOPMLFile.</span>
<a href="#l3.114"></a><span id="l3.114">   storeFeed: function(feedProperties)</span>
<a href="#l3.115"></a><span id="l3.115">   {</span>
<a href="#l3.116"></a><span id="l3.116" class="difflineminus">-    let itemResource = FeedUtils.rdf.GetResource(feedProperties.feedLocation);</span>
<a href="#l3.117"></a><span id="l3.117" class="difflineminus">-    let feed = new Feed(itemResource, feedProperties.server);</span>
<a href="#l3.118"></a><span id="l3.118" class="difflineminus">-</span>
<a href="#l3.119"></a><span id="l3.119" class="difflineminus">-    // If the user specified a folder to add the feed to, then set it here.</span>
<a href="#l3.120"></a><span id="l3.120" class="difflineminus">-    if (feedProperties.folderURI)</span>
<a href="#l3.121"></a><span id="l3.121" class="difflineminus">-    {</span>
<a href="#l3.122"></a><span id="l3.122" class="difflineminus">-      let folderResource = FeedUtils.rdf.GetResource(feedProperties.folderURI);</span>
<a href="#l3.123"></a><span id="l3.123" class="difflineminus">-      if (folderResource)</span>
<a href="#l3.124"></a><span id="l3.124" class="difflineminus">-      {</span>
<a href="#l3.125"></a><span id="l3.125" class="difflineminus">-        let folder = folderResource.QueryInterface(Ci.nsIMsgFolder);</span>
<a href="#l3.126"></a><span id="l3.126" class="difflineminus">-        if (folder &amp;&amp; !folder.isServer)</span>
<a href="#l3.127"></a><span id="l3.127" class="difflineminus">-          feed.folder = folder;</span>
<a href="#l3.128"></a><span id="l3.128" class="difflineminus">-      }</span>
<a href="#l3.129"></a><span id="l3.129" class="difflineminus">-    }</span>
<a href="#l3.130"></a><span id="l3.130" class="difflineminus">-</span>
<a href="#l3.131"></a><span id="l3.131" class="difflineplus">+    let feed = new Feed(feedProperties.feedLocation, feedProperties.feedFolder);</span>
<a href="#l3.132"></a><span id="l3.132">     feed.title = feedProperties.feedName;</span>
<a href="#l3.133"></a><span id="l3.133">     feed.quickMode = feedProperties.quickMode;</span>
<a href="#l3.134"></a><span id="l3.134">     feed.options = feedProperties.options;</span>
<a href="#l3.135"></a><span id="l3.135">     return feed;</span>
<a href="#l3.136"></a><span id="l3.136">   },</span>
<a href="#l3.137"></a><span id="l3.137"> </span>
<a href="#l3.138"></a><span id="l3.138">   updateAccount: function(aItem)</span>
<a href="#l3.139"></a><span id="l3.139">   {</span>
<a href="#l3.140"></a><span id="l3.140" class="difflineat">@@ -1530,22 +1511,17 @@ var FeedSubscriptions = {</span>
<a href="#l3.141"></a><span id="l3.141">     {</span>
<a href="#l3.142"></a><span id="l3.142">       this.updateAccount(itemToEdit)</span>
<a href="#l3.143"></a><span id="l3.143">       return;</span>
<a href="#l3.144"></a><span id="l3.144">     }</span>
<a href="#l3.145"></a><span id="l3.145"> </span>
<a href="#l3.146"></a><span id="l3.146">     if (!itemToEdit || itemToEdit.container || !itemToEdit.parentFolder)</span>
<a href="#l3.147"></a><span id="l3.147">       return;</span>
<a href="#l3.148"></a><span id="l3.148"> </span>
<a href="#l3.149"></a><span id="l3.149" class="difflineminus">-    let resource = FeedUtils.rdf.GetResource(itemToEdit.url);</span>
<a href="#l3.150"></a><span id="l3.150" class="difflineminus">-    let currentFolderServer = itemToEdit.parentFolder.server;</span>
<a href="#l3.151"></a><span id="l3.151" class="difflineminus">-    let ds = FeedUtils.getSubscriptionsDS(currentFolderServer);</span>
<a href="#l3.152"></a><span id="l3.152" class="difflineminus">-    let currentFolderURI = itemToEdit.parentFolder.URI;</span>
<a href="#l3.153"></a><span id="l3.153" class="difflineminus">-    let feed = new Feed(resource, currentFolderServer);</span>
<a href="#l3.154"></a><span id="l3.154" class="difflineminus">-    feed.folder = itemToEdit.parentFolder;</span>
<a href="#l3.155"></a><span id="l3.155" class="difflineplus">+    let feed = new Feed(itemToEdit.url, itemToEdit.parentFolder);</span>
<a href="#l3.156"></a><span id="l3.156"> </span>
<a href="#l3.157"></a><span id="l3.157">     let editNameValue = document.getElementById(&quot;nameValue&quot;).value;</span>
<a href="#l3.158"></a><span id="l3.158">     let editFeedLocation = document.getElementById(&quot;locationValue&quot;).value.trim();</span>
<a href="#l3.159"></a><span id="l3.159">     let selectFolder = document.getElementById(&quot;selectFolder&quot;);</span>
<a href="#l3.160"></a><span id="l3.160">     let editUpdateValue = document.getElementById(&quot;updateValue&quot;).valueNumber;</span>
<a href="#l3.161"></a><span id="l3.161">     let editBiffUnits = document.getElementById(&quot;biffUnits&quot;).value;</span>
<a href="#l3.162"></a><span id="l3.162">     let editQuickMode = document.getElementById(&quot;quickMode&quot;).checked;</span>
<a href="#l3.163"></a><span id="l3.163">     let editAutotagPrefix = document.getElementById(&quot;autotagPrefix&quot;).value;</span>
<a href="#l3.164"></a><span id="l3.164" class="difflineat">@@ -1555,17 +1531,17 @@ var FeedSubscriptions = {</span>
<a href="#l3.165"></a><span id="l3.165">       // Updating a url.  We need to add the new url and delete the old, to</span>
<a href="#l3.166"></a><span id="l3.166">       // ensure everything is cleaned up correctly.</span>
<a href="#l3.167"></a><span id="l3.167">       this.addFeed(null, itemToEdit.parentFolder, false, null, this.kUpdateMode)</span>
<a href="#l3.168"></a><span id="l3.168">       return;</span>
<a href="#l3.169"></a><span id="l3.169">     }</span>
<a href="#l3.170"></a><span id="l3.170"> </span>
<a href="#l3.171"></a><span id="l3.171">     // Did the user change the folder URI for storing the feed?</span>
<a href="#l3.172"></a><span id="l3.172">     let editFolderURI = selectFolder.getAttribute(&quot;uri&quot;);</span>
<a href="#l3.173"></a><span id="l3.173" class="difflineminus">-    if (currentFolderURI != editFolderURI)</span>
<a href="#l3.174"></a><span id="l3.174" class="difflineplus">+    if (itemToEdit.parentFolder.URI != editFolderURI)</span>
<a href="#l3.175"></a><span id="l3.175">     {</span>
<a href="#l3.176"></a><span id="l3.176">       // Make sure the new folderpicked folder is visible.</span>
<a href="#l3.177"></a><span id="l3.177">       this.selectFolder(selectFolder._folder);</span>
<a href="#l3.178"></a><span id="l3.178">       // Now go back to the feed item.</span>
<a href="#l3.179"></a><span id="l3.179">       this.selectFeed(feed, null);</span>
<a href="#l3.180"></a><span id="l3.180">       // We need to find the index of the new parent folder.</span>
<a href="#l3.181"></a><span id="l3.181">       let newParentIndex = this.mView.kRowIndexUndefined;</span>
<a href="#l3.182"></a><span id="l3.182">       for (let index = 0; index &lt; this.mView.rowCount; index++)</span>
<a href="#l3.183"></a><span id="l3.183" class="difflineat">@@ -1635,16 +1611,17 @@ var FeedSubscriptions = {</span>
<a href="#l3.184"></a><span id="l3.184">     {</span>
<a href="#l3.185"></a><span id="l3.185">       itemToEdit.options.category.prefix = editAutotagPrefix;</span>
<a href="#l3.186"></a><span id="l3.186">       feed.options = itemToEdit.options;</span>
<a href="#l3.187"></a><span id="l3.187">       updated = true;</span>
<a href="#l3.188"></a><span id="l3.188">     }</span>
<a href="#l3.189"></a><span id="l3.189"> </span>
<a href="#l3.190"></a><span id="l3.190">     let verifyDelay = 0;</span>
<a href="#l3.191"></a><span id="l3.191">     if (updated) {</span>
<a href="#l3.192"></a><span id="l3.192" class="difflineplus">+      let ds = FeedUtils.getSubscriptionsDS(feed.server);</span>
<a href="#l3.193"></a><span id="l3.193">       ds.Flush();</span>
<a href="#l3.194"></a><span id="l3.194">       message = FeedUtils.strings.GetStringFromName(&quot;subscribe-feedUpdated&quot;);</span>
<a href="#l3.195"></a><span id="l3.195">       this.updateStatusItem(&quot;statusText&quot;, message);</span>
<a href="#l3.196"></a><span id="l3.196">       verifyDelay = 1500;</span>
<a href="#l3.197"></a><span id="l3.197">     }</span>
<a href="#l3.198"></a><span id="l3.198"> </span>
<a href="#l3.199"></a><span id="l3.199">     // Now we want to verify if the stored feed url still works. If it</span>
<a href="#l3.200"></a><span id="l3.200">     // doesn't, show the error. Delay a bit to leave Updated message visible.</span>
<a href="#l3.201"></a><span id="l3.201" class="difflineat">@@ -1677,30 +1654,29 @@ var FeedSubscriptions = {</span>
<a href="#l3.202"></a><span id="l3.202">     let currentParentItem = this.mView.getItemAtIndex(currentParentIndex);</span>
<a href="#l3.203"></a><span id="l3.203">     let currentParentResource = FeedUtils.rdf.GetResource(currentParentItem.url);</span>
<a href="#l3.204"></a><span id="l3.204">     let currentFolder = currentParentResource.QueryInterface(Ci.nsIMsgFolder);</span>
<a href="#l3.205"></a><span id="l3.205"> </span>
<a href="#l3.206"></a><span id="l3.206">     let newParentItem = this.mView.getItemAtIndex(aNewParentIndex);</span>
<a href="#l3.207"></a><span id="l3.207">     let newParentResource = FeedUtils.rdf.GetResource(newParentItem.url);</span>
<a href="#l3.208"></a><span id="l3.208">     let newFolder = newParentResource.QueryInterface(Ci.nsIMsgFolder);</span>
<a href="#l3.209"></a><span id="l3.209"> </span>
<a href="#l3.210"></a><span id="l3.210" class="difflineminus">-    let ds = FeedUtils.getSubscriptionsDS(currentItem.parentFolder.server);</span>
<a href="#l3.211"></a><span id="l3.211" class="difflineminus">-    let resource = FeedUtils.rdf.GetResource(currentItem.url);</span>
<a href="#l3.212"></a><span id="l3.212" class="difflineminus">-</span>
<a href="#l3.213"></a><span id="l3.213">     let accountMoveCopy = false;</span>
<a href="#l3.214"></a><span id="l3.214">     if (currentFolder.rootFolder.URI == newFolder.rootFolder.URI)</span>
<a href="#l3.215"></a><span id="l3.215">     {</span>
<a href="#l3.216"></a><span id="l3.216">       // Moving within the same account/feeds db.</span>
<a href="#l3.217"></a><span id="l3.217">       if (newFolder.isServer || !moveFeed)</span>
<a href="#l3.218"></a><span id="l3.218">         // No moving to account folder if already in the account; can only move,</span>
<a href="#l3.219"></a><span id="l3.219">         // not copy, to folder in the same account.</span>
<a href="#l3.220"></a><span id="l3.220">         return;</span>
<a href="#l3.221"></a><span id="l3.221"> </span>
<a href="#l3.222"></a><span id="l3.222">       // Unassert the older URI, add an assertion for the new parent URI.</span>
<a href="#l3.223"></a><span id="l3.223" class="difflineminus">-      ds.Change(resource, FeedUtils.FZ_DESTFOLDER,</span>
<a href="#l3.224"></a><span id="l3.224" class="difflineplus">+      let feedResource = FeedUtils.rdf.GetResource(currentItem.url);</span>
<a href="#l3.225"></a><span id="l3.225" class="difflineplus">+      let ds = FeedUtils.getSubscriptionsDS(currentItem.parentFolder.server);</span>
<a href="#l3.226"></a><span id="l3.226" class="difflineplus">+      ds.Change(feedResource, FeedUtils.FZ_DESTFOLDER,</span>
<a href="#l3.227"></a><span id="l3.227">                 currentParentResource, newParentResource);</span>
<a href="#l3.228"></a><span id="l3.228">       ds.Flush();</span>
<a href="#l3.229"></a><span id="l3.229"> </span>
<a href="#l3.230"></a><span id="l3.230">       // Update folderpane favicons.</span>
<a href="#l3.231"></a><span id="l3.231">       FeedUtils.setFolderPaneProperty(currentFolder, &quot;favicon&quot;, null, &quot;row&quot;);</span>
<a href="#l3.232"></a><span id="l3.232">       FeedUtils.setFolderPaneProperty(newFolder, &quot;favicon&quot;, null, &quot;row&quot;);</span>
<a href="#l3.233"></a><span id="l3.233">     }</span>
<a href="#l3.234"></a><span id="l3.234">     else</span>
<a href="#l3.235"></a><span id="l3.235" class="difflineat">@@ -1714,19 +1690,20 @@ var FeedSubscriptions = {</span>
<a href="#l3.236"></a><span id="l3.236">                     options:   currentItem.options};</span>
<a href="#l3.237"></a><span id="l3.237">       // Subscribe to the new folder first.  If it already exists in the</span>
<a href="#l3.238"></a><span id="l3.238">       // account or on error, return.</span>
<a href="#l3.239"></a><span id="l3.239">       if (!this.addFeed(currentItem.url, newFolder, false, params, mode))</span>
<a href="#l3.240"></a><span id="l3.240">         return;</span>
<a href="#l3.241"></a><span id="l3.241">       // Unsubscribe the feed from the old folder, if add to the new folder</span>
<a href="#l3.242"></a><span id="l3.242">       // is successfull, and doing a move.</span>
<a href="#l3.243"></a><span id="l3.243">       if (moveFeed)</span>
<a href="#l3.244"></a><span id="l3.244" class="difflineminus">-        FeedUtils.deleteFeed(FeedUtils.rdf.GetResource(currentItem.url),</span>
<a href="#l3.245"></a><span id="l3.245" class="difflineminus">-                             currentItem.parentFolder.server,</span>
<a href="#l3.246"></a><span id="l3.246" class="difflineminus">-                             currentItem.parentFolder);</span>
<a href="#l3.247"></a><span id="l3.247" class="difflineplus">+      {</span>
<a href="#l3.248"></a><span id="l3.248" class="difflineplus">+        let feed = new Feed(currentItem.url, currentItem.parentFolder);</span>
<a href="#l3.249"></a><span id="l3.249" class="difflineplus">+        FeedUtils.deleteFeed(feed);</span>
<a href="#l3.250"></a><span id="l3.250" class="difflineplus">+      }</span>
<a href="#l3.251"></a><span id="l3.251">     }</span>
<a href="#l3.252"></a><span id="l3.252"> </span>
<a href="#l3.253"></a><span id="l3.253">     // Update local favicons.</span>
<a href="#l3.254"></a><span id="l3.254">     currentParentItem.favicon = newParentItem.favicon = null;</span>
<a href="#l3.255"></a><span id="l3.255"> </span>
<a href="#l3.256"></a><span id="l3.256">     // Finally, update our view layer.  Update old parent folder's quickMode</span>
<a href="#l3.257"></a><span id="l3.257">     // and remove the old row, if move.  Otherwise no change to the view.</span>
<a href="#l3.258"></a><span id="l3.258">     if (moveFeed)</span>
<a href="#l3.259"></a><span id="l3.259" class="difflineat">@@ -1775,18 +1752,17 @@ var FeedSubscriptions = {</span>
<a href="#l3.260"></a><span id="l3.260"> </span>
<a href="#l3.261"></a><span id="l3.261">     if (!aRemove)</span>
<a href="#l3.262"></a><span id="l3.262">     {</span>
<a href="#l3.263"></a><span id="l3.263">       // Just added a feed to a folder.  If there are already feeds in the</span>
<a href="#l3.264"></a><span id="l3.264">       // folder, the feed must reflect the parent's quickMode.  If it is the</span>
<a href="#l3.265"></a><span id="l3.265">       // only feed, update the parent folder to the feed's quickMode.</span>
<a href="#l3.266"></a><span id="l3.266">       if (feedsInFolder &gt; 1)</span>
<a href="#l3.267"></a><span id="l3.267">       {</span>
<a href="#l3.268"></a><span id="l3.268" class="difflineminus">-        let feedResource = FeedUtils.rdf.GetResource(feedItem.url);</span>
<a href="#l3.269"></a><span id="l3.269" class="difflineminus">-        let feed = new Feed(feedResource, feedItem.parentFolder.server);</span>
<a href="#l3.270"></a><span id="l3.270" class="difflineplus">+        let feed = new Feed(feedItem.url, feedItem.parentFolder);</span>
<a href="#l3.271"></a><span id="l3.271">         feed.quickMode = parentItem.quickMode;</span>
<a href="#l3.272"></a><span id="l3.272">         feedItem.quickMode = parentItem.quickMode;</span>
<a href="#l3.273"></a><span id="l3.273">       }</span>
<a href="#l3.274"></a><span id="l3.274">       else</span>
<a href="#l3.275"></a><span id="l3.275">         parentItem.quickMode = feedItem.quickMode;</span>
<a href="#l3.276"></a><span id="l3.276">     }</span>
<a href="#l3.277"></a><span id="l3.277">   },</span>
<a href="#l3.278"></a><span id="l3.278"> </span>
<a href="#l3.279"></a><span id="l3.279" class="difflineat">@@ -1916,19 +1892,17 @@ var FeedSubscriptions = {</span>
<a href="#l3.280"></a><span id="l3.280">         }</span>
<a href="#l3.281"></a><span id="l3.281">       }</span>
<a href="#l3.282"></a><span id="l3.282">       else</span>
<a href="#l3.283"></a><span id="l3.283">       {</span>
<a href="#l3.284"></a><span id="l3.284">         // Non success.  Remove intermediate traces from the feeds database.</span>
<a href="#l3.285"></a><span id="l3.285">         // But only if we're not in verify mode.</span>
<a href="#l3.286"></a><span id="l3.286">         if (win.mActionMode != win.kVerifyUrlMode &amp;&amp;</span>
<a href="#l3.287"></a><span id="l3.287">             feed &amp;&amp; feed.url &amp;&amp; feed.server)</span>
<a href="#l3.288"></a><span id="l3.288" class="difflineminus">-          FeedUtils.deleteFeed(FeedUtils.rdf.GetResource(feed.url),</span>
<a href="#l3.289"></a><span id="l3.289" class="difflineminus">-                               feed.server,</span>
<a href="#l3.290"></a><span id="l3.290" class="difflineminus">-                               feed.server.rootFolder);</span>
<a href="#l3.291"></a><span id="l3.291" class="difflineplus">+          FeedUtils.deleteFeed(feed);</span>
<a href="#l3.292"></a><span id="l3.292"> </span>
<a href="#l3.293"></a><span id="l3.293">         if (aErrorCode == FeedUtils.kNewsBlogInvalidFeed)</span>
<a href="#l3.294"></a><span id="l3.294">           message = FeedUtils.strings.GetStringFromName(</span>
<a href="#l3.295"></a><span id="l3.295">                       &quot;subscribe-feedNotValid&quot;);</span>
<a href="#l3.296"></a><span id="l3.296">         if (aErrorCode == FeedUtils.kNewsBlogRequestFailure)</span>
<a href="#l3.297"></a><span id="l3.297">           message = FeedUtils.strings.GetStringFromName(</span>
<a href="#l3.298"></a><span id="l3.298">                       &quot;subscribe-networkError&quot;);</span>
<a href="#l3.299"></a><span id="l3.299">         if (aErrorCode == FeedUtils.kNewsBlogFileError)</span>
<a href="#l3.300"></a><span id="l3.300" class="difflineat">@@ -2649,17 +2623,17 @@ var FeedSubscriptions = {</span>
<a href="#l3.301"></a><span id="l3.301">                              &quot;&lt;outline&gt; - &lt;&quot; + outline.tagName + &quot;&gt;&quot;);</span>
<a href="#l3.302"></a><span id="l3.302">           badTag = true;</span>
<a href="#l3.303"></a><span id="l3.303">           break;</span>
<a href="#l3.304"></a><span id="l3.304">         }</span>
<a href="#l3.305"></a><span id="l3.305"> </span>
<a href="#l3.306"></a><span id="l3.306">         let outlineName = outline.getAttribute(&quot;text&quot;) ||</span>
<a href="#l3.307"></a><span id="l3.307">                           outline.getAttribute(&quot;title&quot;) ||</span>
<a href="#l3.308"></a><span id="l3.308">                           outline.getAttribute(&quot;xmlUrl&quot;);</span>
<a href="#l3.309"></a><span id="l3.309" class="difflineminus">-        let feedUrl, folderURI;</span>
<a href="#l3.310"></a><span id="l3.310" class="difflineplus">+        let feedUrl, folder;</span>
<a href="#l3.311"></a><span id="l3.311"> </span>
<a href="#l3.312"></a><span id="l3.312">         if (outline.getAttribute(&quot;type&quot;) == &quot;rss&quot;)</span>
<a href="#l3.313"></a><span id="l3.313">         {</span>
<a href="#l3.314"></a><span id="l3.314">           // A feed outline.</span>
<a href="#l3.315"></a><span id="l3.315">           feedUrl = outline.getAttribute(&quot;xmlUrl&quot;) || outline.getAttribute(&quot;url&quot;);</span>
<a href="#l3.316"></a><span id="l3.316">           if (!feedUrl)</span>
<a href="#l3.317"></a><span id="l3.317">           {</span>
<a href="#l3.318"></a><span id="l3.318">             FeedUtils.log.info(&quot;importOPMLOutlines: skipping, type=rss &lt;outline&gt; &quot; +</span>
<a href="#l3.319"></a><span id="l3.319" class="difflineat">@@ -2674,26 +2648,29 @@ var FeedSubscriptions = {</span>
<a href="#l3.320"></a><span id="l3.320">           {</span>
<a href="#l3.321"></a><span id="l3.321">             FeedUtils.log.info(&quot;importOPMLOutlines: feed already subscribed in account &quot; +</span>
<a href="#l3.322"></a><span id="l3.322">                                rssServer.prettyName + &quot;, url - &quot; + feedUrl);</span>
<a href="#l3.323"></a><span id="l3.323">             break;</span>
<a href="#l3.324"></a><span id="l3.324">           }</span>
<a href="#l3.325"></a><span id="l3.325"> </span>
<a href="#l3.326"></a><span id="l3.326">           if (aParentNode.tagName == &quot;outline&quot; &amp;&amp;</span>
<a href="#l3.327"></a><span id="l3.327">               aParentNode.getAttribute(&quot;type&quot;) != &quot;rss&quot;)</span>
<a href="#l3.328"></a><span id="l3.328" class="difflineplus">+          {</span>
<a href="#l3.329"></a><span id="l3.329">             // Parent is a folder, already created.</span>
<a href="#l3.330"></a><span id="l3.330" class="difflineminus">-            folderURI = feedFolder.URI;</span>
<a href="#l3.331"></a><span id="l3.331" class="difflineplus">+            folder = feedFolder;</span>
<a href="#l3.332"></a><span id="l3.332" class="difflineplus">+          }</span>
<a href="#l3.333"></a><span id="l3.333">           else</span>
<a href="#l3.334"></a><span id="l3.334">           {</span>
<a href="#l3.335"></a><span id="l3.335">             // Parent is not a folder outline, likely the &lt;body&gt; in a flat list.</span>
<a href="#l3.336"></a><span id="l3.336">             // Create feed's folder with feed's name and account rootFolder as</span>
<a href="#l3.337"></a><span id="l3.337">             // parent of feed's folder.</span>
<a href="#l3.338"></a><span id="l3.338">             // NOTE: Assume a type=rss outline must be a leaf and is not a</span>
<a href="#l3.339"></a><span id="l3.339">             // direct parent of another type=rss outline; such a structure</span>
<a href="#l3.340"></a><span id="l3.340">             // may lead to unintended nesting and inaccurate counts.</span>
<a href="#l3.341"></a><span id="l3.341" class="difflineplus">+            folder = rssServer.rootFolder;</span>
<a href="#l3.342"></a><span id="l3.342">           }</span>
<a href="#l3.343"></a><span id="l3.343"> </span>
<a href="#l3.344"></a><span id="l3.344">           // Create the feed.</span>
<a href="#l3.345"></a><span id="l3.345">           let quickMode = outline.hasAttribute(&quot;fz:quickMode&quot;) ?</span>
<a href="#l3.346"></a><span id="l3.346">                             outline.getAttribute(&quot;fz:quickMode&quot;) == &quot;true&quot; :</span>
<a href="#l3.347"></a><span id="l3.347">                             rssServer.getBoolValue(&quot;quickMode&quot;);</span>
<a href="#l3.348"></a><span id="l3.348">           let options = outline.getAttribute(&quot;fz:options&quot;);</span>
<a href="#l3.349"></a><span id="l3.349">           options = options ? JSON.parse(options) : null;</span>
<a href="#l3.350"></a><span id="l3.350" class="difflineat">@@ -2704,36 +2681,34 @@ var FeedSubscriptions = {</span>
<a href="#l3.351"></a><span id="l3.351">             // set (and is obvious) in the subscribe dialog; ensure import</span>
<a href="#l3.352"></a><span id="l3.352">             // doesn't leave mismatches if mismatched in the opml file.</span>
<a href="#l3.353"></a><span id="l3.353">             firstFeedInFolderQuickMode = quickMode;</span>
<a href="#l3.354"></a><span id="l3.354">           else</span>
<a href="#l3.355"></a><span id="l3.355">             quickMode = firstFeedInFolderQuickMode;</span>
<a href="#l3.356"></a><span id="l3.356"> </span>
<a href="#l3.357"></a><span id="l3.357">           let feedProperties = { feedName     : outlineName,</span>
<a href="#l3.358"></a><span id="l3.358">                                  feedLocation : feedUrl,</span>
<a href="#l3.359"></a><span id="l3.359" class="difflineminus">-                                 server       : rssServer,</span>
<a href="#l3.360"></a><span id="l3.360" class="difflineminus">-                                 folderURI    : folderURI,</span>
<a href="#l3.361"></a><span id="l3.361" class="difflineplus">+                                 feedFolder   : folder,</span>
<a href="#l3.362"></a><span id="l3.362">                                  quickMode    : quickMode,</span>
<a href="#l3.363"></a><span id="l3.363">                                  options      : options };</span>
<a href="#l3.364"></a><span id="l3.364"> </span>
<a href="#l3.365"></a><span id="l3.365">           FeedUtils.log.info(&quot;importOPMLOutlines: importing feed: name, url - &quot;+</span>
<a href="#l3.366"></a><span id="l3.366">                              outlineName + &quot;, &quot; + feedUrl);</span>
<a href="#l3.367"></a><span id="l3.367"> </span>
<a href="#l3.368"></a><span id="l3.368">           let feed = win.storeFeed(feedProperties);</span>
<a href="#l3.369"></a><span id="l3.369">           if (outline.hasAttribute(&quot;htmlUrl&quot;))</span>
<a href="#l3.370"></a><span id="l3.370">             feed.link = outline.getAttribute(&quot;htmlUrl&quot;);</span>
<a href="#l3.371"></a><span id="l3.371"> </span>
<a href="#l3.372"></a><span id="l3.372">           feed.createFolder();</span>
<a href="#l3.373"></a><span id="l3.373">           if (!feed.folder)</span>
<a href="#l3.374"></a><span id="l3.374">           {</span>
<a href="#l3.375"></a><span id="l3.375">             // Non success. Remove intermediate traces from the feeds database.</span>
<a href="#l3.376"></a><span id="l3.376">             if (feed &amp;&amp; feed.url &amp;&amp; feed.server)</span>
<a href="#l3.377"></a><span id="l3.377" class="difflineminus">-              FeedUtils.deleteFeed(FeedUtils.rdf.GetResource(feed.url),</span>
<a href="#l3.378"></a><span id="l3.378" class="difflineminus">-                                   feed.server,</span>
<a href="#l3.379"></a><span id="l3.379" class="difflineminus">-                                   feed.server.rootFolder);</span>
<a href="#l3.380"></a><span id="l3.380" class="difflineplus">+              FeedUtils.deleteFeed(feed);</span>
<a href="#l3.381"></a><span id="l3.381" class="difflineplus">+</span>
<a href="#l3.382"></a><span id="l3.382">             FeedUtils.log.info(&quot;importOPMLOutlines: skipping, error creating folder - '&quot; +</span>
<a href="#l3.383"></a><span id="l3.383">                                feed.folderName + &quot;' from outlineName - '&quot; +</span>
<a href="#l3.384"></a><span id="l3.384">                                outlineName + &quot;' in parent folder &quot; +</span>
<a href="#l3.385"></a><span id="l3.385">                                aParentFolder.filePath.path);</span>
<a href="#l3.386"></a><span id="l3.386">             badTag = true;</span>
<a href="#l3.387"></a><span id="l3.387">             break;</span>
<a href="#l3.388"></a><span id="l3.388">           }</span>
<a href="#l3.389"></a><span id="l3.389"> </span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

