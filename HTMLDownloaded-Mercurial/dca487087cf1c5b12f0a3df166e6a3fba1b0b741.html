<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 9687:dca487087cf1c5b12f0a3df166e6a3fba1b0b741</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ dca487087cf1c5b12f0a3df166e6a3fba1b0b741" />
<meta property="og:url" content="/comm-central/rev/dca487087cf1c5b12f0a3df166e6a3fba1b0b741" />
<meta property="og:description" content="Bug 726737 - Convert mailnews/addrbook/test to Services.jsm and MailServices.js. r=mconley" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / dca487087cf1c5b12f0a3df166e6a3fba1b0b741 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/dca487087cf1c5b12f0a3df166e6a3fba1b0b741">shortlog</a> |
<a href="/comm-central/log/dca487087cf1c5b12f0a3df166e6a3fba1b0b741">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/dca487087cf1c5b12f0a3df166e6a3fba1b0b741">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/dca487087cf1c5b12f0a3df166e6a3fba1b0b741">files</a> |
changeset |
<a href="/comm-central/raw-rev/dca487087cf1c5b12f0a3df166e6a3fba1b0b741">raw</a>  | <a href="/comm-central/archive/dca487087cf1c5b12f0a3df166e6a3fba1b0b741.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=726737">Bug 726737</a> - Convert mailnews/addrbook/test to Services.jsm and MailServices.js. r=mconley
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#97;&#99;&#101;&#109;&#97;&#110;&#32;&#60;&#97;&#99;&#101;&#108;&#105;&#115;&#116;&#115;&#64;&#97;&#116;&#108;&#97;&#115;&#46;&#115;&#107;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 19 Mar 2012 18:29:36 -0400</td></tr>

<tr>
 <td>changeset 9687</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/dca487087cf1c5b12f0a3df166e6a3fba1b0b741">dca487087cf1c5b12f0a3df166e6a3fba1b0b741</a></td>
</tr>



<tr>
<td>parent 9686</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/1c51aa83002e69e4cf51785c809fe024bcbbbe1a">1c51aa83002e69e4cf51785c809fe024bcbbbe1a</a>
</td>
</tr>

<tr>
<td>child 9688</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/5fe8af14e49387a4a8c390331138e8ae0e7a18a4">5fe8af14e49387a4a8c390331138e8ae0e7a18a4</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=dca487087cf1c5b12f0a3df166e6a3fba1b0b741">7410</a></td></tr>
<tr><td>push user</td><td>ryanvm@gmail.com</td></tr>
<tr><td>push date</td><td class="date age">Mon, 19 Mar 2012 22:29:42 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@dca487087cf1 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=dca487087cf1c5b12f0a3df166e6a3fba1b0b741">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=dca487087cf1c5b12f0a3df166e6a3fba1b0b741&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=dca487087cf1c5b12f0a3df166e6a3fba1b0b741&newProject=comm-central&newRevision=dca487087cf1c5b12f0a3df166e6a3fba1b0b741&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=dca487087cf1c5b12f0a3df166e6a3fba1b0b741&newProject=comm-central&newRevision=dca487087cf1c5b12f0a3df166e6a3fba1b0b741&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=dca487087cf1c5b12f0a3df166e6a3fba1b0b741&newProject=comm-central&newRevision=dca487087cf1c5b12f0a3df166e6a3fba1b0b741&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mconley%29&revcount=50">mconley</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=726737">726737</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=726737">Bug 726737</a> - Convert mailnews/addrbook/test to Services.jsm and MailServices.js. r=mconley</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_basic_nsIAbCard.js">mailnews/addrbook/test/unit/test_basic_nsIAbCard.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_basic_nsIAbCard.js">file</a> |
<a href="/comm-central/annotate/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_basic_nsIAbCard.js">annotate</a> |
<a href="/comm-central/diff/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_basic_nsIAbCard.js">diff</a> |
<a href="/comm-central/comparison/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_basic_nsIAbCard.js">comparison</a> |
<a href="/comm-central/log/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_basic_nsIAbCard.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_basic_nsIAbDirectory.js">mailnews/addrbook/test/unit/test_basic_nsIAbDirectory.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_basic_nsIAbDirectory.js">file</a> |
<a href="/comm-central/annotate/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_basic_nsIAbDirectory.js">annotate</a> |
<a href="/comm-central/diff/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_basic_nsIAbDirectory.js">diff</a> |
<a href="/comm-central/comparison/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_basic_nsIAbDirectory.js">comparison</a> |
<a href="/comm-central/log/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_basic_nsIAbDirectory.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_bug387403.js">mailnews/addrbook/test/unit/test_bug387403.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_bug387403.js">file</a> |
<a href="/comm-central/annotate/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_bug387403.js">annotate</a> |
<a href="/comm-central/diff/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_bug387403.js">diff</a> |
<a href="/comm-central/comparison/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_bug387403.js">comparison</a> |
<a href="/comm-central/log/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_bug387403.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_bug534822.js">mailnews/addrbook/test/unit/test_bug534822.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_bug534822.js">file</a> |
<a href="/comm-central/annotate/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_bug534822.js">annotate</a> |
<a href="/comm-central/diff/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_bug534822.js">diff</a> |
<a href="/comm-central/comparison/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_bug534822.js">comparison</a> |
<a href="/comm-central/log/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_bug534822.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_bug_448165.js">mailnews/addrbook/test/unit/test_bug_448165.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_bug_448165.js">file</a> |
<a href="/comm-central/annotate/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_bug_448165.js">annotate</a> |
<a href="/comm-central/diff/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_bug_448165.js">diff</a> |
<a href="/comm-central/comparison/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_bug_448165.js">comparison</a> |
<a href="/comm-central/log/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_bug_448165.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_cardForEmail.js">mailnews/addrbook/test/unit/test_cardForEmail.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_cardForEmail.js">file</a> |
<a href="/comm-central/annotate/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_cardForEmail.js">annotate</a> |
<a href="/comm-central/diff/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_cardForEmail.js">diff</a> |
<a href="/comm-central/comparison/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_cardForEmail.js">comparison</a> |
<a href="/comm-central/log/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_cardForEmail.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_collection.js">mailnews/addrbook/test/unit/test_collection.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_collection.js">file</a> |
<a href="/comm-central/annotate/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_collection.js">annotate</a> |
<a href="/comm-central/diff/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_collection.js">diff</a> |
<a href="/comm-central/comparison/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_collection.js">comparison</a> |
<a href="/comm-central/log/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_collection.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_collection_2.js">mailnews/addrbook/test/unit/test_collection_2.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_collection_2.js">file</a> |
<a href="/comm-central/annotate/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_collection_2.js">annotate</a> |
<a href="/comm-central/diff/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_collection_2.js">diff</a> |
<a href="/comm-central/comparison/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_collection_2.js">comparison</a> |
<a href="/comm-central/log/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_collection_2.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_db_enumerator.js">mailnews/addrbook/test/unit/test_db_enumerator.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_db_enumerator.js">file</a> |
<a href="/comm-central/annotate/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_db_enumerator.js">annotate</a> |
<a href="/comm-central/diff/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_db_enumerator.js">diff</a> |
<a href="/comm-central/comparison/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_db_enumerator.js">comparison</a> |
<a href="/comm-central/log/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_db_enumerator.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_ldap1.js">mailnews/addrbook/test/unit/test_ldap1.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_ldap1.js">file</a> |
<a href="/comm-central/annotate/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_ldap1.js">annotate</a> |
<a href="/comm-central/diff/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_ldap1.js">diff</a> |
<a href="/comm-central/comparison/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_ldap1.js">comparison</a> |
<a href="/comm-central/log/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_ldap1.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_ldap2.js">mailnews/addrbook/test/unit/test_ldap2.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_ldap2.js">file</a> |
<a href="/comm-central/annotate/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_ldap2.js">annotate</a> |
<a href="/comm-central/diff/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_ldap2.js">diff</a> |
<a href="/comm-central/comparison/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_ldap2.js">comparison</a> |
<a href="/comm-central/log/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_ldap2.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_ldapOffline.js">mailnews/addrbook/test/unit/test_ldapOffline.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_ldapOffline.js">file</a> |
<a href="/comm-central/annotate/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_ldapOffline.js">annotate</a> |
<a href="/comm-central/diff/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_ldapOffline.js">diff</a> |
<a href="/comm-central/comparison/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_ldapOffline.js">comparison</a> |
<a href="/comm-central/log/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_ldapOffline.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_mailList1.js">mailnews/addrbook/test/unit/test_mailList1.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_mailList1.js">file</a> |
<a href="/comm-central/annotate/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_mailList1.js">annotate</a> |
<a href="/comm-central/diff/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_mailList1.js">diff</a> |
<a href="/comm-central/comparison/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_mailList1.js">comparison</a> |
<a href="/comm-central/log/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_mailList1.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_notifications.js">mailnews/addrbook/test/unit/test_notifications.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_notifications.js">file</a> |
<a href="/comm-central/annotate/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_notifications.js">annotate</a> |
<a href="/comm-central/diff/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_notifications.js">diff</a> |
<a href="/comm-central/comparison/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_notifications.js">comparison</a> |
<a href="/comm-central/log/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_notifications.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_nsAbAutoCompleteMyDomain.js">mailnews/addrbook/test/unit/test_nsAbAutoCompleteMyDomain.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_nsAbAutoCompleteMyDomain.js">file</a> |
<a href="/comm-central/annotate/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_nsAbAutoCompleteMyDomain.js">annotate</a> |
<a href="/comm-central/diff/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_nsAbAutoCompleteMyDomain.js">diff</a> |
<a href="/comm-central/comparison/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_nsAbAutoCompleteMyDomain.js">comparison</a> |
<a href="/comm-central/log/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_nsAbAutoCompleteMyDomain.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch1.js">mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch1.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch1.js">file</a> |
<a href="/comm-central/annotate/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch1.js">annotate</a> |
<a href="/comm-central/diff/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch1.js">diff</a> |
<a href="/comm-central/comparison/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch1.js">comparison</a> |
<a href="/comm-central/log/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch1.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch2.js">mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch2.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch2.js">file</a> |
<a href="/comm-central/annotate/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch2.js">annotate</a> |
<a href="/comm-central/diff/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch2.js">diff</a> |
<a href="/comm-central/comparison/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch2.js">comparison</a> |
<a href="/comm-central/log/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch2.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch3.js">mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch3.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch3.js">file</a> |
<a href="/comm-central/annotate/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch3.js">annotate</a> |
<a href="/comm-central/diff/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch3.js">diff</a> |
<a href="/comm-central/comparison/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch3.js">comparison</a> |
<a href="/comm-central/log/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch3.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch4.js">mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch4.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch4.js">file</a> |
<a href="/comm-central/annotate/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch4.js">annotate</a> |
<a href="/comm-central/diff/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch4.js">diff</a> |
<a href="/comm-central/comparison/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch4.js">comparison</a> |
<a href="/comm-central/log/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch4.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch5.js">mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch5.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch5.js">file</a> |
<a href="/comm-central/annotate/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch5.js">annotate</a> |
<a href="/comm-central/diff/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch5.js">diff</a> |
<a href="/comm-central/comparison/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch5.js">comparison</a> |
<a href="/comm-central/log/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch5.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_nsAbManager1.js">mailnews/addrbook/test/unit/test_nsAbManager1.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_nsAbManager1.js">file</a> |
<a href="/comm-central/annotate/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_nsAbManager1.js">annotate</a> |
<a href="/comm-central/diff/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_nsAbManager1.js">diff</a> |
<a href="/comm-central/comparison/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_nsAbManager1.js">comparison</a> |
<a href="/comm-central/log/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_nsAbManager1.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_nsAbManager2.js">mailnews/addrbook/test/unit/test_nsAbManager2.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_nsAbManager2.js">file</a> |
<a href="/comm-central/annotate/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_nsAbManager2.js">annotate</a> |
<a href="/comm-central/diff/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_nsAbManager2.js">diff</a> |
<a href="/comm-central/comparison/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_nsAbManager2.js">comparison</a> |
<a href="/comm-central/log/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_nsAbManager2.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_nsIAbCard.js">mailnews/addrbook/test/unit/test_nsIAbCard.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_nsIAbCard.js">file</a> |
<a href="/comm-central/annotate/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_nsIAbCard.js">annotate</a> |
<a href="/comm-central/diff/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_nsIAbCard.js">diff</a> |
<a href="/comm-central/comparison/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_nsIAbCard.js">comparison</a> |
<a href="/comm-central/log/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_nsIAbCard.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_uuid.js">mailnews/addrbook/test/unit/test_uuid.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_uuid.js">file</a> |
<a href="/comm-central/annotate/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_uuid.js">annotate</a> |
<a href="/comm-central/diff/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_uuid.js">diff</a> |
<a href="/comm-central/comparison/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_uuid.js">comparison</a> |
<a href="/comm-central/log/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/addrbook/test/unit/test_uuid.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/test/resources/abSetup.js">mailnews/test/resources/abSetup.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/test/resources/abSetup.js">file</a> |
<a href="/comm-central/annotate/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/test/resources/abSetup.js">annotate</a> |
<a href="/comm-central/diff/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/test/resources/abSetup.js">diff</a> |
<a href="/comm-central/comparison/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/test/resources/abSetup.js">comparison</a> |
<a href="/comm-central/log/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/test/resources/abSetup.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/test/resources/mailDirService.js">mailnews/test/resources/mailDirService.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/test/resources/mailDirService.js">file</a> |
<a href="/comm-central/annotate/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/test/resources/mailDirService.js">annotate</a> |
<a href="/comm-central/diff/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/test/resources/mailDirService.js">diff</a> |
<a href="/comm-central/comparison/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/test/resources/mailDirService.js">comparison</a> |
<a href="/comm-central/log/dca487087cf1c5b12f0a3df166e6a3fba1b0b741/mailnews/test/resources/mailDirService.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_basic_nsIAbCard.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_basic_nsIAbCard.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -12,17 +12,17 @@ const kEmailValueLC = &quot;testemail\u00D2@i</span>
<a href="#l1.4"></a><span id="l1.4"> const kEmailValue2 = &quot;test@test.invalid.com&quot;;</span>
<a href="#l1.5"></a><span id="l1.5"> // Email without the @ or anything after it.</span>
<a href="#l1.6"></a><span id="l1.6"> const kEmailReducedValue = &quot;testEmail\u00D2&quot;;</span>
<a href="#l1.7"></a><span id="l1.7"> const kCompanyValue = &quot;Test\u00D0 Company&quot;;</span>
<a href="#l1.8"></a><span id="l1.8"> </span>
<a href="#l1.9"></a><span id="l1.9"> function run_test() {</span>
<a href="#l1.10"></a><span id="l1.10">   // Create a new card</span>
<a href="#l1.11"></a><span id="l1.11">   var card = Components.classes[&quot;@mozilla.org/addressbook/cardproperty;1&quot;]</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-                         .createInstance(Components.interfaces.nsIAbCard);</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+                       .createInstance(Components.interfaces.nsIAbCard);</span>
<a href="#l1.14"></a><span id="l1.14"> </span>
<a href="#l1.15"></a><span id="l1.15">   // Test - Set First, Last and Display Names and Email Address</span>
<a href="#l1.16"></a><span id="l1.16">   // via setProperty, and check correctly saved via their</span>
<a href="#l1.17"></a><span id="l1.17">   // attributes. We're using firstName to check UTF-8 values.</span>
<a href="#l1.18"></a><span id="l1.18">   card.setProperty(&quot;FirstName&quot;, kFNValue);</span>
<a href="#l1.19"></a><span id="l1.19">   card.setProperty(&quot;LastName&quot;, kLNValue);</span>
<a href="#l1.20"></a><span id="l1.20">   card.setProperty(&quot;DisplayName&quot;, kDNValue);</span>
<a href="#l1.21"></a><span id="l1.21">   card.setProperty(&quot;PrimaryEmail&quot;, kEmailValue);</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineat">@@ -86,20 +86,17 @@ function run_test() {</span>
<a href="#l1.23"></a><span id="l1.23">   do_check_eq(card.generateName(2), &quot;&quot;);</span>
<a href="#l1.24"></a><span id="l1.24"> </span>
<a href="#l1.25"></a><span id="l1.25">   // Test - generateNameWithBundle, most of this will have</span>
<a href="#l1.26"></a><span id="l1.26">   // been tested above.</span>
<a href="#l1.27"></a><span id="l1.27"> </span>
<a href="#l1.28"></a><span id="l1.28">   card.firstName = kFNValue;</span>
<a href="#l1.29"></a><span id="l1.29">   card.lastName = kLNValue;</span>
<a href="#l1.30"></a><span id="l1.30"> </span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-  var sbs = Components.classes[&quot;@mozilla.org/intl/stringbundle;1&quot;]</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineminus">-                      .getService(Components.interfaces.nsIStringBundleService);</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineminus">-</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineminus">-  var bundle = sbs.createBundle(&quot;chrome://messenger/locale/addressbook/addressBook.properties&quot;);</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineplus">+  let bundle = Services.strings.createBundle(&quot;chrome://messenger/locale/addressbook/addressBook.properties&quot;);</span>
<a href="#l1.36"></a><span id="l1.36"> </span>
<a href="#l1.37"></a><span id="l1.37">   do_check_eq(card.generateName(1, bundle), kLNValue + &quot;, &quot; + kFNValue);</span>
<a href="#l1.38"></a><span id="l1.38"> </span>
<a href="#l1.39"></a><span id="l1.39">   // Test - generatePhoneticName</span>
<a href="#l1.40"></a><span id="l1.40"> </span>
<a href="#l1.41"></a><span id="l1.41">   card.setProperty(&quot;PhoneticFirstName&quot;, kFNValue);</span>
<a href="#l1.42"></a><span id="l1.42">   card.setProperty(&quot;PhoneticLastName&quot;, kLNValue);</span>
<a href="#l1.43"></a><span id="l1.43">   do_check_eq(card.generatePhoneticName(false), kFNValue + kLNValue);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_basic_nsIAbDirectory.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_basic_nsIAbDirectory.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -22,25 +22,19 @@</span>
<a href="#l2.4"></a><span id="l2.4">  * - copyMailList</span>
<a href="#l2.5"></a><span id="l2.5">  * - createNewDirectory</span>
<a href="#l2.6"></a><span id="l2.6">  * - createDirectoryByURI</span>
<a href="#l2.7"></a><span id="l2.7">  */</span>
<a href="#l2.8"></a><span id="l2.8"> </span>
<a href="#l2.9"></a><span id="l2.9"> // Main function for the this test so we can check both personal and</span>
<a href="#l2.10"></a><span id="l2.10"> // collected books work correctly in an easy manner.</span>
<a href="#l2.11"></a><span id="l2.11"> function check_ab(abConfig) {</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-  var gPref = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-                        .getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-</span>
<a href="#l2.15"></a><span id="l2.15">   // Test - Get the directory</span>
<a href="#l2.16"></a><span id="l2.16"> </span>
<a href="#l2.17"></a><span id="l2.17" class="difflineminus">-  var abManager = Components.classes[&quot;@mozilla.org/abmanager;1&quot;]</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineminus">-                            .getService(Components.interfaces.nsIAbManager);</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineminus">-</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineminus">-  var AB = abManager.getDirectory(abConfig.URI);</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineplus">+  let AB = MailServices.ab.getDirectory(abConfig.URI);</span>
<a href="#l2.22"></a><span id="l2.22"> </span>
<a href="#l2.23"></a><span id="l2.23">   // Test - Is it the right type?</span>
<a href="#l2.24"></a><span id="l2.24"> </span>
<a href="#l2.25"></a><span id="l2.25">   if (abConfig.dirType == 2)</span>
<a href="#l2.26"></a><span id="l2.26">     do_check_true(AB instanceof Components.interfaces.nsIAbMDBDirectory);</span>
<a href="#l2.27"></a><span id="l2.27"> </span>
<a href="#l2.28"></a><span id="l2.28">   // Test - Check attributes</span>
<a href="#l2.29"></a><span id="l2.29"> </span>
<a href="#l2.30"></a><span id="l2.30" class="difflineat">@@ -58,57 +52,57 @@ function check_ab(abConfig) {</span>
<a href="#l2.31"></a><span id="l2.31">   do_check_eq(AB.supportsMailingLists, true);</span>
<a href="#l2.32"></a><span id="l2.32">   do_check_eq(AB.dirPrefId, abConfig.dirPrefID);</span>
<a href="#l2.33"></a><span id="l2.33"> </span>
<a href="#l2.34"></a><span id="l2.34">   // Test - autocomplete enable/disable</span>
<a href="#l2.35"></a><span id="l2.35"> </span>
<a href="#l2.36"></a><span id="l2.36">   // enable is the default</span>
<a href="#l2.37"></a><span id="l2.37">   do_check_eq(AB.useForAutocomplete(&quot;&quot;), true);</span>
<a href="#l2.38"></a><span id="l2.38"> </span>
<a href="#l2.39"></a><span id="l2.39" class="difflineminus">-  gPref.setBoolPref(&quot;mail.enable_autocomplete&quot;, false);</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineplus">+  Services.prefs.setBoolPref(&quot;mail.enable_autocomplete&quot;, false);</span>
<a href="#l2.41"></a><span id="l2.41"> </span>
<a href="#l2.42"></a><span id="l2.42">   do_check_eq(AB.useForAutocomplete(&quot;&quot;), false);</span>
<a href="#l2.43"></a><span id="l2.43"> </span>
<a href="#l2.44"></a><span id="l2.44" class="difflineminus">-  gPref.setBoolPref(&quot;mail.enable_autocomplete&quot;, true);</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineplus">+  Services.prefs.setBoolPref(&quot;mail.enable_autocomplete&quot;, true);</span>
<a href="#l2.46"></a><span id="l2.46"> </span>
<a href="#l2.47"></a><span id="l2.47">   do_check_eq(AB.useForAutocomplete(&quot;&quot;), true);</span>
<a href="#l2.48"></a><span id="l2.48"> </span>
<a href="#l2.49"></a><span id="l2.49">   // Test - check getting default preferences</span>
<a href="#l2.50"></a><span id="l2.50"> </span>
<a href="#l2.51"></a><span id="l2.51">   do_check_eq(AB.getIntValue(&quot;random&quot;, 54321), 54321);</span>
<a href="#l2.52"></a><span id="l2.52">   do_check_eq(AB.getBoolValue(&quot;random&quot;, false), false);</span>
<a href="#l2.53"></a><span id="l2.53">   do_check_eq(AB.getStringValue(&quot;random&quot;, &quot;abc&quot;), &quot;abc&quot;);</span>
<a href="#l2.54"></a><span id="l2.54">   do_check_eq(AB.getLocalizedStringValue(&quot;random&quot;, &quot;xyz&quot;), &quot;xyz&quot;);</span>
<a href="#l2.55"></a><span id="l2.55"> </span>
<a href="#l2.56"></a><span id="l2.56"> </span>
<a href="#l2.57"></a><span id="l2.57">   // Test - check get/set int preferences on nsIAbDirectory</span>
<a href="#l2.58"></a><span id="l2.58"> </span>
<a href="#l2.59"></a><span id="l2.59">   AB.setIntValue(&quot;inttest&quot;, 12345);</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineminus">-  do_check_eq(gPref.getIntPref(abConfig.dirPrefID + &quot;.inttest&quot;), 12345);</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineplus">+  do_check_eq(Services.prefs.getIntPref(abConfig.dirPrefID + &quot;.inttest&quot;), 12345);</span>
<a href="#l2.62"></a><span id="l2.62">   do_check_eq(AB.getIntValue(&quot;inttest&quot;, -1), 12345);</span>
<a href="#l2.63"></a><span id="l2.63"> </span>
<a href="#l2.64"></a><span id="l2.64">   AB.setIntValue(&quot;inttest&quot;, 123456);</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineminus">-  do_check_eq(gPref.getIntPref(abConfig.dirPrefID + &quot;.inttest&quot;), 123456);</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineplus">+  do_check_eq(Services.prefs.getIntPref(abConfig.dirPrefID + &quot;.inttest&quot;), 123456);</span>
<a href="#l2.67"></a><span id="l2.67">   do_check_eq(AB.getIntValue(&quot;inttest&quot;, -2), 123456);</span>
<a href="#l2.68"></a><span id="l2.68"> </span>
<a href="#l2.69"></a><span id="l2.69">   // Test - check get/set bool preferences on nsIAbDirectory</span>
<a href="#l2.70"></a><span id="l2.70"> </span>
<a href="#l2.71"></a><span id="l2.71">   AB.setBoolValue(&quot;booltest&quot;, true);</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineminus">-  do_check_eq(gPref.getBoolPref(abConfig.dirPrefID + &quot;.booltest&quot;), true);</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineplus">+  do_check_eq(Services.prefs.getBoolPref(abConfig.dirPrefID + &quot;.booltest&quot;), true);</span>
<a href="#l2.74"></a><span id="l2.74">   do_check_eq(AB.getBoolValue(&quot;booltest&quot;, false), true);</span>
<a href="#l2.75"></a><span id="l2.75"> </span>
<a href="#l2.76"></a><span id="l2.76">   AB.setBoolValue(&quot;booltest&quot;, false);</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineminus">-  do_check_eq(gPref.getBoolPref(abConfig.dirPrefID + &quot;.booltest&quot;), false);</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineplus">+  do_check_eq(Services.prefs.getBoolPref(abConfig.dirPrefID + &quot;.booltest&quot;), false);</span>
<a href="#l2.79"></a><span id="l2.79">   do_check_eq(AB.getBoolValue(&quot;booltest&quot;, true), false);</span>
<a href="#l2.80"></a><span id="l2.80"> </span>
<a href="#l2.81"></a><span id="l2.81"> </span>
<a href="#l2.82"></a><span id="l2.82">   // Test - check get/set string preferences on nsIAbDirectory</span>
<a href="#l2.83"></a><span id="l2.83"> </span>
<a href="#l2.84"></a><span id="l2.84">   AB.setStringValue(&quot;stringtest&quot;, &quot;tyu&quot;);</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineminus">-  do_check_eq(gPref.getCharPref(abConfig.dirPrefID + &quot;.stringtest&quot;), &quot;tyu&quot;);</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineplus">+  do_check_eq(Services.prefs.getCharPref(abConfig.dirPrefID + &quot;.stringtest&quot;), &quot;tyu&quot;);</span>
<a href="#l2.87"></a><span id="l2.87">   do_check_eq(AB.getStringValue(&quot;stringtest&quot;, &quot;&quot;), &quot;tyu&quot;);</span>
<a href="#l2.88"></a><span id="l2.88"> }</span>
<a href="#l2.89"></a><span id="l2.89"> </span>
<a href="#l2.90"></a><span id="l2.90"> function run_test() {</span>
<a href="#l2.91"></a><span id="l2.91">   // Check the default personal address book</span>
<a href="#l2.92"></a><span id="l2.92">   check_ab(kPABData);</span>
<a href="#l2.93"></a><span id="l2.93"> </span>
<a href="#l2.94"></a><span id="l2.94">   // Check the default collected address book</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_bug387403.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_bug387403.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -1,15 +1,12 @@</span>
<a href="#l3.4"></a><span id="l3.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l3.5"></a><span id="l3.5"> /**</span>
<a href="#l3.6"></a><span id="l3.6">  * Test for bug 387403 crash when opening e-mail with broken vcard.</span>
<a href="#l3.7"></a><span id="l3.7">  */</span>
<a href="#l3.8"></a><span id="l3.8"> </span>
<a href="#l3.9"></a><span id="l3.9"> load(&quot;../../../resources/mailTestUtils.js&quot;);</span>
<a href="#l3.10"></a><span id="l3.10"> </span>
<a href="#l3.11"></a><span id="l3.11"> function run_test() {</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-  var abManager = Components.classes[&quot;@mozilla.org/abmanager;1&quot;]</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-                            .getService(Components.interfaces.nsIAbManager);</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-</span>
<a href="#l3.15"></a><span id="l3.15">   // Before bug 387403 this would hang, eating up all the memory until it</span>
<a href="#l3.16"></a><span id="l3.16">   // crashed.</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineminus">-  abManager.escapedVCardToAbCard(&quot;begin:vcard\nfn;quoted-printable:Xxxx=C5=82xx  Xxx\nn;quoted-printable:Xxx;Xxxx=C5=82xx \nadr;quoted-printable;quoted-printable;dom:;;xx. Xxxxxxxxxxxx X;Xxxxxx=C3=3&quot;);</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+  MailServices.ab.escapedVCardToAbCard(&quot;begin:vcard\nfn;quoted-printable:Xxxx=C5=82xx  Xxx\nn;quoted-printable:Xxx;Xxxx=C5=82xx \nadr;quoted-printable;quoted-printable;dom:;;xx. Xxxxxxxxxxxx X;Xxxxxx=C3=3&quot;);</span>
<a href="#l3.19"></a><span id="l3.19"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_bug534822.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_bug534822.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -8,40 +8,36 @@ function run_test() {</span>
<a href="#l4.4"></a><span id="l4.4">   // Read in the prefs that will be default.</span>
<a href="#l4.5"></a><span id="l4.5">   let specialPrefs = do_get_file(&quot;data/bug534822prefs.js&quot;);</span>
<a href="#l4.6"></a><span id="l4.6"> </span>
<a href="#l4.7"></a><span id="l4.7">   specialPrefs.copyTo(gProfileDir, &quot;&quot;);</span>
<a href="#l4.8"></a><span id="l4.8"> </span>
<a href="#l4.9"></a><span id="l4.9">   specialPrefs = gProfileDir;</span>
<a href="#l4.10"></a><span id="l4.10">   specialPrefs.append(&quot;bug534822prefs.js&quot;);</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-  Cc[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-    .getService(Ci.nsIPrefService)</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">-    .readUserPrefs(specialPrefs);</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+  Services.prefs.readUserPrefs(specialPrefs);</span>
<a href="#l4.16"></a><span id="l4.16"> </span>
<a href="#l4.17"></a><span id="l4.17">   // Now load the ABs and check we've got all of them.</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineminus">-  let dirs = Cc[&quot;@mozilla.org/abmanager;1&quot;]</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineminus">-               .getService(Ci.nsIAbManager)</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineminus">-               .directories;</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+  let dirs = MailServices.ab.directories;</span>
<a href="#l4.22"></a><span id="l4.22"> </span>
<a href="#l4.23"></a><span id="l4.23">   let dir;</span>
<a href="#l4.24"></a><span id="l4.24"> </span>
<a href="#l4.25"></a><span id="l4.25">   let results = [</span>
<a href="#l4.26"></a><span id="l4.26">     { name: &quot;extension&quot;, result: false },</span>
<a href="#l4.27"></a><span id="l4.27">     { name: kPABData.dirName, result: false },</span>
<a href="#l4.28"></a><span id="l4.28">     { name: kCABData.dirName, result: false }</span>
<a href="#l4.29"></a><span id="l4.29">   ];</span>
<a href="#l4.30"></a><span id="l4.30"> </span>
<a href="#l4.31"></a><span id="l4.31">   // Check the OS X Address Book if available</span>
<a href="#l4.32"></a><span id="l4.32">   if (&quot;@mozilla.org/rdf/resource-factory;1?name=moz-abosxdirectory&quot; in Cc)</span>
<a href="#l4.33"></a><span id="l4.33">     results.push({ name: kOSXData.dirName, result: false });</span>
<a href="#l4.34"></a><span id="l4.34"> </span>
<a href="#l4.35"></a><span id="l4.35">   while (dirs.hasMoreElements()) {</span>
<a href="#l4.36"></a><span id="l4.36">     let dir = dirs.getNext().QueryInterface(Ci.nsIAbDirectory);</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineminus">-    </span>
<a href="#l4.38"></a><span id="l4.38" class="difflineplus">+</span>
<a href="#l4.39"></a><span id="l4.39">     for (let i = 0; i &lt; results.length; ++i) {</span>
<a href="#l4.40"></a><span id="l4.40">       if (results[i].name == dir.dirName) {</span>
<a href="#l4.41"></a><span id="l4.41">         do_check_false(results[i].result);</span>
<a href="#l4.42"></a><span id="l4.42">         results[i].result = true;</span>
<a href="#l4.43"></a><span id="l4.43">       }</span>
<a href="#l4.44"></a><span id="l4.44">     }</span>
<a href="#l4.45"></a><span id="l4.45">   }</span>
<a href="#l4.46"></a><span id="l4.46"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_bug_448165.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_bug_448165.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -1,17 +1,15 @@</span>
<a href="#l5.4"></a><span id="l5.4"> /**</span>
<a href="#l5.5"></a><span id="l5.5">  * A simple test to check for a regression of bug 448165: Mailnews crashes in</span>
<a href="#l5.6"></a><span id="l5.6">  * nsAbMDBDirectory::DeleteCards if aCards is null</span>
<a href="#l5.7"></a><span id="l5.7">  */</span>
<a href="#l5.8"></a><span id="l5.8"> function run_test() {</span>
<a href="#l5.9"></a><span id="l5.9" class="difflineminus">-  // get the Address Book Manager service</span>
<a href="#l5.10"></a><span id="l5.10" class="difflineminus">-  var abManager = Cc[&quot;@mozilla.org/abmanager;1&quot;].getService(Ci.nsIAbManager);</span>
<a href="#l5.11"></a><span id="l5.11">   // get the Personal Address Book</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-  var pab = abManager.getDirectory(kPABData.URI);</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+  let pab = MailServices.ab.getDirectory(kPABData.URI);</span>
<a href="#l5.14"></a><span id="l5.14">   do_check_true(pab instanceof Ci.nsIAbDirectory);</span>
<a href="#l5.15"></a><span id="l5.15">   try {</span>
<a href="#l5.16"></a><span id="l5.16">     pab.deleteCards(null); // this should throw an error</span>
<a href="#l5.17"></a><span id="l5.17">     do_throw(&quot;Error, deleteCards should throw an error when null is passed to it&quot;);</span>
<a href="#l5.18"></a><span id="l5.18">   }</span>
<a href="#l5.19"></a><span id="l5.19">   catch (e) {</span>
<a href="#l5.20"></a><span id="l5.20">     // make sure the correct error message was thrown</span>
<a href="#l5.21"></a><span id="l5.21">     do_check_neq(e.toString().indexOf(&quot;NS_ERROR_INVALID_POINTER&quot;), -1);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_cardForEmail.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_cardForEmail.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -21,20 +21,17 @@ function check_correct_card(card) {</span>
<a href="#l6.4"></a><span id="l6.4"> function run_test() {</span>
<a href="#l6.5"></a><span id="l6.5">   // Test setup - copy the data file into place</span>
<a href="#l6.6"></a><span id="l6.6">   var testAB = do_get_file(&quot;data/cardForEmail.mab&quot;);</span>
<a href="#l6.7"></a><span id="l6.7"> </span>
<a href="#l6.8"></a><span id="l6.8">   // Copy the file to the profile directory for a PAB</span>
<a href="#l6.9"></a><span id="l6.9">   testAB.copyTo(gProfileDir, kPABData.fileName);</span>
<a href="#l6.10"></a><span id="l6.10"> </span>
<a href="#l6.11"></a><span id="l6.11">   // Test - Get the directory</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-  var abManager = Components.classes[&quot;@mozilla.org/abmanager;1&quot;]</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-                            .getService(Components.interfaces.nsIAbManager);</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineminus">-  var AB = abManager.getDirectory(kPABData.URI);</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+  let AB = MailServices.ab.getDirectory(kPABData.URI);</span>
<a href="#l6.17"></a><span id="l6.17"> </span>
<a href="#l6.18"></a><span id="l6.18">   // Test - Check that a null string succeeds and does not</span>
<a href="#l6.19"></a><span id="l6.19">   // return a card (bug 404264)</span>
<a href="#l6.20"></a><span id="l6.20">   do_check_true(AB.cardForEmailAddress(null) == null);</span>
<a href="#l6.21"></a><span id="l6.21"> </span>
<a href="#l6.22"></a><span id="l6.22">   // Test - Check that an empty string succeeds and does not</span>
<a href="#l6.23"></a><span id="l6.23">   // return a card (bug 404264)</span>
<a href="#l6.24"></a><span id="l6.24">   do_check_true(AB.cardForEmailAddress(&quot;&quot;) == null);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_collection.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_collection.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -248,30 +248,24 @@ var collectChecker = {</span>
<a href="#l7.4"></a><span id="l7.4">     }</span>
<a href="#l7.5"></a><span id="l7.5">   }</span>
<a href="#l7.6"></a><span id="l7.6"> };</span>
<a href="#l7.7"></a><span id="l7.7"> </span>
<a href="#l7.8"></a><span id="l7.8"> function run_test()</span>
<a href="#l7.9"></a><span id="l7.9"> {</span>
<a href="#l7.10"></a><span id="l7.10">   // Test - Get the address collecter</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-  var prefService = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-                              .getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineminus">-</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineminus">-  var abManager = Components.classes[&quot;@mozilla.org/abmanager;1&quot;]</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineminus">-                            .getService(Components.interfaces.nsIAbManager);</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineminus">-</span>
<a href="#l7.18"></a><span id="l7.18">   // XXX Getting all directories ensures we create all ABs because the</span>
<a href="#l7.19"></a><span id="l7.19">   // address collecter can't currently create ABs itself (bug 314448).</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineminus">-  var temp = abManager.directories;</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineplus">+  MailServices.ab.directories;</span>
<a href="#l7.22"></a><span id="l7.22"> </span>
<a href="#l7.23"></a><span id="l7.23">   // Get the actual AB for the collector so we can check cards have been</span>
<a href="#l7.24"></a><span id="l7.24">   // added.</span>
<a href="#l7.25"></a><span id="l7.25">   collectChecker.AB =</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineminus">-    abManager.getDirectory(prefService.getCharPref(&quot;mail.collect_addressbook&quot;));</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineplus">+    MailServices.ab.getDirectory(Services.prefs.getCharPref(&quot;mail.collect_addressbook&quot;));</span>
<a href="#l7.28"></a><span id="l7.28"> </span>
<a href="#l7.29"></a><span id="l7.29">   // Get the actual collecter</span>
<a href="#l7.30"></a><span id="l7.30">   collectChecker.addressCollect =</span>
<a href="#l7.31"></a><span id="l7.31">     Components.classes[&quot;@mozilla.org/addressbook/services/addressCollector;1&quot;]</span>
<a href="#l7.32"></a><span id="l7.32">               .getService(Components.interfaces.nsIAbAddressCollector);</span>
<a href="#l7.33"></a><span id="l7.33"> </span>
<a href="#l7.34"></a><span id="l7.34">   // Test - Addition of header without email address.</span>
<a href="#l7.35"></a><span id="l7.35"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_collection_2.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_collection_2.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -7,51 +7,45 @@</span>
<a href="#l8.4"></a><span id="l8.4">  */</span>
<a href="#l8.5"></a><span id="l8.5"> </span>
<a href="#l8.6"></a><span id="l8.6"> const nsIAbPMF = Components.interfaces.nsIAbPreferMailFormat;</span>
<a href="#l8.7"></a><span id="l8.7"> </span>
<a href="#l8.8"></a><span id="l8.8"> function run_test()</span>
<a href="#l8.9"></a><span id="l8.9"> {</span>
<a href="#l8.10"></a><span id="l8.10">   // Test - Get the address collecter</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-  var prefService = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-                              .getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineminus">-</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineminus">-  var abManager = Components.classes[&quot;@mozilla.org/abmanager;1&quot;]</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineminus">-                            .getService(Components.interfaces.nsIAbManager);</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineminus">-</span>
<a href="#l8.18"></a><span id="l8.18">   // Get the actual collecter</span>
<a href="#l8.19"></a><span id="l8.19">   var addressCollect =</span>
<a href="#l8.20"></a><span id="l8.20">     Components.classes[&quot;@mozilla.org/addressbook/services/addressCollector;1&quot;]</span>
<a href="#l8.21"></a><span id="l8.21">               .getService(Components.interfaces.nsIAbAddressCollector);</span>
<a href="#l8.22"></a><span id="l8.22"> </span>
<a href="#l8.23"></a><span id="l8.23">   // Set the new pref afterwards to ensure we change correctly</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineminus">-  prefService.setCharPref(&quot;mail.collect_addressbook&quot;, kCABData.URI);</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineplus">+  Services.prefs.setCharPref(&quot;mail.collect_addressbook&quot;, kCABData.URI);</span>
<a href="#l8.26"></a><span id="l8.26"> </span>
<a href="#l8.27"></a><span id="l8.27">   // For this test use an address book that isn't the one we're collecting</span>
<a href="#l8.28"></a><span id="l8.28">   // to.</span>
<a href="#l8.29"></a><span id="l8.29">   var testAB = do_get_file(&quot;data/collect.mab&quot;);</span>
<a href="#l8.30"></a><span id="l8.30"> </span>
<a href="#l8.31"></a><span id="l8.31">   testAB.copyTo(gProfileDir, kPABData.fileName);</span>
<a href="#l8.32"></a><span id="l8.32"> </span>
<a href="#l8.33"></a><span id="l8.33">   // XXX Getting all directories ensures we create all ABs because the</span>
<a href="#l8.34"></a><span id="l8.34">   // address collecter can't currently create ABs itself (bug 314448).</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineminus">-  var temp = abManager.directories;</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineplus">+  MailServices.ab.directories;</span>
<a href="#l8.37"></a><span id="l8.37"> </span>
<a href="#l8.38"></a><span id="l8.38">   addressCollect.collectAddress(&quot;Other Book &lt;other@book.invalid&gt;&quot;, true,</span>
<a href="#l8.39"></a><span id="l8.39">                                 nsIAbPMF.unknown);</span>
<a href="#l8.40"></a><span id="l8.40"> </span>
<a href="#l8.41"></a><span id="l8.41" class="difflineminus">-  var PAB = abManager.getDirectory(kPABData.URI);</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineplus">+  let PAB = MailServices.ab.getDirectory(kPABData.URI);</span>
<a href="#l8.43"></a><span id="l8.43"> </span>
<a href="#l8.44"></a><span id="l8.44">   var childCards = PAB.childCards;</span>
<a href="#l8.45"></a><span id="l8.45"> </span>
<a href="#l8.46"></a><span id="l8.46">   do_check_true(childCards.hasMoreElements());</span>
<a href="#l8.47"></a><span id="l8.47"> </span>
<a href="#l8.48"></a><span id="l8.48">   var card = childCards.getNext().QueryInterface(Components.interfaces.nsIAbCard);</span>
<a href="#l8.49"></a><span id="l8.49"> </span>
<a href="#l8.50"></a><span id="l8.50">   do_check_eq(card.displayName, &quot;Other Book&quot;);</span>
<a href="#l8.51"></a><span id="l8.51">   do_check_eq(card.primaryEmail, &quot;other@book.invalid&quot;);</span>
<a href="#l8.52"></a><span id="l8.52"> </span>
<a href="#l8.53"></a><span id="l8.53">   // Check the CAB has no cards.</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineminus">-  var CAB = abManager.getDirectory(kCABData.URI);</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineplus">+  let CAB = MailServices.ab.getDirectory(kCABData.URI);</span>
<a href="#l8.56"></a><span id="l8.56"> </span>
<a href="#l8.57"></a><span id="l8.57">   do_check_false(CAB.childCards.hasMoreElements());</span>
<a href="#l8.58"></a><span id="l8.58"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_db_enumerator.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_db_enumerator.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -1,34 +1,33 @@</span>
<a href="#l9.4"></a><span id="l9.4"> /**</span>
<a href="#l9.5"></a><span id="l9.5">  * This test verifies that we don't crash if we have an enumerator on an</span>
<a href="#l9.6"></a><span id="l9.6">  * addr database and delete the underlying directory, which forces the ab</span>
<a href="#l9.7"></a><span id="l9.7">  * closed.</span>
<a href="#l9.8"></a><span id="l9.8">  */</span>
<a href="#l9.9"></a><span id="l9.9" class="difflineminus">-var abm             = Cc[&quot;@mozilla.org/abmanager;1&quot;].getService(Ci.nsIAbManager);</span>
<a href="#l9.10"></a><span id="l9.10"> var ab_prefix       = &quot;test-537815-&quot;;</span>
<a href="#l9.11"></a><span id="l9.11"> var re_prefix       = new RegExp(ab_prefix)</span>
<a href="#l9.12"></a><span id="l9.12"> var card_properties = { FirstName: &quot;01-first-3&quot;, LastName: &quot;02-last&quot;, PrimaryEmail: &quot;08-email-1@zindus.com&quot; };</span>
<a href="#l9.13"></a><span id="l9.13"> var max_addressbooks = 10;</span>
<a href="#l9.14"></a><span id="l9.14"> </span>
<a href="#l9.15"></a><span id="l9.15"> function bug_537815_fixture_setup()</span>
<a href="#l9.16"></a><span id="l9.16"> {</span>
<a href="#l9.17"></a><span id="l9.17">   let i, key;</span>
<a href="#l9.18"></a><span id="l9.18"> </span>
<a href="#l9.19"></a><span id="l9.19">   for (i = 1; i &lt;= max_addressbooks; i++) {</span>
<a href="#l9.20"></a><span id="l9.20">     let ab_name = ab_prefix + i;</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineminus">-    abm.newAddressBook(ab_name, &quot;&quot;, 2);</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineplus">+    MailServices.ab.newAddressBook(ab_name, &quot;&quot;, 2);</span>
<a href="#l9.23"></a><span id="l9.23">     dump(&quot;created: &quot; + ab_name + &quot;\n&quot;);</span>
<a href="#l9.24"></a><span id="l9.24"> </span>
<a href="#l9.25"></a><span id="l9.25">     for (var j = 1; j &lt; 2; j++) {</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineminus">-      let enm_dirs = abm.directories;</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineplus">+      let enm_dirs = MailServices.ab.directories;</span>
<a href="#l9.28"></a><span id="l9.28">       while (enm_dirs.hasMoreElements()) {</span>
<a href="#l9.29"></a><span id="l9.29">         let elem = enm_dirs.getNext().QueryInterface(Ci.nsIAbDirectory);</span>
<a href="#l9.30"></a><span id="l9.30">         let uri = elem.URI;</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineminus">-        let dir = abm.getDirectory(uri);</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineplus">+        let dir = MailServices.ab.getDirectory(uri);</span>
<a href="#l9.33"></a><span id="l9.33"> </span>
<a href="#l9.34"></a><span id="l9.34">         dump(&quot;considering: j: &quot; + j + &quot; &quot; + elem.dirName + &quot;\n&quot;);</span>
<a href="#l9.35"></a><span id="l9.35"> </span>
<a href="#l9.36"></a><span id="l9.36">         if (j == 1 &amp;&amp; String(elem.dirName).match(re_prefix)) {</span>
<a href="#l9.37"></a><span id="l9.37">           for (i = 1; i &lt;= 1000; i++) {</span>
<a href="#l9.38"></a><span id="l9.38">             let abCard = Cc[&quot;@mozilla.org/addressbook/cardproperty;1&quot;].createInstance().QueryInterface(Ci.nsIAbCard);</span>
<a href="#l9.39"></a><span id="l9.39"> </span>
<a href="#l9.40"></a><span id="l9.40">             for (key in card_properties)</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineat">@@ -40,23 +39,23 @@ function bug_537815_fixture_setup()</span>
<a href="#l9.42"></a><span id="l9.42">         }</span>
<a href="#l9.43"></a><span id="l9.43">       }</span>
<a href="#l9.44"></a><span id="l9.44">     }</span>
<a href="#l9.45"></a><span id="l9.45">   }</span>
<a href="#l9.46"></a><span id="l9.46"> }</span>
<a href="#l9.47"></a><span id="l9.47"> </span>
<a href="#l9.48"></a><span id="l9.48"> function bug_537815_test()</span>
<a href="#l9.49"></a><span id="l9.49"> {</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineminus">-  let enm_dirs = abm.directories;</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineplus">+  let enm_dirs = MailServices.ab.directories;</span>
<a href="#l9.52"></a><span id="l9.52">   let i, key;</span>
<a href="#l9.53"></a><span id="l9.53"> </span>
<a href="#l9.54"></a><span id="l9.54">   while (enm_dirs.hasMoreElements()) {</span>
<a href="#l9.55"></a><span id="l9.55">     let elem = enm_dirs.getNext().QueryInterface(Ci.nsIAbDirectory);</span>
<a href="#l9.56"></a><span id="l9.56">     let uri  = elem.URI;</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineminus">-    let dir  = abm.getDirectory(uri);</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineplus">+    let dir  = MailServices.ab.getDirectory(uri);</span>
<a href="#l9.59"></a><span id="l9.59"> </span>
<a href="#l9.60"></a><span id="l9.60">     if (String(elem.dirName).match(re_prefix)) {</span>
<a href="#l9.61"></a><span id="l9.61">       let enm_cards = dir.childCards;</span>
<a href="#l9.62"></a><span id="l9.62"> </span>
<a href="#l9.63"></a><span id="l9.63">       while (enm_cards.hasMoreElements()) {</span>
<a href="#l9.64"></a><span id="l9.64">         let item = enm_cards.getNext();</span>
<a href="#l9.65"></a><span id="l9.65">         let abCard = item.QueryInterface(Ci.nsIAbCard);</span>
<a href="#l9.66"></a><span id="l9.66"> </span>
<a href="#l9.67"></a><span id="l9.67" class="difflineat">@@ -73,28 +72,28 @@ function test_bug_537815()</span>
<a href="#l9.68"></a><span id="l9.68"> {</span>
<a href="#l9.69"></a><span id="l9.69">   bug_537815_fixture_setup();</span>
<a href="#l9.70"></a><span id="l9.70">   bug_537815_test();</span>
<a href="#l9.71"></a><span id="l9.71">   bug_537815_fixture_tear_down();</span>
<a href="#l9.72"></a><span id="l9.72"> }</span>
<a href="#l9.73"></a><span id="l9.73"> </span>
<a href="#l9.74"></a><span id="l9.74"> function bug_537815_fixture_tear_down()</span>
<a href="#l9.75"></a><span id="l9.75"> {</span>
<a href="#l9.76"></a><span id="l9.76" class="difflineminus">-  let enm_dirs = abm.directories;</span>
<a href="#l9.77"></a><span id="l9.77" class="difflineplus">+  let enm_dirs = MailServices.ab.directories;</span>
<a href="#l9.78"></a><span id="l9.78">   let a_uri = {};</span>
<a href="#l9.79"></a><span id="l9.79"> </span>
<a href="#l9.80"></a><span id="l9.80">   while (enm_dirs.hasMoreElements()) {</span>
<a href="#l9.81"></a><span id="l9.81">     let elem = enm_dirs.getNext().QueryInterface(Ci.nsIAbDirectory);</span>
<a href="#l9.82"></a><span id="l9.82"> </span>
<a href="#l9.83"></a><span id="l9.83">     if (String(elem.dirName).match(re_prefix)) {</span>
<a href="#l9.84"></a><span id="l9.84">       a_uri[elem.URI] = true;</span>
<a href="#l9.85"></a><span id="l9.85">       dump(&quot;to be deleted: &quot; + elem.dirName + &quot;\n&quot;);</span>
<a href="#l9.86"></a><span id="l9.86">     }</span>
<a href="#l9.87"></a><span id="l9.87">   }</span>
<a href="#l9.88"></a><span id="l9.88"> </span>
<a href="#l9.89"></a><span id="l9.89">   for (let uri in a_uri)</span>
<a href="#l9.90"></a><span id="l9.90" class="difflineminus">-    abm.deleteAddressBook(uri);</span>
<a href="#l9.91"></a><span id="l9.91" class="difflineplus">+    MailServices.ab.deleteAddressBook(uri);</span>
<a href="#l9.92"></a><span id="l9.92"> }</span>
<a href="#l9.93"></a><span id="l9.93"> </span>
<a href="#l9.94"></a><span id="l9.94"> function run_test()</span>
<a href="#l9.95"></a><span id="l9.95"> {</span>
<a href="#l9.96"></a><span id="l9.96">   test_bug_537815();</span>
<a href="#l9.97"></a><span id="l9.97"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_ldap1.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_ldap1.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -9,48 +9,36 @@ const kLDAPTestSpec = &quot;ldap://invalidhos</span>
<a href="#l10.4"></a><span id="l10.4"> </span>
<a href="#l10.5"></a><span id="l10.5"> function run_test() {</span>
<a href="#l10.6"></a><span id="l10.6">   // If nsIAbLDAPDirectory doesn't exist in our build options, someone has</span>
<a href="#l10.7"></a><span id="l10.7">   // specified --disable-ldap</span>
<a href="#l10.8"></a><span id="l10.8">   if (!(&quot;nsIAbLDAPDirectory&quot; in Components.interfaces))</span>
<a href="#l10.9"></a><span id="l10.9">     return;</span>
<a href="#l10.10"></a><span id="l10.10"> </span>
<a href="#l10.11"></a><span id="l10.11">   // Test - Create an LDAP directory</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-  var abManager = Components.classes[&quot;@mozilla.org/abmanager;1&quot;]</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-                            .getService(Components.interfaces.nsIAbManager);</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineminus">-</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineminus">-  var abUri = abManager.newAddressBook(&quot;test&quot;, kLDAPTestSpec, kLDAPDirectory);</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+  let abUri = MailServices.ab.newAddressBook(&quot;test&quot;, kLDAPTestSpec, kLDAPDirectory);</span>
<a href="#l10.17"></a><span id="l10.17"> </span>
<a href="#l10.18"></a><span id="l10.18">   // Test - Check we have the directory.</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineminus">-  var abDir = abManager.getDirectory(kLDAPUriPrefix + abUri)</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineminus">-                       .QueryInterface(Components.interfaces.nsIAbLDAPDirectory);</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineplus">+  let abDir = MailServices.ab.getDirectory(kLDAPUriPrefix + abUri)</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineplus">+                             .QueryInterface(Components.interfaces.nsIAbLDAPDirectory);</span>
<a href="#l10.23"></a><span id="l10.23"> </span>
<a href="#l10.24"></a><span id="l10.24">   // Test - Check various fields</span>
<a href="#l10.25"></a><span id="l10.25">   do_check_eq(abDir.dirName, &quot;test&quot;);</span>
<a href="#l10.26"></a><span id="l10.26">   do_check_eq(abDir.lDAPURL.spec, kLDAPTestSpec);</span>
<a href="#l10.27"></a><span id="l10.27">   do_check_true(abDir.readOnly);</span>
<a href="#l10.28"></a><span id="l10.28"> </span>
<a href="#l10.29"></a><span id="l10.29">   // Test - Write a UTF-8 Auth DN and check it</span>
<a href="#l10.30"></a><span id="l10.30">   abDir.authDn = &quot;test\u00D0&quot;;</span>
<a href="#l10.31"></a><span id="l10.31"> </span>
<a href="#l10.32"></a><span id="l10.32">   do_check_eq(abDir.authDn, &quot;test\u00D0&quot;);</span>
<a href="#l10.33"></a><span id="l10.33"> </span>
<a href="#l10.34"></a><span id="l10.34">   // Test - searchDuringLocalAutocomplete</span>
<a href="#l10.35"></a><span id="l10.35"> </span>
<a href="#l10.36"></a><span id="l10.36" class="difflineminus">-  var prefs = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineminus">-                        .getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineminus">-</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineminus">-  var ioService = Cc[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineminus">-                    .getService(Ci.nsIIOService);</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineminus">-</span>
<a href="#l10.42"></a><span id="l10.42">   // Set up an account and identity in the account manager</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineminus">-  var acctMgr = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineminus">-                  .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineminus">-</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineminus">-  var identity = acctMgr.createIdentity();</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineplus">+  let identity = MailServices.accounts.createIdentity();</span>
<a href="#l10.48"></a><span id="l10.48"> </span>
<a href="#l10.49"></a><span id="l10.49">   const localAcTests =</span>
<a href="#l10.50"></a><span id="l10.50">     [</span>
<a href="#l10.51"></a><span id="l10.51">      // Online checks</span>
<a href="#l10.52"></a><span id="l10.52">      { useDir: false, dirSer: &quot;&quot;,</span>
<a href="#l10.53"></a><span id="l10.53">        idOver: false, idSer: &quot;&quot;, idKey: &quot;&quot;,</span>
<a href="#l10.54"></a><span id="l10.54">        offline: false, result: false },</span>
<a href="#l10.55"></a><span id="l10.55">      { useDir: true, dirSer: abDir.dirPrefId,</span>
<a href="#l10.56"></a><span id="l10.56" class="difflineat">@@ -95,19 +83,19 @@ function run_test() {</span>
<a href="#l10.57"></a><span id="l10.57">        offline: true, result: true },</span>
<a href="#l10.58"></a><span id="l10.58">      { useDir: true, dirSer: abDir.dirPrefId,</span>
<a href="#l10.59"></a><span id="l10.59">        idOver: true, idSer: kPABData.dirPrefID, idKey: identity.key,</span>
<a href="#l10.60"></a><span id="l10.60">        offline: true, result: false }</span>
<a href="#l10.61"></a><span id="l10.61">      ];</span>
<a href="#l10.62"></a><span id="l10.62"> </span>
<a href="#l10.63"></a><span id="l10.63">   function checkAc(element, index, array) {</span>
<a href="#l10.64"></a><span id="l10.64">     dump(&quot;Testing index &quot; + index + &quot;\n&quot;);</span>
<a href="#l10.65"></a><span id="l10.65" class="difflineminus">-    prefs.setBoolPref(&quot;ldap_2.autoComplete.useDirectory&quot;, element.useDir);</span>
<a href="#l10.66"></a><span id="l10.66" class="difflineminus">-    prefs.setCharPref(&quot;ldap_2.autoComplete.directoryServer&quot;, element.dirSer);</span>
<a href="#l10.67"></a><span id="l10.67" class="difflineplus">+    Services.prefs.setBoolPref(&quot;ldap_2.autoComplete.useDirectory&quot;, element.useDir);</span>
<a href="#l10.68"></a><span id="l10.68" class="difflineplus">+    Services.prefs.setCharPref(&quot;ldap_2.autoComplete.directoryServer&quot;, element.dirSer);</span>
<a href="#l10.69"></a><span id="l10.69">     identity.overrideGlobalPref = element.idOver;</span>
<a href="#l10.70"></a><span id="l10.70">     identity.directoryServer = element.idSer;</span>
<a href="#l10.71"></a><span id="l10.71" class="difflineminus">-    ioService.offline = element.offline;</span>
<a href="#l10.72"></a><span id="l10.72" class="difflineplus">+    Services.io.offline = element.offline;</span>
<a href="#l10.73"></a><span id="l10.73"> </span>
<a href="#l10.74"></a><span id="l10.74">     do_check_eq(abDir.useForAutocomplete(element.idKey), element.result);</span>
<a href="#l10.75"></a><span id="l10.75">   }</span>
<a href="#l10.76"></a><span id="l10.76"> </span>
<a href="#l10.77"></a><span id="l10.77">   localAcTests.forEach(checkAc);</span>
<a href="#l10.78"></a><span id="l10.78"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_ldap2.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_ldap2.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -10,27 +10,25 @@ const kLDAPTestSpec = &quot;ldap://invalidhos</span>
<a href="#l11.4"></a><span id="l11.4"> </span>
<a href="#l11.5"></a><span id="l11.5"> function run_test() {</span>
<a href="#l11.6"></a><span id="l11.6">   // If nsIAbLDAPDirectory doesn't exist in our build options, someone has</span>
<a href="#l11.7"></a><span id="l11.7">   // specified --disable-ldap</span>
<a href="#l11.8"></a><span id="l11.8">   if (!(&quot;nsIAbLDAPDirectory&quot; in Components.interfaces))</span>
<a href="#l11.9"></a><span id="l11.9">     return;</span>
<a href="#l11.10"></a><span id="l11.10"> </span>
<a href="#l11.11"></a><span id="l11.11">   // Test - Create an LDAP directory</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-  var abManager = Components.classes[&quot;@mozilla.org/abmanager;1&quot;]</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-                            .getService(Components.interfaces.nsIAbManager);</span>
<a href="#l11.14"></a><span id="l11.14"> </span>
<a href="#l11.15"></a><span id="l11.15">   // Use a UTF-8 based directory name</span>
<a href="#l11.16"></a><span id="l11.16">   var abUri =</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineminus">-    abManager.newAddressBook(&quot;\u041C\u0435\u043B\u0435\u043D\u043A\u0438&quot;,</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineminus">-                             kLDAPTestSpec, kLDAPDirectory);</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineplus">+    MailServices.ab.newAddressBook(&quot;\u041C\u0435\u043B\u0435\u043D\u043A\u0438&quot;,</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineplus">+                                   kLDAPTestSpec, kLDAPDirectory);</span>
<a href="#l11.21"></a><span id="l11.21"> </span>
<a href="#l11.22"></a><span id="l11.22">   // Test - Check we have the directory.</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineminus">-  var abDir = abManager.getDirectory(kLDAPUriPrefix + abUri)</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineminus">-                       .QueryInterface(Components.interfaces.nsIAbLDAPDirectory);</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineplus">+  let abDir = MailServices.ab.getDirectory(kLDAPUriPrefix + abUri)</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineplus">+                             .QueryInterface(Components.interfaces.nsIAbLDAPDirectory);</span>
<a href="#l11.27"></a><span id="l11.27"> </span>
<a href="#l11.28"></a><span id="l11.28">   // Test - Check various fields</span>
<a href="#l11.29"></a><span id="l11.29">   do_check_eq(abDir.dirName, &quot;\u041C\u0435\u043B\u0435\u043D\u043A\u0438&quot;);</span>
<a href="#l11.30"></a><span id="l11.30">   do_check_eq(abDir.lDAPURL.spec, kLDAPTestSpec);</span>
<a href="#l11.31"></a><span id="l11.31">   do_check_true(abDir.readOnly);</span>
<a href="#l11.32"></a><span id="l11.32"> </span>
<a href="#l11.33"></a><span id="l11.33">   // XXX I'd really like a better check than this, to check that searching</span>
<a href="#l11.34"></a><span id="l11.34">   // works correctly. However we haven't got the support for that at the moment</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_ldapOffline.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_ldapOffline.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -1,17 +1,14 @@</span>
<a href="#l12.4"></a><span id="l12.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l12.5"></a><span id="l12.5"> /*</span>
<a href="#l12.6"></a><span id="l12.6">  * Test suite to check that we correctly get child cards for LDAP directories</span>
<a href="#l12.7"></a><span id="l12.7">  * when offline and that we don't crash.</span>
<a href="#l12.8"></a><span id="l12.8">  */</span>
<a href="#l12.9"></a><span id="l12.9"> </span>
<a href="#l12.10"></a><span id="l12.10" class="difflineminus">-Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l12.11"></a><span id="l12.11" class="difflineminus">-Components.utils.import(&quot;resource://gre/modules/mailServices.js&quot;);</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-</span>
<a href="#l12.13"></a><span id="l12.13"> const kLDAPDirectory = 0; // defined in nsDirPrefs.h</span>
<a href="#l12.14"></a><span id="l12.14"> const kLDAPUriPrefix = &quot;moz-abldapdirectory://&quot;;</span>
<a href="#l12.15"></a><span id="l12.15"> const kLDAPTestSpec = &quot;ldap://invalidhost//dc=intranet??sub?(objectclass=*)&quot;;</span>
<a href="#l12.16"></a><span id="l12.16"> </span>
<a href="#l12.17"></a><span id="l12.17"> // Main function for the this test so we can check both personal and</span>
<a href="#l12.18"></a><span id="l12.18"> // collected books work correctly in an easy manner.</span>
<a href="#l12.19"></a><span id="l12.19"> function run_test() {</span>
<a href="#l12.20"></a><span id="l12.20">   // If nsIAbLDAPDirectory doesn't exist in our build options, someone has</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_mailList1.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_mailList1.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -34,24 +34,21 @@ function run_test() {</span>
<a href="#l13.4"></a><span id="l13.4">   // Test setup - copy the data file into place</span>
<a href="#l13.5"></a><span id="l13.5">   var testAB = do_get_file(&quot;../../../data/abLists1.mab&quot;);</span>
<a href="#l13.6"></a><span id="l13.6"> </span>
<a href="#l13.7"></a><span id="l13.7">   // Copy the file to the profile directory for a PAB</span>
<a href="#l13.8"></a><span id="l13.8">   testAB.copyTo(gProfileDir, kPABData.fileName);</span>
<a href="#l13.9"></a><span id="l13.9"> </span>
<a href="#l13.10"></a><span id="l13.10">   // Test - Get the directory.</span>
<a href="#l13.11"></a><span id="l13.11"> </span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-  var abManager = Components.classes[&quot;@mozilla.org/abmanager;1&quot;]</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineminus">-                            .getService(Components.interfaces.nsIAbManager);</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineminus">-</span>
<a href="#l13.15"></a><span id="l13.15">   // XXX Getting all directories ensures we create all ABs because mailing</span>
<a href="#l13.16"></a><span id="l13.16">   // lists need help initialising themselves</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineminus">-  var temp = abManager.directories;</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineplus">+  MailServices.ab.directories;</span>
<a href="#l13.19"></a><span id="l13.19"> </span>
<a href="#l13.20"></a><span id="l13.20" class="difflineminus">-  var AB = abManager.getDirectory(kPABData.URI);</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineplus">+  let AB = MailServices.ab.getDirectory(kPABData.URI);</span>
<a href="#l13.22"></a><span id="l13.22"> </span>
<a href="#l13.23"></a><span id="l13.23">   // Test - Check all the expected mailing lists exist.</span>
<a href="#l13.24"></a><span id="l13.24"> </span>
<a href="#l13.25"></a><span id="l13.25">   // There are three lists in abLists.mab by default.</span>
<a href="#l13.26"></a><span id="l13.26">   checkLists(AB.childNodes, 3);</span>
<a href="#l13.27"></a><span id="l13.27"> </span>
<a href="#l13.28"></a><span id="l13.28">   // Test - Add a new list.</span>
<a href="#l13.29"></a><span id="l13.29"> </span>
<a href="#l13.30"></a><span id="l13.30" class="difflineat">@@ -65,15 +62,15 @@ function run_test() {</span>
<a href="#l13.31"></a><span id="l13.31"> </span>
<a href="#l13.32"></a><span id="l13.32">   AB.addMailList(mailList);</span>
<a href="#l13.33"></a><span id="l13.33"> </span>
<a href="#l13.34"></a><span id="l13.34">   // check them</span>
<a href="#l13.35"></a><span id="l13.35">   checkLists(AB.childNodes, 4);</span>
<a href="#l13.36"></a><span id="l13.36"> </span>
<a href="#l13.37"></a><span id="l13.37">   // Test - Remove a list.</span>
<a href="#l13.38"></a><span id="l13.38"> </span>
<a href="#l13.39"></a><span id="l13.39" class="difflineminus">-  mailList = abManager.getDirectory(kPABData.URI + &quot;/MailList4&quot;);</span>
<a href="#l13.40"></a><span id="l13.40" class="difflineplus">+  mailList = MailServices.ab.getDirectory(kPABData.URI + &quot;/MailList4&quot;);</span>
<a href="#l13.41"></a><span id="l13.41"> </span>
<a href="#l13.42"></a><span id="l13.42">   AB.deleteDirectory(mailList);</span>
<a href="#l13.43"></a><span id="l13.43"> </span>
<a href="#l13.44"></a><span id="l13.44">   // check them</span>
<a href="#l13.45"></a><span id="l13.45">   checkLists(AB.childNodes, 3);</span>
<a href="#l13.46"></a><span id="l13.46"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_notifications.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_notifications.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -23,37 +23,34 @@ var abListener = {</span>
<a href="#l14.4"></a><span id="l14.4">     do_check_true(this.result.length &lt; this.maxResults);</span>
<a href="#l14.5"></a><span id="l14.5">     this.result.push([&quot;onItemPropertyChanged&quot;, item, property, oldValue, newValue]);</span>
<a href="#l14.6"></a><span id="l14.6">   }</span>
<a href="#l14.7"></a><span id="l14.7"> };</span>
<a href="#l14.8"></a><span id="l14.8"> </span>
<a href="#l14.9"></a><span id="l14.9"> function run_test() {</span>
<a href="#l14.10"></a><span id="l14.10">   var i;</span>
<a href="#l14.11"></a><span id="l14.11"> </span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-  var abManager = Cc[&quot;@mozilla.org/abmanager;1&quot;]</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineminus">-                    .getService(Ci.nsIAbManager);</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineminus">-</span>
<a href="#l14.15"></a><span id="l14.15">   // XXX Getting all directories ensures we create all ABs because the</span>
<a href="#l14.16"></a><span id="l14.16">   // address collecter can't currently create ABs itself (bug 314448).</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineminus">-  abManager.directories;</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineplus">+  MailServices.ab.directories;</span>
<a href="#l14.19"></a><span id="l14.19"> </span>
<a href="#l14.20"></a><span id="l14.20">   // Add a listener</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineminus">-  abManager.addAddressBookListener(abListener, Ci.nsIAbListener.all);</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineplus">+  MailServices.ab.addAddressBookListener(abListener, Ci.nsIAbListener.all);</span>
<a href="#l14.23"></a><span id="l14.23"> </span>
<a href="#l14.24"></a><span id="l14.24">   // Get the directory</span>
<a href="#l14.25"></a><span id="l14.25" class="difflineminus">-  var AB = abManager.getDirectory(kPABData.URI);</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineplus">+  let AB = MailServices.ab.getDirectory(kPABData.URI);</span>
<a href="#l14.27"></a><span id="l14.27"> </span>
<a href="#l14.28"></a><span id="l14.28">   // For card tests, the most we expect is one notification.</span>
<a href="#l14.29"></a><span id="l14.29">   abListener.maxResults = 1;</span>
<a href="#l14.30"></a><span id="l14.30"> </span>
<a href="#l14.31"></a><span id="l14.31">   // Test - add a card</span>
<a href="#l14.32"></a><span id="l14.32"> </span>
<a href="#l14.33"></a><span id="l14.33">   var card = Cc[&quot;@mozilla.org/addressbook/cardproperty;1&quot;]</span>
<a href="#l14.34"></a><span id="l14.34">                .createInstance(Ci.nsIAbCard);</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineminus">-  </span>
<a href="#l14.36"></a><span id="l14.36" class="difflineplus">+</span>
<a href="#l14.37"></a><span id="l14.37">   card.firstName = &quot;test&quot;;</span>
<a href="#l14.38"></a><span id="l14.38">   card.primaryEmail = &quot;test@invalid.com&quot;;</span>
<a href="#l14.39"></a><span id="l14.39"> </span>
<a href="#l14.40"></a><span id="l14.40">   var newCard = AB.addCard(card);</span>
<a href="#l14.41"></a><span id="l14.41"> </span>
<a href="#l14.42"></a><span id="l14.42">   do_check_true(newCard instanceof Ci.nsIAbCard);</span>
<a href="#l14.43"></a><span id="l14.43">   do_check_eq(abListener.result[0][0], &quot;onItemAdded&quot;);</span>
<a href="#l14.44"></a><span id="l14.44">   do_check_eq(abListener.result[0][1], AB);</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineat">@@ -146,10 +143,10 @@ function run_test() {</span>
<a href="#l14.46"></a><span id="l14.46">   var book = abListener.result[1][2].QueryInterface(Ci.nsIAbDirectory);</span>
<a href="#l14.47"></a><span id="l14.47">   do_check_true(book.isMailList);</span>
<a href="#l14.48"></a><span id="l14.48">   do_check_eq(book.dirName, &quot;TestList&quot;);</span>
<a href="#l14.49"></a><span id="l14.49">   do_check_eq(book.listNickName, &quot;test&quot;);</span>
<a href="#l14.50"></a><span id="l14.50">   do_check_eq(book.description, &quot;testdescription&quot;);</span>
<a href="#l14.51"></a><span id="l14.51"> </span>
<a href="#l14.52"></a><span id="l14.52">   // Remove listener</span>
<a href="#l14.53"></a><span id="l14.53"> </span>
<a href="#l14.54"></a><span id="l14.54" class="difflineminus">-  abManager.removeAddressBookListener(abListener);</span>
<a href="#l14.55"></a><span id="l14.55" class="difflineplus">+  MailServices.ab.removeAddressBookListener(abListener);</span>
<a href="#l14.56"></a><span id="l14.56"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_nsAbAutoCompleteMyDomain.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_nsAbAutoCompleteMyDomain.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -21,20 +21,17 @@ function run_test() {</span>
<a href="#l15.4"></a><span id="l15.4">   // Test - Create a new search component</span>
<a href="#l15.5"></a><span id="l15.5"> </span>
<a href="#l15.6"></a><span id="l15.6">   var acs = Components.classes[&quot;@mozilla.org/autocomplete/search;1?name=mydomain&quot;]</span>
<a href="#l15.7"></a><span id="l15.7">     .getService(Components.interfaces.nsIAutoCompleteSearch);</span>
<a href="#l15.8"></a><span id="l15.8"> </span>
<a href="#l15.9"></a><span id="l15.9">   var obs = new acObserver();</span>
<a href="#l15.10"></a><span id="l15.10"> </span>
<a href="#l15.11"></a><span id="l15.11">   // Set up an identity in the account manager with the default settings</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-  var acctMgr = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineminus">-                  .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineminus">-</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineminus">-  var identity = acctMgr.createIdentity();</span>
<a href="#l15.16"></a><span id="l15.16" class="difflineplus">+  let identity = MailServices.accounts.createIdentity();</span>
<a href="#l15.17"></a><span id="l15.17"> </span>
<a href="#l15.18"></a><span id="l15.18">   // Initially disable autocomplete</span>
<a href="#l15.19"></a><span id="l15.19">   identity.autocompleteToMyDomain = false;</span>
<a href="#l15.20"></a><span id="l15.20">   identity.email = &quot;myemail@invalid.com&quot;;</span>
<a href="#l15.21"></a><span id="l15.21"> </span>
<a href="#l15.22"></a><span id="l15.22">   // Test - Valid search - this should return no results (autocomplete disabled)</span>
<a href="#l15.23"></a><span id="l15.23">   acs.startSearch(&quot;test&quot;, identity.key, null, obs);</span>
<a href="#l15.24"></a><span id="l15.24"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch1.js</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch1.js</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -103,32 +103,29 @@ function run_test() {</span>
<a href="#l16.4"></a><span id="l16.4"> </span>
<a href="#l16.5"></a><span id="l16.5">   var acs = Components.classes[&quot;@mozilla.org/autocomplete/search;1?name=addrbook&quot;]</span>
<a href="#l16.6"></a><span id="l16.6">     .getService(Components.interfaces.nsIAutoCompleteSearch);</span>
<a href="#l16.7"></a><span id="l16.7"> </span>
<a href="#l16.8"></a><span id="l16.8">   var obs = new acObserver();</span>
<a href="#l16.9"></a><span id="l16.9"> </span>
<a href="#l16.10"></a><span id="l16.10">   // Test - Check disabling of autocomplete</span>
<a href="#l16.11"></a><span id="l16.11"> </span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-  var prefSvc = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineminus">-    .getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineminus">-</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineminus">-  prefSvc.setBoolPref(&quot;mail.enable_autocomplete&quot;, false);</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineplus">+  Services.prefs.setBoolPref(&quot;mail.enable_autocomplete&quot;, false);</span>
<a href="#l16.17"></a><span id="l16.17"> </span>
<a href="#l16.18"></a><span id="l16.18">   acs.startSearch(&quot;abc&quot;, null, null, obs);</span>
<a href="#l16.19"></a><span id="l16.19"> </span>
<a href="#l16.20"></a><span id="l16.20">   do_check_eq(obs._search, acs);</span>
<a href="#l16.21"></a><span id="l16.21">   do_check_eq(obs._result.searchString, &quot;abc&quot;);</span>
<a href="#l16.22"></a><span id="l16.22">   do_check_eq(obs._result.searchResult, ACR.RESULT_NOMATCH);</span>
<a href="#l16.23"></a><span id="l16.23">   do_check_eq(obs._result.errorDescription, null);</span>
<a href="#l16.24"></a><span id="l16.24">   do_check_eq(obs._result.matchCount, 0);</span>
<a href="#l16.25"></a><span id="l16.25"> </span>
<a href="#l16.26"></a><span id="l16.26">   // Test - Check Enabling of autocomplete, but with empty string.</span>
<a href="#l16.27"></a><span id="l16.27"> </span>
<a href="#l16.28"></a><span id="l16.28" class="difflineminus">-  prefSvc.setBoolPref(&quot;mail.enable_autocomplete&quot;, true);</span>
<a href="#l16.29"></a><span id="l16.29" class="difflineplus">+  Services.prefs.setBoolPref(&quot;mail.enable_autocomplete&quot;, true);</span>
<a href="#l16.30"></a><span id="l16.30"> </span>
<a href="#l16.31"></a><span id="l16.31">   acs.startSearch(null, null, null, obs);</span>
<a href="#l16.32"></a><span id="l16.32"> </span>
<a href="#l16.33"></a><span id="l16.33">   do_check_eq(obs._search, acs);</span>
<a href="#l16.34"></a><span id="l16.34">   do_check_eq(obs._result.searchString, null);</span>
<a href="#l16.35"></a><span id="l16.35">   do_check_eq(obs._result.searchResult, ACR.RESULT_IGNORED);</span>
<a href="#l16.36"></a><span id="l16.36">   do_check_eq(obs._result.errorDescription, null);</span>
<a href="#l16.37"></a><span id="l16.37">   do_check_eq(obs._result.matchCount, 0);</span>
<a href="#l16.38"></a><span id="l16.38" class="difflineat">@@ -170,17 +167,17 @@ function run_test() {</span>
<a href="#l16.39"></a><span id="l16.39"> </span>
<a href="#l16.40"></a><span id="l16.40">   do_check_eq(obs._result.getValueAt(0), &quot;dis &lt;email@invalid.com&gt;&quot;);</span>
<a href="#l16.41"></a><span id="l16.41">   do_check_eq(obs._result.getLabelAt(0), &quot;dis &lt;email@invalid.com&gt;&quot;);</span>
<a href="#l16.42"></a><span id="l16.42">   do_check_eq(obs._result.getCommentAt(0), &quot;&quot;);</span>
<a href="#l16.43"></a><span id="l16.43">   do_check_eq(obs._result.getStyleAt(0), &quot;local-abook&quot;);</span>
<a href="#l16.44"></a><span id="l16.44">   do_check_eq(obs._result.getImageAt(0), &quot;&quot;);</span>
<a href="#l16.45"></a><span id="l16.45"> </span>
<a href="#l16.46"></a><span id="l16.46">   // Now quick-check with the address book name in the comment column.</span>
<a href="#l16.47"></a><span id="l16.47" class="difflineminus">-  prefSvc.setIntPref(&quot;mail.autoComplete.commentColumn&quot;, 1);</span>
<a href="#l16.48"></a><span id="l16.48" class="difflineplus">+  Services.prefs.setIntPref(&quot;mail.autoComplete.commentColumn&quot;, 1);</span>
<a href="#l16.49"></a><span id="l16.49"> </span>
<a href="#l16.50"></a><span id="l16.50">   acs.startSearch(&quot;email&quot;, null, null, obs);</span>
<a href="#l16.51"></a><span id="l16.51"> </span>
<a href="#l16.52"></a><span id="l16.52">   do_check_eq(obs._search, acs);</span>
<a href="#l16.53"></a><span id="l16.53">   do_check_eq(obs._result.searchString, &quot;email&quot;);</span>
<a href="#l16.54"></a><span id="l16.54">   do_check_eq(obs._result.searchResult, ACR.RESULT_SUCCESS);</span>
<a href="#l16.55"></a><span id="l16.55">   do_check_eq(obs._result.errorDescription, null);</span>
<a href="#l16.56"></a><span id="l16.56">   do_check_eq(obs._result.matchCount, 1);</span>
<a href="#l16.57"></a><span id="l16.57" class="difflineat">@@ -233,19 +230,17 @@ function run_test() {</span>
<a href="#l16.58"></a><span id="l16.58">     element.forEach(checkInputItem);</span>
<a href="#l16.59"></a><span id="l16.59">   }</span>
<a href="#l16.60"></a><span id="l16.60"> </span>
<a href="#l16.61"></a><span id="l16.61">   inputs.forEach(checkInputSet);</span>
<a href="#l16.62"></a><span id="l16.62"> </span>
<a href="#l16.63"></a><span id="l16.63"> </span>
<a href="#l16.64"></a><span id="l16.64">   // Test - Popularity Index</span>
<a href="#l16.65"></a><span id="l16.65"> </span>
<a href="#l16.66"></a><span id="l16.66" class="difflineminus">-  var abManager = Cc[&quot;@mozilla.org/abmanager;1&quot;].getService(Ci.nsIAbManager);</span>
<a href="#l16.67"></a><span id="l16.67" class="difflineminus">-</span>
<a href="#l16.68"></a><span id="l16.68" class="difflineminus">-  var pab = abManager.getDirectory(kPABData.URI);</span>
<a href="#l16.69"></a><span id="l16.69" class="difflineplus">+  let pab = MailServices.ab.getDirectory(kPABData.URI);</span>
<a href="#l16.70"></a><span id="l16.70"> </span>
<a href="#l16.71"></a><span id="l16.71">   var childCards = pab.childCards;</span>
<a href="#l16.72"></a><span id="l16.72"> </span>
<a href="#l16.73"></a><span id="l16.73">   while (childCards.hasMoreElements()) {</span>
<a href="#l16.74"></a><span id="l16.74">     var card = childCards.getNext().QueryInterface(Ci.nsIAbCard);</span>
<a href="#l16.75"></a><span id="l16.75"> </span>
<a href="#l16.76"></a><span id="l16.76">     if (card.isMailList)</span>
<a href="#l16.77"></a><span id="l16.77">       continue;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch2.js</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch2.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -3,18 +3,16 @@</span>
<a href="#l17.4"></a><span id="l17.4">  * Second Test suite for nsAbAutoCompleteSearch - test follow-on lookup after</span>
<a href="#l17.5"></a><span id="l17.5">  * a previous search.</span>
<a href="#l17.6"></a><span id="l17.6">  *</span>
<a href="#l17.7"></a><span id="l17.7">  * We run this test without address books, constructing manually ourselves,</span>
<a href="#l17.8"></a><span id="l17.8">  * so that we can ensure that we're not getting the data out of the address</span>
<a href="#l17.9"></a><span id="l17.9">  * books.</span>
<a href="#l17.10"></a><span id="l17.10">  */</span>
<a href="#l17.11"></a><span id="l17.11"> </span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineminus">-</span>
<a href="#l17.14"></a><span id="l17.14"> // taken from nsAbAutoCompleteSearch.js</span>
<a href="#l17.15"></a><span id="l17.15"> const ACR = Components.interfaces.nsIAutoCompleteResult;</span>
<a href="#l17.16"></a><span id="l17.16"> const nsIAbAutoCompleteResult = Components.interfaces.nsIAbAutoCompleteResult;</span>
<a href="#l17.17"></a><span id="l17.17"> </span>
<a href="#l17.18"></a><span id="l17.18"> function nsAbAutoCompleteResult(aSearchString) {</span>
<a href="#l17.19"></a><span id="l17.19">   // Can't create this in the prototype as we'd get the same array for</span>
<a href="#l17.20"></a><span id="l17.20">   // all instances</span>
<a href="#l17.21"></a><span id="l17.21">   this._searchResults = new Array();</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineat">@@ -146,20 +144,17 @@ function run_test() {</span>
<a href="#l17.23"></a><span id="l17.23">   // Test - Create a new search component</span>
<a href="#l17.24"></a><span id="l17.24"> </span>
<a href="#l17.25"></a><span id="l17.25">   var acs = Components.classes[&quot;@mozilla.org/autocomplete/search;1?name=addrbook&quot;]</span>
<a href="#l17.26"></a><span id="l17.26">     .getService(Components.interfaces.nsIAutoCompleteSearch);</span>
<a href="#l17.27"></a><span id="l17.27"> </span>
<a href="#l17.28"></a><span id="l17.28">   var obs = new acObserver();</span>
<a href="#l17.29"></a><span id="l17.29"> </span>
<a href="#l17.30"></a><span id="l17.30">   // Ensure we've got the comment column set up for extra checking.</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineminus">-  var prefSvc = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineminus">-    .getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l17.33"></a><span id="l17.33" class="difflineminus">-</span>
<a href="#l17.34"></a><span id="l17.34" class="difflineminus">-  prefSvc.setIntPref(&quot;mail.autoComplete.commentColumn&quot;, 1);</span>
<a href="#l17.35"></a><span id="l17.35" class="difflineplus">+  Services.prefs.setIntPref(&quot;mail.autoComplete.commentColumn&quot;, 1);</span>
<a href="#l17.36"></a><span id="l17.36"> </span>
<a href="#l17.37"></a><span id="l17.37">   // Make up the last autocomplete result</span>
<a href="#l17.38"></a><span id="l17.38">   var lastResult = new nsAbAutoCompleteResult();</span>
<a href="#l17.39"></a><span id="l17.39"> </span>
<a href="#l17.40"></a><span id="l17.40">   lastResult.searchString = &quot;&quot;;</span>
<a href="#l17.41"></a><span id="l17.41">   lastResult.searchResult = ACR.RESULT_SUCCESS;</span>
<a href="#l17.42"></a><span id="l17.42">   lastResult.defaultIndex = 0;</span>
<a href="#l17.43"></a><span id="l17.43">   lastResult.errorDescription = null;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch3.js</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch3.js</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -40,22 +40,20 @@ acObserver.prototype = {</span>
<a href="#l18.4"></a><span id="l18.4">   }</span>
<a href="#l18.5"></a><span id="l18.5"> };</span>
<a href="#l18.6"></a><span id="l18.6"> </span>
<a href="#l18.7"></a><span id="l18.7"> function run_test()</span>
<a href="#l18.8"></a><span id="l18.8"> {</span>
<a href="#l18.9"></a><span id="l18.9">   // We set up the cards for this test manually as it is easier to set the</span>
<a href="#l18.10"></a><span id="l18.10">   // popularity index and we don't need many.</span>
<a href="#l18.11"></a><span id="l18.11"> </span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-  var abManager = Cc[&quot;@mozilla.org/abmanager;1&quot;].getService(Ci.nsIAbManager);</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+  // Ensure all the directories are initialised.</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineplus">+  MailServices.ab.directories;</span>
<a href="#l18.15"></a><span id="l18.15"> </span>
<a href="#l18.16"></a><span id="l18.16" class="difflineminus">-  // Ensure all the directories are initialised.</span>
<a href="#l18.17"></a><span id="l18.17" class="difflineminus">-  abManager.directories;</span>
<a href="#l18.18"></a><span id="l18.18" class="difflineminus">-</span>
<a href="#l18.19"></a><span id="l18.19" class="difflineminus">-  var ab = abManager.getDirectory(kPABData.URI);</span>
<a href="#l18.20"></a><span id="l18.20" class="difflineplus">+  let ab = MailServices.ab.getDirectory(kPABData.URI);</span>
<a href="#l18.21"></a><span id="l18.21"> </span>
<a href="#l18.22"></a><span id="l18.22">   function createAndAddCard(element) {</span>
<a href="#l18.23"></a><span id="l18.23">     var card = Cc[&quot;@mozilla.org/addressbook/cardproperty;1&quot;]</span>
<a href="#l18.24"></a><span id="l18.24">                  .createInstance(Ci.nsIAbCard);</span>
<a href="#l18.25"></a><span id="l18.25"> </span>
<a href="#l18.26"></a><span id="l18.26">     card.primaryEmail = element.email;</span>
<a href="#l18.27"></a><span id="l18.27">     card.displayName = element.displayName;</span>
<a href="#l18.28"></a><span id="l18.28">     card.setProperty(&quot;PopularityIndex&quot;, element.popularityIndex);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch4.js</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch4.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -83,22 +83,20 @@ acObserver.prototype = {</span>
<a href="#l19.4"></a><span id="l19.4">   }</span>
<a href="#l19.5"></a><span id="l19.5"> };</span>
<a href="#l19.6"></a><span id="l19.6"> </span>
<a href="#l19.7"></a><span id="l19.7"> function run_test()</span>
<a href="#l19.8"></a><span id="l19.8"> {</span>
<a href="#l19.9"></a><span id="l19.9">   // We set up the cards for this test manually as it is easier to set the</span>
<a href="#l19.10"></a><span id="l19.10">   // popularity index and we don't need many.</span>
<a href="#l19.11"></a><span id="l19.11"> </span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-  var abManager = Cc[&quot;@mozilla.org/abmanager;1&quot;].getService(Ci.nsIAbManager);</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+  // Ensure all the directories are initialised.</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineplus">+  MailServices.ab.directories;</span>
<a href="#l19.15"></a><span id="l19.15"> </span>
<a href="#l19.16"></a><span id="l19.16" class="difflineminus">-  // Ensure all the directories are initialised.</span>
<a href="#l19.17"></a><span id="l19.17" class="difflineminus">-  abManager.directories;</span>
<a href="#l19.18"></a><span id="l19.18" class="difflineminus">-</span>
<a href="#l19.19"></a><span id="l19.19" class="difflineminus">-  var ab = abManager.getDirectory(kPABData.URI);</span>
<a href="#l19.20"></a><span id="l19.20" class="difflineplus">+  let ab = MailServices.ab.getDirectory(kPABData.URI);</span>
<a href="#l19.21"></a><span id="l19.21"> </span>
<a href="#l19.22"></a><span id="l19.22">   function createAndAddCard(element) {</span>
<a href="#l19.23"></a><span id="l19.23">     var card = Cc[&quot;@mozilla.org/addressbook/cardproperty;1&quot;]</span>
<a href="#l19.24"></a><span id="l19.24">                  .createInstance(Ci.nsIAbCard);</span>
<a href="#l19.25"></a><span id="l19.25"> </span>
<a href="#l19.26"></a><span id="l19.26">     card.primaryEmail = element.email;</span>
<a href="#l19.27"></a><span id="l19.27">     card.setProperty(&quot;SecondEmail&quot;, element.secondEmail);</span>
<a href="#l19.28"></a><span id="l19.28">     card.displayName = element.displayName;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch5.js</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch5.js</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -1,16 +1,14 @@</span>
<a href="#l20.4"></a><span id="l20.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l20.5"></a><span id="l20.5"> /*</span>
<a href="#l20.6"></a><span id="l20.6">  * This suite ensures that we can correctly read and re-set the popularity</span>
<a href="#l20.7"></a><span id="l20.7">  * indexes on a </span>
<a href="#l20.8"></a><span id="l20.8">  */</span>
<a href="#l20.9"></a><span id="l20.9"> </span>
<a href="#l20.10"></a><span id="l20.10" class="difflineminus">-Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l20.11"></a><span id="l20.11" class="difflineminus">-</span>
<a href="#l20.12"></a><span id="l20.12"> const ACR = Components.interfaces.nsIAutoCompleteResult;</span>
<a href="#l20.13"></a><span id="l20.13"> </span>
<a href="#l20.14"></a><span id="l20.14"> const results = [ { email: &quot;d &lt;ema@test.invalid&gt;&quot;, dirName: kPABData.dirName },</span>
<a href="#l20.15"></a><span id="l20.15">                   { email: &quot;di &lt;emai@test.invalid&gt;&quot;, dirName: kPABData.dirName },</span>
<a href="#l20.16"></a><span id="l20.16">                   { email: &quot;dis &lt;email@test.invalid&gt;&quot;, dirName: kPABData.dirName },</span>
<a href="#l20.17"></a><span id="l20.17">                   { email: &quot;disp &lt;e@test.invalid&gt;&quot;, dirName: kPABData.dirName },</span>
<a href="#l20.18"></a><span id="l20.18">                   { email: &quot;displ &lt;em@test.invalid&gt;&quot;, dirName: kPABData.dirName },</span>
<a href="#l20.19"></a><span id="l20.19">                   { email: &quot;t &lt;list&gt;&quot;, dirName: kPABData.dirName },</span>
<a href="#l20.20"></a><span id="l20.20" class="difflineat">@@ -53,20 +51,17 @@ function run_test() {</span>
<a href="#l20.21"></a><span id="l20.21">   // Test - Create a new search component</span>
<a href="#l20.22"></a><span id="l20.22"> </span>
<a href="#l20.23"></a><span id="l20.23">   let acs = Components.classes[&quot;@mozilla.org/autocomplete/search;1?name=addrbook&quot;]</span>
<a href="#l20.24"></a><span id="l20.24">     .getService(Components.interfaces.nsIAutoCompleteSearch);</span>
<a href="#l20.25"></a><span id="l20.25"> </span>
<a href="#l20.26"></a><span id="l20.26">   let obs = new acObserver();</span>
<a href="#l20.27"></a><span id="l20.27"> </span>
<a href="#l20.28"></a><span id="l20.28">   // Ensure we've got the comment column set up for extra checking.</span>
<a href="#l20.29"></a><span id="l20.29" class="difflineminus">-  let prefSvc = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l20.30"></a><span id="l20.30" class="difflineminus">-    .getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l20.31"></a><span id="l20.31" class="difflineminus">-</span>
<a href="#l20.32"></a><span id="l20.32" class="difflineminus">-  prefSvc.setIntPref(&quot;mail.autoComplete.commentColumn&quot;, 1);</span>
<a href="#l20.33"></a><span id="l20.33" class="difflineplus">+  Services.prefs.setIntPref(&quot;mail.autoComplete.commentColumn&quot;, 1);</span>
<a href="#l20.34"></a><span id="l20.34"> </span>
<a href="#l20.35"></a><span id="l20.35">   // Test - Matches</span>
<a href="#l20.36"></a><span id="l20.36"> </span>
<a href="#l20.37"></a><span id="l20.37">   // Now check multiple matches</span>
<a href="#l20.38"></a><span id="l20.38">   function checkInputItem(element, index, array) {</span>
<a href="#l20.39"></a><span id="l20.39">     print(&quot;Checking &quot; + element.search);</span>
<a href="#l20.40"></a><span id="l20.40">     acs.startSearch(element.search, null, null, obs);</span>
<a href="#l20.41"></a><span id="l20.41"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_nsAbManager1.js</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_nsAbManager1.js</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -1,70 +1,65 @@</span>
<a href="#l21.4"></a><span id="l21.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l21.5"></a><span id="l21.5"> /*</span>
<a href="#l21.6"></a><span id="l21.6">  * Test suite for nsAbManager functions relating to listeners.</span>
<a href="#l21.7"></a><span id="l21.7">  */</span>
<a href="#l21.8"></a><span id="l21.8"> </span>
<a href="#l21.9"></a><span id="l21.9" class="difflineminus">-const abManagerContractID = &quot;@mozilla.org/abmanager;1&quot;;</span>
<a href="#l21.10"></a><span id="l21.10" class="difflineminus">-const nsIAbManager = Components.interfaces.nsIAbManager;</span>
<a href="#l21.11"></a><span id="l21.11"> const nsIAbListener = Components.interfaces.nsIAbListener;</span>
<a href="#l21.12"></a><span id="l21.12"> const numListenerOptions = 4;</span>
<a href="#l21.13"></a><span id="l21.13"> </span>
<a href="#l21.14"></a><span id="l21.14" class="difflineminus">-var gAbManager = Components.classes[abManagerContractID]</span>
<a href="#l21.15"></a><span id="l21.15" class="difflineminus">-                             .getService(nsIAbManager);</span>
<a href="#l21.16"></a><span id="l21.16" class="difflineminus">-</span>
<a href="#l21.17"></a><span id="l21.17"> var gAblAll;</span>
<a href="#l21.18"></a><span id="l21.18"> var gAblSingle = new Array(numListenerOptions);</span>
<a href="#l21.19"></a><span id="l21.19"> </span>
<a href="#l21.20"></a><span id="l21.20"> function abL() {}</span>
<a href="#l21.21"></a><span id="l21.21"> </span>
<a href="#l21.22"></a><span id="l21.22"> abL.prototype = {</span>
<a href="#l21.23"></a><span id="l21.23">  mReceived: 0,</span>
<a href="#l21.24"></a><span id="l21.24">  mAutoRemoveItem: false,</span>
<a href="#l21.25"></a><span id="l21.25"> </span>
<a href="#l21.26"></a><span id="l21.26">   onItemAdded: function (parentItem, item) {</span>
<a href="#l21.27"></a><span id="l21.27">     this.mReceived |= nsIAbListener.itemAdded;</span>
<a href="#l21.28"></a><span id="l21.28">     if (this.mAutoRemoveItem)</span>
<a href="#l21.29"></a><span id="l21.29" class="difflineminus">-      gAbManager.removeAddressBookListener(this);</span>
<a href="#l21.30"></a><span id="l21.30" class="difflineplus">+      MailServices.ab.removeAddressBookListener(this);</span>
<a href="#l21.31"></a><span id="l21.31">   },</span>
<a href="#l21.32"></a><span id="l21.32">   onItemRemoved: function (parentItem, item) {</span>
<a href="#l21.33"></a><span id="l21.33">     this.mReceived |=</span>
<a href="#l21.34"></a><span id="l21.34" class="difflineminus">-      (item == gAbManager ? nsIAbListener.directoryRemoved :</span>
<a href="#l21.35"></a><span id="l21.35" class="difflineminus">-                            nsIAbListener.directoryItemRemoved);</span>
<a href="#l21.36"></a><span id="l21.36" class="difflineplus">+      (item == MailServices.ab ? nsIAbListener.directoryRemoved :</span>
<a href="#l21.37"></a><span id="l21.37" class="difflineplus">+                                 nsIAbListener.directoryItemRemoved);</span>
<a href="#l21.38"></a><span id="l21.38">     if (this.mAutoRemoveItem)</span>
<a href="#l21.39"></a><span id="l21.39" class="difflineminus">-      gAbManager.removeAddressBookListener(this);</span>
<a href="#l21.40"></a><span id="l21.40" class="difflineplus">+      MailServices.ab.removeAddressBookListener(this);</span>
<a href="#l21.41"></a><span id="l21.41">   },</span>
<a href="#l21.42"></a><span id="l21.42">   onItemPropertyChanged: function (item, property, oldValue, newValue) {</span>
<a href="#l21.43"></a><span id="l21.43">     this.mReceived |= nsIAbListener.itemChanged;</span>
<a href="#l21.44"></a><span id="l21.44">     if (this.mAutoRemoveItem)</span>
<a href="#l21.45"></a><span id="l21.45" class="difflineminus">-      gAbManager.removeAddressBookListener(this);</span>
<a href="#l21.46"></a><span id="l21.46" class="difflineplus">+      MailServices.ab.removeAddressBookListener(this);</span>
<a href="#l21.47"></a><span id="l21.47">   }</span>
<a href="#l21.48"></a><span id="l21.48"> };</span>
<a href="#l21.49"></a><span id="l21.49"> </span>
<a href="#l21.50"></a><span id="l21.50"> function NotifyAbManager() {</span>
<a href="#l21.51"></a><span id="l21.51" class="difflineminus">-  gAbManager.notifyItemPropertyChanged(null, null, null, null);</span>
<a href="#l21.52"></a><span id="l21.52" class="difflineminus">-  gAbManager.notifyDirectoryItemAdded(null, null);</span>
<a href="#l21.53"></a><span id="l21.53" class="difflineminus">-  gAbManager.notifyDirectoryItemDeleted(null, null);</span>
<a href="#l21.54"></a><span id="l21.54" class="difflineminus">-  // gAbManager just happens to be nsISupports derived and makes it easy for</span>
<a href="#l21.55"></a><span id="l21.55" class="difflineplus">+  MailServices.ab.notifyItemPropertyChanged(null, null, null, null);</span>
<a href="#l21.56"></a><span id="l21.56" class="difflineplus">+  MailServices.ab.notifyDirectoryItemAdded(null, null);</span>
<a href="#l21.57"></a><span id="l21.57" class="difflineplus">+  MailServices.ab.notifyDirectoryItemDeleted(null, null);</span>
<a href="#l21.58"></a><span id="l21.58" class="difflineplus">+  // MailServices.ab just happens to be nsISupports derived and makes it easy for</span>
<a href="#l21.59"></a><span id="l21.59">   // us to distinguish between xxxItemDeleted and xxxDeleted.</span>
<a href="#l21.60"></a><span id="l21.60" class="difflineminus">-  gAbManager.notifyDirectoryDeleted(null, gAbManager);</span>
<a href="#l21.61"></a><span id="l21.61" class="difflineplus">+  MailServices.ab.notifyDirectoryDeleted(null, MailServices.ab);</span>
<a href="#l21.62"></a><span id="l21.62"> }</span>
<a href="#l21.63"></a><span id="l21.63"> </span>
<a href="#l21.64"></a><span id="l21.64"> function run_test() {</span>
<a href="#l21.65"></a><span id="l21.65">   var i;</span>
<a href="#l21.66"></a><span id="l21.66"> </span>
<a href="#l21.67"></a><span id="l21.67">   // Test - Add a listener</span>
<a href="#l21.68"></a><span id="l21.68"> </span>
<a href="#l21.69"></a><span id="l21.69">   gAblAll = new abL;</span>
<a href="#l21.70"></a><span id="l21.70"> </span>
<a href="#l21.71"></a><span id="l21.71" class="difflineminus">-  gAbManager.addAddressBookListener(gAblAll, nsIAbListener.all);</span>
<a href="#l21.72"></a><span id="l21.72" class="difflineplus">+  MailServices.ab.addAddressBookListener(gAblAll, nsIAbListener.all);</span>
<a href="#l21.73"></a><span id="l21.73"> </span>
<a href="#l21.74"></a><span id="l21.74">   for (i = 0; i &lt; numListenerOptions; ++i) {</span>
<a href="#l21.75"></a><span id="l21.75">     gAblSingle[i] = new abL;</span>
<a href="#l21.76"></a><span id="l21.76" class="difflineminus">-    gAbManager.addAddressBookListener(gAblSingle[i], 1 &lt;&lt; i);</span>
<a href="#l21.77"></a><span id="l21.77" class="difflineplus">+    MailServices.ab.addAddressBookListener(gAblSingle[i], 1 &lt;&lt; i);</span>
<a href="#l21.78"></a><span id="l21.78">   }</span>
<a href="#l21.79"></a><span id="l21.79"> </span>
<a href="#l21.80"></a><span id="l21.80">   // Test - Notify listener on all available items</span>
<a href="#l21.81"></a><span id="l21.81"> </span>
<a href="#l21.82"></a><span id="l21.82">   NotifyAbManager();</span>
<a href="#l21.83"></a><span id="l21.83"> </span>
<a href="#l21.84"></a><span id="l21.84">   do_check_eq(gAblAll.mReceived, (1 &lt;&lt; numListenerOptions) - 1);</span>
<a href="#l21.85"></a><span id="l21.85">   gAblAll.mReceived = 0;</span>
<a href="#l21.86"></a><span id="l21.86" class="difflineat">@@ -99,10 +94,10 @@ function run_test() {</span>
<a href="#l21.87"></a><span id="l21.87">   gAblAll.mReceived = 0;</span>
<a href="#l21.88"></a><span id="l21.88"> </span>
<a href="#l21.89"></a><span id="l21.89">   for (i = 0; i &lt; numListenerOptions; ++i) {</span>
<a href="#l21.90"></a><span id="l21.90">     do_check_eq(gAblSingle[i].mReceived, 0);</span>
<a href="#l21.91"></a><span id="l21.91">   }</span>
<a href="#l21.92"></a><span id="l21.92"> </span>
<a href="#l21.93"></a><span id="l21.93">   // Test - Remove main listener</span>
<a href="#l21.94"></a><span id="l21.94"> </span>
<a href="#l21.95"></a><span id="l21.95" class="difflineminus">-  gAbManager.removeAddressBookListener(gAblAll);</span>
<a href="#l21.96"></a><span id="l21.96" class="difflineplus">+  MailServices.ab.removeAddressBookListener(gAblAll);</span>
<a href="#l21.97"></a><span id="l21.97"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_nsAbManager2.js</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_nsAbManager2.js</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -1,75 +1,70 @@</span>
<a href="#l22.4"></a><span id="l22.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l22.5"></a><span id="l22.5"> /*</span>
<a href="#l22.6"></a><span id="l22.6">  * Test suite for nsAbManager functions relating to add/delete directories and</span>
<a href="#l22.7"></a><span id="l22.7">  * getting the list of directories..</span>
<a href="#l22.8"></a><span id="l22.8">  */</span>
<a href="#l22.9"></a><span id="l22.9"> </span>
<a href="#l22.10"></a><span id="l22.10" class="difflineminus">-const abManagerContractID = &quot;@mozilla.org/abmanager;1&quot;;</span>
<a href="#l22.11"></a><span id="l22.11" class="difflineminus">-const nsIAbManager = Components.interfaces.nsIAbManager;</span>
<a href="#l22.12"></a><span id="l22.12"> const nsIAbDirectory = Components.interfaces.nsIAbDirectory;</span>
<a href="#l22.13"></a><span id="l22.13"> const nsIAbListener = Components.interfaces.nsIAbListener;</span>
<a href="#l22.14"></a><span id="l22.14"> const numListenerOptions = 4;</span>
<a href="#l22.15"></a><span id="l22.15"> </span>
<a href="#l22.16"></a><span id="l22.16" class="difflineminus">-var gAbManager = Components.classes[abManagerContractID]</span>
<a href="#l22.17"></a><span id="l22.17" class="difflineminus">-                             .getService(nsIAbManager);</span>
<a href="#l22.18"></a><span id="l22.18" class="difflineminus">-</span>
<a href="#l22.19"></a><span id="l22.19"> var gAblAll;</span>
<a href="#l22.20"></a><span id="l22.20"> var gAblSingle = new Array(numListenerOptions);</span>
<a href="#l22.21"></a><span id="l22.21"> </span>
<a href="#l22.22"></a><span id="l22.22"> function abL() {}</span>
<a href="#l22.23"></a><span id="l22.23"> </span>
<a href="#l22.24"></a><span id="l22.24"> abL.prototype = {</span>
<a href="#l22.25"></a><span id="l22.25">  mReceived: 0,</span>
<a href="#l22.26"></a><span id="l22.26">  mDirectory: null,</span>
<a href="#l22.27"></a><span id="l22.27">  mAutoRemoveItem: false,</span>
<a href="#l22.28"></a><span id="l22.28"> </span>
<a href="#l22.29"></a><span id="l22.29">   onItemAdded: function (parentItem, item) {</span>
<a href="#l22.30"></a><span id="l22.30">     this.mReceived |= nsIAbListener.itemAdded;</span>
<a href="#l22.31"></a><span id="l22.31">     this.mDirectory = item;</span>
<a href="#l22.32"></a><span id="l22.32">     if (this.mAutoRemoveItem)</span>
<a href="#l22.33"></a><span id="l22.33" class="difflineminus">-      gAbManager.removeAddressBookListener(this);</span>
<a href="#l22.34"></a><span id="l22.34" class="difflineplus">+      MailServices.ab.removeAddressBookListener(this);</span>
<a href="#l22.35"></a><span id="l22.35">   },</span>
<a href="#l22.36"></a><span id="l22.36">   onItemRemoved: function (parentItem, item) {</span>
<a href="#l22.37"></a><span id="l22.37">     this.mReceived |= nsIAbListener.directoryRemoved;</span>
<a href="#l22.38"></a><span id="l22.38">     this.mDirectory = item;</span>
<a href="#l22.39"></a><span id="l22.39">     if (this.mAutoRemoveItem)</span>
<a href="#l22.40"></a><span id="l22.40" class="difflineminus">-      gAbManager.removeAddressBookListener(this);</span>
<a href="#l22.41"></a><span id="l22.41" class="difflineplus">+      MailServices.ab.removeAddressBookListener(this);</span>
<a href="#l22.42"></a><span id="l22.42">   },</span>
<a href="#l22.43"></a><span id="l22.43">   onItemPropertyChanged: function (item, property, oldValue, newValue) {</span>
<a href="#l22.44"></a><span id="l22.44">     this.mReceived |= nsIAbListener.itemChanged;</span>
<a href="#l22.45"></a><span id="l22.45">     this.mDirectory = item;</span>
<a href="#l22.46"></a><span id="l22.46">     if (this.mAutoRemoveItem)</span>
<a href="#l22.47"></a><span id="l22.47" class="difflineminus">-      gAbManager.removeAddressBookListener(this);</span>
<a href="#l22.48"></a><span id="l22.48" class="difflineplus">+      MailServices.ab.removeAddressBookListener(this);</span>
<a href="#l22.49"></a><span id="l22.49">   }</span>
<a href="#l22.50"></a><span id="l22.50"> };</span>
<a href="#l22.51"></a><span id="l22.51"> </span>
<a href="#l22.52"></a><span id="l22.52"> function checkDirs(aDirs, aDirArray) {</span>
<a href="#l22.53"></a><span id="l22.53">   // Don't modify the passed in array.</span>
<a href="#l22.54"></a><span id="l22.54">   var dirArray = aDirArray.concat();</span>
<a href="#l22.55"></a><span id="l22.55"> </span>
<a href="#l22.56"></a><span id="l22.56">   while (aDirs.hasMoreElements()) {</span>
<a href="#l22.57"></a><span id="l22.57">     var dir = aDirs.getNext().QueryInterface(nsIAbDirectory);</span>
<a href="#l22.58"></a><span id="l22.58">     var loc = dirArray.indexOf(dir.URI);</span>
<a href="#l22.59"></a><span id="l22.59"> </span>
<a href="#l22.60"></a><span id="l22.60" class="difflineminus">-    do_check_eq(gAbManager.getDirectory(dir.URI), dir);</span>
<a href="#l22.61"></a><span id="l22.61" class="difflineplus">+    do_check_eq(MailServices.ab.getDirectory(dir.URI), dir);</span>
<a href="#l22.62"></a><span id="l22.62"> </span>
<a href="#l22.63"></a><span id="l22.63">     if (loc == -1)</span>
<a href="#l22.64"></a><span id="l22.64">       do_throw(&quot;Unexpected directory &quot; + dir.URI + &quot; found in address book list&quot;);</span>
<a href="#l22.65"></a><span id="l22.65">     else</span>
<a href="#l22.66"></a><span id="l22.66">       dirArray[loc] = null;</span>
<a href="#l22.67"></a><span id="l22.67">   }</span>
<a href="#l22.68"></a><span id="l22.68"> </span>
<a href="#l22.69"></a><span id="l22.69">   dirArray.forEach(function(value) { do_check_eq(value, null); });</span>
<a href="#l22.70"></a><span id="l22.70"> }</span>
<a href="#l22.71"></a><span id="l22.71"> </span>
<a href="#l22.72"></a><span id="l22.72"> function addDirectory(dirName) {</span>
<a href="#l22.73"></a><span id="l22.73">   // Add the directory</span>
<a href="#l22.74"></a><span id="l22.74" class="difflineminus">-  gAbManager.newAddressBook(dirName, &quot;&quot;, kPABData.dirType);</span>
<a href="#l22.75"></a><span id="l22.75" class="difflineplus">+  MailServices.ab.newAddressBook(dirName, &quot;&quot;, kPABData.dirType);</span>
<a href="#l22.76"></a><span id="l22.76"> </span>
<a href="#l22.77"></a><span id="l22.77">   // Check for correct notifications</span>
<a href="#l22.78"></a><span id="l22.78">   do_check_eq(gAblAll.mReceived, nsIAbListener.itemAdded);</span>
<a href="#l22.79"></a><span id="l22.79"> </span>
<a href="#l22.80"></a><span id="l22.80">   var newDirectory = gAblAll.mDirectory.QueryInterface(nsIAbDirectory);</span>
<a href="#l22.81"></a><span id="l22.81"> </span>
<a href="#l22.82"></a><span id="l22.82">   gAblAll.mReceived = 0;</span>
<a href="#l22.83"></a><span id="l22.83">   gAblAll.mDirectory = null;</span>
<a href="#l22.84"></a><span id="l22.84" class="difflineat">@@ -83,17 +78,17 @@ function addDirectory(dirName) {</span>
<a href="#l22.85"></a><span id="l22.85">       do_check_eq(gAblSingle[i].mReceived, 0);</span>
<a href="#l22.86"></a><span id="l22.86">   }</span>
<a href="#l22.87"></a><span id="l22.87"> </span>
<a href="#l22.88"></a><span id="l22.88">   return newDirectory;</span>
<a href="#l22.89"></a><span id="l22.89"> }</span>
<a href="#l22.90"></a><span id="l22.90"> </span>
<a href="#l22.91"></a><span id="l22.91"> function removeDirectory(directory) {</span>
<a href="#l22.92"></a><span id="l22.92">   // Remove the directory</span>
<a href="#l22.93"></a><span id="l22.93" class="difflineminus">-  gAbManager.deleteAddressBook(directory.URI);</span>
<a href="#l22.94"></a><span id="l22.94" class="difflineplus">+  MailServices.ab.deleteAddressBook(directory.URI);</span>
<a href="#l22.95"></a><span id="l22.95"> </span>
<a href="#l22.96"></a><span id="l22.96">   // Check correct notifications</span>
<a href="#l22.97"></a><span id="l22.97">   do_check_eq(gAblAll.mReceived, nsIAbListener.directoryRemoved);</span>
<a href="#l22.98"></a><span id="l22.98">   do_check_eq(gAblAll.mDirectory, directory);</span>
<a href="#l22.99"></a><span id="l22.99"> </span>
<a href="#l22.100"></a><span id="l22.100">   gAblAll.mReceived = 0;</span>
<a href="#l22.101"></a><span id="l22.101">   gAblAll.mDirectory = null;</span>
<a href="#l22.102"></a><span id="l22.102"> </span>
<a href="#l22.103"></a><span id="l22.103" class="difflineat">@@ -107,74 +102,74 @@ function removeDirectory(directory) {</span>
<a href="#l22.104"></a><span id="l22.104">   }</span>
<a href="#l22.105"></a><span id="l22.105"> }</span>
<a href="#l22.106"></a><span id="l22.106"> </span>
<a href="#l22.107"></a><span id="l22.107"> function run_test() {</span>
<a href="#l22.108"></a><span id="l22.108">   var i;</span>
<a href="#l22.109"></a><span id="l22.109"> </span>
<a href="#l22.110"></a><span id="l22.110">   // Set up listeners</span>
<a href="#l22.111"></a><span id="l22.111">   gAblAll = new abL;</span>
<a href="#l22.112"></a><span id="l22.112" class="difflineminus">-  gAbManager.addAddressBookListener(gAblAll, nsIAbListener.all);</span>
<a href="#l22.113"></a><span id="l22.113" class="difflineplus">+  MailServices.ab.addAddressBookListener(gAblAll, nsIAbListener.all);</span>
<a href="#l22.114"></a><span id="l22.114"> </span>
<a href="#l22.115"></a><span id="l22.115">   for (i = 0; i &lt; numListenerOptions; ++i) {</span>
<a href="#l22.116"></a><span id="l22.116">     gAblSingle[i] = new abL;</span>
<a href="#l22.117"></a><span id="l22.117" class="difflineminus">-    gAbManager.addAddressBookListener(gAblSingle[i], 1 &lt;&lt; i);</span>
<a href="#l22.118"></a><span id="l22.118" class="difflineplus">+    MailServices.ab.addAddressBookListener(gAblSingle[i], 1 &lt;&lt; i);</span>
<a href="#l22.119"></a><span id="l22.119">   }</span>
<a href="#l22.120"></a><span id="l22.120"> </span>
<a href="#l22.121"></a><span id="l22.121">   var expectedABs = [kPABData.URI, kCABData.URI];</span>
<a href="#l22.122"></a><span id="l22.122"> </span>
<a href="#l22.123"></a><span id="l22.123">   // Check the OS X Address Book if available</span>
<a href="#l22.124"></a><span id="l22.124">   if (&quot;@mozilla.org/addressbook/directory;1?type=moz-abosxdirectory&quot; in</span>
<a href="#l22.125"></a><span id="l22.125">       Components.classes)</span>
<a href="#l22.126"></a><span id="l22.126">     expectedABs.push(kOSXData.URI);</span>
<a href="#l22.127"></a><span id="l22.127"> </span>
<a href="#l22.128"></a><span id="l22.128">   // Test - Check initial directories</span>
<a href="#l22.129"></a><span id="l22.129"> </span>
<a href="#l22.130"></a><span id="l22.130" class="difflineminus">-  checkDirs(gAbManager.directories, expectedABs);</span>
<a href="#l22.131"></a><span id="l22.131" class="difflineplus">+  checkDirs(MailServices.ab.directories, expectedABs);</span>
<a href="#l22.132"></a><span id="l22.132"> </span>
<a href="#l22.133"></a><span id="l22.133">   // Test - Add a directory</span>
<a href="#l22.134"></a><span id="l22.134"> </span>
<a href="#l22.135"></a><span id="l22.135">   var newDirectory1 = addDirectory(&quot;testAb1&quot;);</span>
<a href="#l22.136"></a><span id="l22.136"> </span>
<a href="#l22.137"></a><span id="l22.137">   // Test - Check new directory list</span>
<a href="#l22.138"></a><span id="l22.138">   expectedABs.push(newDirectory1.URI);</span>
<a href="#l22.139"></a><span id="l22.139"> </span>
<a href="#l22.140"></a><span id="l22.140" class="difflineminus">-  checkDirs(gAbManager.directories, expectedABs);</span>
<a href="#l22.141"></a><span id="l22.141" class="difflineplus">+  checkDirs(MailServices.ab.directories, expectedABs);</span>
<a href="#l22.142"></a><span id="l22.142"> </span>
<a href="#l22.143"></a><span id="l22.143">   // Test - Repeat for a second directory</span>
<a href="#l22.144"></a><span id="l22.144"> </span>
<a href="#l22.145"></a><span id="l22.145">   var newDirectory2 = addDirectory(&quot;testAb2&quot;);</span>
<a href="#l22.146"></a><span id="l22.146"> </span>
<a href="#l22.147"></a><span id="l22.147">   // Test - Check new directory list</span>
<a href="#l22.148"></a><span id="l22.148">   expectedABs.push(newDirectory2.URI);</span>
<a href="#l22.149"></a><span id="l22.149"> </span>
<a href="#l22.150"></a><span id="l22.150" class="difflineminus">-  checkDirs(gAbManager.directories, expectedABs);</span>
<a href="#l22.151"></a><span id="l22.151" class="difflineplus">+  checkDirs(MailServices.ab.directories, expectedABs);</span>
<a href="#l22.152"></a><span id="l22.152"> </span>
<a href="#l22.153"></a><span id="l22.153">   // Test - Remove a directory</span>
<a href="#l22.154"></a><span id="l22.154"> </span>
<a href="#l22.155"></a><span id="l22.155">   var pos = expectedABs.indexOf(newDirectory1.URI);</span>
<a href="#l22.156"></a><span id="l22.156"> </span>
<a href="#l22.157"></a><span id="l22.157">   expectedABs.splice(pos, 1);</span>
<a href="#l22.158"></a><span id="l22.158"> </span>
<a href="#l22.159"></a><span id="l22.159">   removeDirectory(newDirectory1);</span>
<a href="#l22.160"></a><span id="l22.160">   newDirectory1 = null;</span>
<a href="#l22.161"></a><span id="l22.161"> </span>
<a href="#l22.162"></a><span id="l22.162">   // Test - Check new directory list</span>
<a href="#l22.163"></a><span id="l22.163"> </span>
<a href="#l22.164"></a><span id="l22.164" class="difflineminus">-  checkDirs(gAbManager.directories, expectedABs);</span>
<a href="#l22.165"></a><span id="l22.165" class="difflineplus">+  checkDirs(MailServices.ab.directories, expectedABs);</span>
<a href="#l22.166"></a><span id="l22.166"> </span>
<a href="#l22.167"></a><span id="l22.167">   // Test - Repeat the removal</span>
<a href="#l22.168"></a><span id="l22.168"> </span>
<a href="#l22.169"></a><span id="l22.169">   removeDirectory(newDirectory2);</span>
<a href="#l22.170"></a><span id="l22.170">   newDirectory2 = null;</span>
<a href="#l22.171"></a><span id="l22.171"> </span>
<a href="#l22.172"></a><span id="l22.172">   expectedABs.pop();</span>
<a href="#l22.173"></a><span id="l22.173"> </span>
<a href="#l22.174"></a><span id="l22.174">   // Test - Check new directory list</span>
<a href="#l22.175"></a><span id="l22.175" class="difflineminus">-  checkDirs(gAbManager.directories, expectedABs);</span>
<a href="#l22.176"></a><span id="l22.176" class="difflineplus">+  checkDirs(MailServices.ab.directories, expectedABs);</span>
<a href="#l22.177"></a><span id="l22.177"> </span>
<a href="#l22.178"></a><span id="l22.178">   // Test - Clear the listeners down</span>
<a href="#l22.179"></a><span id="l22.179"> </span>
<a href="#l22.180"></a><span id="l22.180" class="difflineminus">-  gAbManager.removeAddressBookListener(gAblAll);</span>
<a href="#l22.181"></a><span id="l22.181" class="difflineplus">+  MailServices.ab.removeAddressBookListener(gAblAll);</span>
<a href="#l22.182"></a><span id="l22.182"> </span>
<a href="#l22.183"></a><span id="l22.183">   for (i = 0; i&lt; numListenerOptions; ++i)</span>
<a href="#l22.184"></a><span id="l22.184" class="difflineminus">-    gAbManager.removeAddressBookListener(gAblSingle[i]);</span>
<a href="#l22.185"></a><span id="l22.185" class="difflineplus">+    MailServices.ab.removeAddressBookListener(gAblSingle[i]);</span>
<a href="#l22.186"></a><span id="l22.186"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_nsIAbCard.js</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_nsIAbCard.js</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -12,20 +12,17 @@</span>
<a href="#l23.4"></a><span id="l23.4"> function run_test() {</span>
<a href="#l23.5"></a><span id="l23.5">   // Test setup - copy the data file into place</span>
<a href="#l23.6"></a><span id="l23.6">   var testAB = do_get_file(&quot;data/cardForEmail.mab&quot;);</span>
<a href="#l23.7"></a><span id="l23.7"> </span>
<a href="#l23.8"></a><span id="l23.8">   // Copy the file to the profile directory for a PAB</span>
<a href="#l23.9"></a><span id="l23.9">   testAB.copyTo(gProfileDir, kPABData.fileName);</span>
<a href="#l23.10"></a><span id="l23.10"> </span>
<a href="#l23.11"></a><span id="l23.11">   // Test - Get the directory</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-  var abManager = Components.classes[&quot;@mozilla.org/abmanager;1&quot;]</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineminus">-                            .getService(Components.interfaces.nsIAbManager);</span>
<a href="#l23.14"></a><span id="l23.14" class="difflineminus">-</span>
<a href="#l23.15"></a><span id="l23.15" class="difflineminus">-  var AB = abManager.getDirectory(kPABData.URI);</span>
<a href="#l23.16"></a><span id="l23.16" class="difflineplus">+  let AB = MailServices.ab.getDirectory(kPABData.URI);</span>
<a href="#l23.17"></a><span id="l23.17"> </span>
<a href="#l23.18"></a><span id="l23.18">   var childCards = AB.childCards;</span>
<a href="#l23.19"></a><span id="l23.19">   var fullCard = null;</span>
<a href="#l23.20"></a><span id="l23.20">   var tempCard;</span>
<a href="#l23.21"></a><span id="l23.21"> </span>
<a href="#l23.22"></a><span id="l23.22">   while (childCards.hasMoreElements())</span>
<a href="#l23.23"></a><span id="l23.23">   {</span>
<a href="#l23.24"></a><span id="l23.24">     tempCard = childCards.getNext();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_uuid.js</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_uuid.js</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -1,13 +1,12 @@</span>
<a href="#l24.4"></a><span id="l24.4"> /* This file is testing that the UUID semantics of cards and directories match</span>
<a href="#l24.5"></a><span id="l24.5">  * the guarantees of their documented requirements.</span>
<a href="#l24.6"></a><span id="l24.6">  */</span>
<a href="#l24.7"></a><span id="l24.7"> </span>
<a href="#l24.8"></a><span id="l24.8" class="difflineminus">-var abMgr;</span>
<a href="#l24.9"></a><span id="l24.9"> /**</span>
<a href="#l24.10"></a><span id="l24.10">  * Checks that the directory follows the contract for UUIDs.</span>
<a href="#l24.11"></a><span id="l24.11">  *</span>
<a href="#l24.12"></a><span id="l24.12">  * If the directory is modifiable, it will be modified, although the net effect</span>
<a href="#l24.13"></a><span id="l24.13">  * will not change the state if the code works properly.</span>
<a href="#l24.14"></a><span id="l24.14">  */</span>
<a href="#l24.15"></a><span id="l24.15"> function check_directory(directory) {</span>
<a href="#l24.16"></a><span id="l24.16">   var prefId = directory.dirPrefId + '&amp;' + directory.dirName;</span>
<a href="#l24.17"></a><span id="l24.17" class="difflineat">@@ -15,17 +14,17 @@ function check_directory(directory) {</span>
<a href="#l24.18"></a><span id="l24.18">   var testModification = !directory.readOnly;</span>
<a href="#l24.19"></a><span id="l24.19">   dump(&quot;Testing &quot; + prefId);</span>
<a href="#l24.20"></a><span id="l24.20">   if (testModification)</span>
<a href="#l24.21"></a><span id="l24.21">     dump(&quot; (with modifications)&quot;);</span>
<a href="#l24.22"></a><span id="l24.22">   dump(&quot;...\n&quot;);</span>
<a href="#l24.23"></a><span id="l24.23"> </span>
<a href="#l24.24"></a><span id="l24.24">   // Question 1: Is the UUID the preference ID?</span>
<a href="#l24.25"></a><span id="l24.25">   do_check_eq(prefId, directory.uuid);</span>
<a href="#l24.26"></a><span id="l24.26" class="difflineminus">-  </span>
<a href="#l24.27"></a><span id="l24.27" class="difflineplus">+</span>
<a href="#l24.28"></a><span id="l24.28">   // Now we need to run through the cards, checking that each card meets the</span>
<a href="#l24.29"></a><span id="l24.29">   // requirements.</span>
<a href="#l24.30"></a><span id="l24.30">   var seenIds = [], cards = [];</span>
<a href="#l24.31"></a><span id="l24.31">   var enumerator = directory.childCards;</span>
<a href="#l24.32"></a><span id="l24.32">   while (enumerator.hasMoreElements()) {</span>
<a href="#l24.33"></a><span id="l24.33">     var card = enumerator.getNext().QueryInterface(Ci.nsIAbCard);</span>
<a href="#l24.34"></a><span id="l24.34">     cards.push(card);</span>
<a href="#l24.35"></a><span id="l24.35"> </span>
<a href="#l24.36"></a><span id="l24.36" class="difflineat">@@ -33,42 +32,42 @@ function check_directory(directory) {</span>
<a href="#l24.37"></a><span id="l24.37">     do_check_eq(prefId, card.directoryId);</span>
<a href="#l24.38"></a><span id="l24.38"> </span>
<a href="#l24.39"></a><span id="l24.39">     // Question 2.2: Is the local ID unique and valid?</span>
<a href="#l24.40"></a><span id="l24.40">     do_check_neq(card.localId, &quot;&quot;);</span>
<a href="#l24.41"></a><span id="l24.41">     do_check_eq(seenIds.indexOf(card.localId), -1);</span>
<a href="#l24.42"></a><span id="l24.42">     seenIds.push(card.localId);</span>
<a href="#l24.43"></a><span id="l24.43"> </span>
<a href="#l24.44"></a><span id="l24.44">     // Question 2.3: Is the format equal to generateUUID?</span>
<a href="#l24.45"></a><span id="l24.45" class="difflineminus">-    do_check_eq(card.uuid, abMgr.generateUUID(prefId, card.localId));</span>
<a href="#l24.46"></a><span id="l24.46" class="difflineplus">+    do_check_eq(card.uuid, MailServices.ab.generateUUID(prefId, card.localId));</span>
<a href="#l24.47"></a><span id="l24.47">   }</span>
<a href="#l24.48"></a><span id="l24.48"> </span>
<a href="#l24.49"></a><span id="l24.49">   // Question 3: Do cards returned via searches return UUIDs correctly?</span>
<a href="#l24.50"></a><span id="l24.50">   var uri = directory.URI;</span>
<a href="#l24.51"></a><span id="l24.51">   uri += &quot;?(or(DisplayName,=,a)(DisplayName,!=,a))&quot;;</span>
<a href="#l24.52"></a><span id="l24.52" class="difflineminus">-  var search = abMgr.getDirectory(uri);</span>
<a href="#l24.53"></a><span id="l24.53" class="difflineminus">-  </span>
<a href="#l24.54"></a><span id="l24.54" class="difflineplus">+  let search = MailServices.ab.getDirectory(uri);</span>
<a href="#l24.55"></a><span id="l24.55" class="difflineplus">+</span>
<a href="#l24.56"></a><span id="l24.56">   enumerator = search.childCards;</span>
<a href="#l24.57"></a><span id="l24.57">   while (enumerator.hasMoreElements()) {</span>
<a href="#l24.58"></a><span id="l24.58">     var card = enumerator.getNext().QueryInterface(Ci.nsIAbCard);</span>
<a href="#l24.59"></a><span id="l24.59"> </span>
<a href="#l24.60"></a><span id="l24.60">     // Question 3.1: Is the directory ID correct?</span>
<a href="#l24.61"></a><span id="l24.61">     do_check_eq(prefId, card.directoryId);</span>
<a href="#l24.62"></a><span id="l24.62"> </span>
<a href="#l24.63"></a><span id="l24.63">     // Question 3.2: Is the local ID valid?</span>
<a href="#l24.64"></a><span id="l24.64">     do_check_neq(card.localId, &quot;&quot;);</span>
<a href="#l24.65"></a><span id="l24.65"> </span>
<a href="#l24.66"></a><span id="l24.66">     // Question 3.3: Is the format equal to generateUUID?</span>
<a href="#l24.67"></a><span id="l24.67" class="difflineminus">-    do_check_eq(card.uuid, abMgr.generateUUID(prefId, card.localId));</span>
<a href="#l24.68"></a><span id="l24.68" class="difflineplus">+    do_check_eq(card.uuid, MailServices.ab.generateUUID(prefId, card.localId));</span>
<a href="#l24.69"></a><span id="l24.69">   }</span>
<a href="#l24.70"></a><span id="l24.70"> </span>
<a href="#l24.71"></a><span id="l24.71">   // The remaining tests deal with modification of address books.</span>
<a href="#l24.72"></a><span id="l24.72">   if (!testModification)</span>
<a href="#l24.73"></a><span id="l24.73">     return;</span>
<a href="#l24.74"></a><span id="l24.74" class="difflineminus">-  </span>
<a href="#l24.75"></a><span id="l24.75" class="difflineplus">+</span>
<a href="#l24.76"></a><span id="l24.76">   // Question 4: Does adding a new card properly set the UUID?</span>
<a href="#l24.77"></a><span id="l24.77">   var newCard = Cc[&quot;@mozilla.org/addressbook/cardproperty;1&quot;]</span>
<a href="#l24.78"></a><span id="l24.78">                   .createInstance(Ci.nsIAbCard);</span>
<a href="#l24.79"></a><span id="l24.79">   newCard.displayName = &quot;Test User&quot;;</span>
<a href="#l24.80"></a><span id="l24.80">   newCard.primaryEmail = &quot;user1@test.invalid&quot;;</span>
<a href="#l24.81"></a><span id="l24.81">   newCard.firstName = &quot;Test&quot;;</span>
<a href="#l24.82"></a><span id="l24.82">   newCard.lastName = &quot;User&quot;;</span>
<a href="#l24.83"></a><span id="l24.83"> </span>
<a href="#l24.84"></a><span id="l24.84" class="difflineat">@@ -110,15 +109,14 @@ function run_test() {</span>
<a href="#l24.85"></a><span id="l24.85">   // Step 1: What is the ID of an empty card?</span>
<a href="#l24.86"></a><span id="l24.86">   var newCard = Cc[&quot;@mozilla.org/addressbook/cardproperty;1&quot;]</span>
<a href="#l24.87"></a><span id="l24.87">                   .createInstance(Ci.nsIAbCard);</span>
<a href="#l24.88"></a><span id="l24.88">   do_check_eq(newCard.uuid, &quot;&quot;);</span>
<a href="#l24.89"></a><span id="l24.89">   do_check_eq(newCard.directoryId, &quot;&quot;);</span>
<a href="#l24.90"></a><span id="l24.90">   do_check_eq(newCard.localId, &quot;&quot;);</span>
<a href="#l24.91"></a><span id="l24.91"> </span>
<a href="#l24.92"></a><span id="l24.92">   // Step 2: Check the directories</span>
<a href="#l24.93"></a><span id="l24.93" class="difflineminus">-  abMgr = Cc[&quot;@mozilla.org/abmanager;1&quot;].getService(Ci.nsIAbManager);</span>
<a href="#l24.94"></a><span id="l24.94" class="difflineminus">-  var dirs = abMgr.directories;</span>
<a href="#l24.95"></a><span id="l24.95" class="difflineplus">+  let dirs = MailServices.ab.directories;</span>
<a href="#l24.96"></a><span id="l24.96">   while (dirs.hasMoreElements()) {</span>
<a href="#l24.97"></a><span id="l24.97" class="difflineminus">-    var directory = dirs.getNext().QueryInterface(Ci.nsIAbDirectory);</span>
<a href="#l24.98"></a><span id="l24.98" class="difflineplus">+    let directory = dirs.getNext().QueryInterface(Ci.nsIAbDirectory);</span>
<a href="#l24.99"></a><span id="l24.99">     check_directory(directory);</span>
<a href="#l24.100"></a><span id="l24.100">   }</span>
<a href="#l24.101"></a><span id="l24.101"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/mailnews/test/resources/abSetup.js</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/mailnews/test/resources/abSetup.js</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -2,16 +2,18 @@</span>
<a href="#l25.4"></a><span id="l25.4"> /*</span>
<a href="#l25.5"></a><span id="l25.5">  * Sets up the directory service provider to return the app dir as the profile</span>
<a href="#l25.6"></a><span id="l25.6">  * directory for the address book to use for locating its files during the</span>
<a href="#l25.7"></a><span id="l25.7">  * tests.</span>
<a href="#l25.8"></a><span id="l25.8">  *</span>
<a href="#l25.9"></a><span id="l25.9">  * Note there are further configuration setup items below this.</span>
<a href="#l25.10"></a><span id="l25.10">  */</span>
<a href="#l25.11"></a><span id="l25.11"> </span>
<a href="#l25.12"></a><span id="l25.12" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineplus">+</span>
<a href="#l25.14"></a><span id="l25.14"> /**</span>
<a href="#l25.15"></a><span id="l25.15">  * General Configuration Data that applies to the address book.</span>
<a href="#l25.16"></a><span id="l25.16">  */</span>
<a href="#l25.17"></a><span id="l25.17"> </span>
<a href="#l25.18"></a><span id="l25.18"> // Personal Address Book configuration items.</span>
<a href="#l25.19"></a><span id="l25.19"> var kPABData =</span>
<a href="#l25.20"></a><span id="l25.20"> {</span>
<a href="#l25.21"></a><span id="l25.21">   URI: &quot;moz-abmdbdirectory://abook.mab&quot;,</span>
<a href="#l25.22"></a><span id="l25.22" class="difflineat">@@ -43,15 +45,13 @@ var kOSXData =</span>
<a href="#l25.23"></a><span id="l25.23">   dirName: &quot;Mac OS X Address Book&quot;,</span>
<a href="#l25.24"></a><span id="l25.24">   dirType: 3,</span>
<a href="#l25.25"></a><span id="l25.25">   dirPrefID: &quot;ldap_2.servers.osx&quot;,</span>
<a href="#l25.26"></a><span id="l25.26">   readOnly: true,</span>
<a href="#l25.27"></a><span id="l25.27">   position: 1</span>
<a href="#l25.28"></a><span id="l25.28"> };</span>
<a href="#l25.29"></a><span id="l25.29"> </span>
<a href="#l25.30"></a><span id="l25.30"> // Windows (Outlook Express) Address Book deactivation. (Bug 448859)</span>
<a href="#l25.31"></a><span id="l25.31" class="difflineminus">-Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l25.32"></a><span id="l25.32" class="difflineminus">-          .getService(Components.interfaces.nsIPrefBranch)</span>
<a href="#l25.33"></a><span id="l25.33" class="difflineminus">-          .deleteBranch(&quot;ldap_2.servers.oe.&quot;);</span>
<a href="#l25.34"></a><span id="l25.34" class="difflineplus">+Services.prefs.deleteBranch(&quot;ldap_2.servers.oe.&quot;);</span>
<a href="#l25.35"></a><span id="l25.35"> </span>
<a href="#l25.36"></a><span id="l25.36"> // This currently applies to all address books of local type.</span>
<a href="#l25.37"></a><span id="l25.37"> const kNormalPropertiesURI =</span>
<a href="#l25.38"></a><span id="l25.38">   &quot;chrome://messenger/content/addressbook/abAddressBookNameDialog.xul&quot;;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/mailnews/test/resources/mailDirService.js</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/mailnews/test/resources/mailDirService.js</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -7,16 +7,21 @@</span>
<a href="#l26.4"></a><span id="l26.4">  * For xpcshell tests, the &quot;profile&quot; directory will be &lt;profile_dir&gt;/mailtest/</span>
<a href="#l26.5"></a><span id="l26.5">  */</span>
<a href="#l26.6"></a><span id="l26.6"> </span>
<a href="#l26.7"></a><span id="l26.7"> // Make sure we execute this file exactly once</span>
<a href="#l26.8"></a><span id="l26.8"> var gMailDirService_js__;</span>
<a href="#l26.9"></a><span id="l26.9"> if (!gMailDirService_js__) {</span>
<a href="#l26.10"></a><span id="l26.10"> gMailDirService_js__ = true;</span>
<a href="#l26.11"></a><span id="l26.11"> </span>
<a href="#l26.12"></a><span id="l26.12" class="difflineplus">+// Services</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l26.14"></a><span id="l26.14" class="difflineplus">+// MailServices</span>
<a href="#l26.15"></a><span id="l26.15" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l26.16"></a><span id="l26.16" class="difflineplus">+</span>
<a href="#l26.17"></a><span id="l26.17"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l26.18"></a><span id="l26.18"> </span>
<a href="#l26.19"></a><span id="l26.19"> // Declare these globally for unit tests and be done with it.</span>
<a href="#l26.20"></a><span id="l26.20"> var Cc = Components.classes;</span>
<a href="#l26.21"></a><span id="l26.21"> var Ci = Components.interfaces;</span>
<a href="#l26.22"></a><span id="l26.22"> var Cr = Components.results;</span>
<a href="#l26.23"></a><span id="l26.23"> var CC = Components.Constructor;</span>
<a href="#l26.24"></a><span id="l26.24"> </span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

