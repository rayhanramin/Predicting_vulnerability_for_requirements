<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 25314:9a6732b236dae53ed8b7cf4da8851755c7498ba8</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 9a6732b236dae53ed8b7cf4da8851755c7498ba8" />
<meta property="og:url" content="/comm-central/rev/9a6732b236dae53ed8b7cf4da8851755c7498ba8" />
<meta property="og:description" content="Bug 1510097 - Move bootstrapped extension and install.rdf handling to comm-central. r=mkmelin" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 9a6732b236dae53ed8b7cf4da8851755c7498ba8 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/9a6732b236dae53ed8b7cf4da8851755c7498ba8">shortlog</a> |
<a href="/comm-central/log/9a6732b236dae53ed8b7cf4da8851755c7498ba8">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/9a6732b236dae53ed8b7cf4da8851755c7498ba8">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/9a6732b236dae53ed8b7cf4da8851755c7498ba8">files</a> |
changeset |
<a href="/comm-central/raw-rev/9a6732b236dae53ed8b7cf4da8851755c7498ba8">raw</a>  | <a href="/comm-central/archive/9a6732b236dae53ed8b7cf4da8851755c7498ba8.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1510097">Bug 1510097</a> - Move bootstrapped extension and install.rdf handling to comm-central. r=mkmelin
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#71;&#101;&#111;&#102;&#102;&#32;&#76;&#97;&#110;&#107;&#111;&#119;&#32;&#60;&#103;&#101;&#111;&#102;&#102;&#64;&#100;&#97;&#114;&#107;&#116;&#114;&#111;&#106;&#97;&#110;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 30 Nov 2018 11:16:51 +1300</td></tr>

<tr>
 <td>changeset 25314</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/9a6732b236dae53ed8b7cf4da8851755c7498ba8">9a6732b236dae53ed8b7cf4da8851755c7498ba8</a></td>
</tr>



<tr>
<td>parent 25313</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/95ff25a433f1ccd0edad426c5b966459c0f9f085">95ff25a433f1ccd0edad426c5b966459c0f9f085</a>
</td>
</tr>

<tr>
<td>child 25315</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/23e639499671242b915d89b4cc4144410365e699">23e639499671242b915d89b4cc4144410365e699</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=9a6732b236dae53ed8b7cf4da8851755c7498ba8">15186</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Fri, 30 Nov 2018 08:29:41 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@9a6732b236da [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=9a6732b236dae53ed8b7cf4da8851755c7498ba8">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=9a6732b236dae53ed8b7cf4da8851755c7498ba8&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=9a6732b236dae53ed8b7cf4da8851755c7498ba8&newProject=comm-central&newRevision=9a6732b236dae53ed8b7cf4da8851755c7498ba8&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=9a6732b236dae53ed8b7cf4da8851755c7498ba8&newProject=comm-central&newRevision=9a6732b236dae53ed8b7cf4da8851755c7498ba8&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=9a6732b236dae53ed8b7cf4da8851755c7498ba8&newProject=comm-central&newRevision=9a6732b236dae53ed8b7cf4da8851755c7498ba8&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mkmelin%29&revcount=50">mkmelin</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1510097">1510097</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1510097">Bug 1510097</a> - Move bootstrapped extension and install.rdf handling to comm-central. r=mkmelin</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/moz.build">common/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/moz.build">file</a> |
<a href="/comm-central/annotate/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/moz.build">annotate</a> |
<a href="/comm-central/diff/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/moz.build">diff</a> |
<a href="/comm-central/comparison/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/moz.build">comparison</a> |
<a href="/comm-central/log/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/moz.build">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/src/BootstrapLoader.jsm">common/src/BootstrapLoader.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/src/BootstrapLoader.jsm">file</a> |
<a href="/comm-central/annotate/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/src/BootstrapLoader.jsm">annotate</a> |
<a href="/comm-central/diff/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/src/BootstrapLoader.jsm">diff</a> |
<a href="/comm-central/comparison/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/src/BootstrapLoader.jsm">comparison</a> |
<a href="/comm-central/log/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/src/BootstrapLoader.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/src/RDFManifestConverter.jsm">common/src/RDFManifestConverter.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/src/RDFManifestConverter.jsm">file</a> |
<a href="/comm-central/annotate/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/src/RDFManifestConverter.jsm">annotate</a> |
<a href="/comm-central/diff/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/src/RDFManifestConverter.jsm">diff</a> |
<a href="/comm-central/comparison/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/src/RDFManifestConverter.jsm">comparison</a> |
<a href="/comm-central/log/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/src/RDFManifestConverter.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/src/moz.build">common/src/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/src/moz.build">file</a> |
<a href="/comm-central/annotate/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/src/moz.build">annotate</a> |
<a href="/comm-central/diff/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/src/moz.build">diff</a> |
<a href="/comm-central/comparison/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/src/moz.build">comparison</a> |
<a href="/comm-central/log/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/src/moz.build">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/test/xpcshell/.eslintrc.js">common/test/xpcshell/.eslintrc.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/test/xpcshell/.eslintrc.js">file</a> |
<a href="/comm-central/annotate/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/test/xpcshell/.eslintrc.js">annotate</a> |
<a href="/comm-central/diff/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/test/xpcshell/.eslintrc.js">diff</a> |
<a href="/comm-central/comparison/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/test/xpcshell/.eslintrc.js">comparison</a> |
<a href="/comm-central/log/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/test/xpcshell/.eslintrc.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/test/xpcshell/data/BootstrapMonitor.jsm">common/test/xpcshell/data/BootstrapMonitor.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/test/xpcshell/data/BootstrapMonitor.jsm">file</a> |
<a href="/comm-central/annotate/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/test/xpcshell/data/BootstrapMonitor.jsm">annotate</a> |
<a href="/comm-central/diff/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/test/xpcshell/data/BootstrapMonitor.jsm">diff</a> |
<a href="/comm-central/comparison/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/test/xpcshell/data/BootstrapMonitor.jsm">comparison</a> |
<a href="/comm-central/log/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/test/xpcshell/data/BootstrapMonitor.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/test/xpcshell/head_addons.js">common/test/xpcshell/head_addons.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/test/xpcshell/head_addons.js">file</a> |
<a href="/comm-central/annotate/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/test/xpcshell/head_addons.js">annotate</a> |
<a href="/comm-central/diff/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/test/xpcshell/head_addons.js">diff</a> |
<a href="/comm-central/comparison/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/test/xpcshell/head_addons.js">comparison</a> |
<a href="/comm-central/log/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/test/xpcshell/head_addons.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/test/xpcshell/test_bootstrap.js">common/test/xpcshell/test_bootstrap.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/test/xpcshell/test_bootstrap.js">file</a> |
<a href="/comm-central/annotate/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/test/xpcshell/test_bootstrap.js">annotate</a> |
<a href="/comm-central/diff/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/test/xpcshell/test_bootstrap.js">diff</a> |
<a href="/comm-central/comparison/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/test/xpcshell/test_bootstrap.js">comparison</a> |
<a href="/comm-central/log/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/test/xpcshell/test_bootstrap.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/test/xpcshell/test_bootstrap_const.js">common/test/xpcshell/test_bootstrap_const.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/test/xpcshell/test_bootstrap_const.js">file</a> |
<a href="/comm-central/annotate/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/test/xpcshell/test_bootstrap_const.js">annotate</a> |
<a href="/comm-central/diff/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/test/xpcshell/test_bootstrap_const.js">diff</a> |
<a href="/comm-central/comparison/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/test/xpcshell/test_bootstrap_const.js">comparison</a> |
<a href="/comm-central/log/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/test/xpcshell/test_bootstrap_const.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/test/xpcshell/test_bootstrap_globals.js">common/test/xpcshell/test_bootstrap_globals.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/test/xpcshell/test_bootstrap_globals.js">file</a> |
<a href="/comm-central/annotate/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/test/xpcshell/test_bootstrap_globals.js">annotate</a> |
<a href="/comm-central/diff/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/test/xpcshell/test_bootstrap_globals.js">diff</a> |
<a href="/comm-central/comparison/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/test/xpcshell/test_bootstrap_globals.js">comparison</a> |
<a href="/comm-central/log/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/test/xpcshell/test_bootstrap_globals.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/test/xpcshell/test_bootstrapped_chrome_manifest.js">common/test/xpcshell/test_bootstrapped_chrome_manifest.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/test/xpcshell/test_bootstrapped_chrome_manifest.js">file</a> |
<a href="/comm-central/annotate/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/test/xpcshell/test_bootstrapped_chrome_manifest.js">annotate</a> |
<a href="/comm-central/diff/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/test/xpcshell/test_bootstrapped_chrome_manifest.js">diff</a> |
<a href="/comm-central/comparison/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/test/xpcshell/test_bootstrapped_chrome_manifest.js">comparison</a> |
<a href="/comm-central/log/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/test/xpcshell/test_bootstrapped_chrome_manifest.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/test/xpcshell/test_invalid_install_rdf.js">common/test/xpcshell/test_invalid_install_rdf.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/test/xpcshell/test_invalid_install_rdf.js">file</a> |
<a href="/comm-central/annotate/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/test/xpcshell/test_invalid_install_rdf.js">annotate</a> |
<a href="/comm-central/diff/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/test/xpcshell/test_invalid_install_rdf.js">diff</a> |
<a href="/comm-central/comparison/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/test/xpcshell/test_invalid_install_rdf.js">comparison</a> |
<a href="/comm-central/log/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/test/xpcshell/test_invalid_install_rdf.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/test/xpcshell/test_manifest.js">common/test/xpcshell/test_manifest.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/test/xpcshell/test_manifest.js">file</a> |
<a href="/comm-central/annotate/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/test/xpcshell/test_manifest.js">annotate</a> |
<a href="/comm-central/diff/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/test/xpcshell/test_manifest.js">diff</a> |
<a href="/comm-central/comparison/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/test/xpcshell/test_manifest.js">comparison</a> |
<a href="/comm-central/log/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/test/xpcshell/test_manifest.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/test/xpcshell/test_manifest_locales.js">common/test/xpcshell/test_manifest_locales.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/test/xpcshell/test_manifest_locales.js">file</a> |
<a href="/comm-central/annotate/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/test/xpcshell/test_manifest_locales.js">annotate</a> |
<a href="/comm-central/diff/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/test/xpcshell/test_manifest_locales.js">diff</a> |
<a href="/comm-central/comparison/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/test/xpcshell/test_manifest_locales.js">comparison</a> |
<a href="/comm-central/log/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/test/xpcshell/test_manifest_locales.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/test/xpcshell/xpcshell.ini">common/test/xpcshell/xpcshell.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/test/xpcshell/xpcshell.ini">file</a> |
<a href="/comm-central/annotate/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/test/xpcshell/xpcshell.ini">annotate</a> |
<a href="/comm-central/diff/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/test/xpcshell/xpcshell.ini">diff</a> |
<a href="/comm-central/comparison/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/test/xpcshell/xpcshell.ini">comparison</a> |
<a href="/comm-central/log/9a6732b236dae53ed8b7cf4da8851755c7498ba8/common/test/xpcshell/xpcshell.ini">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9a6732b236dae53ed8b7cf4da8851755c7498ba8/mail/components/mailGlue.js">mail/components/mailGlue.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9a6732b236dae53ed8b7cf4da8851755c7498ba8/mail/components/mailGlue.js">file</a> |
<a href="/comm-central/annotate/9a6732b236dae53ed8b7cf4da8851755c7498ba8/mail/components/mailGlue.js">annotate</a> |
<a href="/comm-central/diff/9a6732b236dae53ed8b7cf4da8851755c7498ba8/mail/components/mailGlue.js">diff</a> |
<a href="/comm-central/comparison/9a6732b236dae53ed8b7cf4da8851755c7498ba8/mail/components/mailGlue.js">comparison</a> |
<a href="/comm-central/log/9a6732b236dae53ed8b7cf4da8851755c7498ba8/mail/components/mailGlue.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/common/moz.build</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/common/moz.build</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -4,8 +4,12 @@</span>
<a href="#l1.4"></a><span id="l1.4"> # file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l1.5"></a><span id="l1.5"> </span>
<a href="#l1.6"></a><span id="l1.6"> DIRS += [</span>
<a href="#l1.7"></a><span id="l1.7">     'public',</span>
<a href="#l1.8"></a><span id="l1.8">     'src'</span>
<a href="#l1.9"></a><span id="l1.9"> ]</span>
<a href="#l1.10"></a><span id="l1.10"> </span>
<a href="#l1.11"></a><span id="l1.11"> JAR_MANIFESTS += ['jar.mn']</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+XPCSHELL_TESTS_MANIFESTS += [</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+    'test/xpcshell/xpcshell.ini',</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1">new file mode 100644</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineminus">--- /dev/null</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineplus">+++ b/common/src/BootstrapLoader.jsm</span>
<a href="#l2.4"></a><span id="l2.4" class="difflineat">@@ -0,0 +1,366 @@</span>
<a href="#l2.5"></a><span id="l2.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l2.6"></a><span id="l2.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l2.7"></a><span id="l2.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l2.8"></a><span id="l2.8" class="difflineplus">+</span>
<a href="#l2.9"></a><span id="l2.9" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l2.10"></a><span id="l2.10" class="difflineplus">+</span>
<a href="#l2.11"></a><span id="l2.11" class="difflineplus">+var EXPORTED_SYMBOLS = [&quot;BootstrapLoader&quot;];</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+ChromeUtils.import(&quot;resource://gre/modules/AddonManager.jsm&quot;);</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+XPCOMUtils.defineLazyModuleGetters(this, {</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+  AddonInternal: &quot;resource://gre/modules/addons/XPIDatabase.jsm&quot;,</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+  Blocklist: &quot;resource://gre/modules/Blocklist.jsm&quot;,</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+  ConsoleAPI: &quot;resource://gre/modules/Console.jsm&quot;,</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+  InstallRDF: &quot;resource:///modules/RDFManifestConverter.jsm&quot;,</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineplus">+  Services: &quot;resource://gre/modules/Services.jsm&quot;,</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineplus">+});</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineplus">+</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineplus">+XPCOMUtils.defineLazyGetter(this, &quot;BOOTSTRAP_REASONS&quot;, () =&gt; {</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineplus">+  const {XPIProvider} = ChromeUtils.import(&quot;resource://gre/modules/addons/XPIProvider.jsm&quot;, {});</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineplus">+  return XPIProvider.BOOTSTRAP_REASONS;</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineplus">+});</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineplus">+</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineplus">+ChromeUtils.import(&quot;resource://gre/modules/Log.jsm&quot;);</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineplus">+var logger = Log.repository.getLogger(&quot;addons.bootstrap&quot;);</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+/**</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+ * Valid IDs fit this pattern.</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+ */</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+var gIDTest = /^(\{[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}\}|[a-z0-9-\._]*\@[a-z0-9-\._]+)$/i;</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+// Properties that exist in the install manifest</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+const PROP_METADATA      = [&quot;id&quot;, &quot;version&quot;, &quot;type&quot;, &quot;internalName&quot;, &quot;updateURL&quot;,</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineplus">+                            &quot;optionsURL&quot;, &quot;optionsType&quot;, &quot;aboutURL&quot;, &quot;iconURL&quot;];</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineplus">+const PROP_LOCALE_SINGLE = [&quot;name&quot;, &quot;description&quot;, &quot;creator&quot;, &quot;homepageURL&quot;];</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+const PROP_LOCALE_MULTI  = [&quot;developers&quot;, &quot;translators&quot;, &quot;contributors&quot;];</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineplus">+</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineplus">+// Map new string type identifiers to old style nsIUpdateItem types.</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineplus">+// Retired values:</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineplus">+// 32 = multipackage xpi file</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineplus">+// 8 = locale</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineplus">+// 256 = apiextension</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineplus">+// 128 = experiment</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineplus">+// theme = 4</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineplus">+const TYPES = {</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineplus">+  extension: 2,</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineplus">+  dictionary: 64,</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineplus">+};</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineplus">+</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineplus">+const COMPATIBLE_BY_DEFAULT_TYPES = {</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineplus">+  extension: true,</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineplus">+  dictionary: true,</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineplus">+};</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineplus">+</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineplus">+const hasOwnProperty = Function.call.bind(Object.prototype.hasOwnProperty);</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineplus">+</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineplus">+function isXPI(filename) {</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineplus">+  let ext = filename.slice(-4).toLowerCase();</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineplus">+  return ext === &quot;.xpi&quot; || ext === &quot;.zip&quot;;</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineplus">+}</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineplus">+</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineplus">+/**</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineplus">+ * Gets an nsIURI for a file within another file, either a directory or an XPI</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineplus">+ * file. If aFile is a directory then this will return a file: URI, if it is an</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineplus">+ * XPI file then it will return a jar: URI.</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineplus">+ *</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineplus">+ * @param {nsIFile} aFile</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineplus">+ *        The file containing the resources, must be either a directory or an</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineplus">+ *        XPI file</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineplus">+ * @param {string} aPath</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineplus">+ *        The path to find the resource at, &quot;/&quot; separated. If aPath is empty</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineplus">+ *        then the uri to the root of the contained files will be returned</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineplus">+ * @returns {nsIURI}</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineplus">+ *        An nsIURI pointing at the resource</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineplus">+ */</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineplus">+function getURIForResourceInFile(aFile, aPath) {</span>
<a href="#l2.82"></a><span id="l2.82" class="difflineplus">+  if (!isXPI(aFile.leafName)) {</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineplus">+    let resource = aFile.clone();</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineplus">+    if (aPath)</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineplus">+      aPath.split(&quot;/&quot;).forEach(part =&gt; resource.append(part));</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineplus">+</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineplus">+    return Services.io.newFileURI(resource);</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineplus">+  }</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineplus">+</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineplus">+  return buildJarURI(aFile, aPath);</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineplus">+}</span>
<a href="#l2.92"></a><span id="l2.92" class="difflineplus">+</span>
<a href="#l2.93"></a><span id="l2.93" class="difflineplus">+/**</span>
<a href="#l2.94"></a><span id="l2.94" class="difflineplus">+ * Creates a jar: URI for a file inside a ZIP file.</span>
<a href="#l2.95"></a><span id="l2.95" class="difflineplus">+ *</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineplus">+ * @param {nsIFile} aJarfile</span>
<a href="#l2.97"></a><span id="l2.97" class="difflineplus">+ *        The ZIP file as an nsIFile</span>
<a href="#l2.98"></a><span id="l2.98" class="difflineplus">+ * @param {string} aPath</span>
<a href="#l2.99"></a><span id="l2.99" class="difflineplus">+ *        The path inside the ZIP file</span>
<a href="#l2.100"></a><span id="l2.100" class="difflineplus">+ * @returns {nsIURI}</span>
<a href="#l2.101"></a><span id="l2.101" class="difflineplus">+ *        An nsIURI for the file</span>
<a href="#l2.102"></a><span id="l2.102" class="difflineplus">+ */</span>
<a href="#l2.103"></a><span id="l2.103" class="difflineplus">+function buildJarURI(aJarfile, aPath) {</span>
<a href="#l2.104"></a><span id="l2.104" class="difflineplus">+  let uri = Services.io.newFileURI(aJarfile);</span>
<a href="#l2.105"></a><span id="l2.105" class="difflineplus">+  uri = &quot;jar:&quot; + uri.spec + &quot;!/&quot; + aPath;</span>
<a href="#l2.106"></a><span id="l2.106" class="difflineplus">+  return Services.io.newURI(uri);</span>
<a href="#l2.107"></a><span id="l2.107" class="difflineplus">+}</span>
<a href="#l2.108"></a><span id="l2.108" class="difflineplus">+</span>
<a href="#l2.109"></a><span id="l2.109" class="difflineplus">+var BootstrapLoader = {</span>
<a href="#l2.110"></a><span id="l2.110" class="difflineplus">+  name: &quot;bootstrap&quot;,</span>
<a href="#l2.111"></a><span id="l2.111" class="difflineplus">+  manifestFile: &quot;install.rdf&quot;,</span>
<a href="#l2.112"></a><span id="l2.112" class="difflineplus">+  async loadManifest(pkg) {</span>
<a href="#l2.113"></a><span id="l2.113" class="difflineplus">+    /**</span>
<a href="#l2.114"></a><span id="l2.114" class="difflineplus">+     * Reads locale properties from either the main install manifest root or</span>
<a href="#l2.115"></a><span id="l2.115" class="difflineplus">+     * an em:localized section in the install manifest.</span>
<a href="#l2.116"></a><span id="l2.116" class="difflineplus">+     *</span>
<a href="#l2.117"></a><span id="l2.117" class="difflineplus">+     * @param {Object} aSource</span>
<a href="#l2.118"></a><span id="l2.118" class="difflineplus">+     *        The resource to read the properties from.</span>
<a href="#l2.119"></a><span id="l2.119" class="difflineplus">+     * @param {boolean} isDefault</span>
<a href="#l2.120"></a><span id="l2.120" class="difflineplus">+     *        True if the locale is to be read from the main install manifest</span>
<a href="#l2.121"></a><span id="l2.121" class="difflineplus">+     *        root</span>
<a href="#l2.122"></a><span id="l2.122" class="difflineplus">+     * @param {string[]} aSeenLocales</span>
<a href="#l2.123"></a><span id="l2.123" class="difflineplus">+     *        An array of locale names already seen for this install manifest.</span>
<a href="#l2.124"></a><span id="l2.124" class="difflineplus">+     *        Any locale names seen as a part of this function will be added to</span>
<a href="#l2.125"></a><span id="l2.125" class="difflineplus">+     *        this array</span>
<a href="#l2.126"></a><span id="l2.126" class="difflineplus">+     * @returns {Object}</span>
<a href="#l2.127"></a><span id="l2.127" class="difflineplus">+     *        an object containing the locale properties</span>
<a href="#l2.128"></a><span id="l2.128" class="difflineplus">+     */</span>
<a href="#l2.129"></a><span id="l2.129" class="difflineplus">+    function readLocale(aSource, isDefault, aSeenLocales) {</span>
<a href="#l2.130"></a><span id="l2.130" class="difflineplus">+      let locale = {};</span>
<a href="#l2.131"></a><span id="l2.131" class="difflineplus">+      if (!isDefault) {</span>
<a href="#l2.132"></a><span id="l2.132" class="difflineplus">+        locale.locales = [];</span>
<a href="#l2.133"></a><span id="l2.133" class="difflineplus">+        for (let localeName of aSource.locales || []) {</span>
<a href="#l2.134"></a><span id="l2.134" class="difflineplus">+          if (!localeName) {</span>
<a href="#l2.135"></a><span id="l2.135" class="difflineplus">+            logger.warn(&quot;Ignoring empty locale in localized properties&quot;);</span>
<a href="#l2.136"></a><span id="l2.136" class="difflineplus">+            continue;</span>
<a href="#l2.137"></a><span id="l2.137" class="difflineplus">+          }</span>
<a href="#l2.138"></a><span id="l2.138" class="difflineplus">+          if (aSeenLocales.includes(localeName)) {</span>
<a href="#l2.139"></a><span id="l2.139" class="difflineplus">+            logger.warn(&quot;Ignoring duplicate locale in localized properties&quot;);</span>
<a href="#l2.140"></a><span id="l2.140" class="difflineplus">+            continue;</span>
<a href="#l2.141"></a><span id="l2.141" class="difflineplus">+          }</span>
<a href="#l2.142"></a><span id="l2.142" class="difflineplus">+          aSeenLocales.push(localeName);</span>
<a href="#l2.143"></a><span id="l2.143" class="difflineplus">+          locale.locales.push(localeName);</span>
<a href="#l2.144"></a><span id="l2.144" class="difflineplus">+        }</span>
<a href="#l2.145"></a><span id="l2.145" class="difflineplus">+</span>
<a href="#l2.146"></a><span id="l2.146" class="difflineplus">+        if (locale.locales.length == 0) {</span>
<a href="#l2.147"></a><span id="l2.147" class="difflineplus">+          logger.warn(&quot;Ignoring localized properties with no listed locales&quot;);</span>
<a href="#l2.148"></a><span id="l2.148" class="difflineplus">+          return null;</span>
<a href="#l2.149"></a><span id="l2.149" class="difflineplus">+        }</span>
<a href="#l2.150"></a><span id="l2.150" class="difflineplus">+      }</span>
<a href="#l2.151"></a><span id="l2.151" class="difflineplus">+</span>
<a href="#l2.152"></a><span id="l2.152" class="difflineplus">+      for (let prop of [...PROP_LOCALE_SINGLE, ...PROP_LOCALE_MULTI]) {</span>
<a href="#l2.153"></a><span id="l2.153" class="difflineplus">+        if (hasOwnProperty(aSource, prop)) {</span>
<a href="#l2.154"></a><span id="l2.154" class="difflineplus">+          locale[prop] = aSource[prop];</span>
<a href="#l2.155"></a><span id="l2.155" class="difflineplus">+        }</span>
<a href="#l2.156"></a><span id="l2.156" class="difflineplus">+      }</span>
<a href="#l2.157"></a><span id="l2.157" class="difflineplus">+</span>
<a href="#l2.158"></a><span id="l2.158" class="difflineplus">+      return locale;</span>
<a href="#l2.159"></a><span id="l2.159" class="difflineplus">+    }</span>
<a href="#l2.160"></a><span id="l2.160" class="difflineplus">+</span>
<a href="#l2.161"></a><span id="l2.161" class="difflineplus">+    let manifestData = await pkg.readString(&quot;install.rdf&quot;);</span>
<a href="#l2.162"></a><span id="l2.162" class="difflineplus">+    let manifest = InstallRDF.loadFromString(manifestData).decode();</span>
<a href="#l2.163"></a><span id="l2.163" class="difflineplus">+</span>
<a href="#l2.164"></a><span id="l2.164" class="difflineplus">+    let addon = new AddonInternal();</span>
<a href="#l2.165"></a><span id="l2.165" class="difflineplus">+    for (let prop of PROP_METADATA) {</span>
<a href="#l2.166"></a><span id="l2.166" class="difflineplus">+      if (hasOwnProperty(manifest, prop)) {</span>
<a href="#l2.167"></a><span id="l2.167" class="difflineplus">+        addon[prop] = manifest[prop];</span>
<a href="#l2.168"></a><span id="l2.168" class="difflineplus">+      }</span>
<a href="#l2.169"></a><span id="l2.169" class="difflineplus">+    }</span>
<a href="#l2.170"></a><span id="l2.170" class="difflineplus">+</span>
<a href="#l2.171"></a><span id="l2.171" class="difflineplus">+    if (!addon.type) {</span>
<a href="#l2.172"></a><span id="l2.172" class="difflineplus">+      addon.type = &quot;extension&quot;;</span>
<a href="#l2.173"></a><span id="l2.173" class="difflineplus">+    } else {</span>
<a href="#l2.174"></a><span id="l2.174" class="difflineplus">+      let type = addon.type;</span>
<a href="#l2.175"></a><span id="l2.175" class="difflineplus">+      addon.type = null;</span>
<a href="#l2.176"></a><span id="l2.176" class="difflineplus">+      for (let name in TYPES) {</span>
<a href="#l2.177"></a><span id="l2.177" class="difflineplus">+        if (TYPES[name] == type) {</span>
<a href="#l2.178"></a><span id="l2.178" class="difflineplus">+          addon.type = name;</span>
<a href="#l2.179"></a><span id="l2.179" class="difflineplus">+          break;</span>
<a href="#l2.180"></a><span id="l2.180" class="difflineplus">+        }</span>
<a href="#l2.181"></a><span id="l2.181" class="difflineplus">+      }</span>
<a href="#l2.182"></a><span id="l2.182" class="difflineplus">+    }</span>
<a href="#l2.183"></a><span id="l2.183" class="difflineplus">+</span>
<a href="#l2.184"></a><span id="l2.184" class="difflineplus">+    if (!(addon.type in TYPES))</span>
<a href="#l2.185"></a><span id="l2.185" class="difflineplus">+      throw new Error(&quot;Install manifest specifies unknown type: &quot; + addon.type);</span>
<a href="#l2.186"></a><span id="l2.186" class="difflineplus">+</span>
<a href="#l2.187"></a><span id="l2.187" class="difflineplus">+    if (!addon.id)</span>
<a href="#l2.188"></a><span id="l2.188" class="difflineplus">+      throw new Error(&quot;No ID in install manifest&quot;);</span>
<a href="#l2.189"></a><span id="l2.189" class="difflineplus">+    if (!gIDTest.test(addon.id))</span>
<a href="#l2.190"></a><span id="l2.190" class="difflineplus">+      throw new Error(&quot;Illegal add-on ID &quot; + addon.id);</span>
<a href="#l2.191"></a><span id="l2.191" class="difflineplus">+    if (!addon.version)</span>
<a href="#l2.192"></a><span id="l2.192" class="difflineplus">+      throw new Error(&quot;No version in install manifest&quot;);</span>
<a href="#l2.193"></a><span id="l2.193" class="difflineplus">+</span>
<a href="#l2.194"></a><span id="l2.194" class="difflineplus">+    addon.strictCompatibility = (!(addon.type in COMPATIBLE_BY_DEFAULT_TYPES) ||</span>
<a href="#l2.195"></a><span id="l2.195" class="difflineplus">+                                 manifest.strictCompatibility == &quot;true&quot;);</span>
<a href="#l2.196"></a><span id="l2.196" class="difflineplus">+</span>
<a href="#l2.197"></a><span id="l2.197" class="difflineplus">+    // Only read these properties for extensions.</span>
<a href="#l2.198"></a><span id="l2.198" class="difflineplus">+    if (addon.type == &quot;extension&quot;) {</span>
<a href="#l2.199"></a><span id="l2.199" class="difflineplus">+      if (manifest.bootstrap != &quot;true&quot;) {</span>
<a href="#l2.200"></a><span id="l2.200" class="difflineplus">+        throw new Error(&quot;Non-restartless extensions no longer supported&quot;);</span>
<a href="#l2.201"></a><span id="l2.201" class="difflineplus">+      }</span>
<a href="#l2.202"></a><span id="l2.202" class="difflineplus">+</span>
<a href="#l2.203"></a><span id="l2.203" class="difflineplus">+      if (addon.optionsType &amp;&amp;</span>
<a href="#l2.204"></a><span id="l2.204" class="difflineplus">+          addon.optionsType != AddonManager.OPTIONS_TYPE_INLINE_BROWSER &amp;&amp;</span>
<a href="#l2.205"></a><span id="l2.205" class="difflineplus">+          addon.optionsType != AddonManager.OPTIONS_TYPE_TAB) {</span>
<a href="#l2.206"></a><span id="l2.206" class="difflineplus">+            throw new Error(&quot;Install manifest specifies unknown optionsType: &quot; + addon.optionsType);</span>
<a href="#l2.207"></a><span id="l2.207" class="difflineplus">+      }</span>
<a href="#l2.208"></a><span id="l2.208" class="difflineplus">+    } else {</span>
<a href="#l2.209"></a><span id="l2.209" class="difflineplus">+      // Convert legacy dictionaries into a format the WebExtension</span>
<a href="#l2.210"></a><span id="l2.210" class="difflineplus">+      // dictionary loader can process.</span>
<a href="#l2.211"></a><span id="l2.211" class="difflineplus">+      if (addon.type === &quot;dictionary&quot;) {</span>
<a href="#l2.212"></a><span id="l2.212" class="difflineplus">+        addon.loader = null;</span>
<a href="#l2.213"></a><span id="l2.213" class="difflineplus">+        let dictionaries = {};</span>
<a href="#l2.214"></a><span id="l2.214" class="difflineplus">+        await pkg.iterFiles(({path}) =&gt; {</span>
<a href="#l2.215"></a><span id="l2.215" class="difflineplus">+          let match = /^dictionaries\/([^\/]+)\.dic$/.exec(path);</span>
<a href="#l2.216"></a><span id="l2.216" class="difflineplus">+          if (match) {</span>
<a href="#l2.217"></a><span id="l2.217" class="difflineplus">+            let lang = match[1].replace(/_/g, &quot;-&quot;);</span>
<a href="#l2.218"></a><span id="l2.218" class="difflineplus">+            dictionaries[lang] = match[0];</span>
<a href="#l2.219"></a><span id="l2.219" class="difflineplus">+          }</span>
<a href="#l2.220"></a><span id="l2.220" class="difflineplus">+        });</span>
<a href="#l2.221"></a><span id="l2.221" class="difflineplus">+        addon.startupData = {dictionaries};</span>
<a href="#l2.222"></a><span id="l2.222" class="difflineplus">+      }</span>
<a href="#l2.223"></a><span id="l2.223" class="difflineplus">+</span>
<a href="#l2.224"></a><span id="l2.224" class="difflineplus">+      // Only extensions are allowed to provide an optionsURL, optionsType,</span>
<a href="#l2.225"></a><span id="l2.225" class="difflineplus">+      // optionsBrowserStyle, or aboutURL. For all other types they are silently ignored</span>
<a href="#l2.226"></a><span id="l2.226" class="difflineplus">+      addon.aboutURL = null;</span>
<a href="#l2.227"></a><span id="l2.227" class="difflineplus">+      addon.optionsBrowserStyle = null;</span>
<a href="#l2.228"></a><span id="l2.228" class="difflineplus">+      addon.optionsType = null;</span>
<a href="#l2.229"></a><span id="l2.229" class="difflineplus">+      addon.optionsURL = null;</span>
<a href="#l2.230"></a><span id="l2.230" class="difflineplus">+    }</span>
<a href="#l2.231"></a><span id="l2.231" class="difflineplus">+</span>
<a href="#l2.232"></a><span id="l2.232" class="difflineplus">+    addon.defaultLocale = readLocale(manifest, true);</span>
<a href="#l2.233"></a><span id="l2.233" class="difflineplus">+</span>
<a href="#l2.234"></a><span id="l2.234" class="difflineplus">+    let seenLocales = [];</span>
<a href="#l2.235"></a><span id="l2.235" class="difflineplus">+    addon.locales = [];</span>
<a href="#l2.236"></a><span id="l2.236" class="difflineplus">+    for (let localeData of manifest.localized || []) {</span>
<a href="#l2.237"></a><span id="l2.237" class="difflineplus">+      let locale = readLocale(localeData, false, seenLocales);</span>
<a href="#l2.238"></a><span id="l2.238" class="difflineplus">+      if (locale)</span>
<a href="#l2.239"></a><span id="l2.239" class="difflineplus">+        addon.locales.push(locale);</span>
<a href="#l2.240"></a><span id="l2.240" class="difflineplus">+    }</span>
<a href="#l2.241"></a><span id="l2.241" class="difflineplus">+</span>
<a href="#l2.242"></a><span id="l2.242" class="difflineplus">+    let dependencies = new Set(manifest.dependencies);</span>
<a href="#l2.243"></a><span id="l2.243" class="difflineplus">+    addon.dependencies = Object.freeze(Array.from(dependencies));</span>
<a href="#l2.244"></a><span id="l2.244" class="difflineplus">+</span>
<a href="#l2.245"></a><span id="l2.245" class="difflineplus">+    let seenApplications = [];</span>
<a href="#l2.246"></a><span id="l2.246" class="difflineplus">+    addon.targetApplications = [];</span>
<a href="#l2.247"></a><span id="l2.247" class="difflineplus">+    for (let targetApp of manifest.targetApplications || []) {</span>
<a href="#l2.248"></a><span id="l2.248" class="difflineplus">+      if (!targetApp.id || !targetApp.minVersion ||</span>
<a href="#l2.249"></a><span id="l2.249" class="difflineplus">+          !targetApp.maxVersion) {</span>
<a href="#l2.250"></a><span id="l2.250" class="difflineplus">+            logger.warn(&quot;Ignoring invalid targetApplication entry in install manifest&quot;);</span>
<a href="#l2.251"></a><span id="l2.251" class="difflineplus">+            continue;</span>
<a href="#l2.252"></a><span id="l2.252" class="difflineplus">+      }</span>
<a href="#l2.253"></a><span id="l2.253" class="difflineplus">+      if (seenApplications.includes(targetApp.id)) {</span>
<a href="#l2.254"></a><span id="l2.254" class="difflineplus">+        logger.warn(&quot;Ignoring duplicate targetApplication entry for &quot; + targetApp.id +</span>
<a href="#l2.255"></a><span id="l2.255" class="difflineplus">+                    &quot; in install manifest&quot;);</span>
<a href="#l2.256"></a><span id="l2.256" class="difflineplus">+        continue;</span>
<a href="#l2.257"></a><span id="l2.257" class="difflineplus">+      }</span>
<a href="#l2.258"></a><span id="l2.258" class="difflineplus">+      seenApplications.push(targetApp.id);</span>
<a href="#l2.259"></a><span id="l2.259" class="difflineplus">+      addon.targetApplications.push(targetApp);</span>
<a href="#l2.260"></a><span id="l2.260" class="difflineplus">+    }</span>
<a href="#l2.261"></a><span id="l2.261" class="difflineplus">+</span>
<a href="#l2.262"></a><span id="l2.262" class="difflineplus">+    // Note that we don't need to check for duplicate targetPlatform entries since</span>
<a href="#l2.263"></a><span id="l2.263" class="difflineplus">+    // the RDF service coalesces them for us.</span>
<a href="#l2.264"></a><span id="l2.264" class="difflineplus">+    addon.targetPlatforms = [];</span>
<a href="#l2.265"></a><span id="l2.265" class="difflineplus">+    for (let targetPlatform of manifest.targetPlatforms || []) {</span>
<a href="#l2.266"></a><span id="l2.266" class="difflineplus">+      let platform = {</span>
<a href="#l2.267"></a><span id="l2.267" class="difflineplus">+        os: null,</span>
<a href="#l2.268"></a><span id="l2.268" class="difflineplus">+        abi: null,</span>
<a href="#l2.269"></a><span id="l2.269" class="difflineplus">+      };</span>
<a href="#l2.270"></a><span id="l2.270" class="difflineplus">+</span>
<a href="#l2.271"></a><span id="l2.271" class="difflineplus">+      let pos = targetPlatform.indexOf(&quot;_&quot;);</span>
<a href="#l2.272"></a><span id="l2.272" class="difflineplus">+      if (pos != -1) {</span>
<a href="#l2.273"></a><span id="l2.273" class="difflineplus">+        platform.os = targetPlatform.substring(0, pos);</span>
<a href="#l2.274"></a><span id="l2.274" class="difflineplus">+        platform.abi = targetPlatform.substring(pos + 1);</span>
<a href="#l2.275"></a><span id="l2.275" class="difflineplus">+      } else {</span>
<a href="#l2.276"></a><span id="l2.276" class="difflineplus">+        platform.os = targetPlatform;</span>
<a href="#l2.277"></a><span id="l2.277" class="difflineplus">+      }</span>
<a href="#l2.278"></a><span id="l2.278" class="difflineplus">+</span>
<a href="#l2.279"></a><span id="l2.279" class="difflineplus">+      addon.targetPlatforms.push(platform);</span>
<a href="#l2.280"></a><span id="l2.280" class="difflineplus">+    }</span>
<a href="#l2.281"></a><span id="l2.281" class="difflineplus">+</span>
<a href="#l2.282"></a><span id="l2.282" class="difflineplus">+    addon.userDisabled = false;</span>
<a href="#l2.283"></a><span id="l2.283" class="difflineplus">+    addon.softDisabled = addon.blocklistState == Blocklist.STATE_SOFTBLOCKED;</span>
<a href="#l2.284"></a><span id="l2.284" class="difflineplus">+    addon.applyBackgroundUpdates = AddonManager.AUTOUPDATE_DEFAULT;</span>
<a href="#l2.285"></a><span id="l2.285" class="difflineplus">+</span>
<a href="#l2.286"></a><span id="l2.286" class="difflineplus">+    addon.userPermissions = null;</span>
<a href="#l2.287"></a><span id="l2.287" class="difflineplus">+</span>
<a href="#l2.288"></a><span id="l2.288" class="difflineplus">+    addon.icons = {};</span>
<a href="#l2.289"></a><span id="l2.289" class="difflineplus">+    if (await pkg.hasResource(&quot;icon.png&quot;)) {</span>
<a href="#l2.290"></a><span id="l2.290" class="difflineplus">+      addon.icons[32] = &quot;icon.png&quot;;</span>
<a href="#l2.291"></a><span id="l2.291" class="difflineplus">+      addon.icons[48] = &quot;icon.png&quot;;</span>
<a href="#l2.292"></a><span id="l2.292" class="difflineplus">+    }</span>
<a href="#l2.293"></a><span id="l2.293" class="difflineplus">+</span>
<a href="#l2.294"></a><span id="l2.294" class="difflineplus">+    if (await pkg.hasResource(&quot;icon64.png&quot;)) {</span>
<a href="#l2.295"></a><span id="l2.295" class="difflineplus">+      addon.icons[64] = &quot;icon64.png&quot;;</span>
<a href="#l2.296"></a><span id="l2.296" class="difflineplus">+    }</span>
<a href="#l2.297"></a><span id="l2.297" class="difflineplus">+</span>
<a href="#l2.298"></a><span id="l2.298" class="difflineplus">+    return addon;</span>
<a href="#l2.299"></a><span id="l2.299" class="difflineplus">+  },</span>
<a href="#l2.300"></a><span id="l2.300" class="difflineplus">+</span>
<a href="#l2.301"></a><span id="l2.301" class="difflineplus">+  loadScope(addon, file) {</span>
<a href="#l2.302"></a><span id="l2.302" class="difflineplus">+    let uri = getURIForResourceInFile(file, &quot;bootstrap.js&quot;).spec;</span>
<a href="#l2.303"></a><span id="l2.303" class="difflineplus">+    let principal = Services.scriptSecurityManager.getSystemPrincipal();</span>
<a href="#l2.304"></a><span id="l2.304" class="difflineplus">+</span>
<a href="#l2.305"></a><span id="l2.305" class="difflineplus">+    let sandbox = new Cu.Sandbox(principal, {</span>
<a href="#l2.306"></a><span id="l2.306" class="difflineplus">+      sandboxName: uri,</span>
<a href="#l2.307"></a><span id="l2.307" class="difflineplus">+      addonId: addon.id,</span>
<a href="#l2.308"></a><span id="l2.308" class="difflineplus">+      wantGlobalProperties: [&quot;ChromeUtils&quot;],</span>
<a href="#l2.309"></a><span id="l2.309" class="difflineplus">+      metadata: { addonID: addon.id, URI: uri },</span>
<a href="#l2.310"></a><span id="l2.310" class="difflineplus">+    });</span>
<a href="#l2.311"></a><span id="l2.311" class="difflineplus">+</span>
<a href="#l2.312"></a><span id="l2.312" class="difflineplus">+    try {</span>
<a href="#l2.313"></a><span id="l2.313" class="difflineplus">+      Object.assign(sandbox, BOOTSTRAP_REASONS);</span>
<a href="#l2.314"></a><span id="l2.314" class="difflineplus">+</span>
<a href="#l2.315"></a><span id="l2.315" class="difflineplus">+      XPCOMUtils.defineLazyGetter(sandbox, &quot;console&quot;, () =&gt;</span>
<a href="#l2.316"></a><span id="l2.316" class="difflineplus">+        new ConsoleAPI({ consoleID: `addon/${addon.id}` }));</span>
<a href="#l2.317"></a><span id="l2.317" class="difflineplus">+</span>
<a href="#l2.318"></a><span id="l2.318" class="difflineplus">+      Services.scriptloader.loadSubScript(uri, sandbox);</span>
<a href="#l2.319"></a><span id="l2.319" class="difflineplus">+    } catch (e) {</span>
<a href="#l2.320"></a><span id="l2.320" class="difflineplus">+      logger.warn(`Error loading bootstrap.js for ${addon.id}`, e);</span>
<a href="#l2.321"></a><span id="l2.321" class="difflineplus">+    }</span>
<a href="#l2.322"></a><span id="l2.322" class="difflineplus">+</span>
<a href="#l2.323"></a><span id="l2.323" class="difflineplus">+    function findMethod(name) {</span>
<a href="#l2.324"></a><span id="l2.324" class="difflineplus">+      if (sandbox.name) {</span>
<a href="#l2.325"></a><span id="l2.325" class="difflineplus">+        return sandbox.name;</span>
<a href="#l2.326"></a><span id="l2.326" class="difflineplus">+      }</span>
<a href="#l2.327"></a><span id="l2.327" class="difflineplus">+</span>
<a href="#l2.328"></a><span id="l2.328" class="difflineplus">+      try {</span>
<a href="#l2.329"></a><span id="l2.329" class="difflineplus">+        let method = Cu.evalInSandbox(name, sandbox);</span>
<a href="#l2.330"></a><span id="l2.330" class="difflineplus">+        return method;</span>
<a href="#l2.331"></a><span id="l2.331" class="difflineplus">+      } catch (err) { }</span>
<a href="#l2.332"></a><span id="l2.332" class="difflineplus">+</span>
<a href="#l2.333"></a><span id="l2.333" class="difflineplus">+      return () =&gt; {</span>
<a href="#l2.334"></a><span id="l2.334" class="difflineplus">+        logger.warn(`Add-on ${addon.id} is missing bootstrap method ${name}`);</span>
<a href="#l2.335"></a><span id="l2.335" class="difflineplus">+      };</span>
<a href="#l2.336"></a><span id="l2.336" class="difflineplus">+    }</span>
<a href="#l2.337"></a><span id="l2.337" class="difflineplus">+</span>
<a href="#l2.338"></a><span id="l2.338" class="difflineplus">+    let install = findMethod(&quot;install&quot;);</span>
<a href="#l2.339"></a><span id="l2.339" class="difflineplus">+    let uninstall = findMethod(&quot;uninstall&quot;);</span>
<a href="#l2.340"></a><span id="l2.340" class="difflineplus">+    let startup = findMethod(&quot;startup&quot;);</span>
<a href="#l2.341"></a><span id="l2.341" class="difflineplus">+    let shutdown = findMethod(&quot;shutdown&quot;);</span>
<a href="#l2.342"></a><span id="l2.342" class="difflineplus">+</span>
<a href="#l2.343"></a><span id="l2.343" class="difflineplus">+    return {</span>
<a href="#l2.344"></a><span id="l2.344" class="difflineplus">+      install: (...args) =&gt; install(...args),</span>
<a href="#l2.345"></a><span id="l2.345" class="difflineplus">+      uninstall: (...args) =&gt; uninstall(...args),</span>
<a href="#l2.346"></a><span id="l2.346" class="difflineplus">+</span>
<a href="#l2.347"></a><span id="l2.347" class="difflineplus">+      startup(...args) {</span>
<a href="#l2.348"></a><span id="l2.348" class="difflineplus">+        if (addon.type == &quot;extension&quot;) {</span>
<a href="#l2.349"></a><span id="l2.349" class="difflineplus">+          logger.debug(`Registering manifest for ${file.path}\n`);</span>
<a href="#l2.350"></a><span id="l2.350" class="difflineplus">+          Components.manager.addBootstrappedManifestLocation(file);</span>
<a href="#l2.351"></a><span id="l2.351" class="difflineplus">+        }</span>
<a href="#l2.352"></a><span id="l2.352" class="difflineplus">+        return startup(...args);</span>
<a href="#l2.353"></a><span id="l2.353" class="difflineplus">+      },</span>
<a href="#l2.354"></a><span id="l2.354" class="difflineplus">+</span>
<a href="#l2.355"></a><span id="l2.355" class="difflineplus">+      shutdown(data, reason) {</span>
<a href="#l2.356"></a><span id="l2.356" class="difflineplus">+        try {</span>
<a href="#l2.357"></a><span id="l2.357" class="difflineplus">+          return shutdown(data, reason);</span>
<a href="#l2.358"></a><span id="l2.358" class="difflineplus">+        } catch (err) {</span>
<a href="#l2.359"></a><span id="l2.359" class="difflineplus">+          throw err;</span>
<a href="#l2.360"></a><span id="l2.360" class="difflineplus">+        } finally {</span>
<a href="#l2.361"></a><span id="l2.361" class="difflineplus">+          if (reason != BOOTSTRAP_REASONS.APP_SHUTDOWN) {</span>
<a href="#l2.362"></a><span id="l2.362" class="difflineplus">+            logger.debug(`Removing manifest for ${file.path}\n`);</span>
<a href="#l2.363"></a><span id="l2.363" class="difflineplus">+            Components.manager.removeBootstrappedManifestLocation(file);</span>
<a href="#l2.364"></a><span id="l2.364" class="difflineplus">+          }</span>
<a href="#l2.365"></a><span id="l2.365" class="difflineplus">+        }</span>
<a href="#l2.366"></a><span id="l2.366" class="difflineplus">+      },</span>
<a href="#l2.367"></a><span id="l2.367" class="difflineplus">+    };</span>
<a href="#l2.368"></a><span id="l2.368" class="difflineplus">+  },</span>
<a href="#l2.369"></a><span id="l2.369" class="difflineplus">+};</span>
<a href="#l2.370"></a><span id="l2.370" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1">new file mode 100644</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineminus">--- /dev/null</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineplus">+++ b/common/src/RDFManifestConverter.jsm</span>
<a href="#l3.4"></a><span id="l3.4" class="difflineat">@@ -0,0 +1,110 @@</span>
<a href="#l3.5"></a><span id="l3.5" class="difflineplus">+ /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l3.6"></a><span id="l3.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l3.7"></a><span id="l3.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l3.8"></a><span id="l3.8" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l3.9"></a><span id="l3.9" class="difflineplus">+</span>
<a href="#l3.10"></a><span id="l3.10" class="difflineplus">+var EXPORTED_SYMBOLS = [&quot;InstallRDF&quot;];</span>
<a href="#l3.11"></a><span id="l3.11" class="difflineplus">+</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+ChromeUtils.defineModuleGetter(this, &quot;RDFDataSource&quot;,</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+                               &quot;resource://gre/modules/addons/RDFDataSource.jsm&quot;);</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+const RDFURI_INSTALL_MANIFEST_ROOT = &quot;urn:mozilla:install-manifest&quot;;</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+function EM_R(aProperty) {</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+  return `http://www.mozilla.org/2004/em-rdf#${aProperty}`;</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+}</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+function getValue(literal) {</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+  return literal &amp;&amp; literal.getValue();</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineplus">+}</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineplus">+</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineplus">+function getProperty(resource, property) {</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineplus">+  return getValue(resource.getProperty(EM_R(property)));</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineplus">+}</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineplus">+</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineplus">+class Manifest {</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineplus">+  constructor(ds) {</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+    this.ds = ds;</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+  }</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+  static loadFromString(text) {</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+    return new this(RDFDataSource.loadFromString(text));</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+  }</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+  static loadFromBuffer(buffer) {</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+    return new this(RDFDataSource.loadFromBuffer(buffer));</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+  }</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineplus">+  static async loadFromFile(uri) {</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineplus">+    return new this(await RDFDataSource.loadFromFile(uri));</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineplus">+  }</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineplus">+}</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineplus">+</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineplus">+class InstallRDF extends Manifest {</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineplus">+  _readProps(source, obj, props) {</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineplus">+    for (let prop of props) {</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineplus">+      let val = getProperty(source, prop);</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineplus">+      if (val != null) {</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineplus">+        obj[prop] = val;</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineplus">+      }</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineplus">+    }</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineplus">+  }</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineplus">+</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineplus">+  _readArrayProp(source, obj, prop, target, decode = getValue) {</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineplus">+    let result = Array.from(source.getObjects(EM_R(prop)),</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineplus">+                            target =&gt; decode(target));</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineplus">+    if (result.length) {</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineplus">+      obj[target] = result;</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineplus">+    }</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineplus">+  }</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineplus">+</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineplus">+  _readArrayProps(source, obj, props, decode = getValue) {</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineplus">+    for (let [prop, target] of Object.entries(props)) {</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineplus">+      this._readArrayProp(source, obj, prop, target, decode);</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineplus">+    }</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineplus">+  }</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineplus">+</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineplus">+  _readLocaleStrings(source, obj) {</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineplus">+    this._readProps(source, obj, [&quot;name&quot;, &quot;description&quot;, &quot;creator&quot;, &quot;homepageURL&quot;]);</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineplus">+    this._readArrayProps(source, obj, {</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineplus">+      locale: &quot;locales&quot;,</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineplus">+      developer: &quot;developers&quot;,</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineplus">+      translator: &quot;translators&quot;,</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineplus">+      contributor: &quot;contributors&quot;,</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineplus">+    });</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineplus">+  }</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineplus">+</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineplus">+  decode() {</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineplus">+    let root = this.ds.getResource(RDFURI_INSTALL_MANIFEST_ROOT);</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineplus">+    let result = {};</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineplus">+</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineplus">+    let props = [&quot;id&quot;, &quot;version&quot;, &quot;type&quot;, &quot;updateURL&quot;, &quot;optionsURL&quot;,</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineplus">+                 &quot;optionsType&quot;, &quot;aboutURL&quot;, &quot;iconURL&quot;,</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineplus">+                 &quot;bootstrap&quot;, &quot;unpack&quot;, &quot;strictCompatibility&quot;];</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineplus">+    this._readProps(root, result, props);</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineplus">+</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineplus">+    let decodeTargetApplication = source =&gt; {</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineplus">+      let app = {};</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineplus">+      this._readProps(source, app, [&quot;id&quot;, &quot;minVersion&quot;, &quot;maxVersion&quot;]);</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineplus">+      return app;</span>
<a href="#l3.94"></a><span id="l3.94" class="difflineplus">+    };</span>
<a href="#l3.95"></a><span id="l3.95" class="difflineplus">+</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineplus">+    let decodeLocale = source =&gt; {</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineplus">+      let localized = {};</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineplus">+      this._readLocaleStrings(source, localized);</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineplus">+      return localized;</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineplus">+    };</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineplus">+</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineplus">+    this._readLocaleStrings(root, result);</span>
<a href="#l3.103"></a><span id="l3.103" class="difflineplus">+</span>
<a href="#l3.104"></a><span id="l3.104" class="difflineplus">+    this._readArrayProps(root, result, {&quot;targetPlatform&quot;: &quot;targetPlatforms&quot;});</span>
<a href="#l3.105"></a><span id="l3.105" class="difflineplus">+    this._readArrayProps(root, result, {&quot;targetApplication&quot;: &quot;targetApplications&quot;},</span>
<a href="#l3.106"></a><span id="l3.106" class="difflineplus">+                         decodeTargetApplication);</span>
<a href="#l3.107"></a><span id="l3.107" class="difflineplus">+    this._readArrayProps(root, result, {&quot;localized&quot;: &quot;localized&quot;},</span>
<a href="#l3.108"></a><span id="l3.108" class="difflineplus">+                         decodeLocale);</span>
<a href="#l3.109"></a><span id="l3.109" class="difflineplus">+    this._readArrayProps(root, result, {&quot;dependency&quot;: &quot;dependencies&quot;},</span>
<a href="#l3.110"></a><span id="l3.110" class="difflineplus">+                         source =&gt; getProperty(source, &quot;id&quot;));</span>
<a href="#l3.111"></a><span id="l3.111" class="difflineplus">+</span>
<a href="#l3.112"></a><span id="l3.112" class="difflineplus">+    return result;</span>
<a href="#l3.113"></a><span id="l3.113" class="difflineplus">+  }</span>
<a href="#l3.114"></a><span id="l3.114" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/common/src/moz.build</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/common/src/moz.build</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -1,17 +1,19 @@</span>
<a href="#l4.4"></a><span id="l4.4"> # vim: set filetype=python:</span>
<a href="#l4.5"></a><span id="l4.5"> # This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l4.6"></a><span id="l4.6"> # License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l4.7"></a><span id="l4.7"> # file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l4.8"></a><span id="l4.8"> </span>
<a href="#l4.9"></a><span id="l4.9"> EXTRA_JS_MODULES += [</span>
<a href="#l4.10"></a><span id="l4.10" class="difflineplus">+    'BootstrapLoader.jsm',</span>
<a href="#l4.11"></a><span id="l4.11">     'ChromeManifest.jsm',</span>
<a href="#l4.12"></a><span id="l4.12">     'extensionSupport.jsm',</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-    'Overlays.jsm'</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+    'Overlays.jsm',</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+    'RDFManifestConverter.jsm',</span>
<a href="#l4.16"></a><span id="l4.16"> ]</span>
<a href="#l4.17"></a><span id="l4.17"> </span>
<a href="#l4.18"></a><span id="l4.18"> SOURCES += [</span>
<a href="#l4.19"></a><span id="l4.19">     'nsCommonModule.cpp',</span>
<a href="#l4.20"></a><span id="l4.20">     'nsComponentManagerExtra.cpp',</span>
<a href="#l4.21"></a><span id="l4.21"> ]</span>
<a href="#l4.22"></a><span id="l4.22"> </span>
<a href="#l4.23"></a><span id="l4.23"> LOCAL_INCLUDES += [</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1">new file mode 100644</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineminus">--- /dev/null</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineplus">+++ b/common/test/xpcshell/.eslintrc.js</span>
<a href="#l5.4"></a><span id="l5.4" class="difflineat">@@ -0,0 +1,9 @@</span>
<a href="#l5.5"></a><span id="l5.5" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l5.6"></a><span id="l5.6" class="difflineplus">+</span>
<a href="#l5.7"></a><span id="l5.7" class="difflineplus">+module.exports = {</span>
<a href="#l5.8"></a><span id="l5.8" class="difflineplus">+  &quot;extends&quot;: &quot;plugin:mozilla/xpcshell-test&quot;,</span>
<a href="#l5.9"></a><span id="l5.9" class="difflineplus">+</span>
<a href="#l5.10"></a><span id="l5.10" class="difflineplus">+  &quot;rules&quot;: {</span>
<a href="#l5.11"></a><span id="l5.11" class="difflineplus">+    &quot;func-names&quot;: &quot;off&quot;,</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+  },</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1">new file mode 100644</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineminus">--- /dev/null</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineplus">+++ b/common/test/xpcshell/data/BootstrapMonitor.jsm</span>
<a href="#l6.4"></a><span id="l6.4" class="difflineat">@@ -0,0 +1,34 @@</span>
<a href="#l6.5"></a><span id="l6.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l6.6"></a><span id="l6.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l6.7"></a><span id="l6.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l6.8"></a><span id="l6.8" class="difflineplus">+</span>
<a href="#l6.9"></a><span id="l6.9" class="difflineplus">+ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l6.10"></a><span id="l6.10" class="difflineplus">+</span>
<a href="#l6.11"></a><span id="l6.11" class="difflineplus">+var EXPORTED_SYMBOLS = [ &quot;monitor&quot; ];</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+function notify(event, originalMethod, data, reason) {</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+  let info = {</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+    event,</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+    data: Object.assign({}, data, {</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineplus">+      installPath: data.installPath.path,</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineplus">+      resourceURI: data.resourceURI.spec,</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineplus">+    }),</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineplus">+    reason,</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineplus">+  };</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineplus">+  let subject = {wrappedJSObject: {data}};</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineplus">+</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineplus">+  Services.obs.notifyObservers(subject, &quot;bootstrapmonitor-event&quot;, JSON.stringify(info));</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineplus">+</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineplus">+  // If the bootstrap scope already declares a method call it</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineplus">+  if (originalMethod)</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineplus">+    originalMethod(data, reason);</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineplus">+}</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineplus">+</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+// Allows a simple one-line bootstrap script:</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineplus">+// Components.utils.import(&quot;resource://xpcshelldata/bootstrapmonitor.jsm&quot;).monitor(this);</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineplus">+var monitor = function(scope, methods = [&quot;install&quot;, &quot;startup&quot;, &quot;shutdown&quot;, &quot;uninstall&quot;]) {</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineplus">+  for (let event of methods) {</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineplus">+    scope[event] = notify.bind(null, event, scope[event]);</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineplus">+  }</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1">new file mode 100644</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineminus">--- /dev/null</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineplus">+++ b/common/test/xpcshell/head_addons.js</span>
<a href="#l7.4"></a><span id="l7.4" class="difflineat">@@ -0,0 +1,1381 @@</span>
<a href="#l7.5"></a><span id="l7.5" class="difflineplus">+/* Any copyright is dedicated to the Public Domain.</span>
<a href="#l7.6"></a><span id="l7.6" class="difflineplus">+ * http://creativecommons.org/publicdomain/zero/1.0/</span>
<a href="#l7.7"></a><span id="l7.7" class="difflineplus">+ */</span>
<a href="#l7.8"></a><span id="l7.8" class="difflineplus">+</span>
<a href="#l7.9"></a><span id="l7.9" class="difflineplus">+/* eslint no-unused-vars: [&quot;error&quot;, {vars: &quot;local&quot;, args: &quot;none&quot;}] */</span>
<a href="#l7.10"></a><span id="l7.10" class="difflineplus">+</span>
<a href="#l7.11"></a><span id="l7.11" class="difflineplus">+Cu.importGlobalProperties([&quot;TextEncoder&quot;]);</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+const PREF_EM_CHECK_UPDATE_SECURITY   = &quot;extensions.checkUpdateSecurity&quot;;</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+const PREF_EM_STRICT_COMPATIBILITY    = &quot;extensions.strictCompatibility&quot;;</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+const PREF_GETADDONS_BYIDS               = &quot;extensions.getAddons.get.url&quot;;</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+const PREF_COMPAT_OVERRIDES              = &quot;extensions.getAddons.compatOverides.url&quot;;</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+const PREF_XPI_SIGNATURES_REQUIRED    = &quot;xpinstall.signatures.required&quot;;</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineplus">+</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+const PREF_DISABLE_SECURITY = (&quot;security.turn_off_all_security_so_that_&quot; +</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineplus">+                               &quot;viruses_can_take_over_this_computer&quot;);</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineplus">+</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineplus">+// Maximum error in file modification times. Some file systems don't store</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineplus">+// modification times exactly. As long as we are closer than this then it</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineplus">+// still passes.</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineplus">+const MAX_TIME_DIFFERENCE = 3000;</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineplus">+</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineplus">+// Time to reset file modified time relative to Date.now() so we can test that</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineplus">+// times are modified (10 hours old).</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineplus">+const MAKE_FILE_OLD_DIFFERENCE = 10 * 3600 * 1000;</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineplus">+</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineplus">+ChromeUtils.import(&quot;resource://gre/modules/AppConstants.jsm&quot;);</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+ChromeUtils.import(&quot;resource://gre/modules/FileUtils.jsm&quot;);</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineplus">+ChromeUtils.import(&quot;resource://gre/modules/NetUtil.jsm&quot;);</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineplus">+ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineplus">+ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+ChromeUtils.import(&quot;resource://gre/modules/addons/AddonRepository.jsm&quot;);</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineplus">+ChromeUtils.import(&quot;resource://gre/modules/osfile.jsm&quot;);</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineplus">+</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineplus">+ChromeUtils.import(&quot;resource://testing-common/AddonTestUtils.jsm&quot;);</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineplus">+</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineplus">+ChromeUtils.defineModuleGetter(this, &quot;Blocklist&quot;,</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineplus">+                               &quot;resource://gre/modules/Blocklist.jsm&quot;);</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineplus">+ChromeUtils.defineModuleGetter(this, &quot;Extension&quot;,</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineplus">+                               &quot;resource://gre/modules/Extension.jsm&quot;);</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineplus">+ChromeUtils.defineModuleGetter(this, &quot;ExtensionTestUtils&quot;,</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineplus">+                               &quot;resource://testing-common/ExtensionXPCShellUtils.jsm&quot;);</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineplus">+ChromeUtils.defineModuleGetter(this, &quot;ExtensionTestCommon&quot;,</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineplus">+                               &quot;resource://testing-common/ExtensionTestCommon.jsm&quot;);</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineplus">+ChromeUtils.defineModuleGetter(this, &quot;HttpServer&quot;,</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineplus">+                               &quot;resource://testing-common/httpd.js&quot;);</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineplus">+ChromeUtils.defineModuleGetter(this, &quot;MockAsyncShutdown&quot;,</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineplus">+                               &quot;resource://testing-common/AddonTestUtils.jsm&quot;);</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineplus">+ChromeUtils.defineModuleGetter(this, &quot;MockRegistrar&quot;,</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineplus">+                               &quot;resource://testing-common/MockRegistrar.jsm&quot;);</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineplus">+ChromeUtils.defineModuleGetter(this, &quot;MockRegistry&quot;,</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineplus">+                               &quot;resource://testing-common/MockRegistry.jsm&quot;);</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineplus">+ChromeUtils.defineModuleGetter(this, &quot;PromiseTestUtils&quot;,</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineplus">+                               &quot;resource://testing-common/PromiseTestUtils.jsm&quot;);</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineplus">+ChromeUtils.defineModuleGetter(this, &quot;TestUtils&quot;,</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineplus">+                               &quot;resource://testing-common/TestUtils.jsm&quot;);</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineplus">+</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineplus">+XPCOMUtils.defineLazyServiceGetter(this, &quot;aomStartup&quot;,</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineplus">+                                   &quot;@mozilla.org/addons/addon-manager-startup;1&quot;,</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineplus">+                                   &quot;amIAddonManagerStartup&quot;);</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineplus">+</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineplus">+const {</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineplus">+  createAppInfo,</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineplus">+  createHttpServer,</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineplus">+  createInstallRDF,</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineplus">+  createTempWebExtensionFile,</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineplus">+  createUpdateRDF,</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineplus">+  getFileForAddon,</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineplus">+  manuallyInstall,</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineplus">+  manuallyUninstall,</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineplus">+  overrideBuiltIns,</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineplus">+  promiseAddonEvent,</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineplus">+  promiseCompleteAllInstalls,</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineplus">+  promiseCompleteInstall,</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineplus">+  promiseConsoleOutput,</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineplus">+  promiseFindAddonUpdates,</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineplus">+  promiseInstallAllFiles,</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineplus">+  promiseInstallFile,</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineplus">+  promiseSetExtensionModifiedTime,</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineplus">+  promiseShutdownManager,</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineplus">+  promiseWebExtensionStartup,</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineplus">+  promiseWriteProxyFileToDir,</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineplus">+  registerDirectory,</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineplus">+  setExtensionModifiedTime,</span>
<a href="#l7.89"></a><span id="l7.89" class="difflineplus">+  writeFilesToZip,</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineplus">+} = AddonTestUtils;</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineplus">+</span>
<a href="#l7.92"></a><span id="l7.92" class="difflineplus">+// WebExtension wrapper for ease of testing</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineplus">+ExtensionTestUtils.init(this);</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineplus">+</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineplus">+AddonTestUtils.init(this);</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineplus">+AddonTestUtils.overrideCertDB();</span>
<a href="#l7.97"></a><span id="l7.97" class="difflineplus">+</span>
<a href="#l7.98"></a><span id="l7.98" class="difflineplus">+XPCOMUtils.defineLazyGetter(this, &quot;BOOTSTRAP_REASONS&quot;,</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineplus">+                            () =&gt; AddonManagerPrivate.BOOTSTRAP_REASONS);</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineplus">+</span>
<a href="#l7.101"></a><span id="l7.101" class="difflineplus">+function getReasonName(reason) {</span>
<a href="#l7.102"></a><span id="l7.102" class="difflineplus">+  for (let key of Object.keys(BOOTSTRAP_REASONS)) {</span>
<a href="#l7.103"></a><span id="l7.103" class="difflineplus">+    if (BOOTSTRAP_REASONS[key] == reason) {</span>
<a href="#l7.104"></a><span id="l7.104" class="difflineplus">+      return key;</span>
<a href="#l7.105"></a><span id="l7.105" class="difflineplus">+    }</span>
<a href="#l7.106"></a><span id="l7.106" class="difflineplus">+  }</span>
<a href="#l7.107"></a><span id="l7.107" class="difflineplus">+  throw new Error(&quot;This shouldn't happen.&quot;);</span>
<a href="#l7.108"></a><span id="l7.108" class="difflineplus">+}</span>
<a href="#l7.109"></a><span id="l7.109" class="difflineplus">+</span>
<a href="#l7.110"></a><span id="l7.110" class="difflineplus">+</span>
<a href="#l7.111"></a><span id="l7.111" class="difflineplus">+Object.defineProperty(this, &quot;gAppInfo&quot;, {</span>
<a href="#l7.112"></a><span id="l7.112" class="difflineplus">+  get() {</span>
<a href="#l7.113"></a><span id="l7.113" class="difflineplus">+    return AddonTestUtils.appInfo;</span>
<a href="#l7.114"></a><span id="l7.114" class="difflineplus">+  },</span>
<a href="#l7.115"></a><span id="l7.115" class="difflineplus">+});</span>
<a href="#l7.116"></a><span id="l7.116" class="difflineplus">+</span>
<a href="#l7.117"></a><span id="l7.117" class="difflineplus">+Object.defineProperty(this, &quot;gAddonStartup&quot;, {</span>
<a href="#l7.118"></a><span id="l7.118" class="difflineplus">+  get() {</span>
<a href="#l7.119"></a><span id="l7.119" class="difflineplus">+    return AddonTestUtils.addonStartup.clone();</span>
<a href="#l7.120"></a><span id="l7.120" class="difflineplus">+  },</span>
<a href="#l7.121"></a><span id="l7.121" class="difflineplus">+});</span>
<a href="#l7.122"></a><span id="l7.122" class="difflineplus">+</span>
<a href="#l7.123"></a><span id="l7.123" class="difflineplus">+Object.defineProperty(this, &quot;gInternalManager&quot;, {</span>
<a href="#l7.124"></a><span id="l7.124" class="difflineplus">+  get() {</span>
<a href="#l7.125"></a><span id="l7.125" class="difflineplus">+    return AddonTestUtils.addonIntegrationService.QueryInterface(Ci.nsITimerCallback);</span>
<a href="#l7.126"></a><span id="l7.126" class="difflineplus">+  },</span>
<a href="#l7.127"></a><span id="l7.127" class="difflineplus">+});</span>
<a href="#l7.128"></a><span id="l7.128" class="difflineplus">+</span>
<a href="#l7.129"></a><span id="l7.129" class="difflineplus">+Object.defineProperty(this, &quot;gProfD&quot;, {</span>
<a href="#l7.130"></a><span id="l7.130" class="difflineplus">+  get() {</span>
<a href="#l7.131"></a><span id="l7.131" class="difflineplus">+    return AddonTestUtils.profileDir.clone();</span>
<a href="#l7.132"></a><span id="l7.132" class="difflineplus">+  },</span>
<a href="#l7.133"></a><span id="l7.133" class="difflineplus">+});</span>
<a href="#l7.134"></a><span id="l7.134" class="difflineplus">+</span>
<a href="#l7.135"></a><span id="l7.135" class="difflineplus">+Object.defineProperty(this, &quot;gTmpD&quot;, {</span>
<a href="#l7.136"></a><span id="l7.136" class="difflineplus">+  get() {</span>
<a href="#l7.137"></a><span id="l7.137" class="difflineplus">+    return AddonTestUtils.tempDir.clone();</span>
<a href="#l7.138"></a><span id="l7.138" class="difflineplus">+  },</span>
<a href="#l7.139"></a><span id="l7.139" class="difflineplus">+});</span>
<a href="#l7.140"></a><span id="l7.140" class="difflineplus">+</span>
<a href="#l7.141"></a><span id="l7.141" class="difflineplus">+Object.defineProperty(this, &quot;gUseRealCertChecks&quot;, {</span>
<a href="#l7.142"></a><span id="l7.142" class="difflineplus">+  get() {</span>
<a href="#l7.143"></a><span id="l7.143" class="difflineplus">+    return AddonTestUtils.useRealCertChecks;</span>
<a href="#l7.144"></a><span id="l7.144" class="difflineplus">+  },</span>
<a href="#l7.145"></a><span id="l7.145" class="difflineplus">+  set(val) {</span>
<a href="#l7.146"></a><span id="l7.146" class="difflineplus">+   return AddonTestUtils.useRealCertChecks = val;</span>
<a href="#l7.147"></a><span id="l7.147" class="difflineplus">+  },</span>
<a href="#l7.148"></a><span id="l7.148" class="difflineplus">+});</span>
<a href="#l7.149"></a><span id="l7.149" class="difflineplus">+</span>
<a href="#l7.150"></a><span id="l7.150" class="difflineplus">+Object.defineProperty(this, &quot;TEST_UNPACKED&quot;, {</span>
<a href="#l7.151"></a><span id="l7.151" class="difflineplus">+  get() {</span>
<a href="#l7.152"></a><span id="l7.152" class="difflineplus">+    return AddonTestUtils.testUnpacked;</span>
<a href="#l7.153"></a><span id="l7.153" class="difflineplus">+  },</span>
<a href="#l7.154"></a><span id="l7.154" class="difflineplus">+  set(val) {</span>
<a href="#l7.155"></a><span id="l7.155" class="difflineplus">+   return AddonTestUtils.testUnpacked = val;</span>
<a href="#l7.156"></a><span id="l7.156" class="difflineplus">+  },</span>
<a href="#l7.157"></a><span id="l7.157" class="difflineplus">+});</span>
<a href="#l7.158"></a><span id="l7.158" class="difflineplus">+</span>
<a href="#l7.159"></a><span id="l7.159" class="difflineplus">+// We need some internal bits of AddonManager</span>
<a href="#l7.160"></a><span id="l7.160" class="difflineplus">+var AMscope = ChromeUtils.import(&quot;resource://gre/modules/AddonManager.jsm&quot;, {});</span>
<a href="#l7.161"></a><span id="l7.161" class="difflineplus">+var { AddonManager, AddonManagerInternal, AddonManagerPrivate } = AMscope;</span>
<a href="#l7.162"></a><span id="l7.162" class="difflineplus">+</span>
<a href="#l7.163"></a><span id="l7.163" class="difflineplus">+// Wrap the startup functions to ensure the bootstrap loader is added.</span>
<a href="#l7.164"></a><span id="l7.164" class="difflineplus">+function promiseStartupManager(newVersion) {</span>
<a href="#l7.165"></a><span id="l7.165" class="difflineplus">+  ChromeUtils.import(&quot;resource:///modules/BootstrapLoader.jsm&quot;);</span>
<a href="#l7.166"></a><span id="l7.166" class="difflineplus">+  AddonManager.addExternalExtensionLoader(BootstrapLoader);</span>
<a href="#l7.167"></a><span id="l7.167" class="difflineplus">+  return AddonTestUtils.promiseStartupManager(newVersion);</span>
<a href="#l7.168"></a><span id="l7.168" class="difflineplus">+}</span>
<a href="#l7.169"></a><span id="l7.169" class="difflineplus">+</span>
<a href="#l7.170"></a><span id="l7.170" class="difflineplus">+async function promiseRestartManager(newVersion) {</span>
<a href="#l7.171"></a><span id="l7.171" class="difflineplus">+  await promiseShutdownManager(false);</span>
<a href="#l7.172"></a><span id="l7.172" class="difflineplus">+  await promiseStartupManager(newVersion);</span>
<a href="#l7.173"></a><span id="l7.173" class="difflineplus">+}</span>
<a href="#l7.174"></a><span id="l7.174" class="difflineplus">+</span>
<a href="#l7.175"></a><span id="l7.175" class="difflineplus">+const promiseAddonByID = AddonManager.getAddonByID;</span>
<a href="#l7.176"></a><span id="l7.176" class="difflineplus">+const promiseAddonsByIDs = AddonManager.getAddonsByIDs;</span>
<a href="#l7.177"></a><span id="l7.177" class="difflineplus">+</span>
<a href="#l7.178"></a><span id="l7.178" class="difflineplus">+var gPort = null;</span>
<a href="#l7.179"></a><span id="l7.179" class="difflineplus">+var gUrlToFileMap = {};</span>
<a href="#l7.180"></a><span id="l7.180" class="difflineplus">+</span>
<a href="#l7.181"></a><span id="l7.181" class="difflineplus">+// Map resource://xpcshell-data/ to the data directory</span>
<a href="#l7.182"></a><span id="l7.182" class="difflineplus">+var resHandler = Services.io.getProtocolHandler(&quot;resource&quot;)</span>
<a href="#l7.183"></a><span id="l7.183" class="difflineplus">+                         .QueryInterface(Ci.nsISubstitutingProtocolHandler);</span>
<a href="#l7.184"></a><span id="l7.184" class="difflineplus">+// Allow non-existent files because of bug 1207735</span>
<a href="#l7.185"></a><span id="l7.185" class="difflineplus">+var dataURI = NetUtil.newURI(do_get_file(&quot;data&quot;, true));</span>
<a href="#l7.186"></a><span id="l7.186" class="difflineplus">+resHandler.setSubstitution(&quot;xpcshell-data&quot;, dataURI);</span>
<a href="#l7.187"></a><span id="l7.187" class="difflineplus">+</span>
<a href="#l7.188"></a><span id="l7.188" class="difflineplus">+function isManifestRegistered(file) {</span>
<a href="#l7.189"></a><span id="l7.189" class="difflineplus">+  let manifests = Components.manager.getManifestLocations();</span>
<a href="#l7.190"></a><span id="l7.190" class="difflineplus">+  for (let i = 0; i &lt; manifests.length; i++) {</span>
<a href="#l7.191"></a><span id="l7.191" class="difflineplus">+    let manifest = manifests.queryElementAt(i, Ci.nsIURI);</span>
<a href="#l7.192"></a><span id="l7.192" class="difflineplus">+</span>
<a href="#l7.193"></a><span id="l7.193" class="difflineplus">+    // manifest is the url to the manifest file either in an XPI or a directory.</span>
<a href="#l7.194"></a><span id="l7.194" class="difflineplus">+    // We want the location of the XPI or directory itself.</span>
<a href="#l7.195"></a><span id="l7.195" class="difflineplus">+    if (manifest instanceof Ci.nsIJARURI) {</span>
<a href="#l7.196"></a><span id="l7.196" class="difflineplus">+      manifest = manifest.JARFile.QueryInterface(Ci.nsIFileURL).file;</span>
<a href="#l7.197"></a><span id="l7.197" class="difflineplus">+    } else if (manifest instanceof Ci.nsIFileURL) {</span>
<a href="#l7.198"></a><span id="l7.198" class="difflineplus">+      manifest = manifest.file.parent;</span>
<a href="#l7.199"></a><span id="l7.199" class="difflineplus">+    } else {</span>
<a href="#l7.200"></a><span id="l7.200" class="difflineplus">+      continue;</span>
<a href="#l7.201"></a><span id="l7.201" class="difflineplus">+    }</span>
<a href="#l7.202"></a><span id="l7.202" class="difflineplus">+</span>
<a href="#l7.203"></a><span id="l7.203" class="difflineplus">+    if (manifest.equals(file))</span>
<a href="#l7.204"></a><span id="l7.204" class="difflineplus">+      return true;</span>
<a href="#l7.205"></a><span id="l7.205" class="difflineplus">+  }</span>
<a href="#l7.206"></a><span id="l7.206" class="difflineplus">+  return false;</span>
<a href="#l7.207"></a><span id="l7.207" class="difflineplus">+}</span>
<a href="#l7.208"></a><span id="l7.208" class="difflineplus">+</span>
<a href="#l7.209"></a><span id="l7.209" class="difflineplus">+const BOOTSTRAP_MONITOR_BOOTSTRAP_JS = `</span>
<a href="#l7.210"></a><span id="l7.210" class="difflineplus">+  ChromeUtils.import(&quot;resource://xpcshell-data/BootstrapMonitor.jsm&quot;).monitor(this);</span>
<a href="#l7.211"></a><span id="l7.211" class="difflineplus">+`;</span>
<a href="#l7.212"></a><span id="l7.212" class="difflineplus">+</span>
<a href="#l7.213"></a><span id="l7.213" class="difflineplus">+// Listens to messages from bootstrap.js telling us what add-ons were started</span>
<a href="#l7.214"></a><span id="l7.214" class="difflineplus">+// and stopped etc. and performs some sanity checks that only installed add-ons</span>
<a href="#l7.215"></a><span id="l7.215" class="difflineplus">+// are started etc.</span>
<a href="#l7.216"></a><span id="l7.216" class="difflineplus">+this.BootstrapMonitor = {</span>
<a href="#l7.217"></a><span id="l7.217" class="difflineplus">+  inited: false,</span>
<a href="#l7.218"></a><span id="l7.218" class="difflineplus">+</span>
<a href="#l7.219"></a><span id="l7.219" class="difflineplus">+  // Contain the current state of add-ons in the system</span>
<a href="#l7.220"></a><span id="l7.220" class="difflineplus">+  installed: new Map(),</span>
<a href="#l7.221"></a><span id="l7.221" class="difflineplus">+  started: new Map(),</span>
<a href="#l7.222"></a><span id="l7.222" class="difflineplus">+</span>
<a href="#l7.223"></a><span id="l7.223" class="difflineplus">+  // Contain the last state of shutdown and uninstall calls for an add-on</span>
<a href="#l7.224"></a><span id="l7.224" class="difflineplus">+  stopped: new Map(),</span>
<a href="#l7.225"></a><span id="l7.225" class="difflineplus">+  uninstalled: new Map(),</span>
<a href="#l7.226"></a><span id="l7.226" class="difflineplus">+</span>
<a href="#l7.227"></a><span id="l7.227" class="difflineplus">+  startupPromises: [],</span>
<a href="#l7.228"></a><span id="l7.228" class="difflineplus">+  installPromises: [],</span>
<a href="#l7.229"></a><span id="l7.229" class="difflineplus">+</span>
<a href="#l7.230"></a><span id="l7.230" class="difflineplus">+  restartfulIds: new Set(),</span>
<a href="#l7.231"></a><span id="l7.231" class="difflineplus">+</span>
<a href="#l7.232"></a><span id="l7.232" class="difflineplus">+  init() {</span>
<a href="#l7.233"></a><span id="l7.233" class="difflineplus">+    this.inited = true;</span>
<a href="#l7.234"></a><span id="l7.234" class="difflineplus">+    Services.obs.addObserver(this, &quot;bootstrapmonitor-event&quot;);</span>
<a href="#l7.235"></a><span id="l7.235" class="difflineplus">+  },</span>
<a href="#l7.236"></a><span id="l7.236" class="difflineplus">+</span>
<a href="#l7.237"></a><span id="l7.237" class="difflineplus">+  shutdownCheck() {</span>
<a href="#l7.238"></a><span id="l7.238" class="difflineplus">+    if (!this.inited)</span>
<a href="#l7.239"></a><span id="l7.239" class="difflineplus">+      return;</span>
<a href="#l7.240"></a><span id="l7.240" class="difflineplus">+</span>
<a href="#l7.241"></a><span id="l7.241" class="difflineplus">+    Assert.equal(this.started.size, 0);</span>
<a href="#l7.242"></a><span id="l7.242" class="difflineplus">+  },</span>
<a href="#l7.243"></a><span id="l7.243" class="difflineplus">+</span>
<a href="#l7.244"></a><span id="l7.244" class="difflineplus">+  clear(id) {</span>
<a href="#l7.245"></a><span id="l7.245" class="difflineplus">+    this.installed.delete(id);</span>
<a href="#l7.246"></a><span id="l7.246" class="difflineplus">+    this.started.delete(id);</span>
<a href="#l7.247"></a><span id="l7.247" class="difflineplus">+    this.stopped.delete(id);</span>
<a href="#l7.248"></a><span id="l7.248" class="difflineplus">+    this.uninstalled.delete(id);</span>
<a href="#l7.249"></a><span id="l7.249" class="difflineplus">+  },</span>
<a href="#l7.250"></a><span id="l7.250" class="difflineplus">+</span>
<a href="#l7.251"></a><span id="l7.251" class="difflineplus">+  promiseAddonStartup(id) {</span>
<a href="#l7.252"></a><span id="l7.252" class="difflineplus">+    return new Promise(resolve =&gt; {</span>
<a href="#l7.253"></a><span id="l7.253" class="difflineplus">+      this.startupPromises.push(resolve);</span>
<a href="#l7.254"></a><span id="l7.254" class="difflineplus">+    });</span>
<a href="#l7.255"></a><span id="l7.255" class="difflineplus">+  },</span>
<a href="#l7.256"></a><span id="l7.256" class="difflineplus">+</span>
<a href="#l7.257"></a><span id="l7.257" class="difflineplus">+  promiseAddonInstall(id) {</span>
<a href="#l7.258"></a><span id="l7.258" class="difflineplus">+    return new Promise(resolve =&gt; {</span>
<a href="#l7.259"></a><span id="l7.259" class="difflineplus">+      this.installPromises.push(resolve);</span>
<a href="#l7.260"></a><span id="l7.260" class="difflineplus">+    });</span>
<a href="#l7.261"></a><span id="l7.261" class="difflineplus">+  },</span>
<a href="#l7.262"></a><span id="l7.262" class="difflineplus">+</span>
<a href="#l7.263"></a><span id="l7.263" class="difflineplus">+  checkMatches(cached, current) {</span>
<a href="#l7.264"></a><span id="l7.264" class="difflineplus">+    Assert.notEqual(cached, undefined);</span>
<a href="#l7.265"></a><span id="l7.265" class="difflineplus">+    Assert.equal(current.data.version, cached.data.version);</span>
<a href="#l7.266"></a><span id="l7.266" class="difflineplus">+    Assert.equal(current.data.installPath, cached.data.installPath);</span>
<a href="#l7.267"></a><span id="l7.267" class="difflineplus">+    Assert.ok(Services.io.newURI(current.data.resourceURI).equals(Services.io.newURI(cached.data.resourceURI)),</span>
<a href="#l7.268"></a><span id="l7.268" class="difflineplus">+              `Resource URIs match: &quot;${current.data.resourceURI}&quot; == &quot;${cached.data.resourceURI}&quot;`);</span>
<a href="#l7.269"></a><span id="l7.269" class="difflineplus">+  },</span>
<a href="#l7.270"></a><span id="l7.270" class="difflineplus">+</span>
<a href="#l7.271"></a><span id="l7.271" class="difflineplus">+  checkAddonStarted(id, version = undefined) {</span>
<a href="#l7.272"></a><span id="l7.272" class="difflineplus">+    let started = this.started.get(id);</span>
<a href="#l7.273"></a><span id="l7.273" class="difflineplus">+    Assert.notEqual(started, undefined);</span>
<a href="#l7.274"></a><span id="l7.274" class="difflineplus">+    if (version != undefined)</span>
<a href="#l7.275"></a><span id="l7.275" class="difflineplus">+      Assert.equal(started.data.version, version);</span>
<a href="#l7.276"></a><span id="l7.276" class="difflineplus">+</span>
<a href="#l7.277"></a><span id="l7.277" class="difflineplus">+    // Chrome should be registered by now</span>
<a href="#l7.278"></a><span id="l7.278" class="difflineplus">+    let installPath = new FileUtils.File(started.data.installPath);</span>
<a href="#l7.279"></a><span id="l7.279" class="difflineplus">+    let isRegistered = isManifestRegistered(installPath);</span>
<a href="#l7.280"></a><span id="l7.280" class="difflineplus">+    Assert.ok(isRegistered);</span>
<a href="#l7.281"></a><span id="l7.281" class="difflineplus">+  },</span>
<a href="#l7.282"></a><span id="l7.282" class="difflineplus">+</span>
<a href="#l7.283"></a><span id="l7.283" class="difflineplus">+  checkAddonNotStarted(id) {</span>
<a href="#l7.284"></a><span id="l7.284" class="difflineplus">+    Assert.ok(!this.started.has(id));</span>
<a href="#l7.285"></a><span id="l7.285" class="difflineplus">+  },</span>
<a href="#l7.286"></a><span id="l7.286" class="difflineplus">+</span>
<a href="#l7.287"></a><span id="l7.287" class="difflineplus">+  checkAddonInstalled(id, version = undefined) {</span>
<a href="#l7.288"></a><span id="l7.288" class="difflineplus">+    const installed = this.installed.get(id);</span>
<a href="#l7.289"></a><span id="l7.289" class="difflineplus">+    notEqual(installed, undefined);</span>
<a href="#l7.290"></a><span id="l7.290" class="difflineplus">+    if (version !== undefined) {</span>
<a href="#l7.291"></a><span id="l7.291" class="difflineplus">+      equal(installed.data.version, version);</span>
<a href="#l7.292"></a><span id="l7.292" class="difflineplus">+    }</span>
<a href="#l7.293"></a><span id="l7.293" class="difflineplus">+    return installed;</span>
<a href="#l7.294"></a><span id="l7.294" class="difflineplus">+  },</span>
<a href="#l7.295"></a><span id="l7.295" class="difflineplus">+</span>
<a href="#l7.296"></a><span id="l7.296" class="difflineplus">+  checkAddonNotInstalled(id) {</span>
<a href="#l7.297"></a><span id="l7.297" class="difflineplus">+    Assert.ok(!this.installed.has(id));</span>
<a href="#l7.298"></a><span id="l7.298" class="difflineplus">+  },</span>
<a href="#l7.299"></a><span id="l7.299" class="difflineplus">+</span>
<a href="#l7.300"></a><span id="l7.300" class="difflineplus">+  observe(subject, topic, data) {</span>
<a href="#l7.301"></a><span id="l7.301" class="difflineplus">+    let info = JSON.parse(data);</span>
<a href="#l7.302"></a><span id="l7.302" class="difflineplus">+    let id = info.data.id;</span>
<a href="#l7.303"></a><span id="l7.303" class="difflineplus">+    let installPath = new FileUtils.File(info.data.installPath);</span>
<a href="#l7.304"></a><span id="l7.304" class="difflineplus">+</span>
<a href="#l7.305"></a><span id="l7.305" class="difflineplus">+    if (subject &amp;&amp; subject.wrappedJSObject) {</span>
<a href="#l7.306"></a><span id="l7.306" class="difflineplus">+      // NOTE: in some of the new tests, we need to received the real objects instead of</span>
<a href="#l7.307"></a><span id="l7.307" class="difflineplus">+      // their JSON representations, but most of the current tests expect intallPath</span>
<a href="#l7.308"></a><span id="l7.308" class="difflineplus">+      // and resourceURI to have been converted to strings.</span>
<a href="#l7.309"></a><span id="l7.309" class="difflineplus">+      info.data = Object.assign({}, subject.wrappedJSObject.data, {</span>
<a href="#l7.310"></a><span id="l7.310" class="difflineplus">+        installPath: info.data.installPath,</span>
<a href="#l7.311"></a><span id="l7.311" class="difflineplus">+        resourceURI: info.data.resourceURI,</span>
<a href="#l7.312"></a><span id="l7.312" class="difflineplus">+      });</span>
<a href="#l7.313"></a><span id="l7.313" class="difflineplus">+    }</span>
<a href="#l7.314"></a><span id="l7.314" class="difflineplus">+</span>
<a href="#l7.315"></a><span id="l7.315" class="difflineplus">+    // If this is the install event the add-ons shouldn't already be installed</span>
<a href="#l7.316"></a><span id="l7.316" class="difflineplus">+    if (info.event == &quot;install&quot;) {</span>
<a href="#l7.317"></a><span id="l7.317" class="difflineplus">+      this.checkAddonNotInstalled(id);</span>
<a href="#l7.318"></a><span id="l7.318" class="difflineplus">+</span>
<a href="#l7.319"></a><span id="l7.319" class="difflineplus">+      this.installed.set(id, info);</span>
<a href="#l7.320"></a><span id="l7.320" class="difflineplus">+</span>
<a href="#l7.321"></a><span id="l7.321" class="difflineplus">+      for (let resolve of this.installPromises)</span>
<a href="#l7.322"></a><span id="l7.322" class="difflineplus">+        resolve();</span>
<a href="#l7.323"></a><span id="l7.323" class="difflineplus">+      this.installPromises = [];</span>
<a href="#l7.324"></a><span id="l7.324" class="difflineplus">+    } else {</span>
<a href="#l7.325"></a><span id="l7.325" class="difflineplus">+      this.checkMatches(this.installed.get(id), info);</span>
<a href="#l7.326"></a><span id="l7.326" class="difflineplus">+    }</span>
<a href="#l7.327"></a><span id="l7.327" class="difflineplus">+</span>
<a href="#l7.328"></a><span id="l7.328" class="difflineplus">+    // If this is the shutdown event than the add-on should already be started</span>
<a href="#l7.329"></a><span id="l7.329" class="difflineplus">+    if (info.event == &quot;shutdown&quot;) {</span>
<a href="#l7.330"></a><span id="l7.330" class="difflineplus">+      this.checkMatches(this.started.get(id), info);</span>
<a href="#l7.331"></a><span id="l7.331" class="difflineplus">+</span>
<a href="#l7.332"></a><span id="l7.332" class="difflineplus">+      this.started.delete(id);</span>
<a href="#l7.333"></a><span id="l7.333" class="difflineplus">+      this.stopped.set(id, info);</span>
<a href="#l7.334"></a><span id="l7.334" class="difflineplus">+</span>
<a href="#l7.335"></a><span id="l7.335" class="difflineplus">+      // Chrome should still be registered at this point</span>
<a href="#l7.336"></a><span id="l7.336" class="difflineplus">+      let isRegistered = isManifestRegistered(installPath);</span>
<a href="#l7.337"></a><span id="l7.337" class="difflineplus">+      Assert.ok(isRegistered);</span>
<a href="#l7.338"></a><span id="l7.338" class="difflineplus">+</span>
<a href="#l7.339"></a><span id="l7.339" class="difflineplus">+      // XPIProvider doesn't bother unregistering chrome on app shutdown but</span>
<a href="#l7.340"></a><span id="l7.340" class="difflineplus">+      // since we simulate restarts we must do so manually to keep the registry</span>
<a href="#l7.341"></a><span id="l7.341" class="difflineplus">+      // consistent.</span>
<a href="#l7.342"></a><span id="l7.342" class="difflineplus">+      if (info.reason == 2 /* APP_SHUTDOWN */)</span>
<a href="#l7.343"></a><span id="l7.343" class="difflineplus">+        Components.manager.removeBootstrappedManifestLocation(installPath);</span>
<a href="#l7.344"></a><span id="l7.344" class="difflineplus">+    } else {</span>
<a href="#l7.345"></a><span id="l7.345" class="difflineplus">+      this.checkAddonNotStarted(id);</span>
<a href="#l7.346"></a><span id="l7.346" class="difflineplus">+    }</span>
<a href="#l7.347"></a><span id="l7.347" class="difflineplus">+</span>
<a href="#l7.348"></a><span id="l7.348" class="difflineplus">+    if (info.event == &quot;uninstall&quot;) {</span>
<a href="#l7.349"></a><span id="l7.349" class="difflineplus">+      // We currently support registering, but not unregistering,</span>
<a href="#l7.350"></a><span id="l7.350" class="difflineplus">+      // restartful add-on manifests during xpcshell AOM &quot;restarts&quot;.</span>
<a href="#l7.351"></a><span id="l7.351" class="difflineplus">+      if (!this.restartfulIds.has(id)) {</span>
<a href="#l7.352"></a><span id="l7.352" class="difflineplus">+        // Chrome should be unregistered at this point</span>
<a href="#l7.353"></a><span id="l7.353" class="difflineplus">+        let isRegistered = isManifestRegistered(installPath);</span>
<a href="#l7.354"></a><span id="l7.354" class="difflineplus">+        Assert.ok(!isRegistered);</span>
<a href="#l7.355"></a><span id="l7.355" class="difflineplus">+      }</span>
<a href="#l7.356"></a><span id="l7.356" class="difflineplus">+</span>
<a href="#l7.357"></a><span id="l7.357" class="difflineplus">+      this.installed.delete(id);</span>
<a href="#l7.358"></a><span id="l7.358" class="difflineplus">+      this.uninstalled.set(id, info);</span>
<a href="#l7.359"></a><span id="l7.359" class="difflineplus">+    } else if (info.event == &quot;startup&quot;) {</span>
<a href="#l7.360"></a><span id="l7.360" class="difflineplus">+      this.started.set(id, info);</span>
<a href="#l7.361"></a><span id="l7.361" class="difflineplus">+</span>
<a href="#l7.362"></a><span id="l7.362" class="difflineplus">+      // Chrome should be registered at this point</span>
<a href="#l7.363"></a><span id="l7.363" class="difflineplus">+      let isRegistered = isManifestRegistered(installPath);</span>
<a href="#l7.364"></a><span id="l7.364" class="difflineplus">+      Assert.ok(isRegistered);</span>
<a href="#l7.365"></a><span id="l7.365" class="difflineplus">+</span>
<a href="#l7.366"></a><span id="l7.366" class="difflineplus">+      for (let resolve of this.startupPromises)</span>
<a href="#l7.367"></a><span id="l7.367" class="difflineplus">+        resolve();</span>
<a href="#l7.368"></a><span id="l7.368" class="difflineplus">+      this.startupPromises = [];</span>
<a href="#l7.369"></a><span id="l7.369" class="difflineplus">+    }</span>
<a href="#l7.370"></a><span id="l7.370" class="difflineplus">+  },</span>
<a href="#l7.371"></a><span id="l7.371" class="difflineplus">+};</span>
<a href="#l7.372"></a><span id="l7.372" class="difflineplus">+</span>
<a href="#l7.373"></a><span id="l7.373" class="difflineplus">+AddonTestUtils.on(&quot;addon-manager-shutdown&quot;, () =&gt; {</span>
<a href="#l7.374"></a><span id="l7.374" class="difflineplus">+  BootstrapMonitor.shutdownCheck();</span>
<a href="#l7.375"></a><span id="l7.375" class="difflineplus">+  Cu.unload(&quot;resource:///modules/BootstrapLoader.jsm&quot;);</span>
<a href="#l7.376"></a><span id="l7.376" class="difflineplus">+});</span>
<a href="#l7.377"></a><span id="l7.377" class="difflineplus">+</span>
<a href="#l7.378"></a><span id="l7.378" class="difflineplus">+var SlightlyLessDodgyBootstrapMonitor = {</span>
<a href="#l7.379"></a><span id="l7.379" class="difflineplus">+  started: new Map(),</span>
<a href="#l7.380"></a><span id="l7.380" class="difflineplus">+  stopped: new Map(),</span>
<a href="#l7.381"></a><span id="l7.381" class="difflineplus">+  installed: new Map(),</span>
<a href="#l7.382"></a><span id="l7.382" class="difflineplus">+  uninstalled: new Map(),</span>
<a href="#l7.383"></a><span id="l7.383" class="difflineplus">+</span>
<a href="#l7.384"></a><span id="l7.384" class="difflineplus">+  init() {</span>
<a href="#l7.385"></a><span id="l7.385" class="difflineplus">+    this.onEvent = this.onEvent.bind(this);</span>
<a href="#l7.386"></a><span id="l7.386" class="difflineplus">+</span>
<a href="#l7.387"></a><span id="l7.387" class="difflineplus">+    AddonTestUtils.on(&quot;addon-manager-shutdown&quot;, this.onEvent);</span>
<a href="#l7.388"></a><span id="l7.388" class="difflineplus">+    AddonTestUtils.on(&quot;bootstrap-method&quot;, this.onEvent);</span>
<a href="#l7.389"></a><span id="l7.389" class="difflineplus">+  },</span>
<a href="#l7.390"></a><span id="l7.390" class="difflineplus">+</span>
<a href="#l7.391"></a><span id="l7.391" class="difflineplus">+  shutdownCheck() {</span>
<a href="#l7.392"></a><span id="l7.392" class="difflineplus">+    equal(this.started.size, 0,</span>
<a href="#l7.393"></a><span id="l7.393" class="difflineplus">+          &quot;Should have no add-ons that were started but not shutdown&quot;);</span>
<a href="#l7.394"></a><span id="l7.394" class="difflineplus">+  },</span>
<a href="#l7.395"></a><span id="l7.395" class="difflineplus">+</span>
<a href="#l7.396"></a><span id="l7.396" class="difflineplus">+  onEvent(msg, data) {</span>
<a href="#l7.397"></a><span id="l7.397" class="difflineplus">+    switch (msg) {</span>
<a href="#l7.398"></a><span id="l7.398" class="difflineplus">+      case &quot;addon-manager-shutdown&quot;:</span>
<a href="#l7.399"></a><span id="l7.399" class="difflineplus">+        this.shutdownCheck();</span>
<a href="#l7.400"></a><span id="l7.400" class="difflineplus">+        break;</span>
<a href="#l7.401"></a><span id="l7.401" class="difflineplus">+      case &quot;bootstrap-method&quot;:</span>
<a href="#l7.402"></a><span id="l7.402" class="difflineplus">+        this.onBootstrapMethod(data.method, data.params, data.reason);</span>
<a href="#l7.403"></a><span id="l7.403" class="difflineplus">+        break;</span>
<a href="#l7.404"></a><span id="l7.404" class="difflineplus">+    }</span>
<a href="#l7.405"></a><span id="l7.405" class="difflineplus">+  },</span>
<a href="#l7.406"></a><span id="l7.406" class="difflineplus">+</span>
<a href="#l7.407"></a><span id="l7.407" class="difflineplus">+  onBootstrapMethod(method, params, reason) {</span>
<a href="#l7.408"></a><span id="l7.408" class="difflineplus">+    let {id} = params;</span>
<a href="#l7.409"></a><span id="l7.409" class="difflineplus">+</span>
<a href="#l7.410"></a><span id="l7.410" class="difflineplus">+    info(`Bootstrap method ${method} for ${params.id} version ${params.version}`);</span>
<a href="#l7.411"></a><span id="l7.411" class="difflineplus">+</span>
<a href="#l7.412"></a><span id="l7.412" class="difflineplus">+    if (method !== &quot;install&quot;) {</span>
<a href="#l7.413"></a><span id="l7.413" class="difflineplus">+      this.checkInstalled(id);</span>
<a href="#l7.414"></a><span id="l7.414" class="difflineplus">+    }</span>
<a href="#l7.415"></a><span id="l7.415" class="difflineplus">+</span>
<a href="#l7.416"></a><span id="l7.416" class="difflineplus">+    switch (method) {</span>
<a href="#l7.417"></a><span id="l7.417" class="difflineplus">+      case &quot;install&quot;:</span>
<a href="#l7.418"></a><span id="l7.418" class="difflineplus">+        this.checkNotInstalled(id);</span>
<a href="#l7.419"></a><span id="l7.419" class="difflineplus">+        this.installed.set(id, {reason, params});</span>
<a href="#l7.420"></a><span id="l7.420" class="difflineplus">+        this.uninstalled.delete(id);</span>
<a href="#l7.421"></a><span id="l7.421" class="difflineplus">+        break;</span>
<a href="#l7.422"></a><span id="l7.422" class="difflineplus">+      case &quot;startup&quot;:</span>
<a href="#l7.423"></a><span id="l7.423" class="difflineplus">+        this.checkNotStarted(id);</span>
<a href="#l7.424"></a><span id="l7.424" class="difflineplus">+        this.started.set(id, {reason, params});</span>
<a href="#l7.425"></a><span id="l7.425" class="difflineplus">+        this.stopped.delete(id);</span>
<a href="#l7.426"></a><span id="l7.426" class="difflineplus">+        break;</span>
<a href="#l7.427"></a><span id="l7.427" class="difflineplus">+      case &quot;shutdown&quot;:</span>
<a href="#l7.428"></a><span id="l7.428" class="difflineplus">+        this.checkMatches(&quot;shutdown&quot;, &quot;startup&quot;, params, this.started.get(id));</span>
<a href="#l7.429"></a><span id="l7.429" class="difflineplus">+        this.checkStarted(id);</span>
<a href="#l7.430"></a><span id="l7.430" class="difflineplus">+        this.stopped.set(id, {reason, params});</span>
<a href="#l7.431"></a><span id="l7.431" class="difflineplus">+        this.started.delete(id);</span>
<a href="#l7.432"></a><span id="l7.432" class="difflineplus">+        break;</span>
<a href="#l7.433"></a><span id="l7.433" class="difflineplus">+      case &quot;uninstall&quot;:</span>
<a href="#l7.434"></a><span id="l7.434" class="difflineplus">+        this.checkMatches(&quot;uninstall&quot;, &quot;install&quot;, params, this.installed.get(id));</span>
<a href="#l7.435"></a><span id="l7.435" class="difflineplus">+        this.uninstalled.set(id, {reason, params});</span>
<a href="#l7.436"></a><span id="l7.436" class="difflineplus">+        this.installed.delete(id);</span>
<a href="#l7.437"></a><span id="l7.437" class="difflineplus">+        break;</span>
<a href="#l7.438"></a><span id="l7.438" class="difflineplus">+      case &quot;update&quot;:</span>
<a href="#l7.439"></a><span id="l7.439" class="difflineplus">+        this.checkMatches(&quot;update&quot;, &quot;install&quot;, params, this.installed.get(id));</span>
<a href="#l7.440"></a><span id="l7.440" class="difflineplus">+        this.installed.set(id, {reason, params});</span>
<a href="#l7.441"></a><span id="l7.441" class="difflineplus">+        break;</span>
<a href="#l7.442"></a><span id="l7.442" class="difflineplus">+    }</span>
<a href="#l7.443"></a><span id="l7.443" class="difflineplus">+  },</span>
<a href="#l7.444"></a><span id="l7.444" class="difflineplus">+</span>
<a href="#l7.445"></a><span id="l7.445" class="difflineplus">+  clear(id) {</span>
<a href="#l7.446"></a><span id="l7.446" class="difflineplus">+    this.installed.delete(id);</span>
<a href="#l7.447"></a><span id="l7.447" class="difflineplus">+    this.started.delete(id);</span>
<a href="#l7.448"></a><span id="l7.448" class="difflineplus">+    this.stopped.delete(id);</span>
<a href="#l7.449"></a><span id="l7.449" class="difflineplus">+    this.uninstalled.delete(id);</span>
<a href="#l7.450"></a><span id="l7.450" class="difflineplus">+  },</span>
<a href="#l7.451"></a><span id="l7.451" class="difflineplus">+</span>
<a href="#l7.452"></a><span id="l7.452" class="difflineplus">+  checkMatches(method, lastMethod, params, {params: lastParams} = {}) {</span>
<a href="#l7.453"></a><span id="l7.453" class="difflineplus">+    ok(lastParams,</span>
<a href="#l7.454"></a><span id="l7.454" class="difflineplus">+       `Expecting matching ${lastMethod} call for add-on ${params.id} ${method} call`);</span>
<a href="#l7.455"></a><span id="l7.455" class="difflineplus">+</span>
<a href="#l7.456"></a><span id="l7.456" class="difflineplus">+    if (method == &quot;update&quot;) {</span>
<a href="#l7.457"></a><span id="l7.457" class="difflineplus">+      equal(params.oldVersion, lastParams.version,</span>
<a href="#l7.458"></a><span id="l7.458" class="difflineplus">+            &quot;params.version should match last call&quot;);</span>
<a href="#l7.459"></a><span id="l7.459" class="difflineplus">+    } else {</span>
<a href="#l7.460"></a><span id="l7.460" class="difflineplus">+      equal(params.version, lastParams.version,</span>
<a href="#l7.461"></a><span id="l7.461" class="difflineplus">+            &quot;params.version should match last call&quot;);</span>
<a href="#l7.462"></a><span id="l7.462" class="difflineplus">+    }</span>
<a href="#l7.463"></a><span id="l7.463" class="difflineplus">+</span>
<a href="#l7.464"></a><span id="l7.464" class="difflineplus">+    if (method !== &quot;update&quot; &amp;&amp; method !== &quot;uninstall&quot;) {</span>
<a href="#l7.465"></a><span id="l7.465" class="difflineplus">+      equal(params.installPath.path, lastParams.installPath.path,</span>
<a href="#l7.466"></a><span id="l7.466" class="difflineplus">+            `params.installPath should match last call`);</span>
<a href="#l7.467"></a><span id="l7.467" class="difflineplus">+</span>
<a href="#l7.468"></a><span id="l7.468" class="difflineplus">+      ok(params.resourceURI.equals(lastParams.resourceURI),</span>
<a href="#l7.469"></a><span id="l7.469" class="difflineplus">+         `params.resourceURI should match: &quot;${params.resourceURI.spec}&quot; == &quot;${lastParams.resourceURI.spec}&quot;`);</span>
<a href="#l7.470"></a><span id="l7.470" class="difflineplus">+    }</span>
<a href="#l7.471"></a><span id="l7.471" class="difflineplus">+  },</span>
<a href="#l7.472"></a><span id="l7.472" class="difflineplus">+</span>
<a href="#l7.473"></a><span id="l7.473" class="difflineplus">+  checkStarted(id, version = undefined) {</span>
<a href="#l7.474"></a><span id="l7.474" class="difflineplus">+    let started = this.started.get(id);</span>
<a href="#l7.475"></a><span id="l7.475" class="difflineplus">+    ok(started, `Should have seen startup method call for ${id}`);</span>
<a href="#l7.476"></a><span id="l7.476" class="difflineplus">+</span>
<a href="#l7.477"></a><span id="l7.477" class="difflineplus">+    if (version !== undefined)</span>
<a href="#l7.478"></a><span id="l7.478" class="difflineplus">+      equal(started.params.version, version,</span>
<a href="#l7.479"></a><span id="l7.479" class="difflineplus">+            &quot;Expected version number&quot;);</span>
<a href="#l7.480"></a><span id="l7.480" class="difflineplus">+  },</span>
<a href="#l7.481"></a><span id="l7.481" class="difflineplus">+</span>
<a href="#l7.482"></a><span id="l7.482" class="difflineplus">+  checkNotStarted(id) {</span>
<a href="#l7.483"></a><span id="l7.483" class="difflineplus">+    ok(!this.started.has(id),</span>
<a href="#l7.484"></a><span id="l7.484" class="difflineplus">+       `Should not have seen startup method call for ${id}`);</span>
<a href="#l7.485"></a><span id="l7.485" class="difflineplus">+  },</span>
<a href="#l7.486"></a><span id="l7.486" class="difflineplus">+</span>
<a href="#l7.487"></a><span id="l7.487" class="difflineplus">+  checkInstalled(id, version = undefined) {</span>
<a href="#l7.488"></a><span id="l7.488" class="difflineplus">+    const installed = this.installed.get(id);</span>
<a href="#l7.489"></a><span id="l7.489" class="difflineplus">+    ok(installed, `Should have seen install call for ${id}`);</span>
<a href="#l7.490"></a><span id="l7.490" class="difflineplus">+</span>
<a href="#l7.491"></a><span id="l7.491" class="difflineplus">+    if (version !== undefined)</span>
<a href="#l7.492"></a><span id="l7.492" class="difflineplus">+      equal(installed.params.version, version,</span>
<a href="#l7.493"></a><span id="l7.493" class="difflineplus">+            &quot;Expected version number&quot;);</span>
<a href="#l7.494"></a><span id="l7.494" class="difflineplus">+</span>
<a href="#l7.495"></a><span id="l7.495" class="difflineplus">+    return installed;</span>
<a href="#l7.496"></a><span id="l7.496" class="difflineplus">+  },</span>
<a href="#l7.497"></a><span id="l7.497" class="difflineplus">+</span>
<a href="#l7.498"></a><span id="l7.498" class="difflineplus">+  checkNotInstalled(id) {</span>
<a href="#l7.499"></a><span id="l7.499" class="difflineplus">+    ok(!this.installed.has(id),</span>
<a href="#l7.500"></a><span id="l7.500" class="difflineplus">+       `Should not have seen install method call for ${id}`);</span>
<a href="#l7.501"></a><span id="l7.501" class="difflineplus">+  },</span>
<a href="#l7.502"></a><span id="l7.502" class="difflineplus">+};</span>
<a href="#l7.503"></a><span id="l7.503" class="difflineplus">+</span>
<a href="#l7.504"></a><span id="l7.504" class="difflineplus">+function isNightlyChannel() {</span>
<a href="#l7.505"></a><span id="l7.505" class="difflineplus">+  var channel = Services.prefs.getCharPref(&quot;app.update.channel&quot;, &quot;default&quot;);</span>
<a href="#l7.506"></a><span id="l7.506" class="difflineplus">+</span>
<a href="#l7.507"></a><span id="l7.507" class="difflineplus">+  return channel != &quot;aurora&quot; &amp;&amp; channel != &quot;beta&quot; &amp;&amp; channel != &quot;release&quot; &amp;&amp; channel != &quot;esr&quot;;</span>
<a href="#l7.508"></a><span id="l7.508" class="difflineplus">+}</span>
<a href="#l7.509"></a><span id="l7.509" class="difflineplus">+</span>
<a href="#l7.510"></a><span id="l7.510" class="difflineplus">+</span>
<a href="#l7.511"></a><span id="l7.511" class="difflineplus">+async function restartWithLocales(locales) {</span>
<a href="#l7.512"></a><span id="l7.512" class="difflineplus">+  Services.locale.requestedLocales = locales;</span>
<a href="#l7.513"></a><span id="l7.513" class="difflineplus">+  await promiseRestartManager();</span>
<a href="#l7.514"></a><span id="l7.514" class="difflineplus">+}</span>
<a href="#l7.515"></a><span id="l7.515" class="difflineplus">+</span>
<a href="#l7.516"></a><span id="l7.516" class="difflineplus">+/**</span>
<a href="#l7.517"></a><span id="l7.517" class="difflineplus">+ * Returns a map of Addon objects for installed add-ons with the given</span>
<a href="#l7.518"></a><span id="l7.518" class="difflineplus">+ * IDs. The returned map contains a key for the ID of each add-on that</span>
<a href="#l7.519"></a><span id="l7.519" class="difflineplus">+ * is found. IDs for add-ons which do not exist are not present in the</span>
<a href="#l7.520"></a><span id="l7.520" class="difflineplus">+ * map.</span>
<a href="#l7.521"></a><span id="l7.521" class="difflineplus">+ *</span>
<a href="#l7.522"></a><span id="l7.522" class="difflineplus">+ * @param {sequence&lt;string&gt;} ids</span>
<a href="#l7.523"></a><span id="l7.523" class="difflineplus">+ *        The list of add-on IDs to get.</span>
<a href="#l7.524"></a><span id="l7.524" class="difflineplus">+ * @returns {Promise&lt;string, Addon&gt;}</span>
<a href="#l7.525"></a><span id="l7.525" class="difflineplus">+ *        Map of add-ons that were found.</span>
<a href="#l7.526"></a><span id="l7.526" class="difflineplus">+ */</span>
<a href="#l7.527"></a><span id="l7.527" class="difflineplus">+async function getAddons(ids) {</span>
<a href="#l7.528"></a><span id="l7.528" class="difflineplus">+  let addons = new Map();</span>
<a href="#l7.529"></a><span id="l7.529" class="difflineplus">+  for (let addon of await AddonManager.getAddonsByIDs(ids)) {</span>
<a href="#l7.530"></a><span id="l7.530" class="difflineplus">+    if (addon) {</span>
<a href="#l7.531"></a><span id="l7.531" class="difflineplus">+      addons.set(addon.id, addon);</span>
<a href="#l7.532"></a><span id="l7.532" class="difflineplus">+    }</span>
<a href="#l7.533"></a><span id="l7.533" class="difflineplus">+  }</span>
<a href="#l7.534"></a><span id="l7.534" class="difflineplus">+  return addons;</span>
<a href="#l7.535"></a><span id="l7.535" class="difflineplus">+}</span>
<a href="#l7.536"></a><span id="l7.536" class="difflineplus">+</span>
<a href="#l7.537"></a><span id="l7.537" class="difflineplus">+/**</span>
<a href="#l7.538"></a><span id="l7.538" class="difflineplus">+ * Checks that the given add-on has the given expected properties.</span>
<a href="#l7.539"></a><span id="l7.539" class="difflineplus">+ *</span>
<a href="#l7.540"></a><span id="l7.540" class="difflineplus">+ * @param {string} id</span>
<a href="#l7.541"></a><span id="l7.541" class="difflineplus">+ *        The id of the add-on.</span>
<a href="#l7.542"></a><span id="l7.542" class="difflineplus">+ * @param {Addon?} addon</span>
<a href="#l7.543"></a><span id="l7.543" class="difflineplus">+ *        The add-on object, or null if the add-on does not exist.</span>
<a href="#l7.544"></a><span id="l7.544" class="difflineplus">+ * @param {object?} expected</span>
<a href="#l7.545"></a><span id="l7.545" class="difflineplus">+ *        An object containing the expected values for properties of the</span>
<a href="#l7.546"></a><span id="l7.546" class="difflineplus">+ *        add-on, or null if the add-on is expected not to exist.</span>
<a href="#l7.547"></a><span id="l7.547" class="difflineplus">+ */</span>
<a href="#l7.548"></a><span id="l7.548" class="difflineplus">+function checkAddon(id, addon, expected) {</span>
<a href="#l7.549"></a><span id="l7.549" class="difflineplus">+  info(`Checking state of addon ${id}`);</span>
<a href="#l7.550"></a><span id="l7.550" class="difflineplus">+</span>
<a href="#l7.551"></a><span id="l7.551" class="difflineplus">+  if (expected === null) {</span>
<a href="#l7.552"></a><span id="l7.552" class="difflineplus">+    ok(!addon, `Addon ${id} should not exist`);</span>
<a href="#l7.553"></a><span id="l7.553" class="difflineplus">+  } else {</span>
<a href="#l7.554"></a><span id="l7.554" class="difflineplus">+    ok(addon, `Addon ${id} should exist`);</span>
<a href="#l7.555"></a><span id="l7.555" class="difflineplus">+    for (let [key, value] of Object.entries(expected)) {</span>
<a href="#l7.556"></a><span id="l7.556" class="difflineplus">+      if (value instanceof Ci.nsIURI) {</span>
<a href="#l7.557"></a><span id="l7.557" class="difflineplus">+        equal(addon[key] &amp;&amp; addon[key].spec, value.spec, `Expected value of addon.${key}`);</span>
<a href="#l7.558"></a><span id="l7.558" class="difflineplus">+      } else {</span>
<a href="#l7.559"></a><span id="l7.559" class="difflineplus">+        deepEqual(addon[key], value, `Expected value of addon.${key}`);</span>
<a href="#l7.560"></a><span id="l7.560" class="difflineplus">+      }</span>
<a href="#l7.561"></a><span id="l7.561" class="difflineplus">+    }</span>
<a href="#l7.562"></a><span id="l7.562" class="difflineplus">+  }</span>
<a href="#l7.563"></a><span id="l7.563" class="difflineplus">+}</span>
<a href="#l7.564"></a><span id="l7.564" class="difflineplus">+</span>
<a href="#l7.565"></a><span id="l7.565" class="difflineplus">+/**</span>
<a href="#l7.566"></a><span id="l7.566" class="difflineplus">+ * Tests that an add-on does appear in the crash report annotations, if</span>
<a href="#l7.567"></a><span id="l7.567" class="difflineplus">+ * crash reporting is enabled. The test will fail if the add-on is not in the</span>
<a href="#l7.568"></a><span id="l7.568" class="difflineplus">+ * annotation.</span>
<a href="#l7.569"></a><span id="l7.569" class="difflineplus">+ * @param  aId</span>
<a href="#l7.570"></a><span id="l7.570" class="difflineplus">+ *         The ID of the add-on</span>
<a href="#l7.571"></a><span id="l7.571" class="difflineplus">+ * @param  aVersion</span>
<a href="#l7.572"></a><span id="l7.572" class="difflineplus">+ *         The version of the add-on</span>
<a href="#l7.573"></a><span id="l7.573" class="difflineplus">+ */</span>
<a href="#l7.574"></a><span id="l7.574" class="difflineplus">+function do_check_in_crash_annotation(aId, aVersion) {</span>
<a href="#l7.575"></a><span id="l7.575" class="difflineplus">+  if (!AppConstants.MOZ_CRASHREPORTER) {</span>
<a href="#l7.576"></a><span id="l7.576" class="difflineplus">+    return;</span>
<a href="#l7.577"></a><span id="l7.577" class="difflineplus">+  }</span>
<a href="#l7.578"></a><span id="l7.578" class="difflineplus">+</span>
<a href="#l7.579"></a><span id="l7.579" class="difflineplus">+  if (!(&quot;Add-ons&quot; in gAppInfo.annotations)) {</span>
<a href="#l7.580"></a><span id="l7.580" class="difflineplus">+    Assert.ok(false, &quot;Cannot find Add-ons entry in crash annotations&quot;);</span>
<a href="#l7.581"></a><span id="l7.581" class="difflineplus">+    return;</span>
<a href="#l7.582"></a><span id="l7.582" class="difflineplus">+  }</span>
<a href="#l7.583"></a><span id="l7.583" class="difflineplus">+</span>
<a href="#l7.584"></a><span id="l7.584" class="difflineplus">+  let addons = gAppInfo.annotations[&quot;Add-ons&quot;].split(&quot;,&quot;);</span>
<a href="#l7.585"></a><span id="l7.585" class="difflineplus">+  Assert.ok(addons.includes(`${encodeURIComponent(aId)}:${encodeURIComponent(aVersion)}`));</span>
<a href="#l7.586"></a><span id="l7.586" class="difflineplus">+}</span>
<a href="#l7.587"></a><span id="l7.587" class="difflineplus">+</span>
<a href="#l7.588"></a><span id="l7.588" class="difflineplus">+/**</span>
<a href="#l7.589"></a><span id="l7.589" class="difflineplus">+ * Tests that an add-on does not appear in the crash report annotations, if</span>
<a href="#l7.590"></a><span id="l7.590" class="difflineplus">+ * crash reporting is enabled. The test will fail if the add-on is in the</span>
<a href="#l7.591"></a><span id="l7.591" class="difflineplus">+ * annotation.</span>
<a href="#l7.592"></a><span id="l7.592" class="difflineplus">+ * @param  aId</span>
<a href="#l7.593"></a><span id="l7.593" class="difflineplus">+ *         The ID of the add-on</span>
<a href="#l7.594"></a><span id="l7.594" class="difflineplus">+ * @param  aVersion</span>
<a href="#l7.595"></a><span id="l7.595" class="difflineplus">+ *         The version of the add-on</span>
<a href="#l7.596"></a><span id="l7.596" class="difflineplus">+ */</span>
<a href="#l7.597"></a><span id="l7.597" class="difflineplus">+function do_check_not_in_crash_annotation(aId, aVersion) {</span>
<a href="#l7.598"></a><span id="l7.598" class="difflineplus">+  if (!AppConstants.MOZ_CRASHREPORTER) {</span>
<a href="#l7.599"></a><span id="l7.599" class="difflineplus">+    return;</span>
<a href="#l7.600"></a><span id="l7.600" class="difflineplus">+  }</span>
<a href="#l7.601"></a><span id="l7.601" class="difflineplus">+</span>
<a href="#l7.602"></a><span id="l7.602" class="difflineplus">+  if (!(&quot;Add-ons&quot; in gAppInfo.annotations)) {</span>
<a href="#l7.603"></a><span id="l7.603" class="difflineplus">+    Assert.ok(true);</span>
<a href="#l7.604"></a><span id="l7.604" class="difflineplus">+    return;</span>
<a href="#l7.605"></a><span id="l7.605" class="difflineplus">+  }</span>
<a href="#l7.606"></a><span id="l7.606" class="difflineplus">+</span>
<a href="#l7.607"></a><span id="l7.607" class="difflineplus">+  let addons = gAppInfo.annotations[&quot;Add-ons&quot;].split(&quot;,&quot;);</span>
<a href="#l7.608"></a><span id="l7.608" class="difflineplus">+  Assert.ok(!addons.includes(`${encodeURIComponent(aId)}:${encodeURIComponent(aVersion)}`));</span>
<a href="#l7.609"></a><span id="l7.609" class="difflineplus">+}</span>
<a href="#l7.610"></a><span id="l7.610" class="difflineplus">+</span>
<a href="#l7.611"></a><span id="l7.611" class="difflineplus">+function do_get_file_hash(aFile, aAlgorithm) {</span>
<a href="#l7.612"></a><span id="l7.612" class="difflineplus">+  if (!aAlgorithm)</span>
<a href="#l7.613"></a><span id="l7.613" class="difflineplus">+    aAlgorithm = &quot;sha1&quot;;</span>
<a href="#l7.614"></a><span id="l7.614" class="difflineplus">+</span>
<a href="#l7.615"></a><span id="l7.615" class="difflineplus">+  let crypto = Cc[&quot;@mozilla.org/security/hash;1&quot;].</span>
<a href="#l7.616"></a><span id="l7.616" class="difflineplus">+               createInstance(Ci.nsICryptoHash);</span>
<a href="#l7.617"></a><span id="l7.617" class="difflineplus">+  crypto.initWithString(aAlgorithm);</span>
<a href="#l7.618"></a><span id="l7.618" class="difflineplus">+  let fis = Cc[&quot;@mozilla.org/network/file-input-stream;1&quot;].</span>
<a href="#l7.619"></a><span id="l7.619" class="difflineplus">+            createInstance(Ci.nsIFileInputStream);</span>
<a href="#l7.620"></a><span id="l7.620" class="difflineplus">+  fis.init(aFile, -1, -1, false);</span>
<a href="#l7.621"></a><span id="l7.621" class="difflineplus">+  crypto.updateFromStream(fis, aFile.fileSize);</span>
<a href="#l7.622"></a><span id="l7.622" class="difflineplus">+</span>
<a href="#l7.623"></a><span id="l7.623" class="difflineplus">+  // return the two-digit hexadecimal code for a byte</span>
<a href="#l7.624"></a><span id="l7.624" class="difflineplus">+  let toHexString = charCode =&gt; (&quot;0&quot; + charCode.toString(16)).slice(-2);</span>
<a href="#l7.625"></a><span id="l7.625" class="difflineplus">+</span>
<a href="#l7.626"></a><span id="l7.626" class="difflineplus">+  let binary = crypto.finish(false);</span>
<a href="#l7.627"></a><span id="l7.627" class="difflineplus">+  let hash = Array.from(binary, c =&gt; toHexString(c.charCodeAt(0)));</span>
<a href="#l7.628"></a><span id="l7.628" class="difflineplus">+  return aAlgorithm + &quot;:&quot; + hash.join(&quot;&quot;);</span>
<a href="#l7.629"></a><span id="l7.629" class="difflineplus">+}</span>
<a href="#l7.630"></a><span id="l7.630" class="difflineplus">+</span>
<a href="#l7.631"></a><span id="l7.631" class="difflineplus">+/**</span>
<a href="#l7.632"></a><span id="l7.632" class="difflineplus">+ * Returns an extension uri spec</span>
<a href="#l7.633"></a><span id="l7.633" class="difflineplus">+ *</span>
<a href="#l7.634"></a><span id="l7.634" class="difflineplus">+ * @param  aProfileDir</span>
<a href="#l7.635"></a><span id="l7.635" class="difflineplus">+ *         The extension install directory</span>
<a href="#l7.636"></a><span id="l7.636" class="difflineplus">+ * @return a uri spec pointing to the root of the extension</span>
<a href="#l7.637"></a><span id="l7.637" class="difflineplus">+ */</span>
<a href="#l7.638"></a><span id="l7.638" class="difflineplus">+function do_get_addon_root_uri(aProfileDir, aId) {</span>
<a href="#l7.639"></a><span id="l7.639" class="difflineplus">+  let path = aProfileDir.clone();</span>
<a href="#l7.640"></a><span id="l7.640" class="difflineplus">+  path.append(aId);</span>
<a href="#l7.641"></a><span id="l7.641" class="difflineplus">+  if (!path.exists()) {</span>
<a href="#l7.642"></a><span id="l7.642" class="difflineplus">+    path.leafName += &quot;.xpi&quot;;</span>
<a href="#l7.643"></a><span id="l7.643" class="difflineplus">+    return &quot;jar:&quot; + Services.io.newFileURI(path).spec + &quot;!/&quot;;</span>
<a href="#l7.644"></a><span id="l7.644" class="difflineplus">+  }</span>
<a href="#l7.645"></a><span id="l7.645" class="difflineplus">+  return Services.io.newFileURI(path).spec;</span>
<a href="#l7.646"></a><span id="l7.646" class="difflineplus">+}</span>
<a href="#l7.647"></a><span id="l7.647" class="difflineplus">+</span>
<a href="#l7.648"></a><span id="l7.648" class="difflineplus">+function do_get_expected_addon_name(aId) {</span>
<a href="#l7.649"></a><span id="l7.649" class="difflineplus">+  if (TEST_UNPACKED)</span>
<a href="#l7.650"></a><span id="l7.650" class="difflineplus">+    return aId;</span>
<a href="#l7.651"></a><span id="l7.651" class="difflineplus">+  return aId + &quot;.xpi&quot;;</span>
<a href="#l7.652"></a><span id="l7.652" class="difflineplus">+}</span>
<a href="#l7.653"></a><span id="l7.653" class="difflineplus">+</span>
<a href="#l7.654"></a><span id="l7.654" class="difflineplus">+/**</span>
<a href="#l7.655"></a><span id="l7.655" class="difflineplus">+ * Check that an array of actual add-ons is the same as an array of</span>
<a href="#l7.656"></a><span id="l7.656" class="difflineplus">+ * expected add-ons.</span>
<a href="#l7.657"></a><span id="l7.657" class="difflineplus">+ *</span>
<a href="#l7.658"></a><span id="l7.658" class="difflineplus">+ * @param  aActualAddons</span>
<a href="#l7.659"></a><span id="l7.659" class="difflineplus">+ *         The array of actual add-ons to check.</span>
<a href="#l7.660"></a><span id="l7.660" class="difflineplus">+ * @param  aExpectedAddons</span>
<a href="#l7.661"></a><span id="l7.661" class="difflineplus">+ *         The array of expected add-ons to check against.</span>
<a href="#l7.662"></a><span id="l7.662" class="difflineplus">+ * @param  aProperties</span>
<a href="#l7.663"></a><span id="l7.663" class="difflineplus">+ *         An array of properties to check.</span>
<a href="#l7.664"></a><span id="l7.664" class="difflineplus">+ */</span>
<a href="#l7.665"></a><span id="l7.665" class="difflineplus">+function do_check_addons(aActualAddons, aExpectedAddons, aProperties) {</span>
<a href="#l7.666"></a><span id="l7.666" class="difflineplus">+  Assert.notEqual(aActualAddons, null);</span>
<a href="#l7.667"></a><span id="l7.667" class="difflineplus">+  Assert.equal(aActualAddons.length, aExpectedAddons.length);</span>
<a href="#l7.668"></a><span id="l7.668" class="difflineplus">+  for (let i = 0; i &lt; aActualAddons.length; i++)</span>
<a href="#l7.669"></a><span id="l7.669" class="difflineplus">+    do_check_addon(aActualAddons[i], aExpectedAddons[i], aProperties);</span>
<a href="#l7.670"></a><span id="l7.670" class="difflineplus">+}</span>
<a href="#l7.671"></a><span id="l7.671" class="difflineplus">+</span>
<a href="#l7.672"></a><span id="l7.672" class="difflineplus">+/**</span>
<a href="#l7.673"></a><span id="l7.673" class="difflineplus">+ * Check that the actual add-on is the same as the expected add-on.</span>
<a href="#l7.674"></a><span id="l7.674" class="difflineplus">+ *</span>
<a href="#l7.675"></a><span id="l7.675" class="difflineplus">+ * @param  aActualAddon</span>
<a href="#l7.676"></a><span id="l7.676" class="difflineplus">+ *         The actual add-on to check.</span>
<a href="#l7.677"></a><span id="l7.677" class="difflineplus">+ * @param  aExpectedAddon</span>
<a href="#l7.678"></a><span id="l7.678" class="difflineplus">+ *         The expected add-on to check against.</span>
<a href="#l7.679"></a><span id="l7.679" class="difflineplus">+ * @param  aProperties</span>
<a href="#l7.680"></a><span id="l7.680" class="difflineplus">+ *         An array of properties to check.</span>
<a href="#l7.681"></a><span id="l7.681" class="difflineplus">+ */</span>
<a href="#l7.682"></a><span id="l7.682" class="difflineplus">+function do_check_addon(aActualAddon, aExpectedAddon, aProperties) {</span>
<a href="#l7.683"></a><span id="l7.683" class="difflineplus">+  Assert.notEqual(aActualAddon, null);</span>
<a href="#l7.684"></a><span id="l7.684" class="difflineplus">+</span>
<a href="#l7.685"></a><span id="l7.685" class="difflineplus">+  aProperties.forEach(function(aProperty) {</span>
<a href="#l7.686"></a><span id="l7.686" class="difflineplus">+    let actualValue = aActualAddon[aProperty];</span>
<a href="#l7.687"></a><span id="l7.687" class="difflineplus">+    let expectedValue = aExpectedAddon[aProperty];</span>
<a href="#l7.688"></a><span id="l7.688" class="difflineplus">+</span>
<a href="#l7.689"></a><span id="l7.689" class="difflineplus">+    // Check that all undefined expected properties are null on actual add-on</span>
<a href="#l7.690"></a><span id="l7.690" class="difflineplus">+    if (!(aProperty in aExpectedAddon)) {</span>
<a href="#l7.691"></a><span id="l7.691" class="difflineplus">+      if (actualValue !== undefined &amp;&amp; actualValue !== null) {</span>
<a href="#l7.692"></a><span id="l7.692" class="difflineplus">+        do_throw(&quot;Unexpected defined/non-null property for add-on &quot; +</span>
<a href="#l7.693"></a><span id="l7.693" class="difflineplus">+                 aExpectedAddon.id + &quot; (addon[&quot; + aProperty + &quot;] = &quot; +</span>
<a href="#l7.694"></a><span id="l7.694" class="difflineplus">+                 actualValue.toSource() + &quot;)&quot;);</span>
<a href="#l7.695"></a><span id="l7.695" class="difflineplus">+      }</span>
<a href="#l7.696"></a><span id="l7.696" class="difflineplus">+</span>
<a href="#l7.697"></a><span id="l7.697" class="difflineplus">+      return;</span>
<a href="#l7.698"></a><span id="l7.698" class="difflineplus">+    }</span>
<a href="#l7.699"></a><span id="l7.699" class="difflineplus">+    if (expectedValue &amp;&amp; !actualValue) {</span>
<a href="#l7.700"></a><span id="l7.700" class="difflineplus">+      do_throw(&quot;Missing property for add-on &quot; + aExpectedAddon.id +</span>
<a href="#l7.701"></a><span id="l7.701" class="difflineplus">+        &quot;: expected addon[&quot; + aProperty + &quot;] = &quot; + expectedValue);</span>
<a href="#l7.702"></a><span id="l7.702" class="difflineplus">+      return;</span>
<a href="#l7.703"></a><span id="l7.703" class="difflineplus">+    }</span>
<a href="#l7.704"></a><span id="l7.704" class="difflineplus">+</span>
<a href="#l7.705"></a><span id="l7.705" class="difflineplus">+    switch (aProperty) {</span>
<a href="#l7.706"></a><span id="l7.706" class="difflineplus">+      case &quot;creator&quot;:</span>
<a href="#l7.707"></a><span id="l7.707" class="difflineplus">+        do_check_author(actualValue, expectedValue);</span>
<a href="#l7.708"></a><span id="l7.708" class="difflineplus">+        break;</span>
<a href="#l7.709"></a><span id="l7.709" class="difflineplus">+</span>
<a href="#l7.710"></a><span id="l7.710" class="difflineplus">+      case &quot;developers&quot;:</span>
<a href="#l7.711"></a><span id="l7.711" class="difflineplus">+        Assert.equal(actualValue.length, expectedValue.length);</span>
<a href="#l7.712"></a><span id="l7.712" class="difflineplus">+        for (let i = 0; i &lt; actualValue.length; i++)</span>
<a href="#l7.713"></a><span id="l7.713" class="difflineplus">+          do_check_author(actualValue[i], expectedValue[i]);</span>
<a href="#l7.714"></a><span id="l7.714" class="difflineplus">+        break;</span>
<a href="#l7.715"></a><span id="l7.715" class="difflineplus">+</span>
<a href="#l7.716"></a><span id="l7.716" class="difflineplus">+      case &quot;screenshots&quot;:</span>
<a href="#l7.717"></a><span id="l7.717" class="difflineplus">+        Assert.equal(actualValue.length, expectedValue.length);</span>
<a href="#l7.718"></a><span id="l7.718" class="difflineplus">+        for (let i = 0; i &lt; actualValue.length; i++)</span>
<a href="#l7.719"></a><span id="l7.719" class="difflineplus">+          do_check_screenshot(actualValue[i], expectedValue[i]);</span>
<a href="#l7.720"></a><span id="l7.720" class="difflineplus">+        break;</span>
<a href="#l7.721"></a><span id="l7.721" class="difflineplus">+</span>
<a href="#l7.722"></a><span id="l7.722" class="difflineplus">+      case &quot;sourceURI&quot;:</span>
<a href="#l7.723"></a><span id="l7.723" class="difflineplus">+        Assert.equal(actualValue.spec, expectedValue);</span>
<a href="#l7.724"></a><span id="l7.724" class="difflineplus">+        break;</span>
<a href="#l7.725"></a><span id="l7.725" class="difflineplus">+</span>
<a href="#l7.726"></a><span id="l7.726" class="difflineplus">+      case &quot;updateDate&quot;:</span>
<a href="#l7.727"></a><span id="l7.727" class="difflineplus">+        Assert.equal(actualValue.getTime(), expectedValue.getTime());</span>
<a href="#l7.728"></a><span id="l7.728" class="difflineplus">+        break;</span>
<a href="#l7.729"></a><span id="l7.729" class="difflineplus">+</span>
<a href="#l7.730"></a><span id="l7.730" class="difflineplus">+      case &quot;compatibilityOverrides&quot;:</span>
<a href="#l7.731"></a><span id="l7.731" class="difflineplus">+        Assert.equal(actualValue.length, expectedValue.length);</span>
<a href="#l7.732"></a><span id="l7.732" class="difflineplus">+        for (let i = 0; i &lt; actualValue.length; i++)</span>
<a href="#l7.733"></a><span id="l7.733" class="difflineplus">+          do_check_compatibilityoverride(actualValue[i], expectedValue[i]);</span>
<a href="#l7.734"></a><span id="l7.734" class="difflineplus">+        break;</span>
<a href="#l7.735"></a><span id="l7.735" class="difflineplus">+</span>
<a href="#l7.736"></a><span id="l7.736" class="difflineplus">+      case &quot;icons&quot;:</span>
<a href="#l7.737"></a><span id="l7.737" class="difflineplus">+        do_check_icons(actualValue, expectedValue);</span>
<a href="#l7.738"></a><span id="l7.738" class="difflineplus">+        break;</span>
<a href="#l7.739"></a><span id="l7.739" class="difflineplus">+</span>
<a href="#l7.740"></a><span id="l7.740" class="difflineplus">+      default:</span>
<a href="#l7.741"></a><span id="l7.741" class="difflineplus">+        if (actualValue !== expectedValue)</span>
<a href="#l7.742"></a><span id="l7.742" class="difflineplus">+          do_throw(&quot;Failed for &quot; + aProperty + &quot; for add-on &quot; + aExpectedAddon.id +</span>
<a href="#l7.743"></a><span id="l7.743" class="difflineplus">+                   &quot; (&quot; + actualValue + &quot; === &quot; + expectedValue + &quot;)&quot;);</span>
<a href="#l7.744"></a><span id="l7.744" class="difflineplus">+    }</span>
<a href="#l7.745"></a><span id="l7.745" class="difflineplus">+  });</span>
<a href="#l7.746"></a><span id="l7.746" class="difflineplus">+}</span>
<a href="#l7.747"></a><span id="l7.747" class="difflineplus">+</span>
<a href="#l7.748"></a><span id="l7.748" class="difflineplus">+/**</span>
<a href="#l7.749"></a><span id="l7.749" class="difflineplus">+ * Check that the actual author is the same as the expected author.</span>
<a href="#l7.750"></a><span id="l7.750" class="difflineplus">+ *</span>
<a href="#l7.751"></a><span id="l7.751" class="difflineplus">+ * @param  aActual</span>
<a href="#l7.752"></a><span id="l7.752" class="difflineplus">+ *         The actual author to check.</span>
<a href="#l7.753"></a><span id="l7.753" class="difflineplus">+ * @param  aExpected</span>
<a href="#l7.754"></a><span id="l7.754" class="difflineplus">+ *         The expected author to check against.</span>
<a href="#l7.755"></a><span id="l7.755" class="difflineplus">+ */</span>
<a href="#l7.756"></a><span id="l7.756" class="difflineplus">+function do_check_author(aActual, aExpected) {</span>
<a href="#l7.757"></a><span id="l7.757" class="difflineplus">+  Assert.equal(aActual.toString(), aExpected.name);</span>
<a href="#l7.758"></a><span id="l7.758" class="difflineplus">+  Assert.equal(aActual.name, aExpected.name);</span>
<a href="#l7.759"></a><span id="l7.759" class="difflineplus">+  Assert.equal(aActual.url, aExpected.url);</span>
<a href="#l7.760"></a><span id="l7.760" class="difflineplus">+}</span>
<a href="#l7.761"></a><span id="l7.761" class="difflineplus">+</span>
<a href="#l7.762"></a><span id="l7.762" class="difflineplus">+/**</span>
<a href="#l7.763"></a><span id="l7.763" class="difflineplus">+ * Check that the actual screenshot is the same as the expected screenshot.</span>
<a href="#l7.764"></a><span id="l7.764" class="difflineplus">+ *</span>
<a href="#l7.765"></a><span id="l7.765" class="difflineplus">+ * @param  aActual</span>
<a href="#l7.766"></a><span id="l7.766" class="difflineplus">+ *         The actual screenshot to check.</span>
<a href="#l7.767"></a><span id="l7.767" class="difflineplus">+ * @param  aExpected</span>
<a href="#l7.768"></a><span id="l7.768" class="difflineplus">+ *         The expected screenshot to check against.</span>
<a href="#l7.769"></a><span id="l7.769" class="difflineplus">+ */</span>
<a href="#l7.770"></a><span id="l7.770" class="difflineplus">+function do_check_screenshot(aActual, aExpected) {</span>
<a href="#l7.771"></a><span id="l7.771" class="difflineplus">+  Assert.equal(aActual.toString(), aExpected.url);</span>
<a href="#l7.772"></a><span id="l7.772" class="difflineplus">+  Assert.equal(aActual.url, aExpected.url);</span>
<a href="#l7.773"></a><span id="l7.773" class="difflineplus">+  Assert.equal(aActual.width, aExpected.width);</span>
<a href="#l7.774"></a><span id="l7.774" class="difflineplus">+  Assert.equal(aActual.height, aExpected.height);</span>
<a href="#l7.775"></a><span id="l7.775" class="difflineplus">+  Assert.equal(aActual.thumbnailURL, aExpected.thumbnailURL);</span>
<a href="#l7.776"></a><span id="l7.776" class="difflineplus">+  Assert.equal(aActual.thumbnailWidth, aExpected.thumbnailWidth);</span>
<a href="#l7.777"></a><span id="l7.777" class="difflineplus">+  Assert.equal(aActual.thumbnailHeight, aExpected.thumbnailHeight);</span>
<a href="#l7.778"></a><span id="l7.778" class="difflineplus">+  Assert.equal(aActual.caption, aExpected.caption);</span>
<a href="#l7.779"></a><span id="l7.779" class="difflineplus">+}</span>
<a href="#l7.780"></a><span id="l7.780" class="difflineplus">+</span>
<a href="#l7.781"></a><span id="l7.781" class="difflineplus">+/**</span>
<a href="#l7.782"></a><span id="l7.782" class="difflineplus">+ * Check that the actual compatibility override is the same as the expected</span>
<a href="#l7.783"></a><span id="l7.783" class="difflineplus">+ * compatibility override.</span>
<a href="#l7.784"></a><span id="l7.784" class="difflineplus">+ *</span>
<a href="#l7.785"></a><span id="l7.785" class="difflineplus">+ * @param  aAction</span>
<a href="#l7.786"></a><span id="l7.786" class="difflineplus">+ *         The actual compatibility override to check.</span>
<a href="#l7.787"></a><span id="l7.787" class="difflineplus">+ * @param  aExpected</span>
<a href="#l7.788"></a><span id="l7.788" class="difflineplus">+ *         The expected compatibility override to check against.</span>
<a href="#l7.789"></a><span id="l7.789" class="difflineplus">+ */</span>
<a href="#l7.790"></a><span id="l7.790" class="difflineplus">+function do_check_compatibilityoverride(aActual, aExpected) {</span>
<a href="#l7.791"></a><span id="l7.791" class="difflineplus">+  Assert.equal(aActual.type, aExpected.type);</span>
<a href="#l7.792"></a><span id="l7.792" class="difflineplus">+  Assert.equal(aActual.minVersion, aExpected.minVersion);</span>
<a href="#l7.793"></a><span id="l7.793" class="difflineplus">+  Assert.equal(aActual.maxVersion, aExpected.maxVersion);</span>
<a href="#l7.794"></a><span id="l7.794" class="difflineplus">+  Assert.equal(aActual.appID, aExpected.appID);</span>
<a href="#l7.795"></a><span id="l7.795" class="difflineplus">+  Assert.equal(aActual.appMinVersion, aExpected.appMinVersion);</span>
<a href="#l7.796"></a><span id="l7.796" class="difflineplus">+  Assert.equal(aActual.appMaxVersion, aExpected.appMaxVersion);</span>
<a href="#l7.797"></a><span id="l7.797" class="difflineplus">+}</span>
<a href="#l7.798"></a><span id="l7.798" class="difflineplus">+</span>
<a href="#l7.799"></a><span id="l7.799" class="difflineplus">+function do_check_icons(aActual, aExpected) {</span>
<a href="#l7.800"></a><span id="l7.800" class="difflineplus">+  for (var size in aExpected) {</span>
<a href="#l7.801"></a><span id="l7.801" class="difflineplus">+    Assert.equal(aActual[size], aExpected[size]);</span>
<a href="#l7.802"></a><span id="l7.802" class="difflineplus">+  }</span>
<a href="#l7.803"></a><span id="l7.803" class="difflineplus">+}</span>
<a href="#l7.804"></a><span id="l7.804" class="difflineplus">+</span>
<a href="#l7.805"></a><span id="l7.805" class="difflineplus">+function isThemeInAddonsList(aDir, aId) {</span>
<a href="#l7.806"></a><span id="l7.806" class="difflineplus">+  return AddonTestUtils.addonsList.hasTheme(aDir, aId);</span>
<a href="#l7.807"></a><span id="l7.807" class="difflineplus">+}</span>
<a href="#l7.808"></a><span id="l7.808" class="difflineplus">+</span>
<a href="#l7.809"></a><span id="l7.809" class="difflineplus">+function isExtensionInBootstrappedList(aDir, aId) {</span>
<a href="#l7.810"></a><span id="l7.810" class="difflineplus">+  return AddonTestUtils.addonsList.hasExtension(aDir, aId);</span>
<a href="#l7.811"></a><span id="l7.811" class="difflineplus">+}</span>
<a href="#l7.812"></a><span id="l7.812" class="difflineplus">+</span>
<a href="#l7.813"></a><span id="l7.813" class="difflineplus">+/**</span>
<a href="#l7.814"></a><span id="l7.814" class="difflineplus">+ * Writes an install.rdf manifest into a directory using the properties passed</span>
<a href="#l7.815"></a><span id="l7.815" class="difflineplus">+ * in a JS object. The objects should contain a property for each property to</span>
<a href="#l7.816"></a><span id="l7.816" class="difflineplus">+ * appear in the RDF. The object may contain an array of objects with id,</span>
<a href="#l7.817"></a><span id="l7.817" class="difflineplus">+ * minVersion and maxVersion in the targetApplications property to give target</span>
<a href="#l7.818"></a><span id="l7.818" class="difflineplus">+ * application compatibility.</span>
<a href="#l7.819"></a><span id="l7.819" class="difflineplus">+ *</span>
<a href="#l7.820"></a><span id="l7.820" class="difflineplus">+ * @param   aData</span>
<a href="#l7.821"></a><span id="l7.821" class="difflineplus">+ *          The object holding data about the add-on</span>
<a href="#l7.822"></a><span id="l7.822" class="difflineplus">+ * @param   aDir</span>
<a href="#l7.823"></a><span id="l7.823" class="difflineplus">+ *          The directory to add the install.rdf to</span>
<a href="#l7.824"></a><span id="l7.824" class="difflineplus">+ * @param   aId</span>
<a href="#l7.825"></a><span id="l7.825" class="difflineplus">+ *          An optional string to override the default installation aId</span>
<a href="#l7.826"></a><span id="l7.826" class="difflineplus">+ * @param   aExtraFile</span>
<a href="#l7.827"></a><span id="l7.827" class="difflineplus">+ *          An optional dummy file to create in the directory</span>
<a href="#l7.828"></a><span id="l7.828" class="difflineplus">+ * @return  An nsIFile for the directory in which the add-on is installed.</span>
<a href="#l7.829"></a><span id="l7.829" class="difflineplus">+ */</span>
<a href="#l7.830"></a><span id="l7.830" class="difflineplus">+async function promiseWriteInstallRDFToDir(aData, aDir, aId = aData.id, aExtraFile = null) {</span>
<a href="#l7.831"></a><span id="l7.831" class="difflineplus">+  let files = {</span>
<a href="#l7.832"></a><span id="l7.832" class="difflineplus">+    &quot;install.rdf&quot;: AddonTestUtils.createInstallRDF(aData),</span>
<a href="#l7.833"></a><span id="l7.833" class="difflineplus">+  };</span>
<a href="#l7.834"></a><span id="l7.834" class="difflineplus">+  if (typeof aExtraFile === &quot;object&quot;)</span>
<a href="#l7.835"></a><span id="l7.835" class="difflineplus">+    Object.assign(files, aExtraFile);</span>
<a href="#l7.836"></a><span id="l7.836" class="difflineplus">+  else</span>
<a href="#l7.837"></a><span id="l7.837" class="difflineplus">+    files[aExtraFile] = &quot;&quot;;</span>
<a href="#l7.838"></a><span id="l7.838" class="difflineplus">+</span>
<a href="#l7.839"></a><span id="l7.839" class="difflineplus">+  let dir = aDir.clone();</span>
<a href="#l7.840"></a><span id="l7.840" class="difflineplus">+  dir.append(aId);</span>
<a href="#l7.841"></a><span id="l7.841" class="difflineplus">+</span>
<a href="#l7.842"></a><span id="l7.842" class="difflineplus">+  await AddonTestUtils.promiseWriteFilesToDir(dir.path, files);</span>
<a href="#l7.843"></a><span id="l7.843" class="difflineplus">+  return dir;</span>
<a href="#l7.844"></a><span id="l7.844" class="difflineplus">+}</span>
<a href="#l7.845"></a><span id="l7.845" class="difflineplus">+</span>
<a href="#l7.846"></a><span id="l7.846" class="difflineplus">+/**</span>
<a href="#l7.847"></a><span id="l7.847" class="difflineplus">+ * Writes an install.rdf manifest into a packed extension using the properties passed</span>
<a href="#l7.848"></a><span id="l7.848" class="difflineplus">+ * in a JS object. The objects should contain a property for each property to</span>
<a href="#l7.849"></a><span id="l7.849" class="difflineplus">+ * appear in the RDF. The object may contain an array of objects with id,</span>
<a href="#l7.850"></a><span id="l7.850" class="difflineplus">+ * minVersion and maxVersion in the targetApplications property to give target</span>
<a href="#l7.851"></a><span id="l7.851" class="difflineplus">+ * application compatibility.</span>
<a href="#l7.852"></a><span id="l7.852" class="difflineplus">+ *</span>
<a href="#l7.853"></a><span id="l7.853" class="difflineplus">+ * @param   aData</span>
<a href="#l7.854"></a><span id="l7.854" class="difflineplus">+ *          The object holding data about the add-on</span>
<a href="#l7.855"></a><span id="l7.855" class="difflineplus">+ * @param   aDir</span>
<a href="#l7.856"></a><span id="l7.856" class="difflineplus">+ *          The install directory to add the extension to</span>
<a href="#l7.857"></a><span id="l7.857" class="difflineplus">+ * @param   aId</span>
<a href="#l7.858"></a><span id="l7.858" class="difflineplus">+ *          An optional string to override the default installation aId</span>
<a href="#l7.859"></a><span id="l7.859" class="difflineplus">+ * @param   aExtraFile</span>
<a href="#l7.860"></a><span id="l7.860" class="difflineplus">+ *          An optional dummy file to create in the extension</span>
<a href="#l7.861"></a><span id="l7.861" class="difflineplus">+ * @return  A file pointing to where the extension was installed</span>
<a href="#l7.862"></a><span id="l7.862" class="difflineplus">+ */</span>
<a href="#l7.863"></a><span id="l7.863" class="difflineplus">+async function promiseWriteInstallRDFToXPI(aData, aDir, aId = aData.id, aExtraFile = null) {</span>
<a href="#l7.864"></a><span id="l7.864" class="difflineplus">+  let files = {</span>
<a href="#l7.865"></a><span id="l7.865" class="difflineplus">+    &quot;install.rdf&quot;: AddonTestUtils.createInstallRDF(aData),</span>
<a href="#l7.866"></a><span id="l7.866" class="difflineplus">+  };</span>
<a href="#l7.867"></a><span id="l7.867" class="difflineplus">+  if (typeof aExtraFile === &quot;object&quot;)</span>
<a href="#l7.868"></a><span id="l7.868" class="difflineplus">+    Object.assign(files, aExtraFile);</span>
<a href="#l7.869"></a><span id="l7.869" class="difflineplus">+  else</span>
<a href="#l7.870"></a><span id="l7.870" class="difflineplus">+  if (aExtraFile)</span>
<a href="#l7.871"></a><span id="l7.871" class="difflineplus">+    files[aExtraFile] = &quot;&quot;;</span>
<a href="#l7.872"></a><span id="l7.872" class="difflineplus">+</span>
<a href="#l7.873"></a><span id="l7.873" class="difflineplus">+  if (!aDir.exists())</span>
<a href="#l7.874"></a><span id="l7.874" class="difflineplus">+    aDir.create(Ci.nsIFile.DIRECTORY_TYPE, FileUtils.PERMS_DIRECTORY);</span>
<a href="#l7.875"></a><span id="l7.875" class="difflineplus">+</span>
<a href="#l7.876"></a><span id="l7.876" class="difflineplus">+  var file = aDir.clone();</span>
<a href="#l7.877"></a><span id="l7.877" class="difflineplus">+  file.append(`${aId}.xpi`);</span>
<a href="#l7.878"></a><span id="l7.878" class="difflineplus">+</span>
<a href="#l7.879"></a><span id="l7.879" class="difflineplus">+  AddonTestUtils.writeFilesToZip(file.path, files);</span>
<a href="#l7.880"></a><span id="l7.880" class="difflineplus">+</span>
<a href="#l7.881"></a><span id="l7.881" class="difflineplus">+  return file;</span>
<a href="#l7.882"></a><span id="l7.882" class="difflineplus">+}</span>
<a href="#l7.883"></a><span id="l7.883" class="difflineplus">+</span>
<a href="#l7.884"></a><span id="l7.884" class="difflineplus">+/**</span>
<a href="#l7.885"></a><span id="l7.885" class="difflineplus">+ * Writes an install.rdf manifest into an extension using the properties passed</span>
<a href="#l7.886"></a><span id="l7.886" class="difflineplus">+ * in a JS object. The objects should contain a property for each property to</span>
<a href="#l7.887"></a><span id="l7.887" class="difflineplus">+ * appear in the RDF. The object may contain an array of objects with id,</span>
<a href="#l7.888"></a><span id="l7.888" class="difflineplus">+ * minVersion and maxVersion in the targetApplications property to give target</span>
<a href="#l7.889"></a><span id="l7.889" class="difflineplus">+ * application compatibility.</span>
<a href="#l7.890"></a><span id="l7.890" class="difflineplus">+ *</span>
<a href="#l7.891"></a><span id="l7.891" class="difflineplus">+ * @param   aData</span>
<a href="#l7.892"></a><span id="l7.892" class="difflineplus">+ *          The object holding data about the add-on</span>
<a href="#l7.893"></a><span id="l7.893" class="difflineplus">+ * @param   aDir</span>
<a href="#l7.894"></a><span id="l7.894" class="difflineplus">+ *          The install directory to add the extension to</span>
<a href="#l7.895"></a><span id="l7.895" class="difflineplus">+ * @param   aId</span>
<a href="#l7.896"></a><span id="l7.896" class="difflineplus">+ *          An optional string to override the default installation aId</span>
<a href="#l7.897"></a><span id="l7.897" class="difflineplus">+ * @param   aExtraFile</span>
<a href="#l7.898"></a><span id="l7.898" class="difflineplus">+ *          An optional dummy file to create in the extension</span>
<a href="#l7.899"></a><span id="l7.899" class="difflineplus">+ * @return  A file pointing to where the extension was installed</span>
<a href="#l7.900"></a><span id="l7.900" class="difflineplus">+ */</span>
<a href="#l7.901"></a><span id="l7.901" class="difflineplus">+function promiseWriteInstallRDFForExtension(aData, aDir, aId, aExtraFile) {</span>
<a href="#l7.902"></a><span id="l7.902" class="difflineplus">+  if (TEST_UNPACKED) {</span>
<a href="#l7.903"></a><span id="l7.903" class="difflineplus">+    return promiseWriteInstallRDFToDir(aData, aDir, aId, aExtraFile);</span>
<a href="#l7.904"></a><span id="l7.904" class="difflineplus">+  }</span>
<a href="#l7.905"></a><span id="l7.905" class="difflineplus">+  return promiseWriteInstallRDFToXPI(aData, aDir, aId, aExtraFile);</span>
<a href="#l7.906"></a><span id="l7.906" class="difflineplus">+}</span>
<a href="#l7.907"></a><span id="l7.907" class="difflineplus">+</span>
<a href="#l7.908"></a><span id="l7.908" class="difflineplus">+/**</span>
<a href="#l7.909"></a><span id="l7.909" class="difflineplus">+ * Writes a manifest.json manifest into an extension using the properties passed</span>
<a href="#l7.910"></a><span id="l7.910" class="difflineplus">+ * in a JS object.</span>
<a href="#l7.911"></a><span id="l7.911" class="difflineplus">+ *</span>
<a href="#l7.912"></a><span id="l7.912" class="difflineplus">+ * @param   aManifest</span>
<a href="#l7.913"></a><span id="l7.913" class="difflineplus">+ *          The data to write</span>
<a href="#l7.914"></a><span id="l7.914" class="difflineplus">+ * @param   aDir</span>
<a href="#l7.915"></a><span id="l7.915" class="difflineplus">+ *          The install directory to add the extension to</span>
<a href="#l7.916"></a><span id="l7.916" class="difflineplus">+ * @param   aId</span>
<a href="#l7.917"></a><span id="l7.917" class="difflineplus">+ *          An optional string to override the default installation aId</span>
<a href="#l7.918"></a><span id="l7.918" class="difflineplus">+ * @return  A file pointing to where the extension was installed</span>
<a href="#l7.919"></a><span id="l7.919" class="difflineplus">+ */</span>
<a href="#l7.920"></a><span id="l7.920" class="difflineplus">+function promiseWriteWebManifestForExtension(aData, aDir, aId = aData.applications.gecko.id) {</span>
<a href="#l7.921"></a><span id="l7.921" class="difflineplus">+  let files = {</span>
<a href="#l7.922"></a><span id="l7.922" class="difflineplus">+    &quot;manifest.json&quot;: JSON.stringify(aData),</span>
<a href="#l7.923"></a><span id="l7.923" class="difflineplus">+  };</span>
<a href="#l7.924"></a><span id="l7.924" class="difflineplus">+  return AddonTestUtils.promiseWriteFilesToExtension(aDir.path, aId, files);</span>
<a href="#l7.925"></a><span id="l7.925" class="difflineplus">+}</span>
<a href="#l7.926"></a><span id="l7.926" class="difflineplus">+</span>
<a href="#l7.927"></a><span id="l7.927" class="difflineplus">+/**</span>
<a href="#l7.928"></a><span id="l7.928" class="difflineplus">+ * Creates an XPI file for some manifest data in the temporary directory and</span>
<a href="#l7.929"></a><span id="l7.929" class="difflineplus">+ * returns the nsIFile for it. The file will be deleted when the test completes.</span>
<a href="#l7.930"></a><span id="l7.930" class="difflineplus">+ *</span>
<a href="#l7.931"></a><span id="l7.931" class="difflineplus">+ * @param   aData</span>
<a href="#l7.932"></a><span id="l7.932" class="difflineplus">+ *          The object holding data about the add-on</span>
<a href="#l7.933"></a><span id="l7.933" class="difflineplus">+ * @return  A file pointing to the created XPI file</span>
<a href="#l7.934"></a><span id="l7.934" class="difflineplus">+ */</span>
<a href="#l7.935"></a><span id="l7.935" class="difflineplus">+function createTempXPIFile(aData, aExtraFile) {</span>
<a href="#l7.936"></a><span id="l7.936" class="difflineplus">+  let files = {</span>
<a href="#l7.937"></a><span id="l7.937" class="difflineplus">+    &quot;install.rdf&quot;: aData,</span>
<a href="#l7.938"></a><span id="l7.938" class="difflineplus">+  };</span>
<a href="#l7.939"></a><span id="l7.939" class="difflineplus">+  if (typeof aExtraFile == &quot;object&quot;)</span>
<a href="#l7.940"></a><span id="l7.940" class="difflineplus">+    Object.assign(files, aExtraFile);</span>
<a href="#l7.941"></a><span id="l7.941" class="difflineplus">+  else if (aExtraFile)</span>
<a href="#l7.942"></a><span id="l7.942" class="difflineplus">+    files[aExtraFile] = &quot;&quot;;</span>
<a href="#l7.943"></a><span id="l7.943" class="difflineplus">+</span>
<a href="#l7.944"></a><span id="l7.944" class="difflineplus">+  return AddonTestUtils.createTempXPIFile(files);</span>
<a href="#l7.945"></a><span id="l7.945" class="difflineplus">+}</span>
<a href="#l7.946"></a><span id="l7.946" class="difflineplus">+</span>
<a href="#l7.947"></a><span id="l7.947" class="difflineplus">+function promiseInstallXPI(installRDF) {</span>
<a href="#l7.948"></a><span id="l7.948" class="difflineplus">+  return AddonTestUtils.promiseInstallXPI({&quot;install.rdf&quot;: installRDF});</span>
<a href="#l7.949"></a><span id="l7.949" class="difflineplus">+}</span>
<a href="#l7.950"></a><span id="l7.950" class="difflineplus">+</span>
<a href="#l7.951"></a><span id="l7.951" class="difflineplus">+var gExpectedEvents = {};</span>
<a href="#l7.952"></a><span id="l7.952" class="difflineplus">+var gExpectedInstalls = [];</span>
<a href="#l7.953"></a><span id="l7.953" class="difflineplus">+var gNext = null;</span>
<a href="#l7.954"></a><span id="l7.954" class="difflineplus">+</span>
<a href="#l7.955"></a><span id="l7.955" class="difflineplus">+function getExpectedEvent(aId) {</span>
<a href="#l7.956"></a><span id="l7.956" class="difflineplus">+  if (!(aId in gExpectedEvents))</span>
<a href="#l7.957"></a><span id="l7.957" class="difflineplus">+    do_throw(&quot;Wasn't expecting events for &quot; + aId);</span>
<a href="#l7.958"></a><span id="l7.958" class="difflineplus">+  if (gExpectedEvents[aId].length == 0)</span>
<a href="#l7.959"></a><span id="l7.959" class="difflineplus">+    do_throw(&quot;Too many events for &quot; + aId);</span>
<a href="#l7.960"></a><span id="l7.960" class="difflineplus">+  let event = gExpectedEvents[aId].shift();</span>
<a href="#l7.961"></a><span id="l7.961" class="difflineplus">+  if (event instanceof Array)</span>
<a href="#l7.962"></a><span id="l7.962" class="difflineplus">+    return event;</span>
<a href="#l7.963"></a><span id="l7.963" class="difflineplus">+  return [event, true];</span>
<a href="#l7.964"></a><span id="l7.964" class="difflineplus">+}</span>
<a href="#l7.965"></a><span id="l7.965" class="difflineplus">+</span>
<a href="#l7.966"></a><span id="l7.966" class="difflineplus">+function getExpectedInstall(aAddon) {</span>
<a href="#l7.967"></a><span id="l7.967" class="difflineplus">+  if (gExpectedInstalls instanceof Array)</span>
<a href="#l7.968"></a><span id="l7.968" class="difflineplus">+    return gExpectedInstalls.shift();</span>
<a href="#l7.969"></a><span id="l7.969" class="difflineplus">+  if (!aAddon || !aAddon.id)</span>
<a href="#l7.970"></a><span id="l7.970" class="difflineplus">+    return gExpectedInstalls.NO_ID.shift();</span>
<a href="#l7.971"></a><span id="l7.971" class="difflineplus">+  let id = aAddon.id;</span>
<a href="#l7.972"></a><span id="l7.972" class="difflineplus">+  if (!(id in gExpectedInstalls) || !(gExpectedInstalls[id] instanceof Array))</span>
<a href="#l7.973"></a><span id="l7.973" class="difflineplus">+    do_throw(&quot;Wasn't expecting events for &quot; + id);</span>
<a href="#l7.974"></a><span id="l7.974" class="difflineplus">+  if (gExpectedInstalls[id].length == 0)</span>
<a href="#l7.975"></a><span id="l7.975" class="difflineplus">+    do_throw(&quot;Too many events for &quot; + id);</span>
<a href="#l7.976"></a><span id="l7.976" class="difflineplus">+  return gExpectedInstalls[id].shift();</span>
<a href="#l7.977"></a><span id="l7.977" class="difflineplus">+}</span>
<a href="#l7.978"></a><span id="l7.978" class="difflineplus">+</span>
<a href="#l7.979"></a><span id="l7.979" class="difflineplus">+const AddonListener = {</span>
<a href="#l7.980"></a><span id="l7.980" class="difflineplus">+  onPropertyChanged(aAddon, aProperties) {</span>
<a href="#l7.981"></a><span id="l7.981" class="difflineplus">+    info(`Got onPropertyChanged event for ${aAddon.id}`);</span>
<a href="#l7.982"></a><span id="l7.982" class="difflineplus">+    let [event, properties] = getExpectedEvent(aAddon.id);</span>
<a href="#l7.983"></a><span id="l7.983" class="difflineplus">+    Assert.equal(&quot;onPropertyChanged&quot;, event);</span>
<a href="#l7.984"></a><span id="l7.984" class="difflineplus">+    Assert.equal(aProperties.length, properties.length);</span>
<a href="#l7.985"></a><span id="l7.985" class="difflineplus">+    properties.forEach(function(aProperty) {</span>
<a href="#l7.986"></a><span id="l7.986" class="difflineplus">+      // Only test that the expected properties are listed, having additional</span>
<a href="#l7.987"></a><span id="l7.987" class="difflineplus">+      // properties listed is not necessary a problem</span>
<a href="#l7.988"></a><span id="l7.988" class="difflineplus">+      if (!aProperties.includes(aProperty))</span>
<a href="#l7.989"></a><span id="l7.989" class="difflineplus">+        do_throw(&quot;Did not see property change for &quot; + aProperty);</span>
<a href="#l7.990"></a><span id="l7.990" class="difflineplus">+    });</span>
<a href="#l7.991"></a><span id="l7.991" class="difflineplus">+    return check_test_completed(arguments);</span>
<a href="#l7.992"></a><span id="l7.992" class="difflineplus">+  },</span>
<a href="#l7.993"></a><span id="l7.993" class="difflineplus">+</span>
<a href="#l7.994"></a><span id="l7.994" class="difflineplus">+  onEnabling(aAddon, aRequiresRestart) {</span>
<a href="#l7.995"></a><span id="l7.995" class="difflineplus">+    info(`Got onEnabling event for ${aAddon.id}`);</span>
<a href="#l7.996"></a><span id="l7.996" class="difflineplus">+    let [event, expectedRestart] = getExpectedEvent(aAddon.id);</span>
<a href="#l7.997"></a><span id="l7.997" class="difflineplus">+    Assert.equal(&quot;onEnabling&quot;, event);</span>
<a href="#l7.998"></a><span id="l7.998" class="difflineplus">+    Assert.equal(aRequiresRestart, expectedRestart);</span>
<a href="#l7.999"></a><span id="l7.999" class="difflineplus">+    if (expectedRestart)</span>
<a href="#l7.1000"></a><span id="l7.1000" class="difflineplus">+      Assert.ok(hasFlag(aAddon.pendingOperations, AddonManager.PENDING_ENABLE));</span>
<a href="#l7.1001"></a><span id="l7.1001" class="difflineplus">+    Assert.ok(!hasFlag(aAddon.permissions, AddonManager.PERM_CAN_ENABLE));</span>
<a href="#l7.1002"></a><span id="l7.1002" class="difflineplus">+    return check_test_completed(arguments);</span>
<a href="#l7.1003"></a><span id="l7.1003" class="difflineplus">+  },</span>
<a href="#l7.1004"></a><span id="l7.1004" class="difflineplus">+</span>
<a href="#l7.1005"></a><span id="l7.1005" class="difflineplus">+  onEnabled(aAddon) {</span>
<a href="#l7.1006"></a><span id="l7.1006" class="difflineplus">+    info(`Got onEnabled event for ${aAddon.id}`);</span>
<a href="#l7.1007"></a><span id="l7.1007" class="difflineplus">+    let [event] = getExpectedEvent(aAddon.id);</span>
<a href="#l7.1008"></a><span id="l7.1008" class="difflineplus">+    Assert.equal(&quot;onEnabled&quot;, event);</span>
<a href="#l7.1009"></a><span id="l7.1009" class="difflineplus">+    Assert.ok(!hasFlag(aAddon.permissions, AddonManager.PERM_CAN_ENABLE));</span>
<a href="#l7.1010"></a><span id="l7.1010" class="difflineplus">+    return check_test_completed(arguments);</span>
<a href="#l7.1011"></a><span id="l7.1011" class="difflineplus">+  },</span>
<a href="#l7.1012"></a><span id="l7.1012" class="difflineplus">+</span>
<a href="#l7.1013"></a><span id="l7.1013" class="difflineplus">+  onDisabling(aAddon, aRequiresRestart) {</span>
<a href="#l7.1014"></a><span id="l7.1014" class="difflineplus">+    info(`Got onDisabling event for ${aAddon.id}`);</span>
<a href="#l7.1015"></a><span id="l7.1015" class="difflineplus">+    let [event, expectedRestart] = getExpectedEvent(aAddon.id);</span>
<a href="#l7.1016"></a><span id="l7.1016" class="difflineplus">+    Assert.equal(&quot;onDisabling&quot;, event);</span>
<a href="#l7.1017"></a><span id="l7.1017" class="difflineplus">+    Assert.equal(aRequiresRestart, expectedRestart);</span>
<a href="#l7.1018"></a><span id="l7.1018" class="difflineplus">+    if (expectedRestart)</span>
<a href="#l7.1019"></a><span id="l7.1019" class="difflineplus">+      Assert.ok(hasFlag(aAddon.pendingOperations, AddonManager.PENDING_DISABLE));</span>
<a href="#l7.1020"></a><span id="l7.1020" class="difflineplus">+    Assert.ok(!hasFlag(aAddon.permissions, AddonManager.PERM_CAN_DISABLE));</span>
<a href="#l7.1021"></a><span id="l7.1021" class="difflineplus">+    return check_test_completed(arguments);</span>
<a href="#l7.1022"></a><span id="l7.1022" class="difflineplus">+  },</span>
<a href="#l7.1023"></a><span id="l7.1023" class="difflineplus">+</span>
<a href="#l7.1024"></a><span id="l7.1024" class="difflineplus">+  onDisabled(aAddon) {</span>
<a href="#l7.1025"></a><span id="l7.1025" class="difflineplus">+    info(`Got onDisabled event for ${aAddon.id}`);</span>
<a href="#l7.1026"></a><span id="l7.1026" class="difflineplus">+    let [event] = getExpectedEvent(aAddon.id);</span>
<a href="#l7.1027"></a><span id="l7.1027" class="difflineplus">+    Assert.equal(&quot;onDisabled&quot;, event);</span>
<a href="#l7.1028"></a><span id="l7.1028" class="difflineplus">+    Assert.ok(!hasFlag(aAddon.permissions, AddonManager.PERM_CAN_DISABLE));</span>
<a href="#l7.1029"></a><span id="l7.1029" class="difflineplus">+    return check_test_completed(arguments);</span>
<a href="#l7.1030"></a><span id="l7.1030" class="difflineplus">+  },</span>
<a href="#l7.1031"></a><span id="l7.1031" class="difflineplus">+</span>
<a href="#l7.1032"></a><span id="l7.1032" class="difflineplus">+  onInstalling(aAddon, aRequiresRestart) {</span>
<a href="#l7.1033"></a><span id="l7.1033" class="difflineplus">+    info(`Got onInstalling event for ${aAddon.id}`);</span>
<a href="#l7.1034"></a><span id="l7.1034" class="difflineplus">+    let [event, expectedRestart] = getExpectedEvent(aAddon.id);</span>
<a href="#l7.1035"></a><span id="l7.1035" class="difflineplus">+    Assert.equal(&quot;onInstalling&quot;, event);</span>
<a href="#l7.1036"></a><span id="l7.1036" class="difflineplus">+    Assert.equal(aRequiresRestart, expectedRestart);</span>
<a href="#l7.1037"></a><span id="l7.1037" class="difflineplus">+    if (expectedRestart)</span>
<a href="#l7.1038"></a><span id="l7.1038" class="difflineplus">+      Assert.ok(hasFlag(aAddon.pendingOperations, AddonManager.PENDING_INSTALL));</span>
<a href="#l7.1039"></a><span id="l7.1039" class="difflineplus">+    return check_test_completed(arguments);</span>
<a href="#l7.1040"></a><span id="l7.1040" class="difflineplus">+  },</span>
<a href="#l7.1041"></a><span id="l7.1041" class="difflineplus">+</span>
<a href="#l7.1042"></a><span id="l7.1042" class="difflineplus">+  onInstalled(aAddon) {</span>
<a href="#l7.1043"></a><span id="l7.1043" class="difflineplus">+    info(`Got onInstalled event for ${aAddon.id}`);</span>
<a href="#l7.1044"></a><span id="l7.1044" class="difflineplus">+    let [event] = getExpectedEvent(aAddon.id);</span>
<a href="#l7.1045"></a><span id="l7.1045" class="difflineplus">+    Assert.equal(&quot;onInstalled&quot;, event);</span>
<a href="#l7.1046"></a><span id="l7.1046" class="difflineplus">+    return check_test_completed(arguments);</span>
<a href="#l7.1047"></a><span id="l7.1047" class="difflineplus">+  },</span>
<a href="#l7.1048"></a><span id="l7.1048" class="difflineplus">+</span>
<a href="#l7.1049"></a><span id="l7.1049" class="difflineplus">+  onUninstalling(aAddon, aRequiresRestart) {</span>
<a href="#l7.1050"></a><span id="l7.1050" class="difflineplus">+    info(`Got onUninstalling event for ${aAddon.id}`);</span>
<a href="#l7.1051"></a><span id="l7.1051" class="difflineplus">+    let [event, expectedRestart] = getExpectedEvent(aAddon.id);</span>
<a href="#l7.1052"></a><span id="l7.1052" class="difflineplus">+    Assert.equal(&quot;onUninstalling&quot;, event);</span>
<a href="#l7.1053"></a><span id="l7.1053" class="difflineplus">+    Assert.equal(aRequiresRestart, expectedRestart);</span>
<a href="#l7.1054"></a><span id="l7.1054" class="difflineplus">+    if (expectedRestart)</span>
<a href="#l7.1055"></a><span id="l7.1055" class="difflineplus">+      Assert.ok(hasFlag(aAddon.pendingOperations, AddonManager.PENDING_UNINSTALL));</span>
<a href="#l7.1056"></a><span id="l7.1056" class="difflineplus">+    return check_test_completed(arguments);</span>
<a href="#l7.1057"></a><span id="l7.1057" class="difflineplus">+  },</span>
<a href="#l7.1058"></a><span id="l7.1058" class="difflineplus">+</span>
<a href="#l7.1059"></a><span id="l7.1059" class="difflineplus">+  onUninstalled(aAddon) {</span>
<a href="#l7.1060"></a><span id="l7.1060" class="difflineplus">+    info(`Got onUninstalled event for ${aAddon.id}`);</span>
<a href="#l7.1061"></a><span id="l7.1061" class="difflineplus">+    let [event] = getExpectedEvent(aAddon.id);</span>
<a href="#l7.1062"></a><span id="l7.1062" class="difflineplus">+    Assert.equal(&quot;onUninstalled&quot;, event);</span>
<a href="#l7.1063"></a><span id="l7.1063" class="difflineplus">+    return check_test_completed(arguments);</span>
<a href="#l7.1064"></a><span id="l7.1064" class="difflineplus">+  },</span>
<a href="#l7.1065"></a><span id="l7.1065" class="difflineplus">+</span>
<a href="#l7.1066"></a><span id="l7.1066" class="difflineplus">+  onOperationCancelled(aAddon) {</span>
<a href="#l7.1067"></a><span id="l7.1067" class="difflineplus">+    info(`Got onOperationCancelled event for ${aAddon.id}`);</span>
<a href="#l7.1068"></a><span id="l7.1068" class="difflineplus">+    let [event] = getExpectedEvent(aAddon.id);</span>
<a href="#l7.1069"></a><span id="l7.1069" class="difflineplus">+    Assert.equal(&quot;onOperationCancelled&quot;, event);</span>
<a href="#l7.1070"></a><span id="l7.1070" class="difflineplus">+    return check_test_completed(arguments);</span>
<a href="#l7.1071"></a><span id="l7.1071" class="difflineplus">+  },</span>
<a href="#l7.1072"></a><span id="l7.1072" class="difflineplus">+};</span>
<a href="#l7.1073"></a><span id="l7.1073" class="difflineplus">+</span>
<a href="#l7.1074"></a><span id="l7.1074" class="difflineplus">+const InstallListener = {</span>
<a href="#l7.1075"></a><span id="l7.1075" class="difflineplus">+  onNewInstall(install) {</span>
<a href="#l7.1076"></a><span id="l7.1076" class="difflineplus">+    if (install.state != AddonManager.STATE_DOWNLOADED &amp;&amp;</span>
<a href="#l7.1077"></a><span id="l7.1077" class="difflineplus">+        install.state != AddonManager.STATE_DOWNLOAD_FAILED &amp;&amp;</span>
<a href="#l7.1078"></a><span id="l7.1078" class="difflineplus">+        install.state != AddonManager.STATE_AVAILABLE)</span>
<a href="#l7.1079"></a><span id="l7.1079" class="difflineplus">+      do_throw(&quot;Bad install state &quot; + install.state);</span>
<a href="#l7.1080"></a><span id="l7.1080" class="difflineplus">+    if (install.state != AddonManager.STATE_DOWNLOAD_FAILED)</span>
<a href="#l7.1081"></a><span id="l7.1081" class="difflineplus">+      Assert.equal(install.error, 0);</span>
<a href="#l7.1082"></a><span id="l7.1082" class="difflineplus">+    else</span>
<a href="#l7.1083"></a><span id="l7.1083" class="difflineplus">+      Assert.notEqual(install.error, 0);</span>
<a href="#l7.1084"></a><span id="l7.1084" class="difflineplus">+    Assert.equal(&quot;onNewInstall&quot;, getExpectedInstall());</span>
<a href="#l7.1085"></a><span id="l7.1085" class="difflineplus">+    return check_test_completed(arguments);</span>
<a href="#l7.1086"></a><span id="l7.1086" class="difflineplus">+  },</span>
<a href="#l7.1087"></a><span id="l7.1087" class="difflineplus">+</span>
<a href="#l7.1088"></a><span id="l7.1088" class="difflineplus">+  onDownloadStarted(install) {</span>
<a href="#l7.1089"></a><span id="l7.1089" class="difflineplus">+    Assert.equal(install.state, AddonManager.STATE_DOWNLOADING);</span>
<a href="#l7.1090"></a><span id="l7.1090" class="difflineplus">+    Assert.equal(install.error, 0);</span>
<a href="#l7.1091"></a><span id="l7.1091" class="difflineplus">+    Assert.equal(&quot;onDownloadStarted&quot;, getExpectedInstall());</span>
<a href="#l7.1092"></a><span id="l7.1092" class="difflineplus">+    return check_test_completed(arguments);</span>
<a href="#l7.1093"></a><span id="l7.1093" class="difflineplus">+  },</span>
<a href="#l7.1094"></a><span id="l7.1094" class="difflineplus">+</span>
<a href="#l7.1095"></a><span id="l7.1095" class="difflineplus">+  onDownloadEnded(install) {</span>
<a href="#l7.1096"></a><span id="l7.1096" class="difflineplus">+    Assert.equal(install.state, AddonManager.STATE_DOWNLOADED);</span>
<a href="#l7.1097"></a><span id="l7.1097" class="difflineplus">+    Assert.equal(install.error, 0);</span>
<a href="#l7.1098"></a><span id="l7.1098" class="difflineplus">+    Assert.equal(&quot;onDownloadEnded&quot;, getExpectedInstall());</span>
<a href="#l7.1099"></a><span id="l7.1099" class="difflineplus">+    return check_test_completed(arguments);</span>
<a href="#l7.1100"></a><span id="l7.1100" class="difflineplus">+  },</span>
<a href="#l7.1101"></a><span id="l7.1101" class="difflineplus">+</span>
<a href="#l7.1102"></a><span id="l7.1102" class="difflineplus">+  onDownloadFailed(install) {</span>
<a href="#l7.1103"></a><span id="l7.1103" class="difflineplus">+    Assert.equal(install.state, AddonManager.STATE_DOWNLOAD_FAILED);</span>
<a href="#l7.1104"></a><span id="l7.1104" class="difflineplus">+    Assert.equal(&quot;onDownloadFailed&quot;, getExpectedInstall());</span>
<a href="#l7.1105"></a><span id="l7.1105" class="difflineplus">+    return check_test_completed(arguments);</span>
<a href="#l7.1106"></a><span id="l7.1106" class="difflineplus">+  },</span>
<a href="#l7.1107"></a><span id="l7.1107" class="difflineplus">+</span>
<a href="#l7.1108"></a><span id="l7.1108" class="difflineplus">+  onDownloadCancelled(install) {</span>
<a href="#l7.1109"></a><span id="l7.1109" class="difflineplus">+    Assert.equal(install.state, AddonManager.STATE_CANCELLED);</span>
<a href="#l7.1110"></a><span id="l7.1110" class="difflineplus">+    Assert.equal(install.error, 0);</span>
<a href="#l7.1111"></a><span id="l7.1111" class="difflineplus">+    Assert.equal(&quot;onDownloadCancelled&quot;, getExpectedInstall());</span>
<a href="#l7.1112"></a><span id="l7.1112" class="difflineplus">+    return check_test_completed(arguments);</span>
<a href="#l7.1113"></a><span id="l7.1113" class="difflineplus">+  },</span>
<a href="#l7.1114"></a><span id="l7.1114" class="difflineplus">+</span>
<a href="#l7.1115"></a><span id="l7.1115" class="difflineplus">+  onInstallStarted(install) {</span>
<a href="#l7.1116"></a><span id="l7.1116" class="difflineplus">+    Assert.equal(install.state, AddonManager.STATE_INSTALLING);</span>
<a href="#l7.1117"></a><span id="l7.1117" class="difflineplus">+    Assert.equal(install.error, 0);</span>
<a href="#l7.1118"></a><span id="l7.1118" class="difflineplus">+    Assert.equal(&quot;onInstallStarted&quot;, getExpectedInstall(install.addon));</span>
<a href="#l7.1119"></a><span id="l7.1119" class="difflineplus">+    return check_test_completed(arguments);</span>
<a href="#l7.1120"></a><span id="l7.1120" class="difflineplus">+  },</span>
<a href="#l7.1121"></a><span id="l7.1121" class="difflineplus">+</span>
<a href="#l7.1122"></a><span id="l7.1122" class="difflineplus">+  onInstallEnded(install, newAddon) {</span>
<a href="#l7.1123"></a><span id="l7.1123" class="difflineplus">+    Assert.equal(install.state, AddonManager.STATE_INSTALLED);</span>
<a href="#l7.1124"></a><span id="l7.1124" class="difflineplus">+    Assert.equal(install.error, 0);</span>
<a href="#l7.1125"></a><span id="l7.1125" class="difflineplus">+    Assert.equal(&quot;onInstallEnded&quot;, getExpectedInstall(install.addon));</span>
<a href="#l7.1126"></a><span id="l7.1126" class="difflineplus">+    return check_test_completed(arguments);</span>
<a href="#l7.1127"></a><span id="l7.1127" class="difflineplus">+  },</span>
<a href="#l7.1128"></a><span id="l7.1128" class="difflineplus">+</span>
<a href="#l7.1129"></a><span id="l7.1129" class="difflineplus">+  onInstallFailed(install) {</span>
<a href="#l7.1130"></a><span id="l7.1130" class="difflineplus">+    Assert.equal(install.state, AddonManager.STATE_INSTALL_FAILED);</span>
<a href="#l7.1131"></a><span id="l7.1131" class="difflineplus">+    Assert.equal(&quot;onInstallFailed&quot;, getExpectedInstall(install.addon));</span>
<a href="#l7.1132"></a><span id="l7.1132" class="difflineplus">+    return check_test_completed(arguments);</span>
<a href="#l7.1133"></a><span id="l7.1133" class="difflineplus">+  },</span>
<a href="#l7.1134"></a><span id="l7.1134" class="difflineplus">+</span>
<a href="#l7.1135"></a><span id="l7.1135" class="difflineplus">+  onInstallCancelled(install) {</span>
<a href="#l7.1136"></a><span id="l7.1136" class="difflineplus">+    // If the install was cancelled by a listener returning false from</span>
<a href="#l7.1137"></a><span id="l7.1137" class="difflineplus">+    // onInstallStarted, then the state will revert to STATE_DOWNLOADED.</span>
<a href="#l7.1138"></a><span id="l7.1138" class="difflineplus">+    let possibleStates = [AddonManager.STATE_CANCELLED,</span>
<a href="#l7.1139"></a><span id="l7.1139" class="difflineplus">+                          AddonManager.STATE_DOWNLOADED];</span>
<a href="#l7.1140"></a><span id="l7.1140" class="difflineplus">+    Assert.ok(possibleStates.includes(install.state));</span>
<a href="#l7.1141"></a><span id="l7.1141" class="difflineplus">+    Assert.equal(install.error, 0);</span>
<a href="#l7.1142"></a><span id="l7.1142" class="difflineplus">+    Assert.equal(&quot;onInstallCancelled&quot;, getExpectedInstall(install.addon));</span>
<a href="#l7.1143"></a><span id="l7.1143" class="difflineplus">+    return check_test_completed(arguments);</span>
<a href="#l7.1144"></a><span id="l7.1144" class="difflineplus">+  },</span>
<a href="#l7.1145"></a><span id="l7.1145" class="difflineplus">+</span>
<a href="#l7.1146"></a><span id="l7.1146" class="difflineplus">+  onExternalInstall(aAddon, existingAddon, aRequiresRestart) {</span>
<a href="#l7.1147"></a><span id="l7.1147" class="difflineplus">+    Assert.equal(&quot;onExternalInstall&quot;, getExpectedInstall(aAddon));</span>
<a href="#l7.1148"></a><span id="l7.1148" class="difflineplus">+    Assert.ok(!aRequiresRestart);</span>
<a href="#l7.1149"></a><span id="l7.1149" class="difflineplus">+    return check_test_completed(arguments);</span>
<a href="#l7.1150"></a><span id="l7.1150" class="difflineplus">+  },</span>
<a href="#l7.1151"></a><span id="l7.1151" class="difflineplus">+};</span>
<a href="#l7.1152"></a><span id="l7.1152" class="difflineplus">+</span>
<a href="#l7.1153"></a><span id="l7.1153" class="difflineplus">+function hasFlag(aBits, aFlag) {</span>
<a href="#l7.1154"></a><span id="l7.1154" class="difflineplus">+  return (aBits &amp; aFlag) != 0;</span>
<a href="#l7.1155"></a><span id="l7.1155" class="difflineplus">+}</span>
<a href="#l7.1156"></a><span id="l7.1156" class="difflineplus">+</span>
<a href="#l7.1157"></a><span id="l7.1157" class="difflineplus">+// Just a wrapper around setting the expected events.</span>
<a href="#l7.1158"></a><span id="l7.1158" class="difflineplus">+function prepare_test(aExpectedEvents, aExpectedInstalls, aNext) {</span>
<a href="#l7.1159"></a><span id="l7.1159" class="difflineplus">+  AddonManager.addAddonListener(AddonListener);</span>
<a href="#l7.1160"></a><span id="l7.1160" class="difflineplus">+  AddonManager.addInstallListener(InstallListener);</span>
<a href="#l7.1161"></a><span id="l7.1161" class="difflineplus">+</span>
<a href="#l7.1162"></a><span id="l7.1162" class="difflineplus">+  gExpectedInstalls = aExpectedInstalls;</span>
<a href="#l7.1163"></a><span id="l7.1163" class="difflineplus">+  gExpectedEvents = aExpectedEvents;</span>
<a href="#l7.1164"></a><span id="l7.1164" class="difflineplus">+  gNext = aNext;</span>
<a href="#l7.1165"></a><span id="l7.1165" class="difflineplus">+}</span>
<a href="#l7.1166"></a><span id="l7.1166" class="difflineplus">+</span>
<a href="#l7.1167"></a><span id="l7.1167" class="difflineplus">+function clearListeners() {</span>
<a href="#l7.1168"></a><span id="l7.1168" class="difflineplus">+  AddonManager.removeAddonListener(AddonListener);</span>
<a href="#l7.1169"></a><span id="l7.1169" class="difflineplus">+  AddonManager.removeInstallListener(InstallListener);</span>
<a href="#l7.1170"></a><span id="l7.1170" class="difflineplus">+}</span>
<a href="#l7.1171"></a><span id="l7.1171" class="difflineplus">+</span>
<a href="#l7.1172"></a><span id="l7.1172" class="difflineplus">+function end_test() {</span>
<a href="#l7.1173"></a><span id="l7.1173" class="difflineplus">+  clearListeners();</span>
<a href="#l7.1174"></a><span id="l7.1174" class="difflineplus">+}</span>
<a href="#l7.1175"></a><span id="l7.1175" class="difflineplus">+</span>
<a href="#l7.1176"></a><span id="l7.1176" class="difflineplus">+// Checks if all expected events have been seen and if so calls the callback.</span>
<a href="#l7.1177"></a><span id="l7.1177" class="difflineplus">+function check_test_completed(aArgs) {</span>
<a href="#l7.1178"></a><span id="l7.1178" class="difflineplus">+  if (!gNext)</span>
<a href="#l7.1179"></a><span id="l7.1179" class="difflineplus">+    return undefined;</span>
<a href="#l7.1180"></a><span id="l7.1180" class="difflineplus">+</span>
<a href="#l7.1181"></a><span id="l7.1181" class="difflineplus">+  if (gExpectedInstalls instanceof Array &amp;&amp;</span>
<a href="#l7.1182"></a><span id="l7.1182" class="difflineplus">+      gExpectedInstalls.length &gt; 0)</span>
<a href="#l7.1183"></a><span id="l7.1183" class="difflineplus">+    return undefined;</span>
<a href="#l7.1184"></a><span id="l7.1184" class="difflineplus">+</span>
<a href="#l7.1185"></a><span id="l7.1185" class="difflineplus">+  for (let id in gExpectedInstalls) {</span>
<a href="#l7.1186"></a><span id="l7.1186" class="difflineplus">+    let installList = gExpectedInstalls[id];</span>
<a href="#l7.1187"></a><span id="l7.1187" class="difflineplus">+    if (installList.length &gt; 0)</span>
<a href="#l7.1188"></a><span id="l7.1188" class="difflineplus">+      return undefined;</span>
<a href="#l7.1189"></a><span id="l7.1189" class="difflineplus">+  }</span>
<a href="#l7.1190"></a><span id="l7.1190" class="difflineplus">+</span>
<a href="#l7.1191"></a><span id="l7.1191" class="difflineplus">+  for (let id in gExpectedEvents) {</span>
<a href="#l7.1192"></a><span id="l7.1192" class="difflineplus">+    if (gExpectedEvents[id].length &gt; 0)</span>
<a href="#l7.1193"></a><span id="l7.1193" class="difflineplus">+      return undefined;</span>
<a href="#l7.1194"></a><span id="l7.1194" class="difflineplus">+  }</span>
<a href="#l7.1195"></a><span id="l7.1195" class="difflineplus">+</span>
<a href="#l7.1196"></a><span id="l7.1196" class="difflineplus">+  return gNext.apply(null, aArgs);</span>
<a href="#l7.1197"></a><span id="l7.1197" class="difflineplus">+}</span>
<a href="#l7.1198"></a><span id="l7.1198" class="difflineplus">+</span>
<a href="#l7.1199"></a><span id="l7.1199" class="difflineplus">+// Verifies that all the expected events for all add-ons were seen.</span>
<a href="#l7.1200"></a><span id="l7.1200" class="difflineplus">+function ensure_test_completed() {</span>
<a href="#l7.1201"></a><span id="l7.1201" class="difflineplus">+  for (let i in gExpectedEvents) {</span>
<a href="#l7.1202"></a><span id="l7.1202" class="difflineplus">+    if (gExpectedEvents[i].length &gt; 0)</span>
<a href="#l7.1203"></a><span id="l7.1203" class="difflineplus">+      do_throw(`Didn't see all the expected events for ${i}: Still expecting ${gExpectedEvents[i]}`);</span>
<a href="#l7.1204"></a><span id="l7.1204" class="difflineplus">+  }</span>
<a href="#l7.1205"></a><span id="l7.1205" class="difflineplus">+  gExpectedEvents = {};</span>
<a href="#l7.1206"></a><span id="l7.1206" class="difflineplus">+  if (gExpectedInstalls)</span>
<a href="#l7.1207"></a><span id="l7.1207" class="difflineplus">+    Assert.equal(gExpectedInstalls.length, 0);</span>
<a href="#l7.1208"></a><span id="l7.1208" class="difflineplus">+}</span>
<a href="#l7.1209"></a><span id="l7.1209" class="difflineplus">+</span>
<a href="#l7.1210"></a><span id="l7.1210" class="difflineplus">+/**</span>
<a href="#l7.1211"></a><span id="l7.1211" class="difflineplus">+ * A helper method to install an array of AddonInstall to completion and then</span>
<a href="#l7.1212"></a><span id="l7.1212" class="difflineplus">+ * call a provided callback.</span>
<a href="#l7.1213"></a><span id="l7.1213" class="difflineplus">+ *</span>
<a href="#l7.1214"></a><span id="l7.1214" class="difflineplus">+ * @param   aInstalls</span>
<a href="#l7.1215"></a><span id="l7.1215" class="difflineplus">+ *          The array of AddonInstalls to install</span>
<a href="#l7.1216"></a><span id="l7.1216" class="difflineplus">+ * @param   aCallback</span>
<a href="#l7.1217"></a><span id="l7.1217" class="difflineplus">+ *          The callback to call when all installs have finished</span>
<a href="#l7.1218"></a><span id="l7.1218" class="difflineplus">+ */</span>
<a href="#l7.1219"></a><span id="l7.1219" class="difflineplus">+function completeAllInstalls(aInstalls, aCallback) {</span>
<a href="#l7.1220"></a><span id="l7.1220" class="difflineplus">+  promiseCompleteAllInstalls(aInstalls).then(aCallback);</span>
<a href="#l7.1221"></a><span id="l7.1221" class="difflineplus">+}</span>
<a href="#l7.1222"></a><span id="l7.1222" class="difflineplus">+</span>
<a href="#l7.1223"></a><span id="l7.1223" class="difflineplus">+/**</span>
<a href="#l7.1224"></a><span id="l7.1224" class="difflineplus">+ * A helper method to install an array of files and call a callback after the</span>
<a href="#l7.1225"></a><span id="l7.1225" class="difflineplus">+ * installs are completed.</span>
<a href="#l7.1226"></a><span id="l7.1226" class="difflineplus">+ *</span>
<a href="#l7.1227"></a><span id="l7.1227" class="difflineplus">+ * @param   aFiles</span>
<a href="#l7.1228"></a><span id="l7.1228" class="difflineplus">+ *          The array of files to install</span>
<a href="#l7.1229"></a><span id="l7.1229" class="difflineplus">+ * @param   aCallback</span>
<a href="#l7.1230"></a><span id="l7.1230" class="difflineplus">+ *          The callback to call when all installs have finished</span>
<a href="#l7.1231"></a><span id="l7.1231" class="difflineplus">+ * @param   aIgnoreIncompatible</span>
<a href="#l7.1232"></a><span id="l7.1232" class="difflineplus">+ *          Optional parameter to ignore add-ons that are incompatible in</span>
<a href="#l7.1233"></a><span id="l7.1233" class="difflineplus">+ *          aome way with the application</span>
<a href="#l7.1234"></a><span id="l7.1234" class="difflineplus">+ */</span>
<a href="#l7.1235"></a><span id="l7.1235" class="difflineplus">+function installAllFiles(aFiles, aCallback, aIgnoreIncompatible) {</span>
<a href="#l7.1236"></a><span id="l7.1236" class="difflineplus">+  promiseInstallAllFiles(aFiles, aIgnoreIncompatible).then(aCallback);</span>
<a href="#l7.1237"></a><span id="l7.1237" class="difflineplus">+}</span>
<a href="#l7.1238"></a><span id="l7.1238" class="difflineplus">+</span>
<a href="#l7.1239"></a><span id="l7.1239" class="difflineplus">+const EXTENSIONS_DB = &quot;extensions.json&quot;;</span>
<a href="#l7.1240"></a><span id="l7.1240" class="difflineplus">+var gExtensionsJSON = gProfD.clone();</span>
<a href="#l7.1241"></a><span id="l7.1241" class="difflineplus">+gExtensionsJSON.append(EXTENSIONS_DB);</span>
<a href="#l7.1242"></a><span id="l7.1242" class="difflineplus">+</span>
<a href="#l7.1243"></a><span id="l7.1243" class="difflineplus">+async function promiseInstallWebExtension(aData) {</span>
<a href="#l7.1244"></a><span id="l7.1244" class="difflineplus">+  let addonFile = createTempWebExtensionFile(aData);</span>
<a href="#l7.1245"></a><span id="l7.1245" class="difflineplus">+</span>
<a href="#l7.1246"></a><span id="l7.1246" class="difflineplus">+  let {addon} = await promiseInstallFile(addonFile);</span>
<a href="#l7.1247"></a><span id="l7.1247" class="difflineplus">+  return addon;</span>
<a href="#l7.1248"></a><span id="l7.1248" class="difflineplus">+}</span>
<a href="#l7.1249"></a><span id="l7.1249" class="difflineplus">+</span>
<a href="#l7.1250"></a><span id="l7.1250" class="difflineplus">+// By default use strict compatibility.</span>
<a href="#l7.1251"></a><span id="l7.1251" class="difflineplus">+Services.prefs.setBoolPref(&quot;extensions.strictCompatibility&quot;, true);</span>
<a href="#l7.1252"></a><span id="l7.1252" class="difflineplus">+</span>
<a href="#l7.1253"></a><span id="l7.1253" class="difflineplus">+// Ensure signature checks are enabled by default.</span>
<a href="#l7.1254"></a><span id="l7.1254" class="difflineplus">+Services.prefs.setBoolPref(PREF_XPI_SIGNATURES_REQUIRED, false);</span>
<a href="#l7.1255"></a><span id="l7.1255" class="difflineplus">+</span>
<a href="#l7.1256"></a><span id="l7.1256" class="difflineplus">+Services.prefs.setBoolPref(&quot;extensions.legacy.enabled&quot;, true);</span>
<a href="#l7.1257"></a><span id="l7.1257" class="difflineplus">+</span>
<a href="#l7.1258"></a><span id="l7.1258" class="difflineplus">+// Copies blocklistFile (an nsIFile) to gProfD/blocklist.xml.</span>
<a href="#l7.1259"></a><span id="l7.1259" class="difflineplus">+function copyBlocklistToProfile(blocklistFile) {</span>
<a href="#l7.1260"></a><span id="l7.1260" class="difflineplus">+  var dest = gProfD.clone();</span>
<a href="#l7.1261"></a><span id="l7.1261" class="difflineplus">+  dest.append(&quot;blocklist.xml&quot;);</span>
<a href="#l7.1262"></a><span id="l7.1262" class="difflineplus">+  if (dest.exists())</span>
<a href="#l7.1263"></a><span id="l7.1263" class="difflineplus">+    dest.remove(false);</span>
<a href="#l7.1264"></a><span id="l7.1264" class="difflineplus">+  blocklistFile.copyTo(gProfD, &quot;blocklist.xml&quot;);</span>
<a href="#l7.1265"></a><span id="l7.1265" class="difflineplus">+  dest.lastModifiedTime = Date.now();</span>
<a href="#l7.1266"></a><span id="l7.1266" class="difflineplus">+}</span>
<a href="#l7.1267"></a><span id="l7.1267" class="difflineplus">+</span>
<a href="#l7.1268"></a><span id="l7.1268" class="difflineplus">+// Make sure that a given path does not exist.</span>
<a href="#l7.1269"></a><span id="l7.1269" class="difflineplus">+function pathShouldntExist(file) {</span>
<a href="#l7.1270"></a><span id="l7.1270" class="difflineplus">+  if (file.exists()) {</span>
<a href="#l7.1271"></a><span id="l7.1271" class="difflineplus">+    do_throw(`Test cleanup: path ${file.path} exists when it should not`);</span>
<a href="#l7.1272"></a><span id="l7.1272" class="difflineplus">+  }</span>
<a href="#l7.1273"></a><span id="l7.1273" class="difflineplus">+}</span>
<a href="#l7.1274"></a><span id="l7.1274" class="difflineplus">+</span>
<a href="#l7.1275"></a><span id="l7.1275" class="difflineplus">+// Wrap a function (typically a callback) to catch and report exceptions.</span>
<a href="#l7.1276"></a><span id="l7.1276" class="difflineplus">+function do_exception_wrap(func) {</span>
<a href="#l7.1277"></a><span id="l7.1277" class="difflineplus">+  return function() {</span>
<a href="#l7.1278"></a><span id="l7.1278" class="difflineplus">+    try {</span>
<a href="#l7.1279"></a><span id="l7.1279" class="difflineplus">+      func.apply(null, arguments);</span>
<a href="#l7.1280"></a><span id="l7.1280" class="difflineplus">+    } catch (e) {</span>
<a href="#l7.1281"></a><span id="l7.1281" class="difflineplus">+      do_report_unexpected_exception(e);</span>
<a href="#l7.1282"></a><span id="l7.1282" class="difflineplus">+    }</span>
<a href="#l7.1283"></a><span id="l7.1283" class="difflineplus">+  };</span>
<a href="#l7.1284"></a><span id="l7.1284" class="difflineplus">+}</span>
<a href="#l7.1285"></a><span id="l7.1285" class="difflineplus">+</span>
<a href="#l7.1286"></a><span id="l7.1286" class="difflineplus">+/**</span>
<a href="#l7.1287"></a><span id="l7.1287" class="difflineplus">+ * Change the schema version of the JSON extensions database.</span>
<a href="#l7.1288"></a><span id="l7.1288" class="difflineplus">+ */</span>
<a href="#l7.1289"></a><span id="l7.1289" class="difflineplus">+async function changeXPIDBVersion(aNewVersion) {</span>
<a href="#l7.1290"></a><span id="l7.1290" class="difflineplus">+  let json = await loadJSON(gExtensionsJSON.path);</span>
<a href="#l7.1291"></a><span id="l7.1291" class="difflineplus">+  json.schemaVersion = aNewVersion;</span>
<a href="#l7.1292"></a><span id="l7.1292" class="difflineplus">+  await saveJSON(json, gExtensionsJSON.path);</span>
<a href="#l7.1293"></a><span id="l7.1293" class="difflineplus">+}</span>
<a href="#l7.1294"></a><span id="l7.1294" class="difflineplus">+</span>
<a href="#l7.1295"></a><span id="l7.1295" class="difflineplus">+/**</span>
<a href="#l7.1296"></a><span id="l7.1296" class="difflineplus">+ * Load a file into a string.</span>
<a href="#l7.1297"></a><span id="l7.1297" class="difflineplus">+ */</span>
<a href="#l7.1298"></a><span id="l7.1298" class="difflineplus">+async function loadFile(aFile) {</span>
<a href="#l7.1299"></a><span id="l7.1299" class="difflineplus">+  let buffer = await OS.File.read(aFile);</span>
<a href="#l7.1300"></a><span id="l7.1300" class="difflineplus">+  return new TextDecoder().decode(buffer);</span>
<a href="#l7.1301"></a><span id="l7.1301" class="difflineplus">+}</span>
<a href="#l7.1302"></a><span id="l7.1302" class="difflineplus">+</span>
<a href="#l7.1303"></a><span id="l7.1303" class="difflineplus">+/**</span>
<a href="#l7.1304"></a><span id="l7.1304" class="difflineplus">+ * Raw load of a JSON file.</span>
<a href="#l7.1305"></a><span id="l7.1305" class="difflineplus">+ */</span>
<a href="#l7.1306"></a><span id="l7.1306" class="difflineplus">+async function loadJSON(aFile) {</span>
<a href="#l7.1307"></a><span id="l7.1307" class="difflineplus">+  let data = await loadFile(aFile);</span>
<a href="#l7.1308"></a><span id="l7.1308" class="difflineplus">+  info(&quot;Loaded JSON file &quot; + aFile);</span>
<a href="#l7.1309"></a><span id="l7.1309" class="difflineplus">+  return JSON.parse(data);</span>
<a href="#l7.1310"></a><span id="l7.1310" class="difflineplus">+}</span>
<a href="#l7.1311"></a><span id="l7.1311" class="difflineplus">+</span>
<a href="#l7.1312"></a><span id="l7.1312" class="difflineplus">+/**</span>
<a href="#l7.1313"></a><span id="l7.1313" class="difflineplus">+ * Raw save of a JSON blob to file.</span>
<a href="#l7.1314"></a><span id="l7.1314" class="difflineplus">+ */</span>
<a href="#l7.1315"></a><span id="l7.1315" class="difflineplus">+async function saveJSON(aData, aFile) {</span>
<a href="#l7.1316"></a><span id="l7.1316" class="difflineplus">+  info(&quot;Starting to save JSON file &quot; + aFile);</span>
<a href="#l7.1317"></a><span id="l7.1317" class="difflineplus">+  await OS.File.writeAtomic(aFile, new TextEncoder().encode(JSON.stringify(aData, null, 2)));</span>
<a href="#l7.1318"></a><span id="l7.1318" class="difflineplus">+  info(&quot;Done saving JSON file &quot; + aFile.path);</span>
<a href="#l7.1319"></a><span id="l7.1319" class="difflineplus">+}</span>
<a href="#l7.1320"></a><span id="l7.1320" class="difflineplus">+</span>
<a href="#l7.1321"></a><span id="l7.1321" class="difflineplus">+/**</span>
<a href="#l7.1322"></a><span id="l7.1322" class="difflineplus">+ * Create a callback function that calls do_execute_soon on an actual callback and arguments.</span>
<a href="#l7.1323"></a><span id="l7.1323" class="difflineplus">+ */</span>
<a href="#l7.1324"></a><span id="l7.1324" class="difflineplus">+function callback_soon(aFunction) {</span>
<a href="#l7.1325"></a><span id="l7.1325" class="difflineplus">+  return function(...args) {</span>
<a href="#l7.1326"></a><span id="l7.1326" class="difflineplus">+    executeSoon(function() {</span>
<a href="#l7.1327"></a><span id="l7.1327" class="difflineplus">+      aFunction.apply(null, args);</span>
<a href="#l7.1328"></a><span id="l7.1328" class="difflineplus">+    }, aFunction.name ? &quot;delayed callback &quot; + aFunction.name : &quot;delayed callback&quot;);</span>
<a href="#l7.1329"></a><span id="l7.1329" class="difflineplus">+  };</span>
<a href="#l7.1330"></a><span id="l7.1330" class="difflineplus">+}</span>
<a href="#l7.1331"></a><span id="l7.1331" class="difflineplus">+</span>
<a href="#l7.1332"></a><span id="l7.1332" class="difflineplus">+XPCOMUtils.defineLazyServiceGetter(this, &quot;pluginHost&quot;,</span>
<a href="#l7.1333"></a><span id="l7.1333" class="difflineplus">+                                  &quot;@mozilla.org/plugin/host;1&quot;, &quot;nsIPluginHost&quot;);</span>
<a href="#l7.1334"></a><span id="l7.1334" class="difflineplus">+</span>
<a href="#l7.1335"></a><span id="l7.1335" class="difflineplus">+class MockPluginTag {</span>
<a href="#l7.1336"></a><span id="l7.1336" class="difflineplus">+  constructor(opts, enabledState = Ci.nsIPluginTag.STATE_ENABLED) {</span>
<a href="#l7.1337"></a><span id="l7.1337" class="difflineplus">+    this.pluginTag = pluginHost.createFakePlugin({</span>
<a href="#l7.1338"></a><span id="l7.1338" class="difflineplus">+      handlerURI: &quot;resource://fake-plugin/${Math.random()}.xhtml&quot;,</span>
<a href="#l7.1339"></a><span id="l7.1339" class="difflineplus">+      mimeEntries: [{type: &quot;application/x-fake-plugin&quot;}],</span>
<a href="#l7.1340"></a><span id="l7.1340" class="difflineplus">+      fileName: `${opts.name}.so`,</span>
<a href="#l7.1341"></a><span id="l7.1341" class="difflineplus">+      ...opts,</span>
<a href="#l7.1342"></a><span id="l7.1342" class="difflineplus">+    });</span>
<a href="#l7.1343"></a><span id="l7.1343" class="difflineplus">+    this.pluginTag.enabledState = enabledState;</span>
<a href="#l7.1344"></a><span id="l7.1344" class="difflineplus">+</span>
<a href="#l7.1345"></a><span id="l7.1345" class="difflineplus">+    this.name = opts.name;</span>
<a href="#l7.1346"></a><span id="l7.1346" class="difflineplus">+    this.version = opts.version;</span>
<a href="#l7.1347"></a><span id="l7.1347" class="difflineplus">+  }</span>
<a href="#l7.1348"></a><span id="l7.1348" class="difflineplus">+  async isBlocklisted() {</span>
<a href="#l7.1349"></a><span id="l7.1349" class="difflineplus">+    let state = await Blocklist.getPluginBlocklistState(this.pluginTag);</span>
<a href="#l7.1350"></a><span id="l7.1350" class="difflineplus">+    return state == Services.blocklist.STATE_BLOCKED;</span>
<a href="#l7.1351"></a><span id="l7.1351" class="difflineplus">+  }</span>
<a href="#l7.1352"></a><span id="l7.1352" class="difflineplus">+  get disabled() {</span>
<a href="#l7.1353"></a><span id="l7.1353" class="difflineplus">+    return this.pluginTag.enabledState == Ci.nsIPluginTag.STATE_DISABLED;</span>
<a href="#l7.1354"></a><span id="l7.1354" class="difflineplus">+  }</span>
<a href="#l7.1355"></a><span id="l7.1355" class="difflineplus">+  set disabled(val) {</span>
<a href="#l7.1356"></a><span id="l7.1356" class="difflineplus">+    this.enabledState = Ci.nsIPluginTag[val ? &quot;STATE_DISABLED&quot; : &quot;STATE_ENABLED&quot;];</span>
<a href="#l7.1357"></a><span id="l7.1357" class="difflineplus">+  }</span>
<a href="#l7.1358"></a><span id="l7.1358" class="difflineplus">+  get enabledState() {</span>
<a href="#l7.1359"></a><span id="l7.1359" class="difflineplus">+    return this.pluginTag.enabledState;</span>
<a href="#l7.1360"></a><span id="l7.1360" class="difflineplus">+  }</span>
<a href="#l7.1361"></a><span id="l7.1361" class="difflineplus">+  set enabledState(val) {</span>
<a href="#l7.1362"></a><span id="l7.1362" class="difflineplus">+    this.pluginTag.enabledState = val;</span>
<a href="#l7.1363"></a><span id="l7.1363" class="difflineplus">+  }</span>
<a href="#l7.1364"></a><span id="l7.1364" class="difflineplus">+}</span>
<a href="#l7.1365"></a><span id="l7.1365" class="difflineplus">+</span>
<a href="#l7.1366"></a><span id="l7.1366" class="difflineplus">+function mockPluginHost(plugins) {</span>
<a href="#l7.1367"></a><span id="l7.1367" class="difflineplus">+  let PluginHost = {</span>
<a href="#l7.1368"></a><span id="l7.1368" class="difflineplus">+    getPluginTags(count) {</span>
<a href="#l7.1369"></a><span id="l7.1369" class="difflineplus">+      count.value = plugins.length;</span>
<a href="#l7.1370"></a><span id="l7.1370" class="difflineplus">+      return plugins.map(p =&gt; p.pluginTag);</span>
<a href="#l7.1371"></a><span id="l7.1371" class="difflineplus">+    },</span>
<a href="#l7.1372"></a><span id="l7.1372" class="difflineplus">+</span>
<a href="#l7.1373"></a><span id="l7.1373" class="difflineplus">+    QueryInterface: ChromeUtils.generateQI([&quot;nsIPluginHost&quot;]),</span>
<a href="#l7.1374"></a><span id="l7.1374" class="difflineplus">+  };</span>
<a href="#l7.1375"></a><span id="l7.1375" class="difflineplus">+</span>
<a href="#l7.1376"></a><span id="l7.1376" class="difflineplus">+  MockRegistrar.register(&quot;@mozilla.org/plugin/host;1&quot;, PluginHost);</span>
<a href="#l7.1377"></a><span id="l7.1377" class="difflineplus">+}</span>
<a href="#l7.1378"></a><span id="l7.1378" class="difflineplus">+</span>
<a href="#l7.1379"></a><span id="l7.1379" class="difflineplus">+async function setInitialState(addon, initialState) {</span>
<a href="#l7.1380"></a><span id="l7.1380" class="difflineplus">+  if (initialState.userDisabled) {</span>
<a href="#l7.1381"></a><span id="l7.1381" class="difflineplus">+    await addon.disable();</span>
<a href="#l7.1382"></a><span id="l7.1382" class="difflineplus">+  } else if (initialState.userDisabled === false) {</span>
<a href="#l7.1383"></a><span id="l7.1383" class="difflineplus">+    await addon.enable();</span>
<a href="#l7.1384"></a><span id="l7.1384" class="difflineplus">+  }</span>
<a href="#l7.1385"></a><span id="l7.1385" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1">new file mode 100644</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineminus">--- /dev/null</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineplus">+++ b/common/test/xpcshell/test_bootstrap.js</span>
<a href="#l8.4"></a><span id="l8.4" class="difflineat">@@ -0,0 +1,1181 @@</span>
<a href="#l8.5"></a><span id="l8.5" class="difflineplus">+/* Any copyright is dedicated to the Public Domain.</span>
<a href="#l8.6"></a><span id="l8.6" class="difflineplus">+ * http://creativecommons.org/publicdomain/zero/1.0/</span>
<a href="#l8.7"></a><span id="l8.7" class="difflineplus">+ */</span>
<a href="#l8.8"></a><span id="l8.8" class="difflineplus">+</span>
<a href="#l8.9"></a><span id="l8.9" class="difflineplus">+const APP_STARTUP                     = 1;</span>
<a href="#l8.10"></a><span id="l8.10" class="difflineplus">+const APP_SHUTDOWN                    = 2;</span>
<a href="#l8.11"></a><span id="l8.11" class="difflineplus">+const ADDON_ENABLE                    = 3;</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+const ADDON_DISABLE                   = 4;</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+const ADDON_INSTALL                   = 5;</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+const ADDON_UNINSTALL                 = 6;</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+const ADDON_UPGRADE                   = 7;</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+const ADDON_DOWNGRADE                 = 8;</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineplus">+const ID1 = &quot;bootstrap1@tests.mozilla.org&quot;;</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineplus">+const ID2 = &quot;bootstrap2@tests.mozilla.org&quot;;</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineplus">+</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineplus">+// This verifies that bootstrappable add-ons can be used without restarts.</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineplus">+ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineplus">+</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineplus">+// Enable loading extensions from the user scopes</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineplus">+Services.prefs.setIntPref(&quot;extensions.enabledScopes&quot;,</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineplus">+                          AddonManager.SCOPE_PROFILE + AddonManager.SCOPE_USER);</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineplus">+</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineplus">+BootstrapMonitor.init();</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineplus">+</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineplus">+createAppInfo(&quot;xpcshell@tests.mozilla.org&quot;, &quot;XPCShell&quot;, &quot;1&quot;, &quot;1.9.2&quot;);</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineplus">+</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+const profileDir = gProfD.clone();</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineplus">+profileDir.append(&quot;extensions&quot;);</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineplus">+const userExtDir = gProfD.clone();</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineplus">+userExtDir.append(&quot;extensions2&quot;);</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineplus">+userExtDir.append(gAppInfo.ID);</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineplus">+registerDirectory(&quot;XREUSysExt&quot;, userExtDir.parent);</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineplus">+</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineplus">+const ADDONS = {</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineplus">+  test_bootstrap1_1: {</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineplus">+    &quot;install.rdf&quot;: {</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineplus">+      id: &quot;bootstrap1@tests.mozilla.org&quot;,</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineplus">+</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineplus">+      name: &quot;Test Bootstrap 1&quot;,</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineplus">+</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineplus">+      iconURL: &quot;chrome://foo/skin/icon.png&quot;,</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineplus">+      aboutURL: &quot;chrome://foo/content/about.xul&quot;,</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineplus">+      optionsURL: &quot;chrome://foo/content/options.xul&quot;,</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineplus">+    },</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineplus">+    &quot;bootstrap.js&quot;: BOOTSTRAP_MONITOR_BOOTSTRAP_JS,</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineplus">+  },</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineplus">+  test_bootstrap1_2: {</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineplus">+    &quot;install.rdf&quot;: {</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineplus">+      id: &quot;bootstrap1@tests.mozilla.org&quot;,</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineplus">+      version: &quot;2.0&quot;,</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineplus">+</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineplus">+      name: &quot;Test Bootstrap 1&quot;,</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineplus">+    },</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineplus">+    &quot;bootstrap.js&quot;: BOOTSTRAP_MONITOR_BOOTSTRAP_JS,</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineplus">+  },</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineplus">+  test_bootstrap1_3: {</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineplus">+    &quot;install.rdf&quot;: {</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineplus">+      id: &quot;bootstrap1@tests.mozilla.org&quot;,</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineplus">+      version: &quot;3.0&quot;,</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineplus">+</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineplus">+      name: &quot;Test Bootstrap 1&quot;,</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineplus">+</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineplus">+      targetApplications: [{</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineplus">+        id: &quot;undefined&quot;,</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineplus">+        minVersion: &quot;1&quot;,</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineplus">+        maxVersion: &quot;1&quot;}],</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineplus">+    },</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineplus">+    &quot;bootstrap.js&quot;: BOOTSTRAP_MONITOR_BOOTSTRAP_JS,</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineplus">+  },</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineplus">+  test_bootstrap2_1: {</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineplus">+    &quot;install.rdf&quot;: {</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineplus">+      id: &quot;bootstrap2@tests.mozilla.org&quot;,</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineplus">+    },</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineplus">+    &quot;bootstrap.js&quot;: BOOTSTRAP_MONITOR_BOOTSTRAP_JS,</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineplus">+  },</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineplus">+};</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineplus">+</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineplus">+var testserver = AddonTestUtils.createHttpServer({hosts: [&quot;example.com&quot;]});</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineplus">+</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineplus">+const XPIS = {};</span>
<a href="#l8.86"></a><span id="l8.86" class="difflineplus">+for (let [name, addon] of Object.entries(ADDONS)) {</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineplus">+  XPIS[name] = AddonTestUtils.createTempXPIFile(addon);</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineplus">+  testserver.registerFile(`/addons/${name}.xpi`, XPIS[name]);</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineplus">+}</span>
<a href="#l8.90"></a><span id="l8.90" class="difflineplus">+</span>
<a href="#l8.91"></a><span id="l8.91" class="difflineplus">+</span>
<a href="#l8.92"></a><span id="l8.92" class="difflineplus">+function getStartupReason() {</span>
<a href="#l8.93"></a><span id="l8.93" class="difflineplus">+  let info = BootstrapMonitor.started.get(ID1);</span>
<a href="#l8.94"></a><span id="l8.94" class="difflineplus">+  return info ? info.reason : undefined;</span>
<a href="#l8.95"></a><span id="l8.95" class="difflineplus">+}</span>
<a href="#l8.96"></a><span id="l8.96" class="difflineplus">+</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineplus">+function getShutdownReason() {</span>
<a href="#l8.98"></a><span id="l8.98" class="difflineplus">+  let info = BootstrapMonitor.stopped.get(ID1);</span>
<a href="#l8.99"></a><span id="l8.99" class="difflineplus">+  return info ? info.reason : undefined;</span>
<a href="#l8.100"></a><span id="l8.100" class="difflineplus">+}</span>
<a href="#l8.101"></a><span id="l8.101" class="difflineplus">+</span>
<a href="#l8.102"></a><span id="l8.102" class="difflineplus">+function getInstallReason() {</span>
<a href="#l8.103"></a><span id="l8.103" class="difflineplus">+  let info = BootstrapMonitor.installed.get(ID1);</span>
<a href="#l8.104"></a><span id="l8.104" class="difflineplus">+  return info ? info.reason : undefined;</span>
<a href="#l8.105"></a><span id="l8.105" class="difflineplus">+}</span>
<a href="#l8.106"></a><span id="l8.106" class="difflineplus">+</span>
<a href="#l8.107"></a><span id="l8.107" class="difflineplus">+function getUninstallReason() {</span>
<a href="#l8.108"></a><span id="l8.108" class="difflineplus">+  let info = BootstrapMonitor.uninstalled.get(ID1);</span>
<a href="#l8.109"></a><span id="l8.109" class="difflineplus">+  return info ? info.reason : undefined;</span>
<a href="#l8.110"></a><span id="l8.110" class="difflineplus">+}</span>
<a href="#l8.111"></a><span id="l8.111" class="difflineplus">+</span>
<a href="#l8.112"></a><span id="l8.112" class="difflineplus">+function getStartupOldVersion() {</span>
<a href="#l8.113"></a><span id="l8.113" class="difflineplus">+  let info = BootstrapMonitor.started.get(ID1);</span>
<a href="#l8.114"></a><span id="l8.114" class="difflineplus">+  return info ? info.data.oldVersion : undefined;</span>
<a href="#l8.115"></a><span id="l8.115" class="difflineplus">+}</span>
<a href="#l8.116"></a><span id="l8.116" class="difflineplus">+</span>
<a href="#l8.117"></a><span id="l8.117" class="difflineplus">+function getShutdownNewVersion() {</span>
<a href="#l8.118"></a><span id="l8.118" class="difflineplus">+  let info = BootstrapMonitor.stopped.get(ID1);</span>
<a href="#l8.119"></a><span id="l8.119" class="difflineplus">+  return info ? info.data.newVersion : undefined;</span>
<a href="#l8.120"></a><span id="l8.120" class="difflineplus">+}</span>
<a href="#l8.121"></a><span id="l8.121" class="difflineplus">+</span>
<a href="#l8.122"></a><span id="l8.122" class="difflineplus">+function getInstallOldVersion() {</span>
<a href="#l8.123"></a><span id="l8.123" class="difflineplus">+  let info = BootstrapMonitor.installed.get(ID1);</span>
<a href="#l8.124"></a><span id="l8.124" class="difflineplus">+  return info ? info.data.oldVersion : undefined;</span>
<a href="#l8.125"></a><span id="l8.125" class="difflineplus">+}</span>
<a href="#l8.126"></a><span id="l8.126" class="difflineplus">+</span>
<a href="#l8.127"></a><span id="l8.127" class="difflineplus">+function getUninstallNewVersion() {</span>
<a href="#l8.128"></a><span id="l8.128" class="difflineplus">+  let info = BootstrapMonitor.uninstalled.get(ID1);</span>
<a href="#l8.129"></a><span id="l8.129" class="difflineplus">+  return info ? info.data.newVersion : undefined;</span>
<a href="#l8.130"></a><span id="l8.130" class="difflineplus">+}</span>
<a href="#l8.131"></a><span id="l8.131" class="difflineplus">+</span>
<a href="#l8.132"></a><span id="l8.132" class="difflineplus">+async function checkBootstrappedPref() {</span>
<a href="#l8.133"></a><span id="l8.133" class="difflineplus">+  let XPIScope = ChromeUtils.import(&quot;resource://gre/modules/addons/XPIProvider.jsm&quot;, {});</span>
<a href="#l8.134"></a><span id="l8.134" class="difflineplus">+</span>
<a href="#l8.135"></a><span id="l8.135" class="difflineplus">+  let data = new Map();</span>
<a href="#l8.136"></a><span id="l8.136" class="difflineplus">+  for (let entry of XPIScope.XPIStates.enabledAddons()) {</span>
<a href="#l8.137"></a><span id="l8.137" class="difflineplus">+    data.set(entry.id, entry);</span>
<a href="#l8.138"></a><span id="l8.138" class="difflineplus">+  }</span>
<a href="#l8.139"></a><span id="l8.139" class="difflineplus">+</span>
<a href="#l8.140"></a><span id="l8.140" class="difflineplus">+  let addons = await AddonManager.getAddonsByTypes([&quot;extension&quot;]);</span>
<a href="#l8.141"></a><span id="l8.141" class="difflineplus">+  for (let addon of addons) {</span>
<a href="#l8.142"></a><span id="l8.142" class="difflineplus">+    if (!addon.id.endsWith(&quot;@tests.mozilla.org&quot;))</span>
<a href="#l8.143"></a><span id="l8.143" class="difflineplus">+      continue;</span>
<a href="#l8.144"></a><span id="l8.144" class="difflineplus">+    if (!addon.isActive)</span>
<a href="#l8.145"></a><span id="l8.145" class="difflineplus">+      continue;</span>
<a href="#l8.146"></a><span id="l8.146" class="difflineplus">+    if (addon.operationsRequiringRestart != AddonManager.OP_NEEDS_RESTART_NONE)</span>
<a href="#l8.147"></a><span id="l8.147" class="difflineplus">+      continue;</span>
<a href="#l8.148"></a><span id="l8.148" class="difflineplus">+</span>
<a href="#l8.149"></a><span id="l8.149" class="difflineplus">+    ok(data.has(addon.id));</span>
<a href="#l8.150"></a><span id="l8.150" class="difflineplus">+    let addonData = data.get(addon.id);</span>
<a href="#l8.151"></a><span id="l8.151" class="difflineplus">+    data.delete(addon.id);</span>
<a href="#l8.152"></a><span id="l8.152" class="difflineplus">+</span>
<a href="#l8.153"></a><span id="l8.153" class="difflineplus">+    equal(addonData.version, addon.version);</span>
<a href="#l8.154"></a><span id="l8.154" class="difflineplus">+    equal(addonData.type, addon.type);</span>
<a href="#l8.155"></a><span id="l8.155" class="difflineplus">+    let file = addon.getResourceURI().QueryInterface(Ci.nsIFileURL).file;</span>
<a href="#l8.156"></a><span id="l8.156" class="difflineplus">+    equal(addonData.path, file.path);</span>
<a href="#l8.157"></a><span id="l8.157" class="difflineplus">+  }</span>
<a href="#l8.158"></a><span id="l8.158" class="difflineplus">+  equal(data.size, 0);</span>
<a href="#l8.159"></a><span id="l8.159" class="difflineplus">+}</span>
<a href="#l8.160"></a><span id="l8.160" class="difflineplus">+</span>
<a href="#l8.161"></a><span id="l8.161" class="difflineplus">+add_task(async function run_test() {</span>
<a href="#l8.162"></a><span id="l8.162" class="difflineplus">+  promiseStartupManager();</span>
<a href="#l8.163"></a><span id="l8.163" class="difflineplus">+</span>
<a href="#l8.164"></a><span id="l8.164" class="difflineplus">+  ok(!gExtensionsJSON.exists());</span>
<a href="#l8.165"></a><span id="l8.165" class="difflineplus">+  ok(!gAddonStartup.exists());</span>
<a href="#l8.166"></a><span id="l8.166" class="difflineplus">+});</span>
<a href="#l8.167"></a><span id="l8.167" class="difflineplus">+</span>
<a href="#l8.168"></a><span id="l8.168" class="difflineplus">+// Tests that installing doesn't require a restart</span>
<a href="#l8.169"></a><span id="l8.169" class="difflineplus">+add_task(async function test_1() {</span>
<a href="#l8.170"></a><span id="l8.170" class="difflineplus">+  prepare_test({}, [</span>
<a href="#l8.171"></a><span id="l8.171" class="difflineplus">+    &quot;onNewInstall&quot;,</span>
<a href="#l8.172"></a><span id="l8.172" class="difflineplus">+  ]);</span>
<a href="#l8.173"></a><span id="l8.173" class="difflineplus">+</span>
<a href="#l8.174"></a><span id="l8.174" class="difflineplus">+  let install = await AddonManager.getInstallForFile(XPIS.test_bootstrap1_1);</span>
<a href="#l8.175"></a><span id="l8.175" class="difflineplus">+  ensure_test_completed();</span>
<a href="#l8.176"></a><span id="l8.176" class="difflineplus">+</span>
<a href="#l8.177"></a><span id="l8.177" class="difflineplus">+  notEqual(install, null);</span>
<a href="#l8.178"></a><span id="l8.178" class="difflineplus">+  equal(install.type, &quot;extension&quot;);</span>
<a href="#l8.179"></a><span id="l8.179" class="difflineplus">+  equal(install.version, &quot;1.0&quot;);</span>
<a href="#l8.180"></a><span id="l8.180" class="difflineplus">+  equal(install.name, &quot;Test Bootstrap 1&quot;);</span>
<a href="#l8.181"></a><span id="l8.181" class="difflineplus">+  equal(install.state, AddonManager.STATE_DOWNLOADED);</span>
<a href="#l8.182"></a><span id="l8.182" class="difflineplus">+  notEqual(install.addon.syncGUID, null);</span>
<a href="#l8.183"></a><span id="l8.183" class="difflineplus">+  equal(install.addon.operationsRequiringRestart &amp;</span>
<a href="#l8.184"></a><span id="l8.184" class="difflineplus">+               AddonManager.OP_NEEDS_RESTART_INSTALL, 0);</span>
<a href="#l8.185"></a><span id="l8.185" class="difflineplus">+  do_check_not_in_crash_annotation(ID1, &quot;1.0&quot;);</span>
<a href="#l8.186"></a><span id="l8.186" class="difflineplus">+</span>
<a href="#l8.187"></a><span id="l8.187" class="difflineplus">+  let addon = install.addon;</span>
<a href="#l8.188"></a><span id="l8.188" class="difflineplus">+</span>
<a href="#l8.189"></a><span id="l8.189" class="difflineplus">+  await Promise.all([</span>
<a href="#l8.190"></a><span id="l8.190" class="difflineplus">+    BootstrapMonitor.promiseAddonStartup(ID1),</span>
<a href="#l8.191"></a><span id="l8.191" class="difflineplus">+    new Promise(resolve =&gt; {</span>
<a href="#l8.192"></a><span id="l8.192" class="difflineplus">+      prepare_test({</span>
<a href="#l8.193"></a><span id="l8.193" class="difflineplus">+        [ID1]: [</span>
<a href="#l8.194"></a><span id="l8.194" class="difflineplus">+          [&quot;onInstalling&quot;, false],</span>
<a href="#l8.195"></a><span id="l8.195" class="difflineplus">+          &quot;onInstalled&quot;,</span>
<a href="#l8.196"></a><span id="l8.196" class="difflineplus">+        ],</span>
<a href="#l8.197"></a><span id="l8.197" class="difflineplus">+      }, [</span>
<a href="#l8.198"></a><span id="l8.198" class="difflineplus">+        &quot;onInstallStarted&quot;,</span>
<a href="#l8.199"></a><span id="l8.199" class="difflineplus">+        &quot;onInstallEnded&quot;,</span>
<a href="#l8.200"></a><span id="l8.200" class="difflineplus">+      ], function() {</span>
<a href="#l8.201"></a><span id="l8.201" class="difflineplus">+        // startup should not have been called yet.</span>
<a href="#l8.202"></a><span id="l8.202" class="difflineplus">+        BootstrapMonitor.checkAddonNotStarted(ID1);</span>
<a href="#l8.203"></a><span id="l8.203" class="difflineplus">+        resolve();</span>
<a href="#l8.204"></a><span id="l8.204" class="difflineplus">+      });</span>
<a href="#l8.205"></a><span id="l8.205" class="difflineplus">+      install.install();</span>
<a href="#l8.206"></a><span id="l8.206" class="difflineplus">+    }),</span>
<a href="#l8.207"></a><span id="l8.207" class="difflineplus">+  ]);</span>
<a href="#l8.208"></a><span id="l8.208" class="difflineplus">+</span>
<a href="#l8.209"></a><span id="l8.209" class="difflineplus">+  await checkBootstrappedPref();</span>
<a href="#l8.210"></a><span id="l8.210" class="difflineplus">+  let installSyncGUID = addon.syncGUID;</span>
<a href="#l8.211"></a><span id="l8.211" class="difflineplus">+</span>
<a href="#l8.212"></a><span id="l8.212" class="difflineplus">+  let installs = await AddonManager.getAllInstalls();</span>
<a href="#l8.213"></a><span id="l8.213" class="difflineplus">+  // There should be no active installs now since the install completed and</span>
<a href="#l8.214"></a><span id="l8.214" class="difflineplus">+  // doesn't require a restart.</span>
<a href="#l8.215"></a><span id="l8.215" class="difflineplus">+  equal(installs.length, 0);</span>
<a href="#l8.216"></a><span id="l8.216" class="difflineplus">+</span>
<a href="#l8.217"></a><span id="l8.217" class="difflineplus">+  let b1 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l8.218"></a><span id="l8.218" class="difflineplus">+  notEqual(b1, null);</span>
<a href="#l8.219"></a><span id="l8.219" class="difflineplus">+  equal(b1.version, &quot;1.0&quot;);</span>
<a href="#l8.220"></a><span id="l8.220" class="difflineplus">+  notEqual(b1.syncGUID, null);</span>
<a href="#l8.221"></a><span id="l8.221" class="difflineplus">+  equal(b1.syncGUID, installSyncGUID);</span>
<a href="#l8.222"></a><span id="l8.222" class="difflineplus">+  ok(!b1.appDisabled);</span>
<a href="#l8.223"></a><span id="l8.223" class="difflineplus">+  ok(!b1.userDisabled);</span>
<a href="#l8.224"></a><span id="l8.224" class="difflineplus">+  ok(b1.isActive);</span>
<a href="#l8.225"></a><span id="l8.225" class="difflineplus">+  ok(!b1.isSystem);</span>
<a href="#l8.226"></a><span id="l8.226" class="difflineplus">+  BootstrapMonitor.checkAddonInstalled(ID1, &quot;1.0&quot;);</span>
<a href="#l8.227"></a><span id="l8.227" class="difflineplus">+  BootstrapMonitor.checkAddonStarted(ID1, &quot;1.0&quot;);</span>
<a href="#l8.228"></a><span id="l8.228" class="difflineplus">+  equal(getStartupReason(), ADDON_INSTALL);</span>
<a href="#l8.229"></a><span id="l8.229" class="difflineplus">+  equal(getStartupOldVersion(), undefined);</span>
<a href="#l8.230"></a><span id="l8.230" class="difflineplus">+  do_check_in_crash_annotation(ID1, &quot;1.0&quot;);</span>
<a href="#l8.231"></a><span id="l8.231" class="difflineplus">+</span>
<a href="#l8.232"></a><span id="l8.232" class="difflineplus">+  let dir = do_get_addon_root_uri(profileDir, ID1);</span>
<a href="#l8.233"></a><span id="l8.233" class="difflineplus">+  equal(b1.getResourceURI(&quot;bootstrap.js&quot;).spec, dir + &quot;bootstrap.js&quot;);</span>
<a href="#l8.234"></a><span id="l8.234" class="difflineplus">+});</span>
<a href="#l8.235"></a><span id="l8.235" class="difflineplus">+</span>
<a href="#l8.236"></a><span id="l8.236" class="difflineplus">+// Tests that disabling doesn't require a restart</span>
<a href="#l8.237"></a><span id="l8.237" class="difflineplus">+add_task(async function test_2() {</span>
<a href="#l8.238"></a><span id="l8.238" class="difflineplus">+  let b1 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l8.239"></a><span id="l8.239" class="difflineplus">+  prepare_test({</span>
<a href="#l8.240"></a><span id="l8.240" class="difflineplus">+    [ID1]: [</span>
<a href="#l8.241"></a><span id="l8.241" class="difflineplus">+      [&quot;onDisabling&quot;, false],</span>
<a href="#l8.242"></a><span id="l8.242" class="difflineplus">+      &quot;onDisabled&quot;,</span>
<a href="#l8.243"></a><span id="l8.243" class="difflineplus">+    ],</span>
<a href="#l8.244"></a><span id="l8.244" class="difflineplus">+  });</span>
<a href="#l8.245"></a><span id="l8.245" class="difflineplus">+</span>
<a href="#l8.246"></a><span id="l8.246" class="difflineplus">+  equal(b1.operationsRequiringRestart &amp;</span>
<a href="#l8.247"></a><span id="l8.247" class="difflineplus">+        AddonManager.OP_NEEDS_RESTART_DISABLE, 0);</span>
<a href="#l8.248"></a><span id="l8.248" class="difflineplus">+  await b1.disable();</span>
<a href="#l8.249"></a><span id="l8.249" class="difflineplus">+  ensure_test_completed();</span>
<a href="#l8.250"></a><span id="l8.250" class="difflineplus">+</span>
<a href="#l8.251"></a><span id="l8.251" class="difflineplus">+  await new Promise(executeSoon);</span>
<a href="#l8.252"></a><span id="l8.252" class="difflineplus">+</span>
<a href="#l8.253"></a><span id="l8.253" class="difflineplus">+  notEqual(b1, null);</span>
<a href="#l8.254"></a><span id="l8.254" class="difflineplus">+  equal(b1.version, &quot;1.0&quot;);</span>
<a href="#l8.255"></a><span id="l8.255" class="difflineplus">+  ok(!b1.appDisabled);</span>
<a href="#l8.256"></a><span id="l8.256" class="difflineplus">+  ok(b1.userDisabled);</span>
<a href="#l8.257"></a><span id="l8.257" class="difflineplus">+  ok(!b1.isActive);</span>
<a href="#l8.258"></a><span id="l8.258" class="difflineplus">+  BootstrapMonitor.checkAddonInstalled(ID1, &quot;1.0&quot;);</span>
<a href="#l8.259"></a><span id="l8.259" class="difflineplus">+  BootstrapMonitor.checkAddonNotStarted(ID1);</span>
<a href="#l8.260"></a><span id="l8.260" class="difflineplus">+  equal(getShutdownReason(), ADDON_DISABLE);</span>
<a href="#l8.261"></a><span id="l8.261" class="difflineplus">+  equal(getShutdownNewVersion(), undefined);</span>
<a href="#l8.262"></a><span id="l8.262" class="difflineplus">+  do_check_not_in_crash_annotation(ID1, &quot;1.0&quot;);</span>
<a href="#l8.263"></a><span id="l8.263" class="difflineplus">+</span>
<a href="#l8.264"></a><span id="l8.264" class="difflineplus">+  let newb1 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l8.265"></a><span id="l8.265" class="difflineplus">+  notEqual(newb1, null);</span>
<a href="#l8.266"></a><span id="l8.266" class="difflineplus">+  equal(newb1.version, &quot;1.0&quot;);</span>
<a href="#l8.267"></a><span id="l8.267" class="difflineplus">+  ok(!newb1.appDisabled);</span>
<a href="#l8.268"></a><span id="l8.268" class="difflineplus">+  ok(newb1.userDisabled);</span>
<a href="#l8.269"></a><span id="l8.269" class="difflineplus">+  ok(!newb1.isActive);</span>
<a href="#l8.270"></a><span id="l8.270" class="difflineplus">+</span>
<a href="#l8.271"></a><span id="l8.271" class="difflineplus">+  await checkBootstrappedPref();</span>
<a href="#l8.272"></a><span id="l8.272" class="difflineplus">+});</span>
<a href="#l8.273"></a><span id="l8.273" class="difflineplus">+</span>
<a href="#l8.274"></a><span id="l8.274" class="difflineplus">+// Test that restarting doesn't accidentally re-enable</span>
<a href="#l8.275"></a><span id="l8.275" class="difflineplus">+add_task(async function test_3() {</span>
<a href="#l8.276"></a><span id="l8.276" class="difflineplus">+  await promiseShutdownManager();</span>
<a href="#l8.277"></a><span id="l8.277" class="difflineplus">+</span>
<a href="#l8.278"></a><span id="l8.278" class="difflineplus">+  BootstrapMonitor.checkAddonInstalled(ID1, &quot;1.0&quot;);</span>
<a href="#l8.279"></a><span id="l8.279" class="difflineplus">+  BootstrapMonitor.checkAddonNotStarted(ID1);</span>
<a href="#l8.280"></a><span id="l8.280" class="difflineplus">+  equal(getShutdownReason(), ADDON_DISABLE);</span>
<a href="#l8.281"></a><span id="l8.281" class="difflineplus">+  equal(getShutdownNewVersion(), undefined);</span>
<a href="#l8.282"></a><span id="l8.282" class="difflineplus">+</span>
<a href="#l8.283"></a><span id="l8.283" class="difflineplus">+  await promiseStartupManager();</span>
<a href="#l8.284"></a><span id="l8.284" class="difflineplus">+</span>
<a href="#l8.285"></a><span id="l8.285" class="difflineplus">+  BootstrapMonitor.checkAddonInstalled(ID1, &quot;1.0&quot;);</span>
<a href="#l8.286"></a><span id="l8.286" class="difflineplus">+  BootstrapMonitor.checkAddonNotStarted(ID1);</span>
<a href="#l8.287"></a><span id="l8.287" class="difflineplus">+  equal(getShutdownReason(), ADDON_DISABLE);</span>
<a href="#l8.288"></a><span id="l8.288" class="difflineplus">+  equal(getShutdownNewVersion(), undefined);</span>
<a href="#l8.289"></a><span id="l8.289" class="difflineplus">+  do_check_not_in_crash_annotation(ID1, &quot;1.0&quot;);</span>
<a href="#l8.290"></a><span id="l8.290" class="difflineplus">+</span>
<a href="#l8.291"></a><span id="l8.291" class="difflineplus">+  ok(gAddonStartup.exists());</span>
<a href="#l8.292"></a><span id="l8.292" class="difflineplus">+</span>
<a href="#l8.293"></a><span id="l8.293" class="difflineplus">+  let b1 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l8.294"></a><span id="l8.294" class="difflineplus">+  notEqual(b1, null);</span>
<a href="#l8.295"></a><span id="l8.295" class="difflineplus">+  equal(b1.version, &quot;1.0&quot;);</span>
<a href="#l8.296"></a><span id="l8.296" class="difflineplus">+  ok(!b1.appDisabled);</span>
<a href="#l8.297"></a><span id="l8.297" class="difflineplus">+  ok(b1.userDisabled);</span>
<a href="#l8.298"></a><span id="l8.298" class="difflineplus">+  ok(!b1.isActive);</span>
<a href="#l8.299"></a><span id="l8.299" class="difflineplus">+</span>
<a href="#l8.300"></a><span id="l8.300" class="difflineplus">+  await checkBootstrappedPref();</span>
<a href="#l8.301"></a><span id="l8.301" class="difflineplus">+});</span>
<a href="#l8.302"></a><span id="l8.302" class="difflineplus">+</span>
<a href="#l8.303"></a><span id="l8.303" class="difflineplus">+// Tests that enabling doesn't require a restart</span>
<a href="#l8.304"></a><span id="l8.304" class="difflineplus">+add_task(async function test_4() {</span>
<a href="#l8.305"></a><span id="l8.305" class="difflineplus">+  let b1 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l8.306"></a><span id="l8.306" class="difflineplus">+  prepare_test({</span>
<a href="#l8.307"></a><span id="l8.307" class="difflineplus">+    [ID1]: [</span>
<a href="#l8.308"></a><span id="l8.308" class="difflineplus">+      [&quot;onEnabling&quot;, false],</span>
<a href="#l8.309"></a><span id="l8.309" class="difflineplus">+      &quot;onEnabled&quot;,</span>
<a href="#l8.310"></a><span id="l8.310" class="difflineplus">+    ],</span>
<a href="#l8.311"></a><span id="l8.311" class="difflineplus">+  });</span>
<a href="#l8.312"></a><span id="l8.312" class="difflineplus">+</span>
<a href="#l8.313"></a><span id="l8.313" class="difflineplus">+  equal(b1.operationsRequiringRestart &amp;</span>
<a href="#l8.314"></a><span id="l8.314" class="difflineplus">+               AddonManager.OP_NEEDS_RESTART_ENABLE, 0);</span>
<a href="#l8.315"></a><span id="l8.315" class="difflineplus">+  await b1.enable();</span>
<a href="#l8.316"></a><span id="l8.316" class="difflineplus">+  ensure_test_completed();</span>
<a href="#l8.317"></a><span id="l8.317" class="difflineplus">+</span>
<a href="#l8.318"></a><span id="l8.318" class="difflineplus">+  notEqual(b1, null);</span>
<a href="#l8.319"></a><span id="l8.319" class="difflineplus">+  equal(b1.version, &quot;1.0&quot;);</span>
<a href="#l8.320"></a><span id="l8.320" class="difflineplus">+  ok(!b1.appDisabled);</span>
<a href="#l8.321"></a><span id="l8.321" class="difflineplus">+  ok(!b1.userDisabled);</span>
<a href="#l8.322"></a><span id="l8.322" class="difflineplus">+  ok(b1.isActive);</span>
<a href="#l8.323"></a><span id="l8.323" class="difflineplus">+  ok(!b1.isSystem);</span>
<a href="#l8.324"></a><span id="l8.324" class="difflineplus">+  BootstrapMonitor.checkAddonInstalled(ID1, &quot;1.0&quot;);</span>
<a href="#l8.325"></a><span id="l8.325" class="difflineplus">+  BootstrapMonitor.checkAddonStarted(ID1, &quot;1.0&quot;);</span>
<a href="#l8.326"></a><span id="l8.326" class="difflineplus">+  equal(getStartupReason(), ADDON_ENABLE);</span>
<a href="#l8.327"></a><span id="l8.327" class="difflineplus">+  equal(getStartupOldVersion(), undefined);</span>
<a href="#l8.328"></a><span id="l8.328" class="difflineplus">+  do_check_in_crash_annotation(ID1, &quot;1.0&quot;);</span>
<a href="#l8.329"></a><span id="l8.329" class="difflineplus">+</span>
<a href="#l8.330"></a><span id="l8.330" class="difflineplus">+  let newb1 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l8.331"></a><span id="l8.331" class="difflineplus">+  notEqual(newb1, null);</span>
<a href="#l8.332"></a><span id="l8.332" class="difflineplus">+  equal(newb1.version, &quot;1.0&quot;);</span>
<a href="#l8.333"></a><span id="l8.333" class="difflineplus">+  ok(!newb1.appDisabled);</span>
<a href="#l8.334"></a><span id="l8.334" class="difflineplus">+  ok(!newb1.userDisabled);</span>
<a href="#l8.335"></a><span id="l8.335" class="difflineplus">+  ok(newb1.isActive);</span>
<a href="#l8.336"></a><span id="l8.336" class="difflineplus">+</span>
<a href="#l8.337"></a><span id="l8.337" class="difflineplus">+  await checkBootstrappedPref();</span>
<a href="#l8.338"></a><span id="l8.338" class="difflineplus">+});</span>
<a href="#l8.339"></a><span id="l8.339" class="difflineplus">+</span>
<a href="#l8.340"></a><span id="l8.340" class="difflineplus">+// Tests that a restart shuts down and restarts the add-on</span>
<a href="#l8.341"></a><span id="l8.341" class="difflineplus">+add_task(async function test_5() {</span>
<a href="#l8.342"></a><span id="l8.342" class="difflineplus">+  await promiseShutdownManager();</span>
<a href="#l8.343"></a><span id="l8.343" class="difflineplus">+  // By the time we've shut down, the database must have been written</span>
<a href="#l8.344"></a><span id="l8.344" class="difflineplus">+  ok(gExtensionsJSON.exists());</span>
<a href="#l8.345"></a><span id="l8.345" class="difflineplus">+</span>
<a href="#l8.346"></a><span id="l8.346" class="difflineplus">+  BootstrapMonitor.checkAddonInstalled(ID1, &quot;1.0&quot;);</span>
<a href="#l8.347"></a><span id="l8.347" class="difflineplus">+  BootstrapMonitor.checkAddonNotStarted(ID1);</span>
<a href="#l8.348"></a><span id="l8.348" class="difflineplus">+  equal(getShutdownReason(), APP_SHUTDOWN);</span>
<a href="#l8.349"></a><span id="l8.349" class="difflineplus">+  equal(getShutdownNewVersion(), undefined);</span>
<a href="#l8.350"></a><span id="l8.350" class="difflineplus">+  do_check_not_in_crash_annotation(ID1, &quot;1.0&quot;);</span>
<a href="#l8.351"></a><span id="l8.351" class="difflineplus">+  await promiseStartupManager();</span>
<a href="#l8.352"></a><span id="l8.352" class="difflineplus">+  BootstrapMonitor.checkAddonInstalled(ID1, &quot;1.0&quot;);</span>
<a href="#l8.353"></a><span id="l8.353" class="difflineplus">+  BootstrapMonitor.checkAddonStarted(ID1, &quot;1.0&quot;);</span>
<a href="#l8.354"></a><span id="l8.354" class="difflineplus">+  equal(getStartupReason(), APP_STARTUP);</span>
<a href="#l8.355"></a><span id="l8.355" class="difflineplus">+  equal(getStartupOldVersion(), undefined);</span>
<a href="#l8.356"></a><span id="l8.356" class="difflineplus">+  do_check_in_crash_annotation(ID1, &quot;1.0&quot;);</span>
<a href="#l8.357"></a><span id="l8.357" class="difflineplus">+</span>
<a href="#l8.358"></a><span id="l8.358" class="difflineplus">+  let b1 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l8.359"></a><span id="l8.359" class="difflineplus">+  notEqual(b1, null);</span>
<a href="#l8.360"></a><span id="l8.360" class="difflineplus">+  equal(b1.version, &quot;1.0&quot;);</span>
<a href="#l8.361"></a><span id="l8.361" class="difflineplus">+  ok(!b1.appDisabled);</span>
<a href="#l8.362"></a><span id="l8.362" class="difflineplus">+  ok(!b1.userDisabled);</span>
<a href="#l8.363"></a><span id="l8.363" class="difflineplus">+  ok(b1.isActive);</span>
<a href="#l8.364"></a><span id="l8.364" class="difflineplus">+  ok(!b1.isSystem);</span>
<a href="#l8.365"></a><span id="l8.365" class="difflineplus">+</span>
<a href="#l8.366"></a><span id="l8.366" class="difflineplus">+  await checkBootstrappedPref();</span>
<a href="#l8.367"></a><span id="l8.367" class="difflineplus">+});</span>
<a href="#l8.368"></a><span id="l8.368" class="difflineplus">+</span>
<a href="#l8.369"></a><span id="l8.369" class="difflineplus">+// Tests that installing an upgrade doesn't require a restart</span>
<a href="#l8.370"></a><span id="l8.370" class="difflineplus">+add_task(async function test_6() {</span>
<a href="#l8.371"></a><span id="l8.371" class="difflineplus">+  prepare_test({}, [</span>
<a href="#l8.372"></a><span id="l8.372" class="difflineplus">+    &quot;onNewInstall&quot;,</span>
<a href="#l8.373"></a><span id="l8.373" class="difflineplus">+  ]);</span>
<a href="#l8.374"></a><span id="l8.374" class="difflineplus">+</span>
<a href="#l8.375"></a><span id="l8.375" class="difflineplus">+  let install = await AddonManager.getInstallForFile(XPIS.test_bootstrap1_2);</span>
<a href="#l8.376"></a><span id="l8.376" class="difflineplus">+  ensure_test_completed();</span>
<a href="#l8.377"></a><span id="l8.377" class="difflineplus">+</span>
<a href="#l8.378"></a><span id="l8.378" class="difflineplus">+  notEqual(install, null);</span>
<a href="#l8.379"></a><span id="l8.379" class="difflineplus">+  equal(install.type, &quot;extension&quot;);</span>
<a href="#l8.380"></a><span id="l8.380" class="difflineplus">+  equal(install.version, &quot;2.0&quot;);</span>
<a href="#l8.381"></a><span id="l8.381" class="difflineplus">+  equal(install.name, &quot;Test Bootstrap 1&quot;);</span>
<a href="#l8.382"></a><span id="l8.382" class="difflineplus">+  equal(install.state, AddonManager.STATE_DOWNLOADED);</span>
<a href="#l8.383"></a><span id="l8.383" class="difflineplus">+</span>
<a href="#l8.384"></a><span id="l8.384" class="difflineplus">+  await Promise.all([</span>
<a href="#l8.385"></a><span id="l8.385" class="difflineplus">+    BootstrapMonitor.promiseAddonStartup(ID1),</span>
<a href="#l8.386"></a><span id="l8.386" class="difflineplus">+    new Promise(resolve =&gt; {</span>
<a href="#l8.387"></a><span id="l8.387" class="difflineplus">+      prepare_test({</span>
<a href="#l8.388"></a><span id="l8.388" class="difflineplus">+        [ID1]: [</span>
<a href="#l8.389"></a><span id="l8.389" class="difflineplus">+          [&quot;onInstalling&quot;, false],</span>
<a href="#l8.390"></a><span id="l8.390" class="difflineplus">+          &quot;onInstalled&quot;,</span>
<a href="#l8.391"></a><span id="l8.391" class="difflineplus">+        ],</span>
<a href="#l8.392"></a><span id="l8.392" class="difflineplus">+      }, [</span>
<a href="#l8.393"></a><span id="l8.393" class="difflineplus">+        &quot;onInstallStarted&quot;,</span>
<a href="#l8.394"></a><span id="l8.394" class="difflineplus">+        &quot;onInstallEnded&quot;,</span>
<a href="#l8.395"></a><span id="l8.395" class="difflineplus">+      ], resolve);</span>
<a href="#l8.396"></a><span id="l8.396" class="difflineplus">+      install.install();</span>
<a href="#l8.397"></a><span id="l8.397" class="difflineplus">+    }),</span>
<a href="#l8.398"></a><span id="l8.398" class="difflineplus">+  ]);</span>
<a href="#l8.399"></a><span id="l8.399" class="difflineplus">+</span>
<a href="#l8.400"></a><span id="l8.400" class="difflineplus">+  let b1 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l8.401"></a><span id="l8.401" class="difflineplus">+  notEqual(b1, null);</span>
<a href="#l8.402"></a><span id="l8.402" class="difflineplus">+  equal(b1.version, &quot;2.0&quot;);</span>
<a href="#l8.403"></a><span id="l8.403" class="difflineplus">+  ok(!b1.appDisabled);</span>
<a href="#l8.404"></a><span id="l8.404" class="difflineplus">+  ok(!b1.userDisabled);</span>
<a href="#l8.405"></a><span id="l8.405" class="difflineplus">+  ok(b1.isActive);</span>
<a href="#l8.406"></a><span id="l8.406" class="difflineplus">+  ok(!b1.isSystem);</span>
<a href="#l8.407"></a><span id="l8.407" class="difflineplus">+  BootstrapMonitor.checkAddonInstalled(ID1, &quot;2.0&quot;);</span>
<a href="#l8.408"></a><span id="l8.408" class="difflineplus">+  BootstrapMonitor.checkAddonStarted(ID1, &quot;2.0&quot;);</span>
<a href="#l8.409"></a><span id="l8.409" class="difflineplus">+  equal(getStartupReason(), ADDON_UPGRADE);</span>
<a href="#l8.410"></a><span id="l8.410" class="difflineplus">+  equal(getInstallOldVersion(), 1);</span>
<a href="#l8.411"></a><span id="l8.411" class="difflineplus">+  equal(getStartupOldVersion(), 1);</span>
<a href="#l8.412"></a><span id="l8.412" class="difflineplus">+  equal(getShutdownReason(), ADDON_UPGRADE);</span>
<a href="#l8.413"></a><span id="l8.413" class="difflineplus">+  equal(getShutdownNewVersion(), 2);</span>
<a href="#l8.414"></a><span id="l8.414" class="difflineplus">+  equal(getUninstallNewVersion(), 2);</span>
<a href="#l8.415"></a><span id="l8.415" class="difflineplus">+  do_check_not_in_crash_annotation(ID1, &quot;1.0&quot;);</span>
<a href="#l8.416"></a><span id="l8.416" class="difflineplus">+  do_check_in_crash_annotation(ID1, &quot;2.0&quot;);</span>
<a href="#l8.417"></a><span id="l8.417" class="difflineplus">+</span>
<a href="#l8.418"></a><span id="l8.418" class="difflineplus">+  await checkBootstrappedPref();</span>
<a href="#l8.419"></a><span id="l8.419" class="difflineplus">+});</span>
<a href="#l8.420"></a><span id="l8.420" class="difflineplus">+</span>
<a href="#l8.421"></a><span id="l8.421" class="difflineplus">+// Tests that uninstalling doesn't require a restart</span>
<a href="#l8.422"></a><span id="l8.422" class="difflineplus">+add_task(async function test_7() {</span>
<a href="#l8.423"></a><span id="l8.423" class="difflineplus">+  let b1 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l8.424"></a><span id="l8.424" class="difflineplus">+  prepare_test({</span>
<a href="#l8.425"></a><span id="l8.425" class="difflineplus">+    [ID1]: [</span>
<a href="#l8.426"></a><span id="l8.426" class="difflineplus">+      [&quot;onUninstalling&quot;, false],</span>
<a href="#l8.427"></a><span id="l8.427" class="difflineplus">+      &quot;onUninstalled&quot;,</span>
<a href="#l8.428"></a><span id="l8.428" class="difflineplus">+    ],</span>
<a href="#l8.429"></a><span id="l8.429" class="difflineplus">+  });</span>
<a href="#l8.430"></a><span id="l8.430" class="difflineplus">+</span>
<a href="#l8.431"></a><span id="l8.431" class="difflineplus">+  equal(b1.operationsRequiringRestart &amp;</span>
<a href="#l8.432"></a><span id="l8.432" class="difflineplus">+        AddonManager.OP_NEEDS_RESTART_UNINSTALL, 0);</span>
<a href="#l8.433"></a><span id="l8.433" class="difflineplus">+  await b1.uninstall();</span>
<a href="#l8.434"></a><span id="l8.434" class="difflineplus">+</span>
<a href="#l8.435"></a><span id="l8.435" class="difflineplus">+  await checkBootstrappedPref();</span>
<a href="#l8.436"></a><span id="l8.436" class="difflineplus">+</span>
<a href="#l8.437"></a><span id="l8.437" class="difflineplus">+  ensure_test_completed();</span>
<a href="#l8.438"></a><span id="l8.438" class="difflineplus">+  BootstrapMonitor.checkAddonNotInstalled(ID1);</span>
<a href="#l8.439"></a><span id="l8.439" class="difflineplus">+  BootstrapMonitor.checkAddonNotStarted(ID1);</span>
<a href="#l8.440"></a><span id="l8.440" class="difflineplus">+  equal(getShutdownReason(), ADDON_UNINSTALL);</span>
<a href="#l8.441"></a><span id="l8.441" class="difflineplus">+  equal(getShutdownNewVersion(), undefined);</span>
<a href="#l8.442"></a><span id="l8.442" class="difflineplus">+  do_check_not_in_crash_annotation(ID1, &quot;2.0&quot;);</span>
<a href="#l8.443"></a><span id="l8.443" class="difflineplus">+</span>
<a href="#l8.444"></a><span id="l8.444" class="difflineplus">+  b1 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l8.445"></a><span id="l8.445" class="difflineplus">+  equal(b1, null);</span>
<a href="#l8.446"></a><span id="l8.446" class="difflineplus">+</span>
<a href="#l8.447"></a><span id="l8.447" class="difflineplus">+  await promiseRestartManager();</span>
<a href="#l8.448"></a><span id="l8.448" class="difflineplus">+</span>
<a href="#l8.449"></a><span id="l8.449" class="difflineplus">+  let newb1 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l8.450"></a><span id="l8.450" class="difflineplus">+  equal(newb1, null);</span>
<a href="#l8.451"></a><span id="l8.451" class="difflineplus">+</span>
<a href="#l8.452"></a><span id="l8.452" class="difflineplus">+  await checkBootstrappedPref();</span>
<a href="#l8.453"></a><span id="l8.453" class="difflineplus">+});</span>
<a href="#l8.454"></a><span id="l8.454" class="difflineplus">+</span>
<a href="#l8.455"></a><span id="l8.455" class="difflineplus">+// Test that a bootstrapped extension dropped into the profile loads properly</span>
<a href="#l8.456"></a><span id="l8.456" class="difflineplus">+// on startup and doesn't cause an EM restart</span>
<a href="#l8.457"></a><span id="l8.457" class="difflineplus">+add_task(async function test_8() {</span>
<a href="#l8.458"></a><span id="l8.458" class="difflineplus">+  await promiseShutdownManager();</span>
<a href="#l8.459"></a><span id="l8.459" class="difflineplus">+</span>
<a href="#l8.460"></a><span id="l8.460" class="difflineplus">+  await manuallyInstall(XPIS.test_bootstrap1_1, profileDir, ID1);</span>
<a href="#l8.461"></a><span id="l8.461" class="difflineplus">+</span>
<a href="#l8.462"></a><span id="l8.462" class="difflineplus">+  await promiseStartupManager();</span>
<a href="#l8.463"></a><span id="l8.463" class="difflineplus">+</span>
<a href="#l8.464"></a><span id="l8.464" class="difflineplus">+  let b1 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l8.465"></a><span id="l8.465" class="difflineplus">+  notEqual(b1, null);</span>
<a href="#l8.466"></a><span id="l8.466" class="difflineplus">+  equal(b1.version, &quot;1.0&quot;);</span>
<a href="#l8.467"></a><span id="l8.467" class="difflineplus">+  ok(!b1.appDisabled);</span>
<a href="#l8.468"></a><span id="l8.468" class="difflineplus">+  ok(!b1.userDisabled);</span>
<a href="#l8.469"></a><span id="l8.469" class="difflineplus">+  ok(b1.isActive);</span>
<a href="#l8.470"></a><span id="l8.470" class="difflineplus">+  ok(!b1.isSystem);</span>
<a href="#l8.471"></a><span id="l8.471" class="difflineplus">+  BootstrapMonitor.checkAddonInstalled(ID1, &quot;1.0&quot;);</span>
<a href="#l8.472"></a><span id="l8.472" class="difflineplus">+  BootstrapMonitor.checkAddonStarted(ID1, &quot;1.0&quot;);</span>
<a href="#l8.473"></a><span id="l8.473" class="difflineplus">+  equal(getStartupReason(), ADDON_INSTALL);</span>
<a href="#l8.474"></a><span id="l8.474" class="difflineplus">+  equal(getStartupOldVersion(), undefined);</span>
<a href="#l8.475"></a><span id="l8.475" class="difflineplus">+  do_check_in_crash_annotation(ID1, &quot;1.0&quot;);</span>
<a href="#l8.476"></a><span id="l8.476" class="difflineplus">+</span>
<a href="#l8.477"></a><span id="l8.477" class="difflineplus">+  await checkBootstrappedPref();</span>
<a href="#l8.478"></a><span id="l8.478" class="difflineplus">+});</span>
<a href="#l8.479"></a><span id="l8.479" class="difflineplus">+</span>
<a href="#l8.480"></a><span id="l8.480" class="difflineplus">+// Test that items detected as removed during startup get removed properly</span>
<a href="#l8.481"></a><span id="l8.481" class="difflineplus">+add_task(async function test_9() {</span>
<a href="#l8.482"></a><span id="l8.482" class="difflineplus">+  await promiseShutdownManager();</span>
<a href="#l8.483"></a><span id="l8.483" class="difflineplus">+</span>
<a href="#l8.484"></a><span id="l8.484" class="difflineplus">+  manuallyUninstall(profileDir, ID1);</span>
<a href="#l8.485"></a><span id="l8.485" class="difflineplus">+  BootstrapMonitor.clear(ID1);</span>
<a href="#l8.486"></a><span id="l8.486" class="difflineplus">+</span>
<a href="#l8.487"></a><span id="l8.487" class="difflineplus">+  await promiseStartupManager();</span>
<a href="#l8.488"></a><span id="l8.488" class="difflineplus">+</span>
<a href="#l8.489"></a><span id="l8.489" class="difflineplus">+  let b1 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l8.490"></a><span id="l8.490" class="difflineplus">+  equal(b1, null);</span>
<a href="#l8.491"></a><span id="l8.491" class="difflineplus">+  do_check_not_in_crash_annotation(ID1, &quot;1.0&quot;);</span>
<a href="#l8.492"></a><span id="l8.492" class="difflineplus">+</span>
<a href="#l8.493"></a><span id="l8.493" class="difflineplus">+  await checkBootstrappedPref();</span>
<a href="#l8.494"></a><span id="l8.494" class="difflineplus">+});</span>
<a href="#l8.495"></a><span id="l8.495" class="difflineplus">+</span>
<a href="#l8.496"></a><span id="l8.496" class="difflineplus">+</span>
<a href="#l8.497"></a><span id="l8.497" class="difflineplus">+// Tests that installing a downgrade sends the right reason</span>
<a href="#l8.498"></a><span id="l8.498" class="difflineplus">+add_task(async function test_10() {</span>
<a href="#l8.499"></a><span id="l8.499" class="difflineplus">+  prepare_test({}, [</span>
<a href="#l8.500"></a><span id="l8.500" class="difflineplus">+    &quot;onNewInstall&quot;,</span>
<a href="#l8.501"></a><span id="l8.501" class="difflineplus">+  ]);</span>
<a href="#l8.502"></a><span id="l8.502" class="difflineplus">+</span>
<a href="#l8.503"></a><span id="l8.503" class="difflineplus">+  let install = await AddonManager.getInstallForFile(XPIS.test_bootstrap1_2);</span>
<a href="#l8.504"></a><span id="l8.504" class="difflineplus">+  ensure_test_completed();</span>
<a href="#l8.505"></a><span id="l8.505" class="difflineplus">+</span>
<a href="#l8.506"></a><span id="l8.506" class="difflineplus">+  notEqual(install, null);</span>
<a href="#l8.507"></a><span id="l8.507" class="difflineplus">+  equal(install.type, &quot;extension&quot;);</span>
<a href="#l8.508"></a><span id="l8.508" class="difflineplus">+  equal(install.version, &quot;2.0&quot;);</span>
<a href="#l8.509"></a><span id="l8.509" class="difflineplus">+  equal(install.name, &quot;Test Bootstrap 1&quot;);</span>
<a href="#l8.510"></a><span id="l8.510" class="difflineplus">+  equal(install.state, AddonManager.STATE_DOWNLOADED);</span>
<a href="#l8.511"></a><span id="l8.511" class="difflineplus">+  do_check_not_in_crash_annotation(ID1, &quot;2.0&quot;);</span>
<a href="#l8.512"></a><span id="l8.512" class="difflineplus">+</span>
<a href="#l8.513"></a><span id="l8.513" class="difflineplus">+  await Promise.all([</span>
<a href="#l8.514"></a><span id="l8.514" class="difflineplus">+    BootstrapMonitor.promiseAddonStartup(ID1),</span>
<a href="#l8.515"></a><span id="l8.515" class="difflineplus">+    new Promise(resolve =&gt; {</span>
<a href="#l8.516"></a><span id="l8.516" class="difflineplus">+      prepare_test({</span>
<a href="#l8.517"></a><span id="l8.517" class="difflineplus">+        [ID1]: [</span>
<a href="#l8.518"></a><span id="l8.518" class="difflineplus">+          [&quot;onInstalling&quot;, false],</span>
<a href="#l8.519"></a><span id="l8.519" class="difflineplus">+          &quot;onInstalled&quot;,</span>
<a href="#l8.520"></a><span id="l8.520" class="difflineplus">+        ],</span>
<a href="#l8.521"></a><span id="l8.521" class="difflineplus">+      }, [</span>
<a href="#l8.522"></a><span id="l8.522" class="difflineplus">+        &quot;onInstallStarted&quot;,</span>
<a href="#l8.523"></a><span id="l8.523" class="difflineplus">+        &quot;onInstallEnded&quot;,</span>
<a href="#l8.524"></a><span id="l8.524" class="difflineplus">+      ], resolve);</span>
<a href="#l8.525"></a><span id="l8.525" class="difflineplus">+      install.install();</span>
<a href="#l8.526"></a><span id="l8.526" class="difflineplus">+    }),</span>
<a href="#l8.527"></a><span id="l8.527" class="difflineplus">+  ]);</span>
<a href="#l8.528"></a><span id="l8.528" class="difflineplus">+</span>
<a href="#l8.529"></a><span id="l8.529" class="difflineplus">+</span>
<a href="#l8.530"></a><span id="l8.530" class="difflineplus">+  let b1 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l8.531"></a><span id="l8.531" class="difflineplus">+  notEqual(b1, null);</span>
<a href="#l8.532"></a><span id="l8.532" class="difflineplus">+  equal(b1.version, &quot;2.0&quot;);</span>
<a href="#l8.533"></a><span id="l8.533" class="difflineplus">+  ok(!b1.appDisabled);</span>
<a href="#l8.534"></a><span id="l8.534" class="difflineplus">+  ok(!b1.userDisabled);</span>
<a href="#l8.535"></a><span id="l8.535" class="difflineplus">+  ok(b1.isActive);</span>
<a href="#l8.536"></a><span id="l8.536" class="difflineplus">+  ok(!b1.isSystem);</span>
<a href="#l8.537"></a><span id="l8.537" class="difflineplus">+  BootstrapMonitor.checkAddonInstalled(ID1, &quot;2.0&quot;);</span>
<a href="#l8.538"></a><span id="l8.538" class="difflineplus">+  BootstrapMonitor.checkAddonStarted(ID1, &quot;2.0&quot;);</span>
<a href="#l8.539"></a><span id="l8.539" class="difflineplus">+  equal(getStartupReason(), ADDON_INSTALL);</span>
<a href="#l8.540"></a><span id="l8.540" class="difflineplus">+  equal(getStartupOldVersion(), undefined);</span>
<a href="#l8.541"></a><span id="l8.541" class="difflineplus">+  do_check_in_crash_annotation(ID1, &quot;2.0&quot;);</span>
<a href="#l8.542"></a><span id="l8.542" class="difflineplus">+</span>
<a href="#l8.543"></a><span id="l8.543" class="difflineplus">+  prepare_test({}, [</span>
<a href="#l8.544"></a><span id="l8.544" class="difflineplus">+    &quot;onNewInstall&quot;,</span>
<a href="#l8.545"></a><span id="l8.545" class="difflineplus">+  ]);</span>
<a href="#l8.546"></a><span id="l8.546" class="difflineplus">+</span>
<a href="#l8.547"></a><span id="l8.547" class="difflineplus">+  install = await AddonManager.getInstallForFile(XPIS.test_bootstrap1_1);</span>
<a href="#l8.548"></a><span id="l8.548" class="difflineplus">+  ensure_test_completed();</span>
<a href="#l8.549"></a><span id="l8.549" class="difflineplus">+</span>
<a href="#l8.550"></a><span id="l8.550" class="difflineplus">+  notEqual(install, null);</span>
<a href="#l8.551"></a><span id="l8.551" class="difflineplus">+  equal(install.type, &quot;extension&quot;);</span>
<a href="#l8.552"></a><span id="l8.552" class="difflineplus">+  equal(install.version, &quot;1.0&quot;);</span>
<a href="#l8.553"></a><span id="l8.553" class="difflineplus">+  equal(install.name, &quot;Test Bootstrap 1&quot;);</span>
<a href="#l8.554"></a><span id="l8.554" class="difflineplus">+  equal(install.state, AddonManager.STATE_DOWNLOADED);</span>
<a href="#l8.555"></a><span id="l8.555" class="difflineplus">+</span>
<a href="#l8.556"></a><span id="l8.556" class="difflineplus">+  await Promise.all([</span>
<a href="#l8.557"></a><span id="l8.557" class="difflineplus">+    BootstrapMonitor.promiseAddonStartup(ID1),</span>
<a href="#l8.558"></a><span id="l8.558" class="difflineplus">+    new Promise(resolve =&gt; {</span>
<a href="#l8.559"></a><span id="l8.559" class="difflineplus">+      prepare_test({</span>
<a href="#l8.560"></a><span id="l8.560" class="difflineplus">+        [ID1]: [</span>
<a href="#l8.561"></a><span id="l8.561" class="difflineplus">+          [&quot;onInstalling&quot;, false],</span>
<a href="#l8.562"></a><span id="l8.562" class="difflineplus">+          &quot;onInstalled&quot;,</span>
<a href="#l8.563"></a><span id="l8.563" class="difflineplus">+        ],</span>
<a href="#l8.564"></a><span id="l8.564" class="difflineplus">+      }, [</span>
<a href="#l8.565"></a><span id="l8.565" class="difflineplus">+        &quot;onInstallStarted&quot;,</span>
<a href="#l8.566"></a><span id="l8.566" class="difflineplus">+        &quot;onInstallEnded&quot;,</span>
<a href="#l8.567"></a><span id="l8.567" class="difflineplus">+      ], resolve);</span>
<a href="#l8.568"></a><span id="l8.568" class="difflineplus">+      install.install();</span>
<a href="#l8.569"></a><span id="l8.569" class="difflineplus">+    }),</span>
<a href="#l8.570"></a><span id="l8.570" class="difflineplus">+  ]);</span>
<a href="#l8.571"></a><span id="l8.571" class="difflineplus">+</span>
<a href="#l8.572"></a><span id="l8.572" class="difflineplus">+  b1 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l8.573"></a><span id="l8.573" class="difflineplus">+  notEqual(b1, null);</span>
<a href="#l8.574"></a><span id="l8.574" class="difflineplus">+  equal(b1.version, &quot;1.0&quot;);</span>
<a href="#l8.575"></a><span id="l8.575" class="difflineplus">+  ok(!b1.appDisabled);</span>
<a href="#l8.576"></a><span id="l8.576" class="difflineplus">+  ok(!b1.userDisabled);</span>
<a href="#l8.577"></a><span id="l8.577" class="difflineplus">+  ok(b1.isActive);</span>
<a href="#l8.578"></a><span id="l8.578" class="difflineplus">+  ok(!b1.isSystem);</span>
<a href="#l8.579"></a><span id="l8.579" class="difflineplus">+  BootstrapMonitor.checkAddonInstalled(ID1, &quot;1.0&quot;);</span>
<a href="#l8.580"></a><span id="l8.580" class="difflineplus">+  BootstrapMonitor.checkAddonStarted(ID1, &quot;1.0&quot;);</span>
<a href="#l8.581"></a><span id="l8.581" class="difflineplus">+  equal(getStartupReason(), ADDON_DOWNGRADE);</span>
<a href="#l8.582"></a><span id="l8.582" class="difflineplus">+  equal(getInstallOldVersion(), 2);</span>
<a href="#l8.583"></a><span id="l8.583" class="difflineplus">+  equal(getStartupOldVersion(), 2);</span>
<a href="#l8.584"></a><span id="l8.584" class="difflineplus">+  equal(getShutdownReason(), ADDON_DOWNGRADE);</span>
<a href="#l8.585"></a><span id="l8.585" class="difflineplus">+  equal(getShutdownNewVersion(), 1);</span>
<a href="#l8.586"></a><span id="l8.586" class="difflineplus">+  equal(getUninstallNewVersion(), 1);</span>
<a href="#l8.587"></a><span id="l8.587" class="difflineplus">+  do_check_in_crash_annotation(ID1, &quot;1.0&quot;);</span>
<a href="#l8.588"></a><span id="l8.588" class="difflineplus">+  do_check_not_in_crash_annotation(ID1, &quot;2.0&quot;);</span>
<a href="#l8.589"></a><span id="l8.589" class="difflineplus">+</span>
<a href="#l8.590"></a><span id="l8.590" class="difflineplus">+  await checkBootstrappedPref();</span>
<a href="#l8.591"></a><span id="l8.591" class="difflineplus">+});</span>
<a href="#l8.592"></a><span id="l8.592" class="difflineplus">+</span>
<a href="#l8.593"></a><span id="l8.593" class="difflineplus">+// Tests that uninstalling a disabled add-on still calls the uninstall method</span>
<a href="#l8.594"></a><span id="l8.594" class="difflineplus">+add_task(async function test_11() {</span>
<a href="#l8.595"></a><span id="l8.595" class="difflineplus">+  let b1 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l8.596"></a><span id="l8.596" class="difflineplus">+  prepare_test({</span>
<a href="#l8.597"></a><span id="l8.597" class="difflineplus">+    [ID1]: [</span>
<a href="#l8.598"></a><span id="l8.598" class="difflineplus">+      [&quot;onDisabling&quot;, false],</span>
<a href="#l8.599"></a><span id="l8.599" class="difflineplus">+      &quot;onDisabled&quot;,</span>
<a href="#l8.600"></a><span id="l8.600" class="difflineplus">+      [&quot;onUninstalling&quot;, false],</span>
<a href="#l8.601"></a><span id="l8.601" class="difflineplus">+      &quot;onUninstalled&quot;,</span>
<a href="#l8.602"></a><span id="l8.602" class="difflineplus">+    ],</span>
<a href="#l8.603"></a><span id="l8.603" class="difflineplus">+  });</span>
<a href="#l8.604"></a><span id="l8.604" class="difflineplus">+</span>
<a href="#l8.605"></a><span id="l8.605" class="difflineplus">+  await b1.disable();</span>
<a href="#l8.606"></a><span id="l8.606" class="difflineplus">+</span>
<a href="#l8.607"></a><span id="l8.607" class="difflineplus">+  BootstrapMonitor.checkAddonInstalled(ID1, &quot;1.0&quot;);</span>
<a href="#l8.608"></a><span id="l8.608" class="difflineplus">+  BootstrapMonitor.checkAddonNotStarted(ID1);</span>
<a href="#l8.609"></a><span id="l8.609" class="difflineplus">+  equal(getShutdownReason(), ADDON_DISABLE);</span>
<a href="#l8.610"></a><span id="l8.610" class="difflineplus">+  equal(getShutdownNewVersion(), undefined);</span>
<a href="#l8.611"></a><span id="l8.611" class="difflineplus">+  do_check_not_in_crash_annotation(ID1, &quot;1.0&quot;);</span>
<a href="#l8.612"></a><span id="l8.612" class="difflineplus">+</span>
<a href="#l8.613"></a><span id="l8.613" class="difflineplus">+  await b1.uninstall();</span>
<a href="#l8.614"></a><span id="l8.614" class="difflineplus">+</span>
<a href="#l8.615"></a><span id="l8.615" class="difflineplus">+  ensure_test_completed();</span>
<a href="#l8.616"></a><span id="l8.616" class="difflineplus">+  BootstrapMonitor.checkAddonNotInstalled(ID1);</span>
<a href="#l8.617"></a><span id="l8.617" class="difflineplus">+  BootstrapMonitor.checkAddonNotStarted(ID1);</span>
<a href="#l8.618"></a><span id="l8.618" class="difflineplus">+  do_check_not_in_crash_annotation(ID1, &quot;1.0&quot;);</span>
<a href="#l8.619"></a><span id="l8.619" class="difflineplus">+</span>
<a href="#l8.620"></a><span id="l8.620" class="difflineplus">+  await checkBootstrappedPref();</span>
<a href="#l8.621"></a><span id="l8.621" class="difflineplus">+});</span>
<a href="#l8.622"></a><span id="l8.622" class="difflineplus">+</span>
<a href="#l8.623"></a><span id="l8.623" class="difflineplus">+// Tests that bootstrapped extensions are correctly loaded even if the app is</span>
<a href="#l8.624"></a><span id="l8.624" class="difflineplus">+// upgraded at the same time</span>
<a href="#l8.625"></a><span id="l8.625" class="difflineplus">+add_task(async function test_12() {</span>
<a href="#l8.626"></a><span id="l8.626" class="difflineplus">+  await promiseShutdownManager();</span>
<a href="#l8.627"></a><span id="l8.627" class="difflineplus">+</span>
<a href="#l8.628"></a><span id="l8.628" class="difflineplus">+  await manuallyInstall(XPIS.test_bootstrap1_1, profileDir, ID1);</span>
<a href="#l8.629"></a><span id="l8.629" class="difflineplus">+</span>
<a href="#l8.630"></a><span id="l8.630" class="difflineplus">+  await promiseStartupManager();</span>
<a href="#l8.631"></a><span id="l8.631" class="difflineplus">+</span>
<a href="#l8.632"></a><span id="l8.632" class="difflineplus">+  let b1 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l8.633"></a><span id="l8.633" class="difflineplus">+  notEqual(b1, null);</span>
<a href="#l8.634"></a><span id="l8.634" class="difflineplus">+  equal(b1.version, &quot;1.0&quot;);</span>
<a href="#l8.635"></a><span id="l8.635" class="difflineplus">+  ok(!b1.appDisabled);</span>
<a href="#l8.636"></a><span id="l8.636" class="difflineplus">+  ok(!b1.userDisabled);</span>
<a href="#l8.637"></a><span id="l8.637" class="difflineplus">+  ok(b1.isActive);</span>
<a href="#l8.638"></a><span id="l8.638" class="difflineplus">+  ok(!b1.isSystem);</span>
<a href="#l8.639"></a><span id="l8.639" class="difflineplus">+  BootstrapMonitor.checkAddonInstalled(ID1, &quot;1.0&quot;);</span>
<a href="#l8.640"></a><span id="l8.640" class="difflineplus">+  BootstrapMonitor.checkAddonStarted(ID1, &quot;1.0&quot;);</span>
<a href="#l8.641"></a><span id="l8.641" class="difflineplus">+  equal(getStartupReason(), ADDON_INSTALL);</span>
<a href="#l8.642"></a><span id="l8.642" class="difflineplus">+  equal(getStartupOldVersion(), undefined);</span>
<a href="#l8.643"></a><span id="l8.643" class="difflineplus">+  do_check_in_crash_annotation(ID1, &quot;1.0&quot;);</span>
<a href="#l8.644"></a><span id="l8.644" class="difflineplus">+</span>
<a href="#l8.645"></a><span id="l8.645" class="difflineplus">+  await b1.uninstall();</span>
<a href="#l8.646"></a><span id="l8.646" class="difflineplus">+</span>
<a href="#l8.647"></a><span id="l8.647" class="difflineplus">+  await promiseRestartManager();</span>
<a href="#l8.648"></a><span id="l8.648" class="difflineplus">+  await checkBootstrappedPref();</span>
<a href="#l8.649"></a><span id="l8.649" class="difflineplus">+});</span>
<a href="#l8.650"></a><span id="l8.650" class="difflineplus">+</span>
<a href="#l8.651"></a><span id="l8.651" class="difflineplus">+</span>
<a href="#l8.652"></a><span id="l8.652" class="difflineplus">+// Tests that installing a bootstrapped extension with an invalid application</span>
<a href="#l8.653"></a><span id="l8.653" class="difflineplus">+// entry doesn't call it's startup method</span>
<a href="#l8.654"></a><span id="l8.654" class="difflineplus">+add_task(async function test_13() {</span>
<a href="#l8.655"></a><span id="l8.655" class="difflineplus">+  prepare_test({}, [</span>
<a href="#l8.656"></a><span id="l8.656" class="difflineplus">+    &quot;onNewInstall&quot;,</span>
<a href="#l8.657"></a><span id="l8.657" class="difflineplus">+  ]);</span>
<a href="#l8.658"></a><span id="l8.658" class="difflineplus">+</span>
<a href="#l8.659"></a><span id="l8.659" class="difflineplus">+  let install = await AddonManager.getInstallForFile(XPIS.test_bootstrap1_3);</span>
<a href="#l8.660"></a><span id="l8.660" class="difflineplus">+  ensure_test_completed();</span>
<a href="#l8.661"></a><span id="l8.661" class="difflineplus">+</span>
<a href="#l8.662"></a><span id="l8.662" class="difflineplus">+  notEqual(install, null);</span>
<a href="#l8.663"></a><span id="l8.663" class="difflineplus">+  equal(install.type, &quot;extension&quot;);</span>
<a href="#l8.664"></a><span id="l8.664" class="difflineplus">+  equal(install.version, &quot;3.0&quot;);</span>
<a href="#l8.665"></a><span id="l8.665" class="difflineplus">+  equal(install.name, &quot;Test Bootstrap 1&quot;);</span>
<a href="#l8.666"></a><span id="l8.666" class="difflineplus">+  equal(install.state, AddonManager.STATE_DOWNLOADED);</span>
<a href="#l8.667"></a><span id="l8.667" class="difflineplus">+  do_check_not_in_crash_annotation(ID1, &quot;3.0&quot;);</span>
<a href="#l8.668"></a><span id="l8.668" class="difflineplus">+</span>
<a href="#l8.669"></a><span id="l8.669" class="difflineplus">+  await new Promise(resolve =&gt; {</span>
<a href="#l8.670"></a><span id="l8.670" class="difflineplus">+    prepare_test({</span>
<a href="#l8.671"></a><span id="l8.671" class="difflineplus">+      [ID1]: [</span>
<a href="#l8.672"></a><span id="l8.672" class="difflineplus">+        [&quot;onInstalling&quot;, false],</span>
<a href="#l8.673"></a><span id="l8.673" class="difflineplus">+        &quot;onInstalled&quot;,</span>
<a href="#l8.674"></a><span id="l8.674" class="difflineplus">+      ],</span>
<a href="#l8.675"></a><span id="l8.675" class="difflineplus">+    }, [</span>
<a href="#l8.676"></a><span id="l8.676" class="difflineplus">+      &quot;onInstallStarted&quot;,</span>
<a href="#l8.677"></a><span id="l8.677" class="difflineplus">+      &quot;onInstallEnded&quot;,</span>
<a href="#l8.678"></a><span id="l8.678" class="difflineplus">+    ], resolve);</span>
<a href="#l8.679"></a><span id="l8.679" class="difflineplus">+    install.install();</span>
<a href="#l8.680"></a><span id="l8.680" class="difflineplus">+  });</span>
<a href="#l8.681"></a><span id="l8.681" class="difflineplus">+</span>
<a href="#l8.682"></a><span id="l8.682" class="difflineplus">+  let installs = await AddonManager.getAllInstalls();</span>
<a href="#l8.683"></a><span id="l8.683" class="difflineplus">+</span>
<a href="#l8.684"></a><span id="l8.684" class="difflineplus">+  // There should be no active installs now since the install completed and</span>
<a href="#l8.685"></a><span id="l8.685" class="difflineplus">+  // doesn't require a restart.</span>
<a href="#l8.686"></a><span id="l8.686" class="difflineplus">+  equal(installs.length, 0);</span>
<a href="#l8.687"></a><span id="l8.687" class="difflineplus">+</span>
<a href="#l8.688"></a><span id="l8.688" class="difflineplus">+  let b1 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l8.689"></a><span id="l8.689" class="difflineplus">+  notEqual(b1, null);</span>
<a href="#l8.690"></a><span id="l8.690" class="difflineplus">+  equal(b1.version, &quot;3.0&quot;);</span>
<a href="#l8.691"></a><span id="l8.691" class="difflineplus">+  ok(b1.appDisabled);</span>
<a href="#l8.692"></a><span id="l8.692" class="difflineplus">+  ok(!b1.userDisabled);</span>
<a href="#l8.693"></a><span id="l8.693" class="difflineplus">+  ok(!b1.isActive);</span>
<a href="#l8.694"></a><span id="l8.694" class="difflineplus">+  BootstrapMonitor.checkAddonInstalled(ID1, &quot;3.0&quot;); // We call install even for disabled add-ons</span>
<a href="#l8.695"></a><span id="l8.695" class="difflineplus">+  BootstrapMonitor.checkAddonNotStarted(ID1); // Should not have called startup though</span>
<a href="#l8.696"></a><span id="l8.696" class="difflineplus">+  do_check_not_in_crash_annotation(ID1, &quot;3.0&quot;);</span>
<a href="#l8.697"></a><span id="l8.697" class="difflineplus">+</span>
<a href="#l8.698"></a><span id="l8.698" class="difflineplus">+  await promiseRestartManager();</span>
<a href="#l8.699"></a><span id="l8.699" class="difflineplus">+</span>
<a href="#l8.700"></a><span id="l8.700" class="difflineplus">+  b1 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l8.701"></a><span id="l8.701" class="difflineplus">+  notEqual(b1, null);</span>
<a href="#l8.702"></a><span id="l8.702" class="difflineplus">+  equal(b1.version, &quot;3.0&quot;);</span>
<a href="#l8.703"></a><span id="l8.703" class="difflineplus">+  ok(b1.appDisabled);</span>
<a href="#l8.704"></a><span id="l8.704" class="difflineplus">+  ok(!b1.userDisabled);</span>
<a href="#l8.705"></a><span id="l8.705" class="difflineplus">+  ok(!b1.isActive);</span>
<a href="#l8.706"></a><span id="l8.706" class="difflineplus">+  BootstrapMonitor.checkAddonInstalled(ID1, &quot;3.0&quot;); // We call install even for disabled add-ons</span>
<a href="#l8.707"></a><span id="l8.707" class="difflineplus">+  BootstrapMonitor.checkAddonNotStarted(ID1); // Should not have called startup though</span>
<a href="#l8.708"></a><span id="l8.708" class="difflineplus">+  do_check_not_in_crash_annotation(ID1, &quot;3.0&quot;);</span>
<a href="#l8.709"></a><span id="l8.709" class="difflineplus">+</span>
<a href="#l8.710"></a><span id="l8.710" class="difflineplus">+  await checkBootstrappedPref();</span>
<a href="#l8.711"></a><span id="l8.711" class="difflineplus">+  await b1.uninstall();</span>
<a href="#l8.712"></a><span id="l8.712" class="difflineplus">+});</span>
<a href="#l8.713"></a><span id="l8.713" class="difflineplus">+</span>
<a href="#l8.714"></a><span id="l8.714" class="difflineplus">+// Tests that a bootstrapped extension with an invalid target application entry</span>
<a href="#l8.715"></a><span id="l8.715" class="difflineplus">+// does not get loaded when detected during startup</span>
<a href="#l8.716"></a><span id="l8.716" class="difflineplus">+add_task(async function test_14() {</span>
<a href="#l8.717"></a><span id="l8.717" class="difflineplus">+  await promiseRestartManager();</span>
<a href="#l8.718"></a><span id="l8.718" class="difflineplus">+</span>
<a href="#l8.719"></a><span id="l8.719" class="difflineplus">+  await promiseShutdownManager();</span>
<a href="#l8.720"></a><span id="l8.720" class="difflineplus">+</span>
<a href="#l8.721"></a><span id="l8.721" class="difflineplus">+  await manuallyInstall(XPIS.test_bootstrap1_3, profileDir, ID1);</span>
<a href="#l8.722"></a><span id="l8.722" class="difflineplus">+</span>
<a href="#l8.723"></a><span id="l8.723" class="difflineplus">+  await promiseStartupManager();</span>
<a href="#l8.724"></a><span id="l8.724" class="difflineplus">+</span>
<a href="#l8.725"></a><span id="l8.725" class="difflineplus">+  let b1 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l8.726"></a><span id="l8.726" class="difflineplus">+  notEqual(b1, null);</span>
<a href="#l8.727"></a><span id="l8.727" class="difflineplus">+  equal(b1.version, &quot;3.0&quot;);</span>
<a href="#l8.728"></a><span id="l8.728" class="difflineplus">+  ok(b1.appDisabled);</span>
<a href="#l8.729"></a><span id="l8.729" class="difflineplus">+  ok(!b1.userDisabled);</span>
<a href="#l8.730"></a><span id="l8.730" class="difflineplus">+  ok(!b1.isActive);</span>
<a href="#l8.731"></a><span id="l8.731" class="difflineplus">+  BootstrapMonitor.checkAddonInstalled(ID1, &quot;3.0&quot;); // We call install even for disabled add-ons</span>
<a href="#l8.732"></a><span id="l8.732" class="difflineplus">+  BootstrapMonitor.checkAddonNotStarted(ID1); // Should not have called startup though</span>
<a href="#l8.733"></a><span id="l8.733" class="difflineplus">+  do_check_not_in_crash_annotation(ID1, &quot;3.0&quot;);</span>
<a href="#l8.734"></a><span id="l8.734" class="difflineplus">+</span>
<a href="#l8.735"></a><span id="l8.735" class="difflineplus">+  await checkBootstrappedPref();</span>
<a href="#l8.736"></a><span id="l8.736" class="difflineplus">+  await b1.uninstall();</span>
<a href="#l8.737"></a><span id="l8.737" class="difflineplus">+});</span>
<a href="#l8.738"></a><span id="l8.738" class="difflineplus">+</span>
<a href="#l8.739"></a><span id="l8.739" class="difflineplus">+// Tests that upgrading a disabled bootstrapped extension still calls uninstall</span>
<a href="#l8.740"></a><span id="l8.740" class="difflineplus">+// and install but doesn't startup the new version</span>
<a href="#l8.741"></a><span id="l8.741" class="difflineplus">+add_task(async function test_15() {</span>
<a href="#l8.742"></a><span id="l8.742" class="difflineplus">+  await Promise.all([</span>
<a href="#l8.743"></a><span id="l8.743" class="difflineplus">+    BootstrapMonitor.promiseAddonStartup(ID1),</span>
<a href="#l8.744"></a><span id="l8.744" class="difflineplus">+    promiseInstallFile(XPIS.test_bootstrap1_1),</span>
<a href="#l8.745"></a><span id="l8.745" class="difflineplus">+  ]);</span>
<a href="#l8.746"></a><span id="l8.746" class="difflineplus">+</span>
<a href="#l8.747"></a><span id="l8.747" class="difflineplus">+  let b1 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l8.748"></a><span id="l8.748" class="difflineplus">+  notEqual(b1, null);</span>
<a href="#l8.749"></a><span id="l8.749" class="difflineplus">+  equal(b1.version, &quot;1.0&quot;);</span>
<a href="#l8.750"></a><span id="l8.750" class="difflineplus">+  ok(!b1.appDisabled);</span>
<a href="#l8.751"></a><span id="l8.751" class="difflineplus">+  ok(!b1.userDisabled);</span>
<a href="#l8.752"></a><span id="l8.752" class="difflineplus">+  ok(b1.isActive);</span>
<a href="#l8.753"></a><span id="l8.753" class="difflineplus">+  ok(!b1.isSystem);</span>
<a href="#l8.754"></a><span id="l8.754" class="difflineplus">+  BootstrapMonitor.checkAddonInstalled(ID1, &quot;1.0&quot;);</span>
<a href="#l8.755"></a><span id="l8.755" class="difflineplus">+  BootstrapMonitor.checkAddonStarted(ID1, &quot;1.0&quot;);</span>
<a href="#l8.756"></a><span id="l8.756" class="difflineplus">+</span>
<a href="#l8.757"></a><span id="l8.757" class="difflineplus">+  await b1.disable();</span>
<a href="#l8.758"></a><span id="l8.758" class="difflineplus">+  ok(!b1.isActive);</span>
<a href="#l8.759"></a><span id="l8.759" class="difflineplus">+  BootstrapMonitor.checkAddonInstalled(ID1, &quot;1.0&quot;);</span>
<a href="#l8.760"></a><span id="l8.760" class="difflineplus">+  BootstrapMonitor.checkAddonNotStarted(ID1);</span>
<a href="#l8.761"></a><span id="l8.761" class="difflineplus">+</span>
<a href="#l8.762"></a><span id="l8.762" class="difflineplus">+  prepare_test({}, [</span>
<a href="#l8.763"></a><span id="l8.763" class="difflineplus">+    &quot;onNewInstall&quot;,</span>
<a href="#l8.764"></a><span id="l8.764" class="difflineplus">+  ]);</span>
<a href="#l8.765"></a><span id="l8.765" class="difflineplus">+</span>
<a href="#l8.766"></a><span id="l8.766" class="difflineplus">+  let install = await AddonManager.getInstallForFile(XPIS.test_bootstrap1_2);</span>
<a href="#l8.767"></a><span id="l8.767" class="difflineplus">+  ensure_test_completed();</span>
<a href="#l8.768"></a><span id="l8.768" class="difflineplus">+</span>
<a href="#l8.769"></a><span id="l8.769" class="difflineplus">+  notEqual(install, null);</span>
<a href="#l8.770"></a><span id="l8.770" class="difflineplus">+  ok(install.addon.userDisabled);</span>
<a href="#l8.771"></a><span id="l8.771" class="difflineplus">+</span>
<a href="#l8.772"></a><span id="l8.772" class="difflineplus">+  await new Promise(resolve =&gt; {</span>
<a href="#l8.773"></a><span id="l8.773" class="difflineplus">+    prepare_test({</span>
<a href="#l8.774"></a><span id="l8.774" class="difflineplus">+      [ID1]: [</span>
<a href="#l8.775"></a><span id="l8.775" class="difflineplus">+        [&quot;onInstalling&quot;, false],</span>
<a href="#l8.776"></a><span id="l8.776" class="difflineplus">+        &quot;onInstalled&quot;,</span>
<a href="#l8.777"></a><span id="l8.777" class="difflineplus">+      ],</span>
<a href="#l8.778"></a><span id="l8.778" class="difflineplus">+    }, [</span>
<a href="#l8.779"></a><span id="l8.779" class="difflineplus">+      &quot;onInstallStarted&quot;,</span>
<a href="#l8.780"></a><span id="l8.780" class="difflineplus">+      &quot;onInstallEnded&quot;,</span>
<a href="#l8.781"></a><span id="l8.781" class="difflineplus">+    ], resolve);</span>
<a href="#l8.782"></a><span id="l8.782" class="difflineplus">+    install.install();</span>
<a href="#l8.783"></a><span id="l8.783" class="difflineplus">+  });</span>
<a href="#l8.784"></a><span id="l8.784" class="difflineplus">+</span>
<a href="#l8.785"></a><span id="l8.785" class="difflineplus">+  b1 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l8.786"></a><span id="l8.786" class="difflineplus">+  notEqual(b1, null);</span>
<a href="#l8.787"></a><span id="l8.787" class="difflineplus">+  equal(b1.version, &quot;2.0&quot;);</span>
<a href="#l8.788"></a><span id="l8.788" class="difflineplus">+  ok(!b1.appDisabled);</span>
<a href="#l8.789"></a><span id="l8.789" class="difflineplus">+  ok(b1.userDisabled);</span>
<a href="#l8.790"></a><span id="l8.790" class="difflineplus">+  ok(!b1.isActive);</span>
<a href="#l8.791"></a><span id="l8.791" class="difflineplus">+  BootstrapMonitor.checkAddonInstalled(ID1, &quot;2.0&quot;);</span>
<a href="#l8.792"></a><span id="l8.792" class="difflineplus">+  BootstrapMonitor.checkAddonNotStarted(ID1);</span>
<a href="#l8.793"></a><span id="l8.793" class="difflineplus">+</span>
<a href="#l8.794"></a><span id="l8.794" class="difflineplus">+  await checkBootstrappedPref();</span>
<a href="#l8.795"></a><span id="l8.795" class="difflineplus">+  await promiseRestartManager();</span>
<a href="#l8.796"></a><span id="l8.796" class="difflineplus">+</span>
<a href="#l8.797"></a><span id="l8.797" class="difflineplus">+  let b1_2 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l8.798"></a><span id="l8.798" class="difflineplus">+  notEqual(b1_2, null);</span>
<a href="#l8.799"></a><span id="l8.799" class="difflineplus">+  equal(b1_2.version, &quot;2.0&quot;);</span>
<a href="#l8.800"></a><span id="l8.800" class="difflineplus">+  ok(!b1_2.appDisabled);</span>
<a href="#l8.801"></a><span id="l8.801" class="difflineplus">+  ok(b1_2.userDisabled);</span>
<a href="#l8.802"></a><span id="l8.802" class="difflineplus">+  ok(!b1_2.isActive);</span>
<a href="#l8.803"></a><span id="l8.803" class="difflineplus">+  BootstrapMonitor.checkAddonInstalled(ID1, &quot;2.0&quot;);</span>
<a href="#l8.804"></a><span id="l8.804" class="difflineplus">+  BootstrapMonitor.checkAddonNotStarted(ID1);</span>
<a href="#l8.805"></a><span id="l8.805" class="difflineplus">+</span>
<a href="#l8.806"></a><span id="l8.806" class="difflineplus">+  await b1_2.uninstall();</span>
<a href="#l8.807"></a><span id="l8.807" class="difflineplus">+});</span>
<a href="#l8.808"></a><span id="l8.808" class="difflineplus">+</span>
<a href="#l8.809"></a><span id="l8.809" class="difflineplus">+// Tests that bootstrapped extensions don't get loaded when in safe mode</span>
<a href="#l8.810"></a><span id="l8.810" class="difflineplus">+add_task(async function test_16() {</span>
<a href="#l8.811"></a><span id="l8.811" class="difflineplus">+  await Promise.all([</span>
<a href="#l8.812"></a><span id="l8.812" class="difflineplus">+    BootstrapMonitor.promiseAddonStartup(ID1),</span>
<a href="#l8.813"></a><span id="l8.813" class="difflineplus">+    promiseInstallFile(XPIS.test_bootstrap1_1),</span>
<a href="#l8.814"></a><span id="l8.814" class="difflineplus">+  ]);</span>
<a href="#l8.815"></a><span id="l8.815" class="difflineplus">+</span>
<a href="#l8.816"></a><span id="l8.816" class="difflineplus">+  let b1 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l8.817"></a><span id="l8.817" class="difflineplus">+  // Should have installed and started</span>
<a href="#l8.818"></a><span id="l8.818" class="difflineplus">+  BootstrapMonitor.checkAddonInstalled(ID1, &quot;1.0&quot;);</span>
<a href="#l8.819"></a><span id="l8.819" class="difflineplus">+  BootstrapMonitor.checkAddonStarted(ID1, &quot;1.0&quot;);</span>
<a href="#l8.820"></a><span id="l8.820" class="difflineplus">+  ok(b1.isActive);</span>
<a href="#l8.821"></a><span id="l8.821" class="difflineplus">+  ok(!b1.isSystem);</span>
<a href="#l8.822"></a><span id="l8.822" class="difflineplus">+  equal(b1.iconURL, &quot;chrome://foo/skin/icon.png&quot;);</span>
<a href="#l8.823"></a><span id="l8.823" class="difflineplus">+  equal(b1.aboutURL, &quot;chrome://foo/content/about.xul&quot;);</span>
<a href="#l8.824"></a><span id="l8.824" class="difflineplus">+  equal(b1.optionsURL, &quot;chrome://foo/content/options.xul&quot;);</span>
<a href="#l8.825"></a><span id="l8.825" class="difflineplus">+</span>
<a href="#l8.826"></a><span id="l8.826" class="difflineplus">+  await promiseShutdownManager();</span>
<a href="#l8.827"></a><span id="l8.827" class="difflineplus">+</span>
<a href="#l8.828"></a><span id="l8.828" class="difflineplus">+  // Should have stopped</span>
<a href="#l8.829"></a><span id="l8.829" class="difflineplus">+  BootstrapMonitor.checkAddonInstalled(ID1, &quot;1.0&quot;);</span>
<a href="#l8.830"></a><span id="l8.830" class="difflineplus">+  BootstrapMonitor.checkAddonNotStarted(ID1);</span>
<a href="#l8.831"></a><span id="l8.831" class="difflineplus">+</span>
<a href="#l8.832"></a><span id="l8.832" class="difflineplus">+  gAppInfo.inSafeMode = true;</span>
<a href="#l8.833"></a><span id="l8.833" class="difflineplus">+  await promiseStartupManager();</span>
<a href="#l8.834"></a><span id="l8.834" class="difflineplus">+</span>
<a href="#l8.835"></a><span id="l8.835" class="difflineplus">+  let b1_2 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l8.836"></a><span id="l8.836" class="difflineplus">+  // Should still be stopped</span>
<a href="#l8.837"></a><span id="l8.837" class="difflineplus">+  BootstrapMonitor.checkAddonInstalled(ID1, &quot;1.0&quot;);</span>
<a href="#l8.838"></a><span id="l8.838" class="difflineplus">+  BootstrapMonitor.checkAddonNotStarted(ID1);</span>
<a href="#l8.839"></a><span id="l8.839" class="difflineplus">+  ok(!b1_2.isActive);</span>
<a href="#l8.840"></a><span id="l8.840" class="difflineplus">+  equal(b1_2.iconURL, null);</span>
<a href="#l8.841"></a><span id="l8.841" class="difflineplus">+  equal(b1_2.aboutURL, null);</span>
<a href="#l8.842"></a><span id="l8.842" class="difflineplus">+  equal(b1_2.optionsURL, null);</span>
<a href="#l8.843"></a><span id="l8.843" class="difflineplus">+</span>
<a href="#l8.844"></a><span id="l8.844" class="difflineplus">+  await promiseShutdownManager();</span>
<a href="#l8.845"></a><span id="l8.845" class="difflineplus">+  gAppInfo.inSafeMode = false;</span>
<a href="#l8.846"></a><span id="l8.846" class="difflineplus">+  await promiseStartupManager();</span>
<a href="#l8.847"></a><span id="l8.847" class="difflineplus">+</span>
<a href="#l8.848"></a><span id="l8.848" class="difflineplus">+  // Should have started</span>
<a href="#l8.849"></a><span id="l8.849" class="difflineplus">+  BootstrapMonitor.checkAddonInstalled(ID1, &quot;1.0&quot;);</span>
<a href="#l8.850"></a><span id="l8.850" class="difflineplus">+  BootstrapMonitor.checkAddonStarted(ID1, &quot;1.0&quot;);</span>
<a href="#l8.851"></a><span id="l8.851" class="difflineplus">+</span>
<a href="#l8.852"></a><span id="l8.852" class="difflineplus">+  let b1_3 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l8.853"></a><span id="l8.853" class="difflineplus">+  await b1_3.uninstall();</span>
<a href="#l8.854"></a><span id="l8.854" class="difflineplus">+});</span>
<a href="#l8.855"></a><span id="l8.855" class="difflineplus">+</span>
<a href="#l8.856"></a><span id="l8.856" class="difflineplus">+// Check that a bootstrapped extension in a non-profile location is loaded</span>
<a href="#l8.857"></a><span id="l8.857" class="difflineplus">+add_task(async function test_17() {</span>
<a href="#l8.858"></a><span id="l8.858" class="difflineplus">+  await promiseShutdownManager();</span>
<a href="#l8.859"></a><span id="l8.859" class="difflineplus">+</span>
<a href="#l8.860"></a><span id="l8.860" class="difflineplus">+  await manuallyInstall(XPIS.test_bootstrap1_1, userExtDir, ID1);</span>
<a href="#l8.861"></a><span id="l8.861" class="difflineplus">+</span>
<a href="#l8.862"></a><span id="l8.862" class="difflineplus">+  await promiseStartupManager();</span>
<a href="#l8.863"></a><span id="l8.863" class="difflineplus">+</span>
<a href="#l8.864"></a><span id="l8.864" class="difflineplus">+  let b1 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l8.865"></a><span id="l8.865" class="difflineplus">+  // Should have installed and started</span>
<a href="#l8.866"></a><span id="l8.866" class="difflineplus">+  BootstrapMonitor.checkAddonInstalled(ID1, &quot;1.0&quot;);</span>
<a href="#l8.867"></a><span id="l8.867" class="difflineplus">+  BootstrapMonitor.checkAddonStarted(ID1, &quot;1.0&quot;);</span>
<a href="#l8.868"></a><span id="l8.868" class="difflineplus">+  notEqual(b1, null);</span>
<a href="#l8.869"></a><span id="l8.869" class="difflineplus">+  equal(b1.version, &quot;1.0&quot;);</span>
<a href="#l8.870"></a><span id="l8.870" class="difflineplus">+  ok(b1.isActive);</span>
<a href="#l8.871"></a><span id="l8.871" class="difflineplus">+  ok(!b1.isSystem);</span>
<a href="#l8.872"></a><span id="l8.872" class="difflineplus">+</span>
<a href="#l8.873"></a><span id="l8.873" class="difflineplus">+  await checkBootstrappedPref();</span>
<a href="#l8.874"></a><span id="l8.874" class="difflineplus">+});</span>
<a href="#l8.875"></a><span id="l8.875" class="difflineplus">+</span>
<a href="#l8.876"></a><span id="l8.876" class="difflineplus">+// Check that installing a new bootstrapped extension in the profile replaces</span>
<a href="#l8.877"></a><span id="l8.877" class="difflineplus">+// the existing one</span>
<a href="#l8.878"></a><span id="l8.878" class="difflineplus">+add_task(async function test_18() {</span>
<a href="#l8.879"></a><span id="l8.879" class="difflineplus">+  await Promise.all([</span>
<a href="#l8.880"></a><span id="l8.880" class="difflineplus">+    BootstrapMonitor.promiseAddonStartup(ID1),</span>
<a href="#l8.881"></a><span id="l8.881" class="difflineplus">+    promiseInstallFile(XPIS.test_bootstrap1_2),</span>
<a href="#l8.882"></a><span id="l8.882" class="difflineplus">+  ]);</span>
<a href="#l8.883"></a><span id="l8.883" class="difflineplus">+</span>
<a href="#l8.884"></a><span id="l8.884" class="difflineplus">+  let b1 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l8.885"></a><span id="l8.885" class="difflineplus">+  // Should have installed and started</span>
<a href="#l8.886"></a><span id="l8.886" class="difflineplus">+  BootstrapMonitor.checkAddonInstalled(ID1, &quot;2.0&quot;);</span>
<a href="#l8.887"></a><span id="l8.887" class="difflineplus">+  BootstrapMonitor.checkAddonStarted(ID1, &quot;2.0&quot;);</span>
<a href="#l8.888"></a><span id="l8.888" class="difflineplus">+  notEqual(b1, null);</span>
<a href="#l8.889"></a><span id="l8.889" class="difflineplus">+  equal(b1.version, &quot;2.0&quot;);</span>
<a href="#l8.890"></a><span id="l8.890" class="difflineplus">+  ok(b1.isActive);</span>
<a href="#l8.891"></a><span id="l8.891" class="difflineplus">+  ok(!b1.isSystem);</span>
<a href="#l8.892"></a><span id="l8.892" class="difflineplus">+</span>
<a href="#l8.893"></a><span id="l8.893" class="difflineplus">+  equal(getShutdownReason(), ADDON_UPGRADE);</span>
<a href="#l8.894"></a><span id="l8.894" class="difflineplus">+  equal(getUninstallReason(), ADDON_UPGRADE);</span>
<a href="#l8.895"></a><span id="l8.895" class="difflineplus">+  equal(getInstallReason(), ADDON_UPGRADE);</span>
<a href="#l8.896"></a><span id="l8.896" class="difflineplus">+  equal(getStartupReason(), ADDON_UPGRADE);</span>
<a href="#l8.897"></a><span id="l8.897" class="difflineplus">+</span>
<a href="#l8.898"></a><span id="l8.898" class="difflineplus">+  equal(getShutdownNewVersion(), 2);</span>
<a href="#l8.899"></a><span id="l8.899" class="difflineplus">+  equal(getUninstallNewVersion(), 2);</span>
<a href="#l8.900"></a><span id="l8.900" class="difflineplus">+  equal(getInstallOldVersion(), 1);</span>
<a href="#l8.901"></a><span id="l8.901" class="difflineplus">+  equal(getStartupOldVersion(), 1);</span>
<a href="#l8.902"></a><span id="l8.902" class="difflineplus">+</span>
<a href="#l8.903"></a><span id="l8.903" class="difflineplus">+  await checkBootstrappedPref();</span>
<a href="#l8.904"></a><span id="l8.904" class="difflineplus">+});</span>
<a href="#l8.905"></a><span id="l8.905" class="difflineplus">+</span>
<a href="#l8.906"></a><span id="l8.906" class="difflineplus">+// Check that uninstalling the profile version reveals the non-profile one</span>
<a href="#l8.907"></a><span id="l8.907" class="difflineplus">+add_task(async function test_19() {</span>
<a href="#l8.908"></a><span id="l8.908" class="difflineplus">+  let b1 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l8.909"></a><span id="l8.909" class="difflineplus">+  // The revealed add-on gets activated asynchronously</span>
<a href="#l8.910"></a><span id="l8.910" class="difflineplus">+  await new Promise(resolve =&gt; {</span>
<a href="#l8.911"></a><span id="l8.911" class="difflineplus">+    prepare_test({</span>
<a href="#l8.912"></a><span id="l8.912" class="difflineplus">+      [ID1]: [</span>
<a href="#l8.913"></a><span id="l8.913" class="difflineplus">+        [&quot;onUninstalling&quot;, false],</span>
<a href="#l8.914"></a><span id="l8.914" class="difflineplus">+        &quot;onUninstalled&quot;,</span>
<a href="#l8.915"></a><span id="l8.915" class="difflineplus">+        [&quot;onInstalling&quot;, false],</span>
<a href="#l8.916"></a><span id="l8.916" class="difflineplus">+        &quot;onInstalled&quot;,</span>
<a href="#l8.917"></a><span id="l8.917" class="difflineplus">+      ],</span>
<a href="#l8.918"></a><span id="l8.918" class="difflineplus">+    }, [], resolve);</span>
<a href="#l8.919"></a><span id="l8.919" class="difflineplus">+</span>
<a href="#l8.920"></a><span id="l8.920" class="difflineplus">+    b1.uninstall();</span>
<a href="#l8.921"></a><span id="l8.921" class="difflineplus">+  });</span>
<a href="#l8.922"></a><span id="l8.922" class="difflineplus">+</span>
<a href="#l8.923"></a><span id="l8.923" class="difflineplus">+  b1 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l8.924"></a><span id="l8.924" class="difflineplus">+  // Should have reverted to the older version</span>
<a href="#l8.925"></a><span id="l8.925" class="difflineplus">+  BootstrapMonitor.checkAddonInstalled(ID1, &quot;1.0&quot;);</span>
<a href="#l8.926"></a><span id="l8.926" class="difflineplus">+  BootstrapMonitor.checkAddonStarted(ID1, &quot;1.0&quot;);</span>
<a href="#l8.927"></a><span id="l8.927" class="difflineplus">+  notEqual(b1, null);</span>
<a href="#l8.928"></a><span id="l8.928" class="difflineplus">+  equal(b1.version, &quot;1.0&quot;);</span>
<a href="#l8.929"></a><span id="l8.929" class="difflineplus">+  ok(b1.isActive);</span>
<a href="#l8.930"></a><span id="l8.930" class="difflineplus">+  ok(!b1.isSystem);</span>
<a href="#l8.931"></a><span id="l8.931" class="difflineplus">+</span>
<a href="#l8.932"></a><span id="l8.932" class="difflineplus">+  equal(getShutdownReason(), ADDON_DOWNGRADE);</span>
<a href="#l8.933"></a><span id="l8.933" class="difflineplus">+  equal(getUninstallReason(), ADDON_DOWNGRADE);</span>
<a href="#l8.934"></a><span id="l8.934" class="difflineplus">+  equal(getInstallReason(), ADDON_DOWNGRADE);</span>
<a href="#l8.935"></a><span id="l8.935" class="difflineplus">+  equal(getStartupReason(), ADDON_DOWNGRADE);</span>
<a href="#l8.936"></a><span id="l8.936" class="difflineplus">+</span>
<a href="#l8.937"></a><span id="l8.937" class="difflineplus">+  equal(getShutdownNewVersion(), &quot;1.0&quot;);</span>
<a href="#l8.938"></a><span id="l8.938" class="difflineplus">+  equal(getUninstallNewVersion(), &quot;1.0&quot;);</span>
<a href="#l8.939"></a><span id="l8.939" class="difflineplus">+  equal(getInstallOldVersion(), &quot;2.0&quot;);</span>
<a href="#l8.940"></a><span id="l8.940" class="difflineplus">+  equal(getStartupOldVersion(), &quot;2.0&quot;);</span>
<a href="#l8.941"></a><span id="l8.941" class="difflineplus">+</span>
<a href="#l8.942"></a><span id="l8.942" class="difflineplus">+  await checkBootstrappedPref();</span>
<a href="#l8.943"></a><span id="l8.943" class="difflineplus">+});</span>
<a href="#l8.944"></a><span id="l8.944" class="difflineplus">+</span>
<a href="#l8.945"></a><span id="l8.945" class="difflineplus">+// Check that a new profile extension detected at startup replaces the non-profile</span>
<a href="#l8.946"></a><span id="l8.946" class="difflineplus">+// one</span>
<a href="#l8.947"></a><span id="l8.947" class="difflineplus">+add_task(async function test_20() {</span>
<a href="#l8.948"></a><span id="l8.948" class="difflineplus">+  await promiseShutdownManager();</span>
<a href="#l8.949"></a><span id="l8.949" class="difflineplus">+</span>
<a href="#l8.950"></a><span id="l8.950" class="difflineplus">+  await manuallyInstall(XPIS.test_bootstrap1_2, profileDir, ID1);</span>
<a href="#l8.951"></a><span id="l8.951" class="difflineplus">+</span>
<a href="#l8.952"></a><span id="l8.952" class="difflineplus">+  await promiseStartupManager();</span>
<a href="#l8.953"></a><span id="l8.953" class="difflineplus">+</span>
<a href="#l8.954"></a><span id="l8.954" class="difflineplus">+  let b1 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l8.955"></a><span id="l8.955" class="difflineplus">+  // Should have installed and started</span>
<a href="#l8.956"></a><span id="l8.956" class="difflineplus">+  BootstrapMonitor.checkAddonInstalled(ID1, &quot;2.0&quot;);</span>
<a href="#l8.957"></a><span id="l8.957" class="difflineplus">+  BootstrapMonitor.checkAddonStarted(ID1, &quot;2.0&quot;);</span>
<a href="#l8.958"></a><span id="l8.958" class="difflineplus">+  notEqual(b1, null);</span>
<a href="#l8.959"></a><span id="l8.959" class="difflineplus">+  equal(b1.version, &quot;2.0&quot;);</span>
<a href="#l8.960"></a><span id="l8.960" class="difflineplus">+  ok(b1.isActive);</span>
<a href="#l8.961"></a><span id="l8.961" class="difflineplus">+  ok(!b1.isSystem);</span>
<a href="#l8.962"></a><span id="l8.962" class="difflineplus">+</span>
<a href="#l8.963"></a><span id="l8.963" class="difflineplus">+  equal(getShutdownReason(), APP_SHUTDOWN);</span>
<a href="#l8.964"></a><span id="l8.964" class="difflineplus">+  equal(getUninstallReason(), ADDON_UPGRADE);</span>
<a href="#l8.965"></a><span id="l8.965" class="difflineplus">+  equal(getInstallReason(), ADDON_UPGRADE);</span>
<a href="#l8.966"></a><span id="l8.966" class="difflineplus">+  equal(getStartupReason(), APP_STARTUP);</span>
<a href="#l8.967"></a><span id="l8.967" class="difflineplus">+</span>
<a href="#l8.968"></a><span id="l8.968" class="difflineplus">+  equal(getShutdownNewVersion(), undefined);</span>
<a href="#l8.969"></a><span id="l8.969" class="difflineplus">+  equal(getUninstallNewVersion(), 2);</span>
<a href="#l8.970"></a><span id="l8.970" class="difflineplus">+  equal(getInstallOldVersion(), 1);</span>
<a href="#l8.971"></a><span id="l8.971" class="difflineplus">+  equal(getStartupOldVersion(), undefined);</span>
<a href="#l8.972"></a><span id="l8.972" class="difflineplus">+});</span>
<a href="#l8.973"></a><span id="l8.973" class="difflineplus">+</span>
<a href="#l8.974"></a><span id="l8.974" class="difflineplus">+// Check that a detected removal reveals the non-profile one</span>
<a href="#l8.975"></a><span id="l8.975" class="difflineplus">+add_task(async function test_21() {</span>
<a href="#l8.976"></a><span id="l8.976" class="difflineplus">+  await promiseShutdownManager();</span>
<a href="#l8.977"></a><span id="l8.977" class="difflineplus">+</span>
<a href="#l8.978"></a><span id="l8.978" class="difflineplus">+  equal(getShutdownReason(), APP_SHUTDOWN);</span>
<a href="#l8.979"></a><span id="l8.979" class="difflineplus">+  equal(getShutdownNewVersion(), undefined);</span>
<a href="#l8.980"></a><span id="l8.980" class="difflineplus">+</span>
<a href="#l8.981"></a><span id="l8.981" class="difflineplus">+  manuallyUninstall(profileDir, ID1);</span>
<a href="#l8.982"></a><span id="l8.982" class="difflineplus">+  BootstrapMonitor.clear(ID1);</span>
<a href="#l8.983"></a><span id="l8.983" class="difflineplus">+</span>
<a href="#l8.984"></a><span id="l8.984" class="difflineplus">+  await promiseStartupManager();</span>
<a href="#l8.985"></a><span id="l8.985" class="difflineplus">+</span>
<a href="#l8.986"></a><span id="l8.986" class="difflineplus">+  let b1 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l8.987"></a><span id="l8.987" class="difflineplus">+  // Should have installed and started</span>
<a href="#l8.988"></a><span id="l8.988" class="difflineplus">+  BootstrapMonitor.checkAddonInstalled(ID1, &quot;1.0&quot;);</span>
<a href="#l8.989"></a><span id="l8.989" class="difflineplus">+  BootstrapMonitor.checkAddonStarted(ID1, &quot;1.0&quot;);</span>
<a href="#l8.990"></a><span id="l8.990" class="difflineplus">+  notEqual(b1, null);</span>
<a href="#l8.991"></a><span id="l8.991" class="difflineplus">+  equal(b1.version, &quot;1.0&quot;);</span>
<a href="#l8.992"></a><span id="l8.992" class="difflineplus">+  ok(b1.isActive);</span>
<a href="#l8.993"></a><span id="l8.993" class="difflineplus">+  ok(!b1.isSystem);</span>
<a href="#l8.994"></a><span id="l8.994" class="difflineplus">+</span>
<a href="#l8.995"></a><span id="l8.995" class="difflineplus">+  // This won't be set as the bootstrap script was gone so we couldn't</span>
<a href="#l8.996"></a><span id="l8.996" class="difflineplus">+  // uninstall it properly</span>
<a href="#l8.997"></a><span id="l8.997" class="difflineplus">+  equal(getUninstallReason(), undefined);</span>
<a href="#l8.998"></a><span id="l8.998" class="difflineplus">+  equal(getUninstallNewVersion(), undefined);</span>
<a href="#l8.999"></a><span id="l8.999" class="difflineplus">+</span>
<a href="#l8.1000"></a><span id="l8.1000" class="difflineplus">+  equal(getInstallReason(), ADDON_DOWNGRADE);</span>
<a href="#l8.1001"></a><span id="l8.1001" class="difflineplus">+  equal(getInstallOldVersion(), 2);</span>
<a href="#l8.1002"></a><span id="l8.1002" class="difflineplus">+</span>
<a href="#l8.1003"></a><span id="l8.1003" class="difflineplus">+  equal(getStartupReason(), APP_STARTUP);</span>
<a href="#l8.1004"></a><span id="l8.1004" class="difflineplus">+  equal(getStartupOldVersion(), undefined);</span>
<a href="#l8.1005"></a><span id="l8.1005" class="difflineplus">+</span>
<a href="#l8.1006"></a><span id="l8.1006" class="difflineplus">+  await checkBootstrappedPref();</span>
<a href="#l8.1007"></a><span id="l8.1007" class="difflineplus">+  await promiseShutdownManager();</span>
<a href="#l8.1008"></a><span id="l8.1008" class="difflineplus">+</span>
<a href="#l8.1009"></a><span id="l8.1009" class="difflineplus">+  manuallyUninstall(userExtDir, ID1);</span>
<a href="#l8.1010"></a><span id="l8.1010" class="difflineplus">+  BootstrapMonitor.clear(ID1);</span>
<a href="#l8.1011"></a><span id="l8.1011" class="difflineplus">+</span>
<a href="#l8.1012"></a><span id="l8.1012" class="difflineplus">+  await promiseStartupManager();</span>
<a href="#l8.1013"></a><span id="l8.1013" class="difflineplus">+});</span>
<a href="#l8.1014"></a><span id="l8.1014" class="difflineplus">+</span>
<a href="#l8.1015"></a><span id="l8.1015" class="difflineplus">+// Check that an upgrade from the filesystem is detected and applied correctly</span>
<a href="#l8.1016"></a><span id="l8.1016" class="difflineplus">+add_task(async function test_22() {</span>
<a href="#l8.1017"></a><span id="l8.1017" class="difflineplus">+  await promiseShutdownManager();</span>
<a href="#l8.1018"></a><span id="l8.1018" class="difflineplus">+</span>
<a href="#l8.1019"></a><span id="l8.1019" class="difflineplus">+  let file = await manuallyInstall(XPIS.test_bootstrap1_1, profileDir, ID1);</span>
<a href="#l8.1020"></a><span id="l8.1020" class="difflineplus">+  if (file.isDirectory())</span>
<a href="#l8.1021"></a><span id="l8.1021" class="difflineplus">+    file.append(&quot;install.rdf&quot;);</span>
<a href="#l8.1022"></a><span id="l8.1022" class="difflineplus">+</span>
<a href="#l8.1023"></a><span id="l8.1023" class="difflineplus">+  // Make it look old so changes are detected</span>
<a href="#l8.1024"></a><span id="l8.1024" class="difflineplus">+  setExtensionModifiedTime(file, file.lastModifiedTime - 5000);</span>
<a href="#l8.1025"></a><span id="l8.1025" class="difflineplus">+</span>
<a href="#l8.1026"></a><span id="l8.1026" class="difflineplus">+  await promiseStartupManager();</span>
<a href="#l8.1027"></a><span id="l8.1027" class="difflineplus">+</span>
<a href="#l8.1028"></a><span id="l8.1028" class="difflineplus">+  let b1 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l8.1029"></a><span id="l8.1029" class="difflineplus">+  // Should have installed and started</span>
<a href="#l8.1030"></a><span id="l8.1030" class="difflineplus">+  BootstrapMonitor.checkAddonInstalled(ID1, &quot;1.0&quot;);</span>
<a href="#l8.1031"></a><span id="l8.1031" class="difflineplus">+  BootstrapMonitor.checkAddonStarted(ID1, &quot;1.0&quot;);</span>
<a href="#l8.1032"></a><span id="l8.1032" class="difflineplus">+  notEqual(b1, null);</span>
<a href="#l8.1033"></a><span id="l8.1033" class="difflineplus">+  equal(b1.version, &quot;1.0&quot;);</span>
<a href="#l8.1034"></a><span id="l8.1034" class="difflineplus">+  ok(b1.isActive);</span>
<a href="#l8.1035"></a><span id="l8.1035" class="difflineplus">+  ok(!b1.isSystem);</span>
<a href="#l8.1036"></a><span id="l8.1036" class="difflineplus">+</span>
<a href="#l8.1037"></a><span id="l8.1037" class="difflineplus">+  await promiseShutdownManager();</span>
<a href="#l8.1038"></a><span id="l8.1038" class="difflineplus">+</span>
<a href="#l8.1039"></a><span id="l8.1039" class="difflineplus">+  equal(getShutdownReason(), APP_SHUTDOWN);</span>
<a href="#l8.1040"></a><span id="l8.1040" class="difflineplus">+  equal(getShutdownNewVersion(), undefined);</span>
<a href="#l8.1041"></a><span id="l8.1041" class="difflineplus">+</span>
<a href="#l8.1042"></a><span id="l8.1042" class="difflineplus">+  manuallyUninstall(profileDir, ID1);</span>
<a href="#l8.1043"></a><span id="l8.1043" class="difflineplus">+  BootstrapMonitor.clear(ID1);</span>
<a href="#l8.1044"></a><span id="l8.1044" class="difflineplus">+  await manuallyInstall(XPIS.test_bootstrap1_2, profileDir, ID1);</span>
<a href="#l8.1045"></a><span id="l8.1045" class="difflineplus">+</span>
<a href="#l8.1046"></a><span id="l8.1046" class="difflineplus">+  await promiseStartupManager();</span>
<a href="#l8.1047"></a><span id="l8.1047" class="difflineplus">+</span>
<a href="#l8.1048"></a><span id="l8.1048" class="difflineplus">+  let b1_2 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l8.1049"></a><span id="l8.1049" class="difflineplus">+  // Should have installed and started</span>
<a href="#l8.1050"></a><span id="l8.1050" class="difflineplus">+  BootstrapMonitor.checkAddonInstalled(ID1, &quot;2.0&quot;);</span>
<a href="#l8.1051"></a><span id="l8.1051" class="difflineplus">+  BootstrapMonitor.checkAddonStarted(ID1, &quot;2.0&quot;);</span>
<a href="#l8.1052"></a><span id="l8.1052" class="difflineplus">+  notEqual(b1_2, null);</span>
<a href="#l8.1053"></a><span id="l8.1053" class="difflineplus">+  equal(b1_2.version, &quot;2.0&quot;);</span>
<a href="#l8.1054"></a><span id="l8.1054" class="difflineplus">+  ok(b1_2.isActive);</span>
<a href="#l8.1055"></a><span id="l8.1055" class="difflineplus">+  ok(!b1_2.isSystem);</span>
<a href="#l8.1056"></a><span id="l8.1056" class="difflineplus">+</span>
<a href="#l8.1057"></a><span id="l8.1057" class="difflineplus">+  // This won't be set as the bootstrap script was gone so we couldn't</span>
<a href="#l8.1058"></a><span id="l8.1058" class="difflineplus">+  // uninstall it properly</span>
<a href="#l8.1059"></a><span id="l8.1059" class="difflineplus">+  equal(getUninstallReason(), undefined);</span>
<a href="#l8.1060"></a><span id="l8.1060" class="difflineplus">+  equal(getUninstallNewVersion(), undefined);</span>
<a href="#l8.1061"></a><span id="l8.1061" class="difflineplus">+</span>
<a href="#l8.1062"></a><span id="l8.1062" class="difflineplus">+  equal(getInstallReason(), ADDON_UPGRADE);</span>
<a href="#l8.1063"></a><span id="l8.1063" class="difflineplus">+  equal(getInstallOldVersion(), 1);</span>
<a href="#l8.1064"></a><span id="l8.1064" class="difflineplus">+  equal(getStartupReason(), APP_STARTUP);</span>
<a href="#l8.1065"></a><span id="l8.1065" class="difflineplus">+  equal(getStartupOldVersion(), undefined);</span>
<a href="#l8.1066"></a><span id="l8.1066" class="difflineplus">+</span>
<a href="#l8.1067"></a><span id="l8.1067" class="difflineplus">+  await checkBootstrappedPref();</span>
<a href="#l8.1068"></a><span id="l8.1068" class="difflineplus">+  await b1_2.uninstall();</span>
<a href="#l8.1069"></a><span id="l8.1069" class="difflineplus">+});</span>
<a href="#l8.1070"></a><span id="l8.1070" class="difflineplus">+</span>
<a href="#l8.1071"></a><span id="l8.1071" class="difflineplus">+</span>
<a href="#l8.1072"></a><span id="l8.1072" class="difflineplus">+// Tests that installing from a URL doesn't require a restart</span>
<a href="#l8.1073"></a><span id="l8.1073" class="difflineplus">+add_task(async function test_23() {</span>
<a href="#l8.1074"></a><span id="l8.1074" class="difflineplus">+  prepare_test({}, [</span>
<a href="#l8.1075"></a><span id="l8.1075" class="difflineplus">+    &quot;onNewInstall&quot;,</span>
<a href="#l8.1076"></a><span id="l8.1076" class="difflineplus">+  ]);</span>
<a href="#l8.1077"></a><span id="l8.1077" class="difflineplus">+</span>
<a href="#l8.1078"></a><span id="l8.1078" class="difflineplus">+  let url = &quot;http://example.com/addons/test_bootstrap1_1.xpi&quot;;</span>
<a href="#l8.1079"></a><span id="l8.1079" class="difflineplus">+  let install = await AddonManager.getInstallForURL(url, &quot;application/x-xpinstall&quot;);</span>
<a href="#l8.1080"></a><span id="l8.1080" class="difflineplus">+</span>
<a href="#l8.1081"></a><span id="l8.1081" class="difflineplus">+  ensure_test_completed();</span>
<a href="#l8.1082"></a><span id="l8.1082" class="difflineplus">+</span>
<a href="#l8.1083"></a><span id="l8.1083" class="difflineplus">+  notEqual(install, null);</span>
<a href="#l8.1084"></a><span id="l8.1084" class="difflineplus">+</span>
<a href="#l8.1085"></a><span id="l8.1085" class="difflineplus">+  await new Promise(resolve =&gt; {</span>
<a href="#l8.1086"></a><span id="l8.1086" class="difflineplus">+    prepare_test({}, [</span>
<a href="#l8.1087"></a><span id="l8.1087" class="difflineplus">+      &quot;onDownloadStarted&quot;,</span>
<a href="#l8.1088"></a><span id="l8.1088" class="difflineplus">+      &quot;onDownloadEnded&quot;,</span>
<a href="#l8.1089"></a><span id="l8.1089" class="difflineplus">+    ], function() {</span>
<a href="#l8.1090"></a><span id="l8.1090" class="difflineplus">+      equal(install.type, &quot;extension&quot;);</span>
<a href="#l8.1091"></a><span id="l8.1091" class="difflineplus">+      equal(install.version, &quot;1.0&quot;);</span>
<a href="#l8.1092"></a><span id="l8.1092" class="difflineplus">+      equal(install.name, &quot;Test Bootstrap 1&quot;);</span>
<a href="#l8.1093"></a><span id="l8.1093" class="difflineplus">+      equal(install.state, AddonManager.STATE_DOWNLOADED);</span>
<a href="#l8.1094"></a><span id="l8.1094" class="difflineplus">+      equal(install.addon.operationsRequiringRestart &amp;</span>
<a href="#l8.1095"></a><span id="l8.1095" class="difflineplus">+                   AddonManager.OP_NEEDS_RESTART_INSTALL, 0);</span>
<a href="#l8.1096"></a><span id="l8.1096" class="difflineplus">+      do_check_not_in_crash_annotation(ID1, &quot;1.0&quot;);</span>
<a href="#l8.1097"></a><span id="l8.1097" class="difflineplus">+</span>
<a href="#l8.1098"></a><span id="l8.1098" class="difflineplus">+      prepare_test({</span>
<a href="#l8.1099"></a><span id="l8.1099" class="difflineplus">+        [ID1]: [</span>
<a href="#l8.1100"></a><span id="l8.1100" class="difflineplus">+          [&quot;onInstalling&quot;, false],</span>
<a href="#l8.1101"></a><span id="l8.1101" class="difflineplus">+          &quot;onInstalled&quot;,</span>
<a href="#l8.1102"></a><span id="l8.1102" class="difflineplus">+        ],</span>
<a href="#l8.1103"></a><span id="l8.1103" class="difflineplus">+      }, [</span>
<a href="#l8.1104"></a><span id="l8.1104" class="difflineplus">+        &quot;onInstallStarted&quot;,</span>
<a href="#l8.1105"></a><span id="l8.1105" class="difflineplus">+        &quot;onInstallEnded&quot;,</span>
<a href="#l8.1106"></a><span id="l8.1106" class="difflineplus">+      ], resolve);</span>
<a href="#l8.1107"></a><span id="l8.1107" class="difflineplus">+    });</span>
<a href="#l8.1108"></a><span id="l8.1108" class="difflineplus">+    install.install();</span>
<a href="#l8.1109"></a><span id="l8.1109" class="difflineplus">+  });</span>
<a href="#l8.1110"></a><span id="l8.1110" class="difflineplus">+</span>
<a href="#l8.1111"></a><span id="l8.1111" class="difflineplus">+  await checkBootstrappedPref();</span>
<a href="#l8.1112"></a><span id="l8.1112" class="difflineplus">+</span>
<a href="#l8.1113"></a><span id="l8.1113" class="difflineplus">+  let installs = await AddonManager.getAllInstalls();</span>
<a href="#l8.1114"></a><span id="l8.1114" class="difflineplus">+</span>
<a href="#l8.1115"></a><span id="l8.1115" class="difflineplus">+  // There should be no active installs now since the install completed and</span>
<a href="#l8.1116"></a><span id="l8.1116" class="difflineplus">+  // doesn't require a restart.</span>
<a href="#l8.1117"></a><span id="l8.1117" class="difflineplus">+  equal(installs.length, 0);</span>
<a href="#l8.1118"></a><span id="l8.1118" class="difflineplus">+</span>
<a href="#l8.1119"></a><span id="l8.1119" class="difflineplus">+  let b1 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l8.1120"></a><span id="l8.1120" class="difflineplus">+</span>
<a href="#l8.1121"></a><span id="l8.1121" class="difflineplus">+  notEqual(b1, null);</span>
<a href="#l8.1122"></a><span id="l8.1122" class="difflineplus">+  equal(b1.version, &quot;1.0&quot;);</span>
<a href="#l8.1123"></a><span id="l8.1123" class="difflineplus">+  ok(!b1.appDisabled);</span>
<a href="#l8.1124"></a><span id="l8.1124" class="difflineplus">+  ok(!b1.userDisabled);</span>
<a href="#l8.1125"></a><span id="l8.1125" class="difflineplus">+  ok(b1.isActive);</span>
<a href="#l8.1126"></a><span id="l8.1126" class="difflineplus">+  ok(!b1.isSystem);</span>
<a href="#l8.1127"></a><span id="l8.1127" class="difflineplus">+  BootstrapMonitor.checkAddonInstalled(ID1, &quot;1.0&quot;);</span>
<a href="#l8.1128"></a><span id="l8.1128" class="difflineplus">+  BootstrapMonitor.checkAddonStarted(ID1, &quot;1.0&quot;);</span>
<a href="#l8.1129"></a><span id="l8.1129" class="difflineplus">+  equal(getStartupReason(), ADDON_INSTALL);</span>
<a href="#l8.1130"></a><span id="l8.1130" class="difflineplus">+  equal(getStartupOldVersion(), undefined);</span>
<a href="#l8.1131"></a><span id="l8.1131" class="difflineplus">+  do_check_in_crash_annotation(ID1, &quot;1.0&quot;);</span>
<a href="#l8.1132"></a><span id="l8.1132" class="difflineplus">+</span>
<a href="#l8.1133"></a><span id="l8.1133" class="difflineplus">+  let dir = do_get_addon_root_uri(profileDir, ID1);</span>
<a href="#l8.1134"></a><span id="l8.1134" class="difflineplus">+  equal(b1.getResourceURI(&quot;bootstrap.js&quot;).spec, dir + &quot;bootstrap.js&quot;);</span>
<a href="#l8.1135"></a><span id="l8.1135" class="difflineplus">+</span>
<a href="#l8.1136"></a><span id="l8.1136" class="difflineplus">+  await promiseRestartManager();</span>
<a href="#l8.1137"></a><span id="l8.1137" class="difflineplus">+</span>
<a href="#l8.1138"></a><span id="l8.1138" class="difflineplus">+  let b1_2 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l8.1139"></a><span id="l8.1139" class="difflineplus">+  await b1_2.uninstall();</span>
<a href="#l8.1140"></a><span id="l8.1140" class="difflineplus">+});</span>
<a href="#l8.1141"></a><span id="l8.1141" class="difflineplus">+</span>
<a href="#l8.1142"></a><span id="l8.1142" class="difflineplus">+// Tests that we recover from a broken preference</span>
<a href="#l8.1143"></a><span id="l8.1143" class="difflineplus">+add_task(async function test_24() {</span>
<a href="#l8.1144"></a><span id="l8.1144" class="difflineplus">+  info(&quot;starting 24&quot;);</span>
<a href="#l8.1145"></a><span id="l8.1145" class="difflineplus">+</span>
<a href="#l8.1146"></a><span id="l8.1146" class="difflineplus">+  await Promise.all([</span>
<a href="#l8.1147"></a><span id="l8.1147" class="difflineplus">+    BootstrapMonitor.promiseAddonStartup(ID2),</span>
<a href="#l8.1148"></a><span id="l8.1148" class="difflineplus">+    promiseInstallAllFiles([XPIS.test_bootstrap1_1, XPIS.test_bootstrap2_1]),</span>
<a href="#l8.1149"></a><span id="l8.1149" class="difflineplus">+  ]);</span>
<a href="#l8.1150"></a><span id="l8.1150" class="difflineplus">+</span>
<a href="#l8.1151"></a><span id="l8.1151" class="difflineplus">+  info(&quot;test 24 got prefs&quot;);</span>
<a href="#l8.1152"></a><span id="l8.1152" class="difflineplus">+  BootstrapMonitor.checkAddonInstalled(ID1, &quot;1.0&quot;);</span>
<a href="#l8.1153"></a><span id="l8.1153" class="difflineplus">+  BootstrapMonitor.checkAddonStarted(ID1, &quot;1.0&quot;);</span>
<a href="#l8.1154"></a><span id="l8.1154" class="difflineplus">+  BootstrapMonitor.checkAddonInstalled(ID2, &quot;1.0&quot;);</span>
<a href="#l8.1155"></a><span id="l8.1155" class="difflineplus">+  BootstrapMonitor.checkAddonStarted(ID2, &quot;1.0&quot;);</span>
<a href="#l8.1156"></a><span id="l8.1156" class="difflineplus">+</span>
<a href="#l8.1157"></a><span id="l8.1157" class="difflineplus">+  await promiseRestartManager();</span>
<a href="#l8.1158"></a><span id="l8.1158" class="difflineplus">+</span>
<a href="#l8.1159"></a><span id="l8.1159" class="difflineplus">+  BootstrapMonitor.checkAddonInstalled(ID1, &quot;1.0&quot;);</span>
<a href="#l8.1160"></a><span id="l8.1160" class="difflineplus">+  BootstrapMonitor.checkAddonStarted(ID1, &quot;1.0&quot;);</span>
<a href="#l8.1161"></a><span id="l8.1161" class="difflineplus">+  BootstrapMonitor.checkAddonInstalled(ID2, &quot;1.0&quot;);</span>
<a href="#l8.1162"></a><span id="l8.1162" class="difflineplus">+  BootstrapMonitor.checkAddonStarted(ID2, &quot;1.0&quot;);</span>
<a href="#l8.1163"></a><span id="l8.1163" class="difflineplus">+</span>
<a href="#l8.1164"></a><span id="l8.1164" class="difflineplus">+  await promiseShutdownManager();</span>
<a href="#l8.1165"></a><span id="l8.1165" class="difflineplus">+</span>
<a href="#l8.1166"></a><span id="l8.1166" class="difflineplus">+  BootstrapMonitor.checkAddonInstalled(ID1, &quot;1.0&quot;);</span>
<a href="#l8.1167"></a><span id="l8.1167" class="difflineplus">+  BootstrapMonitor.checkAddonNotStarted(ID1);</span>
<a href="#l8.1168"></a><span id="l8.1168" class="difflineplus">+  BootstrapMonitor.checkAddonInstalled(ID2, &quot;1.0&quot;);</span>
<a href="#l8.1169"></a><span id="l8.1169" class="difflineplus">+  BootstrapMonitor.checkAddonNotStarted(ID2);</span>
<a href="#l8.1170"></a><span id="l8.1170" class="difflineplus">+</span>
<a href="#l8.1171"></a><span id="l8.1171" class="difflineplus">+  // Break the JSON.</span>
<a href="#l8.1172"></a><span id="l8.1172" class="difflineplus">+  let data = aomStartup.readStartupData();</span>
<a href="#l8.1173"></a><span id="l8.1173" class="difflineplus">+  data[&quot;app-profile&quot;].addons[ID1].path += &quot;foo&quot;;</span>
<a href="#l8.1174"></a><span id="l8.1174" class="difflineplus">+</span>
<a href="#l8.1175"></a><span id="l8.1175" class="difflineplus">+  await OS.File.writeAtomic(gAddonStartup.path,</span>
<a href="#l8.1176"></a><span id="l8.1176" class="difflineplus">+                            new TextEncoder().encode(JSON.stringify(data)),</span>
<a href="#l8.1177"></a><span id="l8.1177" class="difflineplus">+                            {compression: &quot;lz4&quot;});</span>
<a href="#l8.1178"></a><span id="l8.1178" class="difflineplus">+</span>
<a href="#l8.1179"></a><span id="l8.1179" class="difflineplus">+  await promiseStartupManager();</span>
<a href="#l8.1180"></a><span id="l8.1180" class="difflineplus">+</span>
<a href="#l8.1181"></a><span id="l8.1181" class="difflineplus">+  BootstrapMonitor.checkAddonInstalled(ID1, &quot;1.0&quot;);</span>
<a href="#l8.1182"></a><span id="l8.1182" class="difflineplus">+  BootstrapMonitor.checkAddonStarted(ID1, &quot;1.0&quot;);</span>
<a href="#l8.1183"></a><span id="l8.1183" class="difflineplus">+  BootstrapMonitor.checkAddonInstalled(ID2, &quot;1.0&quot;);</span>
<a href="#l8.1184"></a><span id="l8.1184" class="difflineplus">+  BootstrapMonitor.checkAddonStarted(ID2, &quot;1.0&quot;);</span>
<a href="#l8.1185"></a><span id="l8.1185" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1">new file mode 100644</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineminus">--- /dev/null</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineplus">+++ b/common/test/xpcshell/test_bootstrap_const.js</span>
<a href="#l9.4"></a><span id="l9.4" class="difflineat">@@ -0,0 +1,27 @@</span>
<a href="#l9.5"></a><span id="l9.5" class="difflineplus">+/* Any copyright is dedicated to the Public Domain.</span>
<a href="#l9.6"></a><span id="l9.6" class="difflineplus">+ * http://creativecommons.org/publicdomain/zero/1.0/</span>
<a href="#l9.7"></a><span id="l9.7" class="difflineplus">+ */</span>
<a href="#l9.8"></a><span id="l9.8" class="difflineplus">+</span>
<a href="#l9.9"></a><span id="l9.9" class="difflineplus">+createAppInfo(&quot;xpcshell@tests.mozilla.org&quot;, &quot;XPCShell&quot;, &quot;1&quot;, &quot;1&quot;);</span>
<a href="#l9.10"></a><span id="l9.10" class="difflineplus">+</span>
<a href="#l9.11"></a><span id="l9.11" class="difflineplus">+const ADDONS = {</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+  test_bootstrap_const: {</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+    &quot;install.rdf&quot;: {</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+      &quot;id&quot;: &quot;bootstrap@tests.mozilla.org&quot;,</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+    },</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+    &quot;bootstrap.js&quot;: &quot;ChromeUtils.import(\&quot;resource://gre/modules/Services.jsm\&quot;);\n\nconst install = function() {\n  Services.obs.notifyObservers(null, \&quot;addon-install\&quot;);\n};\n&quot;,</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+  },</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineplus">+};</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineplus">+</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineplus">+add_task(async function() {</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineplus">+  await promiseStartupManager();</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineplus">+</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineplus">+  let sawInstall = false;</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineplus">+  Services.obs.addObserver(function() {</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineplus">+    sawInstall = true;</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineplus">+  }, &quot;addon-install&quot;);</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineplus">+</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineplus">+  await AddonTestUtils.promiseInstallXPI(ADDONS.test_bootstrap_const);</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineplus">+</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineplus">+  ok(sawInstall);</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1">new file mode 100644</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineminus">--- /dev/null</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineplus">+++ b/common/test/xpcshell/test_bootstrap_globals.js</span>
<a href="#l10.4"></a><span id="l10.4" class="difflineat">@@ -0,0 +1,66 @@</span>
<a href="#l10.5"></a><span id="l10.5" class="difflineplus">+/* Any copyright is dedicated to the Public Domain.</span>
<a href="#l10.6"></a><span id="l10.6" class="difflineplus">+ * http://creativecommons.org/publicdomain/zero/1.0/</span>
<a href="#l10.7"></a><span id="l10.7" class="difflineplus">+ */</span>
<a href="#l10.8"></a><span id="l10.8" class="difflineplus">+</span>
<a href="#l10.9"></a><span id="l10.9" class="difflineplus">+// This verifies that bootstrap.js has the expected globals defined</span>
<a href="#l10.10"></a><span id="l10.10" class="difflineplus">+ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l10.11"></a><span id="l10.11" class="difflineplus">+</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+createAppInfo(&quot;xpcshell@tests.mozilla.org&quot;, &quot;XPCShell&quot;, &quot;1&quot;, &quot;1&quot;);</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+const ADDONS = {</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineplus">+  bootstrap_globals: {</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+    &quot;install.rdf&quot;: {</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineplus">+      &quot;id&quot;: &quot;bootstrap_globals@tests.mozilla.org&quot;,</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineplus">+    },</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineplus">+    &quot;bootstrap.js&quot;: String.raw`ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineplus">+</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineplus">+var seenGlobals = new Set();</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineplus">+var scope = this;</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineplus">+function checkGlobal(name, type) {</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineplus">+  if (scope[name] &amp;&amp; typeof(scope[name]) == type)</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineplus">+    seenGlobals.add(name);</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineplus">+}</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineplus">+</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineplus">+var wrapped = {};</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineplus">+Services.obs.notifyObservers({ wrappedJSObject: wrapped }, &quot;bootstrap-request-globals&quot;);</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineplus">+for (let [name, type] of wrapped.expectedGlobals) {</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineplus">+  checkGlobal(name, type);</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineplus">+}</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineplus">+</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineplus">+function startup(data, reason) {</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineplus">+  Services.obs.notifyObservers({ wrappedJSObject: seenGlobals }, &quot;bootstrap-seen-globals&quot;);</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineplus">+}</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineplus">+</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineplus">+function install(data, reason) {}</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineplus">+function shutdown(data, reason) {}</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineplus">+function uninstall(data, reason) {}</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineplus">+`,</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineplus">+  },</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineplus">+};</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineplus">+</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineplus">+</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineplus">+const EXPECTED_GLOBALS = [</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineplus">+  [&quot;console&quot;, &quot;object&quot;],</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineplus">+];</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineplus">+</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineplus">+async function run_test() {</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineplus">+  do_test_pending();</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineplus">+  await promiseStartupManager();</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineplus">+  let sawGlobals = false;</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineplus">+</span>
<a href="#l10.55"></a><span id="l10.55" class="difflineplus">+  Services.obs.addObserver(function(subject) {</span>
<a href="#l10.56"></a><span id="l10.56" class="difflineplus">+    subject.wrappedJSObject.expectedGlobals = EXPECTED_GLOBALS;</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineplus">+  }, &quot;bootstrap-request-globals&quot;);</span>
<a href="#l10.58"></a><span id="l10.58" class="difflineplus">+</span>
<a href="#l10.59"></a><span id="l10.59" class="difflineplus">+  Services.obs.addObserver(function({ wrappedJSObject: seenGlobals }) {</span>
<a href="#l10.60"></a><span id="l10.60" class="difflineplus">+    for (let [name ] of EXPECTED_GLOBALS)</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineplus">+      Assert.ok(seenGlobals.has(name));</span>
<a href="#l10.62"></a><span id="l10.62" class="difflineplus">+</span>
<a href="#l10.63"></a><span id="l10.63" class="difflineplus">+    sawGlobals = true;</span>
<a href="#l10.64"></a><span id="l10.64" class="difflineplus">+  }, &quot;bootstrap-seen-globals&quot;);</span>
<a href="#l10.65"></a><span id="l10.65" class="difflineplus">+</span>
<a href="#l10.66"></a><span id="l10.66" class="difflineplus">+  await AddonTestUtils.promiseInstallXPI(ADDONS.bootstrap_globals);</span>
<a href="#l10.67"></a><span id="l10.67" class="difflineplus">+  Assert.ok(sawGlobals);</span>
<a href="#l10.68"></a><span id="l10.68" class="difflineplus">+  await promiseShutdownManager();</span>
<a href="#l10.69"></a><span id="l10.69" class="difflineplus">+  do_test_finished();</span>
<a href="#l10.70"></a><span id="l10.70" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1">new file mode 100644</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineminus">--- /dev/null</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineplus">+++ b/common/test/xpcshell/test_bootstrapped_chrome_manifest.js</span>
<a href="#l11.4"></a><span id="l11.4" class="difflineat">@@ -0,0 +1,50 @@</span>
<a href="#l11.5"></a><span id="l11.5" class="difflineplus">+/* Any copyright is dedicated to the Public Domain.</span>
<a href="#l11.6"></a><span id="l11.6" class="difflineplus">+ * http://creativecommons.org/publicdomain/zero/1.0/</span>
<a href="#l11.7"></a><span id="l11.7" class="difflineplus">+ */</span>
<a href="#l11.8"></a><span id="l11.8" class="difflineplus">+</span>
<a href="#l11.9"></a><span id="l11.9" class="difflineplus">+const ADDON = {</span>
<a href="#l11.10"></a><span id="l11.10" class="difflineplus">+  &quot;install.rdf&quot;: {</span>
<a href="#l11.11"></a><span id="l11.11" class="difflineplus">+    &quot;id&quot;: &quot;bug675371@tests.mozilla.org&quot;,</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+  },</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+  &quot;chrome.manifest&quot;: `content bug675371 .`,</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+  &quot;test.js&quot;: `var active = true;`,</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+};</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineplus">+</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineplus">+add_task(async function run_test() {</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineplus">+  createAppInfo(&quot;xpcshell@tests.mozilla.org&quot;, &quot;XPCShell&quot;, &quot;1&quot;, &quot;1.9.2&quot;);</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineplus">+  await promiseStartupManager();</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineplus">+});</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineplus">+</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineplus">+function checkActive(expected) {</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineplus">+  let target = { active: false };</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineplus">+  let load = () =&gt; {</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineplus">+    Services.scriptloader.loadSubScript(&quot;chrome://bug675371/content/test.js&quot;, target);</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineplus">+  };</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineplus">+</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineplus">+  if (expected) {</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineplus">+    load();</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineplus">+  } else {</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineplus">+    Assert.throws(load, /Error opening input stream/);</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineplus">+  }</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineplus">+  equal(target.active, expected, &quot;Manifest is active?&quot;);</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineplus">+}</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineplus">+</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineplus">+add_task(async function test() {</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineplus">+  let {addon} = await AddonTestUtils.promiseInstallXPI(ADDON);</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineplus">+</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineplus">+  Assert.ok(addon.isActive);</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineplus">+</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineplus">+  // Tests that chrome.manifest is registered when the addon is installed.</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineplus">+  checkActive(true);</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineplus">+</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineplus">+  await addon.disable();</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineplus">+  checkActive(false);</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineplus">+</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineplus">+  await addon.enable();</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineplus">+  checkActive(true);</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineplus">+</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineplus">+  await promiseShutdownManager();</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineplus">+</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineplus">+  // Tests that chrome.manifest remains registered at app shutdown.</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineplus">+  checkActive(true);</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1">new file mode 100644</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineminus">--- /dev/null</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineplus">+++ b/common/test/xpcshell/test_invalid_install_rdf.js</span>
<a href="#l12.4"></a><span id="l12.4" class="difflineat">@@ -0,0 +1,113 @@</span>
<a href="#l12.5"></a><span id="l12.5" class="difflineplus">+/* Any copyright is dedicated to the Public Domain.</span>
<a href="#l12.6"></a><span id="l12.6" class="difflineplus">+ * http://creativecommons.org/publicdomain/zero/1.0/</span>
<a href="#l12.7"></a><span id="l12.7" class="difflineplus">+ */</span>
<a href="#l12.8"></a><span id="l12.8" class="difflineplus">+</span>
<a href="#l12.9"></a><span id="l12.9" class="difflineplus">+// Test that side-loaded extensions with invalid install.rdf files are</span>
<a href="#l12.10"></a><span id="l12.10" class="difflineplus">+// not initialized at startup.</span>
<a href="#l12.11"></a><span id="l12.11" class="difflineplus">+</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+const APP_ID = &quot;xpcshell@tests.mozilla.org&quot;;</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+Services.prefs.setIntPref(&quot;extensions.enabledScopes&quot;, AddonManager.SCOPE_USER);</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineplus">+createAppInfo(APP_ID, &quot;XPCShell&quot;, &quot;1&quot;, &quot;1.9.2&quot;);</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineplus">+</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineplus">+const userAppDir = AddonTestUtils.profileDir.clone();</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineplus">+userAppDir.append(&quot;app-extensions&quot;);</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineplus">+userAppDir.create(Ci.nsIFile.DIRECTORY_TYPE, FileUtils.PERMS_DIRECTORY);</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineplus">+AddonTestUtils.registerDirectory(&quot;XREUSysExt&quot;, userAppDir);</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineplus">+</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineplus">+const userExtensions = userAppDir.clone();</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineplus">+userExtensions.append(APP_ID);</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineplus">+userExtensions.create(Ci.nsIFile.DIRECTORY_TYPE, FileUtils.PERMS_DIRECTORY);</span>
<a href="#l12.26"></a><span id="l12.26" class="difflineplus">+</span>
<a href="#l12.27"></a><span id="l12.27" class="difflineplus">+XPCOMUtils.defineLazyServiceGetters(this, {</span>
<a href="#l12.28"></a><span id="l12.28" class="difflineplus">+  ChromeRegistry: [&quot;@mozilla.org/chrome/chrome-registry;1&quot;, &quot;nsIChromeRegistry&quot;],</span>
<a href="#l12.29"></a><span id="l12.29" class="difflineplus">+});</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineplus">+</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineplus">+function hasChromeEntry(package) {</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineplus">+  try {</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineplus">+    void ChromeRegistry.convertChromeURL(Services.io.newURI(`chrome://${package}/content/`));</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineplus">+    return true;</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineplus">+  } catch (e) {</span>
<a href="#l12.36"></a><span id="l12.36" class="difflineplus">+    return false;</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineplus">+  }</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineplus">+}</span>
<a href="#l12.39"></a><span id="l12.39" class="difflineplus">+</span>
<a href="#l12.40"></a><span id="l12.40" class="difflineplus">+add_task(async function() {</span>
<a href="#l12.41"></a><span id="l12.41" class="difflineplus">+  await promiseWriteInstallRDFToXPI({</span>
<a href="#l12.42"></a><span id="l12.42" class="difflineplus">+    id: &quot;langpack-foo@addons.mozilla.org&quot;,</span>
<a href="#l12.43"></a><span id="l12.43" class="difflineplus">+    version: &quot;1.0&quot;,</span>
<a href="#l12.44"></a><span id="l12.44" class="difflineplus">+    type: 8,</span>
<a href="#l12.45"></a><span id="l12.45" class="difflineplus">+    targetApplications: [{</span>
<a href="#l12.46"></a><span id="l12.46" class="difflineplus">+      id: &quot;xpcshell@tests.mozilla.org&quot;,</span>
<a href="#l12.47"></a><span id="l12.47" class="difflineplus">+      minVersion: &quot;1&quot;,</span>
<a href="#l12.48"></a><span id="l12.48" class="difflineplus">+      maxVersion: &quot;1&quot;,</span>
<a href="#l12.49"></a><span id="l12.49" class="difflineplus">+    }],</span>
<a href="#l12.50"></a><span id="l12.50" class="difflineplus">+    name: &quot;Invalid install.rdf extension&quot;,</span>
<a href="#l12.51"></a><span id="l12.51" class="difflineplus">+  }, userExtensions, undefined, {</span>
<a href="#l12.52"></a><span id="l12.52" class="difflineplus">+    &quot;chrome.manifest&quot;: `</span>
<a href="#l12.53"></a><span id="l12.53" class="difflineplus">+      content foo-langpack ./</span>
<a href="#l12.54"></a><span id="l12.54" class="difflineplus">+    `,</span>
<a href="#l12.55"></a><span id="l12.55" class="difflineplus">+  });</span>
<a href="#l12.56"></a><span id="l12.56" class="difflineplus">+</span>
<a href="#l12.57"></a><span id="l12.57" class="difflineplus">+  await promiseWriteInstallRDFToXPI({</span>
<a href="#l12.58"></a><span id="l12.58" class="difflineplus">+    id: &quot;foo@addons.mozilla.org&quot;,</span>
<a href="#l12.59"></a><span id="l12.59" class="difflineplus">+    version: &quot;1.0&quot;,</span>
<a href="#l12.60"></a><span id="l12.60" class="difflineplus">+    bootstrap: true,</span>
<a href="#l12.61"></a><span id="l12.61" class="difflineplus">+    targetApplications: [{</span>
<a href="#l12.62"></a><span id="l12.62" class="difflineplus">+      id: &quot;xpcshell@tests.mozilla.org&quot;,</span>
<a href="#l12.63"></a><span id="l12.63" class="difflineplus">+      minVersion: &quot;1&quot;,</span>
<a href="#l12.64"></a><span id="l12.64" class="difflineplus">+      maxVersion: &quot;1&quot;,</span>
<a href="#l12.65"></a><span id="l12.65" class="difflineplus">+    }],</span>
<a href="#l12.66"></a><span id="l12.66" class="difflineplus">+    name: &quot;Invalid install.rdf extension&quot;,</span>
<a href="#l12.67"></a><span id="l12.67" class="difflineplus">+  }, userExtensions, undefined, {</span>
<a href="#l12.68"></a><span id="l12.68" class="difflineplus">+    &quot;chrome.manifest&quot;: `</span>
<a href="#l12.69"></a><span id="l12.69" class="difflineplus">+      content foo ./</span>
<a href="#l12.70"></a><span id="l12.70" class="difflineplus">+    `,</span>
<a href="#l12.71"></a><span id="l12.71" class="difflineplus">+  });</span>
<a href="#l12.72"></a><span id="l12.72" class="difflineplus">+</span>
<a href="#l12.73"></a><span id="l12.73" class="difflineplus">+  await promiseWriteInstallRDFToXPI({</span>
<a href="#l12.74"></a><span id="l12.74" class="difflineplus">+    id: &quot;foo-legacy-legacy@addons.mozilla.org&quot;,</span>
<a href="#l12.75"></a><span id="l12.75" class="difflineplus">+    version: &quot;1.0&quot;,</span>
<a href="#l12.76"></a><span id="l12.76" class="difflineplus">+    bootstrap: false,</span>
<a href="#l12.77"></a><span id="l12.77" class="difflineplus">+    targetApplications: [{</span>
<a href="#l12.78"></a><span id="l12.78" class="difflineplus">+      id: &quot;xpcshell@tests.mozilla.org&quot;,</span>
<a href="#l12.79"></a><span id="l12.79" class="difflineplus">+      minVersion: &quot;1&quot;,</span>
<a href="#l12.80"></a><span id="l12.80" class="difflineplus">+      maxVersion: &quot;1&quot;,</span>
<a href="#l12.81"></a><span id="l12.81" class="difflineplus">+    }],</span>
<a href="#l12.82"></a><span id="l12.82" class="difflineplus">+    name: &quot;Invalid install.rdf extension&quot;,</span>
<a href="#l12.83"></a><span id="l12.83" class="difflineplus">+  }, userExtensions, undefined, {</span>
<a href="#l12.84"></a><span id="l12.84" class="difflineplus">+    &quot;chrome.manifest&quot;: `</span>
<a href="#l12.85"></a><span id="l12.85" class="difflineplus">+      content foo-legacy-legacy ./</span>
<a href="#l12.86"></a><span id="l12.86" class="difflineplus">+    `,</span>
<a href="#l12.87"></a><span id="l12.87" class="difflineplus">+  });</span>
<a href="#l12.88"></a><span id="l12.88" class="difflineplus">+</span>
<a href="#l12.89"></a><span id="l12.89" class="difflineplus">+  equal(hasChromeEntry(&quot;foo-langpack&quot;), false,</span>
<a href="#l12.90"></a><span id="l12.90" class="difflineplus">+        &quot;Should not have registered foo-langpack resource before AOM startup&quot;);</span>
<a href="#l12.91"></a><span id="l12.91" class="difflineplus">+  equal(hasChromeEntry(&quot;foo-legacy-legacy&quot;), false,</span>
<a href="#l12.92"></a><span id="l12.92" class="difflineplus">+        &quot;Should not have registered foo-legacy-legacy resource before AOM startup&quot;);</span>
<a href="#l12.93"></a><span id="l12.93" class="difflineplus">+  equal(hasChromeEntry(&quot;foo&quot;), false,</span>
<a href="#l12.94"></a><span id="l12.94" class="difflineplus">+        &quot;Should not have registered foo resource before AOM startup&quot;);</span>
<a href="#l12.95"></a><span id="l12.95" class="difflineplus">+</span>
<a href="#l12.96"></a><span id="l12.96" class="difflineplus">+  await promiseStartupManager();</span>
<a href="#l12.97"></a><span id="l12.97" class="difflineplus">+</span>
<a href="#l12.98"></a><span id="l12.98" class="difflineplus">+  equal(hasChromeEntry(&quot;foo-langpack&quot;), false,</span>
<a href="#l12.99"></a><span id="l12.99" class="difflineplus">+        &quot;Should not have registered chrome manifest for invalid extension&quot;);</span>
<a href="#l12.100"></a><span id="l12.100" class="difflineplus">+  equal(hasChromeEntry(&quot;foo-legacy-legacy&quot;), false,</span>
<a href="#l12.101"></a><span id="l12.101" class="difflineplus">+        &quot;Should not have registered chrome manifest for non-restartless extension&quot;);</span>
<a href="#l12.102"></a><span id="l12.102" class="difflineplus">+  equal(hasChromeEntry(&quot;foo&quot;), true,</span>
<a href="#l12.103"></a><span id="l12.103" class="difflineplus">+        &quot;Should have registered chrome manifest for valid extension&quot;);</span>
<a href="#l12.104"></a><span id="l12.104" class="difflineplus">+</span>
<a href="#l12.105"></a><span id="l12.105" class="difflineplus">+  await promiseRestartManager();</span>
<a href="#l12.106"></a><span id="l12.106" class="difflineplus">+</span>
<a href="#l12.107"></a><span id="l12.107" class="difflineplus">+  equal(hasChromeEntry(&quot;foo-langpack&quot;), false,</span>
<a href="#l12.108"></a><span id="l12.108" class="difflineplus">+        &quot;Should still not have registered chrome manifest for invalid extension after restart&quot;);</span>
<a href="#l12.109"></a><span id="l12.109" class="difflineplus">+  equal(hasChromeEntry(&quot;foo-legacy-legacy&quot;), false,</span>
<a href="#l12.110"></a><span id="l12.110" class="difflineplus">+        &quot;Should still not have registered chrome manifest for non-restartless extension&quot;);</span>
<a href="#l12.111"></a><span id="l12.111" class="difflineplus">+  equal(hasChromeEntry(&quot;foo&quot;), true,</span>
<a href="#l12.112"></a><span id="l12.112" class="difflineplus">+        &quot;Should still have registered chrome manifest for valid extension after restart&quot;);</span>
<a href="#l12.113"></a><span id="l12.113" class="difflineplus">+</span>
<a href="#l12.114"></a><span id="l12.114" class="difflineplus">+  await promiseShutdownManager();</span>
<a href="#l12.115"></a><span id="l12.115" class="difflineplus">+</span>
<a href="#l12.116"></a><span id="l12.116" class="difflineplus">+  userAppDir.remove(true);</span>
<a href="#l12.117"></a><span id="l12.117" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1">new file mode 100644</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineminus">--- /dev/null</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineplus">+++ b/common/test/xpcshell/test_manifest.js</span>
<a href="#l13.4"></a><span id="l13.4" class="difflineat">@@ -0,0 +1,752 @@</span>
<a href="#l13.5"></a><span id="l13.5" class="difflineplus">+/* Any copyright is dedicated to the Public Domain.</span>
<a href="#l13.6"></a><span id="l13.6" class="difflineplus">+ * http://creativecommons.org/publicdomain/zero/1.0/</span>
<a href="#l13.7"></a><span id="l13.7" class="difflineplus">+ */</span>
<a href="#l13.8"></a><span id="l13.8" class="difflineplus">+</span>
<a href="#l13.9"></a><span id="l13.9" class="difflineplus">+// This tests that all properties are read from the install manifests and that</span>
<a href="#l13.10"></a><span id="l13.10" class="difflineplus">+// items are correctly enabled/disabled based on them (blocklist tests are</span>
<a href="#l13.11"></a><span id="l13.11" class="difflineplus">+// elsewhere)</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+const ADDONS = [</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineplus">+  {</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineplus">+    &quot;install.rdf&quot;: {</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineplus">+      id: &quot;addon1@tests.mozilla.org&quot;,</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineplus">+      version: &quot;1.0&quot;,</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineplus">+      bootstrap: true,</span>
<a href="#l13.19"></a><span id="l13.19" class="difflineplus">+      aboutURL: &quot;chrome://test/content/about.xul&quot;,</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineplus">+      iconURL: &quot;chrome://test/skin/icon.png&quot;,</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineplus">+      targetApplications: [{</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineplus">+        id: &quot;xpcshell@tests.mozilla.org&quot;,</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineplus">+        minVersion: &quot;1&quot;,</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineplus">+        maxVersion: &quot;1&quot;,</span>
<a href="#l13.25"></a><span id="l13.25" class="difflineplus">+      }],</span>
<a href="#l13.26"></a><span id="l13.26" class="difflineplus">+      name: &quot;Test Addon 1&quot;,</span>
<a href="#l13.27"></a><span id="l13.27" class="difflineplus">+      description: &quot;Test Description&quot;,</span>
<a href="#l13.28"></a><span id="l13.28" class="difflineplus">+      creator: &quot;Test Creator&quot;,</span>
<a href="#l13.29"></a><span id="l13.29" class="difflineplus">+      homepageURL: &quot;http://www.example.com&quot;,</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineplus">+      developer: [</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineplus">+        &quot;Test Developer 1&quot;,</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineplus">+        &quot;Test Developer 2&quot;,</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineplus">+      ],</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineplus">+      translator: [</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineplus">+        &quot;Test Translator 1&quot;,</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineplus">+        &quot;Test Translator 2&quot;,</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineplus">+      ],</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineplus">+      contributor: [</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineplus">+        &quot;Test Contributor 1&quot;,</span>
<a href="#l13.40"></a><span id="l13.40" class="difflineplus">+        &quot;Test Contributor 2&quot;,</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineplus">+      ],</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineplus">+    },</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineplus">+</span>
<a href="#l13.44"></a><span id="l13.44" class="difflineplus">+    expected: {</span>
<a href="#l13.45"></a><span id="l13.45" class="difflineplus">+      id: &quot;addon1@tests.mozilla.org&quot;,</span>
<a href="#l13.46"></a><span id="l13.46" class="difflineplus">+      type: &quot;extension&quot;,</span>
<a href="#l13.47"></a><span id="l13.47" class="difflineplus">+      version: &quot;1.0&quot;,</span>
<a href="#l13.48"></a><span id="l13.48" class="difflineplus">+      optionsType: null,</span>
<a href="#l13.49"></a><span id="l13.49" class="difflineplus">+      aboutURL: &quot;chrome://test/content/about.xul&quot;,</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineplus">+      iconURL: &quot;chrome://test/skin/icon.png&quot;,</span>
<a href="#l13.51"></a><span id="l13.51" class="difflineplus">+      icons: {32: &quot;chrome://test/skin/icon.png&quot;, 48: &quot;chrome://test/skin/icon.png&quot;},</span>
<a href="#l13.52"></a><span id="l13.52" class="difflineplus">+      name: &quot;Test Addon 1&quot;,</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineplus">+      description: &quot;Test Description&quot;,</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineplus">+      creator: &quot;Test Creator&quot;,</span>
<a href="#l13.55"></a><span id="l13.55" class="difflineplus">+      homepageURL: &quot;http://www.example.com&quot;,</span>
<a href="#l13.56"></a><span id="l13.56" class="difflineplus">+      developers: [&quot;Test Developer 1&quot;, &quot;Test Developer 2&quot;],</span>
<a href="#l13.57"></a><span id="l13.57" class="difflineplus">+      translators: [&quot;Test Translator 1&quot;, &quot;Test Translator 2&quot;],</span>
<a href="#l13.58"></a><span id="l13.58" class="difflineplus">+      contributors: [&quot;Test Contributor 1&quot;, &quot;Test Contributor 2&quot;],</span>
<a href="#l13.59"></a><span id="l13.59" class="difflineplus">+      isActive: true,</span>
<a href="#l13.60"></a><span id="l13.60" class="difflineplus">+      userDisabled: false,</span>
<a href="#l13.61"></a><span id="l13.61" class="difflineplus">+      appDisabled: false,</span>
<a href="#l13.62"></a><span id="l13.62" class="difflineplus">+      isCompatible: true,</span>
<a href="#l13.63"></a><span id="l13.63" class="difflineplus">+      providesUpdatesSecurely: true,</span>
<a href="#l13.64"></a><span id="l13.64" class="difflineplus">+      blocklistState: Ci.nsIBlocklistService.STATE_NOT_BLOCKED,</span>
<a href="#l13.65"></a><span id="l13.65" class="difflineplus">+    },</span>
<a href="#l13.66"></a><span id="l13.66" class="difflineplus">+  },</span>
<a href="#l13.67"></a><span id="l13.67" class="difflineplus">+</span>
<a href="#l13.68"></a><span id="l13.68" class="difflineplus">+  {</span>
<a href="#l13.69"></a><span id="l13.69" class="difflineplus">+    &quot;install.rdf&quot;: {</span>
<a href="#l13.70"></a><span id="l13.70" class="difflineplus">+      id: &quot;addon2@tests.mozilla.org&quot;,</span>
<a href="#l13.71"></a><span id="l13.71" class="difflineplus">+      version: &quot;1.0&quot;,</span>
<a href="#l13.72"></a><span id="l13.72" class="difflineplus">+      bootstrap: true,</span>
<a href="#l13.73"></a><span id="l13.73" class="difflineplus">+      updateURL: &quot;https://www.foo.com&quot;,</span>
<a href="#l13.74"></a><span id="l13.74" class="difflineplus">+      targetApplications: [{</span>
<a href="#l13.75"></a><span id="l13.75" class="difflineplus">+        id: &quot;xpcshell@tests.mozilla.org&quot;,</span>
<a href="#l13.76"></a><span id="l13.76" class="difflineplus">+        minVersion: &quot;1&quot;,</span>
<a href="#l13.77"></a><span id="l13.77" class="difflineplus">+        maxVersion: &quot;1&quot;,</span>
<a href="#l13.78"></a><span id="l13.78" class="difflineplus">+      }],</span>
<a href="#l13.79"></a><span id="l13.79" class="difflineplus">+      name: &quot;Test Addon 2&quot;,</span>
<a href="#l13.80"></a><span id="l13.80" class="difflineplus">+    },</span>
<a href="#l13.81"></a><span id="l13.81" class="difflineplus">+</span>
<a href="#l13.82"></a><span id="l13.82" class="difflineplus">+    expected: {</span>
<a href="#l13.83"></a><span id="l13.83" class="difflineplus">+      id: &quot;addon2@tests.mozilla.org&quot;,</span>
<a href="#l13.84"></a><span id="l13.84" class="difflineplus">+      isActive: true,</span>
<a href="#l13.85"></a><span id="l13.85" class="difflineplus">+      userDisabled: false,</span>
<a href="#l13.86"></a><span id="l13.86" class="difflineplus">+      appDisabled: false,</span>
<a href="#l13.87"></a><span id="l13.87" class="difflineplus">+      providesUpdatesSecurely: true,</span>
<a href="#l13.88"></a><span id="l13.88" class="difflineplus">+    },</span>
<a href="#l13.89"></a><span id="l13.89" class="difflineplus">+  },</span>
<a href="#l13.90"></a><span id="l13.90" class="difflineplus">+</span>
<a href="#l13.91"></a><span id="l13.91" class="difflineplus">+  {</span>
<a href="#l13.92"></a><span id="l13.92" class="difflineplus">+    &quot;install.rdf&quot;: {</span>
<a href="#l13.93"></a><span id="l13.93" class="difflineplus">+      id: &quot;addon3@tests.mozilla.org&quot;,</span>
<a href="#l13.94"></a><span id="l13.94" class="difflineplus">+      version: &quot;1.0&quot;,</span>
<a href="#l13.95"></a><span id="l13.95" class="difflineplus">+      bootstrap: true,</span>
<a href="#l13.96"></a><span id="l13.96" class="difflineplus">+      updateURL: &quot;http://www.foo.com&quot;,</span>
<a href="#l13.97"></a><span id="l13.97" class="difflineplus">+      targetApplications: [{</span>
<a href="#l13.98"></a><span id="l13.98" class="difflineplus">+        id: &quot;xpcshell@tests.mozilla.org&quot;,</span>
<a href="#l13.99"></a><span id="l13.99" class="difflineplus">+        minVersion: &quot;1&quot;,</span>
<a href="#l13.100"></a><span id="l13.100" class="difflineplus">+        maxVersion: &quot;1&quot;,</span>
<a href="#l13.101"></a><span id="l13.101" class="difflineplus">+      }],</span>
<a href="#l13.102"></a><span id="l13.102" class="difflineplus">+      name: &quot;Test Addon 3&quot;,</span>
<a href="#l13.103"></a><span id="l13.103" class="difflineplus">+    },</span>
<a href="#l13.104"></a><span id="l13.104" class="difflineplus">+</span>
<a href="#l13.105"></a><span id="l13.105" class="difflineplus">+    expected: {</span>
<a href="#l13.106"></a><span id="l13.106" class="difflineplus">+      id: &quot;addon3@tests.mozilla.org&quot;,</span>
<a href="#l13.107"></a><span id="l13.107" class="difflineplus">+      isActive: false,</span>
<a href="#l13.108"></a><span id="l13.108" class="difflineplus">+      userDisabled: false,</span>
<a href="#l13.109"></a><span id="l13.109" class="difflineplus">+      appDisabled: true,</span>
<a href="#l13.110"></a><span id="l13.110" class="difflineplus">+      providesUpdatesSecurely: false,</span>
<a href="#l13.111"></a><span id="l13.111" class="difflineplus">+    },</span>
<a href="#l13.112"></a><span id="l13.112" class="difflineplus">+  },</span>
<a href="#l13.113"></a><span id="l13.113" class="difflineplus">+</span>
<a href="#l13.114"></a><span id="l13.114" class="difflineplus">+  {</span>
<a href="#l13.115"></a><span id="l13.115" class="difflineplus">+    &quot;install.rdf&quot;: {</span>
<a href="#l13.116"></a><span id="l13.116" class="difflineplus">+      id: &quot;addon4@tests.mozilla.org&quot;,</span>
<a href="#l13.117"></a><span id="l13.117" class="difflineplus">+      version: &quot;1.0&quot;,</span>
<a href="#l13.118"></a><span id="l13.118" class="difflineplus">+      bootstrap: true,</span>
<a href="#l13.119"></a><span id="l13.119" class="difflineplus">+      updateURL: &quot;http://www.foo.com&quot;,</span>
<a href="#l13.120"></a><span id="l13.120" class="difflineplus">+      updateKey: &quot;foo&quot;,</span>
<a href="#l13.121"></a><span id="l13.121" class="difflineplus">+      targetApplications: [{</span>
<a href="#l13.122"></a><span id="l13.122" class="difflineplus">+        id: &quot;xpcshell@tests.mozilla.org&quot;,</span>
<a href="#l13.123"></a><span id="l13.123" class="difflineplus">+        minVersion: &quot;1&quot;,</span>
<a href="#l13.124"></a><span id="l13.124" class="difflineplus">+        maxVersion: &quot;1&quot;,</span>
<a href="#l13.125"></a><span id="l13.125" class="difflineplus">+      }],</span>
<a href="#l13.126"></a><span id="l13.126" class="difflineplus">+      name: &quot;Test Addon 4&quot;,</span>
<a href="#l13.127"></a><span id="l13.127" class="difflineplus">+    },</span>
<a href="#l13.128"></a><span id="l13.128" class="difflineplus">+</span>
<a href="#l13.129"></a><span id="l13.129" class="difflineplus">+    expected: {</span>
<a href="#l13.130"></a><span id="l13.130" class="difflineplus">+      id: &quot;addon4@tests.mozilla.org&quot;,</span>
<a href="#l13.131"></a><span id="l13.131" class="difflineplus">+      isActive: false,</span>
<a href="#l13.132"></a><span id="l13.132" class="difflineplus">+      userDisabled: false,</span>
<a href="#l13.133"></a><span id="l13.133" class="difflineplus">+      appDisabled: true,</span>
<a href="#l13.134"></a><span id="l13.134" class="difflineplus">+      providesUpdatesSecurely: false,</span>
<a href="#l13.135"></a><span id="l13.135" class="difflineplus">+    },</span>
<a href="#l13.136"></a><span id="l13.136" class="difflineplus">+  },</span>
<a href="#l13.137"></a><span id="l13.137" class="difflineplus">+</span>
<a href="#l13.138"></a><span id="l13.138" class="difflineplus">+  {</span>
<a href="#l13.139"></a><span id="l13.139" class="difflineplus">+    &quot;install.rdf&quot;: {</span>
<a href="#l13.140"></a><span id="l13.140" class="difflineplus">+      id: &quot;addon5@tests.mozilla.org&quot;,</span>
<a href="#l13.141"></a><span id="l13.141" class="difflineplus">+      version: &quot;1.0&quot;,</span>
<a href="#l13.142"></a><span id="l13.142" class="difflineplus">+      bootstrap: true,</span>
<a href="#l13.143"></a><span id="l13.143" class="difflineplus">+      targetApplications: [{</span>
<a href="#l13.144"></a><span id="l13.144" class="difflineplus">+        id: &quot;xpcshell@tests.mozilla.org&quot;,</span>
<a href="#l13.145"></a><span id="l13.145" class="difflineplus">+        minVersion: &quot;1&quot;,</span>
<a href="#l13.146"></a><span id="l13.146" class="difflineplus">+        maxVersion: &quot;*&quot;,</span>
<a href="#l13.147"></a><span id="l13.147" class="difflineplus">+      }],</span>
<a href="#l13.148"></a><span id="l13.148" class="difflineplus">+      name: &quot;Test Addon 5&quot;,</span>
<a href="#l13.149"></a><span id="l13.149" class="difflineplus">+    },</span>
<a href="#l13.150"></a><span id="l13.150" class="difflineplus">+</span>
<a href="#l13.151"></a><span id="l13.151" class="difflineplus">+    expected: {</span>
<a href="#l13.152"></a><span id="l13.152" class="difflineplus">+      isActive: true,</span>
<a href="#l13.153"></a><span id="l13.153" class="difflineplus">+      userDisabled: false,</span>
<a href="#l13.154"></a><span id="l13.154" class="difflineplus">+      appDisabled: false,</span>
<a href="#l13.155"></a><span id="l13.155" class="difflineplus">+      isCompatible: true,</span>
<a href="#l13.156"></a><span id="l13.156" class="difflineplus">+    },</span>
<a href="#l13.157"></a><span id="l13.157" class="difflineplus">+  },</span>
<a href="#l13.158"></a><span id="l13.158" class="difflineplus">+</span>
<a href="#l13.159"></a><span id="l13.159" class="difflineplus">+  {</span>
<a href="#l13.160"></a><span id="l13.160" class="difflineplus">+    &quot;install.rdf&quot;: {</span>
<a href="#l13.161"></a><span id="l13.161" class="difflineplus">+      id: &quot;addon6@tests.mozilla.org&quot;,</span>
<a href="#l13.162"></a><span id="l13.162" class="difflineplus">+      version: &quot;1.0&quot;,</span>
<a href="#l13.163"></a><span id="l13.163" class="difflineplus">+      bootstrap: true,</span>
<a href="#l13.164"></a><span id="l13.164" class="difflineplus">+      targetApplications: [{</span>
<a href="#l13.165"></a><span id="l13.165" class="difflineplus">+        id: &quot;xpcshell@tests.mozilla.org&quot;,</span>
<a href="#l13.166"></a><span id="l13.166" class="difflineplus">+        minVersion: &quot;0&quot;,</span>
<a href="#l13.167"></a><span id="l13.167" class="difflineplus">+        maxVersion: &quot;1&quot;,</span>
<a href="#l13.168"></a><span id="l13.168" class="difflineplus">+      }],</span>
<a href="#l13.169"></a><span id="l13.169" class="difflineplus">+      name: &quot;Test Addon 6&quot;,</span>
<a href="#l13.170"></a><span id="l13.170" class="difflineplus">+    },</span>
<a href="#l13.171"></a><span id="l13.171" class="difflineplus">+</span>
<a href="#l13.172"></a><span id="l13.172" class="difflineplus">+    expected: {</span>
<a href="#l13.173"></a><span id="l13.173" class="difflineplus">+      isActive: true,</span>
<a href="#l13.174"></a><span id="l13.174" class="difflineplus">+      userDisabled: false,</span>
<a href="#l13.175"></a><span id="l13.175" class="difflineplus">+      appDisabled: false,</span>
<a href="#l13.176"></a><span id="l13.176" class="difflineplus">+      isCompatible: true,</span>
<a href="#l13.177"></a><span id="l13.177" class="difflineplus">+    },</span>
<a href="#l13.178"></a><span id="l13.178" class="difflineplus">+  },</span>
<a href="#l13.179"></a><span id="l13.179" class="difflineplus">+</span>
<a href="#l13.180"></a><span id="l13.180" class="difflineplus">+  {</span>
<a href="#l13.181"></a><span id="l13.181" class="difflineplus">+    &quot;install.rdf&quot;: {</span>
<a href="#l13.182"></a><span id="l13.182" class="difflineplus">+      id: &quot;addon7@tests.mozilla.org&quot;,</span>
<a href="#l13.183"></a><span id="l13.183" class="difflineplus">+      version: &quot;1.0&quot;,</span>
<a href="#l13.184"></a><span id="l13.184" class="difflineplus">+      bootstrap: true,</span>
<a href="#l13.185"></a><span id="l13.185" class="difflineplus">+      targetApplications: [{</span>
<a href="#l13.186"></a><span id="l13.186" class="difflineplus">+        id: &quot;xpcshell@tests.mozilla.org&quot;,</span>
<a href="#l13.187"></a><span id="l13.187" class="difflineplus">+        minVersion: &quot;0&quot;,</span>
<a href="#l13.188"></a><span id="l13.188" class="difflineplus">+        maxVersion: &quot;0&quot;,</span>
<a href="#l13.189"></a><span id="l13.189" class="difflineplus">+      }],</span>
<a href="#l13.190"></a><span id="l13.190" class="difflineplus">+      name: &quot;Test Addon 7&quot;,</span>
<a href="#l13.191"></a><span id="l13.191" class="difflineplus">+    },</span>
<a href="#l13.192"></a><span id="l13.192" class="difflineplus">+</span>
<a href="#l13.193"></a><span id="l13.193" class="difflineplus">+    expected: {</span>
<a href="#l13.194"></a><span id="l13.194" class="difflineplus">+      isActive: false,</span>
<a href="#l13.195"></a><span id="l13.195" class="difflineplus">+      userDisabled: false,</span>
<a href="#l13.196"></a><span id="l13.196" class="difflineplus">+      appDisabled: true,</span>
<a href="#l13.197"></a><span id="l13.197" class="difflineplus">+      isCompatible: false,</span>
<a href="#l13.198"></a><span id="l13.198" class="difflineplus">+    },</span>
<a href="#l13.199"></a><span id="l13.199" class="difflineplus">+  },</span>
<a href="#l13.200"></a><span id="l13.200" class="difflineplus">+</span>
<a href="#l13.201"></a><span id="l13.201" class="difflineplus">+  {</span>
<a href="#l13.202"></a><span id="l13.202" class="difflineplus">+    &quot;install.rdf&quot;: {</span>
<a href="#l13.203"></a><span id="l13.203" class="difflineplus">+      id: &quot;addon8@tests.mozilla.org&quot;,</span>
<a href="#l13.204"></a><span id="l13.204" class="difflineplus">+      version: &quot;1.0&quot;,</span>
<a href="#l13.205"></a><span id="l13.205" class="difflineplus">+      bootstrap: true,</span>
<a href="#l13.206"></a><span id="l13.206" class="difflineplus">+      targetApplications: [{</span>
<a href="#l13.207"></a><span id="l13.207" class="difflineplus">+        id: &quot;xpcshell@tests.mozilla.org&quot;,</span>
<a href="#l13.208"></a><span id="l13.208" class="difflineplus">+        minVersion: &quot;1.1&quot;,</span>
<a href="#l13.209"></a><span id="l13.209" class="difflineplus">+        maxVersion: &quot;*&quot;,</span>
<a href="#l13.210"></a><span id="l13.210" class="difflineplus">+      }],</span>
<a href="#l13.211"></a><span id="l13.211" class="difflineplus">+      name: &quot;Test Addon 8&quot;,</span>
<a href="#l13.212"></a><span id="l13.212" class="difflineplus">+    },</span>
<a href="#l13.213"></a><span id="l13.213" class="difflineplus">+</span>
<a href="#l13.214"></a><span id="l13.214" class="difflineplus">+    expected: {</span>
<a href="#l13.215"></a><span id="l13.215" class="difflineplus">+      isActive: false,</span>
<a href="#l13.216"></a><span id="l13.216" class="difflineplus">+      userDisabled: false,</span>
<a href="#l13.217"></a><span id="l13.217" class="difflineplus">+      appDisabled: true,</span>
<a href="#l13.218"></a><span id="l13.218" class="difflineplus">+      isCompatible: false,</span>
<a href="#l13.219"></a><span id="l13.219" class="difflineplus">+    },</span>
<a href="#l13.220"></a><span id="l13.220" class="difflineplus">+  },</span>
<a href="#l13.221"></a><span id="l13.221" class="difflineplus">+</span>
<a href="#l13.222"></a><span id="l13.222" class="difflineplus">+  {</span>
<a href="#l13.223"></a><span id="l13.223" class="difflineplus">+    &quot;install.rdf&quot;: {</span>
<a href="#l13.224"></a><span id="l13.224" class="difflineplus">+      id: &quot;addon9@tests.mozilla.org&quot;,</span>
<a href="#l13.225"></a><span id="l13.225" class="difflineplus">+      version: &quot;1.0&quot;,</span>
<a href="#l13.226"></a><span id="l13.226" class="difflineplus">+      bootstrap: true,</span>
<a href="#l13.227"></a><span id="l13.227" class="difflineplus">+      targetApplications: [{</span>
<a href="#l13.228"></a><span id="l13.228" class="difflineplus">+        id: &quot;toolkit@mozilla.org&quot;,</span>
<a href="#l13.229"></a><span id="l13.229" class="difflineplus">+        minVersion: &quot;1.9.2&quot;,</span>
<a href="#l13.230"></a><span id="l13.230" class="difflineplus">+        maxVersion: &quot;1.9.*&quot;,</span>
<a href="#l13.231"></a><span id="l13.231" class="difflineplus">+      }],</span>
<a href="#l13.232"></a><span id="l13.232" class="difflineplus">+      name: &quot;Test Addon 9&quot;,</span>
<a href="#l13.233"></a><span id="l13.233" class="difflineplus">+    },</span>
<a href="#l13.234"></a><span id="l13.234" class="difflineplus">+</span>
<a href="#l13.235"></a><span id="l13.235" class="difflineplus">+    expected: {</span>
<a href="#l13.236"></a><span id="l13.236" class="difflineplus">+      isActive: true,</span>
<a href="#l13.237"></a><span id="l13.237" class="difflineplus">+      userDisabled: false,</span>
<a href="#l13.238"></a><span id="l13.238" class="difflineplus">+      appDisabled: false,</span>
<a href="#l13.239"></a><span id="l13.239" class="difflineplus">+      isCompatible: true,</span>
<a href="#l13.240"></a><span id="l13.240" class="difflineplus">+    },</span>
<a href="#l13.241"></a><span id="l13.241" class="difflineplus">+  },</span>
<a href="#l13.242"></a><span id="l13.242" class="difflineplus">+</span>
<a href="#l13.243"></a><span id="l13.243" class="difflineplus">+  {</span>
<a href="#l13.244"></a><span id="l13.244" class="difflineplus">+    &quot;install.rdf&quot;: {</span>
<a href="#l13.245"></a><span id="l13.245" class="difflineplus">+      id: &quot;addon10@tests.mozilla.org&quot;,</span>
<a href="#l13.246"></a><span id="l13.246" class="difflineplus">+      version: &quot;1.0&quot;,</span>
<a href="#l13.247"></a><span id="l13.247" class="difflineplus">+      bootstrap: true,</span>
<a href="#l13.248"></a><span id="l13.248" class="difflineplus">+      targetApplications: [{</span>
<a href="#l13.249"></a><span id="l13.249" class="difflineplus">+        id: &quot;toolkit@mozilla.org&quot;,</span>
<a href="#l13.250"></a><span id="l13.250" class="difflineplus">+        minVersion: &quot;1.9.2.1&quot;,</span>
<a href="#l13.251"></a><span id="l13.251" class="difflineplus">+        maxVersion: &quot;1.9.*&quot;,</span>
<a href="#l13.252"></a><span id="l13.252" class="difflineplus">+      }],</span>
<a href="#l13.253"></a><span id="l13.253" class="difflineplus">+      name: &quot;Test Addon 10&quot;,</span>
<a href="#l13.254"></a><span id="l13.254" class="difflineplus">+    },</span>
<a href="#l13.255"></a><span id="l13.255" class="difflineplus">+</span>
<a href="#l13.256"></a><span id="l13.256" class="difflineplus">+    expected: {</span>
<a href="#l13.257"></a><span id="l13.257" class="difflineplus">+      isActive: false,</span>
<a href="#l13.258"></a><span id="l13.258" class="difflineplus">+      userDisabled: false,</span>
<a href="#l13.259"></a><span id="l13.259" class="difflineplus">+      appDisabled: true,</span>
<a href="#l13.260"></a><span id="l13.260" class="difflineplus">+      isCompatible: false,</span>
<a href="#l13.261"></a><span id="l13.261" class="difflineplus">+    },</span>
<a href="#l13.262"></a><span id="l13.262" class="difflineplus">+  },</span>
<a href="#l13.263"></a><span id="l13.263" class="difflineplus">+</span>
<a href="#l13.264"></a><span id="l13.264" class="difflineplus">+  {</span>
<a href="#l13.265"></a><span id="l13.265" class="difflineplus">+    &quot;install.rdf&quot;: {</span>
<a href="#l13.266"></a><span id="l13.266" class="difflineplus">+      id: &quot;addon11@tests.mozilla.org&quot;,</span>
<a href="#l13.267"></a><span id="l13.267" class="difflineplus">+      version: &quot;1.0&quot;,</span>
<a href="#l13.268"></a><span id="l13.268" class="difflineplus">+      bootstrap: true,</span>
<a href="#l13.269"></a><span id="l13.269" class="difflineplus">+      targetApplications: [{</span>
<a href="#l13.270"></a><span id="l13.270" class="difflineplus">+        id: &quot;toolkit@mozilla.org&quot;,</span>
<a href="#l13.271"></a><span id="l13.271" class="difflineplus">+        minVersion: &quot;1.9&quot;,</span>
<a href="#l13.272"></a><span id="l13.272" class="difflineplus">+        maxVersion: &quot;1.9.2&quot;,</span>
<a href="#l13.273"></a><span id="l13.273" class="difflineplus">+      }],</span>
<a href="#l13.274"></a><span id="l13.274" class="difflineplus">+      name: &quot;Test Addon 11&quot;,</span>
<a href="#l13.275"></a><span id="l13.275" class="difflineplus">+    },</span>
<a href="#l13.276"></a><span id="l13.276" class="difflineplus">+</span>
<a href="#l13.277"></a><span id="l13.277" class="difflineplus">+    expected: {</span>
<a href="#l13.278"></a><span id="l13.278" class="difflineplus">+      isActive: true,</span>
<a href="#l13.279"></a><span id="l13.279" class="difflineplus">+      userDisabled: false,</span>
<a href="#l13.280"></a><span id="l13.280" class="difflineplus">+      appDisabled: false,</span>
<a href="#l13.281"></a><span id="l13.281" class="difflineplus">+      isCompatible: true,</span>
<a href="#l13.282"></a><span id="l13.282" class="difflineplus">+    },</span>
<a href="#l13.283"></a><span id="l13.283" class="difflineplus">+  },</span>
<a href="#l13.284"></a><span id="l13.284" class="difflineplus">+</span>
<a href="#l13.285"></a><span id="l13.285" class="difflineplus">+  {</span>
<a href="#l13.286"></a><span id="l13.286" class="difflineplus">+    &quot;install.rdf&quot;: {</span>
<a href="#l13.287"></a><span id="l13.287" class="difflineplus">+      id: &quot;addon12@tests.mozilla.org&quot;,</span>
<a href="#l13.288"></a><span id="l13.288" class="difflineplus">+      version: &quot;1.0&quot;,</span>
<a href="#l13.289"></a><span id="l13.289" class="difflineplus">+      bootstrap: true,</span>
<a href="#l13.290"></a><span id="l13.290" class="difflineplus">+      targetApplications: [{</span>
<a href="#l13.291"></a><span id="l13.291" class="difflineplus">+        id: &quot;toolkit@mozilla.org&quot;,</span>
<a href="#l13.292"></a><span id="l13.292" class="difflineplus">+        minVersion: &quot;1.9&quot;,</span>
<a href="#l13.293"></a><span id="l13.293" class="difflineplus">+        maxVersion: &quot;1.9.1.*&quot;,</span>
<a href="#l13.294"></a><span id="l13.294" class="difflineplus">+      }],</span>
<a href="#l13.295"></a><span id="l13.295" class="difflineplus">+      name: &quot;Test Addon 12&quot;,</span>
<a href="#l13.296"></a><span id="l13.296" class="difflineplus">+    },</span>
<a href="#l13.297"></a><span id="l13.297" class="difflineplus">+</span>
<a href="#l13.298"></a><span id="l13.298" class="difflineplus">+    expected: {</span>
<a href="#l13.299"></a><span id="l13.299" class="difflineplus">+      isActive: false,</span>
<a href="#l13.300"></a><span id="l13.300" class="difflineplus">+      userDisabled: false,</span>
<a href="#l13.301"></a><span id="l13.301" class="difflineplus">+      appDisabled: true,</span>
<a href="#l13.302"></a><span id="l13.302" class="difflineplus">+      isCompatible: false,</span>
<a href="#l13.303"></a><span id="l13.303" class="difflineplus">+    },</span>
<a href="#l13.304"></a><span id="l13.304" class="difflineplus">+  },</span>
<a href="#l13.305"></a><span id="l13.305" class="difflineplus">+</span>
<a href="#l13.306"></a><span id="l13.306" class="difflineplus">+  {</span>
<a href="#l13.307"></a><span id="l13.307" class="difflineplus">+    &quot;install.rdf&quot;: {</span>
<a href="#l13.308"></a><span id="l13.308" class="difflineplus">+      id: &quot;addon13@tests.mozilla.org&quot;,</span>
<a href="#l13.309"></a><span id="l13.309" class="difflineplus">+      version: &quot;1.0&quot;,</span>
<a href="#l13.310"></a><span id="l13.310" class="difflineplus">+      bootstrap: true,</span>
<a href="#l13.311"></a><span id="l13.311" class="difflineplus">+      targetApplications: [{</span>
<a href="#l13.312"></a><span id="l13.312" class="difflineplus">+        id: &quot;toolkit@mozilla.org&quot;,</span>
<a href="#l13.313"></a><span id="l13.313" class="difflineplus">+        minVersion: &quot;1.9&quot;,</span>
<a href="#l13.314"></a><span id="l13.314" class="difflineplus">+        maxVersion: &quot;1.9.*&quot;,</span>
<a href="#l13.315"></a><span id="l13.315" class="difflineplus">+      }, {</span>
<a href="#l13.316"></a><span id="l13.316" class="difflineplus">+        id: &quot;xpcshell@tests.mozilla.org&quot;,</span>
<a href="#l13.317"></a><span id="l13.317" class="difflineplus">+        minVersion: &quot;0&quot;,</span>
<a href="#l13.318"></a><span id="l13.318" class="difflineplus">+        maxVersion: &quot;0.5&quot;,</span>
<a href="#l13.319"></a><span id="l13.319" class="difflineplus">+      }],</span>
<a href="#l13.320"></a><span id="l13.320" class="difflineplus">+      name: &quot;Test Addon 13&quot;,</span>
<a href="#l13.321"></a><span id="l13.321" class="difflineplus">+    },</span>
<a href="#l13.322"></a><span id="l13.322" class="difflineplus">+</span>
<a href="#l13.323"></a><span id="l13.323" class="difflineplus">+    expected: {</span>
<a href="#l13.324"></a><span id="l13.324" class="difflineplus">+      isActive: false,</span>
<a href="#l13.325"></a><span id="l13.325" class="difflineplus">+      userDisabled: false,</span>
<a href="#l13.326"></a><span id="l13.326" class="difflineplus">+      appDisabled: true,</span>
<a href="#l13.327"></a><span id="l13.327" class="difflineplus">+      isCompatible: false,</span>
<a href="#l13.328"></a><span id="l13.328" class="difflineplus">+    },</span>
<a href="#l13.329"></a><span id="l13.329" class="difflineplus">+  },</span>
<a href="#l13.330"></a><span id="l13.330" class="difflineplus">+</span>
<a href="#l13.331"></a><span id="l13.331" class="difflineplus">+  {</span>
<a href="#l13.332"></a><span id="l13.332" class="difflineplus">+    &quot;install.rdf&quot;: {</span>
<a href="#l13.333"></a><span id="l13.333" class="difflineplus">+      id: &quot;addon14@tests.mozilla.org&quot;,</span>
<a href="#l13.334"></a><span id="l13.334" class="difflineplus">+      version: &quot;1.0&quot;,</span>
<a href="#l13.335"></a><span id="l13.335" class="difflineplus">+      bootstrap: true,</span>
<a href="#l13.336"></a><span id="l13.336" class="difflineplus">+      targetApplications: [{</span>
<a href="#l13.337"></a><span id="l13.337" class="difflineplus">+        id: &quot;toolkit@mozilla.org&quot;,</span>
<a href="#l13.338"></a><span id="l13.338" class="difflineplus">+        minVersion: &quot;1.9&quot;,</span>
<a href="#l13.339"></a><span id="l13.339" class="difflineplus">+        maxVersion: &quot;1.9.1&quot;,</span>
<a href="#l13.340"></a><span id="l13.340" class="difflineplus">+      }, {</span>
<a href="#l13.341"></a><span id="l13.341" class="difflineplus">+        id: &quot;xpcshell@tests.mozilla.org&quot;,</span>
<a href="#l13.342"></a><span id="l13.342" class="difflineplus">+        minVersion: &quot;1&quot;,</span>
<a href="#l13.343"></a><span id="l13.343" class="difflineplus">+        maxVersion: &quot;1&quot;,</span>
<a href="#l13.344"></a><span id="l13.344" class="difflineplus">+      }],</span>
<a href="#l13.345"></a><span id="l13.345" class="difflineplus">+      name: &quot;Test Addon 14&quot;,</span>
<a href="#l13.346"></a><span id="l13.346" class="difflineplus">+    },</span>
<a href="#l13.347"></a><span id="l13.347" class="difflineplus">+</span>
<a href="#l13.348"></a><span id="l13.348" class="difflineplus">+    expected: {</span>
<a href="#l13.349"></a><span id="l13.349" class="difflineplus">+      isActive: true,</span>
<a href="#l13.350"></a><span id="l13.350" class="difflineplus">+      userDisabled: false,</span>
<a href="#l13.351"></a><span id="l13.351" class="difflineplus">+      appDisabled: false,</span>
<a href="#l13.352"></a><span id="l13.352" class="difflineplus">+      isCompatible: true,</span>
<a href="#l13.353"></a><span id="l13.353" class="difflineplus">+    },</span>
<a href="#l13.354"></a><span id="l13.354" class="difflineplus">+  },</span>
<a href="#l13.355"></a><span id="l13.355" class="difflineplus">+</span>
<a href="#l13.356"></a><span id="l13.356" class="difflineplus">+  {</span>
<a href="#l13.357"></a><span id="l13.357" class="difflineplus">+    &quot;install.rdf&quot;: {</span>
<a href="#l13.358"></a><span id="l13.358" class="difflineplus">+      id: &quot;addon15@tests.mozilla.org&quot;,</span>
<a href="#l13.359"></a><span id="l13.359" class="difflineplus">+      version: &quot;1.0&quot;,</span>
<a href="#l13.360"></a><span id="l13.360" class="difflineplus">+      bootstrap: true,</span>
<a href="#l13.361"></a><span id="l13.361" class="difflineplus">+      updateKey: &quot;foo&quot;,</span>
<a href="#l13.362"></a><span id="l13.362" class="difflineplus">+      targetApplications: [{</span>
<a href="#l13.363"></a><span id="l13.363" class="difflineplus">+        id: &quot;xpcshell@tests.mozilla.org&quot;,</span>
<a href="#l13.364"></a><span id="l13.364" class="difflineplus">+        minVersion: &quot;1&quot;,</span>
<a href="#l13.365"></a><span id="l13.365" class="difflineplus">+        maxVersion: &quot;1&quot;,</span>
<a href="#l13.366"></a><span id="l13.366" class="difflineplus">+      }],</span>
<a href="#l13.367"></a><span id="l13.367" class="difflineplus">+      name: &quot;Test Addon 15&quot;,</span>
<a href="#l13.368"></a><span id="l13.368" class="difflineplus">+    },</span>
<a href="#l13.369"></a><span id="l13.369" class="difflineplus">+</span>
<a href="#l13.370"></a><span id="l13.370" class="difflineplus">+    expected: {</span>
<a href="#l13.371"></a><span id="l13.371" class="difflineplus">+      isActive: true,</span>
<a href="#l13.372"></a><span id="l13.372" class="difflineplus">+      userDisabled: false,</span>
<a href="#l13.373"></a><span id="l13.373" class="difflineplus">+      appDisabled: false,</span>
<a href="#l13.374"></a><span id="l13.374" class="difflineplus">+      isCompatible: true,</span>
<a href="#l13.375"></a><span id="l13.375" class="difflineplus">+      providesUpdatesSecurely: true,</span>
<a href="#l13.376"></a><span id="l13.376" class="difflineplus">+    },</span>
<a href="#l13.377"></a><span id="l13.377" class="difflineplus">+  },</span>
<a href="#l13.378"></a><span id="l13.378" class="difflineplus">+</span>
<a href="#l13.379"></a><span id="l13.379" class="difflineplus">+  {</span>
<a href="#l13.380"></a><span id="l13.380" class="difflineplus">+    &quot;install.rdf&quot;: {</span>
<a href="#l13.381"></a><span id="l13.381" class="difflineplus">+      id: &quot;addon16@tests.mozilla.org&quot;,</span>
<a href="#l13.382"></a><span id="l13.382" class="difflineplus">+      version: &quot;1.0&quot;,</span>
<a href="#l13.383"></a><span id="l13.383" class="difflineplus">+      bootstrap: true,</span>
<a href="#l13.384"></a><span id="l13.384" class="difflineplus">+      updateKey: &quot;foo&quot;,</span>
<a href="#l13.385"></a><span id="l13.385" class="difflineplus">+      updateURL: &quot;https://www.foo.com&quot;,</span>
<a href="#l13.386"></a><span id="l13.386" class="difflineplus">+      targetApplications: [{</span>
<a href="#l13.387"></a><span id="l13.387" class="difflineplus">+        id: &quot;xpcshell@tests.mozilla.org&quot;,</span>
<a href="#l13.388"></a><span id="l13.388" class="difflineplus">+        minVersion: &quot;1&quot;,</span>
<a href="#l13.389"></a><span id="l13.389" class="difflineplus">+        maxVersion: &quot;1&quot;,</span>
<a href="#l13.390"></a><span id="l13.390" class="difflineplus">+      }],</span>
<a href="#l13.391"></a><span id="l13.391" class="difflineplus">+      name: &quot;Test Addon 16&quot;,</span>
<a href="#l13.392"></a><span id="l13.392" class="difflineplus">+    },</span>
<a href="#l13.393"></a><span id="l13.393" class="difflineplus">+</span>
<a href="#l13.394"></a><span id="l13.394" class="difflineplus">+    expected: {</span>
<a href="#l13.395"></a><span id="l13.395" class="difflineplus">+      isActive: true,</span>
<a href="#l13.396"></a><span id="l13.396" class="difflineplus">+      userDisabled: false,</span>
<a href="#l13.397"></a><span id="l13.397" class="difflineplus">+      appDisabled: false,</span>
<a href="#l13.398"></a><span id="l13.398" class="difflineplus">+      isCompatible: true,</span>
<a href="#l13.399"></a><span id="l13.399" class="difflineplus">+      providesUpdatesSecurely: true,</span>
<a href="#l13.400"></a><span id="l13.400" class="difflineplus">+    },</span>
<a href="#l13.401"></a><span id="l13.401" class="difflineplus">+  },</span>
<a href="#l13.402"></a><span id="l13.402" class="difflineplus">+</span>
<a href="#l13.403"></a><span id="l13.403" class="difflineplus">+  {</span>
<a href="#l13.404"></a><span id="l13.404" class="difflineplus">+    &quot;install.rdf&quot;: {</span>
<a href="#l13.405"></a><span id="l13.405" class="difflineplus">+      id: &quot;addon17@tests.mozilla.org&quot;,</span>
<a href="#l13.406"></a><span id="l13.406" class="difflineplus">+      version: &quot;1.0&quot;,</span>
<a href="#l13.407"></a><span id="l13.407" class="difflineplus">+      bootstrap: true,</span>
<a href="#l13.408"></a><span id="l13.408" class="difflineplus">+      optionsURL: &quot;chrome://test/content/options.xul&quot;,</span>
<a href="#l13.409"></a><span id="l13.409" class="difflineplus">+      optionsType: &quot;2&quot;,</span>
<a href="#l13.410"></a><span id="l13.410" class="difflineplus">+      targetApplications: [{</span>
<a href="#l13.411"></a><span id="l13.411" class="difflineplus">+        id: &quot;xpcshell@tests.mozilla.org&quot;,</span>
<a href="#l13.412"></a><span id="l13.412" class="difflineplus">+        minVersion: &quot;1&quot;,</span>
<a href="#l13.413"></a><span id="l13.413" class="difflineplus">+        maxVersion: &quot;1&quot;,</span>
<a href="#l13.414"></a><span id="l13.414" class="difflineplus">+      }],</span>
<a href="#l13.415"></a><span id="l13.415" class="difflineplus">+      name: &quot;Test Addon 17&quot;,</span>
<a href="#l13.416"></a><span id="l13.416" class="difflineplus">+    },</span>
<a href="#l13.417"></a><span id="l13.417" class="difflineplus">+</span>
<a href="#l13.418"></a><span id="l13.418" class="difflineplus">+    // An obsolete optionsType means the add-on isn't registered.</span>
<a href="#l13.419"></a><span id="l13.419" class="difflineplus">+    expected: null,</span>
<a href="#l13.420"></a><span id="l13.420" class="difflineplus">+  },</span>
<a href="#l13.421"></a><span id="l13.421" class="difflineplus">+</span>
<a href="#l13.422"></a><span id="l13.422" class="difflineplus">+  {</span>
<a href="#l13.423"></a><span id="l13.423" class="difflineplus">+    &quot;install.rdf&quot;: {</span>
<a href="#l13.424"></a><span id="l13.424" class="difflineplus">+      id: &quot;addon18@tests.mozilla.org&quot;,</span>
<a href="#l13.425"></a><span id="l13.425" class="difflineplus">+      version: &quot;1.0&quot;,</span>
<a href="#l13.426"></a><span id="l13.426" class="difflineplus">+      bootstrap: true,</span>
<a href="#l13.427"></a><span id="l13.427" class="difflineplus">+      targetApplications: [{</span>
<a href="#l13.428"></a><span id="l13.428" class="difflineplus">+        id: &quot;xpcshell@tests.mozilla.org&quot;,</span>
<a href="#l13.429"></a><span id="l13.429" class="difflineplus">+        minVersion: &quot;1&quot;,</span>
<a href="#l13.430"></a><span id="l13.430" class="difflineplus">+        maxVersion: &quot;1&quot;,</span>
<a href="#l13.431"></a><span id="l13.431" class="difflineplus">+      }],</span>
<a href="#l13.432"></a><span id="l13.432" class="difflineplus">+      name: &quot;Test Addon 18&quot;,</span>
<a href="#l13.433"></a><span id="l13.433" class="difflineplus">+    },</span>
<a href="#l13.434"></a><span id="l13.434" class="difflineplus">+    extraFiles: {&quot;options.xul&quot;: &quot;&quot;},</span>
<a href="#l13.435"></a><span id="l13.435" class="difflineplus">+</span>
<a href="#l13.436"></a><span id="l13.436" class="difflineplus">+    expected: {</span>
<a href="#l13.437"></a><span id="l13.437" class="difflineplus">+      isActive: true,</span>
<a href="#l13.438"></a><span id="l13.438" class="difflineplus">+      userDisabled: false,</span>
<a href="#l13.439"></a><span id="l13.439" class="difflineplus">+      appDisabled: false,</span>
<a href="#l13.440"></a><span id="l13.440" class="difflineplus">+      isCompatible: true,</span>
<a href="#l13.441"></a><span id="l13.441" class="difflineplus">+      optionsURL: null,</span>
<a href="#l13.442"></a><span id="l13.442" class="difflineplus">+      optionsType: null,</span>
<a href="#l13.443"></a><span id="l13.443" class="difflineplus">+    },</span>
<a href="#l13.444"></a><span id="l13.444" class="difflineplus">+  },</span>
<a href="#l13.445"></a><span id="l13.445" class="difflineplus">+</span>
<a href="#l13.446"></a><span id="l13.446" class="difflineplus">+  {</span>
<a href="#l13.447"></a><span id="l13.447" class="difflineplus">+    &quot;install.rdf&quot;: {</span>
<a href="#l13.448"></a><span id="l13.448" class="difflineplus">+      id: &quot;addon19@tests.mozilla.org&quot;,</span>
<a href="#l13.449"></a><span id="l13.449" class="difflineplus">+      version: &quot;1.0&quot;,</span>
<a href="#l13.450"></a><span id="l13.450" class="difflineplus">+      bootstrap: true,</span>
<a href="#l13.451"></a><span id="l13.451" class="difflineplus">+      optionsType: &quot;99&quot;,</span>
<a href="#l13.452"></a><span id="l13.452" class="difflineplus">+      targetApplications: [{</span>
<a href="#l13.453"></a><span id="l13.453" class="difflineplus">+        id: &quot;xpcshell@tests.mozilla.org&quot;,</span>
<a href="#l13.454"></a><span id="l13.454" class="difflineplus">+        minVersion: &quot;1&quot;,</span>
<a href="#l13.455"></a><span id="l13.455" class="difflineplus">+        maxVersion: &quot;1&quot;,</span>
<a href="#l13.456"></a><span id="l13.456" class="difflineplus">+      }],</span>
<a href="#l13.457"></a><span id="l13.457" class="difflineplus">+      name: &quot;Test Addon 19&quot;,</span>
<a href="#l13.458"></a><span id="l13.458" class="difflineplus">+    },</span>
<a href="#l13.459"></a><span id="l13.459" class="difflineplus">+</span>
<a href="#l13.460"></a><span id="l13.460" class="difflineplus">+    expected: null,</span>
<a href="#l13.461"></a><span id="l13.461" class="difflineplus">+  },</span>
<a href="#l13.462"></a><span id="l13.462" class="difflineplus">+</span>
<a href="#l13.463"></a><span id="l13.463" class="difflineplus">+  {</span>
<a href="#l13.464"></a><span id="l13.464" class="difflineplus">+    &quot;install.rdf&quot;: {</span>
<a href="#l13.465"></a><span id="l13.465" class="difflineplus">+      id: &quot;addon20@tests.mozilla.org&quot;,</span>
<a href="#l13.466"></a><span id="l13.466" class="difflineplus">+      version: &quot;1.0&quot;,</span>
<a href="#l13.467"></a><span id="l13.467" class="difflineplus">+      bootstrap: true,</span>
<a href="#l13.468"></a><span id="l13.468" class="difflineplus">+      optionsURL: &quot;chrome://test/content/options.xul&quot;,</span>
<a href="#l13.469"></a><span id="l13.469" class="difflineplus">+      targetApplications: [{</span>
<a href="#l13.470"></a><span id="l13.470" class="difflineplus">+        id: &quot;xpcshell@tests.mozilla.org&quot;,</span>
<a href="#l13.471"></a><span id="l13.471" class="difflineplus">+        minVersion: &quot;1&quot;,</span>
<a href="#l13.472"></a><span id="l13.472" class="difflineplus">+        maxVersion: &quot;1&quot;,</span>
<a href="#l13.473"></a><span id="l13.473" class="difflineplus">+      }],</span>
<a href="#l13.474"></a><span id="l13.474" class="difflineplus">+      name: &quot;Test Addon 20&quot;,</span>
<a href="#l13.475"></a><span id="l13.475" class="difflineplus">+    },</span>
<a href="#l13.476"></a><span id="l13.476" class="difflineplus">+</span>
<a href="#l13.477"></a><span id="l13.477" class="difflineplus">+    // Even with a defined optionsURL optionsType is null by default.</span>
<a href="#l13.478"></a><span id="l13.478" class="difflineplus">+    expected: {</span>
<a href="#l13.479"></a><span id="l13.479" class="difflineplus">+      isActive: true,</span>
<a href="#l13.480"></a><span id="l13.480" class="difflineplus">+      userDisabled: false,</span>
<a href="#l13.481"></a><span id="l13.481" class="difflineplus">+      appDisabled: false,</span>
<a href="#l13.482"></a><span id="l13.482" class="difflineplus">+      isCompatible: true,</span>
<a href="#l13.483"></a><span id="l13.483" class="difflineplus">+      optionsURL: &quot;chrome://test/content/options.xul&quot;,</span>
<a href="#l13.484"></a><span id="l13.484" class="difflineplus">+      optionsType: null,</span>
<a href="#l13.485"></a><span id="l13.485" class="difflineplus">+    },</span>
<a href="#l13.486"></a><span id="l13.486" class="difflineplus">+  },</span>
<a href="#l13.487"></a><span id="l13.487" class="difflineplus">+</span>
<a href="#l13.488"></a><span id="l13.488" class="difflineplus">+  {</span>
<a href="#l13.489"></a><span id="l13.489" class="difflineplus">+    &quot;install.rdf&quot;: {</span>
<a href="#l13.490"></a><span id="l13.490" class="difflineplus">+      id: &quot;addon21@tests.mozilla.org&quot;,</span>
<a href="#l13.491"></a><span id="l13.491" class="difflineplus">+      version: &quot;1.0&quot;,</span>
<a href="#l13.492"></a><span id="l13.492" class="difflineplus">+      bootstrap: true,</span>
<a href="#l13.493"></a><span id="l13.493" class="difflineplus">+      optionsType: &quot;3&quot;,</span>
<a href="#l13.494"></a><span id="l13.494" class="difflineplus">+      optionsURL: &quot;chrome://test/content/options.xul&quot;,</span>
<a href="#l13.495"></a><span id="l13.495" class="difflineplus">+      targetApplications: [{</span>
<a href="#l13.496"></a><span id="l13.496" class="difflineplus">+        id: &quot;xpcshell@tests.mozilla.org&quot;,</span>
<a href="#l13.497"></a><span id="l13.497" class="difflineplus">+        minVersion: &quot;1&quot;,</span>
<a href="#l13.498"></a><span id="l13.498" class="difflineplus">+        maxVersion: &quot;1&quot;,</span>
<a href="#l13.499"></a><span id="l13.499" class="difflineplus">+      }],</span>
<a href="#l13.500"></a><span id="l13.500" class="difflineplus">+      name: &quot;Test Addon 21&quot;,</span>
<a href="#l13.501"></a><span id="l13.501" class="difflineplus">+    },</span>
<a href="#l13.502"></a><span id="l13.502" class="difflineplus">+</span>
<a href="#l13.503"></a><span id="l13.503" class="difflineplus">+    expected: {</span>
<a href="#l13.504"></a><span id="l13.504" class="difflineplus">+      isActive: true,</span>
<a href="#l13.505"></a><span id="l13.505" class="difflineplus">+      userDisabled: false,</span>
<a href="#l13.506"></a><span id="l13.506" class="difflineplus">+      appDisabled: false,</span>
<a href="#l13.507"></a><span id="l13.507" class="difflineplus">+      isCompatible: true,</span>
<a href="#l13.508"></a><span id="l13.508" class="difflineplus">+      optionsURL: &quot;chrome://test/content/options.xul&quot;,</span>
<a href="#l13.509"></a><span id="l13.509" class="difflineplus">+      optionsType: AddonManager.OPTIONS_TYPE_TAB,</span>
<a href="#l13.510"></a><span id="l13.510" class="difflineplus">+    },</span>
<a href="#l13.511"></a><span id="l13.511" class="difflineplus">+  },</span>
<a href="#l13.512"></a><span id="l13.512" class="difflineplus">+</span>
<a href="#l13.513"></a><span id="l13.513" class="difflineplus">+  {</span>
<a href="#l13.514"></a><span id="l13.514" class="difflineplus">+    &quot;install.rdf&quot;: {</span>
<a href="#l13.515"></a><span id="l13.515" class="difflineplus">+      id: &quot;addon22@tests.mozilla.org&quot;,</span>
<a href="#l13.516"></a><span id="l13.516" class="difflineplus">+      version: &quot;1.0&quot;,</span>
<a href="#l13.517"></a><span id="l13.517" class="difflineplus">+      bootstrap: true,</span>
<a href="#l13.518"></a><span id="l13.518" class="difflineplus">+      optionsType: &quot;2&quot;,</span>
<a href="#l13.519"></a><span id="l13.519" class="difflineplus">+      targetApplications: [{</span>
<a href="#l13.520"></a><span id="l13.520" class="difflineplus">+        id: &quot;xpcshell@tests.mozilla.org&quot;,</span>
<a href="#l13.521"></a><span id="l13.521" class="difflineplus">+        minVersion: &quot;1&quot;,</span>
<a href="#l13.522"></a><span id="l13.522" class="difflineplus">+        maxVersion: &quot;1&quot;,</span>
<a href="#l13.523"></a><span id="l13.523" class="difflineplus">+      }],</span>
<a href="#l13.524"></a><span id="l13.524" class="difflineplus">+      name: &quot;Test Addon 22&quot;,</span>
<a href="#l13.525"></a><span id="l13.525" class="difflineplus">+    },</span>
<a href="#l13.526"></a><span id="l13.526" class="difflineplus">+</span>
<a href="#l13.527"></a><span id="l13.527" class="difflineplus">+    // An obsolete optionsType means the add-on isn't registered.</span>
<a href="#l13.528"></a><span id="l13.528" class="difflineplus">+    expected: null,</span>
<a href="#l13.529"></a><span id="l13.529" class="difflineplus">+  },</span>
<a href="#l13.530"></a><span id="l13.530" class="difflineplus">+</span>
<a href="#l13.531"></a><span id="l13.531" class="difflineplus">+  {</span>
<a href="#l13.532"></a><span id="l13.532" class="difflineplus">+    &quot;install.rdf&quot;: {</span>
<a href="#l13.533"></a><span id="l13.533" class="difflineplus">+      id: &quot;addon23@tests.mozilla.org&quot;,</span>
<a href="#l13.534"></a><span id="l13.534" class="difflineplus">+      version: &quot;1.0&quot;,</span>
<a href="#l13.535"></a><span id="l13.535" class="difflineplus">+      bootstrap: true,</span>
<a href="#l13.536"></a><span id="l13.536" class="difflineplus">+      optionsType: &quot;2&quot;,</span>
<a href="#l13.537"></a><span id="l13.537" class="difflineplus">+      targetApplications: [{</span>
<a href="#l13.538"></a><span id="l13.538" class="difflineplus">+        id: &quot;xpcshell@tests.mozilla.org&quot;,</span>
<a href="#l13.539"></a><span id="l13.539" class="difflineplus">+        minVersion: &quot;1&quot;,</span>
<a href="#l13.540"></a><span id="l13.540" class="difflineplus">+        maxVersion: &quot;1&quot;,</span>
<a href="#l13.541"></a><span id="l13.541" class="difflineplus">+      }],</span>
<a href="#l13.542"></a><span id="l13.542" class="difflineplus">+      name: &quot;Test Addon 23&quot;,</span>
<a href="#l13.543"></a><span id="l13.543" class="difflineplus">+    },</span>
<a href="#l13.544"></a><span id="l13.544" class="difflineplus">+    extraFiles: {&quot;options.xul&quot;: &quot;&quot;},</span>
<a href="#l13.545"></a><span id="l13.545" class="difflineplus">+</span>
<a href="#l13.546"></a><span id="l13.546" class="difflineplus">+    // An obsolete optionsType means the add-on isn't registered.</span>
<a href="#l13.547"></a><span id="l13.547" class="difflineplus">+    expected: null,</span>
<a href="#l13.548"></a><span id="l13.548" class="difflineplus">+  },</span>
<a href="#l13.549"></a><span id="l13.549" class="difflineplus">+</span>
<a href="#l13.550"></a><span id="l13.550" class="difflineplus">+  {</span>
<a href="#l13.551"></a><span id="l13.551" class="difflineplus">+    &quot;install.rdf&quot;: {</span>
<a href="#l13.552"></a><span id="l13.552" class="difflineplus">+      id: &quot;addon24@tests.mozilla.org&quot;,</span>
<a href="#l13.553"></a><span id="l13.553" class="difflineplus">+      version: &quot;1.0&quot;,</span>
<a href="#l13.554"></a><span id="l13.554" class="difflineplus">+      bootstrap: true,</span>
<a href="#l13.555"></a><span id="l13.555" class="difflineplus">+      targetApplications: [{</span>
<a href="#l13.556"></a><span id="l13.556" class="difflineplus">+        id: &quot;xpcshell@tests.mozilla.org&quot;,</span>
<a href="#l13.557"></a><span id="l13.557" class="difflineplus">+        minVersion: &quot;1&quot;,</span>
<a href="#l13.558"></a><span id="l13.558" class="difflineplus">+        maxVersion: &quot;1&quot;,</span>
<a href="#l13.559"></a><span id="l13.559" class="difflineplus">+      }],</span>
<a href="#l13.560"></a><span id="l13.560" class="difflineplus">+      name: &quot;Test Addon 24&quot;,</span>
<a href="#l13.561"></a><span id="l13.561" class="difflineplus">+    },</span>
<a href="#l13.562"></a><span id="l13.562" class="difflineplus">+    extraFiles: {&quot;options.xul&quot;: &quot;&quot;},</span>
<a href="#l13.563"></a><span id="l13.563" class="difflineplus">+</span>
<a href="#l13.564"></a><span id="l13.564" class="difflineplus">+    expected: {</span>
<a href="#l13.565"></a><span id="l13.565" class="difflineplus">+      optionsType: null,</span>
<a href="#l13.566"></a><span id="l13.566" class="difflineplus">+      optionsURL: null,</span>
<a href="#l13.567"></a><span id="l13.567" class="difflineplus">+    },</span>
<a href="#l13.568"></a><span id="l13.568" class="difflineplus">+  },</span>
<a href="#l13.569"></a><span id="l13.569" class="difflineplus">+</span>
<a href="#l13.570"></a><span id="l13.570" class="difflineplus">+  {</span>
<a href="#l13.571"></a><span id="l13.571" class="difflineplus">+    &quot;install.rdf&quot;: {</span>
<a href="#l13.572"></a><span id="l13.572" class="difflineplus">+      id: &quot;addon25@tests.mozilla.org&quot;,</span>
<a href="#l13.573"></a><span id="l13.573" class="difflineplus">+      version: &quot;1.0&quot;,</span>
<a href="#l13.574"></a><span id="l13.574" class="difflineplus">+      bootstrap: true,</span>
<a href="#l13.575"></a><span id="l13.575" class="difflineplus">+      optionsType: &quot;3&quot;,</span>
<a href="#l13.576"></a><span id="l13.576" class="difflineplus">+      targetApplications: [{</span>
<a href="#l13.577"></a><span id="l13.577" class="difflineplus">+        id: &quot;xpcshell@tests.mozilla.org&quot;,</span>
<a href="#l13.578"></a><span id="l13.578" class="difflineplus">+        minVersion: &quot;1&quot;,</span>
<a href="#l13.579"></a><span id="l13.579" class="difflineplus">+        maxVersion: &quot;1&quot;,</span>
<a href="#l13.580"></a><span id="l13.580" class="difflineplus">+      }],</span>
<a href="#l13.581"></a><span id="l13.581" class="difflineplus">+      name: &quot;Test Addon 25&quot;,</span>
<a href="#l13.582"></a><span id="l13.582" class="difflineplus">+    },</span>
<a href="#l13.583"></a><span id="l13.583" class="difflineplus">+</span>
<a href="#l13.584"></a><span id="l13.584" class="difflineplus">+    expected: {</span>
<a href="#l13.585"></a><span id="l13.585" class="difflineplus">+      optionsType: null,</span>
<a href="#l13.586"></a><span id="l13.586" class="difflineplus">+      optionsURL: null,</span>
<a href="#l13.587"></a><span id="l13.587" class="difflineplus">+    },</span>
<a href="#l13.588"></a><span id="l13.588" class="difflineplus">+  },</span>
<a href="#l13.589"></a><span id="l13.589" class="difflineplus">+</span>
<a href="#l13.590"></a><span id="l13.590" class="difflineplus">+  {</span>
<a href="#l13.591"></a><span id="l13.591" class="difflineplus">+    &quot;install.rdf&quot;: {</span>
<a href="#l13.592"></a><span id="l13.592" class="difflineplus">+      id: &quot;addon26@tests.mozilla.org&quot;,</span>
<a href="#l13.593"></a><span id="l13.593" class="difflineplus">+      version: &quot;1.0&quot;,</span>
<a href="#l13.594"></a><span id="l13.594" class="difflineplus">+      bootstrap: true,</span>
<a href="#l13.595"></a><span id="l13.595" class="difflineplus">+      optionsType: &quot;4&quot;,</span>
<a href="#l13.596"></a><span id="l13.596" class="difflineplus">+      targetApplications: [{</span>
<a href="#l13.597"></a><span id="l13.597" class="difflineplus">+        id: &quot;xpcshell@tests.mozilla.org&quot;,</span>
<a href="#l13.598"></a><span id="l13.598" class="difflineplus">+        minVersion: &quot;1&quot;,</span>
<a href="#l13.599"></a><span id="l13.599" class="difflineplus">+        maxVersion: &quot;1&quot;,</span>
<a href="#l13.600"></a><span id="l13.600" class="difflineplus">+      }],</span>
<a href="#l13.601"></a><span id="l13.601" class="difflineplus">+      name: &quot;Test Addon 26&quot;,</span>
<a href="#l13.602"></a><span id="l13.602" class="difflineplus">+    },</span>
<a href="#l13.603"></a><span id="l13.603" class="difflineplus">+    extraFiles: {&quot;options.xul&quot;: &quot;&quot;},</span>
<a href="#l13.604"></a><span id="l13.604" class="difflineplus">+    expected: null,</span>
<a href="#l13.605"></a><span id="l13.605" class="difflineplus">+  },</span>
<a href="#l13.606"></a><span id="l13.606" class="difflineplus">+</span>
<a href="#l13.607"></a><span id="l13.607" class="difflineplus">+  // Tests compatibility based on target platforms.</span>
<a href="#l13.608"></a><span id="l13.608" class="difflineplus">+</span>
<a href="#l13.609"></a><span id="l13.609" class="difflineplus">+  // No targetPlatforms so should be compatible</span>
<a href="#l13.610"></a><span id="l13.610" class="difflineplus">+  {</span>
<a href="#l13.611"></a><span id="l13.611" class="difflineplus">+    &quot;install.rdf&quot;: {</span>
<a href="#l13.612"></a><span id="l13.612" class="difflineplus">+      id: &quot;tp-addon1@tests.mozilla.org&quot;,</span>
<a href="#l13.613"></a><span id="l13.613" class="difflineplus">+      version: &quot;1.0&quot;,</span>
<a href="#l13.614"></a><span id="l13.614" class="difflineplus">+      bootstrap: true,</span>
<a href="#l13.615"></a><span id="l13.615" class="difflineplus">+      name: &quot;Test 1&quot;,</span>
<a href="#l13.616"></a><span id="l13.616" class="difflineplus">+      targetApplications: [{</span>
<a href="#l13.617"></a><span id="l13.617" class="difflineplus">+        id: &quot;xpcshell@tests.mozilla.org&quot;,</span>
<a href="#l13.618"></a><span id="l13.618" class="difflineplus">+        minVersion: &quot;1&quot;,</span>
<a href="#l13.619"></a><span id="l13.619" class="difflineplus">+        maxVersion: &quot;1&quot;,</span>
<a href="#l13.620"></a><span id="l13.620" class="difflineplus">+      }],</span>
<a href="#l13.621"></a><span id="l13.621" class="difflineplus">+    },</span>
<a href="#l13.622"></a><span id="l13.622" class="difflineplus">+</span>
<a href="#l13.623"></a><span id="l13.623" class="difflineplus">+    expected: {</span>
<a href="#l13.624"></a><span id="l13.624" class="difflineplus">+      appDisabled: false,</span>
<a href="#l13.625"></a><span id="l13.625" class="difflineplus">+      isPlatformCompatible: true,</span>
<a href="#l13.626"></a><span id="l13.626" class="difflineplus">+      isActive: true,</span>
<a href="#l13.627"></a><span id="l13.627" class="difflineplus">+    },</span>
<a href="#l13.628"></a><span id="l13.628" class="difflineplus">+  },</span>
<a href="#l13.629"></a><span id="l13.629" class="difflineplus">+</span>
<a href="#l13.630"></a><span id="l13.630" class="difflineplus">+  // Matches the OS</span>
<a href="#l13.631"></a><span id="l13.631" class="difflineplus">+  {</span>
<a href="#l13.632"></a><span id="l13.632" class="difflineplus">+    &quot;install.rdf&quot;: {</span>
<a href="#l13.633"></a><span id="l13.633" class="difflineplus">+      id: &quot;tp-addon2@tests.mozilla.org&quot;,</span>
<a href="#l13.634"></a><span id="l13.634" class="difflineplus">+      version: &quot;1.0&quot;,</span>
<a href="#l13.635"></a><span id="l13.635" class="difflineplus">+      bootstrap: true,</span>
<a href="#l13.636"></a><span id="l13.636" class="difflineplus">+      name: &quot;Test 2&quot;,</span>
<a href="#l13.637"></a><span id="l13.637" class="difflineplus">+      targetPlatforms: [</span>
<a href="#l13.638"></a><span id="l13.638" class="difflineplus">+        &quot;XPCShell&quot;,</span>
<a href="#l13.639"></a><span id="l13.639" class="difflineplus">+        &quot;WINNT_x86&quot;,</span>
<a href="#l13.640"></a><span id="l13.640" class="difflineplus">+        &quot;XPCShell&quot;,</span>
<a href="#l13.641"></a><span id="l13.641" class="difflineplus">+      ],</span>
<a href="#l13.642"></a><span id="l13.642" class="difflineplus">+      targetApplications: [{</span>
<a href="#l13.643"></a><span id="l13.643" class="difflineplus">+        id: &quot;xpcshell@tests.mozilla.org&quot;,</span>
<a href="#l13.644"></a><span id="l13.644" class="difflineplus">+        minVersion: &quot;1&quot;,</span>
<a href="#l13.645"></a><span id="l13.645" class="difflineplus">+        maxVersion: &quot;1&quot;,</span>
<a href="#l13.646"></a><span id="l13.646" class="difflineplus">+      }],</span>
<a href="#l13.647"></a><span id="l13.647" class="difflineplus">+    },</span>
<a href="#l13.648"></a><span id="l13.648" class="difflineplus">+</span>
<a href="#l13.649"></a><span id="l13.649" class="difflineplus">+    expected: {</span>
<a href="#l13.650"></a><span id="l13.650" class="difflineplus">+      appDisabled: false,</span>
<a href="#l13.651"></a><span id="l13.651" class="difflineplus">+      isPlatformCompatible: true,</span>
<a href="#l13.652"></a><span id="l13.652" class="difflineplus">+      isActive: true,</span>
<a href="#l13.653"></a><span id="l13.653" class="difflineplus">+    },</span>
<a href="#l13.654"></a><span id="l13.654" class="difflineplus">+  },</span>
<a href="#l13.655"></a><span id="l13.655" class="difflineplus">+</span>
<a href="#l13.656"></a><span id="l13.656" class="difflineplus">+  // Matches the OS and ABI</span>
<a href="#l13.657"></a><span id="l13.657" class="difflineplus">+  {</span>
<a href="#l13.658"></a><span id="l13.658" class="difflineplus">+    &quot;install.rdf&quot;: {</span>
<a href="#l13.659"></a><span id="l13.659" class="difflineplus">+      id: &quot;tp-addon3@tests.mozilla.org&quot;,</span>
<a href="#l13.660"></a><span id="l13.660" class="difflineplus">+      version: &quot;1.0&quot;,</span>
<a href="#l13.661"></a><span id="l13.661" class="difflineplus">+      bootstrap: true,</span>
<a href="#l13.662"></a><span id="l13.662" class="difflineplus">+      name: &quot;Test 3&quot;,</span>
<a href="#l13.663"></a><span id="l13.663" class="difflineplus">+      targetPlatforms: [</span>
<a href="#l13.664"></a><span id="l13.664" class="difflineplus">+        &quot;WINNT&quot;,</span>
<a href="#l13.665"></a><span id="l13.665" class="difflineplus">+        &quot;XPCShell_noarch-spidermonkey&quot;,</span>
<a href="#l13.666"></a><span id="l13.666" class="difflineplus">+      ],</span>
<a href="#l13.667"></a><span id="l13.667" class="difflineplus">+      targetApplications: [{</span>
<a href="#l13.668"></a><span id="l13.668" class="difflineplus">+        id: &quot;xpcshell@tests.mozilla.org&quot;,</span>
<a href="#l13.669"></a><span id="l13.669" class="difflineplus">+        minVersion: &quot;1&quot;,</span>
<a href="#l13.670"></a><span id="l13.670" class="difflineplus">+        maxVersion: &quot;1&quot;,</span>
<a href="#l13.671"></a><span id="l13.671" class="difflineplus">+      }],</span>
<a href="#l13.672"></a><span id="l13.672" class="difflineplus">+    },</span>
<a href="#l13.673"></a><span id="l13.673" class="difflineplus">+</span>
<a href="#l13.674"></a><span id="l13.674" class="difflineplus">+    expected: {</span>
<a href="#l13.675"></a><span id="l13.675" class="difflineplus">+      appDisabled: false,</span>
<a href="#l13.676"></a><span id="l13.676" class="difflineplus">+      isPlatformCompatible: true,</span>
<a href="#l13.677"></a><span id="l13.677" class="difflineplus">+      isActive: true,</span>
<a href="#l13.678"></a><span id="l13.678" class="difflineplus">+    },</span>
<a href="#l13.679"></a><span id="l13.679" class="difflineplus">+  },</span>
<a href="#l13.680"></a><span id="l13.680" class="difflineplus">+</span>
<a href="#l13.681"></a><span id="l13.681" class="difflineplus">+  // Doesn't match</span>
<a href="#l13.682"></a><span id="l13.682" class="difflineplus">+  {</span>
<a href="#l13.683"></a><span id="l13.683" class="difflineplus">+    &quot;install.rdf&quot;: {</span>
<a href="#l13.684"></a><span id="l13.684" class="difflineplus">+      id: &quot;tp-addon4@tests.mozilla.org&quot;,</span>
<a href="#l13.685"></a><span id="l13.685" class="difflineplus">+      version: &quot;1.0&quot;,</span>
<a href="#l13.686"></a><span id="l13.686" class="difflineplus">+      bootstrap: true,</span>
<a href="#l13.687"></a><span id="l13.687" class="difflineplus">+      name: &quot;Test 4&quot;,</span>
<a href="#l13.688"></a><span id="l13.688" class="difflineplus">+      targetPlatforms: [</span>
<a href="#l13.689"></a><span id="l13.689" class="difflineplus">+        &quot;WINNT_noarch-spidermonkey&quot;,</span>
<a href="#l13.690"></a><span id="l13.690" class="difflineplus">+        &quot;Darwin&quot;,</span>
<a href="#l13.691"></a><span id="l13.691" class="difflineplus">+        &quot;WINNT_noarch-spidermonkey&quot;,</span>
<a href="#l13.692"></a><span id="l13.692" class="difflineplus">+      ],</span>
<a href="#l13.693"></a><span id="l13.693" class="difflineplus">+      targetApplications: [{</span>
<a href="#l13.694"></a><span id="l13.694" class="difflineplus">+        id: &quot;xpcshell@tests.mozilla.org&quot;,</span>
<a href="#l13.695"></a><span id="l13.695" class="difflineplus">+        minVersion: &quot;1&quot;,</span>
<a href="#l13.696"></a><span id="l13.696" class="difflineplus">+        maxVersion: &quot;1&quot;,</span>
<a href="#l13.697"></a><span id="l13.697" class="difflineplus">+      }],</span>
<a href="#l13.698"></a><span id="l13.698" class="difflineplus">+    },</span>
<a href="#l13.699"></a><span id="l13.699" class="difflineplus">+</span>
<a href="#l13.700"></a><span id="l13.700" class="difflineplus">+    expected: {</span>
<a href="#l13.701"></a><span id="l13.701" class="difflineplus">+      appDisabled: true,</span>
<a href="#l13.702"></a><span id="l13.702" class="difflineplus">+      isPlatformCompatible: false,</span>
<a href="#l13.703"></a><span id="l13.703" class="difflineplus">+      isActive: false,</span>
<a href="#l13.704"></a><span id="l13.704" class="difflineplus">+    },</span>
<a href="#l13.705"></a><span id="l13.705" class="difflineplus">+  },</span>
<a href="#l13.706"></a><span id="l13.706" class="difflineplus">+</span>
<a href="#l13.707"></a><span id="l13.707" class="difflineplus">+  // Matches the OS but since a different entry specifies ABI this doesn't match.</span>
<a href="#l13.708"></a><span id="l13.708" class="difflineplus">+  {</span>
<a href="#l13.709"></a><span id="l13.709" class="difflineplus">+    &quot;install.rdf&quot;: {</span>
<a href="#l13.710"></a><span id="l13.710" class="difflineplus">+      id: &quot;tp-addon5@tests.mozilla.org&quot;,</span>
<a href="#l13.711"></a><span id="l13.711" class="difflineplus">+      version: &quot;1.0&quot;,</span>
<a href="#l13.712"></a><span id="l13.712" class="difflineplus">+      bootstrap: true,</span>
<a href="#l13.713"></a><span id="l13.713" class="difflineplus">+      name: &quot;Test 5&quot;,</span>
<a href="#l13.714"></a><span id="l13.714" class="difflineplus">+      targetPlatforms: [</span>
<a href="#l13.715"></a><span id="l13.715" class="difflineplus">+        &quot;XPCShell&quot;,</span>
<a href="#l13.716"></a><span id="l13.716" class="difflineplus">+        &quot;XPCShell_foo&quot;,</span>
<a href="#l13.717"></a><span id="l13.717" class="difflineplus">+      ],</span>
<a href="#l13.718"></a><span id="l13.718" class="difflineplus">+      targetApplications: [{</span>
<a href="#l13.719"></a><span id="l13.719" class="difflineplus">+        id: &quot;xpcshell@tests.mozilla.org&quot;,</span>
<a href="#l13.720"></a><span id="l13.720" class="difflineplus">+        minVersion: &quot;1&quot;,</span>
<a href="#l13.721"></a><span id="l13.721" class="difflineplus">+        maxVersion: &quot;1&quot;,</span>
<a href="#l13.722"></a><span id="l13.722" class="difflineplus">+      }],</span>
<a href="#l13.723"></a><span id="l13.723" class="difflineplus">+    },</span>
<a href="#l13.724"></a><span id="l13.724" class="difflineplus">+</span>
<a href="#l13.725"></a><span id="l13.725" class="difflineplus">+    expected: {</span>
<a href="#l13.726"></a><span id="l13.726" class="difflineplus">+      appDisabled: true,</span>
<a href="#l13.727"></a><span id="l13.727" class="difflineplus">+      isPlatformCompatible: false,</span>
<a href="#l13.728"></a><span id="l13.728" class="difflineplus">+      isActive: false,</span>
<a href="#l13.729"></a><span id="l13.729" class="difflineplus">+    },</span>
<a href="#l13.730"></a><span id="l13.730" class="difflineplus">+  },</span>
<a href="#l13.731"></a><span id="l13.731" class="difflineplus">+];</span>
<a href="#l13.732"></a><span id="l13.732" class="difflineplus">+</span>
<a href="#l13.733"></a><span id="l13.733" class="difflineplus">+const IDS = ADDONS.map(a =&gt; a[&quot;install.rdf&quot;].id);</span>
<a href="#l13.734"></a><span id="l13.734" class="difflineplus">+</span>
<a href="#l13.735"></a><span id="l13.735" class="difflineplus">+add_task(async function setup() {</span>
<a href="#l13.736"></a><span id="l13.736" class="difflineplus">+  createAppInfo(&quot;xpcshell@tests.mozilla.org&quot;, &quot;XPCShell&quot;, &quot;1&quot;, &quot;1.9.2&quot;);</span>
<a href="#l13.737"></a><span id="l13.737" class="difflineplus">+  const profileDir = gProfD.clone();</span>
<a href="#l13.738"></a><span id="l13.738" class="difflineplus">+  profileDir.append(&quot;extensions&quot;);</span>
<a href="#l13.739"></a><span id="l13.739" class="difflineplus">+</span>
<a href="#l13.740"></a><span id="l13.740" class="difflineplus">+  for (let addon of ADDONS) {</span>
<a href="#l13.741"></a><span id="l13.741" class="difflineplus">+    await promiseWriteInstallRDFForExtension(addon[&quot;install.rdf&quot;], profileDir, undefined, addon.extraFiles);</span>
<a href="#l13.742"></a><span id="l13.742" class="difflineplus">+  }</span>
<a href="#l13.743"></a><span id="l13.743" class="difflineplus">+});</span>
<a href="#l13.744"></a><span id="l13.744" class="difflineplus">+</span>
<a href="#l13.745"></a><span id="l13.745" class="difflineplus">+add_task(async function test_values() {</span>
<a href="#l13.746"></a><span id="l13.746" class="difflineplus">+  await promiseStartupManager();</span>
<a href="#l13.747"></a><span id="l13.747" class="difflineplus">+</span>
<a href="#l13.748"></a><span id="l13.748" class="difflineplus">+  let addons = await getAddons(IDS);</span>
<a href="#l13.749"></a><span id="l13.749" class="difflineplus">+</span>
<a href="#l13.750"></a><span id="l13.750" class="difflineplus">+  for (let addon of ADDONS) {</span>
<a href="#l13.751"></a><span id="l13.751" class="difflineplus">+    let {id} = addon[&quot;install.rdf&quot;];</span>
<a href="#l13.752"></a><span id="l13.752" class="difflineplus">+    checkAddon(id, addons.get(id), addon.expected);</span>
<a href="#l13.753"></a><span id="l13.753" class="difflineplus">+  }</span>
<a href="#l13.754"></a><span id="l13.754" class="difflineplus">+</span>
<a href="#l13.755"></a><span id="l13.755" class="difflineplus">+  await promiseShutdownManager();</span>
<a href="#l13.756"></a><span id="l13.756" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1">new file mode 100644</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineminus">--- /dev/null</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineplus">+++ b/common/test/xpcshell/test_manifest_locales.js</span>
<a href="#l14.4"></a><span id="l14.4" class="difflineat">@@ -0,0 +1,134 @@</span>
<a href="#l14.5"></a><span id="l14.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l14.6"></a><span id="l14.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l14.7"></a><span id="l14.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l14.8"></a><span id="l14.8" class="difflineplus">+ */</span>
<a href="#l14.9"></a><span id="l14.9" class="difflineplus">+</span>
<a href="#l14.10"></a><span id="l14.10" class="difflineplus">+const ID = &quot;bug397778@tests.mozilla.org&quot;;</span>
<a href="#l14.11"></a><span id="l14.11" class="difflineplus">+</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineplus">+const ADDON = {</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+  id: &quot;bug397778@tests.mozilla.org&quot;,</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+  version: &quot;1.0&quot;,</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineplus">+  name: &quot;Fallback Name&quot;,</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineplus">+  description: &quot;Fallback Description&quot;,</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineplus">+  bootstrap: true,</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineplus">+</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineplus">+  targetApplications: [{</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineplus">+    id: &quot;xpcshell@tests.mozilla.org&quot;,</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineplus">+    minVersion: &quot;1&quot;,</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineplus">+    maxVersion: &quot;1&quot;}],</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineplus">+</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineplus">+  localized: [</span>
<a href="#l14.25"></a><span id="l14.25" class="difflineplus">+    {</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineplus">+      locale: [&quot;fr&quot;],</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineplus">+      name: &quot;fr Name&quot;,</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineplus">+      description: &quot;fr Description&quot;,</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineplus">+    },</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineplus">+    {</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineplus">+      locale: [&quot;de-DE&quot;],</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineplus">+      name: &quot;Deutsches W\u00f6rterbuch&quot;,</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineplus">+    },</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineplus">+    {</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineplus">+      locale: [&quot;es-ES&quot;],</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineplus">+      name: &quot;es-ES Name&quot;,</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineplus">+      description: &quot;es-ES Description&quot;,</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineplus">+    },</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineplus">+    {</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineplus">+      locale: [&quot;zh-TW&quot;],</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineplus">+      name: &quot;zh-TW Name&quot;,</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineplus">+      description: &quot;zh-TW Description&quot;,</span>
<a href="#l14.43"></a><span id="l14.43" class="difflineplus">+    },</span>
<a href="#l14.44"></a><span id="l14.44" class="difflineplus">+    {</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineplus">+      locale: [&quot;zh-CN&quot;],</span>
<a href="#l14.46"></a><span id="l14.46" class="difflineplus">+      name: &quot;zh-CN Name&quot;,</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineplus">+      description: &quot;zh-CN Description&quot;,</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineplus">+    },</span>
<a href="#l14.49"></a><span id="l14.49" class="difflineplus">+    {</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineplus">+      locale: [&quot;en-GB&quot;],</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineplus">+      name: &quot;en-GB Name&quot;,</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineplus">+      description: &quot;en-GB Description&quot;,</span>
<a href="#l14.53"></a><span id="l14.53" class="difflineplus">+    },</span>
<a href="#l14.54"></a><span id="l14.54" class="difflineplus">+    {</span>
<a href="#l14.55"></a><span id="l14.55" class="difflineplus">+      locale: [&quot;en&quot;],</span>
<a href="#l14.56"></a><span id="l14.56" class="difflineplus">+      name: &quot;en Name&quot;,</span>
<a href="#l14.57"></a><span id="l14.57" class="difflineplus">+      description: &quot;en Description&quot;,</span>
<a href="#l14.58"></a><span id="l14.58" class="difflineplus">+    },</span>
<a href="#l14.59"></a><span id="l14.59" class="difflineplus">+    {</span>
<a href="#l14.60"></a><span id="l14.60" class="difflineplus">+      locale: [&quot;en-CA&quot;],</span>
<a href="#l14.61"></a><span id="l14.61" class="difflineplus">+      name: &quot;en-CA Name&quot;,</span>
<a href="#l14.62"></a><span id="l14.62" class="difflineplus">+      description: &quot;en-CA Description&quot;,</span>
<a href="#l14.63"></a><span id="l14.63" class="difflineplus">+    },</span>
<a href="#l14.64"></a><span id="l14.64" class="difflineplus">+  ],</span>
<a href="#l14.65"></a><span id="l14.65" class="difflineplus">+};</span>
<a href="#l14.66"></a><span id="l14.66" class="difflineplus">+</span>
<a href="#l14.67"></a><span id="l14.67" class="difflineplus">+add_task(async function setup() {</span>
<a href="#l14.68"></a><span id="l14.68" class="difflineplus">+  createAppInfo(&quot;xpcshell@tests.mozilla.org&quot;, &quot;XPCShell&quot;, &quot;1&quot;);</span>
<a href="#l14.69"></a><span id="l14.69" class="difflineplus">+  Services.locale.requestedLocales = [&quot;fr-FR&quot;];</span>
<a href="#l14.70"></a><span id="l14.70" class="difflineplus">+</span>
<a href="#l14.71"></a><span id="l14.71" class="difflineplus">+  await promiseStartupManager();</span>
<a href="#l14.72"></a><span id="l14.72" class="difflineplus">+  await promiseInstallXPI(ADDON);</span>
<a href="#l14.73"></a><span id="l14.73" class="difflineplus">+});</span>
<a href="#l14.74"></a><span id="l14.74" class="difflineplus">+</span>
<a href="#l14.75"></a><span id="l14.75" class="difflineplus">+add_task(async function test_1() {</span>
<a href="#l14.76"></a><span id="l14.76" class="difflineplus">+  let addon = await AddonManager.getAddonByID(ID);</span>
<a href="#l14.77"></a><span id="l14.77" class="difflineplus">+  Assert.notEqual(addon, null);</span>
<a href="#l14.78"></a><span id="l14.78" class="difflineplus">+  Assert.equal(addon.name, &quot;fr Name&quot;);</span>
<a href="#l14.79"></a><span id="l14.79" class="difflineplus">+  Assert.equal(addon.description, &quot;fr Description&quot;);</span>
<a href="#l14.80"></a><span id="l14.80" class="difflineplus">+</span>
<a href="#l14.81"></a><span id="l14.81" class="difflineplus">+  await addon.disable();</span>
<a href="#l14.82"></a><span id="l14.82" class="difflineplus">+  await promiseRestartManager();</span>
<a href="#l14.83"></a><span id="l14.83" class="difflineplus">+</span>
<a href="#l14.84"></a><span id="l14.84" class="difflineplus">+  let newAddon = await AddonManager.getAddonByID(ID);</span>
<a href="#l14.85"></a><span id="l14.85" class="difflineplus">+  Assert.notEqual(newAddon, null);</span>
<a href="#l14.86"></a><span id="l14.86" class="difflineplus">+  Assert.equal(newAddon.name, &quot;fr Name&quot;);</span>
<a href="#l14.87"></a><span id="l14.87" class="difflineplus">+});</span>
<a href="#l14.88"></a><span id="l14.88" class="difflineplus">+</span>
<a href="#l14.89"></a><span id="l14.89" class="difflineplus">+add_task(async function test_2() {</span>
<a href="#l14.90"></a><span id="l14.90" class="difflineplus">+  // Change locale. The more specific de-DE is the best match</span>
<a href="#l14.91"></a><span id="l14.91" class="difflineplus">+  await restartWithLocales([&quot;de&quot;]);</span>
<a href="#l14.92"></a><span id="l14.92" class="difflineplus">+</span>
<a href="#l14.93"></a><span id="l14.93" class="difflineplus">+  let addon = await AddonManager.getAddonByID(ID);</span>
<a href="#l14.94"></a><span id="l14.94" class="difflineplus">+  Assert.notEqual(addon, null);</span>
<a href="#l14.95"></a><span id="l14.95" class="difflineplus">+  Assert.equal(addon.name, &quot;Deutsches W\u00f6rterbuch&quot;);</span>
<a href="#l14.96"></a><span id="l14.96" class="difflineplus">+  Assert.equal(addon.description, null);</span>
<a href="#l14.97"></a><span id="l14.97" class="difflineplus">+});</span>
<a href="#l14.98"></a><span id="l14.98" class="difflineplus">+</span>
<a href="#l14.99"></a><span id="l14.99" class="difflineplus">+add_task(async function test_3() {</span>
<a href="#l14.100"></a><span id="l14.100" class="difflineplus">+  // Change locale. Locale case should have no effect</span>
<a href="#l14.101"></a><span id="l14.101" class="difflineplus">+  await restartWithLocales([&quot;DE-de&quot;]);</span>
<a href="#l14.102"></a><span id="l14.102" class="difflineplus">+</span>
<a href="#l14.103"></a><span id="l14.103" class="difflineplus">+  let addon = await AddonManager.getAddonByID(ID);</span>
<a href="#l14.104"></a><span id="l14.104" class="difflineplus">+  Assert.notEqual(addon, null);</span>
<a href="#l14.105"></a><span id="l14.105" class="difflineplus">+  Assert.equal(addon.name, &quot;Deutsches W\u00f6rterbuch&quot;);</span>
<a href="#l14.106"></a><span id="l14.106" class="difflineplus">+  Assert.equal(addon.description, null);</span>
<a href="#l14.107"></a><span id="l14.107" class="difflineplus">+});</span>
<a href="#l14.108"></a><span id="l14.108" class="difflineplus">+</span>
<a href="#l14.109"></a><span id="l14.109" class="difflineplus">+add_task(async function test_4() {</span>
<a href="#l14.110"></a><span id="l14.110" class="difflineplus">+  // Change locale. es-ES should closely match</span>
<a href="#l14.111"></a><span id="l14.111" class="difflineplus">+  await restartWithLocales([&quot;es-AR&quot;]);</span>
<a href="#l14.112"></a><span id="l14.112" class="difflineplus">+</span>
<a href="#l14.113"></a><span id="l14.113" class="difflineplus">+  let addon = await AddonManager.getAddonByID(ID);</span>
<a href="#l14.114"></a><span id="l14.114" class="difflineplus">+  Assert.notEqual(addon, null);</span>
<a href="#l14.115"></a><span id="l14.115" class="difflineplus">+  Assert.equal(addon.name, &quot;es-ES Name&quot;);</span>
<a href="#l14.116"></a><span id="l14.116" class="difflineplus">+  Assert.equal(addon.description, &quot;es-ES Description&quot;);</span>
<a href="#l14.117"></a><span id="l14.117" class="difflineplus">+});</span>
<a href="#l14.118"></a><span id="l14.118" class="difflineplus">+</span>
<a href="#l14.119"></a><span id="l14.119" class="difflineplus">+add_task(async function test_5() {</span>
<a href="#l14.120"></a><span id="l14.120" class="difflineplus">+  // Change locale. Either zh-CN or zh-TW could match</span>
<a href="#l14.121"></a><span id="l14.121" class="difflineplus">+  await restartWithLocales([&quot;zh&quot;]);</span>
<a href="#l14.122"></a><span id="l14.122" class="difflineplus">+</span>
<a href="#l14.123"></a><span id="l14.123" class="difflineplus">+  let addon = await AddonManager.getAddonByID(ID);</span>
<a href="#l14.124"></a><span id="l14.124" class="difflineplus">+  Assert.notEqual(addon, null);</span>
<a href="#l14.125"></a><span id="l14.125" class="difflineplus">+  ok(addon.name == &quot;zh-TW Name&quot; || addon.name == &quot;zh-CN Name&quot;,</span>
<a href="#l14.126"></a><span id="l14.126" class="difflineplus">+     `Add-on name mismatch: ${addon.name}`);</span>
<a href="#l14.127"></a><span id="l14.127" class="difflineplus">+});</span>
<a href="#l14.128"></a><span id="l14.128" class="difflineplus">+</span>
<a href="#l14.129"></a><span id="l14.129" class="difflineplus">+add_task(async function test_6() {</span>
<a href="#l14.130"></a><span id="l14.130" class="difflineplus">+  // Unknown locale should try to match against en-US as well. Of en,en-GB</span>
<a href="#l14.131"></a><span id="l14.131" class="difflineplus">+  // en should match as being less specific</span>
<a href="#l14.132"></a><span id="l14.132" class="difflineplus">+  await restartWithLocales([&quot;nl-NL&quot;]);</span>
<a href="#l14.133"></a><span id="l14.133" class="difflineplus">+</span>
<a href="#l14.134"></a><span id="l14.134" class="difflineplus">+  let addon = await AddonManager.getAddonByID(ID);</span>
<a href="#l14.135"></a><span id="l14.135" class="difflineplus">+  Assert.notEqual(addon, null);</span>
<a href="#l14.136"></a><span id="l14.136" class="difflineplus">+  Assert.equal(addon.name, &quot;en Name&quot;);</span>
<a href="#l14.137"></a><span id="l14.137" class="difflineplus">+  Assert.equal(addon.description, &quot;en Description&quot;);</span>
<a href="#l14.138"></a><span id="l14.138" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1">new file mode 100644</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineminus">--- /dev/null</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineplus">+++ b/common/test/xpcshell/xpcshell.ini</span>
<a href="#l15.4"></a><span id="l15.4" class="difflineat">@@ -0,0 +1,13 @@</span>
<a href="#l15.5"></a><span id="l15.5" class="difflineplus">+[DEFAULT]</span>
<a href="#l15.6"></a><span id="l15.6" class="difflineplus">+tags = addons</span>
<a href="#l15.7"></a><span id="l15.7" class="difflineplus">+head = head_addons.js</span>
<a href="#l15.8"></a><span id="l15.8" class="difflineplus">+support-files =</span>
<a href="#l15.9"></a><span id="l15.9" class="difflineplus">+  data/**</span>
<a href="#l15.10"></a><span id="l15.10" class="difflineplus">+</span>
<a href="#l15.11"></a><span id="l15.11" class="difflineplus">+[test_bootstrap.js]</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineplus">+[test_bootstrap_const.js]</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+[test_bootstrap_globals.js]</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineplus">+[test_bootstrapped_chrome_manifest.js]</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineplus">+[test_invalid_install_rdf.js]</span>
<a href="#l15.16"></a><span id="l15.16" class="difflineplus">+[test_manifest.js]</span>
<a href="#l15.17"></a><span id="l15.17" class="difflineplus">+[test_manifest_locales.js]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mail/components/mailGlue.js</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mail/components/mailGlue.js</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -101,16 +101,20 @@ MailGlue.prototype = {</span>
<a href="#l16.4"></a><span id="l16.4"> </span>
<a href="#l16.5"></a><span id="l16.5">     ExtensionSupport.unregisterWindowListener(&quot;Thunderbird-internal-Toolbox&quot;);</span>
<a href="#l16.6"></a><span id="l16.6">     ExtensionSupport.unregisterWindowListener(&quot;Thunderbird-internal-BrowserConsole&quot;);</span>
<a href="#l16.7"></a><span id="l16.7">   },</span>
<a href="#l16.8"></a><span id="l16.8"> </span>
<a href="#l16.9"></a><span id="l16.9">   // nsIObserver implementation</span>
<a href="#l16.10"></a><span id="l16.10">   observe(aSubject, aTopic, aData) {</span>
<a href="#l16.11"></a><span id="l16.11">     switch (aTopic) {</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineplus">+    case &quot;app-startup&quot;:</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+      ChromeUtils.import(&quot;resource:///modules/BootstrapLoader.jsm&quot;);</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineplus">+      AddonManager.addExternalExtensionLoader(BootstrapLoader);</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineplus">+      break;</span>
<a href="#l16.16"></a><span id="l16.16">     case &quot;xpcom-shutdown&quot;:</span>
<a href="#l16.17"></a><span id="l16.17">       this._dispose();</span>
<a href="#l16.18"></a><span id="l16.18">       break;</span>
<a href="#l16.19"></a><span id="l16.19">     case &quot;final-ui-startup&quot;:</span>
<a href="#l16.20"></a><span id="l16.20">       this._onProfileStartup();</span>
<a href="#l16.21"></a><span id="l16.21">       break;</span>
<a href="#l16.22"></a><span id="l16.22">     case &quot;mail-startup-done&quot;:</span>
<a href="#l16.23"></a><span id="l16.23">       this._onMailStartupDone();</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

