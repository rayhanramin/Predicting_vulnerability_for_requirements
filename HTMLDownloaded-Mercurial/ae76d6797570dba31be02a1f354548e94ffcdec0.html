<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 18857:ae76d6797570dba31be02a1f354548e94ffcdec0</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ ae76d6797570dba31be02a1f354548e94ffcdec0" />
<meta property="og:url" content="/comm-central/rev/ae76d6797570dba31be02a1f354548e94ffcdec0" />
<meta property="og:description" content="Backout 969a3a5cb50f (Bug 1240327) for xpcshell crashes." />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / ae76d6797570dba31be02a1f354548e94ffcdec0 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/ae76d6797570dba31be02a1f354548e94ffcdec0">shortlog</a> |
<a href="/comm-central/log/ae76d6797570dba31be02a1f354548e94ffcdec0">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/ae76d6797570dba31be02a1f354548e94ffcdec0">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/ae76d6797570dba31be02a1f354548e94ffcdec0">files</a> |
changeset |
<a href="/comm-central/raw-rev/ae76d6797570dba31be02a1f354548e94ffcdec0">raw</a>  | <a href="/comm-central/archive/ae76d6797570dba31be02a1f354548e94ffcdec0.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
Backout 969a3a5cb50f (<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1240327">Bug 1240327</a>) for xpcshell crashes.
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#97;&#108;&#101;&#116;&#104;&#32;&#60;&#97;&#108;&#101;&#116;&#104;&#64;&#105;&#110;&#115;&#116;&#97;&#110;&#116;&#98;&#105;&#114;&#100;&#46;&#111;&#114;&#103;&#62;</td></tr>
<tr><td></td><td class="date age">Tue, 19 Jan 2016 16:56:15 +0100</td></tr>

<tr>
 <td>changeset 18857</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/ae76d6797570dba31be02a1f354548e94ffcdec0">ae76d6797570dba31be02a1f354548e94ffcdec0</a></td>
</tr>



<tr>
<td>parent 18856</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/d77b7f2deb94d3d6979c3455998365aeea56f37e">d77b7f2deb94d3d6979c3455998365aeea56f37e</a>
</td>
</tr>

<tr>
<td>child 18858</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/53b84f8641a8a0b46473177cb4b08031a8c3e55c">53b84f8641a8a0b46473177cb4b08031a8c3e55c</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=ae76d6797570dba31be02a1f354548e94ffcdec0">11558</a></td></tr>
<tr><td>push user</td><td>aleth@instantbird.org</td></tr>
<tr><td>push date</td><td class="date age">Tue, 19 Jan 2016 15:57:07 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@ae76d6797570 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=ae76d6797570dba31be02a1f354548e94ffcdec0">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=ae76d6797570dba31be02a1f354548e94ffcdec0&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=ae76d6797570dba31be02a1f354548e94ffcdec0&newProject=comm-central&newRevision=ae76d6797570dba31be02a1f354548e94ffcdec0&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=ae76d6797570dba31be02a1f354548e94ffcdec0&newProject=comm-central&newRevision=ae76d6797570dba31be02a1f354548e94ffcdec0&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=ae76d6797570dba31be02a1f354548e94ffcdec0&newProject=comm-central&newRevision=ae76d6797570dba31be02a1f354548e94ffcdec0&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>

<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1240327">1240327</a></td></tr>

<tr><td>backs out</td><td><a style="font-family: monospace" href="/comm-central/rev/969a3a5cb50fff98fb5225da45e61d95e13d6671">969a3a5cb50fff98fb5225da45e61d95e13d6671</a></td></tr>


</table></div>

<div class="page_body description">Backout 969a3a5cb50f (<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1240327">Bug 1240327</a>) for xpcshell crashes.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/base/public/nsIMsgFolder.idl">mailnews/base/public/nsIMsgFolder.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/base/public/nsIMsgFolder.idl">file</a> |
<a href="/comm-central/annotate/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/base/public/nsIMsgFolder.idl">annotate</a> |
<a href="/comm-central/diff/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/base/public/nsIMsgFolder.idl">diff</a> |
<a href="/comm-central/comparison/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/base/public/nsIMsgFolder.idl">comparison</a> |
<a href="/comm-central/log/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/base/public/nsIMsgFolder.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/base/util/nsMsgDBFolder.cpp">mailnews/base/util/nsMsgDBFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/base/util/nsMsgDBFolder.cpp">file</a> |
<a href="/comm-central/annotate/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/base/util/nsMsgDBFolder.cpp">annotate</a> |
<a href="/comm-central/diff/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/base/util/nsMsgDBFolder.cpp">diff</a> |
<a href="/comm-central/comparison/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/base/util/nsMsgDBFolder.cpp">comparison</a> |
<a href="/comm-central/log/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/base/util/nsMsgDBFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/base/util/nsMsgDBFolder.h">mailnews/base/util/nsMsgDBFolder.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/base/util/nsMsgDBFolder.h">file</a> |
<a href="/comm-central/annotate/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/base/util/nsMsgDBFolder.h">annotate</a> |
<a href="/comm-central/diff/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/base/util/nsMsgDBFolder.h">diff</a> |
<a href="/comm-central/comparison/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/base/util/nsMsgDBFolder.h">comparison</a> |
<a href="/comm-central/log/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/base/util/nsMsgDBFolder.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/compose/public/moz.build">mailnews/compose/public/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/compose/public/moz.build">file</a> |
<a href="/comm-central/annotate/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/compose/public/moz.build">annotate</a> |
<a href="/comm-central/diff/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/compose/public/moz.build">diff</a> |
<a href="/comm-central/comparison/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/compose/public/moz.build">comparison</a> |
<a href="/comm-central/log/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/compose/public/moz.build">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/compose/public/nsIMsgAttachmentHandler.idl">mailnews/compose/public/nsIMsgAttachmentHandler.idl</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/compose/public/nsIMsgAttachmentHandler.idl">diff</a> |
<a href="/comm-central/comparison/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/compose/public/nsIMsgAttachmentHandler.idl">comparison</a> |
<a href="/comm-central/log/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/compose/public/nsIMsgAttachmentHandler.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/compose/public/nsIMsgCompose.idl">mailnews/compose/public/nsIMsgCompose.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/compose/public/nsIMsgCompose.idl">file</a> |
<a href="/comm-central/annotate/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/compose/public/nsIMsgCompose.idl">annotate</a> |
<a href="/comm-central/diff/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/compose/public/nsIMsgCompose.idl">diff</a> |
<a href="/comm-central/comparison/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/compose/public/nsIMsgCompose.idl">comparison</a> |
<a href="/comm-central/log/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/compose/public/nsIMsgCompose.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/compose/public/nsIMsgSend.idl">mailnews/compose/public/nsIMsgSend.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/compose/public/nsIMsgSend.idl">file</a> |
<a href="/comm-central/annotate/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/compose/public/nsIMsgSend.idl">annotate</a> |
<a href="/comm-central/diff/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/compose/public/nsIMsgSend.idl">diff</a> |
<a href="/comm-central/comparison/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/compose/public/nsIMsgSend.idl">comparison</a> |
<a href="/comm-central/log/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/compose/public/nsIMsgSend.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/compose/src/moz.build">mailnews/compose/src/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/compose/src/moz.build">file</a> |
<a href="/comm-central/annotate/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/compose/src/moz.build">annotate</a> |
<a href="/comm-central/diff/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/compose/src/moz.build">diff</a> |
<a href="/comm-central/comparison/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/compose/src/moz.build">comparison</a> |
<a href="/comm-central/log/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/compose/src/moz.build">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/compose/src/nsMsgAttachmentHandler.cpp">mailnews/compose/src/nsMsgAttachmentHandler.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/compose/src/nsMsgAttachmentHandler.cpp">file</a> |
<a href="/comm-central/annotate/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/compose/src/nsMsgAttachmentHandler.cpp">annotate</a> |
<a href="/comm-central/diff/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/compose/src/nsMsgAttachmentHandler.cpp">diff</a> |
<a href="/comm-central/comparison/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/compose/src/nsMsgAttachmentHandler.cpp">comparison</a> |
<a href="/comm-central/log/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/compose/src/nsMsgAttachmentHandler.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/compose/src/nsMsgAttachmentHandler.h">mailnews/compose/src/nsMsgAttachmentHandler.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/compose/src/nsMsgAttachmentHandler.h">file</a> |
<a href="/comm-central/annotate/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/compose/src/nsMsgAttachmentHandler.h">annotate</a> |
<a href="/comm-central/diff/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/compose/src/nsMsgAttachmentHandler.h">diff</a> |
<a href="/comm-central/comparison/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/compose/src/nsMsgAttachmentHandler.h">comparison</a> |
<a href="/comm-central/log/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/compose/src/nsMsgAttachmentHandler.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/compose/src/nsMsgCompose.cpp">mailnews/compose/src/nsMsgCompose.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/compose/src/nsMsgCompose.cpp">file</a> |
<a href="/comm-central/annotate/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/compose/src/nsMsgCompose.cpp">annotate</a> |
<a href="/comm-central/diff/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/compose/src/nsMsgCompose.cpp">diff</a> |
<a href="/comm-central/comparison/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/compose/src/nsMsgCompose.cpp">comparison</a> |
<a href="/comm-central/log/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/compose/src/nsMsgCompose.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/compose/src/nsMsgCompose.h">mailnews/compose/src/nsMsgCompose.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/compose/src/nsMsgCompose.h">file</a> |
<a href="/comm-central/annotate/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/compose/src/nsMsgCompose.h">annotate</a> |
<a href="/comm-central/diff/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/compose/src/nsMsgCompose.h">diff</a> |
<a href="/comm-central/comparison/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/compose/src/nsMsgCompose.h">comparison</a> |
<a href="/comm-central/log/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/compose/src/nsMsgCompose.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/compose/src/nsMsgSend.cpp">mailnews/compose/src/nsMsgSend.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/compose/src/nsMsgSend.cpp">file</a> |
<a href="/comm-central/annotate/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/compose/src/nsMsgSend.cpp">annotate</a> |
<a href="/comm-central/diff/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/compose/src/nsMsgSend.cpp">diff</a> |
<a href="/comm-central/comparison/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/compose/src/nsMsgSend.cpp">comparison</a> |
<a href="/comm-central/log/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/compose/src/nsMsgSend.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/compose/src/nsMsgSend.h">mailnews/compose/src/nsMsgSend.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/compose/src/nsMsgSend.h">file</a> |
<a href="/comm-central/annotate/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/compose/src/nsMsgSend.h">annotate</a> |
<a href="/comm-central/diff/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/compose/src/nsMsgSend.h">diff</a> |
<a href="/comm-central/comparison/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/compose/src/nsMsgSend.h">comparison</a> |
<a href="/comm-central/log/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/compose/src/nsMsgSend.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/imap/src/nsImapMailFolder.cpp">mailnews/imap/src/nsImapMailFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/imap/src/nsImapMailFolder.cpp">file</a> |
<a href="/comm-central/annotate/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/imap/src/nsImapMailFolder.cpp">annotate</a> |
<a href="/comm-central/diff/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/imap/src/nsImapMailFolder.cpp">diff</a> |
<a href="/comm-central/comparison/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/imap/src/nsImapMailFolder.cpp">comparison</a> |
<a href="/comm-central/log/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/imap/src/nsImapMailFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/imap/src/nsImapMailFolder.h">mailnews/imap/src/nsImapMailFolder.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/imap/src/nsImapMailFolder.h">file</a> |
<a href="/comm-central/annotate/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/imap/src/nsImapMailFolder.h">annotate</a> |
<a href="/comm-central/diff/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/imap/src/nsImapMailFolder.h">diff</a> |
<a href="/comm-central/comparison/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/imap/src/nsImapMailFolder.h">comparison</a> |
<a href="/comm-central/log/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/imap/src/nsImapMailFolder.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/local/src/nsLocalMailFolder.cpp">mailnews/local/src/nsLocalMailFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/local/src/nsLocalMailFolder.cpp">file</a> |
<a href="/comm-central/annotate/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/local/src/nsLocalMailFolder.cpp">annotate</a> |
<a href="/comm-central/diff/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/local/src/nsLocalMailFolder.cpp">diff</a> |
<a href="/comm-central/comparison/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/local/src/nsLocalMailFolder.cpp">comparison</a> |
<a href="/comm-central/log/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/local/src/nsLocalMailFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/local/src/nsLocalMailFolder.h">mailnews/local/src/nsLocalMailFolder.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/local/src/nsLocalMailFolder.h">file</a> |
<a href="/comm-central/annotate/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/local/src/nsLocalMailFolder.h">annotate</a> |
<a href="/comm-central/diff/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/local/src/nsLocalMailFolder.h">diff</a> |
<a href="/comm-central/comparison/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/local/src/nsLocalMailFolder.h">comparison</a> |
<a href="/comm-central/log/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/local/src/nsLocalMailFolder.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/news/src/nsNewsFolder.cpp">mailnews/news/src/nsNewsFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/news/src/nsNewsFolder.cpp">file</a> |
<a href="/comm-central/annotate/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/news/src/nsNewsFolder.cpp">annotate</a> |
<a href="/comm-central/diff/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/news/src/nsNewsFolder.cpp">diff</a> |
<a href="/comm-central/comparison/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/news/src/nsNewsFolder.cpp">comparison</a> |
<a href="/comm-central/log/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/news/src/nsNewsFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/news/src/nsNewsFolder.h">mailnews/news/src/nsNewsFolder.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/news/src/nsNewsFolder.h">file</a> |
<a href="/comm-central/annotate/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/news/src/nsNewsFolder.h">annotate</a> |
<a href="/comm-central/diff/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/news/src/nsNewsFolder.h">diff</a> |
<a href="/comm-central/comparison/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/news/src/nsNewsFolder.h">comparison</a> |
<a href="/comm-central/log/ae76d6797570dba31be02a1f354548e94ffcdec0/mailnews/news/src/nsNewsFolder.h">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/base/public/nsIMsgFolder.idl</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/base/public/nsIMsgFolder.idl</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -25,17 +25,17 @@ interface nsIArray;</span>
<a href="#l1.4"></a><span id="l1.4"> interface nsIMutableArray;</span>
<a href="#l1.5"></a><span id="l1.5"> interface nsIMsgPluggableStore;</span>
<a href="#l1.6"></a><span id="l1.6"> </span>
<a href="#l1.7"></a><span id="l1.7"> typedef long nsMsgBiffState;</span>
<a href="#l1.8"></a><span id="l1.8"> </span>
<a href="#l1.9"></a><span id="l1.9"> // enumerated type for determining if a message has been replied to, forwarded, etc.</span>
<a href="#l1.10"></a><span id="l1.10"> typedef long nsMsgDispositionState;</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-[scriptable, uuid(5d253ba2-42aa-43a7-b584-0059855ababf)]</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+[scriptable, uuid(E6CC0770-D0D8-4E67-8A2E-02C82C32C99A)]</span>
<a href="#l1.14"></a><span id="l1.14"> interface nsIMsgFolder : nsISupports {</span>
<a href="#l1.15"></a><span id="l1.15"> </span>
<a href="#l1.16"></a><span id="l1.16">   const nsMsgBiffState nsMsgBiffState_NewMail = 0; // User has new mail waiting.</span>
<a href="#l1.17"></a><span id="l1.17">   const nsMsgBiffState nsMsgBiffState_NoMail =  1; // No new mail is waiting.</span>
<a href="#l1.18"></a><span id="l1.18">   const nsMsgBiffState nsMsgBiffState_Unknown = 2; // We dunno whether there is new mail.</span>
<a href="#l1.19"></a><span id="l1.19"> </span>
<a href="#l1.20"></a><span id="l1.20">   /// Returns an enumerator containing the messages within the current database.</span>
<a href="#l1.21"></a><span id="l1.21">   readonly attribute nsISimpleEnumerator messages;</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineat">@@ -826,15 +826,9 @@ interface nsIMsgFolder : nsISupports {</span>
<a href="#l1.23"></a><span id="l1.23">    */</span>
<a href="#l1.24"></a><span id="l1.24">   boolean getForcePropertyEmpty(in string propertyName);</span>
<a href="#l1.25"></a><span id="l1.25"> </span>
<a href="#l1.26"></a><span id="l1.26">   /**</span>
<a href="#l1.27"></a><span id="l1.27">    * Pluggable store for this folder. Currently, this will always be the same</span>
<a href="#l1.28"></a><span id="l1.28">    * as the pluggable store for the server.</span>
<a href="#l1.29"></a><span id="l1.29">    */</span>
<a href="#l1.30"></a><span id="l1.30">   readonly attribute nsIMsgPluggableStore msgStore;</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineminus">-  /**</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineminus">-   * Protocol type, i.e. &quot;pop3&quot;, &quot;imap&quot;, &quot;nntp&quot;, &quot;none&quot;, etc</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineminus">-   * used to construct URLs for this account type.</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineminus">-   */</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineminus">-  readonly attribute ACString incomingServerType;</span>
<a href="#l1.37"></a><span id="l1.37"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/base/util/nsMsgDBFolder.cpp</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgDBFolder.cpp</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -5936,24 +5936,16 @@ NS_IMETHODIMP nsMsgDBFolder::OrProcessin</span>
<a href="#l2.4"></a><span id="l2.4"> NS_IMETHODIMP nsMsgDBFolder::AndProcessingFlags(nsMsgKey aKey, uint32_t mask)</span>
<a href="#l2.5"></a><span id="l2.5"> {</span>
<a href="#l2.6"></a><span id="l2.6">   for (uint32_t i = 0; i &lt; nsMsgProcessingFlags::NumberOfFlags; i++)</span>
<a href="#l2.7"></a><span id="l2.7">     if (!(mProcessingFlag[i].bit &amp; mask) &amp;&amp; mProcessingFlag[i].keys)</span>
<a href="#l2.8"></a><span id="l2.8">       mProcessingFlag[i].keys-&gt;Remove(aKey);</span>
<a href="#l2.9"></a><span id="l2.9">   return NS_OK;</span>
<a href="#l2.10"></a><span id="l2.10"> }</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-// Each implementation must provide an override of this, connecting the folder</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-// type to the corresponding incoming server type.</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::GetIncomingServerType(nsACString&amp; aIncomingServerType)</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineminus">-{</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineminus">-  NS_ASSERTION(false, &quot;subclasses need to override this&quot;);</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineminus">-  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineminus">-}</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineminus">-</span>
<a href="#l2.20"></a><span id="l2.20"> void nsMsgDBFolder::ClearProcessingFlags()</span>
<a href="#l2.21"></a><span id="l2.21"> {</span>
<a href="#l2.22"></a><span id="l2.22">   for (uint32_t i = 0; i &lt; nsMsgProcessingFlags::NumberOfFlags; i++)</span>
<a href="#l2.23"></a><span id="l2.23">   {</span>
<a href="#l2.24"></a><span id="l2.24">     // There is no clear method so we need to delete and re-create.</span>
<a href="#l2.25"></a><span id="l2.25">     delete mProcessingFlag[i].keys;</span>
<a href="#l2.26"></a><span id="l2.26">     mProcessingFlag[i].keys = nsMsgKeySetU::Create();</span>
<a href="#l2.27"></a><span id="l2.27">   }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/base/util/nsMsgDBFolder.h</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgDBFolder.h</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -80,16 +80,22 @@ public:</span>
<a href="#l3.4"></a><span id="l3.4">   nsresult CreateDirectoryForFolder(nsIFile **result);</span>
<a href="#l3.5"></a><span id="l3.5">   nsresult CreateBackupDirectory(nsIFile **result);</span>
<a href="#l3.6"></a><span id="l3.6">   nsresult GetBackupSummaryFile(nsIFile **result, const nsACString&amp; newName);</span>
<a href="#l3.7"></a><span id="l3.7">   nsresult GetMsgPreviewTextFromStream(nsIMsgDBHdr *msgHdr, nsIInputStream *stream);</span>
<a href="#l3.8"></a><span id="l3.8">   nsresult HandleAutoCompactEvent(nsIMsgWindow *aMsgWindow);</span>
<a href="#l3.9"></a><span id="l3.9"> protected:</span>
<a href="#l3.10"></a><span id="l3.10">   virtual ~nsMsgDBFolder();</span>
<a href="#l3.11"></a><span id="l3.11">   </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+  // this is a little helper function that is not part of the public interface. </span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+  // we use it to get the IID of the incoming server for the derived folder.</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+  // w/out a function like this we would have to implement GetServer in each</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+  // derived folder class.</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+  virtual void GetIncomingServerType(nsCString&amp; serverType) = 0;</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+</span>
<a href="#l3.18"></a><span id="l3.18">   virtual nsresult CreateBaseMessageURI(const nsACString&amp; aURI);</span>
<a href="#l3.19"></a><span id="l3.19"> </span>
<a href="#l3.20"></a><span id="l3.20">   void compressQuotesInMsgSnippet(const nsString&amp; aMessageText, nsAString&amp; aCompressedQuotesStr);</span>
<a href="#l3.21"></a><span id="l3.21">   void decodeMsgSnippet(const nsACString&amp; aEncodingType, bool aIsComplete, nsCString&amp; aMsgSnippet);</span>
<a href="#l3.22"></a><span id="l3.22"> </span>
<a href="#l3.23"></a><span id="l3.23">   // helper routine to parse the URI and update member variables</span>
<a href="#l3.24"></a><span id="l3.24">   nsresult parseURI(bool needServer=false);</span>
<a href="#l3.25"></a><span id="l3.25">   nsresult GetBaseStringBundle(nsIStringBundle **aBundle);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/compose/public/moz.build</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/compose/public/moz.build</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -1,16 +1,15 @@</span>
<a href="#l4.4"></a><span id="l4.4"> # vim: set filetype=python:</span>
<a href="#l4.5"></a><span id="l4.5"> # This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l4.6"></a><span id="l4.6"> # License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l4.7"></a><span id="l4.7"> # file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l4.8"></a><span id="l4.8"> </span>
<a href="#l4.9"></a><span id="l4.9"> XPIDL_SOURCES += [</span>
<a href="#l4.10"></a><span id="l4.10">     'nsIMsgAttachment.idl',</span>
<a href="#l4.11"></a><span id="l4.11" class="difflineminus">-    'nsIMsgAttachmentHandler.idl',</span>
<a href="#l4.12"></a><span id="l4.12">     'nsIMsgCompFields.idl',</span>
<a href="#l4.13"></a><span id="l4.13">     'nsIMsgCompose.idl',</span>
<a href="#l4.14"></a><span id="l4.14">     'nsIMsgComposeParams.idl',</span>
<a href="#l4.15"></a><span id="l4.15">     'nsIMsgComposeProgressParams.idl',</span>
<a href="#l4.16"></a><span id="l4.16">     'nsIMsgComposeSecure.idl',</span>
<a href="#l4.17"></a><span id="l4.17">     'nsIMsgComposeService.idl',</span>
<a href="#l4.18"></a><span id="l4.18">     'nsIMsgCompUtils.idl',</span>
<a href="#l4.19"></a><span id="l4.19">     'nsIMsgQuote.idl',</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1">deleted file mode 100644</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineminus">--- a/mailnews/compose/public/nsIMsgAttachmentHandler.idl</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineplus">+++ /dev/null</span>
<a href="#l5.4"></a><span id="l5.4" class="difflineat">@@ -1,45 +0,0 @@</span>
<a href="#l5.5"></a><span id="l5.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l5.6"></a><span id="l5.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l5.7"></a><span id="l5.7" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l5.8"></a><span id="l5.8" class="difflineminus">-</span>
<a href="#l5.9"></a><span id="l5.9" class="difflineminus">-#include &quot;nsISupports.idl&quot;</span>
<a href="#l5.10"></a><span id="l5.10" class="difflineminus">-interface nsIFile;</span>
<a href="#l5.11"></a><span id="l5.11" class="difflineminus">-</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-// This interface provides minimal XPCONNECT access to objects of type</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-// nsMsgAttachmentHandler. This is primarily for use with new account</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineminus">-// types and JsAccount, so this is probably not the interface that you</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineminus">-// want if you are working with standard account types.</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineminus">-</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineminus">-[scriptable, uuid(1731283c-60fe-4102-a804-622a84cc1a08)]</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineminus">-interface nsIMsgAttachmentHandler : nsISupports</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineminus">-{</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineminus">-  /// The real type, once we know it.</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineminus">-  readonly attribute ACString type;</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineminus">-</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineminus">-  /// URI with link to the attachment.</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineminus">-  readonly attribute ACString uri;</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineminus">-</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineminus">-  /// The temp file to which we save it.</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineminus">-  readonly attribute nsIFile tmpFile;</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineminus">-</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineminus">-  /// The name for the headers, if different from the URL.</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineminus">-  readonly attribute AUTF8String name;</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineminus">-</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineminus">-  /// Size of the attachment, in bytes.</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineminus">-  readonly attribute unsigned long size;</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineminus">-</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineminus">-  /// This is for multipart/related Content-ID's.</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineminus">-  readonly attribute ACString contentId;</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineminus">-</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineminus">-  /// True if this should be sent as a link to a file.</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineminus">-  readonly attribute boolean sendViaCloud;</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineminus">-</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineminus">-  /// Name of the character set for the attachment.</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineminus">-  readonly attribute ACString charset;</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineminus">-</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineminus">-  /// The encoding, once we've decided.</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineminus">-  readonly attribute ACString encoding;</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineminus">-</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineminus">-  /// Whether the attachment has been encoded, for example to base64.</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineminus">-  readonly attribute boolean alreadyEncoded;</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineminus">-};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/compose/public/nsIMsgCompose.idl</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/compose/public/nsIMsgCompose.idl</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -93,17 +93,17 @@ native nsString(nsString);</span>
<a href="#l6.4"></a><span id="l6.4"> </span>
<a href="#l6.5"></a><span id="l6.5"> /* recycling listener interface */</span>
<a href="#l6.6"></a><span id="l6.6"> [scriptable, uuid(0b28cc56-1dd2-11b2-bbe4-99e6a314f8ba)]</span>
<a href="#l6.7"></a><span id="l6.7"> interface nsIMsgComposeRecyclingListener : nsISupports {</span>
<a href="#l6.8"></a><span id="l6.8">   void onClose();</span>
<a href="#l6.9"></a><span id="l6.9">   void onReopen(in nsIMsgComposeParams params);</span>
<a href="#l6.10"></a><span id="l6.10"> };</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-[scriptable, uuid(d06ca5af-66b5-4a08-961f-5b47e88cee98)]</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+[scriptable, uuid(44596460-2de4-11e4-8c21-0800200c9a66)]</span>
<a href="#l6.14"></a><span id="l6.14"> interface nsIMsgCompose : nsIMsgSendListener {</span>
<a href="#l6.15"></a><span id="l6.15"> </span>
<a href="#l6.16"></a><span id="l6.16">   /**</span>
<a href="#l6.17"></a><span id="l6.17">    * Initializes the msg compose object.</span>
<a href="#l6.18"></a><span id="l6.18">    *</span>
<a href="#l6.19"></a><span id="l6.19">    * @param aParams   An nsIMsgComposeParams object containing the initial</span>
<a href="#l6.20"></a><span id="l6.20">    *                  details for the compose.</span>
<a href="#l6.21"></a><span id="l6.21">    * @param aWindow   The optional window associated with this compose object.</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineat">@@ -121,29 +121,16 @@ interface nsIMsgCompose : nsIMsgSendList</span>
<a href="#l6.23"></a><span id="l6.23">   void RegisterStateListener(in nsIMsgComposeStateListener stateListener);</span>
<a href="#l6.24"></a><span id="l6.24"> </span>
<a href="#l6.25"></a><span id="l6.25">   /* ... */</span>
<a href="#l6.26"></a><span id="l6.26">   void UnregisterStateListener(in nsIMsgComposeStateListener stateListener);</span>
<a href="#l6.27"></a><span id="l6.27"> </span>
<a href="#l6.28"></a><span id="l6.28">   /* ... */</span>
<a href="#l6.29"></a><span id="l6.29">   void SendMsg(in MSG_DeliverMode deliverMode, in nsIMsgIdentity identity, in string accountKey, in nsIMsgWindow aMsgWindow, in nsIMsgProgress progress);</span>
<a href="#l6.30"></a><span id="l6.30"> </span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">-  /**</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineminus">-   * After all Compose preparations are complete, send the prepared message to</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineminus">-   * the server. This exists primarily to allow an override of the sending to</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineminus">-   * use a non-SMTP method for send.</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineminus">-   *</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineminus">-   * @param deliverMode One of the nsIMsgCompDeliverMode values.</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineminus">-   * @param identity The message identity.</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineminus">-   * @param accountKey The message account key.</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineminus">-   */</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineminus">-  void sendMsgToServer(in MSG_DeliverMode deliverMode,</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineminus">-                       in nsIMsgIdentity identity,</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineminus">-                       in string accountKey);</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineminus">-</span>
<a href="#l6.44"></a><span id="l6.44">   /* ... */</span>
<a href="#l6.45"></a><span id="l6.45">   void CloseWindow(in boolean reclycleIt);</span>
<a href="#l6.46"></a><span id="l6.46"> </span>
<a href="#l6.47"></a><span id="l6.47">   /* ... */</span>
<a href="#l6.48"></a><span id="l6.48">   void abort();</span>
<a href="#l6.49"></a><span id="l6.49">     </span>
<a href="#l6.50"></a><span id="l6.50">   /* ... */</span>
<a href="#l6.51"></a><span id="l6.51">   void quoteMessage(in string msgURI);</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineat">@@ -186,21 +173,18 @@ interface nsIMsgCompose : nsIMsgSendList</span>
<a href="#l6.53"></a><span id="l6.53">    * if it is different the SendMsg version will overwrite this identity.</span>
<a href="#l6.54"></a><span id="l6.54">    */</span>
<a href="#l6.55"></a><span id="l6.55">   attribute nsIMsgIdentity identity;</span>
<a href="#l6.56"></a><span id="l6.56"> </span>
<a href="#l6.57"></a><span id="l6.57">   /* Check if the composing mail headers (and identity) can be converted to a mail charset.</span>
<a href="#l6.58"></a><span id="l6.58">   */</span>
<a href="#l6.59"></a><span id="l6.59">   boolean checkCharsetConversion(in nsIMsgIdentity identity, out string fallbackCharset);</span>
<a href="#l6.60"></a><span id="l6.60"> </span>
<a href="#l6.61"></a><span id="l6.61" class="difflineminus">-  /* The message send object. This is created by default to be the SMTP server</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineminus">-   * in sendMsgToServer, but if that method is overridden, set the actual</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineminus">-   * value used here.</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineminus">-   */</span>
<a href="#l6.65"></a><span id="l6.65" class="difflineminus">-  attribute nsIMsgSend messageSend;</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineplus">+  /* the message send object */</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineplus">+  readonly attribute nsIMsgSend messageSend;</span>
<a href="#l6.68"></a><span id="l6.68"> </span>
<a href="#l6.69"></a><span id="l6.69">   /*</span>
<a href="#l6.70"></a><span id="l6.70">    * Clear the messageSend object to break any circular references</span>
<a href="#l6.71"></a><span id="l6.71">    */</span>
<a href="#l6.72"></a><span id="l6.72">    void clearMessageSend();</span>
<a href="#l6.73"></a><span id="l6.73"> </span>
<a href="#l6.74"></a><span id="l6.74">   /* ... */</span>
<a href="#l6.75"></a><span id="l6.75">   attribute nsIEditor editor;</span>
<a href="#l6.76"></a><span id="l6.76" class="difflineat">@@ -221,20 +205,16 @@ interface nsIMsgCompose : nsIMsgSendList</span>
<a href="#l6.77"></a><span id="l6.77">   readonly attribute long wrapLength;</span>
<a href="#l6.78"></a><span id="l6.78"> </span>
<a href="#l6.79"></a><span id="l6.79">   /* by reading this value, you can determine if yes or not the message has been mofified</span>
<a href="#l6.80"></a><span id="l6.80">      by the user. When you set this value to false, you reset the modification count</span>
<a href="#l6.81"></a><span id="l6.81">      of the body to 0 (clean).</span>
<a href="#l6.82"></a><span id="l6.82">   */</span>
<a href="#l6.83"></a><span id="l6.83">   attribute boolean bodyModified;</span>
<a href="#l6.84"></a><span id="l6.84"> </span>
<a href="#l6.85"></a><span id="l6.85" class="difflineminus">-  /* The body string is stored as a byte string in comp fields, but is converted to</span>
<a href="#l6.86"></a><span id="l6.86" class="difflineminus">-   * UTF16 when fetched by GetBody(). Fetch the body without conversion.</span>
<a href="#l6.87"></a><span id="l6.87" class="difflineminus">-   */</span>
<a href="#l6.88"></a><span id="l6.88" class="difflineminus">-  readonly attribute ACString bodyRaw;</span>
<a href="#l6.89"></a><span id="l6.89"> </span>
<a href="#l6.90"></a><span id="l6.90">   /**</span>
<a href="#l6.91"></a><span id="l6.91">    *  Init the editor THIS USED TO BE [noscript]</span>
<a href="#l6.92"></a><span id="l6.92">    *  Now, this is called after editor is created,</span>
<a href="#l6.93"></a><span id="l6.93">    *  which is triggered by loading startup url from JS.</span>
<a href="#l6.94"></a><span id="l6.94">    *  The completion of document loading is detected by observing </span>
<a href="#l6.95"></a><span id="l6.95">    *  the &quot;obs_documentCreated&quot; command</span>
<a href="#l6.96"></a><span id="l6.96">    */</span>
<a href="#l6.97"></a><span id="l6.97" class="difflineat">@@ -297,21 +277,18 @@ interface nsIMsgCompose : nsIMsgSendList</span>
<a href="#l6.98"></a><span id="l6.98">   attribute boolean insertingQuotedContent;</span>
<a href="#l6.99"></a><span id="l6.99"> </span>
<a href="#l6.100"></a><span id="l6.100">   /* for easier use of nsIMsgSendListener */</span>
<a href="#l6.101"></a><span id="l6.101">   void addMsgSendListener(in nsIMsgSendListener sendListener);</span>
<a href="#l6.102"></a><span id="l6.102"> </span>
<a href="#l6.103"></a><span id="l6.103">   /* for easier use of nsIMsgSendListener */</span>
<a href="#l6.104"></a><span id="l6.104">   void removeMsgSendListener(in nsIMsgSendListener sendListener);</span>
<a href="#l6.105"></a><span id="l6.105"> </span>
<a href="#l6.106"></a><span id="l6.106" class="difflineminus">-  // Access during mail-set-sender observer if needed, see nsIMsgCompDeliverMode.</span>
<a href="#l6.107"></a><span id="l6.107" class="difflineminus">-  readonly attribute MSG_DeliverMode deliverMode;</span>
<a href="#l6.108"></a><span id="l6.108" class="difflineminus">-</span>
<a href="#l6.109"></a><span id="l6.109"> };</span>
<a href="#l6.110"></a><span id="l6.110"> </span>
<a href="#l6.111"></a><span id="l6.111"> /* send listener interface */</span>
<a href="#l6.112"></a><span id="l6.112" class="difflineminus">-[scriptable, uuid(ad6ee068-b225-47f9-a50e-8e48440282ca)]</span>
<a href="#l6.113"></a><span id="l6.113" class="difflineplus">+[uuid(ACC72780-2CEA-11D5-9DAA-BACDEAC1EEFC)]</span>
<a href="#l6.114"></a><span id="l6.114"> interface nsIMsgComposeSendListener : nsISupports {</span>
<a href="#l6.115"></a><span id="l6.115"> </span>
<a href="#l6.116"></a><span id="l6.116">   void setMsgCompose(in nsIMsgCompose msgCompose);</span>
<a href="#l6.117"></a><span id="l6.117">   void setDeliverMode(in MSG_DeliverMode deliverMode);</span>
<a href="#l6.118"></a><span id="l6.118">  </span>
<a href="#l6.119"></a><span id="l6.119"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/compose/public/nsIMsgSend.idl</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/compose/public/nsIMsgSend.idl</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -29,17 +29,16 @@ interface nsIMsgDBHdr;</span>
<a href="#l7.4"></a><span id="l7.4"> interface nsIMsgHdr;</span>
<a href="#l7.5"></a><span id="l7.5"> interface nsIFile;</span>
<a href="#l7.6"></a><span id="l7.6"> interface nsIOutputStream;</span>
<a href="#l7.7"></a><span id="l7.7"> interface nsIMsgComposeSecure;</span>
<a href="#l7.8"></a><span id="l7.8"> interface nsIMsgStatusFeedback;</span>
<a href="#l7.9"></a><span id="l7.9"> interface nsIEditor;</span>
<a href="#l7.10"></a><span id="l7.10"> interface nsIArray;</span>
<a href="#l7.11"></a><span id="l7.11"> interface nsISupportsArray;</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-interface nsIMsgAttachmentHandler;</span>
<a href="#l7.13"></a><span id="l7.13"> </span>
<a href="#l7.14"></a><span id="l7.14"> typedef long nsMsgDeliverMode;</span>
<a href="#l7.15"></a><span id="l7.15"> </span>
<a href="#l7.16"></a><span id="l7.16"> [scriptable, uuid(c658cd1f-dc4a-43c0-911c-c6d3e569ca7e)]</span>
<a href="#l7.17"></a><span id="l7.17"> interface nsIMsgAttachmentData : nsISupports</span>
<a href="#l7.18"></a><span id="l7.18"> {</span>
<a href="#l7.19"></a><span id="l7.19">   /// The URL to attach.</span>
<a href="#l7.20"></a><span id="l7.20">   attribute nsIURI url;</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineat">@@ -147,17 +146,17 @@ interface nsIMsgEmbeddedImageData : nsIS</span>
<a href="#l7.22"></a><span id="l7.22"> class nsMsgAttachmentHandler;</span>
<a href="#l7.23"></a><span id="l7.23"> #include &quot;nsAutoPtr.h&quot;</span>
<a href="#l7.24"></a><span id="l7.24"> #include &quot;nsTArray.h&quot;</span>
<a href="#l7.25"></a><span id="l7.25"> %}</span>
<a href="#l7.26"></a><span id="l7.26"> </span>
<a href="#l7.27"></a><span id="l7.27"> [ptr] native nsMsgAttachedFile(nsMsgAttachedFile);</span>
<a href="#l7.28"></a><span id="l7.28"> [ptr] native nsMsgAttachmentHandlerArray(nsTArray&lt;RefPtr&lt;nsMsgAttachmentHandler&gt;&gt;);</span>
<a href="#l7.29"></a><span id="l7.29"> </span>
<a href="#l7.30"></a><span id="l7.30" class="difflineminus">-[scriptable, uuid(adcea7be-0585-4f43-ab97-f2436ea5e002)]</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineplus">+[scriptable, uuid(3fa45021-8174-478f-8c69-f3a8dc3f49fc)]</span>
<a href="#l7.32"></a><span id="l7.32"> interface nsIMsgSend : nsISupports</span>
<a href="#l7.33"></a><span id="l7.33"> {</span>
<a href="#l7.34"></a><span id="l7.34">   //</span>
<a href="#l7.35"></a><span id="l7.35">   // This is the primary interface for creating and sending RFC822 messages</span>
<a href="#l7.36"></a><span id="l7.36">   // in the new architecture. Currently, this method supports many arguments</span>
<a href="#l7.37"></a><span id="l7.37">   // that change the behavior of the operation. This will change in time to </span>
<a href="#l7.38"></a><span id="l7.38">   // be separate calls that will be more singluar in nature.</span>
<a href="#l7.39"></a><span id="l7.39">   //</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineat">@@ -365,41 +364,9 @@ interface nsIMsgSend : nsISupports</span>
<a href="#l7.41"></a><span id="l7.41"> </span>
<a href="#l7.42"></a><span id="l7.42">     nsIOutputStream getOutputStream();</span>
<a href="#l7.43"></a><span id="l7.43"> </span>
<a href="#l7.44"></a><span id="l7.44">     attribute nsIRequest runningRequest;</span>
<a href="#l7.45"></a><span id="l7.45"> </span>
<a href="#l7.46"></a><span id="l7.46">     attribute nsresult status;</span>
<a href="#l7.47"></a><span id="l7.47"> </span>
<a href="#l7.48"></a><span id="l7.48">     attribute nsIMsgComposeSecure cryptoclosure;</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineminus">-</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineminus">-    /// Access the local copy of the composition fields.</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineminus">-    readonly attribute nsIMsgCompFields sendCompFields;</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineminus">-</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineminus">-    /// The message body.</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineminus">-    readonly attribute AString sendBody;</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineminus">-</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineminus">-    /// The type of the message body (typically text/plain or text/html).</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineminus">-    readonly attribute ACString sendBodyType;</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineminus">-</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineminus">-    /// The identity to use to send the message.</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineminus">-    readonly attribute nsIMsgIdentity identity;</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineminus">-</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineminus">-    /**</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineminus">-     * Get a handler for an attachment by its index.</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineminus">-     * The lifetime of the attachment is dependent on the existence</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineminus">-     * of the underlying send object, so do not hold onto these</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineminus">-     * attachment handlers.</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineminus">-     *</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineminus">-     * @param index  Index used to specify a particular attachment.</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineminus">-     *</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineminus">-     * @return       Attachment handler with information about the attachment.</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineminus">-     */</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineminus">-    nsIMsgAttachmentHandler getAttachment(in unsigned long index);</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineminus">-</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineminus">-    /// The folder name to which the message will be saved,</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineminus">-    /// used by error reporting.</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineminus">-    attribute AString savedToFolderName;</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineminus">-</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineminus">-    /// Should we deliver this message (versus saving as a file)?</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineminus">-    attribute boolean dontDeliver;</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineminus">-</span>
<a href="#l7.81"></a><span id="l7.81"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/compose/src/moz.build</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/compose/src/moz.build</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -1,19 +1,15 @@</span>
<a href="#l8.4"></a><span id="l8.4"> # vim: set filetype=python:</span>
<a href="#l8.5"></a><span id="l8.5"> # This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l8.6"></a><span id="l8.6"> # License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l8.7"></a><span id="l8.7"> # file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l8.8"></a><span id="l8.8"> </span>
<a href="#l8.9"></a><span id="l8.9"> EXPORTS += [</span>
<a href="#l8.10"></a><span id="l8.10">     'nsComposeStrings.h',</span>
<a href="#l8.11"></a><span id="l8.11" class="difflineminus">-    'nsMsgAttachmentHandler.h',</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-    'nsMsgCompFields.h',</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-    'nsMsgCompose.h',</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineminus">-    'nsMsgSend.h',</span>
<a href="#l8.15"></a><span id="l8.15"> ]</span>
<a href="#l8.16"></a><span id="l8.16"> </span>
<a href="#l8.17"></a><span id="l8.17"> SOURCES += [</span>
<a href="#l8.18"></a><span id="l8.18">     'nsComposeStrings.cpp',</span>
<a href="#l8.19"></a><span id="l8.19">     'nsMsgAttachment.cpp',</span>
<a href="#l8.20"></a><span id="l8.20">     'nsMsgAttachmentHandler.cpp',</span>
<a href="#l8.21"></a><span id="l8.21">     'nsMsgCompFields.cpp',</span>
<a href="#l8.22"></a><span id="l8.22">     'nsMsgCompose.cpp',</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgAttachmentHandler.cpp</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgAttachmentHandler.cpp</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -149,96 +149,16 @@ nsMsgAttachmentHandler::~nsMsgAttachment</span>
<a href="#l9.4"></a><span id="l9.4">     mTmpFile-&gt;Remove(false);</span>
<a href="#l9.5"></a><span id="l9.5"> </span>
<a href="#l9.6"></a><span id="l9.6">   if (mOutFile)</span>
<a href="#l9.7"></a><span id="l9.7">     mOutFile-&gt;Close();</span>
<a href="#l9.8"></a><span id="l9.8"> </span>
<a href="#l9.9"></a><span id="l9.9">   CleanupTempFile();</span>
<a href="#l9.10"></a><span id="l9.10"> }</span>
<a href="#l9.11"></a><span id="l9.11"> </span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-NS_IMPL_ISUPPORTS(nsMsgAttachmentHandler, nsIMsgAttachmentHandler)</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">-</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineminus">-// nsIMsgAttachmentHandler implementation.</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineminus">-</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineminus">-NS_IMETHODIMP nsMsgAttachmentHandler::GetType(nsACString&amp; aType)</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineminus">-{</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineminus">-  aType.Assign(m_type);</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineminus">-  return NS_OK;</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineminus">-}</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineminus">-</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineminus">-NS_IMETHODIMP nsMsgAttachmentHandler::GetUri(nsACString&amp; aUri)</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineminus">-{</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineminus">-  nsAutoCString turl;</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineminus">-  if (!mURL)</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineminus">-  {</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineminus">-    if (!m_uri.IsEmpty())</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineminus">-      turl = m_uri;</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineminus">-  }</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineminus">-  else</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineminus">-    mURL-&gt;GetSpec(turl);</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineminus">-  aUri.Assign(turl);</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineminus">-  return NS_OK;</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineminus">-}</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineminus">-</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineminus">-NS_IMETHODIMP nsMsgAttachmentHandler::GetTmpFile(nsIFile **aTmpFile)</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineminus">-{</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aTmpFile);</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineminus">-  if (!mTmpFile)</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineminus">-  NS_ADDREF(*aTmpFile = mTmpFile);</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineminus">-  return NS_OK;</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineminus">-}</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineminus">-</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineminus">-NS_IMETHODIMP nsMsgAttachmentHandler::GetName(nsACString&amp; aName)</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineminus">-{</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineminus">-  aName.Assign(m_realName);</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineminus">-  return NS_OK;</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineminus">-}</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineminus">-</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineminus">-NS_IMETHODIMP nsMsgAttachmentHandler::GetSize(uint32_t *aSize)</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineminus">-{</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aSize);</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineminus">-  *aSize = m_size;</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineminus">-  return NS_OK;</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineminus">-}</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineminus">-</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineminus">-NS_IMETHODIMP nsMsgAttachmentHandler::GetContentId(nsACString&amp; aContentId)</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineminus">-{</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineminus">-  aContentId.Assign(m_contentId);</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineminus">-  return NS_OK;</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineminus">-}</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineminus">-</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineminus">-NS_IMETHODIMP nsMsgAttachmentHandler::GetSendViaCloud(bool* aSendViaCloud)</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineminus">-{</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aSendViaCloud);</span>
<a href="#l9.67"></a><span id="l9.67" class="difflineminus">-  *aSendViaCloud = mSendViaCloud;</span>
<a href="#l9.68"></a><span id="l9.68" class="difflineminus">-  return NS_OK;</span>
<a href="#l9.69"></a><span id="l9.69" class="difflineminus">-}</span>
<a href="#l9.70"></a><span id="l9.70" class="difflineminus">-</span>
<a href="#l9.71"></a><span id="l9.71" class="difflineminus">-NS_IMETHODIMP nsMsgAttachmentHandler::GetCharset(nsACString&amp; aCharset)</span>
<a href="#l9.72"></a><span id="l9.72" class="difflineminus">-{</span>
<a href="#l9.73"></a><span id="l9.73" class="difflineminus">-  aCharset.Assign(m_charset);</span>
<a href="#l9.74"></a><span id="l9.74" class="difflineminus">-  return NS_OK;</span>
<a href="#l9.75"></a><span id="l9.75" class="difflineminus">-}</span>
<a href="#l9.76"></a><span id="l9.76" class="difflineminus">-</span>
<a href="#l9.77"></a><span id="l9.77" class="difflineminus">-NS_IMETHODIMP nsMsgAttachmentHandler::GetEncoding(nsACString&amp; aEncoding)</span>
<a href="#l9.78"></a><span id="l9.78" class="difflineminus">-{</span>
<a href="#l9.79"></a><span id="l9.79" class="difflineminus">-  aEncoding.Assign(m_encoding);</span>
<a href="#l9.80"></a><span id="l9.80" class="difflineminus">-  return NS_OK;</span>
<a href="#l9.81"></a><span id="l9.81" class="difflineminus">-}</span>
<a href="#l9.82"></a><span id="l9.82" class="difflineminus">-</span>
<a href="#l9.83"></a><span id="l9.83" class="difflineminus">-NS_IMETHODIMP nsMsgAttachmentHandler::GetAlreadyEncoded(bool* aAlreadyEncoded)</span>
<a href="#l9.84"></a><span id="l9.84" class="difflineminus">-{</span>
<a href="#l9.85"></a><span id="l9.85" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aAlreadyEncoded);</span>
<a href="#l9.86"></a><span id="l9.86" class="difflineminus">-  *aAlreadyEncoded = m_already_encoded_p;</span>
<a href="#l9.87"></a><span id="l9.87" class="difflineminus">-  return NS_OK;</span>
<a href="#l9.88"></a><span id="l9.88" class="difflineminus">-}</span>
<a href="#l9.89"></a><span id="l9.89" class="difflineminus">-</span>
<a href="#l9.90"></a><span id="l9.90" class="difflineminus">-// Local methods.</span>
<a href="#l9.91"></a><span id="l9.91" class="difflineminus">-</span>
<a href="#l9.92"></a><span id="l9.92"> void</span>
<a href="#l9.93"></a><span id="l9.93"> nsMsgAttachmentHandler::CleanupTempFile()</span>
<a href="#l9.94"></a><span id="l9.94"> {</span>
<a href="#l9.95"></a><span id="l9.95"> #ifdef XP_MACOSX</span>
<a href="#l9.96"></a><span id="l9.96">   if (mEncodedWorkingFile) {</span>
<a href="#l9.97"></a><span id="l9.97">     mEncodedWorkingFile-&gt;Remove(false);</span>
<a href="#l9.98"></a><span id="l9.98">     mEncodedWorkingFile = nullptr;</span>
<a href="#l9.99"></a><span id="l9.99">   }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgAttachmentHandler.h</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgAttachmentHandler.h</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -9,17 +9,16 @@</span>
<a href="#l10.4"></a><span id="l10.4"> #include &quot;nsIURL.h&quot;</span>
<a href="#l10.5"></a><span id="l10.5"> #include &quot;nsMsgCompFields.h&quot;</span>
<a href="#l10.6"></a><span id="l10.6"> #include &quot;nsIMsgStatusFeedback.h&quot;</span>
<a href="#l10.7"></a><span id="l10.7"> #include &quot;nsIChannel.h&quot;</span>
<a href="#l10.8"></a><span id="l10.8"> #include &quot;nsIMsgSend.h&quot;</span>
<a href="#l10.9"></a><span id="l10.9"> #include &quot;nsIFileStreams.h&quot;</span>
<a href="#l10.10"></a><span id="l10.10"> #include &quot;nsIStreamConverter.h&quot;</span>
<a href="#l10.11"></a><span id="l10.11"> #include &quot;nsAutoPtr.h&quot;</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-#include &quot;nsIMsgAttachmentHandler.h&quot;</span>
<a href="#l10.13"></a><span id="l10.13"> </span>
<a href="#l10.14"></a><span id="l10.14"> #ifdef XP_MACOSX</span>
<a href="#l10.15"></a><span id="l10.15"> </span>
<a href="#l10.16"></a><span id="l10.16"> #include &quot;nsMsgAppleDouble.h&quot;</span>
<a href="#l10.17"></a><span id="l10.17"> #include &quot;nsILocalFileMac.h&quot;</span>
<a href="#l10.18"></a><span id="l10.18"> </span>
<a href="#l10.19"></a><span id="l10.19"> class AppleDoubleEncodeObject</span>
<a href="#l10.20"></a><span id="l10.20"> {</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineat">@@ -57,24 +56,22 @@ namespace mailnews {</span>
<a href="#l10.22"></a><span id="l10.22"> class MimeEncoder;</span>
<a href="#l10.23"></a><span id="l10.23"> }</span>
<a href="#l10.24"></a><span id="l10.24"> }</span>
<a href="#l10.25"></a><span id="l10.25"> </span>
<a href="#l10.26"></a><span id="l10.26"> //</span>
<a href="#l10.27"></a><span id="l10.27"> // This is a class that deals with processing remote attachments. It implements</span>
<a href="#l10.28"></a><span id="l10.28"> // an nsIStreamListener interface to deal with incoming data</span>
<a href="#l10.29"></a><span id="l10.29"> //</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineminus">-class nsMsgAttachmentHandler : public nsIMsgAttachmentHandler</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineplus">+class nsMsgAttachmentHandler</span>
<a href="#l10.32"></a><span id="l10.32"> {</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineplus">+  NS_INLINE_DECL_THREADSAFE_REFCOUNTING(nsMsgAttachmentHandler)</span>
<a href="#l10.34"></a><span id="l10.34"> </span>
<a href="#l10.35"></a><span id="l10.35">   typedef mozilla::mailnews::MimeEncoder MimeEncoder;</span>
<a href="#l10.36"></a><span id="l10.36"> public:</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineminus">-  NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineminus">-  NS_DECL_NSIMSGATTACHMENTHANDLER</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineminus">-</span>
<a href="#l10.40"></a><span id="l10.40">   nsMsgAttachmentHandler();</span>
<a href="#l10.41"></a><span id="l10.41"> public:</span>
<a href="#l10.42"></a><span id="l10.42">   nsresult              SnarfAttachment(nsMsgCompFields *compFields);</span>
<a href="#l10.43"></a><span id="l10.43">   nsresult              PickEncoding(const char *charset, nsIMsgSend* mime_delivery_state);</span>
<a href="#l10.44"></a><span id="l10.44">   nsresult              PickCharset();</span>
<a href="#l10.45"></a><span id="l10.45">   void                  AnalyzeSnarfedFile ();      // Analyze a previously-snarfed file.</span>
<a href="#l10.46"></a><span id="l10.46">                                                     // (Currently only used for plaintext</span>
<a href="#l10.47"></a><span id="l10.47">                                                     // converted from HTML.) </span>
<a href="#l10.48"></a><span id="l10.48" class="difflineat">@@ -83,17 +80,17 @@ public:</span>
<a href="#l10.49"></a><span id="l10.49">   </span>
<a href="#l10.50"></a><span id="l10.50">   // if there's an intermediate temp file left, takes care to remove it from disk.</span>
<a href="#l10.51"></a><span id="l10.51">   //</span>
<a href="#l10.52"></a><span id="l10.52">   // NOTE: this takes care of the mEncodedWorkingFile temp file, but not mTmpFile which seems</span>
<a href="#l10.53"></a><span id="l10.53">   // to be used by lots of other classes at the moment.</span>
<a href="#l10.54"></a><span id="l10.54">   void                  CleanupTempFile();</span>
<a href="#l10.55"></a><span id="l10.55"> </span>
<a href="#l10.56"></a><span id="l10.56"> private:</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineminus">-  virtual ~nsMsgAttachmentHandler();</span>
<a href="#l10.58"></a><span id="l10.58" class="difflineplus">+  ~nsMsgAttachmentHandler();</span>
<a href="#l10.59"></a><span id="l10.59"> </span>
<a href="#l10.60"></a><span id="l10.60">   // use when a message (e.g. original message in a reply) is attached as a rfc822 attachment.</span>
<a href="#l10.61"></a><span id="l10.61">   nsresult              SnarfMsgAttachment(nsMsgCompFields *compFields);</span>
<a href="#l10.62"></a><span id="l10.62">   bool                  UseUUEncode_p(void);</span>
<a href="#l10.63"></a><span id="l10.63">   void                  AnalyzeDataChunk (const char *chunk, int32_t chunkSize);</span>
<a href="#l10.64"></a><span id="l10.64">   nsresult              LoadDataFromFile(nsIFile *file, nsString &amp;sigData, bool charsetConversion); //A similar function already exist in nsMsgCompose!</span>
<a href="#l10.65"></a><span id="l10.65"> #ifdef XP_MACOSX</span>
<a href="#l10.66"></a><span id="l10.66">   nsresult              ConvertToAppleEncoding(const nsCString &amp;aFileSpecURI, </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgCompose.cpp</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgCompose.cpp</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -73,17 +73,16 @@</span>
<a href="#l11.4"></a><span id="l11.4"> #include &quot;nsIMsgWindow.h&quot;</span>
<a href="#l11.5"></a><span id="l11.5"> #include &quot;nsITextToSubURI.h&quot;</span>
<a href="#l11.6"></a><span id="l11.6"> #include &quot;nsIAbManager.h&quot;</span>
<a href="#l11.7"></a><span id="l11.7"> #include &quot;nsCRT.h&quot;</span>
<a href="#l11.8"></a><span id="l11.8"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l11.9"></a><span id="l11.9"> #include &quot;mozilla/mailnews/MimeHeaderParser.h&quot;</span>
<a href="#l11.10"></a><span id="l11.10"> #include &quot;nsISelection.h&quot;</span>
<a href="#l11.11"></a><span id="l11.11"> #include &quot;nsJSEnvironment.h&quot;</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-#include &quot;nsIObserverService.h&quot;</span>
<a href="#l11.13"></a><span id="l11.13"> </span>
<a href="#l11.14"></a><span id="l11.14"> using namespace mozilla::mailnews;</span>
<a href="#l11.15"></a><span id="l11.15"> </span>
<a href="#l11.16"></a><span id="l11.16"> static nsresult GetReplyHeaderInfo(int32_t* reply_header_type,</span>
<a href="#l11.17"></a><span id="l11.17">                                    nsString&amp; reply_header_locale,</span>
<a href="#l11.18"></a><span id="l11.18">                                    nsString&amp; reply_header_authorwrote,</span>
<a href="#l11.19"></a><span id="l11.19">                                    nsString&amp; reply_header_ondateauthorwrote,</span>
<a href="#l11.20"></a><span id="l11.20">                                    nsString&amp; reply_header_authorwroteondate,</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineat">@@ -1034,19 +1033,18 @@ NS_IMETHODIMP nsMsgCompose::AddMsgSendLi</span>
<a href="#l11.22"></a><span id="l11.22"> }</span>
<a href="#l11.23"></a><span id="l11.23"> </span>
<a href="#l11.24"></a><span id="l11.24"> NS_IMETHODIMP nsMsgCompose::RemoveMsgSendListener( nsIMsgSendListener *aMsgSendListener )</span>
<a href="#l11.25"></a><span id="l11.25"> {</span>
<a href="#l11.26"></a><span id="l11.26">   NS_ENSURE_ARG_POINTER(aMsgSendListener);</span>
<a href="#l11.27"></a><span id="l11.27">   return mExternalSendListeners.RemoveElement(aMsgSendListener) ? NS_OK : NS_ERROR_FAILURE;</span>
<a href="#l11.28"></a><span id="l11.28"> }</span>
<a href="#l11.29"></a><span id="l11.29"> </span>
<a href="#l11.30"></a><span id="l11.30" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineminus">-nsMsgCompose::SendMsgToServer(MSG_DeliverMode deliverMode, nsIMsgIdentity *identity,</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineminus">-                              const char *accountKey)</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineplus">+nsresult nsMsgCompose::_SendMsg(MSG_DeliverMode deliverMode, nsIMsgIdentity *identity,</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineplus">+                                const char *accountKey)</span>
<a href="#l11.35"></a><span id="l11.35"> {</span>
<a href="#l11.36"></a><span id="l11.36">   nsresult rv = NS_OK;</span>
<a href="#l11.37"></a><span id="l11.37"> </span>
<a href="#l11.38"></a><span id="l11.38">   // clear saved message id if sending, so we don't send out the same message-id.</span>
<a href="#l11.39"></a><span id="l11.39">   if (deliverMode == nsIMsgCompDeliverMode::Now ||</span>
<a href="#l11.40"></a><span id="l11.40">       deliverMode == nsIMsgCompDeliverMode::Later ||</span>
<a href="#l11.41"></a><span id="l11.41">       deliverMode == nsIMsgCompDeliverMode::Background)</span>
<a href="#l11.42"></a><span id="l11.42">     m_compFields-&gt;SetMessageId(&quot;&quot;);</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineat">@@ -1066,34 +1064,17 @@ nsMsgCompose::SendMsgToServer(MSG_Delive</span>
<a href="#l11.44"></a><span id="l11.44">     if (!pFrom || !*pFrom)</span>
<a href="#l11.45"></a><span id="l11.45">     {</span>
<a href="#l11.46"></a><span id="l11.46">       nsCString sender;</span>
<a href="#l11.47"></a><span id="l11.47">       MakeMimeAddress(NS_ConvertUTF16toUTF8(fullName), email, sender);</span>
<a href="#l11.48"></a><span id="l11.48">       m_compFields-&gt;SetFrom(sender.IsEmpty() ? email.get() : sender.get());</span>
<a href="#l11.49"></a><span id="l11.49">     }</span>
<a href="#l11.50"></a><span id="l11.50"> </span>
<a href="#l11.51"></a><span id="l11.51">     m_compFields-&gt;SetOrganization(organization);</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineminus">-</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineminus">-    // We need an nsIMsgSend instance to send the message. Allow extensions</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineminus">-    // to override the default SMTP sender by observing mail-set-sender.</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineminus">-    mMsgSend = nullptr;</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineminus">-    mDeliverMode = deliverMode;  // save for possible access by observer;</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineminus">-</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineminus">-    nsCOMPtr&lt;nsIObserverService&gt; observerService =</span>
<a href="#l11.59"></a><span id="l11.59" class="difflineminus">-      mozilla::services::GetObserverService();</span>
<a href="#l11.60"></a><span id="l11.60" class="difflineminus">-    if (observerService)</span>
<a href="#l11.61"></a><span id="l11.61" class="difflineminus">-    {</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineminus">-      observerService-&gt;NotifyObservers(</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineminus">-        NS_ISUPPORTS_CAST(nsIMsgCompose*, this),</span>
<a href="#l11.64"></a><span id="l11.64" class="difflineminus">-        &quot;mail-set-sender&quot;,</span>
<a href="#l11.65"></a><span id="l11.65" class="difflineminus">-        NS_ConvertUTF8toUTF16(nsDependentCString(accountKey)).get());</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineminus">-    }</span>
<a href="#l11.67"></a><span id="l11.67" class="difflineminus">-    if (!mMsgSend)</span>
<a href="#l11.68"></a><span id="l11.68" class="difflineminus">-      mMsgSend = do_CreateInstance(NS_MSGSEND_CONTRACTID);</span>
<a href="#l11.69"></a><span id="l11.69" class="difflineminus">-</span>
<a href="#l11.70"></a><span id="l11.70" class="difflineplus">+    mMsgSend = do_CreateInstance(NS_MSGSEND_CONTRACTID);</span>
<a href="#l11.71"></a><span id="l11.71">     if (mMsgSend)</span>
<a href="#l11.72"></a><span id="l11.72">     {</span>
<a href="#l11.73"></a><span id="l11.73">       nsCString bodyString(m_compFields-&gt;GetBody());</span>
<a href="#l11.74"></a><span id="l11.74"> </span>
<a href="#l11.75"></a><span id="l11.75">       // Create the listener for the send operation...</span>
<a href="#l11.76"></a><span id="l11.76">       nsCOMPtr&lt;nsIMsgComposeSendListener&gt; composeSendListener = do_CreateInstance(NS_MSGCOMPOSESENDLISTENER_CONTRACTID);</span>
<a href="#l11.77"></a><span id="l11.77">       if (!composeSendListener)</span>
<a href="#l11.78"></a><span id="l11.78">         return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l11.79"></a><span id="l11.79" class="difflineat">@@ -1334,17 +1315,17 @@ NS_IMETHODIMP nsMsgCompose::SendMsg(MSG_</span>
<a href="#l11.80"></a><span id="l11.80">               m_compFields-&gt;AddAttachment(attachment);</span>
<a href="#l11.81"></a><span id="l11.81">           }</span>
<a href="#l11.82"></a><span id="l11.82">       }</span>
<a href="#l11.83"></a><span id="l11.83">   }</span>
<a href="#l11.84"></a><span id="l11.84"> </span>
<a href="#l11.85"></a><span id="l11.85">   // Save the identity being sent for later use.</span>
<a href="#l11.86"></a><span id="l11.86">   m_identity = identity;</span>
<a href="#l11.87"></a><span id="l11.87"> </span>
<a href="#l11.88"></a><span id="l11.88" class="difflineminus">-  rv = SendMsgToServer(deliverMode, identity, accountKey);</span>
<a href="#l11.89"></a><span id="l11.89" class="difflineplus">+  rv = _SendMsg(deliverMode, identity, accountKey);</span>
<a href="#l11.90"></a><span id="l11.90">   if (NS_FAILED(rv))</span>
<a href="#l11.91"></a><span id="l11.91">   {</span>
<a href="#l11.92"></a><span id="l11.92">     nsCOMPtr&lt;nsIMsgSendReport&gt; sendReport;</span>
<a href="#l11.93"></a><span id="l11.93">     if (mMsgSend)</span>
<a href="#l11.94"></a><span id="l11.94">       mMsgSend-&gt;GetSendReport(getter_AddRefs(sendReport));</span>
<a href="#l11.95"></a><span id="l11.95">     if (sendReport)</span>
<a href="#l11.96"></a><span id="l11.96">     {</span>
<a href="#l11.97"></a><span id="l11.97">       nsresult theError;</span>
<a href="#l11.98"></a><span id="l11.98" class="difflineat">@@ -1581,22 +1562,16 @@ NS_IMETHODIMP nsMsgCompose::InitEditor(n</span>
<a href="#l11.99"></a><span id="l11.99">   {</span>
<a href="#l11.100"></a><span id="l11.100">     NotifyStateListeners(nsIMsgComposeNotificationType::ComposeFieldsReady, NS_OK);</span>
<a href="#l11.101"></a><span id="l11.101">     nsresult rv = BuildBodyMessageAndSignature();</span>
<a href="#l11.102"></a><span id="l11.102">     NotifyStateListeners(nsIMsgComposeNotificationType::ComposeBodyReady, NS_OK);</span>
<a href="#l11.103"></a><span id="l11.103">     return rv;</span>
<a href="#l11.104"></a><span id="l11.104">   }</span>
<a href="#l11.105"></a><span id="l11.105"> }</span>
<a href="#l11.106"></a><span id="l11.106"> </span>
<a href="#l11.107"></a><span id="l11.107" class="difflineminus">-NS_IMETHODIMP nsMsgCompose::GetBodyRaw(nsACString&amp; aBodyRaw)</span>
<a href="#l11.108"></a><span id="l11.108" class="difflineminus">-{</span>
<a href="#l11.109"></a><span id="l11.109" class="difflineminus">-  aBodyRaw.Assign((char *)m_compFields-&gt;GetBody());</span>
<a href="#l11.110"></a><span id="l11.110" class="difflineminus">-  return NS_OK;</span>
<a href="#l11.111"></a><span id="l11.111" class="difflineminus">-}</span>
<a href="#l11.112"></a><span id="l11.112" class="difflineminus">-</span>
<a href="#l11.113"></a><span id="l11.113"> nsresult nsMsgCompose::GetBodyModified(bool * modified)</span>
<a href="#l11.114"></a><span id="l11.114"> {</span>
<a href="#l11.115"></a><span id="l11.115">   nsresult rv;</span>
<a href="#l11.116"></a><span id="l11.116"> </span>
<a href="#l11.117"></a><span id="l11.117">   if (! modified)</span>
<a href="#l11.118"></a><span id="l11.118">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l11.119"></a><span id="l11.119"> </span>
<a href="#l11.120"></a><span id="l11.120">   *modified = true;</span>
<a href="#l11.121"></a><span id="l11.121" class="difflineat">@@ -2135,22 +2110,16 @@ NS_IMETHODIMP nsMsgCompose::GetProgress(</span>
<a href="#l11.122"></a><span id="l11.122"> NS_IMETHODIMP nsMsgCompose::GetMessageSend(nsIMsgSend **_retval)</span>
<a href="#l11.123"></a><span id="l11.123"> {</span>
<a href="#l11.124"></a><span id="l11.124">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l11.125"></a><span id="l11.125">   *_retval = mMsgSend;</span>
<a href="#l11.126"></a><span id="l11.126">   NS_IF_ADDREF(*_retval);</span>
<a href="#l11.127"></a><span id="l11.127">   return NS_OK;</span>
<a href="#l11.128"></a><span id="l11.128"> }</span>
<a href="#l11.129"></a><span id="l11.129"> </span>
<a href="#l11.130"></a><span id="l11.130" class="difflineminus">-NS_IMETHODIMP nsMsgCompose::SetMessageSend(nsIMsgSend* aMsgSend)</span>
<a href="#l11.131"></a><span id="l11.131" class="difflineminus">-{</span>
<a href="#l11.132"></a><span id="l11.132" class="difflineminus">-  mMsgSend = aMsgSend;</span>
<a href="#l11.133"></a><span id="l11.133" class="difflineminus">-  return NS_OK;</span>
<a href="#l11.134"></a><span id="l11.134" class="difflineminus">-}</span>
<a href="#l11.135"></a><span id="l11.135" class="difflineminus">-</span>
<a href="#l11.136"></a><span id="l11.136"> NS_IMETHODIMP nsMsgCompose::ClearMessageSend()</span>
<a href="#l11.137"></a><span id="l11.137"> {</span>
<a href="#l11.138"></a><span id="l11.138">   mMsgSend = nullptr;</span>
<a href="#l11.139"></a><span id="l11.139">   return NS_OK;</span>
<a href="#l11.140"></a><span id="l11.140"> }</span>
<a href="#l11.141"></a><span id="l11.141"> </span>
<a href="#l11.142"></a><span id="l11.142"> NS_IMETHODIMP nsMsgCompose::SetCiteReference(nsString citeReference)</span>
<a href="#l11.143"></a><span id="l11.143"> {</span>
<a href="#l11.144"></a><span id="l11.144" class="difflineat">@@ -5500,23 +5469,16 @@ NS_IMETHODIMP nsMsgCompose::CheckCharset</span>
<a href="#l11.145"></a><span id="l11.145">   // headers can be converted to the appropriate charset, but we don't support</span>
<a href="#l11.146"></a><span id="l11.146">   // encoding headers to non-UTF-8, so this is now moot.</span>
<a href="#l11.147"></a><span id="l11.147">   if (fallbackCharset)</span>
<a href="#l11.148"></a><span id="l11.148">     *fallbackCharset = nullptr;</span>
<a href="#l11.149"></a><span id="l11.149">   *_retval = true;</span>
<a href="#l11.150"></a><span id="l11.150">   return NS_OK;</span>
<a href="#l11.151"></a><span id="l11.151"> }</span>
<a href="#l11.152"></a><span id="l11.152"> </span>
<a href="#l11.153"></a><span id="l11.153" class="difflineminus">-NS_IMETHODIMP nsMsgCompose::GetDeliverMode(MSG_DeliverMode* aDeliverMode)</span>
<a href="#l11.154"></a><span id="l11.154" class="difflineminus">-{</span>
<a href="#l11.155"></a><span id="l11.155" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aDeliverMode);</span>
<a href="#l11.156"></a><span id="l11.156" class="difflineminus">-  *aDeliverMode = mDeliverMode;</span>
<a href="#l11.157"></a><span id="l11.157" class="difflineminus">-  return NS_OK;</span>
<a href="#l11.158"></a><span id="l11.158" class="difflineminus">-}</span>
<a href="#l11.159"></a><span id="l11.159" class="difflineminus">-</span>
<a href="#l11.160"></a><span id="l11.160"> nsMsgMailList::nsMsgMailList(nsIAbDirectory* directory) :</span>
<a href="#l11.161"></a><span id="l11.161">   mDirectory(directory)</span>
<a href="#l11.162"></a><span id="l11.162"> {</span>
<a href="#l11.163"></a><span id="l11.163">   mDirectory-&gt;GetDirName(mName);</span>
<a href="#l11.164"></a><span id="l11.164">   mDirectory-&gt;GetDescription(mDescription);</span>
<a href="#l11.165"></a><span id="l11.165"> </span>
<a href="#l11.166"></a><span id="l11.166">   if (mDescription.IsEmpty())</span>
<a href="#l11.167"></a><span id="l11.167">     mDescription = mName;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgCompose.h</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgCompose.h</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -40,17 +40,17 @@ class nsMsgCompose : public nsIMsgCompos</span>
<a href="#l12.4"></a><span id="l12.4"> 	NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l12.5"></a><span id="l12.5"> </span>
<a href="#l12.6"></a><span id="l12.6"> 	/*** nsIMsgCompose pure virtual functions */</span>
<a href="#l12.7"></a><span id="l12.7"> 	NS_DECL_NSIMSGCOMPOSE</span>
<a href="#l12.8"></a><span id="l12.8"> </span>
<a href="#l12.9"></a><span id="l12.9">   /* nsIMsgSendListener interface */</span>
<a href="#l12.10"></a><span id="l12.10">   NS_DECL_NSIMSGSENDLISTENER</span>
<a href="#l12.11"></a><span id="l12.11"> </span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-protected:</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+private:</span>
<a href="#l12.14"></a><span id="l12.14"> 	virtual ~nsMsgCompose();</span>
<a href="#l12.15"></a><span id="l12.15"> </span>
<a href="#l12.16"></a><span id="l12.16">  // Deal with quoting issues...</span>
<a href="#l12.17"></a><span id="l12.17"> 	nsresult                      QuoteOriginalMessage(); // New template</span>
<a href="#l12.18"></a><span id="l12.18">   nsresult                      SetQuotingToFollow(bool aVal);</span>
<a href="#l12.19"></a><span id="l12.19">   nsresult                      ConvertHTMLToText(nsIFile *aSigFile, nsString &amp;aSigData);</span>
<a href="#l12.20"></a><span id="l12.20">   nsresult                      ConvertTextToHTML(nsIFile *aSigFile, nsString &amp;aSigData);</span>
<a href="#l12.21"></a><span id="l12.21">   bool                          IsEmbeddedObjectSafe(const char * originalScheme,</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineat">@@ -71,17 +71,18 @@ protected:</span>
<a href="#l12.23"></a><span id="l12.23">                                                  bool aAllowUTF16 = true);</span>
<a href="#l12.24"></a><span id="l12.24"> </span>
<a href="#l12.25"></a><span id="l12.25">   bool                          CheckIncludeSignaturePrefs(nsIMsgIdentity *identity);</span>
<a href="#l12.26"></a><span id="l12.26">   //m_folderName to store the value of the saved drafts folder.</span>
<a href="#l12.27"></a><span id="l12.27">   nsCString                     m_folderName;</span>
<a href="#l12.28"></a><span id="l12.28">   void InsertDivWrappedTextAtSelection(const nsAString &amp;aText,</span>
<a href="#l12.29"></a><span id="l12.29">                                        const nsAString &amp;classStr);</span>
<a href="#l12.30"></a><span id="l12.30"> </span>
<a href="#l12.31"></a><span id="l12.31" class="difflineminus">- protected:</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineplus">+ private:</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineplus">+  nsresult _SendMsg(MSG_DeliverMode deliverMode, nsIMsgIdentity *identity, const char *accountKey);</span>
<a href="#l12.34"></a><span id="l12.34">   nsresult CreateMessage(const char * originalMsgURI, MSG_ComposeType type, nsIMsgCompFields* compFields);</span>
<a href="#l12.35"></a><span id="l12.35">   void CleanUpRecipients(nsString&amp; recipients);</span>
<a href="#l12.36"></a><span id="l12.36">   nsresult GetABDirectories(const nsACString&amp; aDirUri,</span>
<a href="#l12.37"></a><span id="l12.37">                             nsCOMArray&lt;nsIAbDirectory&gt; &amp;aDirArray);</span>
<a href="#l12.38"></a><span id="l12.38">   nsresult BuildMailListArray(nsIAbDirectory* parentDir,</span>
<a href="#l12.39"></a><span id="l12.39">                               nsTArray&lt;nsMsgMailList&gt;&amp; array);</span>
<a href="#l12.40"></a><span id="l12.40">   nsresult TagConvertible(nsIDOMNode *node,  int32_t *_retval);</span>
<a href="#l12.41"></a><span id="l12.41">   nsresult _BodyConvertible(nsIDOMNode *node, int32_t *_retval);</span>
<a href="#l12.42"></a><span id="l12.42" class="difflineat">@@ -126,18 +127,17 @@ protected:</span>
<a href="#l12.43"></a><span id="l12.43"> </span>
<a href="#l12.44"></a><span id="l12.44">   nsCString                                 mSmtpPassword;</span>
<a href="#l12.45"></a><span id="l12.45">   nsCString                                 mHtmlToQuote;</span>
<a href="#l12.46"></a><span id="l12.46"> </span>
<a href="#l12.47"></a><span id="l12.47">   nsTObserverArray&lt;nsCOMPtr&lt;nsIMsgComposeStateListener&gt; &gt; mStateListeners;</span>
<a href="#l12.48"></a><span id="l12.48">   nsTObserverArray&lt;nsCOMPtr&lt;nsIMsgSendListener&gt; &gt; mExternalSendListeners;</span>
<a href="#l12.49"></a><span id="l12.49">     </span>
<a href="#l12.50"></a><span id="l12.50">   bool                                      mInsertingQuotedContent;</span>
<a href="#l12.51"></a><span id="l12.51" class="difflineminus">-  MSG_DeliverMode                           mDeliverMode;  // nsIMsgCompDeliverMode long.</span>
<a href="#l12.52"></a><span id="l12.52" class="difflineminus">-</span>
<a href="#l12.53"></a><span id="l12.53" class="difflineplus">+    </span>
<a href="#l12.54"></a><span id="l12.54">   friend class QuotingOutputStreamListener;</span>
<a href="#l12.55"></a><span id="l12.55"> 	friend class nsMsgComposeSendListener;</span>
<a href="#l12.56"></a><span id="l12.56"> };</span>
<a href="#l12.57"></a><span id="l12.57"> </span>
<a href="#l12.58"></a><span id="l12.58"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l12.59"></a><span id="l12.59"> // THIS IS THE CLASS THAT IS THE STREAM Listener OF THE HTML OUPUT</span>
<a href="#l12.60"></a><span id="l12.60"> // FROM LIBMIME. THIS IS FOR QUOTING</span>
<a href="#l12.61"></a><span id="l12.61"> ////////////////////////////////////////////////////////////////////////////////////</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgSend.cpp</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgSend.cpp</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -74,17 +74,16 @@</span>
<a href="#l13.4"></a><span id="l13.4"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l13.5"></a><span id="l13.5"> #include &quot;nsIArray.h&quot;</span>
<a href="#l13.6"></a><span id="l13.6"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l13.7"></a><span id="l13.7"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l13.8"></a><span id="l13.8"> #include &quot;mozilla/mailnews/MimeEncoder.h&quot;</span>
<a href="#l13.9"></a><span id="l13.9"> #include &quot;mozilla/mailnews/MimeHeaderParser.h&quot;</span>
<a href="#l13.10"></a><span id="l13.10"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l13.11"></a><span id="l13.11"> #include &quot;nsIMsgFilterService.h&quot;</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-#include &quot;nsIMsgProtocolInfo.h&quot;</span>
<a href="#l13.13"></a><span id="l13.13"> </span>
<a href="#l13.14"></a><span id="l13.14"> using namespace mozilla::mailnews;</span>
<a href="#l13.15"></a><span id="l13.15"> </span>
<a href="#l13.16"></a><span id="l13.16"> static NS_DEFINE_CID(kRDFServiceCID, NS_RDFSERVICE_CID);</span>
<a href="#l13.17"></a><span id="l13.17"> </span>
<a href="#l13.18"></a><span id="l13.18"> #define PREF_MAIL_SEND_STRUCT &quot;mail.send_struct&quot;</span>
<a href="#l13.19"></a><span id="l13.19"> #define PREF_MAIL_STRICTLY_MIME &quot;mail.strictly_mime&quot;</span>
<a href="#l13.20"></a><span id="l13.20"> #define PREF_MAIL_MESSAGE_WARNING_SIZE &quot;mailnews.message_warning_size&quot;</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineat">@@ -199,20 +198,20 @@ static nsresult StripOutGroupNames(char </span>
<a href="#l13.22"></a><span id="l13.22"> </span>
<a href="#l13.23"></a><span id="l13.23"> </span>
<a href="#l13.24"></a><span id="l13.24"> // This private class just provides us an external URL listener, with callback functionality.</span>
<a href="#l13.25"></a><span id="l13.25"> </span>
<a href="#l13.26"></a><span id="l13.26"> class MsgDeliveryListener : public nsIUrlListener</span>
<a href="#l13.27"></a><span id="l13.27"> {</span>
<a href="#l13.28"></a><span id="l13.28"> public:</span>
<a href="#l13.29"></a><span id="l13.29">   MsgDeliveryListener(nsIMsgSend *aMsgSend, bool inIsNewsDelivery);</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineminus">-</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineplus">+  </span>
<a href="#l13.32"></a><span id="l13.32">   NS_DECL_ISUPPORTS</span>
<a href="#l13.33"></a><span id="l13.33">   NS_DECL_NSIURLLISTENER</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineminus">-</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineplus">+    </span>
<a href="#l13.36"></a><span id="l13.36"> private:</span>
<a href="#l13.37"></a><span id="l13.37">   virtual ~MsgDeliveryListener();</span>
<a href="#l13.38"></a><span id="l13.38">   nsCOMPtr&lt;nsIMsgSend&gt; mMsgSend;</span>
<a href="#l13.39"></a><span id="l13.39">   bool                 mIsNewsDelivery;</span>
<a href="#l13.40"></a><span id="l13.40"> };</span>
<a href="#l13.41"></a><span id="l13.41"> </span>
<a href="#l13.42"></a><span id="l13.42"> NS_IMPL_ISUPPORTS(MsgDeliveryListener, nsIUrlListener)</span>
<a href="#l13.43"></a><span id="l13.43"> </span>
<a href="#l13.44"></a><span id="l13.44" class="difflineat">@@ -225,41 +224,40 @@ MsgDeliveryListener::MsgDeliveryListener</span>
<a href="#l13.45"></a><span id="l13.45"> MsgDeliveryListener::~MsgDeliveryListener()</span>
<a href="#l13.46"></a><span id="l13.46"> {</span>
<a href="#l13.47"></a><span id="l13.47"> }</span>
<a href="#l13.48"></a><span id="l13.48"> </span>
<a href="#l13.49"></a><span id="l13.49"> NS_IMETHODIMP MsgDeliveryListener::OnStartRunningUrl(nsIURI *url)</span>
<a href="#l13.50"></a><span id="l13.50"> {</span>
<a href="#l13.51"></a><span id="l13.51">   if (mMsgSend)</span>
<a href="#l13.52"></a><span id="l13.52">     mMsgSend-&gt;NotifyListenerOnStartSending(nullptr, 0);</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineminus">-</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineplus">+  </span>
<a href="#l13.55"></a><span id="l13.55">   return NS_OK;</span>
<a href="#l13.56"></a><span id="l13.56"> }</span>
<a href="#l13.57"></a><span id="l13.57"> </span>
<a href="#l13.58"></a><span id="l13.58"> NS_IMETHODIMP MsgDeliveryListener::OnStopRunningUrl(nsIURI *url, nsresult aExitCode)</span>
<a href="#l13.59"></a><span id="l13.59" class="difflineminus">-{</span>
<a href="#l13.60"></a><span id="l13.60" class="difflineplus">+{  </span>
<a href="#l13.61"></a><span id="l13.61">   if (url)</span>
<a href="#l13.62"></a><span id="l13.62">   {</span>
<a href="#l13.63"></a><span id="l13.63">     nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailUrl = do_QueryInterface(url);</span>
<a href="#l13.64"></a><span id="l13.64">     if (mailUrl)</span>
<a href="#l13.65"></a><span id="l13.65">       mailUrl-&gt;UnRegisterListener(this);</span>
<a href="#l13.66"></a><span id="l13.66">   }</span>
<a href="#l13.67"></a><span id="l13.67"> </span>
<a href="#l13.68"></a><span id="l13.68">   // Let mMsgSend sort out the OnStopSending notification - it knows more about</span>
<a href="#l13.69"></a><span id="l13.69">   // the messages than we do.</span>
<a href="#l13.70"></a><span id="l13.70">   if (mMsgSend)</span>
<a href="#l13.71"></a><span id="l13.71">     mMsgSend-&gt;SendDeliveryCallback(url, mIsNewsDelivery, aExitCode);</span>
<a href="#l13.72"></a><span id="l13.72" class="difflineminus">-</span>
<a href="#l13.73"></a><span id="l13.73" class="difflineplus">+      </span>
<a href="#l13.74"></a><span id="l13.74">   return NS_OK;</span>
<a href="#l13.75"></a><span id="l13.75"> }</span>
<a href="#l13.76"></a><span id="l13.76"> </span>
<a href="#l13.77"></a><span id="l13.77"> </span>
<a href="#l13.78"></a><span id="l13.78"> /* the following macro actually implement addref, release and query interface for our component. */</span>
<a href="#l13.79"></a><span id="l13.79" class="difflineminus">-NS_IMPL_ISUPPORTS(nsMsgComposeAndSend, nsIMsgSend, nsIMsgOperationListener,</span>
<a href="#l13.80"></a><span id="l13.80" class="difflineminus">-                  nsISupportsWeakReference)</span>
<a href="#l13.81"></a><span id="l13.81" class="difflineplus">+NS_IMPL_ISUPPORTS(nsMsgComposeAndSend, nsIMsgSend, nsIMsgOperationListener)</span>
<a href="#l13.82"></a><span id="l13.82"> </span>
<a href="#l13.83"></a><span id="l13.83"> nsMsgComposeAndSend::nsMsgComposeAndSend() :</span>
<a href="#l13.84"></a><span id="l13.84">     m_messageKey(nsMsgKey_None)</span>
<a href="#l13.85"></a><span id="l13.85"> {</span>
<a href="#l13.86"></a><span id="l13.86">   mGUINotificationEnabled = true;</span>
<a href="#l13.87"></a><span id="l13.87">   mAbortInProcess = false;</span>
<a href="#l13.88"></a><span id="l13.88">   mMultipartRelatedAttachmentCount = -1;</span>
<a href="#l13.89"></a><span id="l13.89">   mSendMailAlso = false;</span>
<a href="#l13.90"></a><span id="l13.90" class="difflineat">@@ -1787,39 +1785,21 @@ nsMsgComposeAndSend::ProcessMultipartRel</span>
<a href="#l13.91"></a><span id="l13.91">       // Start counting the attachments which are going to come from mail folders</span>
<a href="#l13.92"></a><span id="l13.92">       // and from NNTP servers.</span>
<a href="#l13.93"></a><span id="l13.93">       //</span>
<a href="#l13.94"></a><span id="l13.94">       if (m_attachments[i]-&gt;mURL)</span>
<a href="#l13.95"></a><span id="l13.95">       {</span>
<a href="#l13.96"></a><span id="l13.96">         nsIURI *uri = m_attachments[i]-&gt;mURL;</span>
<a href="#l13.97"></a><span id="l13.97">         bool match = false;</span>
<a href="#l13.98"></a><span id="l13.98">         if ((NS_SUCCEEDED(uri-&gt;SchemeIs(&quot;mailbox&quot;, &amp;match)) &amp;&amp; match) ||</span>
<a href="#l13.99"></a><span id="l13.99" class="difflineminus">-            (NS_SUCCEEDED(uri-&gt;SchemeIs(&quot;imap&quot;, &amp;match)) &amp;&amp; match))</span>
<a href="#l13.100"></a><span id="l13.100" class="difflineplus">+           (NS_SUCCEEDED(uri-&gt;SchemeIs(&quot;imap&quot;, &amp;match)) &amp;&amp; match))</span>
<a href="#l13.101"></a><span id="l13.101">           (*aMailboxCount)++;</span>
<a href="#l13.102"></a><span id="l13.102">         else if ((NS_SUCCEEDED(uri-&gt;SchemeIs(&quot;news&quot;, &amp;match)) &amp;&amp; match) ||</span>
<a href="#l13.103"></a><span id="l13.103" class="difflineminus">-                 (NS_SUCCEEDED(uri-&gt;SchemeIs(&quot;snews&quot;, &amp;match)) &amp;&amp; match))</span>
<a href="#l13.104"></a><span id="l13.104" class="difflineplus">+                (NS_SUCCEEDED(uri-&gt;SchemeIs(&quot;snews&quot;, &amp;match)) &amp;&amp; match))</span>
<a href="#l13.105"></a><span id="l13.105">           (*aNewsCount)++;</span>
<a href="#l13.106"></a><span id="l13.106" class="difflineminus">-        else</span>
<a href="#l13.107"></a><span id="l13.107" class="difflineminus">-        {</span>
<a href="#l13.108"></a><span id="l13.108" class="difflineminus">-          // Additional account types need a mechanism to report that they are</span>
<a href="#l13.109"></a><span id="l13.109" class="difflineminus">-          // message protocols. If there is an nsIMsgProtocolInfo component</span>
<a href="#l13.110"></a><span id="l13.110" class="difflineminus">-          // registered for this scheme, we'll consider it a mailbox</span>
<a href="#l13.111"></a><span id="l13.111" class="difflineminus">-          // attachment.</span>
<a href="#l13.112"></a><span id="l13.112" class="difflineminus">-          nsAutoCString contractID;</span>
<a href="#l13.113"></a><span id="l13.113" class="difflineminus">-          contractID.Assign(</span>
<a href="#l13.114"></a><span id="l13.114" class="difflineminus">-            NS_LITERAL_CSTRING(&quot;@mozilla.org/messenger/protocol/info;1&quot;));</span>
<a href="#l13.115"></a><span id="l13.115" class="difflineminus">-          nsAutoCString scheme;</span>
<a href="#l13.116"></a><span id="l13.116" class="difflineminus">-          uri-&gt;GetScheme(scheme);</span>
<a href="#l13.117"></a><span id="l13.117" class="difflineminus">-          contractID.Append(scheme);</span>
<a href="#l13.118"></a><span id="l13.118" class="difflineminus">-          nsCOMPtr&lt;nsIMsgProtocolInfo&gt; msgProtocolInfo =</span>
<a href="#l13.119"></a><span id="l13.119" class="difflineminus">-            do_CreateInstance(contractID.get());</span>
<a href="#l13.120"></a><span id="l13.120" class="difflineminus">-          if (msgProtocolInfo)</span>
<a href="#l13.121"></a><span id="l13.121" class="difflineminus">-            (*aMailboxCount)++;</span>
<a href="#l13.122"></a><span id="l13.122" class="difflineminus">-        }</span>
<a href="#l13.123"></a><span id="l13.123" class="difflineminus">-</span>
<a href="#l13.124"></a><span id="l13.124">       }</span>
<a href="#l13.125"></a><span id="l13.125">     }</span>
<a href="#l13.126"></a><span id="l13.126">     else</span>
<a href="#l13.127"></a><span id="l13.127">     {</span>
<a href="#l13.128"></a><span id="l13.128">       m_attachments[i]-&gt;m_contentId = m_attachments[duplicateOf]-&gt;m_contentId;</span>
<a href="#l13.129"></a><span id="l13.129">       m_attachments[i]-&gt;SetMimeDeliveryState(nullptr);</span>
<a href="#l13.130"></a><span id="l13.130">     }</span>
<a href="#l13.131"></a><span id="l13.131"> </span>
<a href="#l13.132"></a><span id="l13.132" class="difflineat">@@ -2195,24 +2175,19 @@ nsMsgComposeAndSend::AddCompFieldRemoteA</span>
<a href="#l13.133"></a><span id="l13.133">     {</span>
<a href="#l13.134"></a><span id="l13.134">       attachment-&gt;GetUrl(url);</span>
<a href="#l13.135"></a><span id="l13.135">       if (!url.IsEmpty())</span>
<a href="#l13.136"></a><span id="l13.136">       {</span>
<a href="#l13.137"></a><span id="l13.137">         // Just look for files that are NOT local file attachments and do</span>
<a href="#l13.138"></a><span id="l13.138">         // the right thing.</span>
<a href="#l13.139"></a><span id="l13.139">         if (! nsMsgIsLocalFile(url.get()))</span>
<a href="#l13.140"></a><span id="l13.140">         {</span>
<a href="#l13.141"></a><span id="l13.141" class="difflineminus">-          // Check for message attachment, see nsMsgMailNewsUrl::GetIsMessageUri.</span>
<a href="#l13.142"></a><span id="l13.142" class="difflineminus">-          nsCOMPtr&lt;nsIURI&gt; nsiuri = do_CreateInstance(NS_STANDARDURL_CONTRACTID);</span>
<a href="#l13.143"></a><span id="l13.143" class="difflineminus">-          NS_ENSURE_STATE(nsiuri);</span>
<a href="#l13.144"></a><span id="l13.144" class="difflineminus">-          nsiuri-&gt;SetSpec(url);</span>
<a href="#l13.145"></a><span id="l13.145" class="difflineminus">-          nsAutoCString scheme;</span>
<a href="#l13.146"></a><span id="l13.146" class="difflineminus">-          nsiuri-&gt;GetScheme(scheme);</span>
<a href="#l13.147"></a><span id="l13.147" class="difflineminus">-          bool isAMessageAttachment =</span>
<a href="#l13.148"></a><span id="l13.148" class="difflineminus">-            StringEndsWith(scheme, NS_LITERAL_CSTRING(&quot;-message&quot;));</span>
<a href="#l13.149"></a><span id="l13.149" class="difflineplus">+          bool isAMessageAttachment = !PL_strncasecmp(url.get(), &quot;mailbox-message://&quot;, 18) ||</span>
<a href="#l13.150"></a><span id="l13.150" class="difflineplus">+              !PL_strncasecmp(url.get(), &quot;imap-message://&quot;, 15) ||</span>
<a href="#l13.151"></a><span id="l13.151" class="difflineplus">+              !PL_strncasecmp(url.get(), &quot;news-message://&quot;, 15);</span>
<a href="#l13.152"></a><span id="l13.152"> </span>
<a href="#l13.153"></a><span id="l13.153">           m_attachments[newLoc]-&gt;mDeleteFile = true;</span>
<a href="#l13.154"></a><span id="l13.154">           m_attachments[newLoc]-&gt;m_done = false;</span>
<a href="#l13.155"></a><span id="l13.155">           m_attachments[newLoc]-&gt;SetMimeDeliveryState(this);</span>
<a href="#l13.156"></a><span id="l13.156"> </span>
<a href="#l13.157"></a><span id="l13.157">           if (!isAMessageAttachment)</span>
<a href="#l13.158"></a><span id="l13.158">             nsMsgNewURL(getter_AddRefs(m_attachments[newLoc]-&gt;mURL), url.get());</span>
<a href="#l13.159"></a><span id="l13.159"> </span>
<a href="#l13.160"></a><span id="l13.160" class="difflineat">@@ -2430,45 +2405,29 @@ nsMsgComposeAndSend::HackAttachments(nsI</span>
<a href="#l13.161"></a><span id="l13.161">       attachment-&gt;GetXMacCreator(m_attachments[i]-&gt;m_xMacCreator);</span>
<a href="#l13.162"></a><span id="l13.162">       m_attachments[i]-&gt;m_encoding = ENCODING_7BIT;</span>
<a href="#l13.163"></a><span id="l13.163"> </span>
<a href="#l13.164"></a><span id="l13.164">       // real name is set in the case of vcard so don't change it.  XXX STILL NEEDED?</span>
<a href="#l13.165"></a><span id="l13.165">       // m_attachments[i]-&gt;m_real_name = 0;</span>
<a href="#l13.166"></a><span id="l13.166"> </span>
<a href="#l13.167"></a><span id="l13.167">       /* Count up attachments which are going to come from mail folders</span>
<a href="#l13.168"></a><span id="l13.168">       and from NNTP servers. */</span>
<a href="#l13.169"></a><span id="l13.169" class="difflineminus">-      if (m_attachments[i]-&gt;mURL)</span>
<a href="#l13.170"></a><span id="l13.170" class="difflineminus">-      {</span>
<a href="#l13.171"></a><span id="l13.171" class="difflineminus">-        nsIURI *uri = m_attachments[i]-&gt;mURL;</span>
<a href="#l13.172"></a><span id="l13.172" class="difflineminus">-        bool match = false;</span>
<a href="#l13.173"></a><span id="l13.173" class="difflineminus">-        if ((NS_SUCCEEDED(uri-&gt;SchemeIs(&quot;mailbox&quot;, &amp;match)) &amp;&amp; match) ||</span>
<a href="#l13.174"></a><span id="l13.174" class="difflineminus">-            (NS_SUCCEEDED(uri-&gt;SchemeIs(&quot;imap&quot;, &amp;match)) &amp;&amp; match))</span>
<a href="#l13.175"></a><span id="l13.175" class="difflineminus">-          mailbox_count++;</span>
<a href="#l13.176"></a><span id="l13.176" class="difflineminus">-        else if ((NS_SUCCEEDED(uri-&gt;SchemeIs(&quot;news&quot;, &amp;match)) &amp;&amp; match) ||</span>
<a href="#l13.177"></a><span id="l13.177" class="difflineminus">-                 (NS_SUCCEEDED(uri-&gt;SchemeIs(&quot;snews&quot;, &amp;match)) &amp;&amp; match))</span>
<a href="#l13.178"></a><span id="l13.178" class="difflineminus">-            news_count++;</span>
<a href="#l13.179"></a><span id="l13.179" class="difflineminus">-        else</span>
<a href="#l13.180"></a><span id="l13.180" class="difflineminus">-        {</span>
<a href="#l13.181"></a><span id="l13.181" class="difflineminus">-          // Additional account types need a mechanism to report that they are</span>
<a href="#l13.182"></a><span id="l13.182" class="difflineminus">-          // message protocols. If there is an nsIMsgProtocolInfo component</span>
<a href="#l13.183"></a><span id="l13.183" class="difflineminus">-          // registered for this scheme, we'll consider it a mailbox</span>
<a href="#l13.184"></a><span id="l13.184" class="difflineminus">-          // attachment.</span>
<a href="#l13.185"></a><span id="l13.185" class="difflineminus">-          nsAutoCString contractID;</span>
<a href="#l13.186"></a><span id="l13.186" class="difflineminus">-          contractID.Assign(</span>
<a href="#l13.187"></a><span id="l13.187" class="difflineminus">-            NS_LITERAL_CSTRING(&quot;@mozilla.org/messenger/protocol/info;1&quot;));</span>
<a href="#l13.188"></a><span id="l13.188" class="difflineminus">-          nsAutoCString scheme;</span>
<a href="#l13.189"></a><span id="l13.189" class="difflineminus">-          uri-&gt;GetScheme(scheme);</span>
<a href="#l13.190"></a><span id="l13.190" class="difflineminus">-          contractID.Append(scheme);</span>
<a href="#l13.191"></a><span id="l13.191" class="difflineminus">-          nsCOMPtr&lt;nsIMsgProtocolInfo&gt; msgProtocolInfo =</span>
<a href="#l13.192"></a><span id="l13.192" class="difflineminus">-            do_CreateInstance(contractID.get());</span>
<a href="#l13.193"></a><span id="l13.193" class="difflineminus">-          if (msgProtocolInfo)</span>
<a href="#l13.194"></a><span id="l13.194" class="difflineminus">-            mailbox_count++;</span>
<a href="#l13.195"></a><span id="l13.195" class="difflineminus">-        }</span>
<a href="#l13.196"></a><span id="l13.196" class="difflineminus">-        if (uri)</span>
<a href="#l13.197"></a><span id="l13.197" class="difflineminus">-          msg_pick_real_name(m_attachments[i], nullptr, mCompFields-&gt;GetCharacterSet());</span>
<a href="#l13.198"></a><span id="l13.198" class="difflineplus">+    if (m_attachments[i]-&gt;mURL)</span>
<a href="#l13.199"></a><span id="l13.199" class="difflineplus">+    {</span>
<a href="#l13.200"></a><span id="l13.200" class="difflineplus">+    nsIURI *uri = m_attachments[i]-&gt;mURL;</span>
<a href="#l13.201"></a><span id="l13.201" class="difflineplus">+    bool match = false;</span>
<a href="#l13.202"></a><span id="l13.202" class="difflineplus">+    if ((NS_SUCCEEDED(uri-&gt;SchemeIs(&quot;mailbox&quot;, &amp;match)) &amp;&amp; match) ||</span>
<a href="#l13.203"></a><span id="l13.203" class="difflineplus">+      (NS_SUCCEEDED(uri-&gt;SchemeIs(&quot;imap&quot;, &amp;match)) &amp;&amp; match))</span>
<a href="#l13.204"></a><span id="l13.204" class="difflineplus">+      mailbox_count++;</span>
<a href="#l13.205"></a><span id="l13.205" class="difflineplus">+    else if ((NS_SUCCEEDED(uri-&gt;SchemeIs(&quot;news&quot;, &amp;match)) &amp;&amp; match) ||</span>
<a href="#l13.206"></a><span id="l13.206" class="difflineplus">+           (NS_SUCCEEDED(uri-&gt;SchemeIs(&quot;snews&quot;, &amp;match)) &amp;&amp; match))</span>
<a href="#l13.207"></a><span id="l13.207" class="difflineplus">+        news_count++;</span>
<a href="#l13.208"></a><span id="l13.208" class="difflineplus">+</span>
<a href="#l13.209"></a><span id="l13.209" class="difflineplus">+      if (uri)</span>
<a href="#l13.210"></a><span id="l13.210" class="difflineplus">+        msg_pick_real_name(m_attachments[i], nullptr, mCompFields-&gt;GetCharacterSet());</span>
<a href="#l13.211"></a><span id="l13.211">       }</span>
<a href="#l13.212"></a><span id="l13.212">     }</span>
<a href="#l13.213"></a><span id="l13.213">   }</span>
<a href="#l13.214"></a><span id="l13.214"> </span>
<a href="#l13.215"></a><span id="l13.215">   bool needToCallGatherMimeAttachments = true;</span>
<a href="#l13.216"></a><span id="l13.216"> </span>
<a href="#l13.217"></a><span id="l13.217">   if (m_attachment_count &gt; 0)</span>
<a href="#l13.218"></a><span id="l13.218">   {</span>
<a href="#l13.219"></a><span id="l13.219" class="difflineat">@@ -3171,17 +3130,17 @@ NS_IMETHODIMP nsMsgComposeAndSend::SendD</span>
<a href="#l13.220"></a><span id="l13.220">         default:</span>
<a href="#l13.221"></a><span id="l13.221">           if (aExitCode != NS_ERROR_ABORT &amp;&amp; !NS_IS_MSG_ERROR(aExitCode))</span>
<a href="#l13.222"></a><span id="l13.222">             aExitCode = NS_ERROR_SMTP_SEND_FAILED_UNKNOWN_REASON;</span>
<a href="#l13.223"></a><span id="l13.223">           break;</span>
<a href="#l13.224"></a><span id="l13.224">       }</span>
<a href="#l13.225"></a><span id="l13.225">     }</span>
<a href="#l13.226"></a><span id="l13.226">     DeliverAsMailExit(aUrl, aExitCode);</span>
<a href="#l13.227"></a><span id="l13.227">   }</span>
<a href="#l13.228"></a><span id="l13.228" class="difflineminus">-</span>
<a href="#l13.229"></a><span id="l13.229" class="difflineplus">+  </span>
<a href="#l13.230"></a><span id="l13.230">   return aExitCode;</span>
<a href="#l13.231"></a><span id="l13.231"> }</span>
<a href="#l13.232"></a><span id="l13.232"> </span>
<a href="#l13.233"></a><span id="l13.233"> nsresult</span>
<a href="#l13.234"></a><span id="l13.234"> nsMsgComposeAndSend::DeliverMessage()</span>
<a href="#l13.235"></a><span id="l13.235"> {</span>
<a href="#l13.236"></a><span id="l13.236">   if (mSendProgress)</span>
<a href="#l13.237"></a><span id="l13.237">   {</span>
<a href="#l13.238"></a><span id="l13.238" class="difflineat">@@ -3268,17 +3227,17 @@ nsMsgComposeAndSend::DeliverFileAsMail()</span>
<a href="#l13.239"></a><span id="l13.239"> </span>
<a href="#l13.240"></a><span id="l13.240">   if (!buf)</span>
<a href="#l13.241"></a><span id="l13.241">   {</span>
<a href="#l13.242"></a><span id="l13.242">     nsresult ignoreMe;</span>
<a href="#l13.243"></a><span id="l13.243">     Fail(NS_ERROR_OUT_OF_MEMORY, nullptr, &amp;ignoreMe);</span>
<a href="#l13.244"></a><span id="l13.244">     NotifyListenerOnStopSending(nullptr, NS_ERROR_OUT_OF_MEMORY, nullptr, nullptr);</span>
<a href="#l13.245"></a><span id="l13.245">     return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l13.246"></a><span id="l13.246">   }</span>
<a href="#l13.247"></a><span id="l13.247" class="difflineminus">-</span>
<a href="#l13.248"></a><span id="l13.248" class="difflineplus">+  </span>
<a href="#l13.249"></a><span id="l13.249">   bool collectOutgoingAddresses = true;</span>
<a href="#l13.250"></a><span id="l13.250">   nsCOMPtr&lt;nsIPrefBranch&gt; pPrefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l13.251"></a><span id="l13.251">   if (pPrefBranch)</span>
<a href="#l13.252"></a><span id="l13.252">     pPrefBranch-&gt;GetBoolPref(PREF_MAIL_COLLECT_EMAIL_ADDRESS_OUTGOING, &amp;collectOutgoingAddresses);</span>
<a href="#l13.253"></a><span id="l13.253"> </span>
<a href="#l13.254"></a><span id="l13.254">   nsCOMPtr&lt;nsIAbAddressCollector&gt; addressCollector =</span>
<a href="#l13.255"></a><span id="l13.255">            do_GetService(NS_ABADDRESSCOLLECTOR_CONTRACTID);</span>
<a href="#l13.256"></a><span id="l13.256"> </span>
<a href="#l13.257"></a><span id="l13.257" class="difflineat">@@ -3313,31 +3272,31 @@ nsMsgComposeAndSend::DeliverFileAsMail()</span>
<a href="#l13.258"></a><span id="l13.258"> #endif</span>
<a href="#l13.259"></a><span id="l13.259"> </span>
<a href="#l13.260"></a><span id="l13.260">   PL_strcpy (buf, &quot;&quot;);</span>
<a href="#l13.261"></a><span id="l13.261">   buf2 = buf + PL_strlen (buf);</span>
<a href="#l13.262"></a><span id="l13.262">   if (mCompFields-&gt;GetTo() &amp;&amp; *mCompFields-&gt;GetTo())</span>
<a href="#l13.263"></a><span id="l13.263">   {</span>
<a href="#l13.264"></a><span id="l13.264">     PL_strcat (buf2, mCompFields-&gt;GetTo());</span>
<a href="#l13.265"></a><span id="l13.265">     if (addressCollector)</span>
<a href="#l13.266"></a><span id="l13.266" class="difflineminus">-      addressCollector-&gt;CollectAddress(nsCString(mCompFields-&gt;GetTo()),</span>
<a href="#l13.267"></a><span id="l13.267" class="difflineplus">+      addressCollector-&gt;CollectAddress(nsCString(mCompFields-&gt;GetTo()), </span>
<a href="#l13.268"></a><span id="l13.268">             collectAddresses /* create card if one doesn't exist */, sendFormat);</span>
<a href="#l13.269"></a><span id="l13.269">   }</span>
<a href="#l13.270"></a><span id="l13.270">   if (mCompFields-&gt;GetCc() &amp;&amp; *mCompFields-&gt;GetCc()) {</span>
<a href="#l13.271"></a><span id="l13.271">     if (*buf2) PL_strcat (buf2, &quot;,&quot;);</span>
<a href="#l13.272"></a><span id="l13.272">       PL_strcat (buf2, mCompFields-&gt;GetCc());</span>
<a href="#l13.273"></a><span id="l13.273">     if (addressCollector)</span>
<a href="#l13.274"></a><span id="l13.274" class="difflineminus">-      addressCollector-&gt;CollectAddress(nsCString(mCompFields-&gt;GetCc()),</span>
<a href="#l13.275"></a><span id="l13.275" class="difflineplus">+      addressCollector-&gt;CollectAddress(nsCString(mCompFields-&gt;GetCc()), </span>
<a href="#l13.276"></a><span id="l13.276">             collectAddresses /* create card if one doesn't exist */, sendFormat);</span>
<a href="#l13.277"></a><span id="l13.277">   }</span>
<a href="#l13.278"></a><span id="l13.278">   if (mCompFields-&gt;GetBcc() &amp;&amp; *mCompFields-&gt;GetBcc()) {</span>
<a href="#l13.279"></a><span id="l13.279">     if (*buf2) PL_strcat (buf2, &quot;,&quot;);</span>
<a href="#l13.280"></a><span id="l13.280">       PL_strcat (buf2, mCompFields-&gt;GetBcc());</span>
<a href="#l13.281"></a><span id="l13.281">     if (addressCollector)</span>
<a href="#l13.282"></a><span id="l13.282" class="difflineminus">-      addressCollector-&gt;CollectAddress(nsCString(mCompFields-&gt;GetBcc()),</span>
<a href="#l13.283"></a><span id="l13.283" class="difflineplus">+      addressCollector-&gt;CollectAddress(nsCString(mCompFields-&gt;GetBcc()), </span>
<a href="#l13.284"></a><span id="l13.284">             collectAddresses /* create card if one doesn't exist */, sendFormat);</span>
<a href="#l13.285"></a><span id="l13.285">   }</span>
<a href="#l13.286"></a><span id="l13.286"> </span>
<a href="#l13.287"></a><span id="l13.287">   // We need undo groups to keep only the addresses</span>
<a href="#l13.288"></a><span id="l13.288">   nsresult rv = StripOutGroupNames(buf);</span>
<a href="#l13.289"></a><span id="l13.289">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.290"></a><span id="l13.290"> </span>
<a href="#l13.291"></a><span id="l13.291">   // Ok, now MIME II encode this to prevent 8bit problems...</span>
<a href="#l13.292"></a><span id="l13.292" class="difflineat">@@ -4850,92 +4809,16 @@ NS_IMETHODIMP nsMsgComposeAndSend::GetCr</span>
<a href="#l13.293"></a><span id="l13.293"> }</span>
<a href="#l13.294"></a><span id="l13.294"> </span>
<a href="#l13.295"></a><span id="l13.295"> NS_IMETHODIMP nsMsgComposeAndSend::SetCryptoclosure(nsIMsgComposeSecure * aCryptoclosure)</span>
<a href="#l13.296"></a><span id="l13.296"> {</span>
<a href="#l13.297"></a><span id="l13.297">   m_crypto_closure = aCryptoclosure;</span>
<a href="#l13.298"></a><span id="l13.298">   return NS_OK;</span>
<a href="#l13.299"></a><span id="l13.299"> }</span>
<a href="#l13.300"></a><span id="l13.300"> </span>
<a href="#l13.301"></a><span id="l13.301" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l13.302"></a><span id="l13.302" class="difflineminus">-nsMsgComposeAndSend::GetSendCompFields(nsIMsgCompFields** aCompFields)</span>
<a href="#l13.303"></a><span id="l13.303" class="difflineminus">-{</span>
<a href="#l13.304"></a><span id="l13.304" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aCompFields);</span>
<a href="#l13.305"></a><span id="l13.305" class="difflineminus">-  nsCOMPtr&lt;nsIMsgCompFields&gt; qiCompFields(mCompFields);</span>
<a href="#l13.306"></a><span id="l13.306" class="difflineminus">-  NS_ENSURE_STATE(qiCompFields);</span>
<a href="#l13.307"></a><span id="l13.307" class="difflineminus">-  qiCompFields.forget(aCompFields);</span>
<a href="#l13.308"></a><span id="l13.308" class="difflineminus">-  return NS_OK;</span>
<a href="#l13.309"></a><span id="l13.309" class="difflineminus">-}</span>
<a href="#l13.310"></a><span id="l13.310" class="difflineminus">-</span>
<a href="#l13.311"></a><span id="l13.311" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l13.312"></a><span id="l13.312" class="difflineminus">-nsMsgComposeAndSend::GetSendBody(nsAString&amp; aBody)</span>
<a href="#l13.313"></a><span id="l13.313" class="difflineminus">-{</span>
<a href="#l13.314"></a><span id="l13.314" class="difflineminus">-  nsCString charSet;</span>
<a href="#l13.315"></a><span id="l13.315" class="difflineminus">-  if (mCompFields)</span>
<a href="#l13.316"></a><span id="l13.316" class="difflineminus">-    mCompFields-&gt;GetCharacterSet(getter_Copies(charSet));</span>
<a href="#l13.317"></a><span id="l13.317" class="difflineminus">-  return ConvertToUnicode(charSet.get(), m_attachment1_body, aBody);</span>
<a href="#l13.318"></a><span id="l13.318" class="difflineminus">-}</span>
<a href="#l13.319"></a><span id="l13.319" class="difflineminus">-</span>
<a href="#l13.320"></a><span id="l13.320" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l13.321"></a><span id="l13.321" class="difflineminus">-nsMsgComposeAndSend::GetSendBodyType(nsACString&amp; aBodyType)</span>
<a href="#l13.322"></a><span id="l13.322" class="difflineminus">-{</span>
<a href="#l13.323"></a><span id="l13.323" class="difflineminus">-  if (m_attachment1_type &amp;&amp; *m_attachment1_type)</span>
<a href="#l13.324"></a><span id="l13.324" class="difflineminus">-    aBodyType.Assign(nsDependentCString(m_attachment1_type));</span>
<a href="#l13.325"></a><span id="l13.325" class="difflineminus">-  return NS_OK;</span>
<a href="#l13.326"></a><span id="l13.326" class="difflineminus">-}</span>
<a href="#l13.327"></a><span id="l13.327" class="difflineminus">-</span>
<a href="#l13.328"></a><span id="l13.328" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l13.329"></a><span id="l13.329" class="difflineminus">-nsMsgComposeAndSend::GetIdentity(nsIMsgIdentity **aIdentity)</span>
<a href="#l13.330"></a><span id="l13.330" class="difflineminus">-{</span>
<a href="#l13.331"></a><span id="l13.331" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aIdentity);</span>
<a href="#l13.332"></a><span id="l13.332" class="difflineminus">-  *aIdentity = mUserIdentity;</span>
<a href="#l13.333"></a><span id="l13.333" class="difflineminus">-  NS_IF_ADDREF(*aIdentity);</span>
<a href="#l13.334"></a><span id="l13.334" class="difflineminus">-  return NS_OK;</span>
<a href="#l13.335"></a><span id="l13.335" class="difflineminus">-}</span>
<a href="#l13.336"></a><span id="l13.336" class="difflineminus">-</span>
<a href="#l13.337"></a><span id="l13.337" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l13.338"></a><span id="l13.338" class="difflineminus">-nsMsgComposeAndSend::GetAttachment(uint32_t aIndex,</span>
<a href="#l13.339"></a><span id="l13.339" class="difflineminus">-                                   nsIMsgAttachmentHandler **aAttachment)</span>
<a href="#l13.340"></a><span id="l13.340" class="difflineminus">-{</span>
<a href="#l13.341"></a><span id="l13.341" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aAttachment);</span>
<a href="#l13.342"></a><span id="l13.342" class="difflineminus">-  if (aIndex &gt;= m_attachment_count)</span>
<a href="#l13.343"></a><span id="l13.343" class="difflineminus">-    return NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l13.344"></a><span id="l13.344" class="difflineminus">-  *aAttachment = m_attachments[aIndex];</span>
<a href="#l13.345"></a><span id="l13.345" class="difflineminus">-  NS_IF_ADDREF(*aAttachment);</span>
<a href="#l13.346"></a><span id="l13.346" class="difflineminus">-  return NS_OK;</span>
<a href="#l13.347"></a><span id="l13.347" class="difflineminus">-}</span>
<a href="#l13.348"></a><span id="l13.348" class="difflineminus">-</span>
<a href="#l13.349"></a><span id="l13.349" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l13.350"></a><span id="l13.350" class="difflineminus">-nsMsgComposeAndSend::SetSavedToFolderName(const nsAString&amp; aName)</span>
<a href="#l13.351"></a><span id="l13.351" class="difflineminus">-{</span>
<a href="#l13.352"></a><span id="l13.352" class="difflineminus">-  mSavedToFolderName.Assign(aName);</span>
<a href="#l13.353"></a><span id="l13.353" class="difflineminus">-  return NS_OK;</span>
<a href="#l13.354"></a><span id="l13.354" class="difflineminus">-}</span>
<a href="#l13.355"></a><span id="l13.355" class="difflineminus">-</span>
<a href="#l13.356"></a><span id="l13.356" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l13.357"></a><span id="l13.357" class="difflineminus">-nsMsgComposeAndSend::GetSavedToFolderName(nsAString&amp; aName)</span>
<a href="#l13.358"></a><span id="l13.358" class="difflineminus">-{</span>
<a href="#l13.359"></a><span id="l13.359" class="difflineminus">-  aName.Assign(mSavedToFolderName);</span>
<a href="#l13.360"></a><span id="l13.360" class="difflineminus">-  return NS_OK;</span>
<a href="#l13.361"></a><span id="l13.361" class="difflineminus">-}</span>
<a href="#l13.362"></a><span id="l13.362" class="difflineminus">-</span>
<a href="#l13.363"></a><span id="l13.363" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l13.364"></a><span id="l13.364" class="difflineminus">-nsMsgComposeAndSend::SetDontDeliver(bool aDontDeliver)</span>
<a href="#l13.365"></a><span id="l13.365" class="difflineminus">-{</span>
<a href="#l13.366"></a><span id="l13.366" class="difflineminus">-  m_dont_deliver_p = aDontDeliver;</span>
<a href="#l13.367"></a><span id="l13.367" class="difflineminus">-  return NS_OK;</span>
<a href="#l13.368"></a><span id="l13.368" class="difflineminus">-}</span>
<a href="#l13.369"></a><span id="l13.369" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l13.370"></a><span id="l13.370" class="difflineminus">-nsMsgComposeAndSend::GetDontDeliver(bool *aDontDeliver)</span>
<a href="#l13.371"></a><span id="l13.371" class="difflineminus">-{</span>
<a href="#l13.372"></a><span id="l13.372" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aDontDeliver);</span>
<a href="#l13.373"></a><span id="l13.373" class="difflineminus">-  *aDontDeliver = m_dont_deliver_p;</span>
<a href="#l13.374"></a><span id="l13.374" class="difflineminus">-  return NS_OK;</span>
<a href="#l13.375"></a><span id="l13.375" class="difflineminus">-}</span>
<a href="#l13.376"></a><span id="l13.376" class="difflineminus">-</span>
<a href="#l13.377"></a><span id="l13.377"> NS_IMPL_ISUPPORTS(nsMsgAttachmentData, nsIMsgAttachmentData)</span>
<a href="#l13.378"></a><span id="l13.378"> </span>
<a href="#l13.379"></a><span id="l13.379"> nsMsgAttachmentData::nsMsgAttachmentData() :  m_size(0), m_isExternalAttachment(0),</span>
<a href="#l13.380"></a><span id="l13.380">   m_isDownloaded(false), m_hasFilename(false), m_displayableInline(false)</span>
<a href="#l13.381"></a><span id="l13.381"> {</span>
<a href="#l13.382"></a><span id="l13.382"> }</span>
<a href="#l13.383"></a><span id="l13.383"> </span>
<a href="#l13.384"></a><span id="l13.384"> nsMsgAttachmentData::~nsMsgAttachmentData()</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgSend.h</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgSend.h</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -161,18 +161,17 @@ class nsIInterfaceRequestor;</span>
<a href="#l14.4"></a><span id="l14.4"> </span>
<a href="#l14.5"></a><span id="l14.5"> namespace mozilla {</span>
<a href="#l14.6"></a><span id="l14.6"> namespace mailnews {</span>
<a href="#l14.7"></a><span id="l14.7"> class MimeEncoder;</span>
<a href="#l14.8"></a><span id="l14.8"> }</span>
<a href="#l14.9"></a><span id="l14.9"> }</span>
<a href="#l14.10"></a><span id="l14.10"> </span>
<a href="#l14.11"></a><span id="l14.11"> class nsMsgComposeAndSend : public nsIMsgSend,</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-                            public nsIMsgOperationListener,</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineminus">-                            public nsSupportsWeakReference</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+                            public nsIMsgOperationListener</span>
<a href="#l14.15"></a><span id="l14.15"> {</span>
<a href="#l14.16"></a><span id="l14.16">   typedef mozilla::mailnews::MimeEncoder MimeEncoder;</span>
<a href="#l14.17"></a><span id="l14.17"> public:</span>
<a href="#l14.18"></a><span id="l14.18">   //</span>
<a href="#l14.19"></a><span id="l14.19">   // Define QueryInterface, AddRef and Release for this class</span>
<a href="#l14.20"></a><span id="l14.20">   //</span>
<a href="#l14.21"></a><span id="l14.21">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l14.22"></a><span id="l14.22">   NS_DECL_NSIMSGSEND</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineat">@@ -367,17 +366,17 @@ public:</span>
<a href="#l14.24"></a><span id="l14.24">   bool                    mGUINotificationEnabled;      // Should we throw up the GUI alerts on errors?</span>
<a href="#l14.25"></a><span id="l14.25">   bool                    mAbortInProcess;              // Used by Abort to avoid reentrance.</span>
<a href="#l14.26"></a><span id="l14.26"> </span>
<a href="#l14.27"></a><span id="l14.27">   nsCOMPtr&lt;nsIMsgComposeSecure&gt; m_crypto_closure;</span>
<a href="#l14.28"></a><span id="l14.28"> </span>
<a href="#l14.29"></a><span id="l14.29"> protected:</span>
<a href="#l14.30"></a><span id="l14.30">   nsCOMPtr&lt;nsIStringBundle&gt; mComposeBundle;</span>
<a href="#l14.31"></a><span id="l14.31">   nsresult GetNotificationCallbacks(nsIInterfaceRequestor** aCallbacks);</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineminus">-</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineplus">+private:</span>
<a href="#l14.34"></a><span id="l14.34">   virtual ~nsMsgComposeAndSend();</span>
<a href="#l14.35"></a><span id="l14.35">   nsresult FilterSentMessage();</span>
<a href="#l14.36"></a><span id="l14.36">   nsresult MaybePerformSecondFCC(nsresult aStatus);</span>
<a href="#l14.37"></a><span id="l14.37"> </span>
<a href="#l14.38"></a><span id="l14.38">   // generates a message id for our message, if necessary</span>
<a href="#l14.39"></a><span id="l14.39">   void GenerateMessageId( );</span>
<a href="#l14.40"></a><span id="l14.40"> </span>
<a href="#l14.41"></a><span id="l14.41">   // add default custom headers to the message</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -9811,22 +9811,16 @@ NS_IMETHODIMP nsImapMailFolder::GetOffli</span>
<a href="#l15.4"></a><span id="l15.4">       return rv;</span>
<a href="#l15.5"></a><span id="l15.5">     nsMsgKey newMsgKey;</span>
<a href="#l15.6"></a><span id="l15.6">     hdr-&gt;GetMessageKey(&amp;newMsgKey);</span>
<a href="#l15.7"></a><span id="l15.7">     return offlineFolder-&gt;GetOfflineFileStream(newMsgKey, offset, size, aFileStream);</span>
<a href="#l15.8"></a><span id="l15.8">   }</span>
<a href="#l15.9"></a><span id="l15.9">   return NS_OK;</span>
<a href="#l15.10"></a><span id="l15.10"> }</span>
<a href="#l15.11"></a><span id="l15.11"> </span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-NS_IMETHODIMP nsImapMailFolder::GetIncomingServerType(nsACString&amp; serverType)</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineminus">-{</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineminus">-  serverType.AssignLiteral(&quot;imap&quot;);</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineminus">-  return NS_OK;</span>
<a href="#l15.16"></a><span id="l15.16" class="difflineminus">-}</span>
<a href="#l15.17"></a><span id="l15.17" class="difflineminus">-</span>
<a href="#l15.18"></a><span id="l15.18"> void nsImapMailFolder::DeleteStoreMessages(nsIArray* aMessages)</span>
<a href="#l15.19"></a><span id="l15.19"> {</span>
<a href="#l15.20"></a><span id="l15.20">   // Delete messages for pluggable stores that do not support compaction.</span>
<a href="#l15.21"></a><span id="l15.21">   nsCOMPtr&lt;nsIMsgPluggableStore&gt; offlineStore;</span>
<a href="#l15.22"></a><span id="l15.22">   (void) GetMsgStore(getter_AddRefs(offlineStore));</span>
<a href="#l15.23"></a><span id="l15.23"> </span>
<a href="#l15.24"></a><span id="l15.24">   if (offlineStore)</span>
<a href="#l15.25"></a><span id="l15.25">   {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/imap/src/nsImapMailFolder.h</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapMailFolder.h</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -317,18 +317,16 @@ public:</span>
<a href="#l16.4"></a><span id="l16.4">   * the folder where the message first arrives, this method searches for the existence</span>
<a href="#l16.5"></a><span id="l16.5">   * of msg in all the folders/labels that we retrieve from X-GM-LABELS also.</span>
<a href="#l16.6"></a><span id="l16.6">   * overrides nsMsgDBFolder::GetOfflineMsgFolder()</span>
<a href="#l16.7"></a><span id="l16.7">   *  @param msgKey key  of the msg for which we are trying to get the folder;</span>
<a href="#l16.8"></a><span id="l16.8">   *  @param aMsgFolder  required folder;</span>
<a href="#l16.9"></a><span id="l16.9">   */</span>
<a href="#l16.10"></a><span id="l16.10">   NS_IMETHOD GetOfflineMsgFolder(nsMsgKey msgKey, nsIMsgFolder **aMsgFolder) override;</span>
<a href="#l16.11"></a><span id="l16.11"> </span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-  NS_IMETHOD GetIncomingServerType(nsACString&amp; serverType) override;</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineminus">-</span>
<a href="#l16.14"></a><span id="l16.14">   nsresult AddSubfolderWithPath(nsAString&amp; name, nsIFile *dbPath, nsIMsgFolder **child, bool brandNew = false);</span>
<a href="#l16.15"></a><span id="l16.15">   nsresult MoveIncorporatedMessage(nsIMsgDBHdr *mailHdr,</span>
<a href="#l16.16"></a><span id="l16.16">                                   nsIMsgDatabase *sourceDB,</span>
<a href="#l16.17"></a><span id="l16.17">                                   const nsACString&amp; destFolder,</span>
<a href="#l16.18"></a><span id="l16.18">                                   nsIMsgFilter *filter,</span>
<a href="#l16.19"></a><span id="l16.19">                                   nsIMsgWindow *msgWindow);</span>
<a href="#l16.20"></a><span id="l16.20"> </span>
<a href="#l16.21"></a><span id="l16.21">   // send notification to copy service listener.</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineat">@@ -392,16 +390,17 @@ protected:</span>
<a href="#l16.23"></a><span id="l16.23">   static bool ShouldCheckAllFolders(nsIImapIncomingServer *imapServer);</span>
<a href="#l16.24"></a><span id="l16.24">   nsresult GetServerKey(nsACString&amp; serverKey);</span>
<a href="#l16.25"></a><span id="l16.25">   nsresult DisplayStatusMsg(nsIImapUrl *aImapUrl, const nsAString&amp; msg);</span>
<a href="#l16.26"></a><span id="l16.26"> </span>
<a href="#l16.27"></a><span id="l16.27">   //nsresult RenameLocal(const char *newName);</span>
<a href="#l16.28"></a><span id="l16.28">   nsresult AddDirectorySeparator(nsIFile *path);</span>
<a href="#l16.29"></a><span id="l16.29">   nsresult CreateSubFolders(nsIFile *path);</span>
<a href="#l16.30"></a><span id="l16.30">   nsresult GetDatabase() override;</span>
<a href="#l16.31"></a><span id="l16.31" class="difflineplus">+  virtual void GetIncomingServerType(nsCString&amp; serverType) override { serverType.AssignLiteral(&quot;imap&quot;);}</span>
<a href="#l16.32"></a><span id="l16.32"> </span>
<a href="#l16.33"></a><span id="l16.33">   nsresult        GetFolderOwnerUserName(nsACString&amp; userName);</span>
<a href="#l16.34"></a><span id="l16.34">   nsIMAPNamespace *GetNamespaceForFolder();</span>
<a href="#l16.35"></a><span id="l16.35">   void            SetNamespaceForFolder(nsIMAPNamespace *ns);</span>
<a href="#l16.36"></a><span id="l16.36"> </span>
<a href="#l16.37"></a><span id="l16.37">   nsMsgIMAPFolderACL * GetFolderACL();</span>
<a href="#l16.38"></a><span id="l16.38">   nsresult CreateACLRightsStringForFolder(nsAString&amp; rightsString);</span>
<a href="#l16.39"></a><span id="l16.39">   nsresult GetBodysToDownload(nsTArray&lt;nsMsgKey&gt; *keysOfMessagesToDownload);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/local/src/nsLocalMailFolder.cpp</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/local/src/nsLocalMailFolder.cpp</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -3079,34 +3079,34 @@ NS_IMETHODIMP nsMsgLocalMailFolder::Noti</span>
<a href="#l17.4"></a><span id="l17.4">   NotifyFolderEvent(mDeleteOrMoveMsgCompletedAtom);</span>
<a href="#l17.5"></a><span id="l17.5">   return NS_OK;</span>
<a href="#l17.6"></a><span id="l17.6"> }</span>
<a href="#l17.7"></a><span id="l17.7"> </span>
<a href="#l17.8"></a><span id="l17.8"> // TODO:  once we move certain code into the IncomingServer (search for TODO)</span>
<a href="#l17.9"></a><span id="l17.9"> // this method will go away.</span>
<a href="#l17.10"></a><span id="l17.10"> // sometimes this gets called when we don't have the server yet, so</span>
<a href="#l17.11"></a><span id="l17.11"> // that's why we're not calling GetServer()</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineminus">-nsMsgLocalMailFolder::GetIncomingServerType(nsACString&amp; aServerType)</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineplus">+void</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineplus">+nsMsgLocalMailFolder::GetIncomingServerType(nsCString&amp; aServerType)</span>
<a href="#l17.16"></a><span id="l17.16"> {</span>
<a href="#l17.17"></a><span id="l17.17">   nsresult rv;</span>
<a href="#l17.18"></a><span id="l17.18">   if (mType.IsEmpty())</span>
<a href="#l17.19"></a><span id="l17.19">   {</span>
<a href="#l17.20"></a><span id="l17.20">     nsCOMPtr&lt;nsIURL&gt; url = do_CreateInstance(NS_STANDARDURL_CONTRACTID, &amp;rv);</span>
<a href="#l17.21"></a><span id="l17.21">     if (NS_FAILED(rv))</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineminus">-      return rv;</span>
<a href="#l17.23"></a><span id="l17.23" class="difflineplus">+      return;</span>
<a href="#l17.24"></a><span id="l17.24"> </span>
<a href="#l17.25"></a><span id="l17.25">     rv = url-&gt;SetSpec(mURI);</span>
<a href="#l17.26"></a><span id="l17.26">     if (NS_FAILED(rv))</span>
<a href="#l17.27"></a><span id="l17.27" class="difflineminus">-      return rv;</span>
<a href="#l17.28"></a><span id="l17.28" class="difflineplus">+      return;</span>
<a href="#l17.29"></a><span id="l17.29"> </span>
<a href="#l17.30"></a><span id="l17.30">     nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l17.31"></a><span id="l17.31">              do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l17.32"></a><span id="l17.32">     if (NS_FAILED(rv))</span>
<a href="#l17.33"></a><span id="l17.33" class="difflineminus">-      return rv;</span>
<a href="#l17.34"></a><span id="l17.34" class="difflineplus">+      return;</span>
<a href="#l17.35"></a><span id="l17.35"> </span>
<a href="#l17.36"></a><span id="l17.36">     nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l17.37"></a><span id="l17.37">     // try &quot;none&quot; first</span>
<a href="#l17.38"></a><span id="l17.38">     url-&gt;SetScheme(NS_LITERAL_CSTRING(&quot;none&quot;));</span>
<a href="#l17.39"></a><span id="l17.39">     rv = accountManager-&gt;FindServerByURI(url, false, getter_AddRefs(server));</span>
<a href="#l17.40"></a><span id="l17.40">     if (NS_SUCCEEDED(rv) &amp;&amp; server)</span>
<a href="#l17.41"></a><span id="l17.41">       mType.AssignLiteral(&quot;none&quot;);</span>
<a href="#l17.42"></a><span id="l17.42">     else</span>
<a href="#l17.43"></a><span id="l17.43" class="difflineat">@@ -3132,17 +3132,16 @@ nsMsgLocalMailFolder::GetIncomingServerT</span>
<a href="#l17.44"></a><span id="l17.44">           if (NS_SUCCEEDED(rv) &amp;&amp; server)</span>
<a href="#l17.45"></a><span id="l17.45">             mType.AssignLiteral(&quot;movemail&quot;);</span>
<a href="#l17.46"></a><span id="l17.46"> #endif /* HAVE_MOVEMAIL */</span>
<a href="#l17.47"></a><span id="l17.47">         }</span>
<a href="#l17.48"></a><span id="l17.48">       }</span>
<a href="#l17.49"></a><span id="l17.49">     }</span>
<a href="#l17.50"></a><span id="l17.50">   }</span>
<a href="#l17.51"></a><span id="l17.51">   aServerType = mType;</span>
<a href="#l17.52"></a><span id="l17.52" class="difflineminus">-  return NS_OK;</span>
<a href="#l17.53"></a><span id="l17.53"> }</span>
<a href="#l17.54"></a><span id="l17.54"> </span>
<a href="#l17.55"></a><span id="l17.55"> nsresult nsMsgLocalMailFolder::CreateBaseMessageURI(const nsACString&amp; aURI)</span>
<a href="#l17.56"></a><span id="l17.56"> {</span>
<a href="#l17.57"></a><span id="l17.57">   return nsCreateLocalBaseMessageURI(aURI, mBaseMessageURI);</span>
<a href="#l17.58"></a><span id="l17.58"> }</span>
<a href="#l17.59"></a><span id="l17.59"> </span>
<a href="#l17.60"></a><span id="l17.60"> NS_IMETHODIMP</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/local/src/nsLocalMailFolder.h</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/local/src/nsLocalMailFolder.h</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -170,17 +170,16 @@ public:</span>
<a href="#l18.4"></a><span id="l18.4"> </span>
<a href="#l18.5"></a><span id="l18.5">   // Used when headers_only is TRUE</span>
<a href="#l18.6"></a><span id="l18.6">   NS_IMETHOD DownloadMessagesForOffline(nsIArray *aMessages, nsIMsgWindow *aWindow) override;</span>
<a href="#l18.7"></a><span id="l18.7">   NS_IMETHOD FetchMsgPreviewText(nsMsgKey *aKeysToFetch, uint32_t aNumKeys,</span>
<a href="#l18.8"></a><span id="l18.8">                                                  bool aLocalOnly, nsIUrlListener *aUrlListener, </span>
<a href="#l18.9"></a><span id="l18.9">                                                  bool *aAsyncResults) override;</span>
<a href="#l18.10"></a><span id="l18.10">   NS_IMETHOD AddKeywordsToMessages(nsIArray *aMessages, const nsACString&amp; aKeywords) override;</span>
<a href="#l18.11"></a><span id="l18.11">   NS_IMETHOD RemoveKeywordsFromMessages(nsIArray *aMessages, const nsACString&amp; aKeywords) override;</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-  NS_IMETHOD GetIncomingServerType(nsACString&amp; serverType) override;</span>
<a href="#l18.13"></a><span id="l18.13"> </span>
<a href="#l18.14"></a><span id="l18.14"> protected:</span>
<a href="#l18.15"></a><span id="l18.15">   virtual ~nsMsgLocalMailFolder();</span>
<a href="#l18.16"></a><span id="l18.16">   nsresult CreateChildFromURI(const nsCString &amp;uri, nsIMsgFolder **folder) override;</span>
<a href="#l18.17"></a><span id="l18.17">   nsresult CopyFolderAcrossServer(nsIMsgFolder *srcFolder, nsIMsgWindow *msgWindow,nsIMsgCopyServiceListener* listener);</span>
<a href="#l18.18"></a><span id="l18.18"> </span>
<a href="#l18.19"></a><span id="l18.19">   nsresult CreateSubFolders(nsIFile *path);</span>
<a href="#l18.20"></a><span id="l18.20">   nsresult GetTrashFolder(nsIMsgFolder** trashFolder);</span>
<a href="#l18.21"></a><span id="l18.21" class="difflineat">@@ -218,16 +217,17 @@ protected:</span>
<a href="#l18.22"></a><span id="l18.22">                              bool isMove,</span>
<a href="#l18.23"></a><span id="l18.23">                              int64_t totalMsgSize);</span>
<a href="#l18.24"></a><span id="l18.24"> </span>
<a href="#l18.25"></a><span id="l18.25">   // copy multiple messages at a time from this folder</span>
<a href="#l18.26"></a><span id="l18.26">   nsresult CopyMessagesTo(nsIArray *messages, nsTArray&lt;nsMsgKey&gt; &amp;keyArray,</span>
<a href="#l18.27"></a><span id="l18.27">                                        nsIMsgWindow *aMsgWindow,</span>
<a href="#l18.28"></a><span id="l18.28">                                        nsIMsgFolder *dstFolder,</span>
<a href="#l18.29"></a><span id="l18.29">                                        bool isMove);</span>
<a href="#l18.30"></a><span id="l18.30" class="difflineplus">+  virtual void GetIncomingServerType(nsCString&amp; serverType) override;</span>
<a href="#l18.31"></a><span id="l18.31">   nsresult InitCopyState(nsISupports* aSupport, nsIArray* messages,</span>
<a href="#l18.32"></a><span id="l18.32">                          bool isMove, nsIMsgCopyServiceListener* listener, nsIMsgWindow *msgWindow, bool isMoveFolder, bool allowUndo);</span>
<a href="#l18.33"></a><span id="l18.33">   nsresult InitCopyMsgHdrAndFileStream();</span>
<a href="#l18.34"></a><span id="l18.34">   // preserve message metadata when moving or copying messages</span>
<a href="#l18.35"></a><span id="l18.35">   void CopyPropertiesToMsgHdr(nsIMsgDBHdr *destHdr, nsIMsgDBHdr *srcHdr, bool isMove);</span>
<a href="#l18.36"></a><span id="l18.36">   virtual nsresult CreateBaseMessageURI(const nsACString&amp; aURI) override;</span>
<a href="#l18.37"></a><span id="l18.37">   nsresult ChangeKeywordForMessages(nsIArray *aMessages, const nsACString&amp; aKeyword, bool add);</span>
<a href="#l18.38"></a><span id="l18.38">   bool GetDeleteFromServerOnMove();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/news/src/nsNewsFolder.cpp</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/news/src/nsNewsFolder.cpp</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -1884,16 +1884,8 @@ nsMsgNewsFolder::OnStopRunningUrl(nsIURI</span>
<a href="#l19.4"></a><span id="l19.4">  if (m_tempMessageStream)</span>
<a href="#l19.5"></a><span id="l19.5">   {</span>
<a href="#l19.6"></a><span id="l19.6">     m_tempMessageStream-&gt;Close();</span>
<a href="#l19.7"></a><span id="l19.7">     m_tempMessageStream = nullptr;</span>
<a href="#l19.8"></a><span id="l19.8">   }</span>
<a href="#l19.9"></a><span id="l19.9">   m_downloadingMultipleMessages = false;</span>
<a href="#l19.10"></a><span id="l19.10">   return nsMsgDBFolder::OnStopRunningUrl(aUrl, aExitCode);</span>
<a href="#l19.11"></a><span id="l19.11"> }</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineminus">-nsMsgNewsFolder::GetIncomingServerType(nsACString&amp; serverType)</span>
<a href="#l19.15"></a><span id="l19.15" class="difflineminus">-{</span>
<a href="#l19.16"></a><span id="l19.16" class="difflineminus">-  serverType.AssignLiteral(&quot;nntp&quot;);</span>
<a href="#l19.17"></a><span id="l19.17" class="difflineminus">-  return NS_OK;</span>
<a href="#l19.18"></a><span id="l19.18" class="difflineminus">-}</span>
<a href="#l19.19"></a><span id="l19.19" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mailnews/news/src/nsNewsFolder.h</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mailnews/news/src/nsNewsFolder.h</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -85,17 +85,16 @@ public:</span>
<a href="#l20.4"></a><span id="l20.4"> </span>
<a href="#l20.5"></a><span id="l20.5">   NS_IMETHOD GetFilterList(nsIMsgWindow *aMsgWindow,</span>
<a href="#l20.6"></a><span id="l20.6">                            nsIMsgFilterList **aFilterList) override;</span>
<a href="#l20.7"></a><span id="l20.7">   NS_IMETHOD GetEditableFilterList(nsIMsgWindow *aMsgWindow,</span>
<a href="#l20.8"></a><span id="l20.8">                                    nsIMsgFilterList **aFilterList) override;</span>
<a href="#l20.9"></a><span id="l20.9">   NS_IMETHOD SetFilterList(nsIMsgFilterList *aFilterList) override;</span>
<a href="#l20.10"></a><span id="l20.10">   NS_IMETHOD SetEditableFilterList(nsIMsgFilterList *aFilterList) override;</span>
<a href="#l20.11"></a><span id="l20.11">   NS_IMETHOD ApplyRetentionSettings() override;</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-  NS_IMETHOD GetIncomingServerType(nsACString&amp; serverType) override;</span>
<a href="#l20.13"></a><span id="l20.13"> </span>
<a href="#l20.14"></a><span id="l20.14"> protected:</span>
<a href="#l20.15"></a><span id="l20.15">   virtual ~nsMsgNewsFolder();</span>
<a href="#l20.16"></a><span id="l20.16">   // helper routine to parse the URI and update member variables</span>
<a href="#l20.17"></a><span id="l20.17">   nsresult AbbreviatePrettyName(nsAString&amp; prettyName, int32_t fullwords);</span>
<a href="#l20.18"></a><span id="l20.18">   nsresult ParseFolder(nsIFile *path);</span>
<a href="#l20.19"></a><span id="l20.19">   nsresult CreateSubFolders(nsIFile *path);</span>
<a href="#l20.20"></a><span id="l20.20">   nsresult AddDirectorySeparator(nsIFile *path);</span>
<a href="#l20.21"></a><span id="l20.21" class="difflineat">@@ -105,16 +104,20 @@ protected:</span>
<a href="#l20.22"></a><span id="l20.22"> </span>
<a href="#l20.23"></a><span id="l20.23">   nsresult LoadNewsrcFileAndCreateNewsgroups();</span>
<a href="#l20.24"></a><span id="l20.24">   int32_t RememberLine(const nsACString&amp; line);</span>
<a href="#l20.25"></a><span id="l20.25">   nsresult RememberUnsubscribedGroup(const nsACString&amp; newsgroup, const nsACString&amp; setStr);</span>
<a href="#l20.26"></a><span id="l20.26">   nsresult ForgetLine(void);</span>
<a href="#l20.27"></a><span id="l20.27">   nsresult GetNewsMessages(nsIMsgWindow *aMsgWindow, bool getOld, nsIUrlListener *aListener);</span>
<a href="#l20.28"></a><span id="l20.28"> </span>
<a href="#l20.29"></a><span id="l20.29">   int32_t HandleNewsrcLine(const char * line, uint32_t line_size);</span>
<a href="#l20.30"></a><span id="l20.30" class="difflineplus">+  virtual void GetIncomingServerType(nsCString&amp; serverType) override</span>
<a href="#l20.31"></a><span id="l20.31" class="difflineplus">+  {</span>
<a href="#l20.32"></a><span id="l20.32" class="difflineplus">+    serverType.AssignLiteral(&quot;nntp&quot;);</span>
<a href="#l20.33"></a><span id="l20.33" class="difflineplus">+  }</span>
<a href="#l20.34"></a><span id="l20.34">   virtual nsresult CreateBaseMessageURI(const nsACString&amp; aURI) override;</span>
<a href="#l20.35"></a><span id="l20.35"> </span>
<a href="#l20.36"></a><span id="l20.36"> protected:</span>
<a href="#l20.37"></a><span id="l20.37">   int64_t mExpungedBytes;</span>
<a href="#l20.38"></a><span id="l20.38">   bool mGettingNews;</span>
<a href="#l20.39"></a><span id="l20.39">   bool mInitialized;</span>
<a href="#l20.40"></a><span id="l20.40">   bool m_downloadMessageForOfflineUse;</span>
<a href="#l20.41"></a><span id="l20.41">   bool m_downloadingMultipleMessages;</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

