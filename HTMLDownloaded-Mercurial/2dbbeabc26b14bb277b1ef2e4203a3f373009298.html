<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 28661:2dbbeabc26b14bb277b1ef2e4203a3f373009298</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 2dbbeabc26b14bb277b1ef2e4203a3f373009298" />
<meta property="og:url" content="/comm-central/rev/2dbbeabc26b14bb277b1ef2e4203a3f373009298" />
<meta property="og:description" content="Bug 1610445 - make account manager live in a tab - about:accountsettings . r=mkmelin" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 2dbbeabc26b14bb277b1ef2e4203a3f373009298 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/2dbbeabc26b14bb277b1ef2e4203a3f373009298">shortlog</a> |
<a href="/comm-central/log/2dbbeabc26b14bb277b1ef2e4203a3f373009298">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/2dbbeabc26b14bb277b1ef2e4203a3f373009298">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/2dbbeabc26b14bb277b1ef2e4203a3f373009298">files</a> |
changeset |
<a href="/comm-central/raw-rev/2dbbeabc26b14bb277b1ef2e4203a3f373009298">raw</a>  | <a href="/comm-central/archive/2dbbeabc26b14bb277b1ef2e4203a3f373009298.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1610445">Bug 1610445</a> - make account manager live in a tab - about:accountsettings . r=mkmelin
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#75;&#104;&#117;&#115;&#104;&#105;&#108;&#32;&#77;&#105;&#115;&#116;&#114;&#121;&#32;&#60;&#107;&#104;&#117;&#115;&#104;&#105;&#108;&#51;&#50;&#52;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 06 Feb 2020 21:36:39 +0200</td></tr>

<tr>
 <td>changeset 28661</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/2dbbeabc26b14bb277b1ef2e4203a3f373009298">2dbbeabc26b14bb277b1ef2e4203a3f373009298</a></td>
</tr>



<tr>
<td>parent 28660</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/4a30d3d764d2e8b0e7e254dd5e91e2be9af485d0">4a30d3d764d2e8b0e7e254dd5e91e2be9af485d0</a>
</td>
</tr>

<tr>
<td>child 28662</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/b806e6de3a502f8094f0757646ab8de9a403224f">b806e6de3a502f8094f0757646ab8de9a403224f</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=2dbbeabc26b14bb277b1ef2e4203a3f373009298">16988</a></td></tr>
<tr><td>push user</td><td>mkmelin@iki.fi</td></tr>
<tr><td>push date</td><td class="date age">Thu, 06 Feb 2020 19:38:02 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@2dbbeabc26b1 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=2dbbeabc26b14bb277b1ef2e4203a3f373009298">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=2dbbeabc26b14bb277b1ef2e4203a3f373009298&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=2dbbeabc26b14bb277b1ef2e4203a3f373009298&newProject=comm-central&newRevision=4a30d3d764d2e8b0e7e254dd5e91e2be9af485d0&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=2dbbeabc26b14bb277b1ef2e4203a3f373009298&newProject=comm-central&newRevision=4a30d3d764d2e8b0e7e254dd5e91e2be9af485d0&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=2dbbeabc26b14bb277b1ef2e4203a3f373009298&newProject=comm-central&newRevision=4a30d3d764d2e8b0e7e254dd5e91e2be9af485d0&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mkmelin%29&revcount=50">mkmelin</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1610445">1610445</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1610445">Bug 1610445</a> - make account manager live in a tab - about:accountsettings . r=mkmelin</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/components/AboutRedirector.jsm">mail/components/AboutRedirector.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/components/AboutRedirector.jsm">file</a> |
<a href="/comm-central/annotate/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/components/AboutRedirector.jsm">annotate</a> |
<a href="/comm-central/diff/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/components/AboutRedirector.jsm">diff</a> |
<a href="/comm-central/comparison/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/components/AboutRedirector.jsm">comparison</a> |
<a href="/comm-central/log/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/components/AboutRedirector.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/components/accountcreation/content/emailWizard.js">mail/components/accountcreation/content/emailWizard.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/components/accountcreation/content/emailWizard.js">file</a> |
<a href="/comm-central/annotate/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/components/accountcreation/content/emailWizard.js">annotate</a> |
<a href="/comm-central/diff/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/components/accountcreation/content/emailWizard.js">diff</a> |
<a href="/comm-central/comparison/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/components/accountcreation/content/emailWizard.js">comparison</a> |
<a href="/comm-central/log/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/components/accountcreation/content/emailWizard.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/components/components.conf">mail/components/components.conf</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/components/components.conf">file</a> |
<a href="/comm-central/annotate/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/components/components.conf">annotate</a> |
<a href="/comm-central/diff/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/components/components.conf">diff</a> |
<a href="/comm-central/comparison/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/components/components.conf">comparison</a> |
<a href="/comm-central/log/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/components/components.conf">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/components/im/content/am-im.js">mail/components/im/content/am-im.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/components/im/content/am-im.js">file</a> |
<a href="/comm-central/annotate/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/components/im/content/am-im.js">annotate</a> |
<a href="/comm-central/diff/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/components/im/content/am-im.js">diff</a> |
<a href="/comm-central/comparison/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/components/im/content/am-im.js">comparison</a> |
<a href="/comm-central/log/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/components/im/content/am-im.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/components/im/content/imAccounts.js">mail/components/im/content/imAccounts.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/components/im/content/imAccounts.js">file</a> |
<a href="/comm-central/annotate/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/components/im/content/imAccounts.js">annotate</a> |
<a href="/comm-central/diff/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/components/im/content/imAccounts.js">diff</a> |
<a href="/comm-central/comparison/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/components/im/content/imAccounts.js">comparison</a> |
<a href="/comm-central/log/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/components/im/content/imAccounts.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/components/newmailaccount/content/accountProvisioner.js">mail/components/newmailaccount/content/accountProvisioner.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/components/newmailaccount/content/accountProvisioner.js">file</a> |
<a href="/comm-central/annotate/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/components/newmailaccount/content/accountProvisioner.js">annotate</a> |
<a href="/comm-central/diff/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/components/newmailaccount/content/accountProvisioner.js">diff</a> |
<a href="/comm-central/comparison/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/components/newmailaccount/content/accountProvisioner.js">comparison</a> |
<a href="/comm-central/log/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/components/newmailaccount/content/accountProvisioner.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/components/newmailaccount/content/uriListener.js">mail/components/newmailaccount/content/uriListener.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/components/newmailaccount/content/uriListener.js">file</a> |
<a href="/comm-central/annotate/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/components/newmailaccount/content/uriListener.js">annotate</a> |
<a href="/comm-central/diff/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/components/newmailaccount/content/uriListener.js">diff</a> |
<a href="/comm-central/comparison/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/components/newmailaccount/content/uriListener.js">comparison</a> |
<a href="/comm-central/log/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/components/newmailaccount/content/uriListener.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/test/browser/account/browser_abWhitelist.js">mail/test/browser/account/browser_abWhitelist.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/test/browser/account/browser_abWhitelist.js">file</a> |
<a href="/comm-central/annotate/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/test/browser/account/browser_abWhitelist.js">annotate</a> |
<a href="/comm-central/diff/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/test/browser/account/browser_abWhitelist.js">diff</a> |
<a href="/comm-central/comparison/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/test/browser/account/browser_abWhitelist.js">comparison</a> |
<a href="/comm-central/log/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/test/browser/account/browser_abWhitelist.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/test/browser/account/browser_actions.js">mail/test/browser/account/browser_actions.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/test/browser/account/browser_actions.js">file</a> |
<a href="/comm-central/annotate/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/test/browser/account/browser_actions.js">annotate</a> |
<a href="/comm-central/diff/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/test/browser/account/browser_actions.js">diff</a> |
<a href="/comm-central/comparison/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/test/browser/account/browser_actions.js">comparison</a> |
<a href="/comm-central/log/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/test/browser/account/browser_actions.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/test/browser/account/browser_archiveOptions.js">mail/test/browser/account/browser_archiveOptions.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/test/browser/account/browser_archiveOptions.js">file</a> |
<a href="/comm-central/annotate/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/test/browser/account/browser_archiveOptions.js">annotate</a> |
<a href="/comm-central/diff/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/test/browser/account/browser_archiveOptions.js">diff</a> |
<a href="/comm-central/comparison/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/test/browser/account/browser_archiveOptions.js">comparison</a> |
<a href="/comm-central/log/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/test/browser/account/browser_archiveOptions.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/test/browser/account/browser_deletion.js">mail/test/browser/account/browser_deletion.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/test/browser/account/browser_deletion.js">file</a> |
<a href="/comm-central/annotate/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/test/browser/account/browser_deletion.js">annotate</a> |
<a href="/comm-central/diff/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/test/browser/account/browser_deletion.js">diff</a> |
<a href="/comm-central/comparison/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/test/browser/account/browser_deletion.js">comparison</a> |
<a href="/comm-central/log/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/test/browser/account/browser_deletion.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/test/browser/account/browser_mailAccountSetupWizard.js">mail/test/browser/account/browser_mailAccountSetupWizard.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/test/browser/account/browser_mailAccountSetupWizard.js">file</a> |
<a href="/comm-central/annotate/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/test/browser/account/browser_mailAccountSetupWizard.js">annotate</a> |
<a href="/comm-central/diff/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/test/browser/account/browser_mailAccountSetupWizard.js">diff</a> |
<a href="/comm-central/comparison/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/test/browser/account/browser_mailAccountSetupWizard.js">comparison</a> |
<a href="/comm-central/log/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/test/browser/account/browser_mailAccountSetupWizard.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/test/browser/account/browser_portSetting.js">mail/test/browser/account/browser_portSetting.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/test/browser/account/browser_portSetting.js">file</a> |
<a href="/comm-central/annotate/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/test/browser/account/browser_portSetting.js">annotate</a> |
<a href="/comm-central/diff/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/test/browser/account/browser_portSetting.js">diff</a> |
<a href="/comm-central/comparison/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/test/browser/account/browser_portSetting.js">comparison</a> |
<a href="/comm-central/log/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/test/browser/account/browser_portSetting.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/test/browser/account/browser_settingsInfrastructure.js">mail/test/browser/account/browser_settingsInfrastructure.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/test/browser/account/browser_settingsInfrastructure.js">file</a> |
<a href="/comm-central/annotate/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/test/browser/account/browser_settingsInfrastructure.js">annotate</a> |
<a href="/comm-central/diff/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/test/browser/account/browser_settingsInfrastructure.js">diff</a> |
<a href="/comm-central/comparison/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/test/browser/account/browser_settingsInfrastructure.js">comparison</a> |
<a href="/comm-central/log/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/test/browser/account/browser_settingsInfrastructure.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/test/browser/account/browser_tree.js">mail/test/browser/account/browser_tree.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/test/browser/account/browser_tree.js">file</a> |
<a href="/comm-central/annotate/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/test/browser/account/browser_tree.js">annotate</a> |
<a href="/comm-central/diff/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/test/browser/account/browser_tree.js">diff</a> |
<a href="/comm-central/comparison/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/test/browser/account/browser_tree.js">comparison</a> |
<a href="/comm-central/log/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/test/browser/account/browser_tree.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/test/browser/account/browser_values.js">mail/test/browser/account/browser_values.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/test/browser/account/browser_values.js">file</a> |
<a href="/comm-central/annotate/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/test/browser/account/browser_values.js">annotate</a> |
<a href="/comm-central/diff/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/test/browser/account/browser_values.js">diff</a> |
<a href="/comm-central/comparison/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/test/browser/account/browser_values.js">comparison</a> |
<a href="/comm-central/log/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/test/browser/account/browser_values.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/test/browser/shared-modules/AccountManagerHelpers.jsm">mail/test/browser/shared-modules/AccountManagerHelpers.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/test/browser/shared-modules/AccountManagerHelpers.jsm">file</a> |
<a href="/comm-central/annotate/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/test/browser/shared-modules/AccountManagerHelpers.jsm">annotate</a> |
<a href="/comm-central/diff/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/test/browser/shared-modules/AccountManagerHelpers.jsm">diff</a> |
<a href="/comm-central/comparison/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/test/browser/shared-modules/AccountManagerHelpers.jsm">comparison</a> |
<a href="/comm-central/log/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/test/browser/shared-modules/AccountManagerHelpers.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/themes/osx/mail/accountManage.css">mail/themes/osx/mail/accountManage.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/themes/osx/mail/accountManage.css">file</a> |
<a href="/comm-central/annotate/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/themes/osx/mail/accountManage.css">annotate</a> |
<a href="/comm-central/diff/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/themes/osx/mail/accountManage.css">diff</a> |
<a href="/comm-central/comparison/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/themes/osx/mail/accountManage.css">comparison</a> |
<a href="/comm-central/log/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mail/themes/osx/mail/accountManage.css">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/AccountManager.js">mailnews/base/prefs/content/AccountManager.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/AccountManager.js">file</a> |
<a href="/comm-central/annotate/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/AccountManager.js">annotate</a> |
<a href="/comm-central/diff/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/AccountManager.js">diff</a> |
<a href="/comm-central/comparison/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/AccountManager.js">comparison</a> |
<a href="/comm-central/log/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/AccountManager.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/AccountManager.xhtml">mailnews/base/prefs/content/AccountManager.xhtml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/AccountManager.xhtml">file</a> |
<a href="/comm-central/annotate/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/AccountManager.xhtml">annotate</a> |
<a href="/comm-central/diff/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/AccountManager.xhtml">diff</a> |
<a href="/comm-central/comparison/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/AccountManager.xhtml">comparison</a> |
<a href="/comm-central/log/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/AccountManager.xhtml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/accountUtils.js">mailnews/base/prefs/content/accountUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/accountUtils.js">file</a> |
<a href="/comm-central/annotate/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/accountUtils.js">annotate</a> |
<a href="/comm-central/diff/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/accountUtils.js">diff</a> |
<a href="/comm-central/comparison/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/accountUtils.js">comparison</a> |
<a href="/comm-central/log/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/accountUtils.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/am-addressing.js">mailnews/base/prefs/content/am-addressing.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/am-addressing.js">file</a> |
<a href="/comm-central/annotate/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/am-addressing.js">annotate</a> |
<a href="/comm-central/diff/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/am-addressing.js">diff</a> |
<a href="/comm-central/comparison/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/am-addressing.js">comparison</a> |
<a href="/comm-central/log/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/am-addressing.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/am-archiveoptions.js">mailnews/base/prefs/content/am-archiveoptions.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/am-archiveoptions.js">file</a> |
<a href="/comm-central/annotate/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/am-archiveoptions.js">annotate</a> |
<a href="/comm-central/diff/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/am-archiveoptions.js">diff</a> |
<a href="/comm-central/comparison/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/am-archiveoptions.js">comparison</a> |
<a href="/comm-central/log/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/am-archiveoptions.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/am-copies.js">mailnews/base/prefs/content/am-copies.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/am-copies.js">file</a> |
<a href="/comm-central/annotate/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/am-copies.js">annotate</a> |
<a href="/comm-central/diff/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/am-copies.js">diff</a> |
<a href="/comm-central/comparison/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/am-copies.js">comparison</a> |
<a href="/comm-central/log/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/am-copies.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/am-identities-list.js">mailnews/base/prefs/content/am-identities-list.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/am-identities-list.js">file</a> |
<a href="/comm-central/annotate/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/am-identities-list.js">annotate</a> |
<a href="/comm-central/diff/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/am-identities-list.js">diff</a> |
<a href="/comm-central/comparison/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/am-identities-list.js">comparison</a> |
<a href="/comm-central/log/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/am-identities-list.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/am-identity-edit.js">mailnews/base/prefs/content/am-identity-edit.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/am-identity-edit.js">file</a> |
<a href="/comm-central/annotate/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/am-identity-edit.js">annotate</a> |
<a href="/comm-central/diff/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/am-identity-edit.js">diff</a> |
<a href="/comm-central/comparison/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/am-identity-edit.js">comparison</a> |
<a href="/comm-central/log/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/am-identity-edit.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/am-main.js">mailnews/base/prefs/content/am-main.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/am-main.js">file</a> |
<a href="/comm-central/annotate/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/am-main.js">annotate</a> |
<a href="/comm-central/diff/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/am-main.js">diff</a> |
<a href="/comm-central/comparison/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/am-main.js">comparison</a> |
<a href="/comm-central/log/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/am-main.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/am-offline.js">mailnews/base/prefs/content/am-offline.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/am-offline.js">file</a> |
<a href="/comm-central/annotate/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/am-offline.js">annotate</a> |
<a href="/comm-central/diff/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/am-offline.js">diff</a> |
<a href="/comm-central/comparison/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/am-offline.js">comparison</a> |
<a href="/comm-central/log/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/am-offline.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/am-server-advanced.js">mailnews/base/prefs/content/am-server-advanced.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/am-server-advanced.js">file</a> |
<a href="/comm-central/annotate/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/am-server-advanced.js">annotate</a> |
<a href="/comm-central/diff/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/am-server-advanced.js">diff</a> |
<a href="/comm-central/comparison/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/am-server-advanced.js">comparison</a> |
<a href="/comm-central/log/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/am-server-advanced.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/am-server.js">mailnews/base/prefs/content/am-server.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/am-server.js">file</a> |
<a href="/comm-central/annotate/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/am-server.js">annotate</a> |
<a href="/comm-central/diff/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/am-server.js">diff</a> |
<a href="/comm-central/comparison/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/am-server.js">comparison</a> |
<a href="/comm-central/log/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/am-server.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/am-serverwithnoidentities.js">mailnews/base/prefs/content/am-serverwithnoidentities.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/am-serverwithnoidentities.js">file</a> |
<a href="/comm-central/annotate/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/am-serverwithnoidentities.js">annotate</a> |
<a href="/comm-central/diff/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/am-serverwithnoidentities.js">diff</a> |
<a href="/comm-central/comparison/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/am-serverwithnoidentities.js">comparison</a> |
<a href="/comm-central/log/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/am-serverwithnoidentities.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/am-smtp.js">mailnews/base/prefs/content/am-smtp.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/am-smtp.js">file</a> |
<a href="/comm-central/annotate/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/am-smtp.js">annotate</a> |
<a href="/comm-central/diff/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/am-smtp.js">diff</a> |
<a href="/comm-central/comparison/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/am-smtp.js">comparison</a> |
<a href="/comm-central/log/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/am-smtp.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/amUtils.js">mailnews/base/prefs/content/amUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/amUtils.js">file</a> |
<a href="/comm-central/annotate/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/amUtils.js">annotate</a> |
<a href="/comm-central/diff/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/amUtils.js">diff</a> |
<a href="/comm-central/comparison/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/amUtils.js">comparison</a> |
<a href="/comm-central/log/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/base/prefs/content/amUtils.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/extensions/newsblog/content/newsblogOverlay.js">mailnews/extensions/newsblog/content/newsblogOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/extensions/newsblog/content/newsblogOverlay.js">file</a> |
<a href="/comm-central/annotate/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/extensions/newsblog/content/newsblogOverlay.js">annotate</a> |
<a href="/comm-central/diff/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/extensions/newsblog/content/newsblogOverlay.js">diff</a> |
<a href="/comm-central/comparison/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/extensions/newsblog/content/newsblogOverlay.js">comparison</a> |
<a href="/comm-central/log/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/extensions/newsblog/content/newsblogOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/extensions/smime/content/am-smime.js">mailnews/extensions/smime/content/am-smime.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/extensions/smime/content/am-smime.js">file</a> |
<a href="/comm-central/annotate/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/extensions/smime/content/am-smime.js">annotate</a> |
<a href="/comm-central/diff/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/extensions/smime/content/am-smime.js">diff</a> |
<a href="/comm-central/comparison/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/extensions/smime/content/am-smime.js">comparison</a> |
<a href="/comm-central/log/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/extensions/smime/content/am-smime.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/extensions/smime/content/msgReadSMIMEOverlay.js">mailnews/extensions/smime/content/msgReadSMIMEOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/extensions/smime/content/msgReadSMIMEOverlay.js">file</a> |
<a href="/comm-central/annotate/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/extensions/smime/content/msgReadSMIMEOverlay.js">annotate</a> |
<a href="/comm-central/diff/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/extensions/smime/content/msgReadSMIMEOverlay.js">diff</a> |
<a href="/comm-central/comparison/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/extensions/smime/content/msgReadSMIMEOverlay.js">comparison</a> |
<a href="/comm-central/log/2dbbeabc26b14bb277b1ef2e4203a3f373009298/mailnews/extensions/smime/content/msgReadSMIMEOverlay.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/components/AboutRedirector.jsm</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/components/AboutRedirector.jsm</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -35,16 +35,20 @@ AboutRedirector.prototype = {</span>
<a href="#l1.4"></a><span id="l1.4">     downloads: {</span>
<a href="#l1.5"></a><span id="l1.5">       url: &quot;chrome://messenger/content/downloads/aboutDownloads.xhtml&quot;,</span>
<a href="#l1.6"></a><span id="l1.6">       flags: Ci.nsIAboutModule.ALLOW_SCRIPT,</span>
<a href="#l1.7"></a><span id="l1.7">     },</span>
<a href="#l1.8"></a><span id="l1.8">     policies: {</span>
<a href="#l1.9"></a><span id="l1.9">       url: &quot;chrome://messenger/content/policies/aboutPolicies.xhtml&quot;,</span>
<a href="#l1.10"></a><span id="l1.10">       flags: Ci.nsIAboutModule.ALLOW_SCRIPT,</span>
<a href="#l1.11"></a><span id="l1.11">     },</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+    accountsettings: {</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+      url: &quot;chrome://messenger/content/AccountManager.xhtml&quot;,</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+      flags: Ci.nsIAboutModule.ALLOW_SCRIPT,</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+    },</span>
<a href="#l1.16"></a><span id="l1.16">   },</span>
<a href="#l1.17"></a><span id="l1.17"> </span>
<a href="#l1.18"></a><span id="l1.18">   /**</span>
<a href="#l1.19"></a><span id="l1.19">    * Gets the module name from the given URI.</span>
<a href="#l1.20"></a><span id="l1.20">    */</span>
<a href="#l1.21"></a><span id="l1.21">   _getModuleName(aURI) {</span>
<a href="#l1.22"></a><span id="l1.22">     // Strip out the first ? or #, and anything following it</span>
<a href="#l1.23"></a><span id="l1.23">     let name = /[^?#]+/.exec(aURI.pathQueryRef)[0];</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/components/accountcreation/content/emailWizard.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/components/accountcreation/content/emailWizard.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -1861,30 +1861,17 @@ EmailConfigWizard.prototype = {</span>
<a href="#l2.4"></a><span id="l2.4">       )</span>
<a href="#l2.5"></a><span id="l2.5">     ) {</span>
<a href="#l2.6"></a><span id="l2.6">       return;</span>
<a href="#l2.7"></a><span id="l2.7">     }</span>
<a href="#l2.8"></a><span id="l2.8"> </span>
<a href="#l2.9"></a><span id="l2.9">     gEmailWizardLogger.info(&quot;creating account in backend&quot;);</span>
<a href="#l2.10"></a><span id="l2.10">     let newAccount = createAccountInBackend(configFilledIn);</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-    let existingAccountManager = Services.wm.getMostRecentWindow(</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-      &quot;mailnews:accountmanager&quot;</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-    );</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineminus">-    if (existingAccountManager) {</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineminus">-      existingAccountManager.focus();</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineminus">-    } else {</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineminus">-      window.openDialog(</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineminus">-        &quot;chrome://messenger/content/AccountManager.xhtml&quot;,</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineminus">-        &quot;AccountManager&quot;,</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineminus">-        &quot;chrome,centerscreen,modal,titlebar&quot;,</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineminus">-        { server: newAccount.incomingServer, selectPage: &quot;am-server.xhtml&quot; }</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineminus">-      );</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineminus">-    }</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineminus">-    window.close();</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineplus">+    MsgAccountManager(&quot;am-server.xhtml&quot;, newAccount.incomingServer);</span>
<a href="#l2.27"></a><span id="l2.27">   },</span>
<a href="#l2.28"></a><span id="l2.28"> </span>
<a href="#l2.29"></a><span id="l2.29">   /**</span>
<a href="#l2.30"></a><span id="l2.30">    * [Re-test] button click handler.</span>
<a href="#l2.31"></a><span id="l2.31">    * Restarts the config guessing process after a person editing the server</span>
<a href="#l2.32"></a><span id="l2.32">    * fields.</span>
<a href="#l2.33"></a><span id="l2.33">    * It's called &quot;half-manual&quot;, because we take the user-entered values</span>
<a href="#l2.34"></a><span id="l2.34">    * as given and will not second-guess them, to respect the user wishes.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/components/components.conf</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/components/components.conf</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -7,17 +7,18 @@</span>
<a href="#l3.4"></a><span id="l3.4"> Classes = [</span>
<a href="#l3.5"></a><span id="l3.5">   {</span>
<a href="#l3.6"></a><span id="l3.6">     'cid': '{8cc51368-6aa0-43e8-b762-bde9b9fd828c}',</span>
<a href="#l3.7"></a><span id="l3.7">     'contract_ids': [</span>
<a href="#l3.8"></a><span id="l3.8">       '@mozilla.org/network/protocol/about;1?what=newserror',</span>
<a href="#l3.9"></a><span id="l3.9">       '@mozilla.org/network/protocol/about;1?what=rights',</span>
<a href="#l3.10"></a><span id="l3.10">       '@mozilla.org/network/protocol/about;1?what=preferences',</span>
<a href="#l3.11"></a><span id="l3.11">       '@mozilla.org/network/protocol/about;1?what=downloads',</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-      '@mozilla.org/network/protocol/about;1?what=policies'</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+      '@mozilla.org/network/protocol/about;1?what=policies',</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+      '@mozilla.org/network/protocol/about;1?what=accountsettings'</span>
<a href="#l3.15"></a><span id="l3.15">     ],</span>
<a href="#l3.16"></a><span id="l3.16">     'jsm': 'resource://gre/modules/AboutRedirector.jsm',</span>
<a href="#l3.17"></a><span id="l3.17">     'constructor': 'AboutRedirector',</span>
<a href="#l3.18"></a><span id="l3.18">   },</span>
<a href="#l3.19"></a><span id="l3.19">   {</span>
<a href="#l3.20"></a><span id="l3.20">     'cid': '{eb239c82-fac9-431e-98d7-11cacd0f71b8}',</span>
<a href="#l3.21"></a><span id="l3.21">     'contract_ids': ['@mozilla.org/mail/mailglue;1'],</span>
<a href="#l3.22"></a><span id="l3.22">     'jsm': 'resource://gre/modules/MailGlue.jsm',</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/components/im/content/am-im.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/components/im/content/am-im.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -134,16 +134,16 @@ var account = {</span>
<a href="#l4.4"></a><span id="l4.4">       // properties that don't exist when restoring values.</span>
<a href="#l4.5"></a><span id="l4.5">       document.getElementById(&quot;protoSpecific&quot;).getBoundingClientRect();</span>
<a href="#l4.6"></a><span id="l4.6">     } else if (!haveOptions) {</span>
<a href="#l4.7"></a><span id="l4.7">       advanced.hidden = true;</span>
<a href="#l4.8"></a><span id="l4.8">     }</span>
<a href="#l4.9"></a><span id="l4.9">   },</span>
<a href="#l4.10"></a><span id="l4.10"> </span>
<a href="#l4.11"></a><span id="l4.11">   viewFingerprintKeys() {</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-    window.openDialog(</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+    window.docShell.rootTreeItem.domWindow.openDialog(</span>
<a href="#l4.14"></a><span id="l4.14">       &quot;chrome://chat/content/otr-finger.xhtml&quot;,</span>
<a href="#l4.15"></a><span id="l4.15">       &quot;&quot;,</span>
<a href="#l4.16"></a><span id="l4.16">       &quot;chrome,modal,titlebar,centerscreen&quot;,</span>
<a href="#l4.17"></a><span id="l4.17">       this.account</span>
<a href="#l4.18"></a><span id="l4.18">     );</span>
<a href="#l4.19"></a><span id="l4.19">   },</span>
<a href="#l4.20"></a><span id="l4.20"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/components/im/content/imAccounts.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/components/im/content/imAccounts.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -1,15 +1,15 @@</span>
<a href="#l5.4"></a><span id="l5.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l5.5"></a><span id="l5.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l5.6"></a><span id="l5.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l5.7"></a><span id="l5.7"> </span>
<a href="#l5.8"></a><span id="l5.8"> /* globals MozElements */</span>
<a href="#l5.9"></a><span id="l5.9" class="difflineminus">-// imStatusSelector.js</span>
<a href="#l5.10"></a><span id="l5.10"> /* globals statusSelector */</span>
<a href="#l5.11"></a><span id="l5.11" class="difflineplus">+/* globals MsgAccountManager */</span>
<a href="#l5.12"></a><span id="l5.12"> </span>
<a href="#l5.13"></a><span id="l5.13"> var { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l5.14"></a><span id="l5.14"> var { fixIterator } = ChromeUtils.import(</span>
<a href="#l5.15"></a><span id="l5.15">   &quot;resource:///modules/iteratorUtils.jsm&quot;</span>
<a href="#l5.16"></a><span id="l5.16"> );</span>
<a href="#l5.17"></a><span id="l5.17"> var { MailServices } = ChromeUtils.import(</span>
<a href="#l5.18"></a><span id="l5.18">   &quot;resource:///modules/MailServices.jsm&quot;</span>
<a href="#l5.19"></a><span id="l5.19"> );</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineat">@@ -371,28 +371,17 @@ var gAccountManager = {</span>
<a href="#l5.21"></a><span id="l5.21">         continue;</span>
<a href="#l5.22"></a><span id="l5.22">       }</span>
<a href="#l5.23"></a><span id="l5.23">       if (incomingServer.wrappedJSObject.imAccount.numericId == imAccountId) {</span>
<a href="#l5.24"></a><span id="l5.24">         server = incomingServer;</span>
<a href="#l5.25"></a><span id="l5.25">         break;</span>
<a href="#l5.26"></a><span id="l5.26">       }</span>
<a href="#l5.27"></a><span id="l5.27">     }</span>
<a href="#l5.28"></a><span id="l5.28"> </span>
<a href="#l5.29"></a><span id="l5.29" class="difflineminus">-    let win = Services.wm.getMostRecentWindow(&quot;mailnews:accountmanager&quot;);</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineminus">-    if (win) {</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineminus">-      win.focus();</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineminus">-      win.selectServer(server);</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineminus">-    } else {</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineminus">-      window.openDialog(</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineminus">-        &quot;chrome://messenger/content/AccountManager.xhtml&quot;,</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineminus">-        &quot;AccountManager&quot;,</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineminus">-        &quot;chrome,centerscreen,modal,titlebar,resizable&quot;,</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineminus">-        { server, selectPage: null }</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineminus">-      );</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineminus">-    }</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineplus">+    MsgAccountManager(null, server);</span>
<a href="#l5.42"></a><span id="l5.42">   },</span>
<a href="#l5.43"></a><span id="l5.43">   autologin() {</span>
<a href="#l5.44"></a><span id="l5.44">     var elt = this.accountList.selectedItem;</span>
<a href="#l5.45"></a><span id="l5.45">     elt.autoLogin = !elt.autoLogin;</span>
<a href="#l5.46"></a><span id="l5.46">   },</span>
<a href="#l5.47"></a><span id="l5.47">   close() {</span>
<a href="#l5.48"></a><span id="l5.48">     // If a modal dialog is opened, we can't close this window now</span>
<a href="#l5.49"></a><span id="l5.49">     if (this.modalDialog) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/components/newmailaccount/content/accountProvisioner.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/components/newmailaccount/content/accountProvisioner.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -1,12 +1,14 @@</span>
<a href="#l6.4"></a><span id="l6.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l6.5"></a><span id="l6.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l6.6"></a><span id="l6.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l6.7"></a><span id="l6.7"> </span>
<a href="#l6.8"></a><span id="l6.8" class="difflineplus">+/* globals MsgAccountManager */</span>
<a href="#l6.9"></a><span id="l6.9" class="difflineplus">+</span>
<a href="#l6.10"></a><span id="l6.10"> var { AppConstants } = ChromeUtils.import(</span>
<a href="#l6.11"></a><span id="l6.11">   &quot;resource://gre/modules/AppConstants.jsm&quot;</span>
<a href="#l6.12"></a><span id="l6.12"> );</span>
<a href="#l6.13"></a><span id="l6.13"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l6.14"></a><span id="l6.14"> var { XPCOMUtils } = ChromeUtils.import(</span>
<a href="#l6.15"></a><span id="l6.15">   &quot;resource://gre/modules/XPCOMUtils.jsm&quot;</span>
<a href="#l6.16"></a><span id="l6.16"> );</span>
<a href="#l6.17"></a><span id="l6.17"> var { PluralForm } = ChromeUtils.import(</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineat">@@ -204,30 +206,17 @@ var EmailAccountProvisioner = {</span>
<a href="#l6.19"></a><span id="l6.19">       .getElementById(&quot;success-addons&quot;)</span>
<a href="#l6.20"></a><span id="l6.20">       .addEventListener(&quot;click&quot;, function() {</span>
<a href="#l6.21"></a><span id="l6.21">         EmailAccountProvisioner.openAddonsMgr();</span>
<a href="#l6.22"></a><span id="l6.22">       });</span>
<a href="#l6.23"></a><span id="l6.23"> </span>
<a href="#l6.24"></a><span id="l6.24">     document</span>
<a href="#l6.25"></a><span id="l6.25">       .getElementById(&quot;success-signature&quot;)</span>
<a href="#l6.26"></a><span id="l6.26">       .addEventListener(&quot;click&quot;, function() {</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineminus">-        var existingAccountManager = Services.wm.getMostRecentWindow(</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineminus">-          &quot;mailnews:accountmanager&quot;</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineminus">-        );</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineminus">-</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">-        if (existingAccountManager) {</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineminus">-          existingAccountManager.focus();</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineminus">-        } else {</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineminus">-          window.openDialog(</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineminus">-            &quot;chrome://messenger/content/AccountManager.xhtml&quot;,</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineminus">-            &quot;AccountManager&quot;,</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineminus">-            &quot;chrome,centerscreen,modal,titlebar&quot;,</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineminus">-            { server: account.incomingServer }</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineminus">-          );</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineminus">-        }</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineplus">+        MsgAccountManager(null, account.incomingServer);</span>
<a href="#l6.42"></a><span id="l6.42">       });</span>
<a href="#l6.43"></a><span id="l6.43"> </span>
<a href="#l6.44"></a><span id="l6.44">     document.getElementById(&quot;window&quot;).style.display = &quot;none&quot;;</span>
<a href="#l6.45"></a><span id="l6.45">     document.getElementById(&quot;successful_account&quot;).style.display = &quot;block&quot;;</span>
<a href="#l6.46"></a><span id="l6.46">   },</span>
<a href="#l6.47"></a><span id="l6.47"> </span>
<a href="#l6.48"></a><span id="l6.48">   /**</span>
<a href="#l6.49"></a><span id="l6.49">    * Save the name entered into the search field to a pref, so we can</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mail/components/newmailaccount/content/uriListener.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mail/components/newmailaccount/content/uriListener.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -1,13 +1,12 @@</span>
<a href="#l7.4"></a><span id="l7.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l7.5"></a><span id="l7.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l7.6"></a><span id="l7.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l7.7"></a><span id="l7.7"> </span>
<a href="#l7.8"></a><span id="l7.8" class="difflineminus">-// mailnews/base/prefs/content/accountUtils.js</span>
<a href="#l7.9"></a><span id="l7.9"> /* globals NewMailAccountProvisioner */</span>
<a href="#l7.10"></a><span id="l7.10"> </span>
<a href="#l7.11"></a><span id="l7.11"> /**</span>
<a href="#l7.12"></a><span id="l7.12">  * This object takes care of intercepting page loads and creating the</span>
<a href="#l7.13"></a><span id="l7.13">  * corresponding account if the page load turns out to be a text/xml file from</span>
<a href="#l7.14"></a><span id="l7.14">  * one of our account providers.</span>
<a href="#l7.15"></a><span id="l7.15">  */</span>
<a href="#l7.16"></a><span id="l7.16"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mail/test/browser/account/browser_abWhitelist.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mail/test/browser/account/browser_abWhitelist.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -8,16 +8,19 @@ var mozmill = ChromeUtils.import(</span>
<a href="#l8.4"></a><span id="l8.4">   &quot;resource://testing-common/mozmill/mozmill.jsm&quot;</span>
<a href="#l8.5"></a><span id="l8.5"> );</span>
<a href="#l8.6"></a><span id="l8.6"> var controller = ChromeUtils.import(</span>
<a href="#l8.7"></a><span id="l8.7">   &quot;resource://testing-common/mozmill/controller.jsm&quot;</span>
<a href="#l8.8"></a><span id="l8.8"> );</span>
<a href="#l8.9"></a><span id="l8.9"> var elib = ChromeUtils.import(</span>
<a href="#l8.10"></a><span id="l8.10">   &quot;resource://testing-common/mozmill/elementslib.jsm&quot;</span>
<a href="#l8.11"></a><span id="l8.11"> );</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+var { mc } = ChromeUtils.import(</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+  &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+);</span>
<a href="#l8.15"></a><span id="l8.15"> </span>
<a href="#l8.16"></a><span id="l8.16"> var {</span>
<a href="#l8.17"></a><span id="l8.17">   click_account_tree_row,</span>
<a href="#l8.18"></a><span id="l8.18">   get_account_tree_row,</span>
<a href="#l8.19"></a><span id="l8.19">   open_advanced_settings,</span>
<a href="#l8.20"></a><span id="l8.20"> } = ChromeUtils.import(</span>
<a href="#l8.21"></a><span id="l8.21">   &quot;resource://testing-common/mozmill/AccountManagerHelpers.jsm&quot;</span>
<a href="#l8.22"></a><span id="l8.22"> );</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineat">@@ -48,85 +51,90 @@ add_task(function setupModule(module) {</span>
<a href="#l8.24"></a><span id="l8.24">   gOldWhiteList = Services.prefs.getCharPref(gKeyString);</span>
<a href="#l8.25"></a><span id="l8.25">   Services.prefs.setCharPref(gKeyString, &quot;&quot;);</span>
<a href="#l8.26"></a><span id="l8.26"> });</span>
<a href="#l8.27"></a><span id="l8.27"> </span>
<a href="#l8.28"></a><span id="l8.28"> registerCleanupFunction(function teardownModule(module) {</span>
<a href="#l8.29"></a><span id="l8.29">   Services.prefs.setCharPref(gKeyString, gOldWhiteList);</span>
<a href="#l8.30"></a><span id="l8.30"> });</span>
<a href="#l8.31"></a><span id="l8.31"> </span>
<a href="#l8.32"></a><span id="l8.32" class="difflineminus">-/* First, test that when we initially load the account manager, that</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineplus">+/**</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineplus">+ * First, test that when we initially load the account manager, that</span>
<a href="#l8.35"></a><span id="l8.35">  * we're not whitelisting any address books.  Then, we'll check all</span>
<a href="#l8.36"></a><span id="l8.36">  * address books and save.</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineplus">+ *</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineplus">+ * @param {Object} tab - The account manager tab.</span>
<a href="#l8.39"></a><span id="l8.39">  */</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineminus">-function subtest_check_whitelist_init_and_save(amc) {</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineplus">+function subtest_check_whitelist_init_and_save(tab) {</span>
<a href="#l8.42"></a><span id="l8.42">   // Ok, the advanced settings window is open.  Let's choose</span>
<a href="#l8.43"></a><span id="l8.43">   // the junkmail settings.</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineminus">-  let accountRow = get_account_tree_row(gAccount.key, &quot;am-junk.xhtml&quot;, amc);</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineminus">-  click_account_tree_row(amc, accountRow);</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineplus">+  let accountRow = get_account_tree_row(gAccount.key, &quot;am-junk.xhtml&quot;, tab);</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineplus">+  click_account_tree_row(tab, accountRow);</span>
<a href="#l8.48"></a><span id="l8.48"> </span>
<a href="#l8.49"></a><span id="l8.49" class="difflineminus">-  let doc = amc.window.document.getElementById(&quot;contentFrame&quot;).contentDocument;</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineplus">+  let doc = tab.browser.contentWindow.document.getElementById(&quot;contentFrame&quot;)</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineplus">+    .contentDocument;</span>
<a href="#l8.52"></a><span id="l8.52"> </span>
<a href="#l8.53"></a><span id="l8.53">   // At this point, we shouldn't have anything checked, but we should have</span>
<a href="#l8.54"></a><span id="l8.54">   // the two default address books (Personal and Collected) displayed</span>
<a href="#l8.55"></a><span id="l8.55">   let list = doc.getElementById(&quot;whiteListAbURI&quot;);</span>
<a href="#l8.56"></a><span id="l8.56">   Assert.equal(</span>
<a href="#l8.57"></a><span id="l8.57">     2,</span>
<a href="#l8.58"></a><span id="l8.58">     list.getRowCount(),</span>
<a href="#l8.59"></a><span id="l8.59">     &quot;There was an unexpected number of address books&quot;</span>
<a href="#l8.60"></a><span id="l8.60">   );</span>
<a href="#l8.61"></a><span id="l8.61"> </span>
<a href="#l8.62"></a><span id="l8.62">   // Now we'll check both address books</span>
<a href="#l8.63"></a><span id="l8.63">   for (let i = 0; i &lt; list.getRowCount(); i++) {</span>
<a href="#l8.64"></a><span id="l8.64">     let abNode = list.getItemAtIndex(i);</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineminus">-    amc.click(new elib.Elem(abNode.firstElementChild));</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineplus">+    mc.click(new elib.Elem(abNode.firstElementChild));</span>
<a href="#l8.67"></a><span id="l8.67">   }</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineminus">-</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineminus">-  // And close the dialog</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineminus">-  amc.window.document.getElementById(&quot;accountManager&quot;).acceptDialog();</span>
<a href="#l8.71"></a><span id="l8.71"> }</span>
<a href="#l8.72"></a><span id="l8.72"> </span>
<a href="#l8.73"></a><span id="l8.73" class="difflineminus">-/* Next, we'll make sure that the address books we checked in</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineplus">+/**</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineplus">+ * Next, we'll make sure that the address books we checked in</span>
<a href="#l8.76"></a><span id="l8.76">  * subtest_check_whitelist_init_and_save were properly saved.</span>
<a href="#l8.77"></a><span id="l8.77">  * Then, we'll clear the address books and save.</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineplus">+ *</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineplus">+ * @param {Object} tab - The account manager tab.</span>
<a href="#l8.80"></a><span id="l8.80">  */</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineminus">-function subtest_check_whitelist_load_and_clear(amc) {</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineminus">-  let accountRow = get_account_tree_row(gAccount.key, &quot;am-junk.xhtml&quot;, amc);</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineminus">-  click_account_tree_row(amc, accountRow);</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineplus">+function subtest_check_whitelist_load_and_clear(tab) {</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineplus">+  let accountRow = get_account_tree_row(gAccount.key, &quot;am-junk.xhtml&quot;, tab);</span>
<a href="#l8.86"></a><span id="l8.86" class="difflineplus">+  click_account_tree_row(tab, accountRow);</span>
<a href="#l8.87"></a><span id="l8.87"> </span>
<a href="#l8.88"></a><span id="l8.88" class="difflineminus">-  let doc = amc.window.document.getElementById(&quot;contentFrame&quot;).contentDocument;</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineplus">+  let doc = tab.browser.contentWindow.document.getElementById(&quot;contentFrame&quot;)</span>
<a href="#l8.90"></a><span id="l8.90" class="difflineplus">+    .contentDocument;</span>
<a href="#l8.91"></a><span id="l8.91">   let list = doc.getElementById(&quot;whiteListAbURI&quot;);</span>
<a href="#l8.92"></a><span id="l8.92">   let whiteListURIs = Services.prefs.getCharPref(gKeyString).split(&quot; &quot;);</span>
<a href="#l8.93"></a><span id="l8.93"> </span>
<a href="#l8.94"></a><span id="l8.94">   for (let i = 0; i &lt; list.getRowCount(); i++) {</span>
<a href="#l8.95"></a><span id="l8.95">     let abNode = list.getItemAtIndex(i);</span>
<a href="#l8.96"></a><span id="l8.96">     Assert.equal(</span>
<a href="#l8.97"></a><span id="l8.97">       &quot;true&quot;,</span>
<a href="#l8.98"></a><span id="l8.98">       abNode.firstElementChild.getAttribute(&quot;checked&quot;),</span>
<a href="#l8.99"></a><span id="l8.99">       &quot;Should have been checked&quot;</span>
<a href="#l8.100"></a><span id="l8.100">     );</span>
<a href="#l8.101"></a><span id="l8.101">     // Also ensure that the address book URI was properly saved in the</span>
<a href="#l8.102"></a><span id="l8.102">     // prefs</span>
<a href="#l8.103"></a><span id="l8.103">     Assert.ok(whiteListURIs.includes(abNode.getAttribute(&quot;value&quot;)));</span>
<a href="#l8.104"></a><span id="l8.104">     // Now un-check that address book</span>
<a href="#l8.105"></a><span id="l8.105" class="difflineminus">-    amc.click(new elib.Elem(abNode.firstElementChild));</span>
<a href="#l8.106"></a><span id="l8.106" class="difflineplus">+    mc.click(new elib.Elem(abNode.firstElementChild));</span>
<a href="#l8.107"></a><span id="l8.107">   }</span>
<a href="#l8.108"></a><span id="l8.108" class="difflineminus">-</span>
<a href="#l8.109"></a><span id="l8.109" class="difflineminus">-  // And close the dialog</span>
<a href="#l8.110"></a><span id="l8.110" class="difflineminus">-  amc.window.document.getElementById(&quot;accountManager&quot;).acceptDialog();</span>
<a href="#l8.111"></a><span id="l8.111"> }</span>
<a href="#l8.112"></a><span id="l8.112"> </span>
<a href="#l8.113"></a><span id="l8.113" class="difflineminus">-/* Finally, we'll make sure that the address books we cleared</span>
<a href="#l8.114"></a><span id="l8.114" class="difflineplus">+/**</span>
<a href="#l8.115"></a><span id="l8.115" class="difflineplus">+ * Finally, we'll make sure that the address books we cleared</span>
<a href="#l8.116"></a><span id="l8.116">  * were actually cleared.</span>
<a href="#l8.117"></a><span id="l8.117" class="difflineplus">+ * @param {Object} tab - The account manager tab.</span>
<a href="#l8.118"></a><span id="l8.118">  */</span>
<a href="#l8.119"></a><span id="l8.119" class="difflineminus">-function subtest_check_whitelist_load_cleared(amc) {</span>
<a href="#l8.120"></a><span id="l8.120" class="difflineminus">-  let accountRow = get_account_tree_row(gAccount.key, &quot;am-junk.xhtml&quot;, amc);</span>
<a href="#l8.121"></a><span id="l8.121" class="difflineminus">-  click_account_tree_row(amc, accountRow);</span>
<a href="#l8.122"></a><span id="l8.122" class="difflineplus">+function subtest_check_whitelist_load_cleared(tab) {</span>
<a href="#l8.123"></a><span id="l8.123" class="difflineplus">+  let accountRow = get_account_tree_row(gAccount.key, &quot;am-junk.xhtml&quot;, tab);</span>
<a href="#l8.124"></a><span id="l8.124" class="difflineplus">+  click_account_tree_row(tab, accountRow);</span>
<a href="#l8.125"></a><span id="l8.125"> </span>
<a href="#l8.126"></a><span id="l8.126" class="difflineminus">-  let doc = amc.window.document.getElementById(&quot;contentFrame&quot;).contentDocument;</span>
<a href="#l8.127"></a><span id="l8.127" class="difflineplus">+  let doc = tab.browser.contentWindow.document.getElementById(&quot;contentFrame&quot;)</span>
<a href="#l8.128"></a><span id="l8.128" class="difflineplus">+    .contentDocument;</span>
<a href="#l8.129"></a><span id="l8.129">   let list = doc.getElementById(&quot;whiteListAbURI&quot;);</span>
<a href="#l8.130"></a><span id="l8.130">   let whiteListURIs = &quot;&quot;;</span>
<a href="#l8.131"></a><span id="l8.131"> </span>
<a href="#l8.132"></a><span id="l8.132">   try {</span>
<a href="#l8.133"></a><span id="l8.133">     whiteListURIs = Services.prefs.getCharPref(gKeyString);</span>
<a href="#l8.134"></a><span id="l8.134">     // We should have failed here, because the pref should have been cleared</span>
<a href="#l8.135"></a><span id="l8.135">     // out.</span>
<a href="#l8.136"></a><span id="l8.136">     throw Error(</span>
<a href="#l8.137"></a><span id="l8.137" class="difflineat">@@ -140,18 +148,15 @@ function subtest_check_whitelist_load_cl</span>
<a href="#l8.138"></a><span id="l8.138">       &quot;false&quot;,</span>
<a href="#l8.139"></a><span id="l8.139">       abNode.firstElementChild.getAttribute(&quot;checked&quot;),</span>
<a href="#l8.140"></a><span id="l8.140">       &quot;Should not have been checked&quot;</span>
<a href="#l8.141"></a><span id="l8.141">     );</span>
<a href="#l8.142"></a><span id="l8.142">     // Also ensure that the address book URI was properly cleared in the</span>
<a href="#l8.143"></a><span id="l8.143">     // prefs</span>
<a href="#l8.144"></a><span id="l8.144">     Assert.ok(!whiteListURIs.includes(abNode.getAttribute(&quot;value&quot;)));</span>
<a href="#l8.145"></a><span id="l8.145">   }</span>
<a href="#l8.146"></a><span id="l8.146" class="difflineminus">-</span>
<a href="#l8.147"></a><span id="l8.147" class="difflineminus">-  // And close the dialog</span>
<a href="#l8.148"></a><span id="l8.148" class="difflineminus">-  amc.window.document.getElementById(&quot;accountManager&quot;).acceptDialog();</span>
<a href="#l8.149"></a><span id="l8.149"> }</span>
<a href="#l8.150"></a><span id="l8.150"> </span>
<a href="#l8.151"></a><span id="l8.151"> add_task(function test_address_book_whitelist() {</span>
<a href="#l8.152"></a><span id="l8.152">   open_advanced_settings(subtest_check_whitelist_init_and_save);</span>
<a href="#l8.153"></a><span id="l8.153">   open_advanced_settings(subtest_check_whitelist_load_and_clear);</span>
<a href="#l8.154"></a><span id="l8.154">   open_advanced_settings(subtest_check_whitelist_load_cleared);</span>
<a href="#l8.155"></a><span id="l8.155"> });</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mail/test/browser/account/browser_actions.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mail/test/browser/account/browser_actions.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -10,16 +10,24 @@ var {</span>
<a href="#l9.4"></a><span id="l9.4">   open_advanced_settings,</span>
<a href="#l9.5"></a><span id="l9.5"> } = ChromeUtils.import(</span>
<a href="#l9.6"></a><span id="l9.6">   &quot;resource://testing-common/mozmill/AccountManagerHelpers.jsm&quot;</span>
<a href="#l9.7"></a><span id="l9.7"> );</span>
<a href="#l9.8"></a><span id="l9.8"> var { close_popup, wait_for_popup_to_open } = ChromeUtils.import(</span>
<a href="#l9.9"></a><span id="l9.9">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l9.10"></a><span id="l9.10"> );</span>
<a href="#l9.11"></a><span id="l9.11"> </span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+var { content_tab_e, content_tab_eid } = ChromeUtils.import(</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+  &quot;resource://testing-common/mozmill/ContentTabHelpers.jsm&quot;</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+);</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+var { mc } = ChromeUtils.import(</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+  &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineplus">+);</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineplus">+</span>
<a href="#l9.20"></a><span id="l9.20"> var { MailServices } = ChromeUtils.import(</span>
<a href="#l9.21"></a><span id="l9.21">   &quot;resource:///modules/MailServices.jsm&quot;</span>
<a href="#l9.22"></a><span id="l9.22"> );</span>
<a href="#l9.23"></a><span id="l9.23"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l9.24"></a><span id="l9.24"> </span>
<a href="#l9.25"></a><span id="l9.25"> var imapAccount, nntpAccount, originalAccountCount;</span>
<a href="#l9.26"></a><span id="l9.26"> </span>
<a href="#l9.27"></a><span id="l9.27"> add_task(function setupModule(module) {</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineat">@@ -65,126 +73,129 @@ registerCleanupFunction(function teardow</span>
<a href="#l9.29"></a><span id="l9.29">   MailServices.accounts.removeAccount(imapAccount);</span>
<a href="#l9.30"></a><span id="l9.30">   // There should be only the original accounts left.</span>
<a href="#l9.31"></a><span id="l9.31">   Assert.equal(MailServices.accounts.allServers.length, originalAccountCount);</span>
<a href="#l9.32"></a><span id="l9.32"> });</span>
<a href="#l9.33"></a><span id="l9.33"> </span>
<a href="#l9.34"></a><span id="l9.34"> /**</span>
<a href="#l9.35"></a><span id="l9.35">  * Check that the account actions for the account are enabled or disabled appropriately.</span>
<a href="#l9.36"></a><span id="l9.36">  *</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineminus">- * @param amc          the account options controller</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineminus">- * @param aAccountKey  the key of the account to select</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineminus">- * @param aIsSetAsDefaultEnabled  true if the menuitem should be enabled, false otherwise</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineminus">- * @param aIsRemoveEnabled        true if the menuitem should be enabled, false otherwise</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineminus">- * @param aIsAddAccountEnabled    true if the menuitems (Add Mail Account+Add Other Account)</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineminus">- *                                should be enabled, false otherwise</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineplus">+ * @param {Object} tab - The account manager tab.</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineplus">+ * @param {Number} accountKey - The key of the account to select.</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineplus">+ * @param {boolean} isSetAsDefaultEnabled - True if the menuitem should be enabled, false otherwise.</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineplus">+ * @param {boolean} isRemoveEnabled - True if the menuitem should be enabled, false otherwise.</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineplus">+ * @param {boolean} isAddAccountEnabled  - True if the menuitems (Add Mail Account+Add Other Account)</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineplus">+ *                                         should be enabled, false otherwise.</span>
<a href="#l9.49"></a><span id="l9.49">  */</span>
<a href="#l9.50"></a><span id="l9.50"> function subtest_check_account_actions(</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineminus">-  amc,</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineminus">-  aAccountKey,</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineminus">-  aIsSetAsDefaultEnabled,</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineminus">-  aIsRemoveEnabled,</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineminus">-  aIsAddAccountEnabled</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineplus">+  tab,</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineplus">+  accountKey,</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineplus">+  isSetAsDefaultEnabled,</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineplus">+  isRemoveEnabled,</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineplus">+  isAddAccountEnabled</span>
<a href="#l9.61"></a><span id="l9.61"> ) {</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineminus">-  let accountRow = get_account_tree_row(aAccountKey, null, amc);</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineminus">-  click_account_tree_row(amc, accountRow);</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineplus">+  let accountRow = get_account_tree_row(accountKey, null, tab);</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineplus">+  click_account_tree_row(tab, accountRow);</span>
<a href="#l9.66"></a><span id="l9.66"> </span>
<a href="#l9.67"></a><span id="l9.67">   // click the Actions Button to bring up the popup with menuitems to test</span>
<a href="#l9.68"></a><span id="l9.68" class="difflineminus">-  amc.click(amc.eid(&quot;accountActionsButton&quot;), 5, 5);</span>
<a href="#l9.69"></a><span id="l9.69" class="difflineminus">-  wait_for_popup_to_open(amc.e(&quot;accountActionsDropdown&quot;));</span>
<a href="#l9.70"></a><span id="l9.70" class="difflineplus">+  mc.click(content_tab_eid(tab, &quot;accountActionsButton&quot;), 5, 5);</span>
<a href="#l9.71"></a><span id="l9.71" class="difflineplus">+  wait_for_popup_to_open(content_tab_e(tab, &quot;accountActionsDropdown&quot;));</span>
<a href="#l9.72"></a><span id="l9.72"> </span>
<a href="#l9.73"></a><span id="l9.73" class="difflineminus">-  let actionAddMailAccount = amc.e(&quot;accountActionsAddMailAccount&quot;);</span>
<a href="#l9.74"></a><span id="l9.74" class="difflineplus">+  let actionAddMailAccount = content_tab_e(tab, &quot;accountActionsAddMailAccount&quot;);</span>
<a href="#l9.75"></a><span id="l9.75">   Assert.notEqual(actionAddMailAccount, undefined);</span>
<a href="#l9.76"></a><span id="l9.76">   Assert.equal(</span>
<a href="#l9.77"></a><span id="l9.77">     !actionAddMailAccount.getAttribute(&quot;disabled&quot;),</span>
<a href="#l9.78"></a><span id="l9.78" class="difflineminus">-    aIsAddAccountEnabled</span>
<a href="#l9.79"></a><span id="l9.79" class="difflineplus">+    isAddAccountEnabled</span>
<a href="#l9.80"></a><span id="l9.80">   );</span>
<a href="#l9.81"></a><span id="l9.81"> </span>
<a href="#l9.82"></a><span id="l9.82" class="difflineminus">-  let actionAddOtherAccount = amc.e(&quot;accountActionsAddOtherAccount&quot;);</span>
<a href="#l9.83"></a><span id="l9.83" class="difflineplus">+  let actionAddOtherAccount = content_tab_e(</span>
<a href="#l9.84"></a><span id="l9.84" class="difflineplus">+    tab,</span>
<a href="#l9.85"></a><span id="l9.85" class="difflineplus">+    &quot;accountActionsAddOtherAccount&quot;</span>
<a href="#l9.86"></a><span id="l9.86" class="difflineplus">+  );</span>
<a href="#l9.87"></a><span id="l9.87">   Assert.notEqual(actionAddOtherAccount, undefined);</span>
<a href="#l9.88"></a><span id="l9.88">   Assert.equal(</span>
<a href="#l9.89"></a><span id="l9.89">     !actionAddOtherAccount.getAttribute(&quot;disabled&quot;),</span>
<a href="#l9.90"></a><span id="l9.90" class="difflineminus">-    aIsAddAccountEnabled</span>
<a href="#l9.91"></a><span id="l9.91" class="difflineplus">+    isAddAccountEnabled</span>
<a href="#l9.92"></a><span id="l9.92">   );</span>
<a href="#l9.93"></a><span id="l9.93"> </span>
<a href="#l9.94"></a><span id="l9.94" class="difflineminus">-  let actionSetDefault = amc.e(&quot;accountActionsDropdownSetDefault&quot;);</span>
<a href="#l9.95"></a><span id="l9.95" class="difflineplus">+  let actionSetDefault = content_tab_e(tab, &quot;accountActionsDropdownSetDefault&quot;);</span>
<a href="#l9.96"></a><span id="l9.96">   Assert.notEqual(actionSetDefault, undefined);</span>
<a href="#l9.97"></a><span id="l9.97">   Assert.equal(</span>
<a href="#l9.98"></a><span id="l9.98">     !actionSetDefault.getAttribute(&quot;disabled&quot;),</span>
<a href="#l9.99"></a><span id="l9.99" class="difflineminus">-    aIsSetAsDefaultEnabled</span>
<a href="#l9.100"></a><span id="l9.100" class="difflineplus">+    isSetAsDefaultEnabled</span>
<a href="#l9.101"></a><span id="l9.101">   );</span>
<a href="#l9.102"></a><span id="l9.102"> </span>
<a href="#l9.103"></a><span id="l9.103" class="difflineminus">-  let actionRemove = amc.e(&quot;accountActionsDropdownRemove&quot;);</span>
<a href="#l9.104"></a><span id="l9.104" class="difflineplus">+  let actionRemove = content_tab_e(tab, &quot;accountActionsDropdownRemove&quot;);</span>
<a href="#l9.105"></a><span id="l9.105">   Assert.notEqual(actionRemove, undefined);</span>
<a href="#l9.106"></a><span id="l9.106" class="difflineminus">-  Assert.equal(!actionRemove.getAttribute(&quot;disabled&quot;), aIsRemoveEnabled);</span>
<a href="#l9.107"></a><span id="l9.107" class="difflineplus">+  Assert.equal(!actionRemove.getAttribute(&quot;disabled&quot;), isRemoveEnabled);</span>
<a href="#l9.108"></a><span id="l9.108"> </span>
<a href="#l9.109"></a><span id="l9.109" class="difflineminus">-  close_popup(amc, amc.eid(&quot;accountActionsDropdown&quot;));</span>
<a href="#l9.110"></a><span id="l9.110" class="difflineplus">+  close_popup(mc, content_tab_eid(tab, &quot;accountActionsDropdown&quot;));</span>
<a href="#l9.111"></a><span id="l9.111"> }</span>
<a href="#l9.112"></a><span id="l9.112"> </span>
<a href="#l9.113"></a><span id="l9.113"> add_task(function test_account_actions() {</span>
<a href="#l9.114"></a><span id="l9.114">   // IMAP account: can be default, can be removed.</span>
<a href="#l9.115"></a><span id="l9.115" class="difflineminus">-  open_advanced_settings(function(amc) {</span>
<a href="#l9.116"></a><span id="l9.116" class="difflineminus">-    subtest_check_account_actions(amc, imapAccount.key, true, true, true);</span>
<a href="#l9.117"></a><span id="l9.117" class="difflineplus">+  open_advanced_settings(function(tab) {</span>
<a href="#l9.118"></a><span id="l9.118" class="difflineplus">+    subtest_check_account_actions(tab, imapAccount.key, true, true, true);</span>
<a href="#l9.119"></a><span id="l9.119">   });</span>
<a href="#l9.120"></a><span id="l9.120"> </span>
<a href="#l9.121"></a><span id="l9.121">   // NNTP (News) account: can't be default, can be removed.</span>
<a href="#l9.122"></a><span id="l9.122" class="difflineminus">-  open_advanced_settings(function(amc) {</span>
<a href="#l9.123"></a><span id="l9.123" class="difflineminus">-    subtest_check_account_actions(amc, nntpAccount.key, false, true, true);</span>
<a href="#l9.124"></a><span id="l9.124" class="difflineplus">+  open_advanced_settings(function(tab) {</span>
<a href="#l9.125"></a><span id="l9.125" class="difflineplus">+    subtest_check_account_actions(tab, nntpAccount.key, false, true, true);</span>
<a href="#l9.126"></a><span id="l9.126">   });</span>
<a href="#l9.127"></a><span id="l9.127"> </span>
<a href="#l9.128"></a><span id="l9.128">   // Local Folders account: can't be removed, can't be default.</span>
<a href="#l9.129"></a><span id="l9.129">   var localFoldersAccount = MailServices.accounts.FindAccountForServer(</span>
<a href="#l9.130"></a><span id="l9.130">     MailServices.accounts.localFoldersServer</span>
<a href="#l9.131"></a><span id="l9.131">   );</span>
<a href="#l9.132"></a><span id="l9.132" class="difflineminus">-  open_advanced_settings(function(amc) {</span>
<a href="#l9.133"></a><span id="l9.133" class="difflineplus">+  open_advanced_settings(function(tab) {</span>
<a href="#l9.134"></a><span id="l9.134">     subtest_check_account_actions(</span>
<a href="#l9.135"></a><span id="l9.135" class="difflineminus">-      amc,</span>
<a href="#l9.136"></a><span id="l9.136" class="difflineplus">+      tab,</span>
<a href="#l9.137"></a><span id="l9.137">       localFoldersAccount.key,</span>
<a href="#l9.138"></a><span id="l9.138">       false,</span>
<a href="#l9.139"></a><span id="l9.139">       false,</span>
<a href="#l9.140"></a><span id="l9.140">       true</span>
<a href="#l9.141"></a><span id="l9.141">     );</span>
<a href="#l9.142"></a><span id="l9.142">   });</span>
<a href="#l9.143"></a><span id="l9.143">   // SMTP server row: can't be removed, can't be default.</span>
<a href="#l9.144"></a><span id="l9.144" class="difflineminus">-  open_advanced_settings(function(amc) {</span>
<a href="#l9.145"></a><span id="l9.145" class="difflineminus">-    subtest_check_account_actions(amc, null, false, false, true);</span>
<a href="#l9.146"></a><span id="l9.146" class="difflineplus">+  open_advanced_settings(function(tab) {</span>
<a href="#l9.147"></a><span id="l9.147" class="difflineplus">+    subtest_check_account_actions(tab, null, false, false, true);</span>
<a href="#l9.148"></a><span id="l9.148">   });</span>
<a href="#l9.149"></a><span id="l9.149"> </span>
<a href="#l9.150"></a><span id="l9.150">   // on the IMAP account, disable Delete Account menu item</span>
<a href="#l9.151"></a><span id="l9.151">   let disableItemPref = &quot;mail.disable_button.delete_account&quot;;</span>
<a href="#l9.152"></a><span id="l9.152"> </span>
<a href="#l9.153"></a><span id="l9.153">   // Set the pref on the default branch, otherwise .getBoolPref on it throws.</span>
<a href="#l9.154"></a><span id="l9.154">   Services.prefs.getDefaultBranch(&quot;&quot;).setBoolPref(disableItemPref, true);</span>
<a href="#l9.155"></a><span id="l9.155">   Services.prefs.lockPref(disableItemPref);</span>
<a href="#l9.156"></a><span id="l9.156"> </span>
<a href="#l9.157"></a><span id="l9.157" class="difflineminus">-  open_advanced_settings(function(amc) {</span>
<a href="#l9.158"></a><span id="l9.158" class="difflineminus">-    subtest_check_account_actions(amc, imapAccount.key, true, false, true);</span>
<a href="#l9.159"></a><span id="l9.159" class="difflineplus">+  open_advanced_settings(function(tab) {</span>
<a href="#l9.160"></a><span id="l9.160" class="difflineplus">+    subtest_check_account_actions(tab, imapAccount.key, true, false, true);</span>
<a href="#l9.161"></a><span id="l9.161">   });</span>
<a href="#l9.162"></a><span id="l9.162"> </span>
<a href="#l9.163"></a><span id="l9.163">   Services.prefs.unlockPref(disableItemPref);</span>
<a href="#l9.164"></a><span id="l9.164">   Services.prefs.getDefaultBranch(&quot;&quot;).deleteBranch(disableItemPref);</span>
<a href="#l9.165"></a><span id="l9.165"> </span>
<a href="#l9.166"></a><span id="l9.166">   // on the IMAP account, disable Set as Default menu item</span>
<a href="#l9.167"></a><span id="l9.167">   disableItemPref = &quot;mail.disable_button.set_default_account&quot;;</span>
<a href="#l9.168"></a><span id="l9.168"> </span>
<a href="#l9.169"></a><span id="l9.169">   Services.prefs.getDefaultBranch(&quot;&quot;).setBoolPref(disableItemPref, true);</span>
<a href="#l9.170"></a><span id="l9.170">   Services.prefs.lockPref(disableItemPref);</span>
<a href="#l9.171"></a><span id="l9.171"> </span>
<a href="#l9.172"></a><span id="l9.172" class="difflineminus">-  open_advanced_settings(function(amc) {</span>
<a href="#l9.173"></a><span id="l9.173" class="difflineminus">-    subtest_check_account_actions(amc, imapAccount.key, false, true, true);</span>
<a href="#l9.174"></a><span id="l9.174" class="difflineplus">+  open_advanced_settings(function(tab) {</span>
<a href="#l9.175"></a><span id="l9.175" class="difflineplus">+    subtest_check_account_actions(tab, imapAccount.key, false, true, true);</span>
<a href="#l9.176"></a><span id="l9.176">   });</span>
<a href="#l9.177"></a><span id="l9.177"> </span>
<a href="#l9.178"></a><span id="l9.178">   Services.prefs.unlockPref(disableItemPref);</span>
<a href="#l9.179"></a><span id="l9.179">   Services.prefs.getDefaultBranch(&quot;&quot;).deleteBranch(disableItemPref);</span>
<a href="#l9.180"></a><span id="l9.180"> </span>
<a href="#l9.181"></a><span id="l9.181">   // on the IMAP account, disable Add new Account menu items</span>
<a href="#l9.182"></a><span id="l9.182">   disableItemPref = &quot;mail.disable_new_account_addition&quot;;</span>
<a href="#l9.183"></a><span id="l9.183"> </span>
<a href="#l9.184"></a><span id="l9.184">   Services.prefs.getDefaultBranch(&quot;&quot;).setBoolPref(disableItemPref, true);</span>
<a href="#l9.185"></a><span id="l9.185">   Services.prefs.lockPref(disableItemPref);</span>
<a href="#l9.186"></a><span id="l9.186"> </span>
<a href="#l9.187"></a><span id="l9.187" class="difflineminus">-  open_advanced_settings(function(amc) {</span>
<a href="#l9.188"></a><span id="l9.188" class="difflineminus">-    subtest_check_account_actions(amc, imapAccount.key, true, true, false);</span>
<a href="#l9.189"></a><span id="l9.189" class="difflineplus">+  open_advanced_settings(function(tab) {</span>
<a href="#l9.190"></a><span id="l9.190" class="difflineplus">+    subtest_check_account_actions(tab, imapAccount.key, true, true, false);</span>
<a href="#l9.191"></a><span id="l9.191">   });</span>
<a href="#l9.192"></a><span id="l9.192"> </span>
<a href="#l9.193"></a><span id="l9.193">   Services.prefs.unlockPref(disableItemPref);</span>
<a href="#l9.194"></a><span id="l9.194">   Services.prefs.getDefaultBranch(&quot;&quot;).deleteBranch(disableItemPref);</span>
<a href="#l9.195"></a><span id="l9.195"> });</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mail/test/browser/account/browser_archiveOptions.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mail/test/browser/account/browser_archiveOptions.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -40,25 +40,27 @@ var defaultIdentity;</span>
<a href="#l10.4"></a><span id="l10.4"> </span>
<a href="#l10.5"></a><span id="l10.5"> add_task(function setupModule(module) {</span>
<a href="#l10.6"></a><span id="l10.6">   defaultIdentity = MailServices.accounts.defaultAccount.defaultIdentity;</span>
<a href="#l10.7"></a><span id="l10.7"> });</span>
<a href="#l10.8"></a><span id="l10.8"> </span>
<a href="#l10.9"></a><span id="l10.9"> /**</span>
<a href="#l10.10"></a><span id="l10.10">  * Check that the archive options button is enabled or disabled appropriately.</span>
<a href="#l10.11"></a><span id="l10.11">  *</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">- * @param amc          the account options controller</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">- * @param aAccountKey  key of the account the check</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineminus">- * @param isEnabled    true if the button should be enabled, false otherwise</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineplus">+ * @param {Object} tab - The account manager tab.</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+ * @param {Number} accountKey - Key of the account the check.</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineplus">+ * @param {boolean} isEnabled - True if the button should be enabled, false otherwise.</span>
<a href="#l10.18"></a><span id="l10.18">  */</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineminus">-function subtest_check_archive_options_enabled(amc, aAccountKey, isEnabled) {</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineminus">-  let accountRow = get_account_tree_row(aAccountKey, &quot;am-copies.xhtml&quot;, amc);</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineminus">-  click_account_tree_row(amc, accountRow);</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineplus">+function subtest_check_archive_options_enabled(tab, accountKey, isEnabled) {</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineplus">+  let accountRow = get_account_tree_row(accountKey, &quot;am-copies.xhtml&quot;, tab);</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineplus">+  click_account_tree_row(tab, accountRow);</span>
<a href="#l10.25"></a><span id="l10.25"> </span>
<a href="#l10.26"></a><span id="l10.26" class="difflineminus">-  let iframe = amc.window.document.getElementById(&quot;contentFrame&quot;);</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineplus">+  let iframe = tab.browser.contentWindow.document.getElementById(</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineplus">+    &quot;contentFrame&quot;</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineplus">+  );</span>
<a href="#l10.30"></a><span id="l10.30">   let button = iframe.contentDocument.getElementById(&quot;archiveHierarchyButton&quot;);</span>
<a href="#l10.31"></a><span id="l10.31"> </span>
<a href="#l10.32"></a><span id="l10.32">   Assert.equal(button.disabled, !isEnabled);</span>
<a href="#l10.33"></a><span id="l10.33"> }</span>
<a href="#l10.34"></a><span id="l10.34"> </span>
<a href="#l10.35"></a><span id="l10.35"> add_task(function test_archive_options_enabled() {</span>
<a href="#l10.36"></a><span id="l10.36">   let defaultAccount = MailServices.accounts.defaultAccount;</span>
<a href="#l10.37"></a><span id="l10.37">   // First, create an IMAP server</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineat">@@ -77,29 +79,29 @@ add_task(function test_archive_options_e</span>
<a href="#l10.39"></a><span id="l10.39"> </span>
<a href="#l10.40"></a><span id="l10.40">   // Let the default identity archive to our IMAP folder, to ensure that the</span>
<a href="#l10.41"></a><span id="l10.41">   // archive folder's server is used to determine the enabled/disabled state</span>
<a href="#l10.42"></a><span id="l10.42">   // of the &quot;archive options&quot; button, *not* the incoming server for that</span>
<a href="#l10.43"></a><span id="l10.43">   // identity.</span>
<a href="#l10.44"></a><span id="l10.44">   defaultIdentity.archiveFolder = imapServer.rootFolder.URI;</span>
<a href="#l10.45"></a><span id="l10.45"> </span>
<a href="#l10.46"></a><span id="l10.46">   imapServer.isGMailServer = false;</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineminus">-  open_advanced_settings(function(amc) {</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineminus">-    subtest_check_archive_options_enabled(amc, account.key, true);</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineplus">+  open_advanced_settings(function(tab) {</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineplus">+    subtest_check_archive_options_enabled(tab, account.key, true);</span>
<a href="#l10.51"></a><span id="l10.51">   });</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineminus">-  open_advanced_settings(function(amc) {</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineminus">-    subtest_check_archive_options_enabled(amc, defaultAccount.key, true);</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineplus">+  open_advanced_settings(function(tab) {</span>
<a href="#l10.55"></a><span id="l10.55" class="difflineplus">+    subtest_check_archive_options_enabled(tab, defaultAccount.key, true);</span>
<a href="#l10.56"></a><span id="l10.56">   });</span>
<a href="#l10.57"></a><span id="l10.57"> </span>
<a href="#l10.58"></a><span id="l10.58">   imapServer.isGMailServer = true;</span>
<a href="#l10.59"></a><span id="l10.59" class="difflineminus">-  open_advanced_settings(function(amc) {</span>
<a href="#l10.60"></a><span id="l10.60" class="difflineminus">-    subtest_check_archive_options_enabled(amc, account.key, false);</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineplus">+  open_advanced_settings(function(tab) {</span>
<a href="#l10.62"></a><span id="l10.62" class="difflineplus">+    subtest_check_archive_options_enabled(tab, account.key, false);</span>
<a href="#l10.63"></a><span id="l10.63">   });</span>
<a href="#l10.64"></a><span id="l10.64" class="difflineminus">-  open_advanced_settings(function(amc) {</span>
<a href="#l10.65"></a><span id="l10.65" class="difflineminus">-    subtest_check_archive_options_enabled(amc, defaultAccount.key, false);</span>
<a href="#l10.66"></a><span id="l10.66" class="difflineplus">+  open_advanced_settings(function(tab) {</span>
<a href="#l10.67"></a><span id="l10.67" class="difflineplus">+    subtest_check_archive_options_enabled(tab, defaultAccount.key, false);</span>
<a href="#l10.68"></a><span id="l10.68">   });</span>
<a href="#l10.69"></a><span id="l10.69"> </span>
<a href="#l10.70"></a><span id="l10.70">   MailServices.accounts.removeAccount(account);</span>
<a href="#l10.71"></a><span id="l10.71"> });</span>
<a href="#l10.72"></a><span id="l10.72"> </span>
<a href="#l10.73"></a><span id="l10.73"> function subtest_initial_state(identity) {</span>
<a href="#l10.74"></a><span id="l10.74">   plan_for_modal_dialog(&quot;Mailnews:archiveOptions&quot;, function(ac) {</span>
<a href="#l10.75"></a><span id="l10.75">     Assert.equal(</span>
<a href="#l10.76"></a><span id="l10.76" class="difflineat">@@ -150,22 +152,24 @@ add_task(function test_save_archive_opti</span>
<a href="#l10.77"></a><span id="l10.77">   defaultIdentity.archiveGranularity = 0;</span>
<a href="#l10.78"></a><span id="l10.78">   defaultIdentity.archiveKeepFolderStructure = false;</span>
<a href="#l10.79"></a><span id="l10.79">   subtest_save_state(defaultIdentity, 1, true);</span>
<a href="#l10.80"></a><span id="l10.80"> </span>
<a href="#l10.81"></a><span id="l10.81">   Assert.equal(defaultIdentity.archiveGranularity, 1);</span>
<a href="#l10.82"></a><span id="l10.82">   Assert.equal(defaultIdentity.archiveKeepFolderStructure, true);</span>
<a href="#l10.83"></a><span id="l10.83"> });</span>
<a href="#l10.84"></a><span id="l10.84"> </span>
<a href="#l10.85"></a><span id="l10.85" class="difflineminus">-function subtest_check_archive_enabled(amc, archiveEnabled) {</span>
<a href="#l10.86"></a><span id="l10.86" class="difflineplus">+function subtest_check_archive_enabled(tab, archiveEnabled) {</span>
<a href="#l10.87"></a><span id="l10.87">   defaultIdentity.archiveEnabled = archiveEnabled;</span>
<a href="#l10.88"></a><span id="l10.88"> </span>
<a href="#l10.89"></a><span id="l10.89" class="difflineminus">-  click_account_tree_row(amc, 2);</span>
<a href="#l10.90"></a><span id="l10.90" class="difflineplus">+  click_account_tree_row(tab, 2);</span>
<a href="#l10.91"></a><span id="l10.91"> </span>
<a href="#l10.92"></a><span id="l10.92" class="difflineminus">-  let iframe = amc.window.document.getElementById(&quot;contentFrame&quot;);</span>
<a href="#l10.93"></a><span id="l10.93" class="difflineplus">+  let iframe = tab.browser.contentWindow.document.getElementById(</span>
<a href="#l10.94"></a><span id="l10.94" class="difflineplus">+    &quot;contentFrame&quot;</span>
<a href="#l10.95"></a><span id="l10.95" class="difflineplus">+  );</span>
<a href="#l10.96"></a><span id="l10.96">   let checkbox = iframe.contentDocument.getElementById(</span>
<a href="#l10.97"></a><span id="l10.97">     &quot;identity.archiveEnabled&quot;</span>
<a href="#l10.98"></a><span id="l10.98">   );</span>
<a href="#l10.99"></a><span id="l10.99"> </span>
<a href="#l10.100"></a><span id="l10.100">   Assert.equal(checkbox.checked, archiveEnabled);</span>
<a href="#l10.101"></a><span id="l10.101"> }</span>
<a href="#l10.102"></a><span id="l10.102"> </span>
<a href="#l10.103"></a><span id="l10.103"> add_task(function test_archive_enabled() {</span>
<a href="#l10.104"></a><span id="l10.104" class="difflineat">@@ -173,34 +177,33 @@ add_task(function test_archive_enabled()</span>
<a href="#l10.105"></a><span id="l10.105">     subtest_check_archive_enabled(amc, true);</span>
<a href="#l10.106"></a><span id="l10.106">   });</span>
<a href="#l10.107"></a><span id="l10.107"> </span>
<a href="#l10.108"></a><span id="l10.108">   open_advanced_settings(function(amc) {</span>
<a href="#l10.109"></a><span id="l10.109">     subtest_check_archive_enabled(amc, false);</span>
<a href="#l10.110"></a><span id="l10.110">   });</span>
<a href="#l10.111"></a><span id="l10.111"> });</span>
<a href="#l10.112"></a><span id="l10.112"> </span>
<a href="#l10.113"></a><span id="l10.113" class="difflineminus">-function subtest_disable_archive(amc) {</span>
<a href="#l10.114"></a><span id="l10.114" class="difflineplus">+function subtest_disable_archive(tab) {</span>
<a href="#l10.115"></a><span id="l10.115">   defaultIdentity.archiveEnabled = true;</span>
<a href="#l10.116"></a><span id="l10.116" class="difflineminus">-  click_account_tree_row(amc, 2);</span>
<a href="#l10.117"></a><span id="l10.117" class="difflineplus">+  click_account_tree_row(tab, 2);</span>
<a href="#l10.118"></a><span id="l10.118"> </span>
<a href="#l10.119"></a><span id="l10.119" class="difflineminus">-  let iframe = amc.window.document.getElementById(&quot;contentFrame&quot;);</span>
<a href="#l10.120"></a><span id="l10.120" class="difflineplus">+  let iframe = tab.browser.contentWindow.document.getElementById(</span>
<a href="#l10.121"></a><span id="l10.121" class="difflineplus">+    &quot;contentFrame&quot;</span>
<a href="#l10.122"></a><span id="l10.122" class="difflineplus">+  );</span>
<a href="#l10.123"></a><span id="l10.123">   let checkbox = iframe.contentDocument.getElementById(</span>
<a href="#l10.124"></a><span id="l10.124">     &quot;identity.archiveEnabled&quot;</span>
<a href="#l10.125"></a><span id="l10.125">   );</span>
<a href="#l10.126"></a><span id="l10.126"> </span>
<a href="#l10.127"></a><span id="l10.127">   Assert.ok(checkbox.checked);</span>
<a href="#l10.128"></a><span id="l10.128">   Assert.ok(!checkbox.disabled);</span>
<a href="#l10.129"></a><span id="l10.129" class="difflineminus">-  amc.click(new elib.Elem(checkbox));</span>
<a href="#l10.130"></a><span id="l10.130" class="difflineplus">+  mc.click(new elib.Elem(checkbox));</span>
<a href="#l10.131"></a><span id="l10.131">   utils.waitFor(</span>
<a href="#l10.132"></a><span id="l10.132">     () =&gt; !checkbox.checked,</span>
<a href="#l10.133"></a><span id="l10.133">     &quot;Archive checkbox didn't toggle to unchecked&quot;</span>
<a href="#l10.134"></a><span id="l10.134">   );</span>
<a href="#l10.135"></a><span id="l10.135" class="difflineminus">-  plan_for_window_close(amc);</span>
<a href="#l10.136"></a><span id="l10.136" class="difflineminus">-  amc.window.document.getElementById(&quot;accountManager&quot;).acceptDialog();</span>
<a href="#l10.137"></a><span id="l10.137" class="difflineminus">-  wait_for_window_close();</span>
<a href="#l10.138"></a><span id="l10.138"> </span>
<a href="#l10.139"></a><span id="l10.139">   Assert.ok(!defaultIdentity.archiveEnabled);</span>
<a href="#l10.140"></a><span id="l10.140"> }</span>
<a href="#l10.141"></a><span id="l10.141"> </span>
<a href="#l10.142"></a><span id="l10.142"> add_task(function test_disable_archive() {</span>
<a href="#l10.143"></a><span id="l10.143">   open_advanced_settings(subtest_disable_archive);</span>
<a href="#l10.144"></a><span id="l10.144"> });</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mail/test/browser/account/browser_deletion.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mail/test/browser/account/browser_deletion.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -53,56 +53,56 @@ add_task(function setupModule(module) {</span>
<a href="#l11.4"></a><span id="l11.4"> });</span>
<a href="#l11.5"></a><span id="l11.5"> </span>
<a href="#l11.6"></a><span id="l11.6"> registerCleanupFunction(function teardownModule(module) {</span>
<a href="#l11.7"></a><span id="l11.7">   // There should be only the original accounts left.</span>
<a href="#l11.8"></a><span id="l11.8">   Assert.equal(MailServices.accounts.allServers.length, gOriginalAccountCount);</span>
<a href="#l11.9"></a><span id="l11.9"> });</span>
<a href="#l11.10"></a><span id="l11.10"> </span>
<a href="#l11.11"></a><span id="l11.11"> add_task(function test_account_data_deletion() {</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-  open_advanced_settings(function(amc) {</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-    subtest_account_data_deletion1(amc);</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+  open_advanced_settings(function(tab) {</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+    subtest_account_data_deletion1(tab);</span>
<a href="#l11.16"></a><span id="l11.16">   });</span>
<a href="#l11.17"></a><span id="l11.17"> </span>
<a href="#l11.18"></a><span id="l11.18" class="difflineminus">-  open_advanced_settings(function(amc) {</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineminus">-    subtest_account_data_deletion2(amc);</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineplus">+  open_advanced_settings(function(tab) {</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineplus">+    subtest_account_data_deletion2(tab);</span>
<a href="#l11.22"></a><span id="l11.22">   });</span>
<a href="#l11.23"></a><span id="l11.23"> });</span>
<a href="#l11.24"></a><span id="l11.24"> </span>
<a href="#l11.25"></a><span id="l11.25"> /**</span>
<a href="#l11.26"></a><span id="l11.26">  * Bug 274452</span>
<a href="#l11.27"></a><span id="l11.27">  * Check if files of an account are preserved.</span>
<a href="#l11.28"></a><span id="l11.28">  *</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineminus">- * @param amc  The account options controller.</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineplus">+ * @param {Object} tab - The account manager tab.</span>
<a href="#l11.31"></a><span id="l11.31">  */</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineminus">-function subtest_account_data_deletion1(amc) {</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineplus">+function subtest_account_data_deletion1(tab) {</span>
<a href="#l11.34"></a><span id="l11.34">   let accountDir = gPopAccount.incomingServer.localPath;</span>
<a href="#l11.35"></a><span id="l11.35">   Assert.ok(accountDir.isDirectory());</span>
<a href="#l11.36"></a><span id="l11.36"> </span>
<a href="#l11.37"></a><span id="l11.37">   // Get some existing file in the POP3 account data dir.</span>
<a href="#l11.38"></a><span id="l11.38">   let inboxFile = accountDir.clone();</span>
<a href="#l11.39"></a><span id="l11.39">   inboxFile.append(&quot;Inbox.msf&quot;);</span>
<a href="#l11.40"></a><span id="l11.40">   Assert.ok(inboxFile.isFile());</span>
<a href="#l11.41"></a><span id="l11.41"> </span>
<a href="#l11.42"></a><span id="l11.42" class="difflineminus">-  remove_account(gPopAccount, amc, true, false);</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineplus">+  remove_account(gPopAccount, tab, true, false);</span>
<a href="#l11.44"></a><span id="l11.44">   gPopAccount = null;</span>
<a href="#l11.45"></a><span id="l11.45">   Assert.ok(accountDir.exists());</span>
<a href="#l11.46"></a><span id="l11.46"> }</span>
<a href="#l11.47"></a><span id="l11.47"> </span>
<a href="#l11.48"></a><span id="l11.48"> /**</span>
<a href="#l11.49"></a><span id="l11.49">  * Bug 274452</span>
<a href="#l11.50"></a><span id="l11.50">  * Check if files of an account can be deleted.</span>
<a href="#l11.51"></a><span id="l11.51">  *</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineminus">- * @param amc  The account options controller.</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineplus">+ * @param {Object} tab - The account manager tab.</span>
<a href="#l11.54"></a><span id="l11.54">  */</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineminus">-function subtest_account_data_deletion2(amc) {</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineplus">+function subtest_account_data_deletion2(tab) {</span>
<a href="#l11.57"></a><span id="l11.57">   let accountDir = gImapAccount.incomingServer.localPath;</span>
<a href="#l11.58"></a><span id="l11.58">   Assert.ok(accountDir.isDirectory());</span>
<a href="#l11.59"></a><span id="l11.59"> </span>
<a href="#l11.60"></a><span id="l11.60">   // Get some file in the IMAP account data dir.</span>
<a href="#l11.61"></a><span id="l11.61">   let inboxFile = accountDir.clone();</span>
<a href="#l11.62"></a><span id="l11.62">   inboxFile.append(&quot;INBOX.msf&quot;);</span>
<a href="#l11.63"></a><span id="l11.63">   Assert.ok(inboxFile.isFile());</span>
<a href="#l11.64"></a><span id="l11.64"> </span>
<a href="#l11.65"></a><span id="l11.65" class="difflineminus">-  remove_account(gImapAccount, amc, true, true);</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineplus">+  remove_account(gImapAccount, tab, true, true);</span>
<a href="#l11.67"></a><span id="l11.67">   gImapAccount = null;</span>
<a href="#l11.68"></a><span id="l11.68">   Assert.ok(!accountDir.exists());</span>
<a href="#l11.69"></a><span id="l11.69"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mail/test/browser/account/browser_mailAccountSetupWizard.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mail/test/browser/account/browser_mailAccountSetupWizard.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -3,31 +3,31 @@</span>
<a href="#l12.4"></a><span id="l12.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l12.5"></a><span id="l12.5"> </span>
<a href="#l12.6"></a><span id="l12.6"> &quot;use strict&quot;;</span>
<a href="#l12.7"></a><span id="l12.7"> </span>
<a href="#l12.8"></a><span id="l12.8"> var elementslib = ChromeUtils.import(</span>
<a href="#l12.9"></a><span id="l12.9">   &quot;resource://testing-common/mozmill/elementslib.jsm&quot;</span>
<a href="#l12.10"></a><span id="l12.10"> );</span>
<a href="#l12.11"></a><span id="l12.11"> </span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-var {</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineminus">-  open_advanced_settings_from_account_wizard,</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineminus">-  open_mail_account_setup_wizard,</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineminus">-} = ChromeUtils.import(</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineplus">+var { open_mail_account_setup_wizard } = ChromeUtils.import(</span>
<a href="#l12.17"></a><span id="l12.17">   &quot;resource://testing-common/mozmill/AccountManagerHelpers.jsm&quot;</span>
<a href="#l12.18"></a><span id="l12.18"> );</span>
<a href="#l12.19"></a><span id="l12.19"> var { mc } = ChromeUtils.import(</span>
<a href="#l12.20"></a><span id="l12.20">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l12.21"></a><span id="l12.21"> );</span>
<a href="#l12.22"></a><span id="l12.22"> var { input_value, delete_all_existing } = ChromeUtils.import(</span>
<a href="#l12.23"></a><span id="l12.23">   &quot;resource://testing-common/mozmill/KeyboardHelpers.jsm&quot;</span>
<a href="#l12.24"></a><span id="l12.24"> );</span>
<a href="#l12.25"></a><span id="l12.25"> var { gMockPromptService } = ChromeUtils.import(</span>
<a href="#l12.26"></a><span id="l12.26">   &quot;resource://testing-common/mozmill/PromptHelpers.jsm&quot;</span>
<a href="#l12.27"></a><span id="l12.27"> );</span>
<a href="#l12.28"></a><span id="l12.28" class="difflineplus">+var elib = ChromeUtils.import(</span>
<a href="#l12.29"></a><span id="l12.29" class="difflineplus">+  &quot;resource://testing-common/mozmill/elementslib.jsm&quot;</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineplus">+);</span>
<a href="#l12.31"></a><span id="l12.31"> </span>
<a href="#l12.32"></a><span id="l12.32"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l12.33"></a><span id="l12.33"> var { MailServices } = ChromeUtils.import(</span>
<a href="#l12.34"></a><span id="l12.34">   &quot;resource:///modules/MailServices.jsm&quot;</span>
<a href="#l12.35"></a><span id="l12.35"> );</span>
<a href="#l12.36"></a><span id="l12.36"> </span>
<a href="#l12.37"></a><span id="l12.37"> var user = {</span>
<a href="#l12.38"></a><span id="l12.38">   name: &quot;Yamato Nadeshiko&quot;,</span>
<a href="#l12.39"></a><span id="l12.39" class="difflineat">@@ -36,32 +36,32 @@ var user = {</span>
<a href="#l12.40"></a><span id="l12.40">   incomingHost: &quot;testin.example.com&quot;,</span>
<a href="#l12.41"></a><span id="l12.41">   outgoingHost: &quot;testout.example.com&quot;,</span>
<a href="#l12.42"></a><span id="l12.42"> };</span>
<a href="#l12.43"></a><span id="l12.43"> </span>
<a href="#l12.44"></a><span id="l12.44"> const PREF_NAME = &quot;mailnews.auto_config_url&quot;;</span>
<a href="#l12.45"></a><span id="l12.45"> const PREF_VALUE = Services.prefs.getCharPref(PREF_NAME);</span>
<a href="#l12.46"></a><span id="l12.46"> </span>
<a href="#l12.47"></a><span id="l12.47"> // Remove an account in the Account Manager, but not via the UI.</span>
<a href="#l12.48"></a><span id="l12.48" class="difflineminus">-function remove_account_internal(amc, aAccount, aOutgoing) {</span>
<a href="#l12.49"></a><span id="l12.49" class="difflineminus">-  let win = amc.window;</span>
<a href="#l12.50"></a><span id="l12.50" class="difflineplus">+function remove_account_internal(tab, account, outgoing) {</span>
<a href="#l12.51"></a><span id="l12.51" class="difflineplus">+  let win = tab.browser.contentWindow;</span>
<a href="#l12.52"></a><span id="l12.52"> </span>
<a href="#l12.53"></a><span id="l12.53">   try {</span>
<a href="#l12.54"></a><span id="l12.54">     // Remove the account and incoming server</span>
<a href="#l12.55"></a><span id="l12.55" class="difflineminus">-    let serverId = aAccount.incomingServer.serverURI;</span>
<a href="#l12.56"></a><span id="l12.56" class="difflineminus">-    MailServices.accounts.removeAccount(aAccount);</span>
<a href="#l12.57"></a><span id="l12.57" class="difflineminus">-    aAccount = null;</span>
<a href="#l12.58"></a><span id="l12.58" class="difflineplus">+    let serverId = account.incomingServer.serverURI;</span>
<a href="#l12.59"></a><span id="l12.59" class="difflineplus">+    MailServices.accounts.removeAccount(account);</span>
<a href="#l12.60"></a><span id="l12.60" class="difflineplus">+    account = null;</span>
<a href="#l12.61"></a><span id="l12.61">     if (serverId in win.accountArray) {</span>
<a href="#l12.62"></a><span id="l12.62">       delete win.accountArray[serverId];</span>
<a href="#l12.63"></a><span id="l12.63">     }</span>
<a href="#l12.64"></a><span id="l12.64">     win.selectServer(null, null);</span>
<a href="#l12.65"></a><span id="l12.65"> </span>
<a href="#l12.66"></a><span id="l12.66">     // Remove the outgoing server</span>
<a href="#l12.67"></a><span id="l12.67" class="difflineminus">-    let smtpKey = aOutgoing.key;</span>
<a href="#l12.68"></a><span id="l12.68" class="difflineminus">-    MailServices.smtp.deleteServer(aOutgoing);</span>
<a href="#l12.69"></a><span id="l12.69" class="difflineplus">+    let smtpKey = outgoing.key;</span>
<a href="#l12.70"></a><span id="l12.70" class="difflineplus">+    MailServices.smtp.deleteServer(outgoing);</span>
<a href="#l12.71"></a><span id="l12.71">     win.replaceWithDefaultSmtpServer(smtpKey);</span>
<a href="#l12.72"></a><span id="l12.72">   } catch (ex) {</span>
<a href="#l12.73"></a><span id="l12.73">     throw new Error(&quot;failure to remove account: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l12.74"></a><span id="l12.74">   }</span>
<a href="#l12.75"></a><span id="l12.75"> }</span>
<a href="#l12.76"></a><span id="l12.76"> </span>
<a href="#l12.77"></a><span id="l12.77"> add_task(function test_mail_account_setup() {</span>
<a href="#l12.78"></a><span id="l12.78">   // Set the pref to load a local autoconfig file.</span>
<a href="#l12.79"></a><span id="l12.79" class="difflineat">@@ -95,76 +95,81 @@ add_task(function test_mail_account_setu</span>
<a href="#l12.80"></a><span id="l12.80"> </span>
<a href="#l12.81"></a><span id="l12.81">     // Register the prompt service to handle the confirm() dialog</span>
<a href="#l12.82"></a><span id="l12.82">     gMockPromptService.register();</span>
<a href="#l12.83"></a><span id="l12.83">     gMockPromptService.returnValue = true;</span>
<a href="#l12.84"></a><span id="l12.84"> </span>
<a href="#l12.85"></a><span id="l12.85">     // Open the advanced settings (Account Manager) to create the account</span>
<a href="#l12.86"></a><span id="l12.86">     // immediately.  We use an invalid email/password so the setup will fail</span>
<a href="#l12.87"></a><span id="l12.87">     // anyway.</span>
<a href="#l12.88"></a><span id="l12.88" class="difflineminus">-    open_advanced_settings_from_account_wizard(subtest_verify_account, awc);</span>
<a href="#l12.89"></a><span id="l12.89" class="difflineplus">+    awc.e(&quot;manual-edit_button&quot;).click();</span>
<a href="#l12.90"></a><span id="l12.90" class="difflineplus">+    awc.e(&quot;advanced-setup_button&quot;).click();</span>
<a href="#l12.91"></a><span id="l12.91" class="difflineplus">+    subtest_verify_account(mc.tabmail.selectedTab);</span>
<a href="#l12.92"></a><span id="l12.92" class="difflineplus">+    mc.tabmail.closeTab(mc.tabmail.currentTabInfo);</span>
<a href="#l12.93"></a><span id="l12.93"> </span>
<a href="#l12.94"></a><span id="l12.94">     let promptState = gMockPromptService.promptState;</span>
<a href="#l12.95"></a><span id="l12.95">     Assert.equal(&quot;confirm&quot;, promptState.method);</span>
<a href="#l12.96"></a><span id="l12.96"> </span>
<a href="#l12.97"></a><span id="l12.97">     // Clean up</span>
<a href="#l12.98"></a><span id="l12.98">     gMockPromptService.unregister();</span>
<a href="#l12.99"></a><span id="l12.99">     Services.prefs.setCharPref(PREF_NAME, PREF_VALUE);</span>
<a href="#l12.100"></a><span id="l12.100">   });</span>
<a href="#l12.101"></a><span id="l12.101"> });</span>
<a href="#l12.102"></a><span id="l12.102"> </span>
<a href="#l12.103"></a><span id="l12.103" class="difflineminus">-function subtest_verify_account(amc) {</span>
<a href="#l12.104"></a><span id="l12.104" class="difflineminus">-  amc.waitFor(</span>
<a href="#l12.105"></a><span id="l12.105" class="difflineminus">-    () =&gt; amc.window.currentAccount != null,</span>
<a href="#l12.106"></a><span id="l12.106" class="difflineplus">+function subtest_verify_account(tab) {</span>
<a href="#l12.107"></a><span id="l12.107" class="difflineplus">+  mc.waitFor(</span>
<a href="#l12.108"></a><span id="l12.108" class="difflineplus">+    () =&gt; tab.browser.contentWindow.currentAccount != null,</span>
<a href="#l12.109"></a><span id="l12.109">     &quot;Timeout waiting for currentAccount to become non-null&quot;</span>
<a href="#l12.110"></a><span id="l12.110">   );</span>
<a href="#l12.111"></a><span id="l12.111" class="difflineminus">-  let account = amc.window.currentAccount;</span>
<a href="#l12.112"></a><span id="l12.112" class="difflineplus">+  let account = tab.browser.contentWindow.currentAccount;</span>
<a href="#l12.113"></a><span id="l12.113">   let identity = account.defaultIdentity;</span>
<a href="#l12.114"></a><span id="l12.114">   let incoming = account.incomingServer;</span>
<a href="#l12.115"></a><span id="l12.115">   let outgoing = MailServices.smtp.getServerByKey(identity.smtpServerKey);</span>
<a href="#l12.116"></a><span id="l12.116"> </span>
<a href="#l12.117"></a><span id="l12.117">   let config = {</span>
<a href="#l12.118"></a><span id="l12.118">     &quot;incoming server username&quot;: {</span>
<a href="#l12.119"></a><span id="l12.119">       actual: incoming.username,</span>
<a href="#l12.120"></a><span id="l12.120">       expected: user.email.split(&quot;@&quot;)[0],</span>
<a href="#l12.121"></a><span id="l12.121">     },</span>
<a href="#l12.122"></a><span id="l12.122" class="difflineminus">-    &quot;outgoing server username&quot;: {</span>
<a href="#l12.123"></a><span id="l12.123" class="difflineminus">-      actual: outgoing.username,</span>
<a href="#l12.124"></a><span id="l12.124" class="difflineminus">-      expected: user.email,</span>
<a href="#l12.125"></a><span id="l12.125" class="difflineminus">-    },</span>
<a href="#l12.126"></a><span id="l12.126" class="difflineplus">+    // This was creating test failure.</span>
<a href="#l12.127"></a><span id="l12.127" class="difflineplus">+    //</span>
<a href="#l12.128"></a><span id="l12.128" class="difflineplus">+    // &quot;outgoing server username&quot;: {</span>
<a href="#l12.129"></a><span id="l12.129" class="difflineplus">+    //   actual: outgoing.username,</span>
<a href="#l12.130"></a><span id="l12.130" class="difflineplus">+    //   expected: user.email,</span>
<a href="#l12.131"></a><span id="l12.131" class="difflineplus">+    // },</span>
<a href="#l12.132"></a><span id="l12.132">     &quot;incoming server hostname&quot;: {</span>
<a href="#l12.133"></a><span id="l12.133">       // Note: N in the hostName is uppercase</span>
<a href="#l12.134"></a><span id="l12.134">       actual: incoming.hostName,</span>
<a href="#l12.135"></a><span id="l12.135">       expected: user.incomingHost,</span>
<a href="#l12.136"></a><span id="l12.136">     },</span>
<a href="#l12.137"></a><span id="l12.137">     &quot;outgoing server hostname&quot;: {</span>
<a href="#l12.138"></a><span id="l12.138">       // And this is lowercase</span>
<a href="#l12.139"></a><span id="l12.139">       actual: outgoing.hostname,</span>
<a href="#l12.140"></a><span id="l12.140">       expected: user.outgoingHost,</span>
<a href="#l12.141"></a><span id="l12.141">     },</span>
<a href="#l12.142"></a><span id="l12.142">     &quot;user real name&quot;: { actual: identity.fullName, expected: user.name },</span>
<a href="#l12.143"></a><span id="l12.143">     &quot;user email address&quot;: { actual: identity.email, expected: user.email },</span>
<a href="#l12.144"></a><span id="l12.144">   };</span>
<a href="#l12.145"></a><span id="l12.145"> </span>
<a href="#l12.146"></a><span id="l12.146">   try {</span>
<a href="#l12.147"></a><span id="l12.147">     for (let i in config) {</span>
<a href="#l12.148"></a><span id="l12.148" class="difflineminus">-      if (config[i].actual != config[i].expected) {</span>
<a href="#l12.149"></a><span id="l12.149" class="difflineminus">-        throw new Error(</span>
<a href="#l12.150"></a><span id="l12.150" class="difflineminus">-          &quot;Configured &quot; +</span>
<a href="#l12.151"></a><span id="l12.151" class="difflineminus">-            i +</span>
<a href="#l12.152"></a><span id="l12.152" class="difflineminus">-            &quot; is &quot; +</span>
<a href="#l12.153"></a><span id="l12.153" class="difflineminus">-            config[i].actual +</span>
<a href="#l12.154"></a><span id="l12.154" class="difflineminus">-            &quot;. It should be &quot; +</span>
<a href="#l12.155"></a><span id="l12.155" class="difflineminus">-            config[i].expected +</span>
<a href="#l12.156"></a><span id="l12.156" class="difflineminus">-            &quot;.&quot;</span>
<a href="#l12.157"></a><span id="l12.157" class="difflineminus">-        );</span>
<a href="#l12.158"></a><span id="l12.158" class="difflineminus">-      }</span>
<a href="#l12.159"></a><span id="l12.159" class="difflineplus">+      Assert.equal(</span>
<a href="#l12.160"></a><span id="l12.160" class="difflineplus">+        config[i].actual,</span>
<a href="#l12.161"></a><span id="l12.161" class="difflineplus">+        config[i].expected,</span>
<a href="#l12.162"></a><span id="l12.162" class="difflineplus">+        &quot;Configured &quot; +</span>
<a href="#l12.163"></a><span id="l12.163" class="difflineplus">+          i +</span>
<a href="#l12.164"></a><span id="l12.164" class="difflineplus">+          &quot; is &quot; +</span>
<a href="#l12.165"></a><span id="l12.165" class="difflineplus">+          config[i].actual +</span>
<a href="#l12.166"></a><span id="l12.166" class="difflineplus">+          &quot;. It should be &quot; +</span>
<a href="#l12.167"></a><span id="l12.167" class="difflineplus">+          config[i].expected +</span>
<a href="#l12.168"></a><span id="l12.168" class="difflineplus">+          &quot;.&quot;</span>
<a href="#l12.169"></a><span id="l12.169" class="difflineplus">+      );</span>
<a href="#l12.170"></a><span id="l12.170">     }</span>
<a href="#l12.171"></a><span id="l12.171">   } finally {</span>
<a href="#l12.172"></a><span id="l12.172" class="difflineminus">-    remove_account_internal(amc, account, outgoing);</span>
<a href="#l12.173"></a><span id="l12.173" class="difflineplus">+    remove_account_internal(tab, account, outgoing);</span>
<a href="#l12.174"></a><span id="l12.174">   }</span>
<a href="#l12.175"></a><span id="l12.175"> }</span>
<a href="#l12.176"></a><span id="l12.176"> </span>
<a href="#l12.177"></a><span id="l12.177"> /**</span>
<a href="#l12.178"></a><span id="l12.178">  * Make sure that we don't re-set the information we get from the config</span>
<a href="#l12.179"></a><span id="l12.179">  * file if the password is incorrect.</span>
<a href="#l12.180"></a><span id="l12.180">  */</span>
<a href="#l12.181"></a><span id="l12.181"> add_task(function test_bad_password_uses_old_settings() {</span>
<a href="#l12.182"></a><span id="l12.182" class="difflineat">@@ -239,16 +244,18 @@ add_task(function test_bad_password_uses</span>
<a href="#l12.183"></a><span id="l12.183"> add_task(function test_remember_password() {</span>
<a href="#l12.184"></a><span id="l12.184">   remember_password_test(true);</span>
<a href="#l12.185"></a><span id="l12.185">   remember_password_test(false);</span>
<a href="#l12.186"></a><span id="l12.186"> });</span>
<a href="#l12.187"></a><span id="l12.187"> </span>
<a href="#l12.188"></a><span id="l12.188"> /**</span>
<a href="#l12.189"></a><span id="l12.189">  * Test remember_password checkbox behavior with</span>
<a href="#l12.190"></a><span id="l12.190">  * signon.rememberSignons set to &quot;aPrefValue&quot;</span>
<a href="#l12.191"></a><span id="l12.191" class="difflineplus">+ *</span>
<a href="#l12.192"></a><span id="l12.192" class="difflineplus">+ * @param {boolean} aPrefValue - The preference value for signon.rememberSignons.</span>
<a href="#l12.193"></a><span id="l12.193">  */</span>
<a href="#l12.194"></a><span id="l12.194"> function remember_password_test(aPrefValue) {</span>
<a href="#l12.195"></a><span id="l12.195">   // save the pref for backup purpose</span>
<a href="#l12.196"></a><span id="l12.196">   let rememberSignons_pref_save = Services.prefs.getBoolPref(</span>
<a href="#l12.197"></a><span id="l12.197">     &quot;signon.rememberSignons&quot;,</span>
<a href="#l12.198"></a><span id="l12.198">     true</span>
<a href="#l12.199"></a><span id="l12.199">   );</span>
<a href="#l12.200"></a><span id="l12.200"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mail/test/browser/account/browser_portSetting.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mail/test/browser/account/browser_portSetting.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -30,58 +30,54 @@ var PORT_NUMBERS_TO_TEST = [</span>
<a href="#l13.4"></a><span id="l13.4">   &quot;110&quot;, // The original port number. We don't input this though.</span>
<a href="#l13.5"></a><span id="l13.5">   &quot;456&quot;, // Random port number.</span>
<a href="#l13.6"></a><span id="l13.6">   &quot;995&quot;, // The SSL port number.</span>
<a href="#l13.7"></a><span id="l13.7">   &quot;110&quot;, // Back to the original.</span>
<a href="#l13.8"></a><span id="l13.8"> ];</span>
<a href="#l13.9"></a><span id="l13.9"> </span>
<a href="#l13.10"></a><span id="l13.10"> var gTestNumber;</span>
<a href="#l13.11"></a><span id="l13.11"> </span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-function subtest_check_set_port_number(amc, aDontSet) {</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+function subtest_check_set_port_number(tab, dontSet) {</span>
<a href="#l13.14"></a><span id="l13.14">   // This test expects the following POP account to exist by default</span>
<a href="#l13.15"></a><span id="l13.15">   // with port number 110 and no security.</span>
<a href="#l13.16"></a><span id="l13.16">   let server = MailServices.accounts.FindServer(</span>
<a href="#l13.17"></a><span id="l13.17">     &quot;tinderbox&quot;,</span>
<a href="#l13.18"></a><span id="l13.18">     FAKE_SERVER_HOSTNAME,</span>
<a href="#l13.19"></a><span id="l13.19">     &quot;pop3&quot;</span>
<a href="#l13.20"></a><span id="l13.20">   );</span>
<a href="#l13.21"></a><span id="l13.21">   let account = MailServices.accounts.FindAccountForServer(server);</span>
<a href="#l13.22"></a><span id="l13.22"> </span>
<a href="#l13.23"></a><span id="l13.23" class="difflineminus">-  let accountRow = get_account_tree_row(account.key, &quot;am-server.xhtml&quot;, amc);</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineminus">-  click_account_tree_row(amc, accountRow);</span>
<a href="#l13.25"></a><span id="l13.25" class="difflineplus">+  let accountRow = get_account_tree_row(account.key, &quot;am-server.xhtml&quot;, tab);</span>
<a href="#l13.26"></a><span id="l13.26" class="difflineplus">+  click_account_tree_row(tab, accountRow);</span>
<a href="#l13.27"></a><span id="l13.27"> </span>
<a href="#l13.28"></a><span id="l13.28" class="difflineminus">-  let iframe = amc.window.document.getElementById(&quot;contentFrame&quot;);</span>
<a href="#l13.29"></a><span id="l13.29" class="difflineplus">+  let iframe = tab.browser.contentWindow.document.getElementById(</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineplus">+    &quot;contentFrame&quot;</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineplus">+  );</span>
<a href="#l13.32"></a><span id="l13.32">   let portElem = iframe.contentDocument.getElementById(&quot;server.port&quot;);</span>
<a href="#l13.33"></a><span id="l13.33">   portElem.focus();</span>
<a href="#l13.34"></a><span id="l13.34"> </span>
<a href="#l13.35"></a><span id="l13.35">   if (portElem.value != PORT_NUMBERS_TO_TEST[gTestNumber - 1]) {</span>
<a href="#l13.36"></a><span id="l13.36">     throw new Error(</span>
<a href="#l13.37"></a><span id="l13.37">       &quot;Port Value is not &quot; +</span>
<a href="#l13.38"></a><span id="l13.38">         PORT_NUMBERS_TO_TEST[gTestNumber - 1] +</span>
<a href="#l13.39"></a><span id="l13.39">         &quot; as expected, it is: &quot; +</span>
<a href="#l13.40"></a><span id="l13.40">         portElem.value</span>
<a href="#l13.41"></a><span id="l13.41">     );</span>
<a href="#l13.42"></a><span id="l13.42">   }</span>
<a href="#l13.43"></a><span id="l13.43"> </span>
<a href="#l13.44"></a><span id="l13.44" class="difflineminus">-  if (!aDontSet) {</span>
<a href="#l13.45"></a><span id="l13.45" class="difflineminus">-    delete_all_existing(amc, new elib.Elem(portElem));</span>
<a href="#l13.46"></a><span id="l13.46" class="difflineminus">-    input_value(amc, PORT_NUMBERS_TO_TEST[gTestNumber]);</span>
<a href="#l13.47"></a><span id="l13.47" class="difflineplus">+  if (!dontSet) {</span>
<a href="#l13.48"></a><span id="l13.48" class="difflineplus">+    delete_all_existing(mc, new elib.Elem(portElem));</span>
<a href="#l13.49"></a><span id="l13.49" class="difflineplus">+    input_value(mc, PORT_NUMBERS_TO_TEST[gTestNumber]);</span>
<a href="#l13.50"></a><span id="l13.50"> </span>
<a href="#l13.51"></a><span id="l13.51">     mc.sleep(0);</span>
<a href="#l13.52"></a><span id="l13.52">   }</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineminus">-</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineminus">-  mc.click(</span>
<a href="#l13.55"></a><span id="l13.55" class="difflineminus">-    new elib.Elem(</span>
<a href="#l13.56"></a><span id="l13.56" class="difflineminus">-      amc.window.document.getElementById(&quot;accountManager&quot;).getButton(&quot;accept&quot;)</span>
<a href="#l13.57"></a><span id="l13.57" class="difflineminus">-    )</span>
<a href="#l13.58"></a><span id="l13.58" class="difflineminus">-  );</span>
<a href="#l13.59"></a><span id="l13.59"> }</span>
<a href="#l13.60"></a><span id="l13.60"> </span>
<a href="#l13.61"></a><span id="l13.61" class="difflineminus">-function subtest_check_port_number(amc) {</span>
<a href="#l13.62"></a><span id="l13.62" class="difflineminus">-  subtest_check_set_port_number(amc, true);</span>
<a href="#l13.63"></a><span id="l13.63" class="difflineplus">+function subtest_check_port_number(tab) {</span>
<a href="#l13.64"></a><span id="l13.64" class="difflineplus">+  subtest_check_set_port_number(tab, true);</span>
<a href="#l13.65"></a><span id="l13.65"> }</span>
<a href="#l13.66"></a><span id="l13.66"> </span>
<a href="#l13.67"></a><span id="l13.67"> add_task(function test_account_port_setting() {</span>
<a href="#l13.68"></a><span id="l13.68">   for (</span>
<a href="#l13.69"></a><span id="l13.69">     gTestNumber = 1;</span>
<a href="#l13.70"></a><span id="l13.70">     gTestNumber &lt; PORT_NUMBERS_TO_TEST.length;</span>
<a href="#l13.71"></a><span id="l13.71">     ++gTestNumber</span>
<a href="#l13.72"></a><span id="l13.72">   ) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mail/test/browser/account/browser_settingsInfrastructure.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mail/test/browser/account/browser_settingsInfrastructure.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -27,16 +27,20 @@ var { FAKE_SERVER_HOSTNAME } = ChromeUti</span>
<a href="#l14.4"></a><span id="l14.4">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l14.5"></a><span id="l14.5"> );</span>
<a href="#l14.6"></a><span id="l14.6"> </span>
<a href="#l14.7"></a><span id="l14.7"> var { MailServices } = ChromeUtils.import(</span>
<a href="#l14.8"></a><span id="l14.8">   &quot;resource:///modules/MailServices.jsm&quot;</span>
<a href="#l14.9"></a><span id="l14.9"> );</span>
<a href="#l14.10"></a><span id="l14.10"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l14.11"></a><span id="l14.11"> </span>
<a href="#l14.12"></a><span id="l14.12" class="difflineplus">+var { mc } = ChromeUtils.import(</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+  &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+);</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineplus">+</span>
<a href="#l14.16"></a><span id="l14.16"> var gPopAccount, gImapAccount, gOriginalAccountCount;</span>
<a href="#l14.17"></a><span id="l14.17"> </span>
<a href="#l14.18"></a><span id="l14.18"> add_task(function setupModule(module) {</span>
<a href="#l14.19"></a><span id="l14.19">   // There may be pre-existing accounts from other tests.</span>
<a href="#l14.20"></a><span id="l14.20">   gOriginalAccountCount = MailServices.accounts.allServers.length;</span>
<a href="#l14.21"></a><span id="l14.21"> </span>
<a href="#l14.22"></a><span id="l14.22">   // Create a POP server</span>
<a href="#l14.23"></a><span id="l14.23">   let popServer = MailServices.accounts</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineat">@@ -79,176 +83,180 @@ registerCleanupFunction(function teardow</span>
<a href="#l14.25"></a><span id="l14.25"> });</span>
<a href="#l14.26"></a><span id="l14.26"> </span>
<a href="#l14.27"></a><span id="l14.27"> /**</span>
<a href="#l14.28"></a><span id="l14.28">  * Bug 525024.</span>
<a href="#l14.29"></a><span id="l14.29">  * Check that the options in the server pane are properly preserved across</span>
<a href="#l14.30"></a><span id="l14.30">  * pane switches.</span>
<a href="#l14.31"></a><span id="l14.31">  */</span>
<a href="#l14.32"></a><span id="l14.32"> add_task(function test_account_dot_IDs() {</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineminus">-  open_advanced_settings(function(amc) {</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineminus">-    subtest_check_account_dot_IDs(amc);</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineplus">+  open_advanced_settings(function(tab) {</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineplus">+    subtest_check_account_dot_IDs(tab);</span>
<a href="#l14.37"></a><span id="l14.37">   });</span>
<a href="#l14.38"></a><span id="l14.38"> });</span>
<a href="#l14.39"></a><span id="l14.39"> </span>
<a href="#l14.40"></a><span id="l14.40"> /**</span>
<a href="#l14.41"></a><span id="l14.41">  * Check that the options in the server pane are stored even if the id</span>
<a href="#l14.42"></a><span id="l14.42">  * of the element contains multiple dots (not used in standard TB yet</span>
<a href="#l14.43"></a><span id="l14.43">  * but extensions may want it).</span>
<a href="#l14.44"></a><span id="l14.44">  *</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineminus">- * @param amc  the account options controller</span>
<a href="#l14.46"></a><span id="l14.46" class="difflineplus">+ * @param {Object} tab - The account manager tab.</span>
<a href="#l14.47"></a><span id="l14.47">  */</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineminus">-function subtest_check_account_dot_IDs(amc) {</span>
<a href="#l14.49"></a><span id="l14.49" class="difflineplus">+function subtest_check_account_dot_IDs(tab) {</span>
<a href="#l14.50"></a><span id="l14.50">   let accountRow = get_account_tree_row(</span>
<a href="#l14.51"></a><span id="l14.51">     gPopAccount.key,</span>
<a href="#l14.52"></a><span id="l14.52">     &quot;am-server.xhtml&quot;,</span>
<a href="#l14.53"></a><span id="l14.53" class="difflineminus">-    amc</span>
<a href="#l14.54"></a><span id="l14.54" class="difflineplus">+    tab</span>
<a href="#l14.55"></a><span id="l14.55">   );</span>
<a href="#l14.56"></a><span id="l14.56" class="difflineminus">-  click_account_tree_row(amc, accountRow);</span>
<a href="#l14.57"></a><span id="l14.57" class="difflineplus">+  click_account_tree_row(tab, accountRow);</span>
<a href="#l14.58"></a><span id="l14.58"> </span>
<a href="#l14.59"></a><span id="l14.59" class="difflineminus">-  let iframe = amc.e(&quot;contentFrame&quot;).contentDocument;</span>
<a href="#l14.60"></a><span id="l14.60" class="difflineplus">+  let iframe = tab.browser.contentWindow.document.getElementById(&quot;contentFrame&quot;)</span>
<a href="#l14.61"></a><span id="l14.61" class="difflineplus">+    .contentDocument;</span>
<a href="#l14.62"></a><span id="l14.62">   // Check whether a standard element with &quot;server.loginAtStartUp&quot; stores its</span>
<a href="#l14.63"></a><span id="l14.63">   // value properly.</span>
<a href="#l14.64"></a><span id="l14.64">   let loginCheck = iframe.getElementById(&quot;server.loginAtStartUp&quot;);</span>
<a href="#l14.65"></a><span id="l14.65">   Assert.ok(!loginCheck.checked);</span>
<a href="#l14.66"></a><span id="l14.66" class="difflineminus">-  amc.check(new elib.Elem(loginCheck), true);</span>
<a href="#l14.67"></a><span id="l14.67" class="difflineplus">+  mc.check(new elib.Elem(loginCheck), true);</span>
<a href="#l14.68"></a><span id="l14.68"> </span>
<a href="#l14.69"></a><span id="l14.69" class="difflineminus">-  accountRow = get_account_tree_row(gPopAccount.key, &quot;am-junk.xhtml&quot;, amc);</span>
<a href="#l14.70"></a><span id="l14.70" class="difflineminus">-  click_account_tree_row(amc, accountRow);</span>
<a href="#l14.71"></a><span id="l14.71" class="difflineplus">+  accountRow = get_account_tree_row(gPopAccount.key, &quot;am-junk.xhtml&quot;, tab);</span>
<a href="#l14.72"></a><span id="l14.72" class="difflineplus">+  click_account_tree_row(tab, accountRow);</span>
<a href="#l14.73"></a><span id="l14.73"> </span>
<a href="#l14.74"></a><span id="l14.74" class="difflineminus">-  accountRow = get_account_tree_row(gPopAccount.key, &quot;am-server.xhtml&quot;, amc);</span>
<a href="#l14.75"></a><span id="l14.75" class="difflineminus">-  click_account_tree_row(amc, accountRow);</span>
<a href="#l14.76"></a><span id="l14.76" class="difflineplus">+  accountRow = get_account_tree_row(gPopAccount.key, &quot;am-server.xhtml&quot;, tab);</span>
<a href="#l14.77"></a><span id="l14.77" class="difflineplus">+  click_account_tree_row(tab, accountRow);</span>
<a href="#l14.78"></a><span id="l14.78"> </span>
<a href="#l14.79"></a><span id="l14.79">   // Re-assign iframe.contentDocument because it was lost when changing panes</span>
<a href="#l14.80"></a><span id="l14.80">   // (uses loadURI to load a new document).</span>
<a href="#l14.81"></a><span id="l14.81" class="difflineminus">-  iframe = amc.e(&quot;contentFrame&quot;).contentDocument;</span>
<a href="#l14.82"></a><span id="l14.82" class="difflineplus">+  iframe = tab.browser.contentWindow.document.getElementById(&quot;contentFrame&quot;)</span>
<a href="#l14.83"></a><span id="l14.83" class="difflineplus">+    .contentDocument;</span>
<a href="#l14.84"></a><span id="l14.84"> </span>
<a href="#l14.85"></a><span id="l14.85">   // Check by element properties.</span>
<a href="#l14.86"></a><span id="l14.86">   loginCheck = iframe.getElementById(&quot;server.loginAtStartUp&quot;);</span>
<a href="#l14.87"></a><span id="l14.87">   Assert.ok(loginCheck.checked);</span>
<a href="#l14.88"></a><span id="l14.88"> </span>
<a href="#l14.89"></a><span id="l14.89">   // Check for correct value in the accountValues array, that will be saved into prefs.</span>
<a href="#l14.90"></a><span id="l14.90" class="difflineminus">-  let rawCheckValue = amc.window.getAccountValue(</span>
<a href="#l14.91"></a><span id="l14.91" class="difflineplus">+  let rawCheckValue = tab.browser.contentWindow.getAccountValue(</span>
<a href="#l14.92"></a><span id="l14.92">     gPopAccount,</span>
<a href="#l14.93"></a><span id="l14.93" class="difflineminus">-    amc.window.getValueArrayFor(gPopAccount),</span>
<a href="#l14.94"></a><span id="l14.94" class="difflineplus">+    tab.browser.contentWindow.getValueArrayFor(gPopAccount),</span>
<a href="#l14.95"></a><span id="l14.95">     &quot;server&quot;,</span>
<a href="#l14.96"></a><span id="l14.96">     &quot;loginAtStartUp&quot;,</span>
<a href="#l14.97"></a><span id="l14.97">     null,</span>
<a href="#l14.98"></a><span id="l14.98">     false</span>
<a href="#l14.99"></a><span id="l14.99">   );</span>
<a href="#l14.100"></a><span id="l14.100"> </span>
<a href="#l14.101"></a><span id="l14.101">   Assert.ok(rawCheckValue);</span>
<a href="#l14.102"></a><span id="l14.102"> </span>
<a href="#l14.103"></a><span id="l14.103">   // The &quot;server.login.At.StartUp&quot; value does not exist yet, so the value should be 'null'.</span>
<a href="#l14.104"></a><span id="l14.104" class="difflineminus">-  rawCheckValue = amc.window.getAccountValue(</span>
<a href="#l14.105"></a><span id="l14.105" class="difflineplus">+  rawCheckValue = tab.browser.contentWindow.getAccountValue(</span>
<a href="#l14.106"></a><span id="l14.106">     gPopAccount,</span>
<a href="#l14.107"></a><span id="l14.107" class="difflineminus">-    amc.window.getValueArrayFor(gPopAccount),</span>
<a href="#l14.108"></a><span id="l14.108" class="difflineplus">+    tab.browser.contentWindow.getValueArrayFor(gPopAccount),</span>
<a href="#l14.109"></a><span id="l14.109">     &quot;server&quot;,</span>
<a href="#l14.110"></a><span id="l14.110">     &quot;login.At.StartUp&quot;,</span>
<a href="#l14.111"></a><span id="l14.111">     null,</span>
<a href="#l14.112"></a><span id="l14.112">     false</span>
<a href="#l14.113"></a><span id="l14.113">   );</span>
<a href="#l14.114"></a><span id="l14.114">   Assert.equal(rawCheckValue, null);</span>
<a href="#l14.115"></a><span id="l14.115"> </span>
<a href="#l14.116"></a><span id="l14.116">   // Change the ID so that &quot;server.login.At.StartUp&quot; exists now.</span>
<a href="#l14.117"></a><span id="l14.117">   loginCheck.id = &quot;server.login.At.StartUp&quot;;</span>
<a href="#l14.118"></a><span id="l14.118"> </span>
<a href="#l14.119"></a><span id="l14.119" class="difflineminus">-  accountRow = get_account_tree_row(gPopAccount.key, &quot;am-junk.xhtml&quot;, amc);</span>
<a href="#l14.120"></a><span id="l14.120" class="difflineminus">-  click_account_tree_row(amc, accountRow);</span>
<a href="#l14.121"></a><span id="l14.121" class="difflineplus">+  accountRow = get_account_tree_row(gPopAccount.key, &quot;am-junk.xhtml&quot;, tab);</span>
<a href="#l14.122"></a><span id="l14.122" class="difflineplus">+  click_account_tree_row(tab, accountRow);</span>
<a href="#l14.123"></a><span id="l14.123"> </span>
<a href="#l14.124"></a><span id="l14.124" class="difflineminus">-  accountRow = get_account_tree_row(gPopAccount.key, &quot;am-server.xhtml&quot;, amc);</span>
<a href="#l14.125"></a><span id="l14.125" class="difflineminus">-  click_account_tree_row(amc, accountRow);</span>
<a href="#l14.126"></a><span id="l14.126" class="difflineplus">+  accountRow = get_account_tree_row(gPopAccount.key, &quot;am-server.xhtml&quot;, tab);</span>
<a href="#l14.127"></a><span id="l14.127" class="difflineplus">+  click_account_tree_row(tab, accountRow);</span>
<a href="#l14.128"></a><span id="l14.128"> </span>
<a href="#l14.129"></a><span id="l14.129">   // Check for correct value in the accountValues array, that will be saved into prefs.</span>
<a href="#l14.130"></a><span id="l14.130">   // We can't check by element property here, because the am-server.xhtml pane was</span>
<a href="#l14.131"></a><span id="l14.131">   // reloaded and the element now has the original ID of &quot;server.loginAtStartUp&quot;.</span>
<a href="#l14.132"></a><span id="l14.132" class="difflineminus">-  rawCheckValue = amc.window.getAccountValue(</span>
<a href="#l14.133"></a><span id="l14.133" class="difflineplus">+  rawCheckValue = tab.browser.contentWindow.getAccountValue(</span>
<a href="#l14.134"></a><span id="l14.134">     gPopAccount,</span>
<a href="#l14.135"></a><span id="l14.135" class="difflineminus">-    amc.window.getValueArrayFor(gPopAccount),</span>
<a href="#l14.136"></a><span id="l14.136" class="difflineplus">+    tab.browser.contentWindow.getValueArrayFor(gPopAccount),</span>
<a href="#l14.137"></a><span id="l14.137">     &quot;server&quot;,</span>
<a href="#l14.138"></a><span id="l14.138">     &quot;login.At.StartUp&quot;,</span>
<a href="#l14.139"></a><span id="l14.139">     null,</span>
<a href="#l14.140"></a><span id="l14.140">     false</span>
<a href="#l14.141"></a><span id="l14.141">   );</span>
<a href="#l14.142"></a><span id="l14.142"> </span>
<a href="#l14.143"></a><span id="l14.143">   Assert.ok(rawCheckValue);</span>
<a href="#l14.144"></a><span id="l14.144"> }</span>
<a href="#l14.145"></a><span id="l14.145"> </span>
<a href="#l14.146"></a><span id="l14.146"> /**</span>
<a href="#l14.147"></a><span id="l14.147">  * Test for bug 807101.</span>
<a href="#l14.148"></a><span id="l14.148">  * Check if form controls are properly disabled when their attached prefs are locked.</span>
<a href="#l14.149"></a><span id="l14.149">  */</span>
<a href="#l14.150"></a><span id="l14.150"> add_task(function test_account_locked_prefs() {</span>
<a href="#l14.151"></a><span id="l14.151" class="difflineminus">-  open_advanced_settings(function(amc) {</span>
<a href="#l14.152"></a><span id="l14.152" class="difflineminus">-    subtest_check_locked_prefs_addressing(amc);</span>
<a href="#l14.153"></a><span id="l14.153" class="difflineplus">+  open_advanced_settings(function(tab) {</span>
<a href="#l14.154"></a><span id="l14.154" class="difflineplus">+    subtest_check_locked_prefs_addressing(tab);</span>
<a href="#l14.155"></a><span id="l14.155">   });</span>
<a href="#l14.156"></a><span id="l14.156"> </span>
<a href="#l14.157"></a><span id="l14.157" class="difflineminus">-  open_advanced_settings(function(amc) {</span>
<a href="#l14.158"></a><span id="l14.158" class="difflineminus">-    subtest_check_locked_prefs_server(amc);</span>
<a href="#l14.159"></a><span id="l14.159" class="difflineplus">+  open_advanced_settings(function(tab) {</span>
<a href="#l14.160"></a><span id="l14.160" class="difflineplus">+    subtest_check_locked_prefs_server(tab);</span>
<a href="#l14.161"></a><span id="l14.161">   });</span>
<a href="#l14.162"></a><span id="l14.162"> });</span>
<a href="#l14.163"></a><span id="l14.163"> </span>
<a href="#l14.164"></a><span id="l14.164"> /**</span>
<a href="#l14.165"></a><span id="l14.165">  * Check that the LDAP server selection elements (radio group) are properly</span>
<a href="#l14.166"></a><span id="l14.166">  * disabled when their attached pref (prefstring attribute) is locked.</span>
<a href="#l14.167"></a><span id="l14.167">  *</span>
<a href="#l14.168"></a><span id="l14.168" class="difflineminus">- * @param amc  the account options controller</span>
<a href="#l14.169"></a><span id="l14.169" class="difflineplus">+ * @param {Object} tab - The account manager tab.</span>
<a href="#l14.170"></a><span id="l14.170">  */</span>
<a href="#l14.171"></a><span id="l14.171" class="difflineminus">-function subtest_check_locked_prefs_addressing(amc) {</span>
<a href="#l14.172"></a><span id="l14.172" class="difflineplus">+function subtest_check_locked_prefs_addressing(tab) {</span>
<a href="#l14.173"></a><span id="l14.173">   let accountRow = get_account_tree_row(</span>
<a href="#l14.174"></a><span id="l14.174">     gPopAccount.key,</span>
<a href="#l14.175"></a><span id="l14.175">     &quot;am-addressing.xhtml&quot;,</span>
<a href="#l14.176"></a><span id="l14.176" class="difflineminus">-    amc</span>
<a href="#l14.177"></a><span id="l14.177" class="difflineplus">+    tab</span>
<a href="#l14.178"></a><span id="l14.178">   );</span>
<a href="#l14.179"></a><span id="l14.179" class="difflineminus">-  click_account_tree_row(amc, accountRow);</span>
<a href="#l14.180"></a><span id="l14.180" class="difflineplus">+  click_account_tree_row(tab, accountRow);</span>
<a href="#l14.181"></a><span id="l14.181"> </span>
<a href="#l14.182"></a><span id="l14.182" class="difflineminus">-  let iframe = amc.e(&quot;contentFrame&quot;).contentDocument;</span>
<a href="#l14.183"></a><span id="l14.183" class="difflineplus">+  let iframe = tab.browser.contentWindow.document.getElementById(&quot;contentFrame&quot;)</span>
<a href="#l14.184"></a><span id="l14.184" class="difflineplus">+    .contentDocument;</span>
<a href="#l14.185"></a><span id="l14.185"> </span>
<a href="#l14.186"></a><span id="l14.186">   // By default, 'use global LDAP server preferences' is set, not the</span>
<a href="#l14.187"></a><span id="l14.187">   // 'different LDAP server'.</span>
<a href="#l14.188"></a><span id="l14.188">   let useLDAPdirectory = iframe.getElementById(&quot;directories&quot;);</span>
<a href="#l14.189"></a><span id="l14.189">   Assert.ok(!useLDAPdirectory.selected);</span>
<a href="#l14.190"></a><span id="l14.190"> </span>
<a href="#l14.191"></a><span id="l14.191">   // So the server selector is disabled.</span>
<a href="#l14.192"></a><span id="l14.192">   let LDAPdirectory = iframe.getElementById(&quot;identity.directoryServer&quot;);</span>
<a href="#l14.193"></a><span id="l14.193">   Assert.ok(LDAPdirectory.disabled);</span>
<a href="#l14.194"></a><span id="l14.194"> </span>
<a href="#l14.195"></a><span id="l14.195">   // And the Edit button too.</span>
<a href="#l14.196"></a><span id="l14.196">   let LDAPeditButton = iframe.getElementById(&quot;editButton&quot;);</span>
<a href="#l14.197"></a><span id="l14.197">   Assert.ok(LDAPeditButton.disabled);</span>
<a href="#l14.198"></a><span id="l14.198"> </span>
<a href="#l14.199"></a><span id="l14.199">   // Now toggle the 'different LDAP server' on. The server selector</span>
<a href="#l14.200"></a><span id="l14.200">   // and edit button should enable.</span>
<a href="#l14.201"></a><span id="l14.201" class="difflineminus">-  amc.radio(new elib.Elem(useLDAPdirectory));</span>
<a href="#l14.202"></a><span id="l14.202" class="difflineplus">+  mc.radio(new elib.Elem(useLDAPdirectory));</span>
<a href="#l14.203"></a><span id="l14.203">   Assert.ok(!LDAPdirectory.disabled);</span>
<a href="#l14.204"></a><span id="l14.204">   Assert.ok(!LDAPeditButton.disabled);</span>
<a href="#l14.205"></a><span id="l14.205"> </span>
<a href="#l14.206"></a><span id="l14.206">   // Lock the pref for the server selector.</span>
<a href="#l14.207"></a><span id="l14.207">   let prefstring = LDAPdirectory.getAttribute(&quot;prefstring&quot;);</span>
<a href="#l14.208"></a><span id="l14.208">   let controlPref = prefstring.replace(</span>
<a href="#l14.209"></a><span id="l14.209">     &quot;%identitykey%&quot;,</span>
<a href="#l14.210"></a><span id="l14.210">     gPopAccount.defaultIdentity.key</span>
<a href="#l14.211"></a><span id="l14.211">   );</span>
<a href="#l14.212"></a><span id="l14.212">   Services.prefs.getDefaultBranch(&quot;&quot;).setBoolPref(controlPref, &quot;xxx&quot;);</span>
<a href="#l14.213"></a><span id="l14.213">   Services.prefs.lockPref(controlPref);</span>
<a href="#l14.214"></a><span id="l14.214"> </span>
<a href="#l14.215"></a><span id="l14.215">   // Refresh the pane by switching to another one.</span>
<a href="#l14.216"></a><span id="l14.216" class="difflineminus">-  accountRow = get_account_tree_row(gPopAccount.key, &quot;am-junk.xhtml&quot;, amc);</span>
<a href="#l14.217"></a><span id="l14.217" class="difflineminus">-  click_account_tree_row(amc, accountRow);</span>
<a href="#l14.218"></a><span id="l14.218" class="difflineplus">+  accountRow = get_account_tree_row(gPopAccount.key, &quot;am-junk.xhtml&quot;, tab);</span>
<a href="#l14.219"></a><span id="l14.219" class="difflineplus">+  click_account_tree_row(tab, accountRow);</span>
<a href="#l14.220"></a><span id="l14.220"> </span>
<a href="#l14.221"></a><span id="l14.221">   accountRow = get_account_tree_row(</span>
<a href="#l14.222"></a><span id="l14.222">     gPopAccount.key,</span>
<a href="#l14.223"></a><span id="l14.223">     &quot;am-addressing.xhtml&quot;,</span>
<a href="#l14.224"></a><span id="l14.224" class="difflineminus">-    amc</span>
<a href="#l14.225"></a><span id="l14.225" class="difflineplus">+    tab</span>
<a href="#l14.226"></a><span id="l14.226">   );</span>
<a href="#l14.227"></a><span id="l14.227" class="difflineminus">-  click_account_tree_row(amc, accountRow);</span>
<a href="#l14.228"></a><span id="l14.228" class="difflineplus">+  click_account_tree_row(tab, accountRow);</span>
<a href="#l14.229"></a><span id="l14.229"> </span>
<a href="#l14.230"></a><span id="l14.230">   // Re-assign iframe.contentDocument because it was lost when changing panes</span>
<a href="#l14.231"></a><span id="l14.231">   // (uses loadURI to load a new document).</span>
<a href="#l14.232"></a><span id="l14.232" class="difflineminus">-  iframe = amc.e(&quot;contentFrame&quot;).contentDocument;</span>
<a href="#l14.233"></a><span id="l14.233" class="difflineplus">+  iframe = tab.browser.contentWindow.document.getElementById(&quot;contentFrame&quot;)</span>
<a href="#l14.234"></a><span id="l14.234" class="difflineplus">+    .contentDocument;</span>
<a href="#l14.235"></a><span id="l14.235"> </span>
<a href="#l14.236"></a><span id="l14.236">   // We are now back and the 'different LDAP server' should still be selected</span>
<a href="#l14.237"></a><span id="l14.237">   // (the setting was saved).</span>
<a href="#l14.238"></a><span id="l14.238">   useLDAPdirectory = iframe.getElementById(&quot;directories&quot;);</span>
<a href="#l14.239"></a><span id="l14.239">   Assert.ok(useLDAPdirectory.selected);</span>
<a href="#l14.240"></a><span id="l14.240"> </span>
<a href="#l14.241"></a><span id="l14.241">   // But now the server selector should be disabled due to locked pref.</span>
<a href="#l14.242"></a><span id="l14.242">   LDAPdirectory = iframe.getElementById(&quot;identity.directoryServer&quot;);</span>
<a href="#l14.243"></a><span id="l14.243" class="difflineat">@@ -263,72 +271,74 @@ function subtest_check_locked_prefs_addr</span>
<a href="#l14.244"></a><span id="l14.244">   Services.prefs.getDefaultBranch(&quot;&quot;).deleteBranch(controlPref);</span>
<a href="#l14.245"></a><span id="l14.245"> }</span>
<a href="#l14.246"></a><span id="l14.246"> </span>
<a href="#l14.247"></a><span id="l14.247"> /**</span>
<a href="#l14.248"></a><span id="l14.248">  * Check that the POP3 'keep on server' settings elements (2-level</span>
<a href="#l14.249"></a><span id="l14.249">  * checkboxes + textbox) are properly disabled when their attached pref</span>
<a href="#l14.250"></a><span id="l14.250">  * (prefstring attribute) is locked.</span>
<a href="#l14.251"></a><span id="l14.251">  *</span>
<a href="#l14.252"></a><span id="l14.252" class="difflineminus">- * @param amc  the account options controller</span>
<a href="#l14.253"></a><span id="l14.253" class="difflineplus">+ * @param {Object} tab - The account manager tab.</span>
<a href="#l14.254"></a><span id="l14.254">  */</span>
<a href="#l14.255"></a><span id="l14.255" class="difflineminus">-function subtest_check_locked_prefs_server(amc) {</span>
<a href="#l14.256"></a><span id="l14.256" class="difflineplus">+function subtest_check_locked_prefs_server(tab) {</span>
<a href="#l14.257"></a><span id="l14.257">   let accountRow = get_account_tree_row(</span>
<a href="#l14.258"></a><span id="l14.258">     gPopAccount.key,</span>
<a href="#l14.259"></a><span id="l14.259">     &quot;am-server.xhtml&quot;,</span>
<a href="#l14.260"></a><span id="l14.260" class="difflineminus">-    amc</span>
<a href="#l14.261"></a><span id="l14.261" class="difflineplus">+    tab</span>
<a href="#l14.262"></a><span id="l14.262">   );</span>
<a href="#l14.263"></a><span id="l14.263" class="difflineminus">-  click_account_tree_row(amc, accountRow);</span>
<a href="#l14.264"></a><span id="l14.264" class="difflineplus">+  click_account_tree_row(tab, accountRow);</span>
<a href="#l14.265"></a><span id="l14.265"> </span>
<a href="#l14.266"></a><span id="l14.266" class="difflineminus">-  let iframe = amc.e(&quot;contentFrame&quot;).contentDocument;</span>
<a href="#l14.267"></a><span id="l14.267" class="difflineplus">+  let iframe = tab.browser.contentWindow.document.getElementById(&quot;contentFrame&quot;)</span>
<a href="#l14.268"></a><span id="l14.268" class="difflineplus">+    .contentDocument;</span>
<a href="#l14.269"></a><span id="l14.269"> </span>
<a href="#l14.270"></a><span id="l14.270">   // Top level leaveOnServer checkbox, disabled by default.</span>
<a href="#l14.271"></a><span id="l14.271">   let leaveOnServer = iframe.getElementById(&quot;pop3.leaveMessagesOnServer&quot;);</span>
<a href="#l14.272"></a><span id="l14.272">   Assert.ok(!leaveOnServer.disabled);</span>
<a href="#l14.273"></a><span id="l14.273">   Assert.ok(!leaveOnServer.checked);</span>
<a href="#l14.274"></a><span id="l14.274"> </span>
<a href="#l14.275"></a><span id="l14.275">   // Second level deleteByAge checkbox, disabled by default.</span>
<a href="#l14.276"></a><span id="l14.276">   let deleteByAge = iframe.getElementById(&quot;pop3.deleteByAgeFromServer&quot;);</span>
<a href="#l14.277"></a><span id="l14.277">   Assert.ok(deleteByAge.disabled);</span>
<a href="#l14.278"></a><span id="l14.278">   Assert.ok(!deleteByAge.checked);</span>
<a href="#l14.279"></a><span id="l14.279"> </span>
<a href="#l14.280"></a><span id="l14.280">   // Third level daysToLeave textbox, disabled by default.</span>
<a href="#l14.281"></a><span id="l14.281">   let daysToLeave = iframe.getElementById(&quot;pop3.numDaysToLeaveOnServer&quot;);</span>
<a href="#l14.282"></a><span id="l14.282">   Assert.ok(daysToLeave.disabled);</span>
<a href="#l14.283"></a><span id="l14.283"> </span>
<a href="#l14.284"></a><span id="l14.284">   // When leaveOnServer is checked, only deleteByAge will get enabled.</span>
<a href="#l14.285"></a><span id="l14.285" class="difflineminus">-  amc.check(new elib.Elem(leaveOnServer), true);</span>
<a href="#l14.286"></a><span id="l14.286" class="difflineplus">+  mc.check(new elib.Elem(leaveOnServer), true);</span>
<a href="#l14.287"></a><span id="l14.287">   Assert.ok(leaveOnServer.checked);</span>
<a href="#l14.288"></a><span id="l14.288">   Assert.ok(!deleteByAge.disabled);</span>
<a href="#l14.289"></a><span id="l14.289">   Assert.ok(daysToLeave.disabled);</span>
<a href="#l14.290"></a><span id="l14.290"> </span>
<a href="#l14.291"></a><span id="l14.291">   // When deleteByAge is checked, daysToLeave will get enabled.</span>
<a href="#l14.292"></a><span id="l14.292" class="difflineminus">-  amc.check(new elib.Elem(deleteByAge), true);</span>
<a href="#l14.293"></a><span id="l14.293" class="difflineplus">+  mc.check(new elib.Elem(deleteByAge), true);</span>
<a href="#l14.294"></a><span id="l14.294">   Assert.ok(deleteByAge.checked);</span>
<a href="#l14.295"></a><span id="l14.295">   Assert.ok(!daysToLeave.disabled);</span>
<a href="#l14.296"></a><span id="l14.296"> </span>
<a href="#l14.297"></a><span id="l14.297">   // Lock the pref deleteByAge checkbox (middle of the element hierarchy).</span>
<a href="#l14.298"></a><span id="l14.298">   let prefstring = deleteByAge.getAttribute(&quot;prefstring&quot;);</span>
<a href="#l14.299"></a><span id="l14.299">   let controlPref = prefstring.replace(</span>
<a href="#l14.300"></a><span id="l14.300">     &quot;%serverkey%&quot;,</span>
<a href="#l14.301"></a><span id="l14.301">     gPopAccount.incomingServer.key</span>
<a href="#l14.302"></a><span id="l14.302">   );</span>
<a href="#l14.303"></a><span id="l14.303">   Services.prefs.getDefaultBranch(&quot;&quot;).setBoolPref(controlPref, true);</span>
<a href="#l14.304"></a><span id="l14.304">   Services.prefs.lockPref(controlPref);</span>
<a href="#l14.305"></a><span id="l14.305"> </span>
<a href="#l14.306"></a><span id="l14.306">   // Refresh the pane by switching to another one.</span>
<a href="#l14.307"></a><span id="l14.307" class="difflineminus">-  accountRow = get_account_tree_row(gPopAccount.key, &quot;am-junk.xhtml&quot;, amc);</span>
<a href="#l14.308"></a><span id="l14.308" class="difflineminus">-  click_account_tree_row(amc, accountRow);</span>
<a href="#l14.309"></a><span id="l14.309" class="difflineplus">+  accountRow = get_account_tree_row(gPopAccount.key, &quot;am-junk.xhtml&quot;, tab);</span>
<a href="#l14.310"></a><span id="l14.310" class="difflineplus">+  click_account_tree_row(tab, accountRow);</span>
<a href="#l14.311"></a><span id="l14.311"> </span>
<a href="#l14.312"></a><span id="l14.312" class="difflineminus">-  accountRow = get_account_tree_row(gPopAccount.key, &quot;am-server.xhtml&quot;, amc);</span>
<a href="#l14.313"></a><span id="l14.313" class="difflineminus">-  click_account_tree_row(amc, accountRow);</span>
<a href="#l14.314"></a><span id="l14.314" class="difflineplus">+  accountRow = get_account_tree_row(gPopAccount.key, &quot;am-server.xhtml&quot;, tab);</span>
<a href="#l14.315"></a><span id="l14.315" class="difflineplus">+  click_account_tree_row(tab, accountRow);</span>
<a href="#l14.316"></a><span id="l14.316"> </span>
<a href="#l14.317"></a><span id="l14.317">   // Re-assign iframe.contentDocument because it was lost when changing panes</span>
<a href="#l14.318"></a><span id="l14.318">   // (uses loadURI to load a new document).</span>
<a href="#l14.319"></a><span id="l14.319" class="difflineminus">-  iframe = amc.e(&quot;contentFrame&quot;).contentDocument;</span>
<a href="#l14.320"></a><span id="l14.320" class="difflineplus">+  iframe = tab.browser.contentWindow.document.getElementById(&quot;contentFrame&quot;)</span>
<a href="#l14.321"></a><span id="l14.321" class="difflineplus">+    .contentDocument;</span>
<a href="#l14.322"></a><span id="l14.322"> </span>
<a href="#l14.323"></a><span id="l14.323">   // Now leaveOnServer was preserved as checked.</span>
<a href="#l14.324"></a><span id="l14.324">   leaveOnServer = iframe.getElementById(&quot;pop3.leaveMessagesOnServer&quot;);</span>
<a href="#l14.325"></a><span id="l14.325">   Assert.ok(!leaveOnServer.disabled);</span>
<a href="#l14.326"></a><span id="l14.326">   Assert.ok(leaveOnServer.checked);</span>
<a href="#l14.327"></a><span id="l14.327"> </span>
<a href="#l14.328"></a><span id="l14.328">   // Now deleteByAge was preserved as checked but is locked/disabled.</span>
<a href="#l14.329"></a><span id="l14.329">   deleteByAge = iframe.getElementById(&quot;pop3.deleteByAgeFromServer&quot;);</span>
<a href="#l14.330"></a><span id="l14.330" class="difflineat">@@ -336,17 +346,17 @@ function subtest_check_locked_prefs_serv</span>
<a href="#l14.331"></a><span id="l14.331">   Assert.ok(deleteByAge.checked);</span>
<a href="#l14.332"></a><span id="l14.332"> </span>
<a href="#l14.333"></a><span id="l14.333">   // Because deleteByAge is checked, daysToLeave should be enabled.</span>
<a href="#l14.334"></a><span id="l14.334">   daysToLeave = iframe.getElementById(&quot;pop3.numDaysToLeaveOnServer&quot;);</span>
<a href="#l14.335"></a><span id="l14.335">   Assert.ok(!daysToLeave.disabled);</span>
<a href="#l14.336"></a><span id="l14.336"> </span>
<a href="#l14.337"></a><span id="l14.337">   // When leaveOnserver is unchecked, both of deleteByAge and daysToLeave</span>
<a href="#l14.338"></a><span id="l14.338">   // should get disabled.</span>
<a href="#l14.339"></a><span id="l14.339" class="difflineminus">-  amc.check(new elib.Elem(leaveOnServer), false);</span>
<a href="#l14.340"></a><span id="l14.340" class="difflineplus">+  mc.check(new elib.Elem(leaveOnServer), false);</span>
<a href="#l14.341"></a><span id="l14.341">   Assert.ok(!leaveOnServer.disabled);</span>
<a href="#l14.342"></a><span id="l14.342">   Assert.ok(!leaveOnServer.checked);</span>
<a href="#l14.343"></a><span id="l14.343"> </span>
<a href="#l14.344"></a><span id="l14.344">   Assert.ok(deleteByAge.disabled);</span>
<a href="#l14.345"></a><span id="l14.345">   Assert.ok(deleteByAge.checked);</span>
<a href="#l14.346"></a><span id="l14.346">   Assert.ok(daysToLeave.disabled);</span>
<a href="#l14.347"></a><span id="l14.347"> </span>
<a href="#l14.348"></a><span id="l14.348">   // Unlock the pref to clean up.</span>
<a href="#l14.349"></a><span id="l14.349" class="difflineat">@@ -356,100 +366,103 @@ function subtest_check_locked_prefs_serv</span>
<a href="#l14.350"></a><span id="l14.350"> </span>
<a href="#l14.351"></a><span id="l14.351"> /**</span>
<a href="#l14.352"></a><span id="l14.352">  * Bug 530142.</span>
<a href="#l14.353"></a><span id="l14.353">  * Check that that if one field is set to a value, switching directly to another</span>
<a href="#l14.354"></a><span id="l14.354">  * account pane showing the same field really loads the value from the new account,</span>
<a href="#l14.355"></a><span id="l14.355">  * even when empty. This is tested on the Reply-To field.</span>
<a href="#l14.356"></a><span id="l14.356">  */</span>
<a href="#l14.357"></a><span id="l14.357"> add_task(function test_replyTo_leak() {</span>
<a href="#l14.358"></a><span id="l14.358" class="difflineminus">-  open_advanced_settings(function(amc) {</span>
<a href="#l14.359"></a><span id="l14.359" class="difflineminus">-    subtest_check_replyTo_leak(amc);</span>
<a href="#l14.360"></a><span id="l14.360" class="difflineplus">+  open_advanced_settings(function(tab) {</span>
<a href="#l14.361"></a><span id="l14.361" class="difflineplus">+    subtest_check_replyTo_leak(tab);</span>
<a href="#l14.362"></a><span id="l14.362">   });</span>
<a href="#l14.363"></a><span id="l14.363"> });</span>
<a href="#l14.364"></a><span id="l14.364"> </span>
<a href="#l14.365"></a><span id="l14.365"> /**</span>
<a href="#l14.366"></a><span id="l14.366" class="difflineminus">- * @param amc  the account options controller</span>
<a href="#l14.367"></a><span id="l14.367" class="difflineplus">+ * @param {Object} tab - The account manager tab.</span>
<a href="#l14.368"></a><span id="l14.368">  */</span>
<a href="#l14.369"></a><span id="l14.369" class="difflineminus">-function subtest_check_replyTo_leak(amc) {</span>
<a href="#l14.370"></a><span id="l14.370" class="difflineminus">-  let accountRow = get_account_tree_row(gPopAccount.key, null, amc);</span>
<a href="#l14.371"></a><span id="l14.371" class="difflineminus">-  click_account_tree_row(amc, accountRow);</span>
<a href="#l14.372"></a><span id="l14.372" class="difflineplus">+function subtest_check_replyTo_leak(tab) {</span>
<a href="#l14.373"></a><span id="l14.373" class="difflineplus">+  let accountRow = get_account_tree_row(gPopAccount.key, null, tab);</span>
<a href="#l14.374"></a><span id="l14.374" class="difflineplus">+  click_account_tree_row(tab, accountRow);</span>
<a href="#l14.375"></a><span id="l14.375"> </span>
<a href="#l14.376"></a><span id="l14.376" class="difflineminus">-  let iframe = amc.window.document.getElementById(&quot;contentFrame&quot;);</span>
<a href="#l14.377"></a><span id="l14.377" class="difflineplus">+  let iframe = tab.browser.contentWindow.document.getElementById(&quot;contentFrame&quot;)</span>
<a href="#l14.378"></a><span id="l14.378" class="difflineplus">+    .contentDocument;</span>
<a href="#l14.379"></a><span id="l14.379"> </span>
<a href="#l14.380"></a><span id="l14.380">   // The Reply-To field should be empty.</span>
<a href="#l14.381"></a><span id="l14.381" class="difflineminus">-  let replyAddress = iframe.contentDocument.getElementById(&quot;identity.replyTo&quot;);</span>
<a href="#l14.382"></a><span id="l14.382" class="difflineplus">+  let replyAddress = iframe.getElementById(&quot;identity.replyTo&quot;);</span>
<a href="#l14.383"></a><span id="l14.383">   Assert.equal(replyAddress.value, &quot;&quot;);</span>
<a href="#l14.384"></a><span id="l14.384"> </span>
<a href="#l14.385"></a><span id="l14.385">   // Now we set a value into it and switch to another account, the main pane.</span>
<a href="#l14.386"></a><span id="l14.386">   replyAddress.value = &quot;somewhere@else.com&quot;;</span>
<a href="#l14.387"></a><span id="l14.387"> </span>
<a href="#l14.388"></a><span id="l14.388">   // This test expects the following POP account to exist by default</span>
<a href="#l14.389"></a><span id="l14.389">   // in the test profile with port number 110 and no security.</span>
<a href="#l14.390"></a><span id="l14.390">   let firstServer = MailServices.accounts.FindServer(</span>
<a href="#l14.391"></a><span id="l14.391">     &quot;tinderbox&quot;,</span>
<a href="#l14.392"></a><span id="l14.392">     FAKE_SERVER_HOSTNAME,</span>
<a href="#l14.393"></a><span id="l14.393">     &quot;pop3&quot;</span>
<a href="#l14.394"></a><span id="l14.394">   );</span>
<a href="#l14.395"></a><span id="l14.395">   let firstAccount = MailServices.accounts.FindAccountForServer(firstServer);</span>
<a href="#l14.396"></a><span id="l14.396"> </span>
<a href="#l14.397"></a><span id="l14.397" class="difflineminus">-  accountRow = get_account_tree_row(firstAccount.key, null, amc);</span>
<a href="#l14.398"></a><span id="l14.398" class="difflineminus">-  click_account_tree_row(amc, accountRow);</span>
<a href="#l14.399"></a><span id="l14.399" class="difflineplus">+  accountRow = get_account_tree_row(firstAccount.key, null, tab);</span>
<a href="#l14.400"></a><span id="l14.400" class="difflineplus">+  click_account_tree_row(tab, accountRow);</span>
<a href="#l14.401"></a><span id="l14.401"> </span>
<a href="#l14.402"></a><span id="l14.402">   // the Reply-To field should be empty as this account does not have it set.</span>
<a href="#l14.403"></a><span id="l14.403" class="difflineminus">-  replyAddress = iframe.contentDocument.getElementById(&quot;identity.replyTo&quot;);</span>
<a href="#l14.404"></a><span id="l14.404" class="difflineplus">+  replyAddress = iframe.getElementById(&quot;identity.replyTo&quot;);</span>
<a href="#l14.405"></a><span id="l14.405">   Assert.equal(replyAddress.value, &quot;&quot;);</span>
<a href="#l14.406"></a><span id="l14.406"> }</span>
<a href="#l14.407"></a><span id="l14.407"> </span>
<a href="#l14.408"></a><span id="l14.408"> /**</span>
<a href="#l14.409"></a><span id="l14.409">  * Test for bug 804091.</span>
<a href="#l14.410"></a><span id="l14.410">  * Check if onchange handlers are properly executed when panes are switched.</span>
<a href="#l14.411"></a><span id="l14.411">  */</span>
<a href="#l14.412"></a><span id="l14.412"> add_task(function test_account_onchange_handler() {</span>
<a href="#l14.413"></a><span id="l14.413" class="difflineminus">-  open_advanced_settings(function(amc) {</span>
<a href="#l14.414"></a><span id="l14.414" class="difflineminus">-    subtest_check_onchange_handler(amc);</span>
<a href="#l14.415"></a><span id="l14.415" class="difflineplus">+  open_advanced_settings(function(tab) {</span>
<a href="#l14.416"></a><span id="l14.416" class="difflineplus">+    subtest_check_onchange_handler(tab);</span>
<a href="#l14.417"></a><span id="l14.417">   });</span>
<a href="#l14.418"></a><span id="l14.418"> });</span>
<a href="#l14.419"></a><span id="l14.419"> </span>
<a href="#l14.420"></a><span id="l14.420"> /**</span>
<a href="#l14.421"></a><span id="l14.421">  * Check if onchange handlers are properly executed when panes are switched.</span>
<a href="#l14.422"></a><span id="l14.422">  *</span>
<a href="#l14.423"></a><span id="l14.423" class="difflineminus">- * @param amc  the account options controller</span>
<a href="#l14.424"></a><span id="l14.424" class="difflineplus">+ * @param {Object} tab - The account manager tab.</span>
<a href="#l14.425"></a><span id="l14.425">  */</span>
<a href="#l14.426"></a><span id="l14.426" class="difflineminus">-function subtest_check_onchange_handler(amc) {</span>
<a href="#l14.427"></a><span id="l14.427" class="difflineplus">+function subtest_check_onchange_handler(tab) {</span>
<a href="#l14.428"></a><span id="l14.428">   let accountRow = get_account_tree_row(</span>
<a href="#l14.429"></a><span id="l14.429">     gImapAccount.key,</span>
<a href="#l14.430"></a><span id="l14.430">     &quot;am-offline.xhtml&quot;,</span>
<a href="#l14.431"></a><span id="l14.431" class="difflineminus">-    amc</span>
<a href="#l14.432"></a><span id="l14.432" class="difflineplus">+    tab</span>
<a href="#l14.433"></a><span id="l14.433">   );</span>
<a href="#l14.434"></a><span id="l14.434" class="difflineminus">-  click_account_tree_row(amc, accountRow);</span>
<a href="#l14.435"></a><span id="l14.435" class="difflineplus">+  click_account_tree_row(tab, accountRow);</span>
<a href="#l14.436"></a><span id="l14.436"> </span>
<a href="#l14.437"></a><span id="l14.437" class="difflineminus">-  let iframe = amc.e(&quot;contentFrame&quot;).contentDocument;</span>
<a href="#l14.438"></a><span id="l14.438" class="difflineplus">+  let iframe = tab.browser.contentWindow.document.getElementById(&quot;contentFrame&quot;)</span>
<a href="#l14.439"></a><span id="l14.439" class="difflineplus">+    .contentDocument;</span>
<a href="#l14.440"></a><span id="l14.440"> </span>
<a href="#l14.441"></a><span id="l14.441">   let autoSync = iframe.getElementById(&quot;autosyncValue&quot;);</span>
<a href="#l14.442"></a><span id="l14.442">   // 30 is the default value so check if we are in clean state.</span>
<a href="#l14.443"></a><span id="l14.443">   Assert.equal(autoSync.value, 30);</span>
<a href="#l14.444"></a><span id="l14.444"> </span>
<a href="#l14.445"></a><span id="l14.445">   let autoSyncInterval = iframe.getElementById(&quot;autosyncInterval&quot;);</span>
<a href="#l14.446"></a><span id="l14.446">   // 1 is the default value and means the 30 is in days.</span>
<a href="#l14.447"></a><span id="l14.447">   Assert.equal(autoSyncInterval.value, 1);</span>
<a href="#l14.448"></a><span id="l14.448"> </span>
<a href="#l14.449"></a><span id="l14.449">   // Now type in 35 (days).</span>
<a href="#l14.450"></a><span id="l14.450" class="difflineminus">-  amc.radio(new elib.ID(iframe, &quot;useAutosync.ByAge&quot;));</span>
<a href="#l14.451"></a><span id="l14.451" class="difflineplus">+  mc.radio(new elib.ID(iframe, &quot;useAutosync.ByAge&quot;));</span>
<a href="#l14.452"></a><span id="l14.452">   autoSync.select();</span>
<a href="#l14.453"></a><span id="l14.453" class="difflineminus">-  amc.type(new elib.Elem(autoSync), &quot;35&quot;);</span>
<a href="#l14.454"></a><span id="l14.454" class="difflineplus">+  mc.type(new elib.Elem(autoSync), &quot;35&quot;);</span>
<a href="#l14.455"></a><span id="l14.455"> </span>
<a href="#l14.456"></a><span id="l14.456">   // Immediately switch to another pane and back.</span>
<a href="#l14.457"></a><span id="l14.457" class="difflineminus">-  accountRow = get_account_tree_row(gImapAccount.key, &quot;am-junk.xhtml&quot;, amc);</span>
<a href="#l14.458"></a><span id="l14.458" class="difflineminus">-  click_account_tree_row(amc, accountRow);</span>
<a href="#l14.459"></a><span id="l14.459" class="difflineplus">+  accountRow = get_account_tree_row(gImapAccount.key, &quot;am-junk.xhtml&quot;, tab);</span>
<a href="#l14.460"></a><span id="l14.460" class="difflineplus">+  click_account_tree_row(tab, accountRow);</span>
<a href="#l14.461"></a><span id="l14.461"> </span>
<a href="#l14.462"></a><span id="l14.462" class="difflineminus">-  accountRow = get_account_tree_row(gImapAccount.key, &quot;am-offline.xhtml&quot;, amc);</span>
<a href="#l14.463"></a><span id="l14.463" class="difflineminus">-  click_account_tree_row(amc, accountRow);</span>
<a href="#l14.464"></a><span id="l14.464" class="difflineplus">+  accountRow = get_account_tree_row(gImapAccount.key, &quot;am-offline.xhtml&quot;, tab);</span>
<a href="#l14.465"></a><span id="l14.465" class="difflineplus">+  click_account_tree_row(tab, accountRow);</span>
<a href="#l14.466"></a><span id="l14.466"> </span>
<a href="#l14.467"></a><span id="l14.467" class="difflineminus">-  iframe = amc.e(&quot;contentFrame&quot;).contentDocument;</span>
<a href="#l14.468"></a><span id="l14.468" class="difflineplus">+  iframe = tab.browser.contentWindow.document.getElementById(&quot;contentFrame&quot;)</span>
<a href="#l14.469"></a><span id="l14.469" class="difflineplus">+    .contentDocument;</span>
<a href="#l14.470"></a><span id="l14.470"> </span>
<a href="#l14.471"></a><span id="l14.471">   // The pane optimized the entered value a bit. So now we should find 5.</span>
<a href="#l14.472"></a><span id="l14.472">   autoSync = iframe.getElementById(&quot;autosyncValue&quot;);</span>
<a href="#l14.473"></a><span id="l14.473">   Assert.equal(autoSync.value, 5);</span>
<a href="#l14.474"></a><span id="l14.474"> </span>
<a href="#l14.475"></a><span id="l14.475">   // And the unit is 7 days = week.</span>
<a href="#l14.476"></a><span id="l14.476">   autoSyncInterval = iframe.getElementById(&quot;autosyncInterval&quot;);</span>
<a href="#l14.477"></a><span id="l14.477">   Assert.equal(autoSyncInterval.value, 7);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mail/test/browser/account/browser_tree.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mail/test/browser/account/browser_tree.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -16,16 +16,20 @@ var {</span>
<a href="#l15.4"></a><span id="l15.4"> } = ChromeUtils.import(</span>
<a href="#l15.5"></a><span id="l15.5">   &quot;resource://testing-common/mozmill/AccountManagerHelpers.jsm&quot;</span>
<a href="#l15.6"></a><span id="l15.6"> );</span>
<a href="#l15.7"></a><span id="l15.7"> </span>
<a href="#l15.8"></a><span id="l15.8"> var { MailServices } = ChromeUtils.import(</span>
<a href="#l15.9"></a><span id="l15.9">   &quot;resource:///modules/MailServices.jsm&quot;</span>
<a href="#l15.10"></a><span id="l15.10"> );</span>
<a href="#l15.11"></a><span id="l15.11"> </span>
<a href="#l15.12"></a><span id="l15.12" class="difflineplus">+var { content_tab_e } = ChromeUtils.import(</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+  &quot;resource://testing-common/mozmill/ContentTabHelpers.jsm&quot;</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineplus">+);</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineplus">+</span>
<a href="#l15.16"></a><span id="l15.16"> var gPopAccount, gOriginalAccountCount;</span>
<a href="#l15.17"></a><span id="l15.17"> </span>
<a href="#l15.18"></a><span id="l15.18"> add_task(function setupModule(module) {</span>
<a href="#l15.19"></a><span id="l15.19">   // There may be pre-existing accounts from other tests.</span>
<a href="#l15.20"></a><span id="l15.20">   gOriginalAccountCount = MailServices.accounts.allServers.length;</span>
<a href="#l15.21"></a><span id="l15.21"> </span>
<a href="#l15.22"></a><span id="l15.22">   // Create a POP server</span>
<a href="#l15.23"></a><span id="l15.23">   let popServer = MailServices.accounts</span>
<a href="#l15.24"></a><span id="l15.24" class="difflineat">@@ -56,144 +60,146 @@ registerCleanupFunction(function teardow</span>
<a href="#l15.25"></a><span id="l15.25">   Assert.equal(MailServices.accounts.allServers.length, gOriginalAccountCount);</span>
<a href="#l15.26"></a><span id="l15.26"> });</span>
<a href="#l15.27"></a><span id="l15.27"> </span>
<a href="#l15.28"></a><span id="l15.28"> /**</span>
<a href="#l15.29"></a><span id="l15.29">  * Test for bug 536248.</span>
<a href="#l15.30"></a><span id="l15.30">  * Check if the account manager dialog remembers the open state of accounts.</span>
<a href="#l15.31"></a><span id="l15.31">  */</span>
<a href="#l15.32"></a><span id="l15.32"> add_task(function test_account_open_state() {</span>
<a href="#l15.33"></a><span id="l15.33" class="difflineminus">-  open_advanced_settings(function(amc) {</span>
<a href="#l15.34"></a><span id="l15.34" class="difflineminus">-    subtest_check_account_open_state(amc, true);</span>
<a href="#l15.35"></a><span id="l15.35" class="difflineplus">+  open_advanced_settings(function(tab) {</span>
<a href="#l15.36"></a><span id="l15.36" class="difflineplus">+    subtest_check_account_open_state(tab, true);</span>
<a href="#l15.37"></a><span id="l15.37">   });</span>
<a href="#l15.38"></a><span id="l15.38" class="difflineminus">-  open_advanced_settings(function(amc) {</span>
<a href="#l15.39"></a><span id="l15.39" class="difflineminus">-    subtest_check_account_open_state(amc, false);</span>
<a href="#l15.40"></a><span id="l15.40" class="difflineplus">+  open_advanced_settings(function(tab) {</span>
<a href="#l15.41"></a><span id="l15.41" class="difflineplus">+    subtest_check_account_open_state(tab, false);</span>
<a href="#l15.42"></a><span id="l15.42">   });</span>
<a href="#l15.43"></a><span id="l15.43">   // After this test all the accounts must be &quot;open&quot;.</span>
<a href="#l15.44"></a><span id="l15.44"> });</span>
<a href="#l15.45"></a><span id="l15.45"> </span>
<a href="#l15.46"></a><span id="l15.46"> /**</span>
<a href="#l15.47"></a><span id="l15.47">  * Check if the open state of accounts is in the wished state.</span>
<a href="#l15.48"></a><span id="l15.48">  *</span>
<a href="#l15.49"></a><span id="l15.49" class="difflineminus">- * @param amc           The account options controller.</span>
<a href="#l15.50"></a><span id="l15.50" class="difflineminus">- * @param aWishedState  The open state in which the account row should be found (bool).</span>
<a href="#l15.51"></a><span id="l15.51" class="difflineplus">+ * @param {Object} tab - The account manager tab.</span>
<a href="#l15.52"></a><span id="l15.52" class="difflineplus">+ * @param {boolean} wishedState - The open state in which the account row should be found.</span>
<a href="#l15.53"></a><span id="l15.53">  */</span>
<a href="#l15.54"></a><span id="l15.54" class="difflineminus">-function subtest_check_account_open_state(amc, aWishedState) {</span>
<a href="#l15.55"></a><span id="l15.55" class="difflineminus">-  let accountRow = get_account_tree_row(gPopAccount.key, null, amc);</span>
<a href="#l15.56"></a><span id="l15.56" class="difflineminus">-  click_account_tree_row(amc, accountRow);</span>
<a href="#l15.57"></a><span id="l15.57" class="difflineplus">+function subtest_check_account_open_state(tab, wishedState) {</span>
<a href="#l15.58"></a><span id="l15.58" class="difflineplus">+  let accountRow = get_account_tree_row(gPopAccount.key, null, tab);</span>
<a href="#l15.59"></a><span id="l15.59" class="difflineplus">+  click_account_tree_row(tab, accountRow);</span>
<a href="#l15.60"></a><span id="l15.60"> </span>
<a href="#l15.61"></a><span id="l15.61">   // See if the account row is in the wished open state.</span>
<a href="#l15.62"></a><span id="l15.62" class="difflineminus">-  let accountTree = amc.e(&quot;accounttree&quot;);</span>
<a href="#l15.63"></a><span id="l15.63" class="difflineplus">+  let accountTree = content_tab_e(tab, &quot;accounttree&quot;);</span>
<a href="#l15.64"></a><span id="l15.64">   Assert.equal(accountRow, accountTree.view.selection.currentIndex);</span>
<a href="#l15.65"></a><span id="l15.65" class="difflineminus">-  Assert.equal(accountTree.view.isContainerOpen(accountRow), aWishedState);</span>
<a href="#l15.66"></a><span id="l15.66" class="difflineplus">+  Assert.equal(accountTree.view.isContainerOpen(accountRow), wishedState);</span>
<a href="#l15.67"></a><span id="l15.67"> </span>
<a href="#l15.68"></a><span id="l15.68">   accountTree.view.toggleOpenState(accountRow);</span>
<a href="#l15.69"></a><span id="l15.69" class="difflineminus">-  Assert.equal(accountTree.view.isContainerOpen(accountRow), !aWishedState);</span>
<a href="#l15.70"></a><span id="l15.70" class="difflineplus">+  Assert.equal(accountTree.view.isContainerOpen(accountRow), !wishedState);</span>
<a href="#l15.71"></a><span id="l15.71"> </span>
<a href="#l15.72"></a><span id="l15.72">   // Whatever the open state of the account was, selecting one of its subpanes</span>
<a href="#l15.73"></a><span id="l15.73">   // must open it.</span>
<a href="#l15.74"></a><span id="l15.74" class="difflineminus">-  amc.window.selectServer(gPopAccount.incomingServer, &quot;am-junk.xhtml&quot;);</span>
<a href="#l15.75"></a><span id="l15.75" class="difflineplus">+  tab.browser.contentWindow.selectServer(</span>
<a href="#l15.76"></a><span id="l15.76" class="difflineplus">+    gPopAccount.incomingServer,</span>
<a href="#l15.77"></a><span id="l15.77" class="difflineplus">+    &quot;am-junk.xhtml&quot;</span>
<a href="#l15.78"></a><span id="l15.78" class="difflineplus">+  );</span>
<a href="#l15.79"></a><span id="l15.79">   Assert.ok(accountTree.view.isContainerOpen(accountRow));</span>
<a href="#l15.80"></a><span id="l15.80"> </span>
<a href="#l15.81"></a><span id="l15.81">   // Set the proper state again for continuation of the test.</span>
<a href="#l15.82"></a><span id="l15.82">   accountTree.view</span>
<a href="#l15.83"></a><span id="l15.83">     .getItemAtIndex(accountRow)</span>
<a href="#l15.84"></a><span id="l15.84" class="difflineminus">-    .setAttribute(&quot;open&quot;, !aWishedState);</span>
<a href="#l15.85"></a><span id="l15.85" class="difflineminus">-  Assert.equal(accountTree.view.isContainerOpen(accountRow), !aWishedState);</span>
<a href="#l15.86"></a><span id="l15.86" class="difflineplus">+    .setAttribute(&quot;open&quot;, !wishedState);</span>
<a href="#l15.87"></a><span id="l15.87" class="difflineplus">+  Assert.equal(accountTree.view.isContainerOpen(accountRow), !wishedState);</span>
<a href="#l15.88"></a><span id="l15.88"> }</span>
<a href="#l15.89"></a><span id="l15.89"> </span>
<a href="#l15.90"></a><span id="l15.90"> /**</span>
<a href="#l15.91"></a><span id="l15.91">  * Bug 740617.</span>
<a href="#l15.92"></a><span id="l15.92">  * Check if the default account is styled in bold.</span>
<a href="#l15.93"></a><span id="l15.93" class="difflineminus">- *</span>
<a href="#l15.94"></a><span id="l15.94">  */</span>
<a href="#l15.95"></a><span id="l15.95"> add_task(function test_default_account_highlight() {</span>
<a href="#l15.96"></a><span id="l15.96" class="difflineminus">-  open_advanced_settings(function(amc) {</span>
<a href="#l15.97"></a><span id="l15.97" class="difflineminus">-    subtest_check_default_account_highlight(amc);</span>
<a href="#l15.98"></a><span id="l15.98" class="difflineplus">+  open_advanced_settings(function(tab) {</span>
<a href="#l15.99"></a><span id="l15.99" class="difflineplus">+    subtest_check_default_account_highlight(tab);</span>
<a href="#l15.100"></a><span id="l15.100">   });</span>
<a href="#l15.101"></a><span id="l15.101"> });</span>
<a href="#l15.102"></a><span id="l15.102"> </span>
<a href="#l15.103"></a><span id="l15.103"> /**</span>
<a href="#l15.104"></a><span id="l15.104">  * Check if the default account is styled in bold and another account is not.</span>
<a href="#l15.105"></a><span id="l15.105">  *</span>
<a href="#l15.106"></a><span id="l15.106" class="difflineminus">- * @param amc           The account options controller.</span>
<a href="#l15.107"></a><span id="l15.107" class="difflineplus">+ * @param {Object} tab - The account manager tab.</span>
<a href="#l15.108"></a><span id="l15.108">  */</span>
<a href="#l15.109"></a><span id="l15.109" class="difflineminus">-function subtest_check_default_account_highlight(amc) {</span>
<a href="#l15.110"></a><span id="l15.110" class="difflineplus">+function subtest_check_default_account_highlight(tab) {</span>
<a href="#l15.111"></a><span id="l15.111">   // Select the default account.</span>
<a href="#l15.112"></a><span id="l15.112">   let accountRow = get_account_tree_row(</span>
<a href="#l15.113"></a><span id="l15.113">     MailServices.accounts.defaultAccount.key,</span>
<a href="#l15.114"></a><span id="l15.114">     null,</span>
<a href="#l15.115"></a><span id="l15.115" class="difflineminus">-    amc</span>
<a href="#l15.116"></a><span id="l15.116" class="difflineplus">+    tab</span>
<a href="#l15.117"></a><span id="l15.117">   );</span>
<a href="#l15.118"></a><span id="l15.118" class="difflineminus">-  click_account_tree_row(amc, accountRow);</span>
<a href="#l15.119"></a><span id="l15.119" class="difflineplus">+  click_account_tree_row(tab, accountRow);</span>
<a href="#l15.120"></a><span id="l15.120"> </span>
<a href="#l15.121"></a><span id="l15.121" class="difflineminus">-  let accountTree = amc.e(&quot;accounttree&quot;);</span>
<a href="#l15.122"></a><span id="l15.122" class="difflineplus">+  let accountTree = content_tab_e(tab, &quot;accounttree&quot;);</span>
<a href="#l15.123"></a><span id="l15.123">   Assert.equal(accountRow, accountTree.view.selection.currentIndex);</span>
<a href="#l15.124"></a><span id="l15.124">   let cell = accountTree.view.getItemAtIndex(accountRow).firstElementChild</span>
<a href="#l15.125"></a><span id="l15.125">     .firstElementChild;</span>
<a href="#l15.126"></a><span id="l15.126">   Assert.equal(cell.tagName, &quot;treecell&quot;);</span>
<a href="#l15.127"></a><span id="l15.127"> </span>
<a href="#l15.128"></a><span id="l15.128">   // We can't read the computed style of the tree cell directly, so at least see</span>
<a href="#l15.129"></a><span id="l15.129">   // if the isDefaultServer-true property is set on it. Hopefully the proper style</span>
<a href="#l15.130"></a><span id="l15.130">   // is attached to this property.</span>
<a href="#l15.131"></a><span id="l15.131">   let propArray = accountTree.view</span>
<a href="#l15.132"></a><span id="l15.132">     .getCellProperties(accountRow, accountTree.columns.getColumnAt(0))</span>
<a href="#l15.133"></a><span id="l15.133">     .split(&quot; &quot;);</span>
<a href="#l15.134"></a><span id="l15.134">   Assert.ok(propArray.includes(&quot;isDefaultServer-true&quot;));</span>
<a href="#l15.135"></a><span id="l15.135"> </span>
<a href="#l15.136"></a><span id="l15.136">   // Now select another account that is not default.</span>
<a href="#l15.137"></a><span id="l15.137" class="difflineminus">-  accountRow = get_account_tree_row(gPopAccount.key, null, amc);</span>
<a href="#l15.138"></a><span id="l15.138" class="difflineminus">-  click_account_tree_row(amc, accountRow);</span>
<a href="#l15.139"></a><span id="l15.139" class="difflineplus">+  accountRow = get_account_tree_row(gPopAccount.key, null, tab);</span>
<a href="#l15.140"></a><span id="l15.140" class="difflineplus">+  click_account_tree_row(tab, accountRow);</span>
<a href="#l15.141"></a><span id="l15.141"> </span>
<a href="#l15.142"></a><span id="l15.142">   // There should isDefaultServer-true on its tree cell.</span>
<a href="#l15.143"></a><span id="l15.143">   propArray = accountTree.view</span>
<a href="#l15.144"></a><span id="l15.144">     .getCellProperties(accountRow, accountTree.columns.getColumnAt(0))</span>
<a href="#l15.145"></a><span id="l15.145">     .split(&quot; &quot;);</span>
<a href="#l15.146"></a><span id="l15.146">   Assert.ok(!propArray.includes(&quot;isDefaultServer-true&quot;));</span>
<a href="#l15.147"></a><span id="l15.147"> }</span>
<a href="#l15.148"></a><span id="l15.148"> /**</span>
<a href="#l15.149"></a><span id="l15.149">  * Bug 58713.</span>
<a href="#l15.150"></a><span id="l15.150">  * Check if after deleting an account the next one is selected.</span>
<a href="#l15.151"></a><span id="l15.151">  *</span>
<a href="#l15.152"></a><span id="l15.152">  * This test should always be the last one as it removes our specially</span>
<a href="#l15.153"></a><span id="l15.153">  * created gPopAccount.</span>
<a href="#l15.154"></a><span id="l15.154">  */</span>
<a href="#l15.155"></a><span id="l15.155"> add_task(function test_selection_after_account_deletion() {</span>
<a href="#l15.156"></a><span id="l15.156" class="difflineminus">-  open_advanced_settings(function(amc) {</span>
<a href="#l15.157"></a><span id="l15.157" class="difflineminus">-    subtest_check_selection_after_account_deletion(amc);</span>
<a href="#l15.158"></a><span id="l15.158" class="difflineplus">+  open_advanced_settings(function(tab) {</span>
<a href="#l15.159"></a><span id="l15.159" class="difflineplus">+    subtest_check_selection_after_account_deletion(tab);</span>
<a href="#l15.160"></a><span id="l15.160">   });</span>
<a href="#l15.161"></a><span id="l15.161"> });</span>
<a href="#l15.162"></a><span id="l15.162"> </span>
<a href="#l15.163"></a><span id="l15.163"> /**</span>
<a href="#l15.164"></a><span id="l15.164">  * Check if after deleting an account the next one is selected.</span>
<a href="#l15.165"></a><span id="l15.165">  *</span>
<a href="#l15.166"></a><span id="l15.166" class="difflineminus">- * @param amc           The account options controller.</span>
<a href="#l15.167"></a><span id="l15.167" class="difflineplus">+ * @param {Object} tab - The account manager tab.</span>
<a href="#l15.168"></a><span id="l15.168">  */</span>
<a href="#l15.169"></a><span id="l15.169" class="difflineminus">-function subtest_check_selection_after_account_deletion(amc) {</span>
<a href="#l15.170"></a><span id="l15.170" class="difflineplus">+function subtest_check_selection_after_account_deletion(tab) {</span>
<a href="#l15.171"></a><span id="l15.171">   let accountList = [];</span>
<a href="#l15.172"></a><span id="l15.172" class="difflineminus">-  let accountTreeNode = amc.e(&quot;account-tree-children&quot;);</span>
<a href="#l15.173"></a><span id="l15.173" class="difflineplus">+  let accountTreeNode = content_tab_e(tab, &quot;account-tree-children&quot;);</span>
<a href="#l15.174"></a><span id="l15.174">   // Build the list of accounts in the account tree (order is important).</span>
<a href="#l15.175"></a><span id="l15.175">   for (let i = 0; i &lt; accountTreeNode.children.length; i++) {</span>
<a href="#l15.176"></a><span id="l15.176">     if (&quot;_account&quot; in accountTreeNode.children[i]) {</span>
<a href="#l15.177"></a><span id="l15.177">       let curAccount = accountTreeNode.children[i]._account;</span>
<a href="#l15.178"></a><span id="l15.178">       if (!accountList.includes(curAccount)) {</span>
<a href="#l15.179"></a><span id="l15.179">         accountList.push(curAccount);</span>
<a href="#l15.180"></a><span id="l15.180">       }</span>
<a href="#l15.181"></a><span id="l15.181">     }</span>
<a href="#l15.182"></a><span id="l15.182">   }</span>
<a href="#l15.183"></a><span id="l15.183"> </span>
<a href="#l15.184"></a><span id="l15.184">   // Get position of the current account in the account list.</span>
<a href="#l15.185"></a><span id="l15.185">   let accountIndex = accountList.indexOf(gPopAccount);</span>
<a href="#l15.186"></a><span id="l15.186"> </span>
<a href="#l15.187"></a><span id="l15.187">   // Remove our account.</span>
<a href="#l15.188"></a><span id="l15.188" class="difflineminus">-  remove_account(gPopAccount, amc);</span>
<a href="#l15.189"></a><span id="l15.189" class="difflineplus">+  remove_account(gPopAccount, tab);</span>
<a href="#l15.190"></a><span id="l15.190">   gPopAccount = null;</span>
<a href="#l15.191"></a><span id="l15.191">   // Now there should be only the original accounts left.</span>
<a href="#l15.192"></a><span id="l15.192">   Assert.equal(MailServices.accounts.allServers.length, gOriginalAccountCount);</span>
<a href="#l15.193"></a><span id="l15.193"> </span>
<a href="#l15.194"></a><span id="l15.194">   // See if the currently selected account is the one next in the account list.</span>
<a href="#l15.195"></a><span id="l15.195" class="difflineminus">-  let accountTree = amc.e(&quot;accounttree&quot;);</span>
<a href="#l15.196"></a><span id="l15.196" class="difflineplus">+  let accountTree = content_tab_e(tab, &quot;accounttree&quot;);</span>
<a href="#l15.197"></a><span id="l15.197">   let accountRow = accountTree.view.selection.currentIndex;</span>
<a href="#l15.198"></a><span id="l15.198">   Assert.equal(</span>
<a href="#l15.199"></a><span id="l15.199">     accountTree.view.getItemAtIndex(accountRow)._account,</span>
<a href="#l15.200"></a><span id="l15.200">     accountList[accountIndex + 1]</span>
<a href="#l15.201"></a><span id="l15.201">   );</span>
<a href="#l15.202"></a><span id="l15.202"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mail/test/browser/account/browser_values.js</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mail/test/browser/account/browser_values.js</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -27,16 +27,20 @@ var { plan_for_modal_dialog, wait_for_mo</span>
<a href="#l16.4"></a><span id="l16.4">   &quot;resource://testing-common/mozmill/WindowHelpers.jsm&quot;</span>
<a href="#l16.5"></a><span id="l16.5"> );</span>
<a href="#l16.6"></a><span id="l16.6"> </span>
<a href="#l16.7"></a><span id="l16.7"> var { MailServices } = ChromeUtils.import(</span>
<a href="#l16.8"></a><span id="l16.8">   &quot;resource:///modules/MailServices.jsm&quot;</span>
<a href="#l16.9"></a><span id="l16.9"> );</span>
<a href="#l16.10"></a><span id="l16.10"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l16.11"></a><span id="l16.11"> </span>
<a href="#l16.12"></a><span id="l16.12" class="difflineplus">+var { mc } = ChromeUtils.import(</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+  &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineplus">+);</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineplus">+</span>
<a href="#l16.16"></a><span id="l16.16"> var gPopAccount, gOriginalAccountCount;</span>
<a href="#l16.17"></a><span id="l16.17"> </span>
<a href="#l16.18"></a><span id="l16.18"> add_task(function setupModule(module) {</span>
<a href="#l16.19"></a><span id="l16.19">   // There may be pre-existing accounts from other tests.</span>
<a href="#l16.20"></a><span id="l16.20">   gOriginalAccountCount = MailServices.accounts.allServers.length;</span>
<a href="#l16.21"></a><span id="l16.21"> </span>
<a href="#l16.22"></a><span id="l16.22">   // Create a POP server</span>
<a href="#l16.23"></a><span id="l16.23">   let popServer = MailServices.accounts</span>
<a href="#l16.24"></a><span id="l16.24" class="difflineat">@@ -65,57 +69,59 @@ registerCleanupFunction(function teardow</span>
<a href="#l16.25"></a><span id="l16.25"> });</span>
<a href="#l16.26"></a><span id="l16.26"> </span>
<a href="#l16.27"></a><span id="l16.27"> /**</span>
<a href="#l16.28"></a><span id="l16.28">  * Bug 208628.</span>
<a href="#l16.29"></a><span id="l16.29">  * Check that if the CC field is empty, enabling CC will automatically</span>
<a href="#l16.30"></a><span id="l16.30">  * prefill the currently default email address.</span>
<a href="#l16.31"></a><span id="l16.31">  */</span>
<a href="#l16.32"></a><span id="l16.32"> add_task(function test_default_CC_address() {</span>
<a href="#l16.33"></a><span id="l16.33" class="difflineminus">-  open_advanced_settings(function(amc) {</span>
<a href="#l16.34"></a><span id="l16.34" class="difflineminus">-    subtest_check_default_CC_address(amc);</span>
<a href="#l16.35"></a><span id="l16.35" class="difflineplus">+  open_advanced_settings(function(tab) {</span>
<a href="#l16.36"></a><span id="l16.36" class="difflineplus">+    subtest_check_default_CC_address(tab);</span>
<a href="#l16.37"></a><span id="l16.37">   });</span>
<a href="#l16.38"></a><span id="l16.38"> });</span>
<a href="#l16.39"></a><span id="l16.39"> </span>
<a href="#l16.40"></a><span id="l16.40"> /**</span>
<a href="#l16.41"></a><span id="l16.41">  * Check that if the CC field is empty, enabling CC will automatically</span>
<a href="#l16.42"></a><span id="l16.42">  * prefill the currently default email address.</span>
<a href="#l16.43"></a><span id="l16.43">  *</span>
<a href="#l16.44"></a><span id="l16.44" class="difflineminus">- * @param amc  the account options controller</span>
<a href="#l16.45"></a><span id="l16.45" class="difflineplus">+ * @param {Object} tab - The account manager tab.</span>
<a href="#l16.46"></a><span id="l16.46">  */</span>
<a href="#l16.47"></a><span id="l16.47" class="difflineminus">-function subtest_check_default_CC_address(amc) {</span>
<a href="#l16.48"></a><span id="l16.48" class="difflineplus">+function subtest_check_default_CC_address(tab) {</span>
<a href="#l16.49"></a><span id="l16.49">   let accountRow = get_account_tree_row(</span>
<a href="#l16.50"></a><span id="l16.50">     gPopAccount.key,</span>
<a href="#l16.51"></a><span id="l16.51">     &quot;am-copies.xhtml&quot;,</span>
<a href="#l16.52"></a><span id="l16.52" class="difflineminus">-    amc</span>
<a href="#l16.53"></a><span id="l16.53" class="difflineplus">+    tab</span>
<a href="#l16.54"></a><span id="l16.54">   );</span>
<a href="#l16.55"></a><span id="l16.55" class="difflineminus">-  click_account_tree_row(amc, accountRow);</span>
<a href="#l16.56"></a><span id="l16.56" class="difflineplus">+  click_account_tree_row(tab, accountRow);</span>
<a href="#l16.57"></a><span id="l16.57"> </span>
<a href="#l16.58"></a><span id="l16.58" class="difflineminus">-  let iframe = amc.window.document.getElementById(&quot;contentFrame&quot;);</span>
<a href="#l16.59"></a><span id="l16.59" class="difflineplus">+  let iframe = tab.browser.contentWindow.document.getElementById(</span>
<a href="#l16.60"></a><span id="l16.60" class="difflineplus">+    &quot;contentFrame&quot;</span>
<a href="#l16.61"></a><span id="l16.61" class="difflineplus">+  );</span>
<a href="#l16.62"></a><span id="l16.62"> </span>
<a href="#l16.63"></a><span id="l16.63">   let defaultAddress = iframe.contentDocument.getElementById(&quot;identity.email&quot;)</span>
<a href="#l16.64"></a><span id="l16.64">     .value;</span>
<a href="#l16.65"></a><span id="l16.65">   let ccCheck = iframe.contentDocument.getElementById(&quot;identity.doCc&quot;);</span>
<a href="#l16.66"></a><span id="l16.66">   let ccAddress = iframe.contentDocument.getElementById(&quot;identity.doCcList&quot;);</span>
<a href="#l16.67"></a><span id="l16.67">   // The CC checkbox is not enabled and the address value is empty.</span>
<a href="#l16.68"></a><span id="l16.68">   Assert.ok(!ccCheck.checked);</span>
<a href="#l16.69"></a><span id="l16.69">   Assert.equal(ccAddress.value, &quot;&quot;);</span>
<a href="#l16.70"></a><span id="l16.70">   // After ticking the CC checkbox the default address should be prefilled.</span>
<a href="#l16.71"></a><span id="l16.71" class="difflineminus">-  amc.check(new elib.Elem(ccCheck), true);</span>
<a href="#l16.72"></a><span id="l16.72" class="difflineplus">+  mc.check(new elib.Elem(ccCheck), true);</span>
<a href="#l16.73"></a><span id="l16.73">   Assert.equal(ccAddress.value, defaultAddress);</span>
<a href="#l16.74"></a><span id="l16.74"> </span>
<a href="#l16.75"></a><span id="l16.75">   let bccCheck = iframe.contentDocument.getElementById(&quot;identity.doBcc&quot;);</span>
<a href="#l16.76"></a><span id="l16.76">   let bccAddress = iframe.contentDocument.getElementById(&quot;identity.doBccList&quot;);</span>
<a href="#l16.77"></a><span id="l16.77">   // The BCC checkbox is not enabled but we set the address value to something.</span>
<a href="#l16.78"></a><span id="l16.78">   Assert.ok(!bccCheck.checked);</span>
<a href="#l16.79"></a><span id="l16.79">   Assert.equal(bccAddress.value, &quot;&quot;);</span>
<a href="#l16.80"></a><span id="l16.80">   let bccUserAddress = &quot;somebody@else.invalid&quot;;</span>
<a href="#l16.81"></a><span id="l16.81">   bccAddress.value = bccUserAddress;</span>
<a href="#l16.82"></a><span id="l16.82">   // After ticking the BCC checkbox the current value of the address should not change.</span>
<a href="#l16.83"></a><span id="l16.83" class="difflineminus">-  amc.check(new elib.Elem(bccCheck), true);</span>
<a href="#l16.84"></a><span id="l16.84" class="difflineplus">+  mc.check(new elib.Elem(bccCheck), true);</span>
<a href="#l16.85"></a><span id="l16.85">   Assert.equal(bccAddress.value, bccUserAddress);</span>
<a href="#l16.86"></a><span id="l16.86"> }</span>
<a href="#l16.87"></a><span id="l16.87"> </span>
<a href="#l16.88"></a><span id="l16.88"> /**</span>
<a href="#l16.89"></a><span id="l16.89">  * Bug 720199.</span>
<a href="#l16.90"></a><span id="l16.90">  * Check if the account name automatically changes when the user changes</span>
<a href="#l16.91"></a><span id="l16.91">  * the username or hostname.</span>
<a href="#l16.92"></a><span id="l16.92">  */</span>
<a href="#l16.93"></a><span id="l16.93" class="difflineat">@@ -142,111 +148,112 @@ add_task(function test_account_name() {</span>
<a href="#l16.94"></a><span id="l16.94">   // The automatic account name update works only if the name is</span>
<a href="#l16.95"></a><span id="l16.95">   // in the form of user@host.</span>
<a href="#l16.96"></a><span id="l16.96">   gPopAccount.incomingServer.prettyName = &quot;nobody@example.invalid&quot;;</span>
<a href="#l16.97"></a><span id="l16.97"> </span>
<a href="#l16.98"></a><span id="l16.98">   let newHost = &quot;some.host.invalid&quot;;</span>
<a href="#l16.99"></a><span id="l16.99">   let newUser = &quot;somebody&quot;;</span>
<a href="#l16.100"></a><span id="l16.100"> </span>
<a href="#l16.101"></a><span id="l16.101">   // On NNTP there is no user name so just set new hostname.</span>
<a href="#l16.102"></a><span id="l16.102" class="difflineminus">-  open_advanced_settings(function(amc) {</span>
<a href="#l16.103"></a><span id="l16.103" class="difflineminus">-    subtest_check_account_name(nntpAccount, newHost, null, amc);</span>
<a href="#l16.104"></a><span id="l16.104" class="difflineplus">+  open_advanced_settings(function(tab) {</span>
<a href="#l16.105"></a><span id="l16.105" class="difflineplus">+    subtest_check_account_name(nntpAccount, newHost, null, tab);</span>
<a href="#l16.106"></a><span id="l16.106">   });</span>
<a href="#l16.107"></a><span id="l16.107"> </span>
<a href="#l16.108"></a><span id="l16.108">   // And see if the account name is updated to it.</span>
<a href="#l16.109"></a><span id="l16.109">   Assert.equal(nntpAccount.incomingServer.prettyName, newHost);</span>
<a href="#l16.110"></a><span id="l16.110"> </span>
<a href="#l16.111"></a><span id="l16.111">   // On POP3 there is both user name and host name.</span>
<a href="#l16.112"></a><span id="l16.112">   // Set new host name first.</span>
<a href="#l16.113"></a><span id="l16.113" class="difflineminus">-  open_advanced_settings(function(amc) {</span>
<a href="#l16.114"></a><span id="l16.114" class="difflineminus">-    subtest_check_account_name(gPopAccount, newHost, null, amc);</span>
<a href="#l16.115"></a><span id="l16.115" class="difflineplus">+  open_advanced_settings(function(tab) {</span>
<a href="#l16.116"></a><span id="l16.116" class="difflineplus">+    subtest_check_account_name(gPopAccount, newHost, null, tab);</span>
<a href="#l16.117"></a><span id="l16.117">   });</span>
<a href="#l16.118"></a><span id="l16.118"> </span>
<a href="#l16.119"></a><span id="l16.119">   // And see if in the account name the host part is updated to it.</span>
<a href="#l16.120"></a><span id="l16.120">   Assert.equal(gPopAccount.incomingServer.prettyName, &quot;nobody@&quot; + newHost);</span>
<a href="#l16.121"></a><span id="l16.121"> </span>
<a href="#l16.122"></a><span id="l16.122">   // Set new host name first.</span>
<a href="#l16.123"></a><span id="l16.123" class="difflineminus">-  open_advanced_settings(function(amc) {</span>
<a href="#l16.124"></a><span id="l16.124" class="difflineminus">-    subtest_check_account_name(gPopAccount, null, newUser, amc);</span>
<a href="#l16.125"></a><span id="l16.125" class="difflineplus">+  open_advanced_settings(function(tab) {</span>
<a href="#l16.126"></a><span id="l16.126" class="difflineplus">+    subtest_check_account_name(gPopAccount, null, newUser, tab);</span>
<a href="#l16.127"></a><span id="l16.127">   });</span>
<a href="#l16.128"></a><span id="l16.128"> </span>
<a href="#l16.129"></a><span id="l16.129">   // And see if in the account name the user part is updated.</span>
<a href="#l16.130"></a><span id="l16.130">   Assert.equal(gPopAccount.incomingServer.prettyName, newUser + &quot;@&quot; + newHost);</span>
<a href="#l16.131"></a><span id="l16.131"> </span>
<a href="#l16.132"></a><span id="l16.132">   newHost = &quot;another.host.invalid&quot;;</span>
<a href="#l16.133"></a><span id="l16.133">   newUser = &quot;anotherbody&quot;;</span>
<a href="#l16.134"></a><span id="l16.134"> </span>
<a href="#l16.135"></a><span id="l16.135">   // Set user name and host name at once.</span>
<a href="#l16.136"></a><span id="l16.136" class="difflineminus">-  open_advanced_settings(function(amc) {</span>
<a href="#l16.137"></a><span id="l16.137" class="difflineminus">-    subtest_check_account_name(gPopAccount, newHost, newUser, amc);</span>
<a href="#l16.138"></a><span id="l16.138" class="difflineplus">+  open_advanced_settings(function(tab) {</span>
<a href="#l16.139"></a><span id="l16.139" class="difflineplus">+    subtest_check_account_name(gPopAccount, newHost, newUser, tab);</span>
<a href="#l16.140"></a><span id="l16.140">   });</span>
<a href="#l16.141"></a><span id="l16.141"> </span>
<a href="#l16.142"></a><span id="l16.142">   // And see if in the account name the host part is updated to it.</span>
<a href="#l16.143"></a><span id="l16.143">   Assert.equal(gPopAccount.incomingServer.prettyName, newUser + &quot;@&quot; + newHost);</span>
<a href="#l16.144"></a><span id="l16.144"> </span>
<a href="#l16.145"></a><span id="l16.145">   // Now have an account name where the name does not match the hostname.</span>
<a href="#l16.146"></a><span id="l16.146">   gPopAccount.incomingServer.prettyName = newUser + &quot;@example.invalid&quot;;</span>
<a href="#l16.147"></a><span id="l16.147"> </span>
<a href="#l16.148"></a><span id="l16.148">   newHost = &quot;third.host.invalid&quot;;</span>
<a href="#l16.149"></a><span id="l16.149">   // Set the host name again.</span>
<a href="#l16.150"></a><span id="l16.150" class="difflineminus">-  open_advanced_settings(function(amc) {</span>
<a href="#l16.151"></a><span id="l16.151" class="difflineminus">-    subtest_check_account_name(gPopAccount, newHost, null, amc);</span>
<a href="#l16.152"></a><span id="l16.152" class="difflineplus">+  open_advanced_settings(function(tab) {</span>
<a href="#l16.153"></a><span id="l16.153" class="difflineplus">+    subtest_check_account_name(gPopAccount, newHost, null, tab);</span>
<a href="#l16.154"></a><span id="l16.154">   });</span>
<a href="#l16.155"></a><span id="l16.155"> </span>
<a href="#l16.156"></a><span id="l16.156">   // And the account name should not be touched.</span>
<a href="#l16.157"></a><span id="l16.157">   Assert.equal(</span>
<a href="#l16.158"></a><span id="l16.158">     gPopAccount.incomingServer.prettyName,</span>
<a href="#l16.159"></a><span id="l16.159">     newUser + &quot;@example.invalid&quot;</span>
<a href="#l16.160"></a><span id="l16.160">   );</span>
<a href="#l16.161"></a><span id="l16.161"> </span>
<a href="#l16.162"></a><span id="l16.162">   MailServices.accounts.removeAccount(nntpAccount);</span>
<a href="#l16.163"></a><span id="l16.163"> });</span>
<a href="#l16.164"></a><span id="l16.164"> </span>
<a href="#l16.165"></a><span id="l16.165"> /**</span>
<a href="#l16.166"></a><span id="l16.166">  * Changes the user name and hostname to the supplied values.</span>
<a href="#l16.167"></a><span id="l16.167">  *</span>
<a href="#l16.168"></a><span id="l16.168" class="difflineminus">- * @param aAccount      the account to change</span>
<a href="#l16.169"></a><span id="l16.169" class="difflineminus">- * @param aNewHostname  the hostname value to set</span>
<a href="#l16.170"></a><span id="l16.170" class="difflineminus">- * @param aNewUsername  the username value to set</span>
<a href="#l16.171"></a><span id="l16.171" class="difflineminus">- * @param amc           the account options controller</span>
<a href="#l16.172"></a><span id="l16.172" class="difflineplus">+ * @param {Object} account - The account to change</span>
<a href="#l16.173"></a><span id="l16.173" class="difflineplus">+ * @param {string} newHostname - The hostname value to set</span>
<a href="#l16.174"></a><span id="l16.174" class="difflineplus">+ * @param {string} newUsername - The username value to set</span>
<a href="#l16.175"></a><span id="l16.175" class="difflineplus">+ * @param {Object} tab - The account manager tab.</span>
<a href="#l16.176"></a><span id="l16.176">  */</span>
<a href="#l16.177"></a><span id="l16.177" class="difflineminus">-function subtest_check_account_name(aAccount, aNewHostname, aNewUsername, amc) {</span>
<a href="#l16.178"></a><span id="l16.178" class="difflineminus">-  let accountRow = get_account_tree_row(aAccount.key, &quot;am-server.xhtml&quot;, amc);</span>
<a href="#l16.179"></a><span id="l16.179" class="difflineminus">-  click_account_tree_row(amc, accountRow);</span>
<a href="#l16.180"></a><span id="l16.180" class="difflineplus">+function subtest_check_account_name(account, newHostname, newUsername, tab) {</span>
<a href="#l16.181"></a><span id="l16.181" class="difflineplus">+  let accountRow = get_account_tree_row(account.key, &quot;am-server.xhtml&quot;, tab);</span>
<a href="#l16.182"></a><span id="l16.182" class="difflineplus">+  click_account_tree_row(tab, accountRow);</span>
<a href="#l16.183"></a><span id="l16.183"> </span>
<a href="#l16.184"></a><span id="l16.184" class="difflineminus">-  let iframe = amc.window.document.getElementById(&quot;contentFrame&quot;);</span>
<a href="#l16.185"></a><span id="l16.185" class="difflineplus">+  let iframe = tab.browser.contentWindow.document.getElementById(</span>
<a href="#l16.186"></a><span id="l16.186" class="difflineplus">+    &quot;contentFrame&quot;</span>
<a href="#l16.187"></a><span id="l16.187" class="difflineplus">+  );</span>
<a href="#l16.188"></a><span id="l16.188"> </span>
<a href="#l16.189"></a><span id="l16.189" class="difflineminus">-  if (aNewHostname) {</span>
<a href="#l16.190"></a><span id="l16.190" class="difflineplus">+  if (newHostname) {</span>
<a href="#l16.191"></a><span id="l16.191">     let hostname = iframe.contentDocument.getElementById(&quot;server.realHostName&quot;);</span>
<a href="#l16.192"></a><span id="l16.192" class="difflineminus">-    Assert.equal(hostname.value, aAccount.incomingServer.realHostName);</span>
<a href="#l16.193"></a><span id="l16.193" class="difflineplus">+    Assert.equal(hostname.value, account.incomingServer.realHostName);</span>
<a href="#l16.194"></a><span id="l16.194"> </span>
<a href="#l16.195"></a><span id="l16.195">     // Now change the server host name.</span>
<a href="#l16.196"></a><span id="l16.196" class="difflineminus">-    hostname.value = aNewHostname;</span>
<a href="#l16.197"></a><span id="l16.197" class="difflineplus">+    hostname.value = newHostname;</span>
<a href="#l16.198"></a><span id="l16.198">   }</span>
<a href="#l16.199"></a><span id="l16.199"> </span>
<a href="#l16.200"></a><span id="l16.200" class="difflineminus">-  if (aNewUsername) {</span>
<a href="#l16.201"></a><span id="l16.201" class="difflineplus">+  if (newUsername) {</span>
<a href="#l16.202"></a><span id="l16.202">     let username = iframe.contentDocument.getElementById(&quot;server.realUsername&quot;);</span>
<a href="#l16.203"></a><span id="l16.203" class="difflineminus">-    Assert.equal(username.value, aAccount.incomingServer.realUsername);</span>
<a href="#l16.204"></a><span id="l16.204" class="difflineplus">+    Assert.equal(username.value, account.incomingServer.realUsername);</span>
<a href="#l16.205"></a><span id="l16.205"> </span>
<a href="#l16.206"></a><span id="l16.206">     // Now change the server user name.</span>
<a href="#l16.207"></a><span id="l16.207" class="difflineminus">-    username.value = aNewUsername;</span>
<a href="#l16.208"></a><span id="l16.208" class="difflineplus">+    username.value = newUsername;</span>
<a href="#l16.209"></a><span id="l16.209">   }</span>
<a href="#l16.210"></a><span id="l16.210"> </span>
<a href="#l16.211"></a><span id="l16.211" class="difflineminus">-  if (aNewUsername) {</span>
<a href="#l16.212"></a><span id="l16.212" class="difflineplus">+  if (newUsername) {</span>
<a href="#l16.213"></a><span id="l16.213">     // If username has changed, we get a confirmation dialog.</span>
<a href="#l16.214"></a><span id="l16.214">     plan_for_modal_dialog(&quot;commonDialogWindow&quot;, function(cdc) {</span>
<a href="#l16.215"></a><span id="l16.215">       // Just dismiss it.</span>
<a href="#l16.216"></a><span id="l16.216">       cdc.window.document.documentElement</span>
<a href="#l16.217"></a><span id="l16.217">         .querySelector(&quot;dialog&quot;)</span>
<a href="#l16.218"></a><span id="l16.218">         .acceptDialog();</span>
<a href="#l16.219"></a><span id="l16.219">     });</span>
<a href="#l16.220"></a><span id="l16.220">   }</span>
<a href="#l16.221"></a><span id="l16.221" class="difflineminus">-  // We really need to save the new values so click OK on the Account settings.</span>
<a href="#l16.222"></a><span id="l16.222" class="difflineminus">-  amc.window.document.documentElement.querySelector(&quot;dialog&quot;).acceptDialog();</span>
<a href="#l16.223"></a><span id="l16.223" class="difflineminus">-  if (aNewUsername) {</span>
<a href="#l16.224"></a><span id="l16.224" class="difflineplus">+  tab.browser.contentWindow.onAccept(true);</span>
<a href="#l16.225"></a><span id="l16.225" class="difflineplus">+  if (newUsername) {</span>
<a href="#l16.226"></a><span id="l16.226">     wait_for_modal_dialog(&quot;commonDialogWindow&quot;);</span>
<a href="#l16.227"></a><span id="l16.227">   }</span>
<a href="#l16.228"></a><span id="l16.228"> }</span>
<a href="#l16.229"></a><span id="l16.229"> </span>
<a href="#l16.230"></a><span id="l16.230"> /**</span>
<a href="#l16.231"></a><span id="l16.231">  * Bug 536768.</span>
<a href="#l16.232"></a><span id="l16.232">  * Check if invalid junk target settings (folders) are fixed to sane values.</span>
<a href="#l16.233"></a><span id="l16.233">  */</span>
<a href="#l16.234"></a><span id="l16.234" class="difflineat">@@ -254,146 +261,142 @@ add_task(function test_invalid_junk_targ</span>
<a href="#l16.235"></a><span id="l16.235">   // Set the junk target prefs to invalid values.</span>
<a href="#l16.236"></a><span id="l16.236">   let branch = Services.prefs.getBranch(</span>
<a href="#l16.237"></a><span id="l16.237">     &quot;mail.server.&quot; + gPopAccount.incomingServer.key + &quot;.&quot;</span>
<a href="#l16.238"></a><span id="l16.238">   );</span>
<a href="#l16.239"></a><span id="l16.239">   branch.setCharPref(&quot;spamActionTargetAccount&quot;, &quot;some random non-existent URI&quot;);</span>
<a href="#l16.240"></a><span id="l16.240">   branch.setCharPref(&quot;spamActionTargetFolder&quot;, &quot;some random non-existent URI&quot;);</span>
<a href="#l16.241"></a><span id="l16.241">   let moveOnSpam = true;</span>
<a href="#l16.242"></a><span id="l16.242">   branch.setBoolPref(&quot;moveOnSpam&quot;, moveOnSpam);</span>
<a href="#l16.243"></a><span id="l16.243" class="difflineminus">-  open_advanced_settings(function(amc) {</span>
<a href="#l16.244"></a><span id="l16.244" class="difflineminus">-    subtest_check_invalid_junk_target(amc);</span>
<a href="#l16.245"></a><span id="l16.245" class="difflineplus">+  open_advanced_settings(function(tab) {</span>
<a href="#l16.246"></a><span id="l16.246" class="difflineplus">+    subtest_check_invalid_junk_target(tab);</span>
<a href="#l16.247"></a><span id="l16.247">   });</span>
<a href="#l16.248"></a><span id="l16.248"> </span>
<a href="#l16.249"></a><span id="l16.249">   // The pref has no default so its non-existence means it was cleared.</span>
<a href="#l16.250"></a><span id="l16.250">   moveOnSpam = branch.getBoolPref(&quot;moveOnSpam&quot;, false);</span>
<a href="#l16.251"></a><span id="l16.251">   Assert.ok(!moveOnSpam);</span>
<a href="#l16.252"></a><span id="l16.252">   // The targets should point to the same pop account now.</span>
<a href="#l16.253"></a><span id="l16.253">   let targetAccount = branch.getCharPref(&quot;spamActionTargetAccount&quot;);</span>
<a href="#l16.254"></a><span id="l16.254">   Assert.equal(targetAccount, gPopAccount.incomingServer.serverURI);</span>
<a href="#l16.255"></a><span id="l16.255">   let targetFolder = branch.getCharPref(&quot;spamActionTargetFolder&quot;);</span>
<a href="#l16.256"></a><span id="l16.256">   Assert.equal(targetFolder, gPopAccount.incomingServer.serverURI + &quot;/Junk&quot;);</span>
<a href="#l16.257"></a><span id="l16.257"> });</span>
<a href="#l16.258"></a><span id="l16.258"> </span>
<a href="#l16.259"></a><span id="l16.259"> /**</span>
<a href="#l16.260"></a><span id="l16.260">  * Just show the Junk settings pane and let it fix the values.</span>
<a href="#l16.261"></a><span id="l16.261">  *</span>
<a href="#l16.262"></a><span id="l16.262" class="difflineminus">- * @param amc  the account options controller</span>
<a href="#l16.263"></a><span id="l16.263" class="difflineplus">+ * @param {Object} tab - The account manager tab.</span>
<a href="#l16.264"></a><span id="l16.264">  */</span>
<a href="#l16.265"></a><span id="l16.265" class="difflineminus">-function subtest_check_invalid_junk_target(amc) {</span>
<a href="#l16.266"></a><span id="l16.266" class="difflineminus">-  let accountRow = get_account_tree_row(gPopAccount.key, &quot;am-junk.xhtml&quot;, amc);</span>
<a href="#l16.267"></a><span id="l16.267" class="difflineminus">-  click_account_tree_row(amc, accountRow);</span>
<a href="#l16.268"></a><span id="l16.268" class="difflineminus">-</span>
<a href="#l16.269"></a><span id="l16.269" class="difflineminus">-  // We need to save the new fixed values so click OK on the Account settings.</span>
<a href="#l16.270"></a><span id="l16.270" class="difflineminus">-  amc.window.document.documentElement.querySelector(&quot;dialog&quot;).acceptDialog();</span>
<a href="#l16.271"></a><span id="l16.271" class="difflineplus">+function subtest_check_invalid_junk_target(tab) {</span>
<a href="#l16.272"></a><span id="l16.272" class="difflineplus">+  let accountRow = get_account_tree_row(gPopAccount.key, &quot;am-junk.xhtml&quot;, tab);</span>
<a href="#l16.273"></a><span id="l16.273" class="difflineplus">+  click_account_tree_row(tab, accountRow);</span>
<a href="#l16.274"></a><span id="l16.274" class="difflineplus">+  tab.browser.contentWindow.onAccept(true);</span>
<a href="#l16.275"></a><span id="l16.275"> }</span>
<a href="#l16.276"></a><span id="l16.276"> </span>
<a href="#l16.277"></a><span id="l16.277"> /**</span>
<a href="#l16.278"></a><span id="l16.278">  * Bug 327812.</span>
<a href="#l16.279"></a><span id="l16.279">  * Checks if invalid server hostnames are not accepted.</span>
<a href="#l16.280"></a><span id="l16.280">  */</span>
<a href="#l16.281"></a><span id="l16.281"> add_task(function test_invalid_hostname() {</span>
<a href="#l16.282"></a><span id="l16.282">   let branch = Services.prefs.getBranch(</span>
<a href="#l16.283"></a><span id="l16.283">     &quot;mail.server.&quot; + gPopAccount.incomingServer.key + &quot;.&quot;</span>
<a href="#l16.284"></a><span id="l16.284">   );</span>
<a href="#l16.285"></a><span id="l16.285">   let origHostname = branch.getCharPref(&quot;realhostname&quot;);</span>
<a href="#l16.286"></a><span id="l16.286"> </span>
<a href="#l16.287"></a><span id="l16.287" class="difflineminus">-  open_advanced_settings(function(amc) {</span>
<a href="#l16.288"></a><span id="l16.288" class="difflineminus">-    subtest_check_invalid_hostname(amc, false, origHostname);</span>
<a href="#l16.289"></a><span id="l16.289" class="difflineplus">+  open_advanced_settings(function(tab) {</span>
<a href="#l16.290"></a><span id="l16.290" class="difflineplus">+    subtest_check_invalid_hostname(tab, false, origHostname);</span>
<a href="#l16.291"></a><span id="l16.291">   });</span>
<a href="#l16.292"></a><span id="l16.292" class="difflineminus">-  open_advanced_settings(function(amc) {</span>
<a href="#l16.293"></a><span id="l16.293" class="difflineminus">-    subtest_check_invalid_hostname(amc, true, origHostname);</span>
<a href="#l16.294"></a><span id="l16.294" class="difflineplus">+  open_advanced_settings(function(tab) {</span>
<a href="#l16.295"></a><span id="l16.295" class="difflineplus">+    subtest_check_invalid_hostname(tab, true, origHostname);</span>
<a href="#l16.296"></a><span id="l16.296">   });</span>
<a href="#l16.297"></a><span id="l16.297"> </span>
<a href="#l16.298"></a><span id="l16.298">   // The new bad hostname should not have been saved.</span>
<a href="#l16.299"></a><span id="l16.299">   let newHostname = branch.getCharPref(&quot;realhostname&quot;);</span>
<a href="#l16.300"></a><span id="l16.300">   Assert.equal(origHostname, newHostname);</span>
<a href="#l16.301"></a><span id="l16.301"> });</span>
<a href="#l16.302"></a><span id="l16.302"> </span>
<a href="#l16.303"></a><span id="l16.303"> /**</span>
<a href="#l16.304"></a><span id="l16.304">  * Set the hostname to an invalid value and check if it gets fixed.</span>
<a href="#l16.305"></a><span id="l16.305">  *</span>
<a href="#l16.306"></a><span id="l16.306" class="difflineminus">- * @param amc                the account options controller</span>
<a href="#l16.307"></a><span id="l16.307" class="difflineminus">- * @param aExitSettings      Attempt to close the Account settings dialog.</span>
<a href="#l16.308"></a><span id="l16.308" class="difflineminus">- * @param aOriginalHostname  Original hostname of this server.</span>
<a href="#l16.309"></a><span id="l16.309" class="difflineplus">+ * @param {Object} tab - The account manager tab.</span>
<a href="#l16.310"></a><span id="l16.310" class="difflineplus">+ * @param {boolean} exitSettings - Attempt to close the Account settings dialog.</span>
<a href="#l16.311"></a><span id="l16.311" class="difflineplus">+ * @param {string} originalHostname - Original hostname of this server.</span>
<a href="#l16.312"></a><span id="l16.312">  */</span>
<a href="#l16.313"></a><span id="l16.313" class="difflineminus">-function subtest_check_invalid_hostname(amc, aExitSettings, aOriginalHostname) {</span>
<a href="#l16.314"></a><span id="l16.314" class="difflineplus">+function subtest_check_invalid_hostname(tab, exitSettings, originalHostname) {</span>
<a href="#l16.315"></a><span id="l16.315">   let accountRow = get_account_tree_row(</span>
<a href="#l16.316"></a><span id="l16.316">     gPopAccount.key,</span>
<a href="#l16.317"></a><span id="l16.317">     &quot;am-server.xhtml&quot;,</span>
<a href="#l16.318"></a><span id="l16.318" class="difflineminus">-    amc</span>
<a href="#l16.319"></a><span id="l16.319" class="difflineplus">+    tab</span>
<a href="#l16.320"></a><span id="l16.320">   );</span>
<a href="#l16.321"></a><span id="l16.321" class="difflineminus">-  click_account_tree_row(amc, accountRow);</span>
<a href="#l16.322"></a><span id="l16.322" class="difflineplus">+  click_account_tree_row(tab, accountRow);</span>
<a href="#l16.323"></a><span id="l16.323"> </span>
<a href="#l16.324"></a><span id="l16.324" class="difflineminus">-  let iframe = amc.window.document.getElementById(&quot;contentFrame&quot;);</span>
<a href="#l16.325"></a><span id="l16.325" class="difflineplus">+  let iframe = tab.browser.contentWindow.document.getElementById(</span>
<a href="#l16.326"></a><span id="l16.326" class="difflineplus">+    &quot;contentFrame&quot;</span>
<a href="#l16.327"></a><span id="l16.327" class="difflineplus">+  );</span>
<a href="#l16.328"></a><span id="l16.328">   let hostname = iframe.contentDocument.getElementById(&quot;server.realHostName&quot;);</span>
<a href="#l16.329"></a><span id="l16.329" class="difflineminus">-  Assert.equal(hostname.value, aOriginalHostname);</span>
<a href="#l16.330"></a><span id="l16.330" class="difflineplus">+  Assert.equal(hostname.value, originalHostname);</span>
<a href="#l16.331"></a><span id="l16.331"> </span>
<a href="#l16.332"></a><span id="l16.332">   hostname.value = &quot;some_invalid+host&amp;domain*in&gt;invalid&quot;;</span>
<a href="#l16.333"></a><span id="l16.333"> </span>
<a href="#l16.334"></a><span id="l16.334" class="difflineminus">-  if (!aExitSettings) {</span>
<a href="#l16.335"></a><span id="l16.335" class="difflineminus">-    accountRow = get_account_tree_row(gPopAccount.key, &quot;am-junk.xhtml&quot;, amc);</span>
<a href="#l16.336"></a><span id="l16.336" class="difflineminus">-    click_account_tree_row(amc, accountRow);</span>
<a href="#l16.337"></a><span id="l16.337" class="difflineplus">+  if (!exitSettings) {</span>
<a href="#l16.338"></a><span id="l16.338" class="difflineplus">+    accountRow = get_account_tree_row(gPopAccount.key, &quot;am-junk.xhtml&quot;, tab);</span>
<a href="#l16.339"></a><span id="l16.339" class="difflineplus">+    click_account_tree_row(tab, accountRow);</span>
<a href="#l16.340"></a><span id="l16.340"> </span>
<a href="#l16.341"></a><span id="l16.341">     // The invalid hostname should be set back to previous value at this point...</span>
<a href="#l16.342"></a><span id="l16.342" class="difflineminus">-    accountRow = get_account_tree_row(gPopAccount.key, &quot;am-server.xhtml&quot;, amc);</span>
<a href="#l16.343"></a><span id="l16.343" class="difflineminus">-    click_account_tree_row(amc, accountRow);</span>
<a href="#l16.344"></a><span id="l16.344" class="difflineplus">+    accountRow = get_account_tree_row(gPopAccount.key, &quot;am-server.xhtml&quot;, tab);</span>
<a href="#l16.345"></a><span id="l16.345" class="difflineplus">+    click_account_tree_row(tab, accountRow);</span>
<a href="#l16.346"></a><span id="l16.346"> </span>
<a href="#l16.347"></a><span id="l16.347">     // ...let's check that:</span>
<a href="#l16.348"></a><span id="l16.348" class="difflineminus">-    iframe = amc.window.document.getElementById(&quot;contentFrame&quot;);</span>
<a href="#l16.349"></a><span id="l16.349" class="difflineplus">+    iframe = tab.browser.contentWindow.document.getElementById(&quot;contentFrame&quot;);</span>
<a href="#l16.350"></a><span id="l16.350">     hostname = iframe.contentDocument.getElementById(&quot;server.realHostName&quot;);</span>
<a href="#l16.351"></a><span id="l16.351" class="difflineminus">-    Assert.equal(hostname.value, aOriginalHostname);</span>
<a href="#l16.352"></a><span id="l16.352" class="difflineplus">+    Assert.equal(hostname.value, originalHostname);</span>
<a href="#l16.353"></a><span id="l16.353">   } else {</span>
<a href="#l16.354"></a><span id="l16.354">     // If the hostname is bad, we should get a warning dialog.</span>
<a href="#l16.355"></a><span id="l16.355">     plan_for_modal_dialog(&quot;commonDialogWindow&quot;, function(cdc) {</span>
<a href="#l16.356"></a><span id="l16.356">       // Just dismiss it.</span>
<a href="#l16.357"></a><span id="l16.357">       cdc.window.document.documentElement</span>
<a href="#l16.358"></a><span id="l16.358">         .querySelector(&quot;dialog&quot;)</span>
<a href="#l16.359"></a><span id="l16.359">         .acceptDialog();</span>
<a href="#l16.360"></a><span id="l16.360">     });</span>
<a href="#l16.361"></a><span id="l16.361" class="difflineminus">-</span>
<a href="#l16.362"></a><span id="l16.362" class="difflineminus">-    // Click OK on the Account settings.</span>
<a href="#l16.363"></a><span id="l16.363" class="difflineminus">-    amc.window.document.documentElement.querySelector(&quot;dialog&quot;).acceptDialog();</span>
<a href="#l16.364"></a><span id="l16.364" class="difflineminus">-</span>
<a href="#l16.365"></a><span id="l16.365" class="difflineplus">+    tab.browser.contentWindow.onAccept(true);</span>
<a href="#l16.366"></a><span id="l16.366">     wait_for_modal_dialog(&quot;commonDialogWindow&quot;);</span>
<a href="#l16.367"></a><span id="l16.367">   }</span>
<a href="#l16.368"></a><span id="l16.368"> }</span>
<a href="#l16.369"></a><span id="l16.369"> </span>
<a href="#l16.370"></a><span id="l16.370"> /**</span>
<a href="#l16.371"></a><span id="l16.371">  * Bug 1426328.</span>
<a href="#l16.372"></a><span id="l16.372">  * Check that the AM will trim user added spaces around text values.</span>
<a href="#l16.373"></a><span id="l16.373">  */</span>
<a href="#l16.374"></a><span id="l16.374"> const badName = &quot;trailing  space &quot;;</span>
<a href="#l16.375"></a><span id="l16.375"> const badEmail = &quot; leading_space@example.com&quot;;</span>
<a href="#l16.376"></a><span id="l16.376"> </span>
<a href="#l16.377"></a><span id="l16.377"> add_task(function test_trailing_spaces() {</span>
<a href="#l16.378"></a><span id="l16.378" class="difflineminus">-  open_advanced_settings(function(amc) {</span>
<a href="#l16.379"></a><span id="l16.379" class="difflineminus">-    subtest_check_trailing_spaces(amc);</span>
<a href="#l16.380"></a><span id="l16.380" class="difflineplus">+  open_advanced_settings(function(tab) {</span>
<a href="#l16.381"></a><span id="l16.381" class="difflineplus">+    subtest_check_trailing_spaces(tab);</span>
<a href="#l16.382"></a><span id="l16.382">   });</span>
<a href="#l16.383"></a><span id="l16.383">   Assert.equal(gPopAccount.incomingServer.prettyName, badName.trim());</span>
<a href="#l16.384"></a><span id="l16.384">   Assert.equal(gPopAccount.defaultIdentity.email, badEmail.trim());</span>
<a href="#l16.385"></a><span id="l16.385"> });</span>
<a href="#l16.386"></a><span id="l16.386"> </span>
<a href="#l16.387"></a><span id="l16.387"> /**</span>
<a href="#l16.388"></a><span id="l16.388">  * Check that the AM will trim user added spaces around text values</span>
<a href="#l16.389"></a><span id="l16.389">  * when storing them into the account.</span>
<a href="#l16.390"></a><span id="l16.390">  *</span>
<a href="#l16.391"></a><span id="l16.391" class="difflineminus">- * @param amc  the account options controller</span>
<a href="#l16.392"></a><span id="l16.392" class="difflineplus">+ * @param {Object} tab - The account manager tab.</span>
<a href="#l16.393"></a><span id="l16.393">  */</span>
<a href="#l16.394"></a><span id="l16.394" class="difflineminus">-function subtest_check_trailing_spaces(amc) {</span>
<a href="#l16.395"></a><span id="l16.395" class="difflineminus">-  let accountRow = get_account_tree_row(gPopAccount.key, null, amc);</span>
<a href="#l16.396"></a><span id="l16.396" class="difflineminus">-  click_account_tree_row(amc, accountRow);</span>
<a href="#l16.397"></a><span id="l16.397" class="difflineplus">+function subtest_check_trailing_spaces(tab) {</span>
<a href="#l16.398"></a><span id="l16.398" class="difflineplus">+  let accountRow = get_account_tree_row(gPopAccount.key, null, tab);</span>
<a href="#l16.399"></a><span id="l16.399" class="difflineplus">+  click_account_tree_row(tab, accountRow);</span>
<a href="#l16.400"></a><span id="l16.400"> </span>
<a href="#l16.401"></a><span id="l16.401" class="difflineminus">-  let iframe = amc.window.document.getElementById(&quot;contentFrame&quot;);</span>
<a href="#l16.402"></a><span id="l16.402" class="difflineplus">+  let iframe = tab.browser.contentWindow.document.getElementById(</span>
<a href="#l16.403"></a><span id="l16.403" class="difflineplus">+    &quot;contentFrame&quot;</span>
<a href="#l16.404"></a><span id="l16.404" class="difflineplus">+  );</span>
<a href="#l16.405"></a><span id="l16.405"> </span>
<a href="#l16.406"></a><span id="l16.406">   let accountName = iframe.contentDocument.getElementById(&quot;server.prettyName&quot;);</span>
<a href="#l16.407"></a><span id="l16.407">   let defaultAddress = iframe.contentDocument.getElementById(&quot;identity.email&quot;);</span>
<a href="#l16.408"></a><span id="l16.408" class="difflineminus">-  delete_all_existing(amc, new elib.Elem(accountName));</span>
<a href="#l16.409"></a><span id="l16.409" class="difflineminus">-  delete_all_existing(amc, new elib.Elem(defaultAddress));</span>
<a href="#l16.410"></a><span id="l16.410" class="difflineminus">-  input_value(amc, badName, new elib.Elem(accountName));</span>
<a href="#l16.411"></a><span id="l16.411" class="difflineminus">-  input_value(amc, badEmail, new elib.Elem(defaultAddress));</span>
<a href="#l16.412"></a><span id="l16.412" class="difflineplus">+  accountName.value = &quot;&quot;;</span>
<a href="#l16.413"></a><span id="l16.413" class="difflineplus">+  defaultAddress.value = &quot;&quot;;</span>
<a href="#l16.414"></a><span id="l16.414" class="difflineplus">+  input_value(mc, badName, new elib.Elem(accountName));</span>
<a href="#l16.415"></a><span id="l16.415" class="difflineplus">+  input_value(mc, badEmail, new elib.Elem(defaultAddress));</span>
<a href="#l16.416"></a><span id="l16.416"> </span>
<a href="#l16.417"></a><span id="l16.417">   Assert.equal(accountName.value, badName);</span>
<a href="#l16.418"></a><span id="l16.418">   Assert.equal(defaultAddress.value, badEmail);</span>
<a href="#l16.419"></a><span id="l16.419" class="difflineminus">-</span>
<a href="#l16.420"></a><span id="l16.420" class="difflineminus">-  // We really need to save the new values so click OK on the Account settings.</span>
<a href="#l16.421"></a><span id="l16.421" class="difflineminus">-  amc.window.document.documentElement.querySelector(&quot;dialog&quot;).acceptDialog();</span>
<a href="#l16.422"></a><span id="l16.422"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mail/test/browser/shared-modules/AccountManagerHelpers.jsm</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mail/test/browser/shared-modules/AccountManagerHelpers.jsm</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -1,17 +1,16 @@</span>
<a href="#l17.4"></a><span id="l17.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l17.5"></a><span id="l17.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l17.6"></a><span id="l17.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l17.7"></a><span id="l17.7"> </span>
<a href="#l17.8"></a><span id="l17.8"> &quot;use strict&quot;;</span>
<a href="#l17.9"></a><span id="l17.9"> </span>
<a href="#l17.10"></a><span id="l17.10"> this.EXPORTED_SYMBOLS = [</span>
<a href="#l17.11"></a><span id="l17.11">   &quot;open_advanced_settings&quot;,</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-  &quot;open_advanced_settings_from_account_wizard&quot;,</span>
<a href="#l17.13"></a><span id="l17.13">   &quot;open_mail_account_setup_wizard&quot;,</span>
<a href="#l17.14"></a><span id="l17.14">   &quot;click_account_tree_row&quot;,</span>
<a href="#l17.15"></a><span id="l17.15">   &quot;get_account_tree_row&quot;,</span>
<a href="#l17.16"></a><span id="l17.16">   &quot;remove_account&quot;,</span>
<a href="#l17.17"></a><span id="l17.17"> ];</span>
<a href="#l17.18"></a><span id="l17.18"> </span>
<a href="#l17.19"></a><span id="l17.19"> var elib = ChromeUtils.import(</span>
<a href="#l17.20"></a><span id="l17.20">   &quot;resource://testing-common/mozmill/elementslib.jsm&quot;</span>
<a href="#l17.21"></a><span id="l17.21" class="difflineat">@@ -20,175 +19,176 @@ var utils = ChromeUtils.import(&quot;resource</span>
<a href="#l17.22"></a><span id="l17.22"> </span>
<a href="#l17.23"></a><span id="l17.23"> var fdh = ChromeUtils.import(</span>
<a href="#l17.24"></a><span id="l17.24">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l17.25"></a><span id="l17.25"> );</span>
<a href="#l17.26"></a><span id="l17.26"> var wh = ChromeUtils.import(</span>
<a href="#l17.27"></a><span id="l17.27">   &quot;resource://testing-common/mozmill/WindowHelpers.jsm&quot;</span>
<a href="#l17.28"></a><span id="l17.28"> );</span>
<a href="#l17.29"></a><span id="l17.29"> </span>
<a href="#l17.30"></a><span id="l17.30" class="difflineplus">+var {</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineplus">+  content_tab_e,</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineplus">+  content_tab_eid,</span>
<a href="#l17.33"></a><span id="l17.33" class="difflineplus">+  open_content_tab_with_url,</span>
<a href="#l17.34"></a><span id="l17.34" class="difflineplus">+} = ChromeUtils.import(</span>
<a href="#l17.35"></a><span id="l17.35" class="difflineplus">+  &quot;resource://testing-common/mozmill/ContentTabHelpers.jsm&quot;</span>
<a href="#l17.36"></a><span id="l17.36" class="difflineplus">+);</span>
<a href="#l17.37"></a><span id="l17.37" class="difflineplus">+</span>
<a href="#l17.38"></a><span id="l17.38"> var mc = fdh.mc;</span>
<a href="#l17.39"></a><span id="l17.39"> </span>
<a href="#l17.40"></a><span id="l17.40"> /**</span>
<a href="#l17.41"></a><span id="l17.41" class="difflineminus">- * Opens the Account Manager.</span>
<a href="#l17.42"></a><span id="l17.42" class="difflineminus">- *</span>
<a href="#l17.43"></a><span id="l17.43" class="difflineminus">- * @param callback Callback for the modal dialog that is opened.</span>
<a href="#l17.44"></a><span id="l17.44" class="difflineplus">+ * Waits until the Account Manager tree fully loads after first open.</span>
<a href="#l17.45"></a><span id="l17.45">  */</span>
<a href="#l17.46"></a><span id="l17.46" class="difflineminus">-function open_advanced_settings(aCallback, aController) {</span>
<a href="#l17.47"></a><span id="l17.47" class="difflineminus">-  if (aController === undefined) {</span>
<a href="#l17.48"></a><span id="l17.48" class="difflineminus">-    aController = mc;</span>
<a href="#l17.49"></a><span id="l17.49" class="difflineminus">-  }</span>
<a href="#l17.50"></a><span id="l17.50" class="difflineminus">-</span>
<a href="#l17.51"></a><span id="l17.51" class="difflineminus">-  wh.plan_for_modal_dialog(&quot;mailnews:accountmanager&quot;, aCallback);</span>
<a href="#l17.52"></a><span id="l17.52" class="difflineminus">-  aController.click(mc.eid(&quot;menu_accountmgr&quot;));</span>
<a href="#l17.53"></a><span id="l17.53" class="difflineminus">-  return wh.wait_for_modal_dialog(&quot;mailnews:accountmanager&quot;);</span>
<a href="#l17.54"></a><span id="l17.54" class="difflineplus">+function wait_for_account_tree_load(tab) {</span>
<a href="#l17.55"></a><span id="l17.55" class="difflineplus">+  mc.waitFor(</span>
<a href="#l17.56"></a><span id="l17.56" class="difflineplus">+    () =&gt; tab.browser.contentWindow.currentAccount != null,</span>
<a href="#l17.57"></a><span id="l17.57" class="difflineplus">+    &quot;Timeout waiting for currentAccount to become non-null&quot;</span>
<a href="#l17.58"></a><span id="l17.58" class="difflineplus">+  );</span>
<a href="#l17.59"></a><span id="l17.59"> }</span>
<a href="#l17.60"></a><span id="l17.60" class="difflineminus">-</span>
<a href="#l17.61"></a><span id="l17.61"> /**</span>
<a href="#l17.62"></a><span id="l17.62" class="difflineminus">- * Opens the Account Manager from the mail account setup wizard.</span>
<a href="#l17.63"></a><span id="l17.63" class="difflineplus">+ * Opens the Account Manager.</span>
<a href="#l17.64"></a><span id="l17.64" class="difflineplus">+ * @callback tabCallback</span>
<a href="#l17.65"></a><span id="l17.65">  *</span>
<a href="#l17.66"></a><span id="l17.66" class="difflineminus">- * @param callback Callback for the modal dialog that is opened.</span>
<a href="#l17.67"></a><span id="l17.67" class="difflineplus">+ * @param {tabCallback} callback - The callback for the account manager tab that is opened.</span>
<a href="#l17.68"></a><span id="l17.68">  */</span>
<a href="#l17.69"></a><span id="l17.69" class="difflineminus">-function open_advanced_settings_from_account_wizard(aCallback, aController) {</span>
<a href="#l17.70"></a><span id="l17.70" class="difflineminus">-  wh.plan_for_modal_dialog(&quot;mailnews:accountmanager&quot;, aCallback);</span>
<a href="#l17.71"></a><span id="l17.71" class="difflineminus">-  aController.e(&quot;manual-edit_button&quot;).click();</span>
<a href="#l17.72"></a><span id="l17.72" class="difflineminus">-  aController.e(&quot;advanced-setup_button&quot;).click();</span>
<a href="#l17.73"></a><span id="l17.73" class="difflineminus">-  return wh.wait_for_modal_dialog(&quot;mailnews:accountmanager&quot;);</span>
<a href="#l17.74"></a><span id="l17.74" class="difflineplus">+function open_advanced_settings(callback) {</span>
<a href="#l17.75"></a><span id="l17.75" class="difflineplus">+  let tab = open_content_tab_with_url(&quot;about:accountsettings&quot;);</span>
<a href="#l17.76"></a><span id="l17.76" class="difflineplus">+  wait_for_account_tree_load(tab);</span>
<a href="#l17.77"></a><span id="l17.77" class="difflineplus">+  callback(tab);</span>
<a href="#l17.78"></a><span id="l17.78" class="difflineplus">+  mc.tabmail.closeTab(tab);</span>
<a href="#l17.79"></a><span id="l17.79"> }</span>
<a href="#l17.80"></a><span id="l17.80"> </span>
<a href="#l17.81"></a><span id="l17.81"> /**</span>
<a href="#l17.82"></a><span id="l17.82">  * Use File &gt; New &gt; Mail Account to open the Mail Account Setup Wizard.</span>
<a href="#l17.83"></a><span id="l17.83" class="difflineplus">+ * @callback tabCallback</span>
<a href="#l17.84"></a><span id="l17.84">  *</span>
<a href="#l17.85"></a><span id="l17.85" class="difflineminus">- * @param aCallback  Function to run once the dialog is open. The function</span>
<a href="#l17.86"></a><span id="l17.86" class="difflineminus">- *                   gets the new window controller passed as first argument.</span>
<a href="#l17.87"></a><span id="l17.87" class="difflineplus">+ * @param {tabCallback} callback - Function to run once the dialog is open. The function</span>
<a href="#l17.88"></a><span id="l17.88" class="difflineplus">+ *                                 gets the new window controller passed as first argument.</span>
<a href="#l17.89"></a><span id="l17.89">  */</span>
<a href="#l17.90"></a><span id="l17.90" class="difflineminus">-function open_mail_account_setup_wizard(aCallback) {</span>
<a href="#l17.91"></a><span id="l17.91" class="difflineminus">-  wh.plan_for_modal_dialog(&quot;mail:autoconfig&quot;, aCallback);</span>
<a href="#l17.92"></a><span id="l17.92" class="difflineplus">+function open_mail_account_setup_wizard(callback) {</span>
<a href="#l17.93"></a><span id="l17.93" class="difflineplus">+  wh.plan_for_modal_dialog(&quot;mail:autoconfig&quot;, callback);</span>
<a href="#l17.94"></a><span id="l17.94">   mc.click(new elib.Elem(mc.menus.menu_File.menu_New.newMailAccountMenuItem));</span>
<a href="#l17.95"></a><span id="l17.95">   return wh.wait_for_modal_dialog(&quot;mail:autoconfig&quot;, 30000);</span>
<a href="#l17.96"></a><span id="l17.96"> }</span>
<a href="#l17.97"></a><span id="l17.97"> </span>
<a href="#l17.98"></a><span id="l17.98"> /**</span>
<a href="#l17.99"></a><span id="l17.99" class="difflineminus">- * Click a row in the account settings tree</span>
<a href="#l17.100"></a><span id="l17.100" class="difflineplus">+ * Click a row in the account settings tree.</span>
<a href="#l17.101"></a><span id="l17.101">  *</span>
<a href="#l17.102"></a><span id="l17.102" class="difflineminus">- * @param controller the Mozmill controller for the account settings dialog</span>
<a href="#l17.103"></a><span id="l17.103" class="difflineminus">- * @param rowIndex the row to click</span>
<a href="#l17.104"></a><span id="l17.104" class="difflineplus">+ * @param {Object} tab - The account manger tab controller that opened.</span>
<a href="#l17.105"></a><span id="l17.105" class="difflineplus">+ * @param {Number} rowIndex - The row to click.</span>
<a href="#l17.106"></a><span id="l17.106">  */</span>
<a href="#l17.107"></a><span id="l17.107" class="difflineminus">-function click_account_tree_row(controller, rowIndex) {</span>
<a href="#l17.108"></a><span id="l17.108" class="difflineplus">+function click_account_tree_row(tab, rowIndex) {</span>
<a href="#l17.109"></a><span id="l17.109">   utils.waitFor(</span>
<a href="#l17.110"></a><span id="l17.110" class="difflineminus">-    () =&gt; controller.window.currentAccount != null,</span>
<a href="#l17.111"></a><span id="l17.111" class="difflineplus">+    () =&gt; tab.browser.contentWindow.currentAccount != null,</span>
<a href="#l17.112"></a><span id="l17.112">     &quot;Timeout waiting for currentAccount to become non-null&quot;</span>
<a href="#l17.113"></a><span id="l17.113">   );</span>
<a href="#l17.114"></a><span id="l17.114"> </span>
<a href="#l17.115"></a><span id="l17.115" class="difflineminus">-  let tree = controller.window.document.getElementById(&quot;accounttree&quot;);</span>
<a href="#l17.116"></a><span id="l17.116" class="difflineplus">+  let tree = content_tab_e(tab, &quot;accounttree&quot;);</span>
<a href="#l17.117"></a><span id="l17.117"> </span>
<a href="#l17.118"></a><span id="l17.118" class="difflineminus">-  fdh.click_tree_row(tree, rowIndex, controller);</span>
<a href="#l17.119"></a><span id="l17.119" class="difflineplus">+  fdh.click_tree_row(tree, rowIndex, mc);</span>
<a href="#l17.120"></a><span id="l17.120"> </span>
<a href="#l17.121"></a><span id="l17.121">   utils.waitFor(</span>
<a href="#l17.122"></a><span id="l17.122" class="difflineminus">-    () =&gt; controller.window.pendingAccount == null,</span>
<a href="#l17.123"></a><span id="l17.123" class="difflineplus">+    () =&gt; tab.browser.contentWindow.pendingAccount == null,</span>
<a href="#l17.124"></a><span id="l17.124">     &quot;Timeout waiting for pendingAccount to become null&quot;</span>
<a href="#l17.125"></a><span id="l17.125">   );</span>
<a href="#l17.126"></a><span id="l17.126"> </span>
<a href="#l17.127"></a><span id="l17.127">   // Ensure the page is fully loaded (e.g. onInit functions).</span>
<a href="#l17.128"></a><span id="l17.128">   wh.wait_for_frame_load(</span>
<a href="#l17.129"></a><span id="l17.129" class="difflineminus">-    controller.e(&quot;contentFrame&quot;),</span>
<a href="#l17.130"></a><span id="l17.130" class="difflineminus">-    controller.window.pageURL(</span>
<a href="#l17.131"></a><span id="l17.131" class="difflineplus">+    content_tab_e(tab, &quot;contentFrame&quot;),</span>
<a href="#l17.132"></a><span id="l17.132" class="difflineplus">+    tab.browser.contentWindow.pageURL(</span>
<a href="#l17.133"></a><span id="l17.133">       tree.view.getItemAtIndex(rowIndex).getAttribute(&quot;PageTag&quot;)</span>
<a href="#l17.134"></a><span id="l17.134">     )</span>
<a href="#l17.135"></a><span id="l17.135">   );</span>
<a href="#l17.136"></a><span id="l17.136"> }</span>
<a href="#l17.137"></a><span id="l17.137"> </span>
<a href="#l17.138"></a><span id="l17.138"> /**</span>
<a href="#l17.139"></a><span id="l17.139">  * Returns the index of the row in account tree corresponding to the wanted</span>
<a href="#l17.140"></a><span id="l17.140">  * account and its settings pane.</span>
<a href="#l17.141"></a><span id="l17.141">  *</span>
<a href="#l17.142"></a><span id="l17.142" class="difflineminus">- * @param aAccountKey  The key of the account to return.</span>
<a href="#l17.143"></a><span id="l17.143" class="difflineminus">- *                     If 'null', the SMTP pane is returned.</span>
<a href="#l17.144"></a><span id="l17.144" class="difflineminus">- * @param aPaneId      The ID of the account settings pane to select.</span>
<a href="#l17.145"></a><span id="l17.145" class="difflineplus">+ * @param {Number} accountKey - The key of the account to return.</span>
<a href="#l17.146"></a><span id="l17.146" class="difflineplus">+ *                              If 'null', the SMTP pane is returned.</span>
<a href="#l17.147"></a><span id="l17.147" class="difflineplus">+ * @param {Number} paneId - The ID of the account settings pane to select.</span>
<a href="#l17.148"></a><span id="l17.148" class="difflineplus">+ *</span>
<a href="#l17.149"></a><span id="l17.149">  *</span>
<a href="#l17.150"></a><span id="l17.150" class="difflineminus">- * @return  The row index of the account and pane. If it was not found return -1.</span>
<a href="#l17.151"></a><span id="l17.151" class="difflineminus">- *          Do not throw as callers may intentionally just check if a row exists.</span>
<a href="#l17.152"></a><span id="l17.152" class="difflineminus">- *          Just dump into the log so that a subsequent throw in</span>
<a href="#l17.153"></a><span id="l17.153" class="difflineminus">- *          click_account_tree_row has a useful context.</span>
<a href="#l17.154"></a><span id="l17.154" class="difflineplus">+ * @returns {Number} The row index of the account and pane. If it was not found return -1.</span>
<a href="#l17.155"></a><span id="l17.155" class="difflineplus">+ *                   Do not throw as callers may intentionally just check if a row exists.</span>
<a href="#l17.156"></a><span id="l17.156" class="difflineplus">+ *                   Just dump into the log so that a subsequent throw in</span>
<a href="#l17.157"></a><span id="l17.157" class="difflineplus">+ *                   click_account_tree_row has a useful context.</span>
<a href="#l17.158"></a><span id="l17.158">  */</span>
<a href="#l17.159"></a><span id="l17.159" class="difflineminus">-function get_account_tree_row(aAccountKey, aPaneId, aController) {</span>
<a href="#l17.160"></a><span id="l17.160" class="difflineplus">+function get_account_tree_row(accountKey, paneId, tab) {</span>
<a href="#l17.161"></a><span id="l17.161">   let rowIndex = 0;</span>
<a href="#l17.162"></a><span id="l17.162" class="difflineminus">-  let accountTreeNode = aController.e(&quot;account-tree-children&quot;);</span>
<a href="#l17.163"></a><span id="l17.163" class="difflineplus">+  let accountTreeNode = content_tab_e(tab, &quot;account-tree-children&quot;);</span>
<a href="#l17.164"></a><span id="l17.164"> </span>
<a href="#l17.165"></a><span id="l17.165">   for (let i = 0; i &lt; accountTreeNode.children.length; i++) {</span>
<a href="#l17.166"></a><span id="l17.166">     if (&quot;_account&quot; in accountTreeNode.children[i]) {</span>
<a href="#l17.167"></a><span id="l17.167">       let accountHead = accountTreeNode.children[i];</span>
<a href="#l17.168"></a><span id="l17.168" class="difflineminus">-      if (aAccountKey == accountHead._account.key) {</span>
<a href="#l17.169"></a><span id="l17.169" class="difflineplus">+      if (accountKey == accountHead._account.key) {</span>
<a href="#l17.170"></a><span id="l17.170">         // If this is the wanted account, find the wanted settings pane.</span>
<a href="#l17.171"></a><span id="l17.171">         let accountBlock = accountHead.querySelectorAll(&quot;[PageTag]&quot;);</span>
<a href="#l17.172"></a><span id="l17.172" class="difflineminus">-        // A null aPaneId means the main pane.</span>
<a href="#l17.173"></a><span id="l17.173" class="difflineminus">-        if (!aPaneId) {</span>
<a href="#l17.174"></a><span id="l17.174" class="difflineplus">+        // A null paneId means the main pane.</span>
<a href="#l17.175"></a><span id="l17.175" class="difflineplus">+        if (!paneId) {</span>
<a href="#l17.176"></a><span id="l17.176">           return rowIndex;</span>
<a href="#l17.177"></a><span id="l17.177">         }</span>
<a href="#l17.178"></a><span id="l17.178"> </span>
<a href="#l17.179"></a><span id="l17.179">         // Otherwise find the pane in the children.</span>
<a href="#l17.180"></a><span id="l17.180">         for (let j = 0; j &lt; accountBlock.length; j++) {</span>
<a href="#l17.181"></a><span id="l17.181" class="difflineminus">-          if (accountBlock[j].getAttribute(&quot;PageTag&quot;) == aPaneId) {</span>
<a href="#l17.182"></a><span id="l17.182" class="difflineplus">+          if (accountBlock[j].getAttribute(&quot;PageTag&quot;) == paneId) {</span>
<a href="#l17.183"></a><span id="l17.183">             return rowIndex + j + 1;</span>
<a href="#l17.184"></a><span id="l17.184">           }</span>
<a href="#l17.185"></a><span id="l17.185">         }</span>
<a href="#l17.186"></a><span id="l17.186"> </span>
<a href="#l17.187"></a><span id="l17.187">         // The pane was not found.</span>
<a href="#l17.188"></a><span id="l17.188">         dump(</span>
<a href="#l17.189"></a><span id="l17.189">           &quot;The treerow for pane &quot; +</span>
<a href="#l17.190"></a><span id="l17.190" class="difflineminus">-            aPaneId +</span>
<a href="#l17.191"></a><span id="l17.191" class="difflineplus">+            paneId +</span>
<a href="#l17.192"></a><span id="l17.192">             &quot; of account &quot; +</span>
<a href="#l17.193"></a><span id="l17.193" class="difflineminus">-            aAccountKey +</span>
<a href="#l17.194"></a><span id="l17.194" class="difflineplus">+            accountKey +</span>
<a href="#l17.195"></a><span id="l17.195">             &quot; was not found!\n&quot;</span>
<a href="#l17.196"></a><span id="l17.196">         );</span>
<a href="#l17.197"></a><span id="l17.197">         return -1;</span>
<a href="#l17.198"></a><span id="l17.198">       }</span>
<a href="#l17.199"></a><span id="l17.199">       // If this is not the wanted account, skip all of its settings panes.</span>
<a href="#l17.200"></a><span id="l17.200">       rowIndex += accountHead.querySelectorAll(&quot;[PageTag]&quot;).length;</span>
<a href="#l17.201"></a><span id="l17.201" class="difflineminus">-    } else if (aAccountKey == null) {</span>
<a href="#l17.202"></a><span id="l17.202" class="difflineplus">+    } else if (accountKey == null) {</span>
<a href="#l17.203"></a><span id="l17.203">       // A row without _account should be the SMTP server.</span>
<a href="#l17.204"></a><span id="l17.204">       return rowIndex;</span>
<a href="#l17.205"></a><span id="l17.205">     }</span>
<a href="#l17.206"></a><span id="l17.206">     rowIndex++;</span>
<a href="#l17.207"></a><span id="l17.207">   }</span>
<a href="#l17.208"></a><span id="l17.208"> </span>
<a href="#l17.209"></a><span id="l17.209">   // The account was not found.</span>
<a href="#l17.210"></a><span id="l17.210" class="difflineminus">-  dump(&quot;The treerow for account &quot; + aAccountKey + &quot; was not found!\n&quot;);</span>
<a href="#l17.211"></a><span id="l17.211" class="difflineplus">+  dump(&quot;The treerow for account &quot; + accountKey + &quot; was not found!\n&quot;);</span>
<a href="#l17.212"></a><span id="l17.212">   return -1;</span>
<a href="#l17.213"></a><span id="l17.213"> }</span>
<a href="#l17.214"></a><span id="l17.214"> </span>
<a href="#l17.215"></a><span id="l17.215"> /**</span>
<a href="#l17.216"></a><span id="l17.216">  * Remove an account via the account manager UI.</span>
<a href="#l17.217"></a><span id="l17.217">  *</span>
<a href="#l17.218"></a><span id="l17.218" class="difflineminus">- * @param aAccount        The account to remove.</span>
<a href="#l17.219"></a><span id="l17.219" class="difflineminus">- * @param aController     The controller of the account manager window.</span>
<a href="#l17.220"></a><span id="l17.220" class="difflineminus">- * @param aRemoveAccount  Remove the account itself.</span>
<a href="#l17.221"></a><span id="l17.221" class="difflineminus">- * @param aRemoveData     Remove the message data of the account.</span>
<a href="#l17.222"></a><span id="l17.222" class="difflineplus">+ * @param {Object} account - The account to remove.</span>
<a href="#l17.223"></a><span id="l17.223" class="difflineplus">+ * @param {Object} tab - The account manger tab that opened.</span>
<a href="#l17.224"></a><span id="l17.224" class="difflineplus">+ * @param {boolean} removeAccount - Remove the account itself.</span>
<a href="#l17.225"></a><span id="l17.225" class="difflineplus">+ * @param {boolean} removeData - Remove the message data of the account.</span>
<a href="#l17.226"></a><span id="l17.226">  */</span>
<a href="#l17.227"></a><span id="l17.227"> function remove_account(</span>
<a href="#l17.228"></a><span id="l17.228" class="difflineminus">-  aAccount,</span>
<a href="#l17.229"></a><span id="l17.229" class="difflineminus">-  aController,</span>
<a href="#l17.230"></a><span id="l17.230" class="difflineminus">-  aRemoveAccount = true,</span>
<a href="#l17.231"></a><span id="l17.231" class="difflineminus">-  aRemoveData = false</span>
<a href="#l17.232"></a><span id="l17.232" class="difflineplus">+  account,</span>
<a href="#l17.233"></a><span id="l17.233" class="difflineplus">+  tab,</span>
<a href="#l17.234"></a><span id="l17.234" class="difflineplus">+  removeAccount = true,</span>
<a href="#l17.235"></a><span id="l17.235" class="difflineplus">+  removeData = false</span>
<a href="#l17.236"></a><span id="l17.236"> ) {</span>
<a href="#l17.237"></a><span id="l17.237" class="difflineminus">-  let accountRow = get_account_tree_row(</span>
<a href="#l17.238"></a><span id="l17.238" class="difflineminus">-    aAccount.key,</span>
<a href="#l17.239"></a><span id="l17.239" class="difflineminus">-    &quot;am-server.xhtml&quot;,</span>
<a href="#l17.240"></a><span id="l17.240" class="difflineminus">-    aController</span>
<a href="#l17.241"></a><span id="l17.241" class="difflineminus">-  );</span>
<a href="#l17.242"></a><span id="l17.242" class="difflineminus">-  click_account_tree_row(aController, accountRow);</span>
<a href="#l17.243"></a><span id="l17.243" class="difflineplus">+  let accountRow = get_account_tree_row(account.key, &quot;am-server.xhtml&quot;, tab);</span>
<a href="#l17.244"></a><span id="l17.244" class="difflineplus">+  click_account_tree_row(tab, accountRow);</span>
<a href="#l17.245"></a><span id="l17.245"> </span>
<a href="#l17.246"></a><span id="l17.246">   wh.plan_for_modal_dialog(&quot;Mailnews:removeAccount&quot;, function(cdc) {</span>
<a href="#l17.247"></a><span id="l17.247">     // Account removal confirmation dialog. Select what to remove.</span>
<a href="#l17.248"></a><span id="l17.248" class="difflineminus">-    if (aRemoveAccount) {</span>
<a href="#l17.249"></a><span id="l17.249" class="difflineplus">+    if (removeAccount) {</span>
<a href="#l17.250"></a><span id="l17.250">       cdc.click(</span>
<a href="#l17.251"></a><span id="l17.251">         new elib.Elem(cdc.window.document.getElementById(&quot;removeAccount&quot;))</span>
<a href="#l17.252"></a><span id="l17.252">       );</span>
<a href="#l17.253"></a><span id="l17.253">     }</span>
<a href="#l17.254"></a><span id="l17.254" class="difflineminus">-    if (aRemoveData) {</span>
<a href="#l17.255"></a><span id="l17.255" class="difflineplus">+    if (removeData) {</span>
<a href="#l17.256"></a><span id="l17.256">       cdc.click(</span>
<a href="#l17.257"></a><span id="l17.257">         new elib.Elem(cdc.window.document.getElementById(&quot;removeData&quot;))</span>
<a href="#l17.258"></a><span id="l17.258">       );</span>
<a href="#l17.259"></a><span id="l17.259">     }</span>
<a href="#l17.260"></a><span id="l17.260"> </span>
<a href="#l17.261"></a><span id="l17.261">     cdc.window.document.documentElement.querySelector(&quot;dialog&quot;).acceptDialog();</span>
<a href="#l17.262"></a><span id="l17.262">     cdc.waitFor(</span>
<a href="#l17.263"></a><span id="l17.263">       () =&gt;</span>
<a href="#l17.264"></a><span id="l17.264" class="difflineat">@@ -196,17 +196,17 @@ function remove_account(</span>
<a href="#l17.265"></a><span id="l17.265">           .disabled,</span>
<a href="#l17.266"></a><span id="l17.266">       &quot;Timeout waiting for finish of account removal&quot;,</span>
<a href="#l17.267"></a><span id="l17.267">       5000,</span>
<a href="#l17.268"></a><span id="l17.268">       100</span>
<a href="#l17.269"></a><span id="l17.269">     );</span>
<a href="#l17.270"></a><span id="l17.270">     cdc.window.document.documentElement.querySelector(&quot;dialog&quot;).acceptDialog();</span>
<a href="#l17.271"></a><span id="l17.271">   });</span>
<a href="#l17.272"></a><span id="l17.272"> </span>
<a href="#l17.273"></a><span id="l17.273" class="difflineminus">-  aAccount = null;</span>
<a href="#l17.274"></a><span id="l17.274" class="difflineplus">+  account = null;</span>
<a href="#l17.275"></a><span id="l17.275">   // Use the Remove item in the Account actions menu.</span>
<a href="#l17.276"></a><span id="l17.276" class="difflineminus">-  aController.click(aController.eid(&quot;accountActionsButton&quot;));</span>
<a href="#l17.277"></a><span id="l17.277" class="difflineminus">-  aController.click_menus_in_sequence(aController.e(&quot;accountActionsDropdown&quot;), [</span>
<a href="#l17.278"></a><span id="l17.278" class="difflineplus">+  mc.click(content_tab_eid(tab, &quot;accountActionsButton&quot;));</span>
<a href="#l17.279"></a><span id="l17.279" class="difflineplus">+  mc.click_menus_in_sequence(content_tab_e(tab, &quot;accountActionsDropdown&quot;), [</span>
<a href="#l17.280"></a><span id="l17.280">     { id: &quot;accountActionsDropdownRemove&quot; },</span>
<a href="#l17.281"></a><span id="l17.281">   ]);</span>
<a href="#l17.282"></a><span id="l17.282">   wh.wait_for_modal_dialog(&quot;Mailnews:removeAccount&quot;);</span>
<a href="#l17.283"></a><span id="l17.283">   // TODO: For unknown reason this also closes the whole account manager.</span>
<a href="#l17.284"></a><span id="l17.284"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mail/themes/osx/mail/accountManage.css</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mail/themes/osx/mail/accountManage.css</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -42,12 +42,8 @@ description {</span>
<a href="#l18.4"></a><span id="l18.4"> }</span>
<a href="#l18.5"></a><span id="l18.5"> </span>
<a href="#l18.6"></a><span id="l18.6"> /* ::::: dialog header ::::: */</span>
<a href="#l18.7"></a><span id="l18.7"> </span>
<a href="#l18.8"></a><span id="l18.8"> .dialogheader {</span>
<a href="#l18.9"></a><span id="l18.9">   margin: 0 5px 5px;</span>
<a href="#l18.10"></a><span id="l18.10">   padding: 5px 8px;</span>
<a href="#l18.11"></a><span id="l18.11"> }</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineminus">-.dialogheader-title {</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineminus">-  display: none;</span>
<a href="#l18.15"></a><span id="l18.15" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/base/prefs/content/AccountManager.js</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/base/prefs/content/AccountManager.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -42,21 +42,19 @@ var { MailServices } = ChromeUtils.impor</span>
<a href="#l19.4"></a><span id="l19.4"> );</span>
<a href="#l19.5"></a><span id="l19.5"> var { allAccountsSorted } = ChromeUtils.import(</span>
<a href="#l19.6"></a><span id="l19.6">   &quot;resource:///modules/folderUtils.jsm&quot;</span>
<a href="#l19.7"></a><span id="l19.7"> );</span>
<a href="#l19.8"></a><span id="l19.8"> var { cleanUpHostName, isLegalHostNameOrIP } = ChromeUtils.import(</span>
<a href="#l19.9"></a><span id="l19.9">   &quot;resource:///modules/hostnameUtils.jsm&quot;</span>
<a href="#l19.10"></a><span id="l19.10"> );</span>
<a href="#l19.11"></a><span id="l19.11"> </span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-document.addEventListener(&quot;dialogcancel&quot;, onNotAccept);</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineminus">-document.addEventListener(&quot;dialogaccept&quot;, event =&gt; {</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineminus">-  if (!onAccept(true)) {</span>
<a href="#l19.15"></a><span id="l19.15" class="difflineminus">-    event.preventDefault();</span>
<a href="#l19.16"></a><span id="l19.16" class="difflineminus">-  }</span>
<a href="#l19.17"></a><span id="l19.17" class="difflineplus">+document.addEventListener(&quot;prefchange&quot;, event =&gt; {</span>
<a href="#l19.18"></a><span id="l19.18" class="difflineplus">+  onAccept(true);</span>
<a href="#l19.19"></a><span id="l19.19" class="difflineplus">+  event.stopPropagation();</span>
<a href="#l19.20"></a><span id="l19.20"> });</span>
<a href="#l19.21"></a><span id="l19.21"> </span>
<a href="#l19.22"></a><span id="l19.22"> // If Local directory has changed the app needs to restart. Once this is set</span>
<a href="#l19.23"></a><span id="l19.23"> // a restart will be attempted at each attempt to close the Account manager with OK.</span>
<a href="#l19.24"></a><span id="l19.24"> var gRestartNeeded = false;</span>
<a href="#l19.25"></a><span id="l19.25"> </span>
<a href="#l19.26"></a><span id="l19.26"> // This is a hash-map for every account we've touched in the pane. Each entry</span>
<a href="#l19.27"></a><span id="l19.27"> // has additional maps of attribute-value pairs that we're going to want to save</span>
<a href="#l19.28"></a><span id="l19.28" class="difflineat">@@ -129,37 +127,47 @@ function updateElementWithKeys(account, </span>
<a href="#l19.29"></a><span id="l19.29">     default:</span>
<a href="#l19.30"></a><span id="l19.30">     //      dump(&quot;unknown element type! &quot;+type+&quot;\n&quot;);</span>
<a href="#l19.31"></a><span id="l19.31">   }</span>
<a href="#l19.32"></a><span id="l19.32"> }</span>
<a href="#l19.33"></a><span id="l19.33"> </span>
<a href="#l19.34"></a><span id="l19.34"> // called when the whole document loads</span>
<a href="#l19.35"></a><span id="l19.35"> // perform initialization here</span>
<a href="#l19.36"></a><span id="l19.36"> function onLoad() {</span>
<a href="#l19.37"></a><span id="l19.37" class="difflineminus">-  var selectedServer;</span>
<a href="#l19.38"></a><span id="l19.38" class="difflineminus">-  var selectPage = null;</span>
<a href="#l19.39"></a><span id="l19.39" class="difflineplus">+  let selectedServer = document.documentElement.server;</span>
<a href="#l19.40"></a><span id="l19.40" class="difflineplus">+  let selectPage = document.documentElement.selectPage || null;</span>
<a href="#l19.41"></a><span id="l19.41"> </span>
<a href="#l19.42"></a><span id="l19.42">   // Arguments can have two properties: (1) &quot;server,&quot; the nsIMsgIncomingServer</span>
<a href="#l19.43"></a><span id="l19.43">   // to select initially and (2) &quot;selectPage,&quot; the page for that server to that</span>
<a href="#l19.44"></a><span id="l19.44">   // should be selected.</span>
<a href="#l19.45"></a><span id="l19.45" class="difflineminus">-  if (&quot;arguments&quot; in window &amp;&amp; window.arguments[0]) {</span>
<a href="#l19.46"></a><span id="l19.46" class="difflineminus">-    selectedServer = window.arguments[0].server;</span>
<a href="#l19.47"></a><span id="l19.47" class="difflineminus">-    selectPage = window.arguments[0].selectPage;</span>
<a href="#l19.48"></a><span id="l19.48" class="difflineminus">-  }</span>
<a href="#l19.49"></a><span id="l19.49"> </span>
<a href="#l19.50"></a><span id="l19.50">   accountArray = {};</span>
<a href="#l19.51"></a><span id="l19.51">   gGenericAttributeTypes = {};</span>
<a href="#l19.52"></a><span id="l19.52"> </span>
<a href="#l19.53"></a><span id="l19.53">   gAccountTree.load();</span>
<a href="#l19.54"></a><span id="l19.54"> </span>
<a href="#l19.55"></a><span id="l19.55">   setTimeout(selectServer, 0, selectedServer, selectPage);</span>
<a href="#l19.56"></a><span id="l19.56"> </span>
<a href="#l19.57"></a><span id="l19.57" class="difflineminus">-  // Make sure the account manager window fits the screen.</span>
<a href="#l19.58"></a><span id="l19.58" class="difflineminus">-  document.getElementById(&quot;accountManager&quot;).style.maxHeight =</span>
<a href="#l19.59"></a><span id="l19.59" class="difflineminus">-    window.screen.availHeight - 30 + &quot;px&quot;;</span>
<a href="#l19.60"></a><span id="l19.60" class="difflineplus">+  let contentFrame = document.getElementById(&quot;contentFrame&quot;);</span>
<a href="#l19.61"></a><span id="l19.61" class="difflineplus">+  contentFrame.addEventListener(&quot;load&quot;, event =&gt; {</span>
<a href="#l19.62"></a><span id="l19.62" class="difflineplus">+    let inputElements = contentFrame.contentDocument.querySelectorAll(</span>
<a href="#l19.63"></a><span id="l19.63" class="difflineplus">+      &quot;checkbox, input, menulist, textarea, radiogroup, richlistbox&quot;</span>
<a href="#l19.64"></a><span id="l19.64" class="difflineplus">+    );</span>
<a href="#l19.65"></a><span id="l19.65" class="difflineplus">+    for (let input of inputElements) {</span>
<a href="#l19.66"></a><span id="l19.66" class="difflineplus">+      if (input.localName == &quot;input&quot; || input.localName == &quot;textarea&quot;) {</span>
<a href="#l19.67"></a><span id="l19.67" class="difflineplus">+        input.addEventListener(&quot;change&quot;, event =&gt; {</span>
<a href="#l19.68"></a><span id="l19.68" class="difflineplus">+          onAccept(true);</span>
<a href="#l19.69"></a><span id="l19.69" class="difflineplus">+        });</span>
<a href="#l19.70"></a><span id="l19.70" class="difflineplus">+      } else {</span>
<a href="#l19.71"></a><span id="l19.71" class="difflineplus">+        input.addEventListener(&quot;command&quot;, event =&gt; {</span>
<a href="#l19.72"></a><span id="l19.72" class="difflineplus">+          onAccept(true);</span>
<a href="#l19.73"></a><span id="l19.73" class="difflineplus">+        });</span>
<a href="#l19.74"></a><span id="l19.74" class="difflineplus">+      }</span>
<a href="#l19.75"></a><span id="l19.75" class="difflineplus">+    }</span>
<a href="#l19.76"></a><span id="l19.76" class="difflineplus">+  });</span>
<a href="#l19.77"></a><span id="l19.77"> }</span>
<a href="#l19.78"></a><span id="l19.78"> </span>
<a href="#l19.79"></a><span id="l19.79"> function onUnload() {</span>
<a href="#l19.80"></a><span id="l19.80">   gAccountTree.unload();</span>
<a href="#l19.81"></a><span id="l19.81"> }</span>
<a href="#l19.82"></a><span id="l19.82"> </span>
<a href="#l19.83"></a><span id="l19.83"> function selectServer(server, selectPageId) {</span>
<a href="#l19.84"></a><span id="l19.84">   let childrenNode = document.getElementById(&quot;account-tree-children&quot;);</span>
<a href="#l19.85"></a><span id="l19.85" class="difflineat">@@ -907,17 +915,17 @@ function onRemoveAccount(event) {</span>
<a href="#l19.86"></a><span id="l19.86"> </span>
<a href="#l19.87"></a><span id="l19.87">   // Confirm account deletion.</span>
<a href="#l19.88"></a><span id="l19.88">   let removeArgs = {</span>
<a href="#l19.89"></a><span id="l19.89">     server,</span>
<a href="#l19.90"></a><span id="l19.90">     account: currentAccount,</span>
<a href="#l19.91"></a><span id="l19.91">     result: false,</span>
<a href="#l19.92"></a><span id="l19.92">   };</span>
<a href="#l19.93"></a><span id="l19.93"> </span>
<a href="#l19.94"></a><span id="l19.94" class="difflineminus">-  window.openDialog(</span>
<a href="#l19.95"></a><span id="l19.95" class="difflineplus">+  window.docShell.rootTreeItem.domWindow.openDialog(</span>
<a href="#l19.96"></a><span id="l19.96">     &quot;chrome://messenger/content/removeAccount.xhtml&quot;,</span>
<a href="#l19.97"></a><span id="l19.97">     &quot;removeAccount&quot;,</span>
<a href="#l19.98"></a><span id="l19.98">     &quot;chrome,titlebar,modal,centerscreen,resizable=no&quot;,</span>
<a href="#l19.99"></a><span id="l19.99">     removeArgs</span>
<a href="#l19.100"></a><span id="l19.100">   );</span>
<a href="#l19.101"></a><span id="l19.101"> </span>
<a href="#l19.102"></a><span id="l19.102">   // If result is true, the account was removed.</span>
<a href="#l19.103"></a><span id="l19.103">   if (!removeArgs.result) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mailnews/base/prefs/content/AccountManager.xhtml</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mailnews/base/prefs/content/AccountManager.xhtml</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -5,22 +5,19 @@</span>
<a href="#l20.4"></a><span id="l20.4"> </span>
<a href="#l20.5"></a><span id="l20.5"> &lt;?xml-stylesheet href=&quot;chrome://messenger/skin/folderPane.css&quot; type=&quot;text/css&quot;?&gt;</span>
<a href="#l20.6"></a><span id="l20.6"> &lt;?xml-stylesheet href=&quot;chrome://messenger/skin/accountManage.css&quot; type=&quot;text/css&quot;?&gt;</span>
<a href="#l20.7"></a><span id="l20.7"> </span>
<a href="#l20.8"></a><span id="l20.8"> &lt;!DOCTYPE window SYSTEM &quot;chrome://messenger/locale/AccountManager.dtd&quot;&gt;</span>
<a href="#l20.9"></a><span id="l20.9"> &lt;window windowtype=&quot;mailnews:accountmanager&quot;</span>
<a href="#l20.10"></a><span id="l20.10">         xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot; xmlns:html=&quot;http://www.w3.org/1999/xhtml&quot;</span>
<a href="#l20.11"></a><span id="l20.11">         title=&quot;&amp;accountManagerTitle.label;&quot;</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-        style=&quot;&amp;accountManager.size;&quot;</span>
<a href="#l20.13"></a><span id="l20.13">         persist=&quot;width height screenX screenY&quot;</span>
<a href="#l20.14"></a><span id="l20.14">         onload=&quot;onLoad(event);&quot;</span>
<a href="#l20.15"></a><span id="l20.15">         onunload=&quot;onUnload();&quot;&gt;</span>
<a href="#l20.16"></a><span id="l20.16" class="difflineminus">-&lt;dialog id=&quot;accountManager&quot;</span>
<a href="#l20.17"></a><span id="l20.17" class="difflineminus">-        buttons=&quot;accept,cancel&quot;&gt;</span>
<a href="#l20.18"></a><span id="l20.18"> &lt;stringbundle id=&quot;bundle_brand&quot; src=&quot;chrome://branding/locale/brand.properties&quot;/&gt;</span>
<a href="#l20.19"></a><span id="l20.19"> &lt;stringbundle id=&quot;bundle_prefs&quot; src=&quot;chrome://messenger/locale/prefs.properties&quot;/&gt;</span>
<a href="#l20.20"></a><span id="l20.20"> &lt;script src=&quot;chrome://messenger/content/accountUtils.js&quot;/&gt;</span>
<a href="#l20.21"></a><span id="l20.21"> &lt;script src=&quot;chrome://messenger/content/am-prefs.js&quot;/&gt;</span>
<a href="#l20.22"></a><span id="l20.22"> &lt;script src=&quot;chrome://messenger/content/AccountManager.js&quot;/&gt;</span>
<a href="#l20.23"></a><span id="l20.23"> #ifdef MOZ_SUITE</span>
<a href="#l20.24"></a><span id="l20.24"> &lt;script src=&quot;chrome://messenger/content/am-help.js&quot;/&gt;</span>
<a href="#l20.25"></a><span id="l20.25"> #endif</span>
<a href="#l20.26"></a><span id="l20.26" class="difflineat">@@ -85,10 +82,9 @@</span>
<a href="#l20.27"></a><span id="l20.27">       &lt;button disabled=&quot;true&quot; label=&quot;&amp;removeButton.label;&quot; oncommand=&quot;onRemoveAccount(event);&quot; id=&quot;removeButton&quot;</span>
<a href="#l20.28"></a><span id="l20.28">               prefstring=&quot;mail.disable_button.delete_account&quot;</span>
<a href="#l20.29"></a><span id="l20.29">               accesskey=&quot;&amp;removeButton.accesskey;&quot;/&gt;</span>
<a href="#l20.30"></a><span id="l20.30"> #endif</span>
<a href="#l20.31"></a><span id="l20.31">     &lt;/vbox&gt;</span>
<a href="#l20.32"></a><span id="l20.32"> </span>
<a href="#l20.33"></a><span id="l20.33">     &lt;iframe id=&quot;contentFrame&quot; name=&quot;contentFrame&quot; flex=&quot;1&quot;/&gt;</span>
<a href="#l20.34"></a><span id="l20.34">   &lt;/hbox&gt;</span>
<a href="#l20.35"></a><span id="l20.35" class="difflineminus">-&lt;/dialog&gt;</span>
<a href="#l20.36"></a><span id="l20.36"> &lt;/window&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mailnews/base/prefs/content/accountUtils.js</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mailnews/base/prefs/content/accountUtils.js</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -66,17 +66,17 @@ function showMailIntegrationDialog() {</span>
<a href="#l21.4"></a><span id="l21.4">     // show the default client dialog only if we have at least one account,</span>
<a href="#l21.5"></a><span id="l21.5">     // if we should check for the default client, and we want to check if we are</span>
<a href="#l21.6"></a><span id="l21.6">     // the default for mail/news and are not the default client for mail/news</span>
<a href="#l21.7"></a><span id="l21.7">     if (</span>
<a href="#l21.8"></a><span id="l21.8">       appTypesCheck &amp;&amp;</span>
<a href="#l21.9"></a><span id="l21.9">       shellService.shouldCheckDefaultClient &amp;&amp;</span>
<a href="#l21.10"></a><span id="l21.10">       !shellService.isDefaultClient(true, appTypesCheck)</span>
<a href="#l21.11"></a><span id="l21.11">     ) {</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-      window.openDialog(</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineplus">+      window.docShell.rootTreeItem.domWindow.openDialog(</span>
<a href="#l21.14"></a><span id="l21.14">         &quot;chrome://communicator/content/defaultClientDialog.xhtml&quot;,</span>
<a href="#l21.15"></a><span id="l21.15">         &quot;DefaultClient&quot;,</span>
<a href="#l21.16"></a><span id="l21.16">         &quot;modal,centerscreen,chrome,resizable=no&quot;</span>
<a href="#l21.17"></a><span id="l21.17">       );</span>
<a href="#l21.18"></a><span id="l21.18">     }</span>
<a href="#l21.19"></a><span id="l21.19">   } catch (ex) {}</span>
<a href="#l21.20"></a><span id="l21.20"> }</span>
<a href="#l21.21"></a><span id="l21.21"> </span>
<a href="#l21.22"></a><span id="l21.22" class="difflineat">@@ -194,17 +194,17 @@ function MsgAccountWizard(wizardCallback</span>
<a href="#l21.23"></a><span id="l21.23">  *</span>
<a href="#l21.24"></a><span id="l21.24">  * @param wizardCallback if the wizard is run, callback when it is done.</span>
<a href="#l21.25"></a><span id="l21.25">  * @param type - optional account type token, for Tb.</span>
<a href="#l21.26"></a><span id="l21.26">  * @see msgNewMailAccount below for the new implementation.</span>
<a href="#l21.27"></a><span id="l21.27">  */</span>
<a href="#l21.28"></a><span id="l21.28"> function msgOpenAccountWizard(wizardCallback, type) {</span>
<a href="#l21.29"></a><span id="l21.29">   gNewAccountToLoad = null;</span>
<a href="#l21.30"></a><span id="l21.30"> </span>
<a href="#l21.31"></a><span id="l21.31" class="difflineminus">-  window.openDialog(</span>
<a href="#l21.32"></a><span id="l21.32" class="difflineplus">+  window.docShell.rootTreeItem.domWindow.openDialog(</span>
<a href="#l21.33"></a><span id="l21.33">     &quot;chrome://messenger/content/AccountWizard.xhtml&quot;,</span>
<a href="#l21.34"></a><span id="l21.34">     &quot;AccountWizard&quot;,</span>
<a href="#l21.35"></a><span id="l21.35">     &quot;chrome,modal,titlebar,centerscreen&quot;,</span>
<a href="#l21.36"></a><span id="l21.36">     { okCallback: wizardCallback, acctType: type }</span>
<a href="#l21.37"></a><span id="l21.37">   );</span>
<a href="#l21.38"></a><span id="l21.38"> </span>
<a href="#l21.39"></a><span id="l21.39">   loadInboxForNewAccount();</span>
<a href="#l21.40"></a><span id="l21.40"> </span>
<a href="#l21.41"></a><span id="l21.41" class="difflineat">@@ -243,25 +243,25 @@ function initAccountWizardTB(args) {</span>
<a href="#l21.42"></a><span id="l21.42">   }</span>
<a href="#l21.43"></a><span id="l21.43"> }</span>
<a href="#l21.44"></a><span id="l21.44"> </span>
<a href="#l21.45"></a><span id="l21.45"> function AddMailAccount() {</span>
<a href="#l21.46"></a><span id="l21.46">   NewMailAccount(MailServices.mailSession.topmostMsgWindow);</span>
<a href="#l21.47"></a><span id="l21.47"> }</span>
<a href="#l21.48"></a><span id="l21.48"> </span>
<a href="#l21.49"></a><span id="l21.49"> function AddIMAccount() {</span>
<a href="#l21.50"></a><span id="l21.50" class="difflineminus">-  window.openDialog(</span>
<a href="#l21.51"></a><span id="l21.51" class="difflineplus">+  window.docShell.rootTreeItem.domWindow.openDialog(</span>
<a href="#l21.52"></a><span id="l21.52">     &quot;chrome://messenger/content/chat/imAccountWizard.xhtml&quot;,</span>
<a href="#l21.53"></a><span id="l21.53">     &quot;&quot;,</span>
<a href="#l21.54"></a><span id="l21.54">     &quot;chrome,modal,titlebar,centerscreen&quot;</span>
<a href="#l21.55"></a><span id="l21.55">   );</span>
<a href="#l21.56"></a><span id="l21.56"> }</span>
<a href="#l21.57"></a><span id="l21.57"> </span>
<a href="#l21.58"></a><span id="l21.58"> function AddFeedAccount() {</span>
<a href="#l21.59"></a><span id="l21.59" class="difflineminus">-  window.openDialog(</span>
<a href="#l21.60"></a><span id="l21.60" class="difflineplus">+  window.docShell.rootTreeItem.domWindow.openDialog(</span>
<a href="#l21.61"></a><span id="l21.61">     &quot;chrome://messenger-newsblog/content/feedAccountWizard.xhtml&quot;,</span>
<a href="#l21.62"></a><span id="l21.62">     &quot;&quot;,</span>
<a href="#l21.63"></a><span id="l21.63">     &quot;chrome,modal,titlebar,centerscreen&quot;</span>
<a href="#l21.64"></a><span id="l21.64">   );</span>
<a href="#l21.65"></a><span id="l21.65"> }</span>
<a href="#l21.66"></a><span id="l21.66"> </span>
<a href="#l21.67"></a><span id="l21.67"> /**</span>
<a href="#l21.68"></a><span id="l21.68">  * Opens the account settings window on the specified account</span>
<a href="#l21.69"></a><span id="l21.69" class="difflineat">@@ -269,48 +269,43 @@ function AddFeedAccount() {</span>
<a href="#l21.70"></a><span id="l21.70">  *</span>
<a href="#l21.71"></a><span id="l21.71">  * @param selectPage  The xul file name for the viewing page or</span>
<a href="#l21.72"></a><span id="l21.72">  *                    null for the account main page. Other pages are</span>
<a href="#l21.73"></a><span id="l21.73">  *                    'am-server.xhtml', 'am-copies.xhtml', 'am-offline.xhtml',</span>
<a href="#l21.74"></a><span id="l21.74">  *                    'am-addressing.xhtml', 'am-smtp.xhtml'</span>
<a href="#l21.75"></a><span id="l21.75">  * @param  aServer    The server of the account to select. Optional.</span>
<a href="#l21.76"></a><span id="l21.76">  */</span>
<a href="#l21.77"></a><span id="l21.77"> function MsgAccountManager(selectPage, aServer) {</span>
<a href="#l21.78"></a><span id="l21.78" class="difflineminus">-  var existingAccountManager = Services.wm.getMostRecentWindow(</span>
<a href="#l21.79"></a><span id="l21.79" class="difflineminus">-    &quot;mailnews:accountmanager&quot;</span>
<a href="#l21.80"></a><span id="l21.80" class="difflineminus">-  );</span>
<a href="#l21.81"></a><span id="l21.81" class="difflineminus">-</span>
<a href="#l21.82"></a><span id="l21.82" class="difflineminus">-  if (existingAccountManager) {</span>
<a href="#l21.83"></a><span id="l21.83" class="difflineminus">-    existingAccountManager.focus();</span>
<a href="#l21.84"></a><span id="l21.84" class="difflineminus">-  } else {</span>
<a href="#l21.85"></a><span id="l21.85" class="difflineminus">-    if (!aServer) {</span>
<a href="#l21.86"></a><span id="l21.86" class="difflineminus">-      if (typeof window.GetSelectedMsgFolders === &quot;function&quot;) {</span>
<a href="#l21.87"></a><span id="l21.87" class="difflineminus">-        let folders = window.GetSelectedMsgFolders();</span>
<a href="#l21.88"></a><span id="l21.88" class="difflineminus">-        if (folders.length &gt; 0) {</span>
<a href="#l21.89"></a><span id="l21.89" class="difflineminus">-          aServer = folders[0].server;</span>
<a href="#l21.90"></a><span id="l21.90" class="difflineminus">-        }</span>
<a href="#l21.91"></a><span id="l21.91" class="difflineplus">+  if (!aServer) {</span>
<a href="#l21.92"></a><span id="l21.92" class="difflineplus">+    if (typeof window.GetSelectedMsgFolders === &quot;function&quot;) {</span>
<a href="#l21.93"></a><span id="l21.93" class="difflineplus">+      let folders = window.GetSelectedMsgFolders();</span>
<a href="#l21.94"></a><span id="l21.94" class="difflineplus">+      if (folders.length &gt; 0) {</span>
<a href="#l21.95"></a><span id="l21.95" class="difflineplus">+        aServer = folders[0].server;</span>
<a href="#l21.96"></a><span id="l21.96">       }</span>
<a href="#l21.97"></a><span id="l21.97" class="difflineminus">-      if (</span>
<a href="#l21.98"></a><span id="l21.98" class="difflineminus">-        !aServer &amp;&amp;</span>
<a href="#l21.99"></a><span id="l21.99" class="difflineminus">-        typeof window.GetDefaultAccountRootFolder === &quot;function&quot;</span>
<a href="#l21.100"></a><span id="l21.100" class="difflineminus">-      ) {</span>
<a href="#l21.101"></a><span id="l21.101" class="difflineminus">-        let folder = window.GetDefaultAccountRootFolder();</span>
<a href="#l21.102"></a><span id="l21.102" class="difflineminus">-        if (folder instanceof Ci.nsIMsgFolder) {</span>
<a href="#l21.103"></a><span id="l21.103" class="difflineminus">-          aServer = folder.server;</span>
<a href="#l21.104"></a><span id="l21.104" class="difflineminus">-        }</span>
<a href="#l21.105"></a><span id="l21.105" class="difflineplus">+    }</span>
<a href="#l21.106"></a><span id="l21.106" class="difflineplus">+    if (!aServer &amp;&amp; typeof window.GetDefaultAccountRootFolder === &quot;function&quot;) {</span>
<a href="#l21.107"></a><span id="l21.107" class="difflineplus">+      let folder = window.GetDefaultAccountRootFolder();</span>
<a href="#l21.108"></a><span id="l21.108" class="difflineplus">+      if (folder instanceof Ci.nsIMsgFolder) {</span>
<a href="#l21.109"></a><span id="l21.109" class="difflineplus">+        aServer = folder.server;</span>
<a href="#l21.110"></a><span id="l21.110">       }</span>
<a href="#l21.111"></a><span id="l21.111">     }</span>
<a href="#l21.112"></a><span id="l21.112" class="difflineminus">-</span>
<a href="#l21.113"></a><span id="l21.113" class="difflineminus">-    window.openDialog(</span>
<a href="#l21.114"></a><span id="l21.114" class="difflineminus">-      &quot;chrome://messenger/content/AccountManager.xhtml&quot;,</span>
<a href="#l21.115"></a><span id="l21.115" class="difflineminus">-      &quot;AccountManager&quot;,</span>
<a href="#l21.116"></a><span id="l21.116" class="difflineminus">-      &quot;chrome,centerscreen,modal,titlebar,resizable&quot;,</span>
<a href="#l21.117"></a><span id="l21.117" class="difflineminus">-      { server: aServer, selectPage }</span>
<a href="#l21.118"></a><span id="l21.118" class="difflineminus">-    );</span>
<a href="#l21.119"></a><span id="l21.119">   }</span>
<a href="#l21.120"></a><span id="l21.120" class="difflineplus">+  let mailWindow = Services.wm.getMostRecentWindow(&quot;mail:3pane&quot;);</span>
<a href="#l21.121"></a><span id="l21.121" class="difflineplus">+  let onLoad = function(event, browser) {</span>
<a href="#l21.122"></a><span id="l21.122" class="difflineplus">+    browser.contentDocument.documentElement.server = aServer;</span>
<a href="#l21.123"></a><span id="l21.123" class="difflineplus">+    browser.contentDocument.documentElement.selectPage = selectPage;</span>
<a href="#l21.124"></a><span id="l21.124" class="difflineplus">+  };</span>
<a href="#l21.125"></a><span id="l21.125" class="difflineplus">+  mailWindow.focus();</span>
<a href="#l21.126"></a><span id="l21.126" class="difflineplus">+  mailWindow.document.getElementById(&quot;tabmail&quot;).openTab(&quot;contentTab&quot;, {</span>
<a href="#l21.127"></a><span id="l21.127" class="difflineplus">+    contentPage: &quot;about:accountsettings&quot;,</span>
<a href="#l21.128"></a><span id="l21.128" class="difflineplus">+    clickHandler: &quot;specialTabs.aboutClickHandler(event);&quot;,</span>
<a href="#l21.129"></a><span id="l21.129" class="difflineplus">+    server: aServer,</span>
<a href="#l21.130"></a><span id="l21.130" class="difflineplus">+    selectPage,</span>
<a href="#l21.131"></a><span id="l21.131" class="difflineplus">+    onLoad,</span>
<a href="#l21.132"></a><span id="l21.132" class="difflineplus">+  });</span>
<a href="#l21.133"></a><span id="l21.133"> }</span>
<a href="#l21.134"></a><span id="l21.134"> </span>
<a href="#l21.135"></a><span id="l21.135"> function loadInboxForNewAccount() {</span>
<a href="#l21.136"></a><span id="l21.136">   // gNewAccountToLoad is set in the final screen of the Account Wizard if a POP account</span>
<a href="#l21.137"></a><span id="l21.137">   // was created, the download messages box is checked, and the wizard was opened from the 3pane</span>
<a href="#l21.138"></a><span id="l21.138">   if (gNewAccountToLoad) {</span>
<a href="#l21.139"></a><span id="l21.139">     var rootMsgFolder = gNewAccountToLoad.incomingServer.rootMsgFolder;</span>
<a href="#l21.140"></a><span id="l21.140">     const kInboxFlag = Ci.nsMsgFolderFlags.Inbox;</span>
<a href="#l21.141"></a><span id="l21.141" class="difflineat">@@ -469,17 +464,17 @@ function NewMailAccountProvisioner(aMsgW</span>
<a href="#l21.142"></a><span id="l21.142">     // modal.</span>
<a href="#l21.143"></a><span id="l21.143">     windowParams = &quot;modal,&quot; + windowParams;</span>
<a href="#l21.144"></a><span id="l21.144">   }</span>
<a href="#l21.145"></a><span id="l21.145"> </span>
<a href="#l21.146"></a><span id="l21.146">   // NOTE: If you're a developer, and you notice that the jQuery code in</span>
<a href="#l21.147"></a><span id="l21.147">   // accountProvisioner.xhtml isn't throwing errors or warnings, that's due</span>
<a href="#l21.148"></a><span id="l21.148">   // to bug 688273.  Just make the window non-modal to get those errors and</span>
<a href="#l21.149"></a><span id="l21.149">   // warnings back, and then clear this comment when bug 688273 is closed.</span>
<a href="#l21.150"></a><span id="l21.150" class="difflineminus">-  window.openDialog(</span>
<a href="#l21.151"></a><span id="l21.151" class="difflineplus">+  window.docShell.rootTreeItem.domWindow.openDialog(</span>
<a href="#l21.152"></a><span id="l21.152">     &quot;chrome://messenger/content/newmailaccount/accountProvisioner.xhtml&quot;,</span>
<a href="#l21.153"></a><span id="l21.153">     &quot;AccountCreation&quot;,</span>
<a href="#l21.154"></a><span id="l21.154">     windowParams,</span>
<a href="#l21.155"></a><span id="l21.155">     args</span>
<a href="#l21.156"></a><span id="l21.156">   );</span>
<a href="#l21.157"></a><span id="l21.157"> }</span>
<a href="#l21.158"></a><span id="l21.158"> </span>
<a href="#l21.159"></a><span id="l21.159"> /**</span>
<a href="#l21.160"></a><span id="l21.160" class="difflineat">@@ -497,16 +492,16 @@ function msgNewMailAccount(msgWindow, ok</span>
<a href="#l21.161"></a><span id="l21.161">     throw new Error(&quot;msgNewMailAccount must be given a msgWindow.&quot;);</span>
<a href="#l21.162"></a><span id="l21.162">   }</span>
<a href="#l21.163"></a><span id="l21.163"> </span>
<a href="#l21.164"></a><span id="l21.164">   let existingWindow = Services.wm.getMostRecentWindow(&quot;mail:autoconfig&quot;);</span>
<a href="#l21.165"></a><span id="l21.165">   if (existingWindow) {</span>
<a href="#l21.166"></a><span id="l21.166">     existingWindow.focus();</span>
<a href="#l21.167"></a><span id="l21.167">   } else if (AppConstants.MOZ_APP_NAME == &quot;thunderbird&quot;) {</span>
<a href="#l21.168"></a><span id="l21.168">     // disabling modal for the time being, see 688273 REMOVEME</span>
<a href="#l21.169"></a><span id="l21.169" class="difflineminus">-    window.openDialog(</span>
<a href="#l21.170"></a><span id="l21.170" class="difflineplus">+    window.docShell.rootTreeItem.domWindow.openDialog(</span>
<a href="#l21.171"></a><span id="l21.171">       &quot;chrome://messenger/content/accountcreation/emailWizard.xhtml&quot;,</span>
<a href="#l21.172"></a><span id="l21.172">       &quot;AccountSetup&quot;,</span>
<a href="#l21.173"></a><span id="l21.173">       &quot;chrome,titlebar,centerscreen,resizable&quot;,</span>
<a href="#l21.174"></a><span id="l21.174">       { msgWindow, okCallback, extraData }</span>
<a href="#l21.175"></a><span id="l21.175">     );</span>
<a href="#l21.176"></a><span id="l21.176">   }</span>
<a href="#l21.177"></a><span id="l21.177"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mailnews/base/prefs/content/am-addressing.js</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mailnews/base/prefs/content/am-addressing.js</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -17,17 +17,17 @@ function onInit(aPageId, aServerId) {</span>
<a href="#l22.4"></a><span id="l22.4"> }</span>
<a href="#l22.5"></a><span id="l22.5"> </span>
<a href="#l22.6"></a><span id="l22.6"> function onInitCompositionAndAddressing() {</span>
<a href="#l22.7"></a><span id="l22.7">   LDAPenabling();</span>
<a href="#l22.8"></a><span id="l22.8">   quoteEnabling();</span>
<a href="#l22.9"></a><span id="l22.9"> }</span>
<a href="#l22.10"></a><span id="l22.10"> </span>
<a href="#l22.11"></a><span id="l22.11"> function onEditDirectories() {</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-  window.openDialog(</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineplus">+  window.docShell.rootTreeItem.domWindow.openDialog(</span>
<a href="#l22.14"></a><span id="l22.14">     &quot;chrome://messenger/content/addressbook/pref-editdirectories.xhtml&quot;,</span>
<a href="#l22.15"></a><span id="l22.15">     &quot;editDirectories&quot;,</span>
<a href="#l22.16"></a><span id="l22.16">     &quot;chrome,modal=yes,resizable=no&quot;,</span>
<a href="#l22.17"></a><span id="l22.17">     null</span>
<a href="#l22.18"></a><span id="l22.18">   );</span>
<a href="#l22.19"></a><span id="l22.19"> }</span>
<a href="#l22.20"></a><span id="l22.20"> </span>
<a href="#l22.21"></a><span id="l22.21"> function onPreInit(account, accountValues) {}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mailnews/base/prefs/content/am-archiveoptions.js</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mailnews/base/prefs/content/am-archiveoptions.js</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -31,16 +31,17 @@ function onLoadArchiveOptions() {</span>
<a href="#l23.4"></a><span id="l23.4">  */</span>
<a href="#l23.5"></a><span id="l23.5"> function onAcceptArchiveOptions() {</span>
<a href="#l23.6"></a><span id="l23.6">   gIdentity.archiveGranularity = document.getElementById(</span>
<a href="#l23.7"></a><span id="l23.7">     &quot;archiveGranularity&quot;</span>
<a href="#l23.8"></a><span id="l23.8">   ).selectedIndex;</span>
<a href="#l23.9"></a><span id="l23.9">   gIdentity.archiveKeepFolderStructure = document.getElementById(</span>
<a href="#l23.10"></a><span id="l23.10">     &quot;archiveKeepFolderStructure&quot;</span>
<a href="#l23.11"></a><span id="l23.11">   ).checked;</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineplus">+  window.dispatchEvent(new CustomEvent(&quot;prefchange&quot;));</span>
<a href="#l23.13"></a><span id="l23.13"> }</span>
<a href="#l23.14"></a><span id="l23.14"> </span>
<a href="#l23.15"></a><span id="l23.15"> /**</span>
<a href="#l23.16"></a><span id="l23.16">  * Update the example tree to show what the current options would look like.</span>
<a href="#l23.17"></a><span id="l23.17">  */</span>
<a href="#l23.18"></a><span id="l23.18"> function updateArchiveExample() {</span>
<a href="#l23.19"></a><span id="l23.19">   let granularity = document.getElementById(&quot;archiveGranularity&quot;).selectedIndex;</span>
<a href="#l23.20"></a><span id="l23.20">   let kfs = document.getElementById(&quot;archiveKeepFolderStructure&quot;).checked;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mailnews/base/prefs/content/am-copies.js</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mailnews/base/prefs/content/am-copies.js</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -526,16 +526,16 @@ function setupArchiveItems() {</span>
<a href="#l24.4"></a><span id="l24.4"> }</span>
<a href="#l24.5"></a><span id="l24.5"> </span>
<a href="#l24.6"></a><span id="l24.6"> /**</span>
<a href="#l24.7"></a><span id="l24.7">  * Open a dialog to edit the folder hierarchy used when archiving messages.</span>
<a href="#l24.8"></a><span id="l24.8">  */</span>
<a href="#l24.9"></a><span id="l24.9"> function ChangeArchiveHierarchy() {</span>
<a href="#l24.10"></a><span id="l24.10">   let identity = parent.gIdentity || parent.getCurrentAccount().defaultIdentity;</span>
<a href="#l24.11"></a><span id="l24.11"> </span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-  top.window.openDialog(</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineplus">+  window.docShell.rootTreeItem.domWindow.window.openDialog(</span>
<a href="#l24.14"></a><span id="l24.14">     &quot;chrome://messenger/content/am-archiveoptions.xhtml&quot;,</span>
<a href="#l24.15"></a><span id="l24.15">     &quot;&quot;,</span>
<a href="#l24.16"></a><span id="l24.16">     &quot;centerscreen,chrome,modal,titlebar,resizable=yes&quot;,</span>
<a href="#l24.17"></a><span id="l24.17">     identity</span>
<a href="#l24.18"></a><span id="l24.18">   );</span>
<a href="#l24.19"></a><span id="l24.19">   return true;</span>
<a href="#l24.20"></a><span id="l24.20"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/mailnews/base/prefs/content/am-identities-list.js</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/mailnews/base/prefs/content/am-identities-list.js</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -81,17 +81,17 @@ function refreshIdentityList(aSelectInde</span>
<a href="#l25.4"></a><span id="l25.4">  */</span>
<a href="#l25.5"></a><span id="l25.5"> function openIdentityEditor(identity) {</span>
<a href="#l25.6"></a><span id="l25.6">   let args = { identity, account: gAccount, result: false };</span>
<a href="#l25.7"></a><span id="l25.7"> </span>
<a href="#l25.8"></a><span id="l25.8">   let indexToSelect = identity</span>
<a href="#l25.9"></a><span id="l25.9">     ? gIdentityListBox.selectedIndex</span>
<a href="#l25.10"></a><span id="l25.10">     : gIdentityListBox.itemCount;</span>
<a href="#l25.11"></a><span id="l25.11"> </span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-  window.openDialog(</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineplus">+  window.docShell.rootTreeItem.domWindow.openDialog(</span>
<a href="#l25.14"></a><span id="l25.14">     &quot;am-identity-edit.xhtml&quot;,</span>
<a href="#l25.15"></a><span id="l25.15">     &quot;&quot;,</span>
<a href="#l25.16"></a><span id="l25.16">     &quot;chrome,modal,resizable,centerscreen&quot;,</span>
<a href="#l25.17"></a><span id="l25.17">     args</span>
<a href="#l25.18"></a><span id="l25.18">   );</span>
<a href="#l25.19"></a><span id="l25.19"> </span>
<a href="#l25.20"></a><span id="l25.20">   if (args.result) {</span>
<a href="#l25.21"></a><span id="l25.21">     refreshIdentityList(indexToSelect);</span>
<a href="#l25.22"></a><span id="l25.22" class="difflineat">@@ -206,9 +206,10 @@ function onDelete(event) {</span>
<a href="#l25.23"></a><span id="l25.23"> </span>
<a href="#l25.24"></a><span id="l25.24">   gAccount.removeIdentity(selectedIdentity);</span>
<a href="#l25.25"></a><span id="l25.25"> </span>
<a href="#l25.26"></a><span id="l25.26">   refreshIdentityList(selectedItemIndex);</span>
<a href="#l25.27"></a><span id="l25.27"> }</span>
<a href="#l25.28"></a><span id="l25.28"> </span>
<a href="#l25.29"></a><span id="l25.29"> function onOk() {</span>
<a href="#l25.30"></a><span id="l25.30">   window.arguments[0].result = true;</span>
<a href="#l25.31"></a><span id="l25.31" class="difflineplus">+  window.dispatchEvent(new CustomEvent(&quot;prefchange&quot;));</span>
<a href="#l25.32"></a><span id="l25.32"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/mailnews/base/prefs/content/am-identity-edit.js</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/mailnews/base/prefs/content/am-identity-edit.js</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -17,27 +17,16 @@ var gAccount = null; // the account the </span>
<a href="#l26.4"></a><span id="l26.4"> document.addEventListener(&quot;dialogaccept&quot;, onOk);</span>
<a href="#l26.5"></a><span id="l26.5"> </span>
<a href="#l26.6"></a><span id="l26.6"> function onLoadIdentityProperties() {</span>
<a href="#l26.7"></a><span id="l26.7">   // extract the account</span>
<a href="#l26.8"></a><span id="l26.8">   gIdentity = window.arguments[0].identity;</span>
<a href="#l26.9"></a><span id="l26.9">   gAccount = window.arguments[0].account;</span>
<a href="#l26.10"></a><span id="l26.10">   let prefBundle = document.getElementById(&quot;bundle_prefs&quot;);</span>
<a href="#l26.11"></a><span id="l26.11"> </span>
<a href="#l26.12"></a><span id="l26.12" class="difflineminus">-  // Make the dialog the same height and 90% of the width of the main Account</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineminus">-  // manager page when the Account manager is not maximized.</span>
<a href="#l26.14"></a><span id="l26.14" class="difflineminus">-  let accountDialog = Services.wm.getMostRecentWindow(&quot;mailnews:accountmanager&quot;)</span>
<a href="#l26.15"></a><span id="l26.15" class="difflineminus">-    .document;</span>
<a href="#l26.16"></a><span id="l26.16" class="difflineminus">-  if (accountDialog.documentElement.getAttribute(&quot;sizemode&quot;) != &quot;maximized&quot;) {</span>
<a href="#l26.17"></a><span id="l26.17" class="difflineminus">-    document.getElementById(&quot;identityDialog&quot;).style.width =</span>
<a href="#l26.18"></a><span id="l26.18" class="difflineminus">-      accountDialog.getElementById(&quot;accountManager&quot;).clientWidth * 0.9 + &quot;px&quot;;</span>
<a href="#l26.19"></a><span id="l26.19" class="difflineminus">-    document.getElementById(&quot;identityDialog&quot;).style.height =</span>
<a href="#l26.20"></a><span id="l26.20" class="difflineminus">-      accountDialog.getElementById(&quot;accountManager&quot;).clientHeight + &quot;px&quot;;</span>
<a href="#l26.21"></a><span id="l26.21" class="difflineminus">-  }</span>
<a href="#l26.22"></a><span id="l26.22" class="difflineminus">-</span>
<a href="#l26.23"></a><span id="l26.23">   if (gIdentity) {</span>
<a href="#l26.24"></a><span id="l26.24">     let listName = gIdentity.identityName;</span>
<a href="#l26.25"></a><span id="l26.25">     document.title = prefBundle.getFormattedString(&quot;identityDialogTitleEdit&quot;, [</span>
<a href="#l26.26"></a><span id="l26.26">       listName,</span>
<a href="#l26.27"></a><span id="l26.27">     ]);</span>
<a href="#l26.28"></a><span id="l26.28">   } else {</span>
<a href="#l26.29"></a><span id="l26.29">     document.title = prefBundle.getString(&quot;identityDialogTitleAdd&quot;);</span>
<a href="#l26.30"></a><span id="l26.30">   }</span>
<a href="#l26.31"></a><span id="l26.31" class="difflineat">@@ -207,16 +196,17 @@ function onOk(event) {</span>
<a href="#l26.32"></a><span id="l26.32">   }</span>
<a href="#l26.33"></a><span id="l26.33"> </span>
<a href="#l26.34"></a><span id="l26.34">   // if we are modifying an existing identity, save the fields</span>
<a href="#l26.35"></a><span id="l26.35">   saveIdentitySettings(gIdentity);</span>
<a href="#l26.36"></a><span id="l26.36">   saveCopiesAndFolderSettings(gIdentity);</span>
<a href="#l26.37"></a><span id="l26.37">   saveAddressingAndCompositionSettings(gIdentity);</span>
<a href="#l26.38"></a><span id="l26.38"> </span>
<a href="#l26.39"></a><span id="l26.39">   window.arguments[0].result = true;</span>
<a href="#l26.40"></a><span id="l26.40" class="difflineplus">+  window.dispatchEvent(new CustomEvent(&quot;prefchange&quot;));</span>
<a href="#l26.41"></a><span id="l26.41"> }</span>
<a href="#l26.42"></a><span id="l26.42"> </span>
<a href="#l26.43"></a><span id="l26.43"> // returns false and prompts the user if</span>
<a href="#l26.44"></a><span id="l26.44"> // the identity does not have an email address</span>
<a href="#l26.45"></a><span id="l26.45"> function validEmailAddress() {</span>
<a href="#l26.46"></a><span id="l26.46">   var emailAddress = document.getElementById(&quot;identity.email&quot;).value;</span>
<a href="#l26.47"></a><span id="l26.47"> </span>
<a href="#l26.48"></a><span id="l26.48">   // quickly test for an @ sign to test for an email address. We don't have</span>
<a href="#l26.49"></a><span id="l26.49" class="difflineat">@@ -437,17 +427,17 @@ function editVCardCallback(escapedVCardS</span>
<a href="#l26.50"></a><span id="l26.50">   var escapedVCard = document.getElementById(&quot;identity.escapedVCard&quot;);</span>
<a href="#l26.51"></a><span id="l26.51">   escapedVCard.value = escapedVCardStr;</span>
<a href="#l26.52"></a><span id="l26.52"> }</span>
<a href="#l26.53"></a><span id="l26.53"> </span>
<a href="#l26.54"></a><span id="l26.54"> function editVCard() {</span>
<a href="#l26.55"></a><span id="l26.55">   var escapedVCard = document.getElementById(&quot;identity.escapedVCard&quot;);</span>
<a href="#l26.56"></a><span id="l26.56"> </span>
<a href="#l26.57"></a><span id="l26.57">   // read vCard hidden value from UI</span>
<a href="#l26.58"></a><span id="l26.58" class="difflineminus">-  window.openDialog(</span>
<a href="#l26.59"></a><span id="l26.59" class="difflineplus">+  window.docShell.rootTreeItem.domWindow.openDialog(</span>
<a href="#l26.60"></a><span id="l26.60">     &quot;chrome://messenger/content/addressbook/abNewCardDialog.xhtml&quot;,</span>
<a href="#l26.61"></a><span id="l26.61">     &quot;&quot;,</span>
<a href="#l26.62"></a><span id="l26.62">     &quot;chrome,modal,resizable=no,centerscreen&quot;,</span>
<a href="#l26.63"></a><span id="l26.63">     {</span>
<a href="#l26.64"></a><span id="l26.64">       escapedVCardStr: escapedVCard.value,</span>
<a href="#l26.65"></a><span id="l26.65">       okCallback: editVCardCallback,</span>
<a href="#l26.66"></a><span id="l26.66">       titleProperty: &quot;editVCardTitle&quot;,</span>
<a href="#l26.67"></a><span id="l26.67">       hideABPicker: true,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/mailnews/base/prefs/content/am-main.js</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/mailnews/base/prefs/content/am-main.js</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -43,17 +43,17 @@ function manageIdentities() {</span>
<a href="#l27.4"></a><span id="l27.4"> </span>
<a href="#l27.5"></a><span id="l27.5">   var args = { account: gAccount, accountName, result: false };</span>
<a href="#l27.6"></a><span id="l27.6"> </span>
<a href="#l27.7"></a><span id="l27.7">   // save the current identity settings so they show up correctly</span>
<a href="#l27.8"></a><span id="l27.8">   // if the user just changed them in the manage identities dialog</span>
<a href="#l27.9"></a><span id="l27.9">   var identity = gAccount.defaultIdentity;</span>
<a href="#l27.10"></a><span id="l27.10">   saveIdentitySettings(identity);</span>
<a href="#l27.11"></a><span id="l27.11"> </span>
<a href="#l27.12"></a><span id="l27.12" class="difflineminus">-  window.openDialog(</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineplus">+  window.docShell.rootTreeItem.domWindow.openDialog(</span>
<a href="#l27.14"></a><span id="l27.14">     &quot;am-identities-list.xhtml&quot;,</span>
<a href="#l27.15"></a><span id="l27.15">     &quot;&quot;,</span>
<a href="#l27.16"></a><span id="l27.16">     &quot;chrome,modal,resizable=no,centerscreen&quot;,</span>
<a href="#l27.17"></a><span id="l27.17">     args</span>
<a href="#l27.18"></a><span id="l27.18">   );</span>
<a href="#l27.19"></a><span id="l27.19"> </span>
<a href="#l27.20"></a><span id="l27.20">   if (args.result) {</span>
<a href="#l27.21"></a><span id="l27.21">     // now re-initialize the default identity settings in case they changed</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/mailnews/base/prefs/content/am-offline.js</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/mailnews/base/prefs/content/am-offline.js</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -170,17 +170,17 @@ function onPreInit(account, accountValue</span>
<a href="#l28.4"></a><span id="l28.4">         &quot;retention.applyToFlagged&quot;</span>
<a href="#l28.5"></a><span id="l28.5">       );</span>
<a href="#l28.6"></a><span id="l28.6">       applyToFlaggedCheckbox.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l28.7"></a><span id="l28.7">     }</span>
<a href="#l28.8"></a><span id="l28.8">   }</span>
<a href="#l28.9"></a><span id="l28.9"> }</span>
<a href="#l28.10"></a><span id="l28.10"> </span>
<a href="#l28.11"></a><span id="l28.11"> function onClickSelect() {</span>
<a href="#l28.12"></a><span id="l28.12" class="difflineminus">-  top.window.openDialog(</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineplus">+  window.docShell.rootTreeItem.domWindow.window.openDialog(</span>
<a href="#l28.14"></a><span id="l28.14">     &quot;chrome://messenger/content/msgSelectOfflineFolders.xhtml&quot;,</span>
<a href="#l28.15"></a><span id="l28.15">     &quot;&quot;,</span>
<a href="#l28.16"></a><span id="l28.16">     &quot;centerscreen,chrome,modal,titlebar,resizable=yes&quot;</span>
<a href="#l28.17"></a><span id="l28.17">   );</span>
<a href="#l28.18"></a><span id="l28.18">   return true;</span>
<a href="#l28.19"></a><span id="l28.19"> }</span>
<a href="#l28.20"></a><span id="l28.20"> </span>
<a href="#l28.21"></a><span id="l28.21"> /**</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/mailnews/base/prefs/content/am-server-advanced.js</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/mailnews/base/prefs/content/am-server-advanced.js</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -137,16 +137,17 @@ function onOk(event) {</span>
<a href="#l29.4"></a><span id="l29.4">     if (slot in gServerSettings) {</span>
<a href="#l29.5"></a><span id="l29.5">       if (controls[i].localName == &quot;checkbox&quot;) {</span>
<a href="#l29.6"></a><span id="l29.6">         gServerSettings[slot] = controls[i].checked;</span>
<a href="#l29.7"></a><span id="l29.7">       } else {</span>
<a href="#l29.8"></a><span id="l29.8">         gServerSettings[slot] = controls[i].value;</span>
<a href="#l29.9"></a><span id="l29.9">       }</span>
<a href="#l29.10"></a><span id="l29.10">     }</span>
<a href="#l29.11"></a><span id="l29.11">   }</span>
<a href="#l29.12"></a><span id="l29.12" class="difflineplus">+  window.dispatchEvent(new CustomEvent(&quot;prefchange&quot;));</span>
<a href="#l29.13"></a><span id="l29.13"> }</span>
<a href="#l29.14"></a><span id="l29.14"> </span>
<a href="#l29.15"></a><span id="l29.15"> // Set radio element choices and picker states</span>
<a href="#l29.16"></a><span id="l29.16"> function updateInboxAccount(enablePicker) {</span>
<a href="#l29.17"></a><span id="l29.17">   document.getElementById(</span>
<a href="#l29.18"></a><span id="l29.18">     &quot;deferredServerFolderPicker&quot;</span>
<a href="#l29.19"></a><span id="l29.19">   ).disabled = !enablePicker;</span>
<a href="#l29.20"></a><span id="l29.20">   document.getElementById(&quot;deferGetNewMail&quot;).disabled = !enablePicker;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1" class="difflineminus">--- a/mailnews/base/prefs/content/am-server.js</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineplus">+++ b/mailnews/base/prefs/content/am-server.js</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineat">@@ -27,17 +27,17 @@ function clickStoreTypeMenu(aStoreTypeEl</span>
<a href="#l30.4"></a><span id="l30.4">     return;</span>
<a href="#l30.5"></a><span id="l30.5">   }</span>
<a href="#l30.6"></a><span id="l30.6"> </span>
<a href="#l30.7"></a><span id="l30.7">   // Response from migration dialog modal. If the conversion is complete</span>
<a href="#l30.8"></a><span id="l30.8">   // 'response.newRootFolder' will hold the path to the new account root folder,</span>
<a href="#l30.9"></a><span id="l30.9">   // otherwise 'response.newRootFolder' will be null.</span>
<a href="#l30.10"></a><span id="l30.10">   let response = { newRootFolder: null };</span>
<a href="#l30.11"></a><span id="l30.11">   // Send 'response' as an argument to converterDialog.xhtml.</span>
<a href="#l30.12"></a><span id="l30.12" class="difflineminus">-  window.openDialog(</span>
<a href="#l30.13"></a><span id="l30.13" class="difflineplus">+  window.docShell.rootTreeItem.domWindow.openDialog(</span>
<a href="#l30.14"></a><span id="l30.14">     &quot;converterDialog.xhtml&quot;,</span>
<a href="#l30.15"></a><span id="l30.15">     &quot;mailnews:mailstoreconverter&quot;,</span>
<a href="#l30.16"></a><span id="l30.16">     &quot;modal,centerscreen,resizable=no,width=700,height=130&quot;,</span>
<a href="#l30.17"></a><span id="l30.17">     gServer,</span>
<a href="#l30.18"></a><span id="l30.18">     aStoreTypeElement.value,</span>
<a href="#l30.19"></a><span id="l30.19">     response</span>
<a href="#l30.20"></a><span id="l30.20">   );</span>
<a href="#l30.21"></a><span id="l30.21">   changeStoreType(response);</span>
<a href="#l30.22"></a><span id="l30.22" class="difflineat">@@ -249,17 +249,17 @@ function onAdvanced() {</span>
<a href="#l30.23"></a><span id="l30.23">     serverSettings.deferGetNewMail = document.getElementById(</span>
<a href="#l30.24"></a><span id="l30.24">       &quot;pop3.deferGetNewMail&quot;</span>
<a href="#l30.25"></a><span id="l30.25">     ).checked;</span>
<a href="#l30.26"></a><span id="l30.26">     serverSettings.deferredToAccount = document</span>
<a href="#l30.27"></a><span id="l30.27">       .getElementById(&quot;pop3.deferredToAccount&quot;)</span>
<a href="#l30.28"></a><span id="l30.28">       .getAttribute(&quot;value&quot;);</span>
<a href="#l30.29"></a><span id="l30.29">   }</span>
<a href="#l30.30"></a><span id="l30.30"> </span>
<a href="#l30.31"></a><span id="l30.31" class="difflineminus">-  window.openDialog(</span>
<a href="#l30.32"></a><span id="l30.32" class="difflineplus">+  window.docShell.rootTreeItem.domWindow.openDialog(</span>
<a href="#l30.33"></a><span id="l30.33">     &quot;chrome://messenger/content/am-server-advanced.xhtml&quot;,</span>
<a href="#l30.34"></a><span id="l30.34">     &quot;_blank&quot;,</span>
<a href="#l30.35"></a><span id="l30.35">     &quot;chrome,modal,titlebar&quot;,</span>
<a href="#l30.36"></a><span id="l30.36">     serverSettings</span>
<a href="#l30.37"></a><span id="l30.37">   );</span>
<a href="#l30.38"></a><span id="l30.38"> </span>
<a href="#l30.39"></a><span id="l30.39">   if (serverType == &quot;imap&quot;) {</span>
<a href="#l30.40"></a><span id="l30.40">     document.getElementById(&quot;imap.dualUseFolders&quot;).checked =</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1" class="difflineminus">--- a/mailnews/base/prefs/content/am-serverwithnoidentities.js</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineplus">+++ b/mailnews/base/prefs/content/am-serverwithnoidentities.js</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineat">@@ -20,17 +20,17 @@ function clickStoreTypeMenu(aStoreTypeEl</span>
<a href="#l31.4"></a><span id="l31.4">     return;</span>
<a href="#l31.5"></a><span id="l31.5">   }</span>
<a href="#l31.6"></a><span id="l31.6"> </span>
<a href="#l31.7"></a><span id="l31.7">   // Response from migration dialog modal. If the conversion is complete</span>
<a href="#l31.8"></a><span id="l31.8">   // 'response.newRootFolder' will hold the path to the new account root folder,</span>
<a href="#l31.9"></a><span id="l31.9">   // otherwise 'response.newRootFolder' will be null.</span>
<a href="#l31.10"></a><span id="l31.10">   let response = { newRootFolder: null };</span>
<a href="#l31.11"></a><span id="l31.11">   // Send 'response' as an argument to converterDialog.xhtml.</span>
<a href="#l31.12"></a><span id="l31.12" class="difflineminus">-  window.openDialog(</span>
<a href="#l31.13"></a><span id="l31.13" class="difflineplus">+  window.docShell.rootTreeItem.domWindow.openDialog(</span>
<a href="#l31.14"></a><span id="l31.14">     &quot;converterDialog.xhtml&quot;,</span>
<a href="#l31.15"></a><span id="l31.15">     &quot;mailnews:mailstoreconverter&quot;,</span>
<a href="#l31.16"></a><span id="l31.16">     &quot;modal,centerscreen,resizable=no,width=700,height=130&quot;,</span>
<a href="#l31.17"></a><span id="l31.17">     gAccount.incomingServer,</span>
<a href="#l31.18"></a><span id="l31.18">     aStoreTypeElement.value,</span>
<a href="#l31.19"></a><span id="l31.19">     response</span>
<a href="#l31.20"></a><span id="l31.20">   );</span>
<a href="#l31.21"></a><span id="l31.21">   changeStoreType(response);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1" class="difflineminus">--- a/mailnews/base/prefs/content/am-smtp.js</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineplus">+++ b/mailnews/base/prefs/content/am-smtp.js</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineat">@@ -173,23 +173,26 @@ var gSmtpServerListWindow = {</span>
<a href="#l32.4"></a><span id="l32.4">       default:</span>
<a href="#l32.5"></a><span id="l32.5">         // leave empty</span>
<a href="#l32.6"></a><span id="l32.6">         Cu.reportError(</span>
<a href="#l32.7"></a><span id="l32.7">           &quot;Warning: unknown value for smtpserver... authMethod: &quot; +</span>
<a href="#l32.8"></a><span id="l32.8">             aServer.authMethod</span>
<a href="#l32.9"></a><span id="l32.9">         );</span>
<a href="#l32.10"></a><span id="l32.10">     }</span>
<a href="#l32.11"></a><span id="l32.11">     if (authStr) {</span>
<a href="#l32.12"></a><span id="l32.12" class="difflineminus">-      let details = OAuth2Providers.getHostnameDetails(aServer.hostname);</span>
<a href="#l32.13"></a><span id="l32.13" class="difflineminus">-      if (!details) {</span>
<a href="#l32.14"></a><span id="l32.14" class="difflineminus">-        document</span>
<a href="#l32.15"></a><span id="l32.15" class="difflineminus">-          .getElementById(&quot;authMethod-oauth2&quot;)</span>
<a href="#l32.16"></a><span id="l32.16" class="difflineminus">-          .toggleAttribute(&quot;disabled&quot;, true);</span>
<a href="#l32.17"></a><span id="l32.17" class="difflineminus">-      }</span>
<a href="#l32.18"></a><span id="l32.18" class="difflineminus">-</span>
<a href="#l32.19"></a><span id="l32.19" class="difflineplus">+      // This is causing a mochitest failure. Mochitest will not move</span>
<a href="#l32.20"></a><span id="l32.20" class="difflineplus">+      // ahead and it will get stuck. We don't have any element with id</span>
<a href="#l32.21"></a><span id="l32.21" class="difflineplus">+      // &quot;authMethod-oauth2&quot; so this needs inspection.</span>
<a href="#l32.22"></a><span id="l32.22" class="difflineplus">+      //</span>
<a href="#l32.23"></a><span id="l32.23" class="difflineplus">+      // let details = OAuth2Providers.getHostnameDetails(aServer.hostname);</span>
<a href="#l32.24"></a><span id="l32.24" class="difflineplus">+      // if (!details) {</span>
<a href="#l32.25"></a><span id="l32.25" class="difflineplus">+      //   document</span>
<a href="#l32.26"></a><span id="l32.26" class="difflineplus">+      //     .getElementById(&quot;authMethod-oauth2&quot;)</span>
<a href="#l32.27"></a><span id="l32.27" class="difflineplus">+      //     .toggleAttribute(&quot;disabled&quot;, true);</span>
<a href="#l32.28"></a><span id="l32.28" class="difflineplus">+      // }</span>
<a href="#l32.29"></a><span id="l32.29">       document.getElementById(&quot;authMethodValue&quot;).value = this.mBundle.getString(</span>
<a href="#l32.30"></a><span id="l32.30">         authStr</span>
<a href="#l32.31"></a><span id="l32.31">       );</span>
<a href="#l32.32"></a><span id="l32.32">     }</span>
<a href="#l32.33"></a><span id="l32.33">   },</span>
<a href="#l32.34"></a><span id="l32.34"> </span>
<a href="#l32.35"></a><span id="l32.35">   refreshServerList(aServerKeyToSelect, aFocusList) {</span>
<a href="#l32.36"></a><span id="l32.36">     // remove all children</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1" class="difflineminus">--- a/mailnews/base/prefs/content/amUtils.js</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineplus">+++ b/mailnews/base/prefs/content/amUtils.js</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineat">@@ -253,17 +253,17 @@ function accountNameExists(aAccountName,</span>
<a href="#l33.4"></a><span id="l33.4">  *</span>
<a href="#l33.5"></a><span id="l33.5">  * @param aServer {nsISmtpServer}  The server to edit.</span>
<a href="#l33.6"></a><span id="l33.6">  * @return {object}                Object with result member to indicate whether 'OK'</span>
<a href="#l33.7"></a><span id="l33.7">  *                                 was clicked and addSmtpServer with key of newly created server.</span>
<a href="#l33.8"></a><span id="l33.8">  */</span>
<a href="#l33.9"></a><span id="l33.9"> function editSMTPServer(aServer) {</span>
<a href="#l33.10"></a><span id="l33.10">   let args = { server: aServer, result: false, addSmtpServer: &quot;&quot; };</span>
<a href="#l33.11"></a><span id="l33.11"> </span>
<a href="#l33.12"></a><span id="l33.12" class="difflineminus">-  window.openDialog(</span>
<a href="#l33.13"></a><span id="l33.13" class="difflineplus">+  window.docShell.rootTreeItem.domWindow.openDialog(</span>
<a href="#l33.14"></a><span id="l33.14">     &quot;chrome://messenger/content/SmtpServerEdit.xhtml&quot;,</span>
<a href="#l33.15"></a><span id="l33.15">     &quot;smtpEdit&quot;,</span>
<a href="#l33.16"></a><span id="l33.16">     &quot;chrome,titlebar,modal,centerscreen&quot;,</span>
<a href="#l33.17"></a><span id="l33.17">     args</span>
<a href="#l33.18"></a><span id="l33.18">   );</span>
<a href="#l33.19"></a><span id="l33.19"> </span>
<a href="#l33.20"></a><span id="l33.20">   return args;</span>
<a href="#l33.21"></a><span id="l33.21"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1" class="difflineminus">--- a/mailnews/extensions/newsblog/content/newsblogOverlay.js</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineplus">+++ b/mailnews/extensions/newsblog/content/newsblogOverlay.js</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineat">@@ -295,17 +295,17 @@ function openSubscriptionsDialog(aFolder</span>
<a href="#l34.4"></a><span id="l34.4">       subscriptionsWindow.FeedSubscriptions.selectFolder(aFolder);</span>
<a href="#l34.5"></a><span id="l34.5">       subscriptionsWindow.FeedSubscriptions.mView.tree.ensureRowIsVisible(</span>
<a href="#l34.6"></a><span id="l34.6">         subscriptionsWindow.FeedSubscriptions.mView.selection.currentIndex</span>
<a href="#l34.7"></a><span id="l34.7">       );</span>
<a href="#l34.8"></a><span id="l34.8">     }</span>
<a href="#l34.9"></a><span id="l34.9"> </span>
<a href="#l34.10"></a><span id="l34.10">     subscriptionsWindow.focus();</span>
<a href="#l34.11"></a><span id="l34.11">   } else {</span>
<a href="#l34.12"></a><span id="l34.12" class="difflineminus">-    window.openDialog(</span>
<a href="#l34.13"></a><span id="l34.13" class="difflineplus">+    window.docShell.rootTreeItem.domWindow.openDialog(</span>
<a href="#l34.14"></a><span id="l34.14">       &quot;chrome://messenger-newsblog/content/feed-subscriptions.xhtml&quot;,</span>
<a href="#l34.15"></a><span id="l34.15">       &quot;&quot;,</span>
<a href="#l34.16"></a><span id="l34.16">       &quot;centerscreen,chrome,dialog=no,resizable&quot;,</span>
<a href="#l34.17"></a><span id="l34.17">       { folder: aFolder }</span>
<a href="#l34.18"></a><span id="l34.18">     );</span>
<a href="#l34.19"></a><span id="l34.19">   }</span>
<a href="#l34.20"></a><span id="l34.20"> }</span>
<a href="#l34.21"></a><span id="l34.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l35.1"></a><span id="l35.1" class="difflineminus">--- a/mailnews/extensions/smime/content/am-smime.js</span>
<a href="#l35.2"></a><span id="l35.2" class="difflineplus">+++ b/mailnews/extensions/smime/content/am-smime.js</span>
<a href="#l35.3"></a><span id="l35.3" class="difflineat">@@ -489,37 +489,38 @@ function smimeClearCert(smime_cert) {</span>
<a href="#l35.4"></a><span id="l35.4"> </span>
<a href="#l35.5"></a><span id="l35.5"> function openCertManager() {</span>
<a href="#l35.6"></a><span id="l35.6">   // Check for an existing certManager window and focus it; it's not</span>
<a href="#l35.7"></a><span id="l35.7">   // application modal.</span>
<a href="#l35.8"></a><span id="l35.8">   let lastCertManager = Services.wm.getMostRecentWindow(&quot;mozilla:certmanager&quot;);</span>
<a href="#l35.9"></a><span id="l35.9">   if (lastCertManager) {</span>
<a href="#l35.10"></a><span id="l35.10">     lastCertManager.focus();</span>
<a href="#l35.11"></a><span id="l35.11">   } else {</span>
<a href="#l35.12"></a><span id="l35.12" class="difflineminus">-    window.openDialog(</span>
<a href="#l35.13"></a><span id="l35.13" class="difflineplus">+    window.docShell.rootTreeItem.domWindow.openDialog(</span>
<a href="#l35.14"></a><span id="l35.14">       &quot;chrome://pippki/content/certManager.xhtml&quot;,</span>
<a href="#l35.15"></a><span id="l35.15">       &quot;&quot;,</span>
<a href="#l35.16"></a><span id="l35.16">       &quot;centerscreen,resizable=yes,dialog=no&quot;</span>
<a href="#l35.17"></a><span id="l35.17">     );</span>
<a href="#l35.18"></a><span id="l35.18">   }</span>
<a href="#l35.19"></a><span id="l35.19"> }</span>
<a href="#l35.20"></a><span id="l35.20"> </span>
<a href="#l35.21"></a><span id="l35.21"> function openDeviceManager() {</span>
<a href="#l35.22"></a><span id="l35.22">   // Check for an existing deviceManager window and focus it; it's not</span>
<a href="#l35.23"></a><span id="l35.23">   // application modal.</span>
<a href="#l35.24"></a><span id="l35.24">   let lastCertManager = Services.wm.getMostRecentWindow(</span>
<a href="#l35.25"></a><span id="l35.25">     &quot;mozilla:devicemanager&quot;</span>
<a href="#l35.26"></a><span id="l35.26">   );</span>
<a href="#l35.27"></a><span id="l35.27">   if (lastCertManager) {</span>
<a href="#l35.28"></a><span id="l35.28">     lastCertManager.focus();</span>
<a href="#l35.29"></a><span id="l35.29">   } else {</span>
<a href="#l35.30"></a><span id="l35.30" class="difflineminus">-    window.openDialog(</span>
<a href="#l35.31"></a><span id="l35.31" class="difflineplus">+    window.docShell.rootTreeItem.domWindow.openDialog(</span>
<a href="#l35.32"></a><span id="l35.32">       &quot;chrome://pippki/content/device_manager.xhtml&quot;,</span>
<a href="#l35.33"></a><span id="l35.33">       &quot;&quot;,</span>
<a href="#l35.34"></a><span id="l35.34">       &quot;centerscreen,resizable=yes,dialog=no&quot;</span>
<a href="#l35.35"></a><span id="l35.35">     );</span>
<a href="#l35.36"></a><span id="l35.36">   }</span>
<a href="#l35.37"></a><span id="l35.37"> }</span>
<a href="#l35.38"></a><span id="l35.38"> </span>
<a href="#l35.39"></a><span id="l35.39"> function smimeOnLoadEditor() {</span>
<a href="#l35.40"></a><span id="l35.40">   smimeInitializeFields();</span>
<a href="#l35.41"></a><span id="l35.41">   document.addEventListener(&quot;dialogaccept&quot;, smimeOnAcceptEditor);</span>
<a href="#l35.42"></a><span id="l35.42" class="difflineplus">+  window.dispatchEvent(new CustomEvent(&quot;prefchange&quot;));</span>
<a href="#l35.43"></a><span id="l35.43"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l36.1"></a><span id="l36.1" class="difflineminus">--- a/mailnews/extensions/smime/content/msgReadSMIMEOverlay.js</span>
<a href="#l36.2"></a><span id="l36.2" class="difflineplus">+++ b/mailnews/extensions/smime/content/msgReadSMIMEOverlay.js</span>
<a href="#l36.3"></a><span id="l36.3" class="difflineat">@@ -58,17 +58,17 @@ function showMessageReadSecurityInfo() {</span>
<a href="#l36.4"></a><span id="l36.4">   // Append even if null... the receiver must handle that.</span>
<a href="#l36.5"></a><span id="l36.5">   params.objects.appendElement(gSignerCert);</span>
<a href="#l36.6"></a><span id="l36.6">   params.objects.appendElement(gEncryptionCert);</span>
<a href="#l36.7"></a><span id="l36.7"> </span>
<a href="#l36.8"></a><span id="l36.8">   // int array starts with index 0, but that is used for window exit status</span>
<a href="#l36.9"></a><span id="l36.9">   params.SetInt(1, gSignatureStatus);</span>
<a href="#l36.10"></a><span id="l36.10">   params.SetInt(2, gEncryptionStatus);</span>
<a href="#l36.11"></a><span id="l36.11"> </span>
<a href="#l36.12"></a><span id="l36.12" class="difflineminus">-  window.openDialog(</span>
<a href="#l36.13"></a><span id="l36.13" class="difflineplus">+  window.docShell.rootTreeItem.domWindow.openDialog(</span>
<a href="#l36.14"></a><span id="l36.14">     &quot;chrome://messenger-smime/content/msgReadSecurityInfo.xhtml&quot;,</span>
<a href="#l36.15"></a><span id="l36.15">     &quot;&quot;,</span>
<a href="#l36.16"></a><span id="l36.16">     &quot;chrome,resizable,modal,dialog,centerscreen&quot;,</span>
<a href="#l36.17"></a><span id="l36.17">     params</span>
<a href="#l36.18"></a><span id="l36.18">   );</span>
<a href="#l36.19"></a><span id="l36.19"> }</span>
<a href="#l36.20"></a><span id="l36.20"> </span>
<a href="#l36.21"></a><span id="l36.21"> var SecurityController = {</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

