<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 11849:dcdffce8cf46202d99e0c37f2ea4192adb33fa5d</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ dcdffce8cf46202d99e0c37f2ea4192adb33fa5d" />
<meta property="og:url" content="/comm-central/rev/dcdffce8cf46202d99e0c37f2ea4192adb33fa5d" />
<meta property="og:description" content="Bug 833015 Update Suite Download Manager UI for Private Browsing changes r=IanN f=Ratty" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / dcdffce8cf46202d99e0c37f2ea4192adb33fa5d 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/dcdffce8cf46202d99e0c37f2ea4192adb33fa5d">shortlog</a> |
<a href="/comm-central/log/dcdffce8cf46202d99e0c37f2ea4192adb33fa5d">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/dcdffce8cf46202d99e0c37f2ea4192adb33fa5d">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/dcdffce8cf46202d99e0c37f2ea4192adb33fa5d">files</a> |
changeset |
<a href="/comm-central/raw-rev/dcdffce8cf46202d99e0c37f2ea4192adb33fa5d">raw</a>  | <a href="/comm-central/archive/dcdffce8cf46202d99e0c37f2ea4192adb33fa5d.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=833015">Bug 833015</a> Update Suite Download Manager UI for Private Browsing changes r=IanN f=Ratty
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#78;&#101;&#105;&#108;&#32;&#82;&#97;&#115;&#104;&#98;&#114;&#111;&#111;&#107;&#32;&#60;&#110;&#101;&#105;&#108;&#64;&#112;&#97;&#114;&#107;&#119;&#97;&#121;&#99;&#99;&#46;&#99;&#111;&#46;&#117;&#107;&#62;</td></tr>
<tr><td></td><td class="date age">Sat, 26 Jan 2013 23:58:12 +0000</td></tr>

<tr>
 <td>changeset 11849</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/dcdffce8cf46202d99e0c37f2ea4192adb33fa5d">dcdffce8cf46202d99e0c37f2ea4192adb33fa5d</a></td>
</tr>



<tr>
<td>parent 11848</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/5afc408aa274f6fd7a51850f0b69ce7287b91eef">5afc408aa274f6fd7a51850f0b69ce7287b91eef</a>
</td>
</tr>

<tr>
<td>child 11850</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/3b05c1436a118d71d150b11c1890a0a378284f27">3b05c1436a118d71d150b11c1890a0a378284f27</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=dcdffce8cf46202d99e0c37f2ea4192adb33fa5d">8826</a></td></tr>
<tr><td>push user</td><td>neil@parkwaycc.co.uk</td></tr>
<tr><td>push date</td><td class="date age">Sat, 26 Jan 2013 23:58:31 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@dcdffce8cf46 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=dcdffce8cf46202d99e0c37f2ea4192adb33fa5d">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=dcdffce8cf46202d99e0c37f2ea4192adb33fa5d&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=dcdffce8cf46202d99e0c37f2ea4192adb33fa5d&newProject=comm-central&newRevision=5afc408aa274f6fd7a51850f0b69ce7287b91eef&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=dcdffce8cf46202d99e0c37f2ea4192adb33fa5d&newProject=comm-central&newRevision=5afc408aa274f6fd7a51850f0b69ce7287b91eef&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=dcdffce8cf46202d99e0c37f2ea4192adb33fa5d&newProject=comm-central&newRevision=5afc408aa274f6fd7a51850f0b69ce7287b91eef&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28IanN%29&revcount=50">IanN</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=833015">833015</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=833015">Bug 833015</a> Update Suite Download Manager UI for Private Browsing changes r=IanN f=Ratty</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/dcdffce8cf46202d99e0c37f2ea4192adb33fa5d/suite/common/downloads/downloadmanager.js">suite/common/downloads/downloadmanager.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dcdffce8cf46202d99e0c37f2ea4192adb33fa5d/suite/common/downloads/downloadmanager.js">file</a> |
<a href="/comm-central/annotate/dcdffce8cf46202d99e0c37f2ea4192adb33fa5d/suite/common/downloads/downloadmanager.js">annotate</a> |
<a href="/comm-central/diff/dcdffce8cf46202d99e0c37f2ea4192adb33fa5d/suite/common/downloads/downloadmanager.js">diff</a> |
<a href="/comm-central/comparison/dcdffce8cf46202d99e0c37f2ea4192adb33fa5d/suite/common/downloads/downloadmanager.js">comparison</a> |
<a href="/comm-central/log/dcdffce8cf46202d99e0c37f2ea4192adb33fa5d/suite/common/downloads/downloadmanager.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/dcdffce8cf46202d99e0c37f2ea4192adb33fa5d/suite/common/downloads/progressDialog.js">suite/common/downloads/progressDialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dcdffce8cf46202d99e0c37f2ea4192adb33fa5d/suite/common/downloads/progressDialog.js">file</a> |
<a href="/comm-central/annotate/dcdffce8cf46202d99e0c37f2ea4192adb33fa5d/suite/common/downloads/progressDialog.js">annotate</a> |
<a href="/comm-central/diff/dcdffce8cf46202d99e0c37f2ea4192adb33fa5d/suite/common/downloads/progressDialog.js">diff</a> |
<a href="/comm-central/comparison/dcdffce8cf46202d99e0c37f2ea4192adb33fa5d/suite/common/downloads/progressDialog.js">comparison</a> |
<a href="/comm-central/log/dcdffce8cf46202d99e0c37f2ea4192adb33fa5d/suite/common/downloads/progressDialog.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/dcdffce8cf46202d99e0c37f2ea4192adb33fa5d/suite/common/downloads/tests/browser/browser_nsISuiteDownloadManagerUI.js">suite/common/downloads/tests/browser/browser_nsISuiteDownloadManagerUI.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dcdffce8cf46202d99e0c37f2ea4192adb33fa5d/suite/common/downloads/tests/browser/browser_nsISuiteDownloadManagerUI.js">file</a> |
<a href="/comm-central/annotate/dcdffce8cf46202d99e0c37f2ea4192adb33fa5d/suite/common/downloads/tests/browser/browser_nsISuiteDownloadManagerUI.js">annotate</a> |
<a href="/comm-central/diff/dcdffce8cf46202d99e0c37f2ea4192adb33fa5d/suite/common/downloads/tests/browser/browser_nsISuiteDownloadManagerUI.js">diff</a> |
<a href="/comm-central/comparison/dcdffce8cf46202d99e0c37f2ea4192adb33fa5d/suite/common/downloads/tests/browser/browser_nsISuiteDownloadManagerUI.js">comparison</a> |
<a href="/comm-central/log/dcdffce8cf46202d99e0c37f2ea4192adb33fa5d/suite/common/downloads/tests/browser/browser_nsISuiteDownloadManagerUI.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/dcdffce8cf46202d99e0c37f2ea4192adb33fa5d/suite/common/downloads/treeView.js">suite/common/downloads/treeView.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dcdffce8cf46202d99e0c37f2ea4192adb33fa5d/suite/common/downloads/treeView.js">file</a> |
<a href="/comm-central/annotate/dcdffce8cf46202d99e0c37f2ea4192adb33fa5d/suite/common/downloads/treeView.js">annotate</a> |
<a href="/comm-central/diff/dcdffce8cf46202d99e0c37f2ea4192adb33fa5d/suite/common/downloads/treeView.js">diff</a> |
<a href="/comm-central/comparison/dcdffce8cf46202d99e0c37f2ea4192adb33fa5d/suite/common/downloads/treeView.js">comparison</a> |
<a href="/comm-central/log/dcdffce8cf46202d99e0c37f2ea4192adb33fa5d/suite/common/downloads/treeView.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/dcdffce8cf46202d99e0c37f2ea4192adb33fa5d/suite/common/pref/pref-download.xul">suite/common/pref/pref-download.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dcdffce8cf46202d99e0c37f2ea4192adb33fa5d/suite/common/pref/pref-download.xul">file</a> |
<a href="/comm-central/annotate/dcdffce8cf46202d99e0c37f2ea4192adb33fa5d/suite/common/pref/pref-download.xul">annotate</a> |
<a href="/comm-central/diff/dcdffce8cf46202d99e0c37f2ea4192adb33fa5d/suite/common/pref/pref-download.xul">diff</a> |
<a href="/comm-central/comparison/dcdffce8cf46202d99e0c37f2ea4192adb33fa5d/suite/common/pref/pref-download.xul">comparison</a> |
<a href="/comm-central/log/dcdffce8cf46202d99e0c37f2ea4192adb33fa5d/suite/common/pref/pref-download.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/dcdffce8cf46202d99e0c37f2ea4192adb33fa5d/suite/common/public/nsISuiteDownloadManagerUI.idl">suite/common/public/nsISuiteDownloadManagerUI.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dcdffce8cf46202d99e0c37f2ea4192adb33fa5d/suite/common/public/nsISuiteDownloadManagerUI.idl">file</a> |
<a href="/comm-central/annotate/dcdffce8cf46202d99e0c37f2ea4192adb33fa5d/suite/common/public/nsISuiteDownloadManagerUI.idl">annotate</a> |
<a href="/comm-central/diff/dcdffce8cf46202d99e0c37f2ea4192adb33fa5d/suite/common/public/nsISuiteDownloadManagerUI.idl">diff</a> |
<a href="/comm-central/comparison/dcdffce8cf46202d99e0c37f2ea4192adb33fa5d/suite/common/public/nsISuiteDownloadManagerUI.idl">comparison</a> |
<a href="/comm-central/log/dcdffce8cf46202d99e0c37f2ea4192adb33fa5d/suite/common/public/nsISuiteDownloadManagerUI.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/dcdffce8cf46202d99e0c37f2ea4192adb33fa5d/suite/common/src/nsSuiteDownloadManagerUI.js">suite/common/src/nsSuiteDownloadManagerUI.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dcdffce8cf46202d99e0c37f2ea4192adb33fa5d/suite/common/src/nsSuiteDownloadManagerUI.js">file</a> |
<a href="/comm-central/annotate/dcdffce8cf46202d99e0c37f2ea4192adb33fa5d/suite/common/src/nsSuiteDownloadManagerUI.js">annotate</a> |
<a href="/comm-central/diff/dcdffce8cf46202d99e0c37f2ea4192adb33fa5d/suite/common/src/nsSuiteDownloadManagerUI.js">diff</a> |
<a href="/comm-central/comparison/dcdffce8cf46202d99e0c37f2ea4192adb33fa5d/suite/common/src/nsSuiteDownloadManagerUI.js">comparison</a> |
<a href="/comm-central/log/dcdffce8cf46202d99e0c37f2ea4192adb33fa5d/suite/common/src/nsSuiteDownloadManagerUI.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/dcdffce8cf46202d99e0c37f2ea4192adb33fa5d/suite/locales/en-US/chrome/common/pref/pref-download.dtd">suite/locales/en-US/chrome/common/pref/pref-download.dtd</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dcdffce8cf46202d99e0c37f2ea4192adb33fa5d/suite/locales/en-US/chrome/common/pref/pref-download.dtd">file</a> |
<a href="/comm-central/annotate/dcdffce8cf46202d99e0c37f2ea4192adb33fa5d/suite/locales/en-US/chrome/common/pref/pref-download.dtd">annotate</a> |
<a href="/comm-central/diff/dcdffce8cf46202d99e0c37f2ea4192adb33fa5d/suite/locales/en-US/chrome/common/pref/pref-download.dtd">diff</a> |
<a href="/comm-central/comparison/dcdffce8cf46202d99e0c37f2ea4192adb33fa5d/suite/locales/en-US/chrome/common/pref/pref-download.dtd">comparison</a> |
<a href="/comm-central/log/dcdffce8cf46202d99e0c37f2ea4192adb33fa5d/suite/locales/en-US/chrome/common/pref/pref-download.dtd">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/suite/common/downloads/downloadmanager.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/suite/common/downloads/downloadmanager.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -124,47 +124,32 @@ function sortDownloads(aEventTarget)</span>
<a href="#l1.4"></a><span id="l1.4"> </span>
<a href="#l1.5"></a><span id="l1.5">   if (column) {</span>
<a href="#l1.6"></a><span id="l1.6">     // Set attributes to the sorting we did</span>
<a href="#l1.7"></a><span id="l1.7">     column.setAttribute(&quot;sortActive&quot;, &quot;true&quot;);</span>
<a href="#l1.8"></a><span id="l1.8">     column.setAttribute(&quot;sortDirection&quot;, sortDirection);</span>
<a href="#l1.9"></a><span id="l1.9">   }</span>
<a href="#l1.10"></a><span id="l1.10"> }</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-function pauseDownload(aDownloadID)</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-{</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-  gDownloadManager.pauseDownload(aDownloadID);</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineminus">-}</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineminus">-</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineminus">-function resumeDownload(aDownloadID)</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+function retryDownload(aDownload)</span>
<a href="#l1.19"></a><span id="l1.19"> {</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineminus">-  gDownloadManager.resumeDownload(aDownloadID);</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineminus">-}</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineminus">-</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineminus">-function retryDownload(aDownloadID)</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineminus">-{</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineminus">-  gDownloadManager.retryDownload(aDownloadID);</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineplus">+  aDownload.retry();</span>
<a href="#l1.27"></a><span id="l1.27">   if (gDownloadTreeView)</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineminus">-    gDownloadTreeView.removeDownload(aDownloadID);</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineplus">+    gDownloadTreeView.removeDownload(aDownload.guid);</span>
<a href="#l1.30"></a><span id="l1.30"> }</span>
<a href="#l1.31"></a><span id="l1.31"> </span>
<a href="#l1.32"></a><span id="l1.32"> function cancelDownload(aDownload)</span>
<a href="#l1.33"></a><span id="l1.33"> {</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineminus">-  gDownloadManager.cancelDownload(aDownload.id);</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineplus">+  aDownload.cancel();</span>
<a href="#l1.36"></a><span id="l1.36">   // delete the file if it exists</span>
<a href="#l1.37"></a><span id="l1.37">   var file = aDownload.targetFile;</span>
<a href="#l1.38"></a><span id="l1.38">   if (file.exists())</span>
<a href="#l1.39"></a><span id="l1.39">     file.remove(false);</span>
<a href="#l1.40"></a><span id="l1.40"> }</span>
<a href="#l1.41"></a><span id="l1.41"> </span>
<a href="#l1.42"></a><span id="l1.42" class="difflineminus">-function removeDownload(aDownloadID)</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineminus">-{</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineminus">-  gDownloadManager.removeDownload(aDownloadID);</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineminus">-}</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineminus">-</span>
<a href="#l1.47"></a><span id="l1.47"> function openDownload(aDownload)</span>
<a href="#l1.48"></a><span id="l1.48"> {</span>
<a href="#l1.49"></a><span id="l1.49">   var name = aDownload.displayName;</span>
<a href="#l1.50"></a><span id="l1.50">   var file = aDownload.targetFile;</span>
<a href="#l1.51"></a><span id="l1.51"> </span>
<a href="#l1.52"></a><span id="l1.52">   if (file.isExecutable()) {</span>
<a href="#l1.53"></a><span id="l1.53">     var alertOnEXEOpen = GetBoolPref(&quot;browser.download.manager.alertOnEXEOpen&quot;,</span>
<a href="#l1.54"></a><span id="l1.54">                                      true);</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineat">@@ -235,21 +220,21 @@ function showDownload(aDownload)</span>
<a href="#l1.56"></a><span id="l1.56">       var uri = Services.io.newFileURI(parent);</span>
<a href="#l1.57"></a><span id="l1.57">       var protocolSvc = Components.classes[&quot;@mozilla.org/uriloader/external-protocol-service;1&quot;]</span>
<a href="#l1.58"></a><span id="l1.58">                                   .getService(Components.interfaces.nsIExternalProtocolService);</span>
<a href="#l1.59"></a><span id="l1.59">       protocolSvc.loadUrl(uri);</span>
<a href="#l1.60"></a><span id="l1.60">     }</span>
<a href="#l1.61"></a><span id="l1.61">   }</span>
<a href="#l1.62"></a><span id="l1.62"> }</span>
<a href="#l1.63"></a><span id="l1.63"> </span>
<a href="#l1.64"></a><span id="l1.64" class="difflineminus">-function showProperties(aDownloadID)</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineplus">+function showProperties(aDownload)</span>
<a href="#l1.66"></a><span id="l1.66"> {</span>
<a href="#l1.67"></a><span id="l1.67">   var dmui = Components.classes[&quot;@mozilla.org/download-manager-ui;1&quot;]</span>
<a href="#l1.68"></a><span id="l1.68">                        .getService(Components.interfaces.nsISuiteDownloadManagerUI);</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineminus">-  dmui.showProgress(window, aDownloadID);</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineplus">+  dmui.showProgress(window, aDownload);</span>
<a href="#l1.71"></a><span id="l1.71"> }</span>
<a href="#l1.72"></a><span id="l1.72"> </span>
<a href="#l1.73"></a><span id="l1.73"> function onTreeSelect(aEvent)</span>
<a href="#l1.74"></a><span id="l1.74"> {</span>
<a href="#l1.75"></a><span id="l1.75">   var selectionCount = gDownloadTreeView.selection.count;</span>
<a href="#l1.76"></a><span id="l1.76">   if (selectionCount == 1) {</span>
<a href="#l1.77"></a><span id="l1.77">     var selItemData = gDownloadTreeView.getRowData(gDownloadTree.currentIndex);</span>
<a href="#l1.78"></a><span id="l1.78">     gDownloadStatus.label = GetFileFromString(selItemData.file).path;</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineat">@@ -451,72 +436,72 @@ var dlTreeController = {</span>
<a href="#l1.80"></a><span id="l1.80">           selItemData.push(gDownloadTreeView.getRowData(row));</span>
<a href="#l1.81"></a><span id="l1.81">       }</span>
<a href="#l1.82"></a><span id="l1.82">     }</span>
<a href="#l1.83"></a><span id="l1.83"> </span>
<a href="#l1.84"></a><span id="l1.84">     switch (aCommand) {</span>
<a href="#l1.85"></a><span id="l1.85">       case &quot;cmd_play&quot;:</span>
<a href="#l1.86"></a><span id="l1.86">         if (!selectionCount)</span>
<a href="#l1.87"></a><span id="l1.87">           return false;</span>
<a href="#l1.88"></a><span id="l1.88" class="difflineminus">-        for each (let dldata in selItemData) {</span>
<a href="#l1.89"></a><span id="l1.89" class="difflineplus">+        for (let dldata of selItemData) {</span>
<a href="#l1.90"></a><span id="l1.90">           if (dldata.state != nsIDownloadManager.DOWNLOAD_CANCELED &amp;&amp;</span>
<a href="#l1.91"></a><span id="l1.91">               dldata.state != nsIDownloadManager.DOWNLOAD_FAILED &amp;&amp;</span>
<a href="#l1.92"></a><span id="l1.92">               (!dldata.resumable ||</span>
<a href="#l1.93"></a><span id="l1.93">                (!dldata.isActive &amp;&amp;</span>
<a href="#l1.94"></a><span id="l1.94">                 dldata.state != nsIDownloadManager.DOWNLOAD_PAUSED)))</span>
<a href="#l1.95"></a><span id="l1.95">             return false;</span>
<a href="#l1.96"></a><span id="l1.96">         }</span>
<a href="#l1.97"></a><span id="l1.97">         return true;</span>
<a href="#l1.98"></a><span id="l1.98">       case &quot;cmd_pause&quot;:</span>
<a href="#l1.99"></a><span id="l1.99">         if (!selectionCount)</span>
<a href="#l1.100"></a><span id="l1.100">           return false;</span>
<a href="#l1.101"></a><span id="l1.101" class="difflineminus">-        for each (let dldata in selItemData) {</span>
<a href="#l1.102"></a><span id="l1.102" class="difflineplus">+        for (let dldata of selItemData) {</span>
<a href="#l1.103"></a><span id="l1.103">           if (!dldata.isActive ||</span>
<a href="#l1.104"></a><span id="l1.104">               dldata.state == nsIDownloadManager.DOWNLOAD_PAUSED ||</span>
<a href="#l1.105"></a><span id="l1.105">               !dldata.resumable)</span>
<a href="#l1.106"></a><span id="l1.106">             return false;</span>
<a href="#l1.107"></a><span id="l1.107">         }</span>
<a href="#l1.108"></a><span id="l1.108">         return true;</span>
<a href="#l1.109"></a><span id="l1.109">       case &quot;cmd_resume&quot;:</span>
<a href="#l1.110"></a><span id="l1.110">         if (!selectionCount)</span>
<a href="#l1.111"></a><span id="l1.111">           return false;</span>
<a href="#l1.112"></a><span id="l1.112" class="difflineminus">-        for each (let dldata in selItemData) {</span>
<a href="#l1.113"></a><span id="l1.113" class="difflineplus">+        for (let dldata of selItemData) {</span>
<a href="#l1.114"></a><span id="l1.114">           if (dldata.state != nsIDownloadManager.DOWNLOAD_PAUSED ||</span>
<a href="#l1.115"></a><span id="l1.115">               !dldata.resumable)</span>
<a href="#l1.116"></a><span id="l1.116">             return false;</span>
<a href="#l1.117"></a><span id="l1.117">         }</span>
<a href="#l1.118"></a><span id="l1.118">         return true;</span>
<a href="#l1.119"></a><span id="l1.119">       case &quot;cmd_open&quot;:</span>
<a href="#l1.120"></a><span id="l1.120">       case &quot;cmd_show&quot;:</span>
<a href="#l1.121"></a><span id="l1.121">         // we can't reveal until the download is complete, because we have not given</span>
<a href="#l1.122"></a><span id="l1.122">         // the file its final name until them.</span>
<a href="#l1.123"></a><span id="l1.123">         return selectionCount == 1 &amp;&amp;</span>
<a href="#l1.124"></a><span id="l1.124">                selItemData[0].state == nsIDownloadManager.DOWNLOAD_FINISHED &amp;&amp;</span>
<a href="#l1.125"></a><span id="l1.125">                GetFileFromString(selItemData[0].file).exists();</span>
<a href="#l1.126"></a><span id="l1.126">       case &quot;cmd_cancel&quot;:</span>
<a href="#l1.127"></a><span id="l1.127">         if (!selectionCount)</span>
<a href="#l1.128"></a><span id="l1.128">           return false;</span>
<a href="#l1.129"></a><span id="l1.129" class="difflineminus">-        for each (let dldata in selItemData) {</span>
<a href="#l1.130"></a><span id="l1.130" class="difflineplus">+        for (let dldata of selItemData) {</span>
<a href="#l1.131"></a><span id="l1.131">           if (!dldata.isActive)</span>
<a href="#l1.132"></a><span id="l1.132">             return false;</span>
<a href="#l1.133"></a><span id="l1.133">         }</span>
<a href="#l1.134"></a><span id="l1.134">         return true;</span>
<a href="#l1.135"></a><span id="l1.135">       case &quot;cmd_retry&quot;:</span>
<a href="#l1.136"></a><span id="l1.136">         if (!selectionCount)</span>
<a href="#l1.137"></a><span id="l1.137">           return false;</span>
<a href="#l1.138"></a><span id="l1.138" class="difflineminus">-        for each (let dldata in selItemData) {</span>
<a href="#l1.139"></a><span id="l1.139" class="difflineplus">+        for (let dldata of selItemData) {</span>
<a href="#l1.140"></a><span id="l1.140">           if (dldata.state != nsIDownloadManager.DOWNLOAD_CANCELED &amp;&amp;</span>
<a href="#l1.141"></a><span id="l1.141">               dldata.state != nsIDownloadManager.DOWNLOAD_FAILED)</span>
<a href="#l1.142"></a><span id="l1.142">             return false;</span>
<a href="#l1.143"></a><span id="l1.143">         }</span>
<a href="#l1.144"></a><span id="l1.144">         return true;</span>
<a href="#l1.145"></a><span id="l1.145">       case &quot;cmd_remove&quot;:</span>
<a href="#l1.146"></a><span id="l1.146">         if (!selectionCount)</span>
<a href="#l1.147"></a><span id="l1.147">           return false;</span>
<a href="#l1.148"></a><span id="l1.148" class="difflineminus">-        for each (let dldata in selItemData) {</span>
<a href="#l1.149"></a><span id="l1.149" class="difflineplus">+        for (let dldata of selItemData) {</span>
<a href="#l1.150"></a><span id="l1.150">           if (dldata.isActive)</span>
<a href="#l1.151"></a><span id="l1.151">             return false;</span>
<a href="#l1.152"></a><span id="l1.152">         }</span>
<a href="#l1.153"></a><span id="l1.153">         return true;</span>
<a href="#l1.154"></a><span id="l1.154">       case &quot;cmd_openReferrer&quot;:</span>
<a href="#l1.155"></a><span id="l1.155">         return selectionCount == 1 &amp;&amp; !!selItemData[0].referrer;</span>
<a href="#l1.156"></a><span id="l1.156">       case &quot;cmd_stop&quot;:</span>
<a href="#l1.157"></a><span id="l1.157">       case &quot;cmd_copyLocation&quot;:</span>
<a href="#l1.158"></a><span id="l1.158" class="difflineat">@@ -549,100 +534,95 @@ var dlTreeController = {</span>
<a href="#l1.159"></a><span id="l1.159">         gDownloadTreeView.selection.getRangeAt(rg, start, end);</span>
<a href="#l1.160"></a><span id="l1.160">         for (let row = start.value; row &lt;= end.value; row++)</span>
<a href="#l1.161"></a><span id="l1.161">           selItemData.push(gDownloadTreeView.getRowData(row));</span>
<a href="#l1.162"></a><span id="l1.162">       }</span>
<a href="#l1.163"></a><span id="l1.163">     }</span>
<a href="#l1.164"></a><span id="l1.164"> </span>
<a href="#l1.165"></a><span id="l1.165">     switch (aCommand) {</span>
<a href="#l1.166"></a><span id="l1.166">       case &quot;cmd_play&quot;:</span>
<a href="#l1.167"></a><span id="l1.167" class="difflineminus">-        for each (let dldata in selItemData) {</span>
<a href="#l1.168"></a><span id="l1.168" class="difflineplus">+        for (let dldata of selItemData) {</span>
<a href="#l1.169"></a><span id="l1.169">           switch (dldata.state) {</span>
<a href="#l1.170"></a><span id="l1.170">             case nsIDownloadManager.DOWNLOAD_DOWNLOADING:</span>
<a href="#l1.171"></a><span id="l1.171" class="difflineminus">-              pauseDownload(dldata.dlid);</span>
<a href="#l1.172"></a><span id="l1.172" class="difflineplus">+              dldata.dld.pause();</span>
<a href="#l1.173"></a><span id="l1.173">               break;</span>
<a href="#l1.174"></a><span id="l1.174">             case nsIDownloadManager.DOWNLOAD_PAUSED:</span>
<a href="#l1.175"></a><span id="l1.175" class="difflineminus">-              resumeDownload(dldata.dlid);</span>
<a href="#l1.176"></a><span id="l1.176" class="difflineplus">+              dldata.dld.resume();</span>
<a href="#l1.177"></a><span id="l1.177">               break;</span>
<a href="#l1.178"></a><span id="l1.178">             case nsIDownloadManager.DOWNLOAD_FAILED:</span>
<a href="#l1.179"></a><span id="l1.179">             case nsIDownloadManager.DOWNLOAD_CANCELED:</span>
<a href="#l1.180"></a><span id="l1.180" class="difflineminus">-              retryDownload(dldata.dlid);</span>
<a href="#l1.181"></a><span id="l1.181" class="difflineplus">+              retryDownload(dldata.dld);</span>
<a href="#l1.182"></a><span id="l1.182">               break;</span>
<a href="#l1.183"></a><span id="l1.183">           }</span>
<a href="#l1.184"></a><span id="l1.184">         }</span>
<a href="#l1.185"></a><span id="l1.185">         break;</span>
<a href="#l1.186"></a><span id="l1.186">       case &quot;cmd_pause&quot;:</span>
<a href="#l1.187"></a><span id="l1.187" class="difflineminus">-        for each (let dldata in selItemData)</span>
<a href="#l1.188"></a><span id="l1.188" class="difflineminus">-          pauseDownload(dldata.dlid);</span>
<a href="#l1.189"></a><span id="l1.189" class="difflineplus">+        for (let dldata of selItemData)</span>
<a href="#l1.190"></a><span id="l1.190" class="difflineplus">+          dldata.dld.pause();</span>
<a href="#l1.191"></a><span id="l1.191">         break;</span>
<a href="#l1.192"></a><span id="l1.192">       case &quot;cmd_resume&quot;:</span>
<a href="#l1.193"></a><span id="l1.193" class="difflineminus">-        for each (let dldata in selItemData)</span>
<a href="#l1.194"></a><span id="l1.194" class="difflineminus">-          resumeDownload(dldata.dlid);</span>
<a href="#l1.195"></a><span id="l1.195" class="difflineplus">+        for (let dldata of selItemData)</span>
<a href="#l1.196"></a><span id="l1.196" class="difflineplus">+          dldata.dld.resume();</span>
<a href="#l1.197"></a><span id="l1.197">         break;</span>
<a href="#l1.198"></a><span id="l1.198">       case &quot;cmd_retry&quot;:</span>
<a href="#l1.199"></a><span id="l1.199" class="difflineminus">-        for each (let dldata in selItemData)</span>
<a href="#l1.200"></a><span id="l1.200" class="difflineminus">-          retryDownload(dldata.dlid);</span>
<a href="#l1.201"></a><span id="l1.201" class="difflineplus">+        for (let dldata of selItemData)</span>
<a href="#l1.202"></a><span id="l1.202" class="difflineplus">+          retryDownload(dldata.dld);</span>
<a href="#l1.203"></a><span id="l1.203">         break;</span>
<a href="#l1.204"></a><span id="l1.204">       case &quot;cmd_cancel&quot;:</span>
<a href="#l1.205"></a><span id="l1.205" class="difflineminus">-        for each (let dldata in selItemData)</span>
<a href="#l1.206"></a><span id="l1.206" class="difflineminus">-          // fake an nsIDownload with the properties needed by that function</span>
<a href="#l1.207"></a><span id="l1.207" class="difflineminus">-          cancelDownload({id: dldata.dlid,</span>
<a href="#l1.208"></a><span id="l1.208" class="difflineminus">-                          targetFile: GetFileFromString(dldata.file)});</span>
<a href="#l1.209"></a><span id="l1.209" class="difflineplus">+        for (let dldata of selItemData)</span>
<a href="#l1.210"></a><span id="l1.210" class="difflineplus">+          cancelDownload(dldata.dld);</span>
<a href="#l1.211"></a><span id="l1.211">         break;</span>
<a href="#l1.212"></a><span id="l1.212">       case &quot;cmd_remove&quot;:</span>
<a href="#l1.213"></a><span id="l1.213" class="difflineminus">-        for each (let dldata in selItemData)</span>
<a href="#l1.214"></a><span id="l1.214" class="difflineminus">-          removeDownload(dldata.dlid);</span>
<a href="#l1.215"></a><span id="l1.215" class="difflineplus">+        for (let dldata of selItemData)</span>
<a href="#l1.216"></a><span id="l1.216" class="difflineplus">+          dldata.dld.remove();</span>
<a href="#l1.217"></a><span id="l1.217">         break;</span>
<a href="#l1.218"></a><span id="l1.218">       case &quot;cmd_stop&quot;:</span>
<a href="#l1.219"></a><span id="l1.219" class="difflineminus">-        for each (let dldata in selItemData) {</span>
<a href="#l1.220"></a><span id="l1.220" class="difflineplus">+        for (let dldata of selItemData) {</span>
<a href="#l1.221"></a><span id="l1.221">           if (dldata.isActive)</span>
<a href="#l1.222"></a><span id="l1.222" class="difflineminus">-            // fake an nsIDownload with the properties needed by that function</span>
<a href="#l1.223"></a><span id="l1.223" class="difflineminus">-            cancelDownload({id: dldata.dlid,</span>
<a href="#l1.224"></a><span id="l1.224" class="difflineminus">-                            targetFile: GetFileFromString(dldata.file)});</span>
<a href="#l1.225"></a><span id="l1.225" class="difflineplus">+            cancelDownload(dldata.dld);</span>
<a href="#l1.226"></a><span id="l1.226">           else</span>
<a href="#l1.227"></a><span id="l1.227" class="difflineminus">-            removeDownload(dldata.dlid);</span>
<a href="#l1.228"></a><span id="l1.228" class="difflineplus">+            dldata.dld.remove();</span>
<a href="#l1.229"></a><span id="l1.229">         }</span>
<a href="#l1.230"></a><span id="l1.230">         break;</span>
<a href="#l1.231"></a><span id="l1.231">       case &quot;cmd_open&quot;:</span>
<a href="#l1.232"></a><span id="l1.232" class="difflineminus">-        openDownload(gDownloadManager.getDownload(selItemData[0].dlid));</span>
<a href="#l1.233"></a><span id="l1.233" class="difflineplus">+        openDownload(selItemData[0].dld);</span>
<a href="#l1.234"></a><span id="l1.234">         break;</span>
<a href="#l1.235"></a><span id="l1.235">       case &quot;cmd_show&quot;:</span>
<a href="#l1.236"></a><span id="l1.236" class="difflineminus">-        // fake an nsIDownload with the properties needed by that function</span>
<a href="#l1.237"></a><span id="l1.237" class="difflineminus">-        showDownload({targetFile: GetFileFromString(selItemData[0].file)});</span>
<a href="#l1.238"></a><span id="l1.238" class="difflineplus">+        showDownload(selItemData[0].dld);</span>
<a href="#l1.239"></a><span id="l1.239">         break;</span>
<a href="#l1.240"></a><span id="l1.240">       case &quot;cmd_openReferrer&quot;:</span>
<a href="#l1.241"></a><span id="l1.241">         openUILink(selItemData[0].referrer);</span>
<a href="#l1.242"></a><span id="l1.242">         break;</span>
<a href="#l1.243"></a><span id="l1.243">       case &quot;cmd_copyLocation&quot;:</span>
<a href="#l1.244"></a><span id="l1.244">         var clipboard = Components.classes[&quot;@mozilla.org/widget/clipboardhelper;1&quot;]</span>
<a href="#l1.245"></a><span id="l1.245">                                   .getService(Components.interfaces.nsIClipboardHelper);</span>
<a href="#l1.246"></a><span id="l1.246">         var uris = [];</span>
<a href="#l1.247"></a><span id="l1.247" class="difflineminus">-        for each (let dldata in selItemData)</span>
<a href="#l1.248"></a><span id="l1.248" class="difflineplus">+        for (let dldata of selItemData)</span>
<a href="#l1.249"></a><span id="l1.249">           uris.push(dldata.uri);</span>
<a href="#l1.250"></a><span id="l1.250">         clipboard.copyString(uris.join(&quot;\n&quot;), document);</span>
<a href="#l1.251"></a><span id="l1.251">         break;</span>
<a href="#l1.252"></a><span id="l1.252">       case &quot;cmd_properties&quot;:</span>
<a href="#l1.253"></a><span id="l1.253" class="difflineminus">-        showProperties(selItemData[0].dlid);</span>
<a href="#l1.254"></a><span id="l1.254" class="difflineplus">+        showProperties(selItemData[0].dld);</span>
<a href="#l1.255"></a><span id="l1.255">         break;</span>
<a href="#l1.256"></a><span id="l1.256">       case &quot;cmd_selectAll&quot;:</span>
<a href="#l1.257"></a><span id="l1.257">         gDownloadTreeView.selection.selectAll();</span>
<a href="#l1.258"></a><span id="l1.258">         break;</span>
<a href="#l1.259"></a><span id="l1.259">       case &quot;cmd_clearList&quot;:</span>
<a href="#l1.260"></a><span id="l1.260">         // Clear the whole list if there's no search</span>
<a href="#l1.261"></a><span id="l1.261">         if (gSearchBox.value == &quot;&quot;) {</span>
<a href="#l1.262"></a><span id="l1.262">           gDownloadManager.cleanUp();</span>
<a href="#l1.263"></a><span id="l1.263">           return;</span>
<a href="#l1.264"></a><span id="l1.264">         }</span>
<a href="#l1.265"></a><span id="l1.265"> </span>
<a href="#l1.266"></a><span id="l1.266">         // Remove each download starting from the end until we hit a download</span>
<a href="#l1.267"></a><span id="l1.267">         // that is in progress</span>
<a href="#l1.268"></a><span id="l1.268">         for (let idx = gDownloadTreeView.rowCount - 1; idx &gt;= 0; idx--) {</span>
<a href="#l1.269"></a><span id="l1.269">           let dldata = gDownloadTreeView.getRowData(idx);</span>
<a href="#l1.270"></a><span id="l1.270">           if (!dldata.isActive) {</span>
<a href="#l1.271"></a><span id="l1.271" class="difflineminus">-            removeDownload(dldata.dlid);</span>
<a href="#l1.272"></a><span id="l1.272" class="difflineplus">+            dldata.dld.remove();</span>
<a href="#l1.273"></a><span id="l1.273">           }</span>
<a href="#l1.274"></a><span id="l1.274">         }</span>
<a href="#l1.275"></a><span id="l1.275"> </span>
<a href="#l1.276"></a><span id="l1.276">         // Clear the input as if the user did it and move focus to the list</span>
<a href="#l1.277"></a><span id="l1.277">         gSearchBox.value = &quot;&quot;;</span>
<a href="#l1.278"></a><span id="l1.278">         searchDownloads(&quot;&quot;);</span>
<a href="#l1.279"></a><span id="l1.279">         gDownloadTree.focus();</span>
<a href="#l1.280"></a><span id="l1.280">         break;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/suite/common/downloads/progressDialog.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/suite/common/downloads/progressDialog.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -27,17 +27,17 @@ var gRetrying = false;</span>
<a href="#l2.4"></a><span id="l2.4"> </span>
<a href="#l2.5"></a><span id="l2.5"> function progressStartup() {</span>
<a href="#l2.6"></a><span id="l2.6">   gDownload = window.arguments[0];</span>
<a href="#l2.7"></a><span id="l2.7"> </span>
<a href="#l2.8"></a><span id="l2.8">   var recentDMWindow = Services.wm.getMostRecentWindow(&quot;Download:Manager&quot;);</span>
<a href="#l2.9"></a><span id="l2.9">   if (recentDMWindow &amp;&amp; recentDMWindow.gDownloadTreeView.rowCount &gt; 0) {</span>
<a href="#l2.10"></a><span id="l2.10">     // we have been opened by a download manager, get the end time from there</span>
<a href="#l2.11"></a><span id="l2.11">     let dmtree = recentDMWindow.gDownloadTreeView;</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-    let dldata = dmtree.getRowData(dmtree._getIdxForID(gDownload.id));</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+    let dldata = dmtree.getRowData(dmtree._getIdxForGUID(gDownload.guid));</span>
<a href="#l2.14"></a><span id="l2.14">     gEndTime = dldata.endTime;</span>
<a href="#l2.15"></a><span id="l2.15">   }</span>
<a href="#l2.16"></a><span id="l2.16"> </span>
<a href="#l2.17"></a><span id="l2.17">   // cache elements to save .getElementById() calls</span>
<a href="#l2.18"></a><span id="l2.18">   gDownloadBundle = document.getElementById(&quot;dmBundle&quot;);</span>
<a href="#l2.19"></a><span id="l2.19">   gTkDlBundle = document.getElementById(&quot;tkdlBundle&quot;);</span>
<a href="#l2.20"></a><span id="l2.20">   gDlStatus = document.getElementById(&quot;dlStatus&quot;);</span>
<a href="#l2.21"></a><span id="l2.21">   gDlSize = document.getElementById(&quot;dlSize&quot;);</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineat">@@ -331,24 +331,24 @@ var ProgressDlgController = {</span>
<a href="#l2.23"></a><span id="l2.23">       default:</span>
<a href="#l2.24"></a><span id="l2.24">         return false;</span>
<a href="#l2.25"></a><span id="l2.25">     }</span>
<a href="#l2.26"></a><span id="l2.26">   },</span>
<a href="#l2.27"></a><span id="l2.27"> </span>
<a href="#l2.28"></a><span id="l2.28">   doCommand: function(aCommand) {</span>
<a href="#l2.29"></a><span id="l2.29">     switch (aCommand) {</span>
<a href="#l2.30"></a><span id="l2.30">       case &quot;cmd_pause&quot;:</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-        pauseDownload(gDownload.id);</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+        gDownload.pause();</span>
<a href="#l2.33"></a><span id="l2.33">         break;</span>
<a href="#l2.34"></a><span id="l2.34">       case &quot;cmd_resume&quot;:</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineminus">-        resumeDownload(gDownload.id);</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+        gDownload.resume();</span>
<a href="#l2.37"></a><span id="l2.37">         break;</span>
<a href="#l2.38"></a><span id="l2.38">       case &quot;cmd_retry&quot;:</span>
<a href="#l2.39"></a><span id="l2.39">         gRetrying = true;</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineminus">-        retryDownload(gDownload.id);</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+        retryDownload(gDownload);</span>
<a href="#l2.42"></a><span id="l2.42">         break;</span>
<a href="#l2.43"></a><span id="l2.43">       case &quot;cmd_cancel&quot;:</span>
<a href="#l2.44"></a><span id="l2.44">         cancelDownload(gDownload);</span>
<a href="#l2.45"></a><span id="l2.45">         break;</span>
<a href="#l2.46"></a><span id="l2.46">       case &quot;cmd_open&quot;:</span>
<a href="#l2.47"></a><span id="l2.47">         openDownload(gDownload);</span>
<a href="#l2.48"></a><span id="l2.48">         break;</span>
<a href="#l2.49"></a><span id="l2.49">       case &quot;cmd_show&quot;:</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/suite/common/downloads/tests/browser/browser_nsISuiteDownloadManagerUI.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/suite/common/downloads/tests/browser/browser_nsISuiteDownloadManagerUI.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -1,28 +1,28 @@</span>
<a href="#l3.4"></a><span id="l3.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l3.5"></a><span id="l3.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l3.6"></a><span id="l3.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l3.7"></a><span id="l3.7"> </span>
<a href="#l3.8"></a><span id="l3.8"> function test_visibility_open()</span>
<a href="#l3.9"></a><span id="l3.9"> {</span>
<a href="#l3.10"></a><span id="l3.10">   var dmui = Components.classes[&quot;@mozilla.org/download-manager-ui;1&quot;]</span>
<a href="#l3.11"></a><span id="l3.11" class="difflineminus">-                       .getService(Components.interfaces.nsIDownloadManagerUI);</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-  is(dmui.visible, true,</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+                       .getService(Components.interfaces.nsISuiteDownloadManagerUI);</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+  isnot(dmui.recentWindow, null,</span>
<a href="#l3.15"></a><span id="l3.15">      &quot;nsIDownloadManagerUI indicates that the UI is visible&quot;);</span>
<a href="#l3.16"></a><span id="l3.16"> }</span>
<a href="#l3.17"></a><span id="l3.17"> </span>
<a href="#l3.18"></a><span id="l3.18"> function test_visibility_closed(aWin)</span>
<a href="#l3.19"></a><span id="l3.19"> {</span>
<a href="#l3.20"></a><span id="l3.20">   var dmui = Components.classes[&quot;@mozilla.org/download-manager-ui;1&quot;]</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineminus">-                       .getService(Components.interfaces.nsIDownloadManagerUI);</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+                       .getService(Components.interfaces.nsISuiteDownloadManagerUI);</span>
<a href="#l3.23"></a><span id="l3.23"> </span>
<a href="#l3.24"></a><span id="l3.24">   function dmWindowClosedListener() {</span>
<a href="#l3.25"></a><span id="l3.25">     aWin.removeEventListener(&quot;unload&quot;, dmWindowClosedListener, false);</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineminus">-    is(dmui.visible, false,</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineplus">+    is(dmui.recentWindow, null,</span>
<a href="#l3.28"></a><span id="l3.28">        &quot;nsIDownloadManagerUI indicates that the UI is not visible&quot;);</span>
<a href="#l3.29"></a><span id="l3.29">     finish();</span>
<a href="#l3.30"></a><span id="l3.30">   }</span>
<a href="#l3.31"></a><span id="l3.31">   aWin.addEventListener(&quot;unload&quot;, dmWindowClosedListener, false);</span>
<a href="#l3.32"></a><span id="l3.32">   aWin.close();</span>
<a href="#l3.33"></a><span id="l3.33"> }</span>
<a href="#l3.34"></a><span id="l3.34"> </span>
<a href="#l3.35"></a><span id="l3.35"> var testFuncs = [</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/suite/common/downloads/treeView.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/suite/common/downloads/treeView.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -6,21 +6,23 @@ Components.utils.import(&quot;resource://gre/</span>
<a href="#l4.4"></a><span id="l4.4"> Components.utils.import(&quot;resource://gre/modules/DownloadUtils.jsm&quot;);</span>
<a href="#l4.5"></a><span id="l4.5"> </span>
<a href="#l4.6"></a><span id="l4.6"> const nsITreeView = Components.interfaces.nsITreeView;</span>
<a href="#l4.7"></a><span id="l4.7"> // const nsIDownloadManager is already defined in downloadmanager.js</span>
<a href="#l4.8"></a><span id="l4.8"> </span>
<a href="#l4.9"></a><span id="l4.9"> function DownloadTreeView(aDownloadManager) {</span>
<a href="#l4.10"></a><span id="l4.10">   this._dm = aDownloadManager;</span>
<a href="#l4.11"></a><span id="l4.11">   this._dlList = [];</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+  this._dlMap = {};</span>
<a href="#l4.13"></a><span id="l4.13">   this._searchTerms = [];</span>
<a href="#l4.14"></a><span id="l4.14"> }</span>
<a href="#l4.15"></a><span id="l4.15"> </span>
<a href="#l4.16"></a><span id="l4.16"> DownloadTreeView.prototype = {</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineminus">-  QueryInterface: XPCOMUtils.generateQI([nsITreeView]),</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+  QueryInterface: XPCOMUtils.generateQI([nsITreeView,</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+                             Components.interfaces.nsIDownloadManagerResult]),</span>
<a href="#l4.20"></a><span id="l4.20"> </span>
<a href="#l4.21"></a><span id="l4.21">   // ***** nsITreeView attributes and methods *****</span>
<a href="#l4.22"></a><span id="l4.22">   get rowCount() {</span>
<a href="#l4.23"></a><span id="l4.23">     return this._dlList.length;</span>
<a href="#l4.24"></a><span id="l4.24">   },</span>
<a href="#l4.25"></a><span id="l4.25"> </span>
<a href="#l4.26"></a><span id="l4.26">   selection: null,</span>
<a href="#l4.27"></a><span id="l4.27"> </span>
<a href="#l4.28"></a><span id="l4.28" class="difflineat">@@ -130,33 +132,33 @@ DownloadTreeView.prototype = {</span>
<a href="#l4.29"></a><span id="l4.29">           case nsIDownloadManager.DOWNLOAD_DIRTY:            // possible virus/spyware</span>
<a href="#l4.30"></a><span id="l4.30">             return this._dlbundle.getString(&quot;blocked&quot;);</span>
<a href="#l4.31"></a><span id="l4.31">         }</span>
<a href="#l4.32"></a><span id="l4.32">         return this._dlbundle.getString(&quot;notStarted&quot;);</span>
<a href="#l4.33"></a><span id="l4.33">       case &quot;ProgressPercent&quot;:</span>
<a href="#l4.34"></a><span id="l4.34">         return dl.progress;</span>
<a href="#l4.35"></a><span id="l4.35">       case &quot;TimeRemaining&quot;:</span>
<a href="#l4.36"></a><span id="l4.36">         if (dl.isActive) {</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineminus">-          var dld = this._dm.getDownload(dl.dlid);</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineplus">+          var dld = dl.dld;</span>
<a href="#l4.39"></a><span id="l4.39">           var lastSec = (dl.lastSec == null) ? Infinity : dl.lastSec;</span>
<a href="#l4.40"></a><span id="l4.40">           // Calculate the time remaining if we have valid values</span>
<a href="#l4.41"></a><span id="l4.41">           var seconds = (dld.speed &gt; 0) &amp;&amp; (dl.maxBytes &gt; 0)</span>
<a href="#l4.42"></a><span id="l4.42">                         ? (dl.maxBytes - dl.currBytes) / dld.speed</span>
<a href="#l4.43"></a><span id="l4.43">                         : -1;</span>
<a href="#l4.44"></a><span id="l4.44">           var [timeLeft, newLast] = DownloadUtils.getTimeLeft(seconds, lastSec);</span>
<a href="#l4.45"></a><span id="l4.45">           this._dlList[aRow].lastSec = newLast;</span>
<a href="#l4.46"></a><span id="l4.46">           return timeLeft;</span>
<a href="#l4.47"></a><span id="l4.47">         }</span>
<a href="#l4.48"></a><span id="l4.48">         return &quot;&quot;;</span>
<a href="#l4.49"></a><span id="l4.49">       case &quot;Transferred&quot;:</span>
<a href="#l4.50"></a><span id="l4.50">         return DownloadUtils.getTransferTotal(dl.currBytes, dl.maxBytes);</span>
<a href="#l4.51"></a><span id="l4.51">       case &quot;TransferRate&quot;:</span>
<a href="#l4.52"></a><span id="l4.52">         switch (dl.state) {</span>
<a href="#l4.53"></a><span id="l4.53">           case nsIDownloadManager.DOWNLOAD_DOWNLOADING:</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineminus">-            var speed = this._dm.getDownload(dl.dlid).speed;</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineplus">+            var speed = dl.dld.speed;</span>
<a href="#l4.56"></a><span id="l4.56">             this._dlList[aRow]._speed = speed; // used for sorting</span>
<a href="#l4.57"></a><span id="l4.57">             var [rate, unit] = DownloadUtils.convertByteUnits(speed);</span>
<a href="#l4.58"></a><span id="l4.58">             return this._dlbundle.getFormattedString(&quot;speedFormat&quot;, [rate, unit]);</span>
<a href="#l4.59"></a><span id="l4.59">           case nsIDownloadManager.DOWNLOAD_PAUSED:</span>
<a href="#l4.60"></a><span id="l4.60">             return this._dlbundle.getString(&quot;paused&quot;);</span>
<a href="#l4.61"></a><span id="l4.61">           case nsIDownloadManager.DOWNLOAD_NOTSTARTED:</span>
<a href="#l4.62"></a><span id="l4.62">           case nsIDownloadManager.DOWNLOAD_QUEUED:</span>
<a href="#l4.63"></a><span id="l4.63">             return this._dlbundle.getString(&quot;notStarted&quot;);</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineat">@@ -197,63 +199,62 @@ DownloadTreeView.prototype = {</span>
<a href="#l4.65"></a><span id="l4.65">   cycleHeader: function(aColumn) { },</span>
<a href="#l4.66"></a><span id="l4.66">   selectionChanged: function() { },</span>
<a href="#l4.67"></a><span id="l4.67">   cycleCell: function(aRow, aColumn) {</span>
<a href="#l4.68"></a><span id="l4.68">     var dl = this._dlList[aRow];</span>
<a href="#l4.69"></a><span id="l4.69">     switch (aColumn.id) {</span>
<a href="#l4.70"></a><span id="l4.70">       case &quot;ActionPlay&quot;:</span>
<a href="#l4.71"></a><span id="l4.71">         switch (dl.state) {</span>
<a href="#l4.72"></a><span id="l4.72">           case nsIDownloadManager.DOWNLOAD_DOWNLOADING:</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineminus">-            pauseDownload(dl.dlid);</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineplus">+            dl.dld.pause();</span>
<a href="#l4.75"></a><span id="l4.75">             break;</span>
<a href="#l4.76"></a><span id="l4.76">           case nsIDownloadManager.DOWNLOAD_PAUSED:</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineminus">-            resumeDownload(dl.dlid);</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineplus">+            dl.dld.resume();</span>
<a href="#l4.79"></a><span id="l4.79">             break;</span>
<a href="#l4.80"></a><span id="l4.80">           case nsIDownloadManager.DOWNLOAD_FAILED:</span>
<a href="#l4.81"></a><span id="l4.81">           case nsIDownloadManager.DOWNLOAD_CANCELED:</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineminus">-            retryDownload(dl.dlid);</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineplus">+            retryDownload(dl.dld);</span>
<a href="#l4.84"></a><span id="l4.84">             break;</span>
<a href="#l4.85"></a><span id="l4.85">         }</span>
<a href="#l4.86"></a><span id="l4.86">         break;</span>
<a href="#l4.87"></a><span id="l4.87">       case &quot;ActionStop&quot;:</span>
<a href="#l4.88"></a><span id="l4.88">         if (dl.isActive)</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineminus">-          // fake an nsIDownload with the properties needed by that function</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineminus">-          cancelDownload({id: dl.dlid,</span>
<a href="#l4.91"></a><span id="l4.91" class="difflineminus">-                          targetFile: GetFileFromString(dl.file)});</span>
<a href="#l4.92"></a><span id="l4.92" class="difflineplus">+          cancelDownload(dl.dld);</span>
<a href="#l4.93"></a><span id="l4.93">         else</span>
<a href="#l4.94"></a><span id="l4.94" class="difflineminus">-          removeDownload(dl.dlid);</span>
<a href="#l4.95"></a><span id="l4.95" class="difflineplus">+          dl.dld.remove();</span>
<a href="#l4.96"></a><span id="l4.96">         break;</span>
<a href="#l4.97"></a><span id="l4.97">     }</span>
<a href="#l4.98"></a><span id="l4.98">   },</span>
<a href="#l4.99"></a><span id="l4.99">   isEditable: function(aRow, aColumn) { return false; },</span>
<a href="#l4.100"></a><span id="l4.100">   isSelectable: function(aRow, aColumn) { return false; },</span>
<a href="#l4.101"></a><span id="l4.101">   setCellValue: function(aRow, aColumn, aText) { },</span>
<a href="#l4.102"></a><span id="l4.102">   setCellText: function(aRow, aColumn, aText) { },</span>
<a href="#l4.103"></a><span id="l4.103">   performAction: function(aAction) { },</span>
<a href="#l4.104"></a><span id="l4.104">   performActionOnRow: function(aAction, aRow) { },</span>
<a href="#l4.105"></a><span id="l4.105">   performActionOnCell: function(aAction, aRow, aColumn) { },</span>
<a href="#l4.106"></a><span id="l4.106"> </span>
<a href="#l4.107"></a><span id="l4.107">   // ***** local public methods *****</span>
<a href="#l4.108"></a><span id="l4.108"> </span>
<a href="#l4.109"></a><span id="l4.109">   addDownload: function(aDownload) {</span>
<a href="#l4.110"></a><span id="l4.110">     var attrs = {</span>
<a href="#l4.111"></a><span id="l4.111" class="difflineminus">-      dlid: aDownload.id,</span>
<a href="#l4.112"></a><span id="l4.112" class="difflineplus">+      guid: aDownload.guid,</span>
<a href="#l4.113"></a><span id="l4.113">       file: aDownload.target.spec,</span>
<a href="#l4.114"></a><span id="l4.114">       target: aDownload.displayName,</span>
<a href="#l4.115"></a><span id="l4.115">       uri: aDownload.source.spec,</span>
<a href="#l4.116"></a><span id="l4.116">       state: aDownload.state,</span>
<a href="#l4.117"></a><span id="l4.117">       progress: aDownload.percentComplete,</span>
<a href="#l4.118"></a><span id="l4.118">       progressMode: nsITreeView.PROGRESS_NONE,</span>
<a href="#l4.119"></a><span id="l4.119">       resumable: aDownload.resumable,</span>
<a href="#l4.120"></a><span id="l4.120">       startTime: Math.round(aDownload.startTime / 1000),</span>
<a href="#l4.121"></a><span id="l4.121">       endTime: Date.now(),</span>
<a href="#l4.122"></a><span id="l4.122">       referrer: null,</span>
<a href="#l4.123"></a><span id="l4.123">       currBytes: aDownload.amountTransferred,</span>
<a href="#l4.124"></a><span id="l4.124">       maxBytes: aDownload.size,</span>
<a href="#l4.125"></a><span id="l4.125">       lastSec: Infinity, // For calculations of remaining time</span>
<a href="#l4.126"></a><span id="l4.126" class="difflineplus">+      dld: aDownload</span>
<a href="#l4.127"></a><span id="l4.127">     };</span>
<a href="#l4.128"></a><span id="l4.128">     switch (attrs.state) {</span>
<a href="#l4.129"></a><span id="l4.129">       case nsIDownloadManager.DOWNLOAD_DOWNLOADING:</span>
<a href="#l4.130"></a><span id="l4.130">         // At this point, we know if we are an indeterminate download or not.</span>
<a href="#l4.131"></a><span id="l4.131">         attrs.progressMode = attrs.progress == -1 ?</span>
<a href="#l4.132"></a><span id="l4.132">                                                nsITreeView.PROGRESS_UNDETERMINED :</span>
<a href="#l4.133"></a><span id="l4.133">                                                nsITreeView.PROGRESS_NORMAL;</span>
<a href="#l4.134"></a><span id="l4.134">         // We also know the referrer at this point.</span>
<a href="#l4.135"></a><span id="l4.135" class="difflineat">@@ -271,28 +272,29 @@ DownloadTreeView.prototype = {</span>
<a href="#l4.136"></a><span id="l4.136">         break;</span>
<a href="#l4.137"></a><span id="l4.137">     }</span>
<a href="#l4.138"></a><span id="l4.138"> </span>
<a href="#l4.139"></a><span id="l4.139">     // prepend in natural sorting</span>
<a href="#l4.140"></a><span id="l4.140">     attrs.listIndex = this._lastListIndex--;</span>
<a href="#l4.141"></a><span id="l4.141"> </span>
<a href="#l4.142"></a><span id="l4.142">     // Prepend data to the download list</span>
<a href="#l4.143"></a><span id="l4.143">     this._dlList.unshift(attrs);</span>
<a href="#l4.144"></a><span id="l4.144" class="difflineplus">+    this._dlMap[attrs.guid] = attrs;</span>
<a href="#l4.145"></a><span id="l4.145"> </span>
<a href="#l4.146"></a><span id="l4.146">     // Tell the tree we added 1 row at index 0</span>
<a href="#l4.147"></a><span id="l4.147">     this._tree.rowCountChanged(0, 1);</span>
<a href="#l4.148"></a><span id="l4.148"> </span>
<a href="#l4.149"></a><span id="l4.149">     // Data has changed, so re-sorting might be needed</span>
<a href="#l4.150"></a><span id="l4.150">     this.sortView(&quot;&quot;, &quot;&quot;, attrs, 0);</span>
<a href="#l4.151"></a><span id="l4.151"> </span>
<a href="#l4.152"></a><span id="l4.152">     window.updateCommands(&quot;tree-select&quot;);</span>
<a href="#l4.153"></a><span id="l4.153">   },</span>
<a href="#l4.154"></a><span id="l4.154"> </span>
<a href="#l4.155"></a><span id="l4.155">   updateDownload: function(aDownload) {</span>
<a href="#l4.156"></a><span id="l4.156" class="difflineminus">-    var row = this._getIdxForID(aDownload.id);</span>
<a href="#l4.157"></a><span id="l4.157" class="difflineplus">+    var row = this._getIdxForGUID(aDownload.guid);</span>
<a href="#l4.158"></a><span id="l4.158">     if (row == -1) {</span>
<a href="#l4.159"></a><span id="l4.159">       // No download row found to update, but as it's obviously going on,</span>
<a href="#l4.160"></a><span id="l4.160">       // add it to the list now (can happen with very fast, e.g. local dls)</span>
<a href="#l4.161"></a><span id="l4.161">       this.addDownload(aDownload);</span>
<a href="#l4.162"></a><span id="l4.162">       return;</span>
<a href="#l4.163"></a><span id="l4.163">     }</span>
<a href="#l4.164"></a><span id="l4.164">     var dl = this._dlList[row];</span>
<a href="#l4.165"></a><span id="l4.165">     if (dl.currBytes != aDownload.amountTransferred) {</span>
<a href="#l4.166"></a><span id="l4.166" class="difflineat">@@ -332,26 +334,27 @@ DownloadTreeView.prototype = {</span>
<a href="#l4.167"></a><span id="l4.167">     this._tree.invalidateRow(row);</span>
<a href="#l4.168"></a><span id="l4.168"> </span>
<a href="#l4.169"></a><span id="l4.169">     // Data has changed, so re-sorting might be needed</span>
<a href="#l4.170"></a><span id="l4.170">     this.sortView(&quot;&quot;, &quot;&quot;, dl, row);</span>
<a href="#l4.171"></a><span id="l4.171"> </span>
<a href="#l4.172"></a><span id="l4.172">     window.updateCommands(&quot;tree-select&quot;);</span>
<a href="#l4.173"></a><span id="l4.173">   },</span>
<a href="#l4.174"></a><span id="l4.174"> </span>
<a href="#l4.175"></a><span id="l4.175" class="difflineminus">-  removeDownload: function(aDownloadID) {</span>
<a href="#l4.176"></a><span id="l4.176" class="difflineminus">-    var row = this._getIdxForID(aDownloadID);</span>
<a href="#l4.177"></a><span id="l4.177" class="difflineplus">+  removeDownload: function(aGUID) {</span>
<a href="#l4.178"></a><span id="l4.178" class="difflineplus">+    var row = this._getIdxForGUID(aGUID);</span>
<a href="#l4.179"></a><span id="l4.179">     // Make sure we have an item to remove</span>
<a href="#l4.180"></a><span id="l4.180">     if (row &lt; 0) return;</span>
<a href="#l4.181"></a><span id="l4.181"> </span>
<a href="#l4.182"></a><span id="l4.182">     var index = this.selection.currentIndex;</span>
<a href="#l4.183"></a><span id="l4.183">     var wasSingleSelection = this.selection.count == 1;</span>
<a href="#l4.184"></a><span id="l4.184"> </span>
<a href="#l4.185"></a><span id="l4.185">     // Remove data from the download list</span>
<a href="#l4.186"></a><span id="l4.186">     this._dlList.splice(row, 1);</span>
<a href="#l4.187"></a><span id="l4.187" class="difflineplus">+    delete this._dlMap[aGUID];</span>
<a href="#l4.188"></a><span id="l4.188"> </span>
<a href="#l4.189"></a><span id="l4.189">     // Tell the tree we removed 1 row at the given row index</span>
<a href="#l4.190"></a><span id="l4.190">     this._tree.rowCountChanged(row, -1);</span>
<a href="#l4.191"></a><span id="l4.191"> </span>
<a href="#l4.192"></a><span id="l4.192">     // Update selection if only removed download was selected</span>
<a href="#l4.193"></a><span id="l4.193">     if (wasSingleSelection &amp;&amp; this.selection.count == 0) {</span>
<a href="#l4.194"></a><span id="l4.194">       index = Math.min(index, this.rowCount - 1);</span>
<a href="#l4.195"></a><span id="l4.195">       if (index &gt;= 0)</span>
<a href="#l4.196"></a><span id="l4.196" class="difflineat">@@ -363,105 +366,120 @@ DownloadTreeView.prototype = {</span>
<a href="#l4.197"></a><span id="l4.197"> </span>
<a href="#l4.198"></a><span id="l4.198">   initTree: function() {</span>
<a href="#l4.199"></a><span id="l4.199">     if (!this._tree)</span>
<a href="#l4.200"></a><span id="l4.200">       return</span>
<a href="#l4.201"></a><span id="l4.201">     // We're resetting the whole list, either because we're creating the tree</span>
<a href="#l4.202"></a><span id="l4.202">     // or because we need to recreate it</span>
<a href="#l4.203"></a><span id="l4.203">     this._tree.beginUpdateBatch();</span>
<a href="#l4.204"></a><span id="l4.204">     this._dlList = [];</span>
<a href="#l4.205"></a><span id="l4.205" class="difflineplus">+    this._dlMap = {};</span>
<a href="#l4.206"></a><span id="l4.206">     this._lastListIndex = 0;</span>
<a href="#l4.207"></a><span id="l4.207"> </span>
<a href="#l4.208"></a><span id="l4.208">     this.selection.clearSelection();</span>
<a href="#l4.209"></a><span id="l4.209"> </span>
<a href="#l4.210"></a><span id="l4.210">     // sort in reverse and prepend to the list to get continuous list indexes</span>
<a href="#l4.211"></a><span id="l4.211">     // with increasing negative numbers for default-sort in ascending order</span>
<a href="#l4.212"></a><span id="l4.212">     var statement = this._dm.DBConnection.createStatement(</span>
<a href="#l4.213"></a><span id="l4.213" class="difflineminus">-      &quot;SELECT id, target, name, source, state, startTime, endTime, referrer, &quot; +</span>
<a href="#l4.214"></a><span id="l4.214" class="difflineminus">-            &quot;currBytes, maxBytes, state IN (?1, ?2, ?3, ?4, ?5) AS isActive &quot; +</span>
<a href="#l4.215"></a><span id="l4.215" class="difflineplus">+      &quot;SELECT guid, target, name, source, state, startTime, endTime, referrer&quot; +</span>
<a href="#l4.216"></a><span id="l4.216" class="difflineplus">+           &quot;, currBytes, maxBytes, state IN (?1, ?2, ?3, ?4, ?5) AS isActive &quot; +</span>
<a href="#l4.217"></a><span id="l4.217">       &quot;FROM moz_downloads &quot; +</span>
<a href="#l4.218"></a><span id="l4.218">       &quot;ORDER BY isActive ASC, endTime ASC, startTime ASC, id DESC&quot;);</span>
<a href="#l4.219"></a><span id="l4.219"> </span>
<a href="#l4.220"></a><span id="l4.220">     statement.bindByIndex(0, nsIDownloadManager.DOWNLOAD_NOTSTARTED);</span>
<a href="#l4.221"></a><span id="l4.221">     statement.bindByIndex(1, nsIDownloadManager.DOWNLOAD_DOWNLOADING);</span>
<a href="#l4.222"></a><span id="l4.222">     statement.bindByIndex(2, nsIDownloadManager.DOWNLOAD_PAUSED);</span>
<a href="#l4.223"></a><span id="l4.223">     statement.bindByIndex(3, nsIDownloadManager.DOWNLOAD_QUEUED);</span>
<a href="#l4.224"></a><span id="l4.224">     statement.bindByIndex(4, nsIDownloadManager.DOWNLOAD_SCANNING);</span>
<a href="#l4.225"></a><span id="l4.225"> </span>
<a href="#l4.226"></a><span id="l4.226">     while (statement.executeStep()) {</span>
<a href="#l4.227"></a><span id="l4.227">       // Try to get the attribute values from the statement</span>
<a href="#l4.228"></a><span id="l4.228">       let attrs = {</span>
<a href="#l4.229"></a><span id="l4.229" class="difflineminus">-        dlid: statement.getInt64(0),</span>
<a href="#l4.230"></a><span id="l4.230" class="difflineplus">+        guid: statement.getString(0),</span>
<a href="#l4.231"></a><span id="l4.231">         file: statement.getString(1),</span>
<a href="#l4.232"></a><span id="l4.232">         target: statement.getString(2),</span>
<a href="#l4.233"></a><span id="l4.233">         uri: statement.getString(3),</span>
<a href="#l4.234"></a><span id="l4.234">         state: statement.getInt32(4),</span>
<a href="#l4.235"></a><span id="l4.235" class="difflineplus">+        progress: 100,</span>
<a href="#l4.236"></a><span id="l4.236" class="difflineplus">+        progressMode: nsITreeView.PROGRESS_NONE,</span>
<a href="#l4.237"></a><span id="l4.237" class="difflineplus">+        resumable: false,</span>
<a href="#l4.238"></a><span id="l4.238">         startTime: Math.round(statement.getInt64(5) / 1000),</span>
<a href="#l4.239"></a><span id="l4.239">         endTime: Math.round(statement.getInt64(6) / 1000),</span>
<a href="#l4.240"></a><span id="l4.240">         referrer: statement.getString(7),</span>
<a href="#l4.241"></a><span id="l4.241">         currBytes: statement.getInt64(8),</span>
<a href="#l4.242"></a><span id="l4.242">         maxBytes: statement.getInt64(9),</span>
<a href="#l4.243"></a><span id="l4.243" class="difflineplus">+        isActive: statement.getInt32(10),</span>
<a href="#l4.244"></a><span id="l4.244">         lastSec: Infinity, // For calculations of remaining time</span>
<a href="#l4.245"></a><span id="l4.245" class="difflineplus">+        dld: null</span>
<a href="#l4.246"></a><span id="l4.246">       };</span>
<a href="#l4.247"></a><span id="l4.247"> </span>
<a href="#l4.248"></a><span id="l4.248" class="difflineminus">-      // If the download is active, grab the real progress, otherwise default 100</span>
<a href="#l4.249"></a><span id="l4.249" class="difflineminus">-      attrs.isActive = statement.getInt32(10);</span>
<a href="#l4.250"></a><span id="l4.250" class="difflineminus">-      if (attrs.isActive) {</span>
<a href="#l4.251"></a><span id="l4.251" class="difflineminus">-        let dld = this._dm.getDownload(attrs.dlid);</span>
<a href="#l4.252"></a><span id="l4.252" class="difflineminus">-        attrs.progress = dld.percentComplete;</span>
<a href="#l4.253"></a><span id="l4.253" class="difflineminus">-        attrs.progressMode = attrs.progress == -1 ?</span>
<a href="#l4.254"></a><span id="l4.254" class="difflineminus">-                             nsITreeView.PROGRESS_UNDETERMINED :</span>
<a href="#l4.255"></a><span id="l4.255" class="difflineminus">-                             nsITreeView.PROGRESS_NORMAL;</span>
<a href="#l4.256"></a><span id="l4.256" class="difflineminus">-        attrs.resumable = dld.resumable;</span>
<a href="#l4.257"></a><span id="l4.257" class="difflineminus">-      }</span>
<a href="#l4.258"></a><span id="l4.258" class="difflineminus">-      else {</span>
<a href="#l4.259"></a><span id="l4.259" class="difflineminus">-        attrs.progress = 100;</span>
<a href="#l4.260"></a><span id="l4.260" class="difflineminus">-        attrs.progressMode = nsITreeView.PROGRESS_NONE;</span>
<a href="#l4.261"></a><span id="l4.261" class="difflineminus">-        attrs.resumable = false;</span>
<a href="#l4.262"></a><span id="l4.262" class="difflineminus">-      }</span>
<a href="#l4.263"></a><span id="l4.263" class="difflineminus">-</span>
<a href="#l4.264"></a><span id="l4.264">       // Only actually add item to the tree if it's active or matching search</span>
<a href="#l4.265"></a><span id="l4.265" class="difflineminus">-</span>
<a href="#l4.266"></a><span id="l4.266">       let matchSearch = true;</span>
<a href="#l4.267"></a><span id="l4.267">       if (this._searchTerms) {</span>
<a href="#l4.268"></a><span id="l4.268">         // Search through the download attributes that are shown to the user and</span>
<a href="#l4.269"></a><span id="l4.269">         // make it into one big string for easy combined searching</span>
<a href="#l4.270"></a><span id="l4.270">         // XXX: toolkit uses the target, status and dateTime attributes of their XBL item</span>
<a href="#l4.271"></a><span id="l4.271">         let combinedSearch = attrs.file.toLowerCase() + &quot; &quot; + attrs.uri.toLowerCase();</span>
<a href="#l4.272"></a><span id="l4.272">         if (attrs.target)</span>
<a href="#l4.273"></a><span id="l4.273">           combinedSearch = combinedSearch + &quot; &quot; + attrs.target.toLowerCase();</span>
<a href="#l4.274"></a><span id="l4.274"> </span>
<a href="#l4.275"></a><span id="l4.275">         if (!attrs.isActive)</span>
<a href="#l4.276"></a><span id="l4.276" class="difflineminus">-          for each (let term in this._searchTerms)</span>
<a href="#l4.277"></a><span id="l4.277" class="difflineplus">+          for (let term of this._searchTerms)</span>
<a href="#l4.278"></a><span id="l4.278">             if (combinedSearch.indexOf(term) == -1)</span>
<a href="#l4.279"></a><span id="l4.279">               matchSearch = false;</span>
<a href="#l4.280"></a><span id="l4.280">       }</span>
<a href="#l4.281"></a><span id="l4.281"> </span>
<a href="#l4.282"></a><span id="l4.282">       // matchSearch is always true for active downloads, see above</span>
<a href="#l4.283"></a><span id="l4.283">       if (matchSearch) {</span>
<a href="#l4.284"></a><span id="l4.284">         attrs.listIndex = this._lastListIndex--;</span>
<a href="#l4.285"></a><span id="l4.285">         this._dlList.unshift(attrs);</span>
<a href="#l4.286"></a><span id="l4.286" class="difflineplus">+        this._dlMap[attrs.guid] = attrs;</span>
<a href="#l4.287"></a><span id="l4.287">       }</span>
<a href="#l4.288"></a><span id="l4.288">     }</span>
<a href="#l4.289"></a><span id="l4.289">     statement.finalize();</span>
<a href="#l4.290"></a><span id="l4.290" class="difflineplus">+    // now read active downloads</span>
<a href="#l4.291"></a><span id="l4.291" class="difflineplus">+    var downloads = this._dm.activeDownloads;</span>
<a href="#l4.292"></a><span id="l4.292" class="difflineplus">+    while (downloads.hasMoreElements()) {</span>
<a href="#l4.293"></a><span id="l4.293" class="difflineplus">+      let dld = downloads.getNext()</span>
<a href="#l4.294"></a><span id="l4.294" class="difflineplus">+                         .QueryInterface(Components.interfaces.nsIDownload);</span>
<a href="#l4.295"></a><span id="l4.295" class="difflineplus">+      if (dld.guid in this._dlMap) {</span>
<a href="#l4.296"></a><span id="l4.296" class="difflineplus">+        var dl = this._dlMap[dld.guid];</span>
<a href="#l4.297"></a><span id="l4.297" class="difflineplus">+        dl.progress = dld.percentComplete;</span>
<a href="#l4.298"></a><span id="l4.298" class="difflineplus">+        dl.progressMode = dl.progress == -1 ?</span>
<a href="#l4.299"></a><span id="l4.299" class="difflineplus">+                          nsITreeView.PROGRESS_UNDETERMINED :</span>
<a href="#l4.300"></a><span id="l4.300" class="difflineplus">+                          nsITreeView.PROGRESS_NORMAL;</span>
<a href="#l4.301"></a><span id="l4.301" class="difflineplus">+        dl.resumable = dld.resumable;</span>
<a href="#l4.302"></a><span id="l4.302" class="difflineplus">+        dl.dld = dld;</span>
<a href="#l4.303"></a><span id="l4.303" class="difflineplus">+      }</span>
<a href="#l4.304"></a><span id="l4.304" class="difflineplus">+    }</span>
<a href="#l4.305"></a><span id="l4.305">     // find sorted column and sort the tree</span>
<a href="#l4.306"></a><span id="l4.306">     var sortedColumn = this._tree.columns.getSortedColumn();</span>
<a href="#l4.307"></a><span id="l4.307">     if (sortedColumn) {</span>
<a href="#l4.308"></a><span id="l4.308">       var direction = sortedColumn.element.getAttribute(&quot;sortDirection&quot;);</span>
<a href="#l4.309"></a><span id="l4.309">       this.sortView(sortedColumn.id, direction);</span>
<a href="#l4.310"></a><span id="l4.310">     }</span>
<a href="#l4.311"></a><span id="l4.311">     this._tree.endUpdateBatch();</span>
<a href="#l4.312"></a><span id="l4.312"> </span>
<a href="#l4.313"></a><span id="l4.313">     window.updateCommands(&quot;tree-select&quot;);</span>
<a href="#l4.314"></a><span id="l4.314"> </span>
<a href="#l4.315"></a><span id="l4.315" class="difflineplus">+    // ask for nsIDownload objects for finished downloads</span>
<a href="#l4.316"></a><span id="l4.316" class="difflineplus">+    for (let dl of this._dlList)</span>
<a href="#l4.317"></a><span id="l4.317" class="difflineplus">+      if (!dl.dld)</span>
<a href="#l4.318"></a><span id="l4.318" class="difflineplus">+        this._dm.getDownloadByGUID(dl.guid, this);</span>
<a href="#l4.319"></a><span id="l4.319" class="difflineplus">+</span>
<a href="#l4.320"></a><span id="l4.320">     // Send a notification that we finished</span>
<a href="#l4.321"></a><span id="l4.321">     setTimeout(function()</span>
<a href="#l4.322"></a><span id="l4.322">       Services.obs.notifyObservers(window, &quot;download-manager-ui-done&quot;, null), 0);</span>
<a href="#l4.323"></a><span id="l4.323">   },</span>
<a href="#l4.324"></a><span id="l4.324"> </span>
<a href="#l4.325"></a><span id="l4.325" class="difflineplus">+  handleResult: function(aStatus, aDownload) {</span>
<a href="#l4.326"></a><span id="l4.326" class="difflineplus">+    if (aDownload)</span>
<a href="#l4.327"></a><span id="l4.327" class="difflineplus">+      this._dlMap[aDownload.guid].dld = aDownload;</span>
<a href="#l4.328"></a><span id="l4.328" class="difflineplus">+  },</span>
<a href="#l4.329"></a><span id="l4.329" class="difflineplus">+</span>
<a href="#l4.330"></a><span id="l4.330">   searchView: function(aInput) {</span>
<a href="#l4.331"></a><span id="l4.331">     // Stringify the previous search</span>
<a href="#l4.332"></a><span id="l4.332">     var prevSearch = this._searchTerms.join(&quot; &quot;);</span>
<a href="#l4.333"></a><span id="l4.333"> </span>
<a href="#l4.334"></a><span id="l4.334">     // Array of space-separated lower-case search terms</span>
<a href="#l4.335"></a><span id="l4.335">     this._searchTerms = aInput.trim().toLowerCase().split(/\s+/);</span>
<a href="#l4.336"></a><span id="l4.336"> </span>
<a href="#l4.337"></a><span id="l4.337">     // Don't rebuild the download list if the search didn't change</span>
<a href="#l4.338"></a><span id="l4.338" class="difflineat">@@ -604,22 +622,19 @@ DownloadTreeView.prototype = {</span>
<a href="#l4.339"></a><span id="l4.339">     if (!this.__dateService) {</span>
<a href="#l4.340"></a><span id="l4.340">       this.__dateService = Components.classes[&quot;@mozilla.org/intl/scriptabledateformat;1&quot;]</span>
<a href="#l4.341"></a><span id="l4.341">                                      .getService(Components.interfaces.nsIScriptableDateFormat);</span>
<a href="#l4.342"></a><span id="l4.342">     }</span>
<a href="#l4.343"></a><span id="l4.343">     return this.__dateService;</span>
<a href="#l4.344"></a><span id="l4.344">   },</span>
<a href="#l4.345"></a><span id="l4.345"> </span>
<a href="#l4.346"></a><span id="l4.346">   // Get array index in _dlList for a given download ID</span>
<a href="#l4.347"></a><span id="l4.347" class="difflineminus">-  _getIdxForID: function(aDlID) {</span>
<a href="#l4.348"></a><span id="l4.348" class="difflineminus">-    var len = this._dlList.length;</span>
<a href="#l4.349"></a><span id="l4.349" class="difflineminus">-    for (let idx = 0; idx &lt; len; idx++) {</span>
<a href="#l4.350"></a><span id="l4.350" class="difflineminus">-      if (this._dlList[idx].dlid == aDlID)</span>
<a href="#l4.351"></a><span id="l4.351" class="difflineminus">-        return idx;</span>
<a href="#l4.352"></a><span id="l4.352" class="difflineminus">-    }</span>
<a href="#l4.353"></a><span id="l4.353" class="difflineplus">+  _getIdxForGUID: function(aGUID) {</span>
<a href="#l4.354"></a><span id="l4.354" class="difflineplus">+    if (aGUID in this._dlMap)</span>
<a href="#l4.355"></a><span id="l4.355" class="difflineplus">+      return this._dlList.indexOf(this._dlMap[aGUID]);</span>
<a href="#l4.356"></a><span id="l4.356">     return -1;</span>
<a href="#l4.357"></a><span id="l4.357">   },</span>
<a href="#l4.358"></a><span id="l4.358"> </span>
<a href="#l4.359"></a><span id="l4.359">   // Cache IDs of selected downloads for later restoration</span>
<a href="#l4.360"></a><span id="l4.360">   _cacheSelection: function() {</span>
<a href="#l4.361"></a><span id="l4.361">     // Abort if there's already something cached</span>
<a href="#l4.362"></a><span id="l4.362">     if (this._selectionCache)</span>
<a href="#l4.363"></a><span id="l4.363">       return;</span>
<a href="#l4.364"></a><span id="l4.364" class="difflineat">@@ -630,31 +645,31 @@ DownloadTreeView.prototype = {</span>
<a href="#l4.365"></a><span id="l4.365"> </span>
<a href="#l4.366"></a><span id="l4.366">     // Walk all selected rows and cache theior download IDs</span>
<a href="#l4.367"></a><span id="l4.367">     var start = {};</span>
<a href="#l4.368"></a><span id="l4.368">     var end = {};</span>
<a href="#l4.369"></a><span id="l4.369">     var numRanges = this.selection.getRangeCount();</span>
<a href="#l4.370"></a><span id="l4.370">     for (let rg = 0; rg &lt; numRanges; rg++){</span>
<a href="#l4.371"></a><span id="l4.371">       this.selection.getRangeAt(rg, start, end);</span>
<a href="#l4.372"></a><span id="l4.372">       for (let row = start.value; row &lt;= end.value; row++){</span>
<a href="#l4.373"></a><span id="l4.373" class="difflineminus">-        this._selectionCache.push(this._dlList[row].dlid);</span>
<a href="#l4.374"></a><span id="l4.374" class="difflineplus">+        this._selectionCache.push(this._dlList[row].guid);</span>
<a href="#l4.375"></a><span id="l4.375">       }</span>
<a href="#l4.376"></a><span id="l4.376">     }</span>
<a href="#l4.377"></a><span id="l4.377">   },</span>
<a href="#l4.378"></a><span id="l4.378"> </span>
<a href="#l4.379"></a><span id="l4.379">   // Restore selection from cached IDs (as possible)</span>
<a href="#l4.380"></a><span id="l4.380">   _restoreSelection: function() {</span>
<a href="#l4.381"></a><span id="l4.381">     // Abort if the cache is empty</span>
<a href="#l4.382"></a><span id="l4.382">     if (!this._selectionCache)</span>
<a href="#l4.383"></a><span id="l4.383">       return;</span>
<a href="#l4.384"></a><span id="l4.384"> </span>
<a href="#l4.385"></a><span id="l4.385">     this.selection.clearSelection();</span>
<a href="#l4.386"></a><span id="l4.386" class="difflineminus">-    for each (let dlid in this._selectionCache) {</span>
<a href="#l4.387"></a><span id="l4.387" class="difflineplus">+    for (let guid of this._selectionCache) {</span>
<a href="#l4.388"></a><span id="l4.388">       // Find out what row this is now and if possible, add it to the selection</span>
<a href="#l4.389"></a><span id="l4.389" class="difflineminus">-      var row = this._getIdxForID(dlid);</span>
<a href="#l4.390"></a><span id="l4.390" class="difflineplus">+      var row = this._getIdxForGUID(guid);</span>
<a href="#l4.391"></a><span id="l4.391">       if (row != -1)</span>
<a href="#l4.392"></a><span id="l4.392">         this.selection.rangedSelect(row, row, true);</span>
<a href="#l4.393"></a><span id="l4.393">     }</span>
<a href="#l4.394"></a><span id="l4.394">     // Work done, clear the cache</span>
<a href="#l4.395"></a><span id="l4.395">     this._selectionCache = null;</span>
<a href="#l4.396"></a><span id="l4.396">   },</span>
<a href="#l4.397"></a><span id="l4.397"> </span>
<a href="#l4.398"></a><span id="l4.398">   _convertTimeToString: function(aTime) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/suite/common/pref/pref-download.xul</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/suite/common/pref/pref-download.xul</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -11,22 +11,22 @@</span>
<a href="#l5.4"></a><span id="l5.4"> ]&gt;</span>
<a href="#l5.5"></a><span id="l5.5"> </span>
<a href="#l5.6"></a><span id="l5.6"> &lt;overlay xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;&gt;</span>
<a href="#l5.7"></a><span id="l5.7">   &lt;prefpane id=&quot;download_pane&quot;</span>
<a href="#l5.8"></a><span id="l5.8">             label=&quot;&amp;pref.download.title;&quot;</span>
<a href="#l5.9"></a><span id="l5.9">             script=&quot;chrome://communicator/content/pref/pref-download.js&quot;&gt;</span>
<a href="#l5.10"></a><span id="l5.10"> </span>
<a href="#l5.11"></a><span id="l5.11">     &lt;preferences&gt;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+      &lt;preference id=&quot;browser.download.manager.behavior&quot;</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+                  name=&quot;browser.download.manager.behavior&quot;</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+                  type=&quot;int&quot;/&gt;</span>
<a href="#l5.15"></a><span id="l5.15">       &lt;preference id=&quot;browser.download.manager.focusWhenStarting&quot;</span>
<a href="#l5.16"></a><span id="l5.16">                   name=&quot;browser.download.manager.focusWhenStarting&quot;</span>
<a href="#l5.17"></a><span id="l5.17">                   type=&quot;bool&quot; inverted=&quot;true&quot;/&gt;</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineminus">-      &lt;preference id=&quot;browser.download.manager.behavior&quot;</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineminus">-                  name=&quot;browser.download.manager.behavior&quot;</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineminus">-                  type=&quot;int&quot;/&gt;</span>
<a href="#l5.21"></a><span id="l5.21">       &lt;preference id=&quot;browser.download.useDownloadDir&quot;</span>
<a href="#l5.22"></a><span id="l5.22">                   name=&quot;browser.download.useDownloadDir&quot;</span>
<a href="#l5.23"></a><span id="l5.23">                   type=&quot;bool&quot;/&gt;</span>
<a href="#l5.24"></a><span id="l5.24">       &lt;preference id=&quot;browser.download.dir&quot;</span>
<a href="#l5.25"></a><span id="l5.25">                   name=&quot;browser.download.dir&quot;</span>
<a href="#l5.26"></a><span id="l5.26">                   type=&quot;file&quot;/&gt;</span>
<a href="#l5.27"></a><span id="l5.27">       &lt;preference id=&quot;browser.download.folderList&quot;</span>
<a href="#l5.28"></a><span id="l5.28">                   name=&quot;browser.download.folderList&quot;</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineat">@@ -44,33 +44,33 @@</span>
<a href="#l5.30"></a><span id="l5.30">                   type=&quot;bool&quot;/&gt;</span>
<a href="#l5.31"></a><span id="l5.31">       &lt;preference id=&quot;browser.download.finished_sound_url&quot;</span>
<a href="#l5.32"></a><span id="l5.32">                   name=&quot;browser.download.finished_sound_url&quot;</span>
<a href="#l5.33"></a><span id="l5.33">                   type=&quot;string&quot;/&gt;</span>
<a href="#l5.34"></a><span id="l5.34">     &lt;/preferences&gt;</span>
<a href="#l5.35"></a><span id="l5.35"> </span>
<a href="#l5.36"></a><span id="l5.36">     &lt;groupbox&gt;</span>
<a href="#l5.37"></a><span id="l5.37">       &lt;caption label=&quot;&amp;downloadBehavior.label;&quot;/&gt;</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineminus">-      &lt;checkbox id=&quot;focusWhenStarting&quot;</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineminus">-                label=&quot;&amp;focusWhenStarting.label;&quot;</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineminus">-                preference=&quot;browser.download.manager.focusWhenStarting&quot;</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineminus">-                accesskey=&quot;&amp;focusWhenStarting.accesskey;&quot;/&gt;</span>
<a href="#l5.42"></a><span id="l5.42">       &lt;radiogroup id=&quot;downloadBehavior&quot;</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineminus">-                  class=&quot;indent&quot;</span>
<a href="#l5.44"></a><span id="l5.44">                   preference=&quot;browser.download.manager.behavior&quot;&gt;</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineplus">+        &lt;radio value=&quot;2&quot;</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineplus">+               label=&quot;&amp;doNothing.label;&quot;</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineplus">+               accesskey=&quot;&amp;doNothing.accesskey;&quot;/&gt;</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineplus">+        &lt;radio value=&quot;1&quot;</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineplus">+               label=&quot;&amp;openProgressDialog.label;&quot;</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineplus">+               accesskey=&quot;&amp;openProgressDialog.accesskey;&quot;/&gt;</span>
<a href="#l5.51"></a><span id="l5.51">         &lt;radio value=&quot;0&quot;</span>
<a href="#l5.52"></a><span id="l5.52">                label=&quot;&amp;openDM.label;&quot;</span>
<a href="#l5.53"></a><span id="l5.53">                accesskey=&quot;&amp;openDM.accesskey;&quot;/&gt;</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineminus">-        &lt;radio value=&quot;1&quot;</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineminus">-               label=&quot;&amp;openProgressDialog.label;&quot;</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineminus">-               accesskey=&quot;&amp;openProgressDialog.accesskey;&quot;/&gt;</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineminus">-        &lt;radio value=&quot;2&quot;</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineminus">-               label=&quot;&amp;doNothing.label;&quot;</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineminus">-               accesskey=&quot;&amp;doNothing.accesskey;&quot;/&gt;</span>
<a href="#l5.60"></a><span id="l5.60">       &lt;/radiogroup&gt;</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineplus">+      &lt;checkbox id=&quot;focusWhenStarting&quot;</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineplus">+                class=&quot;indent&quot;</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineplus">+                preference=&quot;browser.download.manager.focusWhenStarting&quot;</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineplus">+                label=&quot;&amp;flashWhenOpen.label;&quot;</span>
<a href="#l5.65"></a><span id="l5.65" class="difflineplus">+                accesskey=&quot;&amp;flashWhenOpen.accesskey;&quot;/&gt;</span>
<a href="#l5.66"></a><span id="l5.66">     &lt;/groupbox&gt;</span>
<a href="#l5.67"></a><span id="l5.67"> </span>
<a href="#l5.68"></a><span id="l5.68">     &lt;groupbox&gt;</span>
<a href="#l5.69"></a><span id="l5.69">       &lt;caption label=&quot;&amp;downloadLocation.label;&quot;/&gt;</span>
<a href="#l5.70"></a><span id="l5.70">       &lt;radiogroup id=&quot;saveWhere&quot;</span>
<a href="#l5.71"></a><span id="l5.71">                   preference=&quot;browser.download.useDownloadDir&quot;</span>
<a href="#l5.72"></a><span id="l5.72">                   onsyncfrompreference=&quot;return document.getElementById('download_pane').ReadUseDownloadDir();&quot;&gt;</span>
<a href="#l5.73"></a><span id="l5.73">         &lt;hbox id=&quot;saveToRow&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/suite/common/public/nsISuiteDownloadManagerUI.idl</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/suite/common/public/nsISuiteDownloadManagerUI.idl</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -1,17 +1,19 @@</span>
<a href="#l6.4"></a><span id="l6.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l6.5"></a><span id="l6.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l6.6"></a><span id="l6.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l6.7"></a><span id="l6.7"> </span>
<a href="#l6.8"></a><span id="l6.8"> #include &quot;nsISupports.idl&quot;</span>
<a href="#l6.9"></a><span id="l6.9"> #include &quot;nsIDownloadManagerUI.idl&quot;</span>
<a href="#l6.10"></a><span id="l6.10" class="difflineplus">+interface nsIDOMWindow;</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-[scriptable, uuid(b2180611-e56e-4831-9770-15a53aacb36a)]</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+[scriptable, uuid(23e0112d-2924-4e74-8886-157b60c4af24)]</span>
<a href="#l6.14"></a><span id="l6.14"> interface nsISuiteDownloadManagerUI : nsIDownloadManagerUI</span>
<a href="#l6.15"></a><span id="l6.15"> {</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+  readonly attribute nsIDOMWindow recentWindow;</span>
<a href="#l6.17"></a><span id="l6.17">   void showManager([optional] in nsIInterfaceRequestor aWindowContext,</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineminus">-                    [optional] in unsigned long aID,</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineminus">-                    [optional] in short aReason);</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineplus">+                   [optional] in nsIDownload aDownload,</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineplus">+                   [optional] in short aReason);</span>
<a href="#l6.22"></a><span id="l6.22">   void showProgress([optional] in nsIInterfaceRequestor aWindowContext,</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineminus">-                     [optional] in unsigned long aID,</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineminus">-                     [optional] in short aReason);</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineplus">+                    [optional] in nsIDownload aDownload,</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineplus">+                    [optional] in short aReason);</span>
<a href="#l6.27"></a><span id="l6.27"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/suite/common/src/nsSuiteDownloadManagerUI.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/suite/common/src/nsSuiteDownloadManagerUI.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -7,121 +7,114 @@ Components.utils.import(&quot;resource://gre/</span>
<a href="#l7.4"></a><span id="l7.4"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l7.5"></a><span id="l7.5"> //// Constants</span>
<a href="#l7.6"></a><span id="l7.6"> </span>
<a href="#l7.7"></a><span id="l7.7"> const Cc = Components.classes;</span>
<a href="#l7.8"></a><span id="l7.8"> const Ci = Components.interfaces;</span>
<a href="#l7.9"></a><span id="l7.9"> const Cr = Components.results;</span>
<a href="#l7.10"></a><span id="l7.10"> const TOOLKIT_MANAGER_URL = &quot;chrome://mozapps/content/downloads/downloads.xul&quot;;</span>
<a href="#l7.11"></a><span id="l7.11"> const DOWNLOAD_MANAGER_URL = &quot;chrome://communicator/content/downloads/downloadmanager.xul&quot;;</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+const PREF_FOCUS_WHEN_STARTING = &quot;browser.download.manager.focusWhenStarting&quot;;</span>
<a href="#l7.13"></a><span id="l7.13"> const PREF_FLASH_COUNT = &quot;browser.download.manager.flashCount&quot;;</span>
<a href="#l7.14"></a><span id="l7.14"> const PREF_DM_BEHAVIOR = &quot;browser.download.manager.behavior&quot;;</span>
<a href="#l7.15"></a><span id="l7.15"> const PREF_FORCE_TOOLKIT_UI = &quot;browser.download.manager.useToolkitUI&quot;;</span>
<a href="#l7.16"></a><span id="l7.16"> </span>
<a href="#l7.17"></a><span id="l7.17"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l7.18"></a><span id="l7.18"> //// nsDownloadManagerUI class</span>
<a href="#l7.19"></a><span id="l7.19"> </span>
<a href="#l7.20"></a><span id="l7.20"> function nsDownloadManagerUI() {}</span>
<a href="#l7.21"></a><span id="l7.21"> </span>
<a href="#l7.22"></a><span id="l7.22"> nsDownloadManagerUI.prototype = {</span>
<a href="#l7.23"></a><span id="l7.23">   classID: Components.ID(&quot;{08bbb4af-7bff-4b16-8ff7-d62f3ec5aa0c}&quot;),</span>
<a href="#l7.24"></a><span id="l7.24"> </span>
<a href="#l7.25"></a><span id="l7.25">   //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l7.26"></a><span id="l7.26">   //// nsIDownloadManagerUI</span>
<a href="#l7.27"></a><span id="l7.27"> </span>
<a href="#l7.28"></a><span id="l7.28" class="difflineminus">-  show: function show(aWindowContext, aID, aReason)</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineplus">+  show: function show(aWindowContext, aDownload, aReason, aUsePrivateUI)</span>
<a href="#l7.30"></a><span id="l7.30">   {</span>
<a href="#l7.31"></a><span id="l7.31">     var behavior = 0;</span>
<a href="#l7.32"></a><span id="l7.32">     if (aReason != Ci.nsIDownloadManagerUI.REASON_USER_INTERACTED) {</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineminus">-      try {</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineplus">+      if (aUsePrivateUI)</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineplus">+        behavior = 1;</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+      else try {</span>
<a href="#l7.37"></a><span id="l7.37">         var prefs = Cc[&quot;@mozilla.org/preferences-service;1&quot;].</span>
<a href="#l7.38"></a><span id="l7.38">                     getService(Ci.nsIPrefBranch);</span>
<a href="#l7.39"></a><span id="l7.39">         behavior = prefs.getIntPref(PREF_DM_BEHAVIOR);</span>
<a href="#l7.40"></a><span id="l7.40">         if (prefs.getBoolPref(PREF_FORCE_TOOLKIT_UI))</span>
<a href="#l7.41"></a><span id="l7.41">           behavior = 0; //We are forcing toolkit UI, force manager behavior</span>
<a href="#l7.42"></a><span id="l7.42">       } catch (e) { }</span>
<a href="#l7.43"></a><span id="l7.43">     }</span>
<a href="#l7.44"></a><span id="l7.44"> </span>
<a href="#l7.45"></a><span id="l7.45">     switch (behavior) {</span>
<a href="#l7.46"></a><span id="l7.46">       case 0:</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineminus">-        this.showManager(aWindowContext, aID, aReason);</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineplus">+        this.showManager(aWindowContext, aDownload, aReason);</span>
<a href="#l7.49"></a><span id="l7.49">         break;</span>
<a href="#l7.50"></a><span id="l7.50">       case 1:</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineminus">-        this.showProgress(aWindowContext, aID, aReason);</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineplus">+        this.showProgress(aWindowContext, aDownload, aReason);</span>
<a href="#l7.53"></a><span id="l7.53">     }</span>
<a href="#l7.54"></a><span id="l7.54"> </span>
<a href="#l7.55"></a><span id="l7.55">     return; // No UI for behavior &gt;= 2</span>
<a href="#l7.56"></a><span id="l7.56">   },</span>
<a href="#l7.57"></a><span id="l7.57"> </span>
<a href="#l7.58"></a><span id="l7.58" class="difflineminus">-  get visible() {</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineminus">-    return this.recentWindow != null;</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineminus">-  },</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineplus">+  visible: false, // needed for private downloads to work</span>
<a href="#l7.62"></a><span id="l7.62"> </span>
<a href="#l7.63"></a><span id="l7.63">   getAttention: function getAttention()</span>
<a href="#l7.64"></a><span id="l7.64">   {</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineminus">-    if (!this.visible)</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineplus">+    var window = this.recentWindow;</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineplus">+    if (!window)</span>
<a href="#l7.68"></a><span id="l7.68">       throw Cr.NS_ERROR_UNEXPECTED;</span>
<a href="#l7.69"></a><span id="l7.69"> </span>
<a href="#l7.70"></a><span id="l7.70">     var prefs = Cc[&quot;@mozilla.org/preferences-service;1&quot;].</span>
<a href="#l7.71"></a><span id="l7.71">                 getService(Ci.nsIPrefBranch);</span>
<a href="#l7.72"></a><span id="l7.72">     // This preference may not be set, so defaulting to two.</span>
<a href="#l7.73"></a><span id="l7.73">     var flashCount = 2;</span>
<a href="#l7.74"></a><span id="l7.74">     try {</span>
<a href="#l7.75"></a><span id="l7.75">       flashCount = prefs.getIntPref(PREF_FLASH_COUNT);</span>
<a href="#l7.76"></a><span id="l7.76">     } catch (e) { }</span>
<a href="#l7.77"></a><span id="l7.77"> </span>
<a href="#l7.78"></a><span id="l7.78" class="difflineminus">-    this.recentWindow.getAttentionWithCycleCount(flashCount);</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineplus">+    window.getAttentionWithCycleCount(flashCount);</span>
<a href="#l7.80"></a><span id="l7.80">   },</span>
<a href="#l7.81"></a><span id="l7.81"> </span>
<a href="#l7.82"></a><span id="l7.82">   //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineminus">-  //// nsDownloadManagerUI</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineplus">+  //// nsISuiteDownloadManagerUI</span>
<a href="#l7.85"></a><span id="l7.85"> </span>
<a href="#l7.86"></a><span id="l7.86">   get recentWindow() {</span>
<a href="#l7.87"></a><span id="l7.87">     var wm = Cc[&quot;@mozilla.org/appshell/window-mediator;1&quot;].</span>
<a href="#l7.88"></a><span id="l7.88">              getService(Ci.nsIWindowMediator);</span>
<a href="#l7.89"></a><span id="l7.89">     return wm.getMostRecentWindow(&quot;Download:Manager&quot;);</span>
<a href="#l7.90"></a><span id="l7.90">   },</span>
<a href="#l7.91"></a><span id="l7.91"> </span>
<a href="#l7.92"></a><span id="l7.92" class="difflineminus">-  //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineminus">-  //// nsISuiteDownloadManagerUI</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineminus">-  showManager: function showManager(aWindowContext, aID, aReason)</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineplus">+  showManager: function showManager(aWindowContext, aDownload, aReason)</span>
<a href="#l7.96"></a><span id="l7.96">   {</span>
<a href="#l7.97"></a><span id="l7.97">     // First we see if it is already visible</span>
<a href="#l7.98"></a><span id="l7.98">     let window = this.recentWindow;</span>
<a href="#l7.99"></a><span id="l7.99">     if (window) {</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineminus">-      window.focus();</span>
<a href="#l7.101"></a><span id="l7.101" class="difflineminus">-</span>
<a href="#l7.102"></a><span id="l7.102" class="difflineminus">-      // If we are being asked to show again, with a user interaction reason,</span>
<a href="#l7.103"></a><span id="l7.103" class="difflineminus">-      // set the appropriate variable.</span>
<a href="#l7.104"></a><span id="l7.104" class="difflineminus">-      if (aReason == Ci.nsIDownloadManagerUI.REASON_USER_INTERACTED)</span>
<a href="#l7.105"></a><span id="l7.105" class="difflineminus">-        window.gUserInteracted = true;</span>
<a href="#l7.106"></a><span id="l7.106" class="difflineplus">+      var prefs = Cc[&quot;@mozilla.org/preferences-service;1&quot;].</span>
<a href="#l7.107"></a><span id="l7.107" class="difflineplus">+                  getService(Ci.nsIPrefBranch);</span>
<a href="#l7.108"></a><span id="l7.108" class="difflineplus">+      var focus = prefs.getBoolPref(PREF_FOCUS_WHEN_STARTING);</span>
<a href="#l7.109"></a><span id="l7.109" class="difflineplus">+      if (focus || aReason == Ci.nsIDownloadManagerUI.REASON_USER_INTERACTED)</span>
<a href="#l7.110"></a><span id="l7.110" class="difflineplus">+        window.focus();</span>
<a href="#l7.111"></a><span id="l7.111" class="difflineplus">+      else</span>
<a href="#l7.112"></a><span id="l7.112" class="difflineplus">+        this.getAttention();</span>
<a href="#l7.113"></a><span id="l7.113">       return;</span>
<a href="#l7.114"></a><span id="l7.114">     }</span>
<a href="#l7.115"></a><span id="l7.115"> </span>
<a href="#l7.116"></a><span id="l7.116">     let parent = null;</span>
<a href="#l7.117"></a><span id="l7.117">     // We try to get a window to use as the parent here.  If we don't have one,</span>
<a href="#l7.118"></a><span id="l7.118">     // the download manager will close immediately after opening if the pref</span>
<a href="#l7.119"></a><span id="l7.119">     // browser.download.manager.closeWhenDone is set to true.</span>
<a href="#l7.120"></a><span id="l7.120">     try {</span>
<a href="#l7.121"></a><span id="l7.121">       if (aWindowContext)</span>
<a href="#l7.122"></a><span id="l7.122">         parent = aWindowContext.getInterface(Ci.nsIDOMWindow);</span>
<a href="#l7.123"></a><span id="l7.123">     } catch (e) { /* it's OK to not have a parent window */ }</span>
<a href="#l7.124"></a><span id="l7.124"> </span>
<a href="#l7.125"></a><span id="l7.125">     // We pass the download manager and the nsIDownload we want selected (if any)</span>
<a href="#l7.126"></a><span id="l7.126">     var params = Cc[&quot;@mozilla.org/array;1&quot;].</span>
<a href="#l7.127"></a><span id="l7.127">                  createInstance(Ci.nsIMutableArray);</span>
<a href="#l7.128"></a><span id="l7.128" class="difflineminus">-</span>
<a href="#l7.129"></a><span id="l7.129" class="difflineminus">-    // Don't fail if our passed in ID is invalid</span>
<a href="#l7.130"></a><span id="l7.130" class="difflineminus">-    var download = null;</span>
<a href="#l7.131"></a><span id="l7.131" class="difflineminus">-    try {</span>
<a href="#l7.132"></a><span id="l7.132" class="difflineminus">-      let dm = Cc[&quot;@mozilla.org/download-manager;1&quot;].</span>
<a href="#l7.133"></a><span id="l7.133" class="difflineminus">-               getService(Ci.nsIDownloadManager);</span>
<a href="#l7.134"></a><span id="l7.134" class="difflineminus">-      download = dm.getDownload(aID);</span>
<a href="#l7.135"></a><span id="l7.135" class="difflineminus">-    } catch (ex) {}</span>
<a href="#l7.136"></a><span id="l7.136" class="difflineminus">-    params.appendElement(download, false);</span>
<a href="#l7.137"></a><span id="l7.137" class="difflineplus">+    params.appendElement(aDownload, false);</span>
<a href="#l7.138"></a><span id="l7.138"> </span>
<a href="#l7.139"></a><span id="l7.139">     // Pass in the reason as well</span>
<a href="#l7.140"></a><span id="l7.140">     let reason = Cc[&quot;@mozilla.org/supports-PRInt16;1&quot;].</span>
<a href="#l7.141"></a><span id="l7.141">                  createInstance(Ci.nsISupportsPRInt16);</span>
<a href="#l7.142"></a><span id="l7.142">     reason.data = aReason;</span>
<a href="#l7.143"></a><span id="l7.143">     params.appendElement(reason, false);</span>
<a href="#l7.144"></a><span id="l7.144"> </span>
<a href="#l7.145"></a><span id="l7.145">     var manager = DOWNLOAD_MANAGER_URL;</span>
<a href="#l7.146"></a><span id="l7.146" class="difflineat">@@ -136,34 +129,33 @@ nsDownloadManagerUI.prototype = {</span>
<a href="#l7.147"></a><span id="l7.147">              getService(Ci.nsIWindowWatcher);</span>
<a href="#l7.148"></a><span id="l7.148">     ww.openWindow(parent,</span>
<a href="#l7.149"></a><span id="l7.149">                   manager,</span>
<a href="#l7.150"></a><span id="l7.150">                   null,</span>
<a href="#l7.151"></a><span id="l7.151">                   &quot;all,dialog=no&quot;,</span>
<a href="#l7.152"></a><span id="l7.152">                   params);</span>
<a href="#l7.153"></a><span id="l7.153">   },</span>
<a href="#l7.154"></a><span id="l7.154"> </span>
<a href="#l7.155"></a><span id="l7.155" class="difflineminus">-  showProgress: function showProgress(aWindowContext, aID, aReason)</span>
<a href="#l7.156"></a><span id="l7.156" class="difflineplus">+  showProgress: function showProgress(aWindowContext, aDownload, aReason)</span>
<a href="#l7.157"></a><span id="l7.157">   {</span>
<a href="#l7.158"></a><span id="l7.158" class="difflineminus">-    var params = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l7.159"></a><span id="l7.159" class="difflineplus">+    // Fail if our passed in download is invalid</span>
<a href="#l7.160"></a><span id="l7.160" class="difflineplus">+    if (!aDownload)</span>
<a href="#l7.161"></a><span id="l7.161" class="difflineplus">+      return;</span>
<a href="#l7.162"></a><span id="l7.162"> </span>
<a href="#l7.163"></a><span id="l7.163">     var parent = null;</span>
<a href="#l7.164"></a><span id="l7.164">     // We try to get a window to use as the parent here.  If we don't have one,</span>
<a href="#l7.165"></a><span id="l7.165">     // the progress window will close immediately after opening if the pref</span>
<a href="#l7.166"></a><span id="l7.166">     // browser.download.manager.closeWhenDone is set to true.</span>
<a href="#l7.167"></a><span id="l7.167">     try {</span>
<a href="#l7.168"></a><span id="l7.168">       if (aWindowContext)</span>
<a href="#l7.169"></a><span id="l7.169">         parent = aWindowContext.getInterface(Ci.nsIDOMWindow);</span>
<a href="#l7.170"></a><span id="l7.170">     } catch (e) { /* it's OK to not have a parent window */ }</span>
<a href="#l7.171"></a><span id="l7.171"> </span>
<a href="#l7.172"></a><span id="l7.172" class="difflineminus">-    // Fail if our passed in ID is invalid</span>
<a href="#l7.173"></a><span id="l7.173" class="difflineminus">-    var download = Cc[&quot;@mozilla.org/download-manager;1&quot;].</span>
<a href="#l7.174"></a><span id="l7.174" class="difflineminus">-                   getService(Ci.nsIDownloadManager).</span>
<a href="#l7.175"></a><span id="l7.175" class="difflineminus">-                   getDownload(aID);</span>
<a href="#l7.176"></a><span id="l7.176" class="difflineminus">-    params.appendElement(download, false);</span>
<a href="#l7.177"></a><span id="l7.177" class="difflineplus">+    var params = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l7.178"></a><span id="l7.178" class="difflineplus">+    params.appendElement(aDownload, false);</span>
<a href="#l7.179"></a><span id="l7.179"> </span>
<a href="#l7.180"></a><span id="l7.180">     // Pass in the reason as well</span>
<a href="#l7.181"></a><span id="l7.181">     let reason = Cc[&quot;@mozilla.org/supports-PRInt16;1&quot;].</span>
<a href="#l7.182"></a><span id="l7.182">                  createInstance(Ci.nsISupportsPRInt16);</span>
<a href="#l7.183"></a><span id="l7.183">     reason.data = aReason;</span>
<a href="#l7.184"></a><span id="l7.184">     params.appendElement(reason, false);</span>
<a href="#l7.185"></a><span id="l7.185"> </span>
<a href="#l7.186"></a><span id="l7.186">     var ww = Cc[&quot;@mozilla.org/embedcomp/window-watcher;1&quot;].</span>
<a href="#l7.187"></a><span id="l7.187" class="difflineat">@@ -179,11 +171,9 @@ nsDownloadManagerUI.prototype = {</span>
<a href="#l7.188"></a><span id="l7.188"> </span>
<a href="#l7.189"></a><span id="l7.189">   QueryInterface: XPCOMUtils.generateQI([Ci.nsIDownloadManagerUI,</span>
<a href="#l7.190"></a><span id="l7.190">                                          Ci.nsISuiteDownloadManagerUI])</span>
<a href="#l7.191"></a><span id="l7.191"> };</span>
<a href="#l7.192"></a><span id="l7.192"> </span>
<a href="#l7.193"></a><span id="l7.193"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l7.194"></a><span id="l7.194"> //// Module</span>
<a href="#l7.195"></a><span id="l7.195"> </span>
<a href="#l7.196"></a><span id="l7.196" class="difflineminus">-let components = [nsDownloadManagerUI];</span>
<a href="#l7.197"></a><span id="l7.197" class="difflineminus">-</span>
<a href="#l7.198"></a><span id="l7.198" class="difflineminus">-var NSGetFactory = XPCOMUtils.generateNSGetFactory(components);</span>
<a href="#l7.199"></a><span id="l7.199" class="difflineplus">+var NSGetFactory = XPCOMUtils.generateNSGetFactory([nsDownloadManagerUI]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/suite/locales/en-US/chrome/common/pref/pref-download.dtd</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/suite/locales/en-US/chrome/common/pref/pref-download.dtd</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -1,23 +1,23 @@</span>
<a href="#l8.4"></a><span id="l8.4"> &lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l8.5"></a><span id="l8.5">    - License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l8.6"></a><span id="l8.6">    - file, You can obtain one at http://mozilla.org/MPL/2.0/. --&gt;</span>
<a href="#l8.7"></a><span id="l8.7"> </span>
<a href="#l8.8"></a><span id="l8.8"> &lt;!ENTITY pref.download.title            &quot;Downloads&quot;&gt;</span>
<a href="#l8.9"></a><span id="l8.9"> </span>
<a href="#l8.10"></a><span id="l8.10"> &lt;!ENTITY downloadBehavior.label         &quot;When starting a download&quot;&gt;</span>
<a href="#l8.11"></a><span id="l8.11" class="difflineminus">-&lt;!ENTITY focusWhenStarting.label        &quot;Flash the download manager if it is already open, otherwise:&quot;&gt;</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-&lt;!ENTITY focusWhenStarting.accesskey    &quot;F&quot;&gt;</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+&lt;!ENTITY doNothing.label                &quot;Don't open anything&quot;&gt;</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+&lt;!ENTITY doNothing.accesskey            &quot;D&quot;&gt;</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+&lt;!ENTITY openProgressDialog.label       &quot;Open a progress dialog&quot;&gt;</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+&lt;!ENTITY openProgressDialog.accesskey   &quot;O&quot;&gt;</span>
<a href="#l8.17"></a><span id="l8.17"> &lt;!ENTITY openDM.label                   &quot;Open the download manager&quot;&gt;</span>
<a href="#l8.18"></a><span id="l8.18"> &lt;!ENTITY openDM.accesskey               &quot;m&quot;&gt;</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineminus">-&lt;!ENTITY openProgressDialog.label       &quot;Open a progress dialog&quot;&gt;</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineminus">-&lt;!ENTITY openProgressDialog.accesskey   &quot;O&quot;&gt;</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineminus">-&lt;!ENTITY doNothing.label                &quot;Don't open anything&quot;&gt;</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineminus">-&lt;!ENTITY doNothing.accesskey            &quot;D&quot;&gt;</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineplus">+&lt;!ENTITY flashWhenOpen.label            &quot;Just flash the download manager if it is already open&quot;&gt;</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineplus">+&lt;!ENTITY flashWhenOpen.accesskey        &quot;f&quot;&gt;</span>
<a href="#l8.25"></a><span id="l8.25"> </span>
<a href="#l8.26"></a><span id="l8.26"> &lt;!ENTITY downloadLocation.label         &quot;When saving a file&quot;&gt;</span>
<a href="#l8.27"></a><span id="l8.27"> &lt;!ENTITY saveTo.label                   &quot;Save files to&quot;&gt;</span>
<a href="#l8.28"></a><span id="l8.28"> &lt;!ENTITY saveTo.accesskey               &quot;v&quot;&gt;</span>
<a href="#l8.29"></a><span id="l8.29"> &lt;!ENTITY chooseDownloadFolder.label     &quot;Choose Folder&quot;&gt;</span>
<a href="#l8.30"></a><span id="l8.30"> &lt;!ENTITY chooseDownloadFolder.accesskey &quot;C&quot;&gt;</span>
<a href="#l8.31"></a><span id="l8.31"> &lt;!ENTITY alwaysAsk.label                &quot;Always ask me where to save files&quot;&gt;</span>
<a href="#l8.32"></a><span id="l8.32"> &lt;!ENTITY alwaysAsk.accesskey            &quot;A&quot;&gt;</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

