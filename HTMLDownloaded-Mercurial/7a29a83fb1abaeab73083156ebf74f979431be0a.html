<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 25092:7a29a83fb1abaeab73083156ebf74f979431be0a</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 7a29a83fb1abaeab73083156ebf74f979431be0a" />
<meta property="og:url" content="/comm-central/rev/7a29a83fb1abaeab73083156ebf74f979431be0a" />
<meta property="og:description" content="Bug 1494764: Ignore missing \n on last line of last chunk. r=jorgk" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 7a29a83fb1abaeab73083156ebf74f979431be0a 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/7a29a83fb1abaeab73083156ebf74f979431be0a">shortlog</a> |
<a href="/comm-central/log/7a29a83fb1abaeab73083156ebf74f979431be0a">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/7a29a83fb1abaeab73083156ebf74f979431be0a">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/7a29a83fb1abaeab73083156ebf74f979431be0a">files</a> |
changeset |
<a href="/comm-central/raw-rev/7a29a83fb1abaeab73083156ebf74f979431be0a">raw</a>  | <a href="/comm-central/archive/7a29a83fb1abaeab73083156ebf74f979431be0a.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1494764">Bug 1494764</a>: Ignore missing \n on last line of last chunk. r=jorgk
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#71;&#101;&#110;&#101;&#32;&#83;&#109;&#105;&#116;&#104;&#32;&#60;&#103;&#100;&#115;&#64;&#99;&#104;&#97;&#114;&#116;&#101;&#114;&#116;&#110;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 25 Oct 2018 00:24:06 -0400</td></tr>

<tr>
 <td>changeset 25092</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/7a29a83fb1abaeab73083156ebf74f979431be0a">7a29a83fb1abaeab73083156ebf74f979431be0a</a></td>
</tr>



<tr>
<td>parent 25091</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/c7094bcea32faad13d115526ddc05991d989bd5e">c7094bcea32faad13d115526ddc05991d989bd5e</a>
</td>
</tr>

<tr>
<td>child 25093</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/41cd1f527410813bb22fdc7a9e4f5f4a1b2ba761">41cd1f527410813bb22fdc7a9e4f5f4a1b2ba761</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=7a29a83fb1abaeab73083156ebf74f979431be0a">15065</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Sat, 27 Oct 2018 22:26:04 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@50bc86d0ddd6 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=50bc86d0ddd6bd672deff8dc08da21c992a17ab1">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=50bc86d0ddd6bd672deff8dc08da21c992a17ab1&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=50bc86d0ddd6bd672deff8dc08da21c992a17ab1&newProject=comm-central&newRevision=c7094bcea32faad13d115526ddc05991d989bd5e&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=50bc86d0ddd6bd672deff8dc08da21c992a17ab1&newProject=comm-central&newRevision=c7094bcea32faad13d115526ddc05991d989bd5e&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=50bc86d0ddd6bd672deff8dc08da21c992a17ab1&newProject=comm-central&newRevision=c7094bcea32faad13d115526ddc05991d989bd5e&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28jorgk%29&revcount=50">jorgk</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1494764">1494764</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1494764">Bug 1494764</a>: Ignore missing \n on last line of last chunk. r=jorgk
When last chunk (or only chunk) and last line and it ends in \r
and not \r\n, don't expect to see \n on first line of next message
fetched. This avoids an assertion failure and functional problem.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7a29a83fb1abaeab73083156ebf74f979431be0a/mailnews/imap/src/nsImapServerResponseParser.cpp">mailnews/imap/src/nsImapServerResponseParser.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7a29a83fb1abaeab73083156ebf74f979431be0a/mailnews/imap/src/nsImapServerResponseParser.cpp">file</a> |
<a href="/comm-central/annotate/7a29a83fb1abaeab73083156ebf74f979431be0a/mailnews/imap/src/nsImapServerResponseParser.cpp">annotate</a> |
<a href="/comm-central/diff/7a29a83fb1abaeab73083156ebf74f979431be0a/mailnews/imap/src/nsImapServerResponseParser.cpp">diff</a> |
<a href="/comm-central/comparison/7a29a83fb1abaeab73083156ebf74f979431be0a/mailnews/imap/src/nsImapServerResponseParser.cpp">comparison</a> |
<a href="/comm-central/log/7a29a83fb1abaeab73083156ebf74f979431be0a/mailnews/imap/src/nsImapServerResponseParser.cpp">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/imap/src/nsImapServerResponseParser.cpp</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapServerResponseParser.cpp</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -3115,21 +3115,23 @@ bool nsImapServerResponseParser::msg_fet</span>
<a href="#l1.4"></a><span id="l1.4">       // who cares about binary transparency, and anyway \0 in this context violates RFCs.</span>
<a href="#l1.5"></a><span id="l1.5">       charsReadSoFar += strlen(fCurrentLine);</span>
<a href="#l1.6"></a><span id="l1.6">       if (!fDownloadingHeaders &amp;&amp; fCurrentCommandIsSingleMessageFetch)</span>
<a href="#l1.7"></a><span id="l1.7">       {</span>
<a href="#l1.8"></a><span id="l1.8">         fServerConnection.ProgressEventFunctionUsingName(&quot;imapDownloadingMessage&quot;);</span>
<a href="#l1.9"></a><span id="l1.9">         if (fTotalDownloadSize &gt; 0)</span>
<a href="#l1.10"></a><span id="l1.10">           fServerConnection.PercentProgressUpdateEvent(0, charsReadSoFar + origin, fTotalDownloadSize);</span>
<a href="#l1.11"></a><span id="l1.11">       }</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-      if (charsReadSoFar &gt; numberOfCharsInThisChunk)</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+      if (!lastChunk &amp;&amp; (charsReadSoFar &gt; numberOfCharsInThisChunk))</span>
<a href="#l1.14"></a><span id="l1.14">       {</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineminus">-        // This is the last line of a chunk. &quot;Literal&quot; here means actual email data and</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineminus">-        // its EOLs, without imap protocol elements and their EOLs. End of line is</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineminus">-        // defined by two characters \r\n (i.e., CRLF, 0xd,0xa) specified by RFC822.</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+        // This is the last line of a chunk but not the last chunk of a multi-chunk</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+        // message or the only &quot;chunk&quot; of a smaller non-chunked message. &quot;Literal&quot; here</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineplus">+        // means actual email data and its EOLs, without imap protocol elements and their</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineplus">+        // EOLs. End of line is defined by two characters \r\n (i.e., CRLF, 0xd,0xa)</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineplus">+        // specified by RFC822.</span>
<a href="#l1.23"></a><span id="l1.23">         // Here is an example the most typical last good line of a chunk:</span>
<a href="#l1.24"></a><span id="l1.24">         // &quot;1s8AA5i4AAvF4QAG6+sAAD0bAPsAAAAA1OAAC)\r\n&quot;, where &quot;)\r\n&quot; are non-literals.</span>
<a href="#l1.25"></a><span id="l1.25">         // This an example of the last &quot;good&quot; line of a chunk that terminates with \r\n</span>
<a href="#l1.26"></a><span id="l1.26">         // &quot;FxcA/wAAAALN2gADu80ACS0nAPpVVAD1wNAABF5YAPhAJgD31+QABAAAAP8oMQD+HBwA/umj\r\n&quot;</span>
<a href="#l1.27"></a><span id="l1.27">         // followed by another line of non-literal data:</span>
<a href="#l1.28"></a><span id="l1.28">         // &quot; UID 1004)\r\n&quot;. These two are concatenated into a single string pointed to</span>
<a href="#l1.29"></a><span id="l1.29">         // by fCurrentLine.  The extra &quot;non-literal data&quot; on the last chunk line makes</span>
<a href="#l1.30"></a><span id="l1.30">         // the charsReadSoFar greater than numberOfCharsInThisChunk (the configured</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineat">@@ -3189,29 +3191,29 @@ bool nsImapServerResponseParser::msg_fet</span>
<a href="#l1.32"></a><span id="l1.32">         fServerConnection.HandleMessageDownLoadLine(fCurrentLine, !lastChunk);</span>
<a href="#l1.33"></a><span id="l1.33">         // Restore fCurrentLine's original content.</span>
<a href="#l1.34"></a><span id="l1.34">         displayEndOfLine[1] = saveit1;</span>
<a href="#l1.35"></a><span id="l1.35">         if (fNextChunkStartsWithNewline)</span>
<a href="#l1.36"></a><span id="l1.36">           displayEndOfLine[2] = saveit2;</span>
<a href="#l1.37"></a><span id="l1.37">       }</span>
<a href="#l1.38"></a><span id="l1.38">       else</span>
<a href="#l1.39"></a><span id="l1.39">       {</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineminus">-        // Not the last line of a chunk.</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineplus">+        // Not the last line of a chunk or any line when lastChunk.</span>
<a href="#l1.42"></a><span id="l1.42">         if (!fNextChunkStartsWithNewline)</span>
<a href="#l1.43"></a><span id="l1.43">         {</span>
<a href="#l1.44"></a><span id="l1.44">           // Process unmodified fCurrentLine string.</span>
<a href="#l1.45"></a><span id="l1.45">           fServerConnection.HandleMessageDownLoadLine(fCurrentLine,</span>
<a href="#l1.46"></a><span id="l1.46">             !lastChunk &amp;&amp; (charsReadSoFar == numberOfCharsInThisChunk),</span>
<a href="#l1.47"></a><span id="l1.47">             fCurrentLine);</span>
<a href="#l1.48"></a><span id="l1.48">         }</span>
<a href="#l1.49"></a><span id="l1.49">         else</span>
<a href="#l1.50"></a><span id="l1.50">         {</span>
<a href="#l1.51"></a><span id="l1.51">           // Ignore the orphan '\n' on a line by itself.</span>
<a href="#l1.52"></a><span id="l1.52">           MOZ_ASSERT(strlen(fCurrentLine) == 1 &amp;&amp; fCurrentLine[0] == '\n',</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineminus">-                     &quot;Expect '\n' as only character in this line&quot;);</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineplus">+                     &quot;Expect '\\n' as only character in this line&quot;);</span>
<a href="#l1.55"></a><span id="l1.55">           fNextChunkStartsWithNewline = false;</span>
<a href="#l1.56"></a><span id="l1.56">         }</span>
<a href="#l1.57"></a><span id="l1.57">       }</span>
<a href="#l1.58"></a><span id="l1.58">     }</span>
<a href="#l1.59"></a><span id="l1.59">   }</span>
<a href="#l1.60"></a><span id="l1.60"> </span>
<a href="#l1.61"></a><span id="l1.61">   if (ContinueParse())</span>
<a href="#l1.62"></a><span id="l1.62">   {</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

