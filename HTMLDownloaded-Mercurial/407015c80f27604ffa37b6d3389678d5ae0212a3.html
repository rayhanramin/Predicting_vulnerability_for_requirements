<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 15608:407015c80f27604ffa37b6d3389678d5ae0212a3</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 407015c80f27604ffa37b6d3389678d5ae0212a3" />
<meta property="og:url" content="/comm-central/rev/407015c80f27604ffa37b6d3389678d5ae0212a3" />
<meta property="og:description" content="Bug 959272 - Fix feed folder rename/move/copy and db sync issues. r=mkmelin" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 407015c80f27604ffa37b6d3389678d5ae0212a3 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/407015c80f27604ffa37b6d3389678d5ae0212a3">shortlog</a> |
<a href="/comm-central/log/407015c80f27604ffa37b6d3389678d5ae0212a3">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/407015c80f27604ffa37b6d3389678d5ae0212a3">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/407015c80f27604ffa37b6d3389678d5ae0212a3">files</a> |
changeset |
<a href="/comm-central/raw-rev/407015c80f27604ffa37b6d3389678d5ae0212a3">raw</a>  | <a href="/comm-central/archive/407015c80f27604ffa37b6d3389678d5ae0212a3.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=959272">Bug 959272</a> - Fix feed folder rename/move/copy and db sync issues. r=mkmelin
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#97;&#108;&#116;&#97;&#56;&#56;&#32;&#60;&#97;&#108;&#116;&#97;&#56;&#56;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Wed, 15 Jan 2014 17:53:09 -0500</td></tr>

<tr>
 <td>changeset 15608</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/407015c80f27604ffa37b6d3389678d5ae0212a3">407015c80f27604ffa37b6d3389678d5ae0212a3</a></td>
</tr>



<tr>
<td>parent 15607</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/5b6082f048ddca5e97257b61fdb3fc24a94b9882">5b6082f048ddca5e97257b61fdb3fc24a94b9882</a>
</td>
</tr>

<tr>
<td>child 15609</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/f29c718dd3d8f9bddba0515b8c4afac22527df32">f29c718dd3d8f9bddba0515b8c4afac22527df32</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=407015c80f27604ffa37b6d3389678d5ae0212a3">9784</a></td></tr>
<tr><td>push user</td><td>ryanvm@gmail.com</td></tr>
<tr><td>push date</td><td class="date age">Thu, 16 Jan 2014 13:10:14 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@407015c80f27 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=407015c80f27604ffa37b6d3389678d5ae0212a3">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=407015c80f27604ffa37b6d3389678d5ae0212a3&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=407015c80f27604ffa37b6d3389678d5ae0212a3&newProject=comm-central&newRevision=5b6082f048ddca5e97257b61fdb3fc24a94b9882&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=407015c80f27604ffa37b6d3389678d5ae0212a3&newProject=comm-central&newRevision=5b6082f048ddca5e97257b61fdb3fc24a94b9882&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=407015c80f27604ffa37b6d3389678d5ae0212a3&newProject=comm-central&newRevision=5b6082f048ddca5e97257b61fdb3fc24a94b9882&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mkmelin%29&revcount=50">mkmelin</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=959272">959272</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=959272">Bug 959272</a> - Fix feed folder rename/move/copy and db sync issues. r=mkmelin</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/407015c80f27604ffa37b6d3389678d5ae0212a3/mailnews/base/content/folderWidgets.xml">mailnews/base/content/folderWidgets.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/407015c80f27604ffa37b6d3389678d5ae0212a3/mailnews/base/content/folderWidgets.xml">file</a> |
<a href="/comm-central/annotate/407015c80f27604ffa37b6d3389678d5ae0212a3/mailnews/base/content/folderWidgets.xml">annotate</a> |
<a href="/comm-central/diff/407015c80f27604ffa37b6d3389678d5ae0212a3/mailnews/base/content/folderWidgets.xml">diff</a> |
<a href="/comm-central/comparison/407015c80f27604ffa37b6d3389678d5ae0212a3/mailnews/base/content/folderWidgets.xml">comparison</a> |
<a href="/comm-central/log/407015c80f27604ffa37b6d3389678d5ae0212a3/mailnews/base/content/folderWidgets.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/407015c80f27604ffa37b6d3389678d5ae0212a3/mailnews/extensions/newsblog/content/FeedUtils.jsm">mailnews/extensions/newsblog/content/FeedUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/407015c80f27604ffa37b6d3389678d5ae0212a3/mailnews/extensions/newsblog/content/FeedUtils.jsm">file</a> |
<a href="/comm-central/annotate/407015c80f27604ffa37b6d3389678d5ae0212a3/mailnews/extensions/newsblog/content/FeedUtils.jsm">annotate</a> |
<a href="/comm-central/diff/407015c80f27604ffa37b6d3389678d5ae0212a3/mailnews/extensions/newsblog/content/FeedUtils.jsm">diff</a> |
<a href="/comm-central/comparison/407015c80f27604ffa37b6d3389678d5ae0212a3/mailnews/extensions/newsblog/content/FeedUtils.jsm">comparison</a> |
<a href="/comm-central/log/407015c80f27604ffa37b6d3389678d5ae0212a3/mailnews/extensions/newsblog/content/FeedUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/407015c80f27604ffa37b6d3389678d5ae0212a3/mailnews/extensions/newsblog/content/feed-subscriptions.js">mailnews/extensions/newsblog/content/feed-subscriptions.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/407015c80f27604ffa37b6d3389678d5ae0212a3/mailnews/extensions/newsblog/content/feed-subscriptions.js">file</a> |
<a href="/comm-central/annotate/407015c80f27604ffa37b6d3389678d5ae0212a3/mailnews/extensions/newsblog/content/feed-subscriptions.js">annotate</a> |
<a href="/comm-central/diff/407015c80f27604ffa37b6d3389678d5ae0212a3/mailnews/extensions/newsblog/content/feed-subscriptions.js">diff</a> |
<a href="/comm-central/comparison/407015c80f27604ffa37b6d3389678d5ae0212a3/mailnews/extensions/newsblog/content/feed-subscriptions.js">comparison</a> |
<a href="/comm-central/log/407015c80f27604ffa37b6d3389678d5ae0212a3/mailnews/extensions/newsblog/content/feed-subscriptions.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/407015c80f27604ffa37b6d3389678d5ae0212a3/mailnews/extensions/newsblog/js/newsblog.js">mailnews/extensions/newsblog/js/newsblog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/407015c80f27604ffa37b6d3389678d5ae0212a3/mailnews/extensions/newsblog/js/newsblog.js">file</a> |
<a href="/comm-central/annotate/407015c80f27604ffa37b6d3389678d5ae0212a3/mailnews/extensions/newsblog/js/newsblog.js">annotate</a> |
<a href="/comm-central/diff/407015c80f27604ffa37b6d3389678d5ae0212a3/mailnews/extensions/newsblog/js/newsblog.js">diff</a> |
<a href="/comm-central/comparison/407015c80f27604ffa37b6d3389678d5ae0212a3/mailnews/extensions/newsblog/js/newsblog.js">comparison</a> |
<a href="/comm-central/log/407015c80f27604ffa37b6d3389678d5ae0212a3/mailnews/extensions/newsblog/js/newsblog.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/407015c80f27604ffa37b6d3389678d5ae0212a3/mailnews/local/public/nsINewsBlogFeedDownloader.idl">mailnews/local/public/nsINewsBlogFeedDownloader.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/407015c80f27604ffa37b6d3389678d5ae0212a3/mailnews/local/public/nsINewsBlogFeedDownloader.idl">file</a> |
<a href="/comm-central/annotate/407015c80f27604ffa37b6d3389678d5ae0212a3/mailnews/local/public/nsINewsBlogFeedDownloader.idl">annotate</a> |
<a href="/comm-central/diff/407015c80f27604ffa37b6d3389678d5ae0212a3/mailnews/local/public/nsINewsBlogFeedDownloader.idl">diff</a> |
<a href="/comm-central/comparison/407015c80f27604ffa37b6d3389678d5ae0212a3/mailnews/local/public/nsINewsBlogFeedDownloader.idl">comparison</a> |
<a href="/comm-central/log/407015c80f27604ffa37b6d3389678d5ae0212a3/mailnews/local/public/nsINewsBlogFeedDownloader.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/407015c80f27604ffa37b6d3389678d5ae0212a3/mailnews/local/src/nsRssIncomingServer.cpp">mailnews/local/src/nsRssIncomingServer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/407015c80f27604ffa37b6d3389678d5ae0212a3/mailnews/local/src/nsRssIncomingServer.cpp">file</a> |
<a href="/comm-central/annotate/407015c80f27604ffa37b6d3389678d5ae0212a3/mailnews/local/src/nsRssIncomingServer.cpp">annotate</a> |
<a href="/comm-central/diff/407015c80f27604ffa37b6d3389678d5ae0212a3/mailnews/local/src/nsRssIncomingServer.cpp">diff</a> |
<a href="/comm-central/comparison/407015c80f27604ffa37b6d3389678d5ae0212a3/mailnews/local/src/nsRssIncomingServer.cpp">comparison</a> |
<a href="/comm-central/log/407015c80f27604ffa37b6d3389678d5ae0212a3/mailnews/local/src/nsRssIncomingServer.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/407015c80f27604ffa37b6d3389678d5ae0212a3/mailnews/local/src/nsRssIncomingServer.h">mailnews/local/src/nsRssIncomingServer.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/407015c80f27604ffa37b6d3389678d5ae0212a3/mailnews/local/src/nsRssIncomingServer.h">file</a> |
<a href="/comm-central/annotate/407015c80f27604ffa37b6d3389678d5ae0212a3/mailnews/local/src/nsRssIncomingServer.h">annotate</a> |
<a href="/comm-central/diff/407015c80f27604ffa37b6d3389678d5ae0212a3/mailnews/local/src/nsRssIncomingServer.h">diff</a> |
<a href="/comm-central/comparison/407015c80f27604ffa37b6d3389678d5ae0212a3/mailnews/local/src/nsRssIncomingServer.h">comparison</a> |
<a href="/comm-central/log/407015c80f27604ffa37b6d3389678d5ae0212a3/mailnews/local/src/nsRssIncomingServer.h">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/base/content/folderWidgets.xml</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/base/content/folderWidgets.xml</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -9,20 +9,21 @@</span>
<a href="#l1.4"></a><span id="l1.4">           xmlns:xbl=&quot;http://www.mozilla.org/xbl&quot;</span>
<a href="#l1.5"></a><span id="l1.5">           xmlns:html=&quot;http://www.w3.org/1999/xhtml&quot;</span>
<a href="#l1.6"></a><span id="l1.6">           xmlns:xul=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;&gt;</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8">   &lt;binding id=&quot;folder-menupopup&quot;</span>
<a href="#l1.9"></a><span id="l1.9">            extends=&quot;chrome://global/content/bindings/popup.xml#popup&quot;&gt;</span>
<a href="#l1.10"></a><span id="l1.10">     &lt;implementation&gt;</span>
<a href="#l1.11"></a><span id="l1.11">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+        Components.utils.import(&quot;resource:///modules/FeedUtils.jsm&quot;, this);</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+        Components.utils.import(&quot;resource:///modules/folderUtils.jsm&quot;, this);</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+        Components.utils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;, this);</span>
<a href="#l1.15"></a><span id="l1.15">         Components.utils.import(&quot;resource:///modules/mailServices.js&quot;, this);</span>
<a href="#l1.16"></a><span id="l1.16">         Components.utils.import(&quot;resource:///modules/MailUtils.js&quot;, this);</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineminus">-        Components.utils.import(&quot;resource:///modules/folderUtils.jsm&quot;, this);</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineminus">-        Components.utils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;, this);</span>
<a href="#l1.19"></a><span id="l1.19">         Components.utils.import(&quot;resource:///modules/StringBundle.js&quot;, this);</span>
<a href="#l1.20"></a><span id="l1.20">         this._stringBundle = new this</span>
<a href="#l1.21"></a><span id="l1.21">             .StringBundle(&quot;chrome://messenger/locale/folderWidgets.properties&quot;);</span>
<a href="#l1.22"></a><span id="l1.22"> </span>
<a href="#l1.23"></a><span id="l1.23">         // Find out if we are in a wrapper (customize toolbars mode is active).</span>
<a href="#l1.24"></a><span id="l1.24">         let inWrapper = false;</span>
<a href="#l1.25"></a><span id="l1.25">         let node = this;</span>
<a href="#l1.26"></a><span id="l1.26">         while (node instanceof XULElement) {</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineat">@@ -656,18 +657,17 @@</span>
<a href="#l1.28"></a><span id="l1.28">               break;</span>
<a href="#l1.29"></a><span id="l1.29">             }</span>
<a href="#l1.30"></a><span id="l1.30">           }</span>
<a href="#l1.31"></a><span id="l1.31"> </span>
<a href="#l1.32"></a><span id="l1.32">           aMenuNode.setAttribute(&quot;IsServer&quot;, aFolder.isServer);</span>
<a href="#l1.33"></a><span id="l1.33">           aMenuNode.setAttribute(&quot;IsSecure&quot;, aFolder.server.isSecure);</span>
<a href="#l1.34"></a><span id="l1.34">           aMenuNode.setAttribute(&quot;ServerType&quot;, aFolder.server.type);</span>
<a href="#l1.35"></a><span id="l1.35">           aMenuNode.setAttribute(&quot;IsFeedFolder&quot;,</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineminus">-            (aFolder.server.type == &quot;rss&quot; &amp;&amp; !aFolder.isServer &amp;&amp;</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineminus">-             aFolder.getStringProperty(&quot;feedUrl&quot;) ? true : false));</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineplus">+            (this.FeedUtils.getFeedUrlsInFolder(aFolder) ? true : false));</span>
<a href="#l1.39"></a><span id="l1.39">         ]]&gt;&lt;/body&gt;</span>
<a href="#l1.40"></a><span id="l1.40">       &lt;/method&gt;</span>
<a href="#l1.41"></a><span id="l1.41"> </span>
<a href="#l1.42"></a><span id="l1.42">       &lt;!--</span>
<a href="#l1.43"></a><span id="l1.43">          - Makes a given folder selected.</span>
<a href="#l1.44"></a><span id="l1.44">          -</span>
<a href="#l1.45"></a><span id="l1.45">          - @param aFolder  the folder to select (if unset, then choose first folder)</span>
<a href="#l1.46"></a><span id="l1.46">          - @note  If aFolder is not in this popup, but is instead a descendant of</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineat">@@ -678,16 +678,18 @@</span>
<a href="#l1.48"></a><span id="l1.48">         &lt;parameter name=&quot;aFolder&quot;/&gt;</span>
<a href="#l1.49"></a><span id="l1.49">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l1.50"></a><span id="l1.50">           // Set the label of the aParent element as if aFolder had been selected.</span>
<a href="#l1.51"></a><span id="l1.51">           function setupParent(aFolder, aParent) {</span>
<a href="#l1.52"></a><span id="l1.52">             aParent.setAttribute(&quot;label&quot;, aFolder.name);</span>
<a href="#l1.53"></a><span id="l1.53">             aParent.setAttribute(&quot;IsServer&quot;, aFolder.isServer);</span>
<a href="#l1.54"></a><span id="l1.54">             aParent.setAttribute(&quot;IsSecure&quot;, aFolder.server.isSecure);</span>
<a href="#l1.55"></a><span id="l1.55">             aParent.setAttribute(&quot;ServerType&quot;, aFolder.server.type);</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineplus">+            aParent.setAttribute(&quot;IsFeedFolder&quot;,</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineplus">+              (aParent.menupopup.FeedUtils.getFeedUrlsInFolder(aFolder) ? true : false));</span>
<a href="#l1.58"></a><span id="l1.58">           }</span>
<a href="#l1.59"></a><span id="l1.59">           for (let child of this.childNodes) {</span>
<a href="#l1.60"></a><span id="l1.60">             if (!child || !child._folder || child.disabled)</span>
<a href="#l1.61"></a><span id="l1.61">               continue;</span>
<a href="#l1.62"></a><span id="l1.62">             // Is this the folder in question or subfolder of the folder?</span>
<a href="#l1.63"></a><span id="l1.63">             if (!aFolder || (child._folder.URI == aFolder.URI) ||</span>
<a href="#l1.64"></a><span id="l1.64">                 (child.tagName == &quot;menu&quot; &amp;&amp;</span>
<a href="#l1.65"></a><span id="l1.65">                  child._folder.isAncestorOf(aFolder))) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/extensions/newsblog/content/FeedUtils.jsm</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/extensions/newsblog/content/FeedUtils.jsm</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -72,18 +72,16 @@ var FeedUtils = {</span>
<a href="#l2.4"></a><span id="l2.4">   ATOM_IETF_NS: &quot;http://www.w3.org/2005/Atom&quot;,</span>
<a href="#l2.5"></a><span id="l2.5">   ATOM_THREAD_NS: &quot;http://purl.org/syndication/thread/1.0&quot;,</span>
<a href="#l2.6"></a><span id="l2.6"> </span>
<a href="#l2.7"></a><span id="l2.7">   // The approximate amount of time, specified in milliseconds, to leave an</span>
<a href="#l2.8"></a><span id="l2.8">   // item in the RDF cache after the item has dissappeared from feeds.</span>
<a href="#l2.9"></a><span id="l2.9">   // The delay is currently one day.</span>
<a href="#l2.10"></a><span id="l2.10">   INVALID_ITEM_PURGE_DELAY: 24 * 60 * 60 * 1000,</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-  // The delimiter used to delimit feed urls in the folder's &quot;feedUrl&quot; property.</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-  kFeedUrlDelimiter: &quot;|&quot;,</span>
<a href="#l2.14"></a><span id="l2.14">   kBiffMinutesDefault: 100,</span>
<a href="#l2.15"></a><span id="l2.15">   kNewsBlogSuccess: 0,</span>
<a href="#l2.16"></a><span id="l2.16">   // Usually means there was an error trying to parse the feed.</span>
<a href="#l2.17"></a><span id="l2.17">   kNewsBlogInvalidFeed: 1,</span>
<a href="#l2.18"></a><span id="l2.18">   // Generic networking failure when trying to download the feed.</span>
<a href="#l2.19"></a><span id="l2.19">   kNewsBlogRequestFailure: 2,</span>
<a href="#l2.20"></a><span id="l2.20">   kNewsBlogFeedIsBusy: 3,</span>
<a href="#l2.21"></a><span id="l2.21">   // There are no new articles for this feed</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineat">@@ -207,19 +205,16 @@ var FeedUtils = {</span>
<a href="#l2.23"></a><span id="l2.23">     id = this.rdf.GetResource(id);</span>
<a href="#l2.24"></a><span id="l2.24">     feeds.AppendElement(id);</span>
<a href="#l2.25"></a><span id="l2.25">     ds.Assert(id, this.RDF_TYPE, this.FZ_FEED, true);</span>
<a href="#l2.26"></a><span id="l2.26">     ds.Assert(id, this.DC_IDENTIFIER, this.rdf.GetLiteral(aFeed.url), true);</span>
<a href="#l2.27"></a><span id="l2.27">     if (aFeed.title)</span>
<a href="#l2.28"></a><span id="l2.28">       ds.Assert(id, this.DC_TITLE, this.rdf.GetLiteral(aFeed.title), true);</span>
<a href="#l2.29"></a><span id="l2.29">     ds.Assert(id, this.FZ_DESTFOLDER, aFeed.folder, true);</span>
<a href="#l2.30"></a><span id="l2.30">     ds.Flush();</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineminus">-    // Sync the feedUrl property for the folder.</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineminus">-    this.syncFeedUrlWithFeedsDS(aFeed.folder);</span>
<a href="#l2.34"></a><span id="l2.34">   },</span>
<a href="#l2.35"></a><span id="l2.35"> </span>
<a href="#l2.36"></a><span id="l2.36"> /**</span>
<a href="#l2.37"></a><span id="l2.37">  * Delete a feed record from the feeds.rdf database and update the folder's</span>
<a href="#l2.38"></a><span id="l2.38">  * feedUrl property.</span>
<a href="#l2.39"></a><span id="l2.39">  *</span>
<a href="#l2.40"></a><span id="l2.40">  * @param  nsIRDFResource aId           - feed url as rdf resource.</span>
<a href="#l2.41"></a><span id="l2.41">  * @param  nsIMsgIncomingServer aServer - folder's account server.</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineat">@@ -241,34 +236,34 @@ var FeedUtils = {</span>
<a href="#l2.43"></a><span id="l2.43">       this.removeAssertions(ds, aId);</span>
<a href="#l2.44"></a><span id="l2.44">       ds.Flush();</span>
<a href="#l2.45"></a><span id="l2.45"> </span>
<a href="#l2.46"></a><span id="l2.46">       // Remove all assertions about items in the feed from the items database.</span>
<a href="#l2.47"></a><span id="l2.47">       let itemds = this.getItemsDS(aServer);</span>
<a href="#l2.48"></a><span id="l2.48">       feed.invalidateItems();</span>
<a href="#l2.49"></a><span id="l2.49">       feed.removeInvalidItems(true);</span>
<a href="#l2.50"></a><span id="l2.50">       itemds.Flush();</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineminus">-</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineminus">-      // Sync the feedUrl property for the folder.</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineminus">-      this.syncFeedUrlWithFeedsDS(aParentFolder);</span>
<a href="#l2.54"></a><span id="l2.54">     }</span>
<a href="#l2.55"></a><span id="l2.55">   },</span>
<a href="#l2.56"></a><span id="l2.56"> </span>
<a href="#l2.57"></a><span id="l2.57"> /**</span>
<a href="#l2.58"></a><span id="l2.58">  * Get the list of feed urls for a folder, as identified by the FZ_DESTFOLDER</span>
<a href="#l2.59"></a><span id="l2.59">  * tag, directly from the primary feeds.rdf subscriptions database.</span>
<a href="#l2.60"></a><span id="l2.60">  *</span>
<a href="#l2.61"></a><span id="l2.61">  * @param  nsIMsgFolder - the folder.</span>
<a href="#l2.62"></a><span id="l2.62">  * @return array of urls, or null if none.</span>
<a href="#l2.63"></a><span id="l2.63">  */</span>
<a href="#l2.64"></a><span id="l2.64">   getFeedUrlsInFolder: function(aFolder) {</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineminus">-    if (aFolder.isServer || aFolder.getFlag(Ci.nsMsgFolderFlags.Trash) ||</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineplus">+    if (aFolder.isServer || aFolder.server.type != &quot;rss&quot; ||</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineplus">+        aFolder.getFlag(Ci.nsMsgFolderFlags.Trash) ||</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineplus">+        aFolder.getFlag(Ci.nsMsgFolderFlags.Virtual) ||</span>
<a href="#l2.69"></a><span id="l2.69">         !aFolder.filePath.exists())</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineminus">-      // There are never any feedUrls in the account folder or trash folder or</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineminus">-      // in a ghost folder (nonexistant on disk yet found in aFolder.subFolders).</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineplus">+      // There are never any feedUrls in the account/non-feed/trash/virtual</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineplus">+      // folders or in a ghost folder (nonexistant on disk yet found in</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineplus">+      // aFolder.subFolders).</span>
<a href="#l2.75"></a><span id="l2.75">       return null;</span>
<a href="#l2.76"></a><span id="l2.76"> </span>
<a href="#l2.77"></a><span id="l2.77">     let feedUrlArray = [];</span>
<a href="#l2.78"></a><span id="l2.78"> </span>
<a href="#l2.79"></a><span id="l2.79">     // Get the list from the feeds database.</span>
<a href="#l2.80"></a><span id="l2.80">     try {</span>
<a href="#l2.81"></a><span id="l2.81">       let ds = this.getSubscriptionsDS(aFolder.server);</span>
<a href="#l2.82"></a><span id="l2.82">       let enumerator = ds.GetSources(this.FZ_DESTFOLDER, aFolder, true);</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineat">@@ -285,49 +280,114 @@ var FeedUtils = {</span>
<a href="#l2.84"></a><span id="l2.84">       this.log.error(&quot;getFeedUrlsInFolder: feeds.rdf db error for account - &quot; +</span>
<a href="#l2.85"></a><span id="l2.85">                      aFolder.server.serverURI + &quot; : &quot; + aFolder.server.prettyName);</span>
<a href="#l2.86"></a><span id="l2.86">     }</span>
<a href="#l2.87"></a><span id="l2.87"> </span>
<a href="#l2.88"></a><span id="l2.88">     return feedUrlArray.length ? feedUrlArray : null;</span>
<a href="#l2.89"></a><span id="l2.89">   },</span>
<a href="#l2.90"></a><span id="l2.90"> </span>
<a href="#l2.91"></a><span id="l2.91"> /**</span>
<a href="#l2.92"></a><span id="l2.92" class="difflineminus">- * Update the feeds.rdf database with the new folder's location on name changes</span>
<a href="#l2.93"></a><span id="l2.93" class="difflineminus">- * on rename and move/copy.</span>
<a href="#l2.94"></a><span id="l2.94" class="difflineplus">+ * Update the feeds.rdf database for rename and move/copy folder name changes.</span>
<a href="#l2.95"></a><span id="l2.95">  *</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineminus">- * @param  nsIMsgFolder aFolder      - the folder, new if rename or move/copy</span>
<a href="#l2.97"></a><span id="l2.97" class="difflineminus">- * @param  nsIMsgFolder aOrigFolder  - original folder, if move/copy</span>
<a href="#l2.98"></a><span id="l2.98" class="difflineplus">+ * @param  nsIMsgFolder aFolder      - the folder, new if rename or target of</span>
<a href="#l2.99"></a><span id="l2.99" class="difflineplus">+ *                                      move/copy folder (new parent)</span>
<a href="#l2.100"></a><span id="l2.100" class="difflineplus">+ * @param  nsIMsgFolder aOrigFolder  - original folder</span>
<a href="#l2.101"></a><span id="l2.101" class="difflineplus">+ * @param  string aAction            - &quot;move&quot; or &quot;copy&quot; or &quot;rename&quot;</span>
<a href="#l2.102"></a><span id="l2.102">  */</span>
<a href="#l2.103"></a><span id="l2.103" class="difflineminus">-  updateFolderChangeInFeedsDS: function(aFolder, aOrigFolder) {</span>
<a href="#l2.104"></a><span id="l2.104" class="difflineminus">-    let sourceFolder = aFolder;</span>
<a href="#l2.105"></a><span id="l2.105" class="difflineminus">-    if (aOrigFolder &amp;&amp; aFolder.server != aOrigFolder.server)</span>
<a href="#l2.106"></a><span id="l2.106" class="difflineminus">-      // Copied from another account, get the feed urls from that account's</span>
<a href="#l2.107"></a><span id="l2.107" class="difflineminus">-      // feeds.rdf db.</span>
<a href="#l2.108"></a><span id="l2.108" class="difflineminus">-      sourceFolder = aOrigFolder;</span>
<a href="#l2.109"></a><span id="l2.109" class="difflineplus">+  updateSubscriptionsDS: function(aFolder, aOrigFolder, aAction) {</span>
<a href="#l2.110"></a><span id="l2.110" class="difflineplus">+    this.log.debug(&quot;FeedUtils.updateSubscriptionsDS: &quot; +</span>
<a href="#l2.111"></a><span id="l2.111" class="difflineplus">+                   &quot;\nfolder changed - &quot; + aAction +</span>
<a href="#l2.112"></a><span id="l2.112" class="difflineplus">+                   &quot;\nnew folder  - &quot; + aFolder.filePath.path +</span>
<a href="#l2.113"></a><span id="l2.113" class="difflineplus">+                   &quot;\norig folder - &quot; + aOrigFolder.filePath.path);</span>
<a href="#l2.114"></a><span id="l2.114" class="difflineplus">+</span>
<a href="#l2.115"></a><span id="l2.115" class="difflineplus">+    if (aFolder.server.type != &quot;rss&quot; || FeedUtils.isInTrash(aOrigFolder))</span>
<a href="#l2.116"></a><span id="l2.116" class="difflineplus">+      // Target not a feed account folder; nothing to do, or move/rename in</span>
<a href="#l2.117"></a><span id="l2.117" class="difflineplus">+      // trash; no subscriptions already.</span>
<a href="#l2.118"></a><span id="l2.118" class="difflineplus">+      return;</span>
<a href="#l2.119"></a><span id="l2.119" class="difflineplus">+</span>
<a href="#l2.120"></a><span id="l2.120" class="difflineplus">+    let newFolder = aFolder;</span>
<a href="#l2.121"></a><span id="l2.121" class="difflineplus">+    let newParentURI = aFolder.URI;</span>
<a href="#l2.122"></a><span id="l2.122" class="difflineplus">+    let origParentURI = aOrigFolder.URI;</span>
<a href="#l2.123"></a><span id="l2.123" class="difflineplus">+    if (aAction == &quot;move&quot; || aAction == &quot;copy&quot;)</span>
<a href="#l2.124"></a><span id="l2.124" class="difflineplus">+    {</span>
<a href="#l2.125"></a><span id="l2.125" class="difflineplus">+      // Get the new folder. Don't process the entire parent (new dest folder)!</span>
<a href="#l2.126"></a><span id="l2.126" class="difflineplus">+      newFolder = aFolder.getChildNamed(aOrigFolder.name);</span>
<a href="#l2.127"></a><span id="l2.127" class="difflineplus">+      origParentURI = aOrigFolder.parent ? aOrigFolder.parent.URI :</span>
<a href="#l2.128"></a><span id="l2.128" class="difflineplus">+                                           aOrigFolder.rootFolder.URI;</span>
<a href="#l2.129"></a><span id="l2.129" class="difflineplus">+    }</span>
<a href="#l2.130"></a><span id="l2.130" class="difflineplus">+</span>
<a href="#l2.131"></a><span id="l2.131" class="difflineplus">+    this.updateFolderChangeInFeedsDS(newFolder, aOrigFolder, null, null);</span>
<a href="#l2.132"></a><span id="l2.132" class="difflineplus">+</span>
<a href="#l2.133"></a><span id="l2.133" class="difflineplus">+    // There may be subfolders, but we only get a single notification; iterate</span>
<a href="#l2.134"></a><span id="l2.134" class="difflineplus">+    // over all descendent folders of the folder whose location has changed.</span>
<a href="#l2.135"></a><span id="l2.135" class="difflineplus">+    let newSubFolders = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l2.136"></a><span id="l2.136" class="difflineplus">+    newFolder.ListDescendants(newSubFolders);</span>
<a href="#l2.137"></a><span id="l2.137" class="difflineplus">+    for (let i = 0; i &lt; newSubFolders.length; i++)</span>
<a href="#l2.138"></a><span id="l2.138" class="difflineplus">+    {</span>
<a href="#l2.139"></a><span id="l2.139" class="difflineplus">+      let newSubFolder = newSubFolders.queryElementAt(i, Ci.nsIMsgFolder);</span>
<a href="#l2.140"></a><span id="l2.140" class="difflineplus">+      FeedUtils.updateFolderChangeInFeedsDS(newSubFolder, aOrigFolder,</span>
<a href="#l2.141"></a><span id="l2.141" class="difflineplus">+                                            newParentURI, origParentURI)</span>
<a href="#l2.142"></a><span id="l2.142" class="difflineplus">+    }</span>
<a href="#l2.143"></a><span id="l2.143" class="difflineplus">+  },</span>
<a href="#l2.144"></a><span id="l2.144"> </span>
<a href="#l2.145"></a><span id="l2.145" class="difflineminus">-    this.log.debug(&quot;updateFolderChangeInFeedsDS: aFolder      - &quot; +</span>
<a href="#l2.146"></a><span id="l2.146" class="difflineminus">-                   aFolder.filePath.path);</span>
<a href="#l2.147"></a><span id="l2.147" class="difflineminus">-    this.log.debug(&quot;updateFolderChangeInFeedsDS: sourceFolder - &quot; +</span>
<a href="#l2.148"></a><span id="l2.148" class="difflineminus">-                   sourceFolder.filePath.path);</span>
<a href="#l2.149"></a><span id="l2.149" class="difflineplus">+/**</span>
<a href="#l2.150"></a><span id="l2.150" class="difflineplus">+ * Update the feeds.rdf database with the new folder's or subfolder's location</span>
<a href="#l2.151"></a><span id="l2.151" class="difflineplus">+ * for rename and move/copy name changes. The feeds.rdf subscriptions db is</span>
<a href="#l2.152"></a><span id="l2.152" class="difflineplus">+ * also synced on cross account folder copies. Note that if a copied folder's</span>
<a href="#l2.153"></a><span id="l2.153" class="difflineplus">+ * url exists in the new account, its active subscription will be switched to</span>
<a href="#l2.154"></a><span id="l2.154" class="difflineplus">+ * the folder being copied, to enforce the one unique url per account design.</span>
<a href="#l2.155"></a><span id="l2.155" class="difflineplus">+ *</span>
<a href="#l2.156"></a><span id="l2.156" class="difflineplus">+ * @param  nsIMsgFolder aFolder      - new folder</span>
<a href="#l2.157"></a><span id="l2.157" class="difflineplus">+ * @param  nsIMsgFolder aOrigFolder  - original folder</span>
<a href="#l2.158"></a><span id="l2.158" class="difflineplus">+ * @param  string aNewAncestorURI    - for subfolders, ancestor new folder</span>
<a href="#l2.159"></a><span id="l2.159" class="difflineplus">+ * @param  string aOrigAncestorURI   - for subfolders, ancestor original folder</span>
<a href="#l2.160"></a><span id="l2.160" class="difflineplus">+ */</span>
<a href="#l2.161"></a><span id="l2.161" class="difflineplus">+  updateFolderChangeInFeedsDS: function(aFolder, aOrigFolder,</span>
<a href="#l2.162"></a><span id="l2.162" class="difflineplus">+                                        aNewAncestorURI, aOrigAncestorURI) {</span>
<a href="#l2.163"></a><span id="l2.163" class="difflineplus">+    this.log.debug(&quot;updateFolderChangeInFeedsDS: &quot; +</span>
<a href="#l2.164"></a><span id="l2.164" class="difflineplus">+                   &quot;\naFolder       - &quot; + aFolder.URI +</span>
<a href="#l2.165"></a><span id="l2.165" class="difflineplus">+                   &quot;\naOrigFolder   - &quot; + aOrigFolder.URI +</span>
<a href="#l2.166"></a><span id="l2.166" class="difflineplus">+                   &quot;\naOrigAncestor - &quot; + aOrigAncestorURI +</span>
<a href="#l2.167"></a><span id="l2.167" class="difflineplus">+                   &quot;\naNewAncestor  - &quot; + aNewAncestorURI);</span>
<a href="#l2.168"></a><span id="l2.168"> </span>
<a href="#l2.169"></a><span id="l2.169" class="difflineminus">-    let feedUrl = sourceFolder.getStringProperty(&quot;feedUrl&quot;);</span>
<a href="#l2.170"></a><span id="l2.170" class="difflineminus">-    let feedUrlArray = feedUrl ? this.splitFeedUrls(feedUrl) : null;</span>
<a href="#l2.171"></a><span id="l2.171" class="difflineplus">+    // Get the original folder's URI.</span>
<a href="#l2.172"></a><span id="l2.172" class="difflineplus">+    let folderURI = aFolder.URI;</span>
<a href="#l2.173"></a><span id="l2.173" class="difflineplus">+    let origURI = aNewAncestorURI &amp;&amp; aOrigAncestorURI ?</span>
<a href="#l2.174"></a><span id="l2.174" class="difflineplus">+                    folderURI.replace(aNewAncestorURI, aOrigAncestorURI) :</span>
<a href="#l2.175"></a><span id="l2.175" class="difflineplus">+                    aOrigFolder.URI;</span>
<a href="#l2.176"></a><span id="l2.176" class="difflineplus">+    let origFolderRes = this.rdf.GetResource(origURI);</span>
<a href="#l2.177"></a><span id="l2.177" class="difflineplus">+    this.log.debug(&quot;updateFolderChangeInFeedsDS: urls origURI  - &quot; + origURI);</span>
<a href="#l2.178"></a><span id="l2.178" class="difflineplus">+    // Get the original folder's url list from the feeds database.</span>
<a href="#l2.179"></a><span id="l2.179" class="difflineplus">+    let feedUrlArray = [];</span>
<a href="#l2.180"></a><span id="l2.180" class="difflineplus">+    let dsSrc = this.getSubscriptionsDS(aOrigFolder.server);</span>
<a href="#l2.181"></a><span id="l2.181" class="difflineplus">+    try {</span>
<a href="#l2.182"></a><span id="l2.182" class="difflineplus">+      let enumerator = dsSrc.GetSources(this.FZ_DESTFOLDER, origFolderRes, true);</span>
<a href="#l2.183"></a><span id="l2.183" class="difflineplus">+      while (enumerator.hasMoreElements())</span>
<a href="#l2.184"></a><span id="l2.184" class="difflineplus">+      {</span>
<a href="#l2.185"></a><span id="l2.185" class="difflineplus">+        let containerArc = enumerator.getNext();</span>
<a href="#l2.186"></a><span id="l2.186" class="difflineplus">+        let uri = containerArc.QueryInterface(Ci.nsIRDFResource).Value;</span>
<a href="#l2.187"></a><span id="l2.187" class="difflineplus">+        feedUrlArray.push(uri);</span>
<a href="#l2.188"></a><span id="l2.188" class="difflineplus">+      }</span>
<a href="#l2.189"></a><span id="l2.189" class="difflineplus">+    }</span>
<a href="#l2.190"></a><span id="l2.190" class="difflineplus">+    catch(ex)</span>
<a href="#l2.191"></a><span id="l2.191" class="difflineplus">+    {</span>
<a href="#l2.192"></a><span id="l2.192" class="difflineplus">+      this.log.error(&quot;updateFolderChangeInFeedsDS: feeds.rdf db error for account - &quot; +</span>
<a href="#l2.193"></a><span id="l2.193" class="difflineplus">+                     aOrigFolder.server.prettyName + &quot; : &quot; + ex);</span>
<a href="#l2.194"></a><span id="l2.194" class="difflineplus">+    }</span>
<a href="#l2.195"></a><span id="l2.195"> </span>
<a href="#l2.196"></a><span id="l2.196" class="difflineminus">-    if (!feedUrlArray)</span>
<a href="#l2.197"></a><span id="l2.197" class="difflineplus">+    if (!feedUrlArray.length)</span>
<a href="#l2.198"></a><span id="l2.198">     {</span>
<a href="#l2.199"></a><span id="l2.199">       this.log.debug(&quot;updateFolderChangeInFeedsDS: no feedUrls in this folder&quot;);</span>
<a href="#l2.200"></a><span id="l2.200">       return;</span>
<a href="#l2.201"></a><span id="l2.201">     }</span>
<a href="#l2.202"></a><span id="l2.202"> </span>
<a href="#l2.203"></a><span id="l2.203">     let id, resource, node;</span>
<a href="#l2.204"></a><span id="l2.204">     let ds = this.getSubscriptionsDS(aFolder.server);</span>
<a href="#l2.205"></a><span id="l2.205">     for (let feedUrl of feedUrlArray)</span>
<a href="#l2.206"></a><span id="l2.206">     {</span>
<a href="#l2.207"></a><span id="l2.207" class="difflineminus">-      if (!feedUrl)</span>
<a href="#l2.208"></a><span id="l2.208" class="difflineminus">-        continue;</span>
<a href="#l2.209"></a><span id="l2.209">       this.log.debug(&quot;updateFolderChangeInFeedsDS: feedUrl - &quot; + feedUrl);</span>
<a href="#l2.210"></a><span id="l2.210"> </span>
<a href="#l2.211"></a><span id="l2.211">       id = this.rdf.GetResource(feedUrl);</span>
<a href="#l2.212"></a><span id="l2.212">       // If move to trash, unsubscribe.</span>
<a href="#l2.213"></a><span id="l2.213">       if (this.isInTrash(aFolder))</span>
<a href="#l2.214"></a><span id="l2.214">       {</span>
<a href="#l2.215"></a><span id="l2.215">         this.deleteFeed(id, aFolder.server, aFolder);</span>
<a href="#l2.216"></a><span id="l2.216">       }</span>
<a href="#l2.217"></a><span id="l2.217" class="difflineat">@@ -340,17 +400,16 @@ var FeedUtils = {</span>
<a href="#l2.218"></a><span id="l2.218">         {</span>
<a href="#l2.219"></a><span id="l2.219">           ds.Change(id, this.FZ_DESTFOLDER, node, resource);</span>
<a href="#l2.220"></a><span id="l2.220">         }</span>
<a href="#l2.221"></a><span id="l2.221">         else</span>
<a href="#l2.222"></a><span id="l2.222">         {</span>
<a href="#l2.223"></a><span id="l2.223">           // If adding a new feed it's a cross account action; get the title</span>
<a href="#l2.224"></a><span id="l2.224">           // and quickMode from its original datasource, otherwise use the new</span>
<a href="#l2.225"></a><span id="l2.225">           // folder's name and default server quickMode.</span>
<a href="#l2.226"></a><span id="l2.226" class="difflineminus">-          let dsSrc = FeedUtils.getSubscriptionsDS(sourceFolder.server);</span>
<a href="#l2.227"></a><span id="l2.227">           let feedTitle = dsSrc.GetTarget(id, this.DC_TITLE, true);</span>
<a href="#l2.228"></a><span id="l2.228">           feedTitle = feedTitle ? feedTitle.QueryInterface(Ci.nsIRDFLiteral).Value :</span>
<a href="#l2.229"></a><span id="l2.229">                       resource.name;</span>
<a href="#l2.230"></a><span id="l2.230">           let quickMode = dsSrc.GetTarget(id, this.FZ_QUICKMODE, true);</span>
<a href="#l2.231"></a><span id="l2.231">           quickMode = quickMode.QueryInterface(Ci.nsIRDFLiteral).Value;</span>
<a href="#l2.232"></a><span id="l2.232">           quickMode = quickMode == &quot;true&quot; ? true :</span>
<a href="#l2.233"></a><span id="l2.233">                       quickMode == &quot;false&quot; ? false :</span>
<a href="#l2.234"></a><span id="l2.234">                       aFeed.folder.server.getBoolValue(&quot;quickMode&quot;);</span>
<a href="#l2.235"></a><span id="l2.235" class="difflineat">@@ -363,58 +422,16 @@ var FeedUtils = {</span>
<a href="#l2.236"></a><span id="l2.236">         }</span>
<a href="#l2.237"></a><span id="l2.237">       }</span>
<a href="#l2.238"></a><span id="l2.238">     }</span>
<a href="#l2.239"></a><span id="l2.239"> </span>
<a href="#l2.240"></a><span id="l2.240">     ds.Flush();</span>
<a href="#l2.241"></a><span id="l2.241">   },</span>
<a href="#l2.242"></a><span id="l2.242"> </span>
<a href="#l2.243"></a><span id="l2.243"> /**</span>
<a href="#l2.244"></a><span id="l2.244" class="difflineminus">- * Sync folder's feedUrl property with the folder's urls in the feeds.rdf</span>
<a href="#l2.245"></a><span id="l2.245" class="difflineminus">- * primary database. This secondary location is required for keeping the</span>
<a href="#l2.246"></a><span id="l2.246" class="difflineminus">- * primary feeds.rdf db synced with folder pathname changes.</span>
<a href="#l2.247"></a><span id="l2.247" class="difflineminus">- *</span>
<a href="#l2.248"></a><span id="l2.248" class="difflineminus">- * @param  nsIMsgFolder aFolder - the folder with the feed subscriptions</span>
<a href="#l2.249"></a><span id="l2.249" class="difflineminus">- */</span>
<a href="#l2.250"></a><span id="l2.250" class="difflineminus">-  syncFeedUrlWithFeedsDS: function(aFolder) {</span>
<a href="#l2.251"></a><span id="l2.251" class="difflineminus">-    if (!aFolder || this.isInTrash(aFolder))</span>
<a href="#l2.252"></a><span id="l2.252" class="difflineminus">-      return null;</span>
<a href="#l2.253"></a><span id="l2.253" class="difflineminus">-</span>
<a href="#l2.254"></a><span id="l2.254" class="difflineminus">-    let feedUrlArray = this.getFeedUrlsInFolder(aFolder);</span>
<a href="#l2.255"></a><span id="l2.255" class="difflineminus">-    let feedUrls = feedUrlArray ? feedUrlArray.join(this.kFeedUrlDelimiter) : &quot;&quot;;</span>
<a href="#l2.256"></a><span id="l2.256" class="difflineminus">-    let feedUrl = aFolder.getStringProperty(&quot;feedUrl&quot;);</span>
<a href="#l2.257"></a><span id="l2.257" class="difflineminus">-    if ((feedUrls &amp;&amp; feedUrl != feedUrls) || (!feedUrls &amp;&amp; feedUrl))</span>
<a href="#l2.258"></a><span id="l2.258" class="difflineminus">-    {</span>
<a href="#l2.259"></a><span id="l2.259" class="difflineminus">-      aFolder.setStringProperty(&quot;feedUrl&quot;, feedUrls);</span>
<a href="#l2.260"></a><span id="l2.260" class="difflineminus">-      this.log.debug(&quot;syncFeedUrlWithFeedsDS: synced feedUrl for folder - &quot; +</span>
<a href="#l2.261"></a><span id="l2.261" class="difflineminus">-                     aFolder.filePath.path);</span>
<a href="#l2.262"></a><span id="l2.262" class="difflineminus">-      this.log.debug(&quot;syncFeedUrlWithFeedsDS: setStringProperty - &quot; + feedUrls);</span>
<a href="#l2.263"></a><span id="l2.263" class="difflineminus">-      this.log.debug(&quot;syncFeedUrlWithFeedsDS: getCharProperty   - &quot; +</span>
<a href="#l2.264"></a><span id="l2.264" class="difflineminus">-                     aFolder.msgDatabase.dBFolderInfo.getCharProperty(&quot;feedUrl&quot;));</span>
<a href="#l2.265"></a><span id="l2.265" class="difflineminus">-    }</span>
<a href="#l2.266"></a><span id="l2.266" class="difflineminus">-    return feedUrlArray;</span>
<a href="#l2.267"></a><span id="l2.267" class="difflineminus">-  },</span>
<a href="#l2.268"></a><span id="l2.268" class="difflineminus">-</span>
<a href="#l2.269"></a><span id="l2.269" class="difflineminus">-/**</span>
<a href="#l2.270"></a><span id="l2.270" class="difflineminus">- * Return array of folder's feed urls.  Handle bad delimiter choice.</span>
<a href="#l2.271"></a><span id="l2.271" class="difflineminus">- *</span>
<a href="#l2.272"></a><span id="l2.272" class="difflineminus">- * @param  string aUrlString - the folder's feedUrl string property.</span>
<a href="#l2.273"></a><span id="l2.273" class="difflineminus">- * @return array             - array of urls or empty array if no property.</span>
<a href="#l2.274"></a><span id="l2.274" class="difflineminus">- */</span>
<a href="#l2.275"></a><span id="l2.275" class="difflineminus">-  splitFeedUrls: function(aUrlString) {</span>
<a href="#l2.276"></a><span id="l2.276" class="difflineminus">-    let urlStr = aUrlString.replace(this.kFeedUrlDelimiter + &quot;http://&quot;,</span>
<a href="#l2.277"></a><span id="l2.277" class="difflineminus">-                                    &quot;\x01http://&quot;, &quot;g&quot;)</span>
<a href="#l2.278"></a><span id="l2.278" class="difflineminus">-                           .replace(this.kFeedUrlDelimiter + &quot;https://&quot;,</span>
<a href="#l2.279"></a><span id="l2.279" class="difflineminus">-                                    &quot;\x01https://&quot;, &quot;g&quot;)</span>
<a href="#l2.280"></a><span id="l2.280" class="difflineminus">-                           .replace(this.kFeedUrlDelimiter + &quot;file://&quot;,</span>
<a href="#l2.281"></a><span id="l2.281" class="difflineminus">-                                    &quot;\x01file://&quot;, &quot;g&quot;);</span>
<a href="#l2.282"></a><span id="l2.282" class="difflineminus">-    return urlStr ? urlStr.split(&quot;\x01&quot;) : [];</span>
<a href="#l2.283"></a><span id="l2.283" class="difflineminus">-  },</span>
<a href="#l2.284"></a><span id="l2.284" class="difflineminus">-</span>
<a href="#l2.285"></a><span id="l2.285" class="difflineminus">-/**</span>
<a href="#l2.286"></a><span id="l2.286">  * When subscribing to feeds by dnd on, or adding a url to, the account</span>
<a href="#l2.287"></a><span id="l2.287">  * folder (only), or creating folder structure via opml import, a subfolder is</span>
<a href="#l2.288"></a><span id="l2.288">  * autocreated and thus the derived/given name must be sanitized to prevent</span>
<a href="#l2.289"></a><span id="l2.289">  * filesystem errors. Hashing invalid chars based on OS rather than filesystem</span>
<a href="#l2.290"></a><span id="l2.290">  * is not strictly correct.</span>
<a href="#l2.291"></a><span id="l2.291">  *</span>
<a href="#l2.292"></a><span id="l2.292">  * @param  nsIMsgFolder aParentFolder - parent folder</span>
<a href="#l2.293"></a><span id="l2.293">  * @param  string       aProposedName - proposed name</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/extensions/newsblog/content/feed-subscriptions.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/extensions/newsblog/content/feed-subscriptions.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -1319,19 +1319,16 @@ var FeedSubscriptions = {</span>
<a href="#l3.4"></a><span id="l3.4">         // No moving to account folder if already in the account; can only move,</span>
<a href="#l3.5"></a><span id="l3.5">         // not copy, to folder in the same account.</span>
<a href="#l3.6"></a><span id="l3.6">         return;</span>
<a href="#l3.7"></a><span id="l3.7"> </span>
<a href="#l3.8"></a><span id="l3.8">       // Unassert the older URI, add an assertion for the new parent URI.</span>
<a href="#l3.9"></a><span id="l3.9">       ds.Change(resource, FeedUtils.FZ_DESTFOLDER,</span>
<a href="#l3.10"></a><span id="l3.10">                 currentParentResource, newParentResource);</span>
<a href="#l3.11"></a><span id="l3.11">       ds.Flush();</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-      // Sync the feedUrl property for each folder.</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-      FeedUtils.syncFeedUrlWithFeedsDS(currentFolder);</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-      FeedUtils.syncFeedUrlWithFeedsDS(newFolder);</span>
<a href="#l3.15"></a><span id="l3.15">     }</span>
<a href="#l3.16"></a><span id="l3.16">     else</span>
<a href="#l3.17"></a><span id="l3.17">     {</span>
<a href="#l3.18"></a><span id="l3.18">       // Moving/copying to a new account.  If dropping on the account folder,</span>
<a href="#l3.19"></a><span id="l3.19">       // a new subfolder is created if necessary.</span>
<a href="#l3.20"></a><span id="l3.20">       accountMoveCopy = true;</span>
<a href="#l3.21"></a><span id="l3.21">       let mode = moveFeed ? this.kMoveMode : this.kCopyMode;</span>
<a href="#l3.22"></a><span id="l3.22">       let params = {quickMode: currentItem.quickMode,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/extensions/newsblog/js/newsblog.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/extensions/newsblog/js/newsblog.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -6,17 +6,17 @@</span>
<a href="#l4.4"></a><span id="l4.4"> var {classes: Cc, interfaces: Ci, utils: Cu, results: Cr} = Components;</span>
<a href="#l4.5"></a><span id="l4.5"> </span>
<a href="#l4.6"></a><span id="l4.6"> Cu.import(&quot;resource:///modules/FeedUtils.jsm&quot;);</span>
<a href="#l4.7"></a><span id="l4.7"> Cu.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l4.8"></a><span id="l4.8"> Cu.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l4.9"></a><span id="l4.9"> </span>
<a href="#l4.10"></a><span id="l4.10"> var nsNewsBlogFeedDownloader =</span>
<a href="#l4.11"></a><span id="l4.11"> {</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-  downloadFeed: function(aA, aFolder, aB, aC, aUrlListener, aMsgWindow)</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+  downloadFeed: function(aFolder, aUrlListener, aMsgWindow)</span>
<a href="#l4.14"></a><span id="l4.14">   {</span>
<a href="#l4.15"></a><span id="l4.15">     if (Services.io.offline)</span>
<a href="#l4.16"></a><span id="l4.16">       return;</span>
<a href="#l4.17"></a><span id="l4.17"> </span>
<a href="#l4.18"></a><span id="l4.18">     // We don't yet support the ability to check for new articles while we are</span>
<a href="#l4.19"></a><span id="l4.19">     // in the middle of subscribing to a feed. For now, abort the check for</span>
<a href="#l4.20"></a><span id="l4.20">     // new feeds.</span>
<a href="#l4.21"></a><span id="l4.21">     if (FeedUtils.progressNotifier.mSubscribeMode)</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineat">@@ -63,42 +63,39 @@ var nsNewsBlogFeedDownloader =</span>
<a href="#l4.23"></a><span id="l4.23">             // Ignore error returns.</span>
<a href="#l4.24"></a><span id="l4.24">             folder.QueryInterface(Ci.nsIMsgLocalMailFolder).</span>
<a href="#l4.25"></a><span id="l4.25">                    getDatabaseWithReparse(null, null);</span>
<a href="#l4.26"></a><span id="l4.26">           }</span>
<a href="#l4.27"></a><span id="l4.27">           catch (ex) {}</span>
<a href="#l4.28"></a><span id="l4.28">           continue;</span>
<a href="#l4.29"></a><span id="l4.29">         }</span>
<a href="#l4.30"></a><span id="l4.30"> </span>
<a href="#l4.31"></a><span id="l4.31" class="difflineminus">-        let feedUrlArray = FeedUtils.syncFeedUrlWithFeedsDS(folder);</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+        let feedUrlArray = FeedUtils.getFeedUrlsInFolder(folder);</span>
<a href="#l4.33"></a><span id="l4.33">         // Continue if there are no feedUrls for the folder in the feeds</span>
<a href="#l4.34"></a><span id="l4.34">         // database.  All folders in Trash are skipped.</span>
<a href="#l4.35"></a><span id="l4.35">         if (!feedUrlArray)</span>
<a href="#l4.36"></a><span id="l4.36">           continue;</span>
<a href="#l4.37"></a><span id="l4.37"> </span>
<a href="#l4.38"></a><span id="l4.38">         FeedUtils.log.debug(&quot;downloadFeed: CONTINUE foldername:urlArray - &quot; +</span>
<a href="#l4.39"></a><span id="l4.39">                             folder.name + &quot;:&quot; + feedUrlArray);</span>
<a href="#l4.40"></a><span id="l4.40"> </span>
<a href="#l4.41"></a><span id="l4.41">         FeedUtils.progressNotifier.init(aMsgWindow, false);</span>
<a href="#l4.42"></a><span id="l4.42"> </span>
<a href="#l4.43"></a><span id="l4.43">         // We need to kick off a download for each feed.</span>
<a href="#l4.44"></a><span id="l4.44">         let id, feed;</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineminus">-        for (let url in feedUrlArray)</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineplus">+        for (let url of feedUrlArray)</span>
<a href="#l4.47"></a><span id="l4.47">         {</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineminus">-          if (feedUrlArray[url])</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineminus">-          {</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineminus">-            id = FeedUtils.rdf.GetResource(feedUrlArray[url]);</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineminus">-            feed = new Feed(id, folder.server);</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineminus">-            feed.folder = folder;</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineminus">-            // Bump our pending feed download count.</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineminus">-            FeedUtils.progressNotifier.mNumPendingFeedDownloads++;</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineminus">-            feed.download(true, FeedUtils.progressNotifier);</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineminus">-            FeedUtils.log.debug(&quot;downloadFeed: DOWNLOAD feed url - &quot; +</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineminus">-                                feedUrlArray[url]);</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineminus">-          }</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineplus">+          id = FeedUtils.rdf.GetResource(url);</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineplus">+          feed = new Feed(id, folder.server);</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineplus">+          feed.folder = folder;</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineplus">+          // Bump our pending feed download count.</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineplus">+          FeedUtils.progressNotifier.mNumPendingFeedDownloads++;</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineplus">+          feed.download(true, FeedUtils.progressNotifier);</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineplus">+          FeedUtils.log.debug(&quot;downloadFeed: DOWNLOAD feed url - &quot; +</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineplus">+                              feedUrlArray[url]);</span>
<a href="#l4.67"></a><span id="l4.67"> </span>
<a href="#l4.68"></a><span id="l4.68">           Services.tm.mainThread.dispatch(function() {</span>
<a href="#l4.69"></a><span id="l4.69">             try {</span>
<a href="#l4.70"></a><span id="l4.70">               getFeed.next();</span>
<a href="#l4.71"></a><span id="l4.71">             }</span>
<a href="#l4.72"></a><span id="l4.72">             catch (ex) {</span>
<a href="#l4.73"></a><span id="l4.73">               if (ex instanceof StopIteration)</span>
<a href="#l4.74"></a><span id="l4.74">                 // Finished with all feeds in base folder and its subfolders.</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineat">@@ -201,45 +198,19 @@ var nsNewsBlogFeedDownloader =</span>
<a href="#l4.76"></a><span id="l4.76">     if (!aFolder.isServer)</span>
<a href="#l4.77"></a><span id="l4.77">       feed.folder = aFolder;</span>
<a href="#l4.78"></a><span id="l4.78"> </span>
<a href="#l4.79"></a><span id="l4.79">     FeedUtils.progressNotifier.init(aMsgWindow, true);</span>
<a href="#l4.80"></a><span id="l4.80">     FeedUtils.progressNotifier.mNumPendingFeedDownloads++;</span>
<a href="#l4.81"></a><span id="l4.81">     feed.download(true, FeedUtils.progressNotifier);</span>
<a href="#l4.82"></a><span id="l4.82">   },</span>
<a href="#l4.83"></a><span id="l4.83"> </span>
<a href="#l4.84"></a><span id="l4.84" class="difflineminus">-  updateSubscriptionsDS: function(aFolder, aOrigFolder)</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineplus">+  updateSubscriptionsDS: function(aFolder, aOrigFolder, aAction)</span>
<a href="#l4.86"></a><span id="l4.86">   {</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineminus">-    FeedUtils.log.debug(&quot;updateSubscriptionsDS: folder changed, aFolder - &quot; +</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineminus">-                        aFolder.filePath.path);</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineminus">-    FeedUtils.log.debug(&quot;updateSubscriptionsDS: &quot; + (aOrigFolder ?</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineminus">-                        &quot;move/copy, aOrigFolder  - &quot; + aOrigFolder.filePath.path :</span>
<a href="#l4.91"></a><span id="l4.91" class="difflineminus">-                        &quot;rename&quot;));</span>
<a href="#l4.92"></a><span id="l4.92" class="difflineminus">-</span>
<a href="#l4.93"></a><span id="l4.93" class="difflineminus">-    if ((aOrigFolder &amp;&amp; FeedUtils.isInTrash(aOrigFolder)) ||</span>
<a href="#l4.94"></a><span id="l4.94" class="difflineminus">-        (!aOrigFolder &amp;&amp; FeedUtils.isInTrash(aFolder)))</span>
<a href="#l4.95"></a><span id="l4.95" class="difflineminus">-      // Move within trash, or rename in trash; no subscriptions already.</span>
<a href="#l4.96"></a><span id="l4.96" class="difflineminus">-      return;</span>
<a href="#l4.97"></a><span id="l4.97" class="difflineminus">-</span>
<a href="#l4.98"></a><span id="l4.98" class="difflineminus">-    let newFolder = aFolder;</span>
<a href="#l4.99"></a><span id="l4.99" class="difflineminus">-    if (aOrigFolder)</span>
<a href="#l4.100"></a><span id="l4.100" class="difflineminus">-      // A folder was moved, get the new folder. Don't process the entire parent!</span>
<a href="#l4.101"></a><span id="l4.101" class="difflineminus">-      newFolder = aFolder.getChildNamed(aOrigFolder.name);</span>
<a href="#l4.102"></a><span id="l4.102" class="difflineminus">-</span>
<a href="#l4.103"></a><span id="l4.103" class="difflineminus">-    FeedUtils.updateFolderChangeInFeedsDS(newFolder, aOrigFolder);</span>
<a href="#l4.104"></a><span id="l4.104" class="difflineminus">-</span>
<a href="#l4.105"></a><span id="l4.105" class="difflineminus">-    // There may be subfolders, but we only get a single notification; iterate</span>
<a href="#l4.106"></a><span id="l4.106" class="difflineminus">-    // over all descendent folders of the folder whose location has changed.</span>
<a href="#l4.107"></a><span id="l4.107" class="difflineminus">-    let subFolders = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l4.108"></a><span id="l4.108" class="difflineminus">-    newFolder.ListDescendants(subFolders);</span>
<a href="#l4.109"></a><span id="l4.109" class="difflineminus">-    for (let i = 0; i &lt; subFolders.length; i++)</span>
<a href="#l4.110"></a><span id="l4.110" class="difflineminus">-    {</span>
<a href="#l4.111"></a><span id="l4.111" class="difflineminus">-      let subFolder = subFolders.queryElementAt(i, Ci.nsIMsgFolder);</span>
<a href="#l4.112"></a><span id="l4.112" class="difflineminus">-      FeedUtils.updateFolderChangeInFeedsDS(subFolder, aOrigFolder);</span>
<a href="#l4.113"></a><span id="l4.113" class="difflineminus">-    }</span>
<a href="#l4.114"></a><span id="l4.114" class="difflineplus">+    FeedUtils.updateSubscriptionsDS(aFolder, aOrigFolder, aAction);</span>
<a href="#l4.115"></a><span id="l4.115">   },</span>
<a href="#l4.116"></a><span id="l4.116"> </span>
<a href="#l4.117"></a><span id="l4.117">   QueryInterface: function(aIID)</span>
<a href="#l4.118"></a><span id="l4.118">   {</span>
<a href="#l4.119"></a><span id="l4.119">     if (aIID.equals(Ci.nsINewsBlogFeedDownloader) ||</span>
<a href="#l4.120"></a><span id="l4.120">         aIID.equals(Ci.nsISupports))</span>
<a href="#l4.121"></a><span id="l4.121">       return this;</span>
<a href="#l4.122"></a><span id="l4.122"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/local/public/nsINewsBlogFeedDownloader.idl</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/local/public/nsINewsBlogFeedDownloader.idl</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -3,30 +3,38 @@</span>
<a href="#l5.4"></a><span id="l5.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l5.5"></a><span id="l5.5"> </span>
<a href="#l5.6"></a><span id="l5.6"> #include &quot;nsISupports.idl&quot;</span>
<a href="#l5.7"></a><span id="l5.7"> </span>
<a href="#l5.8"></a><span id="l5.8"> interface nsIMsgFolder;</span>
<a href="#l5.9"></a><span id="l5.9"> interface nsIUrlListener;</span>
<a href="#l5.10"></a><span id="l5.10"> interface nsIMsgWindow;</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-[scriptable, uuid(6839c636-41c2-11e3-b346-00269e4fddc1)]</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+[scriptable, uuid(a74a60ce-7a4d-11e3-b4ca-00269e4fddc1)]</span>
<a href="#l5.14"></a><span id="l5.14"> interface nsINewsBlogFeedDownloader : nsISupports</span>
<a href="#l5.15"></a><span id="l5.15"> {</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineminus">-  void downloadFeed(in string aUrl, in nsIMsgFolder aFolder,</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineminus">-                    in boolean aQuickMode, in wstring aTitle,</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineminus">-                    in nsIUrlListener aUrlListener, in nsIMsgWindow aMsgWindow);</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineplus">+  void downloadFeed(in nsIMsgFolder aFolder,</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineplus">+                    in nsIUrlListener aUrlListener,</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineplus">+                    in nsIMsgWindow aMsgWindow);</span>
<a href="#l5.22"></a><span id="l5.22"> </span>
<a href="#l5.23"></a><span id="l5.23">   /**</span>
<a href="#l5.24"></a><span id="l5.24">    * A convient method to subscribe to feeds without going through the Subscribe</span>
<a href="#l5.25"></a><span id="l5.25">    * dialog; used by drag and drop and commandline.</span>
<a href="#l5.26"></a><span id="l5.26">    */</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineminus">-  void subscribeToFeed(in string aUrl, in nsIMsgFolder aFolder,</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineplus">+  void subscribeToFeed(in string aUrl,</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineplus">+                       in nsIMsgFolder aFolder,</span>
<a href="#l5.30"></a><span id="l5.30">                        in nsIMsgWindow aMsgWindow);</span>
<a href="#l5.31"></a><span id="l5.31"> </span>
<a href="#l5.32"></a><span id="l5.32">   /**</span>
<a href="#l5.33"></a><span id="l5.33">    * Called when the RSS Incoming Server detects a change to an RSS folder name,</span>
<a href="#l5.34"></a><span id="l5.34">    * such as delete (move to trash), move/copy, or rename. We then need to update</span>
<a href="#l5.35"></a><span id="l5.35">    * the feeds.rdf subscriptions data source.</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineplus">+   *</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineplus">+   * @param  nsIMsgFolder aFolder      - the folder, new if rename or target of</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineplus">+   *                                      move/copy folder (new parent)</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineplus">+   * @param  nsIMsgFolder aOrigFolder  - original folder</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineplus">+   * @param  string aAction            - &quot;move&quot; or &quot;copy&quot; or &quot;rename&quot;</span>
<a href="#l5.41"></a><span id="l5.41">    */</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineminus">-  void updateSubscriptionsDS(in nsIMsgFolder aFolder, in nsIMsgFolder aOrigFolder);</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineplus">+  void updateSubscriptionsDS(in nsIMsgFolder aFolder,</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineplus">+                             in nsIMsgFolder aOrigFolder,</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineplus">+                             in string aAction);</span>
<a href="#l5.46"></a><span id="l5.46"> };</span>
<a href="#l5.47"></a><span id="l5.47"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/local/src/nsRssIncomingServer.cpp</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/local/src/nsRssIncomingServer.cpp</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -54,25 +54,26 @@ nsRssIncomingServer::~nsRssIncomingServe</span>
<a href="#l6.4"></a><span id="l6.4">     nsresult rv;</span>
<a href="#l6.5"></a><span id="l6.5">     nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifyService =</span>
<a href="#l6.6"></a><span id="l6.6">       do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l6.7"></a><span id="l6.7">     if (NS_SUCCEEDED(rv))</span>
<a href="#l6.8"></a><span id="l6.8">       notifyService-&gt;RemoveListener(this);</span>
<a href="#l6.9"></a><span id="l6.9">   }</span>
<a href="#l6.10"></a><span id="l6.10"> }</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-nsresult nsRssIncomingServer::FillInDataSourcePath(const nsAString&amp; aDataSourceName, nsIFile ** aLocation)</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+nsresult nsRssIncomingServer::FillInDataSourcePath(const nsAString&amp; aDataSourceName,</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+                                                   nsIFile ** aLocation)</span>
<a href="#l6.15"></a><span id="l6.15"> {</span>
<a href="#l6.16"></a><span id="l6.16">   nsresult rv;</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineminus">-  // start by gettting the local path for this server</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineplus">+  // Get the local path for this server.</span>
<a href="#l6.19"></a><span id="l6.19">   nsCOMPtr&lt;nsIFile&gt; localFile;</span>
<a href="#l6.20"></a><span id="l6.20">   rv = GetLocalPath(getter_AddRefs(localFile));</span>
<a href="#l6.21"></a><span id="l6.21">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.22"></a><span id="l6.22"> </span>
<a href="#l6.23"></a><span id="l6.23" class="difflineminus">-  // now append the name of the subscriptions data source</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineplus">+  // Append the name of the subscriptions data source.</span>
<a href="#l6.25"></a><span id="l6.25">   rv = localFile-&gt;Append(aDataSourceName);</span>
<a href="#l6.26"></a><span id="l6.26">   NS_IF_ADDREF(*aLocation = localFile);</span>
<a href="#l6.27"></a><span id="l6.27">   return rv;</span>
<a href="#l6.28"></a><span id="l6.28"> }</span>
<a href="#l6.29"></a><span id="l6.29"> </span>
<a href="#l6.30"></a><span id="l6.30"> // nsIRSSIncomingServer methods</span>
<a href="#l6.31"></a><span id="l6.31"> NS_IMETHODIMP nsRssIncomingServer::GetSubscriptionsDataSourcePath(nsIFile ** aLocation)</span>
<a href="#l6.32"></a><span id="l6.32"> {</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineat">@@ -81,18 +82,17 @@ NS_IMETHODIMP nsRssIncomingServer::GetSu</span>
<a href="#l6.34"></a><span id="l6.34"> </span>
<a href="#l6.35"></a><span id="l6.35"> NS_IMETHODIMP nsRssIncomingServer::GetFeedItemsDataSourcePath(nsIFile ** aLocation)</span>
<a href="#l6.36"></a><span id="l6.36"> {</span>
<a href="#l6.37"></a><span id="l6.37">   return FillInDataSourcePath(NS_LITERAL_STRING(&quot;feeditems.rdf&quot;), aLocation);</span>
<a href="#l6.38"></a><span id="l6.38"> }</span>
<a href="#l6.39"></a><span id="l6.39"> </span>
<a href="#l6.40"></a><span id="l6.40"> NS_IMETHODIMP nsRssIncomingServer::CreateDefaultMailboxes()</span>
<a href="#l6.41"></a><span id="l6.41"> {</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineminus">-  // for RSS, all we have is Trash</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineminus">-  // XXX or should we be use Local Folders/Trash?</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineplus">+  // For Feeds, all we have is Trash.</span>
<a href="#l6.45"></a><span id="l6.45">   return CreateLocalFolder(NS_LITERAL_STRING(&quot;Trash&quot;));</span>
<a href="#l6.46"></a><span id="l6.46"> }</span>
<a href="#l6.47"></a><span id="l6.47"> </span>
<a href="#l6.48"></a><span id="l6.48"> NS_IMETHODIMP nsRssIncomingServer::SetFlagsOnDefaultMailboxes()</span>
<a href="#l6.49"></a><span id="l6.49"> {</span>
<a href="#l6.50"></a><span id="l6.50">   nsCOMPtr&lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l6.51"></a><span id="l6.51">   nsresult rv = GetRootFolder(getter_AddRefs(rootFolder));</span>
<a href="#l6.52"></a><span id="l6.52">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineat">@@ -110,25 +110,28 @@ NS_IMETHODIMP nsRssIncomingServer::Perfo</span>
<a href="#l6.54"></a><span id="l6.54">   // Get the account root (server) folder and pass it on.</span>
<a href="#l6.55"></a><span id="l6.55">   nsCOMPtr&lt;nsIMsgFolder&gt; rootRSSFolder;</span>
<a href="#l6.56"></a><span id="l6.56">   GetRootMsgFolder(getter_AddRefs(rootRSSFolder));</span>
<a href="#l6.57"></a><span id="l6.57">   nsCOMPtr&lt;nsIUrlListener&gt; urlListener = do_QueryInterface(rootRSSFolder);</span>
<a href="#l6.58"></a><span id="l6.58">   GetNewMail(aMsgWindow, urlListener, rootRSSFolder, nullptr);</span>
<a href="#l6.59"></a><span id="l6.59">   return NS_OK;</span>
<a href="#l6.60"></a><span id="l6.60"> }</span>
<a href="#l6.61"></a><span id="l6.61"> </span>
<a href="#l6.62"></a><span id="l6.62" class="difflineminus">-NS_IMETHODIMP nsRssIncomingServer::GetNewMail(nsIMsgWindow *aMsgWindow, nsIUrlListener *aUrlListener,</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineminus">-                                              nsIMsgFolder *aFolder, nsIURI **_retval)</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineplus">+NS_IMETHODIMP nsRssIncomingServer::GetNewMail(nsIMsgWindow *aMsgWindow,</span>
<a href="#l6.65"></a><span id="l6.65" class="difflineplus">+                                              nsIUrlListener *aUrlListener,</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineplus">+                                              nsIMsgFolder *aFolder,</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineplus">+                                              nsIURI **_retval)</span>
<a href="#l6.68"></a><span id="l6.68"> {</span>
<a href="#l6.69"></a><span id="l6.69">   // Pass the selected folder on to the downloader.</span>
<a href="#l6.70"></a><span id="l6.70">   NS_ENSURE_ARG_POINTER(aFolder);</span>
<a href="#l6.71"></a><span id="l6.71">   nsresult rv;</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineminus">-  nsCOMPtr &lt;nsINewsBlogFeedDownloader&gt; rssDownloader = do_GetService(&quot;@mozilla.org/newsblog-feed-downloader;1&quot;, &amp;rv);</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineplus">+  nsCOMPtr&lt;nsINewsBlogFeedDownloader&gt; rssDownloader =</span>
<a href="#l6.74"></a><span id="l6.74" class="difflineplus">+    do_GetService(&quot;@mozilla.org/newsblog-feed-downloader;1&quot;, &amp;rv);</span>
<a href="#l6.75"></a><span id="l6.75">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.76"></a><span id="l6.76" class="difflineminus">-  rssDownloader-&gt;DownloadFeed(nullptr, aFolder, false, nullptr, aUrlListener, aMsgWindow);</span>
<a href="#l6.77"></a><span id="l6.77" class="difflineplus">+  rssDownloader-&gt;DownloadFeed(aFolder, aUrlListener, aMsgWindow);</span>
<a href="#l6.78"></a><span id="l6.78">   return NS_OK;</span>
<a href="#l6.79"></a><span id="l6.79"> }</span>
<a href="#l6.80"></a><span id="l6.80"> </span>
<a href="#l6.81"></a><span id="l6.81"> NS_IMETHODIMP nsRssIncomingServer::GetAccountManagerChrome(nsAString&amp; aResult)</span>
<a href="#l6.82"></a><span id="l6.82"> {</span>
<a href="#l6.83"></a><span id="l6.83">   aResult.AssignLiteral(&quot;am-newsblog.xul&quot;);</span>
<a href="#l6.84"></a><span id="l6.84">   return NS_OK;</span>
<a href="#l6.85"></a><span id="l6.85"> }</span>
<a href="#l6.86"></a><span id="l6.86" class="difflineat">@@ -145,17 +148,18 @@ NS_IMETHODIMP nsRssIncomingServer::GetSu</span>
<a href="#l6.87"></a><span id="l6.87">   NS_ENSURE_ARG_POINTER(aSupportsDiskSpace);</span>
<a href="#l6.88"></a><span id="l6.88">   *aSupportsDiskSpace = true;</span>
<a href="#l6.89"></a><span id="l6.89">   return NS_OK;</span>
<a href="#l6.90"></a><span id="l6.90"> }</span>
<a href="#l6.91"></a><span id="l6.91"> </span>
<a href="#l6.92"></a><span id="l6.92"> NS_IMETHODIMP nsRssIncomingServer::GetServerRequiresPasswordForBiff(bool *aServerRequiresPasswordForBiff)</span>
<a href="#l6.93"></a><span id="l6.93"> {</span>
<a href="#l6.94"></a><span id="l6.94">   NS_ENSURE_ARG_POINTER(aServerRequiresPasswordForBiff);</span>
<a href="#l6.95"></a><span id="l6.95" class="difflineminus">-  *aServerRequiresPasswordForBiff = false;  // for rss folders, we don't require a password</span>
<a href="#l6.96"></a><span id="l6.96" class="difflineplus">+  // For Feed folders, we don't require a password.</span>
<a href="#l6.97"></a><span id="l6.97" class="difflineplus">+  *aServerRequiresPasswordForBiff = false;</span>
<a href="#l6.98"></a><span id="l6.98">   return NS_OK;</span>
<a href="#l6.99"></a><span id="l6.99"> }</span>
<a href="#l6.100"></a><span id="l6.100"> </span>
<a href="#l6.101"></a><span id="l6.101"> NS_IMETHODIMP nsRssIncomingServer::GetCanSearchMessages(bool *canSearchMessages)</span>
<a href="#l6.102"></a><span id="l6.102"> {</span>
<a href="#l6.103"></a><span id="l6.103">   NS_ENSURE_ARG_POINTER(canSearchMessages);</span>
<a href="#l6.104"></a><span id="l6.104">   *canSearchMessages = true;</span>
<a href="#l6.105"></a><span id="l6.105">   return NS_OK;</span>
<a href="#l6.106"></a><span id="l6.106" class="difflineat">@@ -173,18 +177,19 @@ NS_IMETHODIMP nsRssIncomingServer::MsgsC</span>
<a href="#l6.107"></a><span id="l6.107">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l6.108"></a><span id="l6.108"> }</span>
<a href="#l6.109"></a><span id="l6.109"> </span>
<a href="#l6.110"></a><span id="l6.110"> NS_IMETHODIMP nsRssIncomingServer::MsgsDeleted(nsIArray *aMsgs)</span>
<a href="#l6.111"></a><span id="l6.111"> {</span>
<a href="#l6.112"></a><span id="l6.112">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l6.113"></a><span id="l6.113"> }</span>
<a href="#l6.114"></a><span id="l6.114"> </span>
<a href="#l6.115"></a><span id="l6.115" class="difflineminus">-NS_IMETHODIMP nsRssIncomingServer::MsgsMoveCopyCompleted(</span>
<a href="#l6.116"></a><span id="l6.116" class="difflineminus">-  bool aMove, nsIArray *aSrcMsgs, nsIMsgFolder *aDestFolder,</span>
<a href="#l6.117"></a><span id="l6.117" class="difflineplus">+NS_IMETHODIMP nsRssIncomingServer::MsgsMoveCopyCompleted(bool aMove,</span>
<a href="#l6.118"></a><span id="l6.118" class="difflineplus">+                                                         nsIArray *aSrcMsgs,</span>
<a href="#l6.119"></a><span id="l6.119" class="difflineplus">+                                                         nsIMsgFolder *aDestFolder,</span>
<a href="#l6.120"></a><span id="l6.120">   nsIArray *aDestMsgs)</span>
<a href="#l6.121"></a><span id="l6.121"> {</span>
<a href="#l6.122"></a><span id="l6.122">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l6.123"></a><span id="l6.123"> }</span>
<a href="#l6.124"></a><span id="l6.124"> </span>
<a href="#l6.125"></a><span id="l6.125"> NS_IMETHODIMP nsRssIncomingServer::MsgKeyChanged(nsMsgKey aOldKey,</span>
<a href="#l6.126"></a><span id="l6.126">                                                  nsIMsgDBHdr *aNewHdr)</span>
<a href="#l6.127"></a><span id="l6.127"> {</span>
<a href="#l6.128"></a><span id="l6.128" class="difflineat">@@ -201,50 +206,48 @@ NS_IMETHODIMP nsRssIncomingServer::Folde</span>
<a href="#l6.129"></a><span id="l6.129"> NS_IMETHODIMP nsRssIncomingServer::FolderDeleted(nsIMsgFolder *aFolder)</span>
<a href="#l6.130"></a><span id="l6.130"> {</span>
<a href="#l6.131"></a><span id="l6.131">   // Not necessary for folder deletes, which are move to Trash and handled by</span>
<a href="#l6.132"></a><span id="l6.132">   // movecopy. Virtual folder or trash folder deletes send a folderdeleted,</span>
<a href="#l6.133"></a><span id="l6.133">   // but these should have no subscriptions already.</span>
<a href="#l6.134"></a><span id="l6.134">   return NS_OK;</span>
<a href="#l6.135"></a><span id="l6.135"> }</span>
<a href="#l6.136"></a><span id="l6.136"> </span>
<a href="#l6.137"></a><span id="l6.137" class="difflineminus">-NS_IMETHODIMP nsRssIncomingServer::FolderMoveCopyCompleted(bool aMove, nsIMsgFolder *aSrcFolder, nsIMsgFolder *aDestFolder)</span>
<a href="#l6.138"></a><span id="l6.138" class="difflineplus">+NS_IMETHODIMP nsRssIncomingServer::FolderMoveCopyCompleted(bool aMove,</span>
<a href="#l6.139"></a><span id="l6.139" class="difflineplus">+                                                           nsIMsgFolder *aSrcFolder,</span>
<a href="#l6.140"></a><span id="l6.140" class="difflineplus">+                                                           nsIMsgFolder *aDestFolder)</span>
<a href="#l6.141"></a><span id="l6.141"> {</span>
<a href="#l6.142"></a><span id="l6.142" class="difflineminus">-  return FolderChanged(aDestFolder, aSrcFolder);</span>
<a href="#l6.143"></a><span id="l6.143" class="difflineplus">+  return FolderChanged(aDestFolder, aSrcFolder, (aMove ? &quot;move&quot; : &quot;copy&quot;));</span>
<a href="#l6.144"></a><span id="l6.144"> }</span>
<a href="#l6.145"></a><span id="l6.145"> </span>
<a href="#l6.146"></a><span id="l6.146" class="difflineminus">-NS_IMETHODIMP nsRssIncomingServer::FolderRenamed(nsIMsgFolder *aOrigFolder, nsIMsgFolder *aNewFolder)</span>
<a href="#l6.147"></a><span id="l6.147" class="difflineplus">+NS_IMETHODIMP nsRssIncomingServer::FolderRenamed(nsIMsgFolder *aOrigFolder,</span>
<a href="#l6.148"></a><span id="l6.148" class="difflineplus">+                                                 nsIMsgFolder *aNewFolder)</span>
<a href="#l6.149"></a><span id="l6.149"> {</span>
<a href="#l6.150"></a><span id="l6.150" class="difflineminus">-  return FolderChanged(aNewFolder, nullptr);</span>
<a href="#l6.151"></a><span id="l6.151" class="difflineplus">+  return FolderChanged(aNewFolder, aOrigFolder, &quot;rename&quot;);</span>
<a href="#l6.152"></a><span id="l6.152"> }</span>
<a href="#l6.153"></a><span id="l6.153"> </span>
<a href="#l6.154"></a><span id="l6.154" class="difflineminus">-NS_IMETHODIMP nsRssIncomingServer::ItemEvent(nsISupports *aItem, const nsACString &amp;aEvent, nsISupports *aData)</span>
<a href="#l6.155"></a><span id="l6.155" class="difflineplus">+NS_IMETHODIMP nsRssIncomingServer::ItemEvent(nsISupports *aItem,</span>
<a href="#l6.156"></a><span id="l6.156" class="difflineplus">+                                             const nsACString &amp;aEvent,</span>
<a href="#l6.157"></a><span id="l6.157" class="difflineplus">+                                             nsISupports *aData)</span>
<a href="#l6.158"></a><span id="l6.158"> {</span>
<a href="#l6.159"></a><span id="l6.159">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l6.160"></a><span id="l6.160"> }</span>
<a href="#l6.161"></a><span id="l6.161"> </span>
<a href="#l6.162"></a><span id="l6.162" class="difflineminus">-nsresult nsRssIncomingServer::FolderChanged(nsIMsgFolder *aFolder, nsIMsgFolder *aOrigFolder)</span>
<a href="#l6.163"></a><span id="l6.163" class="difflineplus">+nsresult nsRssIncomingServer::FolderChanged(nsIMsgFolder *aFolder,</span>
<a href="#l6.164"></a><span id="l6.164" class="difflineplus">+                                            nsIMsgFolder *aOrigFolder,</span>
<a href="#l6.165"></a><span id="l6.165" class="difflineplus">+                                            const char *aAction)</span>
<a href="#l6.166"></a><span id="l6.166"> {</span>
<a href="#l6.167"></a><span id="l6.167">   if (!aFolder)</span>
<a href="#l6.168"></a><span id="l6.168">     return NS_OK;</span>
<a href="#l6.169"></a><span id="l6.169"> </span>
<a href="#l6.170"></a><span id="l6.170" class="difflineminus">-  nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l6.171"></a><span id="l6.171" class="difflineminus">-  nsresult rv = aFolder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l6.172"></a><span id="l6.172" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.173"></a><span id="l6.173" class="difflineminus">-</span>
<a href="#l6.174"></a><span id="l6.174" class="difflineminus">-  nsCString type;</span>
<a href="#l6.175"></a><span id="l6.175" class="difflineminus">-  rv = server-&gt;GetType(type);</span>
<a href="#l6.176"></a><span id="l6.176" class="difflineplus">+  nsresult rv;</span>
<a href="#l6.177"></a><span id="l6.177" class="difflineplus">+  nsCOMPtr&lt;nsINewsBlogFeedDownloader&gt; rssDownloader =</span>
<a href="#l6.178"></a><span id="l6.178" class="difflineplus">+    do_GetService(&quot;@mozilla.org/newsblog-feed-downloader;1&quot;, &amp;rv);</span>
<a href="#l6.179"></a><span id="l6.179">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.180"></a><span id="l6.180" class="difflineminus">-</span>
<a href="#l6.181"></a><span id="l6.181" class="difflineminus">-  if (!type.EqualsLiteral(&quot;rss&quot;))</span>
<a href="#l6.182"></a><span id="l6.182" class="difflineminus">-    return rv;</span>
<a href="#l6.183"></a><span id="l6.183" class="difflineminus">-</span>
<a href="#l6.184"></a><span id="l6.184" class="difflineminus">-  nsCOMPtr &lt;nsINewsBlogFeedDownloader&gt; rssDownloader = do_GetService(&quot;@mozilla.org/newsblog-feed-downloader;1&quot;, &amp;rv);</span>
<a href="#l6.185"></a><span id="l6.185" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.186"></a><span id="l6.186" class="difflineminus">-  rssDownloader-&gt;UpdateSubscriptionsDS(aFolder, aOrigFolder);</span>
<a href="#l6.187"></a><span id="l6.187" class="difflineplus">+  rssDownloader-&gt;UpdateSubscriptionsDS(aFolder, aOrigFolder, aAction);</span>
<a href="#l6.188"></a><span id="l6.188">   return rv;</span>
<a href="#l6.189"></a><span id="l6.189"> }</span>
<a href="#l6.190"></a><span id="l6.190"> </span>
<a href="#l6.191"></a><span id="l6.191"> NS_IMETHODIMP</span>
<a href="#l6.192"></a><span id="l6.192"> nsRssIncomingServer::GetSortOrder(int32_t* aSortOrder)</span>
<a href="#l6.193"></a><span id="l6.193"> {</span>
<a href="#l6.194"></a><span id="l6.194">   NS_ENSURE_ARG_POINTER(aSortOrder);</span>
<a href="#l6.195"></a><span id="l6.195">   *aSortOrder = 400000000;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/local/src/nsRssIncomingServer.h</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/local/src/nsRssIncomingServer.h</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -30,14 +30,14 @@ public:</span>
<a href="#l7.4"></a><span id="l7.4">     NS_IMETHOD PerformBiff(nsIMsgWindow *aMsgWindow) MOZ_OVERRIDE;</span>
<a href="#l7.5"></a><span id="l7.5">     NS_IMETHOD GetServerRequiresPasswordForBiff(bool *aServerRequiresPasswordForBiff) MOZ_OVERRIDE;</span>
<a href="#l7.6"></a><span id="l7.6">     NS_IMETHOD GetCanSearchMessages(bool *canSearchMessages) MOZ_OVERRIDE;</span>
<a href="#l7.7"></a><span id="l7.7">     NS_IMETHOD GetSortOrder(int32_t* aSortOrder) MOZ_OVERRIDE;</span>
<a href="#l7.8"></a><span id="l7.8"> </span>
<a href="#l7.9"></a><span id="l7.9">     nsRssIncomingServer();</span>
<a href="#l7.10"></a><span id="l7.10">     virtual ~nsRssIncomingServer();</span>
<a href="#l7.11"></a><span id="l7.11"> protected:</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-    nsresult FolderChanged(nsIMsgFolder *aFolder, nsIMsgFolder *aOrigFolder);</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+    nsresult FolderChanged(nsIMsgFolder *aFolder, nsIMsgFolder *aOrigFolder, const char *aAction);</span>
<a href="#l7.14"></a><span id="l7.14">     nsresult FillInDataSourcePath(const nsAString&amp; aDataSourceName, nsIFile ** aLocation);</span>
<a href="#l7.15"></a><span id="l7.15">     static nsrefcnt gInstanceCount;</span>
<a href="#l7.16"></a><span id="l7.16"> };</span>
<a href="#l7.17"></a><span id="l7.17"> </span>
<a href="#l7.18"></a><span id="l7.18"> #endif /* __nsRssIncomingServer_h */</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

