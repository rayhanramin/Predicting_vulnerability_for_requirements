<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 3203:b626c86b3f40041a2cf66509810c56ff239c35ee</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ b626c86b3f40041a2cf66509810c56ff239c35ee" />
<meta property="og:url" content="/comm-central/rev/b626c86b3f40041a2cf66509810c56ff239c35ee" />
<meta property="og:description" content="Bug 274688 - &quot;The dock icon often shows an incorrect number of unread messages&quot; [r=Standard8 sr=bienvenu]" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / b626c86b3f40041a2cf66509810c56ff239c35ee 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/b626c86b3f40041a2cf66509810c56ff239c35ee">shortlog</a> |
<a href="/comm-central/log/b626c86b3f40041a2cf66509810c56ff239c35ee">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/b626c86b3f40041a2cf66509810c56ff239c35ee">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/b626c86b3f40041a2cf66509810c56ff239c35ee">files</a> |
changeset |
<a href="/comm-central/raw-rev/b626c86b3f40041a2cf66509810c56ff239c35ee">raw</a>  | <a href="/comm-central/archive/b626c86b3f40041a2cf66509810c56ff239c35ee.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=274688">Bug 274688</a> - &quot;The dock icon often shows an incorrect number of unread messages&quot; [r=Standard8 sr=bienvenu]
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#68;&#97;&#118;&#105;&#100;&#32;&#72;&#117;&#109;&#112;&#104;&#114;&#101;&#121;&#32;&#60;&#100;&#97;&#118;&#105;&#100;&#46;&#104;&#117;&#109;&#112;&#104;&#114;&#101;&#121;&#64;&#115;&#101;&#110;&#101;&#99;&#97;&#99;&#46;&#111;&#110;&#46;&#99;&#97;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 31 Jul 2009 10:17:26 +0100</td></tr>

<tr>
 <td>changeset 3203</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/b626c86b3f40041a2cf66509810c56ff239c35ee">b626c86b3f40041a2cf66509810c56ff239c35ee</a></td>
</tr>



<tr>
<td>parent 3202</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/380642ff521441465894df77b27f630d66c53f65">380642ff521441465894df77b27f630d66c53f65</a>
</td>
</tr>

<tr>
<td>child 3204</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/356b7b2836e0c9b403a210c268ddb0a8a0fb4cbc">356b7b2836e0c9b403a210c268ddb0a8a0fb4cbc</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=b626c86b3f40041a2cf66509810c56ff239c35ee">2611</a></td></tr>
<tr><td>push user</td><td>bugzilla@standard8.plus.com</td></tr>
<tr><td>push date</td><td class="date age">Fri, 31 Jul 2009 09:18:33 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@b626c86b3f40 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=b626c86b3f40041a2cf66509810c56ff239c35ee">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=b626c86b3f40041a2cf66509810c56ff239c35ee&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=b626c86b3f40041a2cf66509810c56ff239c35ee&newProject=comm-central&newRevision=380642ff521441465894df77b27f630d66c53f65&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=b626c86b3f40041a2cf66509810c56ff239c35ee&newProject=comm-central&newRevision=380642ff521441465894df77b27f630d66c53f65&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=b626c86b3f40041a2cf66509810c56ff239c35ee&newProject=comm-central&newRevision=380642ff521441465894df77b27f630d66c53f65&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28Standard8%29&revcount=50">Standard8</a>, <a href="/comm-central/log?rev=reviewer%28bienvenu%29&revcount=50">bienvenu</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=274688">274688</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=274688">Bug 274688</a> - &quot;The dock icon often shows an incorrect number of unread messages&quot; [r=Standard8 sr=bienvenu]</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b626c86b3f40041a2cf66509810c56ff239c35ee/mailnews/base/src/nsMessengerOSXIntegration.cpp">mailnews/base/src/nsMessengerOSXIntegration.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b626c86b3f40041a2cf66509810c56ff239c35ee/mailnews/base/src/nsMessengerOSXIntegration.cpp">file</a> |
<a href="/comm-central/annotate/b626c86b3f40041a2cf66509810c56ff239c35ee/mailnews/base/src/nsMessengerOSXIntegration.cpp">annotate</a> |
<a href="/comm-central/diff/b626c86b3f40041a2cf66509810c56ff239c35ee/mailnews/base/src/nsMessengerOSXIntegration.cpp">diff</a> |
<a href="/comm-central/comparison/b626c86b3f40041a2cf66509810c56ff239c35ee/mailnews/base/src/nsMessengerOSXIntegration.cpp">comparison</a> |
<a href="/comm-central/log/b626c86b3f40041a2cf66509810c56ff239c35ee/mailnews/base/src/nsMessengerOSXIntegration.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b626c86b3f40041a2cf66509810c56ff239c35ee/mailnews/base/src/nsMessengerOSXIntegration.h">mailnews/base/src/nsMessengerOSXIntegration.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b626c86b3f40041a2cf66509810c56ff239c35ee/mailnews/base/src/nsMessengerOSXIntegration.h">file</a> |
<a href="/comm-central/annotate/b626c86b3f40041a2cf66509810c56ff239c35ee/mailnews/base/src/nsMessengerOSXIntegration.h">annotate</a> |
<a href="/comm-central/diff/b626c86b3f40041a2cf66509810c56ff239c35ee/mailnews/base/src/nsMessengerOSXIntegration.h">diff</a> |
<a href="/comm-central/comparison/b626c86b3f40041a2cf66509810c56ff239c35ee/mailnews/base/src/nsMessengerOSXIntegration.h">comparison</a> |
<a href="/comm-central/log/b626c86b3f40041a2cf66509810c56ff239c35ee/mailnews/base/src/nsMessengerOSXIntegration.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b626c86b3f40041a2cf66509810c56ff239c35ee/mailnews/mailnews.js">mailnews/mailnews.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b626c86b3f40041a2cf66509810c56ff239c35ee/mailnews/mailnews.js">file</a> |
<a href="/comm-central/annotate/b626c86b3f40041a2cf66509810c56ff239c35ee/mailnews/mailnews.js">annotate</a> |
<a href="/comm-central/diff/b626c86b3f40041a2cf66509810c56ff239c35ee/mailnews/mailnews.js">diff</a> |
<a href="/comm-central/comparison/b626c86b3f40041a2cf66509810c56ff239c35ee/mailnews/mailnews.js">comparison</a> |
<a href="/comm-central/log/b626c86b3f40041a2cf66509810c56ff239c35ee/mailnews/mailnews.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/base/src/nsMessengerOSXIntegration.cpp</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/base/src/nsMessengerOSXIntegration.cpp</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -17,31 +17,32 @@</span>
<a href="#l1.4"></a><span id="l1.4">  * The Initial Developer of the Original Code is</span>
<a href="#l1.5"></a><span id="l1.5">  * The Mozilla Foundation.</span>
<a href="#l1.6"></a><span id="l1.6">  * Portions created by the Initial Developer are Copyright (C) 2005</span>
<a href="#l1.7"></a><span id="l1.7">  * the Initial Developer. All Rights Reserved.</span>
<a href="#l1.8"></a><span id="l1.8">  *</span>
<a href="#l1.9"></a><span id="l1.9">  * Contributor(s):</span>
<a href="#l1.10"></a><span id="l1.10">  *  Scott MacGregor &lt;mscott@mozilla.org&gt;</span>
<a href="#l1.11"></a><span id="l1.11">  *  Jon Baumgartner &lt;jon@bergenstreetsoftware.com&gt;</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">- *  </span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+ *  David Humphrey &lt;david.humphrey@senecac.on.ca&gt;</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+ *</span>
<a href="#l1.15"></a><span id="l1.15">  * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l1.16"></a><span id="l1.16">  * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l1.17"></a><span id="l1.17">  * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l1.18"></a><span id="l1.18">  * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l1.19"></a><span id="l1.19">  * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l1.20"></a><span id="l1.20">  * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l1.21"></a><span id="l1.21">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l1.22"></a><span id="l1.22">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l1.23"></a><span id="l1.23">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l1.24"></a><span id="l1.24">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l1.25"></a><span id="l1.25">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l1.26"></a><span id="l1.26">  *</span>
<a href="#l1.27"></a><span id="l1.27">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineminus">- </span>
<a href="#l1.29"></a><span id="l1.29" class="difflineplus">+</span>
<a href="#l1.30"></a><span id="l1.30"> #include &quot;nscore.h&quot;</span>
<a href="#l1.31"></a><span id="l1.31"> #include &quot;nsMessengerOSXIntegration.h&quot;</span>
<a href="#l1.32"></a><span id="l1.32"> #include &quot;nsIMsgMailSession.h&quot;</span>
<a href="#l1.33"></a><span id="l1.33"> #include &quot;nsIMsgIncomingServer.h&quot;</span>
<a href="#l1.34"></a><span id="l1.34"> #include &quot;nsIMsgIdentity.h&quot;</span>
<a href="#l1.35"></a><span id="l1.35"> #include &quot;nsIMsgAccount.h&quot;</span>
<a href="#l1.36"></a><span id="l1.36"> #include &quot;nsIMsgFolder.h&quot;</span>
<a href="#l1.37"></a><span id="l1.37"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineat">@@ -57,34 +58,35 @@</span>
<a href="#l1.39"></a><span id="l1.39"> #include &quot;nsIDocShell.h&quot;</span>
<a href="#l1.40"></a><span id="l1.40"> #include &quot;nsIBaseWindow.h&quot;</span>
<a href="#l1.41"></a><span id="l1.41"> #include &quot;nsIWidget.h&quot;</span>
<a href="#l1.42"></a><span id="l1.42"> #include &quot;nsIObserverService.h&quot;</span>
<a href="#l1.43"></a><span id="l1.43"> #include &quot;nsIPrefService.h&quot;</span>
<a href="#l1.44"></a><span id="l1.44"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l1.45"></a><span id="l1.45"> #include &quot;nsIMessengerWindowService.h&quot;</span>
<a href="#l1.46"></a><span id="l1.46"> #include &quot;prprf.h&quot;</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineminus">-#include &quot;nsIWeakReference.h&quot;</span>
<a href="#l1.48"></a><span id="l1.48"> #include &quot;nsIAlertsService.h&quot;</span>
<a href="#l1.49"></a><span id="l1.49"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l1.50"></a><span id="l1.50"> #include &quot;nsToolkitCompsCID.h&quot;</span>
<a href="#l1.51"></a><span id="l1.51"> #include &quot;nsINotificationsList.h&quot;</span>
<a href="#l1.52"></a><span id="l1.52"> #include &quot;nsIMsgDatabase.h&quot;</span>
<a href="#l1.53"></a><span id="l1.53"> #include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l1.54"></a><span id="l1.54"> #include &quot;nsIMsgHeaderParser.h&quot;</span>
<a href="#l1.55"></a><span id="l1.55"> #include &quot;nsISupportsPrimitives.h&quot;</span>
<a href="#l1.56"></a><span id="l1.56"> #include &quot;nsIWindowWatcher.h&quot;</span>
<a href="#l1.57"></a><span id="l1.57"> #include &quot;nsMsgLocalCID.h&quot;</span>
<a href="#l1.58"></a><span id="l1.58"> #include &quot;nsIMsgMailNewsUrl.h&quot;</span>
<a href="#l1.59"></a><span id="l1.59"> #include &quot;nsIMsgWindow.h&quot;</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineplus">+#include &quot;nsIMsgAccountManager.h&quot;</span>
<a href="#l1.61"></a><span id="l1.61"> </span>
<a href="#l1.62"></a><span id="l1.62"> #include &lt;Carbon/Carbon.h&gt;</span>
<a href="#l1.63"></a><span id="l1.63"> </span>
<a href="#l1.64"></a><span id="l1.64"> #define kNewMailAlertIcon &quot;chrome://messenger/skin/icons/new-mail-alert.png&quot;</span>
<a href="#l1.65"></a><span id="l1.65"> #define kBiffShowAlertPref &quot;mail.biff.show_alert&quot;</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineplus">+#define kCountInboxesPref &quot;mail.notification.count.inbox_only&quot;</span>
<a href="#l1.67"></a><span id="l1.67"> #define kMaxDisplayCount 10</span>
<a href="#l1.68"></a><span id="l1.68"> </span>
<a href="#l1.69"></a><span id="l1.69"> // HACK: Limitations in Focus/SetFocus on Mac (see bug 465446)</span>
<a href="#l1.70"></a><span id="l1.70"> nsresult FocusAppNative()</span>
<a href="#l1.71"></a><span id="l1.71"> {</span>
<a href="#l1.72"></a><span id="l1.72">   ProcessSerialNumber psn;</span>
<a href="#l1.73"></a><span id="l1.73"> </span>
<a href="#l1.74"></a><span id="l1.74">   if (::GetCurrentProcess(&amp;psn) != 0)</span>
<a href="#l1.75"></a><span id="l1.75" class="difflineat">@@ -158,27 +160,24 @@ static void openMailWindow(const nsCStri</span>
<a href="#l1.76"></a><span id="l1.76">                                 &quot;mail:3pane&quot;, aUri.get(), nsMsgKey_None);</span>
<a href="#l1.77"></a><span id="l1.77">   }</span>
<a href="#l1.78"></a><span id="l1.78"> }</span>
<a href="#l1.79"></a><span id="l1.79"> </span>
<a href="#l1.80"></a><span id="l1.80"> nsMessengerOSXIntegration::nsMessengerOSXIntegration()</span>
<a href="#l1.81"></a><span id="l1.81"> {</span>
<a href="#l1.82"></a><span id="l1.82">   mBiffStateAtom = do_GetAtom(&quot;BiffState&quot;);</span>
<a href="#l1.83"></a><span id="l1.83">   mNewMailReceivedAtom = do_GetAtom(&quot;NewMailReceived&quot;);</span>
<a href="#l1.84"></a><span id="l1.84" class="difflineminus">-  mBiffIconVisible = PR_FALSE;</span>
<a href="#l1.85"></a><span id="l1.85" class="difflineminus">-  NS_NewISupportsArray(getter_AddRefs(mFoldersWithNewMail));</span>
<a href="#l1.86"></a><span id="l1.86" class="difflineplus">+  mTotalUnreadMessagesAtom = do_GetAtom(&quot;TotalUnreadMessages&quot;);</span>
<a href="#l1.87"></a><span id="l1.87" class="difflineplus">+  mUnreadTotal = 0;</span>
<a href="#l1.88"></a><span id="l1.88" class="difflineplus">+  mOnlyCountInboxes = PR_TRUE;</span>
<a href="#l1.89"></a><span id="l1.89"> }</span>
<a href="#l1.90"></a><span id="l1.90"> </span>
<a href="#l1.91"></a><span id="l1.91"> nsMessengerOSXIntegration::~nsMessengerOSXIntegration()</span>
<a href="#l1.92"></a><span id="l1.92"> {</span>
<a href="#l1.93"></a><span id="l1.93" class="difflineminus">-  if (mBiffIconVisible) </span>
<a href="#l1.94"></a><span id="l1.94" class="difflineminus">-  {</span>
<a href="#l1.95"></a><span id="l1.95" class="difflineminus">-    RestoreApplicationDockTileImage();</span>
<a href="#l1.96"></a><span id="l1.96" class="difflineminus">-    mBiffIconVisible = PR_FALSE;</span>
<a href="#l1.97"></a><span id="l1.97" class="difflineminus">-  }</span>
<a href="#l1.98"></a><span id="l1.98" class="difflineplus">+  RestoreApplicationDockTileImage();</span>
<a href="#l1.99"></a><span id="l1.99"> }</span>
<a href="#l1.100"></a><span id="l1.100"> </span>
<a href="#l1.101"></a><span id="l1.101"> NS_IMPL_ADDREF(nsMessengerOSXIntegration)</span>
<a href="#l1.102"></a><span id="l1.102"> NS_IMPL_RELEASE(nsMessengerOSXIntegration)</span>
<a href="#l1.103"></a><span id="l1.103"> </span>
<a href="#l1.104"></a><span id="l1.104"> NS_INTERFACE_MAP_BEGIN(nsMessengerOSXIntegration)</span>
<a href="#l1.105"></a><span id="l1.105">    NS_INTERFACE_MAP_ENTRY_AMBIGUOUS(nsISupports, nsIMessengerOSIntegration)</span>
<a href="#l1.106"></a><span id="l1.106">    NS_INTERFACE_MAP_ENTRY(nsIMessengerOSIntegration)</span>
<a href="#l1.107"></a><span id="l1.107" class="difflineat">@@ -189,20 +188,23 @@ NS_INTERFACE_MAP_END</span>
<a href="#l1.108"></a><span id="l1.108"> </span>
<a href="#l1.109"></a><span id="l1.109"> nsresult</span>
<a href="#l1.110"></a><span id="l1.110"> nsMessengerOSXIntegration::Init()</span>
<a href="#l1.111"></a><span id="l1.111"> {</span>
<a href="#l1.112"></a><span id="l1.112">   // need to register a named Growl notification</span>
<a href="#l1.113"></a><span id="l1.113">   nsresult rv;</span>
<a href="#l1.114"></a><span id="l1.114">   nsCOMPtr&lt;nsIObserverService&gt; observerService = do_GetService(&quot;@mozilla.org/observer-service;1&quot;, &amp;rv);</span>
<a href="#l1.115"></a><span id="l1.115">   if (NS_SUCCEEDED(rv))</span>
<a href="#l1.116"></a><span id="l1.116" class="difflineplus">+  {</span>
<a href="#l1.117"></a><span id="l1.117">     observerService-&gt;AddObserver(this, &quot;before-growl-registration&quot;, PR_FALSE);</span>
<a href="#l1.118"></a><span id="l1.118" class="difflineplus">+    observerService-&gt;AddObserver(this, &quot;mail-startup-done&quot;, PR_FALSE);</span>
<a href="#l1.119"></a><span id="l1.119" class="difflineplus">+  }</span>
<a href="#l1.120"></a><span id="l1.120"> </span>
<a href="#l1.121"></a><span id="l1.121">   nsCOMPtr&lt;nsIMsgMailSession&gt; mailSession = do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l1.122"></a><span id="l1.122" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.123"></a><span id="l1.123" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.124"></a><span id="l1.124"> </span>
<a href="#l1.125"></a><span id="l1.125">   // because we care if the unread total count changes</span>
<a href="#l1.126"></a><span id="l1.126">   return mailSession-&gt;AddFolderListener(this, nsIFolderListener::boolPropertyChanged | nsIFolderListener::intPropertyChanged);</span>
<a href="#l1.127"></a><span id="l1.127"> }</span>
<a href="#l1.128"></a><span id="l1.128"> </span>
<a href="#l1.129"></a><span id="l1.129"> NS_IMETHODIMP</span>
<a href="#l1.130"></a><span id="l1.130"> nsMessengerOSXIntegration::OnItemPropertyChanged(nsIMsgFolder *, nsIAtom *, char const *, char const *)</span>
<a href="#l1.131"></a><span id="l1.131"> {</span>
<a href="#l1.132"></a><span id="l1.132" class="difflineat">@@ -225,16 +227,27 @@ NS_IMETHODIMP</span>
<a href="#l1.133"></a><span id="l1.133"> nsMessengerOSXIntegration::Observe(nsISupports* aSubject, const char* aTopic, const PRUnichar* aData)</span>
<a href="#l1.134"></a><span id="l1.134"> {</span>
<a href="#l1.135"></a><span id="l1.135">   if (!strcmp(aTopic, &quot;alertfinished&quot;))</span>
<a href="#l1.136"></a><span id="l1.136">     return OnAlertFinished();</span>
<a href="#l1.137"></a><span id="l1.137"> </span>
<a href="#l1.138"></a><span id="l1.138">   if (!strcmp(aTopic, &quot;alertclickcallback&quot;))</span>
<a href="#l1.139"></a><span id="l1.139">     return OnAlertClicked(aData);</span>
<a href="#l1.140"></a><span id="l1.140"> </span>
<a href="#l1.141"></a><span id="l1.141" class="difflineplus">+  // get the initial unread count for the dock icon and badge</span>
<a href="#l1.142"></a><span id="l1.142" class="difflineplus">+  if (!strcmp(aTopic, &quot;mail-startup-done&quot;))</span>
<a href="#l1.143"></a><span id="l1.143" class="difflineplus">+  {</span>
<a href="#l1.144"></a><span id="l1.144" class="difflineplus">+    nsresult rv;</span>
<a href="#l1.145"></a><span id="l1.145" class="difflineplus">+    nsCOMPtr&lt;nsIObserverService&gt; observerService = do_GetService(&quot;@mozilla.org/observer-service;1&quot;, &amp;rv);</span>
<a href="#l1.146"></a><span id="l1.146" class="difflineplus">+    if (NS_SUCCEEDED(rv))</span>
<a href="#l1.147"></a><span id="l1.147" class="difflineplus">+      observerService-&gt;RemoveObserver(this, &quot;mail-startup-done&quot;);</span>
<a href="#l1.148"></a><span id="l1.148" class="difflineplus">+    InitUnreadCount();</span>
<a href="#l1.149"></a><span id="l1.149" class="difflineplus">+    BadgeDockIcon();</span>
<a href="#l1.150"></a><span id="l1.150" class="difflineplus">+  }</span>
<a href="#l1.151"></a><span id="l1.151" class="difflineplus">+</span>
<a href="#l1.152"></a><span id="l1.152">   // register named Growl notification for new mail alerts.</span>
<a href="#l1.153"></a><span id="l1.153">   if (!strcmp(aTopic, &quot;before-growl-registration&quot;))</span>
<a href="#l1.154"></a><span id="l1.154">   {</span>
<a href="#l1.155"></a><span id="l1.155">     nsresult rv;</span>
<a href="#l1.156"></a><span id="l1.156">     nsCOMPtr&lt;nsIObserverService&gt; observerService = do_GetService(&quot;@mozilla.org/observer-service;1&quot;, &amp;rv);</span>
<a href="#l1.157"></a><span id="l1.157">     if (NS_SUCCEEDED(rv))</span>
<a href="#l1.158"></a><span id="l1.158">       observerService-&gt;RemoveObserver(this, &quot;before-growl-registration&quot;);</span>
<a href="#l1.159"></a><span id="l1.159"> </span>
<a href="#l1.160"></a><span id="l1.160" class="difflineat">@@ -249,43 +262,16 @@ nsMessengerOSXIntegration::Observe(nsISu</span>
<a href="#l1.161"></a><span id="l1.161">         bundle-&gt;GetStringFromName(NS_LITERAL_STRING(&quot;growlNotification&quot;).get(), getter_Copies(growlNotification));</span>
<a href="#l1.162"></a><span id="l1.162">         notifications-&gt;AddNotification(growlNotification, PR_TRUE);</span>
<a href="#l1.163"></a><span id="l1.163">       }</span>
<a href="#l1.164"></a><span id="l1.164">     }</span>
<a href="#l1.165"></a><span id="l1.165">   }</span>
<a href="#l1.166"></a><span id="l1.166">   return NS_OK;</span>
<a href="#l1.167"></a><span id="l1.167"> }</span>
<a href="#l1.168"></a><span id="l1.168"> </span>
<a href="#l1.169"></a><span id="l1.169" class="difflineminus">-PRInt32</span>
<a href="#l1.170"></a><span id="l1.170" class="difflineminus">-nsMessengerOSXIntegration::CountNewMessages()</span>
<a href="#l1.171"></a><span id="l1.171" class="difflineminus">-{</span>
<a href="#l1.172"></a><span id="l1.172" class="difflineminus">-  // iterate over all the folders in mFoldersWithNewMail</span>
<a href="#l1.173"></a><span id="l1.173" class="difflineminus">-  nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l1.174"></a><span id="l1.174" class="difflineminus">-  nsCOMPtr&lt;nsIWeakReference&gt; weakReference;</span>
<a href="#l1.175"></a><span id="l1.175" class="difflineminus">-  PRInt32 numNewMessages = 0;</span>
<a href="#l1.176"></a><span id="l1.176" class="difflineminus">-  PRInt32 totalNewMessages = 0;</span>
<a href="#l1.177"></a><span id="l1.177" class="difflineminus">-  </span>
<a href="#l1.178"></a><span id="l1.178" class="difflineminus">-  PRUint32 count = 0;</span>
<a href="#l1.179"></a><span id="l1.179" class="difflineminus">-  mFoldersWithNewMail-&gt;Count(&amp;count);</span>
<a href="#l1.180"></a><span id="l1.180" class="difflineminus">-</span>
<a href="#l1.181"></a><span id="l1.181" class="difflineminus">-  for (PRUint32 index = 0; index &lt; count; index++)</span>
<a href="#l1.182"></a><span id="l1.182" class="difflineminus">-  {</span>
<a href="#l1.183"></a><span id="l1.183" class="difflineminus">-    weakReference = do_QueryElementAt(mFoldersWithNewMail, index);</span>
<a href="#l1.184"></a><span id="l1.184" class="difflineminus">-    folder = do_QueryReferent(weakReference);</span>
<a href="#l1.185"></a><span id="l1.185" class="difflineminus">-    if (folder)</span>
<a href="#l1.186"></a><span id="l1.186" class="difflineminus">-    {</span>
<a href="#l1.187"></a><span id="l1.187" class="difflineminus">-      numNewMessages = 0;   </span>
<a href="#l1.188"></a><span id="l1.188" class="difflineminus">-      folder-&gt;GetNumNewMessages(PR_TRUE, &amp;numNewMessages);</span>
<a href="#l1.189"></a><span id="l1.189" class="difflineminus">-      totalNewMessages += numNewMessages;</span>
<a href="#l1.190"></a><span id="l1.190" class="difflineminus">-    } // if we got a folder</span>
<a href="#l1.191"></a><span id="l1.191" class="difflineminus">-  } // for each folder</span>
<a href="#l1.192"></a><span id="l1.192" class="difflineminus">-</span>
<a href="#l1.193"></a><span id="l1.193" class="difflineminus">-  return totalNewMessages;</span>
<a href="#l1.194"></a><span id="l1.194" class="difflineminus">-}</span>
<a href="#l1.195"></a><span id="l1.195" class="difflineminus">-</span>
<a href="#l1.196"></a><span id="l1.196"> nsresult</span>
<a href="#l1.197"></a><span id="l1.197"> nsMessengerOSXIntegration::GetStringBundle(nsIStringBundle **aBundle)</span>
<a href="#l1.198"></a><span id="l1.198"> {</span>
<a href="#l1.199"></a><span id="l1.199">   NS_ENSURE_ARG_POINTER(aBundle);</span>
<a href="#l1.200"></a><span id="l1.200">   nsresult rv;</span>
<a href="#l1.201"></a><span id="l1.201">   nsCOMPtr&lt;nsIStringBundleService&gt; bundleService = do_GetService(NS_STRINGBUNDLE_CONTRACTID, &amp;rv);</span>
<a href="#l1.202"></a><span id="l1.202">   nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l1.203"></a><span id="l1.203">   if (bundleService &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l1.204"></a><span id="l1.204" class="difflineat">@@ -414,91 +400,90 @@ nsMessengerOSXIntegration::ShowAlertMess</span>
<a href="#l1.205"></a><span id="l1.205"> </span>
<a href="#l1.206"></a><span id="l1.206">     PRBool bounceDockIcon = PR_FALSE;</span>
<a href="#l1.207"></a><span id="l1.207">     prefBranch-&gt;GetBoolPref(&quot;mail.biff.animate_dock_icon&quot;, &amp;bounceDockIcon);</span>
<a href="#l1.208"></a><span id="l1.208"> </span>
<a href="#l1.209"></a><span id="l1.209">     if (bounceDockIcon)</span>
<a href="#l1.210"></a><span id="l1.210">       BounceDockIcon();</span>
<a href="#l1.211"></a><span id="l1.211">   }</span>
<a href="#l1.212"></a><span id="l1.212"> </span>
<a href="#l1.213"></a><span id="l1.213" class="difflineminus">-  BadgeDockIcon();</span>
<a href="#l1.214"></a><span id="l1.214" class="difflineminus">-</span>
<a href="#l1.215"></a><span id="l1.215">   if (!showAlert || NS_FAILED(rv))</span>
<a href="#l1.216"></a><span id="l1.216">     OnAlertFinished();</span>
<a href="#l1.217"></a><span id="l1.217"> </span>
<a href="#l1.218"></a><span id="l1.218">   return rv;</span>
<a href="#l1.219"></a><span id="l1.219"> }</span>
<a href="#l1.220"></a><span id="l1.220"> </span>
<a href="#l1.221"></a><span id="l1.221"> NS_IMETHODIMP</span>
<a href="#l1.222"></a><span id="l1.222"> nsMessengerOSXIntegration::OnItemIntPropertyChanged(nsIMsgFolder *aFolder,</span>
<a href="#l1.223"></a><span id="l1.223">                                                     nsIAtom *aProperty,</span>
<a href="#l1.224"></a><span id="l1.224">                                                     PRInt32 aOldValue,</span>
<a href="#l1.225"></a><span id="l1.225">                                                     PRInt32 aNewValue)</span>
<a href="#l1.226"></a><span id="l1.226"> {</span>
<a href="#l1.227"></a><span id="l1.227">    // if we got new mail show an alert</span>
<a href="#l1.228"></a><span id="l1.228" class="difflineminus">-  if (mBiffStateAtom == aProperty &amp;&amp; mFoldersWithNewMail)</span>
<a href="#l1.229"></a><span id="l1.229" class="difflineplus">+  if (mBiffStateAtom == aProperty)</span>
<a href="#l1.230"></a><span id="l1.230">   {</span>
<a href="#l1.231"></a><span id="l1.231">     NS_ENSURE_TRUE(aFolder, NS_OK);</span>
<a href="#l1.232"></a><span id="l1.232"> </span>
<a href="#l1.233"></a><span id="l1.233">     if (aNewValue == nsIMsgFolder::nsMsgBiffState_NewMail)</span>
<a href="#l1.234"></a><span id="l1.234">     {</span>
<a href="#l1.235"></a><span id="l1.235" class="difflineminus">-      // if the icon is not already visible, only show a system tray icon if</span>
<a href="#l1.236"></a><span id="l1.236" class="difflineminus">-      // we are performing biff (as opposed to the user getting new mail)</span>
<a href="#l1.237"></a><span id="l1.237" class="difflineminus">-      if (!mBiffIconVisible)</span>
<a href="#l1.238"></a><span id="l1.238" class="difflineminus">-      {</span>
<a href="#l1.239"></a><span id="l1.239" class="difflineminus">-        PRBool performingBiff = PR_FALSE;</span>
<a href="#l1.240"></a><span id="l1.240" class="difflineminus">-        nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l1.241"></a><span id="l1.241" class="difflineminus">-        aFolder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l1.242"></a><span id="l1.242" class="difflineminus">-        if (server)</span>
<a href="#l1.243"></a><span id="l1.243" class="difflineminus">-          server-&gt;GetPerformingBiff(&amp;performingBiff);</span>
<a href="#l1.244"></a><span id="l1.244" class="difflineminus">-        if (!performingBiff)</span>
<a href="#l1.245"></a><span id="l1.245" class="difflineminus">-          return NS_OK; // kick out right now...</span>
<a href="#l1.246"></a><span id="l1.246" class="difflineminus">-      }</span>
<a href="#l1.247"></a><span id="l1.247" class="difflineminus">-</span>
<a href="#l1.248"></a><span id="l1.248" class="difflineminus">-      nsCOMPtr&lt;nsIWeakReference&gt; weakFolder = do_GetWeakReference(aFolder);</span>
<a href="#l1.249"></a><span id="l1.249" class="difflineminus">-</span>
<a href="#l1.250"></a><span id="l1.250" class="difflineminus">-      if (mFoldersWithNewMail-&gt;IndexOf(weakFolder) == -1)</span>
<a href="#l1.251"></a><span id="l1.251" class="difflineminus">-          mFoldersWithNewMail-&gt;AppendElement(weakFolder);</span>
<a href="#l1.252"></a><span id="l1.252" class="difflineplus">+      PRBool performingBiff = PR_FALSE;</span>
<a href="#l1.253"></a><span id="l1.253" class="difflineplus">+      nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l1.254"></a><span id="l1.254" class="difflineplus">+      aFolder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l1.255"></a><span id="l1.255" class="difflineplus">+      if (server)</span>
<a href="#l1.256"></a><span id="l1.256" class="difflineplus">+        server-&gt;GetPerformingBiff(&amp;performingBiff);</span>
<a href="#l1.257"></a><span id="l1.257" class="difflineplus">+      if (!performingBiff)</span>
<a href="#l1.258"></a><span id="l1.258" class="difflineplus">+        return NS_OK; // kick out right now...</span>
<a href="#l1.259"></a><span id="l1.259"> </span>
<a href="#l1.260"></a><span id="l1.260">       // Biff happens for the root folder, but we want info for the child with new mail</span>
<a href="#l1.261"></a><span id="l1.261">       nsCString folderUri;</span>
<a href="#l1.262"></a><span id="l1.262">       GetFirstFolderWithNewMail(aFolder, folderUri);</span>
<a href="#l1.263"></a><span id="l1.263">       nsCOMPtr&lt;nsIMsgFolder&gt; childFolder;</span>
<a href="#l1.264"></a><span id="l1.264">       nsresult rv = aFolder-&gt;GetChildWithURI(folderUri, PR_TRUE, PR_TRUE,</span>
<a href="#l1.265"></a><span id="l1.265">                                              getter_AddRefs(childFolder));</span>
<a href="#l1.266"></a><span id="l1.266">       if (NS_FAILED(rv) || !childFolder)</span>
<a href="#l1.267"></a><span id="l1.267">         return NS_ERROR_FAILURE;</span>
<a href="#l1.268"></a><span id="l1.268"> </span>
<a href="#l1.269"></a><span id="l1.269">       PRInt32 numNewMessages = 0;</span>
<a href="#l1.270"></a><span id="l1.270">       childFolder-&gt;GetNumNewMessages(PR_TRUE, &amp;numNewMessages);</span>
<a href="#l1.271"></a><span id="l1.271">       FillToolTipInfo(childFolder, numNewMessages);</span>
<a href="#l1.272"></a><span id="l1.272">     }</span>
<a href="#l1.273"></a><span id="l1.273" class="difflineminus">-    else if (aNewValue == nsIMsgFolder::nsMsgBiffState_NoMail)</span>
<a href="#l1.274"></a><span id="l1.274" class="difflineminus">-    {</span>
<a href="#l1.275"></a><span id="l1.275" class="difflineminus">-      // we are always going to remove the icon whenever we get our first no</span>
<a href="#l1.276"></a><span id="l1.276" class="difflineminus">-      // mail notification.</span>
<a href="#l1.277"></a><span id="l1.277" class="difflineminus">-      mFoldersWithNewMail-&gt;Clear();</span>
<a href="#l1.278"></a><span id="l1.278" class="difflineminus">-      if (mBiffIconVisible)</span>
<a href="#l1.279"></a><span id="l1.279" class="difflineminus">-      {</span>
<a href="#l1.280"></a><span id="l1.280" class="difflineminus">-        RestoreApplicationDockTileImage();</span>
<a href="#l1.281"></a><span id="l1.281" class="difflineminus">-        mBiffIconVisible = PR_FALSE;</span>
<a href="#l1.282"></a><span id="l1.282" class="difflineminus">-      }</span>
<a href="#l1.283"></a><span id="l1.283" class="difflineminus">-    }</span>
<a href="#l1.284"></a><span id="l1.284">   }</span>
<a href="#l1.285"></a><span id="l1.285">   else if (mNewMailReceivedAtom == aProperty)</span>
<a href="#l1.286"></a><span id="l1.286">   {</span>
<a href="#l1.287"></a><span id="l1.287">     nsCOMPtr&lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l1.288"></a><span id="l1.288">     nsresult rv = aFolder-&gt;GetRootFolder(getter_AddRefs(rootFolder));</span>
<a href="#l1.289"></a><span id="l1.289">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.290"></a><span id="l1.290"> </span>
<a href="#l1.291"></a><span id="l1.291" class="difflineminus">-    nsCOMPtr&lt;nsIWeakReference&gt; weakFolder = do_GetWeakReference(rootFolder);</span>
<a href="#l1.292"></a><span id="l1.292" class="difflineminus">-    if (mFoldersWithNewMail-&gt;IndexOf(weakFolder) == -1)</span>
<a href="#l1.293"></a><span id="l1.293" class="difflineminus">-      mFoldersWithNewMail-&gt;AppendElement(weakFolder);</span>
<a href="#l1.294"></a><span id="l1.294" class="difflineplus">+    FillToolTipInfo(aFolder, aNewValue);</span>
<a href="#l1.295"></a><span id="l1.295" class="difflineplus">+  }</span>
<a href="#l1.296"></a><span id="l1.296" class="difflineplus">+  else if (mTotalUnreadMessagesAtom == aProperty)</span>
<a href="#l1.297"></a><span id="l1.297" class="difflineplus">+  {</span>
<a href="#l1.298"></a><span id="l1.298" class="difflineplus">+    PRUint32 flags;</span>
<a href="#l1.299"></a><span id="l1.299" class="difflineplus">+    nsresult rv = aFolder-&gt;GetFlags(&amp;flags);</span>
<a href="#l1.300"></a><span id="l1.300" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.301"></a><span id="l1.301"> </span>
<a href="#l1.302"></a><span id="l1.302" class="difflineminus">-    FillToolTipInfo(aFolder, aNewValue);</span>
<a href="#l1.303"></a><span id="l1.303" class="difflineplus">+    // Count this folder if: 1) we want only inboxes and this is an inbox; or</span>
<a href="#l1.304"></a><span id="l1.304" class="difflineplus">+    // 2) we want any folder (see ConfirmShouldCount() for folders included).</span>
<a href="#l1.305"></a><span id="l1.305" class="difflineplus">+    if ((mOnlyCountInboxes &amp;&amp; flags &amp; nsMsgFolderFlags::Inbox) || !mOnlyCountInboxes)</span>
<a href="#l1.306"></a><span id="l1.306" class="difflineplus">+    {</span>
<a href="#l1.307"></a><span id="l1.307" class="difflineplus">+      // Give extensions a chance to suppress counting for this folder,</span>
<a href="#l1.308"></a><span id="l1.308" class="difflineplus">+      // and filter out ones we don't want to count.</span>
<a href="#l1.309"></a><span id="l1.309" class="difflineplus">+      PRBool countFolder;</span>
<a href="#l1.310"></a><span id="l1.310" class="difflineplus">+      rv = ConfirmShouldCount(aFolder, &amp;countFolder);</span>
<a href="#l1.311"></a><span id="l1.311" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.312"></a><span id="l1.312" class="difflineplus">+</span>
<a href="#l1.313"></a><span id="l1.313" class="difflineplus">+      if (!countFolder)</span>
<a href="#l1.314"></a><span id="l1.314" class="difflineplus">+        return NS_OK;</span>
<a href="#l1.315"></a><span id="l1.315" class="difflineplus">+</span>
<a href="#l1.316"></a><span id="l1.316" class="difflineplus">+      // Increment count by difference, treating -1 (i.e., &quot;don't know&quot;) as 0</span>
<a href="#l1.317"></a><span id="l1.317" class="difflineplus">+      mUnreadTotal += aNewValue - (aOldValue &gt; -1 ? aOldValue : 0);</span>
<a href="#l1.318"></a><span id="l1.318" class="difflineplus">+      NS_ASSERTION(mUnreadTotal &gt; -1, &quot;Updated unread message count is less than zero.&quot;);</span>
<a href="#l1.319"></a><span id="l1.319" class="difflineplus">+</span>
<a href="#l1.320"></a><span id="l1.320" class="difflineplus">+      BadgeDockIcon();</span>
<a href="#l1.321"></a><span id="l1.321" class="difflineplus">+    }</span>
<a href="#l1.322"></a><span id="l1.322">   }</span>
<a href="#l1.323"></a><span id="l1.323">   return NS_OK;</span>
<a href="#l1.324"></a><span id="l1.324"> }</span>
<a href="#l1.325"></a><span id="l1.325"> </span>
<a href="#l1.326"></a><span id="l1.326"> nsresult</span>
<a href="#l1.327"></a><span id="l1.327"> nsMessengerOSXIntegration::OnAlertClicked(const PRUnichar* aAlertCookie)</span>
<a href="#l1.328"></a><span id="l1.328"> {</span>
<a href="#l1.329"></a><span id="l1.329">   openMailWindow(NS_ConvertUTF16toUTF8(aAlertCookie));</span>
<a href="#l1.330"></a><span id="l1.330" class="difflineat">@@ -529,33 +514,61 @@ nsMessengerOSXIntegration::BounceDockIco</span>
<a href="#l1.331"></a><span id="l1.331"> }</span>
<a href="#l1.332"></a><span id="l1.332"> </span>
<a href="#l1.333"></a><span id="l1.333"> nsresult</span>
<a href="#l1.334"></a><span id="l1.334"> nsMessengerOSXIntegration::BadgeDockIcon()</span>
<a href="#l1.335"></a><span id="l1.335"> {</span>
<a href="#l1.336"></a><span id="l1.336">   // This will change the dock icon. If we want to overlay the number of</span>
<a href="#l1.337"></a><span id="l1.337">   // new messages on top of the icon use OverlayApplicationDockTileImage</span>
<a href="#l1.338"></a><span id="l1.338">   // you'll have to pass it a CGImage, and somehow we have to/ create</span>
<a href="#l1.339"></a><span id="l1.339" class="difflineminus">-  // the CGImage with the numbers. tricky    </span>
<a href="#l1.340"></a><span id="l1.340" class="difflineminus">-  PRInt32 totalNewMessages = CountNewMessages();</span>
<a href="#l1.341"></a><span id="l1.341" class="difflineplus">+  // the CGImage with the numbers.</span>
<a href="#l1.342"></a><span id="l1.342" class="difflineplus">+</span>
<a href="#l1.343"></a><span id="l1.343" class="difflineplus">+  // Clean-up dock icon, since we will either redraw (need to get rid of</span>
<a href="#l1.344"></a><span id="l1.344" class="difflineplus">+  // any text left over from large numbers), or remove completely.</span>
<a href="#l1.345"></a><span id="l1.345" class="difflineplus">+  RestoreApplicationDockTileImage();</span>
<a href="#l1.346"></a><span id="l1.346" class="difflineplus">+</span>
<a href="#l1.347"></a><span id="l1.347" class="difflineplus">+  // Only badge if unread count &gt; 0.</span>
<a href="#l1.348"></a><span id="l1.348" class="difflineplus">+  if (mUnreadTotal &lt; 1)</span>
<a href="#l1.349"></a><span id="l1.349" class="difflineplus">+    return NS_OK;</span>
<a href="#l1.350"></a><span id="l1.350" class="difflineplus">+</span>
<a href="#l1.351"></a><span id="l1.351" class="difflineplus">+  // Draw the number, first giving extensions a chance to modify.</span>
<a href="#l1.352"></a><span id="l1.352" class="difflineplus">+  // Extensions might wish to transform &quot;1000&quot; into &quot;100+&quot; or some</span>
<a href="#l1.353"></a><span id="l1.353" class="difflineplus">+  // other short string. Getting back the empty string will cause</span>
<a href="#l1.354"></a><span id="l1.354" class="difflineplus">+  // nothing to be drawn and us to return early.</span>
<a href="#l1.355"></a><span id="l1.355" class="difflineplus">+  nsAutoString total;</span>
<a href="#l1.356"></a><span id="l1.356" class="difflineplus">+  total.AppendInt(mUnreadTotal);</span>
<a href="#l1.357"></a><span id="l1.357" class="difflineplus">+</span>
<a href="#l1.358"></a><span id="l1.358" class="difflineplus">+  nsresult rv;</span>
<a href="#l1.359"></a><span id="l1.359" class="difflineplus">+  nsCOMPtr&lt;nsIObserverService&gt; os</span>
<a href="#l1.360"></a><span id="l1.360" class="difflineplus">+    (do_GetService(&quot;@mozilla.org/observer-service;1&quot;, &amp;rv));</span>
<a href="#l1.361"></a><span id="l1.361" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.362"></a><span id="l1.362" class="difflineplus">+</span>
<a href="#l1.363"></a><span id="l1.363" class="difflineplus">+  nsCOMPtr&lt;nsISupportsString&gt; str</span>
<a href="#l1.364"></a><span id="l1.364" class="difflineplus">+    (do_CreateInstance(NS_SUPPORTS_STRING_CONTRACTID, &amp;rv));</span>
<a href="#l1.365"></a><span id="l1.365" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.366"></a><span id="l1.366" class="difflineplus">+</span>
<a href="#l1.367"></a><span id="l1.367" class="difflineplus">+  str-&gt;SetData(total);</span>
<a href="#l1.368"></a><span id="l1.368" class="difflineplus">+  os-&gt;NotifyObservers(str, &quot;before-unread-count-display&quot;,</span>
<a href="#l1.369"></a><span id="l1.369" class="difflineplus">+                      total.get());</span>
<a href="#l1.370"></a><span id="l1.370" class="difflineplus">+  nsAutoString badgeString;</span>
<a href="#l1.371"></a><span id="l1.371" class="difflineplus">+  str-&gt;GetData(badgeString);</span>
<a href="#l1.372"></a><span id="l1.372" class="difflineplus">+  if (badgeString.IsEmpty())</span>
<a href="#l1.373"></a><span id="l1.373" class="difflineplus">+    return NS_OK;</span>
<a href="#l1.374"></a><span id="l1.374" class="difflineplus">+</span>
<a href="#l1.375"></a><span id="l1.375">   CGContextRef context = ::BeginCGContextForApplicationDockTile();</span>
<a href="#l1.376"></a><span id="l1.376" class="difflineminus">-    </span>
<a href="#l1.377"></a><span id="l1.377" class="difflineplus">+</span>
<a href="#l1.378"></a><span id="l1.378">   // Draw a circle.</span>
<a href="#l1.379"></a><span id="l1.379">   ::CGContextBeginPath(context);</span>
<a href="#l1.380"></a><span id="l1.380">   ::CGContextAddArc(context, 95.0, 95.0, 25.0, 0.0, 2 * M_PI, true);</span>
<a href="#l1.381"></a><span id="l1.381">   ::CGContextClosePath(context);</span>
<a href="#l1.382"></a><span id="l1.382"> </span>
<a href="#l1.383"></a><span id="l1.383">   // use #2fc600 for the color.</span>
<a href="#l1.384"></a><span id="l1.384">   ::CGContextSetRGBFillColor(context, 0.184, 0.776, 0.0, 1);</span>
<a href="#l1.385"></a><span id="l1.385">   ::CGContextFillPath(context);</span>
<a href="#l1.386"></a><span id="l1.386"> </span>
<a href="#l1.387"></a><span id="l1.387" class="difflineminus">-  // Draw the number.</span>
<a href="#l1.388"></a><span id="l1.388" class="difflineminus">-  nsAutoString total;</span>
<a href="#l1.389"></a><span id="l1.389" class="difflineminus">-  total.AppendInt(totalNewMessages);</span>
<a href="#l1.390"></a><span id="l1.390" class="difflineminus">-</span>
<a href="#l1.391"></a><span id="l1.391">   // Use a system font (kThemeUtilityWindowTitleFont)</span>
<a href="#l1.392"></a><span id="l1.392">   ScriptCode sysScript = ::GetScriptManagerVariable(smSysScript);</span>
<a href="#l1.393"></a><span id="l1.393"> </span>
<a href="#l1.394"></a><span id="l1.394">   Str255 fontName;</span>
<a href="#l1.395"></a><span id="l1.395">   SInt16 fontSize;</span>
<a href="#l1.396"></a><span id="l1.396">   Style fontStyle;</span>
<a href="#l1.397"></a><span id="l1.397">   ::GetThemeFont(kThemeSmallEmphasizedSystemFont, sysScript, fontName,</span>
<a href="#l1.398"></a><span id="l1.398">                  &amp;fontSize, &amp;fontStyle);</span>
<a href="#l1.399"></a><span id="l1.399" class="difflineat">@@ -569,98 +582,96 @@ nsMessengerOSXIntegration::BadgeDockIcon</span>
<a href="#l1.400"></a><span id="l1.400">                                         nsnull) != noErr)</span>
<a href="#l1.401"></a><span id="l1.401">   {</span>
<a href="#l1.402"></a><span id="l1.402">     NS_WARNING(&quot;FMGetFontFromFontFamilyInstance failed&quot;);</span>
<a href="#l1.403"></a><span id="l1.403">     ::EndCGContextForApplicationDockTile(context);</span>
<a href="#l1.404"></a><span id="l1.404">     return NS_ERROR_FAILURE;</span>
<a href="#l1.405"></a><span id="l1.405">   }</span>
<a href="#l1.406"></a><span id="l1.406"> </span>
<a href="#l1.407"></a><span id="l1.407">   ATSUStyle style;</span>
<a href="#l1.408"></a><span id="l1.408" class="difflineminus">-  if (::ATSUCreateStyle(&amp;style) != noErr) </span>
<a href="#l1.409"></a><span id="l1.409" class="difflineplus">+  if (::ATSUCreateStyle(&amp;style) != noErr)</span>
<a href="#l1.410"></a><span id="l1.410">   {</span>
<a href="#l1.411"></a><span id="l1.411">     NS_WARNING(&quot;ATSUCreateStyle failed&quot;);</span>
<a href="#l1.412"></a><span id="l1.412">     ::EndCGContextForApplicationDockTile(context);</span>
<a href="#l1.413"></a><span id="l1.413">     return NS_ERROR_FAILURE;</span>
<a href="#l1.414"></a><span id="l1.414">   }</span>
<a href="#l1.415"></a><span id="l1.415" class="difflineminus">-        </span>
<a href="#l1.416"></a><span id="l1.416" class="difflineplus">+</span>
<a href="#l1.417"></a><span id="l1.417">   Fixed size = Long2Fix(24);</span>
<a href="#l1.418"></a><span id="l1.418">   RGBColor white = { 0xFFFF, 0xFFFF, 0xFFFF };</span>
<a href="#l1.419"></a><span id="l1.419" class="difflineminus">-    </span>
<a href="#l1.420"></a><span id="l1.420" class="difflineplus">+</span>
<a href="#l1.421"></a><span id="l1.421">   ATSUAttributeTag tags[3] = { kATSUFontTag, kATSUSizeTag, kATSUColorTag };</span>
<a href="#l1.422"></a><span id="l1.422">   ByteCount valueSizes[3] = { sizeof(ATSUFontID), sizeof(Fixed),</span>
<a href="#l1.423"></a><span id="l1.423">                               sizeof(RGBColor) };</span>
<a href="#l1.424"></a><span id="l1.424">   ATSUAttributeValuePtr values[3] = { &amp;fmFont, &amp;size, &amp;white };</span>
<a href="#l1.425"></a><span id="l1.425"> </span>
<a href="#l1.426"></a><span id="l1.426" class="difflineminus">-  if (::ATSUSetAttributes(style, 3, tags, valueSizes, values) != noErr) </span>
<a href="#l1.427"></a><span id="l1.427" class="difflineplus">+  if (::ATSUSetAttributes(style, 3, tags, valueSizes, values) != noErr)</span>
<a href="#l1.428"></a><span id="l1.428">   {</span>
<a href="#l1.429"></a><span id="l1.429">     NS_WARNING(&quot;ATSUSetAttributes failed&quot;);</span>
<a href="#l1.430"></a><span id="l1.430">     ::ATSUDisposeStyle(style);</span>
<a href="#l1.431"></a><span id="l1.431">     ::EndCGContextForApplicationDockTile(context);</span>
<a href="#l1.432"></a><span id="l1.432">     return NS_ERROR_FAILURE;</span>
<a href="#l1.433"></a><span id="l1.433">   }</span>
<a href="#l1.434"></a><span id="l1.434"> </span>
<a href="#l1.435"></a><span id="l1.435">   UniCharCount runLengths = kATSUToTextEnd;</span>
<a href="#l1.436"></a><span id="l1.436">   ATSUTextLayout textLayout;</span>
<a href="#l1.437"></a><span id="l1.437" class="difflineminus">-  if (::ATSUCreateTextLayoutWithTextPtr(total.get(), </span>
<a href="#l1.438"></a><span id="l1.438" class="difflineminus">-                                        kATSUFromTextBeginning, </span>
<a href="#l1.439"></a><span id="l1.439" class="difflineminus">-                                        kATSUToTextEnd, </span>
<a href="#l1.440"></a><span id="l1.440" class="difflineminus">-                                        total.Length(), </span>
<a href="#l1.441"></a><span id="l1.441" class="difflineminus">-                                        1, </span>
<a href="#l1.442"></a><span id="l1.442" class="difflineminus">-                                        &amp;runLengths, </span>
<a href="#l1.443"></a><span id="l1.443" class="difflineminus">-                                        &amp;style, </span>
<a href="#l1.444"></a><span id="l1.444" class="difflineminus">-                                        &amp;textLayout) != noErr) </span>
<a href="#l1.445"></a><span id="l1.445" class="difflineplus">+  if (::ATSUCreateTextLayoutWithTextPtr(badgeString.get(),</span>
<a href="#l1.446"></a><span id="l1.446" class="difflineplus">+                                        kATSUFromTextBeginning,</span>
<a href="#l1.447"></a><span id="l1.447" class="difflineplus">+                                        kATSUToTextEnd,</span>
<a href="#l1.448"></a><span id="l1.448" class="difflineplus">+                                        badgeString.Length(),</span>
<a href="#l1.449"></a><span id="l1.449" class="difflineplus">+                                        1,</span>
<a href="#l1.450"></a><span id="l1.450" class="difflineplus">+                                        &amp;runLengths,</span>
<a href="#l1.451"></a><span id="l1.451" class="difflineplus">+                                        &amp;style,</span>
<a href="#l1.452"></a><span id="l1.452" class="difflineplus">+                                        &amp;textLayout) != noErr)</span>
<a href="#l1.453"></a><span id="l1.453">   {</span>
<a href="#l1.454"></a><span id="l1.454">     NS_WARNING(&quot;ATSUCreateTextLayoutWithTextPtr failed&quot;);</span>
<a href="#l1.455"></a><span id="l1.455">     ::ATSUDisposeStyle(style);</span>
<a href="#l1.456"></a><span id="l1.456">     ::EndCGContextForApplicationDockTile(context);</span>
<a href="#l1.457"></a><span id="l1.457">     return NS_ERROR_FAILURE;</span>
<a href="#l1.458"></a><span id="l1.458">   }</span>
<a href="#l1.459"></a><span id="l1.459"> </span>
<a href="#l1.460"></a><span id="l1.460">   ATSUAttributeTag layoutTags[1] = { kATSUCGContextTag };</span>
<a href="#l1.461"></a><span id="l1.461">   ByteCount layoutValueSizes[1] = { sizeof(CGContextRef) };</span>
<a href="#l1.462"></a><span id="l1.462">   ATSUAttributeValuePtr layoutValues[1] = { &amp;context };</span>
<a href="#l1.463"></a><span id="l1.463"> </span>
<a href="#l1.464"></a><span id="l1.464" class="difflineminus">-  if (::ATSUSetLayoutControls(textLayout, </span>
<a href="#l1.465"></a><span id="l1.465" class="difflineminus">-                              1, </span>
<a href="#l1.466"></a><span id="l1.466" class="difflineminus">-                              layoutTags, </span>
<a href="#l1.467"></a><span id="l1.467" class="difflineminus">-                              layoutValueSizes, </span>
<a href="#l1.468"></a><span id="l1.468" class="difflineminus">-                              layoutValues) != noErr) </span>
<a href="#l1.469"></a><span id="l1.469" class="difflineplus">+  if (::ATSUSetLayoutControls(textLayout,</span>
<a href="#l1.470"></a><span id="l1.470" class="difflineplus">+                              1,</span>
<a href="#l1.471"></a><span id="l1.471" class="difflineplus">+                              layoutTags,</span>
<a href="#l1.472"></a><span id="l1.472" class="difflineplus">+                              layoutValueSizes,</span>
<a href="#l1.473"></a><span id="l1.473" class="difflineplus">+                              layoutValues) != noErr)</span>
<a href="#l1.474"></a><span id="l1.474">   {</span>
<a href="#l1.475"></a><span id="l1.475">     NS_WARNING(&quot;ATSUSetLayoutControls failed&quot;);</span>
<a href="#l1.476"></a><span id="l1.476">     ::ATSUDisposeStyle(style);</span>
<a href="#l1.477"></a><span id="l1.477">     ::EndCGContextForApplicationDockTile(context);</span>
<a href="#l1.478"></a><span id="l1.478">     return NS_ERROR_FAILURE;</span>
<a href="#l1.479"></a><span id="l1.479">   }</span>
<a href="#l1.480"></a><span id="l1.480"> </span>
<a href="#l1.481"></a><span id="l1.481">   Rect boundingBox;</span>
<a href="#l1.482"></a><span id="l1.482" class="difflineminus">-  if (::ATSUMeasureTextImage(textLayout, </span>
<a href="#l1.483"></a><span id="l1.483" class="difflineplus">+  if (::ATSUMeasureTextImage(textLayout,</span>
<a href="#l1.484"></a><span id="l1.484">                              kATSUFromTextBeginning,</span>
<a href="#l1.485"></a><span id="l1.485">                              kATSUToTextEnd,</span>
<a href="#l1.486"></a><span id="l1.486">                              Long2Fix(0),</span>
<a href="#l1.487"></a><span id="l1.487">                              Long2Fix(0),</span>
<a href="#l1.488"></a><span id="l1.488" class="difflineminus">-                             &amp;boundingBox) != noErr) </span>
<a href="#l1.489"></a><span id="l1.489" class="difflineplus">+                             &amp;boundingBox) != noErr)</span>
<a href="#l1.490"></a><span id="l1.490">   {</span>
<a href="#l1.491"></a><span id="l1.491">     NS_WARNING(&quot;ATSUMeasureTextImage failed&quot;);</span>
<a href="#l1.492"></a><span id="l1.492">     ::ATSUDisposeStyle(style);</span>
<a href="#l1.493"></a><span id="l1.493">     ::EndCGContextForApplicationDockTile(context);</span>
<a href="#l1.494"></a><span id="l1.494">     return NS_ERROR_FAILURE;</span>
<a href="#l1.495"></a><span id="l1.495">   }</span>
<a href="#l1.496"></a><span id="l1.496"> </span>
<a href="#l1.497"></a><span id="l1.497">   // Center text inside circle</span>
<a href="#l1.498"></a><span id="l1.498">   ::ATSUDrawText(textLayout, kATSUFromTextBeginning, kATSUToTextEnd,</span>
<a href="#l1.499"></a><span id="l1.499" class="difflineminus">-                 Long2Fix(90 - (boundingBox.right - boundingBox.left) / 2),</span>
<a href="#l1.500"></a><span id="l1.500" class="difflineplus">+                 Long2Fix(95 - (boundingBox.right - boundingBox.left) / 2),</span>
<a href="#l1.501"></a><span id="l1.501">                  Long2Fix(95 - (boundingBox.bottom - boundingBox.top) / 2));</span>
<a href="#l1.502"></a><span id="l1.502"> </span>
<a href="#l1.503"></a><span id="l1.503">   ::ATSUDisposeStyle(style);</span>
<a href="#l1.504"></a><span id="l1.504">   ::ATSUDisposeTextLayout(textLayout);</span>
<a href="#l1.505"></a><span id="l1.505"> </span>
<a href="#l1.506"></a><span id="l1.506">   ::CGContextFlush(context);</span>
<a href="#l1.507"></a><span id="l1.507">   ::EndCGContextForApplicationDockTile(context);</span>
<a href="#l1.508"></a><span id="l1.508" class="difflineminus">-</span>
<a href="#l1.509"></a><span id="l1.509" class="difflineminus">-  mBiffIconVisible = PR_TRUE;</span>
<a href="#l1.510"></a><span id="l1.510">   return NS_OK;</span>
<a href="#l1.511"></a><span id="l1.511"> }</span>
<a href="#l1.512"></a><span id="l1.512"> </span>
<a href="#l1.513"></a><span id="l1.513"> NS_IMETHODIMP</span>
<a href="#l1.514"></a><span id="l1.514"> nsMessengerOSXIntegration::OnItemPropertyFlagChanged(nsIMsgDBHdr *item, nsIAtom *property, PRUint32 oldFlag, PRUint32 newFlag)</span>
<a href="#l1.515"></a><span id="l1.515"> {</span>
<a href="#l1.516"></a><span id="l1.516">   return NS_OK;</span>
<a href="#l1.517"></a><span id="l1.517"> }</span>
<a href="#l1.518"></a><span id="l1.518" class="difflineat">@@ -727,17 +738,17 @@ nsMessengerOSXIntegration::GetNewMailAut</span>
<a href="#l1.519"></a><span id="l1.519">       nsString listSeparator;</span>
<a href="#l1.520"></a><span id="l1.520">       bundle-&gt;GetStringFromName(NS_LITERAL_STRING(&quot;macBiffNotification_separator&quot;).get(), getter_Copies(listSeparator));</span>
<a href="#l1.521"></a><span id="l1.521"> </span>
<a href="#l1.522"></a><span id="l1.522">       PRInt32 displayed = 0;</span>
<a href="#l1.523"></a><span id="l1.523">       for (PRInt32 i = numNewKeys - 1; i &gt;= 0; i--, aNewCount--)</span>
<a href="#l1.524"></a><span id="l1.524">       {</span>
<a href="#l1.525"></a><span id="l1.525">         if (0 == aNewCount || displayed == kMaxDisplayCount)</span>
<a href="#l1.526"></a><span id="l1.526">           break;</span>
<a href="#l1.527"></a><span id="l1.527" class="difflineminus">-  </span>
<a href="#l1.528"></a><span id="l1.528" class="difflineplus">+</span>
<a href="#l1.529"></a><span id="l1.529">         nsCOMPtr&lt;nsIMsgDBHdr&gt; hdr;</span>
<a href="#l1.530"></a><span id="l1.530">         rv = db-&gt;GetMsgHdrForKey(newMessageKeys[i],</span>
<a href="#l1.531"></a><span id="l1.531">                                  getter_AddRefs(hdr));</span>
<a href="#l1.532"></a><span id="l1.532">         if (NS_SUCCEEDED(rv) &amp;&amp; hdr)</span>
<a href="#l1.533"></a><span id="l1.533">         {</span>
<a href="#l1.534"></a><span id="l1.534">           nsString author;</span>
<a href="#l1.535"></a><span id="l1.535">           rv = hdr-&gt;GetMime2DecodedAuthor(author);</span>
<a href="#l1.536"></a><span id="l1.536">           if (NS_FAILED(rv))</span>
<a href="#l1.537"></a><span id="l1.537" class="difflineat">@@ -817,8 +828,173 @@ nsMessengerOSXIntegration::GetFirstFolde</span>
<a href="#l1.538"></a><span id="l1.538">     }  // if enumerator</span>
<a href="#l1.539"></a><span id="l1.539"> </span>
<a href="#l1.540"></a><span id="l1.540">     if (msgFolder)</span>
<a href="#l1.541"></a><span id="l1.541">       msgFolder-&gt;GetURI(aFolderURI);</span>
<a href="#l1.542"></a><span id="l1.542">   }</span>
<a href="#l1.543"></a><span id="l1.543"> </span>
<a href="#l1.544"></a><span id="l1.544">   return NS_OK;</span>
<a href="#l1.545"></a><span id="l1.545"> }</span>
<a href="#l1.546"></a><span id="l1.546" class="difflineplus">+</span>
<a href="#l1.547"></a><span id="l1.547" class="difflineplus">+void</span>
<a href="#l1.548"></a><span id="l1.548" class="difflineplus">+nsMessengerOSXIntegration::InitUnreadCount()</span>
<a href="#l1.549"></a><span id="l1.549" class="difflineplus">+{</span>
<a href="#l1.550"></a><span id="l1.550" class="difflineplus">+  // We either count just inboxes, or all folders</span>
<a href="#l1.551"></a><span id="l1.551" class="difflineplus">+  nsresult rv;</span>
<a href="#l1.552"></a><span id="l1.552" class="difflineplus">+  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l1.553"></a><span id="l1.553" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, );</span>
<a href="#l1.554"></a><span id="l1.554" class="difflineplus">+</span>
<a href="#l1.555"></a><span id="l1.555" class="difflineplus">+  rv = prefBranch-&gt;GetBoolPref(kCountInboxesPref, &amp;mOnlyCountInboxes);</span>
<a href="#l1.556"></a><span id="l1.556" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, );</span>
<a href="#l1.557"></a><span id="l1.557" class="difflineplus">+</span>
<a href="#l1.558"></a><span id="l1.558" class="difflineplus">+  nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l1.559"></a><span id="l1.559" class="difflineplus">+    do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l1.560"></a><span id="l1.560" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, );</span>
<a href="#l1.561"></a><span id="l1.561" class="difflineplus">+</span>
<a href="#l1.562"></a><span id="l1.562" class="difflineplus">+  nsCOMPtr&lt;nsISupportsArray&gt; servers;</span>
<a href="#l1.563"></a><span id="l1.563" class="difflineplus">+  rv = accountManager-&gt;GetAllServers(getter_AddRefs(servers));</span>
<a href="#l1.564"></a><span id="l1.564" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, );</span>
<a href="#l1.565"></a><span id="l1.565" class="difflineplus">+</span>
<a href="#l1.566"></a><span id="l1.566" class="difflineplus">+  PRUint32 count;</span>
<a href="#l1.567"></a><span id="l1.567" class="difflineplus">+  rv = servers-&gt;Count(&amp;count);</span>
<a href="#l1.568"></a><span id="l1.568" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, );</span>
<a href="#l1.569"></a><span id="l1.569" class="difflineplus">+</span>
<a href="#l1.570"></a><span id="l1.570" class="difflineplus">+  PRUint32 i;</span>
<a href="#l1.571"></a><span id="l1.571" class="difflineplus">+  for (i = 0; i &lt; count; i++)</span>
<a href="#l1.572"></a><span id="l1.572" class="difflineplus">+  {</span>
<a href="#l1.573"></a><span id="l1.573" class="difflineplus">+    nsCOMPtr&lt;nsIMsgIncomingServer&gt; server = do_QueryElementAt(servers, i);</span>
<a href="#l1.574"></a><span id="l1.574" class="difflineplus">+    if (!server)</span>
<a href="#l1.575"></a><span id="l1.575" class="difflineplus">+      continue;</span>
<a href="#l1.576"></a><span id="l1.576" class="difflineplus">+</span>
<a href="#l1.577"></a><span id="l1.577" class="difflineplus">+    nsCOMPtr&lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l1.578"></a><span id="l1.578" class="difflineplus">+    server-&gt;GetRootFolder(getter_AddRefs(rootFolder));</span>
<a href="#l1.579"></a><span id="l1.579" class="difflineplus">+    if (!rootFolder)</span>
<a href="#l1.580"></a><span id="l1.580" class="difflineplus">+      continue;</span>
<a href="#l1.581"></a><span id="l1.581" class="difflineplus">+</span>
<a href="#l1.582"></a><span id="l1.582" class="difflineplus">+    // Get a combined unread count for all desired folders</span>
<a href="#l1.583"></a><span id="l1.583" class="difflineplus">+    PRInt32 numUnread = 0;</span>
<a href="#l1.584"></a><span id="l1.584" class="difflineplus">+    if (mOnlyCountInboxes)</span>
<a href="#l1.585"></a><span id="l1.585" class="difflineplus">+    {</span>
<a href="#l1.586"></a><span id="l1.586" class="difflineplus">+      nsCOMPtr&lt;nsIMsgFolder&gt; inboxFolder;</span>
<a href="#l1.587"></a><span id="l1.587" class="difflineplus">+      rootFolder-&gt;GetFolderWithFlags(nsMsgFolderFlags::Inbox, getter_AddRefs(inboxFolder));</span>
<a href="#l1.588"></a><span id="l1.588" class="difflineplus">+      if (inboxFolder)</span>
<a href="#l1.589"></a><span id="l1.589" class="difflineplus">+        GetTotalUnread(inboxFolder, PR_FALSE, &amp;numUnread);</span>
<a href="#l1.590"></a><span id="l1.590" class="difflineplus">+    }</span>
<a href="#l1.591"></a><span id="l1.591" class="difflineplus">+    else</span>
<a href="#l1.592"></a><span id="l1.592" class="difflineplus">+      GetTotalUnread(rootFolder, PR_TRUE, &amp;numUnread);</span>
<a href="#l1.593"></a><span id="l1.593" class="difflineplus">+</span>
<a href="#l1.594"></a><span id="l1.594" class="difflineplus">+    mUnreadTotal += numUnread;</span>
<a href="#l1.595"></a><span id="l1.595" class="difflineplus">+    NS_ASSERTION(mUnreadTotal &gt; -1, &quot;Initial unread message count is less than zero.&quot;);</span>
<a href="#l1.596"></a><span id="l1.596" class="difflineplus">+  }</span>
<a href="#l1.597"></a><span id="l1.597" class="difflineplus">+}</span>
<a href="#l1.598"></a><span id="l1.598" class="difflineplus">+</span>
<a href="#l1.599"></a><span id="l1.599" class="difflineplus">+nsresult</span>
<a href="#l1.600"></a><span id="l1.600" class="difflineplus">+nsMessengerOSXIntegration::ConfirmShouldCount(nsIMsgFolder* aFolder, PRBool* aCountFolder)</span>
<a href="#l1.601"></a><span id="l1.601" class="difflineplus">+{</span>
<a href="#l1.602"></a><span id="l1.602" class="difflineplus">+  // We give extensions a chance to say yes/no to counting for a folder.  By</span>
<a href="#l1.603"></a><span id="l1.603" class="difflineplus">+  // default we count every folder that is mail and isn't </span>
<a href="#l1.604"></a><span id="l1.604" class="difflineplus">+  // Trash, Junk, Drafts, &quot;Outbox&quot;, or a Virtual folder.</span>
<a href="#l1.605"></a><span id="l1.605" class="difflineplus">+  nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l1.606"></a><span id="l1.606" class="difflineplus">+  nsresult rv = aFolder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l1.607"></a><span id="l1.607" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.608"></a><span id="l1.608" class="difflineplus">+</span>
<a href="#l1.609"></a><span id="l1.609" class="difflineplus">+  PRBool defaultValue = PR_TRUE;</span>
<a href="#l1.610"></a><span id="l1.610" class="difflineplus">+  nsCAutoString type;</span>
<a href="#l1.611"></a><span id="l1.611" class="difflineplus">+  rv = server-&gt;GetType(type);</span>
<a href="#l1.612"></a><span id="l1.612" class="difflineplus">+  if (NS_FAILED(rv) || (type.EqualsLiteral(&quot;rss&quot;) || type.EqualsLiteral(&quot;nntp&quot;)))</span>
<a href="#l1.613"></a><span id="l1.613" class="difflineplus">+  {</span>
<a href="#l1.614"></a><span id="l1.614" class="difflineplus">+    defaultValue = PR_FALSE;</span>
<a href="#l1.615"></a><span id="l1.615" class="difflineplus">+    return NS_OK;</span>
<a href="#l1.616"></a><span id="l1.616" class="difflineplus">+  }</span>
<a href="#l1.617"></a><span id="l1.617" class="difflineplus">+</span>
<a href="#l1.618"></a><span id="l1.618" class="difflineplus">+  nsCOMPtr&lt;nsIObserverService&gt; os =</span>
<a href="#l1.619"></a><span id="l1.619" class="difflineplus">+    do_GetService(&quot;@mozilla.org/observer-service;1&quot;, &amp;rv);</span>
<a href="#l1.620"></a><span id="l1.620" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.621"></a><span id="l1.621" class="difflineplus">+</span>
<a href="#l1.622"></a><span id="l1.622" class="difflineplus">+  nsCOMPtr&lt;nsISupportsPRBool&gt; shouldCount =</span>
<a href="#l1.623"></a><span id="l1.623" class="difflineplus">+    do_CreateInstance(NS_SUPPORTS_PRBOOL_CONTRACTID, &amp;rv);</span>
<a href="#l1.624"></a><span id="l1.624" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.625"></a><span id="l1.625" class="difflineplus">+</span>
<a href="#l1.626"></a><span id="l1.626" class="difflineplus">+  PRUint32 flags;</span>
<a href="#l1.627"></a><span id="l1.627" class="difflineplus">+  aFolder-&gt;GetFlags(&amp;flags);</span>
<a href="#l1.628"></a><span id="l1.628" class="difflineplus">+  if ((flags &amp; nsMsgFolderFlags::Trash)   ||</span>
<a href="#l1.629"></a><span id="l1.629" class="difflineplus">+      (flags &amp; nsMsgFolderFlags::Drafts)  ||</span>
<a href="#l1.630"></a><span id="l1.630" class="difflineplus">+      (flags &amp; nsMsgFolderFlags::Queue)   ||</span>
<a href="#l1.631"></a><span id="l1.631" class="difflineplus">+      (flags &amp; nsMsgFolderFlags::Virtual) ||</span>
<a href="#l1.632"></a><span id="l1.632" class="difflineplus">+      (flags &amp; nsMsgFolderFlags::Junk))</span>
<a href="#l1.633"></a><span id="l1.633" class="difflineplus">+    defaultValue = PR_FALSE;</span>
<a href="#l1.634"></a><span id="l1.634" class="difflineplus">+</span>
<a href="#l1.635"></a><span id="l1.635" class="difflineplus">+  rv = shouldCount-&gt;SetData(defaultValue);</span>
<a href="#l1.636"></a><span id="l1.636" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.637"></a><span id="l1.637" class="difflineplus">+</span>
<a href="#l1.638"></a><span id="l1.638" class="difflineplus">+  nsCString folderUri;</span>
<a href="#l1.639"></a><span id="l1.639" class="difflineplus">+  rv = aFolder-&gt;GetURI(folderUri);</span>
<a href="#l1.640"></a><span id="l1.640" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.641"></a><span id="l1.641" class="difflineplus">+</span>
<a href="#l1.642"></a><span id="l1.642" class="difflineplus">+  rv = os-&gt;NotifyObservers(shouldCount, &quot;before-count-unread-for-folder&quot;,</span>
<a href="#l1.643"></a><span id="l1.643" class="difflineplus">+                           NS_ConvertUTF8toUTF16(folderUri).get());</span>
<a href="#l1.644"></a><span id="l1.644" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.645"></a><span id="l1.645" class="difflineplus">+</span>
<a href="#l1.646"></a><span id="l1.646" class="difflineplus">+  return shouldCount-&gt;GetData(aCountFolder);</span>
<a href="#l1.647"></a><span id="l1.647" class="difflineplus">+}</span>
<a href="#l1.648"></a><span id="l1.648" class="difflineplus">+</span>
<a href="#l1.649"></a><span id="l1.649" class="difflineplus">+nsresult</span>
<a href="#l1.650"></a><span id="l1.650" class="difflineplus">+nsMessengerOSXIntegration::GetTotalUnread(nsIMsgFolder* aFolder, PRBool deep, PRInt32* aTotal)</span>
<a href="#l1.651"></a><span id="l1.651" class="difflineplus">+{</span>
<a href="#l1.652"></a><span id="l1.652" class="difflineplus">+  // This simulates nsIMsgFolder::GetNumUnread, but gives extensions</span>
<a href="#l1.653"></a><span id="l1.653" class="difflineplus">+  // a chance to decide whether folders should be counted as part of</span>
<a href="#l1.654"></a><span id="l1.654" class="difflineplus">+  // the total.</span>
<a href="#l1.655"></a><span id="l1.655" class="difflineplus">+  *aTotal = 0;</span>
<a href="#l1.656"></a><span id="l1.656" class="difflineplus">+  PRBool countFolder;</span>
<a href="#l1.657"></a><span id="l1.657" class="difflineplus">+  nsresult rv = ConfirmShouldCount(aFolder, &amp;countFolder);</span>
<a href="#l1.658"></a><span id="l1.658" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.659"></a><span id="l1.659" class="difflineplus">+</span>
<a href="#l1.660"></a><span id="l1.660" class="difflineplus">+  if (!countFolder)</span>
<a href="#l1.661"></a><span id="l1.661" class="difflineplus">+    return NS_OK;</span>
<a href="#l1.662"></a><span id="l1.662" class="difflineplus">+</span>
<a href="#l1.663"></a><span id="l1.663" class="difflineplus">+  PRInt32 total = 0;</span>
<a href="#l1.664"></a><span id="l1.664" class="difflineplus">+  rv = aFolder-&gt;GetNumUnread(PR_FALSE, &amp;total);</span>
<a href="#l1.665"></a><span id="l1.665" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.666"></a><span id="l1.666" class="difflineplus">+</span>
<a href="#l1.667"></a><span id="l1.667" class="difflineplus">+  // Use zero instead of -1 (don't know) or other special nums.</span>
<a href="#l1.668"></a><span id="l1.668" class="difflineplus">+  total = total &gt;= 0 ? total : 0;</span>
<a href="#l1.669"></a><span id="l1.669" class="difflineplus">+</span>
<a href="#l1.670"></a><span id="l1.670" class="difflineplus">+  if (deep)</span>
<a href="#l1.671"></a><span id="l1.671" class="difflineplus">+  {</span>
<a href="#l1.672"></a><span id="l1.672" class="difflineplus">+    PRBool hasChildren;</span>
<a href="#l1.673"></a><span id="l1.673" class="difflineplus">+    rv = aFolder-&gt;GetHasSubFolders(&amp;hasChildren);</span>
<a href="#l1.674"></a><span id="l1.674" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.675"></a><span id="l1.675" class="difflineplus">+</span>
<a href="#l1.676"></a><span id="l1.676" class="difflineplus">+    PRUint32 flags;</span>
<a href="#l1.677"></a><span id="l1.677" class="difflineplus">+    aFolder-&gt;GetFlags(&amp;flags);</span>
<a href="#l1.678"></a><span id="l1.678" class="difflineplus">+</span>
<a href="#l1.679"></a><span id="l1.679" class="difflineplus">+    if (hasChildren &amp;&amp; !(flags &amp; nsMsgFolderFlags::Virtual))</span>
<a href="#l1.680"></a><span id="l1.680" class="difflineplus">+    {</span>
<a href="#l1.681"></a><span id="l1.681" class="difflineplus">+      nsCOMPtr&lt;nsISimpleEnumerator&gt; children;</span>
<a href="#l1.682"></a><span id="l1.682" class="difflineplus">+      rv = aFolder-&gt;GetSubFolders(getter_AddRefs(children));</span>
<a href="#l1.683"></a><span id="l1.683" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.684"></a><span id="l1.684" class="difflineplus">+</span>
<a href="#l1.685"></a><span id="l1.685" class="difflineplus">+      nsCOMPtr&lt;nsIMsgFolder&gt; childFolder;</span>
<a href="#l1.686"></a><span id="l1.686" class="difflineplus">+      PRBool moreFolders;</span>
<a href="#l1.687"></a><span id="l1.687" class="difflineplus">+      while (NS_SUCCEEDED(children-&gt;HasMoreElements(&amp;moreFolders)) &amp;&amp;</span>
<a href="#l1.688"></a><span id="l1.688" class="difflineplus">+             moreFolders)</span>
<a href="#l1.689"></a><span id="l1.689" class="difflineplus">+      {</span>
<a href="#l1.690"></a><span id="l1.690" class="difflineplus">+        nsCOMPtr&lt;nsISupports&gt; child;</span>
<a href="#l1.691"></a><span id="l1.691" class="difflineplus">+        rv = children-&gt;GetNext(getter_AddRefs(child));</span>
<a href="#l1.692"></a><span id="l1.692" class="difflineplus">+        if (NS_SUCCEEDED(rv) &amp;&amp; child)</span>
<a href="#l1.693"></a><span id="l1.693" class="difflineplus">+        {</span>
<a href="#l1.694"></a><span id="l1.694" class="difflineplus">+          childFolder = do_QueryInterface(child, &amp;rv);</span>
<a href="#l1.695"></a><span id="l1.695" class="difflineplus">+          if (NS_SUCCEEDED(rv) &amp;&amp; childFolder)</span>
<a href="#l1.696"></a><span id="l1.696" class="difflineplus">+          {</span>
<a href="#l1.697"></a><span id="l1.697" class="difflineplus">+            PRInt32 childFolderCount = 0;</span>
<a href="#l1.698"></a><span id="l1.698" class="difflineplus">+            rv = GetTotalUnread(childFolder, PR_TRUE, &amp;childFolderCount);</span>
<a href="#l1.699"></a><span id="l1.699" class="difflineplus">+            if (NS_FAILED(rv))</span>
<a href="#l1.700"></a><span id="l1.700" class="difflineplus">+              continue;</span>
<a href="#l1.701"></a><span id="l1.701" class="difflineplus">+</span>
<a href="#l1.702"></a><span id="l1.702" class="difflineplus">+            total += childFolderCount;</span>
<a href="#l1.703"></a><span id="l1.703" class="difflineplus">+          }</span>
<a href="#l1.704"></a><span id="l1.704" class="difflineplus">+        }</span>
<a href="#l1.705"></a><span id="l1.705" class="difflineplus">+      }</span>
<a href="#l1.706"></a><span id="l1.706" class="difflineplus">+    }</span>
<a href="#l1.707"></a><span id="l1.707" class="difflineplus">+  }</span>
<a href="#l1.708"></a><span id="l1.708" class="difflineplus">+  *aTotal = total;</span>
<a href="#l1.709"></a><span id="l1.709" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.710"></a><span id="l1.710" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/base/src/nsMessengerOSXIntegration.h</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/base/src/nsMessengerOSXIntegration.h</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -17,17 +17,18 @@</span>
<a href="#l2.4"></a><span id="l2.4">  * The Initial Developer of the Original Code is</span>
<a href="#l2.5"></a><span id="l2.5">  * The Mozilla Foundation.</span>
<a href="#l2.6"></a><span id="l2.6">  * Portions created by the Initial Developer are Copyright (C) 2005</span>
<a href="#l2.7"></a><span id="l2.7">  * the Initial Developer. All Rights Reserved.</span>
<a href="#l2.8"></a><span id="l2.8">  *</span>
<a href="#l2.9"></a><span id="l2.9">  * Contributor(s):</span>
<a href="#l2.10"></a><span id="l2.10">  *  Scott MacGregor &lt;mscott@mozilla.org&gt;</span>
<a href="#l2.11"></a><span id="l2.11">  *  Jon Baumgartner &lt;jon@bergenstreetsoftware.com&gt;</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">- *  </span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+ *  David Humphrey &lt;david.humphrey@senecac.on.ca&gt;</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+ *</span>
<a href="#l2.15"></a><span id="l2.15">  * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l2.16"></a><span id="l2.16">  * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l2.17"></a><span id="l2.17">  * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l2.18"></a><span id="l2.18">  * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l2.19"></a><span id="l2.19">  * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l2.20"></a><span id="l2.20">  * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l2.21"></a><span id="l2.21">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l2.22"></a><span id="l2.22">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineat">@@ -42,17 +43,16 @@</span>
<a href="#l2.24"></a><span id="l2.24"> </span>
<a href="#l2.25"></a><span id="l2.25"> #include &quot;nsIMessengerOSIntegration.h&quot;</span>
<a href="#l2.26"></a><span id="l2.26"> #include &quot;nsIFolderListener.h&quot;</span>
<a href="#l2.27"></a><span id="l2.27"> #include &quot;nsIAtom.h&quot;</span>
<a href="#l2.28"></a><span id="l2.28"> #include &quot;nsITimer.h&quot;</span>
<a href="#l2.29"></a><span id="l2.29"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l2.30"></a><span id="l2.30"> #include &quot;nsString.h&quot;</span>
<a href="#l2.31"></a><span id="l2.31"> #include &quot;nsInt64.h&quot;</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineminus">-#include &quot;nsISupportsArray.h&quot;</span>
<a href="#l2.33"></a><span id="l2.33"> #include &quot;nsIObserver.h&quot;</span>
<a href="#l2.34"></a><span id="l2.34"> #include &quot;nsIAlertsService.h&quot;</span>
<a href="#l2.35"></a><span id="l2.35"> </span>
<a href="#l2.36"></a><span id="l2.36"> #define NS_MESSENGEROSXINTEGRATION_CID \</span>
<a href="#l2.37"></a><span id="l2.37">   {0xaa83266, 0x4225, 0x4c4b, \</span>
<a href="#l2.38"></a><span id="l2.38">   {0x93, 0xf8, 0x94, 0xb1, 0x82, 0x58, 0x6f, 0x93}}</span>
<a href="#l2.39"></a><span id="l2.39"> </span>
<a href="#l2.40"></a><span id="l2.40"> class nsIStringBundle;</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineat">@@ -67,26 +67,29 @@ public:</span>
<a href="#l2.42"></a><span id="l2.42">   virtual nsresult Init();</span>
<a href="#l2.43"></a><span id="l2.43"> </span>
<a href="#l2.44"></a><span id="l2.44">   NS_DECL_ISUPPORTS</span>
<a href="#l2.45"></a><span id="l2.45">   NS_DECL_NSIMESSENGEROSINTEGRATION</span>
<a href="#l2.46"></a><span id="l2.46">   NS_DECL_NSIFOLDERLISTENER</span>
<a href="#l2.47"></a><span id="l2.47">   NS_DECL_NSIOBSERVER</span>
<a href="#l2.48"></a><span id="l2.48"> </span>
<a href="#l2.49"></a><span id="l2.49"> private:</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineminus">-  nsCOMPtr&lt;nsISupportsArray&gt; mFoldersWithNewMail;  // keep track of all the root folders with pending new mail</span>
<a href="#l2.51"></a><span id="l2.51">   nsCOMPtr&lt;nsIAtom&gt; mBiffStateAtom;</span>
<a href="#l2.52"></a><span id="l2.52">   nsCOMPtr&lt;nsIAtom&gt; mNewMailReceivedAtom;</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineminus">-  PRInt32 CountNewMessages();</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineplus">+  nsCOMPtr&lt;nsIAtom&gt; mTotalUnreadMessagesAtom;</span>
<a href="#l2.55"></a><span id="l2.55">   nsresult ShowAlertMessage(const nsAString&amp; aAlertTitle, const nsAString&amp; aAlertText, const nsACString&amp; aFolderURI);</span>
<a href="#l2.56"></a><span id="l2.56">   nsresult OnAlertFinished();</span>
<a href="#l2.57"></a><span id="l2.57">   nsresult OnAlertClicked(const PRUnichar * aAlertCookie);</span>
<a href="#l2.58"></a><span id="l2.58">   nsresult GetStringBundle(nsIStringBundle **aBundle);</span>
<a href="#l2.59"></a><span id="l2.59">   void FillToolTipInfo(nsIMsgFolder *aFolder, PRInt32 aNewCount);</span>
<a href="#l2.60"></a><span id="l2.60">   nsresult GetFirstFolderWithNewMail(nsIMsgFolder* aFolder, nsCString&amp; aFolderURI);</span>
<a href="#l2.61"></a><span id="l2.61">   nsresult BadgeDockIcon();</span>
<a href="#l2.62"></a><span id="l2.62">   nsresult BounceDockIcon();</span>
<a href="#l2.63"></a><span id="l2.63">   nsresult GetNewMailAuthors(nsIMsgFolder* aFolder, nsString&amp; aAuthors, PRInt32 aNewCount, PRInt32* aNotDisplayed);</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineplus">+  nsresult GetTotalUnread(nsIMsgFolder* aFolder, PRBool deep, PRInt32* aTotal);</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineplus">+  nsresult ConfirmShouldCount(nsIMsgFolder* aFolder, PRBool* aCountFolder);</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineplus">+  void InitUnreadCount();</span>
<a href="#l2.67"></a><span id="l2.67"> </span>
<a href="#l2.68"></a><span id="l2.68" class="difflineminus">-  PRPackedBool mBiffIconVisible;</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineplus">+  PRInt32 mUnreadTotal;</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineplus">+  PRBool mOnlyCountInboxes;</span>
<a href="#l2.71"></a><span id="l2.71"> };</span>
<a href="#l2.72"></a><span id="l2.72"> </span>
<a href="#l2.73"></a><span id="l2.73"> #endif // __nsMessengerOSXIntegration_h</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/mailnews.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/mailnews.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -807,16 +807,17 @@ pref(&quot;ldap_2.servers.oe.description&quot;, &quot;c</span>
<a href="#l3.4"></a><span id="l3.4"> pref(&quot;ldap_2.servers.oe.dirType&quot;, 3);</span>
<a href="#l3.5"></a><span id="l3.5"> #endif</span>
<a href="#l3.6"></a><span id="l3.6"> #endif</span>
<a href="#l3.7"></a><span id="l3.7"> #ifdef XP_MACOSX</span>
<a href="#l3.8"></a><span id="l3.8"> pref(&quot;ldap_2.servers.osx.uri&quot;, &quot;moz-abosxdirectory:///&quot;);</span>
<a href="#l3.9"></a><span id="l3.9"> pref(&quot;ldap_2.servers.osx.description&quot;, &quot;chrome://messenger/locale/addressbook/addressBook.properties&quot;);</span>
<a href="#l3.10"></a><span id="l3.10"> pref(&quot;ldap_2.servers.osx.dirType&quot;, 3);</span>
<a href="#l3.11"></a><span id="l3.11"> pref(&quot;mail.notification.sound&quot;,             &quot;&quot;);</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+pref(&quot;mail.notification.count.inbox_only&quot;, true);</span>
<a href="#l3.13"></a><span id="l3.13"> #else</span>
<a href="#l3.14"></a><span id="l3.14"> #ifdef XP_UNIX</span>
<a href="#l3.15"></a><span id="l3.15"> pref(&quot;mail.check_new_mail&quot;, true);</span>
<a href="#l3.16"></a><span id="l3.16"> pref(&quot;mail.signature_file&quot;, &quot;~/.signature&quot;);</span>
<a href="#l3.17"></a><span id="l3.17"> pref(&quot;mailnews.reply_with_extra_lines&quot;, 0);</span>
<a href="#l3.18"></a><span id="l3.18"> pref(&quot;mail.sash_geometry&quot;, &quot;&quot;);</span>
<a href="#l3.19"></a><span id="l3.19"> pref(&quot;news.cache_xover&quot;, false);</span>
<a href="#l3.20"></a><span id="l3.20"> pref(&quot;news.show_first_unread&quot;, false);</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

