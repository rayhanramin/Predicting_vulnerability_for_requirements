<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 29296:fec353984d2545227f0e160e8c1fa89c00f4fa65</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ fec353984d2545227f0e160e8c1fa89c00f4fa65" />
<meta property="og:url" content="/comm-central/rev/fec353984d2545227f0e160e8c1fa89c00f4fa65" />
<meta property="og:description" content="Bug 1621782 - Import bzip2 sources into comm-central. r=kaie" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / fec353984d2545227f0e160e8c1fa89c00f4fa65 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/fec353984d2545227f0e160e8c1fa89c00f4fa65">shortlog</a> |
<a href="/comm-central/log/fec353984d2545227f0e160e8c1fa89c00f4fa65">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/fec353984d2545227f0e160e8c1fa89c00f4fa65">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/fec353984d2545227f0e160e8c1fa89c00f4fa65">files</a> |
changeset |
<a href="/comm-central/raw-rev/fec353984d2545227f0e160e8c1fa89c00f4fa65">raw</a>  | <a href="/comm-central/archive/fec353984d2545227f0e160e8c1fa89c00f4fa65.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1621782">Bug 1621782</a> - Import bzip2 sources into comm-central. r=kaie
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#82;&#111;&#98;&#32;&#76;&#101;&#109;&#108;&#101;&#121;&#32;&#60;&#114;&#111;&#98;&#64;&#116;&#104;&#117;&#110;&#100;&#101;&#114;&#98;&#105;&#114;&#100;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Tue, 14 Apr 2020 22:24:35 +0000</td></tr>

<tr>
 <td>changeset 29296</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/fec353984d2545227f0e160e8c1fa89c00f4fa65">fec353984d2545227f0e160e8c1fa89c00f4fa65</a></td>
</tr>



<tr>
<td>parent 29295</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/46d32cfff30ff3d8ad4aeeb10f557283b44c10ee">46d32cfff30ff3d8ad4aeeb10f557283b44c10ee</a>
</td>
</tr>

<tr>
<td>child 29297</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/38631616c65c43cc99b885d1de75ba2c516871ed">38631616c65c43cc99b885d1de75ba2c516871ed</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=fec353984d2545227f0e160e8c1fa89c00f4fa65">17301</a></td></tr>
<tr><td>push user</td><td>thunderbird@calypsoblue.org</td></tr>
<tr><td>push date</td><td class="date age">Wed, 15 Apr 2020 18:01:44 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@7c06681d8e9a [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=7c06681d8e9a22d9226498c34b620cd4d3cf8ea3">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=7c06681d8e9a22d9226498c34b620cd4d3cf8ea3&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=7c06681d8e9a22d9226498c34b620cd4d3cf8ea3&newProject=comm-central&newRevision=46d32cfff30ff3d8ad4aeeb10f557283b44c10ee&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=7c06681d8e9a22d9226498c34b620cd4d3cf8ea3&newProject=comm-central&newRevision=46d32cfff30ff3d8ad4aeeb10f557283b44c10ee&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=7c06681d8e9a22d9226498c34b620cd4d3cf8ea3&newProject=comm-central&newRevision=46d32cfff30ff3d8ad4aeeb10f557283b44c10ee&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28kaie%29&revcount=50">kaie</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1621782">1621782</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1621782">Bug 1621782</a> - Import bzip2 sources into comm-central. r=kaie

Bzip2 is a required dependency for RNP which will not be present
on all supported operating systems.

Differential Revision: <a href="https://phabricator.services.mozilla.com/D70735">https://phabricator.services.mozilla.com/D70735</a></div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/README.bzip2">third_party/README.bzip2</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/README.bzip2">file</a> |
<a href="/comm-central/annotate/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/README.bzip2">annotate</a> |
<a href="/comm-central/diff/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/README.bzip2">diff</a> |
<a href="/comm-central/comparison/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/README.bzip2">comparison</a> |
<a href="/comm-central/log/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/README.bzip2">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/CHANGES">third_party/bzip2/CHANGES</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/CHANGES">file</a> |
<a href="/comm-central/annotate/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/CHANGES">annotate</a> |
<a href="/comm-central/diff/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/CHANGES">diff</a> |
<a href="/comm-central/comparison/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/CHANGES">comparison</a> |
<a href="/comm-central/log/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/CHANGES">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/Changelog.mzla">third_party/bzip2/Changelog.mzla</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/Changelog.mzla">file</a> |
<a href="/comm-central/annotate/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/Changelog.mzla">annotate</a> |
<a href="/comm-central/diff/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/Changelog.mzla">diff</a> |
<a href="/comm-central/comparison/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/Changelog.mzla">comparison</a> |
<a href="/comm-central/log/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/Changelog.mzla">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/LICENSE">third_party/bzip2/LICENSE</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/LICENSE">file</a> |
<a href="/comm-central/annotate/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/LICENSE">annotate</a> |
<a href="/comm-central/diff/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/LICENSE">diff</a> |
<a href="/comm-central/comparison/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/LICENSE">comparison</a> |
<a href="/comm-central/log/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/LICENSE">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/README">third_party/bzip2/README</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/README">file</a> |
<a href="/comm-central/annotate/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/README">annotate</a> |
<a href="/comm-central/diff/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/README">diff</a> |
<a href="/comm-central/comparison/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/README">comparison</a> |
<a href="/comm-central/log/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/README">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/README.COMPILATION.PROBLEMS">third_party/bzip2/README.COMPILATION.PROBLEMS</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/README.COMPILATION.PROBLEMS">file</a> |
<a href="/comm-central/annotate/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/README.COMPILATION.PROBLEMS">annotate</a> |
<a href="/comm-central/diff/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/README.COMPILATION.PROBLEMS">diff</a> |
<a href="/comm-central/comparison/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/README.COMPILATION.PROBLEMS">comparison</a> |
<a href="/comm-central/log/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/README.COMPILATION.PROBLEMS">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/README.XML.STUFF">third_party/bzip2/README.XML.STUFF</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/README.XML.STUFF">file</a> |
<a href="/comm-central/annotate/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/README.XML.STUFF">annotate</a> |
<a href="/comm-central/diff/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/README.XML.STUFF">diff</a> |
<a href="/comm-central/comparison/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/README.XML.STUFF">comparison</a> |
<a href="/comm-central/log/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/README.XML.STUFF">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/blocksort.c">third_party/bzip2/blocksort.c</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/blocksort.c">file</a> |
<a href="/comm-central/annotate/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/blocksort.c">annotate</a> |
<a href="/comm-central/diff/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/blocksort.c">diff</a> |
<a href="/comm-central/comparison/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/blocksort.c">comparison</a> |
<a href="/comm-central/log/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/blocksort.c">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/bzlib.c">third_party/bzip2/bzlib.c</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/bzlib.c">file</a> |
<a href="/comm-central/annotate/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/bzlib.c">annotate</a> |
<a href="/comm-central/diff/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/bzlib.c">diff</a> |
<a href="/comm-central/comparison/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/bzlib.c">comparison</a> |
<a href="/comm-central/log/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/bzlib.c">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/bzlib.h">third_party/bzip2/bzlib.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/bzlib.h">file</a> |
<a href="/comm-central/annotate/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/bzlib.h">annotate</a> |
<a href="/comm-central/diff/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/bzlib.h">diff</a> |
<a href="/comm-central/comparison/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/bzlib.h">comparison</a> |
<a href="/comm-central/log/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/bzlib.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/bzlib_private.h">third_party/bzip2/bzlib_private.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/bzlib_private.h">file</a> |
<a href="/comm-central/annotate/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/bzlib_private.h">annotate</a> |
<a href="/comm-central/diff/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/bzlib_private.h">diff</a> |
<a href="/comm-central/comparison/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/bzlib_private.h">comparison</a> |
<a href="/comm-central/log/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/bzlib_private.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/compress.c">third_party/bzip2/compress.c</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/compress.c">file</a> |
<a href="/comm-central/annotate/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/compress.c">annotate</a> |
<a href="/comm-central/diff/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/compress.c">diff</a> |
<a href="/comm-central/comparison/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/compress.c">comparison</a> |
<a href="/comm-central/log/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/compress.c">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/crctable.c">third_party/bzip2/crctable.c</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/crctable.c">file</a> |
<a href="/comm-central/annotate/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/crctable.c">annotate</a> |
<a href="/comm-central/diff/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/crctable.c">diff</a> |
<a href="/comm-central/comparison/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/crctable.c">comparison</a> |
<a href="/comm-central/log/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/crctable.c">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/decompress.c">third_party/bzip2/decompress.c</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/decompress.c">file</a> |
<a href="/comm-central/annotate/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/decompress.c">annotate</a> |
<a href="/comm-central/diff/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/decompress.c">diff</a> |
<a href="/comm-central/comparison/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/decompress.c">comparison</a> |
<a href="/comm-central/log/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/decompress.c">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/huffman.c">third_party/bzip2/huffman.c</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/huffman.c">file</a> |
<a href="/comm-central/annotate/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/huffman.c">annotate</a> |
<a href="/comm-central/diff/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/huffman.c">diff</a> |
<a href="/comm-central/comparison/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/huffman.c">comparison</a> |
<a href="/comm-central/log/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/huffman.c">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/randtable.c">third_party/bzip2/randtable.c</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/randtable.c">file</a> |
<a href="/comm-central/annotate/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/randtable.c">annotate</a> |
<a href="/comm-central/diff/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/randtable.c">diff</a> |
<a href="/comm-central/comparison/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/randtable.c">comparison</a> |
<a href="/comm-central/log/fec353984d2545227f0e160e8c1fa89c00f4fa65/third_party/bzip2/randtable.c">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1">new file mode 100644</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineminus">--- /dev/null</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineplus">+++ b/third_party/README.bzip2</span>
<a href="#l1.4"></a><span id="l1.4" class="difflineat">@@ -0,0 +1,44 @@</span>
<a href="#l1.5"></a><span id="l1.5" class="difflineplus">+Directory ./bzip2 contains a copy of version 1.0.8 of the bzip2 library,</span>
<a href="#l1.6"></a><span id="l1.6" class="difflineplus">+which has been obtained from https://sourceware.org/pub/bzip2/bzip2-1.0.8.tar.gz .</span>
<a href="#l1.7"></a><span id="l1.7" class="difflineplus">+</span>
<a href="#l1.8"></a><span id="l1.8" class="difflineplus">+For licensing information, please refer to the included documentation.</span>
<a href="#l1.9"></a><span id="l1.9" class="difflineplus">+</span>
<a href="#l1.10"></a><span id="l1.10" class="difflineplus">+The SHA512SUM of the imported file is:</span>
<a href="#l1.11"></a><span id="l1.11" class="difflineplus">+083f5e675d73f3233c7930ebe20425a533feedeaaa9d8cc86831312a6581cefbe6ed0d08d2fa89be81082f2a5abdabca8b3c080bf97218a1bd59dc118a30b9f3  bzip2-1.0.8.tar.gz</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+The following files were removed from the source distribution's root:</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+Makefile</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+Makefile-libbz2_so</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+bzdiff</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+bzdiff.1</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+bzgrep</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineplus">+bzgrep.1</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineplus">+bzip.css</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineplus">+bzip2.{1,1.preformatted,c,txt}</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineplus">+bzip2recover.c</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineplus">+bzmore</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineplus">+bzmore.1</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineplus">+dlltest.c</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineplus">+dlltest.dsp</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineplus">+entities.xml</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineplus">+format.pl</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineplus">+libbzip2.def</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+libbzip2.dsp</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+makefile.msc</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+manual.{html,pdf,ps,xml}</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineplus">+mk251.c</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineplus">+sample*</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineplus">+spewG.c</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineplus">+unzcrash.c</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineplus">+words*</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineplus">+xmlproc.sh</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineplus">+*xsl</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineplus">+</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineplus">+The following files were added to the source's root by MZLA Technologies:</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineplus">+Changelog.mzla</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineplus">+moz.build</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineplus">+</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineplus">+</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineplus">+Currently there is no support for building against an external bzip2 library.</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineplus">+See bug: &lt;TBD&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1">new file mode 100644</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineminus">--- /dev/null</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineplus">+++ b/third_party/bzip2/CHANGES</span>
<a href="#l2.4"></a><span id="l2.4" class="difflineat">@@ -0,0 +1,356 @@</span>
<a href="#l2.5"></a><span id="l2.5" class="difflineplus">+ ------------------------------------------------------------------</span>
<a href="#l2.6"></a><span id="l2.6" class="difflineplus">+ This file is part of bzip2/libbzip2, a program and library for</span>
<a href="#l2.7"></a><span id="l2.7" class="difflineplus">+ lossless, block-sorting data compression.</span>
<a href="#l2.8"></a><span id="l2.8" class="difflineplus">+</span>
<a href="#l2.9"></a><span id="l2.9" class="difflineplus">+ bzip2/libbzip2 version 1.0.8 of 13 July 2019</span>
<a href="#l2.10"></a><span id="l2.10" class="difflineplus">+ Copyright (C) 1996-2019 Julian Seward &lt;jseward@acm.org&gt;</span>
<a href="#l2.11"></a><span id="l2.11" class="difflineplus">+</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+ Please read the WARNING, DISCLAIMER and PATENTS sections in the </span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+ README file.</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+ This program is released under the terms of the license contained</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+ in the file LICENSE.</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+ ------------------------------------------------------------------</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+0.9.0</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineplus">+~~~~~</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineplus">+First version.</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineplus">+</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineplus">+</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineplus">+0.9.0a</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineplus">+~~~~~~</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineplus">+Removed 'ranlib' from Makefile, since most modern Unix-es </span>
<a href="#l2.28"></a><span id="l2.28" class="difflineplus">+don't need it, or even know about it.</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineplus">+</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineplus">+</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+0.9.0b</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+~~~~~~</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+Fixed a problem with error reporting in bzip2.c.  This does not effect</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+the library in any way.  Problem is: versions 0.9.0 and 0.9.0a (of the</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+program proper) compress and decompress correctly, but give misleading</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+error messages (internal panics) when an I/O error occurs, instead of</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+reporting the problem correctly.  This shouldn't give any data loss</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+(as far as I can see), but is confusing.</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineplus">+</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineplus">+Made the inline declarations disappear for non-GCC compilers.</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineplus">+</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineplus">+0.9.0c</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineplus">+~~~~~~</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineplus">+Fixed some problems in the library pertaining to some boundary cases.</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineplus">+This makes the library behave more correctly in those situations.  The</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineplus">+fixes apply only to features (calls and parameters) not used by</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineplus">+bzip2.c, so the non-fixedness of them in previous versions has no</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineplus">+effect on reliability of bzip2.c.</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineplus">+</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineplus">+In bzlib.c:</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineplus">+   * made zero-length BZ_FLUSH work correctly in bzCompress().</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineplus">+   * fixed bzWrite/bzRead to ignore zero-length requests.</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineplus">+   * fixed bzread to correctly handle read requests after EOF.</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineplus">+   * wrong parameter order in call to bzDecompressInit in</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineplus">+     bzBuffToBuffDecompress.  Fixed.</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineplus">+</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineplus">+In compress.c:</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineplus">+   * changed setting of nGroups in sendMTFValues() so as to </span>
<a href="#l2.60"></a><span id="l2.60" class="difflineplus">+     do a bit better on small files.  This _does_ effect</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineplus">+     bzip2.c.</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineplus">+</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineplus">+</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineplus">+0.9.5a</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineplus">+~~~~~~</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineplus">+Major change: add a fallback sorting algorithm (blocksort.c)</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineplus">+to give reasonable behaviour even for very repetitive inputs.</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineplus">+Nuked --repetitive-best and --repetitive-fast since they are</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineplus">+no longer useful.</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineplus">+</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineplus">+Minor changes: mostly a whole bunch of small changes/</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineplus">+bugfixes in the driver (bzip2.c).  Changes pertaining to the</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineplus">+user interface are:</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineplus">+</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineplus">+   allow decompression of symlink'd files to stdout</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineplus">+   decompress/test files even without .bz2 extension</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineplus">+   give more accurate error messages for I/O errors</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineplus">+   when compressing/decompressing to stdout, don't catch control-C</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineplus">+   read flags from BZIP2 and BZIP environment variables</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineplus">+   decline to break hard links to a file unless forced with -f</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineplus">+   allow -c flag even with no filenames</span>
<a href="#l2.82"></a><span id="l2.82" class="difflineplus">+   preserve file ownerships as far as possible</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineplus">+   make -s -1 give the expected block size (100k)</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineplus">+   add a flag -q --quiet to suppress nonessential warnings</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineplus">+   stop decoding flags after --, so files beginning in - can be handled</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineplus">+   resolved inconsistent naming: bzcat or bz2cat ?</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineplus">+   bzip2 --help now returns 0</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineplus">+</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineplus">+Programming-level changes are:</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineplus">+</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineplus">+   fixed syntax error in GET_LL4 for Borland C++ 5.02</span>
<a href="#l2.92"></a><span id="l2.92" class="difflineplus">+   let bzBuffToBuffDecompress return BZ_DATA_ERROR{_MAGIC}</span>
<a href="#l2.93"></a><span id="l2.93" class="difflineplus">+   fix overshoot of mode-string end in bzopen_or_bzdopen</span>
<a href="#l2.94"></a><span id="l2.94" class="difflineplus">+   wrapped bzlib.h in #ifdef __cplusplus ... extern &quot;C&quot; { ... }</span>
<a href="#l2.95"></a><span id="l2.95" class="difflineplus">+   close file handles under all error conditions</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineplus">+   added minor mods so it compiles with DJGPP out of the box</span>
<a href="#l2.97"></a><span id="l2.97" class="difflineplus">+   fixed Makefile so it doesn't give problems with BSD make</span>
<a href="#l2.98"></a><span id="l2.98" class="difflineplus">+   fix uninitialised memory reads in dlltest.c</span>
<a href="#l2.99"></a><span id="l2.99" class="difflineplus">+</span>
<a href="#l2.100"></a><span id="l2.100" class="difflineplus">+0.9.5b</span>
<a href="#l2.101"></a><span id="l2.101" class="difflineplus">+~~~~~~</span>
<a href="#l2.102"></a><span id="l2.102" class="difflineplus">+Open stdin/stdout in binary mode for DJGPP.</span>
<a href="#l2.103"></a><span id="l2.103" class="difflineplus">+</span>
<a href="#l2.104"></a><span id="l2.104" class="difflineplus">+0.9.5c</span>
<a href="#l2.105"></a><span id="l2.105" class="difflineplus">+~~~~~~</span>
<a href="#l2.106"></a><span id="l2.106" class="difflineplus">+Changed BZ_N_OVERSHOOT to be ... + 2 instead of ... + 1.  The + 1</span>
<a href="#l2.107"></a><span id="l2.107" class="difflineplus">+version could cause the sorted order to be wrong in some extremely</span>
<a href="#l2.108"></a><span id="l2.108" class="difflineplus">+obscure cases.  Also changed setting of quadrant in blocksort.c.</span>
<a href="#l2.109"></a><span id="l2.109" class="difflineplus">+</span>
<a href="#l2.110"></a><span id="l2.110" class="difflineplus">+0.9.5d</span>
<a href="#l2.111"></a><span id="l2.111" class="difflineplus">+~~~~~~</span>
<a href="#l2.112"></a><span id="l2.112" class="difflineplus">+The only functional change is to make bzlibVersion() in the library</span>
<a href="#l2.113"></a><span id="l2.113" class="difflineplus">+return the correct string.  This has no effect whatsoever on the</span>
<a href="#l2.114"></a><span id="l2.114" class="difflineplus">+functioning of the bzip2 program or library.  Added a couple of casts</span>
<a href="#l2.115"></a><span id="l2.115" class="difflineplus">+so the library compiles without warnings at level 3 in MS Visual</span>
<a href="#l2.116"></a><span id="l2.116" class="difflineplus">+Studio 6.0.  Included a Y2K statement in the file Y2K_INFO.  All other</span>
<a href="#l2.117"></a><span id="l2.117" class="difflineplus">+changes are minor documentation changes.</span>
<a href="#l2.118"></a><span id="l2.118" class="difflineplus">+</span>
<a href="#l2.119"></a><span id="l2.119" class="difflineplus">+1.0</span>
<a href="#l2.120"></a><span id="l2.120" class="difflineplus">+~~~</span>
<a href="#l2.121"></a><span id="l2.121" class="difflineplus">+Several minor bugfixes and enhancements:</span>
<a href="#l2.122"></a><span id="l2.122" class="difflineplus">+</span>
<a href="#l2.123"></a><span id="l2.123" class="difflineplus">+* Large file support.  The library uses 64-bit counters to</span>
<a href="#l2.124"></a><span id="l2.124" class="difflineplus">+  count the volume of data passing through it.  bzip2.c </span>
<a href="#l2.125"></a><span id="l2.125" class="difflineplus">+  is now compiled with -D_FILE_OFFSET_BITS=64 to get large</span>
<a href="#l2.126"></a><span id="l2.126" class="difflineplus">+  file support from the C library.  -v correctly prints out</span>
<a href="#l2.127"></a><span id="l2.127" class="difflineplus">+  file sizes greater than 4 gigabytes.  All these changes have</span>
<a href="#l2.128"></a><span id="l2.128" class="difflineplus">+  been made without assuming a 64-bit platform or a C compiler</span>
<a href="#l2.129"></a><span id="l2.129" class="difflineplus">+  which supports 64-bit ints, so, except for the C library</span>
<a href="#l2.130"></a><span id="l2.130" class="difflineplus">+  aspect, they are fully portable.</span>
<a href="#l2.131"></a><span id="l2.131" class="difflineplus">+</span>
<a href="#l2.132"></a><span id="l2.132" class="difflineplus">+* Decompression robustness.  The library/program should be</span>
<a href="#l2.133"></a><span id="l2.133" class="difflineplus">+  robust to any corruption of compressed data, detecting and</span>
<a href="#l2.134"></a><span id="l2.134" class="difflineplus">+  handling _all_ corruption, instead of merely relying on</span>
<a href="#l2.135"></a><span id="l2.135" class="difflineplus">+  the CRCs.  What this means is that the program should </span>
<a href="#l2.136"></a><span id="l2.136" class="difflineplus">+  never crash, given corrupted data, and the library should</span>
<a href="#l2.137"></a><span id="l2.137" class="difflineplus">+  always return BZ_DATA_ERROR.</span>
<a href="#l2.138"></a><span id="l2.138" class="difflineplus">+</span>
<a href="#l2.139"></a><span id="l2.139" class="difflineplus">+* Fixed an obscure race-condition bug only ever observed on</span>
<a href="#l2.140"></a><span id="l2.140" class="difflineplus">+  Solaris, in which, if you were very unlucky and issued</span>
<a href="#l2.141"></a><span id="l2.141" class="difflineplus">+  control-C at exactly the wrong time, both input and output</span>
<a href="#l2.142"></a><span id="l2.142" class="difflineplus">+  files would be deleted.</span>
<a href="#l2.143"></a><span id="l2.143" class="difflineplus">+</span>
<a href="#l2.144"></a><span id="l2.144" class="difflineplus">+* Don't run out of file handles on test/decompression when</span>
<a href="#l2.145"></a><span id="l2.145" class="difflineplus">+  large numbers of files have invalid magic numbers.</span>
<a href="#l2.146"></a><span id="l2.146" class="difflineplus">+</span>
<a href="#l2.147"></a><span id="l2.147" class="difflineplus">+* Avoid library namespace pollution.  Prefix all exported </span>
<a href="#l2.148"></a><span id="l2.148" class="difflineplus">+  symbols with BZ2_.</span>
<a href="#l2.149"></a><span id="l2.149" class="difflineplus">+</span>
<a href="#l2.150"></a><span id="l2.150" class="difflineplus">+* Minor sorting enhancements from my DCC2000 paper.</span>
<a href="#l2.151"></a><span id="l2.151" class="difflineplus">+</span>
<a href="#l2.152"></a><span id="l2.152" class="difflineplus">+* Advance the version number to 1.0, so as to counteract the</span>
<a href="#l2.153"></a><span id="l2.153" class="difflineplus">+  (false-in-this-case) impression some people have that programs </span>
<a href="#l2.154"></a><span id="l2.154" class="difflineplus">+  with version numbers less than 1.0 are in some way, experimental,</span>
<a href="#l2.155"></a><span id="l2.155" class="difflineplus">+  pre-release versions.</span>
<a href="#l2.156"></a><span id="l2.156" class="difflineplus">+</span>
<a href="#l2.157"></a><span id="l2.157" class="difflineplus">+* Create an initial Makefile-libbz2_so to build a shared library.</span>
<a href="#l2.158"></a><span id="l2.158" class="difflineplus">+  Yes, I know I should really use libtool et al ...</span>
<a href="#l2.159"></a><span id="l2.159" class="difflineplus">+</span>
<a href="#l2.160"></a><span id="l2.160" class="difflineplus">+* Make the program exit with 2 instead of 0 when decompression</span>
<a href="#l2.161"></a><span id="l2.161" class="difflineplus">+  fails due to a bad magic number (ie, an invalid bzip2 header).</span>
<a href="#l2.162"></a><span id="l2.162" class="difflineplus">+  Also exit with 1 (as the manual claims :-) whenever a diagnostic</span>
<a href="#l2.163"></a><span id="l2.163" class="difflineplus">+  message would have been printed AND the corresponding operation </span>
<a href="#l2.164"></a><span id="l2.164" class="difflineplus">+  is aborted, for example</span>
<a href="#l2.165"></a><span id="l2.165" class="difflineplus">+     bzip2: Output file xx already exists.</span>
<a href="#l2.166"></a><span id="l2.166" class="difflineplus">+  When a diagnostic message is printed but the operation is not </span>
<a href="#l2.167"></a><span id="l2.167" class="difflineplus">+  aborted, for example</span>
<a href="#l2.168"></a><span id="l2.168" class="difflineplus">+     bzip2: Can't guess original name for wurble -- using wurble.out</span>
<a href="#l2.169"></a><span id="l2.169" class="difflineplus">+  then the exit value 0 is returned, unless some other problem is</span>
<a href="#l2.170"></a><span id="l2.170" class="difflineplus">+  also detected.</span>
<a href="#l2.171"></a><span id="l2.171" class="difflineplus">+</span>
<a href="#l2.172"></a><span id="l2.172" class="difflineplus">+  I think it corresponds more closely to what the manual claims now.</span>
<a href="#l2.173"></a><span id="l2.173" class="difflineplus">+</span>
<a href="#l2.174"></a><span id="l2.174" class="difflineplus">+</span>
<a href="#l2.175"></a><span id="l2.175" class="difflineplus">+1.0.1</span>
<a href="#l2.176"></a><span id="l2.176" class="difflineplus">+~~~~~</span>
<a href="#l2.177"></a><span id="l2.177" class="difflineplus">+* Modified dlltest.c so it uses the new BZ2_ naming scheme.</span>
<a href="#l2.178"></a><span id="l2.178" class="difflineplus">+* Modified makefile-msc to fix minor build probs on Win2k.</span>
<a href="#l2.179"></a><span id="l2.179" class="difflineplus">+* Updated README.COMPILATION.PROBLEMS.</span>
<a href="#l2.180"></a><span id="l2.180" class="difflineplus">+</span>
<a href="#l2.181"></a><span id="l2.181" class="difflineplus">+There are no functionality changes or bug fixes relative to version</span>
<a href="#l2.182"></a><span id="l2.182" class="difflineplus">+1.0.0.  This is just a documentation update + a fix for minor Win32</span>
<a href="#l2.183"></a><span id="l2.183" class="difflineplus">+build problems.  For almost everyone, upgrading from 1.0.0 to 1.0.1 is</span>
<a href="#l2.184"></a><span id="l2.184" class="difflineplus">+utterly pointless.  Don't bother.</span>
<a href="#l2.185"></a><span id="l2.185" class="difflineplus">+</span>
<a href="#l2.186"></a><span id="l2.186" class="difflineplus">+</span>
<a href="#l2.187"></a><span id="l2.187" class="difflineplus">+1.0.2</span>
<a href="#l2.188"></a><span id="l2.188" class="difflineplus">+~~~~~</span>
<a href="#l2.189"></a><span id="l2.189" class="difflineplus">+A bug fix release, addressing various minor issues which have appeared</span>
<a href="#l2.190"></a><span id="l2.190" class="difflineplus">+in the 18 or so months since 1.0.1 was released.  Most of the fixes</span>
<a href="#l2.191"></a><span id="l2.191" class="difflineplus">+are to do with file-handling or documentation bugs.  To the best of my</span>
<a href="#l2.192"></a><span id="l2.192" class="difflineplus">+knowledge, there have been no data-loss-causing bugs reported in the</span>
<a href="#l2.193"></a><span id="l2.193" class="difflineplus">+compression/decompression engine of 1.0.0 or 1.0.1.</span>
<a href="#l2.194"></a><span id="l2.194" class="difflineplus">+</span>
<a href="#l2.195"></a><span id="l2.195" class="difflineplus">+Note that this release does not improve the rather crude build system</span>
<a href="#l2.196"></a><span id="l2.196" class="difflineplus">+for Unix platforms.  The general plan here is to autoconfiscate/</span>
<a href="#l2.197"></a><span id="l2.197" class="difflineplus">+libtoolise 1.0.2 soon after release, and release the result as 1.1.0</span>
<a href="#l2.198"></a><span id="l2.198" class="difflineplus">+or perhaps 1.2.0.  That, however, is still just a plan at this point.</span>
<a href="#l2.199"></a><span id="l2.199" class="difflineplus">+</span>
<a href="#l2.200"></a><span id="l2.200" class="difflineplus">+Here are the changes in 1.0.2.  Bug-reporters and/or patch-senders in</span>
<a href="#l2.201"></a><span id="l2.201" class="difflineplus">+parentheses.</span>
<a href="#l2.202"></a><span id="l2.202" class="difflineplus">+</span>
<a href="#l2.203"></a><span id="l2.203" class="difflineplus">+* Fix an infinite segfault loop in 1.0.1 when a directory is</span>
<a href="#l2.204"></a><span id="l2.204" class="difflineplus">+  encountered in -f (force) mode.</span>
<a href="#l2.205"></a><span id="l2.205" class="difflineplus">+     (Trond Eivind Glomsrod, Nicholas Nethercote, Volker Schmidt)</span>
<a href="#l2.206"></a><span id="l2.206" class="difflineplus">+</span>
<a href="#l2.207"></a><span id="l2.207" class="difflineplus">+* Avoid double fclose() of output file on certain I/O error paths.</span>
<a href="#l2.208"></a><span id="l2.208" class="difflineplus">+     (Solar Designer)</span>
<a href="#l2.209"></a><span id="l2.209" class="difflineplus">+</span>
<a href="#l2.210"></a><span id="l2.210" class="difflineplus">+* Don't fail with internal error 1007 when fed a long stream (&gt; 48MB)</span>
<a href="#l2.211"></a><span id="l2.211" class="difflineplus">+  of byte 251.  Also print useful message suggesting that 1007s may be</span>
<a href="#l2.212"></a><span id="l2.212" class="difflineplus">+  caused by bad memory.</span>
<a href="#l2.213"></a><span id="l2.213" class="difflineplus">+     (noticed by Juan Pedro Vallejo, fixed by me)</span>
<a href="#l2.214"></a><span id="l2.214" class="difflineplus">+</span>
<a href="#l2.215"></a><span id="l2.215" class="difflineplus">+* Fix uninitialised variable silly bug in demo prog dlltest.c.</span>
<a href="#l2.216"></a><span id="l2.216" class="difflineplus">+     (Jorj Bauer)</span>
<a href="#l2.217"></a><span id="l2.217" class="difflineplus">+</span>
<a href="#l2.218"></a><span id="l2.218" class="difflineplus">+* Remove 512-MB limitation on recovered file size for bzip2recover</span>
<a href="#l2.219"></a><span id="l2.219" class="difflineplus">+  on selected platforms which support 64-bit ints.  At the moment</span>
<a href="#l2.220"></a><span id="l2.220" class="difflineplus">+  all GCC supported platforms, and Win32.</span>
<a href="#l2.221"></a><span id="l2.221" class="difflineplus">+     (me, Alson van der Meulen)</span>
<a href="#l2.222"></a><span id="l2.222" class="difflineplus">+</span>
<a href="#l2.223"></a><span id="l2.223" class="difflineplus">+* Hard-code header byte values, to give correct operation on platforms</span>
<a href="#l2.224"></a><span id="l2.224" class="difflineplus">+  using EBCDIC as their native character set (IBM's OS/390).</span>
<a href="#l2.225"></a><span id="l2.225" class="difflineplus">+     (Leland Lucius)</span>
<a href="#l2.226"></a><span id="l2.226" class="difflineplus">+</span>
<a href="#l2.227"></a><span id="l2.227" class="difflineplus">+* Copy file access times correctly.</span>
<a href="#l2.228"></a><span id="l2.228" class="difflineplus">+     (Marty Leisner)</span>
<a href="#l2.229"></a><span id="l2.229" class="difflineplus">+</span>
<a href="#l2.230"></a><span id="l2.230" class="difflineplus">+* Add distclean and check targets to Makefile.</span>
<a href="#l2.231"></a><span id="l2.231" class="difflineplus">+     (Michael Carmack)</span>
<a href="#l2.232"></a><span id="l2.232" class="difflineplus">+</span>
<a href="#l2.233"></a><span id="l2.233" class="difflineplus">+* Parameterise use of ar and ranlib in Makefile.  Also add $(LDFLAGS).</span>
<a href="#l2.234"></a><span id="l2.234" class="difflineplus">+     (Rich Ireland, Bo Thorsen)</span>
<a href="#l2.235"></a><span id="l2.235" class="difflineplus">+</span>
<a href="#l2.236"></a><span id="l2.236" class="difflineplus">+* Pass -p (create parent dirs as needed) to mkdir during make install.</span>
<a href="#l2.237"></a><span id="l2.237" class="difflineplus">+     (Jeremy Fusco)</span>
<a href="#l2.238"></a><span id="l2.238" class="difflineplus">+</span>
<a href="#l2.239"></a><span id="l2.239" class="difflineplus">+* Dereference symlinks when copying file permissions in -f mode.</span>
<a href="#l2.240"></a><span id="l2.240" class="difflineplus">+     (Volker Schmidt)</span>
<a href="#l2.241"></a><span id="l2.241" class="difflineplus">+</span>
<a href="#l2.242"></a><span id="l2.242" class="difflineplus">+* Majorly simplify implementation of uInt64_qrm10.</span>
<a href="#l2.243"></a><span id="l2.243" class="difflineplus">+     (Bo Lindbergh)</span>
<a href="#l2.244"></a><span id="l2.244" class="difflineplus">+</span>
<a href="#l2.245"></a><span id="l2.245" class="difflineplus">+* Check the input file still exists before deleting the output one,</span>
<a href="#l2.246"></a><span id="l2.246" class="difflineplus">+  when aborting in cleanUpAndFail().</span>
<a href="#l2.247"></a><span id="l2.247" class="difflineplus">+     (Joerg Prante, Robert Linden, Matthias Krings)</span>
<a href="#l2.248"></a><span id="l2.248" class="difflineplus">+</span>
<a href="#l2.249"></a><span id="l2.249" class="difflineplus">+Also a bunch of patches courtesy of Philippe Troin, the Debian maintainer</span>
<a href="#l2.250"></a><span id="l2.250" class="difflineplus">+of bzip2:</span>
<a href="#l2.251"></a><span id="l2.251" class="difflineplus">+</span>
<a href="#l2.252"></a><span id="l2.252" class="difflineplus">+* Wrapper scripts (with manpages): bzdiff, bzgrep, bzmore.</span>
<a href="#l2.253"></a><span id="l2.253" class="difflineplus">+</span>
<a href="#l2.254"></a><span id="l2.254" class="difflineplus">+* Spelling changes and minor enhancements in bzip2.1.</span>
<a href="#l2.255"></a><span id="l2.255" class="difflineplus">+</span>
<a href="#l2.256"></a><span id="l2.256" class="difflineplus">+* Avoid race condition between creating the output file and setting its</span>
<a href="#l2.257"></a><span id="l2.257" class="difflineplus">+  interim permissions safely, by using fopen_output_safely().</span>
<a href="#l2.258"></a><span id="l2.258" class="difflineplus">+  No changes to bzip2recover since there is no issue with file</span>
<a href="#l2.259"></a><span id="l2.259" class="difflineplus">+  permissions there.</span>
<a href="#l2.260"></a><span id="l2.260" class="difflineplus">+</span>
<a href="#l2.261"></a><span id="l2.261" class="difflineplus">+* do not print senseless report with -v when compressing an empty</span>
<a href="#l2.262"></a><span id="l2.262" class="difflineplus">+  file.</span>
<a href="#l2.263"></a><span id="l2.263" class="difflineplus">+</span>
<a href="#l2.264"></a><span id="l2.264" class="difflineplus">+* bzcat -f works on non-bzip2 files.</span>
<a href="#l2.265"></a><span id="l2.265" class="difflineplus">+</span>
<a href="#l2.266"></a><span id="l2.266" class="difflineplus">+* do not try to escape shell meta-characters on unix (the shell takes</span>
<a href="#l2.267"></a><span id="l2.267" class="difflineplus">+  care of these).</span>
<a href="#l2.268"></a><span id="l2.268" class="difflineplus">+</span>
<a href="#l2.269"></a><span id="l2.269" class="difflineplus">+* added --fast and --best aliases for -1 -9 for gzip compatibility.</span>
<a href="#l2.270"></a><span id="l2.270" class="difflineplus">+</span>
<a href="#l2.271"></a><span id="l2.271" class="difflineplus">+</span>
<a href="#l2.272"></a><span id="l2.272" class="difflineplus">+1.0.3 (15 Feb 05)</span>
<a href="#l2.273"></a><span id="l2.273" class="difflineplus">+~~~~~~~~~~~~~~~~~</span>
<a href="#l2.274"></a><span id="l2.274" class="difflineplus">+Fixes some minor bugs since the last version, 1.0.2.</span>
<a href="#l2.275"></a><span id="l2.275" class="difflineplus">+</span>
<a href="#l2.276"></a><span id="l2.276" class="difflineplus">+* Further robustification against corrupted compressed data.</span>
<a href="#l2.277"></a><span id="l2.277" class="difflineplus">+  There are currently no known bitstreams which can cause the</span>
<a href="#l2.278"></a><span id="l2.278" class="difflineplus">+  decompressor to crash, loop or access memory which does not</span>
<a href="#l2.279"></a><span id="l2.279" class="difflineplus">+  belong to it.  If you are using bzip2 or the library to </span>
<a href="#l2.280"></a><span id="l2.280" class="difflineplus">+  decompress bitstreams from untrusted sources, an upgrade</span>
<a href="#l2.281"></a><span id="l2.281" class="difflineplus">+  to 1.0.3 is recommended.  This fixes CAN-2005-1260.</span>
<a href="#l2.282"></a><span id="l2.282" class="difflineplus">+</span>
<a href="#l2.283"></a><span id="l2.283" class="difflineplus">+* The documentation has been converted to XML, from which html</span>
<a href="#l2.284"></a><span id="l2.284" class="difflineplus">+  and pdf can be derived.</span>
<a href="#l2.285"></a><span id="l2.285" class="difflineplus">+</span>
<a href="#l2.286"></a><span id="l2.286" class="difflineplus">+* Various minor bugs in the documentation have been fixed.</span>
<a href="#l2.287"></a><span id="l2.287" class="difflineplus">+</span>
<a href="#l2.288"></a><span id="l2.288" class="difflineplus">+* Fixes for various compilation warnings with newer versions of</span>
<a href="#l2.289"></a><span id="l2.289" class="difflineplus">+  gcc, and on 64-bit platforms.</span>
<a href="#l2.290"></a><span id="l2.290" class="difflineplus">+</span>
<a href="#l2.291"></a><span id="l2.291" class="difflineplus">+* The BZ_NO_STDIO cpp symbol was not properly observed in 1.0.2.</span>
<a href="#l2.292"></a><span id="l2.292" class="difflineplus">+  This has been fixed.</span>
<a href="#l2.293"></a><span id="l2.293" class="difflineplus">+</span>
<a href="#l2.294"></a><span id="l2.294" class="difflineplus">+</span>
<a href="#l2.295"></a><span id="l2.295" class="difflineplus">+1.0.4 (20 Dec 06)</span>
<a href="#l2.296"></a><span id="l2.296" class="difflineplus">+~~~~~~~~~~~~~~~~~</span>
<a href="#l2.297"></a><span id="l2.297" class="difflineplus">+Fixes some minor bugs since the last version, 1.0.3.</span>
<a href="#l2.298"></a><span id="l2.298" class="difflineplus">+</span>
<a href="#l2.299"></a><span id="l2.299" class="difflineplus">+* Fix file permissions race problem (CAN-2005-0953).</span>
<a href="#l2.300"></a><span id="l2.300" class="difflineplus">+</span>
<a href="#l2.301"></a><span id="l2.301" class="difflineplus">+* Avoid possible segfault in BZ2_bzclose.  From Coverity's NetBSD</span>
<a href="#l2.302"></a><span id="l2.302" class="difflineplus">+  scan.</span>
<a href="#l2.303"></a><span id="l2.303" class="difflineplus">+</span>
<a href="#l2.304"></a><span id="l2.304" class="difflineplus">+* 'const'/prototype cleanups in the C code.</span>
<a href="#l2.305"></a><span id="l2.305" class="difflineplus">+</span>
<a href="#l2.306"></a><span id="l2.306" class="difflineplus">+* Change default install location to /usr/local, and handle multiple</span>
<a href="#l2.307"></a><span id="l2.307" class="difflineplus">+  'make install's without error.</span>
<a href="#l2.308"></a><span id="l2.308" class="difflineplus">+</span>
<a href="#l2.309"></a><span id="l2.309" class="difflineplus">+* Sanitise file names more carefully in bzgrep.  Fixes CAN-2005-0758</span>
<a href="#l2.310"></a><span id="l2.310" class="difflineplus">+  to the extent that applies to bzgrep.</span>
<a href="#l2.311"></a><span id="l2.311" class="difflineplus">+</span>
<a href="#l2.312"></a><span id="l2.312" class="difflineplus">+* Use 'mktemp' rather than 'tempfile' in bzdiff.</span>
<a href="#l2.313"></a><span id="l2.313" class="difflineplus">+</span>
<a href="#l2.314"></a><span id="l2.314" class="difflineplus">+* Tighten up a couple of assertions in blocksort.c following automated</span>
<a href="#l2.315"></a><span id="l2.315" class="difflineplus">+  analysis.</span>
<a href="#l2.316"></a><span id="l2.316" class="difflineplus">+</span>
<a href="#l2.317"></a><span id="l2.317" class="difflineplus">+* Fix minor doc/comment bugs.</span>
<a href="#l2.318"></a><span id="l2.318" class="difflineplus">+</span>
<a href="#l2.319"></a><span id="l2.319" class="difflineplus">+</span>
<a href="#l2.320"></a><span id="l2.320" class="difflineplus">+1.0.5 (10 Dec 07)</span>
<a href="#l2.321"></a><span id="l2.321" class="difflineplus">+~~~~~~~~~~~~~~~~~</span>
<a href="#l2.322"></a><span id="l2.322" class="difflineplus">+Security fix only.  Fixes CERT-FI 20469 as it applies to bzip2.</span>
<a href="#l2.323"></a><span id="l2.323" class="difflineplus">+</span>
<a href="#l2.324"></a><span id="l2.324" class="difflineplus">+</span>
<a href="#l2.325"></a><span id="l2.325" class="difflineplus">+1.0.6 (6 Sept 10)</span>
<a href="#l2.326"></a><span id="l2.326" class="difflineplus">+~~~~~~~~~~~~~~~~~</span>
<a href="#l2.327"></a><span id="l2.327" class="difflineplus">+</span>
<a href="#l2.328"></a><span id="l2.328" class="difflineplus">+* Security fix for CVE-2010-0405.  This was reported by Mikolaj</span>
<a href="#l2.329"></a><span id="l2.329" class="difflineplus">+  Izdebski.</span>
<a href="#l2.330"></a><span id="l2.330" class="difflineplus">+</span>
<a href="#l2.331"></a><span id="l2.331" class="difflineplus">+* Make the documentation build on Ubuntu 10.04</span>
<a href="#l2.332"></a><span id="l2.332" class="difflineplus">+</span>
<a href="#l2.333"></a><span id="l2.333" class="difflineplus">+1.0.7 (27 Jun 19)</span>
<a href="#l2.334"></a><span id="l2.334" class="difflineplus">+~~~~~~~~~~~~~~~~~</span>
<a href="#l2.335"></a><span id="l2.335" class="difflineplus">+</span>
<a href="#l2.336"></a><span id="l2.336" class="difflineplus">+* Fix undefined behavior in the macros SET_BH, CLEAR_BH, &amp; ISSET_BH</span>
<a href="#l2.337"></a><span id="l2.337" class="difflineplus">+</span>
<a href="#l2.338"></a><span id="l2.338" class="difflineplus">+* bzip2: Fix return value when combining --test,-t and -q.</span>
<a href="#l2.339"></a><span id="l2.339" class="difflineplus">+</span>
<a href="#l2.340"></a><span id="l2.340" class="difflineplus">+* bzip2recover: Fix buffer overflow for large argv[0]</span>
<a href="#l2.341"></a><span id="l2.341" class="difflineplus">+</span>
<a href="#l2.342"></a><span id="l2.342" class="difflineplus">+* bzip2recover: Fix use after free issue with outFile (CVE-2016-3189)</span>
<a href="#l2.343"></a><span id="l2.343" class="difflineplus">+</span>
<a href="#l2.344"></a><span id="l2.344" class="difflineplus">+* Make sure nSelectors is not out of range (CVE-2019-12900)</span>
<a href="#l2.345"></a><span id="l2.345" class="difflineplus">+</span>
<a href="#l2.346"></a><span id="l2.346" class="difflineplus">+1.0.8 (13 Jul 19)</span>
<a href="#l2.347"></a><span id="l2.347" class="difflineplus">+~~~~~~~~~~~~~~~~~</span>
<a href="#l2.348"></a><span id="l2.348" class="difflineplus">+</span>
<a href="#l2.349"></a><span id="l2.349" class="difflineplus">+* Accept as many selectors as the file format allows.</span>
<a href="#l2.350"></a><span id="l2.350" class="difflineplus">+  This relaxes the fix for CVE-2019-12900 from 1.0.7</span>
<a href="#l2.351"></a><span id="l2.351" class="difflineplus">+  so that bzip2 allows decompression of bz2 files that</span>
<a href="#l2.352"></a><span id="l2.352" class="difflineplus">+  use (too) many selectors again.</span>
<a href="#l2.353"></a><span id="l2.353" class="difflineplus">+</span>
<a href="#l2.354"></a><span id="l2.354" class="difflineplus">+* Fix handling of large (&gt; 4GB) files on Windows.</span>
<a href="#l2.355"></a><span id="l2.355" class="difflineplus">+</span>
<a href="#l2.356"></a><span id="l2.356" class="difflineplus">+* Cleanup of bzdiff and bzgrep scripts so they don't use</span>
<a href="#l2.357"></a><span id="l2.357" class="difflineplus">+  any bash extensions and handle multiple archives correctly.</span>
<a href="#l2.358"></a><span id="l2.358" class="difflineplus">+</span>
<a href="#l2.359"></a><span id="l2.359" class="difflineplus">+* There is now a bz2-files testsuite at</span>
<a href="#l2.360"></a><span id="l2.360" class="difflineplus">+  https://sourceware.org/git/bzip2-tests.git</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1">new file mode 100644</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineminus">--- /dev/null</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineplus">+++ b/third_party/bzip2/Changelog.mzla</span>
<a href="#l3.4"></a><span id="l3.4" class="difflineat">@@ -0,0 +1,7 @@</span>
<a href="#l3.5"></a><span id="l3.5" class="difflineplus">+MZLA Technologies Changelog for bzip2</span>
<a href="#l3.6"></a><span id="l3.6" class="difflineplus">+</span>
<a href="#l3.7"></a><span id="l3.7" class="difflineplus">+- 2020-Apr-15</span>
<a href="#l3.8"></a><span id="l3.8" class="difflineplus">+  Based on 1.0.8 release.</span>
<a href="#l3.9"></a><span id="l3.9" class="difflineplus">+  Removed unneeded files.</span>
<a href="#l3.10"></a><span id="l3.10" class="difflineplus">+  bug #1621782</span>
<a href="#l3.11"></a><span id="l3.11" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1">new file mode 100644</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineminus">--- /dev/null</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineplus">+++ b/third_party/bzip2/LICENSE</span>
<a href="#l4.4"></a><span id="l4.4" class="difflineat">@@ -0,0 +1,42 @@</span>
<a href="#l4.5"></a><span id="l4.5" class="difflineplus">+</span>
<a href="#l4.6"></a><span id="l4.6" class="difflineplus">+--------------------------------------------------------------------------</span>
<a href="#l4.7"></a><span id="l4.7" class="difflineplus">+</span>
<a href="#l4.8"></a><span id="l4.8" class="difflineplus">+This program, &quot;bzip2&quot;, the associated library &quot;libbzip2&quot;, and all</span>
<a href="#l4.9"></a><span id="l4.9" class="difflineplus">+documentation, are copyright (C) 1996-2019 Julian R Seward.  All</span>
<a href="#l4.10"></a><span id="l4.10" class="difflineplus">+rights reserved.</span>
<a href="#l4.11"></a><span id="l4.11" class="difflineplus">+</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+Redistribution and use in source and binary forms, with or without</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+modification, are permitted provided that the following conditions</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+are met:</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+1. Redistributions of source code must retain the above copyright</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+   notice, this list of conditions and the following disclaimer.</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+2. The origin of this software must not be misrepresented; you must </span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+   not claim that you wrote the original software.  If you use this </span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+   software in a product, an acknowledgment in the product </span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+   documentation would be appreciated but is not required.</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineplus">+</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineplus">+3. Altered source versions must be plainly marked as such, and must</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineplus">+   not be misrepresented as being the original software.</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineplus">+</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineplus">+4. The name of the author may not be used to endorse or promote </span>
<a href="#l4.28"></a><span id="l4.28" class="difflineplus">+   products derived from this software without specific prior written </span>
<a href="#l4.29"></a><span id="l4.29" class="difflineplus">+   permission.</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineplus">+</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineplus">+THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineplus">+INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineplus">+NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineplus">+SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineplus">+Julian Seward, jseward@acm.org</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineplus">+bzip2/libbzip2 version 1.0.8 of 13 July 2019</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineplus">+</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineplus">+--------------------------------------------------------------------------</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1">new file mode 100644</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineminus">--- /dev/null</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineplus">+++ b/third_party/bzip2/README</span>
<a href="#l5.4"></a><span id="l5.4" class="difflineat">@@ -0,0 +1,196 @@</span>
<a href="#l5.5"></a><span id="l5.5" class="difflineplus">+</span>
<a href="#l5.6"></a><span id="l5.6" class="difflineplus">+This is the README for bzip2/libzip2.</span>
<a href="#l5.7"></a><span id="l5.7" class="difflineplus">+This version is fully compatible with the previous public releases.</span>
<a href="#l5.8"></a><span id="l5.8" class="difflineplus">+</span>
<a href="#l5.9"></a><span id="l5.9" class="difflineplus">+------------------------------------------------------------------</span>
<a href="#l5.10"></a><span id="l5.10" class="difflineplus">+This file is part of bzip2/libbzip2, a program and library for</span>
<a href="#l5.11"></a><span id="l5.11" class="difflineplus">+lossless, block-sorting data compression.</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+bzip2/libbzip2 version 1.0.8 of 13 July 2019</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+Copyright (C) 1996-2019 Julian Seward &lt;jseward@acm.org&gt;</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+Please read the WARNING, DISCLAIMER and PATENTS sections in this file.</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineplus">+This program is released under the terms of the license contained</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineplus">+in the file LICENSE.</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineplus">+------------------------------------------------------------------</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineplus">+</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineplus">+Complete documentation is available in Postscript form (manual.ps),</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineplus">+PDF (manual.pdf) or html (manual.html).  A plain-text version of the</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineplus">+manual page is available as bzip2.txt.</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineplus">+</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineplus">+</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineplus">+HOW TO BUILD -- UNIX</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineplus">+</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineplus">+Type 'make'.  This builds the library libbz2.a and then the programs</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineplus">+bzip2 and bzip2recover.  Six self-tests are run.  If the self-tests</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineplus">+complete ok, carry on to installation:</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineplus">+To install in /usr/local/bin, /usr/local/lib, /usr/local/man and</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineplus">+/usr/local/include, type</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineplus">+</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineplus">+   make install</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineplus">+</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineplus">+To install somewhere else, eg, /xxx/yyy/{bin,lib,man,include}, type</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineplus">+</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineplus">+   make install PREFIX=/xxx/yyy</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineplus">+</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineplus">+If you are (justifiably) paranoid and want to see what 'make install'</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineplus">+is going to do, you can first do</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineplus">+</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineplus">+   make -n install                      or</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineplus">+   make -n install PREFIX=/xxx/yyy      respectively.</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineplus">+</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineplus">+The -n instructs make to show the commands it would execute, but not</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineplus">+actually execute them.</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineplus">+</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineplus">+</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineplus">+HOW TO BUILD -- UNIX, shared library libbz2.so.</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineplus">+</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineplus">+Do 'make -f Makefile-libbz2_so'.  This Makefile seems to work for</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineplus">+Linux-ELF (RedHat 7.2 on an x86 box), with gcc.  I make no claims</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineplus">+that it works for any other platform, though I suspect it probably</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineplus">+will work for most platforms employing both ELF and gcc.</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineplus">+</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineplus">+bzip2-shared, a client of the shared library, is also built, but not</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineplus">+self-tested.  So I suggest you also build using the normal Makefile,</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineplus">+since that conducts a self-test.  A second reason to prefer the</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineplus">+version statically linked to the library is that, on x86 platforms,</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineplus">+building shared objects makes a valuable register (%ebx) unavailable</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineplus">+to gcc, resulting in a slowdown of 10%-20%, at least for bzip2.</span>
<a href="#l5.65"></a><span id="l5.65" class="difflineplus">+</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineplus">+Important note for people upgrading .so's from 0.9.0/0.9.5 to version</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineplus">+1.0.X.  All the functions in the library have been renamed, from (eg)</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineplus">+bzCompress to BZ2_bzCompress, to avoid namespace pollution.</span>
<a href="#l5.69"></a><span id="l5.69" class="difflineplus">+Unfortunately this means that the libbz2.so created by</span>
<a href="#l5.70"></a><span id="l5.70" class="difflineplus">+Makefile-libbz2_so will not work with any program which used an older</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineplus">+version of the library.  I do encourage library clients to make the</span>
<a href="#l5.72"></a><span id="l5.72" class="difflineplus">+effort to upgrade to use version 1.0, since it is both faster and more</span>
<a href="#l5.73"></a><span id="l5.73" class="difflineplus">+robust than previous versions.</span>
<a href="#l5.74"></a><span id="l5.74" class="difflineplus">+</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineplus">+</span>
<a href="#l5.76"></a><span id="l5.76" class="difflineplus">+HOW TO BUILD -- Windows 95, NT, DOS, Mac, etc.</span>
<a href="#l5.77"></a><span id="l5.77" class="difflineplus">+</span>
<a href="#l5.78"></a><span id="l5.78" class="difflineplus">+It's difficult for me to support compilation on all these platforms.</span>
<a href="#l5.79"></a><span id="l5.79" class="difflineplus">+My approach is to collect binaries for these platforms, and put them</span>
<a href="#l5.80"></a><span id="l5.80" class="difflineplus">+on the master web site (https://sourceware.org/bzip2/).  Look there.  However</span>
<a href="#l5.81"></a><span id="l5.81" class="difflineplus">+(FWIW), bzip2-1.0.X is very standard ANSI C and should compile</span>
<a href="#l5.82"></a><span id="l5.82" class="difflineplus">+unmodified with MS Visual C.  If you have difficulties building, you</span>
<a href="#l5.83"></a><span id="l5.83" class="difflineplus">+might want to read README.COMPILATION.PROBLEMS.</span>
<a href="#l5.84"></a><span id="l5.84" class="difflineplus">+</span>
<a href="#l5.85"></a><span id="l5.85" class="difflineplus">+At least using MS Visual C++ 6, you can build from the unmodified</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineplus">+sources by issuing, in a command shell: </span>
<a href="#l5.87"></a><span id="l5.87" class="difflineplus">+</span>
<a href="#l5.88"></a><span id="l5.88" class="difflineplus">+   nmake -f makefile.msc</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineplus">+</span>
<a href="#l5.90"></a><span id="l5.90" class="difflineplus">+(you may need to first run the MSVC-provided script VCVARS32.BAT</span>
<a href="#l5.91"></a><span id="l5.91" class="difflineplus">+ so as to set up paths to the MSVC tools correctly).</span>
<a href="#l5.92"></a><span id="l5.92" class="difflineplus">+</span>
<a href="#l5.93"></a><span id="l5.93" class="difflineplus">+</span>
<a href="#l5.94"></a><span id="l5.94" class="difflineplus">+VALIDATION</span>
<a href="#l5.95"></a><span id="l5.95" class="difflineplus">+</span>
<a href="#l5.96"></a><span id="l5.96" class="difflineplus">+Correct operation, in the sense that a compressed file can always be</span>
<a href="#l5.97"></a><span id="l5.97" class="difflineplus">+decompressed to reproduce the original, is obviously of paramount</span>
<a href="#l5.98"></a><span id="l5.98" class="difflineplus">+importance.  To validate bzip2, I used a modified version of Mark</span>
<a href="#l5.99"></a><span id="l5.99" class="difflineplus">+Nelson's churn program.  Churn is an automated test driver which</span>
<a href="#l5.100"></a><span id="l5.100" class="difflineplus">+recursively traverses a directory structure, using bzip2 to compress</span>
<a href="#l5.101"></a><span id="l5.101" class="difflineplus">+and then decompress each file it encounters, and checking that the</span>
<a href="#l5.102"></a><span id="l5.102" class="difflineplus">+decompressed data is the same as the original.</span>
<a href="#l5.103"></a><span id="l5.103" class="difflineplus">+</span>
<a href="#l5.104"></a><span id="l5.104" class="difflineplus">+</span>
<a href="#l5.105"></a><span id="l5.105" class="difflineplus">+</span>
<a href="#l5.106"></a><span id="l5.106" class="difflineplus">+Please read and be aware of the following:</span>
<a href="#l5.107"></a><span id="l5.107" class="difflineplus">+</span>
<a href="#l5.108"></a><span id="l5.108" class="difflineplus">+WARNING:</span>
<a href="#l5.109"></a><span id="l5.109" class="difflineplus">+</span>
<a href="#l5.110"></a><span id="l5.110" class="difflineplus">+   This program and library (attempts to) compress data by </span>
<a href="#l5.111"></a><span id="l5.111" class="difflineplus">+   performing several non-trivial transformations on it.  </span>
<a href="#l5.112"></a><span id="l5.112" class="difflineplus">+   Unless you are 100% familiar with *all* the algorithms </span>
<a href="#l5.113"></a><span id="l5.113" class="difflineplus">+   contained herein, and with the consequences of modifying them, </span>
<a href="#l5.114"></a><span id="l5.114" class="difflineplus">+   you should NOT meddle with the compression or decompression </span>
<a href="#l5.115"></a><span id="l5.115" class="difflineplus">+   machinery.  Incorrect changes can and very likely *will* </span>
<a href="#l5.116"></a><span id="l5.116" class="difflineplus">+   lead to disastrous loss of data.</span>
<a href="#l5.117"></a><span id="l5.117" class="difflineplus">+</span>
<a href="#l5.118"></a><span id="l5.118" class="difflineplus">+</span>
<a href="#l5.119"></a><span id="l5.119" class="difflineplus">+DISCLAIMER:</span>
<a href="#l5.120"></a><span id="l5.120" class="difflineplus">+</span>
<a href="#l5.121"></a><span id="l5.121" class="difflineplus">+   I TAKE NO RESPONSIBILITY FOR ANY LOSS OF DATA ARISING FROM THE</span>
<a href="#l5.122"></a><span id="l5.122" class="difflineplus">+   USE OF THIS PROGRAM/LIBRARY, HOWSOEVER CAUSED.</span>
<a href="#l5.123"></a><span id="l5.123" class="difflineplus">+</span>
<a href="#l5.124"></a><span id="l5.124" class="difflineplus">+   Every compression of a file implies an assumption that the</span>
<a href="#l5.125"></a><span id="l5.125" class="difflineplus">+   compressed file can be decompressed to reproduce the original.</span>
<a href="#l5.126"></a><span id="l5.126" class="difflineplus">+   Great efforts in design, coding and testing have been made to</span>
<a href="#l5.127"></a><span id="l5.127" class="difflineplus">+   ensure that this program works correctly.  However, the complexity</span>
<a href="#l5.128"></a><span id="l5.128" class="difflineplus">+   of the algorithms, and, in particular, the presence of various</span>
<a href="#l5.129"></a><span id="l5.129" class="difflineplus">+   special cases in the code which occur with very low but non-zero</span>
<a href="#l5.130"></a><span id="l5.130" class="difflineplus">+   probability make it impossible to rule out the possibility of bugs</span>
<a href="#l5.131"></a><span id="l5.131" class="difflineplus">+   remaining in the program.  DO NOT COMPRESS ANY DATA WITH THIS</span>
<a href="#l5.132"></a><span id="l5.132" class="difflineplus">+   PROGRAM UNLESS YOU ARE PREPARED TO ACCEPT THE POSSIBILITY, HOWEVER</span>
<a href="#l5.133"></a><span id="l5.133" class="difflineplus">+   SMALL, THAT THE DATA WILL NOT BE RECOVERABLE.</span>
<a href="#l5.134"></a><span id="l5.134" class="difflineplus">+</span>
<a href="#l5.135"></a><span id="l5.135" class="difflineplus">+   That is not to say this program is inherently unreliable.  </span>
<a href="#l5.136"></a><span id="l5.136" class="difflineplus">+   Indeed, I very much hope the opposite is true.  bzip2/libbzip2 </span>
<a href="#l5.137"></a><span id="l5.137" class="difflineplus">+   has been carefully constructed and extensively tested.</span>
<a href="#l5.138"></a><span id="l5.138" class="difflineplus">+</span>
<a href="#l5.139"></a><span id="l5.139" class="difflineplus">+</span>
<a href="#l5.140"></a><span id="l5.140" class="difflineplus">+PATENTS:</span>
<a href="#l5.141"></a><span id="l5.141" class="difflineplus">+</span>
<a href="#l5.142"></a><span id="l5.142" class="difflineplus">+   To the best of my knowledge, bzip2/libbzip2 does not use any </span>
<a href="#l5.143"></a><span id="l5.143" class="difflineplus">+   patented algorithms.  However, I do not have the resources </span>
<a href="#l5.144"></a><span id="l5.144" class="difflineplus">+   to carry out a patent search.  Therefore I cannot give any </span>
<a href="#l5.145"></a><span id="l5.145" class="difflineplus">+   guarantee of the above statement.</span>
<a href="#l5.146"></a><span id="l5.146" class="difflineplus">+</span>
<a href="#l5.147"></a><span id="l5.147" class="difflineplus">+</span>
<a href="#l5.148"></a><span id="l5.148" class="difflineplus">+</span>
<a href="#l5.149"></a><span id="l5.149" class="difflineplus">+WHAT'S NEW IN 0.9.0 (as compared to 0.1pl2) ?</span>
<a href="#l5.150"></a><span id="l5.150" class="difflineplus">+</span>
<a href="#l5.151"></a><span id="l5.151" class="difflineplus">+   * Approx 10% faster compression, 30% faster decompression</span>
<a href="#l5.152"></a><span id="l5.152" class="difflineplus">+   * -t (test mode) is a lot quicker</span>
<a href="#l5.153"></a><span id="l5.153" class="difflineplus">+   * Can decompress concatenated compressed files</span>
<a href="#l5.154"></a><span id="l5.154" class="difflineplus">+   * Programming interface, so programs can directly read/write .bz2 files</span>
<a href="#l5.155"></a><span id="l5.155" class="difflineplus">+   * Less restrictive (BSD-style) licensing</span>
<a href="#l5.156"></a><span id="l5.156" class="difflineplus">+   * Flag handling more compatible with GNU gzip</span>
<a href="#l5.157"></a><span id="l5.157" class="difflineplus">+   * Much more documentation, i.e., a proper user manual</span>
<a href="#l5.158"></a><span id="l5.158" class="difflineplus">+   * Hopefully, improved portability (at least of the library)</span>
<a href="#l5.159"></a><span id="l5.159" class="difflineplus">+</span>
<a href="#l5.160"></a><span id="l5.160" class="difflineplus">+WHAT'S NEW IN 0.9.5 ?</span>
<a href="#l5.161"></a><span id="l5.161" class="difflineplus">+</span>
<a href="#l5.162"></a><span id="l5.162" class="difflineplus">+   * Compression speed is much less sensitive to the input</span>
<a href="#l5.163"></a><span id="l5.163" class="difflineplus">+     data than in previous versions.  Specifically, the very</span>
<a href="#l5.164"></a><span id="l5.164" class="difflineplus">+     slow performance caused by repetitive data is fixed.</span>
<a href="#l5.165"></a><span id="l5.165" class="difflineplus">+   * Many small improvements in file and flag handling.</span>
<a href="#l5.166"></a><span id="l5.166" class="difflineplus">+   * A Y2K statement.</span>
<a href="#l5.167"></a><span id="l5.167" class="difflineplus">+</span>
<a href="#l5.168"></a><span id="l5.168" class="difflineplus">+WHAT'S NEW IN 1.0.x ?</span>
<a href="#l5.169"></a><span id="l5.169" class="difflineplus">+</span>
<a href="#l5.170"></a><span id="l5.170" class="difflineplus">+   See the CHANGES file.</span>
<a href="#l5.171"></a><span id="l5.171" class="difflineplus">+</span>
<a href="#l5.172"></a><span id="l5.172" class="difflineplus">+I hope you find bzip2 useful.  Feel free to contact the developers at</span>
<a href="#l5.173"></a><span id="l5.173" class="difflineplus">+   bzip2-devel@sourceware.org</span>
<a href="#l5.174"></a><span id="l5.174" class="difflineplus">+if you have any suggestions or queries.  Many people mailed me with</span>
<a href="#l5.175"></a><span id="l5.175" class="difflineplus">+comments, suggestions and patches after the releases of bzip-0.15,</span>
<a href="#l5.176"></a><span id="l5.176" class="difflineplus">+bzip-0.21, and bzip2 versions 0.1pl2, 0.9.0, 0.9.5, 1.0.0, 1.0.1,</span>
<a href="#l5.177"></a><span id="l5.177" class="difflineplus">+1.0.2 and 1.0.3, and the changes in bzip2 are largely a result of this</span>
<a href="#l5.178"></a><span id="l5.178" class="difflineplus">+feedback.  I thank you for your comments.</span>
<a href="#l5.179"></a><span id="l5.179" class="difflineplus">+</span>
<a href="#l5.180"></a><span id="l5.180" class="difflineplus">+bzip2's &quot;home&quot; is https://sourceware.org/bzip2/</span>
<a href="#l5.181"></a><span id="l5.181" class="difflineplus">+</span>
<a href="#l5.182"></a><span id="l5.182" class="difflineplus">+Julian Seward</span>
<a href="#l5.183"></a><span id="l5.183" class="difflineplus">+jseward@acm.org</span>
<a href="#l5.184"></a><span id="l5.184" class="difflineplus">+Cambridge, UK.</span>
<a href="#l5.185"></a><span id="l5.185" class="difflineplus">+</span>
<a href="#l5.186"></a><span id="l5.186" class="difflineplus">+18     July 1996 (version 0.15)</span>
<a href="#l5.187"></a><span id="l5.187" class="difflineplus">+25   August 1996 (version 0.21)</span>
<a href="#l5.188"></a><span id="l5.188" class="difflineplus">+ 7   August 1997 (bzip2, version 0.1)</span>
<a href="#l5.189"></a><span id="l5.189" class="difflineplus">+29   August 1997 (bzip2, version 0.1pl2)</span>
<a href="#l5.190"></a><span id="l5.190" class="difflineplus">+23   August 1998 (bzip2, version 0.9.0)</span>
<a href="#l5.191"></a><span id="l5.191" class="difflineplus">+ 8     June 1999 (bzip2, version 0.9.5)</span>
<a href="#l5.192"></a><span id="l5.192" class="difflineplus">+ 4     Sept 1999 (bzip2, version 0.9.5d)</span>
<a href="#l5.193"></a><span id="l5.193" class="difflineplus">+ 5      May 2000 (bzip2, version 1.0pre8)</span>
<a href="#l5.194"></a><span id="l5.194" class="difflineplus">+30 December 2001 (bzip2, version 1.0.2pre1)</span>
<a href="#l5.195"></a><span id="l5.195" class="difflineplus">+15 February 2005 (bzip2, version 1.0.3)</span>
<a href="#l5.196"></a><span id="l5.196" class="difflineplus">+20 December 2006 (bzip2, version 1.0.4)</span>
<a href="#l5.197"></a><span id="l5.197" class="difflineplus">+10 December 2007 (bzip2, version 1.0.5)</span>
<a href="#l5.198"></a><span id="l5.198" class="difflineplus">+ 6     Sept 2010 (bzip2, version 1.0.6)</span>
<a href="#l5.199"></a><span id="l5.199" class="difflineplus">+27     June 2019 (bzip2, version 1.0.7)</span>
<a href="#l5.200"></a><span id="l5.200" class="difflineplus">+13     July 2019 (bzip2, version 1.0.8)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1">new file mode 100644</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineminus">--- /dev/null</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineplus">+++ b/third_party/bzip2/README.COMPILATION.PROBLEMS</span>
<a href="#l6.4"></a><span id="l6.4" class="difflineat">@@ -0,0 +1,58 @@</span>
<a href="#l6.5"></a><span id="l6.5" class="difflineplus">+------------------------------------------------------------------</span>
<a href="#l6.6"></a><span id="l6.6" class="difflineplus">+This file is part of bzip2/libbzip2, a program and library for</span>
<a href="#l6.7"></a><span id="l6.7" class="difflineplus">+lossless, block-sorting data compression.</span>
<a href="#l6.8"></a><span id="l6.8" class="difflineplus">+</span>
<a href="#l6.9"></a><span id="l6.9" class="difflineplus">+bzip2/libbzip2 version 1.0.8 of 13 July 2019</span>
<a href="#l6.10"></a><span id="l6.10" class="difflineplus">+Copyright (C) 1996-2019 Julian Seward &lt;jseward@acm.org&gt;</span>
<a href="#l6.11"></a><span id="l6.11" class="difflineplus">+</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+Please read the WARNING, DISCLAIMER and PATENTS sections in the </span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+README file.</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+This program is released under the terms of the license contained</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+in the file LICENSE.</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineplus">+------------------------------------------------------------------</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineplus">+</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineplus">+bzip2 should compile without problems on the vast majority of</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineplus">+platforms.  Using the supplied Makefile, I've built and tested it</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineplus">+myself for x86-linux and amd64-linux.  With makefile.msc, Visual C++</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+6.0 and nmake, you can build a native Win32 version too.  Large file</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineplus">+support seems to work correctly on at least on amd64-linux.</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineplus">+</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineplus">+When I say &quot;large file&quot; I mean a file of size 2,147,483,648 (2^31)</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineplus">+bytes or above.  Many older OSs can't handle files above this size,</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineplus">+but many newer ones can.  Large files are pretty huge -- most files</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineplus">+you'll encounter are not Large Files.</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineplus">+</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineplus">+Early versions of bzip2 (0.1, 0.9.0, 0.9.5) compiled on a wide variety</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineplus">+of platforms without difficulty, and I hope this version will continue</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+in that tradition.  However, in order to support large files, I've had</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineplus">+to include the define -D_FILE_OFFSET_BITS=64 in the Makefile.  This</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineplus">+can cause problems.</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineplus">+</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineplus">+The technique of adding -D_FILE_OFFSET_BITS=64 to get large file</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineplus">+support is, as far as I know, the Recommended Way to get correct large</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineplus">+file support.  For more details, see the Large File Support</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineplus">+Specification, published by the Large File Summit, at</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineplus">+</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineplus">+   http://ftp.sas.com/standards/large.file</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineplus">+</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineplus">+As a general comment, if you get compilation errors which you think</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineplus">+are related to large file support, try removing the above define from</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineplus">+the Makefile, ie, delete the line</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineplus">+</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineplus">+   BIGFILES=-D_FILE_OFFSET_BITS=64 </span>
<a href="#l6.48"></a><span id="l6.48" class="difflineplus">+</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineplus">+from the Makefile, and do 'make clean ; make'.  This will give you a</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineplus">+version of bzip2 without large file support, which, for most</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineplus">+applications, is probably not a problem.  </span>
<a href="#l6.52"></a><span id="l6.52" class="difflineplus">+</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineplus">+Alternatively, try some of the platform-specific hints listed below.</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineplus">+</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineplus">+You can use the spewG.c program to generate huge files to test bzip2's</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineplus">+large file support, if you are feeling paranoid.  Be aware though that</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineplus">+any compilation problems which affect bzip2 will also affect spewG.c,</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineplus">+alas.</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineplus">+</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineplus">+AIX: I have reports that for large file support, you need to specify</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineplus">+-D_LARGE_FILES rather than -D_FILE_OFFSET_BITS=64.  I have not tested</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineplus">+this myself.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1">new file mode 100644</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineminus">--- /dev/null</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineplus">+++ b/third_party/bzip2/README.XML.STUFF</span>
<a href="#l7.4"></a><span id="l7.4" class="difflineat">@@ -0,0 +1,45 @@</span>
<a href="#l7.5"></a><span id="l7.5" class="difflineplus">+  ----------------------------------------------------------------</span>
<a href="#l7.6"></a><span id="l7.6" class="difflineplus">+  This file is part of bzip2/libbzip2, a program and library for</span>
<a href="#l7.7"></a><span id="l7.7" class="difflineplus">+  lossless, block-sorting data compression.</span>
<a href="#l7.8"></a><span id="l7.8" class="difflineplus">+</span>
<a href="#l7.9"></a><span id="l7.9" class="difflineplus">+  bzip2/libbzip2 version 1.0.8 of 13 July 2019</span>
<a href="#l7.10"></a><span id="l7.10" class="difflineplus">+  Copyright (C) 1996-2019 Julian Seward &lt;jseward@acm.org&gt;</span>
<a href="#l7.11"></a><span id="l7.11" class="difflineplus">+</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+  Please read the WARNING, DISCLAIMER and PATENTS sections in the </span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+  README file.</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+  This program is released under the terms of the license contained</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+  in the file LICENSE.</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+  ----------------------------------------------------------------</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineplus">+</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+The script xmlproc.sh takes an xml file as input,</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineplus">+and processes it to create .pdf, .html or .ps output.</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineplus">+It uses format.pl, a perl script to format &lt;pre&gt; blocks nicely,</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineplus">+ and add CDATA tags so writers do not have to use eg. &amp;lt; </span>
<a href="#l7.23"></a><span id="l7.23" class="difflineplus">+</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineplus">+The file &quot;entities.xml&quot; must be edited to reflect current</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineplus">+version, year, etc.</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineplus">+</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineplus">+</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineplus">+Usage:</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineplus">+</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineplus">+  ./xmlproc.sh -v manual.xml</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineplus">+  Validates an xml file to ensure no dtd-compliance errors</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineplus">+  ./xmlproc.sh -html manual.xml</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineplus">+  Output: manual.html</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineplus">+</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+  ./xmlproc.sh -pdf manual.xml</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineplus">+  Output: manual.pdf</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineplus">+</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineplus">+  ./xmlproc.sh -ps manual.xml</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineplus">+  Output: manual.ps</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineplus">+</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineplus">+</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineplus">+Notum bene: </span>
<a href="#l7.44"></a><span id="l7.44" class="difflineplus">+- pdfxmltex barfs if given a filename with an underscore in it</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineplus">+</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineplus">+- xmltex won't work yet - there's a bug in passivetex</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineplus">+    which we are all waiting for Sebastian to fix.</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineplus">+  So we are going the xml -&gt; pdf -&gt; ps route for the time being,</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineplus">+    using pdfxmltex.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1">new file mode 100644</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineminus">--- /dev/null</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineplus">+++ b/third_party/bzip2/blocksort.c</span>
<a href="#l8.4"></a><span id="l8.4" class="difflineat">@@ -0,0 +1,1094 @@</span>
<a href="#l8.5"></a><span id="l8.5" class="difflineplus">+</span>
<a href="#l8.6"></a><span id="l8.6" class="difflineplus">+/*-------------------------------------------------------------*/</span>
<a href="#l8.7"></a><span id="l8.7" class="difflineplus">+/*--- Block sorting machinery                               ---*/</span>
<a href="#l8.8"></a><span id="l8.8" class="difflineplus">+/*---                                           blocksort.c ---*/</span>
<a href="#l8.9"></a><span id="l8.9" class="difflineplus">+/*-------------------------------------------------------------*/</span>
<a href="#l8.10"></a><span id="l8.10" class="difflineplus">+</span>
<a href="#l8.11"></a><span id="l8.11" class="difflineplus">+/* ------------------------------------------------------------------</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+   This file is part of bzip2/libbzip2, a program and library for</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+   lossless, block-sorting data compression.</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+   bzip2/libbzip2 version 1.0.8 of 13 July 2019</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+   Copyright (C) 1996-2019 Julian Seward &lt;jseward@acm.org&gt;</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineplus">+   Please read the WARNING, DISCLAIMER and PATENTS sections in the </span>
<a href="#l8.19"></a><span id="l8.19" class="difflineplus">+   README file.</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineplus">+</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineplus">+   This program is released under the terms of the license contained</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineplus">+   in the file LICENSE.</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineplus">+   ------------------------------------------------------------------ */</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineplus">+</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineplus">+</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineplus">+#include &quot;bzlib_private.h&quot;</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineplus">+</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineplus">+/*---------------------------------------------*/</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineplus">+/*--- Fallback O(N log(N)^2) sorting        ---*/</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineplus">+/*--- algorithm, for repetitive blocks      ---*/</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineplus">+/*---------------------------------------------*/</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineplus">+/*---------------------------------------------*/</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineplus">+static </span>
<a href="#l8.35"></a><span id="l8.35" class="difflineplus">+__inline__</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineplus">+void fallbackSimpleSort ( UInt32* fmap, </span>
<a href="#l8.37"></a><span id="l8.37" class="difflineplus">+                          UInt32* eclass, </span>
<a href="#l8.38"></a><span id="l8.38" class="difflineplus">+                          Int32   lo, </span>
<a href="#l8.39"></a><span id="l8.39" class="difflineplus">+                          Int32   hi )</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineplus">+{</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineplus">+   Int32 i, j, tmp;</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineplus">+   UInt32 ec_tmp;</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineplus">+</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineplus">+   if (lo == hi) return;</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineplus">+</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineplus">+   if (hi - lo &gt; 3) {</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineplus">+      for ( i = hi-4; i &gt;= lo; i-- ) {</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineplus">+         tmp = fmap[i];</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineplus">+         ec_tmp = eclass[tmp];</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineplus">+         for ( j = i+4; j &lt;= hi &amp;&amp; ec_tmp &gt; eclass[fmap[j]]; j += 4 )</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineplus">+            fmap[j-4] = fmap[j];</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineplus">+         fmap[j-4] = tmp;</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineplus">+      }</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineplus">+   }</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineplus">+</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineplus">+   for ( i = hi-1; i &gt;= lo; i-- ) {</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineplus">+      tmp = fmap[i];</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineplus">+      ec_tmp = eclass[tmp];</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineplus">+      for ( j = i+1; j &lt;= hi &amp;&amp; ec_tmp &gt; eclass[fmap[j]]; j++ )</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineplus">+         fmap[j-1] = fmap[j];</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineplus">+      fmap[j-1] = tmp;</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineplus">+   }</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineplus">+}</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineplus">+</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineplus">+</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineplus">+/*---------------------------------------------*/</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineplus">+#define fswap(zz1, zz2) \</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineplus">+   { Int32 zztmp = zz1; zz1 = zz2; zz2 = zztmp; }</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineplus">+</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineplus">+#define fvswap(zzp1, zzp2, zzn)       \</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineplus">+{                                     \</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineplus">+   Int32 yyp1 = (zzp1);               \</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineplus">+   Int32 yyp2 = (zzp2);               \</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineplus">+   Int32 yyn  = (zzn);                \</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineplus">+   while (yyn &gt; 0) {                  \</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineplus">+      fswap(fmap[yyp1], fmap[yyp2]);  \</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineplus">+      yyp1++; yyp2++; yyn--;          \</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineplus">+   }                                  \</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineplus">+}</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineplus">+</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineplus">+</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineplus">+#define fmin(a,b) ((a) &lt; (b)) ? (a) : (b)</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineplus">+</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineplus">+#define fpush(lz,hz) { stackLo[sp] = lz; \</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineplus">+                       stackHi[sp] = hz; \</span>
<a href="#l8.86"></a><span id="l8.86" class="difflineplus">+                       sp++; }</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineplus">+</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineplus">+#define fpop(lz,hz) { sp--;              \</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineplus">+                      lz = stackLo[sp];  \</span>
<a href="#l8.90"></a><span id="l8.90" class="difflineplus">+                      hz = stackHi[sp]; }</span>
<a href="#l8.91"></a><span id="l8.91" class="difflineplus">+</span>
<a href="#l8.92"></a><span id="l8.92" class="difflineplus">+#define FALLBACK_QSORT_SMALL_THRESH 10</span>
<a href="#l8.93"></a><span id="l8.93" class="difflineplus">+#define FALLBACK_QSORT_STACK_SIZE   100</span>
<a href="#l8.94"></a><span id="l8.94" class="difflineplus">+</span>
<a href="#l8.95"></a><span id="l8.95" class="difflineplus">+</span>
<a href="#l8.96"></a><span id="l8.96" class="difflineplus">+static</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineplus">+void fallbackQSort3 ( UInt32* fmap, </span>
<a href="#l8.98"></a><span id="l8.98" class="difflineplus">+                      UInt32* eclass,</span>
<a href="#l8.99"></a><span id="l8.99" class="difflineplus">+                      Int32   loSt, </span>
<a href="#l8.100"></a><span id="l8.100" class="difflineplus">+                      Int32   hiSt )</span>
<a href="#l8.101"></a><span id="l8.101" class="difflineplus">+{</span>
<a href="#l8.102"></a><span id="l8.102" class="difflineplus">+   Int32 unLo, unHi, ltLo, gtHi, n, m;</span>
<a href="#l8.103"></a><span id="l8.103" class="difflineplus">+   Int32 sp, lo, hi;</span>
<a href="#l8.104"></a><span id="l8.104" class="difflineplus">+   UInt32 med, r, r3;</span>
<a href="#l8.105"></a><span id="l8.105" class="difflineplus">+   Int32 stackLo[FALLBACK_QSORT_STACK_SIZE];</span>
<a href="#l8.106"></a><span id="l8.106" class="difflineplus">+   Int32 stackHi[FALLBACK_QSORT_STACK_SIZE];</span>
<a href="#l8.107"></a><span id="l8.107" class="difflineplus">+</span>
<a href="#l8.108"></a><span id="l8.108" class="difflineplus">+   r = 0;</span>
<a href="#l8.109"></a><span id="l8.109" class="difflineplus">+</span>
<a href="#l8.110"></a><span id="l8.110" class="difflineplus">+   sp = 0;</span>
<a href="#l8.111"></a><span id="l8.111" class="difflineplus">+   fpush ( loSt, hiSt );</span>
<a href="#l8.112"></a><span id="l8.112" class="difflineplus">+</span>
<a href="#l8.113"></a><span id="l8.113" class="difflineplus">+   while (sp &gt; 0) {</span>
<a href="#l8.114"></a><span id="l8.114" class="difflineplus">+</span>
<a href="#l8.115"></a><span id="l8.115" class="difflineplus">+      AssertH ( sp &lt; FALLBACK_QSORT_STACK_SIZE - 1, 1004 );</span>
<a href="#l8.116"></a><span id="l8.116" class="difflineplus">+</span>
<a href="#l8.117"></a><span id="l8.117" class="difflineplus">+      fpop ( lo, hi );</span>
<a href="#l8.118"></a><span id="l8.118" class="difflineplus">+      if (hi - lo &lt; FALLBACK_QSORT_SMALL_THRESH) {</span>
<a href="#l8.119"></a><span id="l8.119" class="difflineplus">+         fallbackSimpleSort ( fmap, eclass, lo, hi );</span>
<a href="#l8.120"></a><span id="l8.120" class="difflineplus">+         continue;</span>
<a href="#l8.121"></a><span id="l8.121" class="difflineplus">+      }</span>
<a href="#l8.122"></a><span id="l8.122" class="difflineplus">+</span>
<a href="#l8.123"></a><span id="l8.123" class="difflineplus">+      /* Random partitioning.  Median of 3 sometimes fails to</span>
<a href="#l8.124"></a><span id="l8.124" class="difflineplus">+         avoid bad cases.  Median of 9 seems to help but </span>
<a href="#l8.125"></a><span id="l8.125" class="difflineplus">+         looks rather expensive.  This too seems to work but</span>
<a href="#l8.126"></a><span id="l8.126" class="difflineplus">+         is cheaper.  Guidance for the magic constants </span>
<a href="#l8.127"></a><span id="l8.127" class="difflineplus">+         7621 and 32768 is taken from Sedgewick's algorithms</span>
<a href="#l8.128"></a><span id="l8.128" class="difflineplus">+         book, chapter 35.</span>
<a href="#l8.129"></a><span id="l8.129" class="difflineplus">+      */</span>
<a href="#l8.130"></a><span id="l8.130" class="difflineplus">+      r = ((r * 7621) + 1) % 32768;</span>
<a href="#l8.131"></a><span id="l8.131" class="difflineplus">+      r3 = r % 3;</span>
<a href="#l8.132"></a><span id="l8.132" class="difflineplus">+      if (r3 == 0) med = eclass[fmap[lo]]; else</span>
<a href="#l8.133"></a><span id="l8.133" class="difflineplus">+      if (r3 == 1) med = eclass[fmap[(lo+hi)&gt;&gt;1]]; else</span>
<a href="#l8.134"></a><span id="l8.134" class="difflineplus">+                   med = eclass[fmap[hi]];</span>
<a href="#l8.135"></a><span id="l8.135" class="difflineplus">+</span>
<a href="#l8.136"></a><span id="l8.136" class="difflineplus">+      unLo = ltLo = lo;</span>
<a href="#l8.137"></a><span id="l8.137" class="difflineplus">+      unHi = gtHi = hi;</span>
<a href="#l8.138"></a><span id="l8.138" class="difflineplus">+</span>
<a href="#l8.139"></a><span id="l8.139" class="difflineplus">+      while (1) {</span>
<a href="#l8.140"></a><span id="l8.140" class="difflineplus">+         while (1) {</span>
<a href="#l8.141"></a><span id="l8.141" class="difflineplus">+            if (unLo &gt; unHi) break;</span>
<a href="#l8.142"></a><span id="l8.142" class="difflineplus">+            n = (Int32)eclass[fmap[unLo]] - (Int32)med;</span>
<a href="#l8.143"></a><span id="l8.143" class="difflineplus">+            if (n == 0) { </span>
<a href="#l8.144"></a><span id="l8.144" class="difflineplus">+               fswap(fmap[unLo], fmap[ltLo]); </span>
<a href="#l8.145"></a><span id="l8.145" class="difflineplus">+               ltLo++; unLo++; </span>
<a href="#l8.146"></a><span id="l8.146" class="difflineplus">+               continue; </span>
<a href="#l8.147"></a><span id="l8.147" class="difflineplus">+            };</span>
<a href="#l8.148"></a><span id="l8.148" class="difflineplus">+            if (n &gt; 0) break;</span>
<a href="#l8.149"></a><span id="l8.149" class="difflineplus">+            unLo++;</span>
<a href="#l8.150"></a><span id="l8.150" class="difflineplus">+         }</span>
<a href="#l8.151"></a><span id="l8.151" class="difflineplus">+         while (1) {</span>
<a href="#l8.152"></a><span id="l8.152" class="difflineplus">+            if (unLo &gt; unHi) break;</span>
<a href="#l8.153"></a><span id="l8.153" class="difflineplus">+            n = (Int32)eclass[fmap[unHi]] - (Int32)med;</span>
<a href="#l8.154"></a><span id="l8.154" class="difflineplus">+            if (n == 0) { </span>
<a href="#l8.155"></a><span id="l8.155" class="difflineplus">+               fswap(fmap[unHi], fmap[gtHi]); </span>
<a href="#l8.156"></a><span id="l8.156" class="difflineplus">+               gtHi--; unHi--; </span>
<a href="#l8.157"></a><span id="l8.157" class="difflineplus">+               continue; </span>
<a href="#l8.158"></a><span id="l8.158" class="difflineplus">+            };</span>
<a href="#l8.159"></a><span id="l8.159" class="difflineplus">+            if (n &lt; 0) break;</span>
<a href="#l8.160"></a><span id="l8.160" class="difflineplus">+            unHi--;</span>
<a href="#l8.161"></a><span id="l8.161" class="difflineplus">+         }</span>
<a href="#l8.162"></a><span id="l8.162" class="difflineplus">+         if (unLo &gt; unHi) break;</span>
<a href="#l8.163"></a><span id="l8.163" class="difflineplus">+         fswap(fmap[unLo], fmap[unHi]); unLo++; unHi--;</span>
<a href="#l8.164"></a><span id="l8.164" class="difflineplus">+      }</span>
<a href="#l8.165"></a><span id="l8.165" class="difflineplus">+</span>
<a href="#l8.166"></a><span id="l8.166" class="difflineplus">+      AssertD ( unHi == unLo-1, &quot;fallbackQSort3(2)&quot; );</span>
<a href="#l8.167"></a><span id="l8.167" class="difflineplus">+</span>
<a href="#l8.168"></a><span id="l8.168" class="difflineplus">+      if (gtHi &lt; ltLo) continue;</span>
<a href="#l8.169"></a><span id="l8.169" class="difflineplus">+</span>
<a href="#l8.170"></a><span id="l8.170" class="difflineplus">+      n = fmin(ltLo-lo, unLo-ltLo); fvswap(lo, unLo-n, n);</span>
<a href="#l8.171"></a><span id="l8.171" class="difflineplus">+      m = fmin(hi-gtHi, gtHi-unHi); fvswap(unLo, hi-m+1, m);</span>
<a href="#l8.172"></a><span id="l8.172" class="difflineplus">+</span>
<a href="#l8.173"></a><span id="l8.173" class="difflineplus">+      n = lo + unLo - ltLo - 1;</span>
<a href="#l8.174"></a><span id="l8.174" class="difflineplus">+      m = hi - (gtHi - unHi) + 1;</span>
<a href="#l8.175"></a><span id="l8.175" class="difflineplus">+</span>
<a href="#l8.176"></a><span id="l8.176" class="difflineplus">+      if (n - lo &gt; hi - m) {</span>
<a href="#l8.177"></a><span id="l8.177" class="difflineplus">+         fpush ( lo, n );</span>
<a href="#l8.178"></a><span id="l8.178" class="difflineplus">+         fpush ( m, hi );</span>
<a href="#l8.179"></a><span id="l8.179" class="difflineplus">+      } else {</span>
<a href="#l8.180"></a><span id="l8.180" class="difflineplus">+         fpush ( m, hi );</span>
<a href="#l8.181"></a><span id="l8.181" class="difflineplus">+         fpush ( lo, n );</span>
<a href="#l8.182"></a><span id="l8.182" class="difflineplus">+      }</span>
<a href="#l8.183"></a><span id="l8.183" class="difflineplus">+   }</span>
<a href="#l8.184"></a><span id="l8.184" class="difflineplus">+}</span>
<a href="#l8.185"></a><span id="l8.185" class="difflineplus">+</span>
<a href="#l8.186"></a><span id="l8.186" class="difflineplus">+#undef fmin</span>
<a href="#l8.187"></a><span id="l8.187" class="difflineplus">+#undef fpush</span>
<a href="#l8.188"></a><span id="l8.188" class="difflineplus">+#undef fpop</span>
<a href="#l8.189"></a><span id="l8.189" class="difflineplus">+#undef fswap</span>
<a href="#l8.190"></a><span id="l8.190" class="difflineplus">+#undef fvswap</span>
<a href="#l8.191"></a><span id="l8.191" class="difflineplus">+#undef FALLBACK_QSORT_SMALL_THRESH</span>
<a href="#l8.192"></a><span id="l8.192" class="difflineplus">+#undef FALLBACK_QSORT_STACK_SIZE</span>
<a href="#l8.193"></a><span id="l8.193" class="difflineplus">+</span>
<a href="#l8.194"></a><span id="l8.194" class="difflineplus">+</span>
<a href="#l8.195"></a><span id="l8.195" class="difflineplus">+/*---------------------------------------------*/</span>
<a href="#l8.196"></a><span id="l8.196" class="difflineplus">+/* Pre:</span>
<a href="#l8.197"></a><span id="l8.197" class="difflineplus">+      nblock &gt; 0</span>
<a href="#l8.198"></a><span id="l8.198" class="difflineplus">+      eclass exists for [0 .. nblock-1]</span>
<a href="#l8.199"></a><span id="l8.199" class="difflineplus">+      ((UChar*)eclass) [0 .. nblock-1] holds block</span>
<a href="#l8.200"></a><span id="l8.200" class="difflineplus">+      ptr exists for [0 .. nblock-1]</span>
<a href="#l8.201"></a><span id="l8.201" class="difflineplus">+</span>
<a href="#l8.202"></a><span id="l8.202" class="difflineplus">+   Post:</span>
<a href="#l8.203"></a><span id="l8.203" class="difflineplus">+      ((UChar*)eclass) [0 .. nblock-1] holds block</span>
<a href="#l8.204"></a><span id="l8.204" class="difflineplus">+      All other areas of eclass destroyed</span>
<a href="#l8.205"></a><span id="l8.205" class="difflineplus">+      fmap [0 .. nblock-1] holds sorted order</span>
<a href="#l8.206"></a><span id="l8.206" class="difflineplus">+      bhtab [ 0 .. 2+(nblock/32) ] destroyed</span>
<a href="#l8.207"></a><span id="l8.207" class="difflineplus">+*/</span>
<a href="#l8.208"></a><span id="l8.208" class="difflineplus">+</span>
<a href="#l8.209"></a><span id="l8.209" class="difflineplus">+#define       SET_BH(zz)  bhtab[(zz) &gt;&gt; 5] |= ((UInt32)1 &lt;&lt; ((zz) &amp; 31))</span>
<a href="#l8.210"></a><span id="l8.210" class="difflineplus">+#define     CLEAR_BH(zz)  bhtab[(zz) &gt;&gt; 5] &amp;= ~((UInt32)1 &lt;&lt; ((zz) &amp; 31))</span>
<a href="#l8.211"></a><span id="l8.211" class="difflineplus">+#define     ISSET_BH(zz)  (bhtab[(zz) &gt;&gt; 5] &amp; ((UInt32)1 &lt;&lt; ((zz) &amp; 31)))</span>
<a href="#l8.212"></a><span id="l8.212" class="difflineplus">+#define      WORD_BH(zz)  bhtab[(zz) &gt;&gt; 5]</span>
<a href="#l8.213"></a><span id="l8.213" class="difflineplus">+#define UNALIGNED_BH(zz)  ((zz) &amp; 0x01f)</span>
<a href="#l8.214"></a><span id="l8.214" class="difflineplus">+</span>
<a href="#l8.215"></a><span id="l8.215" class="difflineplus">+static</span>
<a href="#l8.216"></a><span id="l8.216" class="difflineplus">+void fallbackSort ( UInt32* fmap, </span>
<a href="#l8.217"></a><span id="l8.217" class="difflineplus">+                    UInt32* eclass, </span>
<a href="#l8.218"></a><span id="l8.218" class="difflineplus">+                    UInt32* bhtab,</span>
<a href="#l8.219"></a><span id="l8.219" class="difflineplus">+                    Int32   nblock,</span>
<a href="#l8.220"></a><span id="l8.220" class="difflineplus">+                    Int32   verb )</span>
<a href="#l8.221"></a><span id="l8.221" class="difflineplus">+{</span>
<a href="#l8.222"></a><span id="l8.222" class="difflineplus">+   Int32 ftab[257];</span>
<a href="#l8.223"></a><span id="l8.223" class="difflineplus">+   Int32 ftabCopy[256];</span>
<a href="#l8.224"></a><span id="l8.224" class="difflineplus">+   Int32 H, i, j, k, l, r, cc, cc1;</span>
<a href="#l8.225"></a><span id="l8.225" class="difflineplus">+   Int32 nNotDone;</span>
<a href="#l8.226"></a><span id="l8.226" class="difflineplus">+   Int32 nBhtab;</span>
<a href="#l8.227"></a><span id="l8.227" class="difflineplus">+   UChar* eclass8 = (UChar*)eclass;</span>
<a href="#l8.228"></a><span id="l8.228" class="difflineplus">+</span>
<a href="#l8.229"></a><span id="l8.229" class="difflineplus">+   /*--</span>
<a href="#l8.230"></a><span id="l8.230" class="difflineplus">+      Initial 1-char radix sort to generate</span>
<a href="#l8.231"></a><span id="l8.231" class="difflineplus">+      initial fmap and initial BH bits.</span>
<a href="#l8.232"></a><span id="l8.232" class="difflineplus">+   --*/</span>
<a href="#l8.233"></a><span id="l8.233" class="difflineplus">+   if (verb &gt;= 4)</span>
<a href="#l8.234"></a><span id="l8.234" class="difflineplus">+      VPrintf0 ( &quot;        bucket sorting ...\n&quot; );</span>
<a href="#l8.235"></a><span id="l8.235" class="difflineplus">+   for (i = 0; i &lt; 257;    i++) ftab[i] = 0;</span>
<a href="#l8.236"></a><span id="l8.236" class="difflineplus">+   for (i = 0; i &lt; nblock; i++) ftab[eclass8[i]]++;</span>
<a href="#l8.237"></a><span id="l8.237" class="difflineplus">+   for (i = 0; i &lt; 256;    i++) ftabCopy[i] = ftab[i];</span>
<a href="#l8.238"></a><span id="l8.238" class="difflineplus">+   for (i = 1; i &lt; 257;    i++) ftab[i] += ftab[i-1];</span>
<a href="#l8.239"></a><span id="l8.239" class="difflineplus">+</span>
<a href="#l8.240"></a><span id="l8.240" class="difflineplus">+   for (i = 0; i &lt; nblock; i++) {</span>
<a href="#l8.241"></a><span id="l8.241" class="difflineplus">+      j = eclass8[i];</span>
<a href="#l8.242"></a><span id="l8.242" class="difflineplus">+      k = ftab[j] - 1;</span>
<a href="#l8.243"></a><span id="l8.243" class="difflineplus">+      ftab[j] = k;</span>
<a href="#l8.244"></a><span id="l8.244" class="difflineplus">+      fmap[k] = i;</span>
<a href="#l8.245"></a><span id="l8.245" class="difflineplus">+   }</span>
<a href="#l8.246"></a><span id="l8.246" class="difflineplus">+</span>
<a href="#l8.247"></a><span id="l8.247" class="difflineplus">+   nBhtab = 2 + (nblock / 32);</span>
<a href="#l8.248"></a><span id="l8.248" class="difflineplus">+   for (i = 0; i &lt; nBhtab; i++) bhtab[i] = 0;</span>
<a href="#l8.249"></a><span id="l8.249" class="difflineplus">+   for (i = 0; i &lt; 256; i++) SET_BH(ftab[i]);</span>
<a href="#l8.250"></a><span id="l8.250" class="difflineplus">+</span>
<a href="#l8.251"></a><span id="l8.251" class="difflineplus">+   /*--</span>
<a href="#l8.252"></a><span id="l8.252" class="difflineplus">+      Inductively refine the buckets.  Kind-of an</span>
<a href="#l8.253"></a><span id="l8.253" class="difflineplus">+      &quot;exponential radix sort&quot; (!), inspired by the</span>
<a href="#l8.254"></a><span id="l8.254" class="difflineplus">+      Manber-Myers suffix array construction algorithm.</span>
<a href="#l8.255"></a><span id="l8.255" class="difflineplus">+   --*/</span>
<a href="#l8.256"></a><span id="l8.256" class="difflineplus">+</span>
<a href="#l8.257"></a><span id="l8.257" class="difflineplus">+   /*-- set sentinel bits for block-end detection --*/</span>
<a href="#l8.258"></a><span id="l8.258" class="difflineplus">+   for (i = 0; i &lt; 32; i++) { </span>
<a href="#l8.259"></a><span id="l8.259" class="difflineplus">+      SET_BH(nblock + 2*i);</span>
<a href="#l8.260"></a><span id="l8.260" class="difflineplus">+      CLEAR_BH(nblock + 2*i + 1);</span>
<a href="#l8.261"></a><span id="l8.261" class="difflineplus">+   }</span>
<a href="#l8.262"></a><span id="l8.262" class="difflineplus">+</span>
<a href="#l8.263"></a><span id="l8.263" class="difflineplus">+   /*-- the log(N) loop --*/</span>
<a href="#l8.264"></a><span id="l8.264" class="difflineplus">+   H = 1;</span>
<a href="#l8.265"></a><span id="l8.265" class="difflineplus">+   while (1) {</span>
<a href="#l8.266"></a><span id="l8.266" class="difflineplus">+</span>
<a href="#l8.267"></a><span id="l8.267" class="difflineplus">+      if (verb &gt;= 4) </span>
<a href="#l8.268"></a><span id="l8.268" class="difflineplus">+         VPrintf1 ( &quot;        depth %6d has &quot;, H );</span>
<a href="#l8.269"></a><span id="l8.269" class="difflineplus">+</span>
<a href="#l8.270"></a><span id="l8.270" class="difflineplus">+      j = 0;</span>
<a href="#l8.271"></a><span id="l8.271" class="difflineplus">+      for (i = 0; i &lt; nblock; i++) {</span>
<a href="#l8.272"></a><span id="l8.272" class="difflineplus">+         if (ISSET_BH(i)) j = i;</span>
<a href="#l8.273"></a><span id="l8.273" class="difflineplus">+         k = fmap[i] - H; if (k &lt; 0) k += nblock;</span>
<a href="#l8.274"></a><span id="l8.274" class="difflineplus">+         eclass[k] = j;</span>
<a href="#l8.275"></a><span id="l8.275" class="difflineplus">+      }</span>
<a href="#l8.276"></a><span id="l8.276" class="difflineplus">+</span>
<a href="#l8.277"></a><span id="l8.277" class="difflineplus">+      nNotDone = 0;</span>
<a href="#l8.278"></a><span id="l8.278" class="difflineplus">+      r = -1;</span>
<a href="#l8.279"></a><span id="l8.279" class="difflineplus">+      while (1) {</span>
<a href="#l8.280"></a><span id="l8.280" class="difflineplus">+</span>
<a href="#l8.281"></a><span id="l8.281" class="difflineplus">+	 /*-- find the next non-singleton bucket --*/</span>
<a href="#l8.282"></a><span id="l8.282" class="difflineplus">+         k = r + 1;</span>
<a href="#l8.283"></a><span id="l8.283" class="difflineplus">+         while (ISSET_BH(k) &amp;&amp; UNALIGNED_BH(k)) k++;</span>
<a href="#l8.284"></a><span id="l8.284" class="difflineplus">+         if (ISSET_BH(k)) {</span>
<a href="#l8.285"></a><span id="l8.285" class="difflineplus">+            while (WORD_BH(k) == 0xffffffff) k += 32;</span>
<a href="#l8.286"></a><span id="l8.286" class="difflineplus">+            while (ISSET_BH(k)) k++;</span>
<a href="#l8.287"></a><span id="l8.287" class="difflineplus">+         }</span>
<a href="#l8.288"></a><span id="l8.288" class="difflineplus">+         l = k - 1;</span>
<a href="#l8.289"></a><span id="l8.289" class="difflineplus">+         if (l &gt;= nblock) break;</span>
<a href="#l8.290"></a><span id="l8.290" class="difflineplus">+         while (!ISSET_BH(k) &amp;&amp; UNALIGNED_BH(k)) k++;</span>
<a href="#l8.291"></a><span id="l8.291" class="difflineplus">+         if (!ISSET_BH(k)) {</span>
<a href="#l8.292"></a><span id="l8.292" class="difflineplus">+            while (WORD_BH(k) == 0x00000000) k += 32;</span>
<a href="#l8.293"></a><span id="l8.293" class="difflineplus">+            while (!ISSET_BH(k)) k++;</span>
<a href="#l8.294"></a><span id="l8.294" class="difflineplus">+         }</span>
<a href="#l8.295"></a><span id="l8.295" class="difflineplus">+         r = k - 1;</span>
<a href="#l8.296"></a><span id="l8.296" class="difflineplus">+         if (r &gt;= nblock) break;</span>
<a href="#l8.297"></a><span id="l8.297" class="difflineplus">+</span>
<a href="#l8.298"></a><span id="l8.298" class="difflineplus">+         /*-- now [l, r] bracket current bucket --*/</span>
<a href="#l8.299"></a><span id="l8.299" class="difflineplus">+         if (r &gt; l) {</span>
<a href="#l8.300"></a><span id="l8.300" class="difflineplus">+            nNotDone += (r - l + 1);</span>
<a href="#l8.301"></a><span id="l8.301" class="difflineplus">+            fallbackQSort3 ( fmap, eclass, l, r );</span>
<a href="#l8.302"></a><span id="l8.302" class="difflineplus">+</span>
<a href="#l8.303"></a><span id="l8.303" class="difflineplus">+            /*-- scan bucket and generate header bits-- */</span>
<a href="#l8.304"></a><span id="l8.304" class="difflineplus">+            cc = -1;</span>
<a href="#l8.305"></a><span id="l8.305" class="difflineplus">+            for (i = l; i &lt;= r; i++) {</span>
<a href="#l8.306"></a><span id="l8.306" class="difflineplus">+               cc1 = eclass[fmap[i]];</span>
<a href="#l8.307"></a><span id="l8.307" class="difflineplus">+               if (cc != cc1) { SET_BH(i); cc = cc1; };</span>
<a href="#l8.308"></a><span id="l8.308" class="difflineplus">+            }</span>
<a href="#l8.309"></a><span id="l8.309" class="difflineplus">+         }</span>
<a href="#l8.310"></a><span id="l8.310" class="difflineplus">+      }</span>
<a href="#l8.311"></a><span id="l8.311" class="difflineplus">+</span>
<a href="#l8.312"></a><span id="l8.312" class="difflineplus">+      if (verb &gt;= 4) </span>
<a href="#l8.313"></a><span id="l8.313" class="difflineplus">+         VPrintf1 ( &quot;%6d unresolved strings\n&quot;, nNotDone );</span>
<a href="#l8.314"></a><span id="l8.314" class="difflineplus">+</span>
<a href="#l8.315"></a><span id="l8.315" class="difflineplus">+      H *= 2;</span>
<a href="#l8.316"></a><span id="l8.316" class="difflineplus">+      if (H &gt; nblock || nNotDone == 0) break;</span>
<a href="#l8.317"></a><span id="l8.317" class="difflineplus">+   }</span>
<a href="#l8.318"></a><span id="l8.318" class="difflineplus">+</span>
<a href="#l8.319"></a><span id="l8.319" class="difflineplus">+   /*-- </span>
<a href="#l8.320"></a><span id="l8.320" class="difflineplus">+      Reconstruct the original block in</span>
<a href="#l8.321"></a><span id="l8.321" class="difflineplus">+      eclass8 [0 .. nblock-1], since the</span>
<a href="#l8.322"></a><span id="l8.322" class="difflineplus">+      previous phase destroyed it.</span>
<a href="#l8.323"></a><span id="l8.323" class="difflineplus">+   --*/</span>
<a href="#l8.324"></a><span id="l8.324" class="difflineplus">+   if (verb &gt;= 4)</span>
<a href="#l8.325"></a><span id="l8.325" class="difflineplus">+      VPrintf0 ( &quot;        reconstructing block ...\n&quot; );</span>
<a href="#l8.326"></a><span id="l8.326" class="difflineplus">+   j = 0;</span>
<a href="#l8.327"></a><span id="l8.327" class="difflineplus">+   for (i = 0; i &lt; nblock; i++) {</span>
<a href="#l8.328"></a><span id="l8.328" class="difflineplus">+      while (ftabCopy[j] == 0) j++;</span>
<a href="#l8.329"></a><span id="l8.329" class="difflineplus">+      ftabCopy[j]--;</span>
<a href="#l8.330"></a><span id="l8.330" class="difflineplus">+      eclass8[fmap[i]] = (UChar)j;</span>
<a href="#l8.331"></a><span id="l8.331" class="difflineplus">+   }</span>
<a href="#l8.332"></a><span id="l8.332" class="difflineplus">+   AssertH ( j &lt; 256, 1005 );</span>
<a href="#l8.333"></a><span id="l8.333" class="difflineplus">+}</span>
<a href="#l8.334"></a><span id="l8.334" class="difflineplus">+</span>
<a href="#l8.335"></a><span id="l8.335" class="difflineplus">+#undef       SET_BH</span>
<a href="#l8.336"></a><span id="l8.336" class="difflineplus">+#undef     CLEAR_BH</span>
<a href="#l8.337"></a><span id="l8.337" class="difflineplus">+#undef     ISSET_BH</span>
<a href="#l8.338"></a><span id="l8.338" class="difflineplus">+#undef      WORD_BH</span>
<a href="#l8.339"></a><span id="l8.339" class="difflineplus">+#undef UNALIGNED_BH</span>
<a href="#l8.340"></a><span id="l8.340" class="difflineplus">+</span>
<a href="#l8.341"></a><span id="l8.341" class="difflineplus">+</span>
<a href="#l8.342"></a><span id="l8.342" class="difflineplus">+/*---------------------------------------------*/</span>
<a href="#l8.343"></a><span id="l8.343" class="difflineplus">+/*--- The main, O(N^2 log(N)) sorting       ---*/</span>
<a href="#l8.344"></a><span id="l8.344" class="difflineplus">+/*--- algorithm.  Faster for &quot;normal&quot;       ---*/</span>
<a href="#l8.345"></a><span id="l8.345" class="difflineplus">+/*--- non-repetitive blocks.                ---*/</span>
<a href="#l8.346"></a><span id="l8.346" class="difflineplus">+/*---------------------------------------------*/</span>
<a href="#l8.347"></a><span id="l8.347" class="difflineplus">+</span>
<a href="#l8.348"></a><span id="l8.348" class="difflineplus">+/*---------------------------------------------*/</span>
<a href="#l8.349"></a><span id="l8.349" class="difflineplus">+static</span>
<a href="#l8.350"></a><span id="l8.350" class="difflineplus">+__inline__</span>
<a href="#l8.351"></a><span id="l8.351" class="difflineplus">+Bool mainGtU ( UInt32  i1, </span>
<a href="#l8.352"></a><span id="l8.352" class="difflineplus">+               UInt32  i2,</span>
<a href="#l8.353"></a><span id="l8.353" class="difflineplus">+               UChar*  block, </span>
<a href="#l8.354"></a><span id="l8.354" class="difflineplus">+               UInt16* quadrant,</span>
<a href="#l8.355"></a><span id="l8.355" class="difflineplus">+               UInt32  nblock,</span>
<a href="#l8.356"></a><span id="l8.356" class="difflineplus">+               Int32*  budget )</span>
<a href="#l8.357"></a><span id="l8.357" class="difflineplus">+{</span>
<a href="#l8.358"></a><span id="l8.358" class="difflineplus">+   Int32  k;</span>
<a href="#l8.359"></a><span id="l8.359" class="difflineplus">+   UChar  c1, c2;</span>
<a href="#l8.360"></a><span id="l8.360" class="difflineplus">+   UInt16 s1, s2;</span>
<a href="#l8.361"></a><span id="l8.361" class="difflineplus">+</span>
<a href="#l8.362"></a><span id="l8.362" class="difflineplus">+   AssertD ( i1 != i2, &quot;mainGtU&quot; );</span>
<a href="#l8.363"></a><span id="l8.363" class="difflineplus">+   /* 1 */</span>
<a href="#l8.364"></a><span id="l8.364" class="difflineplus">+   c1 = block[i1]; c2 = block[i2];</span>
<a href="#l8.365"></a><span id="l8.365" class="difflineplus">+   if (c1 != c2) return (c1 &gt; c2);</span>
<a href="#l8.366"></a><span id="l8.366" class="difflineplus">+   i1++; i2++;</span>
<a href="#l8.367"></a><span id="l8.367" class="difflineplus">+   /* 2 */</span>
<a href="#l8.368"></a><span id="l8.368" class="difflineplus">+   c1 = block[i1]; c2 = block[i2];</span>
<a href="#l8.369"></a><span id="l8.369" class="difflineplus">+   if (c1 != c2) return (c1 &gt; c2);</span>
<a href="#l8.370"></a><span id="l8.370" class="difflineplus">+   i1++; i2++;</span>
<a href="#l8.371"></a><span id="l8.371" class="difflineplus">+   /* 3 */</span>
<a href="#l8.372"></a><span id="l8.372" class="difflineplus">+   c1 = block[i1]; c2 = block[i2];</span>
<a href="#l8.373"></a><span id="l8.373" class="difflineplus">+   if (c1 != c2) return (c1 &gt; c2);</span>
<a href="#l8.374"></a><span id="l8.374" class="difflineplus">+   i1++; i2++;</span>
<a href="#l8.375"></a><span id="l8.375" class="difflineplus">+   /* 4 */</span>
<a href="#l8.376"></a><span id="l8.376" class="difflineplus">+   c1 = block[i1]; c2 = block[i2];</span>
<a href="#l8.377"></a><span id="l8.377" class="difflineplus">+   if (c1 != c2) return (c1 &gt; c2);</span>
<a href="#l8.378"></a><span id="l8.378" class="difflineplus">+   i1++; i2++;</span>
<a href="#l8.379"></a><span id="l8.379" class="difflineplus">+   /* 5 */</span>
<a href="#l8.380"></a><span id="l8.380" class="difflineplus">+   c1 = block[i1]; c2 = block[i2];</span>
<a href="#l8.381"></a><span id="l8.381" class="difflineplus">+   if (c1 != c2) return (c1 &gt; c2);</span>
<a href="#l8.382"></a><span id="l8.382" class="difflineplus">+   i1++; i2++;</span>
<a href="#l8.383"></a><span id="l8.383" class="difflineplus">+   /* 6 */</span>
<a href="#l8.384"></a><span id="l8.384" class="difflineplus">+   c1 = block[i1]; c2 = block[i2];</span>
<a href="#l8.385"></a><span id="l8.385" class="difflineplus">+   if (c1 != c2) return (c1 &gt; c2);</span>
<a href="#l8.386"></a><span id="l8.386" class="difflineplus">+   i1++; i2++;</span>
<a href="#l8.387"></a><span id="l8.387" class="difflineplus">+   /* 7 */</span>
<a href="#l8.388"></a><span id="l8.388" class="difflineplus">+   c1 = block[i1]; c2 = block[i2];</span>
<a href="#l8.389"></a><span id="l8.389" class="difflineplus">+   if (c1 != c2) return (c1 &gt; c2);</span>
<a href="#l8.390"></a><span id="l8.390" class="difflineplus">+   i1++; i2++;</span>
<a href="#l8.391"></a><span id="l8.391" class="difflineplus">+   /* 8 */</span>
<a href="#l8.392"></a><span id="l8.392" class="difflineplus">+   c1 = block[i1]; c2 = block[i2];</span>
<a href="#l8.393"></a><span id="l8.393" class="difflineplus">+   if (c1 != c2) return (c1 &gt; c2);</span>
<a href="#l8.394"></a><span id="l8.394" class="difflineplus">+   i1++; i2++;</span>
<a href="#l8.395"></a><span id="l8.395" class="difflineplus">+   /* 9 */</span>
<a href="#l8.396"></a><span id="l8.396" class="difflineplus">+   c1 = block[i1]; c2 = block[i2];</span>
<a href="#l8.397"></a><span id="l8.397" class="difflineplus">+   if (c1 != c2) return (c1 &gt; c2);</span>
<a href="#l8.398"></a><span id="l8.398" class="difflineplus">+   i1++; i2++;</span>
<a href="#l8.399"></a><span id="l8.399" class="difflineplus">+   /* 10 */</span>
<a href="#l8.400"></a><span id="l8.400" class="difflineplus">+   c1 = block[i1]; c2 = block[i2];</span>
<a href="#l8.401"></a><span id="l8.401" class="difflineplus">+   if (c1 != c2) return (c1 &gt; c2);</span>
<a href="#l8.402"></a><span id="l8.402" class="difflineplus">+   i1++; i2++;</span>
<a href="#l8.403"></a><span id="l8.403" class="difflineplus">+   /* 11 */</span>
<a href="#l8.404"></a><span id="l8.404" class="difflineplus">+   c1 = block[i1]; c2 = block[i2];</span>
<a href="#l8.405"></a><span id="l8.405" class="difflineplus">+   if (c1 != c2) return (c1 &gt; c2);</span>
<a href="#l8.406"></a><span id="l8.406" class="difflineplus">+   i1++; i2++;</span>
<a href="#l8.407"></a><span id="l8.407" class="difflineplus">+   /* 12 */</span>
<a href="#l8.408"></a><span id="l8.408" class="difflineplus">+   c1 = block[i1]; c2 = block[i2];</span>
<a href="#l8.409"></a><span id="l8.409" class="difflineplus">+   if (c1 != c2) return (c1 &gt; c2);</span>
<a href="#l8.410"></a><span id="l8.410" class="difflineplus">+   i1++; i2++;</span>
<a href="#l8.411"></a><span id="l8.411" class="difflineplus">+</span>
<a href="#l8.412"></a><span id="l8.412" class="difflineplus">+   k = nblock + 8;</span>
<a href="#l8.413"></a><span id="l8.413" class="difflineplus">+</span>
<a href="#l8.414"></a><span id="l8.414" class="difflineplus">+   do {</span>
<a href="#l8.415"></a><span id="l8.415" class="difflineplus">+      /* 1 */</span>
<a href="#l8.416"></a><span id="l8.416" class="difflineplus">+      c1 = block[i1]; c2 = block[i2];</span>
<a href="#l8.417"></a><span id="l8.417" class="difflineplus">+      if (c1 != c2) return (c1 &gt; c2);</span>
<a href="#l8.418"></a><span id="l8.418" class="difflineplus">+      s1 = quadrant[i1]; s2 = quadrant[i2];</span>
<a href="#l8.419"></a><span id="l8.419" class="difflineplus">+      if (s1 != s2) return (s1 &gt; s2);</span>
<a href="#l8.420"></a><span id="l8.420" class="difflineplus">+      i1++; i2++;</span>
<a href="#l8.421"></a><span id="l8.421" class="difflineplus">+      /* 2 */</span>
<a href="#l8.422"></a><span id="l8.422" class="difflineplus">+      c1 = block[i1]; c2 = block[i2];</span>
<a href="#l8.423"></a><span id="l8.423" class="difflineplus">+      if (c1 != c2) return (c1 &gt; c2);</span>
<a href="#l8.424"></a><span id="l8.424" class="difflineplus">+      s1 = quadrant[i1]; s2 = quadrant[i2];</span>
<a href="#l8.425"></a><span id="l8.425" class="difflineplus">+      if (s1 != s2) return (s1 &gt; s2);</span>
<a href="#l8.426"></a><span id="l8.426" class="difflineplus">+      i1++; i2++;</span>
<a href="#l8.427"></a><span id="l8.427" class="difflineplus">+      /* 3 */</span>
<a href="#l8.428"></a><span id="l8.428" class="difflineplus">+      c1 = block[i1]; c2 = block[i2];</span>
<a href="#l8.429"></a><span id="l8.429" class="difflineplus">+      if (c1 != c2) return (c1 &gt; c2);</span>
<a href="#l8.430"></a><span id="l8.430" class="difflineplus">+      s1 = quadrant[i1]; s2 = quadrant[i2];</span>
<a href="#l8.431"></a><span id="l8.431" class="difflineplus">+      if (s1 != s2) return (s1 &gt; s2);</span>
<a href="#l8.432"></a><span id="l8.432" class="difflineplus">+      i1++; i2++;</span>
<a href="#l8.433"></a><span id="l8.433" class="difflineplus">+      /* 4 */</span>
<a href="#l8.434"></a><span id="l8.434" class="difflineplus">+      c1 = block[i1]; c2 = block[i2];</span>
<a href="#l8.435"></a><span id="l8.435" class="difflineplus">+      if (c1 != c2) return (c1 &gt; c2);</span>
<a href="#l8.436"></a><span id="l8.436" class="difflineplus">+      s1 = quadrant[i1]; s2 = quadrant[i2];</span>
<a href="#l8.437"></a><span id="l8.437" class="difflineplus">+      if (s1 != s2) return (s1 &gt; s2);</span>
<a href="#l8.438"></a><span id="l8.438" class="difflineplus">+      i1++; i2++;</span>
<a href="#l8.439"></a><span id="l8.439" class="difflineplus">+      /* 5 */</span>
<a href="#l8.440"></a><span id="l8.440" class="difflineplus">+      c1 = block[i1]; c2 = block[i2];</span>
<a href="#l8.441"></a><span id="l8.441" class="difflineplus">+      if (c1 != c2) return (c1 &gt; c2);</span>
<a href="#l8.442"></a><span id="l8.442" class="difflineplus">+      s1 = quadrant[i1]; s2 = quadrant[i2];</span>
<a href="#l8.443"></a><span id="l8.443" class="difflineplus">+      if (s1 != s2) return (s1 &gt; s2);</span>
<a href="#l8.444"></a><span id="l8.444" class="difflineplus">+      i1++; i2++;</span>
<a href="#l8.445"></a><span id="l8.445" class="difflineplus">+      /* 6 */</span>
<a href="#l8.446"></a><span id="l8.446" class="difflineplus">+      c1 = block[i1]; c2 = block[i2];</span>
<a href="#l8.447"></a><span id="l8.447" class="difflineplus">+      if (c1 != c2) return (c1 &gt; c2);</span>
<a href="#l8.448"></a><span id="l8.448" class="difflineplus">+      s1 = quadrant[i1]; s2 = quadrant[i2];</span>
<a href="#l8.449"></a><span id="l8.449" class="difflineplus">+      if (s1 != s2) return (s1 &gt; s2);</span>
<a href="#l8.450"></a><span id="l8.450" class="difflineplus">+      i1++; i2++;</span>
<a href="#l8.451"></a><span id="l8.451" class="difflineplus">+      /* 7 */</span>
<a href="#l8.452"></a><span id="l8.452" class="difflineplus">+      c1 = block[i1]; c2 = block[i2];</span>
<a href="#l8.453"></a><span id="l8.453" class="difflineplus">+      if (c1 != c2) return (c1 &gt; c2);</span>
<a href="#l8.454"></a><span id="l8.454" class="difflineplus">+      s1 = quadrant[i1]; s2 = quadrant[i2];</span>
<a href="#l8.455"></a><span id="l8.455" class="difflineplus">+      if (s1 != s2) return (s1 &gt; s2);</span>
<a href="#l8.456"></a><span id="l8.456" class="difflineplus">+      i1++; i2++;</span>
<a href="#l8.457"></a><span id="l8.457" class="difflineplus">+      /* 8 */</span>
<a href="#l8.458"></a><span id="l8.458" class="difflineplus">+      c1 = block[i1]; c2 = block[i2];</span>
<a href="#l8.459"></a><span id="l8.459" class="difflineplus">+      if (c1 != c2) return (c1 &gt; c2);</span>
<a href="#l8.460"></a><span id="l8.460" class="difflineplus">+      s1 = quadrant[i1]; s2 = quadrant[i2];</span>
<a href="#l8.461"></a><span id="l8.461" class="difflineplus">+      if (s1 != s2) return (s1 &gt; s2);</span>
<a href="#l8.462"></a><span id="l8.462" class="difflineplus">+      i1++; i2++;</span>
<a href="#l8.463"></a><span id="l8.463" class="difflineplus">+</span>
<a href="#l8.464"></a><span id="l8.464" class="difflineplus">+      if (i1 &gt;= nblock) i1 -= nblock;</span>
<a href="#l8.465"></a><span id="l8.465" class="difflineplus">+      if (i2 &gt;= nblock) i2 -= nblock;</span>
<a href="#l8.466"></a><span id="l8.466" class="difflineplus">+</span>
<a href="#l8.467"></a><span id="l8.467" class="difflineplus">+      k -= 8;</span>
<a href="#l8.468"></a><span id="l8.468" class="difflineplus">+      (*budget)--;</span>
<a href="#l8.469"></a><span id="l8.469" class="difflineplus">+   }</span>
<a href="#l8.470"></a><span id="l8.470" class="difflineplus">+      while (k &gt;= 0);</span>
<a href="#l8.471"></a><span id="l8.471" class="difflineplus">+</span>
<a href="#l8.472"></a><span id="l8.472" class="difflineplus">+   return False;</span>
<a href="#l8.473"></a><span id="l8.473" class="difflineplus">+}</span>
<a href="#l8.474"></a><span id="l8.474" class="difflineplus">+</span>
<a href="#l8.475"></a><span id="l8.475" class="difflineplus">+</span>
<a href="#l8.476"></a><span id="l8.476" class="difflineplus">+/*---------------------------------------------*/</span>
<a href="#l8.477"></a><span id="l8.477" class="difflineplus">+/*--</span>
<a href="#l8.478"></a><span id="l8.478" class="difflineplus">+   Knuth's increments seem to work better</span>
<a href="#l8.479"></a><span id="l8.479" class="difflineplus">+   than Incerpi-Sedgewick here.  Possibly</span>
<a href="#l8.480"></a><span id="l8.480" class="difflineplus">+   because the number of elems to sort is</span>
<a href="#l8.481"></a><span id="l8.481" class="difflineplus">+   usually small, typically &lt;= 20.</span>
<a href="#l8.482"></a><span id="l8.482" class="difflineplus">+--*/</span>
<a href="#l8.483"></a><span id="l8.483" class="difflineplus">+static</span>
<a href="#l8.484"></a><span id="l8.484" class="difflineplus">+Int32 incs[14] = { 1, 4, 13, 40, 121, 364, 1093, 3280,</span>
<a href="#l8.485"></a><span id="l8.485" class="difflineplus">+                   9841, 29524, 88573, 265720,</span>
<a href="#l8.486"></a><span id="l8.486" class="difflineplus">+                   797161, 2391484 };</span>
<a href="#l8.487"></a><span id="l8.487" class="difflineplus">+</span>
<a href="#l8.488"></a><span id="l8.488" class="difflineplus">+static</span>
<a href="#l8.489"></a><span id="l8.489" class="difflineplus">+void mainSimpleSort ( UInt32* ptr,</span>
<a href="#l8.490"></a><span id="l8.490" class="difflineplus">+                      UChar*  block,</span>
<a href="#l8.491"></a><span id="l8.491" class="difflineplus">+                      UInt16* quadrant,</span>
<a href="#l8.492"></a><span id="l8.492" class="difflineplus">+                      Int32   nblock,</span>
<a href="#l8.493"></a><span id="l8.493" class="difflineplus">+                      Int32   lo, </span>
<a href="#l8.494"></a><span id="l8.494" class="difflineplus">+                      Int32   hi, </span>
<a href="#l8.495"></a><span id="l8.495" class="difflineplus">+                      Int32   d,</span>
<a href="#l8.496"></a><span id="l8.496" class="difflineplus">+                      Int32*  budget )</span>
<a href="#l8.497"></a><span id="l8.497" class="difflineplus">+{</span>
<a href="#l8.498"></a><span id="l8.498" class="difflineplus">+   Int32 i, j, h, bigN, hp;</span>
<a href="#l8.499"></a><span id="l8.499" class="difflineplus">+   UInt32 v;</span>
<a href="#l8.500"></a><span id="l8.500" class="difflineplus">+</span>
<a href="#l8.501"></a><span id="l8.501" class="difflineplus">+   bigN = hi - lo + 1;</span>
<a href="#l8.502"></a><span id="l8.502" class="difflineplus">+   if (bigN &lt; 2) return;</span>
<a href="#l8.503"></a><span id="l8.503" class="difflineplus">+</span>
<a href="#l8.504"></a><span id="l8.504" class="difflineplus">+   hp = 0;</span>
<a href="#l8.505"></a><span id="l8.505" class="difflineplus">+   while (incs[hp] &lt; bigN) hp++;</span>
<a href="#l8.506"></a><span id="l8.506" class="difflineplus">+   hp--;</span>
<a href="#l8.507"></a><span id="l8.507" class="difflineplus">+</span>
<a href="#l8.508"></a><span id="l8.508" class="difflineplus">+   for (; hp &gt;= 0; hp--) {</span>
<a href="#l8.509"></a><span id="l8.509" class="difflineplus">+      h = incs[hp];</span>
<a href="#l8.510"></a><span id="l8.510" class="difflineplus">+</span>
<a href="#l8.511"></a><span id="l8.511" class="difflineplus">+      i = lo + h;</span>
<a href="#l8.512"></a><span id="l8.512" class="difflineplus">+      while (True) {</span>
<a href="#l8.513"></a><span id="l8.513" class="difflineplus">+</span>
<a href="#l8.514"></a><span id="l8.514" class="difflineplus">+         /*-- copy 1 --*/</span>
<a href="#l8.515"></a><span id="l8.515" class="difflineplus">+         if (i &gt; hi) break;</span>
<a href="#l8.516"></a><span id="l8.516" class="difflineplus">+         v = ptr[i];</span>
<a href="#l8.517"></a><span id="l8.517" class="difflineplus">+         j = i;</span>
<a href="#l8.518"></a><span id="l8.518" class="difflineplus">+         while ( mainGtU ( </span>
<a href="#l8.519"></a><span id="l8.519" class="difflineplus">+                    ptr[j-h]+d, v+d, block, quadrant, nblock, budget </span>
<a href="#l8.520"></a><span id="l8.520" class="difflineplus">+                 ) ) {</span>
<a href="#l8.521"></a><span id="l8.521" class="difflineplus">+            ptr[j] = ptr[j-h];</span>
<a href="#l8.522"></a><span id="l8.522" class="difflineplus">+            j = j - h;</span>
<a href="#l8.523"></a><span id="l8.523" class="difflineplus">+            if (j &lt;= (lo + h - 1)) break;</span>
<a href="#l8.524"></a><span id="l8.524" class="difflineplus">+         }</span>
<a href="#l8.525"></a><span id="l8.525" class="difflineplus">+         ptr[j] = v;</span>
<a href="#l8.526"></a><span id="l8.526" class="difflineplus">+         i++;</span>
<a href="#l8.527"></a><span id="l8.527" class="difflineplus">+</span>
<a href="#l8.528"></a><span id="l8.528" class="difflineplus">+         /*-- copy 2 --*/</span>
<a href="#l8.529"></a><span id="l8.529" class="difflineplus">+         if (i &gt; hi) break;</span>
<a href="#l8.530"></a><span id="l8.530" class="difflineplus">+         v = ptr[i];</span>
<a href="#l8.531"></a><span id="l8.531" class="difflineplus">+         j = i;</span>
<a href="#l8.532"></a><span id="l8.532" class="difflineplus">+         while ( mainGtU ( </span>
<a href="#l8.533"></a><span id="l8.533" class="difflineplus">+                    ptr[j-h]+d, v+d, block, quadrant, nblock, budget </span>
<a href="#l8.534"></a><span id="l8.534" class="difflineplus">+                 ) ) {</span>
<a href="#l8.535"></a><span id="l8.535" class="difflineplus">+            ptr[j] = ptr[j-h];</span>
<a href="#l8.536"></a><span id="l8.536" class="difflineplus">+            j = j - h;</span>
<a href="#l8.537"></a><span id="l8.537" class="difflineplus">+            if (j &lt;= (lo + h - 1)) break;</span>
<a href="#l8.538"></a><span id="l8.538" class="difflineplus">+         }</span>
<a href="#l8.539"></a><span id="l8.539" class="difflineplus">+         ptr[j] = v;</span>
<a href="#l8.540"></a><span id="l8.540" class="difflineplus">+         i++;</span>
<a href="#l8.541"></a><span id="l8.541" class="difflineplus">+</span>
<a href="#l8.542"></a><span id="l8.542" class="difflineplus">+         /*-- copy 3 --*/</span>
<a href="#l8.543"></a><span id="l8.543" class="difflineplus">+         if (i &gt; hi) break;</span>
<a href="#l8.544"></a><span id="l8.544" class="difflineplus">+         v = ptr[i];</span>
<a href="#l8.545"></a><span id="l8.545" class="difflineplus">+         j = i;</span>
<a href="#l8.546"></a><span id="l8.546" class="difflineplus">+         while ( mainGtU ( </span>
<a href="#l8.547"></a><span id="l8.547" class="difflineplus">+                    ptr[j-h]+d, v+d, block, quadrant, nblock, budget </span>
<a href="#l8.548"></a><span id="l8.548" class="difflineplus">+                 ) ) {</span>
<a href="#l8.549"></a><span id="l8.549" class="difflineplus">+            ptr[j] = ptr[j-h];</span>
<a href="#l8.550"></a><span id="l8.550" class="difflineplus">+            j = j - h;</span>
<a href="#l8.551"></a><span id="l8.551" class="difflineplus">+            if (j &lt;= (lo + h - 1)) break;</span>
<a href="#l8.552"></a><span id="l8.552" class="difflineplus">+         }</span>
<a href="#l8.553"></a><span id="l8.553" class="difflineplus">+         ptr[j] = v;</span>
<a href="#l8.554"></a><span id="l8.554" class="difflineplus">+         i++;</span>
<a href="#l8.555"></a><span id="l8.555" class="difflineplus">+</span>
<a href="#l8.556"></a><span id="l8.556" class="difflineplus">+         if (*budget &lt; 0) return;</span>
<a href="#l8.557"></a><span id="l8.557" class="difflineplus">+      }</span>
<a href="#l8.558"></a><span id="l8.558" class="difflineplus">+   }</span>
<a href="#l8.559"></a><span id="l8.559" class="difflineplus">+}</span>
<a href="#l8.560"></a><span id="l8.560" class="difflineplus">+</span>
<a href="#l8.561"></a><span id="l8.561" class="difflineplus">+</span>
<a href="#l8.562"></a><span id="l8.562" class="difflineplus">+/*---------------------------------------------*/</span>
<a href="#l8.563"></a><span id="l8.563" class="difflineplus">+/*--</span>
<a href="#l8.564"></a><span id="l8.564" class="difflineplus">+   The following is an implementation of</span>
<a href="#l8.565"></a><span id="l8.565" class="difflineplus">+   an elegant 3-way quicksort for strings,</span>
<a href="#l8.566"></a><span id="l8.566" class="difflineplus">+   described in a paper &quot;Fast Algorithms for</span>
<a href="#l8.567"></a><span id="l8.567" class="difflineplus">+   Sorting and Searching Strings&quot;, by Robert</span>
<a href="#l8.568"></a><span id="l8.568" class="difflineplus">+   Sedgewick and Jon L. Bentley.</span>
<a href="#l8.569"></a><span id="l8.569" class="difflineplus">+--*/</span>
<a href="#l8.570"></a><span id="l8.570" class="difflineplus">+</span>
<a href="#l8.571"></a><span id="l8.571" class="difflineplus">+#define mswap(zz1, zz2) \</span>
<a href="#l8.572"></a><span id="l8.572" class="difflineplus">+   { Int32 zztmp = zz1; zz1 = zz2; zz2 = zztmp; }</span>
<a href="#l8.573"></a><span id="l8.573" class="difflineplus">+</span>
<a href="#l8.574"></a><span id="l8.574" class="difflineplus">+#define mvswap(zzp1, zzp2, zzn)       \</span>
<a href="#l8.575"></a><span id="l8.575" class="difflineplus">+{                                     \</span>
<a href="#l8.576"></a><span id="l8.576" class="difflineplus">+   Int32 yyp1 = (zzp1);               \</span>
<a href="#l8.577"></a><span id="l8.577" class="difflineplus">+   Int32 yyp2 = (zzp2);               \</span>
<a href="#l8.578"></a><span id="l8.578" class="difflineplus">+   Int32 yyn  = (zzn);                \</span>
<a href="#l8.579"></a><span id="l8.579" class="difflineplus">+   while (yyn &gt; 0) {                  \</span>
<a href="#l8.580"></a><span id="l8.580" class="difflineplus">+      mswap(ptr[yyp1], ptr[yyp2]);    \</span>
<a href="#l8.581"></a><span id="l8.581" class="difflineplus">+      yyp1++; yyp2++; yyn--;          \</span>
<a href="#l8.582"></a><span id="l8.582" class="difflineplus">+   }                                  \</span>
<a href="#l8.583"></a><span id="l8.583" class="difflineplus">+}</span>
<a href="#l8.584"></a><span id="l8.584" class="difflineplus">+</span>
<a href="#l8.585"></a><span id="l8.585" class="difflineplus">+static </span>
<a href="#l8.586"></a><span id="l8.586" class="difflineplus">+__inline__</span>
<a href="#l8.587"></a><span id="l8.587" class="difflineplus">+UChar mmed3 ( UChar a, UChar b, UChar c )</span>
<a href="#l8.588"></a><span id="l8.588" class="difflineplus">+{</span>
<a href="#l8.589"></a><span id="l8.589" class="difflineplus">+   UChar t;</span>
<a href="#l8.590"></a><span id="l8.590" class="difflineplus">+   if (a &gt; b) { t = a; a = b; b = t; };</span>
<a href="#l8.591"></a><span id="l8.591" class="difflineplus">+   if (b &gt; c) { </span>
<a href="#l8.592"></a><span id="l8.592" class="difflineplus">+      b = c;</span>
<a href="#l8.593"></a><span id="l8.593" class="difflineplus">+      if (a &gt; b) b = a;</span>
<a href="#l8.594"></a><span id="l8.594" class="difflineplus">+   }</span>
<a href="#l8.595"></a><span id="l8.595" class="difflineplus">+   return b;</span>
<a href="#l8.596"></a><span id="l8.596" class="difflineplus">+}</span>
<a href="#l8.597"></a><span id="l8.597" class="difflineplus">+</span>
<a href="#l8.598"></a><span id="l8.598" class="difflineplus">+#define mmin(a,b) ((a) &lt; (b)) ? (a) : (b)</span>
<a href="#l8.599"></a><span id="l8.599" class="difflineplus">+</span>
<a href="#l8.600"></a><span id="l8.600" class="difflineplus">+#define mpush(lz,hz,dz) { stackLo[sp] = lz; \</span>
<a href="#l8.601"></a><span id="l8.601" class="difflineplus">+                          stackHi[sp] = hz; \</span>
<a href="#l8.602"></a><span id="l8.602" class="difflineplus">+                          stackD [sp] = dz; \</span>
<a href="#l8.603"></a><span id="l8.603" class="difflineplus">+                          sp++; }</span>
<a href="#l8.604"></a><span id="l8.604" class="difflineplus">+</span>
<a href="#l8.605"></a><span id="l8.605" class="difflineplus">+#define mpop(lz,hz,dz) { sp--;             \</span>
<a href="#l8.606"></a><span id="l8.606" class="difflineplus">+                         lz = stackLo[sp]; \</span>
<a href="#l8.607"></a><span id="l8.607" class="difflineplus">+                         hz = stackHi[sp]; \</span>
<a href="#l8.608"></a><span id="l8.608" class="difflineplus">+                         dz = stackD [sp]; }</span>
<a href="#l8.609"></a><span id="l8.609" class="difflineplus">+</span>
<a href="#l8.610"></a><span id="l8.610" class="difflineplus">+</span>
<a href="#l8.611"></a><span id="l8.611" class="difflineplus">+#define mnextsize(az) (nextHi[az]-nextLo[az])</span>
<a href="#l8.612"></a><span id="l8.612" class="difflineplus">+</span>
<a href="#l8.613"></a><span id="l8.613" class="difflineplus">+#define mnextswap(az,bz)                                        \</span>
<a href="#l8.614"></a><span id="l8.614" class="difflineplus">+   { Int32 tz;                                                  \</span>
<a href="#l8.615"></a><span id="l8.615" class="difflineplus">+     tz = nextLo[az]; nextLo[az] = nextLo[bz]; nextLo[bz] = tz; \</span>
<a href="#l8.616"></a><span id="l8.616" class="difflineplus">+     tz = nextHi[az]; nextHi[az] = nextHi[bz]; nextHi[bz] = tz; \</span>
<a href="#l8.617"></a><span id="l8.617" class="difflineplus">+     tz = nextD [az]; nextD [az] = nextD [bz]; nextD [bz] = tz; }</span>
<a href="#l8.618"></a><span id="l8.618" class="difflineplus">+</span>
<a href="#l8.619"></a><span id="l8.619" class="difflineplus">+</span>
<a href="#l8.620"></a><span id="l8.620" class="difflineplus">+#define MAIN_QSORT_SMALL_THRESH 20</span>
<a href="#l8.621"></a><span id="l8.621" class="difflineplus">+#define MAIN_QSORT_DEPTH_THRESH (BZ_N_RADIX + BZ_N_QSORT)</span>
<a href="#l8.622"></a><span id="l8.622" class="difflineplus">+#define MAIN_QSORT_STACK_SIZE 100</span>
<a href="#l8.623"></a><span id="l8.623" class="difflineplus">+</span>
<a href="#l8.624"></a><span id="l8.624" class="difflineplus">+static</span>
<a href="#l8.625"></a><span id="l8.625" class="difflineplus">+void mainQSort3 ( UInt32* ptr,</span>
<a href="#l8.626"></a><span id="l8.626" class="difflineplus">+                  UChar*  block,</span>
<a href="#l8.627"></a><span id="l8.627" class="difflineplus">+                  UInt16* quadrant,</span>
<a href="#l8.628"></a><span id="l8.628" class="difflineplus">+                  Int32   nblock,</span>
<a href="#l8.629"></a><span id="l8.629" class="difflineplus">+                  Int32   loSt, </span>
<a href="#l8.630"></a><span id="l8.630" class="difflineplus">+                  Int32   hiSt, </span>
<a href="#l8.631"></a><span id="l8.631" class="difflineplus">+                  Int32   dSt,</span>
<a href="#l8.632"></a><span id="l8.632" class="difflineplus">+                  Int32*  budget )</span>
<a href="#l8.633"></a><span id="l8.633" class="difflineplus">+{</span>
<a href="#l8.634"></a><span id="l8.634" class="difflineplus">+   Int32 unLo, unHi, ltLo, gtHi, n, m, med;</span>
<a href="#l8.635"></a><span id="l8.635" class="difflineplus">+   Int32 sp, lo, hi, d;</span>
<a href="#l8.636"></a><span id="l8.636" class="difflineplus">+</span>
<a href="#l8.637"></a><span id="l8.637" class="difflineplus">+   Int32 stackLo[MAIN_QSORT_STACK_SIZE];</span>
<a href="#l8.638"></a><span id="l8.638" class="difflineplus">+   Int32 stackHi[MAIN_QSORT_STACK_SIZE];</span>
<a href="#l8.639"></a><span id="l8.639" class="difflineplus">+   Int32 stackD [MAIN_QSORT_STACK_SIZE];</span>
<a href="#l8.640"></a><span id="l8.640" class="difflineplus">+</span>
<a href="#l8.641"></a><span id="l8.641" class="difflineplus">+   Int32 nextLo[3];</span>
<a href="#l8.642"></a><span id="l8.642" class="difflineplus">+   Int32 nextHi[3];</span>
<a href="#l8.643"></a><span id="l8.643" class="difflineplus">+   Int32 nextD [3];</span>
<a href="#l8.644"></a><span id="l8.644" class="difflineplus">+</span>
<a href="#l8.645"></a><span id="l8.645" class="difflineplus">+   sp = 0;</span>
<a href="#l8.646"></a><span id="l8.646" class="difflineplus">+   mpush ( loSt, hiSt, dSt );</span>
<a href="#l8.647"></a><span id="l8.647" class="difflineplus">+</span>
<a href="#l8.648"></a><span id="l8.648" class="difflineplus">+   while (sp &gt; 0) {</span>
<a href="#l8.649"></a><span id="l8.649" class="difflineplus">+</span>
<a href="#l8.650"></a><span id="l8.650" class="difflineplus">+      AssertH ( sp &lt; MAIN_QSORT_STACK_SIZE - 2, 1001 );</span>
<a href="#l8.651"></a><span id="l8.651" class="difflineplus">+</span>
<a href="#l8.652"></a><span id="l8.652" class="difflineplus">+      mpop ( lo, hi, d );</span>
<a href="#l8.653"></a><span id="l8.653" class="difflineplus">+      if (hi - lo &lt; MAIN_QSORT_SMALL_THRESH || </span>
<a href="#l8.654"></a><span id="l8.654" class="difflineplus">+          d &gt; MAIN_QSORT_DEPTH_THRESH) {</span>
<a href="#l8.655"></a><span id="l8.655" class="difflineplus">+         mainSimpleSort ( ptr, block, quadrant, nblock, lo, hi, d, budget );</span>
<a href="#l8.656"></a><span id="l8.656" class="difflineplus">+         if (*budget &lt; 0) return;</span>
<a href="#l8.657"></a><span id="l8.657" class="difflineplus">+         continue;</span>
<a href="#l8.658"></a><span id="l8.658" class="difflineplus">+      }</span>
<a href="#l8.659"></a><span id="l8.659" class="difflineplus">+</span>
<a href="#l8.660"></a><span id="l8.660" class="difflineplus">+      med = (Int32) </span>
<a href="#l8.661"></a><span id="l8.661" class="difflineplus">+            mmed3 ( block[ptr[ lo         ]+d],</span>
<a href="#l8.662"></a><span id="l8.662" class="difflineplus">+                    block[ptr[ hi         ]+d],</span>
<a href="#l8.663"></a><span id="l8.663" class="difflineplus">+                    block[ptr[ (lo+hi)&gt;&gt;1 ]+d] );</span>
<a href="#l8.664"></a><span id="l8.664" class="difflineplus">+</span>
<a href="#l8.665"></a><span id="l8.665" class="difflineplus">+      unLo = ltLo = lo;</span>
<a href="#l8.666"></a><span id="l8.666" class="difflineplus">+      unHi = gtHi = hi;</span>
<a href="#l8.667"></a><span id="l8.667" class="difflineplus">+</span>
<a href="#l8.668"></a><span id="l8.668" class="difflineplus">+      while (True) {</span>
<a href="#l8.669"></a><span id="l8.669" class="difflineplus">+         while (True) {</span>
<a href="#l8.670"></a><span id="l8.670" class="difflineplus">+            if (unLo &gt; unHi) break;</span>
<a href="#l8.671"></a><span id="l8.671" class="difflineplus">+            n = ((Int32)block[ptr[unLo]+d]) - med;</span>
<a href="#l8.672"></a><span id="l8.672" class="difflineplus">+            if (n == 0) { </span>
<a href="#l8.673"></a><span id="l8.673" class="difflineplus">+               mswap(ptr[unLo], ptr[ltLo]); </span>
<a href="#l8.674"></a><span id="l8.674" class="difflineplus">+               ltLo++; unLo++; continue; </span>
<a href="#l8.675"></a><span id="l8.675" class="difflineplus">+            };</span>
<a href="#l8.676"></a><span id="l8.676" class="difflineplus">+            if (n &gt;  0) break;</span>
<a href="#l8.677"></a><span id="l8.677" class="difflineplus">+            unLo++;</span>
<a href="#l8.678"></a><span id="l8.678" class="difflineplus">+         }</span>
<a href="#l8.679"></a><span id="l8.679" class="difflineplus">+         while (True) {</span>
<a href="#l8.680"></a><span id="l8.680" class="difflineplus">+            if (unLo &gt; unHi) break;</span>
<a href="#l8.681"></a><span id="l8.681" class="difflineplus">+            n = ((Int32)block[ptr[unHi]+d]) - med;</span>
<a href="#l8.682"></a><span id="l8.682" class="difflineplus">+            if (n == 0) { </span>
<a href="#l8.683"></a><span id="l8.683" class="difflineplus">+               mswap(ptr[unHi], ptr[gtHi]); </span>
<a href="#l8.684"></a><span id="l8.684" class="difflineplus">+               gtHi--; unHi--; continue; </span>
<a href="#l8.685"></a><span id="l8.685" class="difflineplus">+            };</span>
<a href="#l8.686"></a><span id="l8.686" class="difflineplus">+            if (n &lt;  0) break;</span>
<a href="#l8.687"></a><span id="l8.687" class="difflineplus">+            unHi--;</span>
<a href="#l8.688"></a><span id="l8.688" class="difflineplus">+         }</span>
<a href="#l8.689"></a><span id="l8.689" class="difflineplus">+         if (unLo &gt; unHi) break;</span>
<a href="#l8.690"></a><span id="l8.690" class="difflineplus">+         mswap(ptr[unLo], ptr[unHi]); unLo++; unHi--;</span>
<a href="#l8.691"></a><span id="l8.691" class="difflineplus">+      }</span>
<a href="#l8.692"></a><span id="l8.692" class="difflineplus">+</span>
<a href="#l8.693"></a><span id="l8.693" class="difflineplus">+      AssertD ( unHi == unLo-1, &quot;mainQSort3(2)&quot; );</span>
<a href="#l8.694"></a><span id="l8.694" class="difflineplus">+</span>
<a href="#l8.695"></a><span id="l8.695" class="difflineplus">+      if (gtHi &lt; ltLo) {</span>
<a href="#l8.696"></a><span id="l8.696" class="difflineplus">+         mpush(lo, hi, d+1 );</span>
<a href="#l8.697"></a><span id="l8.697" class="difflineplus">+         continue;</span>
<a href="#l8.698"></a><span id="l8.698" class="difflineplus">+      }</span>
<a href="#l8.699"></a><span id="l8.699" class="difflineplus">+</span>
<a href="#l8.700"></a><span id="l8.700" class="difflineplus">+      n = mmin(ltLo-lo, unLo-ltLo); mvswap(lo, unLo-n, n);</span>
<a href="#l8.701"></a><span id="l8.701" class="difflineplus">+      m = mmin(hi-gtHi, gtHi-unHi); mvswap(unLo, hi-m+1, m);</span>
<a href="#l8.702"></a><span id="l8.702" class="difflineplus">+</span>
<a href="#l8.703"></a><span id="l8.703" class="difflineplus">+      n = lo + unLo - ltLo - 1;</span>
<a href="#l8.704"></a><span id="l8.704" class="difflineplus">+      m = hi - (gtHi - unHi) + 1;</span>
<a href="#l8.705"></a><span id="l8.705" class="difflineplus">+</span>
<a href="#l8.706"></a><span id="l8.706" class="difflineplus">+      nextLo[0] = lo;  nextHi[0] = n;   nextD[0] = d;</span>
<a href="#l8.707"></a><span id="l8.707" class="difflineplus">+      nextLo[1] = m;   nextHi[1] = hi;  nextD[1] = d;</span>
<a href="#l8.708"></a><span id="l8.708" class="difflineplus">+      nextLo[2] = n+1; nextHi[2] = m-1; nextD[2] = d+1;</span>
<a href="#l8.709"></a><span id="l8.709" class="difflineplus">+</span>
<a href="#l8.710"></a><span id="l8.710" class="difflineplus">+      if (mnextsize(0) &lt; mnextsize(1)) mnextswap(0,1);</span>
<a href="#l8.711"></a><span id="l8.711" class="difflineplus">+      if (mnextsize(1) &lt; mnextsize(2)) mnextswap(1,2);</span>
<a href="#l8.712"></a><span id="l8.712" class="difflineplus">+      if (mnextsize(0) &lt; mnextsize(1)) mnextswap(0,1);</span>
<a href="#l8.713"></a><span id="l8.713" class="difflineplus">+</span>
<a href="#l8.714"></a><span id="l8.714" class="difflineplus">+      AssertD (mnextsize(0) &gt;= mnextsize(1), &quot;mainQSort3(8)&quot; );</span>
<a href="#l8.715"></a><span id="l8.715" class="difflineplus">+      AssertD (mnextsize(1) &gt;= mnextsize(2), &quot;mainQSort3(9)&quot; );</span>
<a href="#l8.716"></a><span id="l8.716" class="difflineplus">+</span>
<a href="#l8.717"></a><span id="l8.717" class="difflineplus">+      mpush (nextLo[0], nextHi[0], nextD[0]);</span>
<a href="#l8.718"></a><span id="l8.718" class="difflineplus">+      mpush (nextLo[1], nextHi[1], nextD[1]);</span>
<a href="#l8.719"></a><span id="l8.719" class="difflineplus">+      mpush (nextLo[2], nextHi[2], nextD[2]);</span>
<a href="#l8.720"></a><span id="l8.720" class="difflineplus">+   }</span>
<a href="#l8.721"></a><span id="l8.721" class="difflineplus">+}</span>
<a href="#l8.722"></a><span id="l8.722" class="difflineplus">+</span>
<a href="#l8.723"></a><span id="l8.723" class="difflineplus">+#undef mswap</span>
<a href="#l8.724"></a><span id="l8.724" class="difflineplus">+#undef mvswap</span>
<a href="#l8.725"></a><span id="l8.725" class="difflineplus">+#undef mpush</span>
<a href="#l8.726"></a><span id="l8.726" class="difflineplus">+#undef mpop</span>
<a href="#l8.727"></a><span id="l8.727" class="difflineplus">+#undef mmin</span>
<a href="#l8.728"></a><span id="l8.728" class="difflineplus">+#undef mnextsize</span>
<a href="#l8.729"></a><span id="l8.729" class="difflineplus">+#undef mnextswap</span>
<a href="#l8.730"></a><span id="l8.730" class="difflineplus">+#undef MAIN_QSORT_SMALL_THRESH</span>
<a href="#l8.731"></a><span id="l8.731" class="difflineplus">+#undef MAIN_QSORT_DEPTH_THRESH</span>
<a href="#l8.732"></a><span id="l8.732" class="difflineplus">+#undef MAIN_QSORT_STACK_SIZE</span>
<a href="#l8.733"></a><span id="l8.733" class="difflineplus">+</span>
<a href="#l8.734"></a><span id="l8.734" class="difflineplus">+</span>
<a href="#l8.735"></a><span id="l8.735" class="difflineplus">+/*---------------------------------------------*/</span>
<a href="#l8.736"></a><span id="l8.736" class="difflineplus">+/* Pre:</span>
<a href="#l8.737"></a><span id="l8.737" class="difflineplus">+      nblock &gt; N_OVERSHOOT</span>
<a href="#l8.738"></a><span id="l8.738" class="difflineplus">+      block32 exists for [0 .. nblock-1 +N_OVERSHOOT]</span>
<a href="#l8.739"></a><span id="l8.739" class="difflineplus">+      ((UChar*)block32) [0 .. nblock-1] holds block</span>
<a href="#l8.740"></a><span id="l8.740" class="difflineplus">+      ptr exists for [0 .. nblock-1]</span>
<a href="#l8.741"></a><span id="l8.741" class="difflineplus">+</span>
<a href="#l8.742"></a><span id="l8.742" class="difflineplus">+   Post:</span>
<a href="#l8.743"></a><span id="l8.743" class="difflineplus">+      ((UChar*)block32) [0 .. nblock-1] holds block</span>
<a href="#l8.744"></a><span id="l8.744" class="difflineplus">+      All other areas of block32 destroyed</span>
<a href="#l8.745"></a><span id="l8.745" class="difflineplus">+      ftab [0 .. 65536 ] destroyed</span>
<a href="#l8.746"></a><span id="l8.746" class="difflineplus">+      ptr [0 .. nblock-1] holds sorted order</span>
<a href="#l8.747"></a><span id="l8.747" class="difflineplus">+      if (*budget &lt; 0), sorting was abandoned</span>
<a href="#l8.748"></a><span id="l8.748" class="difflineplus">+*/</span>
<a href="#l8.749"></a><span id="l8.749" class="difflineplus">+</span>
<a href="#l8.750"></a><span id="l8.750" class="difflineplus">+#define BIGFREQ(b) (ftab[((b)+1) &lt;&lt; 8] - ftab[(b) &lt;&lt; 8])</span>
<a href="#l8.751"></a><span id="l8.751" class="difflineplus">+#define SETMASK (1 &lt;&lt; 21)</span>
<a href="#l8.752"></a><span id="l8.752" class="difflineplus">+#define CLEARMASK (~(SETMASK))</span>
<a href="#l8.753"></a><span id="l8.753" class="difflineplus">+</span>
<a href="#l8.754"></a><span id="l8.754" class="difflineplus">+static</span>
<a href="#l8.755"></a><span id="l8.755" class="difflineplus">+void mainSort ( UInt32* ptr, </span>
<a href="#l8.756"></a><span id="l8.756" class="difflineplus">+                UChar*  block,</span>
<a href="#l8.757"></a><span id="l8.757" class="difflineplus">+                UInt16* quadrant, </span>
<a href="#l8.758"></a><span id="l8.758" class="difflineplus">+                UInt32* ftab,</span>
<a href="#l8.759"></a><span id="l8.759" class="difflineplus">+                Int32   nblock,</span>
<a href="#l8.760"></a><span id="l8.760" class="difflineplus">+                Int32   verb,</span>
<a href="#l8.761"></a><span id="l8.761" class="difflineplus">+                Int32*  budget )</span>
<a href="#l8.762"></a><span id="l8.762" class="difflineplus">+{</span>
<a href="#l8.763"></a><span id="l8.763" class="difflineplus">+   Int32  i, j, k, ss, sb;</span>
<a href="#l8.764"></a><span id="l8.764" class="difflineplus">+   Int32  runningOrder[256];</span>
<a href="#l8.765"></a><span id="l8.765" class="difflineplus">+   Bool   bigDone[256];</span>
<a href="#l8.766"></a><span id="l8.766" class="difflineplus">+   Int32  copyStart[256];</span>
<a href="#l8.767"></a><span id="l8.767" class="difflineplus">+   Int32  copyEnd  [256];</span>
<a href="#l8.768"></a><span id="l8.768" class="difflineplus">+   UChar  c1;</span>
<a href="#l8.769"></a><span id="l8.769" class="difflineplus">+   Int32  numQSorted;</span>
<a href="#l8.770"></a><span id="l8.770" class="difflineplus">+   UInt16 s;</span>
<a href="#l8.771"></a><span id="l8.771" class="difflineplus">+   if (verb &gt;= 4) VPrintf0 ( &quot;        main sort initialise ...\n&quot; );</span>
<a href="#l8.772"></a><span id="l8.772" class="difflineplus">+</span>
<a href="#l8.773"></a><span id="l8.773" class="difflineplus">+   /*-- set up the 2-byte frequency table --*/</span>
<a href="#l8.774"></a><span id="l8.774" class="difflineplus">+   for (i = 65536; i &gt;= 0; i--) ftab[i] = 0;</span>
<a href="#l8.775"></a><span id="l8.775" class="difflineplus">+</span>
<a href="#l8.776"></a><span id="l8.776" class="difflineplus">+   j = block[0] &lt;&lt; 8;</span>
<a href="#l8.777"></a><span id="l8.777" class="difflineplus">+   i = nblock-1;</span>
<a href="#l8.778"></a><span id="l8.778" class="difflineplus">+   for (; i &gt;= 3; i -= 4) {</span>
<a href="#l8.779"></a><span id="l8.779" class="difflineplus">+      quadrant[i] = 0;</span>
<a href="#l8.780"></a><span id="l8.780" class="difflineplus">+      j = (j &gt;&gt; 8) | ( ((UInt16)block[i]) &lt;&lt; 8);</span>
<a href="#l8.781"></a><span id="l8.781" class="difflineplus">+      ftab[j]++;</span>
<a href="#l8.782"></a><span id="l8.782" class="difflineplus">+      quadrant[i-1] = 0;</span>
<a href="#l8.783"></a><span id="l8.783" class="difflineplus">+      j = (j &gt;&gt; 8) | ( ((UInt16)block[i-1]) &lt;&lt; 8);</span>
<a href="#l8.784"></a><span id="l8.784" class="difflineplus">+      ftab[j]++;</span>
<a href="#l8.785"></a><span id="l8.785" class="difflineplus">+      quadrant[i-2] = 0;</span>
<a href="#l8.786"></a><span id="l8.786" class="difflineplus">+      j = (j &gt;&gt; 8) | ( ((UInt16)block[i-2]) &lt;&lt; 8);</span>
<a href="#l8.787"></a><span id="l8.787" class="difflineplus">+      ftab[j]++;</span>
<a href="#l8.788"></a><span id="l8.788" class="difflineplus">+      quadrant[i-3] = 0;</span>
<a href="#l8.789"></a><span id="l8.789" class="difflineplus">+      j = (j &gt;&gt; 8) | ( ((UInt16)block[i-3]) &lt;&lt; 8);</span>
<a href="#l8.790"></a><span id="l8.790" class="difflineplus">+      ftab[j]++;</span>
<a href="#l8.791"></a><span id="l8.791" class="difflineplus">+   }</span>
<a href="#l8.792"></a><span id="l8.792" class="difflineplus">+   for (; i &gt;= 0; i--) {</span>
<a href="#l8.793"></a><span id="l8.793" class="difflineplus">+      quadrant[i] = 0;</span>
<a href="#l8.794"></a><span id="l8.794" class="difflineplus">+      j = (j &gt;&gt; 8) | ( ((UInt16)block[i]) &lt;&lt; 8);</span>
<a href="#l8.795"></a><span id="l8.795" class="difflineplus">+      ftab[j]++;</span>
<a href="#l8.796"></a><span id="l8.796" class="difflineplus">+   }</span>
<a href="#l8.797"></a><span id="l8.797" class="difflineplus">+</span>
<a href="#l8.798"></a><span id="l8.798" class="difflineplus">+   /*-- (emphasises close relationship of block &amp; quadrant) --*/</span>
<a href="#l8.799"></a><span id="l8.799" class="difflineplus">+   for (i = 0; i &lt; BZ_N_OVERSHOOT; i++) {</span>
<a href="#l8.800"></a><span id="l8.800" class="difflineplus">+      block   [nblock+i] = block[i];</span>
<a href="#l8.801"></a><span id="l8.801" class="difflineplus">+      quadrant[nblock+i] = 0;</span>
<a href="#l8.802"></a><span id="l8.802" class="difflineplus">+   }</span>
<a href="#l8.803"></a><span id="l8.803" class="difflineplus">+</span>
<a href="#l8.804"></a><span id="l8.804" class="difflineplus">+   if (verb &gt;= 4) VPrintf0 ( &quot;        bucket sorting ...\n&quot; );</span>
<a href="#l8.805"></a><span id="l8.805" class="difflineplus">+</span>
<a href="#l8.806"></a><span id="l8.806" class="difflineplus">+   /*-- Complete the initial radix sort --*/</span>
<a href="#l8.807"></a><span id="l8.807" class="difflineplus">+   for (i = 1; i &lt;= 65536; i++) ftab[i] += ftab[i-1];</span>
<a href="#l8.808"></a><span id="l8.808" class="difflineplus">+</span>
<a href="#l8.809"></a><span id="l8.809" class="difflineplus">+   s = block[0] &lt;&lt; 8;</span>
<a href="#l8.810"></a><span id="l8.810" class="difflineplus">+   i = nblock-1;</span>
<a href="#l8.811"></a><span id="l8.811" class="difflineplus">+   for (; i &gt;= 3; i -= 4) {</span>
<a href="#l8.812"></a><span id="l8.812" class="difflineplus">+      s = (s &gt;&gt; 8) | (block[i] &lt;&lt; 8);</span>
<a href="#l8.813"></a><span id="l8.813" class="difflineplus">+      j = ftab[s] -1;</span>
<a href="#l8.814"></a><span id="l8.814" class="difflineplus">+      ftab[s] = j;</span>
<a href="#l8.815"></a><span id="l8.815" class="difflineplus">+      ptr[j] = i;</span>
<a href="#l8.816"></a><span id="l8.816" class="difflineplus">+      s = (s &gt;&gt; 8) | (block[i-1] &lt;&lt; 8);</span>
<a href="#l8.817"></a><span id="l8.817" class="difflineplus">+      j = ftab[s] -1;</span>
<a href="#l8.818"></a><span id="l8.818" class="difflineplus">+      ftab[s] = j;</span>
<a href="#l8.819"></a><span id="l8.819" class="difflineplus">+      ptr[j] = i-1;</span>
<a href="#l8.820"></a><span id="l8.820" class="difflineplus">+      s = (s &gt;&gt; 8) | (block[i-2] &lt;&lt; 8);</span>
<a href="#l8.821"></a><span id="l8.821" class="difflineplus">+      j = ftab[s] -1;</span>
<a href="#l8.822"></a><span id="l8.822" class="difflineplus">+      ftab[s] = j;</span>
<a href="#l8.823"></a><span id="l8.823" class="difflineplus">+      ptr[j] = i-2;</span>
<a href="#l8.824"></a><span id="l8.824" class="difflineplus">+      s = (s &gt;&gt; 8) | (block[i-3] &lt;&lt; 8);</span>
<a href="#l8.825"></a><span id="l8.825" class="difflineplus">+      j = ftab[s] -1;</span>
<a href="#l8.826"></a><span id="l8.826" class="difflineplus">+      ftab[s] = j;</span>
<a href="#l8.827"></a><span id="l8.827" class="difflineplus">+      ptr[j] = i-3;</span>
<a href="#l8.828"></a><span id="l8.828" class="difflineplus">+   }</span>
<a href="#l8.829"></a><span id="l8.829" class="difflineplus">+   for (; i &gt;= 0; i--) {</span>
<a href="#l8.830"></a><span id="l8.830" class="difflineplus">+      s = (s &gt;&gt; 8) | (block[i] &lt;&lt; 8);</span>
<a href="#l8.831"></a><span id="l8.831" class="difflineplus">+      j = ftab[s] -1;</span>
<a href="#l8.832"></a><span id="l8.832" class="difflineplus">+      ftab[s] = j;</span>
<a href="#l8.833"></a><span id="l8.833" class="difflineplus">+      ptr[j] = i;</span>
<a href="#l8.834"></a><span id="l8.834" class="difflineplus">+   }</span>
<a href="#l8.835"></a><span id="l8.835" class="difflineplus">+</span>
<a href="#l8.836"></a><span id="l8.836" class="difflineplus">+   /*--</span>
<a href="#l8.837"></a><span id="l8.837" class="difflineplus">+      Now ftab contains the first loc of every small bucket.</span>
<a href="#l8.838"></a><span id="l8.838" class="difflineplus">+      Calculate the running order, from smallest to largest</span>
<a href="#l8.839"></a><span id="l8.839" class="difflineplus">+      big bucket.</span>
<a href="#l8.840"></a><span id="l8.840" class="difflineplus">+   --*/</span>
<a href="#l8.841"></a><span id="l8.841" class="difflineplus">+   for (i = 0; i &lt;= 255; i++) {</span>
<a href="#l8.842"></a><span id="l8.842" class="difflineplus">+      bigDone     [i] = False;</span>
<a href="#l8.843"></a><span id="l8.843" class="difflineplus">+      runningOrder[i] = i;</span>
<a href="#l8.844"></a><span id="l8.844" class="difflineplus">+   }</span>
<a href="#l8.845"></a><span id="l8.845" class="difflineplus">+</span>
<a href="#l8.846"></a><span id="l8.846" class="difflineplus">+   {</span>
<a href="#l8.847"></a><span id="l8.847" class="difflineplus">+      Int32 vv;</span>
<a href="#l8.848"></a><span id="l8.848" class="difflineplus">+      Int32 h = 1;</span>
<a href="#l8.849"></a><span id="l8.849" class="difflineplus">+      do h = 3 * h + 1; while (h &lt;= 256);</span>
<a href="#l8.850"></a><span id="l8.850" class="difflineplus">+      do {</span>
<a href="#l8.851"></a><span id="l8.851" class="difflineplus">+         h = h / 3;</span>
<a href="#l8.852"></a><span id="l8.852" class="difflineplus">+         for (i = h; i &lt;= 255; i++) {</span>
<a href="#l8.853"></a><span id="l8.853" class="difflineplus">+            vv = runningOrder[i];</span>
<a href="#l8.854"></a><span id="l8.854" class="difflineplus">+            j = i;</span>
<a href="#l8.855"></a><span id="l8.855" class="difflineplus">+            while ( BIGFREQ(runningOrder[j-h]) &gt; BIGFREQ(vv) ) {</span>
<a href="#l8.856"></a><span id="l8.856" class="difflineplus">+               runningOrder[j] = runningOrder[j-h];</span>
<a href="#l8.857"></a><span id="l8.857" class="difflineplus">+               j = j - h;</span>
<a href="#l8.858"></a><span id="l8.858" class="difflineplus">+               if (j &lt;= (h - 1)) goto zero;</span>
<a href="#l8.859"></a><span id="l8.859" class="difflineplus">+            }</span>
<a href="#l8.860"></a><span id="l8.860" class="difflineplus">+            zero:</span>
<a href="#l8.861"></a><span id="l8.861" class="difflineplus">+            runningOrder[j] = vv;</span>
<a href="#l8.862"></a><span id="l8.862" class="difflineplus">+         }</span>
<a href="#l8.863"></a><span id="l8.863" class="difflineplus">+      } while (h != 1);</span>
<a href="#l8.864"></a><span id="l8.864" class="difflineplus">+   }</span>
<a href="#l8.865"></a><span id="l8.865" class="difflineplus">+</span>
<a href="#l8.866"></a><span id="l8.866" class="difflineplus">+   /*--</span>
<a href="#l8.867"></a><span id="l8.867" class="difflineplus">+      The main sorting loop.</span>
<a href="#l8.868"></a><span id="l8.868" class="difflineplus">+   --*/</span>
<a href="#l8.869"></a><span id="l8.869" class="difflineplus">+</span>
<a href="#l8.870"></a><span id="l8.870" class="difflineplus">+   numQSorted = 0;</span>
<a href="#l8.871"></a><span id="l8.871" class="difflineplus">+</span>
<a href="#l8.872"></a><span id="l8.872" class="difflineplus">+   for (i = 0; i &lt;= 255; i++) {</span>
<a href="#l8.873"></a><span id="l8.873" class="difflineplus">+</span>
<a href="#l8.874"></a><span id="l8.874" class="difflineplus">+      /*--</span>
<a href="#l8.875"></a><span id="l8.875" class="difflineplus">+         Process big buckets, starting with the least full.</span>
<a href="#l8.876"></a><span id="l8.876" class="difflineplus">+         Basically this is a 3-step process in which we call</span>
<a href="#l8.877"></a><span id="l8.877" class="difflineplus">+         mainQSort3 to sort the small buckets [ss, j], but</span>
<a href="#l8.878"></a><span id="l8.878" class="difflineplus">+         also make a big effort to avoid the calls if we can.</span>
<a href="#l8.879"></a><span id="l8.879" class="difflineplus">+      --*/</span>
<a href="#l8.880"></a><span id="l8.880" class="difflineplus">+      ss = runningOrder[i];</span>
<a href="#l8.881"></a><span id="l8.881" class="difflineplus">+</span>
<a href="#l8.882"></a><span id="l8.882" class="difflineplus">+      /*--</span>
<a href="#l8.883"></a><span id="l8.883" class="difflineplus">+         Step 1:</span>
<a href="#l8.884"></a><span id="l8.884" class="difflineplus">+         Complete the big bucket [ss] by quicksorting</span>
<a href="#l8.885"></a><span id="l8.885" class="difflineplus">+         any unsorted small buckets [ss, j], for j != ss.  </span>
<a href="#l8.886"></a><span id="l8.886" class="difflineplus">+         Hopefully previous pointer-scanning phases have already</span>
<a href="#l8.887"></a><span id="l8.887" class="difflineplus">+         completed many of the small buckets [ss, j], so</span>
<a href="#l8.888"></a><span id="l8.888" class="difflineplus">+         we don't have to sort them at all.</span>
<a href="#l8.889"></a><span id="l8.889" class="difflineplus">+      --*/</span>
<a href="#l8.890"></a><span id="l8.890" class="difflineplus">+      for (j = 0; j &lt;= 255; j++) {</span>
<a href="#l8.891"></a><span id="l8.891" class="difflineplus">+         if (j != ss) {</span>
<a href="#l8.892"></a><span id="l8.892" class="difflineplus">+            sb = (ss &lt;&lt; 8) + j;</span>
<a href="#l8.893"></a><span id="l8.893" class="difflineplus">+            if ( ! (ftab[sb] &amp; SETMASK) ) {</span>
<a href="#l8.894"></a><span id="l8.894" class="difflineplus">+               Int32 lo = ftab[sb]   &amp; CLEARMASK;</span>
<a href="#l8.895"></a><span id="l8.895" class="difflineplus">+               Int32 hi = (ftab[sb+1] &amp; CLEARMASK) - 1;</span>
<a href="#l8.896"></a><span id="l8.896" class="difflineplus">+               if (hi &gt; lo) {</span>
<a href="#l8.897"></a><span id="l8.897" class="difflineplus">+                  if (verb &gt;= 4)</span>
<a href="#l8.898"></a><span id="l8.898" class="difflineplus">+                     VPrintf4 ( &quot;        qsort [0x%x, 0x%x]   &quot;</span>
<a href="#l8.899"></a><span id="l8.899" class="difflineplus">+                                &quot;done %d   this %d\n&quot;,</span>
<a href="#l8.900"></a><span id="l8.900" class="difflineplus">+                                ss, j, numQSorted, hi - lo + 1 );</span>
<a href="#l8.901"></a><span id="l8.901" class="difflineplus">+                  mainQSort3 ( </span>
<a href="#l8.902"></a><span id="l8.902" class="difflineplus">+                     ptr, block, quadrant, nblock, </span>
<a href="#l8.903"></a><span id="l8.903" class="difflineplus">+                     lo, hi, BZ_N_RADIX, budget </span>
<a href="#l8.904"></a><span id="l8.904" class="difflineplus">+                  );   </span>
<a href="#l8.905"></a><span id="l8.905" class="difflineplus">+                  numQSorted += (hi - lo + 1);</span>
<a href="#l8.906"></a><span id="l8.906" class="difflineplus">+                  if (*budget &lt; 0) return;</span>
<a href="#l8.907"></a><span id="l8.907" class="difflineplus">+               }</span>
<a href="#l8.908"></a><span id="l8.908" class="difflineplus">+            }</span>
<a href="#l8.909"></a><span id="l8.909" class="difflineplus">+            ftab[sb] |= SETMASK;</span>
<a href="#l8.910"></a><span id="l8.910" class="difflineplus">+         }</span>
<a href="#l8.911"></a><span id="l8.911" class="difflineplus">+      }</span>
<a href="#l8.912"></a><span id="l8.912" class="difflineplus">+</span>
<a href="#l8.913"></a><span id="l8.913" class="difflineplus">+      AssertH ( !bigDone[ss], 1006 );</span>
<a href="#l8.914"></a><span id="l8.914" class="difflineplus">+</span>
<a href="#l8.915"></a><span id="l8.915" class="difflineplus">+      /*--</span>
<a href="#l8.916"></a><span id="l8.916" class="difflineplus">+         Step 2:</span>
<a href="#l8.917"></a><span id="l8.917" class="difflineplus">+         Now scan this big bucket [ss] so as to synthesise the</span>
<a href="#l8.918"></a><span id="l8.918" class="difflineplus">+         sorted order for small buckets [t, ss] for all t,</span>
<a href="#l8.919"></a><span id="l8.919" class="difflineplus">+         including, magically, the bucket [ss,ss] too.</span>
<a href="#l8.920"></a><span id="l8.920" class="difflineplus">+         This will avoid doing Real Work in subsequent Step 1's.</span>
<a href="#l8.921"></a><span id="l8.921" class="difflineplus">+      --*/</span>
<a href="#l8.922"></a><span id="l8.922" class="difflineplus">+      {</span>
<a href="#l8.923"></a><span id="l8.923" class="difflineplus">+         for (j = 0; j &lt;= 255; j++) {</span>
<a href="#l8.924"></a><span id="l8.924" class="difflineplus">+            copyStart[j] =  ftab[(j &lt;&lt; 8) + ss]     &amp; CLEARMASK;</span>
<a href="#l8.925"></a><span id="l8.925" class="difflineplus">+            copyEnd  [j] = (ftab[(j &lt;&lt; 8) + ss + 1] &amp; CLEARMASK) - 1;</span>
<a href="#l8.926"></a><span id="l8.926" class="difflineplus">+         }</span>
<a href="#l8.927"></a><span id="l8.927" class="difflineplus">+         for (j = ftab[ss &lt;&lt; 8] &amp; CLEARMASK; j &lt; copyStart[ss]; j++) {</span>
<a href="#l8.928"></a><span id="l8.928" class="difflineplus">+            k = ptr[j]-1; if (k &lt; 0) k += nblock;</span>
<a href="#l8.929"></a><span id="l8.929" class="difflineplus">+            c1 = block[k];</span>
<a href="#l8.930"></a><span id="l8.930" class="difflineplus">+            if (!bigDone[c1])</span>
<a href="#l8.931"></a><span id="l8.931" class="difflineplus">+               ptr[ copyStart[c1]++ ] = k;</span>
<a href="#l8.932"></a><span id="l8.932" class="difflineplus">+         }</span>
<a href="#l8.933"></a><span id="l8.933" class="difflineplus">+         for (j = (ftab[(ss+1) &lt;&lt; 8] &amp; CLEARMASK) - 1; j &gt; copyEnd[ss]; j--) {</span>
<a href="#l8.934"></a><span id="l8.934" class="difflineplus">+            k = ptr[j]-1; if (k &lt; 0) k += nblock;</span>
<a href="#l8.935"></a><span id="l8.935" class="difflineplus">+            c1 = block[k];</span>
<a href="#l8.936"></a><span id="l8.936" class="difflineplus">+            if (!bigDone[c1]) </span>
<a href="#l8.937"></a><span id="l8.937" class="difflineplus">+               ptr[ copyEnd[c1]-- ] = k;</span>
<a href="#l8.938"></a><span id="l8.938" class="difflineplus">+         }</span>
<a href="#l8.939"></a><span id="l8.939" class="difflineplus">+      }</span>
<a href="#l8.940"></a><span id="l8.940" class="difflineplus">+</span>
<a href="#l8.941"></a><span id="l8.941" class="difflineplus">+      AssertH ( (copyStart[ss]-1 == copyEnd[ss])</span>
<a href="#l8.942"></a><span id="l8.942" class="difflineplus">+                || </span>
<a href="#l8.943"></a><span id="l8.943" class="difflineplus">+                /* Extremely rare case missing in bzip2-1.0.0 and 1.0.1.</span>
<a href="#l8.944"></a><span id="l8.944" class="difflineplus">+                   Necessity for this case is demonstrated by compressing </span>
<a href="#l8.945"></a><span id="l8.945" class="difflineplus">+                   a sequence of approximately 48.5 million of character </span>
<a href="#l8.946"></a><span id="l8.946" class="difflineplus">+                   251; 1.0.0/1.0.1 will then die here. */</span>
<a href="#l8.947"></a><span id="l8.947" class="difflineplus">+                (copyStart[ss] == 0 &amp;&amp; copyEnd[ss] == nblock-1),</span>
<a href="#l8.948"></a><span id="l8.948" class="difflineplus">+                1007 )</span>
<a href="#l8.949"></a><span id="l8.949" class="difflineplus">+</span>
<a href="#l8.950"></a><span id="l8.950" class="difflineplus">+      for (j = 0; j &lt;= 255; j++) ftab[(j &lt;&lt; 8) + ss] |= SETMASK;</span>
<a href="#l8.951"></a><span id="l8.951" class="difflineplus">+</span>
<a href="#l8.952"></a><span id="l8.952" class="difflineplus">+      /*--</span>
<a href="#l8.953"></a><span id="l8.953" class="difflineplus">+         Step 3:</span>
<a href="#l8.954"></a><span id="l8.954" class="difflineplus">+         The [ss] big bucket is now done.  Record this fact,</span>
<a href="#l8.955"></a><span id="l8.955" class="difflineplus">+         and update the quadrant descriptors.  Remember to</span>
<a href="#l8.956"></a><span id="l8.956" class="difflineplus">+         update quadrants in the overshoot area too, if</span>
<a href="#l8.957"></a><span id="l8.957" class="difflineplus">+         necessary.  The &quot;if (i &lt; 255)&quot; test merely skips</span>
<a href="#l8.958"></a><span id="l8.958" class="difflineplus">+         this updating for the last bucket processed, since</span>
<a href="#l8.959"></a><span id="l8.959" class="difflineplus">+         updating for the last bucket is pointless.</span>
<a href="#l8.960"></a><span id="l8.960" class="difflineplus">+</span>
<a href="#l8.961"></a><span id="l8.961" class="difflineplus">+         The quadrant array provides a way to incrementally</span>
<a href="#l8.962"></a><span id="l8.962" class="difflineplus">+         cache sort orderings, as they appear, so as to </span>
<a href="#l8.963"></a><span id="l8.963" class="difflineplus">+         make subsequent comparisons in fullGtU() complete</span>
<a href="#l8.964"></a><span id="l8.964" class="difflineplus">+         faster.  For repetitive blocks this makes a big</span>
<a href="#l8.965"></a><span id="l8.965" class="difflineplus">+         difference (but not big enough to be able to avoid</span>
<a href="#l8.966"></a><span id="l8.966" class="difflineplus">+         the fallback sorting mechanism, exponential radix sort).</span>
<a href="#l8.967"></a><span id="l8.967" class="difflineplus">+</span>
<a href="#l8.968"></a><span id="l8.968" class="difflineplus">+         The precise meaning is: at all times:</span>
<a href="#l8.969"></a><span id="l8.969" class="difflineplus">+</span>
<a href="#l8.970"></a><span id="l8.970" class="difflineplus">+            for 0 &lt;= i &lt; nblock and 0 &lt;= j &lt;= nblock</span>
<a href="#l8.971"></a><span id="l8.971" class="difflineplus">+</span>
<a href="#l8.972"></a><span id="l8.972" class="difflineplus">+            if block[i] != block[j], </span>
<a href="#l8.973"></a><span id="l8.973" class="difflineplus">+</span>
<a href="#l8.974"></a><span id="l8.974" class="difflineplus">+               then the relative values of quadrant[i] and </span>
<a href="#l8.975"></a><span id="l8.975" class="difflineplus">+                    quadrant[j] are meaningless.</span>
<a href="#l8.976"></a><span id="l8.976" class="difflineplus">+</span>
<a href="#l8.977"></a><span id="l8.977" class="difflineplus">+               else {</span>
<a href="#l8.978"></a><span id="l8.978" class="difflineplus">+                  if quadrant[i] &lt; quadrant[j]</span>
<a href="#l8.979"></a><span id="l8.979" class="difflineplus">+                     then the string starting at i lexicographically</span>
<a href="#l8.980"></a><span id="l8.980" class="difflineplus">+                     precedes the string starting at j</span>
<a href="#l8.981"></a><span id="l8.981" class="difflineplus">+</span>
<a href="#l8.982"></a><span id="l8.982" class="difflineplus">+                  else if quadrant[i] &gt; quadrant[j]</span>
<a href="#l8.983"></a><span id="l8.983" class="difflineplus">+                     then the string starting at j lexicographically</span>
<a href="#l8.984"></a><span id="l8.984" class="difflineplus">+                     precedes the string starting at i</span>
<a href="#l8.985"></a><span id="l8.985" class="difflineplus">+</span>
<a href="#l8.986"></a><span id="l8.986" class="difflineplus">+                  else</span>
<a href="#l8.987"></a><span id="l8.987" class="difflineplus">+                     the relative ordering of the strings starting</span>
<a href="#l8.988"></a><span id="l8.988" class="difflineplus">+                     at i and j has not yet been determined.</span>
<a href="#l8.989"></a><span id="l8.989" class="difflineplus">+               }</span>
<a href="#l8.990"></a><span id="l8.990" class="difflineplus">+      --*/</span>
<a href="#l8.991"></a><span id="l8.991" class="difflineplus">+      bigDone[ss] = True;</span>
<a href="#l8.992"></a><span id="l8.992" class="difflineplus">+</span>
<a href="#l8.993"></a><span id="l8.993" class="difflineplus">+      if (i &lt; 255) {</span>
<a href="#l8.994"></a><span id="l8.994" class="difflineplus">+         Int32 bbStart  = ftab[ss &lt;&lt; 8] &amp; CLEARMASK;</span>
<a href="#l8.995"></a><span id="l8.995" class="difflineplus">+         Int32 bbSize   = (ftab[(ss+1) &lt;&lt; 8] &amp; CLEARMASK) - bbStart;</span>
<a href="#l8.996"></a><span id="l8.996" class="difflineplus">+         Int32 shifts   = 0;</span>
<a href="#l8.997"></a><span id="l8.997" class="difflineplus">+</span>
<a href="#l8.998"></a><span id="l8.998" class="difflineplus">+         while ((bbSize &gt;&gt; shifts) &gt; 65534) shifts++;</span>
<a href="#l8.999"></a><span id="l8.999" class="difflineplus">+</span>
<a href="#l8.1000"></a><span id="l8.1000" class="difflineplus">+         for (j = bbSize-1; j &gt;= 0; j--) {</span>
<a href="#l8.1001"></a><span id="l8.1001" class="difflineplus">+            Int32 a2update     = ptr[bbStart + j];</span>
<a href="#l8.1002"></a><span id="l8.1002" class="difflineplus">+            UInt16 qVal        = (UInt16)(j &gt;&gt; shifts);</span>
<a href="#l8.1003"></a><span id="l8.1003" class="difflineplus">+            quadrant[a2update] = qVal;</span>
<a href="#l8.1004"></a><span id="l8.1004" class="difflineplus">+            if (a2update &lt; BZ_N_OVERSHOOT)</span>
<a href="#l8.1005"></a><span id="l8.1005" class="difflineplus">+               quadrant[a2update + nblock] = qVal;</span>
<a href="#l8.1006"></a><span id="l8.1006" class="difflineplus">+         }</span>
<a href="#l8.1007"></a><span id="l8.1007" class="difflineplus">+         AssertH ( ((bbSize-1) &gt;&gt; shifts) &lt;= 65535, 1002 );</span>
<a href="#l8.1008"></a><span id="l8.1008" class="difflineplus">+      }</span>
<a href="#l8.1009"></a><span id="l8.1009" class="difflineplus">+</span>
<a href="#l8.1010"></a><span id="l8.1010" class="difflineplus">+   }</span>
<a href="#l8.1011"></a><span id="l8.1011" class="difflineplus">+</span>
<a href="#l8.1012"></a><span id="l8.1012" class="difflineplus">+   if (verb &gt;= 4)</span>
<a href="#l8.1013"></a><span id="l8.1013" class="difflineplus">+      VPrintf3 ( &quot;        %d pointers, %d sorted, %d scanned\n&quot;,</span>
<a href="#l8.1014"></a><span id="l8.1014" class="difflineplus">+                 nblock, numQSorted, nblock - numQSorted );</span>
<a href="#l8.1015"></a><span id="l8.1015" class="difflineplus">+}</span>
<a href="#l8.1016"></a><span id="l8.1016" class="difflineplus">+</span>
<a href="#l8.1017"></a><span id="l8.1017" class="difflineplus">+#undef BIGFREQ</span>
<a href="#l8.1018"></a><span id="l8.1018" class="difflineplus">+#undef SETMASK</span>
<a href="#l8.1019"></a><span id="l8.1019" class="difflineplus">+#undef CLEARMASK</span>
<a href="#l8.1020"></a><span id="l8.1020" class="difflineplus">+</span>
<a href="#l8.1021"></a><span id="l8.1021" class="difflineplus">+</span>
<a href="#l8.1022"></a><span id="l8.1022" class="difflineplus">+/*---------------------------------------------*/</span>
<a href="#l8.1023"></a><span id="l8.1023" class="difflineplus">+/* Pre:</span>
<a href="#l8.1024"></a><span id="l8.1024" class="difflineplus">+      nblock &gt; 0</span>
<a href="#l8.1025"></a><span id="l8.1025" class="difflineplus">+      arr2 exists for [0 .. nblock-1 +N_OVERSHOOT]</span>
<a href="#l8.1026"></a><span id="l8.1026" class="difflineplus">+      ((UChar*)arr2)  [0 .. nblock-1] holds block</span>
<a href="#l8.1027"></a><span id="l8.1027" class="difflineplus">+      arr1 exists for [0 .. nblock-1]</span>
<a href="#l8.1028"></a><span id="l8.1028" class="difflineplus">+</span>
<a href="#l8.1029"></a><span id="l8.1029" class="difflineplus">+   Post:</span>
<a href="#l8.1030"></a><span id="l8.1030" class="difflineplus">+      ((UChar*)arr2) [0 .. nblock-1] holds block</span>
<a href="#l8.1031"></a><span id="l8.1031" class="difflineplus">+      All other areas of block destroyed</span>
<a href="#l8.1032"></a><span id="l8.1032" class="difflineplus">+      ftab [ 0 .. 65536 ] destroyed</span>
<a href="#l8.1033"></a><span id="l8.1033" class="difflineplus">+      arr1 [0 .. nblock-1] holds sorted order</span>
<a href="#l8.1034"></a><span id="l8.1034" class="difflineplus">+*/</span>
<a href="#l8.1035"></a><span id="l8.1035" class="difflineplus">+void BZ2_blockSort ( EState* s )</span>
<a href="#l8.1036"></a><span id="l8.1036" class="difflineplus">+{</span>
<a href="#l8.1037"></a><span id="l8.1037" class="difflineplus">+   UInt32* ptr    = s-&gt;ptr; </span>
<a href="#l8.1038"></a><span id="l8.1038" class="difflineplus">+   UChar*  block  = s-&gt;block;</span>
<a href="#l8.1039"></a><span id="l8.1039" class="difflineplus">+   UInt32* ftab   = s-&gt;ftab;</span>
<a href="#l8.1040"></a><span id="l8.1040" class="difflineplus">+   Int32   nblock = s-&gt;nblock;</span>
<a href="#l8.1041"></a><span id="l8.1041" class="difflineplus">+   Int32   verb   = s-&gt;verbosity;</span>
<a href="#l8.1042"></a><span id="l8.1042" class="difflineplus">+   Int32   wfact  = s-&gt;workFactor;</span>
<a href="#l8.1043"></a><span id="l8.1043" class="difflineplus">+   UInt16* quadrant;</span>
<a href="#l8.1044"></a><span id="l8.1044" class="difflineplus">+   Int32   budget;</span>
<a href="#l8.1045"></a><span id="l8.1045" class="difflineplus">+   Int32   budgetInit;</span>
<a href="#l8.1046"></a><span id="l8.1046" class="difflineplus">+   Int32   i;</span>
<a href="#l8.1047"></a><span id="l8.1047" class="difflineplus">+</span>
<a href="#l8.1048"></a><span id="l8.1048" class="difflineplus">+   if (nblock &lt; 10000) {</span>
<a href="#l8.1049"></a><span id="l8.1049" class="difflineplus">+      fallbackSort ( s-&gt;arr1, s-&gt;arr2, ftab, nblock, verb );</span>
<a href="#l8.1050"></a><span id="l8.1050" class="difflineplus">+   } else {</span>
<a href="#l8.1051"></a><span id="l8.1051" class="difflineplus">+      /* Calculate the location for quadrant, remembering to get</span>
<a href="#l8.1052"></a><span id="l8.1052" class="difflineplus">+         the alignment right.  Assumes that &amp;(block[0]) is at least</span>
<a href="#l8.1053"></a><span id="l8.1053" class="difflineplus">+         2-byte aligned -- this should be ok since block is really</span>
<a href="#l8.1054"></a><span id="l8.1054" class="difflineplus">+         the first section of arr2.</span>
<a href="#l8.1055"></a><span id="l8.1055" class="difflineplus">+      */</span>
<a href="#l8.1056"></a><span id="l8.1056" class="difflineplus">+      i = nblock+BZ_N_OVERSHOOT;</span>
<a href="#l8.1057"></a><span id="l8.1057" class="difflineplus">+      if (i &amp; 1) i++;</span>
<a href="#l8.1058"></a><span id="l8.1058" class="difflineplus">+      quadrant = (UInt16*)(&amp;(block[i]));</span>
<a href="#l8.1059"></a><span id="l8.1059" class="difflineplus">+</span>
<a href="#l8.1060"></a><span id="l8.1060" class="difflineplus">+      /* (wfact-1) / 3 puts the default-factor-30</span>
<a href="#l8.1061"></a><span id="l8.1061" class="difflineplus">+         transition point at very roughly the same place as </span>
<a href="#l8.1062"></a><span id="l8.1062" class="difflineplus">+         with v0.1 and v0.9.0.  </span>
<a href="#l8.1063"></a><span id="l8.1063" class="difflineplus">+         Not that it particularly matters any more, since the</span>
<a href="#l8.1064"></a><span id="l8.1064" class="difflineplus">+         resulting compressed stream is now the same regardless</span>
<a href="#l8.1065"></a><span id="l8.1065" class="difflineplus">+         of whether or not we use the main sort or fallback sort.</span>
<a href="#l8.1066"></a><span id="l8.1066" class="difflineplus">+      */</span>
<a href="#l8.1067"></a><span id="l8.1067" class="difflineplus">+      if (wfact &lt; 1  ) wfact = 1;</span>
<a href="#l8.1068"></a><span id="l8.1068" class="difflineplus">+      if (wfact &gt; 100) wfact = 100;</span>
<a href="#l8.1069"></a><span id="l8.1069" class="difflineplus">+      budgetInit = nblock * ((wfact-1) / 3);</span>
<a href="#l8.1070"></a><span id="l8.1070" class="difflineplus">+      budget = budgetInit;</span>
<a href="#l8.1071"></a><span id="l8.1071" class="difflineplus">+</span>
<a href="#l8.1072"></a><span id="l8.1072" class="difflineplus">+      mainSort ( ptr, block, quadrant, ftab, nblock, verb, &amp;budget );</span>
<a href="#l8.1073"></a><span id="l8.1073" class="difflineplus">+      if (verb &gt;= 3) </span>
<a href="#l8.1074"></a><span id="l8.1074" class="difflineplus">+         VPrintf3 ( &quot;      %d work, %d block, ratio %5.2f\n&quot;,</span>
<a href="#l8.1075"></a><span id="l8.1075" class="difflineplus">+                    budgetInit - budget,</span>
<a href="#l8.1076"></a><span id="l8.1076" class="difflineplus">+                    nblock, </span>
<a href="#l8.1077"></a><span id="l8.1077" class="difflineplus">+                    (float)(budgetInit - budget) /</span>
<a href="#l8.1078"></a><span id="l8.1078" class="difflineplus">+                    (float)(nblock==0 ? 1 : nblock) ); </span>
<a href="#l8.1079"></a><span id="l8.1079" class="difflineplus">+      if (budget &lt; 0) {</span>
<a href="#l8.1080"></a><span id="l8.1080" class="difflineplus">+         if (verb &gt;= 2) </span>
<a href="#l8.1081"></a><span id="l8.1081" class="difflineplus">+            VPrintf0 ( &quot;    too repetitive; using fallback&quot;</span>
<a href="#l8.1082"></a><span id="l8.1082" class="difflineplus">+                       &quot; sorting algorithm\n&quot; );</span>
<a href="#l8.1083"></a><span id="l8.1083" class="difflineplus">+         fallbackSort ( s-&gt;arr1, s-&gt;arr2, ftab, nblock, verb );</span>
<a href="#l8.1084"></a><span id="l8.1084" class="difflineplus">+      }</span>
<a href="#l8.1085"></a><span id="l8.1085" class="difflineplus">+   }</span>
<a href="#l8.1086"></a><span id="l8.1086" class="difflineplus">+</span>
<a href="#l8.1087"></a><span id="l8.1087" class="difflineplus">+   s-&gt;origPtr = -1;</span>
<a href="#l8.1088"></a><span id="l8.1088" class="difflineplus">+   for (i = 0; i &lt; s-&gt;nblock; i++)</span>
<a href="#l8.1089"></a><span id="l8.1089" class="difflineplus">+      if (ptr[i] == 0)</span>
<a href="#l8.1090"></a><span id="l8.1090" class="difflineplus">+         { s-&gt;origPtr = i; break; };</span>
<a href="#l8.1091"></a><span id="l8.1091" class="difflineplus">+</span>
<a href="#l8.1092"></a><span id="l8.1092" class="difflineplus">+   AssertH( s-&gt;origPtr != -1, 1003 );</span>
<a href="#l8.1093"></a><span id="l8.1093" class="difflineplus">+}</span>
<a href="#l8.1094"></a><span id="l8.1094" class="difflineplus">+</span>
<a href="#l8.1095"></a><span id="l8.1095" class="difflineplus">+</span>
<a href="#l8.1096"></a><span id="l8.1096" class="difflineplus">+/*-------------------------------------------------------------*/</span>
<a href="#l8.1097"></a><span id="l8.1097" class="difflineplus">+/*--- end                                       blocksort.c ---*/</span>
<a href="#l8.1098"></a><span id="l8.1098" class="difflineplus">+/*-------------------------------------------------------------*/</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1">new file mode 100644</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineminus">--- /dev/null</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineplus">+++ b/third_party/bzip2/bzlib.c</span>
<a href="#l9.4"></a><span id="l9.4" class="difflineat">@@ -0,0 +1,1572 @@</span>
<a href="#l9.5"></a><span id="l9.5" class="difflineplus">+</span>
<a href="#l9.6"></a><span id="l9.6" class="difflineplus">+/*-------------------------------------------------------------*/</span>
<a href="#l9.7"></a><span id="l9.7" class="difflineplus">+/*--- Library top-level functions.                          ---*/</span>
<a href="#l9.8"></a><span id="l9.8" class="difflineplus">+/*---                                               bzlib.c ---*/</span>
<a href="#l9.9"></a><span id="l9.9" class="difflineplus">+/*-------------------------------------------------------------*/</span>
<a href="#l9.10"></a><span id="l9.10" class="difflineplus">+</span>
<a href="#l9.11"></a><span id="l9.11" class="difflineplus">+/* ------------------------------------------------------------------</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+   This file is part of bzip2/libbzip2, a program and library for</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+   lossless, block-sorting data compression.</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+   bzip2/libbzip2 version 1.0.8 of 13 July 2019</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+   Copyright (C) 1996-2019 Julian Seward &lt;jseward@acm.org&gt;</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineplus">+   Please read the WARNING, DISCLAIMER and PATENTS sections in the </span>
<a href="#l9.19"></a><span id="l9.19" class="difflineplus">+   README file.</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineplus">+</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineplus">+   This program is released under the terms of the license contained</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineplus">+   in the file LICENSE.</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineplus">+   ------------------------------------------------------------------ */</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineplus">+</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineplus">+/* CHANGES</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineplus">+   0.9.0    -- original version.</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineplus">+   0.9.0a/b -- no changes in this file.</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineplus">+   0.9.0c   -- made zero-length BZ_FLUSH work correctly in bzCompress().</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineplus">+     fixed bzWrite/bzRead to ignore zero-length requests.</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineplus">+     fixed bzread to correctly handle read requests after EOF.</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineplus">+     wrong parameter order in call to bzDecompressInit in</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineplus">+     bzBuffToBuffDecompress.  Fixed.</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineplus">+*/</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineplus">+</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineplus">+#include &quot;bzlib_private.h&quot;</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineplus">+</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineplus">+</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineplus">+/*---------------------------------------------------*/</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineplus">+/*--- Compression stuff                           ---*/</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineplus">+/*---------------------------------------------------*/</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineplus">+</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineplus">+</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineplus">+/*---------------------------------------------------*/</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineplus">+#ifndef BZ_NO_STDIO</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineplus">+void BZ2_bz__AssertH__fail ( int errcode )</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineplus">+{</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineplus">+   fprintf(stderr, </span>
<a href="#l9.48"></a><span id="l9.48" class="difflineplus">+      &quot;\n\nbzip2/libbzip2: internal error number %d.\n&quot;</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineplus">+      &quot;This is a bug in bzip2/libbzip2, %s.\n&quot;</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineplus">+      &quot;Please report it to: bzip2-devel@sourceware.org.  If this happened\n&quot;</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineplus">+      &quot;when you were using some program which uses libbzip2 as a\n&quot;</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineplus">+      &quot;component, you should also report this bug to the author(s)\n&quot;</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineplus">+      &quot;of that program.  Please make an effort to report this bug;\n&quot;</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineplus">+      &quot;timely and accurate bug reports eventually lead to higher\n&quot;</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineplus">+      &quot;quality software.  Thanks.\n\n&quot;,</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineplus">+      errcode,</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineplus">+      BZ2_bzlibVersion()</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineplus">+   );</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineplus">+</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineplus">+   if (errcode == 1007) {</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineplus">+   fprintf(stderr,</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineplus">+      &quot;\n*** A special note about internal error number 1007 ***\n&quot;</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineplus">+      &quot;\n&quot;</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineplus">+      &quot;Experience suggests that a common cause of i.e. 1007\n&quot;</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineplus">+      &quot;is unreliable memory or other hardware.  The 1007 assertion\n&quot;</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineplus">+      &quot;just happens to cross-check the results of huge numbers of\n&quot;</span>
<a href="#l9.67"></a><span id="l9.67" class="difflineplus">+      &quot;memory reads/writes, and so acts (unintendedly) as a stress\n&quot;</span>
<a href="#l9.68"></a><span id="l9.68" class="difflineplus">+      &quot;test of your memory system.\n&quot;</span>
<a href="#l9.69"></a><span id="l9.69" class="difflineplus">+      &quot;\n&quot;</span>
<a href="#l9.70"></a><span id="l9.70" class="difflineplus">+      &quot;I suggest the following: try compressing the file again,\n&quot;</span>
<a href="#l9.71"></a><span id="l9.71" class="difflineplus">+      &quot;possibly monitoring progress in detail with the -vv flag.\n&quot;</span>
<a href="#l9.72"></a><span id="l9.72" class="difflineplus">+      &quot;\n&quot;</span>
<a href="#l9.73"></a><span id="l9.73" class="difflineplus">+      &quot;* If the error cannot be reproduced, and/or happens at different\n&quot;</span>
<a href="#l9.74"></a><span id="l9.74" class="difflineplus">+      &quot;  points in compression, you may have a flaky memory system.\n&quot;</span>
<a href="#l9.75"></a><span id="l9.75" class="difflineplus">+      &quot;  Try a memory-test program.  I have used Memtest86\n&quot;</span>
<a href="#l9.76"></a><span id="l9.76" class="difflineplus">+      &quot;  (www.memtest86.com).  At the time of writing it is free (GPLd).\n&quot;</span>
<a href="#l9.77"></a><span id="l9.77" class="difflineplus">+      &quot;  Memtest86 tests memory much more thorougly than your BIOSs\n&quot;</span>
<a href="#l9.78"></a><span id="l9.78" class="difflineplus">+      &quot;  power-on test, and may find failures that the BIOS doesn't.\n&quot;</span>
<a href="#l9.79"></a><span id="l9.79" class="difflineplus">+      &quot;\n&quot;</span>
<a href="#l9.80"></a><span id="l9.80" class="difflineplus">+      &quot;* If the error can be repeatably reproduced, this is a bug in\n&quot;</span>
<a href="#l9.81"></a><span id="l9.81" class="difflineplus">+      &quot;  bzip2, and I would very much like to hear about it.  Please\n&quot;</span>
<a href="#l9.82"></a><span id="l9.82" class="difflineplus">+      &quot;  let me know, and, ideally, save a copy of the file causing the\n&quot;</span>
<a href="#l9.83"></a><span id="l9.83" class="difflineplus">+      &quot;  problem -- without which I will be unable to investigate it.\n&quot;</span>
<a href="#l9.84"></a><span id="l9.84" class="difflineplus">+      &quot;\n&quot;</span>
<a href="#l9.85"></a><span id="l9.85" class="difflineplus">+   );</span>
<a href="#l9.86"></a><span id="l9.86" class="difflineplus">+   }</span>
<a href="#l9.87"></a><span id="l9.87" class="difflineplus">+</span>
<a href="#l9.88"></a><span id="l9.88" class="difflineplus">+   exit(3);</span>
<a href="#l9.89"></a><span id="l9.89" class="difflineplus">+}</span>
<a href="#l9.90"></a><span id="l9.90" class="difflineplus">+#endif</span>
<a href="#l9.91"></a><span id="l9.91" class="difflineplus">+</span>
<a href="#l9.92"></a><span id="l9.92" class="difflineplus">+</span>
<a href="#l9.93"></a><span id="l9.93" class="difflineplus">+/*---------------------------------------------------*/</span>
<a href="#l9.94"></a><span id="l9.94" class="difflineplus">+static</span>
<a href="#l9.95"></a><span id="l9.95" class="difflineplus">+int bz_config_ok ( void )</span>
<a href="#l9.96"></a><span id="l9.96" class="difflineplus">+{</span>
<a href="#l9.97"></a><span id="l9.97" class="difflineplus">+   if (sizeof(int)   != 4) return 0;</span>
<a href="#l9.98"></a><span id="l9.98" class="difflineplus">+   if (sizeof(short) != 2) return 0;</span>
<a href="#l9.99"></a><span id="l9.99" class="difflineplus">+   if (sizeof(char)  != 1) return 0;</span>
<a href="#l9.100"></a><span id="l9.100" class="difflineplus">+   return 1;</span>
<a href="#l9.101"></a><span id="l9.101" class="difflineplus">+}</span>
<a href="#l9.102"></a><span id="l9.102" class="difflineplus">+</span>
<a href="#l9.103"></a><span id="l9.103" class="difflineplus">+</span>
<a href="#l9.104"></a><span id="l9.104" class="difflineplus">+/*---------------------------------------------------*/</span>
<a href="#l9.105"></a><span id="l9.105" class="difflineplus">+static</span>
<a href="#l9.106"></a><span id="l9.106" class="difflineplus">+void* default_bzalloc ( void* opaque, Int32 items, Int32 size )</span>
<a href="#l9.107"></a><span id="l9.107" class="difflineplus">+{</span>
<a href="#l9.108"></a><span id="l9.108" class="difflineplus">+   void* v = malloc ( items * size );</span>
<a href="#l9.109"></a><span id="l9.109" class="difflineplus">+   return v;</span>
<a href="#l9.110"></a><span id="l9.110" class="difflineplus">+}</span>
<a href="#l9.111"></a><span id="l9.111" class="difflineplus">+</span>
<a href="#l9.112"></a><span id="l9.112" class="difflineplus">+static</span>
<a href="#l9.113"></a><span id="l9.113" class="difflineplus">+void default_bzfree ( void* opaque, void* addr )</span>
<a href="#l9.114"></a><span id="l9.114" class="difflineplus">+{</span>
<a href="#l9.115"></a><span id="l9.115" class="difflineplus">+   if (addr != NULL) free ( addr );</span>
<a href="#l9.116"></a><span id="l9.116" class="difflineplus">+}</span>
<a href="#l9.117"></a><span id="l9.117" class="difflineplus">+</span>
<a href="#l9.118"></a><span id="l9.118" class="difflineplus">+</span>
<a href="#l9.119"></a><span id="l9.119" class="difflineplus">+/*---------------------------------------------------*/</span>
<a href="#l9.120"></a><span id="l9.120" class="difflineplus">+static</span>
<a href="#l9.121"></a><span id="l9.121" class="difflineplus">+void prepare_new_block ( EState* s )</span>
<a href="#l9.122"></a><span id="l9.122" class="difflineplus">+{</span>
<a href="#l9.123"></a><span id="l9.123" class="difflineplus">+   Int32 i;</span>
<a href="#l9.124"></a><span id="l9.124" class="difflineplus">+   s-&gt;nblock = 0;</span>
<a href="#l9.125"></a><span id="l9.125" class="difflineplus">+   s-&gt;numZ = 0;</span>
<a href="#l9.126"></a><span id="l9.126" class="difflineplus">+   s-&gt;state_out_pos = 0;</span>
<a href="#l9.127"></a><span id="l9.127" class="difflineplus">+   BZ_INITIALISE_CRC ( s-&gt;blockCRC );</span>
<a href="#l9.128"></a><span id="l9.128" class="difflineplus">+   for (i = 0; i &lt; 256; i++) s-&gt;inUse[i] = False;</span>
<a href="#l9.129"></a><span id="l9.129" class="difflineplus">+   s-&gt;blockNo++;</span>
<a href="#l9.130"></a><span id="l9.130" class="difflineplus">+}</span>
<a href="#l9.131"></a><span id="l9.131" class="difflineplus">+</span>
<a href="#l9.132"></a><span id="l9.132" class="difflineplus">+</span>
<a href="#l9.133"></a><span id="l9.133" class="difflineplus">+/*---------------------------------------------------*/</span>
<a href="#l9.134"></a><span id="l9.134" class="difflineplus">+static</span>
<a href="#l9.135"></a><span id="l9.135" class="difflineplus">+void init_RL ( EState* s )</span>
<a href="#l9.136"></a><span id="l9.136" class="difflineplus">+{</span>
<a href="#l9.137"></a><span id="l9.137" class="difflineplus">+   s-&gt;state_in_ch  = 256;</span>
<a href="#l9.138"></a><span id="l9.138" class="difflineplus">+   s-&gt;state_in_len = 0;</span>
<a href="#l9.139"></a><span id="l9.139" class="difflineplus">+}</span>
<a href="#l9.140"></a><span id="l9.140" class="difflineplus">+</span>
<a href="#l9.141"></a><span id="l9.141" class="difflineplus">+</span>
<a href="#l9.142"></a><span id="l9.142" class="difflineplus">+static</span>
<a href="#l9.143"></a><span id="l9.143" class="difflineplus">+Bool isempty_RL ( EState* s )</span>
<a href="#l9.144"></a><span id="l9.144" class="difflineplus">+{</span>
<a href="#l9.145"></a><span id="l9.145" class="difflineplus">+   if (s-&gt;state_in_ch &lt; 256 &amp;&amp; s-&gt;state_in_len &gt; 0)</span>
<a href="#l9.146"></a><span id="l9.146" class="difflineplus">+      return False; else</span>
<a href="#l9.147"></a><span id="l9.147" class="difflineplus">+      return True;</span>
<a href="#l9.148"></a><span id="l9.148" class="difflineplus">+}</span>
<a href="#l9.149"></a><span id="l9.149" class="difflineplus">+</span>
<a href="#l9.150"></a><span id="l9.150" class="difflineplus">+</span>
<a href="#l9.151"></a><span id="l9.151" class="difflineplus">+/*---------------------------------------------------*/</span>
<a href="#l9.152"></a><span id="l9.152" class="difflineplus">+int BZ_API(BZ2_bzCompressInit) </span>
<a href="#l9.153"></a><span id="l9.153" class="difflineplus">+                    ( bz_stream* strm, </span>
<a href="#l9.154"></a><span id="l9.154" class="difflineplus">+                     int        blockSize100k,</span>
<a href="#l9.155"></a><span id="l9.155" class="difflineplus">+                     int        verbosity,</span>
<a href="#l9.156"></a><span id="l9.156" class="difflineplus">+                     int        workFactor )</span>
<a href="#l9.157"></a><span id="l9.157" class="difflineplus">+{</span>
<a href="#l9.158"></a><span id="l9.158" class="difflineplus">+   Int32   n;</span>
<a href="#l9.159"></a><span id="l9.159" class="difflineplus">+   EState* s;</span>
<a href="#l9.160"></a><span id="l9.160" class="difflineplus">+</span>
<a href="#l9.161"></a><span id="l9.161" class="difflineplus">+   if (!bz_config_ok()) return BZ_CONFIG_ERROR;</span>
<a href="#l9.162"></a><span id="l9.162" class="difflineplus">+</span>
<a href="#l9.163"></a><span id="l9.163" class="difflineplus">+   if (strm == NULL || </span>
<a href="#l9.164"></a><span id="l9.164" class="difflineplus">+       blockSize100k &lt; 1 || blockSize100k &gt; 9 ||</span>
<a href="#l9.165"></a><span id="l9.165" class="difflineplus">+       workFactor &lt; 0 || workFactor &gt; 250)</span>
<a href="#l9.166"></a><span id="l9.166" class="difflineplus">+     return BZ_PARAM_ERROR;</span>
<a href="#l9.167"></a><span id="l9.167" class="difflineplus">+</span>
<a href="#l9.168"></a><span id="l9.168" class="difflineplus">+   if (workFactor == 0) workFactor = 30;</span>
<a href="#l9.169"></a><span id="l9.169" class="difflineplus">+   if (strm-&gt;bzalloc == NULL) strm-&gt;bzalloc = default_bzalloc;</span>
<a href="#l9.170"></a><span id="l9.170" class="difflineplus">+   if (strm-&gt;bzfree == NULL) strm-&gt;bzfree = default_bzfree;</span>
<a href="#l9.171"></a><span id="l9.171" class="difflineplus">+</span>
<a href="#l9.172"></a><span id="l9.172" class="difflineplus">+   s = BZALLOC( sizeof(EState) );</span>
<a href="#l9.173"></a><span id="l9.173" class="difflineplus">+   if (s == NULL) return BZ_MEM_ERROR;</span>
<a href="#l9.174"></a><span id="l9.174" class="difflineplus">+   s-&gt;strm = strm;</span>
<a href="#l9.175"></a><span id="l9.175" class="difflineplus">+</span>
<a href="#l9.176"></a><span id="l9.176" class="difflineplus">+   s-&gt;arr1 = NULL;</span>
<a href="#l9.177"></a><span id="l9.177" class="difflineplus">+   s-&gt;arr2 = NULL;</span>
<a href="#l9.178"></a><span id="l9.178" class="difflineplus">+   s-&gt;ftab = NULL;</span>
<a href="#l9.179"></a><span id="l9.179" class="difflineplus">+</span>
<a href="#l9.180"></a><span id="l9.180" class="difflineplus">+   n       = 100000 * blockSize100k;</span>
<a href="#l9.181"></a><span id="l9.181" class="difflineplus">+   s-&gt;arr1 = BZALLOC( n                  * sizeof(UInt32) );</span>
<a href="#l9.182"></a><span id="l9.182" class="difflineplus">+   s-&gt;arr2 = BZALLOC( (n+BZ_N_OVERSHOOT) * sizeof(UInt32) );</span>
<a href="#l9.183"></a><span id="l9.183" class="difflineplus">+   s-&gt;ftab = BZALLOC( 65537              * sizeof(UInt32) );</span>
<a href="#l9.184"></a><span id="l9.184" class="difflineplus">+</span>
<a href="#l9.185"></a><span id="l9.185" class="difflineplus">+   if (s-&gt;arr1 == NULL || s-&gt;arr2 == NULL || s-&gt;ftab == NULL) {</span>
<a href="#l9.186"></a><span id="l9.186" class="difflineplus">+      if (s-&gt;arr1 != NULL) BZFREE(s-&gt;arr1);</span>
<a href="#l9.187"></a><span id="l9.187" class="difflineplus">+      if (s-&gt;arr2 != NULL) BZFREE(s-&gt;arr2);</span>
<a href="#l9.188"></a><span id="l9.188" class="difflineplus">+      if (s-&gt;ftab != NULL) BZFREE(s-&gt;ftab);</span>
<a href="#l9.189"></a><span id="l9.189" class="difflineplus">+      if (s       != NULL) BZFREE(s);</span>
<a href="#l9.190"></a><span id="l9.190" class="difflineplus">+      return BZ_MEM_ERROR;</span>
<a href="#l9.191"></a><span id="l9.191" class="difflineplus">+   }</span>
<a href="#l9.192"></a><span id="l9.192" class="difflineplus">+</span>
<a href="#l9.193"></a><span id="l9.193" class="difflineplus">+   s-&gt;blockNo           = 0;</span>
<a href="#l9.194"></a><span id="l9.194" class="difflineplus">+   s-&gt;state             = BZ_S_INPUT;</span>
<a href="#l9.195"></a><span id="l9.195" class="difflineplus">+   s-&gt;mode              = BZ_M_RUNNING;</span>
<a href="#l9.196"></a><span id="l9.196" class="difflineplus">+   s-&gt;combinedCRC       = 0;</span>
<a href="#l9.197"></a><span id="l9.197" class="difflineplus">+   s-&gt;blockSize100k     = blockSize100k;</span>
<a href="#l9.198"></a><span id="l9.198" class="difflineplus">+   s-&gt;nblockMAX         = 100000 * blockSize100k - 19;</span>
<a href="#l9.199"></a><span id="l9.199" class="difflineplus">+   s-&gt;verbosity         = verbosity;</span>
<a href="#l9.200"></a><span id="l9.200" class="difflineplus">+   s-&gt;workFactor        = workFactor;</span>
<a href="#l9.201"></a><span id="l9.201" class="difflineplus">+</span>
<a href="#l9.202"></a><span id="l9.202" class="difflineplus">+   s-&gt;block             = (UChar*)s-&gt;arr2;</span>
<a href="#l9.203"></a><span id="l9.203" class="difflineplus">+   s-&gt;mtfv              = (UInt16*)s-&gt;arr1;</span>
<a href="#l9.204"></a><span id="l9.204" class="difflineplus">+   s-&gt;zbits             = NULL;</span>
<a href="#l9.205"></a><span id="l9.205" class="difflineplus">+   s-&gt;ptr               = (UInt32*)s-&gt;arr1;</span>
<a href="#l9.206"></a><span id="l9.206" class="difflineplus">+</span>
<a href="#l9.207"></a><span id="l9.207" class="difflineplus">+   strm-&gt;state          = s;</span>
<a href="#l9.208"></a><span id="l9.208" class="difflineplus">+   strm-&gt;total_in_lo32  = 0;</span>
<a href="#l9.209"></a><span id="l9.209" class="difflineplus">+   strm-&gt;total_in_hi32  = 0;</span>
<a href="#l9.210"></a><span id="l9.210" class="difflineplus">+   strm-&gt;total_out_lo32 = 0;</span>
<a href="#l9.211"></a><span id="l9.211" class="difflineplus">+   strm-&gt;total_out_hi32 = 0;</span>
<a href="#l9.212"></a><span id="l9.212" class="difflineplus">+   init_RL ( s );</span>
<a href="#l9.213"></a><span id="l9.213" class="difflineplus">+   prepare_new_block ( s );</span>
<a href="#l9.214"></a><span id="l9.214" class="difflineplus">+   return BZ_OK;</span>
<a href="#l9.215"></a><span id="l9.215" class="difflineplus">+}</span>
<a href="#l9.216"></a><span id="l9.216" class="difflineplus">+</span>
<a href="#l9.217"></a><span id="l9.217" class="difflineplus">+</span>
<a href="#l9.218"></a><span id="l9.218" class="difflineplus">+/*---------------------------------------------------*/</span>
<a href="#l9.219"></a><span id="l9.219" class="difflineplus">+static</span>
<a href="#l9.220"></a><span id="l9.220" class="difflineplus">+void add_pair_to_block ( EState* s )</span>
<a href="#l9.221"></a><span id="l9.221" class="difflineplus">+{</span>
<a href="#l9.222"></a><span id="l9.222" class="difflineplus">+   Int32 i;</span>
<a href="#l9.223"></a><span id="l9.223" class="difflineplus">+   UChar ch = (UChar)(s-&gt;state_in_ch);</span>
<a href="#l9.224"></a><span id="l9.224" class="difflineplus">+   for (i = 0; i &lt; s-&gt;state_in_len; i++) {</span>
<a href="#l9.225"></a><span id="l9.225" class="difflineplus">+      BZ_UPDATE_CRC( s-&gt;blockCRC, ch );</span>
<a href="#l9.226"></a><span id="l9.226" class="difflineplus">+   }</span>
<a href="#l9.227"></a><span id="l9.227" class="difflineplus">+   s-&gt;inUse[s-&gt;state_in_ch] = True;</span>
<a href="#l9.228"></a><span id="l9.228" class="difflineplus">+   switch (s-&gt;state_in_len) {</span>
<a href="#l9.229"></a><span id="l9.229" class="difflineplus">+      case 1:</span>
<a href="#l9.230"></a><span id="l9.230" class="difflineplus">+         s-&gt;block[s-&gt;nblock] = (UChar)ch; s-&gt;nblock++;</span>
<a href="#l9.231"></a><span id="l9.231" class="difflineplus">+         break;</span>
<a href="#l9.232"></a><span id="l9.232" class="difflineplus">+      case 2:</span>
<a href="#l9.233"></a><span id="l9.233" class="difflineplus">+         s-&gt;block[s-&gt;nblock] = (UChar)ch; s-&gt;nblock++;</span>
<a href="#l9.234"></a><span id="l9.234" class="difflineplus">+         s-&gt;block[s-&gt;nblock] = (UChar)ch; s-&gt;nblock++;</span>
<a href="#l9.235"></a><span id="l9.235" class="difflineplus">+         break;</span>
<a href="#l9.236"></a><span id="l9.236" class="difflineplus">+      case 3:</span>
<a href="#l9.237"></a><span id="l9.237" class="difflineplus">+         s-&gt;block[s-&gt;nblock] = (UChar)ch; s-&gt;nblock++;</span>
<a href="#l9.238"></a><span id="l9.238" class="difflineplus">+         s-&gt;block[s-&gt;nblock] = (UChar)ch; s-&gt;nblock++;</span>
<a href="#l9.239"></a><span id="l9.239" class="difflineplus">+         s-&gt;block[s-&gt;nblock] = (UChar)ch; s-&gt;nblock++;</span>
<a href="#l9.240"></a><span id="l9.240" class="difflineplus">+         break;</span>
<a href="#l9.241"></a><span id="l9.241" class="difflineplus">+      default:</span>
<a href="#l9.242"></a><span id="l9.242" class="difflineplus">+         s-&gt;inUse[s-&gt;state_in_len-4] = True;</span>
<a href="#l9.243"></a><span id="l9.243" class="difflineplus">+         s-&gt;block[s-&gt;nblock] = (UChar)ch; s-&gt;nblock++;</span>
<a href="#l9.244"></a><span id="l9.244" class="difflineplus">+         s-&gt;block[s-&gt;nblock] = (UChar)ch; s-&gt;nblock++;</span>
<a href="#l9.245"></a><span id="l9.245" class="difflineplus">+         s-&gt;block[s-&gt;nblock] = (UChar)ch; s-&gt;nblock++;</span>
<a href="#l9.246"></a><span id="l9.246" class="difflineplus">+         s-&gt;block[s-&gt;nblock] = (UChar)ch; s-&gt;nblock++;</span>
<a href="#l9.247"></a><span id="l9.247" class="difflineplus">+         s-&gt;block[s-&gt;nblock] = ((UChar)(s-&gt;state_in_len-4));</span>
<a href="#l9.248"></a><span id="l9.248" class="difflineplus">+         s-&gt;nblock++;</span>
<a href="#l9.249"></a><span id="l9.249" class="difflineplus">+         break;</span>
<a href="#l9.250"></a><span id="l9.250" class="difflineplus">+   }</span>
<a href="#l9.251"></a><span id="l9.251" class="difflineplus">+}</span>
<a href="#l9.252"></a><span id="l9.252" class="difflineplus">+</span>
<a href="#l9.253"></a><span id="l9.253" class="difflineplus">+</span>
<a href="#l9.254"></a><span id="l9.254" class="difflineplus">+/*---------------------------------------------------*/</span>
<a href="#l9.255"></a><span id="l9.255" class="difflineplus">+static</span>
<a href="#l9.256"></a><span id="l9.256" class="difflineplus">+void flush_RL ( EState* s )</span>
<a href="#l9.257"></a><span id="l9.257" class="difflineplus">+{</span>
<a href="#l9.258"></a><span id="l9.258" class="difflineplus">+   if (s-&gt;state_in_ch &lt; 256) add_pair_to_block ( s );</span>
<a href="#l9.259"></a><span id="l9.259" class="difflineplus">+   init_RL ( s );</span>
<a href="#l9.260"></a><span id="l9.260" class="difflineplus">+}</span>
<a href="#l9.261"></a><span id="l9.261" class="difflineplus">+</span>
<a href="#l9.262"></a><span id="l9.262" class="difflineplus">+</span>
<a href="#l9.263"></a><span id="l9.263" class="difflineplus">+/*---------------------------------------------------*/</span>
<a href="#l9.264"></a><span id="l9.264" class="difflineplus">+#define ADD_CHAR_TO_BLOCK(zs,zchh0)               \</span>
<a href="#l9.265"></a><span id="l9.265" class="difflineplus">+{                                                 \</span>
<a href="#l9.266"></a><span id="l9.266" class="difflineplus">+   UInt32 zchh = (UInt32)(zchh0);                 \</span>
<a href="#l9.267"></a><span id="l9.267" class="difflineplus">+   /*-- fast track the common case --*/           \</span>
<a href="#l9.268"></a><span id="l9.268" class="difflineplus">+   if (zchh != zs-&gt;state_in_ch &amp;&amp;                 \</span>
<a href="#l9.269"></a><span id="l9.269" class="difflineplus">+       zs-&gt;state_in_len == 1) {                   \</span>
<a href="#l9.270"></a><span id="l9.270" class="difflineplus">+      UChar ch = (UChar)(zs-&gt;state_in_ch);        \</span>
<a href="#l9.271"></a><span id="l9.271" class="difflineplus">+      BZ_UPDATE_CRC( zs-&gt;blockCRC, ch );          \</span>
<a href="#l9.272"></a><span id="l9.272" class="difflineplus">+      zs-&gt;inUse[zs-&gt;state_in_ch] = True;          \</span>
<a href="#l9.273"></a><span id="l9.273" class="difflineplus">+      zs-&gt;block[zs-&gt;nblock] = (UChar)ch;          \</span>
<a href="#l9.274"></a><span id="l9.274" class="difflineplus">+      zs-&gt;nblock++;                               \</span>
<a href="#l9.275"></a><span id="l9.275" class="difflineplus">+      zs-&gt;state_in_ch = zchh;                     \</span>
<a href="#l9.276"></a><span id="l9.276" class="difflineplus">+   }                                              \</span>
<a href="#l9.277"></a><span id="l9.277" class="difflineplus">+   else                                           \</span>
<a href="#l9.278"></a><span id="l9.278" class="difflineplus">+   /*-- general, uncommon cases --*/              \</span>
<a href="#l9.279"></a><span id="l9.279" class="difflineplus">+   if (zchh != zs-&gt;state_in_ch ||                 \</span>
<a href="#l9.280"></a><span id="l9.280" class="difflineplus">+      zs-&gt;state_in_len == 255) {                  \</span>
<a href="#l9.281"></a><span id="l9.281" class="difflineplus">+      if (zs-&gt;state_in_ch &lt; 256)                  \</span>
<a href="#l9.282"></a><span id="l9.282" class="difflineplus">+         add_pair_to_block ( zs );                \</span>
<a href="#l9.283"></a><span id="l9.283" class="difflineplus">+      zs-&gt;state_in_ch = zchh;                     \</span>
<a href="#l9.284"></a><span id="l9.284" class="difflineplus">+      zs-&gt;state_in_len = 1;                       \</span>
<a href="#l9.285"></a><span id="l9.285" class="difflineplus">+   } else {                                       \</span>
<a href="#l9.286"></a><span id="l9.286" class="difflineplus">+      zs-&gt;state_in_len++;                         \</span>
<a href="#l9.287"></a><span id="l9.287" class="difflineplus">+   }                                              \</span>
<a href="#l9.288"></a><span id="l9.288" class="difflineplus">+}</span>
<a href="#l9.289"></a><span id="l9.289" class="difflineplus">+</span>
<a href="#l9.290"></a><span id="l9.290" class="difflineplus">+</span>
<a href="#l9.291"></a><span id="l9.291" class="difflineplus">+/*---------------------------------------------------*/</span>
<a href="#l9.292"></a><span id="l9.292" class="difflineplus">+static</span>
<a href="#l9.293"></a><span id="l9.293" class="difflineplus">+Bool copy_input_until_stop ( EState* s )</span>
<a href="#l9.294"></a><span id="l9.294" class="difflineplus">+{</span>
<a href="#l9.295"></a><span id="l9.295" class="difflineplus">+   Bool progress_in = False;</span>
<a href="#l9.296"></a><span id="l9.296" class="difflineplus">+</span>
<a href="#l9.297"></a><span id="l9.297" class="difflineplus">+   if (s-&gt;mode == BZ_M_RUNNING) {</span>
<a href="#l9.298"></a><span id="l9.298" class="difflineplus">+</span>
<a href="#l9.299"></a><span id="l9.299" class="difflineplus">+      /*-- fast track the common case --*/</span>
<a href="#l9.300"></a><span id="l9.300" class="difflineplus">+      while (True) {</span>
<a href="#l9.301"></a><span id="l9.301" class="difflineplus">+         /*-- block full? --*/</span>
<a href="#l9.302"></a><span id="l9.302" class="difflineplus">+         if (s-&gt;nblock &gt;= s-&gt;nblockMAX) break;</span>
<a href="#l9.303"></a><span id="l9.303" class="difflineplus">+         /*-- no input? --*/</span>
<a href="#l9.304"></a><span id="l9.304" class="difflineplus">+         if (s-&gt;strm-&gt;avail_in == 0) break;</span>
<a href="#l9.305"></a><span id="l9.305" class="difflineplus">+         progress_in = True;</span>
<a href="#l9.306"></a><span id="l9.306" class="difflineplus">+         ADD_CHAR_TO_BLOCK ( s, (UInt32)(*((UChar*)(s-&gt;strm-&gt;next_in))) ); </span>
<a href="#l9.307"></a><span id="l9.307" class="difflineplus">+         s-&gt;strm-&gt;next_in++;</span>
<a href="#l9.308"></a><span id="l9.308" class="difflineplus">+         s-&gt;strm-&gt;avail_in--;</span>
<a href="#l9.309"></a><span id="l9.309" class="difflineplus">+         s-&gt;strm-&gt;total_in_lo32++;</span>
<a href="#l9.310"></a><span id="l9.310" class="difflineplus">+         if (s-&gt;strm-&gt;total_in_lo32 == 0) s-&gt;strm-&gt;total_in_hi32++;</span>
<a href="#l9.311"></a><span id="l9.311" class="difflineplus">+      }</span>
<a href="#l9.312"></a><span id="l9.312" class="difflineplus">+</span>
<a href="#l9.313"></a><span id="l9.313" class="difflineplus">+   } else {</span>
<a href="#l9.314"></a><span id="l9.314" class="difflineplus">+</span>
<a href="#l9.315"></a><span id="l9.315" class="difflineplus">+      /*-- general, uncommon case --*/</span>
<a href="#l9.316"></a><span id="l9.316" class="difflineplus">+      while (True) {</span>
<a href="#l9.317"></a><span id="l9.317" class="difflineplus">+         /*-- block full? --*/</span>
<a href="#l9.318"></a><span id="l9.318" class="difflineplus">+         if (s-&gt;nblock &gt;= s-&gt;nblockMAX) break;</span>
<a href="#l9.319"></a><span id="l9.319" class="difflineplus">+         /*-- no input? --*/</span>
<a href="#l9.320"></a><span id="l9.320" class="difflineplus">+         if (s-&gt;strm-&gt;avail_in == 0) break;</span>
<a href="#l9.321"></a><span id="l9.321" class="difflineplus">+         /*-- flush/finish end? --*/</span>
<a href="#l9.322"></a><span id="l9.322" class="difflineplus">+         if (s-&gt;avail_in_expect == 0) break;</span>
<a href="#l9.323"></a><span id="l9.323" class="difflineplus">+         progress_in = True;</span>
<a href="#l9.324"></a><span id="l9.324" class="difflineplus">+         ADD_CHAR_TO_BLOCK ( s, (UInt32)(*((UChar*)(s-&gt;strm-&gt;next_in))) ); </span>
<a href="#l9.325"></a><span id="l9.325" class="difflineplus">+         s-&gt;strm-&gt;next_in++;</span>
<a href="#l9.326"></a><span id="l9.326" class="difflineplus">+         s-&gt;strm-&gt;avail_in--;</span>
<a href="#l9.327"></a><span id="l9.327" class="difflineplus">+         s-&gt;strm-&gt;total_in_lo32++;</span>
<a href="#l9.328"></a><span id="l9.328" class="difflineplus">+         if (s-&gt;strm-&gt;total_in_lo32 == 0) s-&gt;strm-&gt;total_in_hi32++;</span>
<a href="#l9.329"></a><span id="l9.329" class="difflineplus">+         s-&gt;avail_in_expect--;</span>
<a href="#l9.330"></a><span id="l9.330" class="difflineplus">+      }</span>
<a href="#l9.331"></a><span id="l9.331" class="difflineplus">+   }</span>
<a href="#l9.332"></a><span id="l9.332" class="difflineplus">+   return progress_in;</span>
<a href="#l9.333"></a><span id="l9.333" class="difflineplus">+}</span>
<a href="#l9.334"></a><span id="l9.334" class="difflineplus">+</span>
<a href="#l9.335"></a><span id="l9.335" class="difflineplus">+</span>
<a href="#l9.336"></a><span id="l9.336" class="difflineplus">+/*---------------------------------------------------*/</span>
<a href="#l9.337"></a><span id="l9.337" class="difflineplus">+static</span>
<a href="#l9.338"></a><span id="l9.338" class="difflineplus">+Bool copy_output_until_stop ( EState* s )</span>
<a href="#l9.339"></a><span id="l9.339" class="difflineplus">+{</span>
<a href="#l9.340"></a><span id="l9.340" class="difflineplus">+   Bool progress_out = False;</span>
<a href="#l9.341"></a><span id="l9.341" class="difflineplus">+</span>
<a href="#l9.342"></a><span id="l9.342" class="difflineplus">+   while (True) {</span>
<a href="#l9.343"></a><span id="l9.343" class="difflineplus">+</span>
<a href="#l9.344"></a><span id="l9.344" class="difflineplus">+      /*-- no output space? --*/</span>
<a href="#l9.345"></a><span id="l9.345" class="difflineplus">+      if (s-&gt;strm-&gt;avail_out == 0) break;</span>
<a href="#l9.346"></a><span id="l9.346" class="difflineplus">+</span>
<a href="#l9.347"></a><span id="l9.347" class="difflineplus">+      /*-- block done? --*/</span>
<a href="#l9.348"></a><span id="l9.348" class="difflineplus">+      if (s-&gt;state_out_pos &gt;= s-&gt;numZ) break;</span>
<a href="#l9.349"></a><span id="l9.349" class="difflineplus">+</span>
<a href="#l9.350"></a><span id="l9.350" class="difflineplus">+      progress_out = True;</span>
<a href="#l9.351"></a><span id="l9.351" class="difflineplus">+      *(s-&gt;strm-&gt;next_out) = s-&gt;zbits[s-&gt;state_out_pos];</span>
<a href="#l9.352"></a><span id="l9.352" class="difflineplus">+      s-&gt;state_out_pos++;</span>
<a href="#l9.353"></a><span id="l9.353" class="difflineplus">+      s-&gt;strm-&gt;avail_out--;</span>
<a href="#l9.354"></a><span id="l9.354" class="difflineplus">+      s-&gt;strm-&gt;next_out++;</span>
<a href="#l9.355"></a><span id="l9.355" class="difflineplus">+      s-&gt;strm-&gt;total_out_lo32++;</span>
<a href="#l9.356"></a><span id="l9.356" class="difflineplus">+      if (s-&gt;strm-&gt;total_out_lo32 == 0) s-&gt;strm-&gt;total_out_hi32++;</span>
<a href="#l9.357"></a><span id="l9.357" class="difflineplus">+   }</span>
<a href="#l9.358"></a><span id="l9.358" class="difflineplus">+</span>
<a href="#l9.359"></a><span id="l9.359" class="difflineplus">+   return progress_out;</span>
<a href="#l9.360"></a><span id="l9.360" class="difflineplus">+}</span>
<a href="#l9.361"></a><span id="l9.361" class="difflineplus">+</span>
<a href="#l9.362"></a><span id="l9.362" class="difflineplus">+</span>
<a href="#l9.363"></a><span id="l9.363" class="difflineplus">+/*---------------------------------------------------*/</span>
<a href="#l9.364"></a><span id="l9.364" class="difflineplus">+static</span>
<a href="#l9.365"></a><span id="l9.365" class="difflineplus">+Bool handle_compress ( bz_stream* strm )</span>
<a href="#l9.366"></a><span id="l9.366" class="difflineplus">+{</span>
<a href="#l9.367"></a><span id="l9.367" class="difflineplus">+   Bool progress_in  = False;</span>
<a href="#l9.368"></a><span id="l9.368" class="difflineplus">+   Bool progress_out = False;</span>
<a href="#l9.369"></a><span id="l9.369" class="difflineplus">+   EState* s = strm-&gt;state;</span>
<a href="#l9.370"></a><span id="l9.370" class="difflineplus">+   </span>
<a href="#l9.371"></a><span id="l9.371" class="difflineplus">+   while (True) {</span>
<a href="#l9.372"></a><span id="l9.372" class="difflineplus">+</span>
<a href="#l9.373"></a><span id="l9.373" class="difflineplus">+      if (s-&gt;state == BZ_S_OUTPUT) {</span>
<a href="#l9.374"></a><span id="l9.374" class="difflineplus">+         progress_out |= copy_output_until_stop ( s );</span>
<a href="#l9.375"></a><span id="l9.375" class="difflineplus">+         if (s-&gt;state_out_pos &lt; s-&gt;numZ) break;</span>
<a href="#l9.376"></a><span id="l9.376" class="difflineplus">+         if (s-&gt;mode == BZ_M_FINISHING &amp;&amp; </span>
<a href="#l9.377"></a><span id="l9.377" class="difflineplus">+             s-&gt;avail_in_expect == 0 &amp;&amp;</span>
<a href="#l9.378"></a><span id="l9.378" class="difflineplus">+             isempty_RL(s)) break;</span>
<a href="#l9.379"></a><span id="l9.379" class="difflineplus">+         prepare_new_block ( s );</span>
<a href="#l9.380"></a><span id="l9.380" class="difflineplus">+         s-&gt;state = BZ_S_INPUT;</span>
<a href="#l9.381"></a><span id="l9.381" class="difflineplus">+         if (s-&gt;mode == BZ_M_FLUSHING &amp;&amp; </span>
<a href="#l9.382"></a><span id="l9.382" class="difflineplus">+             s-&gt;avail_in_expect == 0 &amp;&amp;</span>
<a href="#l9.383"></a><span id="l9.383" class="difflineplus">+             isempty_RL(s)) break;</span>
<a href="#l9.384"></a><span id="l9.384" class="difflineplus">+      }</span>
<a href="#l9.385"></a><span id="l9.385" class="difflineplus">+</span>
<a href="#l9.386"></a><span id="l9.386" class="difflineplus">+      if (s-&gt;state == BZ_S_INPUT) {</span>
<a href="#l9.387"></a><span id="l9.387" class="difflineplus">+         progress_in |= copy_input_until_stop ( s );</span>
<a href="#l9.388"></a><span id="l9.388" class="difflineplus">+         if (s-&gt;mode != BZ_M_RUNNING &amp;&amp; s-&gt;avail_in_expect == 0) {</span>
<a href="#l9.389"></a><span id="l9.389" class="difflineplus">+            flush_RL ( s );</span>
<a href="#l9.390"></a><span id="l9.390" class="difflineplus">+            BZ2_compressBlock ( s, (Bool)(s-&gt;mode == BZ_M_FINISHING) );</span>
<a href="#l9.391"></a><span id="l9.391" class="difflineplus">+            s-&gt;state = BZ_S_OUTPUT;</span>
<a href="#l9.392"></a><span id="l9.392" class="difflineplus">+         }</span>
<a href="#l9.393"></a><span id="l9.393" class="difflineplus">+         else</span>
<a href="#l9.394"></a><span id="l9.394" class="difflineplus">+         if (s-&gt;nblock &gt;= s-&gt;nblockMAX) {</span>
<a href="#l9.395"></a><span id="l9.395" class="difflineplus">+            BZ2_compressBlock ( s, False );</span>
<a href="#l9.396"></a><span id="l9.396" class="difflineplus">+            s-&gt;state = BZ_S_OUTPUT;</span>
<a href="#l9.397"></a><span id="l9.397" class="difflineplus">+         }</span>
<a href="#l9.398"></a><span id="l9.398" class="difflineplus">+         else</span>
<a href="#l9.399"></a><span id="l9.399" class="difflineplus">+         if (s-&gt;strm-&gt;avail_in == 0) {</span>
<a href="#l9.400"></a><span id="l9.400" class="difflineplus">+            break;</span>
<a href="#l9.401"></a><span id="l9.401" class="difflineplus">+         }</span>
<a href="#l9.402"></a><span id="l9.402" class="difflineplus">+      }</span>
<a href="#l9.403"></a><span id="l9.403" class="difflineplus">+</span>
<a href="#l9.404"></a><span id="l9.404" class="difflineplus">+   }</span>
<a href="#l9.405"></a><span id="l9.405" class="difflineplus">+</span>
<a href="#l9.406"></a><span id="l9.406" class="difflineplus">+   return progress_in || progress_out;</span>
<a href="#l9.407"></a><span id="l9.407" class="difflineplus">+}</span>
<a href="#l9.408"></a><span id="l9.408" class="difflineplus">+</span>
<a href="#l9.409"></a><span id="l9.409" class="difflineplus">+</span>
<a href="#l9.410"></a><span id="l9.410" class="difflineplus">+/*---------------------------------------------------*/</span>
<a href="#l9.411"></a><span id="l9.411" class="difflineplus">+int BZ_API(BZ2_bzCompress) ( bz_stream *strm, int action )</span>
<a href="#l9.412"></a><span id="l9.412" class="difflineplus">+{</span>
<a href="#l9.413"></a><span id="l9.413" class="difflineplus">+   Bool progress;</span>
<a href="#l9.414"></a><span id="l9.414" class="difflineplus">+   EState* s;</span>
<a href="#l9.415"></a><span id="l9.415" class="difflineplus">+   if (strm == NULL) return BZ_PARAM_ERROR;</span>
<a href="#l9.416"></a><span id="l9.416" class="difflineplus">+   s = strm-&gt;state;</span>
<a href="#l9.417"></a><span id="l9.417" class="difflineplus">+   if (s == NULL) return BZ_PARAM_ERROR;</span>
<a href="#l9.418"></a><span id="l9.418" class="difflineplus">+   if (s-&gt;strm != strm) return BZ_PARAM_ERROR;</span>
<a href="#l9.419"></a><span id="l9.419" class="difflineplus">+</span>
<a href="#l9.420"></a><span id="l9.420" class="difflineplus">+   preswitch:</span>
<a href="#l9.421"></a><span id="l9.421" class="difflineplus">+   switch (s-&gt;mode) {</span>
<a href="#l9.422"></a><span id="l9.422" class="difflineplus">+</span>
<a href="#l9.423"></a><span id="l9.423" class="difflineplus">+      case BZ_M_IDLE:</span>
<a href="#l9.424"></a><span id="l9.424" class="difflineplus">+         return BZ_SEQUENCE_ERROR;</span>
<a href="#l9.425"></a><span id="l9.425" class="difflineplus">+</span>
<a href="#l9.426"></a><span id="l9.426" class="difflineplus">+      case BZ_M_RUNNING:</span>
<a href="#l9.427"></a><span id="l9.427" class="difflineplus">+         if (action == BZ_RUN) {</span>
<a href="#l9.428"></a><span id="l9.428" class="difflineplus">+            progress = handle_compress ( strm );</span>
<a href="#l9.429"></a><span id="l9.429" class="difflineplus">+            return progress ? BZ_RUN_OK : BZ_PARAM_ERROR;</span>
<a href="#l9.430"></a><span id="l9.430" class="difflineplus">+         } </span>
<a href="#l9.431"></a><span id="l9.431" class="difflineplus">+         else</span>
<a href="#l9.432"></a><span id="l9.432" class="difflineplus">+	 if (action == BZ_FLUSH) {</span>
<a href="#l9.433"></a><span id="l9.433" class="difflineplus">+            s-&gt;avail_in_expect = strm-&gt;avail_in;</span>
<a href="#l9.434"></a><span id="l9.434" class="difflineplus">+            s-&gt;mode = BZ_M_FLUSHING;</span>
<a href="#l9.435"></a><span id="l9.435" class="difflineplus">+            goto preswitch;</span>
<a href="#l9.436"></a><span id="l9.436" class="difflineplus">+         }</span>
<a href="#l9.437"></a><span id="l9.437" class="difflineplus">+         else</span>
<a href="#l9.438"></a><span id="l9.438" class="difflineplus">+         if (action == BZ_FINISH) {</span>
<a href="#l9.439"></a><span id="l9.439" class="difflineplus">+            s-&gt;avail_in_expect = strm-&gt;avail_in;</span>
<a href="#l9.440"></a><span id="l9.440" class="difflineplus">+            s-&gt;mode = BZ_M_FINISHING;</span>
<a href="#l9.441"></a><span id="l9.441" class="difflineplus">+            goto preswitch;</span>
<a href="#l9.442"></a><span id="l9.442" class="difflineplus">+         }</span>
<a href="#l9.443"></a><span id="l9.443" class="difflineplus">+         else </span>
<a href="#l9.444"></a><span id="l9.444" class="difflineplus">+            return BZ_PARAM_ERROR;</span>
<a href="#l9.445"></a><span id="l9.445" class="difflineplus">+</span>
<a href="#l9.446"></a><span id="l9.446" class="difflineplus">+      case BZ_M_FLUSHING:</span>
<a href="#l9.447"></a><span id="l9.447" class="difflineplus">+         if (action != BZ_FLUSH) return BZ_SEQUENCE_ERROR;</span>
<a href="#l9.448"></a><span id="l9.448" class="difflineplus">+         if (s-&gt;avail_in_expect != s-&gt;strm-&gt;avail_in) </span>
<a href="#l9.449"></a><span id="l9.449" class="difflineplus">+            return BZ_SEQUENCE_ERROR;</span>
<a href="#l9.450"></a><span id="l9.450" class="difflineplus">+         progress = handle_compress ( strm );</span>
<a href="#l9.451"></a><span id="l9.451" class="difflineplus">+         if (s-&gt;avail_in_expect &gt; 0 || !isempty_RL(s) ||</span>
<a href="#l9.452"></a><span id="l9.452" class="difflineplus">+             s-&gt;state_out_pos &lt; s-&gt;numZ) return BZ_FLUSH_OK;</span>
<a href="#l9.453"></a><span id="l9.453" class="difflineplus">+         s-&gt;mode = BZ_M_RUNNING;</span>
<a href="#l9.454"></a><span id="l9.454" class="difflineplus">+         return BZ_RUN_OK;</span>
<a href="#l9.455"></a><span id="l9.455" class="difflineplus">+</span>
<a href="#l9.456"></a><span id="l9.456" class="difflineplus">+      case BZ_M_FINISHING:</span>
<a href="#l9.457"></a><span id="l9.457" class="difflineplus">+         if (action != BZ_FINISH) return BZ_SEQUENCE_ERROR;</span>
<a href="#l9.458"></a><span id="l9.458" class="difflineplus">+         if (s-&gt;avail_in_expect != s-&gt;strm-&gt;avail_in) </span>
<a href="#l9.459"></a><span id="l9.459" class="difflineplus">+            return BZ_SEQUENCE_ERROR;</span>
<a href="#l9.460"></a><span id="l9.460" class="difflineplus">+         progress = handle_compress ( strm );</span>
<a href="#l9.461"></a><span id="l9.461" class="difflineplus">+         if (!progress) return BZ_SEQUENCE_ERROR;</span>
<a href="#l9.462"></a><span id="l9.462" class="difflineplus">+         if (s-&gt;avail_in_expect &gt; 0 || !isempty_RL(s) ||</span>
<a href="#l9.463"></a><span id="l9.463" class="difflineplus">+             s-&gt;state_out_pos &lt; s-&gt;numZ) return BZ_FINISH_OK;</span>
<a href="#l9.464"></a><span id="l9.464" class="difflineplus">+         s-&gt;mode = BZ_M_IDLE;</span>
<a href="#l9.465"></a><span id="l9.465" class="difflineplus">+         return BZ_STREAM_END;</span>
<a href="#l9.466"></a><span id="l9.466" class="difflineplus">+   }</span>
<a href="#l9.467"></a><span id="l9.467" class="difflineplus">+   return BZ_OK; /*--not reached--*/</span>
<a href="#l9.468"></a><span id="l9.468" class="difflineplus">+}</span>
<a href="#l9.469"></a><span id="l9.469" class="difflineplus">+</span>
<a href="#l9.470"></a><span id="l9.470" class="difflineplus">+</span>
<a href="#l9.471"></a><span id="l9.471" class="difflineplus">+/*---------------------------------------------------*/</span>
<a href="#l9.472"></a><span id="l9.472" class="difflineplus">+int BZ_API(BZ2_bzCompressEnd)  ( bz_stream *strm )</span>
<a href="#l9.473"></a><span id="l9.473" class="difflineplus">+{</span>
<a href="#l9.474"></a><span id="l9.474" class="difflineplus">+   EState* s;</span>
<a href="#l9.475"></a><span id="l9.475" class="difflineplus">+   if (strm == NULL) return BZ_PARAM_ERROR;</span>
<a href="#l9.476"></a><span id="l9.476" class="difflineplus">+   s = strm-&gt;state;</span>
<a href="#l9.477"></a><span id="l9.477" class="difflineplus">+   if (s == NULL) return BZ_PARAM_ERROR;</span>
<a href="#l9.478"></a><span id="l9.478" class="difflineplus">+   if (s-&gt;strm != strm) return BZ_PARAM_ERROR;</span>
<a href="#l9.479"></a><span id="l9.479" class="difflineplus">+</span>
<a href="#l9.480"></a><span id="l9.480" class="difflineplus">+   if (s-&gt;arr1 != NULL) BZFREE(s-&gt;arr1);</span>
<a href="#l9.481"></a><span id="l9.481" class="difflineplus">+   if (s-&gt;arr2 != NULL) BZFREE(s-&gt;arr2);</span>
<a href="#l9.482"></a><span id="l9.482" class="difflineplus">+   if (s-&gt;ftab != NULL) BZFREE(s-&gt;ftab);</span>
<a href="#l9.483"></a><span id="l9.483" class="difflineplus">+   BZFREE(strm-&gt;state);</span>
<a href="#l9.484"></a><span id="l9.484" class="difflineplus">+</span>
<a href="#l9.485"></a><span id="l9.485" class="difflineplus">+   strm-&gt;state = NULL;   </span>
<a href="#l9.486"></a><span id="l9.486" class="difflineplus">+</span>
<a href="#l9.487"></a><span id="l9.487" class="difflineplus">+   return BZ_OK;</span>
<a href="#l9.488"></a><span id="l9.488" class="difflineplus">+}</span>
<a href="#l9.489"></a><span id="l9.489" class="difflineplus">+</span>
<a href="#l9.490"></a><span id="l9.490" class="difflineplus">+</span>
<a href="#l9.491"></a><span id="l9.491" class="difflineplus">+/*---------------------------------------------------*/</span>
<a href="#l9.492"></a><span id="l9.492" class="difflineplus">+/*--- Decompression stuff                         ---*/</span>
<a href="#l9.493"></a><span id="l9.493" class="difflineplus">+/*---------------------------------------------------*/</span>
<a href="#l9.494"></a><span id="l9.494" class="difflineplus">+</span>
<a href="#l9.495"></a><span id="l9.495" class="difflineplus">+/*---------------------------------------------------*/</span>
<a href="#l9.496"></a><span id="l9.496" class="difflineplus">+int BZ_API(BZ2_bzDecompressInit) </span>
<a href="#l9.497"></a><span id="l9.497" class="difflineplus">+                     ( bz_stream* strm, </span>
<a href="#l9.498"></a><span id="l9.498" class="difflineplus">+                       int        verbosity,</span>
<a href="#l9.499"></a><span id="l9.499" class="difflineplus">+                       int        small )</span>
<a href="#l9.500"></a><span id="l9.500" class="difflineplus">+{</span>
<a href="#l9.501"></a><span id="l9.501" class="difflineplus">+   DState* s;</span>
<a href="#l9.502"></a><span id="l9.502" class="difflineplus">+</span>
<a href="#l9.503"></a><span id="l9.503" class="difflineplus">+   if (!bz_config_ok()) return BZ_CONFIG_ERROR;</span>
<a href="#l9.504"></a><span id="l9.504" class="difflineplus">+</span>
<a href="#l9.505"></a><span id="l9.505" class="difflineplus">+   if (strm == NULL) return BZ_PARAM_ERROR;</span>
<a href="#l9.506"></a><span id="l9.506" class="difflineplus">+   if (small != 0 &amp;&amp; small != 1) return BZ_PARAM_ERROR;</span>
<a href="#l9.507"></a><span id="l9.507" class="difflineplus">+   if (verbosity &lt; 0 || verbosity &gt; 4) return BZ_PARAM_ERROR;</span>
<a href="#l9.508"></a><span id="l9.508" class="difflineplus">+</span>
<a href="#l9.509"></a><span id="l9.509" class="difflineplus">+   if (strm-&gt;bzalloc == NULL) strm-&gt;bzalloc = default_bzalloc;</span>
<a href="#l9.510"></a><span id="l9.510" class="difflineplus">+   if (strm-&gt;bzfree == NULL) strm-&gt;bzfree = default_bzfree;</span>
<a href="#l9.511"></a><span id="l9.511" class="difflineplus">+</span>
<a href="#l9.512"></a><span id="l9.512" class="difflineplus">+   s = BZALLOC( sizeof(DState) );</span>
<a href="#l9.513"></a><span id="l9.513" class="difflineplus">+   if (s == NULL) return BZ_MEM_ERROR;</span>
<a href="#l9.514"></a><span id="l9.514" class="difflineplus">+   s-&gt;strm                  = strm;</span>
<a href="#l9.515"></a><span id="l9.515" class="difflineplus">+   strm-&gt;state              = s;</span>
<a href="#l9.516"></a><span id="l9.516" class="difflineplus">+   s-&gt;state                 = BZ_X_MAGIC_1;</span>
<a href="#l9.517"></a><span id="l9.517" class="difflineplus">+   s-&gt;bsLive                = 0;</span>
<a href="#l9.518"></a><span id="l9.518" class="difflineplus">+   s-&gt;bsBuff                = 0;</span>
<a href="#l9.519"></a><span id="l9.519" class="difflineplus">+   s-&gt;calculatedCombinedCRC = 0;</span>
<a href="#l9.520"></a><span id="l9.520" class="difflineplus">+   strm-&gt;total_in_lo32      = 0;</span>
<a href="#l9.521"></a><span id="l9.521" class="difflineplus">+   strm-&gt;total_in_hi32      = 0;</span>
<a href="#l9.522"></a><span id="l9.522" class="difflineplus">+   strm-&gt;total_out_lo32     = 0;</span>
<a href="#l9.523"></a><span id="l9.523" class="difflineplus">+   strm-&gt;total_out_hi32     = 0;</span>
<a href="#l9.524"></a><span id="l9.524" class="difflineplus">+   s-&gt;smallDecompress       = (Bool)small;</span>
<a href="#l9.525"></a><span id="l9.525" class="difflineplus">+   s-&gt;ll4                   = NULL;</span>
<a href="#l9.526"></a><span id="l9.526" class="difflineplus">+   s-&gt;ll16                  = NULL;</span>
<a href="#l9.527"></a><span id="l9.527" class="difflineplus">+   s-&gt;tt                    = NULL;</span>
<a href="#l9.528"></a><span id="l9.528" class="difflineplus">+   s-&gt;currBlockNo           = 0;</span>
<a href="#l9.529"></a><span id="l9.529" class="difflineplus">+   s-&gt;verbosity             = verbosity;</span>
<a href="#l9.530"></a><span id="l9.530" class="difflineplus">+</span>
<a href="#l9.531"></a><span id="l9.531" class="difflineplus">+   return BZ_OK;</span>
<a href="#l9.532"></a><span id="l9.532" class="difflineplus">+}</span>
<a href="#l9.533"></a><span id="l9.533" class="difflineplus">+</span>
<a href="#l9.534"></a><span id="l9.534" class="difflineplus">+</span>
<a href="#l9.535"></a><span id="l9.535" class="difflineplus">+/*---------------------------------------------------*/</span>
<a href="#l9.536"></a><span id="l9.536" class="difflineplus">+/* Return  True iff data corruption is discovered.</span>
<a href="#l9.537"></a><span id="l9.537" class="difflineplus">+   Returns False if there is no problem.</span>
<a href="#l9.538"></a><span id="l9.538" class="difflineplus">+*/</span>
<a href="#l9.539"></a><span id="l9.539" class="difflineplus">+static</span>
<a href="#l9.540"></a><span id="l9.540" class="difflineplus">+Bool unRLE_obuf_to_output_FAST ( DState* s )</span>
<a href="#l9.541"></a><span id="l9.541" class="difflineplus">+{</span>
<a href="#l9.542"></a><span id="l9.542" class="difflineplus">+   UChar k1;</span>
<a href="#l9.543"></a><span id="l9.543" class="difflineplus">+</span>
<a href="#l9.544"></a><span id="l9.544" class="difflineplus">+   if (s-&gt;blockRandomised) {</span>
<a href="#l9.545"></a><span id="l9.545" class="difflineplus">+</span>
<a href="#l9.546"></a><span id="l9.546" class="difflineplus">+      while (True) {</span>
<a href="#l9.547"></a><span id="l9.547" class="difflineplus">+         /* try to finish existing run */</span>
<a href="#l9.548"></a><span id="l9.548" class="difflineplus">+         while (True) {</span>
<a href="#l9.549"></a><span id="l9.549" class="difflineplus">+            if (s-&gt;strm-&gt;avail_out == 0) return False;</span>
<a href="#l9.550"></a><span id="l9.550" class="difflineplus">+            if (s-&gt;state_out_len == 0) break;</span>
<a href="#l9.551"></a><span id="l9.551" class="difflineplus">+            *( (UChar*)(s-&gt;strm-&gt;next_out) ) = s-&gt;state_out_ch;</span>
<a href="#l9.552"></a><span id="l9.552" class="difflineplus">+            BZ_UPDATE_CRC ( s-&gt;calculatedBlockCRC, s-&gt;state_out_ch );</span>
<a href="#l9.553"></a><span id="l9.553" class="difflineplus">+            s-&gt;state_out_len--;</span>
<a href="#l9.554"></a><span id="l9.554" class="difflineplus">+            s-&gt;strm-&gt;next_out++;</span>
<a href="#l9.555"></a><span id="l9.555" class="difflineplus">+            s-&gt;strm-&gt;avail_out--;</span>
<a href="#l9.556"></a><span id="l9.556" class="difflineplus">+            s-&gt;strm-&gt;total_out_lo32++;</span>
<a href="#l9.557"></a><span id="l9.557" class="difflineplus">+            if (s-&gt;strm-&gt;total_out_lo32 == 0) s-&gt;strm-&gt;total_out_hi32++;</span>
<a href="#l9.558"></a><span id="l9.558" class="difflineplus">+         }</span>
<a href="#l9.559"></a><span id="l9.559" class="difflineplus">+</span>
<a href="#l9.560"></a><span id="l9.560" class="difflineplus">+         /* can a new run be started? */</span>
<a href="#l9.561"></a><span id="l9.561" class="difflineplus">+         if (s-&gt;nblock_used == s-&gt;save_nblock+1) return False;</span>
<a href="#l9.562"></a><span id="l9.562" class="difflineplus">+               </span>
<a href="#l9.563"></a><span id="l9.563" class="difflineplus">+         /* Only caused by corrupt data stream? */</span>
<a href="#l9.564"></a><span id="l9.564" class="difflineplus">+         if (s-&gt;nblock_used &gt; s-&gt;save_nblock+1)</span>
<a href="#l9.565"></a><span id="l9.565" class="difflineplus">+            return True;</span>
<a href="#l9.566"></a><span id="l9.566" class="difflineplus">+   </span>
<a href="#l9.567"></a><span id="l9.567" class="difflineplus">+         s-&gt;state_out_len = 1;</span>
<a href="#l9.568"></a><span id="l9.568" class="difflineplus">+         s-&gt;state_out_ch = s-&gt;k0;</span>
<a href="#l9.569"></a><span id="l9.569" class="difflineplus">+         BZ_GET_FAST(k1); BZ_RAND_UPD_MASK; </span>
<a href="#l9.570"></a><span id="l9.570" class="difflineplus">+         k1 ^= BZ_RAND_MASK; s-&gt;nblock_used++;</span>
<a href="#l9.571"></a><span id="l9.571" class="difflineplus">+         if (s-&gt;nblock_used == s-&gt;save_nblock+1) continue;</span>
<a href="#l9.572"></a><span id="l9.572" class="difflineplus">+         if (k1 != s-&gt;k0) { s-&gt;k0 = k1; continue; };</span>
<a href="#l9.573"></a><span id="l9.573" class="difflineplus">+   </span>
<a href="#l9.574"></a><span id="l9.574" class="difflineplus">+         s-&gt;state_out_len = 2;</span>
<a href="#l9.575"></a><span id="l9.575" class="difflineplus">+         BZ_GET_FAST(k1); BZ_RAND_UPD_MASK; </span>
<a href="#l9.576"></a><span id="l9.576" class="difflineplus">+         k1 ^= BZ_RAND_MASK; s-&gt;nblock_used++;</span>
<a href="#l9.577"></a><span id="l9.577" class="difflineplus">+         if (s-&gt;nblock_used == s-&gt;save_nblock+1) continue;</span>
<a href="#l9.578"></a><span id="l9.578" class="difflineplus">+         if (k1 != s-&gt;k0) { s-&gt;k0 = k1; continue; };</span>
<a href="#l9.579"></a><span id="l9.579" class="difflineplus">+   </span>
<a href="#l9.580"></a><span id="l9.580" class="difflineplus">+         s-&gt;state_out_len = 3;</span>
<a href="#l9.581"></a><span id="l9.581" class="difflineplus">+         BZ_GET_FAST(k1); BZ_RAND_UPD_MASK; </span>
<a href="#l9.582"></a><span id="l9.582" class="difflineplus">+         k1 ^= BZ_RAND_MASK; s-&gt;nblock_used++;</span>
<a href="#l9.583"></a><span id="l9.583" class="difflineplus">+         if (s-&gt;nblock_used == s-&gt;save_nblock+1) continue;</span>
<a href="#l9.584"></a><span id="l9.584" class="difflineplus">+         if (k1 != s-&gt;k0) { s-&gt;k0 = k1; continue; };</span>
<a href="#l9.585"></a><span id="l9.585" class="difflineplus">+   </span>
<a href="#l9.586"></a><span id="l9.586" class="difflineplus">+         BZ_GET_FAST(k1); BZ_RAND_UPD_MASK; </span>
<a href="#l9.587"></a><span id="l9.587" class="difflineplus">+         k1 ^= BZ_RAND_MASK; s-&gt;nblock_used++;</span>
<a href="#l9.588"></a><span id="l9.588" class="difflineplus">+         s-&gt;state_out_len = ((Int32)k1) + 4;</span>
<a href="#l9.589"></a><span id="l9.589" class="difflineplus">+         BZ_GET_FAST(s-&gt;k0); BZ_RAND_UPD_MASK; </span>
<a href="#l9.590"></a><span id="l9.590" class="difflineplus">+         s-&gt;k0 ^= BZ_RAND_MASK; s-&gt;nblock_used++;</span>
<a href="#l9.591"></a><span id="l9.591" class="difflineplus">+      }</span>
<a href="#l9.592"></a><span id="l9.592" class="difflineplus">+</span>
<a href="#l9.593"></a><span id="l9.593" class="difflineplus">+   } else {</span>
<a href="#l9.594"></a><span id="l9.594" class="difflineplus">+</span>
<a href="#l9.595"></a><span id="l9.595" class="difflineplus">+      /* restore */</span>
<a href="#l9.596"></a><span id="l9.596" class="difflineplus">+      UInt32        c_calculatedBlockCRC = s-&gt;calculatedBlockCRC;</span>
<a href="#l9.597"></a><span id="l9.597" class="difflineplus">+      UChar         c_state_out_ch       = s-&gt;state_out_ch;</span>
<a href="#l9.598"></a><span id="l9.598" class="difflineplus">+      Int32         c_state_out_len      = s-&gt;state_out_len;</span>
<a href="#l9.599"></a><span id="l9.599" class="difflineplus">+      Int32         c_nblock_used        = s-&gt;nblock_used;</span>
<a href="#l9.600"></a><span id="l9.600" class="difflineplus">+      Int32         c_k0                 = s-&gt;k0;</span>
<a href="#l9.601"></a><span id="l9.601" class="difflineplus">+      UInt32*       c_tt                 = s-&gt;tt;</span>
<a href="#l9.602"></a><span id="l9.602" class="difflineplus">+      UInt32        c_tPos               = s-&gt;tPos;</span>
<a href="#l9.603"></a><span id="l9.603" class="difflineplus">+      char*         cs_next_out          = s-&gt;strm-&gt;next_out;</span>
<a href="#l9.604"></a><span id="l9.604" class="difflineplus">+      unsigned int  cs_avail_out         = s-&gt;strm-&gt;avail_out;</span>
<a href="#l9.605"></a><span id="l9.605" class="difflineplus">+      Int32         ro_blockSize100k     = s-&gt;blockSize100k;</span>
<a href="#l9.606"></a><span id="l9.606" class="difflineplus">+      /* end restore */</span>
<a href="#l9.607"></a><span id="l9.607" class="difflineplus">+</span>
<a href="#l9.608"></a><span id="l9.608" class="difflineplus">+      UInt32       avail_out_INIT = cs_avail_out;</span>
<a href="#l9.609"></a><span id="l9.609" class="difflineplus">+      Int32        s_save_nblockPP = s-&gt;save_nblock+1;</span>
<a href="#l9.610"></a><span id="l9.610" class="difflineplus">+      unsigned int total_out_lo32_old;</span>
<a href="#l9.611"></a><span id="l9.611" class="difflineplus">+</span>
<a href="#l9.612"></a><span id="l9.612" class="difflineplus">+      while (True) {</span>
<a href="#l9.613"></a><span id="l9.613" class="difflineplus">+</span>
<a href="#l9.614"></a><span id="l9.614" class="difflineplus">+         /* try to finish existing run */</span>
<a href="#l9.615"></a><span id="l9.615" class="difflineplus">+         if (c_state_out_len &gt; 0) {</span>
<a href="#l9.616"></a><span id="l9.616" class="difflineplus">+            while (True) {</span>
<a href="#l9.617"></a><span id="l9.617" class="difflineplus">+               if (cs_avail_out == 0) goto return_notr;</span>
<a href="#l9.618"></a><span id="l9.618" class="difflineplus">+               if (c_state_out_len == 1) break;</span>
<a href="#l9.619"></a><span id="l9.619" class="difflineplus">+               *( (UChar*)(cs_next_out) ) = c_state_out_ch;</span>
<a href="#l9.620"></a><span id="l9.620" class="difflineplus">+               BZ_UPDATE_CRC ( c_calculatedBlockCRC, c_state_out_ch );</span>
<a href="#l9.621"></a><span id="l9.621" class="difflineplus">+               c_state_out_len--;</span>
<a href="#l9.622"></a><span id="l9.622" class="difflineplus">+               cs_next_out++;</span>
<a href="#l9.623"></a><span id="l9.623" class="difflineplus">+               cs_avail_out--;</span>
<a href="#l9.624"></a><span id="l9.624" class="difflineplus">+            }</span>
<a href="#l9.625"></a><span id="l9.625" class="difflineplus">+            s_state_out_len_eq_one:</span>
<a href="#l9.626"></a><span id="l9.626" class="difflineplus">+            {</span>
<a href="#l9.627"></a><span id="l9.627" class="difflineplus">+               if (cs_avail_out == 0) { </span>
<a href="#l9.628"></a><span id="l9.628" class="difflineplus">+                  c_state_out_len = 1; goto return_notr;</span>
<a href="#l9.629"></a><span id="l9.629" class="difflineplus">+               };</span>
<a href="#l9.630"></a><span id="l9.630" class="difflineplus">+               *( (UChar*)(cs_next_out) ) = c_state_out_ch;</span>
<a href="#l9.631"></a><span id="l9.631" class="difflineplus">+               BZ_UPDATE_CRC ( c_calculatedBlockCRC, c_state_out_ch );</span>
<a href="#l9.632"></a><span id="l9.632" class="difflineplus">+               cs_next_out++;</span>
<a href="#l9.633"></a><span id="l9.633" class="difflineplus">+               cs_avail_out--;</span>
<a href="#l9.634"></a><span id="l9.634" class="difflineplus">+            }</span>
<a href="#l9.635"></a><span id="l9.635" class="difflineplus">+         }   </span>
<a href="#l9.636"></a><span id="l9.636" class="difflineplus">+         /* Only caused by corrupt data stream? */</span>
<a href="#l9.637"></a><span id="l9.637" class="difflineplus">+         if (c_nblock_used &gt; s_save_nblockPP)</span>
<a href="#l9.638"></a><span id="l9.638" class="difflineplus">+            return True;</span>
<a href="#l9.639"></a><span id="l9.639" class="difflineplus">+</span>
<a href="#l9.640"></a><span id="l9.640" class="difflineplus">+         /* can a new run be started? */</span>
<a href="#l9.641"></a><span id="l9.641" class="difflineplus">+         if (c_nblock_used == s_save_nblockPP) {</span>
<a href="#l9.642"></a><span id="l9.642" class="difflineplus">+            c_state_out_len = 0; goto return_notr;</span>
<a href="#l9.643"></a><span id="l9.643" class="difflineplus">+         };   </span>
<a href="#l9.644"></a><span id="l9.644" class="difflineplus">+         c_state_out_ch = c_k0;</span>
<a href="#l9.645"></a><span id="l9.645" class="difflineplus">+         BZ_GET_FAST_C(k1); c_nblock_used++;</span>
<a href="#l9.646"></a><span id="l9.646" class="difflineplus">+         if (k1 != c_k0) { </span>
<a href="#l9.647"></a><span id="l9.647" class="difflineplus">+            c_k0 = k1; goto s_state_out_len_eq_one; </span>
<a href="#l9.648"></a><span id="l9.648" class="difflineplus">+         };</span>
<a href="#l9.649"></a><span id="l9.649" class="difflineplus">+         if (c_nblock_used == s_save_nblockPP) </span>
<a href="#l9.650"></a><span id="l9.650" class="difflineplus">+            goto s_state_out_len_eq_one;</span>
<a href="#l9.651"></a><span id="l9.651" class="difflineplus">+   </span>
<a href="#l9.652"></a><span id="l9.652" class="difflineplus">+         c_state_out_len = 2;</span>
<a href="#l9.653"></a><span id="l9.653" class="difflineplus">+         BZ_GET_FAST_C(k1); c_nblock_used++;</span>
<a href="#l9.654"></a><span id="l9.654" class="difflineplus">+         if (c_nblock_used == s_save_nblockPP) continue;</span>
<a href="#l9.655"></a><span id="l9.655" class="difflineplus">+         if (k1 != c_k0) { c_k0 = k1; continue; };</span>
<a href="#l9.656"></a><span id="l9.656" class="difflineplus">+   </span>
<a href="#l9.657"></a><span id="l9.657" class="difflineplus">+         c_state_out_len = 3;</span>
<a href="#l9.658"></a><span id="l9.658" class="difflineplus">+         BZ_GET_FAST_C(k1); c_nblock_used++;</span>
<a href="#l9.659"></a><span id="l9.659" class="difflineplus">+         if (c_nblock_used == s_save_nblockPP) continue;</span>
<a href="#l9.660"></a><span id="l9.660" class="difflineplus">+         if (k1 != c_k0) { c_k0 = k1; continue; };</span>
<a href="#l9.661"></a><span id="l9.661" class="difflineplus">+   </span>
<a href="#l9.662"></a><span id="l9.662" class="difflineplus">+         BZ_GET_FAST_C(k1); c_nblock_used++;</span>
<a href="#l9.663"></a><span id="l9.663" class="difflineplus">+         c_state_out_len = ((Int32)k1) + 4;</span>
<a href="#l9.664"></a><span id="l9.664" class="difflineplus">+         BZ_GET_FAST_C(c_k0); c_nblock_used++;</span>
<a href="#l9.665"></a><span id="l9.665" class="difflineplus">+      }</span>
<a href="#l9.666"></a><span id="l9.666" class="difflineplus">+</span>
<a href="#l9.667"></a><span id="l9.667" class="difflineplus">+      return_notr:</span>
<a href="#l9.668"></a><span id="l9.668" class="difflineplus">+      total_out_lo32_old = s-&gt;strm-&gt;total_out_lo32;</span>
<a href="#l9.669"></a><span id="l9.669" class="difflineplus">+      s-&gt;strm-&gt;total_out_lo32 += (avail_out_INIT - cs_avail_out);</span>
<a href="#l9.670"></a><span id="l9.670" class="difflineplus">+      if (s-&gt;strm-&gt;total_out_lo32 &lt; total_out_lo32_old)</span>
<a href="#l9.671"></a><span id="l9.671" class="difflineplus">+         s-&gt;strm-&gt;total_out_hi32++;</span>
<a href="#l9.672"></a><span id="l9.672" class="difflineplus">+</span>
<a href="#l9.673"></a><span id="l9.673" class="difflineplus">+      /* save */</span>
<a href="#l9.674"></a><span id="l9.674" class="difflineplus">+      s-&gt;calculatedBlockCRC = c_calculatedBlockCRC;</span>
<a href="#l9.675"></a><span id="l9.675" class="difflineplus">+      s-&gt;state_out_ch       = c_state_out_ch;</span>
<a href="#l9.676"></a><span id="l9.676" class="difflineplus">+      s-&gt;state_out_len      = c_state_out_len;</span>
<a href="#l9.677"></a><span id="l9.677" class="difflineplus">+      s-&gt;nblock_used        = c_nblock_used;</span>
<a href="#l9.678"></a><span id="l9.678" class="difflineplus">+      s-&gt;k0                 = c_k0;</span>
<a href="#l9.679"></a><span id="l9.679" class="difflineplus">+      s-&gt;tt                 = c_tt;</span>
<a href="#l9.680"></a><span id="l9.680" class="difflineplus">+      s-&gt;tPos               = c_tPos;</span>
<a href="#l9.681"></a><span id="l9.681" class="difflineplus">+      s-&gt;strm-&gt;next_out     = cs_next_out;</span>
<a href="#l9.682"></a><span id="l9.682" class="difflineplus">+      s-&gt;strm-&gt;avail_out    = cs_avail_out;</span>
<a href="#l9.683"></a><span id="l9.683" class="difflineplus">+      /* end save */</span>
<a href="#l9.684"></a><span id="l9.684" class="difflineplus">+   }</span>
<a href="#l9.685"></a><span id="l9.685" class="difflineplus">+   return False;</span>
<a href="#l9.686"></a><span id="l9.686" class="difflineplus">+}</span>
<a href="#l9.687"></a><span id="l9.687" class="difflineplus">+</span>
<a href="#l9.688"></a><span id="l9.688" class="difflineplus">+</span>
<a href="#l9.689"></a><span id="l9.689" class="difflineplus">+</span>
<a href="#l9.690"></a><span id="l9.690" class="difflineplus">+/*---------------------------------------------------*/</span>
<a href="#l9.691"></a><span id="l9.691" class="difflineplus">+__inline__ Int32 BZ2_indexIntoF ( Int32 indx, Int32 *cftab )</span>
<a href="#l9.692"></a><span id="l9.692" class="difflineplus">+{</span>
<a href="#l9.693"></a><span id="l9.693" class="difflineplus">+   Int32 nb, na, mid;</span>
<a href="#l9.694"></a><span id="l9.694" class="difflineplus">+   nb = 0;</span>
<a href="#l9.695"></a><span id="l9.695" class="difflineplus">+   na = 256;</span>
<a href="#l9.696"></a><span id="l9.696" class="difflineplus">+   do {</span>
<a href="#l9.697"></a><span id="l9.697" class="difflineplus">+      mid = (nb + na) &gt;&gt; 1;</span>
<a href="#l9.698"></a><span id="l9.698" class="difflineplus">+      if (indx &gt;= cftab[mid]) nb = mid; else na = mid;</span>
<a href="#l9.699"></a><span id="l9.699" class="difflineplus">+   }</span>
<a href="#l9.700"></a><span id="l9.700" class="difflineplus">+   while (na - nb != 1);</span>
<a href="#l9.701"></a><span id="l9.701" class="difflineplus">+   return nb;</span>
<a href="#l9.702"></a><span id="l9.702" class="difflineplus">+}</span>
<a href="#l9.703"></a><span id="l9.703" class="difflineplus">+</span>
<a href="#l9.704"></a><span id="l9.704" class="difflineplus">+</span>
<a href="#l9.705"></a><span id="l9.705" class="difflineplus">+/*---------------------------------------------------*/</span>
<a href="#l9.706"></a><span id="l9.706" class="difflineplus">+/* Return  True iff data corruption is discovered.</span>
<a href="#l9.707"></a><span id="l9.707" class="difflineplus">+   Returns False if there is no problem.</span>
<a href="#l9.708"></a><span id="l9.708" class="difflineplus">+*/</span>
<a href="#l9.709"></a><span id="l9.709" class="difflineplus">+static</span>
<a href="#l9.710"></a><span id="l9.710" class="difflineplus">+Bool unRLE_obuf_to_output_SMALL ( DState* s )</span>
<a href="#l9.711"></a><span id="l9.711" class="difflineplus">+{</span>
<a href="#l9.712"></a><span id="l9.712" class="difflineplus">+   UChar k1;</span>
<a href="#l9.713"></a><span id="l9.713" class="difflineplus">+</span>
<a href="#l9.714"></a><span id="l9.714" class="difflineplus">+   if (s-&gt;blockRandomised) {</span>
<a href="#l9.715"></a><span id="l9.715" class="difflineplus">+</span>
<a href="#l9.716"></a><span id="l9.716" class="difflineplus">+      while (True) {</span>
<a href="#l9.717"></a><span id="l9.717" class="difflineplus">+         /* try to finish existing run */</span>
<a href="#l9.718"></a><span id="l9.718" class="difflineplus">+         while (True) {</span>
<a href="#l9.719"></a><span id="l9.719" class="difflineplus">+            if (s-&gt;strm-&gt;avail_out == 0) return False;</span>
<a href="#l9.720"></a><span id="l9.720" class="difflineplus">+            if (s-&gt;state_out_len == 0) break;</span>
<a href="#l9.721"></a><span id="l9.721" class="difflineplus">+            *( (UChar*)(s-&gt;strm-&gt;next_out) ) = s-&gt;state_out_ch;</span>
<a href="#l9.722"></a><span id="l9.722" class="difflineplus">+            BZ_UPDATE_CRC ( s-&gt;calculatedBlockCRC, s-&gt;state_out_ch );</span>
<a href="#l9.723"></a><span id="l9.723" class="difflineplus">+            s-&gt;state_out_len--;</span>
<a href="#l9.724"></a><span id="l9.724" class="difflineplus">+            s-&gt;strm-&gt;next_out++;</span>
<a href="#l9.725"></a><span id="l9.725" class="difflineplus">+            s-&gt;strm-&gt;avail_out--;</span>
<a href="#l9.726"></a><span id="l9.726" class="difflineplus">+            s-&gt;strm-&gt;total_out_lo32++;</span>
<a href="#l9.727"></a><span id="l9.727" class="difflineplus">+            if (s-&gt;strm-&gt;total_out_lo32 == 0) s-&gt;strm-&gt;total_out_hi32++;</span>
<a href="#l9.728"></a><span id="l9.728" class="difflineplus">+         }</span>
<a href="#l9.729"></a><span id="l9.729" class="difflineplus">+   </span>
<a href="#l9.730"></a><span id="l9.730" class="difflineplus">+         /* can a new run be started? */</span>
<a href="#l9.731"></a><span id="l9.731" class="difflineplus">+         if (s-&gt;nblock_used == s-&gt;save_nblock+1) return False;</span>
<a href="#l9.732"></a><span id="l9.732" class="difflineplus">+</span>
<a href="#l9.733"></a><span id="l9.733" class="difflineplus">+         /* Only caused by corrupt data stream? */</span>
<a href="#l9.734"></a><span id="l9.734" class="difflineplus">+         if (s-&gt;nblock_used &gt; s-&gt;save_nblock+1)</span>
<a href="#l9.735"></a><span id="l9.735" class="difflineplus">+            return True;</span>
<a href="#l9.736"></a><span id="l9.736" class="difflineplus">+   </span>
<a href="#l9.737"></a><span id="l9.737" class="difflineplus">+         s-&gt;state_out_len = 1;</span>
<a href="#l9.738"></a><span id="l9.738" class="difflineplus">+         s-&gt;state_out_ch = s-&gt;k0;</span>
<a href="#l9.739"></a><span id="l9.739" class="difflineplus">+         BZ_GET_SMALL(k1); BZ_RAND_UPD_MASK; </span>
<a href="#l9.740"></a><span id="l9.740" class="difflineplus">+         k1 ^= BZ_RAND_MASK; s-&gt;nblock_used++;</span>
<a href="#l9.741"></a><span id="l9.741" class="difflineplus">+         if (s-&gt;nblock_used == s-&gt;save_nblock+1) continue;</span>
<a href="#l9.742"></a><span id="l9.742" class="difflineplus">+         if (k1 != s-&gt;k0) { s-&gt;k0 = k1; continue; };</span>
<a href="#l9.743"></a><span id="l9.743" class="difflineplus">+   </span>
<a href="#l9.744"></a><span id="l9.744" class="difflineplus">+         s-&gt;state_out_len = 2;</span>
<a href="#l9.745"></a><span id="l9.745" class="difflineplus">+         BZ_GET_SMALL(k1); BZ_RAND_UPD_MASK; </span>
<a href="#l9.746"></a><span id="l9.746" class="difflineplus">+         k1 ^= BZ_RAND_MASK; s-&gt;nblock_used++;</span>
<a href="#l9.747"></a><span id="l9.747" class="difflineplus">+         if (s-&gt;nblock_used == s-&gt;save_nblock+1) continue;</span>
<a href="#l9.748"></a><span id="l9.748" class="difflineplus">+         if (k1 != s-&gt;k0) { s-&gt;k0 = k1; continue; };</span>
<a href="#l9.749"></a><span id="l9.749" class="difflineplus">+   </span>
<a href="#l9.750"></a><span id="l9.750" class="difflineplus">+         s-&gt;state_out_len = 3;</span>
<a href="#l9.751"></a><span id="l9.751" class="difflineplus">+         BZ_GET_SMALL(k1); BZ_RAND_UPD_MASK; </span>
<a href="#l9.752"></a><span id="l9.752" class="difflineplus">+         k1 ^= BZ_RAND_MASK; s-&gt;nblock_used++;</span>
<a href="#l9.753"></a><span id="l9.753" class="difflineplus">+         if (s-&gt;nblock_used == s-&gt;save_nblock+1) continue;</span>
<a href="#l9.754"></a><span id="l9.754" class="difflineplus">+         if (k1 != s-&gt;k0) { s-&gt;k0 = k1; continue; };</span>
<a href="#l9.755"></a><span id="l9.755" class="difflineplus">+   </span>
<a href="#l9.756"></a><span id="l9.756" class="difflineplus">+         BZ_GET_SMALL(k1); BZ_RAND_UPD_MASK; </span>
<a href="#l9.757"></a><span id="l9.757" class="difflineplus">+         k1 ^= BZ_RAND_MASK; s-&gt;nblock_used++;</span>
<a href="#l9.758"></a><span id="l9.758" class="difflineplus">+         s-&gt;state_out_len = ((Int32)k1) + 4;</span>
<a href="#l9.759"></a><span id="l9.759" class="difflineplus">+         BZ_GET_SMALL(s-&gt;k0); BZ_RAND_UPD_MASK; </span>
<a href="#l9.760"></a><span id="l9.760" class="difflineplus">+         s-&gt;k0 ^= BZ_RAND_MASK; s-&gt;nblock_used++;</span>
<a href="#l9.761"></a><span id="l9.761" class="difflineplus">+      }</span>
<a href="#l9.762"></a><span id="l9.762" class="difflineplus">+</span>
<a href="#l9.763"></a><span id="l9.763" class="difflineplus">+   } else {</span>
<a href="#l9.764"></a><span id="l9.764" class="difflineplus">+</span>
<a href="#l9.765"></a><span id="l9.765" class="difflineplus">+      while (True) {</span>
<a href="#l9.766"></a><span id="l9.766" class="difflineplus">+         /* try to finish existing run */</span>
<a href="#l9.767"></a><span id="l9.767" class="difflineplus">+         while (True) {</span>
<a href="#l9.768"></a><span id="l9.768" class="difflineplus">+            if (s-&gt;strm-&gt;avail_out == 0) return False;</span>
<a href="#l9.769"></a><span id="l9.769" class="difflineplus">+            if (s-&gt;state_out_len == 0) break;</span>
<a href="#l9.770"></a><span id="l9.770" class="difflineplus">+            *( (UChar*)(s-&gt;strm-&gt;next_out) ) = s-&gt;state_out_ch;</span>
<a href="#l9.771"></a><span id="l9.771" class="difflineplus">+            BZ_UPDATE_CRC ( s-&gt;calculatedBlockCRC, s-&gt;state_out_ch );</span>
<a href="#l9.772"></a><span id="l9.772" class="difflineplus">+            s-&gt;state_out_len--;</span>
<a href="#l9.773"></a><span id="l9.773" class="difflineplus">+            s-&gt;strm-&gt;next_out++;</span>
<a href="#l9.774"></a><span id="l9.774" class="difflineplus">+            s-&gt;strm-&gt;avail_out--;</span>
<a href="#l9.775"></a><span id="l9.775" class="difflineplus">+            s-&gt;strm-&gt;total_out_lo32++;</span>
<a href="#l9.776"></a><span id="l9.776" class="difflineplus">+            if (s-&gt;strm-&gt;total_out_lo32 == 0) s-&gt;strm-&gt;total_out_hi32++;</span>
<a href="#l9.777"></a><span id="l9.777" class="difflineplus">+         }</span>
<a href="#l9.778"></a><span id="l9.778" class="difflineplus">+   </span>
<a href="#l9.779"></a><span id="l9.779" class="difflineplus">+         /* can a new run be started? */</span>
<a href="#l9.780"></a><span id="l9.780" class="difflineplus">+         if (s-&gt;nblock_used == s-&gt;save_nblock+1) return False;</span>
<a href="#l9.781"></a><span id="l9.781" class="difflineplus">+</span>
<a href="#l9.782"></a><span id="l9.782" class="difflineplus">+         /* Only caused by corrupt data stream? */</span>
<a href="#l9.783"></a><span id="l9.783" class="difflineplus">+         if (s-&gt;nblock_used &gt; s-&gt;save_nblock+1)</span>
<a href="#l9.784"></a><span id="l9.784" class="difflineplus">+            return True;</span>
<a href="#l9.785"></a><span id="l9.785" class="difflineplus">+   </span>
<a href="#l9.786"></a><span id="l9.786" class="difflineplus">+         s-&gt;state_out_len = 1;</span>
<a href="#l9.787"></a><span id="l9.787" class="difflineplus">+         s-&gt;state_out_ch = s-&gt;k0;</span>
<a href="#l9.788"></a><span id="l9.788" class="difflineplus">+         BZ_GET_SMALL(k1); s-&gt;nblock_used++;</span>
<a href="#l9.789"></a><span id="l9.789" class="difflineplus">+         if (s-&gt;nblock_used == s-&gt;save_nblock+1) continue;</span>
<a href="#l9.790"></a><span id="l9.790" class="difflineplus">+         if (k1 != s-&gt;k0) { s-&gt;k0 = k1; continue; };</span>
<a href="#l9.791"></a><span id="l9.791" class="difflineplus">+   </span>
<a href="#l9.792"></a><span id="l9.792" class="difflineplus">+         s-&gt;state_out_len = 2;</span>
<a href="#l9.793"></a><span id="l9.793" class="difflineplus">+         BZ_GET_SMALL(k1); s-&gt;nblock_used++;</span>
<a href="#l9.794"></a><span id="l9.794" class="difflineplus">+         if (s-&gt;nblock_used == s-&gt;save_nblock+1) continue;</span>
<a href="#l9.795"></a><span id="l9.795" class="difflineplus">+         if (k1 != s-&gt;k0) { s-&gt;k0 = k1; continue; };</span>
<a href="#l9.796"></a><span id="l9.796" class="difflineplus">+   </span>
<a href="#l9.797"></a><span id="l9.797" class="difflineplus">+         s-&gt;state_out_len = 3;</span>
<a href="#l9.798"></a><span id="l9.798" class="difflineplus">+         BZ_GET_SMALL(k1); s-&gt;nblock_used++;</span>
<a href="#l9.799"></a><span id="l9.799" class="difflineplus">+         if (s-&gt;nblock_used == s-&gt;save_nblock+1) continue;</span>
<a href="#l9.800"></a><span id="l9.800" class="difflineplus">+         if (k1 != s-&gt;k0) { s-&gt;k0 = k1; continue; };</span>
<a href="#l9.801"></a><span id="l9.801" class="difflineplus">+   </span>
<a href="#l9.802"></a><span id="l9.802" class="difflineplus">+         BZ_GET_SMALL(k1); s-&gt;nblock_used++;</span>
<a href="#l9.803"></a><span id="l9.803" class="difflineplus">+         s-&gt;state_out_len = ((Int32)k1) + 4;</span>
<a href="#l9.804"></a><span id="l9.804" class="difflineplus">+         BZ_GET_SMALL(s-&gt;k0); s-&gt;nblock_used++;</span>
<a href="#l9.805"></a><span id="l9.805" class="difflineplus">+      }</span>
<a href="#l9.806"></a><span id="l9.806" class="difflineplus">+</span>
<a href="#l9.807"></a><span id="l9.807" class="difflineplus">+   }</span>
<a href="#l9.808"></a><span id="l9.808" class="difflineplus">+}</span>
<a href="#l9.809"></a><span id="l9.809" class="difflineplus">+</span>
<a href="#l9.810"></a><span id="l9.810" class="difflineplus">+</span>
<a href="#l9.811"></a><span id="l9.811" class="difflineplus">+/*---------------------------------------------------*/</span>
<a href="#l9.812"></a><span id="l9.812" class="difflineplus">+int BZ_API(BZ2_bzDecompress) ( bz_stream *strm )</span>
<a href="#l9.813"></a><span id="l9.813" class="difflineplus">+{</span>
<a href="#l9.814"></a><span id="l9.814" class="difflineplus">+   Bool    corrupt;</span>
<a href="#l9.815"></a><span id="l9.815" class="difflineplus">+   DState* s;</span>
<a href="#l9.816"></a><span id="l9.816" class="difflineplus">+   if (strm == NULL) return BZ_PARAM_ERROR;</span>
<a href="#l9.817"></a><span id="l9.817" class="difflineplus">+   s = strm-&gt;state;</span>
<a href="#l9.818"></a><span id="l9.818" class="difflineplus">+   if (s == NULL) return BZ_PARAM_ERROR;</span>
<a href="#l9.819"></a><span id="l9.819" class="difflineplus">+   if (s-&gt;strm != strm) return BZ_PARAM_ERROR;</span>
<a href="#l9.820"></a><span id="l9.820" class="difflineplus">+</span>
<a href="#l9.821"></a><span id="l9.821" class="difflineplus">+   while (True) {</span>
<a href="#l9.822"></a><span id="l9.822" class="difflineplus">+      if (s-&gt;state == BZ_X_IDLE) return BZ_SEQUENCE_ERROR;</span>
<a href="#l9.823"></a><span id="l9.823" class="difflineplus">+      if (s-&gt;state == BZ_X_OUTPUT) {</span>
<a href="#l9.824"></a><span id="l9.824" class="difflineplus">+         if (s-&gt;smallDecompress)</span>
<a href="#l9.825"></a><span id="l9.825" class="difflineplus">+            corrupt = unRLE_obuf_to_output_SMALL ( s ); else</span>
<a href="#l9.826"></a><span id="l9.826" class="difflineplus">+            corrupt = unRLE_obuf_to_output_FAST  ( s );</span>
<a href="#l9.827"></a><span id="l9.827" class="difflineplus">+         if (corrupt) return BZ_DATA_ERROR;</span>
<a href="#l9.828"></a><span id="l9.828" class="difflineplus">+         if (s-&gt;nblock_used == s-&gt;save_nblock+1 &amp;&amp; s-&gt;state_out_len == 0) {</span>
<a href="#l9.829"></a><span id="l9.829" class="difflineplus">+            BZ_FINALISE_CRC ( s-&gt;calculatedBlockCRC );</span>
<a href="#l9.830"></a><span id="l9.830" class="difflineplus">+            if (s-&gt;verbosity &gt;= 3) </span>
<a href="#l9.831"></a><span id="l9.831" class="difflineplus">+               VPrintf2 ( &quot; {0x%08x, 0x%08x}&quot;, s-&gt;storedBlockCRC, </span>
<a href="#l9.832"></a><span id="l9.832" class="difflineplus">+                          s-&gt;calculatedBlockCRC );</span>
<a href="#l9.833"></a><span id="l9.833" class="difflineplus">+            if (s-&gt;verbosity &gt;= 2) VPrintf0 ( &quot;]&quot; );</span>
<a href="#l9.834"></a><span id="l9.834" class="difflineplus">+            if (s-&gt;calculatedBlockCRC != s-&gt;storedBlockCRC)</span>
<a href="#l9.835"></a><span id="l9.835" class="difflineplus">+               return BZ_DATA_ERROR;</span>
<a href="#l9.836"></a><span id="l9.836" class="difflineplus">+            s-&gt;calculatedCombinedCRC </span>
<a href="#l9.837"></a><span id="l9.837" class="difflineplus">+               = (s-&gt;calculatedCombinedCRC &lt;&lt; 1) | </span>
<a href="#l9.838"></a><span id="l9.838" class="difflineplus">+                    (s-&gt;calculatedCombinedCRC &gt;&gt; 31);</span>
<a href="#l9.839"></a><span id="l9.839" class="difflineplus">+            s-&gt;calculatedCombinedCRC ^= s-&gt;calculatedBlockCRC;</span>
<a href="#l9.840"></a><span id="l9.840" class="difflineplus">+            s-&gt;state = BZ_X_BLKHDR_1;</span>
<a href="#l9.841"></a><span id="l9.841" class="difflineplus">+         } else {</span>
<a href="#l9.842"></a><span id="l9.842" class="difflineplus">+            return BZ_OK;</span>
<a href="#l9.843"></a><span id="l9.843" class="difflineplus">+         }</span>
<a href="#l9.844"></a><span id="l9.844" class="difflineplus">+      }</span>
<a href="#l9.845"></a><span id="l9.845" class="difflineplus">+      if (s-&gt;state &gt;= BZ_X_MAGIC_1) {</span>
<a href="#l9.846"></a><span id="l9.846" class="difflineplus">+         Int32 r = BZ2_decompress ( s );</span>
<a href="#l9.847"></a><span id="l9.847" class="difflineplus">+         if (r == BZ_STREAM_END) {</span>
<a href="#l9.848"></a><span id="l9.848" class="difflineplus">+            if (s-&gt;verbosity &gt;= 3)</span>
<a href="#l9.849"></a><span id="l9.849" class="difflineplus">+               VPrintf2 ( &quot;\n    combined CRCs: stored = 0x%08x, computed = 0x%08x&quot;, </span>
<a href="#l9.850"></a><span id="l9.850" class="difflineplus">+                          s-&gt;storedCombinedCRC, s-&gt;calculatedCombinedCRC );</span>
<a href="#l9.851"></a><span id="l9.851" class="difflineplus">+            if (s-&gt;calculatedCombinedCRC != s-&gt;storedCombinedCRC)</span>
<a href="#l9.852"></a><span id="l9.852" class="difflineplus">+               return BZ_DATA_ERROR;</span>
<a href="#l9.853"></a><span id="l9.853" class="difflineplus">+            return r;</span>
<a href="#l9.854"></a><span id="l9.854" class="difflineplus">+         }</span>
<a href="#l9.855"></a><span id="l9.855" class="difflineplus">+         if (s-&gt;state != BZ_X_OUTPUT) return r;</span>
<a href="#l9.856"></a><span id="l9.856" class="difflineplus">+      }</span>
<a href="#l9.857"></a><span id="l9.857" class="difflineplus">+   }</span>
<a href="#l9.858"></a><span id="l9.858" class="difflineplus">+</span>
<a href="#l9.859"></a><span id="l9.859" class="difflineplus">+   AssertH ( 0, 6001 );</span>
<a href="#l9.860"></a><span id="l9.860" class="difflineplus">+</span>
<a href="#l9.861"></a><span id="l9.861" class="difflineplus">+   return 0;  /*NOTREACHED*/</span>
<a href="#l9.862"></a><span id="l9.862" class="difflineplus">+}</span>
<a href="#l9.863"></a><span id="l9.863" class="difflineplus">+</span>
<a href="#l9.864"></a><span id="l9.864" class="difflineplus">+</span>
<a href="#l9.865"></a><span id="l9.865" class="difflineplus">+/*---------------------------------------------------*/</span>
<a href="#l9.866"></a><span id="l9.866" class="difflineplus">+int BZ_API(BZ2_bzDecompressEnd)  ( bz_stream *strm )</span>
<a href="#l9.867"></a><span id="l9.867" class="difflineplus">+{</span>
<a href="#l9.868"></a><span id="l9.868" class="difflineplus">+   DState* s;</span>
<a href="#l9.869"></a><span id="l9.869" class="difflineplus">+   if (strm == NULL) return BZ_PARAM_ERROR;</span>
<a href="#l9.870"></a><span id="l9.870" class="difflineplus">+   s = strm-&gt;state;</span>
<a href="#l9.871"></a><span id="l9.871" class="difflineplus">+   if (s == NULL) return BZ_PARAM_ERROR;</span>
<a href="#l9.872"></a><span id="l9.872" class="difflineplus">+   if (s-&gt;strm != strm) return BZ_PARAM_ERROR;</span>
<a href="#l9.873"></a><span id="l9.873" class="difflineplus">+</span>
<a href="#l9.874"></a><span id="l9.874" class="difflineplus">+   if (s-&gt;tt   != NULL) BZFREE(s-&gt;tt);</span>
<a href="#l9.875"></a><span id="l9.875" class="difflineplus">+   if (s-&gt;ll16 != NULL) BZFREE(s-&gt;ll16);</span>
<a href="#l9.876"></a><span id="l9.876" class="difflineplus">+   if (s-&gt;ll4  != NULL) BZFREE(s-&gt;ll4);</span>
<a href="#l9.877"></a><span id="l9.877" class="difflineplus">+</span>
<a href="#l9.878"></a><span id="l9.878" class="difflineplus">+   BZFREE(strm-&gt;state);</span>
<a href="#l9.879"></a><span id="l9.879" class="difflineplus">+   strm-&gt;state = NULL;</span>
<a href="#l9.880"></a><span id="l9.880" class="difflineplus">+</span>
<a href="#l9.881"></a><span id="l9.881" class="difflineplus">+   return BZ_OK;</span>
<a href="#l9.882"></a><span id="l9.882" class="difflineplus">+}</span>
<a href="#l9.883"></a><span id="l9.883" class="difflineplus">+</span>
<a href="#l9.884"></a><span id="l9.884" class="difflineplus">+</span>
<a href="#l9.885"></a><span id="l9.885" class="difflineplus">+#ifndef BZ_NO_STDIO</span>
<a href="#l9.886"></a><span id="l9.886" class="difflineplus">+/*---------------------------------------------------*/</span>
<a href="#l9.887"></a><span id="l9.887" class="difflineplus">+/*--- File I/O stuff                              ---*/</span>
<a href="#l9.888"></a><span id="l9.888" class="difflineplus">+/*---------------------------------------------------*/</span>
<a href="#l9.889"></a><span id="l9.889" class="difflineplus">+</span>
<a href="#l9.890"></a><span id="l9.890" class="difflineplus">+#define BZ_SETERR(eee)                    \</span>
<a href="#l9.891"></a><span id="l9.891" class="difflineplus">+{                                         \</span>
<a href="#l9.892"></a><span id="l9.892" class="difflineplus">+   if (bzerror != NULL) *bzerror = eee;   \</span>
<a href="#l9.893"></a><span id="l9.893" class="difflineplus">+   if (bzf != NULL) bzf-&gt;lastErr = eee;   \</span>
<a href="#l9.894"></a><span id="l9.894" class="difflineplus">+}</span>
<a href="#l9.895"></a><span id="l9.895" class="difflineplus">+</span>
<a href="#l9.896"></a><span id="l9.896" class="difflineplus">+typedef </span>
<a href="#l9.897"></a><span id="l9.897" class="difflineplus">+   struct {</span>
<a href="#l9.898"></a><span id="l9.898" class="difflineplus">+      FILE*     handle;</span>
<a href="#l9.899"></a><span id="l9.899" class="difflineplus">+      Char      buf[BZ_MAX_UNUSED];</span>
<a href="#l9.900"></a><span id="l9.900" class="difflineplus">+      Int32     bufN;</span>
<a href="#l9.901"></a><span id="l9.901" class="difflineplus">+      Bool      writing;</span>
<a href="#l9.902"></a><span id="l9.902" class="difflineplus">+      bz_stream strm;</span>
<a href="#l9.903"></a><span id="l9.903" class="difflineplus">+      Int32     lastErr;</span>
<a href="#l9.904"></a><span id="l9.904" class="difflineplus">+      Bool      initialisedOk;</span>
<a href="#l9.905"></a><span id="l9.905" class="difflineplus">+   }</span>
<a href="#l9.906"></a><span id="l9.906" class="difflineplus">+   bzFile;</span>
<a href="#l9.907"></a><span id="l9.907" class="difflineplus">+</span>
<a href="#l9.908"></a><span id="l9.908" class="difflineplus">+</span>
<a href="#l9.909"></a><span id="l9.909" class="difflineplus">+/*---------------------------------------------*/</span>
<a href="#l9.910"></a><span id="l9.910" class="difflineplus">+static Bool myfeof ( FILE* f )</span>
<a href="#l9.911"></a><span id="l9.911" class="difflineplus">+{</span>
<a href="#l9.912"></a><span id="l9.912" class="difflineplus">+   Int32 c = fgetc ( f );</span>
<a href="#l9.913"></a><span id="l9.913" class="difflineplus">+   if (c == EOF) return True;</span>
<a href="#l9.914"></a><span id="l9.914" class="difflineplus">+   ungetc ( c, f );</span>
<a href="#l9.915"></a><span id="l9.915" class="difflineplus">+   return False;</span>
<a href="#l9.916"></a><span id="l9.916" class="difflineplus">+}</span>
<a href="#l9.917"></a><span id="l9.917" class="difflineplus">+</span>
<a href="#l9.918"></a><span id="l9.918" class="difflineplus">+</span>
<a href="#l9.919"></a><span id="l9.919" class="difflineplus">+/*---------------------------------------------------*/</span>
<a href="#l9.920"></a><span id="l9.920" class="difflineplus">+BZFILE* BZ_API(BZ2_bzWriteOpen) </span>
<a href="#l9.921"></a><span id="l9.921" class="difflineplus">+                    ( int*  bzerror,      </span>
<a href="#l9.922"></a><span id="l9.922" class="difflineplus">+                      FILE* f, </span>
<a href="#l9.923"></a><span id="l9.923" class="difflineplus">+                      int   blockSize100k, </span>
<a href="#l9.924"></a><span id="l9.924" class="difflineplus">+                      int   verbosity,</span>
<a href="#l9.925"></a><span id="l9.925" class="difflineplus">+                      int   workFactor )</span>
<a href="#l9.926"></a><span id="l9.926" class="difflineplus">+{</span>
<a href="#l9.927"></a><span id="l9.927" class="difflineplus">+   Int32   ret;</span>
<a href="#l9.928"></a><span id="l9.928" class="difflineplus">+   bzFile* bzf = NULL;</span>
<a href="#l9.929"></a><span id="l9.929" class="difflineplus">+</span>
<a href="#l9.930"></a><span id="l9.930" class="difflineplus">+   BZ_SETERR(BZ_OK);</span>
<a href="#l9.931"></a><span id="l9.931" class="difflineplus">+</span>
<a href="#l9.932"></a><span id="l9.932" class="difflineplus">+   if (f == NULL ||</span>
<a href="#l9.933"></a><span id="l9.933" class="difflineplus">+       (blockSize100k &lt; 1 || blockSize100k &gt; 9) ||</span>
<a href="#l9.934"></a><span id="l9.934" class="difflineplus">+       (workFactor &lt; 0 || workFactor &gt; 250) ||</span>
<a href="#l9.935"></a><span id="l9.935" class="difflineplus">+       (verbosity &lt; 0 || verbosity &gt; 4))</span>
<a href="#l9.936"></a><span id="l9.936" class="difflineplus">+      { BZ_SETERR(BZ_PARAM_ERROR); return NULL; };</span>
<a href="#l9.937"></a><span id="l9.937" class="difflineplus">+</span>
<a href="#l9.938"></a><span id="l9.938" class="difflineplus">+   if (ferror(f))</span>
<a href="#l9.939"></a><span id="l9.939" class="difflineplus">+      { BZ_SETERR(BZ_IO_ERROR); return NULL; };</span>
<a href="#l9.940"></a><span id="l9.940" class="difflineplus">+</span>
<a href="#l9.941"></a><span id="l9.941" class="difflineplus">+   bzf = malloc ( sizeof(bzFile) );</span>
<a href="#l9.942"></a><span id="l9.942" class="difflineplus">+   if (bzf == NULL)</span>
<a href="#l9.943"></a><span id="l9.943" class="difflineplus">+      { BZ_SETERR(BZ_MEM_ERROR); return NULL; };</span>
<a href="#l9.944"></a><span id="l9.944" class="difflineplus">+</span>
<a href="#l9.945"></a><span id="l9.945" class="difflineplus">+   BZ_SETERR(BZ_OK);</span>
<a href="#l9.946"></a><span id="l9.946" class="difflineplus">+   bzf-&gt;initialisedOk = False;</span>
<a href="#l9.947"></a><span id="l9.947" class="difflineplus">+   bzf-&gt;bufN          = 0;</span>
<a href="#l9.948"></a><span id="l9.948" class="difflineplus">+   bzf-&gt;handle        = f;</span>
<a href="#l9.949"></a><span id="l9.949" class="difflineplus">+   bzf-&gt;writing       = True;</span>
<a href="#l9.950"></a><span id="l9.950" class="difflineplus">+   bzf-&gt;strm.bzalloc  = NULL;</span>
<a href="#l9.951"></a><span id="l9.951" class="difflineplus">+   bzf-&gt;strm.bzfree   = NULL;</span>
<a href="#l9.952"></a><span id="l9.952" class="difflineplus">+   bzf-&gt;strm.opaque   = NULL;</span>
<a href="#l9.953"></a><span id="l9.953" class="difflineplus">+</span>
<a href="#l9.954"></a><span id="l9.954" class="difflineplus">+   if (workFactor == 0) workFactor = 30;</span>
<a href="#l9.955"></a><span id="l9.955" class="difflineplus">+   ret = BZ2_bzCompressInit ( &amp;(bzf-&gt;strm), blockSize100k, </span>
<a href="#l9.956"></a><span id="l9.956" class="difflineplus">+                              verbosity, workFactor );</span>
<a href="#l9.957"></a><span id="l9.957" class="difflineplus">+   if (ret != BZ_OK)</span>
<a href="#l9.958"></a><span id="l9.958" class="difflineplus">+      { BZ_SETERR(ret); free(bzf); return NULL; };</span>
<a href="#l9.959"></a><span id="l9.959" class="difflineplus">+</span>
<a href="#l9.960"></a><span id="l9.960" class="difflineplus">+   bzf-&gt;strm.avail_in = 0;</span>
<a href="#l9.961"></a><span id="l9.961" class="difflineplus">+   bzf-&gt;initialisedOk = True;</span>
<a href="#l9.962"></a><span id="l9.962" class="difflineplus">+   return bzf;   </span>
<a href="#l9.963"></a><span id="l9.963" class="difflineplus">+}</span>
<a href="#l9.964"></a><span id="l9.964" class="difflineplus">+</span>
<a href="#l9.965"></a><span id="l9.965" class="difflineplus">+</span>
<a href="#l9.966"></a><span id="l9.966" class="difflineplus">+</span>
<a href="#l9.967"></a><span id="l9.967" class="difflineplus">+/*---------------------------------------------------*/</span>
<a href="#l9.968"></a><span id="l9.968" class="difflineplus">+void BZ_API(BZ2_bzWrite)</span>
<a href="#l9.969"></a><span id="l9.969" class="difflineplus">+             ( int*    bzerror, </span>
<a href="#l9.970"></a><span id="l9.970" class="difflineplus">+               BZFILE* b, </span>
<a href="#l9.971"></a><span id="l9.971" class="difflineplus">+               void*   buf, </span>
<a href="#l9.972"></a><span id="l9.972" class="difflineplus">+               int     len )</span>
<a href="#l9.973"></a><span id="l9.973" class="difflineplus">+{</span>
<a href="#l9.974"></a><span id="l9.974" class="difflineplus">+   Int32 n, n2, ret;</span>
<a href="#l9.975"></a><span id="l9.975" class="difflineplus">+   bzFile* bzf = (bzFile*)b;</span>
<a href="#l9.976"></a><span id="l9.976" class="difflineplus">+</span>
<a href="#l9.977"></a><span id="l9.977" class="difflineplus">+   BZ_SETERR(BZ_OK);</span>
<a href="#l9.978"></a><span id="l9.978" class="difflineplus">+   if (bzf == NULL || buf == NULL || len &lt; 0)</span>
<a href="#l9.979"></a><span id="l9.979" class="difflineplus">+      { BZ_SETERR(BZ_PARAM_ERROR); return; };</span>
<a href="#l9.980"></a><span id="l9.980" class="difflineplus">+   if (!(bzf-&gt;writing))</span>
<a href="#l9.981"></a><span id="l9.981" class="difflineplus">+      { BZ_SETERR(BZ_SEQUENCE_ERROR); return; };</span>
<a href="#l9.982"></a><span id="l9.982" class="difflineplus">+   if (ferror(bzf-&gt;handle))</span>
<a href="#l9.983"></a><span id="l9.983" class="difflineplus">+      { BZ_SETERR(BZ_IO_ERROR); return; };</span>
<a href="#l9.984"></a><span id="l9.984" class="difflineplus">+</span>
<a href="#l9.985"></a><span id="l9.985" class="difflineplus">+   if (len == 0)</span>
<a href="#l9.986"></a><span id="l9.986" class="difflineplus">+      { BZ_SETERR(BZ_OK); return; };</span>
<a href="#l9.987"></a><span id="l9.987" class="difflineplus">+</span>
<a href="#l9.988"></a><span id="l9.988" class="difflineplus">+   bzf-&gt;strm.avail_in = len;</span>
<a href="#l9.989"></a><span id="l9.989" class="difflineplus">+   bzf-&gt;strm.next_in  = buf;</span>
<a href="#l9.990"></a><span id="l9.990" class="difflineplus">+</span>
<a href="#l9.991"></a><span id="l9.991" class="difflineplus">+   while (True) {</span>
<a href="#l9.992"></a><span id="l9.992" class="difflineplus">+      bzf-&gt;strm.avail_out = BZ_MAX_UNUSED;</span>
<a href="#l9.993"></a><span id="l9.993" class="difflineplus">+      bzf-&gt;strm.next_out = bzf-&gt;buf;</span>
<a href="#l9.994"></a><span id="l9.994" class="difflineplus">+      ret = BZ2_bzCompress ( &amp;(bzf-&gt;strm), BZ_RUN );</span>
<a href="#l9.995"></a><span id="l9.995" class="difflineplus">+      if (ret != BZ_RUN_OK)</span>
<a href="#l9.996"></a><span id="l9.996" class="difflineplus">+         { BZ_SETERR(ret); return; };</span>
<a href="#l9.997"></a><span id="l9.997" class="difflineplus">+</span>
<a href="#l9.998"></a><span id="l9.998" class="difflineplus">+      if (bzf-&gt;strm.avail_out &lt; BZ_MAX_UNUSED) {</span>
<a href="#l9.999"></a><span id="l9.999" class="difflineplus">+         n = BZ_MAX_UNUSED - bzf-&gt;strm.avail_out;</span>
<a href="#l9.1000"></a><span id="l9.1000" class="difflineplus">+         n2 = fwrite ( (void*)(bzf-&gt;buf), sizeof(UChar), </span>
<a href="#l9.1001"></a><span id="l9.1001" class="difflineplus">+                       n, bzf-&gt;handle );</span>
<a href="#l9.1002"></a><span id="l9.1002" class="difflineplus">+         if (n != n2 || ferror(bzf-&gt;handle))</span>
<a href="#l9.1003"></a><span id="l9.1003" class="difflineplus">+            { BZ_SETERR(BZ_IO_ERROR); return; };</span>
<a href="#l9.1004"></a><span id="l9.1004" class="difflineplus">+      }</span>
<a href="#l9.1005"></a><span id="l9.1005" class="difflineplus">+</span>
<a href="#l9.1006"></a><span id="l9.1006" class="difflineplus">+      if (bzf-&gt;strm.avail_in == 0)</span>
<a href="#l9.1007"></a><span id="l9.1007" class="difflineplus">+         { BZ_SETERR(BZ_OK); return; };</span>
<a href="#l9.1008"></a><span id="l9.1008" class="difflineplus">+   }</span>
<a href="#l9.1009"></a><span id="l9.1009" class="difflineplus">+}</span>
<a href="#l9.1010"></a><span id="l9.1010" class="difflineplus">+</span>
<a href="#l9.1011"></a><span id="l9.1011" class="difflineplus">+</span>
<a href="#l9.1012"></a><span id="l9.1012" class="difflineplus">+/*---------------------------------------------------*/</span>
<a href="#l9.1013"></a><span id="l9.1013" class="difflineplus">+void BZ_API(BZ2_bzWriteClose)</span>
<a href="#l9.1014"></a><span id="l9.1014" class="difflineplus">+                  ( int*          bzerror, </span>
<a href="#l9.1015"></a><span id="l9.1015" class="difflineplus">+                    BZFILE*       b, </span>
<a href="#l9.1016"></a><span id="l9.1016" class="difflineplus">+                    int           abandon,</span>
<a href="#l9.1017"></a><span id="l9.1017" class="difflineplus">+                    unsigned int* nbytes_in,</span>
<a href="#l9.1018"></a><span id="l9.1018" class="difflineplus">+                    unsigned int* nbytes_out )</span>
<a href="#l9.1019"></a><span id="l9.1019" class="difflineplus">+{</span>
<a href="#l9.1020"></a><span id="l9.1020" class="difflineplus">+   BZ2_bzWriteClose64 ( bzerror, b, abandon, </span>
<a href="#l9.1021"></a><span id="l9.1021" class="difflineplus">+                        nbytes_in, NULL, nbytes_out, NULL );</span>
<a href="#l9.1022"></a><span id="l9.1022" class="difflineplus">+}</span>
<a href="#l9.1023"></a><span id="l9.1023" class="difflineplus">+</span>
<a href="#l9.1024"></a><span id="l9.1024" class="difflineplus">+</span>
<a href="#l9.1025"></a><span id="l9.1025" class="difflineplus">+void BZ_API(BZ2_bzWriteClose64)</span>
<a href="#l9.1026"></a><span id="l9.1026" class="difflineplus">+                  ( int*          bzerror, </span>
<a href="#l9.1027"></a><span id="l9.1027" class="difflineplus">+                    BZFILE*       b, </span>
<a href="#l9.1028"></a><span id="l9.1028" class="difflineplus">+                    int           abandon,</span>
<a href="#l9.1029"></a><span id="l9.1029" class="difflineplus">+                    unsigned int* nbytes_in_lo32,</span>
<a href="#l9.1030"></a><span id="l9.1030" class="difflineplus">+                    unsigned int* nbytes_in_hi32,</span>
<a href="#l9.1031"></a><span id="l9.1031" class="difflineplus">+                    unsigned int* nbytes_out_lo32,</span>
<a href="#l9.1032"></a><span id="l9.1032" class="difflineplus">+                    unsigned int* nbytes_out_hi32 )</span>
<a href="#l9.1033"></a><span id="l9.1033" class="difflineplus">+{</span>
<a href="#l9.1034"></a><span id="l9.1034" class="difflineplus">+   Int32   n, n2, ret;</span>
<a href="#l9.1035"></a><span id="l9.1035" class="difflineplus">+   bzFile* bzf = (bzFile*)b;</span>
<a href="#l9.1036"></a><span id="l9.1036" class="difflineplus">+</span>
<a href="#l9.1037"></a><span id="l9.1037" class="difflineplus">+   if (bzf == NULL)</span>
<a href="#l9.1038"></a><span id="l9.1038" class="difflineplus">+      { BZ_SETERR(BZ_OK); return; };</span>
<a href="#l9.1039"></a><span id="l9.1039" class="difflineplus">+   if (!(bzf-&gt;writing))</span>
<a href="#l9.1040"></a><span id="l9.1040" class="difflineplus">+      { BZ_SETERR(BZ_SEQUENCE_ERROR); return; };</span>
<a href="#l9.1041"></a><span id="l9.1041" class="difflineplus">+   if (ferror(bzf-&gt;handle))</span>
<a href="#l9.1042"></a><span id="l9.1042" class="difflineplus">+      { BZ_SETERR(BZ_IO_ERROR); return; };</span>
<a href="#l9.1043"></a><span id="l9.1043" class="difflineplus">+</span>
<a href="#l9.1044"></a><span id="l9.1044" class="difflineplus">+   if (nbytes_in_lo32 != NULL) *nbytes_in_lo32 = 0;</span>
<a href="#l9.1045"></a><span id="l9.1045" class="difflineplus">+   if (nbytes_in_hi32 != NULL) *nbytes_in_hi32 = 0;</span>
<a href="#l9.1046"></a><span id="l9.1046" class="difflineplus">+   if (nbytes_out_lo32 != NULL) *nbytes_out_lo32 = 0;</span>
<a href="#l9.1047"></a><span id="l9.1047" class="difflineplus">+   if (nbytes_out_hi32 != NULL) *nbytes_out_hi32 = 0;</span>
<a href="#l9.1048"></a><span id="l9.1048" class="difflineplus">+</span>
<a href="#l9.1049"></a><span id="l9.1049" class="difflineplus">+   if ((!abandon) &amp;&amp; bzf-&gt;lastErr == BZ_OK) {</span>
<a href="#l9.1050"></a><span id="l9.1050" class="difflineplus">+      while (True) {</span>
<a href="#l9.1051"></a><span id="l9.1051" class="difflineplus">+         bzf-&gt;strm.avail_out = BZ_MAX_UNUSED;</span>
<a href="#l9.1052"></a><span id="l9.1052" class="difflineplus">+         bzf-&gt;strm.next_out = bzf-&gt;buf;</span>
<a href="#l9.1053"></a><span id="l9.1053" class="difflineplus">+         ret = BZ2_bzCompress ( &amp;(bzf-&gt;strm), BZ_FINISH );</span>
<a href="#l9.1054"></a><span id="l9.1054" class="difflineplus">+         if (ret != BZ_FINISH_OK &amp;&amp; ret != BZ_STREAM_END)</span>
<a href="#l9.1055"></a><span id="l9.1055" class="difflineplus">+            { BZ_SETERR(ret); return; };</span>
<a href="#l9.1056"></a><span id="l9.1056" class="difflineplus">+</span>
<a href="#l9.1057"></a><span id="l9.1057" class="difflineplus">+         if (bzf-&gt;strm.avail_out &lt; BZ_MAX_UNUSED) {</span>
<a href="#l9.1058"></a><span id="l9.1058" class="difflineplus">+            n = BZ_MAX_UNUSED - bzf-&gt;strm.avail_out;</span>
<a href="#l9.1059"></a><span id="l9.1059" class="difflineplus">+            n2 = fwrite ( (void*)(bzf-&gt;buf), sizeof(UChar), </span>
<a href="#l9.1060"></a><span id="l9.1060" class="difflineplus">+                          n, bzf-&gt;handle );</span>
<a href="#l9.1061"></a><span id="l9.1061" class="difflineplus">+            if (n != n2 || ferror(bzf-&gt;handle))</span>
<a href="#l9.1062"></a><span id="l9.1062" class="difflineplus">+               { BZ_SETERR(BZ_IO_ERROR); return; };</span>
<a href="#l9.1063"></a><span id="l9.1063" class="difflineplus">+         }</span>
<a href="#l9.1064"></a><span id="l9.1064" class="difflineplus">+</span>
<a href="#l9.1065"></a><span id="l9.1065" class="difflineplus">+         if (ret == BZ_STREAM_END) break;</span>
<a href="#l9.1066"></a><span id="l9.1066" class="difflineplus">+      }</span>
<a href="#l9.1067"></a><span id="l9.1067" class="difflineplus">+   }</span>
<a href="#l9.1068"></a><span id="l9.1068" class="difflineplus">+</span>
<a href="#l9.1069"></a><span id="l9.1069" class="difflineplus">+   if ( !abandon &amp;&amp; !ferror ( bzf-&gt;handle ) ) {</span>
<a href="#l9.1070"></a><span id="l9.1070" class="difflineplus">+      fflush ( bzf-&gt;handle );</span>
<a href="#l9.1071"></a><span id="l9.1071" class="difflineplus">+      if (ferror(bzf-&gt;handle))</span>
<a href="#l9.1072"></a><span id="l9.1072" class="difflineplus">+         { BZ_SETERR(BZ_IO_ERROR); return; };</span>
<a href="#l9.1073"></a><span id="l9.1073" class="difflineplus">+   }</span>
<a href="#l9.1074"></a><span id="l9.1074" class="difflineplus">+</span>
<a href="#l9.1075"></a><span id="l9.1075" class="difflineplus">+   if (nbytes_in_lo32 != NULL)</span>
<a href="#l9.1076"></a><span id="l9.1076" class="difflineplus">+      *nbytes_in_lo32 = bzf-&gt;strm.total_in_lo32;</span>
<a href="#l9.1077"></a><span id="l9.1077" class="difflineplus">+   if (nbytes_in_hi32 != NULL)</span>
<a href="#l9.1078"></a><span id="l9.1078" class="difflineplus">+      *nbytes_in_hi32 = bzf-&gt;strm.total_in_hi32;</span>
<a href="#l9.1079"></a><span id="l9.1079" class="difflineplus">+   if (nbytes_out_lo32 != NULL)</span>
<a href="#l9.1080"></a><span id="l9.1080" class="difflineplus">+      *nbytes_out_lo32 = bzf-&gt;strm.total_out_lo32;</span>
<a href="#l9.1081"></a><span id="l9.1081" class="difflineplus">+   if (nbytes_out_hi32 != NULL)</span>
<a href="#l9.1082"></a><span id="l9.1082" class="difflineplus">+      *nbytes_out_hi32 = bzf-&gt;strm.total_out_hi32;</span>
<a href="#l9.1083"></a><span id="l9.1083" class="difflineplus">+</span>
<a href="#l9.1084"></a><span id="l9.1084" class="difflineplus">+   BZ_SETERR(BZ_OK);</span>
<a href="#l9.1085"></a><span id="l9.1085" class="difflineplus">+   BZ2_bzCompressEnd ( &amp;(bzf-&gt;strm) );</span>
<a href="#l9.1086"></a><span id="l9.1086" class="difflineplus">+   free ( bzf );</span>
<a href="#l9.1087"></a><span id="l9.1087" class="difflineplus">+}</span>
<a href="#l9.1088"></a><span id="l9.1088" class="difflineplus">+</span>
<a href="#l9.1089"></a><span id="l9.1089" class="difflineplus">+</span>
<a href="#l9.1090"></a><span id="l9.1090" class="difflineplus">+/*---------------------------------------------------*/</span>
<a href="#l9.1091"></a><span id="l9.1091" class="difflineplus">+BZFILE* BZ_API(BZ2_bzReadOpen) </span>
<a href="#l9.1092"></a><span id="l9.1092" class="difflineplus">+                   ( int*  bzerror, </span>
<a href="#l9.1093"></a><span id="l9.1093" class="difflineplus">+                     FILE* f, </span>
<a href="#l9.1094"></a><span id="l9.1094" class="difflineplus">+                     int   verbosity,</span>
<a href="#l9.1095"></a><span id="l9.1095" class="difflineplus">+                     int   small,</span>
<a href="#l9.1096"></a><span id="l9.1096" class="difflineplus">+                     void* unused,</span>
<a href="#l9.1097"></a><span id="l9.1097" class="difflineplus">+                     int   nUnused )</span>
<a href="#l9.1098"></a><span id="l9.1098" class="difflineplus">+{</span>
<a href="#l9.1099"></a><span id="l9.1099" class="difflineplus">+   bzFile* bzf = NULL;</span>
<a href="#l9.1100"></a><span id="l9.1100" class="difflineplus">+   int     ret;</span>
<a href="#l9.1101"></a><span id="l9.1101" class="difflineplus">+</span>
<a href="#l9.1102"></a><span id="l9.1102" class="difflineplus">+   BZ_SETERR(BZ_OK);</span>
<a href="#l9.1103"></a><span id="l9.1103" class="difflineplus">+</span>
<a href="#l9.1104"></a><span id="l9.1104" class="difflineplus">+   if (f == NULL || </span>
<a href="#l9.1105"></a><span id="l9.1105" class="difflineplus">+       (small != 0 &amp;&amp; small != 1) ||</span>
<a href="#l9.1106"></a><span id="l9.1106" class="difflineplus">+       (verbosity &lt; 0 || verbosity &gt; 4) ||</span>
<a href="#l9.1107"></a><span id="l9.1107" class="difflineplus">+       (unused == NULL &amp;&amp; nUnused != 0) ||</span>
<a href="#l9.1108"></a><span id="l9.1108" class="difflineplus">+       (unused != NULL &amp;&amp; (nUnused &lt; 0 || nUnused &gt; BZ_MAX_UNUSED)))</span>
<a href="#l9.1109"></a><span id="l9.1109" class="difflineplus">+      { BZ_SETERR(BZ_PARAM_ERROR); return NULL; };</span>
<a href="#l9.1110"></a><span id="l9.1110" class="difflineplus">+</span>
<a href="#l9.1111"></a><span id="l9.1111" class="difflineplus">+   if (ferror(f))</span>
<a href="#l9.1112"></a><span id="l9.1112" class="difflineplus">+      { BZ_SETERR(BZ_IO_ERROR); return NULL; };</span>
<a href="#l9.1113"></a><span id="l9.1113" class="difflineplus">+</span>
<a href="#l9.1114"></a><span id="l9.1114" class="difflineplus">+   bzf = malloc ( sizeof(bzFile) );</span>
<a href="#l9.1115"></a><span id="l9.1115" class="difflineplus">+   if (bzf == NULL) </span>
<a href="#l9.1116"></a><span id="l9.1116" class="difflineplus">+      { BZ_SETERR(BZ_MEM_ERROR); return NULL; };</span>
<a href="#l9.1117"></a><span id="l9.1117" class="difflineplus">+</span>
<a href="#l9.1118"></a><span id="l9.1118" class="difflineplus">+   BZ_SETERR(BZ_OK);</span>
<a href="#l9.1119"></a><span id="l9.1119" class="difflineplus">+</span>
<a href="#l9.1120"></a><span id="l9.1120" class="difflineplus">+   bzf-&gt;initialisedOk = False;</span>
<a href="#l9.1121"></a><span id="l9.1121" class="difflineplus">+   bzf-&gt;handle        = f;</span>
<a href="#l9.1122"></a><span id="l9.1122" class="difflineplus">+   bzf-&gt;bufN          = 0;</span>
<a href="#l9.1123"></a><span id="l9.1123" class="difflineplus">+   bzf-&gt;writing       = False;</span>
<a href="#l9.1124"></a><span id="l9.1124" class="difflineplus">+   bzf-&gt;strm.bzalloc  = NULL;</span>
<a href="#l9.1125"></a><span id="l9.1125" class="difflineplus">+   bzf-&gt;strm.bzfree   = NULL;</span>
<a href="#l9.1126"></a><span id="l9.1126" class="difflineplus">+   bzf-&gt;strm.opaque   = NULL;</span>
<a href="#l9.1127"></a><span id="l9.1127" class="difflineplus">+   </span>
<a href="#l9.1128"></a><span id="l9.1128" class="difflineplus">+   while (nUnused &gt; 0) {</span>
<a href="#l9.1129"></a><span id="l9.1129" class="difflineplus">+      bzf-&gt;buf[bzf-&gt;bufN] = *((UChar*)(unused)); bzf-&gt;bufN++;</span>
<a href="#l9.1130"></a><span id="l9.1130" class="difflineplus">+      unused = ((void*)( 1 + ((UChar*)(unused))  ));</span>
<a href="#l9.1131"></a><span id="l9.1131" class="difflineplus">+      nUnused--;</span>
<a href="#l9.1132"></a><span id="l9.1132" class="difflineplus">+   }</span>
<a href="#l9.1133"></a><span id="l9.1133" class="difflineplus">+</span>
<a href="#l9.1134"></a><span id="l9.1134" class="difflineplus">+   ret = BZ2_bzDecompressInit ( &amp;(bzf-&gt;strm), verbosity, small );</span>
<a href="#l9.1135"></a><span id="l9.1135" class="difflineplus">+   if (ret != BZ_OK)</span>
<a href="#l9.1136"></a><span id="l9.1136" class="difflineplus">+      { BZ_SETERR(ret); free(bzf); return NULL; };</span>
<a href="#l9.1137"></a><span id="l9.1137" class="difflineplus">+</span>
<a href="#l9.1138"></a><span id="l9.1138" class="difflineplus">+   bzf-&gt;strm.avail_in = bzf-&gt;bufN;</span>
<a href="#l9.1139"></a><span id="l9.1139" class="difflineplus">+   bzf-&gt;strm.next_in  = bzf-&gt;buf;</span>
<a href="#l9.1140"></a><span id="l9.1140" class="difflineplus">+</span>
<a href="#l9.1141"></a><span id="l9.1141" class="difflineplus">+   bzf-&gt;initialisedOk = True;</span>
<a href="#l9.1142"></a><span id="l9.1142" class="difflineplus">+   return bzf;   </span>
<a href="#l9.1143"></a><span id="l9.1143" class="difflineplus">+}</span>
<a href="#l9.1144"></a><span id="l9.1144" class="difflineplus">+</span>
<a href="#l9.1145"></a><span id="l9.1145" class="difflineplus">+</span>
<a href="#l9.1146"></a><span id="l9.1146" class="difflineplus">+/*---------------------------------------------------*/</span>
<a href="#l9.1147"></a><span id="l9.1147" class="difflineplus">+void BZ_API(BZ2_bzReadClose) ( int *bzerror, BZFILE *b )</span>
<a href="#l9.1148"></a><span id="l9.1148" class="difflineplus">+{</span>
<a href="#l9.1149"></a><span id="l9.1149" class="difflineplus">+   bzFile* bzf = (bzFile*)b;</span>
<a href="#l9.1150"></a><span id="l9.1150" class="difflineplus">+</span>
<a href="#l9.1151"></a><span id="l9.1151" class="difflineplus">+   BZ_SETERR(BZ_OK);</span>
<a href="#l9.1152"></a><span id="l9.1152" class="difflineplus">+   if (bzf == NULL)</span>
<a href="#l9.1153"></a><span id="l9.1153" class="difflineplus">+      { BZ_SETERR(BZ_OK); return; };</span>
<a href="#l9.1154"></a><span id="l9.1154" class="difflineplus">+</span>
<a href="#l9.1155"></a><span id="l9.1155" class="difflineplus">+   if (bzf-&gt;writing)</span>
<a href="#l9.1156"></a><span id="l9.1156" class="difflineplus">+      { BZ_SETERR(BZ_SEQUENCE_ERROR); return; };</span>
<a href="#l9.1157"></a><span id="l9.1157" class="difflineplus">+</span>
<a href="#l9.1158"></a><span id="l9.1158" class="difflineplus">+   if (bzf-&gt;initialisedOk)</span>
<a href="#l9.1159"></a><span id="l9.1159" class="difflineplus">+      (void)BZ2_bzDecompressEnd ( &amp;(bzf-&gt;strm) );</span>
<a href="#l9.1160"></a><span id="l9.1160" class="difflineplus">+   free ( bzf );</span>
<a href="#l9.1161"></a><span id="l9.1161" class="difflineplus">+}</span>
<a href="#l9.1162"></a><span id="l9.1162" class="difflineplus">+</span>
<a href="#l9.1163"></a><span id="l9.1163" class="difflineplus">+</span>
<a href="#l9.1164"></a><span id="l9.1164" class="difflineplus">+/*---------------------------------------------------*/</span>
<a href="#l9.1165"></a><span id="l9.1165" class="difflineplus">+int BZ_API(BZ2_bzRead) </span>
<a href="#l9.1166"></a><span id="l9.1166" class="difflineplus">+           ( int*    bzerror, </span>
<a href="#l9.1167"></a><span id="l9.1167" class="difflineplus">+             BZFILE* b, </span>
<a href="#l9.1168"></a><span id="l9.1168" class="difflineplus">+             void*   buf, </span>
<a href="#l9.1169"></a><span id="l9.1169" class="difflineplus">+             int     len )</span>
<a href="#l9.1170"></a><span id="l9.1170" class="difflineplus">+{</span>
<a href="#l9.1171"></a><span id="l9.1171" class="difflineplus">+   Int32   n, ret;</span>
<a href="#l9.1172"></a><span id="l9.1172" class="difflineplus">+   bzFile* bzf = (bzFile*)b;</span>
<a href="#l9.1173"></a><span id="l9.1173" class="difflineplus">+</span>
<a href="#l9.1174"></a><span id="l9.1174" class="difflineplus">+   BZ_SETERR(BZ_OK);</span>
<a href="#l9.1175"></a><span id="l9.1175" class="difflineplus">+</span>
<a href="#l9.1176"></a><span id="l9.1176" class="difflineplus">+   if (bzf == NULL || buf == NULL || len &lt; 0)</span>
<a href="#l9.1177"></a><span id="l9.1177" class="difflineplus">+      { BZ_SETERR(BZ_PARAM_ERROR); return 0; };</span>
<a href="#l9.1178"></a><span id="l9.1178" class="difflineplus">+</span>
<a href="#l9.1179"></a><span id="l9.1179" class="difflineplus">+   if (bzf-&gt;writing)</span>
<a href="#l9.1180"></a><span id="l9.1180" class="difflineplus">+      { BZ_SETERR(BZ_SEQUENCE_ERROR); return 0; };</span>
<a href="#l9.1181"></a><span id="l9.1181" class="difflineplus">+</span>
<a href="#l9.1182"></a><span id="l9.1182" class="difflineplus">+   if (len == 0)</span>
<a href="#l9.1183"></a><span id="l9.1183" class="difflineplus">+      { BZ_SETERR(BZ_OK); return 0; };</span>
<a href="#l9.1184"></a><span id="l9.1184" class="difflineplus">+</span>
<a href="#l9.1185"></a><span id="l9.1185" class="difflineplus">+   bzf-&gt;strm.avail_out = len;</span>
<a href="#l9.1186"></a><span id="l9.1186" class="difflineplus">+   bzf-&gt;strm.next_out = buf;</span>
<a href="#l9.1187"></a><span id="l9.1187" class="difflineplus">+</span>
<a href="#l9.1188"></a><span id="l9.1188" class="difflineplus">+   while (True) {</span>
<a href="#l9.1189"></a><span id="l9.1189" class="difflineplus">+</span>
<a href="#l9.1190"></a><span id="l9.1190" class="difflineplus">+      if (ferror(bzf-&gt;handle)) </span>
<a href="#l9.1191"></a><span id="l9.1191" class="difflineplus">+         { BZ_SETERR(BZ_IO_ERROR); return 0; };</span>
<a href="#l9.1192"></a><span id="l9.1192" class="difflineplus">+</span>
<a href="#l9.1193"></a><span id="l9.1193" class="difflineplus">+      if (bzf-&gt;strm.avail_in == 0 &amp;&amp; !myfeof(bzf-&gt;handle)) {</span>
<a href="#l9.1194"></a><span id="l9.1194" class="difflineplus">+         n = fread ( bzf-&gt;buf, sizeof(UChar), </span>
<a href="#l9.1195"></a><span id="l9.1195" class="difflineplus">+                     BZ_MAX_UNUSED, bzf-&gt;handle );</span>
<a href="#l9.1196"></a><span id="l9.1196" class="difflineplus">+         if (ferror(bzf-&gt;handle))</span>
<a href="#l9.1197"></a><span id="l9.1197" class="difflineplus">+            { BZ_SETERR(BZ_IO_ERROR); return 0; };</span>
<a href="#l9.1198"></a><span id="l9.1198" class="difflineplus">+         bzf-&gt;bufN = n;</span>
<a href="#l9.1199"></a><span id="l9.1199" class="difflineplus">+         bzf-&gt;strm.avail_in = bzf-&gt;bufN;</span>
<a href="#l9.1200"></a><span id="l9.1200" class="difflineplus">+         bzf-&gt;strm.next_in = bzf-&gt;buf;</span>
<a href="#l9.1201"></a><span id="l9.1201" class="difflineplus">+      }</span>
<a href="#l9.1202"></a><span id="l9.1202" class="difflineplus">+</span>
<a href="#l9.1203"></a><span id="l9.1203" class="difflineplus">+      ret = BZ2_bzDecompress ( &amp;(bzf-&gt;strm) );</span>
<a href="#l9.1204"></a><span id="l9.1204" class="difflineplus">+</span>
<a href="#l9.1205"></a><span id="l9.1205" class="difflineplus">+      if (ret != BZ_OK &amp;&amp; ret != BZ_STREAM_END)</span>
<a href="#l9.1206"></a><span id="l9.1206" class="difflineplus">+         { BZ_SETERR(ret); return 0; };</span>
<a href="#l9.1207"></a><span id="l9.1207" class="difflineplus">+</span>
<a href="#l9.1208"></a><span id="l9.1208" class="difflineplus">+      if (ret == BZ_OK &amp;&amp; myfeof(bzf-&gt;handle) &amp;&amp; </span>
<a href="#l9.1209"></a><span id="l9.1209" class="difflineplus">+          bzf-&gt;strm.avail_in == 0 &amp;&amp; bzf-&gt;strm.avail_out &gt; 0)</span>
<a href="#l9.1210"></a><span id="l9.1210" class="difflineplus">+         { BZ_SETERR(BZ_UNEXPECTED_EOF); return 0; };</span>
<a href="#l9.1211"></a><span id="l9.1211" class="difflineplus">+</span>
<a href="#l9.1212"></a><span id="l9.1212" class="difflineplus">+      if (ret == BZ_STREAM_END)</span>
<a href="#l9.1213"></a><span id="l9.1213" class="difflineplus">+         { BZ_SETERR(BZ_STREAM_END);</span>
<a href="#l9.1214"></a><span id="l9.1214" class="difflineplus">+           return len - bzf-&gt;strm.avail_out; };</span>
<a href="#l9.1215"></a><span id="l9.1215" class="difflineplus">+      if (bzf-&gt;strm.avail_out == 0)</span>
<a href="#l9.1216"></a><span id="l9.1216" class="difflineplus">+         { BZ_SETERR(BZ_OK); return len; };</span>
<a href="#l9.1217"></a><span id="l9.1217" class="difflineplus">+      </span>
<a href="#l9.1218"></a><span id="l9.1218" class="difflineplus">+   }</span>
<a href="#l9.1219"></a><span id="l9.1219" class="difflineplus">+</span>
<a href="#l9.1220"></a><span id="l9.1220" class="difflineplus">+   return 0; /*not reached*/</span>
<a href="#l9.1221"></a><span id="l9.1221" class="difflineplus">+}</span>
<a href="#l9.1222"></a><span id="l9.1222" class="difflineplus">+</span>
<a href="#l9.1223"></a><span id="l9.1223" class="difflineplus">+</span>
<a href="#l9.1224"></a><span id="l9.1224" class="difflineplus">+/*---------------------------------------------------*/</span>
<a href="#l9.1225"></a><span id="l9.1225" class="difflineplus">+void BZ_API(BZ2_bzReadGetUnused) </span>
<a href="#l9.1226"></a><span id="l9.1226" class="difflineplus">+                     ( int*    bzerror, </span>
<a href="#l9.1227"></a><span id="l9.1227" class="difflineplus">+                       BZFILE* b, </span>
<a href="#l9.1228"></a><span id="l9.1228" class="difflineplus">+                       void**  unused, </span>
<a href="#l9.1229"></a><span id="l9.1229" class="difflineplus">+                       int*    nUnused )</span>
<a href="#l9.1230"></a><span id="l9.1230" class="difflineplus">+{</span>
<a href="#l9.1231"></a><span id="l9.1231" class="difflineplus">+   bzFile* bzf = (bzFile*)b;</span>
<a href="#l9.1232"></a><span id="l9.1232" class="difflineplus">+   if (bzf == NULL)</span>
<a href="#l9.1233"></a><span id="l9.1233" class="difflineplus">+      { BZ_SETERR(BZ_PARAM_ERROR); return; };</span>
<a href="#l9.1234"></a><span id="l9.1234" class="difflineplus">+   if (bzf-&gt;lastErr != BZ_STREAM_END)</span>
<a href="#l9.1235"></a><span id="l9.1235" class="difflineplus">+      { BZ_SETERR(BZ_SEQUENCE_ERROR); return; };</span>
<a href="#l9.1236"></a><span id="l9.1236" class="difflineplus">+   if (unused == NULL || nUnused == NULL)</span>
<a href="#l9.1237"></a><span id="l9.1237" class="difflineplus">+      { BZ_SETERR(BZ_PARAM_ERROR); return; };</span>
<a href="#l9.1238"></a><span id="l9.1238" class="difflineplus">+</span>
<a href="#l9.1239"></a><span id="l9.1239" class="difflineplus">+   BZ_SETERR(BZ_OK);</span>
<a href="#l9.1240"></a><span id="l9.1240" class="difflineplus">+   *nUnused = bzf-&gt;strm.avail_in;</span>
<a href="#l9.1241"></a><span id="l9.1241" class="difflineplus">+   *unused = bzf-&gt;strm.next_in;</span>
<a href="#l9.1242"></a><span id="l9.1242" class="difflineplus">+}</span>
<a href="#l9.1243"></a><span id="l9.1243" class="difflineplus">+#endif</span>
<a href="#l9.1244"></a><span id="l9.1244" class="difflineplus">+</span>
<a href="#l9.1245"></a><span id="l9.1245" class="difflineplus">+</span>
<a href="#l9.1246"></a><span id="l9.1246" class="difflineplus">+/*---------------------------------------------------*/</span>
<a href="#l9.1247"></a><span id="l9.1247" class="difflineplus">+/*--- Misc convenience stuff                      ---*/</span>
<a href="#l9.1248"></a><span id="l9.1248" class="difflineplus">+/*---------------------------------------------------*/</span>
<a href="#l9.1249"></a><span id="l9.1249" class="difflineplus">+</span>
<a href="#l9.1250"></a><span id="l9.1250" class="difflineplus">+/*---------------------------------------------------*/</span>
<a href="#l9.1251"></a><span id="l9.1251" class="difflineplus">+int BZ_API(BZ2_bzBuffToBuffCompress) </span>
<a href="#l9.1252"></a><span id="l9.1252" class="difflineplus">+                         ( char*         dest, </span>
<a href="#l9.1253"></a><span id="l9.1253" class="difflineplus">+                           unsigned int* destLen,</span>
<a href="#l9.1254"></a><span id="l9.1254" class="difflineplus">+                           char*         source, </span>
<a href="#l9.1255"></a><span id="l9.1255" class="difflineplus">+                           unsigned int  sourceLen,</span>
<a href="#l9.1256"></a><span id="l9.1256" class="difflineplus">+                           int           blockSize100k, </span>
<a href="#l9.1257"></a><span id="l9.1257" class="difflineplus">+                           int           verbosity, </span>
<a href="#l9.1258"></a><span id="l9.1258" class="difflineplus">+                           int           workFactor )</span>
<a href="#l9.1259"></a><span id="l9.1259" class="difflineplus">+{</span>
<a href="#l9.1260"></a><span id="l9.1260" class="difflineplus">+   bz_stream strm;</span>
<a href="#l9.1261"></a><span id="l9.1261" class="difflineplus">+   int ret;</span>
<a href="#l9.1262"></a><span id="l9.1262" class="difflineplus">+</span>
<a href="#l9.1263"></a><span id="l9.1263" class="difflineplus">+   if (dest == NULL || destLen == NULL || </span>
<a href="#l9.1264"></a><span id="l9.1264" class="difflineplus">+       source == NULL ||</span>
<a href="#l9.1265"></a><span id="l9.1265" class="difflineplus">+       blockSize100k &lt; 1 || blockSize100k &gt; 9 ||</span>
<a href="#l9.1266"></a><span id="l9.1266" class="difflineplus">+       verbosity &lt; 0 || verbosity &gt; 4 ||</span>
<a href="#l9.1267"></a><span id="l9.1267" class="difflineplus">+       workFactor &lt; 0 || workFactor &gt; 250) </span>
<a href="#l9.1268"></a><span id="l9.1268" class="difflineplus">+      return BZ_PARAM_ERROR;</span>
<a href="#l9.1269"></a><span id="l9.1269" class="difflineplus">+</span>
<a href="#l9.1270"></a><span id="l9.1270" class="difflineplus">+   if (workFactor == 0) workFactor = 30;</span>
<a href="#l9.1271"></a><span id="l9.1271" class="difflineplus">+   strm.bzalloc = NULL;</span>
<a href="#l9.1272"></a><span id="l9.1272" class="difflineplus">+   strm.bzfree = NULL;</span>
<a href="#l9.1273"></a><span id="l9.1273" class="difflineplus">+   strm.opaque = NULL;</span>
<a href="#l9.1274"></a><span id="l9.1274" class="difflineplus">+   ret = BZ2_bzCompressInit ( &amp;strm, blockSize100k, </span>
<a href="#l9.1275"></a><span id="l9.1275" class="difflineplus">+                              verbosity, workFactor );</span>
<a href="#l9.1276"></a><span id="l9.1276" class="difflineplus">+   if (ret != BZ_OK) return ret;</span>
<a href="#l9.1277"></a><span id="l9.1277" class="difflineplus">+</span>
<a href="#l9.1278"></a><span id="l9.1278" class="difflineplus">+   strm.next_in = source;</span>
<a href="#l9.1279"></a><span id="l9.1279" class="difflineplus">+   strm.next_out = dest;</span>
<a href="#l9.1280"></a><span id="l9.1280" class="difflineplus">+   strm.avail_in = sourceLen;</span>
<a href="#l9.1281"></a><span id="l9.1281" class="difflineplus">+   strm.avail_out = *destLen;</span>
<a href="#l9.1282"></a><span id="l9.1282" class="difflineplus">+</span>
<a href="#l9.1283"></a><span id="l9.1283" class="difflineplus">+   ret = BZ2_bzCompress ( &amp;strm, BZ_FINISH );</span>
<a href="#l9.1284"></a><span id="l9.1284" class="difflineplus">+   if (ret == BZ_FINISH_OK) goto output_overflow;</span>
<a href="#l9.1285"></a><span id="l9.1285" class="difflineplus">+   if (ret != BZ_STREAM_END) goto errhandler;</span>
<a href="#l9.1286"></a><span id="l9.1286" class="difflineplus">+</span>
<a href="#l9.1287"></a><span id="l9.1287" class="difflineplus">+   /* normal termination */</span>
<a href="#l9.1288"></a><span id="l9.1288" class="difflineplus">+   *destLen -= strm.avail_out;   </span>
<a href="#l9.1289"></a><span id="l9.1289" class="difflineplus">+   BZ2_bzCompressEnd ( &amp;strm );</span>
<a href="#l9.1290"></a><span id="l9.1290" class="difflineplus">+   return BZ_OK;</span>
<a href="#l9.1291"></a><span id="l9.1291" class="difflineplus">+</span>
<a href="#l9.1292"></a><span id="l9.1292" class="difflineplus">+   output_overflow:</span>
<a href="#l9.1293"></a><span id="l9.1293" class="difflineplus">+   BZ2_bzCompressEnd ( &amp;strm );</span>
<a href="#l9.1294"></a><span id="l9.1294" class="difflineplus">+   return BZ_OUTBUFF_FULL;</span>
<a href="#l9.1295"></a><span id="l9.1295" class="difflineplus">+</span>
<a href="#l9.1296"></a><span id="l9.1296" class="difflineplus">+   errhandler:</span>
<a href="#l9.1297"></a><span id="l9.1297" class="difflineplus">+   BZ2_bzCompressEnd ( &amp;strm );</span>
<a href="#l9.1298"></a><span id="l9.1298" class="difflineplus">+   return ret;</span>
<a href="#l9.1299"></a><span id="l9.1299" class="difflineplus">+}</span>
<a href="#l9.1300"></a><span id="l9.1300" class="difflineplus">+</span>
<a href="#l9.1301"></a><span id="l9.1301" class="difflineplus">+</span>
<a href="#l9.1302"></a><span id="l9.1302" class="difflineplus">+/*---------------------------------------------------*/</span>
<a href="#l9.1303"></a><span id="l9.1303" class="difflineplus">+int BZ_API(BZ2_bzBuffToBuffDecompress) </span>
<a href="#l9.1304"></a><span id="l9.1304" class="difflineplus">+                           ( char*         dest, </span>
<a href="#l9.1305"></a><span id="l9.1305" class="difflineplus">+                             unsigned int* destLen,</span>
<a href="#l9.1306"></a><span id="l9.1306" class="difflineplus">+                             char*         source, </span>
<a href="#l9.1307"></a><span id="l9.1307" class="difflineplus">+                             unsigned int  sourceLen,</span>
<a href="#l9.1308"></a><span id="l9.1308" class="difflineplus">+                             int           small,</span>
<a href="#l9.1309"></a><span id="l9.1309" class="difflineplus">+                             int           verbosity )</span>
<a href="#l9.1310"></a><span id="l9.1310" class="difflineplus">+{</span>
<a href="#l9.1311"></a><span id="l9.1311" class="difflineplus">+   bz_stream strm;</span>
<a href="#l9.1312"></a><span id="l9.1312" class="difflineplus">+   int ret;</span>
<a href="#l9.1313"></a><span id="l9.1313" class="difflineplus">+</span>
<a href="#l9.1314"></a><span id="l9.1314" class="difflineplus">+   if (dest == NULL || destLen == NULL || </span>
<a href="#l9.1315"></a><span id="l9.1315" class="difflineplus">+       source == NULL ||</span>
<a href="#l9.1316"></a><span id="l9.1316" class="difflineplus">+       (small != 0 &amp;&amp; small != 1) ||</span>
<a href="#l9.1317"></a><span id="l9.1317" class="difflineplus">+       verbosity &lt; 0 || verbosity &gt; 4) </span>
<a href="#l9.1318"></a><span id="l9.1318" class="difflineplus">+          return BZ_PARAM_ERROR;</span>
<a href="#l9.1319"></a><span id="l9.1319" class="difflineplus">+</span>
<a href="#l9.1320"></a><span id="l9.1320" class="difflineplus">+   strm.bzalloc = NULL;</span>
<a href="#l9.1321"></a><span id="l9.1321" class="difflineplus">+   strm.bzfree = NULL;</span>
<a href="#l9.1322"></a><span id="l9.1322" class="difflineplus">+   strm.opaque = NULL;</span>
<a href="#l9.1323"></a><span id="l9.1323" class="difflineplus">+   ret = BZ2_bzDecompressInit ( &amp;strm, verbosity, small );</span>
<a href="#l9.1324"></a><span id="l9.1324" class="difflineplus">+   if (ret != BZ_OK) return ret;</span>
<a href="#l9.1325"></a><span id="l9.1325" class="difflineplus">+</span>
<a href="#l9.1326"></a><span id="l9.1326" class="difflineplus">+   strm.next_in = source;</span>
<a href="#l9.1327"></a><span id="l9.1327" class="difflineplus">+   strm.next_out = dest;</span>
<a href="#l9.1328"></a><span id="l9.1328" class="difflineplus">+   strm.avail_in = sourceLen;</span>
<a href="#l9.1329"></a><span id="l9.1329" class="difflineplus">+   strm.avail_out = *destLen;</span>
<a href="#l9.1330"></a><span id="l9.1330" class="difflineplus">+</span>
<a href="#l9.1331"></a><span id="l9.1331" class="difflineplus">+   ret = BZ2_bzDecompress ( &amp;strm );</span>
<a href="#l9.1332"></a><span id="l9.1332" class="difflineplus">+   if (ret == BZ_OK) goto output_overflow_or_eof;</span>
<a href="#l9.1333"></a><span id="l9.1333" class="difflineplus">+   if (ret != BZ_STREAM_END) goto errhandler;</span>
<a href="#l9.1334"></a><span id="l9.1334" class="difflineplus">+</span>
<a href="#l9.1335"></a><span id="l9.1335" class="difflineplus">+   /* normal termination */</span>
<a href="#l9.1336"></a><span id="l9.1336" class="difflineplus">+   *destLen -= strm.avail_out;</span>
<a href="#l9.1337"></a><span id="l9.1337" class="difflineplus">+   BZ2_bzDecompressEnd ( &amp;strm );</span>
<a href="#l9.1338"></a><span id="l9.1338" class="difflineplus">+   return BZ_OK;</span>
<a href="#l9.1339"></a><span id="l9.1339" class="difflineplus">+</span>
<a href="#l9.1340"></a><span id="l9.1340" class="difflineplus">+   output_overflow_or_eof:</span>
<a href="#l9.1341"></a><span id="l9.1341" class="difflineplus">+   if (strm.avail_out &gt; 0) {</span>
<a href="#l9.1342"></a><span id="l9.1342" class="difflineplus">+      BZ2_bzDecompressEnd ( &amp;strm );</span>
<a href="#l9.1343"></a><span id="l9.1343" class="difflineplus">+      return BZ_UNEXPECTED_EOF;</span>
<a href="#l9.1344"></a><span id="l9.1344" class="difflineplus">+   } else {</span>
<a href="#l9.1345"></a><span id="l9.1345" class="difflineplus">+      BZ2_bzDecompressEnd ( &amp;strm );</span>
<a href="#l9.1346"></a><span id="l9.1346" class="difflineplus">+      return BZ_OUTBUFF_FULL;</span>
<a href="#l9.1347"></a><span id="l9.1347" class="difflineplus">+   };      </span>
<a href="#l9.1348"></a><span id="l9.1348" class="difflineplus">+</span>
<a href="#l9.1349"></a><span id="l9.1349" class="difflineplus">+   errhandler:</span>
<a href="#l9.1350"></a><span id="l9.1350" class="difflineplus">+   BZ2_bzDecompressEnd ( &amp;strm );</span>
<a href="#l9.1351"></a><span id="l9.1351" class="difflineplus">+   return ret; </span>
<a href="#l9.1352"></a><span id="l9.1352" class="difflineplus">+}</span>
<a href="#l9.1353"></a><span id="l9.1353" class="difflineplus">+</span>
<a href="#l9.1354"></a><span id="l9.1354" class="difflineplus">+</span>
<a href="#l9.1355"></a><span id="l9.1355" class="difflineplus">+/*---------------------------------------------------*/</span>
<a href="#l9.1356"></a><span id="l9.1356" class="difflineplus">+/*--</span>
<a href="#l9.1357"></a><span id="l9.1357" class="difflineplus">+   Code contributed by Yoshioka Tsuneo (tsuneo@rr.iij4u.or.jp)</span>
<a href="#l9.1358"></a><span id="l9.1358" class="difflineplus">+   to support better zlib compatibility.</span>
<a href="#l9.1359"></a><span id="l9.1359" class="difflineplus">+   This code is not _officially_ part of libbzip2 (yet);</span>
<a href="#l9.1360"></a><span id="l9.1360" class="difflineplus">+   I haven't tested it, documented it, or considered the</span>
<a href="#l9.1361"></a><span id="l9.1361" class="difflineplus">+   threading-safeness of it.</span>
<a href="#l9.1362"></a><span id="l9.1362" class="difflineplus">+   If this code breaks, please contact both Yoshioka and me.</span>
<a href="#l9.1363"></a><span id="l9.1363" class="difflineplus">+--*/</span>
<a href="#l9.1364"></a><span id="l9.1364" class="difflineplus">+/*---------------------------------------------------*/</span>
<a href="#l9.1365"></a><span id="l9.1365" class="difflineplus">+</span>
<a href="#l9.1366"></a><span id="l9.1366" class="difflineplus">+/*---------------------------------------------------*/</span>
<a href="#l9.1367"></a><span id="l9.1367" class="difflineplus">+/*--</span>
<a href="#l9.1368"></a><span id="l9.1368" class="difflineplus">+   return version like &quot;0.9.5d, 4-Sept-1999&quot;.</span>
<a href="#l9.1369"></a><span id="l9.1369" class="difflineplus">+--*/</span>
<a href="#l9.1370"></a><span id="l9.1370" class="difflineplus">+const char * BZ_API(BZ2_bzlibVersion)(void)</span>
<a href="#l9.1371"></a><span id="l9.1371" class="difflineplus">+{</span>
<a href="#l9.1372"></a><span id="l9.1372" class="difflineplus">+   return BZ_VERSION;</span>
<a href="#l9.1373"></a><span id="l9.1373" class="difflineplus">+}</span>
<a href="#l9.1374"></a><span id="l9.1374" class="difflineplus">+</span>
<a href="#l9.1375"></a><span id="l9.1375" class="difflineplus">+</span>
<a href="#l9.1376"></a><span id="l9.1376" class="difflineplus">+#ifndef BZ_NO_STDIO</span>
<a href="#l9.1377"></a><span id="l9.1377" class="difflineplus">+/*---------------------------------------------------*/</span>
<a href="#l9.1378"></a><span id="l9.1378" class="difflineplus">+</span>
<a href="#l9.1379"></a><span id="l9.1379" class="difflineplus">+#if defined(_WIN32) || defined(OS2) || defined(MSDOS)</span>
<a href="#l9.1380"></a><span id="l9.1380" class="difflineplus">+#   include &lt;fcntl.h&gt;</span>
<a href="#l9.1381"></a><span id="l9.1381" class="difflineplus">+#   include &lt;io.h&gt;</span>
<a href="#l9.1382"></a><span id="l9.1382" class="difflineplus">+#   define SET_BINARY_MODE(file) setmode(fileno(file),O_BINARY)</span>
<a href="#l9.1383"></a><span id="l9.1383" class="difflineplus">+#else</span>
<a href="#l9.1384"></a><span id="l9.1384" class="difflineplus">+#   define SET_BINARY_MODE(file)</span>
<a href="#l9.1385"></a><span id="l9.1385" class="difflineplus">+#endif</span>
<a href="#l9.1386"></a><span id="l9.1386" class="difflineplus">+static</span>
<a href="#l9.1387"></a><span id="l9.1387" class="difflineplus">+BZFILE * bzopen_or_bzdopen</span>
<a href="#l9.1388"></a><span id="l9.1388" class="difflineplus">+               ( const char *path,   /* no use when bzdopen */</span>
<a href="#l9.1389"></a><span id="l9.1389" class="difflineplus">+                 int fd,             /* no use when bzdopen */</span>
<a href="#l9.1390"></a><span id="l9.1390" class="difflineplus">+                 const char *mode,</span>
<a href="#l9.1391"></a><span id="l9.1391" class="difflineplus">+                 int open_mode)      /* bzopen: 0, bzdopen:1 */</span>
<a href="#l9.1392"></a><span id="l9.1392" class="difflineplus">+{</span>
<a href="#l9.1393"></a><span id="l9.1393" class="difflineplus">+   int    bzerr;</span>
<a href="#l9.1394"></a><span id="l9.1394" class="difflineplus">+   char   unused[BZ_MAX_UNUSED];</span>
<a href="#l9.1395"></a><span id="l9.1395" class="difflineplus">+   int    blockSize100k = 9;</span>
<a href="#l9.1396"></a><span id="l9.1396" class="difflineplus">+   int    writing       = 0;</span>
<a href="#l9.1397"></a><span id="l9.1397" class="difflineplus">+   char   mode2[10]     = &quot;&quot;;</span>
<a href="#l9.1398"></a><span id="l9.1398" class="difflineplus">+   FILE   *fp           = NULL;</span>
<a href="#l9.1399"></a><span id="l9.1399" class="difflineplus">+   BZFILE *bzfp         = NULL;</span>
<a href="#l9.1400"></a><span id="l9.1400" class="difflineplus">+   int    verbosity     = 0;</span>
<a href="#l9.1401"></a><span id="l9.1401" class="difflineplus">+   int    workFactor    = 30;</span>
<a href="#l9.1402"></a><span id="l9.1402" class="difflineplus">+   int    smallMode     = 0;</span>
<a href="#l9.1403"></a><span id="l9.1403" class="difflineplus">+   int    nUnused       = 0; </span>
<a href="#l9.1404"></a><span id="l9.1404" class="difflineplus">+</span>
<a href="#l9.1405"></a><span id="l9.1405" class="difflineplus">+   if (mode == NULL) return NULL;</span>
<a href="#l9.1406"></a><span id="l9.1406" class="difflineplus">+   while (*mode) {</span>
<a href="#l9.1407"></a><span id="l9.1407" class="difflineplus">+      switch (*mode) {</span>
<a href="#l9.1408"></a><span id="l9.1408" class="difflineplus">+      case 'r':</span>
<a href="#l9.1409"></a><span id="l9.1409" class="difflineplus">+         writing = 0; break;</span>
<a href="#l9.1410"></a><span id="l9.1410" class="difflineplus">+      case 'w':</span>
<a href="#l9.1411"></a><span id="l9.1411" class="difflineplus">+         writing = 1; break;</span>
<a href="#l9.1412"></a><span id="l9.1412" class="difflineplus">+      case 's':</span>
<a href="#l9.1413"></a><span id="l9.1413" class="difflineplus">+         smallMode = 1; break;</span>
<a href="#l9.1414"></a><span id="l9.1414" class="difflineplus">+      default:</span>
<a href="#l9.1415"></a><span id="l9.1415" class="difflineplus">+         if (isdigit((int)(*mode))) {</span>
<a href="#l9.1416"></a><span id="l9.1416" class="difflineplus">+            blockSize100k = *mode-BZ_HDR_0;</span>
<a href="#l9.1417"></a><span id="l9.1417" class="difflineplus">+         }</span>
<a href="#l9.1418"></a><span id="l9.1418" class="difflineplus">+      }</span>
<a href="#l9.1419"></a><span id="l9.1419" class="difflineplus">+      mode++;</span>
<a href="#l9.1420"></a><span id="l9.1420" class="difflineplus">+   }</span>
<a href="#l9.1421"></a><span id="l9.1421" class="difflineplus">+   strcat(mode2, writing ? &quot;w&quot; : &quot;r&quot; );</span>
<a href="#l9.1422"></a><span id="l9.1422" class="difflineplus">+   strcat(mode2,&quot;b&quot;);   /* binary mode */</span>
<a href="#l9.1423"></a><span id="l9.1423" class="difflineplus">+</span>
<a href="#l9.1424"></a><span id="l9.1424" class="difflineplus">+   if (open_mode==0) {</span>
<a href="#l9.1425"></a><span id="l9.1425" class="difflineplus">+      if (path==NULL || strcmp(path,&quot;&quot;)==0) {</span>
<a href="#l9.1426"></a><span id="l9.1426" class="difflineplus">+        fp = (writing ? stdout : stdin);</span>
<a href="#l9.1427"></a><span id="l9.1427" class="difflineplus">+        SET_BINARY_MODE(fp);</span>
<a href="#l9.1428"></a><span id="l9.1428" class="difflineplus">+      } else {</span>
<a href="#l9.1429"></a><span id="l9.1429" class="difflineplus">+        fp = fopen(path,mode2);</span>
<a href="#l9.1430"></a><span id="l9.1430" class="difflineplus">+      }</span>
<a href="#l9.1431"></a><span id="l9.1431" class="difflineplus">+   } else {</span>
<a href="#l9.1432"></a><span id="l9.1432" class="difflineplus">+#ifdef BZ_STRICT_ANSI</span>
<a href="#l9.1433"></a><span id="l9.1433" class="difflineplus">+      fp = NULL;</span>
<a href="#l9.1434"></a><span id="l9.1434" class="difflineplus">+#else</span>
<a href="#l9.1435"></a><span id="l9.1435" class="difflineplus">+      fp = fdopen(fd,mode2);</span>
<a href="#l9.1436"></a><span id="l9.1436" class="difflineplus">+#endif</span>
<a href="#l9.1437"></a><span id="l9.1437" class="difflineplus">+   }</span>
<a href="#l9.1438"></a><span id="l9.1438" class="difflineplus">+   if (fp == NULL) return NULL;</span>
<a href="#l9.1439"></a><span id="l9.1439" class="difflineplus">+</span>
<a href="#l9.1440"></a><span id="l9.1440" class="difflineplus">+   if (writing) {</span>
<a href="#l9.1441"></a><span id="l9.1441" class="difflineplus">+      /* Guard against total chaos and anarchy -- JRS */</span>
<a href="#l9.1442"></a><span id="l9.1442" class="difflineplus">+      if (blockSize100k &lt; 1) blockSize100k = 1;</span>
<a href="#l9.1443"></a><span id="l9.1443" class="difflineplus">+      if (blockSize100k &gt; 9) blockSize100k = 9; </span>
<a href="#l9.1444"></a><span id="l9.1444" class="difflineplus">+      bzfp = BZ2_bzWriteOpen(&amp;bzerr,fp,blockSize100k,</span>
<a href="#l9.1445"></a><span id="l9.1445" class="difflineplus">+                             verbosity,workFactor);</span>
<a href="#l9.1446"></a><span id="l9.1446" class="difflineplus">+   } else {</span>
<a href="#l9.1447"></a><span id="l9.1447" class="difflineplus">+      bzfp = BZ2_bzReadOpen(&amp;bzerr,fp,verbosity,smallMode,</span>
<a href="#l9.1448"></a><span id="l9.1448" class="difflineplus">+                            unused,nUnused);</span>
<a href="#l9.1449"></a><span id="l9.1449" class="difflineplus">+   }</span>
<a href="#l9.1450"></a><span id="l9.1450" class="difflineplus">+   if (bzfp == NULL) {</span>
<a href="#l9.1451"></a><span id="l9.1451" class="difflineplus">+      if (fp != stdin &amp;&amp; fp != stdout) fclose(fp);</span>
<a href="#l9.1452"></a><span id="l9.1452" class="difflineplus">+      return NULL;</span>
<a href="#l9.1453"></a><span id="l9.1453" class="difflineplus">+   }</span>
<a href="#l9.1454"></a><span id="l9.1454" class="difflineplus">+   return bzfp;</span>
<a href="#l9.1455"></a><span id="l9.1455" class="difflineplus">+}</span>
<a href="#l9.1456"></a><span id="l9.1456" class="difflineplus">+</span>
<a href="#l9.1457"></a><span id="l9.1457" class="difflineplus">+</span>
<a href="#l9.1458"></a><span id="l9.1458" class="difflineplus">+/*---------------------------------------------------*/</span>
<a href="#l9.1459"></a><span id="l9.1459" class="difflineplus">+/*--</span>
<a href="#l9.1460"></a><span id="l9.1460" class="difflineplus">+   open file for read or write.</span>
<a href="#l9.1461"></a><span id="l9.1461" class="difflineplus">+      ex) bzopen(&quot;file&quot;,&quot;w9&quot;)</span>
<a href="#l9.1462"></a><span id="l9.1462" class="difflineplus">+      case path=&quot;&quot; or NULL =&gt; use stdin or stdout.</span>
<a href="#l9.1463"></a><span id="l9.1463" class="difflineplus">+--*/</span>
<a href="#l9.1464"></a><span id="l9.1464" class="difflineplus">+BZFILE * BZ_API(BZ2_bzopen)</span>
<a href="#l9.1465"></a><span id="l9.1465" class="difflineplus">+               ( const char *path,</span>
<a href="#l9.1466"></a><span id="l9.1466" class="difflineplus">+                 const char *mode )</span>
<a href="#l9.1467"></a><span id="l9.1467" class="difflineplus">+{</span>
<a href="#l9.1468"></a><span id="l9.1468" class="difflineplus">+   return bzopen_or_bzdopen(path,-1,mode,/*bzopen*/0);</span>
<a href="#l9.1469"></a><span id="l9.1469" class="difflineplus">+}</span>
<a href="#l9.1470"></a><span id="l9.1470" class="difflineplus">+</span>
<a href="#l9.1471"></a><span id="l9.1471" class="difflineplus">+</span>
<a href="#l9.1472"></a><span id="l9.1472" class="difflineplus">+/*---------------------------------------------------*/</span>
<a href="#l9.1473"></a><span id="l9.1473" class="difflineplus">+BZFILE * BZ_API(BZ2_bzdopen)</span>
<a href="#l9.1474"></a><span id="l9.1474" class="difflineplus">+               ( int fd,</span>
<a href="#l9.1475"></a><span id="l9.1475" class="difflineplus">+                 const char *mode )</span>
<a href="#l9.1476"></a><span id="l9.1476" class="difflineplus">+{</span>
<a href="#l9.1477"></a><span id="l9.1477" class="difflineplus">+   return bzopen_or_bzdopen(NULL,fd,mode,/*bzdopen*/1);</span>
<a href="#l9.1478"></a><span id="l9.1478" class="difflineplus">+}</span>
<a href="#l9.1479"></a><span id="l9.1479" class="difflineplus">+</span>
<a href="#l9.1480"></a><span id="l9.1480" class="difflineplus">+</span>
<a href="#l9.1481"></a><span id="l9.1481" class="difflineplus">+/*---------------------------------------------------*/</span>
<a href="#l9.1482"></a><span id="l9.1482" class="difflineplus">+int BZ_API(BZ2_bzread) (BZFILE* b, void* buf, int len )</span>
<a href="#l9.1483"></a><span id="l9.1483" class="difflineplus">+{</span>
<a href="#l9.1484"></a><span id="l9.1484" class="difflineplus">+   int bzerr, nread;</span>
<a href="#l9.1485"></a><span id="l9.1485" class="difflineplus">+   if (((bzFile*)b)-&gt;lastErr == BZ_STREAM_END) return 0;</span>
<a href="#l9.1486"></a><span id="l9.1486" class="difflineplus">+   nread = BZ2_bzRead(&amp;bzerr,b,buf,len);</span>
<a href="#l9.1487"></a><span id="l9.1487" class="difflineplus">+   if (bzerr == BZ_OK || bzerr == BZ_STREAM_END) {</span>
<a href="#l9.1488"></a><span id="l9.1488" class="difflineplus">+      return nread;</span>
<a href="#l9.1489"></a><span id="l9.1489" class="difflineplus">+   } else {</span>
<a href="#l9.1490"></a><span id="l9.1490" class="difflineplus">+      return -1;</span>
<a href="#l9.1491"></a><span id="l9.1491" class="difflineplus">+   }</span>
<a href="#l9.1492"></a><span id="l9.1492" class="difflineplus">+}</span>
<a href="#l9.1493"></a><span id="l9.1493" class="difflineplus">+</span>
<a href="#l9.1494"></a><span id="l9.1494" class="difflineplus">+</span>
<a href="#l9.1495"></a><span id="l9.1495" class="difflineplus">+/*---------------------------------------------------*/</span>
<a href="#l9.1496"></a><span id="l9.1496" class="difflineplus">+int BZ_API(BZ2_bzwrite) (BZFILE* b, void* buf, int len )</span>
<a href="#l9.1497"></a><span id="l9.1497" class="difflineplus">+{</span>
<a href="#l9.1498"></a><span id="l9.1498" class="difflineplus">+   int bzerr;</span>
<a href="#l9.1499"></a><span id="l9.1499" class="difflineplus">+</span>
<a href="#l9.1500"></a><span id="l9.1500" class="difflineplus">+   BZ2_bzWrite(&amp;bzerr,b,buf,len);</span>
<a href="#l9.1501"></a><span id="l9.1501" class="difflineplus">+   if(bzerr == BZ_OK){</span>
<a href="#l9.1502"></a><span id="l9.1502" class="difflineplus">+      return len;</span>
<a href="#l9.1503"></a><span id="l9.1503" class="difflineplus">+   }else{</span>
<a href="#l9.1504"></a><span id="l9.1504" class="difflineplus">+      return -1;</span>
<a href="#l9.1505"></a><span id="l9.1505" class="difflineplus">+   }</span>
<a href="#l9.1506"></a><span id="l9.1506" class="difflineplus">+}</span>
<a href="#l9.1507"></a><span id="l9.1507" class="difflineplus">+</span>
<a href="#l9.1508"></a><span id="l9.1508" class="difflineplus">+</span>
<a href="#l9.1509"></a><span id="l9.1509" class="difflineplus">+/*---------------------------------------------------*/</span>
<a href="#l9.1510"></a><span id="l9.1510" class="difflineplus">+int BZ_API(BZ2_bzflush) (BZFILE *b)</span>
<a href="#l9.1511"></a><span id="l9.1511" class="difflineplus">+{</span>
<a href="#l9.1512"></a><span id="l9.1512" class="difflineplus">+   /* do nothing now... */</span>
<a href="#l9.1513"></a><span id="l9.1513" class="difflineplus">+   return 0;</span>
<a href="#l9.1514"></a><span id="l9.1514" class="difflineplus">+}</span>
<a href="#l9.1515"></a><span id="l9.1515" class="difflineplus">+</span>
<a href="#l9.1516"></a><span id="l9.1516" class="difflineplus">+</span>
<a href="#l9.1517"></a><span id="l9.1517" class="difflineplus">+/*---------------------------------------------------*/</span>
<a href="#l9.1518"></a><span id="l9.1518" class="difflineplus">+void BZ_API(BZ2_bzclose) (BZFILE* b)</span>
<a href="#l9.1519"></a><span id="l9.1519" class="difflineplus">+{</span>
<a href="#l9.1520"></a><span id="l9.1520" class="difflineplus">+   int bzerr;</span>
<a href="#l9.1521"></a><span id="l9.1521" class="difflineplus">+   FILE *fp;</span>
<a href="#l9.1522"></a><span id="l9.1522" class="difflineplus">+   </span>
<a href="#l9.1523"></a><span id="l9.1523" class="difflineplus">+   if (b==NULL) {return;}</span>
<a href="#l9.1524"></a><span id="l9.1524" class="difflineplus">+   fp = ((bzFile *)b)-&gt;handle;</span>
<a href="#l9.1525"></a><span id="l9.1525" class="difflineplus">+   if(((bzFile*)b)-&gt;writing){</span>
<a href="#l9.1526"></a><span id="l9.1526" class="difflineplus">+      BZ2_bzWriteClose(&amp;bzerr,b,0,NULL,NULL);</span>
<a href="#l9.1527"></a><span id="l9.1527" class="difflineplus">+      if(bzerr != BZ_OK){</span>
<a href="#l9.1528"></a><span id="l9.1528" class="difflineplus">+         BZ2_bzWriteClose(NULL,b,1,NULL,NULL);</span>
<a href="#l9.1529"></a><span id="l9.1529" class="difflineplus">+      }</span>
<a href="#l9.1530"></a><span id="l9.1530" class="difflineplus">+   }else{</span>
<a href="#l9.1531"></a><span id="l9.1531" class="difflineplus">+      BZ2_bzReadClose(&amp;bzerr,b);</span>
<a href="#l9.1532"></a><span id="l9.1532" class="difflineplus">+   }</span>
<a href="#l9.1533"></a><span id="l9.1533" class="difflineplus">+   if(fp!=stdin &amp;&amp; fp!=stdout){</span>
<a href="#l9.1534"></a><span id="l9.1534" class="difflineplus">+      fclose(fp);</span>
<a href="#l9.1535"></a><span id="l9.1535" class="difflineplus">+   }</span>
<a href="#l9.1536"></a><span id="l9.1536" class="difflineplus">+}</span>
<a href="#l9.1537"></a><span id="l9.1537" class="difflineplus">+</span>
<a href="#l9.1538"></a><span id="l9.1538" class="difflineplus">+</span>
<a href="#l9.1539"></a><span id="l9.1539" class="difflineplus">+/*---------------------------------------------------*/</span>
<a href="#l9.1540"></a><span id="l9.1540" class="difflineplus">+/*--</span>
<a href="#l9.1541"></a><span id="l9.1541" class="difflineplus">+   return last error code </span>
<a href="#l9.1542"></a><span id="l9.1542" class="difflineplus">+--*/</span>
<a href="#l9.1543"></a><span id="l9.1543" class="difflineplus">+static const char *bzerrorstrings[] = {</span>
<a href="#l9.1544"></a><span id="l9.1544" class="difflineplus">+       &quot;OK&quot;</span>
<a href="#l9.1545"></a><span id="l9.1545" class="difflineplus">+      ,&quot;SEQUENCE_ERROR&quot;</span>
<a href="#l9.1546"></a><span id="l9.1546" class="difflineplus">+      ,&quot;PARAM_ERROR&quot;</span>
<a href="#l9.1547"></a><span id="l9.1547" class="difflineplus">+      ,&quot;MEM_ERROR&quot;</span>
<a href="#l9.1548"></a><span id="l9.1548" class="difflineplus">+      ,&quot;DATA_ERROR&quot;</span>
<a href="#l9.1549"></a><span id="l9.1549" class="difflineplus">+      ,&quot;DATA_ERROR_MAGIC&quot;</span>
<a href="#l9.1550"></a><span id="l9.1550" class="difflineplus">+      ,&quot;IO_ERROR&quot;</span>
<a href="#l9.1551"></a><span id="l9.1551" class="difflineplus">+      ,&quot;UNEXPECTED_EOF&quot;</span>
<a href="#l9.1552"></a><span id="l9.1552" class="difflineplus">+      ,&quot;OUTBUFF_FULL&quot;</span>
<a href="#l9.1553"></a><span id="l9.1553" class="difflineplus">+      ,&quot;CONFIG_ERROR&quot;</span>
<a href="#l9.1554"></a><span id="l9.1554" class="difflineplus">+      ,&quot;???&quot;   /* for future */</span>
<a href="#l9.1555"></a><span id="l9.1555" class="difflineplus">+      ,&quot;???&quot;   /* for future */</span>
<a href="#l9.1556"></a><span id="l9.1556" class="difflineplus">+      ,&quot;???&quot;   /* for future */</span>
<a href="#l9.1557"></a><span id="l9.1557" class="difflineplus">+      ,&quot;???&quot;   /* for future */</span>
<a href="#l9.1558"></a><span id="l9.1558" class="difflineplus">+      ,&quot;???&quot;   /* for future */</span>
<a href="#l9.1559"></a><span id="l9.1559" class="difflineplus">+      ,&quot;???&quot;   /* for future */</span>
<a href="#l9.1560"></a><span id="l9.1560" class="difflineplus">+};</span>
<a href="#l9.1561"></a><span id="l9.1561" class="difflineplus">+</span>
<a href="#l9.1562"></a><span id="l9.1562" class="difflineplus">+</span>
<a href="#l9.1563"></a><span id="l9.1563" class="difflineplus">+const char * BZ_API(BZ2_bzerror) (BZFILE *b, int *errnum)</span>
<a href="#l9.1564"></a><span id="l9.1564" class="difflineplus">+{</span>
<a href="#l9.1565"></a><span id="l9.1565" class="difflineplus">+   int err = ((bzFile *)b)-&gt;lastErr;</span>
<a href="#l9.1566"></a><span id="l9.1566" class="difflineplus">+</span>
<a href="#l9.1567"></a><span id="l9.1567" class="difflineplus">+   if(err&gt;0) err = 0;</span>
<a href="#l9.1568"></a><span id="l9.1568" class="difflineplus">+   *errnum = err;</span>
<a href="#l9.1569"></a><span id="l9.1569" class="difflineplus">+   return bzerrorstrings[err*-1];</span>
<a href="#l9.1570"></a><span id="l9.1570" class="difflineplus">+}</span>
<a href="#l9.1571"></a><span id="l9.1571" class="difflineplus">+#endif</span>
<a href="#l9.1572"></a><span id="l9.1572" class="difflineplus">+</span>
<a href="#l9.1573"></a><span id="l9.1573" class="difflineplus">+</span>
<a href="#l9.1574"></a><span id="l9.1574" class="difflineplus">+/*-------------------------------------------------------------*/</span>
<a href="#l9.1575"></a><span id="l9.1575" class="difflineplus">+/*--- end                                           bzlib.c ---*/</span>
<a href="#l9.1576"></a><span id="l9.1576" class="difflineplus">+/*-------------------------------------------------------------*/</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1">new file mode 100644</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineminus">--- /dev/null</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineplus">+++ b/third_party/bzip2/bzlib.h</span>
<a href="#l10.4"></a><span id="l10.4" class="difflineat">@@ -0,0 +1,282 @@</span>
<a href="#l10.5"></a><span id="l10.5" class="difflineplus">+</span>
<a href="#l10.6"></a><span id="l10.6" class="difflineplus">+/*-------------------------------------------------------------*/</span>
<a href="#l10.7"></a><span id="l10.7" class="difflineplus">+/*--- Public header file for the library.                   ---*/</span>
<a href="#l10.8"></a><span id="l10.8" class="difflineplus">+/*---                                               bzlib.h ---*/</span>
<a href="#l10.9"></a><span id="l10.9" class="difflineplus">+/*-------------------------------------------------------------*/</span>
<a href="#l10.10"></a><span id="l10.10" class="difflineplus">+</span>
<a href="#l10.11"></a><span id="l10.11" class="difflineplus">+/* ------------------------------------------------------------------</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+   This file is part of bzip2/libbzip2, a program and library for</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+   lossless, block-sorting data compression.</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineplus">+   bzip2/libbzip2 version 1.0.8 of 13 July 2019</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+   Copyright (C) 1996-2019 Julian Seward &lt;jseward@acm.org&gt;</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineplus">+</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineplus">+   Please read the WARNING, DISCLAIMER and PATENTS sections in the </span>
<a href="#l10.19"></a><span id="l10.19" class="difflineplus">+   README file.</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineplus">+</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineplus">+   This program is released under the terms of the license contained</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineplus">+   in the file LICENSE.</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineplus">+   ------------------------------------------------------------------ */</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineplus">+</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineplus">+</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineplus">+#ifndef _BZLIB_H</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineplus">+#define _BZLIB_H</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineplus">+</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineplus">+#ifdef __cplusplus</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineplus">+extern &quot;C&quot; {</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineplus">+#endif</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineplus">+</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineplus">+#define BZ_RUN               0</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineplus">+#define BZ_FLUSH             1</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineplus">+#define BZ_FINISH            2</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineplus">+</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineplus">+#define BZ_OK                0</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineplus">+#define BZ_RUN_OK            1</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineplus">+#define BZ_FLUSH_OK          2</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineplus">+#define BZ_FINISH_OK         3</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineplus">+#define BZ_STREAM_END        4</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineplus">+#define BZ_SEQUENCE_ERROR    (-1)</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineplus">+#define BZ_PARAM_ERROR       (-2)</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineplus">+#define BZ_MEM_ERROR         (-3)</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineplus">+#define BZ_DATA_ERROR        (-4)</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineplus">+#define BZ_DATA_ERROR_MAGIC  (-5)</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineplus">+#define BZ_IO_ERROR          (-6)</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineplus">+#define BZ_UNEXPECTED_EOF    (-7)</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineplus">+#define BZ_OUTBUFF_FULL      (-8)</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineplus">+#define BZ_CONFIG_ERROR      (-9)</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineplus">+</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineplus">+typedef </span>
<a href="#l10.53"></a><span id="l10.53" class="difflineplus">+   struct {</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineplus">+      char *next_in;</span>
<a href="#l10.55"></a><span id="l10.55" class="difflineplus">+      unsigned int avail_in;</span>
<a href="#l10.56"></a><span id="l10.56" class="difflineplus">+      unsigned int total_in_lo32;</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineplus">+      unsigned int total_in_hi32;</span>
<a href="#l10.58"></a><span id="l10.58" class="difflineplus">+</span>
<a href="#l10.59"></a><span id="l10.59" class="difflineplus">+      char *next_out;</span>
<a href="#l10.60"></a><span id="l10.60" class="difflineplus">+      unsigned int avail_out;</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineplus">+      unsigned int total_out_lo32;</span>
<a href="#l10.62"></a><span id="l10.62" class="difflineplus">+      unsigned int total_out_hi32;</span>
<a href="#l10.63"></a><span id="l10.63" class="difflineplus">+</span>
<a href="#l10.64"></a><span id="l10.64" class="difflineplus">+      void *state;</span>
<a href="#l10.65"></a><span id="l10.65" class="difflineplus">+</span>
<a href="#l10.66"></a><span id="l10.66" class="difflineplus">+      void *(*bzalloc)(void *,int,int);</span>
<a href="#l10.67"></a><span id="l10.67" class="difflineplus">+      void (*bzfree)(void *,void *);</span>
<a href="#l10.68"></a><span id="l10.68" class="difflineplus">+      void *opaque;</span>
<a href="#l10.69"></a><span id="l10.69" class="difflineplus">+   } </span>
<a href="#l10.70"></a><span id="l10.70" class="difflineplus">+   bz_stream;</span>
<a href="#l10.71"></a><span id="l10.71" class="difflineplus">+</span>
<a href="#l10.72"></a><span id="l10.72" class="difflineplus">+</span>
<a href="#l10.73"></a><span id="l10.73" class="difflineplus">+#ifndef BZ_IMPORT</span>
<a href="#l10.74"></a><span id="l10.74" class="difflineplus">+#define BZ_EXPORT</span>
<a href="#l10.75"></a><span id="l10.75" class="difflineplus">+#endif</span>
<a href="#l10.76"></a><span id="l10.76" class="difflineplus">+</span>
<a href="#l10.77"></a><span id="l10.77" class="difflineplus">+#ifndef BZ_NO_STDIO</span>
<a href="#l10.78"></a><span id="l10.78" class="difflineplus">+/* Need a definitition for FILE */</span>
<a href="#l10.79"></a><span id="l10.79" class="difflineplus">+#include &lt;stdio.h&gt;</span>
<a href="#l10.80"></a><span id="l10.80" class="difflineplus">+#endif</span>
<a href="#l10.81"></a><span id="l10.81" class="difflineplus">+</span>
<a href="#l10.82"></a><span id="l10.82" class="difflineplus">+#ifdef _WIN32</span>
<a href="#l10.83"></a><span id="l10.83" class="difflineplus">+#   include &lt;windows.h&gt;</span>
<a href="#l10.84"></a><span id="l10.84" class="difflineplus">+#   ifdef small</span>
<a href="#l10.85"></a><span id="l10.85" class="difflineplus">+      /* windows.h define small to char */</span>
<a href="#l10.86"></a><span id="l10.86" class="difflineplus">+#      undef small</span>
<a href="#l10.87"></a><span id="l10.87" class="difflineplus">+#   endif</span>
<a href="#l10.88"></a><span id="l10.88" class="difflineplus">+#   ifdef BZ_EXPORT</span>
<a href="#l10.89"></a><span id="l10.89" class="difflineplus">+#   define BZ_API(func) WINAPI func</span>
<a href="#l10.90"></a><span id="l10.90" class="difflineplus">+#   define BZ_EXTERN extern</span>
<a href="#l10.91"></a><span id="l10.91" class="difflineplus">+#   else</span>
<a href="#l10.92"></a><span id="l10.92" class="difflineplus">+   /* import windows dll dynamically */</span>
<a href="#l10.93"></a><span id="l10.93" class="difflineplus">+#   define BZ_API(func) (WINAPI * func)</span>
<a href="#l10.94"></a><span id="l10.94" class="difflineplus">+#   define BZ_EXTERN</span>
<a href="#l10.95"></a><span id="l10.95" class="difflineplus">+#   endif</span>
<a href="#l10.96"></a><span id="l10.96" class="difflineplus">+#else</span>
<a href="#l10.97"></a><span id="l10.97" class="difflineplus">+#   define BZ_API(func) func</span>
<a href="#l10.98"></a><span id="l10.98" class="difflineplus">+#   define BZ_EXTERN extern</span>
<a href="#l10.99"></a><span id="l10.99" class="difflineplus">+#endif</span>
<a href="#l10.100"></a><span id="l10.100" class="difflineplus">+</span>
<a href="#l10.101"></a><span id="l10.101" class="difflineplus">+</span>
<a href="#l10.102"></a><span id="l10.102" class="difflineplus">+/*-- Core (low-level) library functions --*/</span>
<a href="#l10.103"></a><span id="l10.103" class="difflineplus">+</span>
<a href="#l10.104"></a><span id="l10.104" class="difflineplus">+BZ_EXTERN int BZ_API(BZ2_bzCompressInit) ( </span>
<a href="#l10.105"></a><span id="l10.105" class="difflineplus">+      bz_stream* strm, </span>
<a href="#l10.106"></a><span id="l10.106" class="difflineplus">+      int        blockSize100k, </span>
<a href="#l10.107"></a><span id="l10.107" class="difflineplus">+      int        verbosity, </span>
<a href="#l10.108"></a><span id="l10.108" class="difflineplus">+      int        workFactor </span>
<a href="#l10.109"></a><span id="l10.109" class="difflineplus">+   );</span>
<a href="#l10.110"></a><span id="l10.110" class="difflineplus">+</span>
<a href="#l10.111"></a><span id="l10.111" class="difflineplus">+BZ_EXTERN int BZ_API(BZ2_bzCompress) ( </span>
<a href="#l10.112"></a><span id="l10.112" class="difflineplus">+      bz_stream* strm, </span>
<a href="#l10.113"></a><span id="l10.113" class="difflineplus">+      int action </span>
<a href="#l10.114"></a><span id="l10.114" class="difflineplus">+   );</span>
<a href="#l10.115"></a><span id="l10.115" class="difflineplus">+</span>
<a href="#l10.116"></a><span id="l10.116" class="difflineplus">+BZ_EXTERN int BZ_API(BZ2_bzCompressEnd) ( </span>
<a href="#l10.117"></a><span id="l10.117" class="difflineplus">+      bz_stream* strm </span>
<a href="#l10.118"></a><span id="l10.118" class="difflineplus">+   );</span>
<a href="#l10.119"></a><span id="l10.119" class="difflineplus">+</span>
<a href="#l10.120"></a><span id="l10.120" class="difflineplus">+BZ_EXTERN int BZ_API(BZ2_bzDecompressInit) ( </span>
<a href="#l10.121"></a><span id="l10.121" class="difflineplus">+      bz_stream *strm, </span>
<a href="#l10.122"></a><span id="l10.122" class="difflineplus">+      int       verbosity, </span>
<a href="#l10.123"></a><span id="l10.123" class="difflineplus">+      int       small</span>
<a href="#l10.124"></a><span id="l10.124" class="difflineplus">+   );</span>
<a href="#l10.125"></a><span id="l10.125" class="difflineplus">+</span>
<a href="#l10.126"></a><span id="l10.126" class="difflineplus">+BZ_EXTERN int BZ_API(BZ2_bzDecompress) ( </span>
<a href="#l10.127"></a><span id="l10.127" class="difflineplus">+      bz_stream* strm </span>
<a href="#l10.128"></a><span id="l10.128" class="difflineplus">+   );</span>
<a href="#l10.129"></a><span id="l10.129" class="difflineplus">+</span>
<a href="#l10.130"></a><span id="l10.130" class="difflineplus">+BZ_EXTERN int BZ_API(BZ2_bzDecompressEnd) ( </span>
<a href="#l10.131"></a><span id="l10.131" class="difflineplus">+      bz_stream *strm </span>
<a href="#l10.132"></a><span id="l10.132" class="difflineplus">+   );</span>
<a href="#l10.133"></a><span id="l10.133" class="difflineplus">+</span>
<a href="#l10.134"></a><span id="l10.134" class="difflineplus">+</span>
<a href="#l10.135"></a><span id="l10.135" class="difflineplus">+</span>
<a href="#l10.136"></a><span id="l10.136" class="difflineplus">+/*-- High(er) level library functions --*/</span>
<a href="#l10.137"></a><span id="l10.137" class="difflineplus">+</span>
<a href="#l10.138"></a><span id="l10.138" class="difflineplus">+#ifndef BZ_NO_STDIO</span>
<a href="#l10.139"></a><span id="l10.139" class="difflineplus">+#define BZ_MAX_UNUSED 5000</span>
<a href="#l10.140"></a><span id="l10.140" class="difflineplus">+</span>
<a href="#l10.141"></a><span id="l10.141" class="difflineplus">+typedef void BZFILE;</span>
<a href="#l10.142"></a><span id="l10.142" class="difflineplus">+</span>
<a href="#l10.143"></a><span id="l10.143" class="difflineplus">+BZ_EXTERN BZFILE* BZ_API(BZ2_bzReadOpen) ( </span>
<a href="#l10.144"></a><span id="l10.144" class="difflineplus">+      int*  bzerror,   </span>
<a href="#l10.145"></a><span id="l10.145" class="difflineplus">+      FILE* f, </span>
<a href="#l10.146"></a><span id="l10.146" class="difflineplus">+      int   verbosity, </span>
<a href="#l10.147"></a><span id="l10.147" class="difflineplus">+      int   small,</span>
<a href="#l10.148"></a><span id="l10.148" class="difflineplus">+      void* unused,    </span>
<a href="#l10.149"></a><span id="l10.149" class="difflineplus">+      int   nUnused </span>
<a href="#l10.150"></a><span id="l10.150" class="difflineplus">+   );</span>
<a href="#l10.151"></a><span id="l10.151" class="difflineplus">+</span>
<a href="#l10.152"></a><span id="l10.152" class="difflineplus">+BZ_EXTERN void BZ_API(BZ2_bzReadClose) ( </span>
<a href="#l10.153"></a><span id="l10.153" class="difflineplus">+      int*    bzerror, </span>
<a href="#l10.154"></a><span id="l10.154" class="difflineplus">+      BZFILE* b </span>
<a href="#l10.155"></a><span id="l10.155" class="difflineplus">+   );</span>
<a href="#l10.156"></a><span id="l10.156" class="difflineplus">+</span>
<a href="#l10.157"></a><span id="l10.157" class="difflineplus">+BZ_EXTERN void BZ_API(BZ2_bzReadGetUnused) ( </span>
<a href="#l10.158"></a><span id="l10.158" class="difflineplus">+      int*    bzerror, </span>
<a href="#l10.159"></a><span id="l10.159" class="difflineplus">+      BZFILE* b, </span>
<a href="#l10.160"></a><span id="l10.160" class="difflineplus">+      void**  unused,  </span>
<a href="#l10.161"></a><span id="l10.161" class="difflineplus">+      int*    nUnused </span>
<a href="#l10.162"></a><span id="l10.162" class="difflineplus">+   );</span>
<a href="#l10.163"></a><span id="l10.163" class="difflineplus">+</span>
<a href="#l10.164"></a><span id="l10.164" class="difflineplus">+BZ_EXTERN int BZ_API(BZ2_bzRead) ( </span>
<a href="#l10.165"></a><span id="l10.165" class="difflineplus">+      int*    bzerror, </span>
<a href="#l10.166"></a><span id="l10.166" class="difflineplus">+      BZFILE* b, </span>
<a href="#l10.167"></a><span id="l10.167" class="difflineplus">+      void*   buf, </span>
<a href="#l10.168"></a><span id="l10.168" class="difflineplus">+      int     len </span>
<a href="#l10.169"></a><span id="l10.169" class="difflineplus">+   );</span>
<a href="#l10.170"></a><span id="l10.170" class="difflineplus">+</span>
<a href="#l10.171"></a><span id="l10.171" class="difflineplus">+BZ_EXTERN BZFILE* BZ_API(BZ2_bzWriteOpen) ( </span>
<a href="#l10.172"></a><span id="l10.172" class="difflineplus">+      int*  bzerror,      </span>
<a href="#l10.173"></a><span id="l10.173" class="difflineplus">+      FILE* f, </span>
<a href="#l10.174"></a><span id="l10.174" class="difflineplus">+      int   blockSize100k, </span>
<a href="#l10.175"></a><span id="l10.175" class="difflineplus">+      int   verbosity, </span>
<a href="#l10.176"></a><span id="l10.176" class="difflineplus">+      int   workFactor </span>
<a href="#l10.177"></a><span id="l10.177" class="difflineplus">+   );</span>
<a href="#l10.178"></a><span id="l10.178" class="difflineplus">+</span>
<a href="#l10.179"></a><span id="l10.179" class="difflineplus">+BZ_EXTERN void BZ_API(BZ2_bzWrite) ( </span>
<a href="#l10.180"></a><span id="l10.180" class="difflineplus">+      int*    bzerror, </span>
<a href="#l10.181"></a><span id="l10.181" class="difflineplus">+      BZFILE* b, </span>
<a href="#l10.182"></a><span id="l10.182" class="difflineplus">+      void*   buf, </span>
<a href="#l10.183"></a><span id="l10.183" class="difflineplus">+      int     len </span>
<a href="#l10.184"></a><span id="l10.184" class="difflineplus">+   );</span>
<a href="#l10.185"></a><span id="l10.185" class="difflineplus">+</span>
<a href="#l10.186"></a><span id="l10.186" class="difflineplus">+BZ_EXTERN void BZ_API(BZ2_bzWriteClose) ( </span>
<a href="#l10.187"></a><span id="l10.187" class="difflineplus">+      int*          bzerror, </span>
<a href="#l10.188"></a><span id="l10.188" class="difflineplus">+      BZFILE*       b, </span>
<a href="#l10.189"></a><span id="l10.189" class="difflineplus">+      int           abandon, </span>
<a href="#l10.190"></a><span id="l10.190" class="difflineplus">+      unsigned int* nbytes_in, </span>
<a href="#l10.191"></a><span id="l10.191" class="difflineplus">+      unsigned int* nbytes_out </span>
<a href="#l10.192"></a><span id="l10.192" class="difflineplus">+   );</span>
<a href="#l10.193"></a><span id="l10.193" class="difflineplus">+</span>
<a href="#l10.194"></a><span id="l10.194" class="difflineplus">+BZ_EXTERN void BZ_API(BZ2_bzWriteClose64) ( </span>
<a href="#l10.195"></a><span id="l10.195" class="difflineplus">+      int*          bzerror, </span>
<a href="#l10.196"></a><span id="l10.196" class="difflineplus">+      BZFILE*       b, </span>
<a href="#l10.197"></a><span id="l10.197" class="difflineplus">+      int           abandon, </span>
<a href="#l10.198"></a><span id="l10.198" class="difflineplus">+      unsigned int* nbytes_in_lo32, </span>
<a href="#l10.199"></a><span id="l10.199" class="difflineplus">+      unsigned int* nbytes_in_hi32, </span>
<a href="#l10.200"></a><span id="l10.200" class="difflineplus">+      unsigned int* nbytes_out_lo32, </span>
<a href="#l10.201"></a><span id="l10.201" class="difflineplus">+      unsigned int* nbytes_out_hi32</span>
<a href="#l10.202"></a><span id="l10.202" class="difflineplus">+   );</span>
<a href="#l10.203"></a><span id="l10.203" class="difflineplus">+#endif</span>
<a href="#l10.204"></a><span id="l10.204" class="difflineplus">+</span>
<a href="#l10.205"></a><span id="l10.205" class="difflineplus">+</span>
<a href="#l10.206"></a><span id="l10.206" class="difflineplus">+/*-- Utility functions --*/</span>
<a href="#l10.207"></a><span id="l10.207" class="difflineplus">+</span>
<a href="#l10.208"></a><span id="l10.208" class="difflineplus">+BZ_EXTERN int BZ_API(BZ2_bzBuffToBuffCompress) ( </span>
<a href="#l10.209"></a><span id="l10.209" class="difflineplus">+      char*         dest, </span>
<a href="#l10.210"></a><span id="l10.210" class="difflineplus">+      unsigned int* destLen,</span>
<a href="#l10.211"></a><span id="l10.211" class="difflineplus">+      char*         source, </span>
<a href="#l10.212"></a><span id="l10.212" class="difflineplus">+      unsigned int  sourceLen,</span>
<a href="#l10.213"></a><span id="l10.213" class="difflineplus">+      int           blockSize100k, </span>
<a href="#l10.214"></a><span id="l10.214" class="difflineplus">+      int           verbosity, </span>
<a href="#l10.215"></a><span id="l10.215" class="difflineplus">+      int           workFactor </span>
<a href="#l10.216"></a><span id="l10.216" class="difflineplus">+   );</span>
<a href="#l10.217"></a><span id="l10.217" class="difflineplus">+</span>
<a href="#l10.218"></a><span id="l10.218" class="difflineplus">+BZ_EXTERN int BZ_API(BZ2_bzBuffToBuffDecompress) ( </span>
<a href="#l10.219"></a><span id="l10.219" class="difflineplus">+      char*         dest, </span>
<a href="#l10.220"></a><span id="l10.220" class="difflineplus">+      unsigned int* destLen,</span>
<a href="#l10.221"></a><span id="l10.221" class="difflineplus">+      char*         source, </span>
<a href="#l10.222"></a><span id="l10.222" class="difflineplus">+      unsigned int  sourceLen,</span>
<a href="#l10.223"></a><span id="l10.223" class="difflineplus">+      int           small, </span>
<a href="#l10.224"></a><span id="l10.224" class="difflineplus">+      int           verbosity </span>
<a href="#l10.225"></a><span id="l10.225" class="difflineplus">+   );</span>
<a href="#l10.226"></a><span id="l10.226" class="difflineplus">+</span>
<a href="#l10.227"></a><span id="l10.227" class="difflineplus">+</span>
<a href="#l10.228"></a><span id="l10.228" class="difflineplus">+/*--</span>
<a href="#l10.229"></a><span id="l10.229" class="difflineplus">+   Code contributed by Yoshioka Tsuneo (tsuneo@rr.iij4u.or.jp)</span>
<a href="#l10.230"></a><span id="l10.230" class="difflineplus">+   to support better zlib compatibility.</span>
<a href="#l10.231"></a><span id="l10.231" class="difflineplus">+   This code is not _officially_ part of libbzip2 (yet);</span>
<a href="#l10.232"></a><span id="l10.232" class="difflineplus">+   I haven't tested it, documented it, or considered the</span>
<a href="#l10.233"></a><span id="l10.233" class="difflineplus">+   threading-safeness of it.</span>
<a href="#l10.234"></a><span id="l10.234" class="difflineplus">+   If this code breaks, please contact both Yoshioka and me.</span>
<a href="#l10.235"></a><span id="l10.235" class="difflineplus">+--*/</span>
<a href="#l10.236"></a><span id="l10.236" class="difflineplus">+</span>
<a href="#l10.237"></a><span id="l10.237" class="difflineplus">+BZ_EXTERN const char * BZ_API(BZ2_bzlibVersion) (</span>
<a href="#l10.238"></a><span id="l10.238" class="difflineplus">+      void</span>
<a href="#l10.239"></a><span id="l10.239" class="difflineplus">+   );</span>
<a href="#l10.240"></a><span id="l10.240" class="difflineplus">+</span>
<a href="#l10.241"></a><span id="l10.241" class="difflineplus">+#ifndef BZ_NO_STDIO</span>
<a href="#l10.242"></a><span id="l10.242" class="difflineplus">+BZ_EXTERN BZFILE * BZ_API(BZ2_bzopen) (</span>
<a href="#l10.243"></a><span id="l10.243" class="difflineplus">+      const char *path,</span>
<a href="#l10.244"></a><span id="l10.244" class="difflineplus">+      const char *mode</span>
<a href="#l10.245"></a><span id="l10.245" class="difflineplus">+   );</span>
<a href="#l10.246"></a><span id="l10.246" class="difflineplus">+</span>
<a href="#l10.247"></a><span id="l10.247" class="difflineplus">+BZ_EXTERN BZFILE * BZ_API(BZ2_bzdopen) (</span>
<a href="#l10.248"></a><span id="l10.248" class="difflineplus">+      int        fd,</span>
<a href="#l10.249"></a><span id="l10.249" class="difflineplus">+      const char *mode</span>
<a href="#l10.250"></a><span id="l10.250" class="difflineplus">+   );</span>
<a href="#l10.251"></a><span id="l10.251" class="difflineplus">+         </span>
<a href="#l10.252"></a><span id="l10.252" class="difflineplus">+BZ_EXTERN int BZ_API(BZ2_bzread) (</span>
<a href="#l10.253"></a><span id="l10.253" class="difflineplus">+      BZFILE* b, </span>
<a href="#l10.254"></a><span id="l10.254" class="difflineplus">+      void* buf, </span>
<a href="#l10.255"></a><span id="l10.255" class="difflineplus">+      int len </span>
<a href="#l10.256"></a><span id="l10.256" class="difflineplus">+   );</span>
<a href="#l10.257"></a><span id="l10.257" class="difflineplus">+</span>
<a href="#l10.258"></a><span id="l10.258" class="difflineplus">+BZ_EXTERN int BZ_API(BZ2_bzwrite) (</span>
<a href="#l10.259"></a><span id="l10.259" class="difflineplus">+      BZFILE* b, </span>
<a href="#l10.260"></a><span id="l10.260" class="difflineplus">+      void*   buf, </span>
<a href="#l10.261"></a><span id="l10.261" class="difflineplus">+      int     len </span>
<a href="#l10.262"></a><span id="l10.262" class="difflineplus">+   );</span>
<a href="#l10.263"></a><span id="l10.263" class="difflineplus">+</span>
<a href="#l10.264"></a><span id="l10.264" class="difflineplus">+BZ_EXTERN int BZ_API(BZ2_bzflush) (</span>
<a href="#l10.265"></a><span id="l10.265" class="difflineplus">+      BZFILE* b</span>
<a href="#l10.266"></a><span id="l10.266" class="difflineplus">+   );</span>
<a href="#l10.267"></a><span id="l10.267" class="difflineplus">+</span>
<a href="#l10.268"></a><span id="l10.268" class="difflineplus">+BZ_EXTERN void BZ_API(BZ2_bzclose) (</span>
<a href="#l10.269"></a><span id="l10.269" class="difflineplus">+      BZFILE* b</span>
<a href="#l10.270"></a><span id="l10.270" class="difflineplus">+   );</span>
<a href="#l10.271"></a><span id="l10.271" class="difflineplus">+</span>
<a href="#l10.272"></a><span id="l10.272" class="difflineplus">+BZ_EXTERN const char * BZ_API(BZ2_bzerror) (</span>
<a href="#l10.273"></a><span id="l10.273" class="difflineplus">+      BZFILE *b, </span>
<a href="#l10.274"></a><span id="l10.274" class="difflineplus">+      int    *errnum</span>
<a href="#l10.275"></a><span id="l10.275" class="difflineplus">+   );</span>
<a href="#l10.276"></a><span id="l10.276" class="difflineplus">+#endif</span>
<a href="#l10.277"></a><span id="l10.277" class="difflineplus">+</span>
<a href="#l10.278"></a><span id="l10.278" class="difflineplus">+#ifdef __cplusplus</span>
<a href="#l10.279"></a><span id="l10.279" class="difflineplus">+}</span>
<a href="#l10.280"></a><span id="l10.280" class="difflineplus">+#endif</span>
<a href="#l10.281"></a><span id="l10.281" class="difflineplus">+</span>
<a href="#l10.282"></a><span id="l10.282" class="difflineplus">+#endif</span>
<a href="#l10.283"></a><span id="l10.283" class="difflineplus">+</span>
<a href="#l10.284"></a><span id="l10.284" class="difflineplus">+/*-------------------------------------------------------------*/</span>
<a href="#l10.285"></a><span id="l10.285" class="difflineplus">+/*--- end                                           bzlib.h ---*/</span>
<a href="#l10.286"></a><span id="l10.286" class="difflineplus">+/*-------------------------------------------------------------*/</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1">new file mode 100644</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineminus">--- /dev/null</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineplus">+++ b/third_party/bzip2/bzlib_private.h</span>
<a href="#l11.4"></a><span id="l11.4" class="difflineat">@@ -0,0 +1,509 @@</span>
<a href="#l11.5"></a><span id="l11.5" class="difflineplus">+</span>
<a href="#l11.6"></a><span id="l11.6" class="difflineplus">+/*-------------------------------------------------------------*/</span>
<a href="#l11.7"></a><span id="l11.7" class="difflineplus">+/*--- Private header file for the library.                  ---*/</span>
<a href="#l11.8"></a><span id="l11.8" class="difflineplus">+/*---                                       bzlib_private.h ---*/</span>
<a href="#l11.9"></a><span id="l11.9" class="difflineplus">+/*-------------------------------------------------------------*/</span>
<a href="#l11.10"></a><span id="l11.10" class="difflineplus">+</span>
<a href="#l11.11"></a><span id="l11.11" class="difflineplus">+/* ------------------------------------------------------------------</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+   This file is part of bzip2/libbzip2, a program and library for</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+   lossless, block-sorting data compression.</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+   bzip2/libbzip2 version 1.0.8 of 13 July 2019</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineplus">+   Copyright (C) 1996-2019 Julian Seward &lt;jseward@acm.org&gt;</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineplus">+</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineplus">+   Please read the WARNING, DISCLAIMER and PATENTS sections in the </span>
<a href="#l11.19"></a><span id="l11.19" class="difflineplus">+   README file.</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineplus">+</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineplus">+   This program is released under the terms of the license contained</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineplus">+   in the file LICENSE.</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineplus">+   ------------------------------------------------------------------ */</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineplus">+</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineplus">+</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineplus">+#ifndef _BZLIB_PRIVATE_H</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineplus">+#define _BZLIB_PRIVATE_H</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineplus">+</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineplus">+#include &lt;stdlib.h&gt;</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineplus">+</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineplus">+#ifndef BZ_NO_STDIO</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineplus">+#include &lt;stdio.h&gt;</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineplus">+#include &lt;ctype.h&gt;</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineplus">+#include &lt;string.h&gt;</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineplus">+#endif</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineplus">+</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineplus">+#include &quot;bzlib.h&quot;</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineplus">+</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineplus">+</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineplus">+</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineplus">+/*-- General stuff. --*/</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineplus">+</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineplus">+#define BZ_VERSION  &quot;1.0.8, 13-Jul-2019&quot;</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineplus">+</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineplus">+typedef char            Char;</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineplus">+typedef unsigned char   Bool;</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineplus">+typedef unsigned char   UChar;</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineplus">+typedef int             Int32;</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineplus">+typedef unsigned int    UInt32;</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineplus">+typedef short           Int16;</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineplus">+typedef unsigned short  UInt16;</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineplus">+</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineplus">+#define True  ((Bool)1)</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineplus">+#define False ((Bool)0)</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineplus">+</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineplus">+#ifndef __GNUC__</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineplus">+#define __inline__  /* */</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineplus">+#endif </span>
<a href="#l11.59"></a><span id="l11.59" class="difflineplus">+</span>
<a href="#l11.60"></a><span id="l11.60" class="difflineplus">+#ifndef BZ_NO_STDIO</span>
<a href="#l11.61"></a><span id="l11.61" class="difflineplus">+</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineplus">+extern void BZ2_bz__AssertH__fail ( int errcode );</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineplus">+#define AssertH(cond,errcode) \</span>
<a href="#l11.64"></a><span id="l11.64" class="difflineplus">+   { if (!(cond)) BZ2_bz__AssertH__fail ( errcode ); }</span>
<a href="#l11.65"></a><span id="l11.65" class="difflineplus">+</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineplus">+#if BZ_DEBUG</span>
<a href="#l11.67"></a><span id="l11.67" class="difflineplus">+#define AssertD(cond,msg) \</span>
<a href="#l11.68"></a><span id="l11.68" class="difflineplus">+   { if (!(cond)) {       \</span>
<a href="#l11.69"></a><span id="l11.69" class="difflineplus">+      fprintf ( stderr,   \</span>
<a href="#l11.70"></a><span id="l11.70" class="difflineplus">+        &quot;\n\nlibbzip2(debug build): internal error\n\t%s\n&quot;, msg );\</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineplus">+      exit(1); \</span>
<a href="#l11.72"></a><span id="l11.72" class="difflineplus">+   }}</span>
<a href="#l11.73"></a><span id="l11.73" class="difflineplus">+#else</span>
<a href="#l11.74"></a><span id="l11.74" class="difflineplus">+#define AssertD(cond,msg) /* */</span>
<a href="#l11.75"></a><span id="l11.75" class="difflineplus">+#endif</span>
<a href="#l11.76"></a><span id="l11.76" class="difflineplus">+</span>
<a href="#l11.77"></a><span id="l11.77" class="difflineplus">+#define VPrintf0(zf) \</span>
<a href="#l11.78"></a><span id="l11.78" class="difflineplus">+   fprintf(stderr,zf)</span>
<a href="#l11.79"></a><span id="l11.79" class="difflineplus">+#define VPrintf1(zf,za1) \</span>
<a href="#l11.80"></a><span id="l11.80" class="difflineplus">+   fprintf(stderr,zf,za1)</span>
<a href="#l11.81"></a><span id="l11.81" class="difflineplus">+#define VPrintf2(zf,za1,za2) \</span>
<a href="#l11.82"></a><span id="l11.82" class="difflineplus">+   fprintf(stderr,zf,za1,za2)</span>
<a href="#l11.83"></a><span id="l11.83" class="difflineplus">+#define VPrintf3(zf,za1,za2,za3) \</span>
<a href="#l11.84"></a><span id="l11.84" class="difflineplus">+   fprintf(stderr,zf,za1,za2,za3)</span>
<a href="#l11.85"></a><span id="l11.85" class="difflineplus">+#define VPrintf4(zf,za1,za2,za3,za4) \</span>
<a href="#l11.86"></a><span id="l11.86" class="difflineplus">+   fprintf(stderr,zf,za1,za2,za3,za4)</span>
<a href="#l11.87"></a><span id="l11.87" class="difflineplus">+#define VPrintf5(zf,za1,za2,za3,za4,za5) \</span>
<a href="#l11.88"></a><span id="l11.88" class="difflineplus">+   fprintf(stderr,zf,za1,za2,za3,za4,za5)</span>
<a href="#l11.89"></a><span id="l11.89" class="difflineplus">+</span>
<a href="#l11.90"></a><span id="l11.90" class="difflineplus">+#else</span>
<a href="#l11.91"></a><span id="l11.91" class="difflineplus">+</span>
<a href="#l11.92"></a><span id="l11.92" class="difflineplus">+extern void bz_internal_error ( int errcode );</span>
<a href="#l11.93"></a><span id="l11.93" class="difflineplus">+#define AssertH(cond,errcode) \</span>
<a href="#l11.94"></a><span id="l11.94" class="difflineplus">+   { if (!(cond)) bz_internal_error ( errcode ); }</span>
<a href="#l11.95"></a><span id="l11.95" class="difflineplus">+#define AssertD(cond,msg)                do { } while (0)</span>
<a href="#l11.96"></a><span id="l11.96" class="difflineplus">+#define VPrintf0(zf)                     do { } while (0)</span>
<a href="#l11.97"></a><span id="l11.97" class="difflineplus">+#define VPrintf1(zf,za1)                 do { } while (0)</span>
<a href="#l11.98"></a><span id="l11.98" class="difflineplus">+#define VPrintf2(zf,za1,za2)             do { } while (0)</span>
<a href="#l11.99"></a><span id="l11.99" class="difflineplus">+#define VPrintf3(zf,za1,za2,za3)         do { } while (0)</span>
<a href="#l11.100"></a><span id="l11.100" class="difflineplus">+#define VPrintf4(zf,za1,za2,za3,za4)     do { } while (0)</span>
<a href="#l11.101"></a><span id="l11.101" class="difflineplus">+#define VPrintf5(zf,za1,za2,za3,za4,za5) do { } while (0)</span>
<a href="#l11.102"></a><span id="l11.102" class="difflineplus">+</span>
<a href="#l11.103"></a><span id="l11.103" class="difflineplus">+#endif</span>
<a href="#l11.104"></a><span id="l11.104" class="difflineplus">+</span>
<a href="#l11.105"></a><span id="l11.105" class="difflineplus">+</span>
<a href="#l11.106"></a><span id="l11.106" class="difflineplus">+#define BZALLOC(nnn) (strm-&gt;bzalloc)(strm-&gt;opaque,(nnn),1)</span>
<a href="#l11.107"></a><span id="l11.107" class="difflineplus">+#define BZFREE(ppp)  (strm-&gt;bzfree)(strm-&gt;opaque,(ppp))</span>
<a href="#l11.108"></a><span id="l11.108" class="difflineplus">+</span>
<a href="#l11.109"></a><span id="l11.109" class="difflineplus">+</span>
<a href="#l11.110"></a><span id="l11.110" class="difflineplus">+/*-- Header bytes. --*/</span>
<a href="#l11.111"></a><span id="l11.111" class="difflineplus">+</span>
<a href="#l11.112"></a><span id="l11.112" class="difflineplus">+#define BZ_HDR_B 0x42   /* 'B' */</span>
<a href="#l11.113"></a><span id="l11.113" class="difflineplus">+#define BZ_HDR_Z 0x5a   /* 'Z' */</span>
<a href="#l11.114"></a><span id="l11.114" class="difflineplus">+#define BZ_HDR_h 0x68   /* 'h' */</span>
<a href="#l11.115"></a><span id="l11.115" class="difflineplus">+#define BZ_HDR_0 0x30   /* '0' */</span>
<a href="#l11.116"></a><span id="l11.116" class="difflineplus">+  </span>
<a href="#l11.117"></a><span id="l11.117" class="difflineplus">+/*-- Constants for the back end. --*/</span>
<a href="#l11.118"></a><span id="l11.118" class="difflineplus">+</span>
<a href="#l11.119"></a><span id="l11.119" class="difflineplus">+#define BZ_MAX_ALPHA_SIZE 258</span>
<a href="#l11.120"></a><span id="l11.120" class="difflineplus">+#define BZ_MAX_CODE_LEN    23</span>
<a href="#l11.121"></a><span id="l11.121" class="difflineplus">+</span>
<a href="#l11.122"></a><span id="l11.122" class="difflineplus">+#define BZ_RUNA 0</span>
<a href="#l11.123"></a><span id="l11.123" class="difflineplus">+#define BZ_RUNB 1</span>
<a href="#l11.124"></a><span id="l11.124" class="difflineplus">+</span>
<a href="#l11.125"></a><span id="l11.125" class="difflineplus">+#define BZ_N_GROUPS 6</span>
<a href="#l11.126"></a><span id="l11.126" class="difflineplus">+#define BZ_G_SIZE   50</span>
<a href="#l11.127"></a><span id="l11.127" class="difflineplus">+#define BZ_N_ITERS  4</span>
<a href="#l11.128"></a><span id="l11.128" class="difflineplus">+</span>
<a href="#l11.129"></a><span id="l11.129" class="difflineplus">+#define BZ_MAX_SELECTORS (2 + (900000 / BZ_G_SIZE))</span>
<a href="#l11.130"></a><span id="l11.130" class="difflineplus">+</span>
<a href="#l11.131"></a><span id="l11.131" class="difflineplus">+</span>
<a href="#l11.132"></a><span id="l11.132" class="difflineplus">+</span>
<a href="#l11.133"></a><span id="l11.133" class="difflineplus">+/*-- Stuff for randomising repetitive blocks. --*/</span>
<a href="#l11.134"></a><span id="l11.134" class="difflineplus">+</span>
<a href="#l11.135"></a><span id="l11.135" class="difflineplus">+extern Int32 BZ2_rNums[512];</span>
<a href="#l11.136"></a><span id="l11.136" class="difflineplus">+</span>
<a href="#l11.137"></a><span id="l11.137" class="difflineplus">+#define BZ_RAND_DECLS                          \</span>
<a href="#l11.138"></a><span id="l11.138" class="difflineplus">+   Int32 rNToGo;                               \</span>
<a href="#l11.139"></a><span id="l11.139" class="difflineplus">+   Int32 rTPos                                 \</span>
<a href="#l11.140"></a><span id="l11.140" class="difflineplus">+</span>
<a href="#l11.141"></a><span id="l11.141" class="difflineplus">+#define BZ_RAND_INIT_MASK                      \</span>
<a href="#l11.142"></a><span id="l11.142" class="difflineplus">+   s-&gt;rNToGo = 0;                              \</span>
<a href="#l11.143"></a><span id="l11.143" class="difflineplus">+   s-&gt;rTPos  = 0                               \</span>
<a href="#l11.144"></a><span id="l11.144" class="difflineplus">+</span>
<a href="#l11.145"></a><span id="l11.145" class="difflineplus">+#define BZ_RAND_MASK ((s-&gt;rNToGo == 1) ? 1 : 0)</span>
<a href="#l11.146"></a><span id="l11.146" class="difflineplus">+</span>
<a href="#l11.147"></a><span id="l11.147" class="difflineplus">+#define BZ_RAND_UPD_MASK                       \</span>
<a href="#l11.148"></a><span id="l11.148" class="difflineplus">+   if (s-&gt;rNToGo == 0) {                       \</span>
<a href="#l11.149"></a><span id="l11.149" class="difflineplus">+      s-&gt;rNToGo = BZ2_rNums[s-&gt;rTPos];         \</span>
<a href="#l11.150"></a><span id="l11.150" class="difflineplus">+      s-&gt;rTPos++;                              \</span>
<a href="#l11.151"></a><span id="l11.151" class="difflineplus">+      if (s-&gt;rTPos == 512) s-&gt;rTPos = 0;       \</span>
<a href="#l11.152"></a><span id="l11.152" class="difflineplus">+   }                                           \</span>
<a href="#l11.153"></a><span id="l11.153" class="difflineplus">+   s-&gt;rNToGo--;</span>
<a href="#l11.154"></a><span id="l11.154" class="difflineplus">+</span>
<a href="#l11.155"></a><span id="l11.155" class="difflineplus">+</span>
<a href="#l11.156"></a><span id="l11.156" class="difflineplus">+</span>
<a href="#l11.157"></a><span id="l11.157" class="difflineplus">+/*-- Stuff for doing CRCs. --*/</span>
<a href="#l11.158"></a><span id="l11.158" class="difflineplus">+</span>
<a href="#l11.159"></a><span id="l11.159" class="difflineplus">+extern UInt32 BZ2_crc32Table[256];</span>
<a href="#l11.160"></a><span id="l11.160" class="difflineplus">+</span>
<a href="#l11.161"></a><span id="l11.161" class="difflineplus">+#define BZ_INITIALISE_CRC(crcVar)              \</span>
<a href="#l11.162"></a><span id="l11.162" class="difflineplus">+{                                              \</span>
<a href="#l11.163"></a><span id="l11.163" class="difflineplus">+   crcVar = 0xffffffffL;                       \</span>
<a href="#l11.164"></a><span id="l11.164" class="difflineplus">+}</span>
<a href="#l11.165"></a><span id="l11.165" class="difflineplus">+</span>
<a href="#l11.166"></a><span id="l11.166" class="difflineplus">+#define BZ_FINALISE_CRC(crcVar)                \</span>
<a href="#l11.167"></a><span id="l11.167" class="difflineplus">+{                                              \</span>
<a href="#l11.168"></a><span id="l11.168" class="difflineplus">+   crcVar = ~(crcVar);                         \</span>
<a href="#l11.169"></a><span id="l11.169" class="difflineplus">+}</span>
<a href="#l11.170"></a><span id="l11.170" class="difflineplus">+</span>
<a href="#l11.171"></a><span id="l11.171" class="difflineplus">+#define BZ_UPDATE_CRC(crcVar,cha)              \</span>
<a href="#l11.172"></a><span id="l11.172" class="difflineplus">+{                                              \</span>
<a href="#l11.173"></a><span id="l11.173" class="difflineplus">+   crcVar = (crcVar &lt;&lt; 8) ^                    \</span>
<a href="#l11.174"></a><span id="l11.174" class="difflineplus">+            BZ2_crc32Table[(crcVar &gt;&gt; 24) ^    \</span>
<a href="#l11.175"></a><span id="l11.175" class="difflineplus">+                           ((UChar)cha)];      \</span>
<a href="#l11.176"></a><span id="l11.176" class="difflineplus">+}</span>
<a href="#l11.177"></a><span id="l11.177" class="difflineplus">+</span>
<a href="#l11.178"></a><span id="l11.178" class="difflineplus">+</span>
<a href="#l11.179"></a><span id="l11.179" class="difflineplus">+</span>
<a href="#l11.180"></a><span id="l11.180" class="difflineplus">+/*-- States and modes for compression. --*/</span>
<a href="#l11.181"></a><span id="l11.181" class="difflineplus">+</span>
<a href="#l11.182"></a><span id="l11.182" class="difflineplus">+#define BZ_M_IDLE      1</span>
<a href="#l11.183"></a><span id="l11.183" class="difflineplus">+#define BZ_M_RUNNING   2</span>
<a href="#l11.184"></a><span id="l11.184" class="difflineplus">+#define BZ_M_FLUSHING  3</span>
<a href="#l11.185"></a><span id="l11.185" class="difflineplus">+#define BZ_M_FINISHING 4</span>
<a href="#l11.186"></a><span id="l11.186" class="difflineplus">+</span>
<a href="#l11.187"></a><span id="l11.187" class="difflineplus">+#define BZ_S_OUTPUT    1</span>
<a href="#l11.188"></a><span id="l11.188" class="difflineplus">+#define BZ_S_INPUT     2</span>
<a href="#l11.189"></a><span id="l11.189" class="difflineplus">+</span>
<a href="#l11.190"></a><span id="l11.190" class="difflineplus">+#define BZ_N_RADIX 2</span>
<a href="#l11.191"></a><span id="l11.191" class="difflineplus">+#define BZ_N_QSORT 12</span>
<a href="#l11.192"></a><span id="l11.192" class="difflineplus">+#define BZ_N_SHELL 18</span>
<a href="#l11.193"></a><span id="l11.193" class="difflineplus">+#define BZ_N_OVERSHOOT (BZ_N_RADIX + BZ_N_QSORT + BZ_N_SHELL + 2)</span>
<a href="#l11.194"></a><span id="l11.194" class="difflineplus">+</span>
<a href="#l11.195"></a><span id="l11.195" class="difflineplus">+</span>
<a href="#l11.196"></a><span id="l11.196" class="difflineplus">+</span>
<a href="#l11.197"></a><span id="l11.197" class="difflineplus">+</span>
<a href="#l11.198"></a><span id="l11.198" class="difflineplus">+/*-- Structure holding all the compression-side stuff. --*/</span>
<a href="#l11.199"></a><span id="l11.199" class="difflineplus">+</span>
<a href="#l11.200"></a><span id="l11.200" class="difflineplus">+typedef</span>
<a href="#l11.201"></a><span id="l11.201" class="difflineplus">+   struct {</span>
<a href="#l11.202"></a><span id="l11.202" class="difflineplus">+      /* pointer back to the struct bz_stream */</span>
<a href="#l11.203"></a><span id="l11.203" class="difflineplus">+      bz_stream* strm;</span>
<a href="#l11.204"></a><span id="l11.204" class="difflineplus">+</span>
<a href="#l11.205"></a><span id="l11.205" class="difflineplus">+      /* mode this stream is in, and whether inputting */</span>
<a href="#l11.206"></a><span id="l11.206" class="difflineplus">+      /* or outputting data */</span>
<a href="#l11.207"></a><span id="l11.207" class="difflineplus">+      Int32    mode;</span>
<a href="#l11.208"></a><span id="l11.208" class="difflineplus">+      Int32    state;</span>
<a href="#l11.209"></a><span id="l11.209" class="difflineplus">+</span>
<a href="#l11.210"></a><span id="l11.210" class="difflineplus">+      /* remembers avail_in when flush/finish requested */</span>
<a href="#l11.211"></a><span id="l11.211" class="difflineplus">+      UInt32   avail_in_expect;</span>
<a href="#l11.212"></a><span id="l11.212" class="difflineplus">+</span>
<a href="#l11.213"></a><span id="l11.213" class="difflineplus">+      /* for doing the block sorting */</span>
<a href="#l11.214"></a><span id="l11.214" class="difflineplus">+      UInt32*  arr1;</span>
<a href="#l11.215"></a><span id="l11.215" class="difflineplus">+      UInt32*  arr2;</span>
<a href="#l11.216"></a><span id="l11.216" class="difflineplus">+      UInt32*  ftab;</span>
<a href="#l11.217"></a><span id="l11.217" class="difflineplus">+      Int32    origPtr;</span>
<a href="#l11.218"></a><span id="l11.218" class="difflineplus">+</span>
<a href="#l11.219"></a><span id="l11.219" class="difflineplus">+      /* aliases for arr1 and arr2 */</span>
<a href="#l11.220"></a><span id="l11.220" class="difflineplus">+      UInt32*  ptr;</span>
<a href="#l11.221"></a><span id="l11.221" class="difflineplus">+      UChar*   block;</span>
<a href="#l11.222"></a><span id="l11.222" class="difflineplus">+      UInt16*  mtfv;</span>
<a href="#l11.223"></a><span id="l11.223" class="difflineplus">+      UChar*   zbits;</span>
<a href="#l11.224"></a><span id="l11.224" class="difflineplus">+</span>
<a href="#l11.225"></a><span id="l11.225" class="difflineplus">+      /* for deciding when to use the fallback sorting algorithm */</span>
<a href="#l11.226"></a><span id="l11.226" class="difflineplus">+      Int32    workFactor;</span>
<a href="#l11.227"></a><span id="l11.227" class="difflineplus">+</span>
<a href="#l11.228"></a><span id="l11.228" class="difflineplus">+      /* run-length-encoding of the input */</span>
<a href="#l11.229"></a><span id="l11.229" class="difflineplus">+      UInt32   state_in_ch;</span>
<a href="#l11.230"></a><span id="l11.230" class="difflineplus">+      Int32    state_in_len;</span>
<a href="#l11.231"></a><span id="l11.231" class="difflineplus">+      BZ_RAND_DECLS;</span>
<a href="#l11.232"></a><span id="l11.232" class="difflineplus">+</span>
<a href="#l11.233"></a><span id="l11.233" class="difflineplus">+      /* input and output limits and current posns */</span>
<a href="#l11.234"></a><span id="l11.234" class="difflineplus">+      Int32    nblock;</span>
<a href="#l11.235"></a><span id="l11.235" class="difflineplus">+      Int32    nblockMAX;</span>
<a href="#l11.236"></a><span id="l11.236" class="difflineplus">+      Int32    numZ;</span>
<a href="#l11.237"></a><span id="l11.237" class="difflineplus">+      Int32    state_out_pos;</span>
<a href="#l11.238"></a><span id="l11.238" class="difflineplus">+</span>
<a href="#l11.239"></a><span id="l11.239" class="difflineplus">+      /* map of bytes used in block */</span>
<a href="#l11.240"></a><span id="l11.240" class="difflineplus">+      Int32    nInUse;</span>
<a href="#l11.241"></a><span id="l11.241" class="difflineplus">+      Bool     inUse[256];</span>
<a href="#l11.242"></a><span id="l11.242" class="difflineplus">+      UChar    unseqToSeq[256];</span>
<a href="#l11.243"></a><span id="l11.243" class="difflineplus">+</span>
<a href="#l11.244"></a><span id="l11.244" class="difflineplus">+      /* the buffer for bit stream creation */</span>
<a href="#l11.245"></a><span id="l11.245" class="difflineplus">+      UInt32   bsBuff;</span>
<a href="#l11.246"></a><span id="l11.246" class="difflineplus">+      Int32    bsLive;</span>
<a href="#l11.247"></a><span id="l11.247" class="difflineplus">+</span>
<a href="#l11.248"></a><span id="l11.248" class="difflineplus">+      /* block and combined CRCs */</span>
<a href="#l11.249"></a><span id="l11.249" class="difflineplus">+      UInt32   blockCRC;</span>
<a href="#l11.250"></a><span id="l11.250" class="difflineplus">+      UInt32   combinedCRC;</span>
<a href="#l11.251"></a><span id="l11.251" class="difflineplus">+</span>
<a href="#l11.252"></a><span id="l11.252" class="difflineplus">+      /* misc administratium */</span>
<a href="#l11.253"></a><span id="l11.253" class="difflineplus">+      Int32    verbosity;</span>
<a href="#l11.254"></a><span id="l11.254" class="difflineplus">+      Int32    blockNo;</span>
<a href="#l11.255"></a><span id="l11.255" class="difflineplus">+      Int32    blockSize100k;</span>
<a href="#l11.256"></a><span id="l11.256" class="difflineplus">+</span>
<a href="#l11.257"></a><span id="l11.257" class="difflineplus">+      /* stuff for coding the MTF values */</span>
<a href="#l11.258"></a><span id="l11.258" class="difflineplus">+      Int32    nMTF;</span>
<a href="#l11.259"></a><span id="l11.259" class="difflineplus">+      Int32    mtfFreq    [BZ_MAX_ALPHA_SIZE];</span>
<a href="#l11.260"></a><span id="l11.260" class="difflineplus">+      UChar    selector   [BZ_MAX_SELECTORS];</span>
<a href="#l11.261"></a><span id="l11.261" class="difflineplus">+      UChar    selectorMtf[BZ_MAX_SELECTORS];</span>
<a href="#l11.262"></a><span id="l11.262" class="difflineplus">+</span>
<a href="#l11.263"></a><span id="l11.263" class="difflineplus">+      UChar    len     [BZ_N_GROUPS][BZ_MAX_ALPHA_SIZE];</span>
<a href="#l11.264"></a><span id="l11.264" class="difflineplus">+      Int32    code    [BZ_N_GROUPS][BZ_MAX_ALPHA_SIZE];</span>
<a href="#l11.265"></a><span id="l11.265" class="difflineplus">+      Int32    rfreq   [BZ_N_GROUPS][BZ_MAX_ALPHA_SIZE];</span>
<a href="#l11.266"></a><span id="l11.266" class="difflineplus">+      /* second dimension: only 3 needed; 4 makes index calculations faster */</span>
<a href="#l11.267"></a><span id="l11.267" class="difflineplus">+      UInt32   len_pack[BZ_MAX_ALPHA_SIZE][4];</span>
<a href="#l11.268"></a><span id="l11.268" class="difflineplus">+</span>
<a href="#l11.269"></a><span id="l11.269" class="difflineplus">+   }</span>
<a href="#l11.270"></a><span id="l11.270" class="difflineplus">+   EState;</span>
<a href="#l11.271"></a><span id="l11.271" class="difflineplus">+</span>
<a href="#l11.272"></a><span id="l11.272" class="difflineplus">+</span>
<a href="#l11.273"></a><span id="l11.273" class="difflineplus">+</span>
<a href="#l11.274"></a><span id="l11.274" class="difflineplus">+/*-- externs for compression. --*/</span>
<a href="#l11.275"></a><span id="l11.275" class="difflineplus">+</span>
<a href="#l11.276"></a><span id="l11.276" class="difflineplus">+extern void </span>
<a href="#l11.277"></a><span id="l11.277" class="difflineplus">+BZ2_blockSort ( EState* );</span>
<a href="#l11.278"></a><span id="l11.278" class="difflineplus">+</span>
<a href="#l11.279"></a><span id="l11.279" class="difflineplus">+extern void </span>
<a href="#l11.280"></a><span id="l11.280" class="difflineplus">+BZ2_compressBlock ( EState*, Bool );</span>
<a href="#l11.281"></a><span id="l11.281" class="difflineplus">+</span>
<a href="#l11.282"></a><span id="l11.282" class="difflineplus">+extern void </span>
<a href="#l11.283"></a><span id="l11.283" class="difflineplus">+BZ2_bsInitWrite ( EState* );</span>
<a href="#l11.284"></a><span id="l11.284" class="difflineplus">+</span>
<a href="#l11.285"></a><span id="l11.285" class="difflineplus">+extern void </span>
<a href="#l11.286"></a><span id="l11.286" class="difflineplus">+BZ2_hbAssignCodes ( Int32*, UChar*, Int32, Int32, Int32 );</span>
<a href="#l11.287"></a><span id="l11.287" class="difflineplus">+</span>
<a href="#l11.288"></a><span id="l11.288" class="difflineplus">+extern void </span>
<a href="#l11.289"></a><span id="l11.289" class="difflineplus">+BZ2_hbMakeCodeLengths ( UChar*, Int32*, Int32, Int32 );</span>
<a href="#l11.290"></a><span id="l11.290" class="difflineplus">+</span>
<a href="#l11.291"></a><span id="l11.291" class="difflineplus">+</span>
<a href="#l11.292"></a><span id="l11.292" class="difflineplus">+</span>
<a href="#l11.293"></a><span id="l11.293" class="difflineplus">+/*-- states for decompression. --*/</span>
<a href="#l11.294"></a><span id="l11.294" class="difflineplus">+</span>
<a href="#l11.295"></a><span id="l11.295" class="difflineplus">+#define BZ_X_IDLE        1</span>
<a href="#l11.296"></a><span id="l11.296" class="difflineplus">+#define BZ_X_OUTPUT      2</span>
<a href="#l11.297"></a><span id="l11.297" class="difflineplus">+</span>
<a href="#l11.298"></a><span id="l11.298" class="difflineplus">+#define BZ_X_MAGIC_1     10</span>
<a href="#l11.299"></a><span id="l11.299" class="difflineplus">+#define BZ_X_MAGIC_2     11</span>
<a href="#l11.300"></a><span id="l11.300" class="difflineplus">+#define BZ_X_MAGIC_3     12</span>
<a href="#l11.301"></a><span id="l11.301" class="difflineplus">+#define BZ_X_MAGIC_4     13</span>
<a href="#l11.302"></a><span id="l11.302" class="difflineplus">+#define BZ_X_BLKHDR_1    14</span>
<a href="#l11.303"></a><span id="l11.303" class="difflineplus">+#define BZ_X_BLKHDR_2    15</span>
<a href="#l11.304"></a><span id="l11.304" class="difflineplus">+#define BZ_X_BLKHDR_3    16</span>
<a href="#l11.305"></a><span id="l11.305" class="difflineplus">+#define BZ_X_BLKHDR_4    17</span>
<a href="#l11.306"></a><span id="l11.306" class="difflineplus">+#define BZ_X_BLKHDR_5    18</span>
<a href="#l11.307"></a><span id="l11.307" class="difflineplus">+#define BZ_X_BLKHDR_6    19</span>
<a href="#l11.308"></a><span id="l11.308" class="difflineplus">+#define BZ_X_BCRC_1      20</span>
<a href="#l11.309"></a><span id="l11.309" class="difflineplus">+#define BZ_X_BCRC_2      21</span>
<a href="#l11.310"></a><span id="l11.310" class="difflineplus">+#define BZ_X_BCRC_3      22</span>
<a href="#l11.311"></a><span id="l11.311" class="difflineplus">+#define BZ_X_BCRC_4      23</span>
<a href="#l11.312"></a><span id="l11.312" class="difflineplus">+#define BZ_X_RANDBIT     24</span>
<a href="#l11.313"></a><span id="l11.313" class="difflineplus">+#define BZ_X_ORIGPTR_1   25</span>
<a href="#l11.314"></a><span id="l11.314" class="difflineplus">+#define BZ_X_ORIGPTR_2   26</span>
<a href="#l11.315"></a><span id="l11.315" class="difflineplus">+#define BZ_X_ORIGPTR_3   27</span>
<a href="#l11.316"></a><span id="l11.316" class="difflineplus">+#define BZ_X_MAPPING_1   28</span>
<a href="#l11.317"></a><span id="l11.317" class="difflineplus">+#define BZ_X_MAPPING_2   29</span>
<a href="#l11.318"></a><span id="l11.318" class="difflineplus">+#define BZ_X_SELECTOR_1  30</span>
<a href="#l11.319"></a><span id="l11.319" class="difflineplus">+#define BZ_X_SELECTOR_2  31</span>
<a href="#l11.320"></a><span id="l11.320" class="difflineplus">+#define BZ_X_SELECTOR_3  32</span>
<a href="#l11.321"></a><span id="l11.321" class="difflineplus">+#define BZ_X_CODING_1    33</span>
<a href="#l11.322"></a><span id="l11.322" class="difflineplus">+#define BZ_X_CODING_2    34</span>
<a href="#l11.323"></a><span id="l11.323" class="difflineplus">+#define BZ_X_CODING_3    35</span>
<a href="#l11.324"></a><span id="l11.324" class="difflineplus">+#define BZ_X_MTF_1       36</span>
<a href="#l11.325"></a><span id="l11.325" class="difflineplus">+#define BZ_X_MTF_2       37</span>
<a href="#l11.326"></a><span id="l11.326" class="difflineplus">+#define BZ_X_MTF_3       38</span>
<a href="#l11.327"></a><span id="l11.327" class="difflineplus">+#define BZ_X_MTF_4       39</span>
<a href="#l11.328"></a><span id="l11.328" class="difflineplus">+#define BZ_X_MTF_5       40</span>
<a href="#l11.329"></a><span id="l11.329" class="difflineplus">+#define BZ_X_MTF_6       41</span>
<a href="#l11.330"></a><span id="l11.330" class="difflineplus">+#define BZ_X_ENDHDR_2    42</span>
<a href="#l11.331"></a><span id="l11.331" class="difflineplus">+#define BZ_X_ENDHDR_3    43</span>
<a href="#l11.332"></a><span id="l11.332" class="difflineplus">+#define BZ_X_ENDHDR_4    44</span>
<a href="#l11.333"></a><span id="l11.333" class="difflineplus">+#define BZ_X_ENDHDR_5    45</span>
<a href="#l11.334"></a><span id="l11.334" class="difflineplus">+#define BZ_X_ENDHDR_6    46</span>
<a href="#l11.335"></a><span id="l11.335" class="difflineplus">+#define BZ_X_CCRC_1      47</span>
<a href="#l11.336"></a><span id="l11.336" class="difflineplus">+#define BZ_X_CCRC_2      48</span>
<a href="#l11.337"></a><span id="l11.337" class="difflineplus">+#define BZ_X_CCRC_3      49</span>
<a href="#l11.338"></a><span id="l11.338" class="difflineplus">+#define BZ_X_CCRC_4      50</span>
<a href="#l11.339"></a><span id="l11.339" class="difflineplus">+</span>
<a href="#l11.340"></a><span id="l11.340" class="difflineplus">+</span>
<a href="#l11.341"></a><span id="l11.341" class="difflineplus">+</span>
<a href="#l11.342"></a><span id="l11.342" class="difflineplus">+/*-- Constants for the fast MTF decoder. --*/</span>
<a href="#l11.343"></a><span id="l11.343" class="difflineplus">+</span>
<a href="#l11.344"></a><span id="l11.344" class="difflineplus">+#define MTFA_SIZE 4096</span>
<a href="#l11.345"></a><span id="l11.345" class="difflineplus">+#define MTFL_SIZE 16</span>
<a href="#l11.346"></a><span id="l11.346" class="difflineplus">+</span>
<a href="#l11.347"></a><span id="l11.347" class="difflineplus">+</span>
<a href="#l11.348"></a><span id="l11.348" class="difflineplus">+</span>
<a href="#l11.349"></a><span id="l11.349" class="difflineplus">+/*-- Structure holding all the decompression-side stuff. --*/</span>
<a href="#l11.350"></a><span id="l11.350" class="difflineplus">+</span>
<a href="#l11.351"></a><span id="l11.351" class="difflineplus">+typedef</span>
<a href="#l11.352"></a><span id="l11.352" class="difflineplus">+   struct {</span>
<a href="#l11.353"></a><span id="l11.353" class="difflineplus">+      /* pointer back to the struct bz_stream */</span>
<a href="#l11.354"></a><span id="l11.354" class="difflineplus">+      bz_stream* strm;</span>
<a href="#l11.355"></a><span id="l11.355" class="difflineplus">+</span>
<a href="#l11.356"></a><span id="l11.356" class="difflineplus">+      /* state indicator for this stream */</span>
<a href="#l11.357"></a><span id="l11.357" class="difflineplus">+      Int32    state;</span>
<a href="#l11.358"></a><span id="l11.358" class="difflineplus">+</span>
<a href="#l11.359"></a><span id="l11.359" class="difflineplus">+      /* for doing the final run-length decoding */</span>
<a href="#l11.360"></a><span id="l11.360" class="difflineplus">+      UChar    state_out_ch;</span>
<a href="#l11.361"></a><span id="l11.361" class="difflineplus">+      Int32    state_out_len;</span>
<a href="#l11.362"></a><span id="l11.362" class="difflineplus">+      Bool     blockRandomised;</span>
<a href="#l11.363"></a><span id="l11.363" class="difflineplus">+      BZ_RAND_DECLS;</span>
<a href="#l11.364"></a><span id="l11.364" class="difflineplus">+</span>
<a href="#l11.365"></a><span id="l11.365" class="difflineplus">+      /* the buffer for bit stream reading */</span>
<a href="#l11.366"></a><span id="l11.366" class="difflineplus">+      UInt32   bsBuff;</span>
<a href="#l11.367"></a><span id="l11.367" class="difflineplus">+      Int32    bsLive;</span>
<a href="#l11.368"></a><span id="l11.368" class="difflineplus">+</span>
<a href="#l11.369"></a><span id="l11.369" class="difflineplus">+      /* misc administratium */</span>
<a href="#l11.370"></a><span id="l11.370" class="difflineplus">+      Int32    blockSize100k;</span>
<a href="#l11.371"></a><span id="l11.371" class="difflineplus">+      Bool     smallDecompress;</span>
<a href="#l11.372"></a><span id="l11.372" class="difflineplus">+      Int32    currBlockNo;</span>
<a href="#l11.373"></a><span id="l11.373" class="difflineplus">+      Int32    verbosity;</span>
<a href="#l11.374"></a><span id="l11.374" class="difflineplus">+</span>
<a href="#l11.375"></a><span id="l11.375" class="difflineplus">+      /* for undoing the Burrows-Wheeler transform */</span>
<a href="#l11.376"></a><span id="l11.376" class="difflineplus">+      Int32    origPtr;</span>
<a href="#l11.377"></a><span id="l11.377" class="difflineplus">+      UInt32   tPos;</span>
<a href="#l11.378"></a><span id="l11.378" class="difflineplus">+      Int32    k0;</span>
<a href="#l11.379"></a><span id="l11.379" class="difflineplus">+      Int32    unzftab[256];</span>
<a href="#l11.380"></a><span id="l11.380" class="difflineplus">+      Int32    nblock_used;</span>
<a href="#l11.381"></a><span id="l11.381" class="difflineplus">+      Int32    cftab[257];</span>
<a href="#l11.382"></a><span id="l11.382" class="difflineplus">+      Int32    cftabCopy[257];</span>
<a href="#l11.383"></a><span id="l11.383" class="difflineplus">+</span>
<a href="#l11.384"></a><span id="l11.384" class="difflineplus">+      /* for undoing the Burrows-Wheeler transform (FAST) */</span>
<a href="#l11.385"></a><span id="l11.385" class="difflineplus">+      UInt32   *tt;</span>
<a href="#l11.386"></a><span id="l11.386" class="difflineplus">+</span>
<a href="#l11.387"></a><span id="l11.387" class="difflineplus">+      /* for undoing the Burrows-Wheeler transform (SMALL) */</span>
<a href="#l11.388"></a><span id="l11.388" class="difflineplus">+      UInt16   *ll16;</span>
<a href="#l11.389"></a><span id="l11.389" class="difflineplus">+      UChar    *ll4;</span>
<a href="#l11.390"></a><span id="l11.390" class="difflineplus">+</span>
<a href="#l11.391"></a><span id="l11.391" class="difflineplus">+      /* stored and calculated CRCs */</span>
<a href="#l11.392"></a><span id="l11.392" class="difflineplus">+      UInt32   storedBlockCRC;</span>
<a href="#l11.393"></a><span id="l11.393" class="difflineplus">+      UInt32   storedCombinedCRC;</span>
<a href="#l11.394"></a><span id="l11.394" class="difflineplus">+      UInt32   calculatedBlockCRC;</span>
<a href="#l11.395"></a><span id="l11.395" class="difflineplus">+      UInt32   calculatedCombinedCRC;</span>
<a href="#l11.396"></a><span id="l11.396" class="difflineplus">+</span>
<a href="#l11.397"></a><span id="l11.397" class="difflineplus">+      /* map of bytes used in block */</span>
<a href="#l11.398"></a><span id="l11.398" class="difflineplus">+      Int32    nInUse;</span>
<a href="#l11.399"></a><span id="l11.399" class="difflineplus">+      Bool     inUse[256];</span>
<a href="#l11.400"></a><span id="l11.400" class="difflineplus">+      Bool     inUse16[16];</span>
<a href="#l11.401"></a><span id="l11.401" class="difflineplus">+      UChar    seqToUnseq[256];</span>
<a href="#l11.402"></a><span id="l11.402" class="difflineplus">+</span>
<a href="#l11.403"></a><span id="l11.403" class="difflineplus">+      /* for decoding the MTF values */</span>
<a href="#l11.404"></a><span id="l11.404" class="difflineplus">+      UChar    mtfa   [MTFA_SIZE];</span>
<a href="#l11.405"></a><span id="l11.405" class="difflineplus">+      Int32    mtfbase[256 / MTFL_SIZE];</span>
<a href="#l11.406"></a><span id="l11.406" class="difflineplus">+      UChar    selector   [BZ_MAX_SELECTORS];</span>
<a href="#l11.407"></a><span id="l11.407" class="difflineplus">+      UChar    selectorMtf[BZ_MAX_SELECTORS];</span>
<a href="#l11.408"></a><span id="l11.408" class="difflineplus">+      UChar    len  [BZ_N_GROUPS][BZ_MAX_ALPHA_SIZE];</span>
<a href="#l11.409"></a><span id="l11.409" class="difflineplus">+</span>
<a href="#l11.410"></a><span id="l11.410" class="difflineplus">+      Int32    limit  [BZ_N_GROUPS][BZ_MAX_ALPHA_SIZE];</span>
<a href="#l11.411"></a><span id="l11.411" class="difflineplus">+      Int32    base   [BZ_N_GROUPS][BZ_MAX_ALPHA_SIZE];</span>
<a href="#l11.412"></a><span id="l11.412" class="difflineplus">+      Int32    perm   [BZ_N_GROUPS][BZ_MAX_ALPHA_SIZE];</span>
<a href="#l11.413"></a><span id="l11.413" class="difflineplus">+      Int32    minLens[BZ_N_GROUPS];</span>
<a href="#l11.414"></a><span id="l11.414" class="difflineplus">+</span>
<a href="#l11.415"></a><span id="l11.415" class="difflineplus">+      /* save area for scalars in the main decompress code */</span>
<a href="#l11.416"></a><span id="l11.416" class="difflineplus">+      Int32    save_i;</span>
<a href="#l11.417"></a><span id="l11.417" class="difflineplus">+      Int32    save_j;</span>
<a href="#l11.418"></a><span id="l11.418" class="difflineplus">+      Int32    save_t;</span>
<a href="#l11.419"></a><span id="l11.419" class="difflineplus">+      Int32    save_alphaSize;</span>
<a href="#l11.420"></a><span id="l11.420" class="difflineplus">+      Int32    save_nGroups;</span>
<a href="#l11.421"></a><span id="l11.421" class="difflineplus">+      Int32    save_nSelectors;</span>
<a href="#l11.422"></a><span id="l11.422" class="difflineplus">+      Int32    save_EOB;</span>
<a href="#l11.423"></a><span id="l11.423" class="difflineplus">+      Int32    save_groupNo;</span>
<a href="#l11.424"></a><span id="l11.424" class="difflineplus">+      Int32    save_groupPos;</span>
<a href="#l11.425"></a><span id="l11.425" class="difflineplus">+      Int32    save_nextSym;</span>
<a href="#l11.426"></a><span id="l11.426" class="difflineplus">+      Int32    save_nblockMAX;</span>
<a href="#l11.427"></a><span id="l11.427" class="difflineplus">+      Int32    save_nblock;</span>
<a href="#l11.428"></a><span id="l11.428" class="difflineplus">+      Int32    save_es;</span>
<a href="#l11.429"></a><span id="l11.429" class="difflineplus">+      Int32    save_N;</span>
<a href="#l11.430"></a><span id="l11.430" class="difflineplus">+      Int32    save_curr;</span>
<a href="#l11.431"></a><span id="l11.431" class="difflineplus">+      Int32    save_zt;</span>
<a href="#l11.432"></a><span id="l11.432" class="difflineplus">+      Int32    save_zn; </span>
<a href="#l11.433"></a><span id="l11.433" class="difflineplus">+      Int32    save_zvec;</span>
<a href="#l11.434"></a><span id="l11.434" class="difflineplus">+      Int32    save_zj;</span>
<a href="#l11.435"></a><span id="l11.435" class="difflineplus">+      Int32    save_gSel;</span>
<a href="#l11.436"></a><span id="l11.436" class="difflineplus">+      Int32    save_gMinlen;</span>
<a href="#l11.437"></a><span id="l11.437" class="difflineplus">+      Int32*   save_gLimit;</span>
<a href="#l11.438"></a><span id="l11.438" class="difflineplus">+      Int32*   save_gBase;</span>
<a href="#l11.439"></a><span id="l11.439" class="difflineplus">+      Int32*   save_gPerm;</span>
<a href="#l11.440"></a><span id="l11.440" class="difflineplus">+</span>
<a href="#l11.441"></a><span id="l11.441" class="difflineplus">+   }</span>
<a href="#l11.442"></a><span id="l11.442" class="difflineplus">+   DState;</span>
<a href="#l11.443"></a><span id="l11.443" class="difflineplus">+</span>
<a href="#l11.444"></a><span id="l11.444" class="difflineplus">+</span>
<a href="#l11.445"></a><span id="l11.445" class="difflineplus">+</span>
<a href="#l11.446"></a><span id="l11.446" class="difflineplus">+/*-- Macros for decompression. --*/</span>
<a href="#l11.447"></a><span id="l11.447" class="difflineplus">+</span>
<a href="#l11.448"></a><span id="l11.448" class="difflineplus">+#define BZ_GET_FAST(cccc)                     \</span>
<a href="#l11.449"></a><span id="l11.449" class="difflineplus">+    /* c_tPos is unsigned, hence test &lt; 0 is pointless. */ \</span>
<a href="#l11.450"></a><span id="l11.450" class="difflineplus">+    if (s-&gt;tPos &gt;= (UInt32)100000 * (UInt32)s-&gt;blockSize100k) return True; \</span>
<a href="#l11.451"></a><span id="l11.451" class="difflineplus">+    s-&gt;tPos = s-&gt;tt[s-&gt;tPos];                 \</span>
<a href="#l11.452"></a><span id="l11.452" class="difflineplus">+    cccc = (UChar)(s-&gt;tPos &amp; 0xff);           \</span>
<a href="#l11.453"></a><span id="l11.453" class="difflineplus">+    s-&gt;tPos &gt;&gt;= 8;</span>
<a href="#l11.454"></a><span id="l11.454" class="difflineplus">+</span>
<a href="#l11.455"></a><span id="l11.455" class="difflineplus">+#define BZ_GET_FAST_C(cccc)                   \</span>
<a href="#l11.456"></a><span id="l11.456" class="difflineplus">+    /* c_tPos is unsigned, hence test &lt; 0 is pointless. */ \</span>
<a href="#l11.457"></a><span id="l11.457" class="difflineplus">+    if (c_tPos &gt;= (UInt32)100000 * (UInt32)ro_blockSize100k) return True; \</span>
<a href="#l11.458"></a><span id="l11.458" class="difflineplus">+    c_tPos = c_tt[c_tPos];                    \</span>
<a href="#l11.459"></a><span id="l11.459" class="difflineplus">+    cccc = (UChar)(c_tPos &amp; 0xff);            \</span>
<a href="#l11.460"></a><span id="l11.460" class="difflineplus">+    c_tPos &gt;&gt;= 8;</span>
<a href="#l11.461"></a><span id="l11.461" class="difflineplus">+</span>
<a href="#l11.462"></a><span id="l11.462" class="difflineplus">+#define SET_LL4(i,n)                                          \</span>
<a href="#l11.463"></a><span id="l11.463" class="difflineplus">+   { if (((i) &amp; 0x1) == 0)                                    \</span>
<a href="#l11.464"></a><span id="l11.464" class="difflineplus">+        s-&gt;ll4[(i) &gt;&gt; 1] = (s-&gt;ll4[(i) &gt;&gt; 1] &amp; 0xf0) | (n); else    \</span>
<a href="#l11.465"></a><span id="l11.465" class="difflineplus">+        s-&gt;ll4[(i) &gt;&gt; 1] = (s-&gt;ll4[(i) &gt;&gt; 1] &amp; 0x0f) | ((n) &lt;&lt; 4);  \</span>
<a href="#l11.466"></a><span id="l11.466" class="difflineplus">+   }</span>
<a href="#l11.467"></a><span id="l11.467" class="difflineplus">+</span>
<a href="#l11.468"></a><span id="l11.468" class="difflineplus">+#define GET_LL4(i)                             \</span>
<a href="#l11.469"></a><span id="l11.469" class="difflineplus">+   ((((UInt32)(s-&gt;ll4[(i) &gt;&gt; 1])) &gt;&gt; (((i) &lt;&lt; 2) &amp; 0x4)) &amp; 0xF)</span>
<a href="#l11.470"></a><span id="l11.470" class="difflineplus">+</span>
<a href="#l11.471"></a><span id="l11.471" class="difflineplus">+#define SET_LL(i,n)                          \</span>
<a href="#l11.472"></a><span id="l11.472" class="difflineplus">+   { s-&gt;ll16[i] = (UInt16)(n &amp; 0x0000ffff);  \</span>
<a href="#l11.473"></a><span id="l11.473" class="difflineplus">+     SET_LL4(i, n &gt;&gt; 16);                    \</span>
<a href="#l11.474"></a><span id="l11.474" class="difflineplus">+   }</span>
<a href="#l11.475"></a><span id="l11.475" class="difflineplus">+</span>
<a href="#l11.476"></a><span id="l11.476" class="difflineplus">+#define GET_LL(i) \</span>
<a href="#l11.477"></a><span id="l11.477" class="difflineplus">+   (((UInt32)s-&gt;ll16[i]) | (GET_LL4(i) &lt;&lt; 16))</span>
<a href="#l11.478"></a><span id="l11.478" class="difflineplus">+</span>
<a href="#l11.479"></a><span id="l11.479" class="difflineplus">+#define BZ_GET_SMALL(cccc)                            \</span>
<a href="#l11.480"></a><span id="l11.480" class="difflineplus">+    /* c_tPos is unsigned, hence test &lt; 0 is pointless. */ \</span>
<a href="#l11.481"></a><span id="l11.481" class="difflineplus">+    if (s-&gt;tPos &gt;= (UInt32)100000 * (UInt32)s-&gt;blockSize100k) return True; \</span>
<a href="#l11.482"></a><span id="l11.482" class="difflineplus">+    cccc = BZ2_indexIntoF ( s-&gt;tPos, s-&gt;cftab );    \</span>
<a href="#l11.483"></a><span id="l11.483" class="difflineplus">+    s-&gt;tPos = GET_LL(s-&gt;tPos);</span>
<a href="#l11.484"></a><span id="l11.484" class="difflineplus">+</span>
<a href="#l11.485"></a><span id="l11.485" class="difflineplus">+</span>
<a href="#l11.486"></a><span id="l11.486" class="difflineplus">+/*-- externs for decompression. --*/</span>
<a href="#l11.487"></a><span id="l11.487" class="difflineplus">+</span>
<a href="#l11.488"></a><span id="l11.488" class="difflineplus">+extern Int32 </span>
<a href="#l11.489"></a><span id="l11.489" class="difflineplus">+BZ2_indexIntoF ( Int32, Int32* );</span>
<a href="#l11.490"></a><span id="l11.490" class="difflineplus">+</span>
<a href="#l11.491"></a><span id="l11.491" class="difflineplus">+extern Int32 </span>
<a href="#l11.492"></a><span id="l11.492" class="difflineplus">+BZ2_decompress ( DState* );</span>
<a href="#l11.493"></a><span id="l11.493" class="difflineplus">+</span>
<a href="#l11.494"></a><span id="l11.494" class="difflineplus">+extern void </span>
<a href="#l11.495"></a><span id="l11.495" class="difflineplus">+BZ2_hbCreateDecodeTables ( Int32*, Int32*, Int32*, UChar*,</span>
<a href="#l11.496"></a><span id="l11.496" class="difflineplus">+                           Int32,  Int32, Int32 );</span>
<a href="#l11.497"></a><span id="l11.497" class="difflineplus">+</span>
<a href="#l11.498"></a><span id="l11.498" class="difflineplus">+</span>
<a href="#l11.499"></a><span id="l11.499" class="difflineplus">+#endif</span>
<a href="#l11.500"></a><span id="l11.500" class="difflineplus">+</span>
<a href="#l11.501"></a><span id="l11.501" class="difflineplus">+</span>
<a href="#l11.502"></a><span id="l11.502" class="difflineplus">+/*-- BZ_NO_STDIO seems to make NULL disappear on some platforms. --*/</span>
<a href="#l11.503"></a><span id="l11.503" class="difflineplus">+</span>
<a href="#l11.504"></a><span id="l11.504" class="difflineplus">+#ifdef BZ_NO_STDIO</span>
<a href="#l11.505"></a><span id="l11.505" class="difflineplus">+#ifndef NULL</span>
<a href="#l11.506"></a><span id="l11.506" class="difflineplus">+#define NULL 0</span>
<a href="#l11.507"></a><span id="l11.507" class="difflineplus">+#endif</span>
<a href="#l11.508"></a><span id="l11.508" class="difflineplus">+#endif</span>
<a href="#l11.509"></a><span id="l11.509" class="difflineplus">+</span>
<a href="#l11.510"></a><span id="l11.510" class="difflineplus">+</span>
<a href="#l11.511"></a><span id="l11.511" class="difflineplus">+/*-------------------------------------------------------------*/</span>
<a href="#l11.512"></a><span id="l11.512" class="difflineplus">+/*--- end                                   bzlib_private.h ---*/</span>
<a href="#l11.513"></a><span id="l11.513" class="difflineplus">+/*-------------------------------------------------------------*/</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1">new file mode 100644</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineminus">--- /dev/null</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineplus">+++ b/third_party/bzip2/compress.c</span>
<a href="#l12.4"></a><span id="l12.4" class="difflineat">@@ -0,0 +1,672 @@</span>
<a href="#l12.5"></a><span id="l12.5" class="difflineplus">+</span>
<a href="#l12.6"></a><span id="l12.6" class="difflineplus">+/*-------------------------------------------------------------*/</span>
<a href="#l12.7"></a><span id="l12.7" class="difflineplus">+/*--- Compression machinery (not incl block sorting)        ---*/</span>
<a href="#l12.8"></a><span id="l12.8" class="difflineplus">+/*---                                            compress.c ---*/</span>
<a href="#l12.9"></a><span id="l12.9" class="difflineplus">+/*-------------------------------------------------------------*/</span>
<a href="#l12.10"></a><span id="l12.10" class="difflineplus">+</span>
<a href="#l12.11"></a><span id="l12.11" class="difflineplus">+/* ------------------------------------------------------------------</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+   This file is part of bzip2/libbzip2, a program and library for</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+   lossless, block-sorting data compression.</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+   bzip2/libbzip2 version 1.0.8 of 13 July 2019</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineplus">+   Copyright (C) 1996-2019 Julian Seward &lt;jseward@acm.org&gt;</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineplus">+</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineplus">+   Please read the WARNING, DISCLAIMER and PATENTS sections in the </span>
<a href="#l12.19"></a><span id="l12.19" class="difflineplus">+   README file.</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineplus">+</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineplus">+   This program is released under the terms of the license contained</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineplus">+   in the file LICENSE.</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineplus">+   ------------------------------------------------------------------ */</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineplus">+</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineplus">+</span>
<a href="#l12.26"></a><span id="l12.26" class="difflineplus">+/* CHANGES</span>
<a href="#l12.27"></a><span id="l12.27" class="difflineplus">+    0.9.0    -- original version.</span>
<a href="#l12.28"></a><span id="l12.28" class="difflineplus">+    0.9.0a/b -- no changes in this file.</span>
<a href="#l12.29"></a><span id="l12.29" class="difflineplus">+    0.9.0c   -- changed setting of nGroups in sendMTFValues() </span>
<a href="#l12.30"></a><span id="l12.30" class="difflineplus">+                so as to do a bit better on small files</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineplus">+*/</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineplus">+</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineplus">+#include &quot;bzlib_private.h&quot;</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineplus">+</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineplus">+</span>
<a href="#l12.36"></a><span id="l12.36" class="difflineplus">+/*---------------------------------------------------*/</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineplus">+/*--- Bit stream I/O                              ---*/</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineplus">+/*---------------------------------------------------*/</span>
<a href="#l12.39"></a><span id="l12.39" class="difflineplus">+</span>
<a href="#l12.40"></a><span id="l12.40" class="difflineplus">+/*---------------------------------------------------*/</span>
<a href="#l12.41"></a><span id="l12.41" class="difflineplus">+void BZ2_bsInitWrite ( EState* s )</span>
<a href="#l12.42"></a><span id="l12.42" class="difflineplus">+{</span>
<a href="#l12.43"></a><span id="l12.43" class="difflineplus">+   s-&gt;bsLive = 0;</span>
<a href="#l12.44"></a><span id="l12.44" class="difflineplus">+   s-&gt;bsBuff = 0;</span>
<a href="#l12.45"></a><span id="l12.45" class="difflineplus">+}</span>
<a href="#l12.46"></a><span id="l12.46" class="difflineplus">+</span>
<a href="#l12.47"></a><span id="l12.47" class="difflineplus">+</span>
<a href="#l12.48"></a><span id="l12.48" class="difflineplus">+/*---------------------------------------------------*/</span>
<a href="#l12.49"></a><span id="l12.49" class="difflineplus">+static</span>
<a href="#l12.50"></a><span id="l12.50" class="difflineplus">+void bsFinishWrite ( EState* s )</span>
<a href="#l12.51"></a><span id="l12.51" class="difflineplus">+{</span>
<a href="#l12.52"></a><span id="l12.52" class="difflineplus">+   while (s-&gt;bsLive &gt; 0) {</span>
<a href="#l12.53"></a><span id="l12.53" class="difflineplus">+      s-&gt;zbits[s-&gt;numZ] = (UChar)(s-&gt;bsBuff &gt;&gt; 24);</span>
<a href="#l12.54"></a><span id="l12.54" class="difflineplus">+      s-&gt;numZ++;</span>
<a href="#l12.55"></a><span id="l12.55" class="difflineplus">+      s-&gt;bsBuff &lt;&lt;= 8;</span>
<a href="#l12.56"></a><span id="l12.56" class="difflineplus">+      s-&gt;bsLive -= 8;</span>
<a href="#l12.57"></a><span id="l12.57" class="difflineplus">+   }</span>
<a href="#l12.58"></a><span id="l12.58" class="difflineplus">+}</span>
<a href="#l12.59"></a><span id="l12.59" class="difflineplus">+</span>
<a href="#l12.60"></a><span id="l12.60" class="difflineplus">+</span>
<a href="#l12.61"></a><span id="l12.61" class="difflineplus">+/*---------------------------------------------------*/</span>
<a href="#l12.62"></a><span id="l12.62" class="difflineplus">+#define bsNEEDW(nz)                           \</span>
<a href="#l12.63"></a><span id="l12.63" class="difflineplus">+{                                             \</span>
<a href="#l12.64"></a><span id="l12.64" class="difflineplus">+   while (s-&gt;bsLive &gt;= 8) {                   \</span>
<a href="#l12.65"></a><span id="l12.65" class="difflineplus">+      s-&gt;zbits[s-&gt;numZ]                       \</span>
<a href="#l12.66"></a><span id="l12.66" class="difflineplus">+         = (UChar)(s-&gt;bsBuff &gt;&gt; 24);          \</span>
<a href="#l12.67"></a><span id="l12.67" class="difflineplus">+      s-&gt;numZ++;                              \</span>
<a href="#l12.68"></a><span id="l12.68" class="difflineplus">+      s-&gt;bsBuff &lt;&lt;= 8;                        \</span>
<a href="#l12.69"></a><span id="l12.69" class="difflineplus">+      s-&gt;bsLive -= 8;                         \</span>
<a href="#l12.70"></a><span id="l12.70" class="difflineplus">+   }                                          \</span>
<a href="#l12.71"></a><span id="l12.71" class="difflineplus">+}</span>
<a href="#l12.72"></a><span id="l12.72" class="difflineplus">+</span>
<a href="#l12.73"></a><span id="l12.73" class="difflineplus">+</span>
<a href="#l12.74"></a><span id="l12.74" class="difflineplus">+/*---------------------------------------------------*/</span>
<a href="#l12.75"></a><span id="l12.75" class="difflineplus">+static</span>
<a href="#l12.76"></a><span id="l12.76" class="difflineplus">+__inline__</span>
<a href="#l12.77"></a><span id="l12.77" class="difflineplus">+void bsW ( EState* s, Int32 n, UInt32 v )</span>
<a href="#l12.78"></a><span id="l12.78" class="difflineplus">+{</span>
<a href="#l12.79"></a><span id="l12.79" class="difflineplus">+   bsNEEDW ( n );</span>
<a href="#l12.80"></a><span id="l12.80" class="difflineplus">+   s-&gt;bsBuff |= (v &lt;&lt; (32 - s-&gt;bsLive - n));</span>
<a href="#l12.81"></a><span id="l12.81" class="difflineplus">+   s-&gt;bsLive += n;</span>
<a href="#l12.82"></a><span id="l12.82" class="difflineplus">+}</span>
<a href="#l12.83"></a><span id="l12.83" class="difflineplus">+</span>
<a href="#l12.84"></a><span id="l12.84" class="difflineplus">+</span>
<a href="#l12.85"></a><span id="l12.85" class="difflineplus">+/*---------------------------------------------------*/</span>
<a href="#l12.86"></a><span id="l12.86" class="difflineplus">+static</span>
<a href="#l12.87"></a><span id="l12.87" class="difflineplus">+void bsPutUInt32 ( EState* s, UInt32 u )</span>
<a href="#l12.88"></a><span id="l12.88" class="difflineplus">+{</span>
<a href="#l12.89"></a><span id="l12.89" class="difflineplus">+   bsW ( s, 8, (u &gt;&gt; 24) &amp; 0xffL );</span>
<a href="#l12.90"></a><span id="l12.90" class="difflineplus">+   bsW ( s, 8, (u &gt;&gt; 16) &amp; 0xffL );</span>
<a href="#l12.91"></a><span id="l12.91" class="difflineplus">+   bsW ( s, 8, (u &gt;&gt;  8) &amp; 0xffL );</span>
<a href="#l12.92"></a><span id="l12.92" class="difflineplus">+   bsW ( s, 8,  u        &amp; 0xffL );</span>
<a href="#l12.93"></a><span id="l12.93" class="difflineplus">+}</span>
<a href="#l12.94"></a><span id="l12.94" class="difflineplus">+</span>
<a href="#l12.95"></a><span id="l12.95" class="difflineplus">+</span>
<a href="#l12.96"></a><span id="l12.96" class="difflineplus">+/*---------------------------------------------------*/</span>
<a href="#l12.97"></a><span id="l12.97" class="difflineplus">+static</span>
<a href="#l12.98"></a><span id="l12.98" class="difflineplus">+void bsPutUChar ( EState* s, UChar c )</span>
<a href="#l12.99"></a><span id="l12.99" class="difflineplus">+{</span>
<a href="#l12.100"></a><span id="l12.100" class="difflineplus">+   bsW( s, 8, (UInt32)c );</span>
<a href="#l12.101"></a><span id="l12.101" class="difflineplus">+}</span>
<a href="#l12.102"></a><span id="l12.102" class="difflineplus">+</span>
<a href="#l12.103"></a><span id="l12.103" class="difflineplus">+</span>
<a href="#l12.104"></a><span id="l12.104" class="difflineplus">+/*---------------------------------------------------*/</span>
<a href="#l12.105"></a><span id="l12.105" class="difflineplus">+/*--- The back end proper                         ---*/</span>
<a href="#l12.106"></a><span id="l12.106" class="difflineplus">+/*---------------------------------------------------*/</span>
<a href="#l12.107"></a><span id="l12.107" class="difflineplus">+</span>
<a href="#l12.108"></a><span id="l12.108" class="difflineplus">+/*---------------------------------------------------*/</span>
<a href="#l12.109"></a><span id="l12.109" class="difflineplus">+static</span>
<a href="#l12.110"></a><span id="l12.110" class="difflineplus">+void makeMaps_e ( EState* s )</span>
<a href="#l12.111"></a><span id="l12.111" class="difflineplus">+{</span>
<a href="#l12.112"></a><span id="l12.112" class="difflineplus">+   Int32 i;</span>
<a href="#l12.113"></a><span id="l12.113" class="difflineplus">+   s-&gt;nInUse = 0;</span>
<a href="#l12.114"></a><span id="l12.114" class="difflineplus">+   for (i = 0; i &lt; 256; i++)</span>
<a href="#l12.115"></a><span id="l12.115" class="difflineplus">+      if (s-&gt;inUse[i]) {</span>
<a href="#l12.116"></a><span id="l12.116" class="difflineplus">+         s-&gt;unseqToSeq[i] = s-&gt;nInUse;</span>
<a href="#l12.117"></a><span id="l12.117" class="difflineplus">+         s-&gt;nInUse++;</span>
<a href="#l12.118"></a><span id="l12.118" class="difflineplus">+      }</span>
<a href="#l12.119"></a><span id="l12.119" class="difflineplus">+}</span>
<a href="#l12.120"></a><span id="l12.120" class="difflineplus">+</span>
<a href="#l12.121"></a><span id="l12.121" class="difflineplus">+</span>
<a href="#l12.122"></a><span id="l12.122" class="difflineplus">+/*---------------------------------------------------*/</span>
<a href="#l12.123"></a><span id="l12.123" class="difflineplus">+static</span>
<a href="#l12.124"></a><span id="l12.124" class="difflineplus">+void generateMTFValues ( EState* s )</span>
<a href="#l12.125"></a><span id="l12.125" class="difflineplus">+{</span>
<a href="#l12.126"></a><span id="l12.126" class="difflineplus">+   UChar   yy[256];</span>
<a href="#l12.127"></a><span id="l12.127" class="difflineplus">+   Int32   i, j;</span>
<a href="#l12.128"></a><span id="l12.128" class="difflineplus">+   Int32   zPend;</span>
<a href="#l12.129"></a><span id="l12.129" class="difflineplus">+   Int32   wr;</span>
<a href="#l12.130"></a><span id="l12.130" class="difflineplus">+   Int32   EOB;</span>
<a href="#l12.131"></a><span id="l12.131" class="difflineplus">+</span>
<a href="#l12.132"></a><span id="l12.132" class="difflineplus">+   /* </span>
<a href="#l12.133"></a><span id="l12.133" class="difflineplus">+      After sorting (eg, here),</span>
<a href="#l12.134"></a><span id="l12.134" class="difflineplus">+         s-&gt;arr1 [ 0 .. s-&gt;nblock-1 ] holds sorted order,</span>
<a href="#l12.135"></a><span id="l12.135" class="difflineplus">+         and</span>
<a href="#l12.136"></a><span id="l12.136" class="difflineplus">+         ((UChar*)s-&gt;arr2) [ 0 .. s-&gt;nblock-1 ] </span>
<a href="#l12.137"></a><span id="l12.137" class="difflineplus">+         holds the original block data.</span>
<a href="#l12.138"></a><span id="l12.138" class="difflineplus">+</span>
<a href="#l12.139"></a><span id="l12.139" class="difflineplus">+      The first thing to do is generate the MTF values,</span>
<a href="#l12.140"></a><span id="l12.140" class="difflineplus">+      and put them in</span>
<a href="#l12.141"></a><span id="l12.141" class="difflineplus">+         ((UInt16*)s-&gt;arr1) [ 0 .. s-&gt;nblock-1 ].</span>
<a href="#l12.142"></a><span id="l12.142" class="difflineplus">+      Because there are strictly fewer or equal MTF values</span>
<a href="#l12.143"></a><span id="l12.143" class="difflineplus">+      than block values, ptr values in this area are overwritten</span>
<a href="#l12.144"></a><span id="l12.144" class="difflineplus">+      with MTF values only when they are no longer needed.</span>
<a href="#l12.145"></a><span id="l12.145" class="difflineplus">+</span>
<a href="#l12.146"></a><span id="l12.146" class="difflineplus">+      The final compressed bitstream is generated into the</span>
<a href="#l12.147"></a><span id="l12.147" class="difflineplus">+      area starting at</span>
<a href="#l12.148"></a><span id="l12.148" class="difflineplus">+         (UChar*) (&amp;((UChar*)s-&gt;arr2)[s-&gt;nblock])</span>
<a href="#l12.149"></a><span id="l12.149" class="difflineplus">+</span>
<a href="#l12.150"></a><span id="l12.150" class="difflineplus">+      These storage aliases are set up in bzCompressInit(),</span>
<a href="#l12.151"></a><span id="l12.151" class="difflineplus">+      except for the last one, which is arranged in </span>
<a href="#l12.152"></a><span id="l12.152" class="difflineplus">+      compressBlock().</span>
<a href="#l12.153"></a><span id="l12.153" class="difflineplus">+   */</span>
<a href="#l12.154"></a><span id="l12.154" class="difflineplus">+   UInt32* ptr   = s-&gt;ptr;</span>
<a href="#l12.155"></a><span id="l12.155" class="difflineplus">+   UChar* block  = s-&gt;block;</span>
<a href="#l12.156"></a><span id="l12.156" class="difflineplus">+   UInt16* mtfv  = s-&gt;mtfv;</span>
<a href="#l12.157"></a><span id="l12.157" class="difflineplus">+</span>
<a href="#l12.158"></a><span id="l12.158" class="difflineplus">+   makeMaps_e ( s );</span>
<a href="#l12.159"></a><span id="l12.159" class="difflineplus">+   EOB = s-&gt;nInUse+1;</span>
<a href="#l12.160"></a><span id="l12.160" class="difflineplus">+</span>
<a href="#l12.161"></a><span id="l12.161" class="difflineplus">+   for (i = 0; i &lt;= EOB; i++) s-&gt;mtfFreq[i] = 0;</span>
<a href="#l12.162"></a><span id="l12.162" class="difflineplus">+</span>
<a href="#l12.163"></a><span id="l12.163" class="difflineplus">+   wr = 0;</span>
<a href="#l12.164"></a><span id="l12.164" class="difflineplus">+   zPend = 0;</span>
<a href="#l12.165"></a><span id="l12.165" class="difflineplus">+   for (i = 0; i &lt; s-&gt;nInUse; i++) yy[i] = (UChar) i;</span>
<a href="#l12.166"></a><span id="l12.166" class="difflineplus">+</span>
<a href="#l12.167"></a><span id="l12.167" class="difflineplus">+   for (i = 0; i &lt; s-&gt;nblock; i++) {</span>
<a href="#l12.168"></a><span id="l12.168" class="difflineplus">+      UChar ll_i;</span>
<a href="#l12.169"></a><span id="l12.169" class="difflineplus">+      AssertD ( wr &lt;= i, &quot;generateMTFValues(1)&quot; );</span>
<a href="#l12.170"></a><span id="l12.170" class="difflineplus">+      j = ptr[i]-1; if (j &lt; 0) j += s-&gt;nblock;</span>
<a href="#l12.171"></a><span id="l12.171" class="difflineplus">+      ll_i = s-&gt;unseqToSeq[block[j]];</span>
<a href="#l12.172"></a><span id="l12.172" class="difflineplus">+      AssertD ( ll_i &lt; s-&gt;nInUse, &quot;generateMTFValues(2a)&quot; );</span>
<a href="#l12.173"></a><span id="l12.173" class="difflineplus">+</span>
<a href="#l12.174"></a><span id="l12.174" class="difflineplus">+      if (yy[0] == ll_i) { </span>
<a href="#l12.175"></a><span id="l12.175" class="difflineplus">+         zPend++;</span>
<a href="#l12.176"></a><span id="l12.176" class="difflineplus">+      } else {</span>
<a href="#l12.177"></a><span id="l12.177" class="difflineplus">+</span>
<a href="#l12.178"></a><span id="l12.178" class="difflineplus">+         if (zPend &gt; 0) {</span>
<a href="#l12.179"></a><span id="l12.179" class="difflineplus">+            zPend--;</span>
<a href="#l12.180"></a><span id="l12.180" class="difflineplus">+            while (True) {</span>
<a href="#l12.181"></a><span id="l12.181" class="difflineplus">+               if (zPend &amp; 1) {</span>
<a href="#l12.182"></a><span id="l12.182" class="difflineplus">+                  mtfv[wr] = BZ_RUNB; wr++; </span>
<a href="#l12.183"></a><span id="l12.183" class="difflineplus">+                  s-&gt;mtfFreq[BZ_RUNB]++; </span>
<a href="#l12.184"></a><span id="l12.184" class="difflineplus">+               } else {</span>
<a href="#l12.185"></a><span id="l12.185" class="difflineplus">+                  mtfv[wr] = BZ_RUNA; wr++; </span>
<a href="#l12.186"></a><span id="l12.186" class="difflineplus">+                  s-&gt;mtfFreq[BZ_RUNA]++; </span>
<a href="#l12.187"></a><span id="l12.187" class="difflineplus">+               }</span>
<a href="#l12.188"></a><span id="l12.188" class="difflineplus">+               if (zPend &lt; 2) break;</span>
<a href="#l12.189"></a><span id="l12.189" class="difflineplus">+               zPend = (zPend - 2) / 2;</span>
<a href="#l12.190"></a><span id="l12.190" class="difflineplus">+            };</span>
<a href="#l12.191"></a><span id="l12.191" class="difflineplus">+            zPend = 0;</span>
<a href="#l12.192"></a><span id="l12.192" class="difflineplus">+         }</span>
<a href="#l12.193"></a><span id="l12.193" class="difflineplus">+         {</span>
<a href="#l12.194"></a><span id="l12.194" class="difflineplus">+            register UChar  rtmp;</span>
<a href="#l12.195"></a><span id="l12.195" class="difflineplus">+            register UChar* ryy_j;</span>
<a href="#l12.196"></a><span id="l12.196" class="difflineplus">+            register UChar  rll_i;</span>
<a href="#l12.197"></a><span id="l12.197" class="difflineplus">+            rtmp  = yy[1];</span>
<a href="#l12.198"></a><span id="l12.198" class="difflineplus">+            yy[1] = yy[0];</span>
<a href="#l12.199"></a><span id="l12.199" class="difflineplus">+            ryy_j = &amp;(yy[1]);</span>
<a href="#l12.200"></a><span id="l12.200" class="difflineplus">+            rll_i = ll_i;</span>
<a href="#l12.201"></a><span id="l12.201" class="difflineplus">+            while ( rll_i != rtmp ) {</span>
<a href="#l12.202"></a><span id="l12.202" class="difflineplus">+               register UChar rtmp2;</span>
<a href="#l12.203"></a><span id="l12.203" class="difflineplus">+               ryy_j++;</span>
<a href="#l12.204"></a><span id="l12.204" class="difflineplus">+               rtmp2  = rtmp;</span>
<a href="#l12.205"></a><span id="l12.205" class="difflineplus">+               rtmp   = *ryy_j;</span>
<a href="#l12.206"></a><span id="l12.206" class="difflineplus">+               *ryy_j = rtmp2;</span>
<a href="#l12.207"></a><span id="l12.207" class="difflineplus">+            };</span>
<a href="#l12.208"></a><span id="l12.208" class="difflineplus">+            yy[0] = rtmp;</span>
<a href="#l12.209"></a><span id="l12.209" class="difflineplus">+            j = ryy_j - &amp;(yy[0]);</span>
<a href="#l12.210"></a><span id="l12.210" class="difflineplus">+            mtfv[wr] = j+1; wr++; s-&gt;mtfFreq[j+1]++;</span>
<a href="#l12.211"></a><span id="l12.211" class="difflineplus">+         }</span>
<a href="#l12.212"></a><span id="l12.212" class="difflineplus">+</span>
<a href="#l12.213"></a><span id="l12.213" class="difflineplus">+      }</span>
<a href="#l12.214"></a><span id="l12.214" class="difflineplus">+   }</span>
<a href="#l12.215"></a><span id="l12.215" class="difflineplus">+</span>
<a href="#l12.216"></a><span id="l12.216" class="difflineplus">+   if (zPend &gt; 0) {</span>
<a href="#l12.217"></a><span id="l12.217" class="difflineplus">+      zPend--;</span>
<a href="#l12.218"></a><span id="l12.218" class="difflineplus">+      while (True) {</span>
<a href="#l12.219"></a><span id="l12.219" class="difflineplus">+         if (zPend &amp; 1) {</span>
<a href="#l12.220"></a><span id="l12.220" class="difflineplus">+            mtfv[wr] = BZ_RUNB; wr++; </span>
<a href="#l12.221"></a><span id="l12.221" class="difflineplus">+            s-&gt;mtfFreq[BZ_RUNB]++; </span>
<a href="#l12.222"></a><span id="l12.222" class="difflineplus">+         } else {</span>
<a href="#l12.223"></a><span id="l12.223" class="difflineplus">+            mtfv[wr] = BZ_RUNA; wr++; </span>
<a href="#l12.224"></a><span id="l12.224" class="difflineplus">+            s-&gt;mtfFreq[BZ_RUNA]++; </span>
<a href="#l12.225"></a><span id="l12.225" class="difflineplus">+         }</span>
<a href="#l12.226"></a><span id="l12.226" class="difflineplus">+         if (zPend &lt; 2) break;</span>
<a href="#l12.227"></a><span id="l12.227" class="difflineplus">+         zPend = (zPend - 2) / 2;</span>
<a href="#l12.228"></a><span id="l12.228" class="difflineplus">+      };</span>
<a href="#l12.229"></a><span id="l12.229" class="difflineplus">+      zPend = 0;</span>
<a href="#l12.230"></a><span id="l12.230" class="difflineplus">+   }</span>
<a href="#l12.231"></a><span id="l12.231" class="difflineplus">+</span>
<a href="#l12.232"></a><span id="l12.232" class="difflineplus">+   mtfv[wr] = EOB; wr++; s-&gt;mtfFreq[EOB]++;</span>
<a href="#l12.233"></a><span id="l12.233" class="difflineplus">+</span>
<a href="#l12.234"></a><span id="l12.234" class="difflineplus">+   s-&gt;nMTF = wr;</span>
<a href="#l12.235"></a><span id="l12.235" class="difflineplus">+}</span>
<a href="#l12.236"></a><span id="l12.236" class="difflineplus">+</span>
<a href="#l12.237"></a><span id="l12.237" class="difflineplus">+</span>
<a href="#l12.238"></a><span id="l12.238" class="difflineplus">+/*---------------------------------------------------*/</span>
<a href="#l12.239"></a><span id="l12.239" class="difflineplus">+#define BZ_LESSER_ICOST  0</span>
<a href="#l12.240"></a><span id="l12.240" class="difflineplus">+#define BZ_GREATER_ICOST 15</span>
<a href="#l12.241"></a><span id="l12.241" class="difflineplus">+</span>
<a href="#l12.242"></a><span id="l12.242" class="difflineplus">+static</span>
<a href="#l12.243"></a><span id="l12.243" class="difflineplus">+void sendMTFValues ( EState* s )</span>
<a href="#l12.244"></a><span id="l12.244" class="difflineplus">+{</span>
<a href="#l12.245"></a><span id="l12.245" class="difflineplus">+   Int32 v, t, i, j, gs, ge, totc, bt, bc, iter;</span>
<a href="#l12.246"></a><span id="l12.246" class="difflineplus">+   Int32 nSelectors, alphaSize, minLen, maxLen, selCtr;</span>
<a href="#l12.247"></a><span id="l12.247" class="difflineplus">+   Int32 nGroups, nBytes;</span>
<a href="#l12.248"></a><span id="l12.248" class="difflineplus">+</span>
<a href="#l12.249"></a><span id="l12.249" class="difflineplus">+   /*--</span>
<a href="#l12.250"></a><span id="l12.250" class="difflineplus">+   UChar  len [BZ_N_GROUPS][BZ_MAX_ALPHA_SIZE];</span>
<a href="#l12.251"></a><span id="l12.251" class="difflineplus">+   is a global since the decoder also needs it.</span>
<a href="#l12.252"></a><span id="l12.252" class="difflineplus">+</span>
<a href="#l12.253"></a><span id="l12.253" class="difflineplus">+   Int32  code[BZ_N_GROUPS][BZ_MAX_ALPHA_SIZE];</span>
<a href="#l12.254"></a><span id="l12.254" class="difflineplus">+   Int32  rfreq[BZ_N_GROUPS][BZ_MAX_ALPHA_SIZE];</span>
<a href="#l12.255"></a><span id="l12.255" class="difflineplus">+   are also globals only used in this proc.</span>
<a href="#l12.256"></a><span id="l12.256" class="difflineplus">+   Made global to keep stack frame size small.</span>
<a href="#l12.257"></a><span id="l12.257" class="difflineplus">+   --*/</span>
<a href="#l12.258"></a><span id="l12.258" class="difflineplus">+</span>
<a href="#l12.259"></a><span id="l12.259" class="difflineplus">+</span>
<a href="#l12.260"></a><span id="l12.260" class="difflineplus">+   UInt16 cost[BZ_N_GROUPS];</span>
<a href="#l12.261"></a><span id="l12.261" class="difflineplus">+   Int32  fave[BZ_N_GROUPS];</span>
<a href="#l12.262"></a><span id="l12.262" class="difflineplus">+</span>
<a href="#l12.263"></a><span id="l12.263" class="difflineplus">+   UInt16* mtfv = s-&gt;mtfv;</span>
<a href="#l12.264"></a><span id="l12.264" class="difflineplus">+</span>
<a href="#l12.265"></a><span id="l12.265" class="difflineplus">+   if (s-&gt;verbosity &gt;= 3)</span>
<a href="#l12.266"></a><span id="l12.266" class="difflineplus">+      VPrintf3( &quot;      %d in block, %d after MTF &amp; 1-2 coding, &quot;</span>
<a href="#l12.267"></a><span id="l12.267" class="difflineplus">+                &quot;%d+2 syms in use\n&quot;, </span>
<a href="#l12.268"></a><span id="l12.268" class="difflineplus">+                s-&gt;nblock, s-&gt;nMTF, s-&gt;nInUse );</span>
<a href="#l12.269"></a><span id="l12.269" class="difflineplus">+</span>
<a href="#l12.270"></a><span id="l12.270" class="difflineplus">+   alphaSize = s-&gt;nInUse+2;</span>
<a href="#l12.271"></a><span id="l12.271" class="difflineplus">+   for (t = 0; t &lt; BZ_N_GROUPS; t++)</span>
<a href="#l12.272"></a><span id="l12.272" class="difflineplus">+      for (v = 0; v &lt; alphaSize; v++)</span>
<a href="#l12.273"></a><span id="l12.273" class="difflineplus">+         s-&gt;len[t][v] = BZ_GREATER_ICOST;</span>
<a href="#l12.274"></a><span id="l12.274" class="difflineplus">+</span>
<a href="#l12.275"></a><span id="l12.275" class="difflineplus">+   /*--- Decide how many coding tables to use ---*/</span>
<a href="#l12.276"></a><span id="l12.276" class="difflineplus">+   AssertH ( s-&gt;nMTF &gt; 0, 3001 );</span>
<a href="#l12.277"></a><span id="l12.277" class="difflineplus">+   if (s-&gt;nMTF &lt; 200)  nGroups = 2; else</span>
<a href="#l12.278"></a><span id="l12.278" class="difflineplus">+   if (s-&gt;nMTF &lt; 600)  nGroups = 3; else</span>
<a href="#l12.279"></a><span id="l12.279" class="difflineplus">+   if (s-&gt;nMTF &lt; 1200) nGroups = 4; else</span>
<a href="#l12.280"></a><span id="l12.280" class="difflineplus">+   if (s-&gt;nMTF &lt; 2400) nGroups = 5; else</span>
<a href="#l12.281"></a><span id="l12.281" class="difflineplus">+                       nGroups = 6;</span>
<a href="#l12.282"></a><span id="l12.282" class="difflineplus">+</span>
<a href="#l12.283"></a><span id="l12.283" class="difflineplus">+   /*--- Generate an initial set of coding tables ---*/</span>
<a href="#l12.284"></a><span id="l12.284" class="difflineplus">+   { </span>
<a href="#l12.285"></a><span id="l12.285" class="difflineplus">+      Int32 nPart, remF, tFreq, aFreq;</span>
<a href="#l12.286"></a><span id="l12.286" class="difflineplus">+</span>
<a href="#l12.287"></a><span id="l12.287" class="difflineplus">+      nPart = nGroups;</span>
<a href="#l12.288"></a><span id="l12.288" class="difflineplus">+      remF  = s-&gt;nMTF;</span>
<a href="#l12.289"></a><span id="l12.289" class="difflineplus">+      gs = 0;</span>
<a href="#l12.290"></a><span id="l12.290" class="difflineplus">+      while (nPart &gt; 0) {</span>
<a href="#l12.291"></a><span id="l12.291" class="difflineplus">+         tFreq = remF / nPart;</span>
<a href="#l12.292"></a><span id="l12.292" class="difflineplus">+         ge = gs-1;</span>
<a href="#l12.293"></a><span id="l12.293" class="difflineplus">+         aFreq = 0;</span>
<a href="#l12.294"></a><span id="l12.294" class="difflineplus">+         while (aFreq &lt; tFreq &amp;&amp; ge &lt; alphaSize-1) {</span>
<a href="#l12.295"></a><span id="l12.295" class="difflineplus">+            ge++;</span>
<a href="#l12.296"></a><span id="l12.296" class="difflineplus">+            aFreq += s-&gt;mtfFreq[ge];</span>
<a href="#l12.297"></a><span id="l12.297" class="difflineplus">+         }</span>
<a href="#l12.298"></a><span id="l12.298" class="difflineplus">+</span>
<a href="#l12.299"></a><span id="l12.299" class="difflineplus">+         if (ge &gt; gs </span>
<a href="#l12.300"></a><span id="l12.300" class="difflineplus">+             &amp;&amp; nPart != nGroups &amp;&amp; nPart != 1 </span>
<a href="#l12.301"></a><span id="l12.301" class="difflineplus">+             &amp;&amp; ((nGroups-nPart) % 2 == 1)) {</span>
<a href="#l12.302"></a><span id="l12.302" class="difflineplus">+            aFreq -= s-&gt;mtfFreq[ge];</span>
<a href="#l12.303"></a><span id="l12.303" class="difflineplus">+            ge--;</span>
<a href="#l12.304"></a><span id="l12.304" class="difflineplus">+         }</span>
<a href="#l12.305"></a><span id="l12.305" class="difflineplus">+</span>
<a href="#l12.306"></a><span id="l12.306" class="difflineplus">+         if (s-&gt;verbosity &gt;= 3)</span>
<a href="#l12.307"></a><span id="l12.307" class="difflineplus">+            VPrintf5( &quot;      initial group %d, [%d .. %d], &quot;</span>
<a href="#l12.308"></a><span id="l12.308" class="difflineplus">+                      &quot;has %d syms (%4.1f%%)\n&quot;,</span>
<a href="#l12.309"></a><span id="l12.309" class="difflineplus">+                      nPart, gs, ge, aFreq, </span>
<a href="#l12.310"></a><span id="l12.310" class="difflineplus">+                      (100.0 * (float)aFreq) / (float)(s-&gt;nMTF) );</span>
<a href="#l12.311"></a><span id="l12.311" class="difflineplus">+ </span>
<a href="#l12.312"></a><span id="l12.312" class="difflineplus">+         for (v = 0; v &lt; alphaSize; v++)</span>
<a href="#l12.313"></a><span id="l12.313" class="difflineplus">+            if (v &gt;= gs &amp;&amp; v &lt;= ge) </span>
<a href="#l12.314"></a><span id="l12.314" class="difflineplus">+               s-&gt;len[nPart-1][v] = BZ_LESSER_ICOST; else</span>
<a href="#l12.315"></a><span id="l12.315" class="difflineplus">+               s-&gt;len[nPart-1][v] = BZ_GREATER_ICOST;</span>
<a href="#l12.316"></a><span id="l12.316" class="difflineplus">+ </span>
<a href="#l12.317"></a><span id="l12.317" class="difflineplus">+         nPart--;</span>
<a href="#l12.318"></a><span id="l12.318" class="difflineplus">+         gs = ge+1;</span>
<a href="#l12.319"></a><span id="l12.319" class="difflineplus">+         remF -= aFreq;</span>
<a href="#l12.320"></a><span id="l12.320" class="difflineplus">+      }</span>
<a href="#l12.321"></a><span id="l12.321" class="difflineplus">+   }</span>
<a href="#l12.322"></a><span id="l12.322" class="difflineplus">+</span>
<a href="#l12.323"></a><span id="l12.323" class="difflineplus">+   /*--- </span>
<a href="#l12.324"></a><span id="l12.324" class="difflineplus">+      Iterate up to BZ_N_ITERS times to improve the tables.</span>
<a href="#l12.325"></a><span id="l12.325" class="difflineplus">+   ---*/</span>
<a href="#l12.326"></a><span id="l12.326" class="difflineplus">+   for (iter = 0; iter &lt; BZ_N_ITERS; iter++) {</span>
<a href="#l12.327"></a><span id="l12.327" class="difflineplus">+</span>
<a href="#l12.328"></a><span id="l12.328" class="difflineplus">+      for (t = 0; t &lt; nGroups; t++) fave[t] = 0;</span>
<a href="#l12.329"></a><span id="l12.329" class="difflineplus">+</span>
<a href="#l12.330"></a><span id="l12.330" class="difflineplus">+      for (t = 0; t &lt; nGroups; t++)</span>
<a href="#l12.331"></a><span id="l12.331" class="difflineplus">+         for (v = 0; v &lt; alphaSize; v++)</span>
<a href="#l12.332"></a><span id="l12.332" class="difflineplus">+            s-&gt;rfreq[t][v] = 0;</span>
<a href="#l12.333"></a><span id="l12.333" class="difflineplus">+</span>
<a href="#l12.334"></a><span id="l12.334" class="difflineplus">+      /*---</span>
<a href="#l12.335"></a><span id="l12.335" class="difflineplus">+        Set up an auxiliary length table which is used to fast-track</span>
<a href="#l12.336"></a><span id="l12.336" class="difflineplus">+	the common case (nGroups == 6). </span>
<a href="#l12.337"></a><span id="l12.337" class="difflineplus">+      ---*/</span>
<a href="#l12.338"></a><span id="l12.338" class="difflineplus">+      if (nGroups == 6) {</span>
<a href="#l12.339"></a><span id="l12.339" class="difflineplus">+         for (v = 0; v &lt; alphaSize; v++) {</span>
<a href="#l12.340"></a><span id="l12.340" class="difflineplus">+            s-&gt;len_pack[v][0] = (s-&gt;len[1][v] &lt;&lt; 16) | s-&gt;len[0][v];</span>
<a href="#l12.341"></a><span id="l12.341" class="difflineplus">+            s-&gt;len_pack[v][1] = (s-&gt;len[3][v] &lt;&lt; 16) | s-&gt;len[2][v];</span>
<a href="#l12.342"></a><span id="l12.342" class="difflineplus">+            s-&gt;len_pack[v][2] = (s-&gt;len[5][v] &lt;&lt; 16) | s-&gt;len[4][v];</span>
<a href="#l12.343"></a><span id="l12.343" class="difflineplus">+	 }</span>
<a href="#l12.344"></a><span id="l12.344" class="difflineplus">+      }</span>
<a href="#l12.345"></a><span id="l12.345" class="difflineplus">+</span>
<a href="#l12.346"></a><span id="l12.346" class="difflineplus">+      nSelectors = 0;</span>
<a href="#l12.347"></a><span id="l12.347" class="difflineplus">+      totc = 0;</span>
<a href="#l12.348"></a><span id="l12.348" class="difflineplus">+      gs = 0;</span>
<a href="#l12.349"></a><span id="l12.349" class="difflineplus">+      while (True) {</span>
<a href="#l12.350"></a><span id="l12.350" class="difflineplus">+</span>
<a href="#l12.351"></a><span id="l12.351" class="difflineplus">+         /*--- Set group start &amp; end marks. --*/</span>
<a href="#l12.352"></a><span id="l12.352" class="difflineplus">+         if (gs &gt;= s-&gt;nMTF) break;</span>
<a href="#l12.353"></a><span id="l12.353" class="difflineplus">+         ge = gs + BZ_G_SIZE - 1; </span>
<a href="#l12.354"></a><span id="l12.354" class="difflineplus">+         if (ge &gt;= s-&gt;nMTF) ge = s-&gt;nMTF-1;</span>
<a href="#l12.355"></a><span id="l12.355" class="difflineplus">+</span>
<a href="#l12.356"></a><span id="l12.356" class="difflineplus">+         /*-- </span>
<a href="#l12.357"></a><span id="l12.357" class="difflineplus">+            Calculate the cost of this group as coded</span>
<a href="#l12.358"></a><span id="l12.358" class="difflineplus">+            by each of the coding tables.</span>
<a href="#l12.359"></a><span id="l12.359" class="difflineplus">+         --*/</span>
<a href="#l12.360"></a><span id="l12.360" class="difflineplus">+         for (t = 0; t &lt; nGroups; t++) cost[t] = 0;</span>
<a href="#l12.361"></a><span id="l12.361" class="difflineplus">+</span>
<a href="#l12.362"></a><span id="l12.362" class="difflineplus">+         if (nGroups == 6 &amp;&amp; 50 == ge-gs+1) {</span>
<a href="#l12.363"></a><span id="l12.363" class="difflineplus">+            /*--- fast track the common case ---*/</span>
<a href="#l12.364"></a><span id="l12.364" class="difflineplus">+            register UInt32 cost01, cost23, cost45;</span>
<a href="#l12.365"></a><span id="l12.365" class="difflineplus">+            register UInt16 icv;</span>
<a href="#l12.366"></a><span id="l12.366" class="difflineplus">+            cost01 = cost23 = cost45 = 0;</span>
<a href="#l12.367"></a><span id="l12.367" class="difflineplus">+</span>
<a href="#l12.368"></a><span id="l12.368" class="difflineplus">+#           define BZ_ITER(nn)                \</span>
<a href="#l12.369"></a><span id="l12.369" class="difflineplus">+               icv = mtfv[gs+(nn)];           \</span>
<a href="#l12.370"></a><span id="l12.370" class="difflineplus">+               cost01 += s-&gt;len_pack[icv][0]; \</span>
<a href="#l12.371"></a><span id="l12.371" class="difflineplus">+               cost23 += s-&gt;len_pack[icv][1]; \</span>
<a href="#l12.372"></a><span id="l12.372" class="difflineplus">+               cost45 += s-&gt;len_pack[icv][2]; \</span>
<a href="#l12.373"></a><span id="l12.373" class="difflineplus">+</span>
<a href="#l12.374"></a><span id="l12.374" class="difflineplus">+            BZ_ITER(0);  BZ_ITER(1);  BZ_ITER(2);  BZ_ITER(3);  BZ_ITER(4);</span>
<a href="#l12.375"></a><span id="l12.375" class="difflineplus">+            BZ_ITER(5);  BZ_ITER(6);  BZ_ITER(7);  BZ_ITER(8);  BZ_ITER(9);</span>
<a href="#l12.376"></a><span id="l12.376" class="difflineplus">+            BZ_ITER(10); BZ_ITER(11); BZ_ITER(12); BZ_ITER(13); BZ_ITER(14);</span>
<a href="#l12.377"></a><span id="l12.377" class="difflineplus">+            BZ_ITER(15); BZ_ITER(16); BZ_ITER(17); BZ_ITER(18); BZ_ITER(19);</span>
<a href="#l12.378"></a><span id="l12.378" class="difflineplus">+            BZ_ITER(20); BZ_ITER(21); BZ_ITER(22); BZ_ITER(23); BZ_ITER(24);</span>
<a href="#l12.379"></a><span id="l12.379" class="difflineplus">+            BZ_ITER(25); BZ_ITER(26); BZ_ITER(27); BZ_ITER(28); BZ_ITER(29);</span>
<a href="#l12.380"></a><span id="l12.380" class="difflineplus">+            BZ_ITER(30); BZ_ITER(31); BZ_ITER(32); BZ_ITER(33); BZ_ITER(34);</span>
<a href="#l12.381"></a><span id="l12.381" class="difflineplus">+            BZ_ITER(35); BZ_ITER(36); BZ_ITER(37); BZ_ITER(38); BZ_ITER(39);</span>
<a href="#l12.382"></a><span id="l12.382" class="difflineplus">+            BZ_ITER(40); BZ_ITER(41); BZ_ITER(42); BZ_ITER(43); BZ_ITER(44);</span>
<a href="#l12.383"></a><span id="l12.383" class="difflineplus">+            BZ_ITER(45); BZ_ITER(46); BZ_ITER(47); BZ_ITER(48); BZ_ITER(49);</span>
<a href="#l12.384"></a><span id="l12.384" class="difflineplus">+</span>
<a href="#l12.385"></a><span id="l12.385" class="difflineplus">+#           undef BZ_ITER</span>
<a href="#l12.386"></a><span id="l12.386" class="difflineplus">+</span>
<a href="#l12.387"></a><span id="l12.387" class="difflineplus">+            cost[0] = cost01 &amp; 0xffff; cost[1] = cost01 &gt;&gt; 16;</span>
<a href="#l12.388"></a><span id="l12.388" class="difflineplus">+            cost[2] = cost23 &amp; 0xffff; cost[3] = cost23 &gt;&gt; 16;</span>
<a href="#l12.389"></a><span id="l12.389" class="difflineplus">+            cost[4] = cost45 &amp; 0xffff; cost[5] = cost45 &gt;&gt; 16;</span>
<a href="#l12.390"></a><span id="l12.390" class="difflineplus">+</span>
<a href="#l12.391"></a><span id="l12.391" class="difflineplus">+         } else {</span>
<a href="#l12.392"></a><span id="l12.392" class="difflineplus">+	    /*--- slow version which correctly handles all situations ---*/</span>
<a href="#l12.393"></a><span id="l12.393" class="difflineplus">+            for (i = gs; i &lt;= ge; i++) { </span>
<a href="#l12.394"></a><span id="l12.394" class="difflineplus">+               UInt16 icv = mtfv[i];</span>
<a href="#l12.395"></a><span id="l12.395" class="difflineplus">+               for (t = 0; t &lt; nGroups; t++) cost[t] += s-&gt;len[t][icv];</span>
<a href="#l12.396"></a><span id="l12.396" class="difflineplus">+            }</span>
<a href="#l12.397"></a><span id="l12.397" class="difflineplus">+         }</span>
<a href="#l12.398"></a><span id="l12.398" class="difflineplus">+ </span>
<a href="#l12.399"></a><span id="l12.399" class="difflineplus">+         /*-- </span>
<a href="#l12.400"></a><span id="l12.400" class="difflineplus">+            Find the coding table which is best for this group,</span>
<a href="#l12.401"></a><span id="l12.401" class="difflineplus">+            and record its identity in the selector table.</span>
<a href="#l12.402"></a><span id="l12.402" class="difflineplus">+         --*/</span>
<a href="#l12.403"></a><span id="l12.403" class="difflineplus">+         bc = 999999999; bt = -1;</span>
<a href="#l12.404"></a><span id="l12.404" class="difflineplus">+         for (t = 0; t &lt; nGroups; t++)</span>
<a href="#l12.405"></a><span id="l12.405" class="difflineplus">+            if (cost[t] &lt; bc) { bc = cost[t]; bt = t; };</span>
<a href="#l12.406"></a><span id="l12.406" class="difflineplus">+         totc += bc;</span>
<a href="#l12.407"></a><span id="l12.407" class="difflineplus">+         fave[bt]++;</span>
<a href="#l12.408"></a><span id="l12.408" class="difflineplus">+         s-&gt;selector[nSelectors] = bt;</span>
<a href="#l12.409"></a><span id="l12.409" class="difflineplus">+         nSelectors++;</span>
<a href="#l12.410"></a><span id="l12.410" class="difflineplus">+</span>
<a href="#l12.411"></a><span id="l12.411" class="difflineplus">+         /*-- </span>
<a href="#l12.412"></a><span id="l12.412" class="difflineplus">+            Increment the symbol frequencies for the selected table.</span>
<a href="#l12.413"></a><span id="l12.413" class="difflineplus">+          --*/</span>
<a href="#l12.414"></a><span id="l12.414" class="difflineplus">+         if (nGroups == 6 &amp;&amp; 50 == ge-gs+1) {</span>
<a href="#l12.415"></a><span id="l12.415" class="difflineplus">+            /*--- fast track the common case ---*/</span>
<a href="#l12.416"></a><span id="l12.416" class="difflineplus">+</span>
<a href="#l12.417"></a><span id="l12.417" class="difflineplus">+#           define BZ_ITUR(nn) s-&gt;rfreq[bt][ mtfv[gs+(nn)] ]++</span>
<a href="#l12.418"></a><span id="l12.418" class="difflineplus">+</span>
<a href="#l12.419"></a><span id="l12.419" class="difflineplus">+            BZ_ITUR(0);  BZ_ITUR(1);  BZ_ITUR(2);  BZ_ITUR(3);  BZ_ITUR(4);</span>
<a href="#l12.420"></a><span id="l12.420" class="difflineplus">+            BZ_ITUR(5);  BZ_ITUR(6);  BZ_ITUR(7);  BZ_ITUR(8);  BZ_ITUR(9);</span>
<a href="#l12.421"></a><span id="l12.421" class="difflineplus">+            BZ_ITUR(10); BZ_ITUR(11); BZ_ITUR(12); BZ_ITUR(13); BZ_ITUR(14);</span>
<a href="#l12.422"></a><span id="l12.422" class="difflineplus">+            BZ_ITUR(15); BZ_ITUR(16); BZ_ITUR(17); BZ_ITUR(18); BZ_ITUR(19);</span>
<a href="#l12.423"></a><span id="l12.423" class="difflineplus">+            BZ_ITUR(20); BZ_ITUR(21); BZ_ITUR(22); BZ_ITUR(23); BZ_ITUR(24);</span>
<a href="#l12.424"></a><span id="l12.424" class="difflineplus">+            BZ_ITUR(25); BZ_ITUR(26); BZ_ITUR(27); BZ_ITUR(28); BZ_ITUR(29);</span>
<a href="#l12.425"></a><span id="l12.425" class="difflineplus">+            BZ_ITUR(30); BZ_ITUR(31); BZ_ITUR(32); BZ_ITUR(33); BZ_ITUR(34);</span>
<a href="#l12.426"></a><span id="l12.426" class="difflineplus">+            BZ_ITUR(35); BZ_ITUR(36); BZ_ITUR(37); BZ_ITUR(38); BZ_ITUR(39);</span>
<a href="#l12.427"></a><span id="l12.427" class="difflineplus">+            BZ_ITUR(40); BZ_ITUR(41); BZ_ITUR(42); BZ_ITUR(43); BZ_ITUR(44);</span>
<a href="#l12.428"></a><span id="l12.428" class="difflineplus">+            BZ_ITUR(45); BZ_ITUR(46); BZ_ITUR(47); BZ_ITUR(48); BZ_ITUR(49);</span>
<a href="#l12.429"></a><span id="l12.429" class="difflineplus">+</span>
<a href="#l12.430"></a><span id="l12.430" class="difflineplus">+#           undef BZ_ITUR</span>
<a href="#l12.431"></a><span id="l12.431" class="difflineplus">+</span>
<a href="#l12.432"></a><span id="l12.432" class="difflineplus">+         } else {</span>
<a href="#l12.433"></a><span id="l12.433" class="difflineplus">+	    /*--- slow version which correctly handles all situations ---*/</span>
<a href="#l12.434"></a><span id="l12.434" class="difflineplus">+            for (i = gs; i &lt;= ge; i++)</span>
<a href="#l12.435"></a><span id="l12.435" class="difflineplus">+               s-&gt;rfreq[bt][ mtfv[i] ]++;</span>
<a href="#l12.436"></a><span id="l12.436" class="difflineplus">+         }</span>
<a href="#l12.437"></a><span id="l12.437" class="difflineplus">+</span>
<a href="#l12.438"></a><span id="l12.438" class="difflineplus">+         gs = ge+1;</span>
<a href="#l12.439"></a><span id="l12.439" class="difflineplus">+      }</span>
<a href="#l12.440"></a><span id="l12.440" class="difflineplus">+      if (s-&gt;verbosity &gt;= 3) {</span>
<a href="#l12.441"></a><span id="l12.441" class="difflineplus">+         VPrintf2 ( &quot;      pass %d: size is %d, grp uses are &quot;, </span>
<a href="#l12.442"></a><span id="l12.442" class="difflineplus">+                   iter+1, totc/8 );</span>
<a href="#l12.443"></a><span id="l12.443" class="difflineplus">+         for (t = 0; t &lt; nGroups; t++)</span>
<a href="#l12.444"></a><span id="l12.444" class="difflineplus">+            VPrintf1 ( &quot;%d &quot;, fave[t] );</span>
<a href="#l12.445"></a><span id="l12.445" class="difflineplus">+         VPrintf0 ( &quot;\n&quot; );</span>
<a href="#l12.446"></a><span id="l12.446" class="difflineplus">+      }</span>
<a href="#l12.447"></a><span id="l12.447" class="difflineplus">+</span>
<a href="#l12.448"></a><span id="l12.448" class="difflineplus">+      /*--</span>
<a href="#l12.449"></a><span id="l12.449" class="difflineplus">+        Recompute the tables based on the accumulated frequencies.</span>
<a href="#l12.450"></a><span id="l12.450" class="difflineplus">+      --*/</span>
<a href="#l12.451"></a><span id="l12.451" class="difflineplus">+      /* maxLen was changed from 20 to 17 in bzip2-1.0.3.  See </span>
<a href="#l12.452"></a><span id="l12.452" class="difflineplus">+         comment in huffman.c for details. */</span>
<a href="#l12.453"></a><span id="l12.453" class="difflineplus">+      for (t = 0; t &lt; nGroups; t++)</span>
<a href="#l12.454"></a><span id="l12.454" class="difflineplus">+         BZ2_hbMakeCodeLengths ( &amp;(s-&gt;len[t][0]), &amp;(s-&gt;rfreq[t][0]), </span>
<a href="#l12.455"></a><span id="l12.455" class="difflineplus">+                                 alphaSize, 17 /*20*/ );</span>
<a href="#l12.456"></a><span id="l12.456" class="difflineplus">+   }</span>
<a href="#l12.457"></a><span id="l12.457" class="difflineplus">+</span>
<a href="#l12.458"></a><span id="l12.458" class="difflineplus">+</span>
<a href="#l12.459"></a><span id="l12.459" class="difflineplus">+   AssertH( nGroups &lt; 8, 3002 );</span>
<a href="#l12.460"></a><span id="l12.460" class="difflineplus">+   AssertH( nSelectors &lt; 32768 &amp;&amp;</span>
<a href="#l12.461"></a><span id="l12.461" class="difflineplus">+            nSelectors &lt;= BZ_MAX_SELECTORS,</span>
<a href="#l12.462"></a><span id="l12.462" class="difflineplus">+            3003 );</span>
<a href="#l12.463"></a><span id="l12.463" class="difflineplus">+</span>
<a href="#l12.464"></a><span id="l12.464" class="difflineplus">+</span>
<a href="#l12.465"></a><span id="l12.465" class="difflineplus">+   /*--- Compute MTF values for the selectors. ---*/</span>
<a href="#l12.466"></a><span id="l12.466" class="difflineplus">+   {</span>
<a href="#l12.467"></a><span id="l12.467" class="difflineplus">+      UChar pos[BZ_N_GROUPS], ll_i, tmp2, tmp;</span>
<a href="#l12.468"></a><span id="l12.468" class="difflineplus">+      for (i = 0; i &lt; nGroups; i++) pos[i] = i;</span>
<a href="#l12.469"></a><span id="l12.469" class="difflineplus">+      for (i = 0; i &lt; nSelectors; i++) {</span>
<a href="#l12.470"></a><span id="l12.470" class="difflineplus">+         ll_i = s-&gt;selector[i];</span>
<a href="#l12.471"></a><span id="l12.471" class="difflineplus">+         j = 0;</span>
<a href="#l12.472"></a><span id="l12.472" class="difflineplus">+         tmp = pos[j];</span>
<a href="#l12.473"></a><span id="l12.473" class="difflineplus">+         while ( ll_i != tmp ) {</span>
<a href="#l12.474"></a><span id="l12.474" class="difflineplus">+            j++;</span>
<a href="#l12.475"></a><span id="l12.475" class="difflineplus">+            tmp2 = tmp;</span>
<a href="#l12.476"></a><span id="l12.476" class="difflineplus">+            tmp = pos[j];</span>
<a href="#l12.477"></a><span id="l12.477" class="difflineplus">+            pos[j] = tmp2;</span>
<a href="#l12.478"></a><span id="l12.478" class="difflineplus">+         };</span>
<a href="#l12.479"></a><span id="l12.479" class="difflineplus">+         pos[0] = tmp;</span>
<a href="#l12.480"></a><span id="l12.480" class="difflineplus">+         s-&gt;selectorMtf[i] = j;</span>
<a href="#l12.481"></a><span id="l12.481" class="difflineplus">+      }</span>
<a href="#l12.482"></a><span id="l12.482" class="difflineplus">+   };</span>
<a href="#l12.483"></a><span id="l12.483" class="difflineplus">+</span>
<a href="#l12.484"></a><span id="l12.484" class="difflineplus">+   /*--- Assign actual codes for the tables. --*/</span>
<a href="#l12.485"></a><span id="l12.485" class="difflineplus">+   for (t = 0; t &lt; nGroups; t++) {</span>
<a href="#l12.486"></a><span id="l12.486" class="difflineplus">+      minLen = 32;</span>
<a href="#l12.487"></a><span id="l12.487" class="difflineplus">+      maxLen = 0;</span>
<a href="#l12.488"></a><span id="l12.488" class="difflineplus">+      for (i = 0; i &lt; alphaSize; i++) {</span>
<a href="#l12.489"></a><span id="l12.489" class="difflineplus">+         if (s-&gt;len[t][i] &gt; maxLen) maxLen = s-&gt;len[t][i];</span>
<a href="#l12.490"></a><span id="l12.490" class="difflineplus">+         if (s-&gt;len[t][i] &lt; minLen) minLen = s-&gt;len[t][i];</span>
<a href="#l12.491"></a><span id="l12.491" class="difflineplus">+      }</span>
<a href="#l12.492"></a><span id="l12.492" class="difflineplus">+      AssertH ( !(maxLen &gt; 17 /*20*/ ), 3004 );</span>
<a href="#l12.493"></a><span id="l12.493" class="difflineplus">+      AssertH ( !(minLen &lt; 1),  3005 );</span>
<a href="#l12.494"></a><span id="l12.494" class="difflineplus">+      BZ2_hbAssignCodes ( &amp;(s-&gt;code[t][0]), &amp;(s-&gt;len[t][0]), </span>
<a href="#l12.495"></a><span id="l12.495" class="difflineplus">+                          minLen, maxLen, alphaSize );</span>
<a href="#l12.496"></a><span id="l12.496" class="difflineplus">+   }</span>
<a href="#l12.497"></a><span id="l12.497" class="difflineplus">+</span>
<a href="#l12.498"></a><span id="l12.498" class="difflineplus">+   /*--- Transmit the mapping table. ---*/</span>
<a href="#l12.499"></a><span id="l12.499" class="difflineplus">+   { </span>
<a href="#l12.500"></a><span id="l12.500" class="difflineplus">+      Bool inUse16[16];</span>
<a href="#l12.501"></a><span id="l12.501" class="difflineplus">+      for (i = 0; i &lt; 16; i++) {</span>
<a href="#l12.502"></a><span id="l12.502" class="difflineplus">+          inUse16[i] = False;</span>
<a href="#l12.503"></a><span id="l12.503" class="difflineplus">+          for (j = 0; j &lt; 16; j++)</span>
<a href="#l12.504"></a><span id="l12.504" class="difflineplus">+             if (s-&gt;inUse[i * 16 + j]) inUse16[i] = True;</span>
<a href="#l12.505"></a><span id="l12.505" class="difflineplus">+      }</span>
<a href="#l12.506"></a><span id="l12.506" class="difflineplus">+     </span>
<a href="#l12.507"></a><span id="l12.507" class="difflineplus">+      nBytes = s-&gt;numZ;</span>
<a href="#l12.508"></a><span id="l12.508" class="difflineplus">+      for (i = 0; i &lt; 16; i++)</span>
<a href="#l12.509"></a><span id="l12.509" class="difflineplus">+         if (inUse16[i]) bsW(s,1,1); else bsW(s,1,0);</span>
<a href="#l12.510"></a><span id="l12.510" class="difflineplus">+</span>
<a href="#l12.511"></a><span id="l12.511" class="difflineplus">+      for (i = 0; i &lt; 16; i++)</span>
<a href="#l12.512"></a><span id="l12.512" class="difflineplus">+         if (inUse16[i])</span>
<a href="#l12.513"></a><span id="l12.513" class="difflineplus">+            for (j = 0; j &lt; 16; j++) {</span>
<a href="#l12.514"></a><span id="l12.514" class="difflineplus">+               if (s-&gt;inUse[i * 16 + j]) bsW(s,1,1); else bsW(s,1,0);</span>
<a href="#l12.515"></a><span id="l12.515" class="difflineplus">+            }</span>
<a href="#l12.516"></a><span id="l12.516" class="difflineplus">+</span>
<a href="#l12.517"></a><span id="l12.517" class="difflineplus">+      if (s-&gt;verbosity &gt;= 3) </span>
<a href="#l12.518"></a><span id="l12.518" class="difflineplus">+         VPrintf1( &quot;      bytes: mapping %d, &quot;, s-&gt;numZ-nBytes );</span>
<a href="#l12.519"></a><span id="l12.519" class="difflineplus">+   }</span>
<a href="#l12.520"></a><span id="l12.520" class="difflineplus">+</span>
<a href="#l12.521"></a><span id="l12.521" class="difflineplus">+   /*--- Now the selectors. ---*/</span>
<a href="#l12.522"></a><span id="l12.522" class="difflineplus">+   nBytes = s-&gt;numZ;</span>
<a href="#l12.523"></a><span id="l12.523" class="difflineplus">+   bsW ( s, 3, nGroups );</span>
<a href="#l12.524"></a><span id="l12.524" class="difflineplus">+   bsW ( s, 15, nSelectors );</span>
<a href="#l12.525"></a><span id="l12.525" class="difflineplus">+   for (i = 0; i &lt; nSelectors; i++) { </span>
<a href="#l12.526"></a><span id="l12.526" class="difflineplus">+      for (j = 0; j &lt; s-&gt;selectorMtf[i]; j++) bsW(s,1,1);</span>
<a href="#l12.527"></a><span id="l12.527" class="difflineplus">+      bsW(s,1,0);</span>
<a href="#l12.528"></a><span id="l12.528" class="difflineplus">+   }</span>
<a href="#l12.529"></a><span id="l12.529" class="difflineplus">+   if (s-&gt;verbosity &gt;= 3)</span>
<a href="#l12.530"></a><span id="l12.530" class="difflineplus">+      VPrintf1( &quot;selectors %d, &quot;, s-&gt;numZ-nBytes );</span>
<a href="#l12.531"></a><span id="l12.531" class="difflineplus">+</span>
<a href="#l12.532"></a><span id="l12.532" class="difflineplus">+   /*--- Now the coding tables. ---*/</span>
<a href="#l12.533"></a><span id="l12.533" class="difflineplus">+   nBytes = s-&gt;numZ;</span>
<a href="#l12.534"></a><span id="l12.534" class="difflineplus">+</span>
<a href="#l12.535"></a><span id="l12.535" class="difflineplus">+   for (t = 0; t &lt; nGroups; t++) {</span>
<a href="#l12.536"></a><span id="l12.536" class="difflineplus">+      Int32 curr = s-&gt;len[t][0];</span>
<a href="#l12.537"></a><span id="l12.537" class="difflineplus">+      bsW ( s, 5, curr );</span>
<a href="#l12.538"></a><span id="l12.538" class="difflineplus">+      for (i = 0; i &lt; alphaSize; i++) {</span>
<a href="#l12.539"></a><span id="l12.539" class="difflineplus">+         while (curr &lt; s-&gt;len[t][i]) { bsW(s,2,2); curr++; /* 10 */ };</span>
<a href="#l12.540"></a><span id="l12.540" class="difflineplus">+         while (curr &gt; s-&gt;len[t][i]) { bsW(s,2,3); curr--; /* 11 */ };</span>
<a href="#l12.541"></a><span id="l12.541" class="difflineplus">+         bsW ( s, 1, 0 );</span>
<a href="#l12.542"></a><span id="l12.542" class="difflineplus">+      }</span>
<a href="#l12.543"></a><span id="l12.543" class="difflineplus">+   }</span>
<a href="#l12.544"></a><span id="l12.544" class="difflineplus">+</span>
<a href="#l12.545"></a><span id="l12.545" class="difflineplus">+   if (s-&gt;verbosity &gt;= 3)</span>
<a href="#l12.546"></a><span id="l12.546" class="difflineplus">+      VPrintf1 ( &quot;code lengths %d, &quot;, s-&gt;numZ-nBytes );</span>
<a href="#l12.547"></a><span id="l12.547" class="difflineplus">+</span>
<a href="#l12.548"></a><span id="l12.548" class="difflineplus">+   /*--- And finally, the block data proper ---*/</span>
<a href="#l12.549"></a><span id="l12.549" class="difflineplus">+   nBytes = s-&gt;numZ;</span>
<a href="#l12.550"></a><span id="l12.550" class="difflineplus">+   selCtr = 0;</span>
<a href="#l12.551"></a><span id="l12.551" class="difflineplus">+   gs = 0;</span>
<a href="#l12.552"></a><span id="l12.552" class="difflineplus">+   while (True) {</span>
<a href="#l12.553"></a><span id="l12.553" class="difflineplus">+      if (gs &gt;= s-&gt;nMTF) break;</span>
<a href="#l12.554"></a><span id="l12.554" class="difflineplus">+      ge = gs + BZ_G_SIZE - 1; </span>
<a href="#l12.555"></a><span id="l12.555" class="difflineplus">+      if (ge &gt;= s-&gt;nMTF) ge = s-&gt;nMTF-1;</span>
<a href="#l12.556"></a><span id="l12.556" class="difflineplus">+      AssertH ( s-&gt;selector[selCtr] &lt; nGroups, 3006 );</span>
<a href="#l12.557"></a><span id="l12.557" class="difflineplus">+</span>
<a href="#l12.558"></a><span id="l12.558" class="difflineplus">+      if (nGroups == 6 &amp;&amp; 50 == ge-gs+1) {</span>
<a href="#l12.559"></a><span id="l12.559" class="difflineplus">+            /*--- fast track the common case ---*/</span>
<a href="#l12.560"></a><span id="l12.560" class="difflineplus">+            UInt16 mtfv_i;</span>
<a href="#l12.561"></a><span id="l12.561" class="difflineplus">+            UChar* s_len_sel_selCtr </span>
<a href="#l12.562"></a><span id="l12.562" class="difflineplus">+               = &amp;(s-&gt;len[s-&gt;selector[selCtr]][0]);</span>
<a href="#l12.563"></a><span id="l12.563" class="difflineplus">+            Int32* s_code_sel_selCtr</span>
<a href="#l12.564"></a><span id="l12.564" class="difflineplus">+               = &amp;(s-&gt;code[s-&gt;selector[selCtr]][0]);</span>
<a href="#l12.565"></a><span id="l12.565" class="difflineplus">+</span>
<a href="#l12.566"></a><span id="l12.566" class="difflineplus">+#           define BZ_ITAH(nn)                      \</span>
<a href="#l12.567"></a><span id="l12.567" class="difflineplus">+               mtfv_i = mtfv[gs+(nn)];              \</span>
<a href="#l12.568"></a><span id="l12.568" class="difflineplus">+               bsW ( s,                             \</span>
<a href="#l12.569"></a><span id="l12.569" class="difflineplus">+                     s_len_sel_selCtr[mtfv_i],      \</span>
<a href="#l12.570"></a><span id="l12.570" class="difflineplus">+                     s_code_sel_selCtr[mtfv_i] )</span>
<a href="#l12.571"></a><span id="l12.571" class="difflineplus">+</span>
<a href="#l12.572"></a><span id="l12.572" class="difflineplus">+            BZ_ITAH(0);  BZ_ITAH(1);  BZ_ITAH(2);  BZ_ITAH(3);  BZ_ITAH(4);</span>
<a href="#l12.573"></a><span id="l12.573" class="difflineplus">+            BZ_ITAH(5);  BZ_ITAH(6);  BZ_ITAH(7);  BZ_ITAH(8);  BZ_ITAH(9);</span>
<a href="#l12.574"></a><span id="l12.574" class="difflineplus">+            BZ_ITAH(10); BZ_ITAH(11); BZ_ITAH(12); BZ_ITAH(13); BZ_ITAH(14);</span>
<a href="#l12.575"></a><span id="l12.575" class="difflineplus">+            BZ_ITAH(15); BZ_ITAH(16); BZ_ITAH(17); BZ_ITAH(18); BZ_ITAH(19);</span>
<a href="#l12.576"></a><span id="l12.576" class="difflineplus">+            BZ_ITAH(20); BZ_ITAH(21); BZ_ITAH(22); BZ_ITAH(23); BZ_ITAH(24);</span>
<a href="#l12.577"></a><span id="l12.577" class="difflineplus">+            BZ_ITAH(25); BZ_ITAH(26); BZ_ITAH(27); BZ_ITAH(28); BZ_ITAH(29);</span>
<a href="#l12.578"></a><span id="l12.578" class="difflineplus">+            BZ_ITAH(30); BZ_ITAH(31); BZ_ITAH(32); BZ_ITAH(33); BZ_ITAH(34);</span>
<a href="#l12.579"></a><span id="l12.579" class="difflineplus">+            BZ_ITAH(35); BZ_ITAH(36); BZ_ITAH(37); BZ_ITAH(38); BZ_ITAH(39);</span>
<a href="#l12.580"></a><span id="l12.580" class="difflineplus">+            BZ_ITAH(40); BZ_ITAH(41); BZ_ITAH(42); BZ_ITAH(43); BZ_ITAH(44);</span>
<a href="#l12.581"></a><span id="l12.581" class="difflineplus">+            BZ_ITAH(45); BZ_ITAH(46); BZ_ITAH(47); BZ_ITAH(48); BZ_ITAH(49);</span>
<a href="#l12.582"></a><span id="l12.582" class="difflineplus">+</span>
<a href="#l12.583"></a><span id="l12.583" class="difflineplus">+#           undef BZ_ITAH</span>
<a href="#l12.584"></a><span id="l12.584" class="difflineplus">+</span>
<a href="#l12.585"></a><span id="l12.585" class="difflineplus">+      } else {</span>
<a href="#l12.586"></a><span id="l12.586" class="difflineplus">+	 /*--- slow version which correctly handles all situations ---*/</span>
<a href="#l12.587"></a><span id="l12.587" class="difflineplus">+         for (i = gs; i &lt;= ge; i++) {</span>
<a href="#l12.588"></a><span id="l12.588" class="difflineplus">+            bsW ( s, </span>
<a href="#l12.589"></a><span id="l12.589" class="difflineplus">+                  s-&gt;len  [s-&gt;selector[selCtr]] [mtfv[i]],</span>
<a href="#l12.590"></a><span id="l12.590" class="difflineplus">+                  s-&gt;code [s-&gt;selector[selCtr]] [mtfv[i]] );</span>
<a href="#l12.591"></a><span id="l12.591" class="difflineplus">+         }</span>
<a href="#l12.592"></a><span id="l12.592" class="difflineplus">+      }</span>
<a href="#l12.593"></a><span id="l12.593" class="difflineplus">+</span>
<a href="#l12.594"></a><span id="l12.594" class="difflineplus">+</span>
<a href="#l12.595"></a><span id="l12.595" class="difflineplus">+      gs = ge+1;</span>
<a href="#l12.596"></a><span id="l12.596" class="difflineplus">+      selCtr++;</span>
<a href="#l12.597"></a><span id="l12.597" class="difflineplus">+   }</span>
<a href="#l12.598"></a><span id="l12.598" class="difflineplus">+   AssertH( selCtr == nSelectors, 3007 );</span>
<a href="#l12.599"></a><span id="l12.599" class="difflineplus">+</span>
<a href="#l12.600"></a><span id="l12.600" class="difflineplus">+   if (s-&gt;verbosity &gt;= 3)</span>
<a href="#l12.601"></a><span id="l12.601" class="difflineplus">+      VPrintf1( &quot;codes %d\n&quot;, s-&gt;numZ-nBytes );</span>
<a href="#l12.602"></a><span id="l12.602" class="difflineplus">+}</span>
<a href="#l12.603"></a><span id="l12.603" class="difflineplus">+</span>
<a href="#l12.604"></a><span id="l12.604" class="difflineplus">+</span>
<a href="#l12.605"></a><span id="l12.605" class="difflineplus">+/*---------------------------------------------------*/</span>
<a href="#l12.606"></a><span id="l12.606" class="difflineplus">+void BZ2_compressBlock ( EState* s, Bool is_last_block )</span>
<a href="#l12.607"></a><span id="l12.607" class="difflineplus">+{</span>
<a href="#l12.608"></a><span id="l12.608" class="difflineplus">+   if (s-&gt;nblock &gt; 0) {</span>
<a href="#l12.609"></a><span id="l12.609" class="difflineplus">+</span>
<a href="#l12.610"></a><span id="l12.610" class="difflineplus">+      BZ_FINALISE_CRC ( s-&gt;blockCRC );</span>
<a href="#l12.611"></a><span id="l12.611" class="difflineplus">+      s-&gt;combinedCRC = (s-&gt;combinedCRC &lt;&lt; 1) | (s-&gt;combinedCRC &gt;&gt; 31);</span>
<a href="#l12.612"></a><span id="l12.612" class="difflineplus">+      s-&gt;combinedCRC ^= s-&gt;blockCRC;</span>
<a href="#l12.613"></a><span id="l12.613" class="difflineplus">+      if (s-&gt;blockNo &gt; 1) s-&gt;numZ = 0;</span>
<a href="#l12.614"></a><span id="l12.614" class="difflineplus">+</span>
<a href="#l12.615"></a><span id="l12.615" class="difflineplus">+      if (s-&gt;verbosity &gt;= 2)</span>
<a href="#l12.616"></a><span id="l12.616" class="difflineplus">+         VPrintf4( &quot;    block %d: crc = 0x%08x, &quot;</span>
<a href="#l12.617"></a><span id="l12.617" class="difflineplus">+                   &quot;combined CRC = 0x%08x, size = %d\n&quot;,</span>
<a href="#l12.618"></a><span id="l12.618" class="difflineplus">+                   s-&gt;blockNo, s-&gt;blockCRC, s-&gt;combinedCRC, s-&gt;nblock );</span>
<a href="#l12.619"></a><span id="l12.619" class="difflineplus">+</span>
<a href="#l12.620"></a><span id="l12.620" class="difflineplus">+      BZ2_blockSort ( s );</span>
<a href="#l12.621"></a><span id="l12.621" class="difflineplus">+   }</span>
<a href="#l12.622"></a><span id="l12.622" class="difflineplus">+</span>
<a href="#l12.623"></a><span id="l12.623" class="difflineplus">+   s-&gt;zbits = (UChar*) (&amp;((UChar*)s-&gt;arr2)[s-&gt;nblock]);</span>
<a href="#l12.624"></a><span id="l12.624" class="difflineplus">+</span>
<a href="#l12.625"></a><span id="l12.625" class="difflineplus">+   /*-- If this is the first block, create the stream header. --*/</span>
<a href="#l12.626"></a><span id="l12.626" class="difflineplus">+   if (s-&gt;blockNo == 1) {</span>
<a href="#l12.627"></a><span id="l12.627" class="difflineplus">+      BZ2_bsInitWrite ( s );</span>
<a href="#l12.628"></a><span id="l12.628" class="difflineplus">+      bsPutUChar ( s, BZ_HDR_B );</span>
<a href="#l12.629"></a><span id="l12.629" class="difflineplus">+      bsPutUChar ( s, BZ_HDR_Z );</span>
<a href="#l12.630"></a><span id="l12.630" class="difflineplus">+      bsPutUChar ( s, BZ_HDR_h );</span>
<a href="#l12.631"></a><span id="l12.631" class="difflineplus">+      bsPutUChar ( s, (UChar)(BZ_HDR_0 + s-&gt;blockSize100k) );</span>
<a href="#l12.632"></a><span id="l12.632" class="difflineplus">+   }</span>
<a href="#l12.633"></a><span id="l12.633" class="difflineplus">+</span>
<a href="#l12.634"></a><span id="l12.634" class="difflineplus">+   if (s-&gt;nblock &gt; 0) {</span>
<a href="#l12.635"></a><span id="l12.635" class="difflineplus">+</span>
<a href="#l12.636"></a><span id="l12.636" class="difflineplus">+      bsPutUChar ( s, 0x31 ); bsPutUChar ( s, 0x41 );</span>
<a href="#l12.637"></a><span id="l12.637" class="difflineplus">+      bsPutUChar ( s, 0x59 ); bsPutUChar ( s, 0x26 );</span>
<a href="#l12.638"></a><span id="l12.638" class="difflineplus">+      bsPutUChar ( s, 0x53 ); bsPutUChar ( s, 0x59 );</span>
<a href="#l12.639"></a><span id="l12.639" class="difflineplus">+</span>
<a href="#l12.640"></a><span id="l12.640" class="difflineplus">+      /*-- Now the block's CRC, so it is in a known place. --*/</span>
<a href="#l12.641"></a><span id="l12.641" class="difflineplus">+      bsPutUInt32 ( s, s-&gt;blockCRC );</span>
<a href="#l12.642"></a><span id="l12.642" class="difflineplus">+</span>
<a href="#l12.643"></a><span id="l12.643" class="difflineplus">+      /*-- </span>
<a href="#l12.644"></a><span id="l12.644" class="difflineplus">+         Now a single bit indicating (non-)randomisation. </span>
<a href="#l12.645"></a><span id="l12.645" class="difflineplus">+         As of version 0.9.5, we use a better sorting algorithm</span>
<a href="#l12.646"></a><span id="l12.646" class="difflineplus">+         which makes randomisation unnecessary.  So always set</span>
<a href="#l12.647"></a><span id="l12.647" class="difflineplus">+         the randomised bit to 'no'.  Of course, the decoder</span>
<a href="#l12.648"></a><span id="l12.648" class="difflineplus">+         still needs to be able to handle randomised blocks</span>
<a href="#l12.649"></a><span id="l12.649" class="difflineplus">+         so as to maintain backwards compatibility with</span>
<a href="#l12.650"></a><span id="l12.650" class="difflineplus">+         older versions of bzip2.</span>
<a href="#l12.651"></a><span id="l12.651" class="difflineplus">+      --*/</span>
<a href="#l12.652"></a><span id="l12.652" class="difflineplus">+      bsW(s,1,0);</span>
<a href="#l12.653"></a><span id="l12.653" class="difflineplus">+</span>
<a href="#l12.654"></a><span id="l12.654" class="difflineplus">+      bsW ( s, 24, s-&gt;origPtr );</span>
<a href="#l12.655"></a><span id="l12.655" class="difflineplus">+      generateMTFValues ( s );</span>
<a href="#l12.656"></a><span id="l12.656" class="difflineplus">+      sendMTFValues ( s );</span>
<a href="#l12.657"></a><span id="l12.657" class="difflineplus">+   }</span>
<a href="#l12.658"></a><span id="l12.658" class="difflineplus">+</span>
<a href="#l12.659"></a><span id="l12.659" class="difflineplus">+</span>
<a href="#l12.660"></a><span id="l12.660" class="difflineplus">+   /*-- If this is the last block, add the stream trailer. --*/</span>
<a href="#l12.661"></a><span id="l12.661" class="difflineplus">+   if (is_last_block) {</span>
<a href="#l12.662"></a><span id="l12.662" class="difflineplus">+</span>
<a href="#l12.663"></a><span id="l12.663" class="difflineplus">+      bsPutUChar ( s, 0x17 ); bsPutUChar ( s, 0x72 );</span>
<a href="#l12.664"></a><span id="l12.664" class="difflineplus">+      bsPutUChar ( s, 0x45 ); bsPutUChar ( s, 0x38 );</span>
<a href="#l12.665"></a><span id="l12.665" class="difflineplus">+      bsPutUChar ( s, 0x50 ); bsPutUChar ( s, 0x90 );</span>
<a href="#l12.666"></a><span id="l12.666" class="difflineplus">+      bsPutUInt32 ( s, s-&gt;combinedCRC );</span>
<a href="#l12.667"></a><span id="l12.667" class="difflineplus">+      if (s-&gt;verbosity &gt;= 2)</span>
<a href="#l12.668"></a><span id="l12.668" class="difflineplus">+         VPrintf1( &quot;    final combined CRC = 0x%08x\n   &quot;, s-&gt;combinedCRC );</span>
<a href="#l12.669"></a><span id="l12.669" class="difflineplus">+      bsFinishWrite ( s );</span>
<a href="#l12.670"></a><span id="l12.670" class="difflineplus">+   }</span>
<a href="#l12.671"></a><span id="l12.671" class="difflineplus">+}</span>
<a href="#l12.672"></a><span id="l12.672" class="difflineplus">+</span>
<a href="#l12.673"></a><span id="l12.673" class="difflineplus">+</span>
<a href="#l12.674"></a><span id="l12.674" class="difflineplus">+/*-------------------------------------------------------------*/</span>
<a href="#l12.675"></a><span id="l12.675" class="difflineplus">+/*--- end                                        compress.c ---*/</span>
<a href="#l12.676"></a><span id="l12.676" class="difflineplus">+/*-------------------------------------------------------------*/</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1">new file mode 100644</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineminus">--- /dev/null</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineplus">+++ b/third_party/bzip2/crctable.c</span>
<a href="#l13.4"></a><span id="l13.4" class="difflineat">@@ -0,0 +1,104 @@</span>
<a href="#l13.5"></a><span id="l13.5" class="difflineplus">+</span>
<a href="#l13.6"></a><span id="l13.6" class="difflineplus">+/*-------------------------------------------------------------*/</span>
<a href="#l13.7"></a><span id="l13.7" class="difflineplus">+/*--- Table for doing CRCs                                  ---*/</span>
<a href="#l13.8"></a><span id="l13.8" class="difflineplus">+/*---                                            crctable.c ---*/</span>
<a href="#l13.9"></a><span id="l13.9" class="difflineplus">+/*-------------------------------------------------------------*/</span>
<a href="#l13.10"></a><span id="l13.10" class="difflineplus">+</span>
<a href="#l13.11"></a><span id="l13.11" class="difflineplus">+/* ------------------------------------------------------------------</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+   This file is part of bzip2/libbzip2, a program and library for</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+   lossless, block-sorting data compression.</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineplus">+</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineplus">+   bzip2/libbzip2 version 1.0.8 of 13 July 2019</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineplus">+   Copyright (C) 1996-2019 Julian Seward &lt;jseward@acm.org&gt;</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineplus">+</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineplus">+   Please read the WARNING, DISCLAIMER and PATENTS sections in the </span>
<a href="#l13.19"></a><span id="l13.19" class="difflineplus">+   README file.</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineplus">+</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineplus">+   This program is released under the terms of the license contained</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineplus">+   in the file LICENSE.</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineplus">+   ------------------------------------------------------------------ */</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineplus">+</span>
<a href="#l13.25"></a><span id="l13.25" class="difflineplus">+</span>
<a href="#l13.26"></a><span id="l13.26" class="difflineplus">+#include &quot;bzlib_private.h&quot;</span>
<a href="#l13.27"></a><span id="l13.27" class="difflineplus">+</span>
<a href="#l13.28"></a><span id="l13.28" class="difflineplus">+/*--</span>
<a href="#l13.29"></a><span id="l13.29" class="difflineplus">+  I think this is an implementation of the AUTODIN-II,</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineplus">+  Ethernet &amp; FDDI 32-bit CRC standard.  Vaguely derived</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineplus">+  from code by Rob Warnock, in Section 51 of the</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineplus">+  comp.compression FAQ.</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineplus">+--*/</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineplus">+</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineplus">+UInt32 BZ2_crc32Table[256] = {</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineplus">+</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineplus">+   /*-- Ugly, innit? --*/</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineplus">+</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineplus">+   0x00000000L, 0x04c11db7L, 0x09823b6eL, 0x0d4326d9L,</span>
<a href="#l13.40"></a><span id="l13.40" class="difflineplus">+   0x130476dcL, 0x17c56b6bL, 0x1a864db2L, 0x1e475005L,</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineplus">+   0x2608edb8L, 0x22c9f00fL, 0x2f8ad6d6L, 0x2b4bcb61L,</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineplus">+   0x350c9b64L, 0x31cd86d3L, 0x3c8ea00aL, 0x384fbdbdL,</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineplus">+   0x4c11db70L, 0x48d0c6c7L, 0x4593e01eL, 0x4152fda9L,</span>
<a href="#l13.44"></a><span id="l13.44" class="difflineplus">+   0x5f15adacL, 0x5bd4b01bL, 0x569796c2L, 0x52568b75L,</span>
<a href="#l13.45"></a><span id="l13.45" class="difflineplus">+   0x6a1936c8L, 0x6ed82b7fL, 0x639b0da6L, 0x675a1011L,</span>
<a href="#l13.46"></a><span id="l13.46" class="difflineplus">+   0x791d4014L, 0x7ddc5da3L, 0x709f7b7aL, 0x745e66cdL,</span>
<a href="#l13.47"></a><span id="l13.47" class="difflineplus">+   0x9823b6e0L, 0x9ce2ab57L, 0x91a18d8eL, 0x95609039L,</span>
<a href="#l13.48"></a><span id="l13.48" class="difflineplus">+   0x8b27c03cL, 0x8fe6dd8bL, 0x82a5fb52L, 0x8664e6e5L,</span>
<a href="#l13.49"></a><span id="l13.49" class="difflineplus">+   0xbe2b5b58L, 0xbaea46efL, 0xb7a96036L, 0xb3687d81L,</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineplus">+   0xad2f2d84L, 0xa9ee3033L, 0xa4ad16eaL, 0xa06c0b5dL,</span>
<a href="#l13.51"></a><span id="l13.51" class="difflineplus">+   0xd4326d90L, 0xd0f37027L, 0xddb056feL, 0xd9714b49L,</span>
<a href="#l13.52"></a><span id="l13.52" class="difflineplus">+   0xc7361b4cL, 0xc3f706fbL, 0xceb42022L, 0xca753d95L,</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineplus">+   0xf23a8028L, 0xf6fb9d9fL, 0xfbb8bb46L, 0xff79a6f1L,</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineplus">+   0xe13ef6f4L, 0xe5ffeb43L, 0xe8bccd9aL, 0xec7dd02dL,</span>
<a href="#l13.55"></a><span id="l13.55" class="difflineplus">+   0x34867077L, 0x30476dc0L, 0x3d044b19L, 0x39c556aeL,</span>
<a href="#l13.56"></a><span id="l13.56" class="difflineplus">+   0x278206abL, 0x23431b1cL, 0x2e003dc5L, 0x2ac12072L,</span>
<a href="#l13.57"></a><span id="l13.57" class="difflineplus">+   0x128e9dcfL, 0x164f8078L, 0x1b0ca6a1L, 0x1fcdbb16L,</span>
<a href="#l13.58"></a><span id="l13.58" class="difflineplus">+   0x018aeb13L, 0x054bf6a4L, 0x0808d07dL, 0x0cc9cdcaL,</span>
<a href="#l13.59"></a><span id="l13.59" class="difflineplus">+   0x7897ab07L, 0x7c56b6b0L, 0x71159069L, 0x75d48ddeL,</span>
<a href="#l13.60"></a><span id="l13.60" class="difflineplus">+   0x6b93dddbL, 0x6f52c06cL, 0x6211e6b5L, 0x66d0fb02L,</span>
<a href="#l13.61"></a><span id="l13.61" class="difflineplus">+   0x5e9f46bfL, 0x5a5e5b08L, 0x571d7dd1L, 0x53dc6066L,</span>
<a href="#l13.62"></a><span id="l13.62" class="difflineplus">+   0x4d9b3063L, 0x495a2dd4L, 0x44190b0dL, 0x40d816baL,</span>
<a href="#l13.63"></a><span id="l13.63" class="difflineplus">+   0xaca5c697L, 0xa864db20L, 0xa527fdf9L, 0xa1e6e04eL,</span>
<a href="#l13.64"></a><span id="l13.64" class="difflineplus">+   0xbfa1b04bL, 0xbb60adfcL, 0xb6238b25L, 0xb2e29692L,</span>
<a href="#l13.65"></a><span id="l13.65" class="difflineplus">+   0x8aad2b2fL, 0x8e6c3698L, 0x832f1041L, 0x87ee0df6L,</span>
<a href="#l13.66"></a><span id="l13.66" class="difflineplus">+   0x99a95df3L, 0x9d684044L, 0x902b669dL, 0x94ea7b2aL,</span>
<a href="#l13.67"></a><span id="l13.67" class="difflineplus">+   0xe0b41de7L, 0xe4750050L, 0xe9362689L, 0xedf73b3eL,</span>
<a href="#l13.68"></a><span id="l13.68" class="difflineplus">+   0xf3b06b3bL, 0xf771768cL, 0xfa325055L, 0xfef34de2L,</span>
<a href="#l13.69"></a><span id="l13.69" class="difflineplus">+   0xc6bcf05fL, 0xc27dede8L, 0xcf3ecb31L, 0xcbffd686L,</span>
<a href="#l13.70"></a><span id="l13.70" class="difflineplus">+   0xd5b88683L, 0xd1799b34L, 0xdc3abdedL, 0xd8fba05aL,</span>
<a href="#l13.71"></a><span id="l13.71" class="difflineplus">+   0x690ce0eeL, 0x6dcdfd59L, 0x608edb80L, 0x644fc637L,</span>
<a href="#l13.72"></a><span id="l13.72" class="difflineplus">+   0x7a089632L, 0x7ec98b85L, 0x738aad5cL, 0x774bb0ebL,</span>
<a href="#l13.73"></a><span id="l13.73" class="difflineplus">+   0x4f040d56L, 0x4bc510e1L, 0x46863638L, 0x42472b8fL,</span>
<a href="#l13.74"></a><span id="l13.74" class="difflineplus">+   0x5c007b8aL, 0x58c1663dL, 0x558240e4L, 0x51435d53L,</span>
<a href="#l13.75"></a><span id="l13.75" class="difflineplus">+   0x251d3b9eL, 0x21dc2629L, 0x2c9f00f0L, 0x285e1d47L,</span>
<a href="#l13.76"></a><span id="l13.76" class="difflineplus">+   0x36194d42L, 0x32d850f5L, 0x3f9b762cL, 0x3b5a6b9bL,</span>
<a href="#l13.77"></a><span id="l13.77" class="difflineplus">+   0x0315d626L, 0x07d4cb91L, 0x0a97ed48L, 0x0e56f0ffL,</span>
<a href="#l13.78"></a><span id="l13.78" class="difflineplus">+   0x1011a0faL, 0x14d0bd4dL, 0x19939b94L, 0x1d528623L,</span>
<a href="#l13.79"></a><span id="l13.79" class="difflineplus">+   0xf12f560eL, 0xf5ee4bb9L, 0xf8ad6d60L, 0xfc6c70d7L,</span>
<a href="#l13.80"></a><span id="l13.80" class="difflineplus">+   0xe22b20d2L, 0xe6ea3d65L, 0xeba91bbcL, 0xef68060bL,</span>
<a href="#l13.81"></a><span id="l13.81" class="difflineplus">+   0xd727bbb6L, 0xd3e6a601L, 0xdea580d8L, 0xda649d6fL,</span>
<a href="#l13.82"></a><span id="l13.82" class="difflineplus">+   0xc423cd6aL, 0xc0e2d0ddL, 0xcda1f604L, 0xc960ebb3L,</span>
<a href="#l13.83"></a><span id="l13.83" class="difflineplus">+   0xbd3e8d7eL, 0xb9ff90c9L, 0xb4bcb610L, 0xb07daba7L,</span>
<a href="#l13.84"></a><span id="l13.84" class="difflineplus">+   0xae3afba2L, 0xaafbe615L, 0xa7b8c0ccL, 0xa379dd7bL,</span>
<a href="#l13.85"></a><span id="l13.85" class="difflineplus">+   0x9b3660c6L, 0x9ff77d71L, 0x92b45ba8L, 0x9675461fL,</span>
<a href="#l13.86"></a><span id="l13.86" class="difflineplus">+   0x8832161aL, 0x8cf30badL, 0x81b02d74L, 0x857130c3L,</span>
<a href="#l13.87"></a><span id="l13.87" class="difflineplus">+   0x5d8a9099L, 0x594b8d2eL, 0x5408abf7L, 0x50c9b640L,</span>
<a href="#l13.88"></a><span id="l13.88" class="difflineplus">+   0x4e8ee645L, 0x4a4ffbf2L, 0x470cdd2bL, 0x43cdc09cL,</span>
<a href="#l13.89"></a><span id="l13.89" class="difflineplus">+   0x7b827d21L, 0x7f436096L, 0x7200464fL, 0x76c15bf8L,</span>
<a href="#l13.90"></a><span id="l13.90" class="difflineplus">+   0x68860bfdL, 0x6c47164aL, 0x61043093L, 0x65c52d24L,</span>
<a href="#l13.91"></a><span id="l13.91" class="difflineplus">+   0x119b4be9L, 0x155a565eL, 0x18197087L, 0x1cd86d30L,</span>
<a href="#l13.92"></a><span id="l13.92" class="difflineplus">+   0x029f3d35L, 0x065e2082L, 0x0b1d065bL, 0x0fdc1becL,</span>
<a href="#l13.93"></a><span id="l13.93" class="difflineplus">+   0x3793a651L, 0x3352bbe6L, 0x3e119d3fL, 0x3ad08088L,</span>
<a href="#l13.94"></a><span id="l13.94" class="difflineplus">+   0x2497d08dL, 0x2056cd3aL, 0x2d15ebe3L, 0x29d4f654L,</span>
<a href="#l13.95"></a><span id="l13.95" class="difflineplus">+   0xc5a92679L, 0xc1683bceL, 0xcc2b1d17L, 0xc8ea00a0L,</span>
<a href="#l13.96"></a><span id="l13.96" class="difflineplus">+   0xd6ad50a5L, 0xd26c4d12L, 0xdf2f6bcbL, 0xdbee767cL,</span>
<a href="#l13.97"></a><span id="l13.97" class="difflineplus">+   0xe3a1cbc1L, 0xe760d676L, 0xea23f0afL, 0xeee2ed18L,</span>
<a href="#l13.98"></a><span id="l13.98" class="difflineplus">+   0xf0a5bd1dL, 0xf464a0aaL, 0xf9278673L, 0xfde69bc4L,</span>
<a href="#l13.99"></a><span id="l13.99" class="difflineplus">+   0x89b8fd09L, 0x8d79e0beL, 0x803ac667L, 0x84fbdbd0L,</span>
<a href="#l13.100"></a><span id="l13.100" class="difflineplus">+   0x9abc8bd5L, 0x9e7d9662L, 0x933eb0bbL, 0x97ffad0cL,</span>
<a href="#l13.101"></a><span id="l13.101" class="difflineplus">+   0xafb010b1L, 0xab710d06L, 0xa6322bdfL, 0xa2f33668L,</span>
<a href="#l13.102"></a><span id="l13.102" class="difflineplus">+   0xbcb4666dL, 0xb8757bdaL, 0xb5365d03L, 0xb1f740b4L</span>
<a href="#l13.103"></a><span id="l13.103" class="difflineplus">+};</span>
<a href="#l13.104"></a><span id="l13.104" class="difflineplus">+</span>
<a href="#l13.105"></a><span id="l13.105" class="difflineplus">+</span>
<a href="#l13.106"></a><span id="l13.106" class="difflineplus">+/*-------------------------------------------------------------*/</span>
<a href="#l13.107"></a><span id="l13.107" class="difflineplus">+/*--- end                                        crctable.c ---*/</span>
<a href="#l13.108"></a><span id="l13.108" class="difflineplus">+/*-------------------------------------------------------------*/</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1">new file mode 100644</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineminus">--- /dev/null</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineplus">+++ b/third_party/bzip2/decompress.c</span>
<a href="#l14.4"></a><span id="l14.4" class="difflineat">@@ -0,0 +1,652 @@</span>
<a href="#l14.5"></a><span id="l14.5" class="difflineplus">+</span>
<a href="#l14.6"></a><span id="l14.6" class="difflineplus">+/*-------------------------------------------------------------*/</span>
<a href="#l14.7"></a><span id="l14.7" class="difflineplus">+/*--- Decompression machinery                               ---*/</span>
<a href="#l14.8"></a><span id="l14.8" class="difflineplus">+/*---                                          decompress.c ---*/</span>
<a href="#l14.9"></a><span id="l14.9" class="difflineplus">+/*-------------------------------------------------------------*/</span>
<a href="#l14.10"></a><span id="l14.10" class="difflineplus">+</span>
<a href="#l14.11"></a><span id="l14.11" class="difflineplus">+/* ------------------------------------------------------------------</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineplus">+   This file is part of bzip2/libbzip2, a program and library for</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+   lossless, block-sorting data compression.</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineplus">+   bzip2/libbzip2 version 1.0.8 of 13 July 2019</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineplus">+   Copyright (C) 1996-2019 Julian Seward &lt;jseward@acm.org&gt;</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineplus">+</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineplus">+   Please read the WARNING, DISCLAIMER and PATENTS sections in the </span>
<a href="#l14.19"></a><span id="l14.19" class="difflineplus">+   README file.</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineplus">+</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineplus">+   This program is released under the terms of the license contained</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineplus">+   in the file LICENSE.</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineplus">+   ------------------------------------------------------------------ */</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineplus">+</span>
<a href="#l14.25"></a><span id="l14.25" class="difflineplus">+</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineplus">+#include &quot;bzlib_private.h&quot;</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineplus">+</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineplus">+</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineplus">+/*---------------------------------------------------*/</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineplus">+static</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineplus">+void makeMaps_d ( DState* s )</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineplus">+{</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineplus">+   Int32 i;</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineplus">+   s-&gt;nInUse = 0;</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineplus">+   for (i = 0; i &lt; 256; i++)</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineplus">+      if (s-&gt;inUse[i]) {</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineplus">+         s-&gt;seqToUnseq[s-&gt;nInUse] = i;</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineplus">+         s-&gt;nInUse++;</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineplus">+      }</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineplus">+}</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineplus">+</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineplus">+</span>
<a href="#l14.43"></a><span id="l14.43" class="difflineplus">+/*---------------------------------------------------*/</span>
<a href="#l14.44"></a><span id="l14.44" class="difflineplus">+#define RETURN(rrr)                               \</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineplus">+   { retVal = rrr; goto save_state_and_return; };</span>
<a href="#l14.46"></a><span id="l14.46" class="difflineplus">+</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineplus">+#define GET_BITS(lll,vvv,nnn)                     \</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineplus">+   case lll: s-&gt;state = lll;                      \</span>
<a href="#l14.49"></a><span id="l14.49" class="difflineplus">+   while (True) {                                 \</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineplus">+      if (s-&gt;bsLive &gt;= nnn) {                     \</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineplus">+         UInt32 v;                                \</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineplus">+         v = (s-&gt;bsBuff &gt;&gt;                        \</span>
<a href="#l14.53"></a><span id="l14.53" class="difflineplus">+             (s-&gt;bsLive-nnn)) &amp; ((1 &lt;&lt; nnn)-1);   \</span>
<a href="#l14.54"></a><span id="l14.54" class="difflineplus">+         s-&gt;bsLive -= nnn;                        \</span>
<a href="#l14.55"></a><span id="l14.55" class="difflineplus">+         vvv = v;                                 \</span>
<a href="#l14.56"></a><span id="l14.56" class="difflineplus">+         break;                                   \</span>
<a href="#l14.57"></a><span id="l14.57" class="difflineplus">+      }                                           \</span>
<a href="#l14.58"></a><span id="l14.58" class="difflineplus">+      if (s-&gt;strm-&gt;avail_in == 0) RETURN(BZ_OK);  \</span>
<a href="#l14.59"></a><span id="l14.59" class="difflineplus">+      s-&gt;bsBuff                                   \</span>
<a href="#l14.60"></a><span id="l14.60" class="difflineplus">+         = (s-&gt;bsBuff &lt;&lt; 8) |                     \</span>
<a href="#l14.61"></a><span id="l14.61" class="difflineplus">+           ((UInt32)                              \</span>
<a href="#l14.62"></a><span id="l14.62" class="difflineplus">+              (*((UChar*)(s-&gt;strm-&gt;next_in))));   \</span>
<a href="#l14.63"></a><span id="l14.63" class="difflineplus">+      s-&gt;bsLive += 8;                             \</span>
<a href="#l14.64"></a><span id="l14.64" class="difflineplus">+      s-&gt;strm-&gt;next_in++;                         \</span>
<a href="#l14.65"></a><span id="l14.65" class="difflineplus">+      s-&gt;strm-&gt;avail_in--;                        \</span>
<a href="#l14.66"></a><span id="l14.66" class="difflineplus">+      s-&gt;strm-&gt;total_in_lo32++;                   \</span>
<a href="#l14.67"></a><span id="l14.67" class="difflineplus">+      if (s-&gt;strm-&gt;total_in_lo32 == 0)            \</span>
<a href="#l14.68"></a><span id="l14.68" class="difflineplus">+         s-&gt;strm-&gt;total_in_hi32++;                \</span>
<a href="#l14.69"></a><span id="l14.69" class="difflineplus">+   }</span>
<a href="#l14.70"></a><span id="l14.70" class="difflineplus">+</span>
<a href="#l14.71"></a><span id="l14.71" class="difflineplus">+#define GET_UCHAR(lll,uuu)                        \</span>
<a href="#l14.72"></a><span id="l14.72" class="difflineplus">+   GET_BITS(lll,uuu,8)</span>
<a href="#l14.73"></a><span id="l14.73" class="difflineplus">+</span>
<a href="#l14.74"></a><span id="l14.74" class="difflineplus">+#define GET_BIT(lll,uuu)                          \</span>
<a href="#l14.75"></a><span id="l14.75" class="difflineplus">+   GET_BITS(lll,uuu,1)</span>
<a href="#l14.76"></a><span id="l14.76" class="difflineplus">+</span>
<a href="#l14.77"></a><span id="l14.77" class="difflineplus">+/*---------------------------------------------------*/</span>
<a href="#l14.78"></a><span id="l14.78" class="difflineplus">+#define GET_MTF_VAL(label1,label2,lval)           \</span>
<a href="#l14.79"></a><span id="l14.79" class="difflineplus">+{                                                 \</span>
<a href="#l14.80"></a><span id="l14.80" class="difflineplus">+   if (groupPos == 0) {                           \</span>
<a href="#l14.81"></a><span id="l14.81" class="difflineplus">+      groupNo++;                                  \</span>
<a href="#l14.82"></a><span id="l14.82" class="difflineplus">+      if (groupNo &gt;= nSelectors)                  \</span>
<a href="#l14.83"></a><span id="l14.83" class="difflineplus">+         RETURN(BZ_DATA_ERROR);                   \</span>
<a href="#l14.84"></a><span id="l14.84" class="difflineplus">+      groupPos = BZ_G_SIZE;                       \</span>
<a href="#l14.85"></a><span id="l14.85" class="difflineplus">+      gSel = s-&gt;selector[groupNo];                \</span>
<a href="#l14.86"></a><span id="l14.86" class="difflineplus">+      gMinlen = s-&gt;minLens[gSel];                 \</span>
<a href="#l14.87"></a><span id="l14.87" class="difflineplus">+      gLimit = &amp;(s-&gt;limit[gSel][0]);              \</span>
<a href="#l14.88"></a><span id="l14.88" class="difflineplus">+      gPerm = &amp;(s-&gt;perm[gSel][0]);                \</span>
<a href="#l14.89"></a><span id="l14.89" class="difflineplus">+      gBase = &amp;(s-&gt;base[gSel][0]);                \</span>
<a href="#l14.90"></a><span id="l14.90" class="difflineplus">+   }                                              \</span>
<a href="#l14.91"></a><span id="l14.91" class="difflineplus">+   groupPos--;                                    \</span>
<a href="#l14.92"></a><span id="l14.92" class="difflineplus">+   zn = gMinlen;                                  \</span>
<a href="#l14.93"></a><span id="l14.93" class="difflineplus">+   GET_BITS(label1, zvec, zn);                    \</span>
<a href="#l14.94"></a><span id="l14.94" class="difflineplus">+   while (1) {                                    \</span>
<a href="#l14.95"></a><span id="l14.95" class="difflineplus">+      if (zn &gt; 20 /* the longest code */)         \</span>
<a href="#l14.96"></a><span id="l14.96" class="difflineplus">+         RETURN(BZ_DATA_ERROR);                   \</span>
<a href="#l14.97"></a><span id="l14.97" class="difflineplus">+      if (zvec &lt;= gLimit[zn]) break;              \</span>
<a href="#l14.98"></a><span id="l14.98" class="difflineplus">+      zn++;                                       \</span>
<a href="#l14.99"></a><span id="l14.99" class="difflineplus">+      GET_BIT(label2, zj);                        \</span>
<a href="#l14.100"></a><span id="l14.100" class="difflineplus">+      zvec = (zvec &lt;&lt; 1) | zj;                    \</span>
<a href="#l14.101"></a><span id="l14.101" class="difflineplus">+   };                                             \</span>
<a href="#l14.102"></a><span id="l14.102" class="difflineplus">+   if (zvec - gBase[zn] &lt; 0                       \</span>
<a href="#l14.103"></a><span id="l14.103" class="difflineplus">+       || zvec - gBase[zn] &gt;= BZ_MAX_ALPHA_SIZE)  \</span>
<a href="#l14.104"></a><span id="l14.104" class="difflineplus">+      RETURN(BZ_DATA_ERROR);                      \</span>
<a href="#l14.105"></a><span id="l14.105" class="difflineplus">+   lval = gPerm[zvec - gBase[zn]];                \</span>
<a href="#l14.106"></a><span id="l14.106" class="difflineplus">+}</span>
<a href="#l14.107"></a><span id="l14.107" class="difflineplus">+</span>
<a href="#l14.108"></a><span id="l14.108" class="difflineplus">+</span>
<a href="#l14.109"></a><span id="l14.109" class="difflineplus">+/*---------------------------------------------------*/</span>
<a href="#l14.110"></a><span id="l14.110" class="difflineplus">+Int32 BZ2_decompress ( DState* s )</span>
<a href="#l14.111"></a><span id="l14.111" class="difflineplus">+{</span>
<a href="#l14.112"></a><span id="l14.112" class="difflineplus">+   UChar      uc;</span>
<a href="#l14.113"></a><span id="l14.113" class="difflineplus">+   Int32      retVal;</span>
<a href="#l14.114"></a><span id="l14.114" class="difflineplus">+   Int32      minLen, maxLen;</span>
<a href="#l14.115"></a><span id="l14.115" class="difflineplus">+   bz_stream* strm = s-&gt;strm;</span>
<a href="#l14.116"></a><span id="l14.116" class="difflineplus">+</span>
<a href="#l14.117"></a><span id="l14.117" class="difflineplus">+   /* stuff that needs to be saved/restored */</span>
<a href="#l14.118"></a><span id="l14.118" class="difflineplus">+   Int32  i;</span>
<a href="#l14.119"></a><span id="l14.119" class="difflineplus">+   Int32  j;</span>
<a href="#l14.120"></a><span id="l14.120" class="difflineplus">+   Int32  t;</span>
<a href="#l14.121"></a><span id="l14.121" class="difflineplus">+   Int32  alphaSize;</span>
<a href="#l14.122"></a><span id="l14.122" class="difflineplus">+   Int32  nGroups;</span>
<a href="#l14.123"></a><span id="l14.123" class="difflineplus">+   Int32  nSelectors;</span>
<a href="#l14.124"></a><span id="l14.124" class="difflineplus">+   Int32  EOB;</span>
<a href="#l14.125"></a><span id="l14.125" class="difflineplus">+   Int32  groupNo;</span>
<a href="#l14.126"></a><span id="l14.126" class="difflineplus">+   Int32  groupPos;</span>
<a href="#l14.127"></a><span id="l14.127" class="difflineplus">+   Int32  nextSym;</span>
<a href="#l14.128"></a><span id="l14.128" class="difflineplus">+   Int32  nblockMAX;</span>
<a href="#l14.129"></a><span id="l14.129" class="difflineplus">+   Int32  nblock;</span>
<a href="#l14.130"></a><span id="l14.130" class="difflineplus">+   Int32  es;</span>
<a href="#l14.131"></a><span id="l14.131" class="difflineplus">+   Int32  N;</span>
<a href="#l14.132"></a><span id="l14.132" class="difflineplus">+   Int32  curr;</span>
<a href="#l14.133"></a><span id="l14.133" class="difflineplus">+   Int32  zt;</span>
<a href="#l14.134"></a><span id="l14.134" class="difflineplus">+   Int32  zn; </span>
<a href="#l14.135"></a><span id="l14.135" class="difflineplus">+   Int32  zvec;</span>
<a href="#l14.136"></a><span id="l14.136" class="difflineplus">+   Int32  zj;</span>
<a href="#l14.137"></a><span id="l14.137" class="difflineplus">+   Int32  gSel;</span>
<a href="#l14.138"></a><span id="l14.138" class="difflineplus">+   Int32  gMinlen;</span>
<a href="#l14.139"></a><span id="l14.139" class="difflineplus">+   Int32* gLimit;</span>
<a href="#l14.140"></a><span id="l14.140" class="difflineplus">+   Int32* gBase;</span>
<a href="#l14.141"></a><span id="l14.141" class="difflineplus">+   Int32* gPerm;</span>
<a href="#l14.142"></a><span id="l14.142" class="difflineplus">+</span>
<a href="#l14.143"></a><span id="l14.143" class="difflineplus">+   if (s-&gt;state == BZ_X_MAGIC_1) {</span>
<a href="#l14.144"></a><span id="l14.144" class="difflineplus">+      /*initialise the save area*/</span>
<a href="#l14.145"></a><span id="l14.145" class="difflineplus">+      s-&gt;save_i           = 0;</span>
<a href="#l14.146"></a><span id="l14.146" class="difflineplus">+      s-&gt;save_j           = 0;</span>
<a href="#l14.147"></a><span id="l14.147" class="difflineplus">+      s-&gt;save_t           = 0;</span>
<a href="#l14.148"></a><span id="l14.148" class="difflineplus">+      s-&gt;save_alphaSize   = 0;</span>
<a href="#l14.149"></a><span id="l14.149" class="difflineplus">+      s-&gt;save_nGroups     = 0;</span>
<a href="#l14.150"></a><span id="l14.150" class="difflineplus">+      s-&gt;save_nSelectors  = 0;</span>
<a href="#l14.151"></a><span id="l14.151" class="difflineplus">+      s-&gt;save_EOB         = 0;</span>
<a href="#l14.152"></a><span id="l14.152" class="difflineplus">+      s-&gt;save_groupNo     = 0;</span>
<a href="#l14.153"></a><span id="l14.153" class="difflineplus">+      s-&gt;save_groupPos    = 0;</span>
<a href="#l14.154"></a><span id="l14.154" class="difflineplus">+      s-&gt;save_nextSym     = 0;</span>
<a href="#l14.155"></a><span id="l14.155" class="difflineplus">+      s-&gt;save_nblockMAX   = 0;</span>
<a href="#l14.156"></a><span id="l14.156" class="difflineplus">+      s-&gt;save_nblock      = 0;</span>
<a href="#l14.157"></a><span id="l14.157" class="difflineplus">+      s-&gt;save_es          = 0;</span>
<a href="#l14.158"></a><span id="l14.158" class="difflineplus">+      s-&gt;save_N           = 0;</span>
<a href="#l14.159"></a><span id="l14.159" class="difflineplus">+      s-&gt;save_curr        = 0;</span>
<a href="#l14.160"></a><span id="l14.160" class="difflineplus">+      s-&gt;save_zt          = 0;</span>
<a href="#l14.161"></a><span id="l14.161" class="difflineplus">+      s-&gt;save_zn          = 0;</span>
<a href="#l14.162"></a><span id="l14.162" class="difflineplus">+      s-&gt;save_zvec        = 0;</span>
<a href="#l14.163"></a><span id="l14.163" class="difflineplus">+      s-&gt;save_zj          = 0;</span>
<a href="#l14.164"></a><span id="l14.164" class="difflineplus">+      s-&gt;save_gSel        = 0;</span>
<a href="#l14.165"></a><span id="l14.165" class="difflineplus">+      s-&gt;save_gMinlen     = 0;</span>
<a href="#l14.166"></a><span id="l14.166" class="difflineplus">+      s-&gt;save_gLimit      = NULL;</span>
<a href="#l14.167"></a><span id="l14.167" class="difflineplus">+      s-&gt;save_gBase       = NULL;</span>
<a href="#l14.168"></a><span id="l14.168" class="difflineplus">+      s-&gt;save_gPerm       = NULL;</span>
<a href="#l14.169"></a><span id="l14.169" class="difflineplus">+   }</span>
<a href="#l14.170"></a><span id="l14.170" class="difflineplus">+</span>
<a href="#l14.171"></a><span id="l14.171" class="difflineplus">+   /*restore from the save area*/</span>
<a href="#l14.172"></a><span id="l14.172" class="difflineplus">+   i           = s-&gt;save_i;</span>
<a href="#l14.173"></a><span id="l14.173" class="difflineplus">+   j           = s-&gt;save_j;</span>
<a href="#l14.174"></a><span id="l14.174" class="difflineplus">+   t           = s-&gt;save_t;</span>
<a href="#l14.175"></a><span id="l14.175" class="difflineplus">+   alphaSize   = s-&gt;save_alphaSize;</span>
<a href="#l14.176"></a><span id="l14.176" class="difflineplus">+   nGroups     = s-&gt;save_nGroups;</span>
<a href="#l14.177"></a><span id="l14.177" class="difflineplus">+   nSelectors  = s-&gt;save_nSelectors;</span>
<a href="#l14.178"></a><span id="l14.178" class="difflineplus">+   EOB         = s-&gt;save_EOB;</span>
<a href="#l14.179"></a><span id="l14.179" class="difflineplus">+   groupNo     = s-&gt;save_groupNo;</span>
<a href="#l14.180"></a><span id="l14.180" class="difflineplus">+   groupPos    = s-&gt;save_groupPos;</span>
<a href="#l14.181"></a><span id="l14.181" class="difflineplus">+   nextSym     = s-&gt;save_nextSym;</span>
<a href="#l14.182"></a><span id="l14.182" class="difflineplus">+   nblockMAX   = s-&gt;save_nblockMAX;</span>
<a href="#l14.183"></a><span id="l14.183" class="difflineplus">+   nblock      = s-&gt;save_nblock;</span>
<a href="#l14.184"></a><span id="l14.184" class="difflineplus">+   es          = s-&gt;save_es;</span>
<a href="#l14.185"></a><span id="l14.185" class="difflineplus">+   N           = s-&gt;save_N;</span>
<a href="#l14.186"></a><span id="l14.186" class="difflineplus">+   curr        = s-&gt;save_curr;</span>
<a href="#l14.187"></a><span id="l14.187" class="difflineplus">+   zt          = s-&gt;save_zt;</span>
<a href="#l14.188"></a><span id="l14.188" class="difflineplus">+   zn          = s-&gt;save_zn; </span>
<a href="#l14.189"></a><span id="l14.189" class="difflineplus">+   zvec        = s-&gt;save_zvec;</span>
<a href="#l14.190"></a><span id="l14.190" class="difflineplus">+   zj          = s-&gt;save_zj;</span>
<a href="#l14.191"></a><span id="l14.191" class="difflineplus">+   gSel        = s-&gt;save_gSel;</span>
<a href="#l14.192"></a><span id="l14.192" class="difflineplus">+   gMinlen     = s-&gt;save_gMinlen;</span>
<a href="#l14.193"></a><span id="l14.193" class="difflineplus">+   gLimit      = s-&gt;save_gLimit;</span>
<a href="#l14.194"></a><span id="l14.194" class="difflineplus">+   gBase       = s-&gt;save_gBase;</span>
<a href="#l14.195"></a><span id="l14.195" class="difflineplus">+   gPerm       = s-&gt;save_gPerm;</span>
<a href="#l14.196"></a><span id="l14.196" class="difflineplus">+</span>
<a href="#l14.197"></a><span id="l14.197" class="difflineplus">+   retVal = BZ_OK;</span>
<a href="#l14.198"></a><span id="l14.198" class="difflineplus">+</span>
<a href="#l14.199"></a><span id="l14.199" class="difflineplus">+   switch (s-&gt;state) {</span>
<a href="#l14.200"></a><span id="l14.200" class="difflineplus">+</span>
<a href="#l14.201"></a><span id="l14.201" class="difflineplus">+      GET_UCHAR(BZ_X_MAGIC_1, uc);</span>
<a href="#l14.202"></a><span id="l14.202" class="difflineplus">+      if (uc != BZ_HDR_B) RETURN(BZ_DATA_ERROR_MAGIC);</span>
<a href="#l14.203"></a><span id="l14.203" class="difflineplus">+</span>
<a href="#l14.204"></a><span id="l14.204" class="difflineplus">+      GET_UCHAR(BZ_X_MAGIC_2, uc);</span>
<a href="#l14.205"></a><span id="l14.205" class="difflineplus">+      if (uc != BZ_HDR_Z) RETURN(BZ_DATA_ERROR_MAGIC);</span>
<a href="#l14.206"></a><span id="l14.206" class="difflineplus">+</span>
<a href="#l14.207"></a><span id="l14.207" class="difflineplus">+      GET_UCHAR(BZ_X_MAGIC_3, uc)</span>
<a href="#l14.208"></a><span id="l14.208" class="difflineplus">+      if (uc != BZ_HDR_h) RETURN(BZ_DATA_ERROR_MAGIC);</span>
<a href="#l14.209"></a><span id="l14.209" class="difflineplus">+</span>
<a href="#l14.210"></a><span id="l14.210" class="difflineplus">+      GET_BITS(BZ_X_MAGIC_4, s-&gt;blockSize100k, 8)</span>
<a href="#l14.211"></a><span id="l14.211" class="difflineplus">+      if (s-&gt;blockSize100k &lt; (BZ_HDR_0 + 1) || </span>
<a href="#l14.212"></a><span id="l14.212" class="difflineplus">+          s-&gt;blockSize100k &gt; (BZ_HDR_0 + 9)) RETURN(BZ_DATA_ERROR_MAGIC);</span>
<a href="#l14.213"></a><span id="l14.213" class="difflineplus">+      s-&gt;blockSize100k -= BZ_HDR_0;</span>
<a href="#l14.214"></a><span id="l14.214" class="difflineplus">+</span>
<a href="#l14.215"></a><span id="l14.215" class="difflineplus">+      if (s-&gt;smallDecompress) {</span>
<a href="#l14.216"></a><span id="l14.216" class="difflineplus">+         s-&gt;ll16 = BZALLOC( s-&gt;blockSize100k * 100000 * sizeof(UInt16) );</span>
<a href="#l14.217"></a><span id="l14.217" class="difflineplus">+         s-&gt;ll4  = BZALLOC( </span>
<a href="#l14.218"></a><span id="l14.218" class="difflineplus">+                      ((1 + s-&gt;blockSize100k * 100000) &gt;&gt; 1) * sizeof(UChar) </span>
<a href="#l14.219"></a><span id="l14.219" class="difflineplus">+                   );</span>
<a href="#l14.220"></a><span id="l14.220" class="difflineplus">+         if (s-&gt;ll16 == NULL || s-&gt;ll4 == NULL) RETURN(BZ_MEM_ERROR);</span>
<a href="#l14.221"></a><span id="l14.221" class="difflineplus">+      } else {</span>
<a href="#l14.222"></a><span id="l14.222" class="difflineplus">+         s-&gt;tt  = BZALLOC( s-&gt;blockSize100k * 100000 * sizeof(Int32) );</span>
<a href="#l14.223"></a><span id="l14.223" class="difflineplus">+         if (s-&gt;tt == NULL) RETURN(BZ_MEM_ERROR);</span>
<a href="#l14.224"></a><span id="l14.224" class="difflineplus">+      }</span>
<a href="#l14.225"></a><span id="l14.225" class="difflineplus">+</span>
<a href="#l14.226"></a><span id="l14.226" class="difflineplus">+      GET_UCHAR(BZ_X_BLKHDR_1, uc);</span>
<a href="#l14.227"></a><span id="l14.227" class="difflineplus">+</span>
<a href="#l14.228"></a><span id="l14.228" class="difflineplus">+      if (uc == 0x17) goto endhdr_2;</span>
<a href="#l14.229"></a><span id="l14.229" class="difflineplus">+      if (uc != 0x31) RETURN(BZ_DATA_ERROR);</span>
<a href="#l14.230"></a><span id="l14.230" class="difflineplus">+      GET_UCHAR(BZ_X_BLKHDR_2, uc);</span>
<a href="#l14.231"></a><span id="l14.231" class="difflineplus">+      if (uc != 0x41) RETURN(BZ_DATA_ERROR);</span>
<a href="#l14.232"></a><span id="l14.232" class="difflineplus">+      GET_UCHAR(BZ_X_BLKHDR_3, uc);</span>
<a href="#l14.233"></a><span id="l14.233" class="difflineplus">+      if (uc != 0x59) RETURN(BZ_DATA_ERROR);</span>
<a href="#l14.234"></a><span id="l14.234" class="difflineplus">+      GET_UCHAR(BZ_X_BLKHDR_4, uc);</span>
<a href="#l14.235"></a><span id="l14.235" class="difflineplus">+      if (uc != 0x26) RETURN(BZ_DATA_ERROR);</span>
<a href="#l14.236"></a><span id="l14.236" class="difflineplus">+      GET_UCHAR(BZ_X_BLKHDR_5, uc);</span>
<a href="#l14.237"></a><span id="l14.237" class="difflineplus">+      if (uc != 0x53) RETURN(BZ_DATA_ERROR);</span>
<a href="#l14.238"></a><span id="l14.238" class="difflineplus">+      GET_UCHAR(BZ_X_BLKHDR_6, uc);</span>
<a href="#l14.239"></a><span id="l14.239" class="difflineplus">+      if (uc != 0x59) RETURN(BZ_DATA_ERROR);</span>
<a href="#l14.240"></a><span id="l14.240" class="difflineplus">+</span>
<a href="#l14.241"></a><span id="l14.241" class="difflineplus">+      s-&gt;currBlockNo++;</span>
<a href="#l14.242"></a><span id="l14.242" class="difflineplus">+      if (s-&gt;verbosity &gt;= 2)</span>
<a href="#l14.243"></a><span id="l14.243" class="difflineplus">+         VPrintf1 ( &quot;\n    [%d: huff+mtf &quot;, s-&gt;currBlockNo );</span>
<a href="#l14.244"></a><span id="l14.244" class="difflineplus">+ </span>
<a href="#l14.245"></a><span id="l14.245" class="difflineplus">+      s-&gt;storedBlockCRC = 0;</span>
<a href="#l14.246"></a><span id="l14.246" class="difflineplus">+      GET_UCHAR(BZ_X_BCRC_1, uc);</span>
<a href="#l14.247"></a><span id="l14.247" class="difflineplus">+      s-&gt;storedBlockCRC = (s-&gt;storedBlockCRC &lt;&lt; 8) | ((UInt32)uc);</span>
<a href="#l14.248"></a><span id="l14.248" class="difflineplus">+      GET_UCHAR(BZ_X_BCRC_2, uc);</span>
<a href="#l14.249"></a><span id="l14.249" class="difflineplus">+      s-&gt;storedBlockCRC = (s-&gt;storedBlockCRC &lt;&lt; 8) | ((UInt32)uc);</span>
<a href="#l14.250"></a><span id="l14.250" class="difflineplus">+      GET_UCHAR(BZ_X_BCRC_3, uc);</span>
<a href="#l14.251"></a><span id="l14.251" class="difflineplus">+      s-&gt;storedBlockCRC = (s-&gt;storedBlockCRC &lt;&lt; 8) | ((UInt32)uc);</span>
<a href="#l14.252"></a><span id="l14.252" class="difflineplus">+      GET_UCHAR(BZ_X_BCRC_4, uc);</span>
<a href="#l14.253"></a><span id="l14.253" class="difflineplus">+      s-&gt;storedBlockCRC = (s-&gt;storedBlockCRC &lt;&lt; 8) | ((UInt32)uc);</span>
<a href="#l14.254"></a><span id="l14.254" class="difflineplus">+</span>
<a href="#l14.255"></a><span id="l14.255" class="difflineplus">+      GET_BITS(BZ_X_RANDBIT, s-&gt;blockRandomised, 1);</span>
<a href="#l14.256"></a><span id="l14.256" class="difflineplus">+</span>
<a href="#l14.257"></a><span id="l14.257" class="difflineplus">+      s-&gt;origPtr = 0;</span>
<a href="#l14.258"></a><span id="l14.258" class="difflineplus">+      GET_UCHAR(BZ_X_ORIGPTR_1, uc);</span>
<a href="#l14.259"></a><span id="l14.259" class="difflineplus">+      s-&gt;origPtr = (s-&gt;origPtr &lt;&lt; 8) | ((Int32)uc);</span>
<a href="#l14.260"></a><span id="l14.260" class="difflineplus">+      GET_UCHAR(BZ_X_ORIGPTR_2, uc);</span>
<a href="#l14.261"></a><span id="l14.261" class="difflineplus">+      s-&gt;origPtr = (s-&gt;origPtr &lt;&lt; 8) | ((Int32)uc);</span>
<a href="#l14.262"></a><span id="l14.262" class="difflineplus">+      GET_UCHAR(BZ_X_ORIGPTR_3, uc);</span>
<a href="#l14.263"></a><span id="l14.263" class="difflineplus">+      s-&gt;origPtr = (s-&gt;origPtr &lt;&lt; 8) | ((Int32)uc);</span>
<a href="#l14.264"></a><span id="l14.264" class="difflineplus">+</span>
<a href="#l14.265"></a><span id="l14.265" class="difflineplus">+      if (s-&gt;origPtr &lt; 0)</span>
<a href="#l14.266"></a><span id="l14.266" class="difflineplus">+         RETURN(BZ_DATA_ERROR);</span>
<a href="#l14.267"></a><span id="l14.267" class="difflineplus">+      if (s-&gt;origPtr &gt; 10 + 100000*s-&gt;blockSize100k) </span>
<a href="#l14.268"></a><span id="l14.268" class="difflineplus">+         RETURN(BZ_DATA_ERROR);</span>
<a href="#l14.269"></a><span id="l14.269" class="difflineplus">+</span>
<a href="#l14.270"></a><span id="l14.270" class="difflineplus">+      /*--- Receive the mapping table ---*/</span>
<a href="#l14.271"></a><span id="l14.271" class="difflineplus">+      for (i = 0; i &lt; 16; i++) {</span>
<a href="#l14.272"></a><span id="l14.272" class="difflineplus">+         GET_BIT(BZ_X_MAPPING_1, uc);</span>
<a href="#l14.273"></a><span id="l14.273" class="difflineplus">+         if (uc == 1) </span>
<a href="#l14.274"></a><span id="l14.274" class="difflineplus">+            s-&gt;inUse16[i] = True; else </span>
<a href="#l14.275"></a><span id="l14.275" class="difflineplus">+            s-&gt;inUse16[i] = False;</span>
<a href="#l14.276"></a><span id="l14.276" class="difflineplus">+      }</span>
<a href="#l14.277"></a><span id="l14.277" class="difflineplus">+</span>
<a href="#l14.278"></a><span id="l14.278" class="difflineplus">+      for (i = 0; i &lt; 256; i++) s-&gt;inUse[i] = False;</span>
<a href="#l14.279"></a><span id="l14.279" class="difflineplus">+</span>
<a href="#l14.280"></a><span id="l14.280" class="difflineplus">+      for (i = 0; i &lt; 16; i++)</span>
<a href="#l14.281"></a><span id="l14.281" class="difflineplus">+         if (s-&gt;inUse16[i])</span>
<a href="#l14.282"></a><span id="l14.282" class="difflineplus">+            for (j = 0; j &lt; 16; j++) {</span>
<a href="#l14.283"></a><span id="l14.283" class="difflineplus">+               GET_BIT(BZ_X_MAPPING_2, uc);</span>
<a href="#l14.284"></a><span id="l14.284" class="difflineplus">+               if (uc == 1) s-&gt;inUse[i * 16 + j] = True;</span>
<a href="#l14.285"></a><span id="l14.285" class="difflineplus">+            }</span>
<a href="#l14.286"></a><span id="l14.286" class="difflineplus">+      makeMaps_d ( s );</span>
<a href="#l14.287"></a><span id="l14.287" class="difflineplus">+      if (s-&gt;nInUse == 0) RETURN(BZ_DATA_ERROR);</span>
<a href="#l14.288"></a><span id="l14.288" class="difflineplus">+      alphaSize = s-&gt;nInUse+2;</span>
<a href="#l14.289"></a><span id="l14.289" class="difflineplus">+</span>
<a href="#l14.290"></a><span id="l14.290" class="difflineplus">+      /*--- Now the selectors ---*/</span>
<a href="#l14.291"></a><span id="l14.291" class="difflineplus">+      GET_BITS(BZ_X_SELECTOR_1, nGroups, 3);</span>
<a href="#l14.292"></a><span id="l14.292" class="difflineplus">+      if (nGroups &lt; 2 || nGroups &gt; BZ_N_GROUPS) RETURN(BZ_DATA_ERROR);</span>
<a href="#l14.293"></a><span id="l14.293" class="difflineplus">+      GET_BITS(BZ_X_SELECTOR_2, nSelectors, 15);</span>
<a href="#l14.294"></a><span id="l14.294" class="difflineplus">+      if (nSelectors &lt; 1) RETURN(BZ_DATA_ERROR);</span>
<a href="#l14.295"></a><span id="l14.295" class="difflineplus">+      for (i = 0; i &lt; nSelectors; i++) {</span>
<a href="#l14.296"></a><span id="l14.296" class="difflineplus">+         j = 0;</span>
<a href="#l14.297"></a><span id="l14.297" class="difflineplus">+         while (True) {</span>
<a href="#l14.298"></a><span id="l14.298" class="difflineplus">+            GET_BIT(BZ_X_SELECTOR_3, uc);</span>
<a href="#l14.299"></a><span id="l14.299" class="difflineplus">+            if (uc == 0) break;</span>
<a href="#l14.300"></a><span id="l14.300" class="difflineplus">+            j++;</span>
<a href="#l14.301"></a><span id="l14.301" class="difflineplus">+            if (j &gt;= nGroups) RETURN(BZ_DATA_ERROR);</span>
<a href="#l14.302"></a><span id="l14.302" class="difflineplus">+         }</span>
<a href="#l14.303"></a><span id="l14.303" class="difflineplus">+         /* Having more than BZ_MAX_SELECTORS doesn't make much sense</span>
<a href="#l14.304"></a><span id="l14.304" class="difflineplus">+            since they will never be used, but some implementations might</span>
<a href="#l14.305"></a><span id="l14.305" class="difflineplus">+            &quot;round up&quot; the number of selectors, so just ignore those. */</span>
<a href="#l14.306"></a><span id="l14.306" class="difflineplus">+         if (i &lt; BZ_MAX_SELECTORS)</span>
<a href="#l14.307"></a><span id="l14.307" class="difflineplus">+           s-&gt;selectorMtf[i] = j;</span>
<a href="#l14.308"></a><span id="l14.308" class="difflineplus">+      }</span>
<a href="#l14.309"></a><span id="l14.309" class="difflineplus">+      if (nSelectors &gt; BZ_MAX_SELECTORS)</span>
<a href="#l14.310"></a><span id="l14.310" class="difflineplus">+        nSelectors = BZ_MAX_SELECTORS;</span>
<a href="#l14.311"></a><span id="l14.311" class="difflineplus">+</span>
<a href="#l14.312"></a><span id="l14.312" class="difflineplus">+      /*--- Undo the MTF values for the selectors. ---*/</span>
<a href="#l14.313"></a><span id="l14.313" class="difflineplus">+      {</span>
<a href="#l14.314"></a><span id="l14.314" class="difflineplus">+         UChar pos[BZ_N_GROUPS], tmp, v;</span>
<a href="#l14.315"></a><span id="l14.315" class="difflineplus">+         for (v = 0; v &lt; nGroups; v++) pos[v] = v;</span>
<a href="#l14.316"></a><span id="l14.316" class="difflineplus">+   </span>
<a href="#l14.317"></a><span id="l14.317" class="difflineplus">+         for (i = 0; i &lt; nSelectors; i++) {</span>
<a href="#l14.318"></a><span id="l14.318" class="difflineplus">+            v = s-&gt;selectorMtf[i];</span>
<a href="#l14.319"></a><span id="l14.319" class="difflineplus">+            tmp = pos[v];</span>
<a href="#l14.320"></a><span id="l14.320" class="difflineplus">+            while (v &gt; 0) { pos[v] = pos[v-1]; v--; }</span>
<a href="#l14.321"></a><span id="l14.321" class="difflineplus">+            pos[0] = tmp;</span>
<a href="#l14.322"></a><span id="l14.322" class="difflineplus">+            s-&gt;selector[i] = tmp;</span>
<a href="#l14.323"></a><span id="l14.323" class="difflineplus">+         }</span>
<a href="#l14.324"></a><span id="l14.324" class="difflineplus">+      }</span>
<a href="#l14.325"></a><span id="l14.325" class="difflineplus">+</span>
<a href="#l14.326"></a><span id="l14.326" class="difflineplus">+      /*--- Now the coding tables ---*/</span>
<a href="#l14.327"></a><span id="l14.327" class="difflineplus">+      for (t = 0; t &lt; nGroups; t++) {</span>
<a href="#l14.328"></a><span id="l14.328" class="difflineplus">+         GET_BITS(BZ_X_CODING_1, curr, 5);</span>
<a href="#l14.329"></a><span id="l14.329" class="difflineplus">+         for (i = 0; i &lt; alphaSize; i++) {</span>
<a href="#l14.330"></a><span id="l14.330" class="difflineplus">+            while (True) {</span>
<a href="#l14.331"></a><span id="l14.331" class="difflineplus">+               if (curr &lt; 1 || curr &gt; 20) RETURN(BZ_DATA_ERROR);</span>
<a href="#l14.332"></a><span id="l14.332" class="difflineplus">+               GET_BIT(BZ_X_CODING_2, uc);</span>
<a href="#l14.333"></a><span id="l14.333" class="difflineplus">+               if (uc == 0) break;</span>
<a href="#l14.334"></a><span id="l14.334" class="difflineplus">+               GET_BIT(BZ_X_CODING_3, uc);</span>
<a href="#l14.335"></a><span id="l14.335" class="difflineplus">+               if (uc == 0) curr++; else curr--;</span>
<a href="#l14.336"></a><span id="l14.336" class="difflineplus">+            }</span>
<a href="#l14.337"></a><span id="l14.337" class="difflineplus">+            s-&gt;len[t][i] = curr;</span>
<a href="#l14.338"></a><span id="l14.338" class="difflineplus">+         }</span>
<a href="#l14.339"></a><span id="l14.339" class="difflineplus">+      }</span>
<a href="#l14.340"></a><span id="l14.340" class="difflineplus">+</span>
<a href="#l14.341"></a><span id="l14.341" class="difflineplus">+      /*--- Create the Huffman decoding tables ---*/</span>
<a href="#l14.342"></a><span id="l14.342" class="difflineplus">+      for (t = 0; t &lt; nGroups; t++) {</span>
<a href="#l14.343"></a><span id="l14.343" class="difflineplus">+         minLen = 32;</span>
<a href="#l14.344"></a><span id="l14.344" class="difflineplus">+         maxLen = 0;</span>
<a href="#l14.345"></a><span id="l14.345" class="difflineplus">+         for (i = 0; i &lt; alphaSize; i++) {</span>
<a href="#l14.346"></a><span id="l14.346" class="difflineplus">+            if (s-&gt;len[t][i] &gt; maxLen) maxLen = s-&gt;len[t][i];</span>
<a href="#l14.347"></a><span id="l14.347" class="difflineplus">+            if (s-&gt;len[t][i] &lt; minLen) minLen = s-&gt;len[t][i];</span>
<a href="#l14.348"></a><span id="l14.348" class="difflineplus">+         }</span>
<a href="#l14.349"></a><span id="l14.349" class="difflineplus">+         BZ2_hbCreateDecodeTables ( </span>
<a href="#l14.350"></a><span id="l14.350" class="difflineplus">+            &amp;(s-&gt;limit[t][0]), </span>
<a href="#l14.351"></a><span id="l14.351" class="difflineplus">+            &amp;(s-&gt;base[t][0]), </span>
<a href="#l14.352"></a><span id="l14.352" class="difflineplus">+            &amp;(s-&gt;perm[t][0]), </span>
<a href="#l14.353"></a><span id="l14.353" class="difflineplus">+            &amp;(s-&gt;len[t][0]),</span>
<a href="#l14.354"></a><span id="l14.354" class="difflineplus">+            minLen, maxLen, alphaSize</span>
<a href="#l14.355"></a><span id="l14.355" class="difflineplus">+         );</span>
<a href="#l14.356"></a><span id="l14.356" class="difflineplus">+         s-&gt;minLens[t] = minLen;</span>
<a href="#l14.357"></a><span id="l14.357" class="difflineplus">+      }</span>
<a href="#l14.358"></a><span id="l14.358" class="difflineplus">+</span>
<a href="#l14.359"></a><span id="l14.359" class="difflineplus">+      /*--- Now the MTF values ---*/</span>
<a href="#l14.360"></a><span id="l14.360" class="difflineplus">+</span>
<a href="#l14.361"></a><span id="l14.361" class="difflineplus">+      EOB      = s-&gt;nInUse+1;</span>
<a href="#l14.362"></a><span id="l14.362" class="difflineplus">+      nblockMAX = 100000 * s-&gt;blockSize100k;</span>
<a href="#l14.363"></a><span id="l14.363" class="difflineplus">+      groupNo  = -1;</span>
<a href="#l14.364"></a><span id="l14.364" class="difflineplus">+      groupPos = 0;</span>
<a href="#l14.365"></a><span id="l14.365" class="difflineplus">+</span>
<a href="#l14.366"></a><span id="l14.366" class="difflineplus">+      for (i = 0; i &lt;= 255; i++) s-&gt;unzftab[i] = 0;</span>
<a href="#l14.367"></a><span id="l14.367" class="difflineplus">+</span>
<a href="#l14.368"></a><span id="l14.368" class="difflineplus">+      /*-- MTF init --*/</span>
<a href="#l14.369"></a><span id="l14.369" class="difflineplus">+      {</span>
<a href="#l14.370"></a><span id="l14.370" class="difflineplus">+         Int32 ii, jj, kk;</span>
<a href="#l14.371"></a><span id="l14.371" class="difflineplus">+         kk = MTFA_SIZE-1;</span>
<a href="#l14.372"></a><span id="l14.372" class="difflineplus">+         for (ii = 256 / MTFL_SIZE - 1; ii &gt;= 0; ii--) {</span>
<a href="#l14.373"></a><span id="l14.373" class="difflineplus">+            for (jj = MTFL_SIZE-1; jj &gt;= 0; jj--) {</span>
<a href="#l14.374"></a><span id="l14.374" class="difflineplus">+               s-&gt;mtfa[kk] = (UChar)(ii * MTFL_SIZE + jj);</span>
<a href="#l14.375"></a><span id="l14.375" class="difflineplus">+               kk--;</span>
<a href="#l14.376"></a><span id="l14.376" class="difflineplus">+            }</span>
<a href="#l14.377"></a><span id="l14.377" class="difflineplus">+            s-&gt;mtfbase[ii] = kk + 1;</span>
<a href="#l14.378"></a><span id="l14.378" class="difflineplus">+         }</span>
<a href="#l14.379"></a><span id="l14.379" class="difflineplus">+      }</span>
<a href="#l14.380"></a><span id="l14.380" class="difflineplus">+      /*-- end MTF init --*/</span>
<a href="#l14.381"></a><span id="l14.381" class="difflineplus">+</span>
<a href="#l14.382"></a><span id="l14.382" class="difflineplus">+      nblock = 0;</span>
<a href="#l14.383"></a><span id="l14.383" class="difflineplus">+      GET_MTF_VAL(BZ_X_MTF_1, BZ_X_MTF_2, nextSym);</span>
<a href="#l14.384"></a><span id="l14.384" class="difflineplus">+</span>
<a href="#l14.385"></a><span id="l14.385" class="difflineplus">+      while (True) {</span>
<a href="#l14.386"></a><span id="l14.386" class="difflineplus">+</span>
<a href="#l14.387"></a><span id="l14.387" class="difflineplus">+         if (nextSym == EOB) break;</span>
<a href="#l14.388"></a><span id="l14.388" class="difflineplus">+</span>
<a href="#l14.389"></a><span id="l14.389" class="difflineplus">+         if (nextSym == BZ_RUNA || nextSym == BZ_RUNB) {</span>
<a href="#l14.390"></a><span id="l14.390" class="difflineplus">+</span>
<a href="#l14.391"></a><span id="l14.391" class="difflineplus">+            es = -1;</span>
<a href="#l14.392"></a><span id="l14.392" class="difflineplus">+            N = 1;</span>
<a href="#l14.393"></a><span id="l14.393" class="difflineplus">+            do {</span>
<a href="#l14.394"></a><span id="l14.394" class="difflineplus">+               /* Check that N doesn't get too big, so that es doesn't</span>
<a href="#l14.395"></a><span id="l14.395" class="difflineplus">+                  go negative.  The maximum value that can be</span>
<a href="#l14.396"></a><span id="l14.396" class="difflineplus">+                  RUNA/RUNB encoded is equal to the block size (post</span>
<a href="#l14.397"></a><span id="l14.397" class="difflineplus">+                  the initial RLE), viz, 900k, so bounding N at 2</span>
<a href="#l14.398"></a><span id="l14.398" class="difflineplus">+                  million should guard against overflow without</span>
<a href="#l14.399"></a><span id="l14.399" class="difflineplus">+                  rejecting any legitimate inputs. */</span>
<a href="#l14.400"></a><span id="l14.400" class="difflineplus">+               if (N &gt;= 2*1024*1024) RETURN(BZ_DATA_ERROR);</span>
<a href="#l14.401"></a><span id="l14.401" class="difflineplus">+               if (nextSym == BZ_RUNA) es = es + (0+1) * N; else</span>
<a href="#l14.402"></a><span id="l14.402" class="difflineplus">+               if (nextSym == BZ_RUNB) es = es + (1+1) * N;</span>
<a href="#l14.403"></a><span id="l14.403" class="difflineplus">+               N = N * 2;</span>
<a href="#l14.404"></a><span id="l14.404" class="difflineplus">+               GET_MTF_VAL(BZ_X_MTF_3, BZ_X_MTF_4, nextSym);</span>
<a href="#l14.405"></a><span id="l14.405" class="difflineplus">+            }</span>
<a href="#l14.406"></a><span id="l14.406" class="difflineplus">+               while (nextSym == BZ_RUNA || nextSym == BZ_RUNB);</span>
<a href="#l14.407"></a><span id="l14.407" class="difflineplus">+</span>
<a href="#l14.408"></a><span id="l14.408" class="difflineplus">+            es++;</span>
<a href="#l14.409"></a><span id="l14.409" class="difflineplus">+            uc = s-&gt;seqToUnseq[ s-&gt;mtfa[s-&gt;mtfbase[0]] ];</span>
<a href="#l14.410"></a><span id="l14.410" class="difflineplus">+            s-&gt;unzftab[uc] += es;</span>
<a href="#l14.411"></a><span id="l14.411" class="difflineplus">+</span>
<a href="#l14.412"></a><span id="l14.412" class="difflineplus">+            if (s-&gt;smallDecompress)</span>
<a href="#l14.413"></a><span id="l14.413" class="difflineplus">+               while (es &gt; 0) {</span>
<a href="#l14.414"></a><span id="l14.414" class="difflineplus">+                  if (nblock &gt;= nblockMAX) RETURN(BZ_DATA_ERROR);</span>
<a href="#l14.415"></a><span id="l14.415" class="difflineplus">+                  s-&gt;ll16[nblock] = (UInt16)uc;</span>
<a href="#l14.416"></a><span id="l14.416" class="difflineplus">+                  nblock++;</span>
<a href="#l14.417"></a><span id="l14.417" class="difflineplus">+                  es--;</span>
<a href="#l14.418"></a><span id="l14.418" class="difflineplus">+               }</span>
<a href="#l14.419"></a><span id="l14.419" class="difflineplus">+            else</span>
<a href="#l14.420"></a><span id="l14.420" class="difflineplus">+               while (es &gt; 0) {</span>
<a href="#l14.421"></a><span id="l14.421" class="difflineplus">+                  if (nblock &gt;= nblockMAX) RETURN(BZ_DATA_ERROR);</span>
<a href="#l14.422"></a><span id="l14.422" class="difflineplus">+                  s-&gt;tt[nblock] = (UInt32)uc;</span>
<a href="#l14.423"></a><span id="l14.423" class="difflineplus">+                  nblock++;</span>
<a href="#l14.424"></a><span id="l14.424" class="difflineplus">+                  es--;</span>
<a href="#l14.425"></a><span id="l14.425" class="difflineplus">+               };</span>
<a href="#l14.426"></a><span id="l14.426" class="difflineplus">+</span>
<a href="#l14.427"></a><span id="l14.427" class="difflineplus">+            continue;</span>
<a href="#l14.428"></a><span id="l14.428" class="difflineplus">+</span>
<a href="#l14.429"></a><span id="l14.429" class="difflineplus">+         } else {</span>
<a href="#l14.430"></a><span id="l14.430" class="difflineplus">+</span>
<a href="#l14.431"></a><span id="l14.431" class="difflineplus">+            if (nblock &gt;= nblockMAX) RETURN(BZ_DATA_ERROR);</span>
<a href="#l14.432"></a><span id="l14.432" class="difflineplus">+</span>
<a href="#l14.433"></a><span id="l14.433" class="difflineplus">+            /*-- uc = MTF ( nextSym-1 ) --*/</span>
<a href="#l14.434"></a><span id="l14.434" class="difflineplus">+            {</span>
<a href="#l14.435"></a><span id="l14.435" class="difflineplus">+               Int32 ii, jj, kk, pp, lno, off;</span>
<a href="#l14.436"></a><span id="l14.436" class="difflineplus">+               UInt32 nn;</span>
<a href="#l14.437"></a><span id="l14.437" class="difflineplus">+               nn = (UInt32)(nextSym - 1);</span>
<a href="#l14.438"></a><span id="l14.438" class="difflineplus">+</span>
<a href="#l14.439"></a><span id="l14.439" class="difflineplus">+               if (nn &lt; MTFL_SIZE) {</span>
<a href="#l14.440"></a><span id="l14.440" class="difflineplus">+                  /* avoid general-case expense */</span>
<a href="#l14.441"></a><span id="l14.441" class="difflineplus">+                  pp = s-&gt;mtfbase[0];</span>
<a href="#l14.442"></a><span id="l14.442" class="difflineplus">+                  uc = s-&gt;mtfa[pp+nn];</span>
<a href="#l14.443"></a><span id="l14.443" class="difflineplus">+                  while (nn &gt; 3) {</span>
<a href="#l14.444"></a><span id="l14.444" class="difflineplus">+                     Int32 z = pp+nn;</span>
<a href="#l14.445"></a><span id="l14.445" class="difflineplus">+                     s-&gt;mtfa[(z)  ] = s-&gt;mtfa[(z)-1];</span>
<a href="#l14.446"></a><span id="l14.446" class="difflineplus">+                     s-&gt;mtfa[(z)-1] = s-&gt;mtfa[(z)-2];</span>
<a href="#l14.447"></a><span id="l14.447" class="difflineplus">+                     s-&gt;mtfa[(z)-2] = s-&gt;mtfa[(z)-3];</span>
<a href="#l14.448"></a><span id="l14.448" class="difflineplus">+                     s-&gt;mtfa[(z)-3] = s-&gt;mtfa[(z)-4];</span>
<a href="#l14.449"></a><span id="l14.449" class="difflineplus">+                     nn -= 4;</span>
<a href="#l14.450"></a><span id="l14.450" class="difflineplus">+                  }</span>
<a href="#l14.451"></a><span id="l14.451" class="difflineplus">+                  while (nn &gt; 0) { </span>
<a href="#l14.452"></a><span id="l14.452" class="difflineplus">+                     s-&gt;mtfa[(pp+nn)] = s-&gt;mtfa[(pp+nn)-1]; nn--; </span>
<a href="#l14.453"></a><span id="l14.453" class="difflineplus">+                  };</span>
<a href="#l14.454"></a><span id="l14.454" class="difflineplus">+                  s-&gt;mtfa[pp] = uc;</span>
<a href="#l14.455"></a><span id="l14.455" class="difflineplus">+               } else { </span>
<a href="#l14.456"></a><span id="l14.456" class="difflineplus">+                  /* general case */</span>
<a href="#l14.457"></a><span id="l14.457" class="difflineplus">+                  lno = nn / MTFL_SIZE;</span>
<a href="#l14.458"></a><span id="l14.458" class="difflineplus">+                  off = nn % MTFL_SIZE;</span>
<a href="#l14.459"></a><span id="l14.459" class="difflineplus">+                  pp = s-&gt;mtfbase[lno] + off;</span>
<a href="#l14.460"></a><span id="l14.460" class="difflineplus">+                  uc = s-&gt;mtfa[pp];</span>
<a href="#l14.461"></a><span id="l14.461" class="difflineplus">+                  while (pp &gt; s-&gt;mtfbase[lno]) { </span>
<a href="#l14.462"></a><span id="l14.462" class="difflineplus">+                     s-&gt;mtfa[pp] = s-&gt;mtfa[pp-1]; pp--; </span>
<a href="#l14.463"></a><span id="l14.463" class="difflineplus">+                  };</span>
<a href="#l14.464"></a><span id="l14.464" class="difflineplus">+                  s-&gt;mtfbase[lno]++;</span>
<a href="#l14.465"></a><span id="l14.465" class="difflineplus">+                  while (lno &gt; 0) {</span>
<a href="#l14.466"></a><span id="l14.466" class="difflineplus">+                     s-&gt;mtfbase[lno]--;</span>
<a href="#l14.467"></a><span id="l14.467" class="difflineplus">+                     s-&gt;mtfa[s-&gt;mtfbase[lno]] </span>
<a href="#l14.468"></a><span id="l14.468" class="difflineplus">+                        = s-&gt;mtfa[s-&gt;mtfbase[lno-1] + MTFL_SIZE - 1];</span>
<a href="#l14.469"></a><span id="l14.469" class="difflineplus">+                     lno--;</span>
<a href="#l14.470"></a><span id="l14.470" class="difflineplus">+                  }</span>
<a href="#l14.471"></a><span id="l14.471" class="difflineplus">+                  s-&gt;mtfbase[0]--;</span>
<a href="#l14.472"></a><span id="l14.472" class="difflineplus">+                  s-&gt;mtfa[s-&gt;mtfbase[0]] = uc;</span>
<a href="#l14.473"></a><span id="l14.473" class="difflineplus">+                  if (s-&gt;mtfbase[0] == 0) {</span>
<a href="#l14.474"></a><span id="l14.474" class="difflineplus">+                     kk = MTFA_SIZE-1;</span>
<a href="#l14.475"></a><span id="l14.475" class="difflineplus">+                     for (ii = 256 / MTFL_SIZE-1; ii &gt;= 0; ii--) {</span>
<a href="#l14.476"></a><span id="l14.476" class="difflineplus">+                        for (jj = MTFL_SIZE-1; jj &gt;= 0; jj--) {</span>
<a href="#l14.477"></a><span id="l14.477" class="difflineplus">+                           s-&gt;mtfa[kk] = s-&gt;mtfa[s-&gt;mtfbase[ii] + jj];</span>
<a href="#l14.478"></a><span id="l14.478" class="difflineplus">+                           kk--;</span>
<a href="#l14.479"></a><span id="l14.479" class="difflineplus">+                        }</span>
<a href="#l14.480"></a><span id="l14.480" class="difflineplus">+                        s-&gt;mtfbase[ii] = kk + 1;</span>
<a href="#l14.481"></a><span id="l14.481" class="difflineplus">+                     }</span>
<a href="#l14.482"></a><span id="l14.482" class="difflineplus">+                  }</span>
<a href="#l14.483"></a><span id="l14.483" class="difflineplus">+               }</span>
<a href="#l14.484"></a><span id="l14.484" class="difflineplus">+            }</span>
<a href="#l14.485"></a><span id="l14.485" class="difflineplus">+            /*-- end uc = MTF ( nextSym-1 ) --*/</span>
<a href="#l14.486"></a><span id="l14.486" class="difflineplus">+</span>
<a href="#l14.487"></a><span id="l14.487" class="difflineplus">+            s-&gt;unzftab[s-&gt;seqToUnseq[uc]]++;</span>
<a href="#l14.488"></a><span id="l14.488" class="difflineplus">+            if (s-&gt;smallDecompress)</span>
<a href="#l14.489"></a><span id="l14.489" class="difflineplus">+               s-&gt;ll16[nblock] = (UInt16)(s-&gt;seqToUnseq[uc]); else</span>
<a href="#l14.490"></a><span id="l14.490" class="difflineplus">+               s-&gt;tt[nblock]   = (UInt32)(s-&gt;seqToUnseq[uc]);</span>
<a href="#l14.491"></a><span id="l14.491" class="difflineplus">+            nblock++;</span>
<a href="#l14.492"></a><span id="l14.492" class="difflineplus">+</span>
<a href="#l14.493"></a><span id="l14.493" class="difflineplus">+            GET_MTF_VAL(BZ_X_MTF_5, BZ_X_MTF_6, nextSym);</span>
<a href="#l14.494"></a><span id="l14.494" class="difflineplus">+            continue;</span>
<a href="#l14.495"></a><span id="l14.495" class="difflineplus">+         }</span>
<a href="#l14.496"></a><span id="l14.496" class="difflineplus">+      }</span>
<a href="#l14.497"></a><span id="l14.497" class="difflineplus">+</span>
<a href="#l14.498"></a><span id="l14.498" class="difflineplus">+      /* Now we know what nblock is, we can do a better sanity</span>
<a href="#l14.499"></a><span id="l14.499" class="difflineplus">+         check on s-&gt;origPtr.</span>
<a href="#l14.500"></a><span id="l14.500" class="difflineplus">+      */</span>
<a href="#l14.501"></a><span id="l14.501" class="difflineplus">+      if (s-&gt;origPtr &lt; 0 || s-&gt;origPtr &gt;= nblock)</span>
<a href="#l14.502"></a><span id="l14.502" class="difflineplus">+         RETURN(BZ_DATA_ERROR);</span>
<a href="#l14.503"></a><span id="l14.503" class="difflineplus">+</span>
<a href="#l14.504"></a><span id="l14.504" class="difflineplus">+      /*-- Set up cftab to facilitate generation of T^(-1) --*/</span>
<a href="#l14.505"></a><span id="l14.505" class="difflineplus">+      /* Check: unzftab entries in range. */</span>
<a href="#l14.506"></a><span id="l14.506" class="difflineplus">+      for (i = 0; i &lt;= 255; i++) {</span>
<a href="#l14.507"></a><span id="l14.507" class="difflineplus">+         if (s-&gt;unzftab[i] &lt; 0 || s-&gt;unzftab[i] &gt; nblock)</span>
<a href="#l14.508"></a><span id="l14.508" class="difflineplus">+            RETURN(BZ_DATA_ERROR);</span>
<a href="#l14.509"></a><span id="l14.509" class="difflineplus">+      }</span>
<a href="#l14.510"></a><span id="l14.510" class="difflineplus">+      /* Actually generate cftab. */</span>
<a href="#l14.511"></a><span id="l14.511" class="difflineplus">+      s-&gt;cftab[0] = 0;</span>
<a href="#l14.512"></a><span id="l14.512" class="difflineplus">+      for (i = 1; i &lt;= 256; i++) s-&gt;cftab[i] = s-&gt;unzftab[i-1];</span>
<a href="#l14.513"></a><span id="l14.513" class="difflineplus">+      for (i = 1; i &lt;= 256; i++) s-&gt;cftab[i] += s-&gt;cftab[i-1];</span>
<a href="#l14.514"></a><span id="l14.514" class="difflineplus">+      /* Check: cftab entries in range. */</span>
<a href="#l14.515"></a><span id="l14.515" class="difflineplus">+      for (i = 0; i &lt;= 256; i++) {</span>
<a href="#l14.516"></a><span id="l14.516" class="difflineplus">+         if (s-&gt;cftab[i] &lt; 0 || s-&gt;cftab[i] &gt; nblock) {</span>
<a href="#l14.517"></a><span id="l14.517" class="difflineplus">+            /* s-&gt;cftab[i] can legitimately be == nblock */</span>
<a href="#l14.518"></a><span id="l14.518" class="difflineplus">+            RETURN(BZ_DATA_ERROR);</span>
<a href="#l14.519"></a><span id="l14.519" class="difflineplus">+         }</span>
<a href="#l14.520"></a><span id="l14.520" class="difflineplus">+      }</span>
<a href="#l14.521"></a><span id="l14.521" class="difflineplus">+      /* Check: cftab entries non-descending. */</span>
<a href="#l14.522"></a><span id="l14.522" class="difflineplus">+      for (i = 1; i &lt;= 256; i++) {</span>
<a href="#l14.523"></a><span id="l14.523" class="difflineplus">+         if (s-&gt;cftab[i-1] &gt; s-&gt;cftab[i]) {</span>
<a href="#l14.524"></a><span id="l14.524" class="difflineplus">+            RETURN(BZ_DATA_ERROR);</span>
<a href="#l14.525"></a><span id="l14.525" class="difflineplus">+         }</span>
<a href="#l14.526"></a><span id="l14.526" class="difflineplus">+      }</span>
<a href="#l14.527"></a><span id="l14.527" class="difflineplus">+</span>
<a href="#l14.528"></a><span id="l14.528" class="difflineplus">+      s-&gt;state_out_len = 0;</span>
<a href="#l14.529"></a><span id="l14.529" class="difflineplus">+      s-&gt;state_out_ch  = 0;</span>
<a href="#l14.530"></a><span id="l14.530" class="difflineplus">+      BZ_INITIALISE_CRC ( s-&gt;calculatedBlockCRC );</span>
<a href="#l14.531"></a><span id="l14.531" class="difflineplus">+      s-&gt;state = BZ_X_OUTPUT;</span>
<a href="#l14.532"></a><span id="l14.532" class="difflineplus">+      if (s-&gt;verbosity &gt;= 2) VPrintf0 ( &quot;rt+rld&quot; );</span>
<a href="#l14.533"></a><span id="l14.533" class="difflineplus">+</span>
<a href="#l14.534"></a><span id="l14.534" class="difflineplus">+      if (s-&gt;smallDecompress) {</span>
<a href="#l14.535"></a><span id="l14.535" class="difflineplus">+</span>
<a href="#l14.536"></a><span id="l14.536" class="difflineplus">+         /*-- Make a copy of cftab, used in generation of T --*/</span>
<a href="#l14.537"></a><span id="l14.537" class="difflineplus">+         for (i = 0; i &lt;= 256; i++) s-&gt;cftabCopy[i] = s-&gt;cftab[i];</span>
<a href="#l14.538"></a><span id="l14.538" class="difflineplus">+</span>
<a href="#l14.539"></a><span id="l14.539" class="difflineplus">+         /*-- compute the T vector --*/</span>
<a href="#l14.540"></a><span id="l14.540" class="difflineplus">+         for (i = 0; i &lt; nblock; i++) {</span>
<a href="#l14.541"></a><span id="l14.541" class="difflineplus">+            uc = (UChar)(s-&gt;ll16[i]);</span>
<a href="#l14.542"></a><span id="l14.542" class="difflineplus">+            SET_LL(i, s-&gt;cftabCopy[uc]);</span>
<a href="#l14.543"></a><span id="l14.543" class="difflineplus">+            s-&gt;cftabCopy[uc]++;</span>
<a href="#l14.544"></a><span id="l14.544" class="difflineplus">+         }</span>
<a href="#l14.545"></a><span id="l14.545" class="difflineplus">+</span>
<a href="#l14.546"></a><span id="l14.546" class="difflineplus">+         /*-- Compute T^(-1) by pointer reversal on T --*/</span>
<a href="#l14.547"></a><span id="l14.547" class="difflineplus">+         i = s-&gt;origPtr;</span>
<a href="#l14.548"></a><span id="l14.548" class="difflineplus">+         j = GET_LL(i);</span>
<a href="#l14.549"></a><span id="l14.549" class="difflineplus">+         do {</span>
<a href="#l14.550"></a><span id="l14.550" class="difflineplus">+            Int32 tmp = GET_LL(j);</span>
<a href="#l14.551"></a><span id="l14.551" class="difflineplus">+            SET_LL(j, i);</span>
<a href="#l14.552"></a><span id="l14.552" class="difflineplus">+            i = j;</span>
<a href="#l14.553"></a><span id="l14.553" class="difflineplus">+            j = tmp;</span>
<a href="#l14.554"></a><span id="l14.554" class="difflineplus">+         }</span>
<a href="#l14.555"></a><span id="l14.555" class="difflineplus">+            while (i != s-&gt;origPtr);</span>
<a href="#l14.556"></a><span id="l14.556" class="difflineplus">+</span>
<a href="#l14.557"></a><span id="l14.557" class="difflineplus">+         s-&gt;tPos = s-&gt;origPtr;</span>
<a href="#l14.558"></a><span id="l14.558" class="difflineplus">+         s-&gt;nblock_used = 0;</span>
<a href="#l14.559"></a><span id="l14.559" class="difflineplus">+         if (s-&gt;blockRandomised) {</span>
<a href="#l14.560"></a><span id="l14.560" class="difflineplus">+            BZ_RAND_INIT_MASK;</span>
<a href="#l14.561"></a><span id="l14.561" class="difflineplus">+            BZ_GET_SMALL(s-&gt;k0); s-&gt;nblock_used++;</span>
<a href="#l14.562"></a><span id="l14.562" class="difflineplus">+            BZ_RAND_UPD_MASK; s-&gt;k0 ^= BZ_RAND_MASK; </span>
<a href="#l14.563"></a><span id="l14.563" class="difflineplus">+         } else {</span>
<a href="#l14.564"></a><span id="l14.564" class="difflineplus">+            BZ_GET_SMALL(s-&gt;k0); s-&gt;nblock_used++;</span>
<a href="#l14.565"></a><span id="l14.565" class="difflineplus">+         }</span>
<a href="#l14.566"></a><span id="l14.566" class="difflineplus">+</span>
<a href="#l14.567"></a><span id="l14.567" class="difflineplus">+      } else {</span>
<a href="#l14.568"></a><span id="l14.568" class="difflineplus">+</span>
<a href="#l14.569"></a><span id="l14.569" class="difflineplus">+         /*-- compute the T^(-1) vector --*/</span>
<a href="#l14.570"></a><span id="l14.570" class="difflineplus">+         for (i = 0; i &lt; nblock; i++) {</span>
<a href="#l14.571"></a><span id="l14.571" class="difflineplus">+            uc = (UChar)(s-&gt;tt[i] &amp; 0xff);</span>
<a href="#l14.572"></a><span id="l14.572" class="difflineplus">+            s-&gt;tt[s-&gt;cftab[uc]] |= (i &lt;&lt; 8);</span>
<a href="#l14.573"></a><span id="l14.573" class="difflineplus">+            s-&gt;cftab[uc]++;</span>
<a href="#l14.574"></a><span id="l14.574" class="difflineplus">+         }</span>
<a href="#l14.575"></a><span id="l14.575" class="difflineplus">+</span>
<a href="#l14.576"></a><span id="l14.576" class="difflineplus">+         s-&gt;tPos = s-&gt;tt[s-&gt;origPtr] &gt;&gt; 8;</span>
<a href="#l14.577"></a><span id="l14.577" class="difflineplus">+         s-&gt;nblock_used = 0;</span>
<a href="#l14.578"></a><span id="l14.578" class="difflineplus">+         if (s-&gt;blockRandomised) {</span>
<a href="#l14.579"></a><span id="l14.579" class="difflineplus">+            BZ_RAND_INIT_MASK;</span>
<a href="#l14.580"></a><span id="l14.580" class="difflineplus">+            BZ_GET_FAST(s-&gt;k0); s-&gt;nblock_used++;</span>
<a href="#l14.581"></a><span id="l14.581" class="difflineplus">+            BZ_RAND_UPD_MASK; s-&gt;k0 ^= BZ_RAND_MASK; </span>
<a href="#l14.582"></a><span id="l14.582" class="difflineplus">+         } else {</span>
<a href="#l14.583"></a><span id="l14.583" class="difflineplus">+            BZ_GET_FAST(s-&gt;k0); s-&gt;nblock_used++;</span>
<a href="#l14.584"></a><span id="l14.584" class="difflineplus">+         }</span>
<a href="#l14.585"></a><span id="l14.585" class="difflineplus">+</span>
<a href="#l14.586"></a><span id="l14.586" class="difflineplus">+      }</span>
<a href="#l14.587"></a><span id="l14.587" class="difflineplus">+</span>
<a href="#l14.588"></a><span id="l14.588" class="difflineplus">+      RETURN(BZ_OK);</span>
<a href="#l14.589"></a><span id="l14.589" class="difflineplus">+</span>
<a href="#l14.590"></a><span id="l14.590" class="difflineplus">+</span>
<a href="#l14.591"></a><span id="l14.591" class="difflineplus">+</span>
<a href="#l14.592"></a><span id="l14.592" class="difflineplus">+    endhdr_2:</span>
<a href="#l14.593"></a><span id="l14.593" class="difflineplus">+</span>
<a href="#l14.594"></a><span id="l14.594" class="difflineplus">+      GET_UCHAR(BZ_X_ENDHDR_2, uc);</span>
<a href="#l14.595"></a><span id="l14.595" class="difflineplus">+      if (uc != 0x72) RETURN(BZ_DATA_ERROR);</span>
<a href="#l14.596"></a><span id="l14.596" class="difflineplus">+      GET_UCHAR(BZ_X_ENDHDR_3, uc);</span>
<a href="#l14.597"></a><span id="l14.597" class="difflineplus">+      if (uc != 0x45) RETURN(BZ_DATA_ERROR);</span>
<a href="#l14.598"></a><span id="l14.598" class="difflineplus">+      GET_UCHAR(BZ_X_ENDHDR_4, uc);</span>
<a href="#l14.599"></a><span id="l14.599" class="difflineplus">+      if (uc != 0x38) RETURN(BZ_DATA_ERROR);</span>
<a href="#l14.600"></a><span id="l14.600" class="difflineplus">+      GET_UCHAR(BZ_X_ENDHDR_5, uc);</span>
<a href="#l14.601"></a><span id="l14.601" class="difflineplus">+      if (uc != 0x50) RETURN(BZ_DATA_ERROR);</span>
<a href="#l14.602"></a><span id="l14.602" class="difflineplus">+      GET_UCHAR(BZ_X_ENDHDR_6, uc);</span>
<a href="#l14.603"></a><span id="l14.603" class="difflineplus">+      if (uc != 0x90) RETURN(BZ_DATA_ERROR);</span>
<a href="#l14.604"></a><span id="l14.604" class="difflineplus">+</span>
<a href="#l14.605"></a><span id="l14.605" class="difflineplus">+      s-&gt;storedCombinedCRC = 0;</span>
<a href="#l14.606"></a><span id="l14.606" class="difflineplus">+      GET_UCHAR(BZ_X_CCRC_1, uc);</span>
<a href="#l14.607"></a><span id="l14.607" class="difflineplus">+      s-&gt;storedCombinedCRC = (s-&gt;storedCombinedCRC &lt;&lt; 8) | ((UInt32)uc);</span>
<a href="#l14.608"></a><span id="l14.608" class="difflineplus">+      GET_UCHAR(BZ_X_CCRC_2, uc);</span>
<a href="#l14.609"></a><span id="l14.609" class="difflineplus">+      s-&gt;storedCombinedCRC = (s-&gt;storedCombinedCRC &lt;&lt; 8) | ((UInt32)uc);</span>
<a href="#l14.610"></a><span id="l14.610" class="difflineplus">+      GET_UCHAR(BZ_X_CCRC_3, uc);</span>
<a href="#l14.611"></a><span id="l14.611" class="difflineplus">+      s-&gt;storedCombinedCRC = (s-&gt;storedCombinedCRC &lt;&lt; 8) | ((UInt32)uc);</span>
<a href="#l14.612"></a><span id="l14.612" class="difflineplus">+      GET_UCHAR(BZ_X_CCRC_4, uc);</span>
<a href="#l14.613"></a><span id="l14.613" class="difflineplus">+      s-&gt;storedCombinedCRC = (s-&gt;storedCombinedCRC &lt;&lt; 8) | ((UInt32)uc);</span>
<a href="#l14.614"></a><span id="l14.614" class="difflineplus">+</span>
<a href="#l14.615"></a><span id="l14.615" class="difflineplus">+      s-&gt;state = BZ_X_IDLE;</span>
<a href="#l14.616"></a><span id="l14.616" class="difflineplus">+      RETURN(BZ_STREAM_END);</span>
<a href="#l14.617"></a><span id="l14.617" class="difflineplus">+</span>
<a href="#l14.618"></a><span id="l14.618" class="difflineplus">+      default: AssertH ( False, 4001 );</span>
<a href="#l14.619"></a><span id="l14.619" class="difflineplus">+   }</span>
<a href="#l14.620"></a><span id="l14.620" class="difflineplus">+</span>
<a href="#l14.621"></a><span id="l14.621" class="difflineplus">+   AssertH ( False, 4002 );</span>
<a href="#l14.622"></a><span id="l14.622" class="difflineplus">+</span>
<a href="#l14.623"></a><span id="l14.623" class="difflineplus">+   save_state_and_return:</span>
<a href="#l14.624"></a><span id="l14.624" class="difflineplus">+</span>
<a href="#l14.625"></a><span id="l14.625" class="difflineplus">+   s-&gt;save_i           = i;</span>
<a href="#l14.626"></a><span id="l14.626" class="difflineplus">+   s-&gt;save_j           = j;</span>
<a href="#l14.627"></a><span id="l14.627" class="difflineplus">+   s-&gt;save_t           = t;</span>
<a href="#l14.628"></a><span id="l14.628" class="difflineplus">+   s-&gt;save_alphaSize   = alphaSize;</span>
<a href="#l14.629"></a><span id="l14.629" class="difflineplus">+   s-&gt;save_nGroups     = nGroups;</span>
<a href="#l14.630"></a><span id="l14.630" class="difflineplus">+   s-&gt;save_nSelectors  = nSelectors;</span>
<a href="#l14.631"></a><span id="l14.631" class="difflineplus">+   s-&gt;save_EOB         = EOB;</span>
<a href="#l14.632"></a><span id="l14.632" class="difflineplus">+   s-&gt;save_groupNo     = groupNo;</span>
<a href="#l14.633"></a><span id="l14.633" class="difflineplus">+   s-&gt;save_groupPos    = groupPos;</span>
<a href="#l14.634"></a><span id="l14.634" class="difflineplus">+   s-&gt;save_nextSym     = nextSym;</span>
<a href="#l14.635"></a><span id="l14.635" class="difflineplus">+   s-&gt;save_nblockMAX   = nblockMAX;</span>
<a href="#l14.636"></a><span id="l14.636" class="difflineplus">+   s-&gt;save_nblock      = nblock;</span>
<a href="#l14.637"></a><span id="l14.637" class="difflineplus">+   s-&gt;save_es          = es;</span>
<a href="#l14.638"></a><span id="l14.638" class="difflineplus">+   s-&gt;save_N           = N;</span>
<a href="#l14.639"></a><span id="l14.639" class="difflineplus">+   s-&gt;save_curr        = curr;</span>
<a href="#l14.640"></a><span id="l14.640" class="difflineplus">+   s-&gt;save_zt          = zt;</span>
<a href="#l14.641"></a><span id="l14.641" class="difflineplus">+   s-&gt;save_zn          = zn;</span>
<a href="#l14.642"></a><span id="l14.642" class="difflineplus">+   s-&gt;save_zvec        = zvec;</span>
<a href="#l14.643"></a><span id="l14.643" class="difflineplus">+   s-&gt;save_zj          = zj;</span>
<a href="#l14.644"></a><span id="l14.644" class="difflineplus">+   s-&gt;save_gSel        = gSel;</span>
<a href="#l14.645"></a><span id="l14.645" class="difflineplus">+   s-&gt;save_gMinlen     = gMinlen;</span>
<a href="#l14.646"></a><span id="l14.646" class="difflineplus">+   s-&gt;save_gLimit      = gLimit;</span>
<a href="#l14.647"></a><span id="l14.647" class="difflineplus">+   s-&gt;save_gBase       = gBase;</span>
<a href="#l14.648"></a><span id="l14.648" class="difflineplus">+   s-&gt;save_gPerm       = gPerm;</span>
<a href="#l14.649"></a><span id="l14.649" class="difflineplus">+</span>
<a href="#l14.650"></a><span id="l14.650" class="difflineplus">+   return retVal;   </span>
<a href="#l14.651"></a><span id="l14.651" class="difflineplus">+}</span>
<a href="#l14.652"></a><span id="l14.652" class="difflineplus">+</span>
<a href="#l14.653"></a><span id="l14.653" class="difflineplus">+</span>
<a href="#l14.654"></a><span id="l14.654" class="difflineplus">+/*-------------------------------------------------------------*/</span>
<a href="#l14.655"></a><span id="l14.655" class="difflineplus">+/*--- end                                      decompress.c ---*/</span>
<a href="#l14.656"></a><span id="l14.656" class="difflineplus">+/*-------------------------------------------------------------*/</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1">new file mode 100644</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineminus">--- /dev/null</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineplus">+++ b/third_party/bzip2/huffman.c</span>
<a href="#l15.4"></a><span id="l15.4" class="difflineat">@@ -0,0 +1,205 @@</span>
<a href="#l15.5"></a><span id="l15.5" class="difflineplus">+</span>
<a href="#l15.6"></a><span id="l15.6" class="difflineplus">+/*-------------------------------------------------------------*/</span>
<a href="#l15.7"></a><span id="l15.7" class="difflineplus">+/*--- Huffman coding low-level stuff                        ---*/</span>
<a href="#l15.8"></a><span id="l15.8" class="difflineplus">+/*---                                             huffman.c ---*/</span>
<a href="#l15.9"></a><span id="l15.9" class="difflineplus">+/*-------------------------------------------------------------*/</span>
<a href="#l15.10"></a><span id="l15.10" class="difflineplus">+</span>
<a href="#l15.11"></a><span id="l15.11" class="difflineplus">+/* ------------------------------------------------------------------</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineplus">+   This file is part of bzip2/libbzip2, a program and library for</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+   lossless, block-sorting data compression.</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineplus">+</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineplus">+   bzip2/libbzip2 version 1.0.8 of 13 July 2019</span>
<a href="#l15.16"></a><span id="l15.16" class="difflineplus">+   Copyright (C) 1996-2019 Julian Seward &lt;jseward@acm.org&gt;</span>
<a href="#l15.17"></a><span id="l15.17" class="difflineplus">+</span>
<a href="#l15.18"></a><span id="l15.18" class="difflineplus">+   Please read the WARNING, DISCLAIMER and PATENTS sections in the </span>
<a href="#l15.19"></a><span id="l15.19" class="difflineplus">+   README file.</span>
<a href="#l15.20"></a><span id="l15.20" class="difflineplus">+</span>
<a href="#l15.21"></a><span id="l15.21" class="difflineplus">+   This program is released under the terms of the license contained</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineplus">+   in the file LICENSE.</span>
<a href="#l15.23"></a><span id="l15.23" class="difflineplus">+   ------------------------------------------------------------------ */</span>
<a href="#l15.24"></a><span id="l15.24" class="difflineplus">+</span>
<a href="#l15.25"></a><span id="l15.25" class="difflineplus">+</span>
<a href="#l15.26"></a><span id="l15.26" class="difflineplus">+#include &quot;bzlib_private.h&quot;</span>
<a href="#l15.27"></a><span id="l15.27" class="difflineplus">+</span>
<a href="#l15.28"></a><span id="l15.28" class="difflineplus">+/*---------------------------------------------------*/</span>
<a href="#l15.29"></a><span id="l15.29" class="difflineplus">+#define WEIGHTOF(zz0)  ((zz0) &amp; 0xffffff00)</span>
<a href="#l15.30"></a><span id="l15.30" class="difflineplus">+#define DEPTHOF(zz1)   ((zz1) &amp; 0x000000ff)</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineplus">+#define MYMAX(zz2,zz3) ((zz2) &gt; (zz3) ? (zz2) : (zz3))</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineplus">+</span>
<a href="#l15.33"></a><span id="l15.33" class="difflineplus">+#define ADDWEIGHTS(zw1,zw2)                           \</span>
<a href="#l15.34"></a><span id="l15.34" class="difflineplus">+   (WEIGHTOF(zw1)+WEIGHTOF(zw2)) |                    \</span>
<a href="#l15.35"></a><span id="l15.35" class="difflineplus">+   (1 + MYMAX(DEPTHOF(zw1),DEPTHOF(zw2)))</span>
<a href="#l15.36"></a><span id="l15.36" class="difflineplus">+</span>
<a href="#l15.37"></a><span id="l15.37" class="difflineplus">+#define UPHEAP(z)                                     \</span>
<a href="#l15.38"></a><span id="l15.38" class="difflineplus">+{                                                     \</span>
<a href="#l15.39"></a><span id="l15.39" class="difflineplus">+   Int32 zz, tmp;                                     \</span>
<a href="#l15.40"></a><span id="l15.40" class="difflineplus">+   zz = z; tmp = heap[zz];                            \</span>
<a href="#l15.41"></a><span id="l15.41" class="difflineplus">+   while (weight[tmp] &lt; weight[heap[zz &gt;&gt; 1]]) {      \</span>
<a href="#l15.42"></a><span id="l15.42" class="difflineplus">+      heap[zz] = heap[zz &gt;&gt; 1];                       \</span>
<a href="#l15.43"></a><span id="l15.43" class="difflineplus">+      zz &gt;&gt;= 1;                                       \</span>
<a href="#l15.44"></a><span id="l15.44" class="difflineplus">+   }                                                  \</span>
<a href="#l15.45"></a><span id="l15.45" class="difflineplus">+   heap[zz] = tmp;                                    \</span>
<a href="#l15.46"></a><span id="l15.46" class="difflineplus">+}</span>
<a href="#l15.47"></a><span id="l15.47" class="difflineplus">+</span>
<a href="#l15.48"></a><span id="l15.48" class="difflineplus">+#define DOWNHEAP(z)                                   \</span>
<a href="#l15.49"></a><span id="l15.49" class="difflineplus">+{                                                     \</span>
<a href="#l15.50"></a><span id="l15.50" class="difflineplus">+   Int32 zz, yy, tmp;                                 \</span>
<a href="#l15.51"></a><span id="l15.51" class="difflineplus">+   zz = z; tmp = heap[zz];                            \</span>
<a href="#l15.52"></a><span id="l15.52" class="difflineplus">+   while (True) {                                     \</span>
<a href="#l15.53"></a><span id="l15.53" class="difflineplus">+      yy = zz &lt;&lt; 1;                                   \</span>
<a href="#l15.54"></a><span id="l15.54" class="difflineplus">+      if (yy &gt; nHeap) break;                          \</span>
<a href="#l15.55"></a><span id="l15.55" class="difflineplus">+      if (yy &lt; nHeap &amp;&amp;                               \</span>
<a href="#l15.56"></a><span id="l15.56" class="difflineplus">+          weight[heap[yy+1]] &lt; weight[heap[yy]])      \</span>
<a href="#l15.57"></a><span id="l15.57" class="difflineplus">+         yy++;                                        \</span>
<a href="#l15.58"></a><span id="l15.58" class="difflineplus">+      if (weight[tmp] &lt; weight[heap[yy]]) break;      \</span>
<a href="#l15.59"></a><span id="l15.59" class="difflineplus">+      heap[zz] = heap[yy];                            \</span>
<a href="#l15.60"></a><span id="l15.60" class="difflineplus">+      zz = yy;                                        \</span>
<a href="#l15.61"></a><span id="l15.61" class="difflineplus">+   }                                                  \</span>
<a href="#l15.62"></a><span id="l15.62" class="difflineplus">+   heap[zz] = tmp;                                    \</span>
<a href="#l15.63"></a><span id="l15.63" class="difflineplus">+}</span>
<a href="#l15.64"></a><span id="l15.64" class="difflineplus">+</span>
<a href="#l15.65"></a><span id="l15.65" class="difflineplus">+</span>
<a href="#l15.66"></a><span id="l15.66" class="difflineplus">+/*---------------------------------------------------*/</span>
<a href="#l15.67"></a><span id="l15.67" class="difflineplus">+void BZ2_hbMakeCodeLengths ( UChar *len, </span>
<a href="#l15.68"></a><span id="l15.68" class="difflineplus">+                             Int32 *freq,</span>
<a href="#l15.69"></a><span id="l15.69" class="difflineplus">+                             Int32 alphaSize,</span>
<a href="#l15.70"></a><span id="l15.70" class="difflineplus">+                             Int32 maxLen )</span>
<a href="#l15.71"></a><span id="l15.71" class="difflineplus">+{</span>
<a href="#l15.72"></a><span id="l15.72" class="difflineplus">+   /*--</span>
<a href="#l15.73"></a><span id="l15.73" class="difflineplus">+      Nodes and heap entries run from 1.  Entry 0</span>
<a href="#l15.74"></a><span id="l15.74" class="difflineplus">+      for both the heap and nodes is a sentinel.</span>
<a href="#l15.75"></a><span id="l15.75" class="difflineplus">+   --*/</span>
<a href="#l15.76"></a><span id="l15.76" class="difflineplus">+   Int32 nNodes, nHeap, n1, n2, i, j, k;</span>
<a href="#l15.77"></a><span id="l15.77" class="difflineplus">+   Bool  tooLong;</span>
<a href="#l15.78"></a><span id="l15.78" class="difflineplus">+</span>
<a href="#l15.79"></a><span id="l15.79" class="difflineplus">+   Int32 heap   [ BZ_MAX_ALPHA_SIZE + 2 ];</span>
<a href="#l15.80"></a><span id="l15.80" class="difflineplus">+   Int32 weight [ BZ_MAX_ALPHA_SIZE * 2 ];</span>
<a href="#l15.81"></a><span id="l15.81" class="difflineplus">+   Int32 parent [ BZ_MAX_ALPHA_SIZE * 2 ]; </span>
<a href="#l15.82"></a><span id="l15.82" class="difflineplus">+</span>
<a href="#l15.83"></a><span id="l15.83" class="difflineplus">+   for (i = 0; i &lt; alphaSize; i++)</span>
<a href="#l15.84"></a><span id="l15.84" class="difflineplus">+      weight[i+1] = (freq[i] == 0 ? 1 : freq[i]) &lt;&lt; 8;</span>
<a href="#l15.85"></a><span id="l15.85" class="difflineplus">+</span>
<a href="#l15.86"></a><span id="l15.86" class="difflineplus">+   while (True) {</span>
<a href="#l15.87"></a><span id="l15.87" class="difflineplus">+</span>
<a href="#l15.88"></a><span id="l15.88" class="difflineplus">+      nNodes = alphaSize;</span>
<a href="#l15.89"></a><span id="l15.89" class="difflineplus">+      nHeap = 0;</span>
<a href="#l15.90"></a><span id="l15.90" class="difflineplus">+</span>
<a href="#l15.91"></a><span id="l15.91" class="difflineplus">+      heap[0] = 0;</span>
<a href="#l15.92"></a><span id="l15.92" class="difflineplus">+      weight[0] = 0;</span>
<a href="#l15.93"></a><span id="l15.93" class="difflineplus">+      parent[0] = -2;</span>
<a href="#l15.94"></a><span id="l15.94" class="difflineplus">+</span>
<a href="#l15.95"></a><span id="l15.95" class="difflineplus">+      for (i = 1; i &lt;= alphaSize; i++) {</span>
<a href="#l15.96"></a><span id="l15.96" class="difflineplus">+         parent[i] = -1;</span>
<a href="#l15.97"></a><span id="l15.97" class="difflineplus">+         nHeap++;</span>
<a href="#l15.98"></a><span id="l15.98" class="difflineplus">+         heap[nHeap] = i;</span>
<a href="#l15.99"></a><span id="l15.99" class="difflineplus">+         UPHEAP(nHeap);</span>
<a href="#l15.100"></a><span id="l15.100" class="difflineplus">+      }</span>
<a href="#l15.101"></a><span id="l15.101" class="difflineplus">+</span>
<a href="#l15.102"></a><span id="l15.102" class="difflineplus">+      AssertH( nHeap &lt; (BZ_MAX_ALPHA_SIZE+2), 2001 );</span>
<a href="#l15.103"></a><span id="l15.103" class="difflineplus">+   </span>
<a href="#l15.104"></a><span id="l15.104" class="difflineplus">+      while (nHeap &gt; 1) {</span>
<a href="#l15.105"></a><span id="l15.105" class="difflineplus">+         n1 = heap[1]; heap[1] = heap[nHeap]; nHeap--; DOWNHEAP(1);</span>
<a href="#l15.106"></a><span id="l15.106" class="difflineplus">+         n2 = heap[1]; heap[1] = heap[nHeap]; nHeap--; DOWNHEAP(1);</span>
<a href="#l15.107"></a><span id="l15.107" class="difflineplus">+         nNodes++;</span>
<a href="#l15.108"></a><span id="l15.108" class="difflineplus">+         parent[n1] = parent[n2] = nNodes;</span>
<a href="#l15.109"></a><span id="l15.109" class="difflineplus">+         weight[nNodes] = ADDWEIGHTS(weight[n1], weight[n2]);</span>
<a href="#l15.110"></a><span id="l15.110" class="difflineplus">+         parent[nNodes] = -1;</span>
<a href="#l15.111"></a><span id="l15.111" class="difflineplus">+         nHeap++;</span>
<a href="#l15.112"></a><span id="l15.112" class="difflineplus">+         heap[nHeap] = nNodes;</span>
<a href="#l15.113"></a><span id="l15.113" class="difflineplus">+         UPHEAP(nHeap);</span>
<a href="#l15.114"></a><span id="l15.114" class="difflineplus">+      }</span>
<a href="#l15.115"></a><span id="l15.115" class="difflineplus">+</span>
<a href="#l15.116"></a><span id="l15.116" class="difflineplus">+      AssertH( nNodes &lt; (BZ_MAX_ALPHA_SIZE * 2), 2002 );</span>
<a href="#l15.117"></a><span id="l15.117" class="difflineplus">+</span>
<a href="#l15.118"></a><span id="l15.118" class="difflineplus">+      tooLong = False;</span>
<a href="#l15.119"></a><span id="l15.119" class="difflineplus">+      for (i = 1; i &lt;= alphaSize; i++) {</span>
<a href="#l15.120"></a><span id="l15.120" class="difflineplus">+         j = 0;</span>
<a href="#l15.121"></a><span id="l15.121" class="difflineplus">+         k = i;</span>
<a href="#l15.122"></a><span id="l15.122" class="difflineplus">+         while (parent[k] &gt;= 0) { k = parent[k]; j++; }</span>
<a href="#l15.123"></a><span id="l15.123" class="difflineplus">+         len[i-1] = j;</span>
<a href="#l15.124"></a><span id="l15.124" class="difflineplus">+         if (j &gt; maxLen) tooLong = True;</span>
<a href="#l15.125"></a><span id="l15.125" class="difflineplus">+      }</span>
<a href="#l15.126"></a><span id="l15.126" class="difflineplus">+      </span>
<a href="#l15.127"></a><span id="l15.127" class="difflineplus">+      if (! tooLong) break;</span>
<a href="#l15.128"></a><span id="l15.128" class="difflineplus">+</span>
<a href="#l15.129"></a><span id="l15.129" class="difflineplus">+      /* 17 Oct 04: keep-going condition for the following loop used</span>
<a href="#l15.130"></a><span id="l15.130" class="difflineplus">+         to be 'i &lt; alphaSize', which missed the last element,</span>
<a href="#l15.131"></a><span id="l15.131" class="difflineplus">+         theoretically leading to the possibility of the compressor</span>
<a href="#l15.132"></a><span id="l15.132" class="difflineplus">+         looping.  However, this count-scaling step is only needed if</span>
<a href="#l15.133"></a><span id="l15.133" class="difflineplus">+         one of the generated Huffman code words is longer than</span>
<a href="#l15.134"></a><span id="l15.134" class="difflineplus">+         maxLen, which up to and including version 1.0.2 was 20 bits,</span>
<a href="#l15.135"></a><span id="l15.135" class="difflineplus">+         which is extremely unlikely.  In version 1.0.3 maxLen was</span>
<a href="#l15.136"></a><span id="l15.136" class="difflineplus">+         changed to 17 bits, which has minimal effect on compression</span>
<a href="#l15.137"></a><span id="l15.137" class="difflineplus">+         ratio, but does mean this scaling step is used from time to</span>
<a href="#l15.138"></a><span id="l15.138" class="difflineplus">+         time, enough to verify that it works.</span>
<a href="#l15.139"></a><span id="l15.139" class="difflineplus">+</span>
<a href="#l15.140"></a><span id="l15.140" class="difflineplus">+         This means that bzip2-1.0.3 and later will only produce</span>
<a href="#l15.141"></a><span id="l15.141" class="difflineplus">+         Huffman codes with a maximum length of 17 bits.  However, in</span>
<a href="#l15.142"></a><span id="l15.142" class="difflineplus">+         order to preserve backwards compatibility with bitstreams</span>
<a href="#l15.143"></a><span id="l15.143" class="difflineplus">+         produced by versions pre-1.0.3, the decompressor must still</span>
<a href="#l15.144"></a><span id="l15.144" class="difflineplus">+         handle lengths of up to 20. */</span>
<a href="#l15.145"></a><span id="l15.145" class="difflineplus">+</span>
<a href="#l15.146"></a><span id="l15.146" class="difflineplus">+      for (i = 1; i &lt;= alphaSize; i++) {</span>
<a href="#l15.147"></a><span id="l15.147" class="difflineplus">+         j = weight[i] &gt;&gt; 8;</span>
<a href="#l15.148"></a><span id="l15.148" class="difflineplus">+         j = 1 + (j / 2);</span>
<a href="#l15.149"></a><span id="l15.149" class="difflineplus">+         weight[i] = j &lt;&lt; 8;</span>
<a href="#l15.150"></a><span id="l15.150" class="difflineplus">+      }</span>
<a href="#l15.151"></a><span id="l15.151" class="difflineplus">+   }</span>
<a href="#l15.152"></a><span id="l15.152" class="difflineplus">+}</span>
<a href="#l15.153"></a><span id="l15.153" class="difflineplus">+</span>
<a href="#l15.154"></a><span id="l15.154" class="difflineplus">+</span>
<a href="#l15.155"></a><span id="l15.155" class="difflineplus">+/*---------------------------------------------------*/</span>
<a href="#l15.156"></a><span id="l15.156" class="difflineplus">+void BZ2_hbAssignCodes ( Int32 *code,</span>
<a href="#l15.157"></a><span id="l15.157" class="difflineplus">+                         UChar *length,</span>
<a href="#l15.158"></a><span id="l15.158" class="difflineplus">+                         Int32 minLen,</span>
<a href="#l15.159"></a><span id="l15.159" class="difflineplus">+                         Int32 maxLen,</span>
<a href="#l15.160"></a><span id="l15.160" class="difflineplus">+                         Int32 alphaSize )</span>
<a href="#l15.161"></a><span id="l15.161" class="difflineplus">+{</span>
<a href="#l15.162"></a><span id="l15.162" class="difflineplus">+   Int32 n, vec, i;</span>
<a href="#l15.163"></a><span id="l15.163" class="difflineplus">+</span>
<a href="#l15.164"></a><span id="l15.164" class="difflineplus">+   vec = 0;</span>
<a href="#l15.165"></a><span id="l15.165" class="difflineplus">+   for (n = minLen; n &lt;= maxLen; n++) {</span>
<a href="#l15.166"></a><span id="l15.166" class="difflineplus">+      for (i = 0; i &lt; alphaSize; i++)</span>
<a href="#l15.167"></a><span id="l15.167" class="difflineplus">+         if (length[i] == n) { code[i] = vec; vec++; };</span>
<a href="#l15.168"></a><span id="l15.168" class="difflineplus">+      vec &lt;&lt;= 1;</span>
<a href="#l15.169"></a><span id="l15.169" class="difflineplus">+   }</span>
<a href="#l15.170"></a><span id="l15.170" class="difflineplus">+}</span>
<a href="#l15.171"></a><span id="l15.171" class="difflineplus">+</span>
<a href="#l15.172"></a><span id="l15.172" class="difflineplus">+</span>
<a href="#l15.173"></a><span id="l15.173" class="difflineplus">+/*---------------------------------------------------*/</span>
<a href="#l15.174"></a><span id="l15.174" class="difflineplus">+void BZ2_hbCreateDecodeTables ( Int32 *limit,</span>
<a href="#l15.175"></a><span id="l15.175" class="difflineplus">+                                Int32 *base,</span>
<a href="#l15.176"></a><span id="l15.176" class="difflineplus">+                                Int32 *perm,</span>
<a href="#l15.177"></a><span id="l15.177" class="difflineplus">+                                UChar *length,</span>
<a href="#l15.178"></a><span id="l15.178" class="difflineplus">+                                Int32 minLen,</span>
<a href="#l15.179"></a><span id="l15.179" class="difflineplus">+                                Int32 maxLen,</span>
<a href="#l15.180"></a><span id="l15.180" class="difflineplus">+                                Int32 alphaSize )</span>
<a href="#l15.181"></a><span id="l15.181" class="difflineplus">+{</span>
<a href="#l15.182"></a><span id="l15.182" class="difflineplus">+   Int32 pp, i, j, vec;</span>
<a href="#l15.183"></a><span id="l15.183" class="difflineplus">+</span>
<a href="#l15.184"></a><span id="l15.184" class="difflineplus">+   pp = 0;</span>
<a href="#l15.185"></a><span id="l15.185" class="difflineplus">+   for (i = minLen; i &lt;= maxLen; i++)</span>
<a href="#l15.186"></a><span id="l15.186" class="difflineplus">+      for (j = 0; j &lt; alphaSize; j++)</span>
<a href="#l15.187"></a><span id="l15.187" class="difflineplus">+         if (length[j] == i) { perm[pp] = j; pp++; };</span>
<a href="#l15.188"></a><span id="l15.188" class="difflineplus">+</span>
<a href="#l15.189"></a><span id="l15.189" class="difflineplus">+   for (i = 0; i &lt; BZ_MAX_CODE_LEN; i++) base[i] = 0;</span>
<a href="#l15.190"></a><span id="l15.190" class="difflineplus">+   for (i = 0; i &lt; alphaSize; i++) base[length[i]+1]++;</span>
<a href="#l15.191"></a><span id="l15.191" class="difflineplus">+</span>
<a href="#l15.192"></a><span id="l15.192" class="difflineplus">+   for (i = 1; i &lt; BZ_MAX_CODE_LEN; i++) base[i] += base[i-1];</span>
<a href="#l15.193"></a><span id="l15.193" class="difflineplus">+</span>
<a href="#l15.194"></a><span id="l15.194" class="difflineplus">+   for (i = 0; i &lt; BZ_MAX_CODE_LEN; i++) limit[i] = 0;</span>
<a href="#l15.195"></a><span id="l15.195" class="difflineplus">+   vec = 0;</span>
<a href="#l15.196"></a><span id="l15.196" class="difflineplus">+</span>
<a href="#l15.197"></a><span id="l15.197" class="difflineplus">+   for (i = minLen; i &lt;= maxLen; i++) {</span>
<a href="#l15.198"></a><span id="l15.198" class="difflineplus">+      vec += (base[i+1] - base[i]);</span>
<a href="#l15.199"></a><span id="l15.199" class="difflineplus">+      limit[i] = vec-1;</span>
<a href="#l15.200"></a><span id="l15.200" class="difflineplus">+      vec &lt;&lt;= 1;</span>
<a href="#l15.201"></a><span id="l15.201" class="difflineplus">+   }</span>
<a href="#l15.202"></a><span id="l15.202" class="difflineplus">+   for (i = minLen + 1; i &lt;= maxLen; i++)</span>
<a href="#l15.203"></a><span id="l15.203" class="difflineplus">+      base[i] = ((limit[i-1] + 1) &lt;&lt; 1) - base[i];</span>
<a href="#l15.204"></a><span id="l15.204" class="difflineplus">+}</span>
<a href="#l15.205"></a><span id="l15.205" class="difflineplus">+</span>
<a href="#l15.206"></a><span id="l15.206" class="difflineplus">+</span>
<a href="#l15.207"></a><span id="l15.207" class="difflineplus">+/*-------------------------------------------------------------*/</span>
<a href="#l15.208"></a><span id="l15.208" class="difflineplus">+/*--- end                                         huffman.c ---*/</span>
<a href="#l15.209"></a><span id="l15.209" class="difflineplus">+/*-------------------------------------------------------------*/</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1">new file mode 100644</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineminus">--- /dev/null</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineplus">+++ b/third_party/bzip2/randtable.c</span>
<a href="#l16.4"></a><span id="l16.4" class="difflineat">@@ -0,0 +1,84 @@</span>
<a href="#l16.5"></a><span id="l16.5" class="difflineplus">+</span>
<a href="#l16.6"></a><span id="l16.6" class="difflineplus">+/*-------------------------------------------------------------*/</span>
<a href="#l16.7"></a><span id="l16.7" class="difflineplus">+/*--- Table for randomising repetitive blocks               ---*/</span>
<a href="#l16.8"></a><span id="l16.8" class="difflineplus">+/*---                                           randtable.c ---*/</span>
<a href="#l16.9"></a><span id="l16.9" class="difflineplus">+/*-------------------------------------------------------------*/</span>
<a href="#l16.10"></a><span id="l16.10" class="difflineplus">+</span>
<a href="#l16.11"></a><span id="l16.11" class="difflineplus">+/* ------------------------------------------------------------------</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineplus">+   This file is part of bzip2/libbzip2, a program and library for</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+   lossless, block-sorting data compression.</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineplus">+</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineplus">+   bzip2/libbzip2 version 1.0.8 of 13 July 2019</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineplus">+   Copyright (C) 1996-2019 Julian Seward &lt;jseward@acm.org&gt;</span>
<a href="#l16.17"></a><span id="l16.17" class="difflineplus">+</span>
<a href="#l16.18"></a><span id="l16.18" class="difflineplus">+   Please read the WARNING, DISCLAIMER and PATENTS sections in the </span>
<a href="#l16.19"></a><span id="l16.19" class="difflineplus">+   README file.</span>
<a href="#l16.20"></a><span id="l16.20" class="difflineplus">+</span>
<a href="#l16.21"></a><span id="l16.21" class="difflineplus">+   This program is released under the terms of the license contained</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineplus">+   in the file LICENSE.</span>
<a href="#l16.23"></a><span id="l16.23" class="difflineplus">+   ------------------------------------------------------------------ */</span>
<a href="#l16.24"></a><span id="l16.24" class="difflineplus">+</span>
<a href="#l16.25"></a><span id="l16.25" class="difflineplus">+</span>
<a href="#l16.26"></a><span id="l16.26" class="difflineplus">+#include &quot;bzlib_private.h&quot;</span>
<a href="#l16.27"></a><span id="l16.27" class="difflineplus">+</span>
<a href="#l16.28"></a><span id="l16.28" class="difflineplus">+</span>
<a href="#l16.29"></a><span id="l16.29" class="difflineplus">+/*---------------------------------------------*/</span>
<a href="#l16.30"></a><span id="l16.30" class="difflineplus">+Int32 BZ2_rNums[512] = { </span>
<a href="#l16.31"></a><span id="l16.31" class="difflineplus">+   619, 720, 127, 481, 931, 816, 813, 233, 566, 247, </span>
<a href="#l16.32"></a><span id="l16.32" class="difflineplus">+   985, 724, 205, 454, 863, 491, 741, 242, 949, 214, </span>
<a href="#l16.33"></a><span id="l16.33" class="difflineplus">+   733, 859, 335, 708, 621, 574, 73, 654, 730, 472, </span>
<a href="#l16.34"></a><span id="l16.34" class="difflineplus">+   419, 436, 278, 496, 867, 210, 399, 680, 480, 51, </span>
<a href="#l16.35"></a><span id="l16.35" class="difflineplus">+   878, 465, 811, 169, 869, 675, 611, 697, 867, 561, </span>
<a href="#l16.36"></a><span id="l16.36" class="difflineplus">+   862, 687, 507, 283, 482, 129, 807, 591, 733, 623, </span>
<a href="#l16.37"></a><span id="l16.37" class="difflineplus">+   150, 238, 59, 379, 684, 877, 625, 169, 643, 105, </span>
<a href="#l16.38"></a><span id="l16.38" class="difflineplus">+   170, 607, 520, 932, 727, 476, 693, 425, 174, 647, </span>
<a href="#l16.39"></a><span id="l16.39" class="difflineplus">+   73, 122, 335, 530, 442, 853, 695, 249, 445, 515, </span>
<a href="#l16.40"></a><span id="l16.40" class="difflineplus">+   909, 545, 703, 919, 874, 474, 882, 500, 594, 612, </span>
<a href="#l16.41"></a><span id="l16.41" class="difflineplus">+   641, 801, 220, 162, 819, 984, 589, 513, 495, 799, </span>
<a href="#l16.42"></a><span id="l16.42" class="difflineplus">+   161, 604, 958, 533, 221, 400, 386, 867, 600, 782, </span>
<a href="#l16.43"></a><span id="l16.43" class="difflineplus">+   382, 596, 414, 171, 516, 375, 682, 485, 911, 276, </span>
<a href="#l16.44"></a><span id="l16.44" class="difflineplus">+   98, 553, 163, 354, 666, 933, 424, 341, 533, 870, </span>
<a href="#l16.45"></a><span id="l16.45" class="difflineplus">+   227, 730, 475, 186, 263, 647, 537, 686, 600, 224, </span>
<a href="#l16.46"></a><span id="l16.46" class="difflineplus">+   469, 68, 770, 919, 190, 373, 294, 822, 808, 206, </span>
<a href="#l16.47"></a><span id="l16.47" class="difflineplus">+   184, 943, 795, 384, 383, 461, 404, 758, 839, 887, </span>
<a href="#l16.48"></a><span id="l16.48" class="difflineplus">+   715, 67, 618, 276, 204, 918, 873, 777, 604, 560, </span>
<a href="#l16.49"></a><span id="l16.49" class="difflineplus">+   951, 160, 578, 722, 79, 804, 96, 409, 713, 940, </span>
<a href="#l16.50"></a><span id="l16.50" class="difflineplus">+   652, 934, 970, 447, 318, 353, 859, 672, 112, 785, </span>
<a href="#l16.51"></a><span id="l16.51" class="difflineplus">+   645, 863, 803, 350, 139, 93, 354, 99, 820, 908, </span>
<a href="#l16.52"></a><span id="l16.52" class="difflineplus">+   609, 772, 154, 274, 580, 184, 79, 626, 630, 742, </span>
<a href="#l16.53"></a><span id="l16.53" class="difflineplus">+   653, 282, 762, 623, 680, 81, 927, 626, 789, 125, </span>
<a href="#l16.54"></a><span id="l16.54" class="difflineplus">+   411, 521, 938, 300, 821, 78, 343, 175, 128, 250, </span>
<a href="#l16.55"></a><span id="l16.55" class="difflineplus">+   170, 774, 972, 275, 999, 639, 495, 78, 352, 126, </span>
<a href="#l16.56"></a><span id="l16.56" class="difflineplus">+   857, 956, 358, 619, 580, 124, 737, 594, 701, 612, </span>
<a href="#l16.57"></a><span id="l16.57" class="difflineplus">+   669, 112, 134, 694, 363, 992, 809, 743, 168, 974, </span>
<a href="#l16.58"></a><span id="l16.58" class="difflineplus">+   944, 375, 748, 52, 600, 747, 642, 182, 862, 81, </span>
<a href="#l16.59"></a><span id="l16.59" class="difflineplus">+   344, 805, 988, 739, 511, 655, 814, 334, 249, 515, </span>
<a href="#l16.60"></a><span id="l16.60" class="difflineplus">+   897, 955, 664, 981, 649, 113, 974, 459, 893, 228, </span>
<a href="#l16.61"></a><span id="l16.61" class="difflineplus">+   433, 837, 553, 268, 926, 240, 102, 654, 459, 51, </span>
<a href="#l16.62"></a><span id="l16.62" class="difflineplus">+   686, 754, 806, 760, 493, 403, 415, 394, 687, 700, </span>
<a href="#l16.63"></a><span id="l16.63" class="difflineplus">+   946, 670, 656, 610, 738, 392, 760, 799, 887, 653, </span>
<a href="#l16.64"></a><span id="l16.64" class="difflineplus">+   978, 321, 576, 617, 626, 502, 894, 679, 243, 440, </span>
<a href="#l16.65"></a><span id="l16.65" class="difflineplus">+   680, 879, 194, 572, 640, 724, 926, 56, 204, 700, </span>
<a href="#l16.66"></a><span id="l16.66" class="difflineplus">+   707, 151, 457, 449, 797, 195, 791, 558, 945, 679, </span>
<a href="#l16.67"></a><span id="l16.67" class="difflineplus">+   297, 59, 87, 824, 713, 663, 412, 693, 342, 606, </span>
<a href="#l16.68"></a><span id="l16.68" class="difflineplus">+   134, 108, 571, 364, 631, 212, 174, 643, 304, 329, </span>
<a href="#l16.69"></a><span id="l16.69" class="difflineplus">+   343, 97, 430, 751, 497, 314, 983, 374, 822, 928, </span>
<a href="#l16.70"></a><span id="l16.70" class="difflineplus">+   140, 206, 73, 263, 980, 736, 876, 478, 430, 305, </span>
<a href="#l16.71"></a><span id="l16.71" class="difflineplus">+   170, 514, 364, 692, 829, 82, 855, 953, 676, 246, </span>
<a href="#l16.72"></a><span id="l16.72" class="difflineplus">+   369, 970, 294, 750, 807, 827, 150, 790, 288, 923, </span>
<a href="#l16.73"></a><span id="l16.73" class="difflineplus">+   804, 378, 215, 828, 592, 281, 565, 555, 710, 82, </span>
<a href="#l16.74"></a><span id="l16.74" class="difflineplus">+   896, 831, 547, 261, 524, 462, 293, 465, 502, 56, </span>
<a href="#l16.75"></a><span id="l16.75" class="difflineplus">+   661, 821, 976, 991, 658, 869, 905, 758, 745, 193, </span>
<a href="#l16.76"></a><span id="l16.76" class="difflineplus">+   768, 550, 608, 933, 378, 286, 215, 979, 792, 961, </span>
<a href="#l16.77"></a><span id="l16.77" class="difflineplus">+   61, 688, 793, 644, 986, 403, 106, 366, 905, 644, </span>
<a href="#l16.78"></a><span id="l16.78" class="difflineplus">+   372, 567, 466, 434, 645, 210, 389, 550, 919, 135, </span>
<a href="#l16.79"></a><span id="l16.79" class="difflineplus">+   780, 773, 635, 389, 707, 100, 626, 958, 165, 504, </span>
<a href="#l16.80"></a><span id="l16.80" class="difflineplus">+   920, 176, 193, 713, 857, 265, 203, 50, 668, 108, </span>
<a href="#l16.81"></a><span id="l16.81" class="difflineplus">+   645, 990, 626, 197, 510, 357, 358, 850, 858, 364, </span>
<a href="#l16.82"></a><span id="l16.82" class="difflineplus">+   936, 638</span>
<a href="#l16.83"></a><span id="l16.83" class="difflineplus">+};</span>
<a href="#l16.84"></a><span id="l16.84" class="difflineplus">+</span>
<a href="#l16.85"></a><span id="l16.85" class="difflineplus">+</span>
<a href="#l16.86"></a><span id="l16.86" class="difflineplus">+/*-------------------------------------------------------------*/</span>
<a href="#l16.87"></a><span id="l16.87" class="difflineplus">+/*--- end                                       randtable.c ---*/</span>
<a href="#l16.88"></a><span id="l16.88" class="difflineplus">+/*-------------------------------------------------------------*/</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

