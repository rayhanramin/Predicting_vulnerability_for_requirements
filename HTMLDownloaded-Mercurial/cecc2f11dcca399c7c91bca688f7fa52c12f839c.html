<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 22967:cecc2f11dcca399c7c91bca688f7fa52c12f839c</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ cecc2f11dcca399c7c91bca688f7fa52c12f839c" />
<meta property="og:url" content="/comm-central/rev/cecc2f11dcca399c7c91bca688f7fa52c12f839c" />
<meta property="og:description" content="Bug 1345266 - Allow access to messages with no expected header. r=jorgk" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / cecc2f11dcca399c7c91bca688f7fa52c12f839c 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/cecc2f11dcca399c7c91bca688f7fa52c12f839c">shortlog</a> |
<a href="/comm-central/log/cecc2f11dcca399c7c91bca688f7fa52c12f839c">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/cecc2f11dcca399c7c91bca688f7fa52c12f839c">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/cecc2f11dcca399c7c91bca688f7fa52c12f839c">files</a> |
changeset |
<a href="/comm-central/raw-rev/cecc2f11dcca399c7c91bca688f7fa52c12f839c">raw</a>  | <a href="/comm-central/archive/cecc2f11dcca399c7c91bca688f7fa52c12f839c.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1345266">Bug 1345266</a> - Allow access to messages with no expected header. r=jorgk
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#71;&#101;&#110;&#101;&#32;&#83;&#109;&#105;&#116;&#104;&#32;&#60;&#103;&#100;&#115;&#64;&#99;&#104;&#97;&#114;&#116;&#101;&#114;&#116;&#110;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 01 Jan 2018 22:47:53 -0500</td></tr>

<tr>
 <td>changeset 22967</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/cecc2f11dcca399c7c91bca688f7fa52c12f839c">cecc2f11dcca399c7c91bca688f7fa52c12f839c</a></td>
</tr>



<tr>
<td>parent 22966</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/25e260b9958157daed1021916711bab304b73938">25e260b9958157daed1021916711bab304b73938</a>
</td>
</tr>

<tr>
<td>child 22968</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/726cc3c0baf21c0e6e351cb6950412b039b55991">726cc3c0baf21c0e6e351cb6950412b039b55991</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=cecc2f11dcca399c7c91bca688f7fa52c12f839c">13902</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Tue, 02 Jan 2018 22:36:07 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@726cc3c0baf2 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=726cc3c0baf21c0e6e351cb6950412b039b55991">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=726cc3c0baf21c0e6e351cb6950412b039b55991&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=726cc3c0baf21c0e6e351cb6950412b039b55991&newProject=comm-central&newRevision=25e260b9958157daed1021916711bab304b73938&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=726cc3c0baf21c0e6e351cb6950412b039b55991&newProject=comm-central&newRevision=25e260b9958157daed1021916711bab304b73938&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=726cc3c0baf21c0e6e351cb6950412b039b55991&newProject=comm-central&newRevision=25e260b9958157daed1021916711bab304b73938&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28jorgk%29&revcount=50">jorgk</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1345266">1345266</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1345266">Bug 1345266</a> - Allow access to messages with no expected header. r=jorgk
Currently messages with no header from an expected set of headers
remain invisible in Thunderbird and can't be read or even deleted.
They are accessible in other email apps (e.g. on Android).</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cecc2f11dcca399c7c91bca688f7fa52c12f839c/mailnews/local/src/nsParseMailbox.cpp">mailnews/local/src/nsParseMailbox.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cecc2f11dcca399c7c91bca688f7fa52c12f839c/mailnews/local/src/nsParseMailbox.cpp">file</a> |
<a href="/comm-central/annotate/cecc2f11dcca399c7c91bca688f7fa52c12f839c/mailnews/local/src/nsParseMailbox.cpp">annotate</a> |
<a href="/comm-central/diff/cecc2f11dcca399c7c91bca688f7fa52c12f839c/mailnews/local/src/nsParseMailbox.cpp">diff</a> |
<a href="/comm-central/comparison/cecc2f11dcca399c7c91bca688f7fa52c12f839c/mailnews/local/src/nsParseMailbox.cpp">comparison</a> |
<a href="/comm-central/log/cecc2f11dcca399c7c91bca688f7fa52c12f839c/mailnews/local/src/nsParseMailbox.cpp">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/local/src/nsParseMailbox.cpp</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/local/src/nsParseMailbox.cpp</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -932,16 +932,22 @@ nsresult nsParseMailMessageState::StartN</span>
<a href="#l1.4"></a><span id="l1.4"> }</span>
<a href="#l1.5"></a><span id="l1.5"> </span>
<a href="#l1.6"></a><span id="l1.6"> /* largely lifted from mimehtml.c, which does similar parsing, sigh...</span>
<a href="#l1.7"></a><span id="l1.7"> */</span>
<a href="#l1.8"></a><span id="l1.8"> nsresult nsParseMailMessageState::ParseHeaders ()</span>
<a href="#l1.9"></a><span id="l1.9"> {</span>
<a href="#l1.10"></a><span id="l1.10">   char *buf = m_headers.GetBuffer();</span>
<a href="#l1.11"></a><span id="l1.11">   uint32_t buf_length = m_headers.GetBufferPos();</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+  if (buf_length == 0)</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+  {</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+    // No header of an expected type is present. Consider this a successful</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+    // parse so email still shows on summary and can be accessed and deleted.</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+    return NS_OK;</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+  }</span>
<a href="#l1.18"></a><span id="l1.18">   char *buf_end = buf + buf_length;</span>
<a href="#l1.19"></a><span id="l1.19">   if (!(buf_length &gt; 1 &amp;&amp; (buf[buf_length - 1] == '\r' ||</span>
<a href="#l1.20"></a><span id="l1.20">         buf[buf_length - 1] == '\n')))</span>
<a href="#l1.21"></a><span id="l1.21">   {</span>
<a href="#l1.22"></a><span id="l1.22">     NS_WARNING(&quot;Header text should always end in a newline&quot;);</span>
<a href="#l1.23"></a><span id="l1.23">     return NS_ERROR_UNEXPECTED;</span>
<a href="#l1.24"></a><span id="l1.24">   }</span>
<a href="#l1.25"></a><span id="l1.25">   while (buf &lt; buf_end)</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

