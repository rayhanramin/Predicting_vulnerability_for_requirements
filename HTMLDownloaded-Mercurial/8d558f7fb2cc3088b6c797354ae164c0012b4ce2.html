<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 28323:8d558f7fb2cc3088b6c797354ae164c0012b4ce2</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 8d558f7fb2cc3088b6c797354ae164c0012b4ce2" />
<meta property="og:url" content="/comm-central/rev/8d558f7fb2cc3088b6c797354ae164c0012b4ce2" />
<meta property="og:description" content="Bug 1562313 - Convert javascript components from chat to static registration. r=mkmelin DONTBUILD" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 8d558f7fb2cc3088b6c797354ae164c0012b4ce2 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/8d558f7fb2cc3088b6c797354ae164c0012b4ce2">shortlog</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/8d558f7fb2cc3088b6c797354ae164c0012b4ce2">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/8d558f7fb2cc3088b6c797354ae164c0012b4ce2">files</a> |
changeset |
<a href="/comm-central/raw-rev/8d558f7fb2cc3088b6c797354ae164c0012b4ce2">raw</a>  | <a href="/comm-central/archive/8d558f7fb2cc3088b6c797354ae164c0012b4ce2.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1562313">Bug 1562313</a> - Convert javascript components from chat to static registration. r=mkmelin DONTBUILD
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#75;&#104;&#117;&#115;&#104;&#105;&#108;&#32;&#77;&#105;&#115;&#116;&#114;&#121;&#32;&#60;&#107;&#104;&#117;&#115;&#104;&#105;&#108;&#51;&#50;&#52;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 05 Dec 2019 21:52:12 +1300</td></tr>

<tr>
 <td>changeset 28323</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/8d558f7fb2cc3088b6c797354ae164c0012b4ce2">8d558f7fb2cc3088b6c797354ae164c0012b4ce2</a></td>
</tr>



<tr>
<td>parent 28322</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/bb6662974cc867216a07f63c510de8d8914ea49f">bb6662974cc867216a07f63c510de8d8914ea49f</a>
</td>
</tr>

<tr>
<td>child 28324</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/98d3639a346e8049888368e789e56c58f6273153">98d3639a346e8049888368e789e56c58f6273153</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=8d558f7fb2cc3088b6c797354ae164c0012b4ce2">16770</a></td></tr>
<tr><td>push user</td><td>geoff@darktrojan.net</td></tr>
<tr><td>push date</td><td class="date age">Thu, 05 Dec 2019 08:54:28 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@8d558f7fb2cc [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=8d558f7fb2cc3088b6c797354ae164c0012b4ce2">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=8d558f7fb2cc3088b6c797354ae164c0012b4ce2&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=8d558f7fb2cc3088b6c797354ae164c0012b4ce2&newProject=comm-central&newRevision=a7069acd686b0791d32f45948c43308d8f7fa968&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=8d558f7fb2cc3088b6c797354ae164c0012b4ce2&newProject=comm-central&newRevision=a7069acd686b0791d32f45948c43308d8f7fa968&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=8d558f7fb2cc3088b6c797354ae164c0012b4ce2&newProject=comm-central&newRevision=a7069acd686b0791d32f45948c43308d8f7fa968&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mkmelin%29&revcount=50">mkmelin</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1562313">1562313</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1562313">Bug 1562313</a> - Convert javascript components from chat to static registration. r=mkmelin DONTBUILD</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/components.conf">chat/components/src/components.conf</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/components.conf">file</a> |
<a href="/comm-central/annotate/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/components.conf">annotate</a> |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/components.conf">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/components.conf">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/components.conf">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/imAccounts.js">chat/components/src/imAccounts.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/imAccounts.js">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/imAccounts.js">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/imAccounts.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/imAccounts.jsm">chat/components/src/imAccounts.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/imAccounts.jsm">file</a> |
<a href="/comm-central/annotate/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/imAccounts.jsm">annotate</a> |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/imAccounts.jsm">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/imAccounts.jsm">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/imAccounts.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/imAccounts.manifest">chat/components/src/imAccounts.manifest</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/imAccounts.manifest">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/imAccounts.manifest">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/imAccounts.manifest">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/imCommands.js">chat/components/src/imCommands.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/imCommands.js">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/imCommands.js">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/imCommands.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/imCommands.jsm">chat/components/src/imCommands.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/imCommands.jsm">file</a> |
<a href="/comm-central/annotate/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/imCommands.jsm">annotate</a> |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/imCommands.jsm">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/imCommands.jsm">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/imCommands.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/imCommands.manifest">chat/components/src/imCommands.manifest</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/imCommands.manifest">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/imCommands.manifest">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/imCommands.manifest">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/imContacts.js">chat/components/src/imContacts.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/imContacts.js">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/imContacts.js">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/imContacts.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/imContacts.jsm">chat/components/src/imContacts.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/imContacts.jsm">file</a> |
<a href="/comm-central/annotate/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/imContacts.jsm">annotate</a> |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/imContacts.jsm">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/imContacts.jsm">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/imContacts.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/imContacts.manifest">chat/components/src/imContacts.manifest</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/imContacts.manifest">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/imContacts.manifest">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/imContacts.manifest">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/imConversations.js">chat/components/src/imConversations.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/imConversations.js">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/imConversations.js">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/imConversations.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/imConversations.jsm">chat/components/src/imConversations.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/imConversations.jsm">file</a> |
<a href="/comm-central/annotate/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/imConversations.jsm">annotate</a> |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/imConversations.jsm">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/imConversations.jsm">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/imConversations.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/imConversations.manifest">chat/components/src/imConversations.manifest</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/imConversations.manifest">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/imConversations.manifest">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/imConversations.manifest">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/imCore.js">chat/components/src/imCore.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/imCore.js">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/imCore.js">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/imCore.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/imCore.jsm">chat/components/src/imCore.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/imCore.jsm">file</a> |
<a href="/comm-central/annotate/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/imCore.jsm">annotate</a> |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/imCore.jsm">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/imCore.jsm">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/imCore.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/imCore.manifest">chat/components/src/imCore.manifest</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/imCore.manifest">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/imCore.manifest">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/imCore.manifest">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/logger.js">chat/components/src/logger.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/logger.js">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/logger.js">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/logger.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/logger.jsm">chat/components/src/logger.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/logger.jsm">file</a> |
<a href="/comm-central/annotate/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/logger.jsm">annotate</a> |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/logger.jsm">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/logger.jsm">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/logger.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/logger.manifest">chat/components/src/logger.manifest</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/logger.manifest">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/logger.manifest">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/logger.manifest">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/moz.build">chat/components/src/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/moz.build">file</a> |
<a href="/comm-central/annotate/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/moz.build">annotate</a> |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/moz.build">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/moz.build">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/moz.build">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/smileProtocolHandler.js">chat/components/src/smileProtocolHandler.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/smileProtocolHandler.js">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/smileProtocolHandler.js">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/smileProtocolHandler.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/smileProtocolHandler.jsm">chat/components/src/smileProtocolHandler.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/smileProtocolHandler.jsm">file</a> |
<a href="/comm-central/annotate/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/smileProtocolHandler.jsm">annotate</a> |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/smileProtocolHandler.jsm">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/smileProtocolHandler.jsm">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/smileProtocolHandler.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/smileProtocolHandler.manifest">chat/components/src/smileProtocolHandler.manifest</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/smileProtocolHandler.manifest">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/smileProtocolHandler.manifest">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/smileProtocolHandler.manifest">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/test/test_commands.js">chat/components/src/test/test_commands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/test/test_commands.js">file</a> |
<a href="/comm-central/annotate/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/test/test_commands.js">annotate</a> |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/test/test_commands.js">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/test/test_commands.js">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/test/test_commands.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/test/test_conversations.js">chat/components/src/test/test_conversations.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/test/test_conversations.js">file</a> |
<a href="/comm-central/annotate/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/test/test_conversations.js">annotate</a> |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/test/test_conversations.js">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/test/test_conversations.js">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/test/test_conversations.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/test/test_logger.js">chat/components/src/test/test_logger.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/test/test_logger.js">file</a> |
<a href="/comm-central/annotate/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/test/test_logger.js">annotate</a> |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/test/test_logger.js">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/test/test_logger.js">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/components/src/test/test_logger.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/facebook/components.conf">chat/protocols/facebook/components.conf</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/facebook/components.conf">file</a> |
<a href="/comm-central/annotate/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/facebook/components.conf">annotate</a> |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/facebook/components.conf">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/facebook/components.conf">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/facebook/components.conf">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/facebook/facebook.js">chat/protocols/facebook/facebook.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/facebook/facebook.js">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/facebook/facebook.js">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/facebook/facebook.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/facebook/facebook.jsm">chat/protocols/facebook/facebook.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/facebook/facebook.jsm">file</a> |
<a href="/comm-central/annotate/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/facebook/facebook.jsm">annotate</a> |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/facebook/facebook.jsm">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/facebook/facebook.jsm">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/facebook/facebook.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/facebook/facebook.manifest">chat/protocols/facebook/facebook.manifest</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/facebook/facebook.manifest">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/facebook/facebook.manifest">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/facebook/facebook.manifest">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/facebook/moz.build">chat/protocols/facebook/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/facebook/moz.build">file</a> |
<a href="/comm-central/annotate/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/facebook/moz.build">annotate</a> |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/facebook/moz.build">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/facebook/moz.build">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/facebook/moz.build">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/gtalk/components.conf">chat/protocols/gtalk/components.conf</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/gtalk/components.conf">file</a> |
<a href="/comm-central/annotate/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/gtalk/components.conf">annotate</a> |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/gtalk/components.conf">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/gtalk/components.conf">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/gtalk/components.conf">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/gtalk/gtalk.js">chat/protocols/gtalk/gtalk.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/gtalk/gtalk.js">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/gtalk/gtalk.js">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/gtalk/gtalk.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/gtalk/gtalk.jsm">chat/protocols/gtalk/gtalk.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/gtalk/gtalk.jsm">file</a> |
<a href="/comm-central/annotate/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/gtalk/gtalk.jsm">annotate</a> |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/gtalk/gtalk.jsm">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/gtalk/gtalk.jsm">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/gtalk/gtalk.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/gtalk/gtalk.manifest">chat/protocols/gtalk/gtalk.manifest</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/gtalk/gtalk.manifest">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/gtalk/gtalk.manifest">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/gtalk/gtalk.manifest">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/gtalk/moz.build">chat/protocols/gtalk/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/gtalk/moz.build">file</a> |
<a href="/comm-central/annotate/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/gtalk/moz.build">annotate</a> |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/gtalk/moz.build">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/gtalk/moz.build">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/gtalk/moz.build">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/components.conf">chat/protocols/irc/components.conf</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/components.conf">file</a> |
<a href="/comm-central/annotate/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/components.conf">annotate</a> |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/components.conf">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/components.conf">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/components.conf">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/irc.js">chat/protocols/irc/irc.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/irc.js">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/irc.js">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/irc.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/irc.jsm">chat/protocols/irc/irc.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/irc.jsm">file</a> |
<a href="/comm-central/annotate/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/irc.jsm">annotate</a> |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/irc.jsm">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/irc.jsm">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/irc.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/irc.manifest">chat/protocols/irc/irc.manifest</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/irc.manifest">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/irc.manifest">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/irc.manifest">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/moz.build">chat/protocols/irc/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/moz.build">file</a> |
<a href="/comm-central/annotate/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/moz.build">annotate</a> |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/moz.build">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/moz.build">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/moz.build">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/test/test_ctcpQuote.js">chat/protocols/irc/test/test_ctcpQuote.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/test/test_ctcpQuote.js">file</a> |
<a href="/comm-central/annotate/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/test/test_ctcpQuote.js">annotate</a> |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/test/test_ctcpQuote.js">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/test/test_ctcpQuote.js">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/test/test_ctcpQuote.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/test/test_ircCommands.js">chat/protocols/irc/test/test_ircCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/test/test_ircCommands.js">file</a> |
<a href="/comm-central/annotate/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/test/test_ircCommands.js">annotate</a> |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/test/test_ircCommands.js">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/test/test_ircCommands.js">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/test/test_ircCommands.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/test/test_ircMessage.js">chat/protocols/irc/test/test_ircMessage.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/test/test_ircMessage.js">file</a> |
<a href="/comm-central/annotate/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/test/test_ircMessage.js">annotate</a> |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/test/test_ircMessage.js">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/test/test_ircMessage.js">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/test/test_ircMessage.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/test/test_ircNonStandard.js">chat/protocols/irc/test/test_ircNonStandard.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/test/test_ircNonStandard.js">file</a> |
<a href="/comm-central/annotate/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/test/test_ircNonStandard.js">annotate</a> |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/test/test_ircNonStandard.js">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/test/test_ircNonStandard.js">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/test/test_ircNonStandard.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/test/test_ircServerTime.js">chat/protocols/irc/test/test_ircServerTime.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/test/test_ircServerTime.js">file</a> |
<a href="/comm-central/annotate/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/test/test_ircServerTime.js">annotate</a> |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/test/test_ircServerTime.js">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/test/test_ircServerTime.js">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/test/test_ircServerTime.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/test/test_sendBufferedCommand.js">chat/protocols/irc/test/test_sendBufferedCommand.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/test/test_sendBufferedCommand.js">file</a> |
<a href="/comm-central/annotate/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/test/test_sendBufferedCommand.js">annotate</a> |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/test/test_sendBufferedCommand.js">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/test/test_sendBufferedCommand.js">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/test/test_sendBufferedCommand.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/test/test_setMode.js">chat/protocols/irc/test/test_setMode.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/test/test_setMode.js">file</a> |
<a href="/comm-central/annotate/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/test/test_setMode.js">annotate</a> |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/test/test_setMode.js">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/test/test_setMode.js">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/test/test_setMode.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/test/test_splitLongMessages.js">chat/protocols/irc/test/test_splitLongMessages.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/test/test_splitLongMessages.js">file</a> |
<a href="/comm-central/annotate/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/test/test_splitLongMessages.js">annotate</a> |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/test/test_splitLongMessages.js">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/test/test_splitLongMessages.js">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/test/test_splitLongMessages.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/test/test_tryNewNick.js">chat/protocols/irc/test/test_tryNewNick.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/test/test_tryNewNick.js">file</a> |
<a href="/comm-central/annotate/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/test/test_tryNewNick.js">annotate</a> |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/test/test_tryNewNick.js">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/test/test_tryNewNick.js">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/irc/test/test_tryNewNick.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/jsTest/components.conf">chat/protocols/jsTest/components.conf</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/jsTest/components.conf">file</a> |
<a href="/comm-central/annotate/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/jsTest/components.conf">annotate</a> |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/jsTest/components.conf">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/jsTest/components.conf">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/jsTest/components.conf">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/jsTest/jsTestProtocol.js">chat/protocols/jsTest/jsTestProtocol.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/jsTest/jsTestProtocol.js">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/jsTest/jsTestProtocol.js">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/jsTest/jsTestProtocol.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/jsTest/jsTestProtocol.jsm">chat/protocols/jsTest/jsTestProtocol.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/jsTest/jsTestProtocol.jsm">file</a> |
<a href="/comm-central/annotate/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/jsTest/jsTestProtocol.jsm">annotate</a> |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/jsTest/jsTestProtocol.jsm">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/jsTest/jsTestProtocol.jsm">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/jsTest/jsTestProtocol.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/jsTest/jsTestProtocol.manifest">chat/protocols/jsTest/jsTestProtocol.manifest</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/jsTest/jsTestProtocol.manifest">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/jsTest/jsTestProtocol.manifest">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/jsTest/jsTestProtocol.manifest">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/jsTest/moz.build">chat/protocols/jsTest/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/jsTest/moz.build">file</a> |
<a href="/comm-central/annotate/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/jsTest/moz.build">annotate</a> |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/jsTest/moz.build">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/jsTest/moz.build">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/jsTest/moz.build">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/matrix/components.conf">chat/protocols/matrix/components.conf</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/matrix/components.conf">file</a> |
<a href="/comm-central/annotate/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/matrix/components.conf">annotate</a> |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/matrix/components.conf">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/matrix/components.conf">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/matrix/components.conf">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/matrix/matrix.js">chat/protocols/matrix/matrix.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/matrix/matrix.js">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/matrix/matrix.js">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/matrix/matrix.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/matrix/matrix.jsm">chat/protocols/matrix/matrix.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/matrix/matrix.jsm">file</a> |
<a href="/comm-central/annotate/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/matrix/matrix.jsm">annotate</a> |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/matrix/matrix.jsm">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/matrix/matrix.jsm">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/matrix/matrix.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/matrix/matrix.manifest">chat/protocols/matrix/matrix.manifest</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/matrix/matrix.manifest">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/matrix/matrix.manifest">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/matrix/matrix.manifest">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/matrix/moz.build">chat/protocols/matrix/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/matrix/moz.build">file</a> |
<a href="/comm-central/annotate/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/matrix/moz.build">annotate</a> |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/matrix/moz.build">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/matrix/moz.build">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/matrix/moz.build">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/odnoklassniki/components.conf">chat/protocols/odnoklassniki/components.conf</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/odnoklassniki/components.conf">file</a> |
<a href="/comm-central/annotate/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/odnoklassniki/components.conf">annotate</a> |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/odnoklassniki/components.conf">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/odnoklassniki/components.conf">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/odnoklassniki/components.conf">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/odnoklassniki/moz.build">chat/protocols/odnoklassniki/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/odnoklassniki/moz.build">file</a> |
<a href="/comm-central/annotate/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/odnoklassniki/moz.build">annotate</a> |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/odnoklassniki/moz.build">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/odnoklassniki/moz.build">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/odnoklassniki/moz.build">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/odnoklassniki/odnoklassniki.js">chat/protocols/odnoklassniki/odnoklassniki.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/odnoklassniki/odnoklassniki.js">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/odnoklassniki/odnoklassniki.js">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/odnoklassniki/odnoklassniki.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/odnoklassniki/odnoklassniki.jsm">chat/protocols/odnoklassniki/odnoklassniki.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/odnoklassniki/odnoklassniki.jsm">file</a> |
<a href="/comm-central/annotate/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/odnoklassniki/odnoklassniki.jsm">annotate</a> |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/odnoklassniki/odnoklassniki.jsm">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/odnoklassniki/odnoklassniki.jsm">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/odnoklassniki/odnoklassniki.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/odnoklassniki/odnoklassniki.manifest">chat/protocols/odnoklassniki/odnoklassniki.manifest</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/odnoklassniki/odnoklassniki.manifest">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/odnoklassniki/odnoklassniki.manifest">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/odnoklassniki/odnoklassniki.manifest">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/skype/components.conf">chat/protocols/skype/components.conf</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/skype/components.conf">file</a> |
<a href="/comm-central/annotate/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/skype/components.conf">annotate</a> |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/skype/components.conf">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/skype/components.conf">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/skype/components.conf">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/skype/moz.build">chat/protocols/skype/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/skype/moz.build">file</a> |
<a href="/comm-central/annotate/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/skype/moz.build">annotate</a> |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/skype/moz.build">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/skype/moz.build">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/skype/moz.build">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/skype/skype.js">chat/protocols/skype/skype.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/skype/skype.js">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/skype/skype.js">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/skype/skype.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/skype/skype.jsm">chat/protocols/skype/skype.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/skype/skype.jsm">file</a> |
<a href="/comm-central/annotate/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/skype/skype.jsm">annotate</a> |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/skype/skype.jsm">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/skype/skype.jsm">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/skype/skype.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/skype/skype.manifest">chat/protocols/skype/skype.manifest</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/skype/skype.manifest">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/skype/skype.manifest">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/skype/skype.manifest">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/skype/test/test_MagicSha256.js">chat/protocols/skype/test/test_MagicSha256.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/skype/test/test_MagicSha256.js">file</a> |
<a href="/comm-central/annotate/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/skype/test/test_MagicSha256.js">annotate</a> |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/skype/test/test_MagicSha256.js">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/skype/test/test_MagicSha256.js">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/skype/test/test_MagicSha256.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/skype/test/test_contactUrlToName.js">chat/protocols/skype/test/test_contactUrlToName.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/skype/test/test_contactUrlToName.js">file</a> |
<a href="/comm-central/annotate/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/skype/test/test_contactUrlToName.js">annotate</a> |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/skype/test/test_contactUrlToName.js">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/skype/test/test_contactUrlToName.js">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/skype/test/test_contactUrlToName.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/twitter/components.conf">chat/protocols/twitter/components.conf</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/twitter/components.conf">file</a> |
<a href="/comm-central/annotate/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/twitter/components.conf">annotate</a> |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/twitter/components.conf">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/twitter/components.conf">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/twitter/components.conf">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/twitter/moz.build">chat/protocols/twitter/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/twitter/moz.build">file</a> |
<a href="/comm-central/annotate/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/twitter/moz.build">annotate</a> |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/twitter/moz.build">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/twitter/moz.build">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/twitter/moz.build">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/twitter/twitter.js">chat/protocols/twitter/twitter.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/twitter/twitter.js">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/twitter/twitter.js">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/twitter/twitter.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/twitter/twitter.jsm">chat/protocols/twitter/twitter.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/twitter/twitter.jsm">file</a> |
<a href="/comm-central/annotate/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/twitter/twitter.jsm">annotate</a> |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/twitter/twitter.jsm">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/twitter/twitter.jsm">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/twitter/twitter.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/twitter/twitter.manifest">chat/protocols/twitter/twitter.manifest</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/twitter/twitter.manifest">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/twitter/twitter.manifest">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/twitter/twitter.manifest">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/xmpp/components.conf">chat/protocols/xmpp/components.conf</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/xmpp/components.conf">file</a> |
<a href="/comm-central/annotate/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/xmpp/components.conf">annotate</a> |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/xmpp/components.conf">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/xmpp/components.conf">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/xmpp/components.conf">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/xmpp/moz.build">chat/protocols/xmpp/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/xmpp/moz.build">file</a> |
<a href="/comm-central/annotate/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/xmpp/moz.build">annotate</a> |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/xmpp/moz.build">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/xmpp/moz.build">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/xmpp/moz.build">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/xmpp/test/test_dnsSrv.js">chat/protocols/xmpp/test/test_dnsSrv.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/xmpp/test/test_dnsSrv.js">file</a> |
<a href="/comm-central/annotate/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/xmpp/test/test_dnsSrv.js">annotate</a> |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/xmpp/test/test_dnsSrv.js">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/xmpp/test/test_dnsSrv.js">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/xmpp/test/test_dnsSrv.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/xmpp/test/test_parseJidAndNormalization.js">chat/protocols/xmpp/test/test_parseJidAndNormalization.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/xmpp/test/test_parseJidAndNormalization.js">file</a> |
<a href="/comm-central/annotate/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/xmpp/test/test_parseJidAndNormalization.js">annotate</a> |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/xmpp/test/test_parseJidAndNormalization.js">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/xmpp/test/test_parseJidAndNormalization.js">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/xmpp/test/test_parseJidAndNormalization.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/xmpp/test/test_parseVCard.js">chat/protocols/xmpp/test/test_parseVCard.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/xmpp/test/test_parseVCard.js">file</a> |
<a href="/comm-central/annotate/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/xmpp/test/test_parseVCard.js">annotate</a> |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/xmpp/test/test_parseVCard.js">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/xmpp/test/test_parseVCard.js">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/xmpp/test/test_parseVCard.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/xmpp/xmpp-base.jsm">chat/protocols/xmpp/xmpp-base.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/xmpp/xmpp-base.jsm">file</a> |
<a href="/comm-central/annotate/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/xmpp/xmpp-base.jsm">annotate</a> |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/xmpp/xmpp-base.jsm">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/xmpp/xmpp-base.jsm">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/xmpp/xmpp-base.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/xmpp/xmpp.js">chat/protocols/xmpp/xmpp.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/xmpp/xmpp.js">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/xmpp/xmpp.js">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/xmpp/xmpp.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/xmpp/xmpp.jsm">chat/protocols/xmpp/xmpp.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/xmpp/xmpp.jsm">file</a> |
<a href="/comm-central/annotate/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/xmpp/xmpp.jsm">annotate</a> |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/xmpp/xmpp.jsm">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/xmpp/xmpp.jsm">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/xmpp/xmpp.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/xmpp/xmpp.manifest">chat/protocols/xmpp/xmpp.manifest</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/xmpp/xmpp.manifest">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/xmpp/xmpp.manifest">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/xmpp/xmpp.manifest">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/yahoo/components.conf">chat/protocols/yahoo/components.conf</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/yahoo/components.conf">file</a> |
<a href="/comm-central/annotate/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/yahoo/components.conf">annotate</a> |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/yahoo/components.conf">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/yahoo/components.conf">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/yahoo/components.conf">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/yahoo/moz.build">chat/protocols/yahoo/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/yahoo/moz.build">file</a> |
<a href="/comm-central/annotate/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/yahoo/moz.build">annotate</a> |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/yahoo/moz.build">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/yahoo/moz.build">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/yahoo/moz.build">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/yahoo/yahoo.js">chat/protocols/yahoo/yahoo.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/yahoo/yahoo.js">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/yahoo/yahoo.js">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/yahoo/yahoo.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/yahoo/yahoo.jsm">chat/protocols/yahoo/yahoo.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/yahoo/yahoo.jsm">file</a> |
<a href="/comm-central/annotate/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/yahoo/yahoo.jsm">annotate</a> |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/yahoo/yahoo.jsm">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/yahoo/yahoo.jsm">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/yahoo/yahoo.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/yahoo/yahoo.manifest">chat/protocols/yahoo/yahoo.manifest</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/yahoo/yahoo.manifest">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/yahoo/yahoo.manifest">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/chat/protocols/yahoo/yahoo.manifest">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/mail/installer/package-manifest.in">mail/installer/package-manifest.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/mail/installer/package-manifest.in">file</a> |
<a href="/comm-central/annotate/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/mail/installer/package-manifest.in">annotate</a> |
<a href="/comm-central/diff/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/mail/installer/package-manifest.in">diff</a> |
<a href="/comm-central/comparison/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/mail/installer/package-manifest.in">comparison</a> |
<a href="/comm-central/log/8d558f7fb2cc3088b6c797354ae164c0012b4ce2/mail/installer/package-manifest.in">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1">new file mode 100644</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineminus">--- /dev/null</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineplus">+++ b/chat/components/src/components.conf</span>
<a href="#l1.4"></a><span id="l1.4" class="difflineat">@@ -0,0 +1,57 @@</span>
<a href="#l1.5"></a><span id="l1.5" class="difflineplus">+# -*- Mode: python; indent-tabs-mode: nil; tab-width: 40 -*-</span>
<a href="#l1.6"></a><span id="l1.6" class="difflineplus">+# vim: set filetype=python:</span>
<a href="#l1.7"></a><span id="l1.7" class="difflineplus">+# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l1.8"></a><span id="l1.8" class="difflineplus">+# License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l1.9"></a><span id="l1.9" class="difflineplus">+# file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l1.10"></a><span id="l1.10" class="difflineplus">+</span>
<a href="#l1.11"></a><span id="l1.11" class="difflineplus">+Classes = [</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+  {</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+    'cid': '{a94b5427-cd8d-40cf-b47e-b67671953e70}',</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+    'contract_ids': ['@mozilla.org/chat/accounts-service;1'],</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+    'jsm': 'resource:///modules/imAccounts.jsm',</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+    'constructor': 'AccountsService',</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+  },</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+  {</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+    'cid': '{7cb20c68-ccc8-4a79-b6f1-0b4771ed6c23}',</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineplus">+    'contract_ids': ['@mozilla.org/chat/commands-service;1'],</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineplus">+    'jsm': 'resource:///modules/imCommands.jsm',</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineplus">+    'constructor': 'CommandsService',</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineplus">+  },</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineplus">+  {</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineplus">+    'cid': '{8c3725dd-ee26-489d-8135-736015af8c7f}',</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineplus">+    'contract_ids': ['@mozilla.org/chat/contacts-service;1'],</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineplus">+    'jsm': 'resource:///modules/imContacts.jsm',</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineplus">+    'constructor': 'ContactsService',</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineplus">+  },</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineplus">+  {</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+    'cid': '{1fa92237-4303-4384-b8ac-4e65b50810a5}',</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+    'contract_ids': ['@mozilla.org/chat/tags-service;1'],</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+    'jsm': 'resource:///modules/imContacts.jsm',</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineplus">+    'constructor': 'TagsService',</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineplus">+  },</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineplus">+  {</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineplus">+    'cid': '{b2397cd5-c76d-4618-8410-f344c7c6443a}',</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineplus">+    'contract_ids': ['@mozilla.org/chat/conversations-service;1'],</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineplus">+    'jsm': 'resource:///modules/imConversations.jsm',</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineplus">+    'constructor': 'ConversationsService',</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineplus">+  },</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineplus">+  {</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineplus">+    'cid': '{073f5953-853c-4a38-bd81-255510c31c2e}',</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineplus">+    'contract_ids': ['@mozilla.org/chat/core-service;1'],</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineplus">+    'jsm': 'resource:///modules/imCore.jsm',</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineplus">+    'constructor': 'CoreService',</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineplus">+  },</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineplus">+  {</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineplus">+    'cid': '{fb0dc220-2c7a-4216-9f19-6b8f3480eae9}',</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineplus">+    'contract_ids': ['@mozilla.org/chat/logger;1'],</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineplus">+    'jsm': 'resource:///modules/logger.jsm',</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineplus">+    'constructor': 'Logger',</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineplus">+    'categories': {'profile-after-change': 'Logger'},</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineplus">+  },</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineplus">+  {</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineplus">+    'cid': '{04e58eae-dfbc-4c9e-8130-6d9ef19cbff4}',</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineplus">+    'contract_ids': ['@mozilla.org/network/protocol;1?name=smile'],</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineplus">+    'jsm': 'resource:///modules/smileProtocolHandler.jsm',</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineplus">+    'constructor': 'smileProtocolHandler',</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineplus">+  },</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineplus">+]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1">rename from chat/components/src/imAccounts.js</span>
<a href="#l2.2"></a><span id="l2.2">rename to chat/components/src/imAccounts.jsm</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineminus">--- a/chat/components/src/imAccounts.js</span>
<a href="#l2.4"></a><span id="l2.4" class="difflineplus">+++ b/chat/components/src/imAccounts.jsm</span>
<a href="#l2.5"></a><span id="l2.5" class="difflineat">@@ -1,11 +1,14 @@</span>
<a href="#l2.6"></a><span id="l2.6"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l2.7"></a><span id="l2.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l2.8"></a><span id="l2.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l2.9"></a><span id="l2.9" class="difflineplus">+</span>
<a href="#l2.10"></a><span id="l2.10" class="difflineplus">+var EXPORTED_SYMBOLS = [&quot;AccountsService&quot;];</span>
<a href="#l2.11"></a><span id="l2.11" class="difflineplus">+</span>
<a href="#l2.12"></a><span id="l2.12"> var {</span>
<a href="#l2.13"></a><span id="l2.13">   ClassInfo,</span>
<a href="#l2.14"></a><span id="l2.14">   EmptyEnumerator,</span>
<a href="#l2.15"></a><span id="l2.15">   nsSimpleEnumerator,</span>
<a href="#l2.16"></a><span id="l2.16">   XPCOMUtils,</span>
<a href="#l2.17"></a><span id="l2.17">   setTimeout,</span>
<a href="#l2.18"></a><span id="l2.18">   clearTimeout,</span>
<a href="#l2.19"></a><span id="l2.19">   executeSoon,</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineat">@@ -1290,13 +1293,9 @@ AccountsService.prototype = {</span>
<a href="#l2.21"></a><span id="l2.21">     this._accountList = list</span>
<a href="#l2.22"></a><span id="l2.22">       .split(&quot;,&quot;)</span>
<a href="#l2.23"></a><span id="l2.23">       .filter(k =&gt; k.trim() != aAccountId)</span>
<a href="#l2.24"></a><span id="l2.24">       .join(&quot;,&quot;);</span>
<a href="#l2.25"></a><span id="l2.25">   },</span>
<a href="#l2.26"></a><span id="l2.26"> </span>
<a href="#l2.27"></a><span id="l2.27">   QueryInterface: ChromeUtils.generateQI([Ci.imIAccountsService]),</span>
<a href="#l2.28"></a><span id="l2.28">   classDescription: &quot;Accounts&quot;,</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineminus">-  classID: Components.ID(&quot;{a94b5427-cd8d-40cf-b47e-b67671953e70}&quot;),</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineminus">-  contractID: &quot;@mozilla.org/chat/accounts-service;1&quot;,</span>
<a href="#l2.31"></a><span id="l2.31"> };</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineminus">-</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineminus">-var NSGetFactory = XPCOMUtils.generateNSGetFactory([AccountsService]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1">deleted file mode 100644</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineminus">--- a/chat/components/src/imAccounts.manifest</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineplus">+++ /dev/null</span>
<a href="#l3.4"></a><span id="l3.4" class="difflineat">@@ -1,2 +0,0 @@</span>
<a href="#l3.5"></a><span id="l3.5" class="difflineminus">-component {a94b5427-cd8d-40cf-b47e-b67671953e70} imAccounts.js</span>
<a href="#l3.6"></a><span id="l3.6" class="difflineminus">-contract @mozilla.org/chat/accounts-service;1 {a94b5427-cd8d-40cf-b47e-b67671953e70}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1">rename from chat/components/src/imCommands.js</span>
<a href="#l4.2"></a><span id="l4.2">rename to chat/components/src/imCommands.jsm</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineminus">--- a/chat/components/src/imCommands.js</span>
<a href="#l4.4"></a><span id="l4.4" class="difflineplus">+++ b/chat/components/src/imCommands.jsm</span>
<a href="#l4.5"></a><span id="l4.5" class="difflineat">@@ -1,12 +1,14 @@</span>
<a href="#l4.6"></a><span id="l4.6"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l4.7"></a><span id="l4.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l4.8"></a><span id="l4.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l4.9"></a><span id="l4.9"> </span>
<a href="#l4.10"></a><span id="l4.10" class="difflineplus">+var EXPORTED_SYMBOLS = [&quot;CommandsService&quot;];</span>
<a href="#l4.11"></a><span id="l4.11" class="difflineplus">+</span>
<a href="#l4.12"></a><span id="l4.12"> var { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l4.13"></a><span id="l4.13"> var { XPCOMUtils, l10nHelper } = ChromeUtils.import(</span>
<a href="#l4.14"></a><span id="l4.14">   &quot;resource:///modules/imXPCOMUtils.jsm&quot;</span>
<a href="#l4.15"></a><span id="l4.15"> );</span>
<a href="#l4.16"></a><span id="l4.16"> </span>
<a href="#l4.17"></a><span id="l4.17"> XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l4.18"></a><span id="l4.18">   l10nHelper(&quot;chrome://chat/locale/commands.properties&quot;)</span>
<a href="#l4.19"></a><span id="l4.19"> );</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineat">@@ -280,13 +282,9 @@ CommandsService.prototype = {</span>
<a href="#l4.21"></a><span id="l4.21">       // If they all failed, print help message.</span>
<a href="#l4.22"></a><span id="l4.22">       this.executeCommand(&quot;/help &quot; + name, aConversation);</span>
<a href="#l4.23"></a><span id="l4.23">     }</span>
<a href="#l4.24"></a><span id="l4.24">     return true;</span>
<a href="#l4.25"></a><span id="l4.25">   },</span>
<a href="#l4.26"></a><span id="l4.26"> </span>
<a href="#l4.27"></a><span id="l4.27">   QueryInterface: ChromeUtils.generateQI([Ci.imICommandsService]),</span>
<a href="#l4.28"></a><span id="l4.28">   classDescription: &quot;Commands&quot;,</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineminus">-  classID: Components.ID(&quot;{7cb20c68-ccc8-4a79-b6f1-0b4771ed6c23}&quot;),</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineminus">-  contractID: &quot;@mozilla.org/chat/commands-service;1&quot;,</span>
<a href="#l4.31"></a><span id="l4.31"> };</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineminus">-</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineminus">-var NSGetFactory = XPCOMUtils.generateNSGetFactory([CommandsService]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1">deleted file mode 100644</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineminus">--- a/chat/components/src/imCommands.manifest</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineplus">+++ /dev/null</span>
<a href="#l5.4"></a><span id="l5.4" class="difflineat">@@ -1,2 +0,0 @@</span>
<a href="#l5.5"></a><span id="l5.5" class="difflineminus">-component {7cb20c68-ccc8-4a79-b6f1-0b4771ed6c23} imCommands.js</span>
<a href="#l5.6"></a><span id="l5.6" class="difflineminus">-contract @mozilla.org/chat/commands-service;1 {7cb20c68-ccc8-4a79-b6f1-0b4771ed6c23}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1">rename from chat/components/src/imContacts.js</span>
<a href="#l6.2"></a><span id="l6.2">rename to chat/components/src/imContacts.jsm</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineminus">--- a/chat/components/src/imContacts.js</span>
<a href="#l6.4"></a><span id="l6.4" class="difflineplus">+++ b/chat/components/src/imContacts.jsm</span>
<a href="#l6.5"></a><span id="l6.5" class="difflineat">@@ -1,12 +1,14 @@</span>
<a href="#l6.6"></a><span id="l6.6"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l6.7"></a><span id="l6.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l6.8"></a><span id="l6.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l6.9"></a><span id="l6.9"> </span>
<a href="#l6.10"></a><span id="l6.10" class="difflineplus">+var EXPORTED_SYMBOLS = [&quot;TagsService&quot;, &quot;ContactsService&quot;];</span>
<a href="#l6.11"></a><span id="l6.11" class="difflineplus">+</span>
<a href="#l6.12"></a><span id="l6.12"> var { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l6.13"></a><span id="l6.13"> var { XPCOMUtils, executeSoon, ClassInfo, l10nHelper } = ChromeUtils.import(</span>
<a href="#l6.14"></a><span id="l6.14">   &quot;resource:///modules/imXPCOMUtils.jsm&quot;</span>
<a href="#l6.15"></a><span id="l6.15"> );</span>
<a href="#l6.16"></a><span id="l6.16"> </span>
<a href="#l6.17"></a><span id="l6.17"> XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l6.18"></a><span id="l6.18">   l10nHelper(&quot;chrome://chat/locale/contacts.properties&quot;)</span>
<a href="#l6.19"></a><span id="l6.19"> );</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineat">@@ -196,18 +198,16 @@ TagsService.prototype = {</span>
<a href="#l6.21"></a><span id="l6.21">   },</span>
<a href="#l6.22"></a><span id="l6.22">   get otherContactsTag() {</span>
<a href="#l6.23"></a><span id="l6.23">     otherContactsTag._initContacts();</span>
<a href="#l6.24"></a><span id="l6.24">     return otherContactsTag;</span>
<a href="#l6.25"></a><span id="l6.25">   },</span>
<a href="#l6.26"></a><span id="l6.26"> </span>
<a href="#l6.27"></a><span id="l6.27">   QueryInterface: ChromeUtils.generateQI([Ci.imITagsService]),</span>
<a href="#l6.28"></a><span id="l6.28">   classDescription: &quot;Tags&quot;,</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineminus">-  classID: Components.ID(&quot;{1fa92237-4303-4384-b8ac-4e65b50810a5}&quot;),</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineminus">-  contractID: &quot;@mozilla.org/chat/tags-service;1&quot;,</span>
<a href="#l6.31"></a><span id="l6.31"> };</span>
<a href="#l6.32"></a><span id="l6.32"> </span>
<a href="#l6.33"></a><span id="l6.33"> // TODO move into the tagsService</span>
<a href="#l6.34"></a><span id="l6.34"> var Tags = [];</span>
<a href="#l6.35"></a><span id="l6.35"> var TagsById = {};</span>
<a href="#l6.36"></a><span id="l6.36"> </span>
<a href="#l6.37"></a><span id="l6.37"> function Tag(aId, aName) {</span>
<a href="#l6.38"></a><span id="l6.38">   this._id = aId;</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineat">@@ -1795,16 +1795,9 @@ ContactsService.prototype = {</span>
<a href="#l6.40"></a><span id="l6.40">       statement.execute();</span>
<a href="#l6.41"></a><span id="l6.41">     } finally {</span>
<a href="#l6.42"></a><span id="l6.42">       statement.finalize();</span>
<a href="#l6.43"></a><span id="l6.43">     }</span>
<a href="#l6.44"></a><span id="l6.44">   },</span>
<a href="#l6.45"></a><span id="l6.45"> </span>
<a href="#l6.46"></a><span id="l6.46">   QueryInterface: ChromeUtils.generateQI([Ci.imIContactsService]),</span>
<a href="#l6.47"></a><span id="l6.47">   classDescription: &quot;Contacts&quot;,</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineminus">-  classID: Components.ID(&quot;{8c3725dd-ee26-489d-8135-736015af8c7f}&quot;),</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineminus">-  contractID: &quot;@mozilla.org/chat/contacts-service;1&quot;,</span>
<a href="#l6.50"></a><span id="l6.50"> };</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineminus">-</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineminus">-var NSGetFactory = XPCOMUtils.generateNSGetFactory([</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineminus">-  ContactsService,</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineminus">-  TagsService,</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineminus">-]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1">deleted file mode 100644</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineminus">--- a/chat/components/src/imContacts.manifest</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineplus">+++ /dev/null</span>
<a href="#l7.4"></a><span id="l7.4" class="difflineat">@@ -1,4 +0,0 @@</span>
<a href="#l7.5"></a><span id="l7.5" class="difflineminus">-component {8c3725dd-ee26-489d-8135-736015af8c7f} imContacts.js</span>
<a href="#l7.6"></a><span id="l7.6" class="difflineminus">-contract @mozilla.org/chat/contacts-service;1 {8c3725dd-ee26-489d-8135-736015af8c7f}</span>
<a href="#l7.7"></a><span id="l7.7" class="difflineminus">-component {1fa92237-4303-4384-b8ac-4e65b50810a5} imContacts.js</span>
<a href="#l7.8"></a><span id="l7.8" class="difflineminus">-contract @mozilla.org/chat/tags-service;1 {1fa92237-4303-4384-b8ac-4e65b50810a5}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1">rename from chat/components/src/imConversations.js</span>
<a href="#l8.2"></a><span id="l8.2">rename to chat/components/src/imConversations.jsm</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineminus">--- a/chat/components/src/imConversations.js</span>
<a href="#l8.4"></a><span id="l8.4" class="difflineplus">+++ b/chat/components/src/imConversations.jsm</span>
<a href="#l8.5"></a><span id="l8.5" class="difflineat">@@ -1,12 +1,14 @@</span>
<a href="#l8.6"></a><span id="l8.6"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l8.7"></a><span id="l8.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l8.8"></a><span id="l8.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l8.9"></a><span id="l8.9"> </span>
<a href="#l8.10"></a><span id="l8.10" class="difflineplus">+var EXPORTED_SYMBOLS = [&quot;ConversationsService&quot;];</span>
<a href="#l8.11"></a><span id="l8.11" class="difflineplus">+</span>
<a href="#l8.12"></a><span id="l8.12"> var { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l8.13"></a><span id="l8.13"> var { Status } = ChromeUtils.import(&quot;resource:///modules/imStatusUtils.jsm&quot;);</span>
<a href="#l8.14"></a><span id="l8.14"> var { XPCOMUtils, nsSimpleEnumerator, ClassInfo } = ChromeUtils.import(</span>
<a href="#l8.15"></a><span id="l8.15">   &quot;resource:///modules/imXPCOMUtils.jsm&quot;</span>
<a href="#l8.16"></a><span id="l8.16"> );</span>
<a href="#l8.17"></a><span id="l8.17"> var { Message } = ChromeUtils.import(&quot;resource:///modules/jsProtoHelper.jsm&quot;);</span>
<a href="#l8.18"></a><span id="l8.18"> </span>
<a href="#l8.19"></a><span id="l8.19"> var gLastUIConvId = 0;</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineat">@@ -821,13 +823,9 @@ ConversationsService.prototype = {</span>
<a href="#l8.21"></a><span id="l8.21">         return conv;</span>
<a href="#l8.22"></a><span id="l8.22">       }</span>
<a href="#l8.23"></a><span id="l8.23">     }</span>
<a href="#l8.24"></a><span id="l8.24">     return null;</span>
<a href="#l8.25"></a><span id="l8.25">   },</span>
<a href="#l8.26"></a><span id="l8.26"> </span>
<a href="#l8.27"></a><span id="l8.27">   QueryInterface: ChromeUtils.generateQI([Ci.imIConversationsService]),</span>
<a href="#l8.28"></a><span id="l8.28">   classDescription: &quot;Conversations&quot;,</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineminus">-  classID: Components.ID(&quot;{b2397cd5-c76d-4618-8410-f344c7c6443a}&quot;),</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineminus">-  contractID: &quot;@mozilla.org/chat/conversations-service;1&quot;,</span>
<a href="#l8.31"></a><span id="l8.31"> };</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineminus">-</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineminus">-var NSGetFactory = XPCOMUtils.generateNSGetFactory([ConversationsService]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1">deleted file mode 100644</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineminus">--- a/chat/components/src/imConversations.manifest</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineplus">+++ /dev/null</span>
<a href="#l9.4"></a><span id="l9.4" class="difflineat">@@ -1,2 +0,0 @@</span>
<a href="#l9.5"></a><span id="l9.5" class="difflineminus">-component {b2397cd5-c76d-4618-8410-f344c7c6443a} imConversations.js</span>
<a href="#l9.6"></a><span id="l9.6" class="difflineminus">-contract @mozilla.org/chat/conversations-service;1 {b2397cd5-c76d-4618-8410-f344c7c6443a}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1">rename from chat/components/src/imCore.js</span>
<a href="#l10.2"></a><span id="l10.2">rename to chat/components/src/imCore.jsm</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineminus">--- a/chat/components/src/imCore.js</span>
<a href="#l10.4"></a><span id="l10.4" class="difflineplus">+++ b/chat/components/src/imCore.jsm</span>
<a href="#l10.5"></a><span id="l10.5" class="difflineat">@@ -1,12 +1,14 @@</span>
<a href="#l10.6"></a><span id="l10.6"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l10.7"></a><span id="l10.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l10.8"></a><span id="l10.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l10.9"></a><span id="l10.9"> </span>
<a href="#l10.10"></a><span id="l10.10" class="difflineplus">+var EXPORTED_SYMBOLS = [&quot;CoreService&quot;];</span>
<a href="#l10.11"></a><span id="l10.11" class="difflineplus">+</span>
<a href="#l10.12"></a><span id="l10.12"> var { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l10.13"></a><span id="l10.13"> var {</span>
<a href="#l10.14"></a><span id="l10.14">   XPCOMUtils,</span>
<a href="#l10.15"></a><span id="l10.15">   ClassInfo,</span>
<a href="#l10.16"></a><span id="l10.16">   initLogModule,</span>
<a href="#l10.17"></a><span id="l10.17">   nsSimpleEnumerator,</span>
<a href="#l10.18"></a><span id="l10.18"> } = ChromeUtils.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l10.19"></a><span id="l10.19"> </span>
<a href="#l10.20"></a><span id="l10.20" class="difflineat">@@ -268,20 +270,17 @@ UserStatus.prototype = {</span>
<a href="#l10.21"></a><span id="l10.21">   },</span>
<a href="#l10.22"></a><span id="l10.22">   _notifyObservers(aTopic, aData) {</span>
<a href="#l10.23"></a><span id="l10.23">     for (let observer of this._observers) {</span>
<a href="#l10.24"></a><span id="l10.24">       observer.observe(this, aTopic, aData);</span>
<a href="#l10.25"></a><span id="l10.25">     }</span>
<a href="#l10.26"></a><span id="l10.26">   },</span>
<a href="#l10.27"></a><span id="l10.27"> };</span>
<a href="#l10.28"></a><span id="l10.28"> </span>
<a href="#l10.29"></a><span id="l10.29" class="difflineminus">-var gCoreService;</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineminus">-function CoreService() {</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineminus">-  gCoreService = this;</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineminus">-}</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineplus">+function CoreService() {}</span>
<a href="#l10.34"></a><span id="l10.34"> CoreService.prototype = {</span>
<a href="#l10.35"></a><span id="l10.35">   globalUserStatus: null,</span>
<a href="#l10.36"></a><span id="l10.36"> </span>
<a href="#l10.37"></a><span id="l10.37">   _initialized: false,</span>
<a href="#l10.38"></a><span id="l10.38">   get initialized() {</span>
<a href="#l10.39"></a><span id="l10.39">     return this._initialized;</span>
<a href="#l10.40"></a><span id="l10.40">   },</span>
<a href="#l10.41"></a><span id="l10.41">   init() {</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineat">@@ -408,13 +407,9 @@ CoreService.prototype = {</span>
<a href="#l10.43"></a><span id="l10.43">     }</span>
<a href="#l10.44"></a><span id="l10.44"> </span>
<a href="#l10.45"></a><span id="l10.45">     this._protos[aPrplId] = proto;</span>
<a href="#l10.46"></a><span id="l10.46">     return proto;</span>
<a href="#l10.47"></a><span id="l10.47">   },</span>
<a href="#l10.48"></a><span id="l10.48"> </span>
<a href="#l10.49"></a><span id="l10.49">   QueryInterface: ChromeUtils.generateQI([Ci.imICoreService]),</span>
<a href="#l10.50"></a><span id="l10.50">   classDescription: &quot;Core&quot;,</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineminus">-  classID: Components.ID(&quot;{073f5953-853c-4a38-bd81-255510c31c2e}&quot;),</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineminus">-  contractID: &quot;@mozilla.org/chat/core-service;1&quot;,</span>
<a href="#l10.53"></a><span id="l10.53"> };</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineminus">-</span>
<a href="#l10.55"></a><span id="l10.55" class="difflineminus">-var NSGetFactory = XPCOMUtils.generateNSGetFactory([CoreService]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1">deleted file mode 100644</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineminus">--- a/chat/components/src/imCore.manifest</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineplus">+++ /dev/null</span>
<a href="#l11.4"></a><span id="l11.4" class="difflineat">@@ -1,2 +0,0 @@</span>
<a href="#l11.5"></a><span id="l11.5" class="difflineminus">-component {073f5953-853c-4a38-bd81-255510c31c2e} imCore.js</span>
<a href="#l11.6"></a><span id="l11.6" class="difflineminus">-contract @mozilla.org/chat/core-service;1 {073f5953-853c-4a38-bd81-255510c31c2e}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1">rename from chat/components/src/logger.js</span>
<a href="#l12.2"></a><span id="l12.2">rename to chat/components/src/logger.jsm</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineminus">--- a/chat/components/src/logger.js</span>
<a href="#l12.4"></a><span id="l12.4" class="difflineplus">+++ b/chat/components/src/logger.jsm</span>
<a href="#l12.5"></a><span id="l12.5" class="difflineat">@@ -1,13 +1,13 @@</span>
<a href="#l12.6"></a><span id="l12.6"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l12.7"></a><span id="l12.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l12.8"></a><span id="l12.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l12.9"></a><span id="l12.9"> </span>
<a href="#l12.10"></a><span id="l12.10" class="difflineminus">-var CC = Components.Constructor;</span>
<a href="#l12.11"></a><span id="l12.11" class="difflineplus">+var EXPORTED_SYMBOLS = [&quot;Logger&quot;];</span>
<a href="#l12.12"></a><span id="l12.12"> </span>
<a href="#l12.13"></a><span id="l12.13"> var { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l12.14"></a><span id="l12.14"> var { EmptyEnumerator, l10nHelper, XPCOMUtils } = ChromeUtils.import(</span>
<a href="#l12.15"></a><span id="l12.15">   &quot;resource:///modules/imXPCOMUtils.jsm&quot;</span>
<a href="#l12.16"></a><span id="l12.16"> );</span>
<a href="#l12.17"></a><span id="l12.17"> var { GenericMessagePrototype } = ChromeUtils.import(</span>
<a href="#l12.18"></a><span id="l12.18">   &quot;resource:///modules/jsProtoHelper.jsm&quot;</span>
<a href="#l12.19"></a><span id="l12.19"> );</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineat">@@ -1125,13 +1125,9 @@ Logger.prototype = {</span>
<a href="#l12.21"></a><span id="l12.21">         break;</span>
<a href="#l12.22"></a><span id="l12.22">       default:</span>
<a href="#l12.23"></a><span id="l12.23">         throw new Error(&quot;Unexpected notification &quot; + aTopic);</span>
<a href="#l12.24"></a><span id="l12.24">     }</span>
<a href="#l12.25"></a><span id="l12.25">   },</span>
<a href="#l12.26"></a><span id="l12.26"> </span>
<a href="#l12.27"></a><span id="l12.27">   QueryInterface: ChromeUtils.generateQI([Ci.nsIObserver, Ci.imILogger]),</span>
<a href="#l12.28"></a><span id="l12.28">   classDescription: &quot;Logger&quot;,</span>
<a href="#l12.29"></a><span id="l12.29" class="difflineminus">-  classID: Components.ID(&quot;{fb0dc220-2c7a-4216-9f19-6b8f3480eae9}&quot;),</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineminus">-  contractID: &quot;@mozilla.org/chat/logger;1&quot;,</span>
<a href="#l12.31"></a><span id="l12.31"> };</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineminus">-</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineminus">-var NSGetFactory = XPCOMUtils.generateNSGetFactory([Logger]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1">deleted file mode 100644</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineminus">--- a/chat/components/src/logger.manifest</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineplus">+++ /dev/null</span>
<a href="#l13.4"></a><span id="l13.4" class="difflineat">@@ -1,3 +0,0 @@</span>
<a href="#l13.5"></a><span id="l13.5" class="difflineminus">-component {fb0dc220-2c7a-4216-9f19-6b8f3480eae9} logger.js</span>
<a href="#l13.6"></a><span id="l13.6" class="difflineminus">-contract @mozilla.org/chat/logger;1 {fb0dc220-2c7a-4216-9f19-6b8f3480eae9}</span>
<a href="#l13.7"></a><span id="l13.7" class="difflineminus">-category profile-after-change Logger @mozilla.org/chat/logger;1</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/chat/components/src/moz.build</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/chat/components/src/moz.build</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -1,24 +1,20 @@</span>
<a href="#l14.4"></a><span id="l14.4"> # vim: set filetype=python:</span>
<a href="#l14.5"></a><span id="l14.5"> # This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l14.6"></a><span id="l14.6"> # License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l14.7"></a><span id="l14.7"> # file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l14.8"></a><span id="l14.8"> </span>
<a href="#l14.9"></a><span id="l14.9"> XPCSHELL_TESTS_MANIFESTS += ['test/xpcshell.ini']</span>
<a href="#l14.10"></a><span id="l14.10"> </span>
<a href="#l14.11"></a><span id="l14.11" class="difflineminus">-EXTRA_COMPONENTS += [</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-    'imAccounts.js',</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineminus">-    'imAccounts.manifest',</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineminus">-    'imCommands.js',</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineminus">-    'imCommands.manifest',</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineminus">-    'imContacts.js',</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineminus">-    'imContacts.manifest',</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineminus">-    'imConversations.js',</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineminus">-    'imConversations.manifest',</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineminus">-    'imCore.js',</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineminus">-    'imCore.manifest',</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineminus">-    'logger.js',</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineminus">-    'logger.manifest',</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineminus">-    'smileProtocolHandler.js',</span>
<a href="#l14.25"></a><span id="l14.25" class="difflineminus">-    'smileProtocolHandler.manifest',</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineplus">+EXTRA_JS_MODULES += [</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineplus">+    'imAccounts.jsm',</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineplus">+    'imCommands.jsm',</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineplus">+    'imContacts.jsm',</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineplus">+    'imConversations.jsm',</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineplus">+    'imCore.jsm',</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineplus">+    'logger.jsm',</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineplus">+    'smileProtocolHandler.jsm'</span>
<a href="#l14.34"></a><span id="l14.34"> ]</span>
<a href="#l14.35"></a><span id="l14.35"> </span>
<a href="#l14.36"></a><span id="l14.36" class="difflineplus">+XPCOM_MANIFESTS += [</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineplus">+    'components.conf',</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineplus">+]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1">rename from chat/components/src/smileProtocolHandler.js</span>
<a href="#l15.2"></a><span id="l15.2">rename to chat/components/src/smileProtocolHandler.jsm</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineminus">--- a/chat/components/src/smileProtocolHandler.js</span>
<a href="#l15.4"></a><span id="l15.4" class="difflineplus">+++ b/chat/components/src/smileProtocolHandler.jsm</span>
<a href="#l15.5"></a><span id="l15.5" class="difflineat">@@ -1,16 +1,15 @@</span>
<a href="#l15.6"></a><span id="l15.6"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l15.7"></a><span id="l15.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l15.8"></a><span id="l15.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l15.9"></a><span id="l15.9"> </span>
<a href="#l15.10"></a><span id="l15.10" class="difflineplus">+var EXPORTED_SYMBOLS = [&quot;smileProtocolHandler&quot;];</span>
<a href="#l15.11"></a><span id="l15.11" class="difflineplus">+</span>
<a href="#l15.12"></a><span id="l15.12"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineminus">-var { XPCOMUtils } = ChromeUtils.import(</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineminus">-  &quot;resource://gre/modules/XPCOMUtils.jsm&quot;</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineminus">-);</span>
<a href="#l15.16"></a><span id="l15.16"> var { getSmileRealURI } = ChromeUtils.import(</span>
<a href="#l15.17"></a><span id="l15.17">   &quot;resource:///modules/imSmileys.jsm&quot;</span>
<a href="#l15.18"></a><span id="l15.18"> );</span>
<a href="#l15.19"></a><span id="l15.19"> </span>
<a href="#l15.20"></a><span id="l15.20"> var kSmileRegexp = /^smile:\/\//;</span>
<a href="#l15.21"></a><span id="l15.21"> </span>
<a href="#l15.22"></a><span id="l15.22"> function smileProtocolHandler() {}</span>
<a href="#l15.23"></a><span id="l15.23"> </span>
<a href="#l15.24"></a><span id="l15.24" class="difflineat">@@ -28,15 +27,11 @@ smileProtocolHandler.prototype = {</span>
<a href="#l15.25"></a><span id="l15.25">     let channel = Services.io.newChannelFromURIWithLoadInfo(uri, aLoadInfo);</span>
<a href="#l15.26"></a><span id="l15.26">     channel.originalURI = aURI;</span>
<a href="#l15.27"></a><span id="l15.27">     return channel;</span>
<a href="#l15.28"></a><span id="l15.28">   },</span>
<a href="#l15.29"></a><span id="l15.29">   allowPort(aPort, aScheme) {</span>
<a href="#l15.30"></a><span id="l15.30">     return false;</span>
<a href="#l15.31"></a><span id="l15.31">   },</span>
<a href="#l15.32"></a><span id="l15.32"> </span>
<a href="#l15.33"></a><span id="l15.33" class="difflineplus">+  QueryInterface: ChromeUtils.generateQI([Ci.nsIProtocolHandler]),</span>
<a href="#l15.34"></a><span id="l15.34">   classDescription: &quot;Smile Protocol Handler&quot;,</span>
<a href="#l15.35"></a><span id="l15.35" class="difflineminus">-  classID: Components.ID(&quot;{04e58eae-dfbc-4c9e-8130-6d9ef19cbff4}&quot;),</span>
<a href="#l15.36"></a><span id="l15.36" class="difflineminus">-  contractID: &quot;@mozilla.org/network/protocol;1?name=smile&quot;,</span>
<a href="#l15.37"></a><span id="l15.37" class="difflineminus">-  QueryInterface: ChromeUtils.generateQI([Ci.nsIProtocolHandler]),</span>
<a href="#l15.38"></a><span id="l15.38"> };</span>
<a href="#l15.39"></a><span id="l15.39" class="difflineminus">-</span>
<a href="#l15.40"></a><span id="l15.40" class="difflineminus">-var NSGetFactory = XPCOMUtils.generateNSGetFactory([smileProtocolHandler]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1">deleted file mode 100644</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineminus">--- a/chat/components/src/smileProtocolHandler.manifest</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineplus">+++ /dev/null</span>
<a href="#l16.4"></a><span id="l16.4" class="difflineat">@@ -1,2 +0,0 @@</span>
<a href="#l16.5"></a><span id="l16.5" class="difflineminus">-component {04e58eae-dfbc-4c9e-8130-6d9ef19cbff4} smileProtocolHandler.js</span>
<a href="#l16.6"></a><span id="l16.6" class="difflineminus">-contract @mozilla.org/network/protocol;1?name=smile {04e58eae-dfbc-4c9e-8130-6d9ef19cbff4}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/chat/components/src/test/test_commands.js</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/chat/components/src/test/test_commands.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -2,17 +2,17 @@</span>
<a href="#l17.4"></a><span id="l17.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l17.5"></a><span id="l17.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l17.6"></a><span id="l17.6"> </span>
<a href="#l17.7"></a><span id="l17.7"> var { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l17.8"></a><span id="l17.8"> // We don't load the command service via Services as we want to access</span>
<a href="#l17.9"></a><span id="l17.9"> // _findCommands in order to avoid having to intercept command execution.</span>
<a href="#l17.10"></a><span id="l17.10"> var imCommands = {};</span>
<a href="#l17.11"></a><span id="l17.11"> Services.scriptloader.loadSubScript(</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-  &quot;resource:///components/imCommands.js&quot;,</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+  &quot;resource:///modules/imCommands.jsm&quot;,</span>
<a href="#l17.14"></a><span id="l17.14">   imCommands</span>
<a href="#l17.15"></a><span id="l17.15"> );</span>
<a href="#l17.16"></a><span id="l17.16"> </span>
<a href="#l17.17"></a><span id="l17.17"> var kPrplId = &quot;green&quot;;</span>
<a href="#l17.18"></a><span id="l17.18"> var kPrplId2 = &quot;red&quot;;</span>
<a href="#l17.19"></a><span id="l17.19"> </span>
<a href="#l17.20"></a><span id="l17.20"> var fakeAccount = {</span>
<a href="#l17.21"></a><span id="l17.21">   connected: true,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/chat/components/src/test/test_conversations.js</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/chat/components/src/test/test_conversations.js</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -1,19 +1,18 @@</span>
<a href="#l18.4"></a><span id="l18.4"> /* Any copyright is dedicated to the Public Domain.</span>
<a href="#l18.5"></a><span id="l18.5">  * http://creativecommons.org/publicdomain/zero/1.0/ */</span>
<a href="#l18.6"></a><span id="l18.6"> </span>
<a href="#l18.7"></a><span id="l18.7"> var { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l18.8"></a><span id="l18.8"> var { GenericConvIMPrototype, Message } = ChromeUtils.import(</span>
<a href="#l18.9"></a><span id="l18.9">   &quot;resource:///modules/jsProtoHelper.jsm&quot;</span>
<a href="#l18.10"></a><span id="l18.10"> );</span>
<a href="#l18.11"></a><span id="l18.11" class="difflineminus">-</span>
<a href="#l18.12"></a><span id="l18.12"> var imConversations = {};</span>
<a href="#l18.13"></a><span id="l18.13"> Services.scriptloader.loadSubScript(</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineminus">-  &quot;resource:///components/imConversations.js&quot;,</span>
<a href="#l18.15"></a><span id="l18.15" class="difflineplus">+  &quot;resource:///modules/imConversations.jsm&quot;,</span>
<a href="#l18.16"></a><span id="l18.16">   imConversations</span>
<a href="#l18.17"></a><span id="l18.17"> );</span>
<a href="#l18.18"></a><span id="l18.18"> </span>
<a href="#l18.19"></a><span id="l18.19"> // Fake prplConversation</span>
<a href="#l18.20"></a><span id="l18.20"> var _id = 0;</span>
<a href="#l18.21"></a><span id="l18.21"> function Conversation(aName) {</span>
<a href="#l18.22"></a><span id="l18.22">   this._name = aName;</span>
<a href="#l18.23"></a><span id="l18.23">   this._observers = [];</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/chat/components/src/test/test_logger.js</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/chat/components/src/test/test_logger.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -3,20 +3,17 @@</span>
<a href="#l19.4"></a><span id="l19.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l19.5"></a><span id="l19.5"> </span>
<a href="#l19.6"></a><span id="l19.6"> do_get_profile();</span>
<a href="#l19.7"></a><span id="l19.7"> </span>
<a href="#l19.8"></a><span id="l19.8"> var { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l19.9"></a><span id="l19.9"> const { OS } = ChromeUtils.import(&quot;resource://gre/modules/osfile.jsm&quot;);</span>
<a href="#l19.10"></a><span id="l19.10"> </span>
<a href="#l19.11"></a><span id="l19.11"> var gLogger = {};</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-Services.scriptloader.loadSubScript(</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineminus">-  &quot;resource:///components/logger.js&quot;,</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineminus">-  gLogger</span>
<a href="#l19.15"></a><span id="l19.15" class="difflineminus">-);</span>
<a href="#l19.16"></a><span id="l19.16" class="difflineplus">+Services.scriptloader.loadSubScript(&quot;resource:///modules/logger.jsm&quot;, gLogger);</span>
<a href="#l19.17"></a><span id="l19.17"> </span>
<a href="#l19.18"></a><span id="l19.18"> var logDirPath = OS.Path.join(OS.Constants.Path.profileDir, &quot;logs&quot;);</span>
<a href="#l19.19"></a><span id="l19.19"> </span>
<a href="#l19.20"></a><span id="l19.20"> var dummyAccount = {</span>
<a href="#l19.21"></a><span id="l19.21">   name: &quot;dummy-account&quot;,</span>
<a href="#l19.22"></a><span id="l19.22">   normalizedName: &quot;dummyaccount&quot;,</span>
<a href="#l19.23"></a><span id="l19.23">   protocol: {</span>
<a href="#l19.24"></a><span id="l19.24">     normalizedName: &quot;dummy&quot;,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1">new file mode 100644</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineminus">--- /dev/null</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineplus">+++ b/chat/protocols/facebook/components.conf</span>
<a href="#l20.4"></a><span id="l20.4" class="difflineat">@@ -0,0 +1,15 @@</span>
<a href="#l20.5"></a><span id="l20.5" class="difflineplus">+# -*- Mode: python; indent-tabs-mode: nil; tab-width: 40 -*-</span>
<a href="#l20.6"></a><span id="l20.6" class="difflineplus">+# vim: set filetype=python:</span>
<a href="#l20.7"></a><span id="l20.7" class="difflineplus">+# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l20.8"></a><span id="l20.8" class="difflineplus">+# License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l20.9"></a><span id="l20.9" class="difflineplus">+# file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l20.10"></a><span id="l20.10" class="difflineplus">+</span>
<a href="#l20.11"></a><span id="l20.11" class="difflineplus">+Classes = [</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineplus">+  {</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineplus">+    'cid': '{1d1d0bc5-610c-472f-b2cb-4b89857d80dc}',</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineplus">+    'contract_ids': ['@mozilla.org/chat/facebook;1'],</span>
<a href="#l20.15"></a><span id="l20.15" class="difflineplus">+    'jsm': 'resource:///modules/facebook.jsm',</span>
<a href="#l20.16"></a><span id="l20.16" class="difflineplus">+    'constructor': 'FacebookProtocol',</span>
<a href="#l20.17"></a><span id="l20.17" class="difflineplus">+    'categories': {'im-protocol-plugin': 'prpl-facebook'},</span>
<a href="#l20.18"></a><span id="l20.18" class="difflineplus">+  },</span>
<a href="#l20.19"></a><span id="l20.19" class="difflineplus">+]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1">rename from chat/protocols/facebook/facebook.js</span>
<a href="#l21.2"></a><span id="l21.2">rename to chat/protocols/facebook/facebook.jsm</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineminus">--- a/chat/protocols/facebook/facebook.js</span>
<a href="#l21.4"></a><span id="l21.4" class="difflineplus">+++ b/chat/protocols/facebook/facebook.jsm</span>
<a href="#l21.5"></a><span id="l21.5" class="difflineat">@@ -1,12 +1,14 @@</span>
<a href="#l21.6"></a><span id="l21.6"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l21.7"></a><span id="l21.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l21.8"></a><span id="l21.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l21.9"></a><span id="l21.9"> </span>
<a href="#l21.10"></a><span id="l21.10" class="difflineplus">+var EXPORTED_SYMBOLS = [&quot;FacebookProtocol&quot;];</span>
<a href="#l21.11"></a><span id="l21.11" class="difflineplus">+</span>
<a href="#l21.12"></a><span id="l21.12"> var { XPCOMUtils, l10nHelper } = ChromeUtils.import(</span>
<a href="#l21.13"></a><span id="l21.13">   &quot;resource:///modules/imXPCOMUtils.jsm&quot;</span>
<a href="#l21.14"></a><span id="l21.14"> );</span>
<a href="#l21.15"></a><span id="l21.15"> var { GenericAccountPrototype, GenericProtocolPrototype } = ChromeUtils.import(</span>
<a href="#l21.16"></a><span id="l21.16">   &quot;resource:///modules/jsProtoHelper.jsm&quot;</span>
<a href="#l21.17"></a><span id="l21.17"> );</span>
<a href="#l21.18"></a><span id="l21.18"> </span>
<a href="#l21.19"></a><span id="l21.19"> XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l21.20"></a><span id="l21.20" class="difflineat">@@ -45,12 +47,9 @@ FacebookProtocol.prototype = {</span>
<a href="#l21.21"></a><span id="l21.21">     return _(&quot;facebook.chat.name&quot;);</span>
<a href="#l21.22"></a><span id="l21.22">   },</span>
<a href="#l21.23"></a><span id="l21.23">   get iconBaseURI() {</span>
<a href="#l21.24"></a><span id="l21.24">     return &quot;chrome://prpl-facebook/skin/&quot;;</span>
<a href="#l21.25"></a><span id="l21.25">   },</span>
<a href="#l21.26"></a><span id="l21.26">   getAccount(aImAccount) {</span>
<a href="#l21.27"></a><span id="l21.27">     return new FacebookAccount(this, aImAccount);</span>
<a href="#l21.28"></a><span id="l21.28">   },</span>
<a href="#l21.29"></a><span id="l21.29" class="difflineminus">-  classID: Components.ID(&quot;{1d1d0bc5-610c-472f-b2cb-4b89857d80dc}&quot;),</span>
<a href="#l21.30"></a><span id="l21.30"> };</span>
<a href="#l21.31"></a><span id="l21.31" class="difflineminus">-</span>
<a href="#l21.32"></a><span id="l21.32" class="difflineminus">-var NSGetFactory = XPCOMUtils.generateNSGetFactory([FacebookProtocol]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1">deleted file mode 100644</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineminus">--- a/chat/protocols/facebook/facebook.manifest</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineplus">+++ /dev/null</span>
<a href="#l22.4"></a><span id="l22.4" class="difflineat">@@ -1,3 +0,0 @@</span>
<a href="#l22.5"></a><span id="l22.5" class="difflineminus">-component {1d1d0bc5-610c-472f-b2cb-4b89857d80dc} facebook.js</span>
<a href="#l22.6"></a><span id="l22.6" class="difflineminus">-contract @mozilla.org/chat/facebook;1 {1d1d0bc5-610c-472f-b2cb-4b89857d80dc}</span>
<a href="#l22.7"></a><span id="l22.7" class="difflineminus">-category im-protocol-plugin prpl-facebook @mozilla.org/chat/facebook;1</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/chat/protocols/facebook/moz.build</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/chat/protocols/facebook/moz.build</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -1,11 +1,14 @@</span>
<a href="#l23.4"></a><span id="l23.4"> # vim: set filetype=python:</span>
<a href="#l23.5"></a><span id="l23.5"> # This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l23.6"></a><span id="l23.6"> # License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l23.7"></a><span id="l23.7"> # file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l23.8"></a><span id="l23.8"> </span>
<a href="#l23.9"></a><span id="l23.9" class="difflineminus">-EXTRA_COMPONENTS += [</span>
<a href="#l23.10"></a><span id="l23.10" class="difflineminus">-    'facebook.js',</span>
<a href="#l23.11"></a><span id="l23.11" class="difflineminus">-    'facebook.manifest',</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineplus">+JAR_MANIFESTS += ['jar.mn']</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineplus">+</span>
<a href="#l23.14"></a><span id="l23.14" class="difflineplus">+EXTRA_JS_MODULES += [</span>
<a href="#l23.15"></a><span id="l23.15" class="difflineplus">+    'facebook.jsm',</span>
<a href="#l23.16"></a><span id="l23.16"> ]</span>
<a href="#l23.17"></a><span id="l23.17"> </span>
<a href="#l23.18"></a><span id="l23.18" class="difflineminus">-JAR_MANIFESTS += ['jar.mn']</span>
<a href="#l23.19"></a><span id="l23.19" class="difflineplus">+XPCOM_MANIFESTS += [</span>
<a href="#l23.20"></a><span id="l23.20" class="difflineplus">+    'components.conf',</span>
<a href="#l23.21"></a><span id="l23.21" class="difflineplus">+]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1">new file mode 100644</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineminus">--- /dev/null</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineplus">+++ b/chat/protocols/gtalk/components.conf</span>
<a href="#l24.4"></a><span id="l24.4" class="difflineat">@@ -0,0 +1,15 @@</span>
<a href="#l24.5"></a><span id="l24.5" class="difflineplus">+# -*- Mode: python; indent-tabs-mode: nil; tab-width: 40 -*-</span>
<a href="#l24.6"></a><span id="l24.6" class="difflineplus">+# vim: set filetype=python:</span>
<a href="#l24.7"></a><span id="l24.7" class="difflineplus">+# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l24.8"></a><span id="l24.8" class="difflineplus">+# License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l24.9"></a><span id="l24.9" class="difflineplus">+# file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l24.10"></a><span id="l24.10" class="difflineplus">+</span>
<a href="#l24.11"></a><span id="l24.11" class="difflineplus">+Classes = [</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineplus">+  {</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineplus">+    'cid': '{38a224c1-6748-49a9-8ab2-efc362b1000d}',</span>
<a href="#l24.14"></a><span id="l24.14" class="difflineplus">+    'contract_ids': ['@mozilla.org/chat/gtalk;1'],</span>
<a href="#l24.15"></a><span id="l24.15" class="difflineplus">+    'jsm': 'resource:///modules/gtalk.jsm',</span>
<a href="#l24.16"></a><span id="l24.16" class="difflineplus">+    'constructor': 'GTalkProtocol',</span>
<a href="#l24.17"></a><span id="l24.17" class="difflineplus">+    'categories': {'im-protocol-plugin': 'prpl-gtalk'},</span>
<a href="#l24.18"></a><span id="l24.18" class="difflineplus">+  },</span>
<a href="#l24.19"></a><span id="l24.19" class="difflineplus">+]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1">rename from chat/protocols/gtalk/gtalk.js</span>
<a href="#l25.2"></a><span id="l25.2">rename to chat/protocols/gtalk/gtalk.jsm</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineminus">--- a/chat/protocols/gtalk/gtalk.js</span>
<a href="#l25.4"></a><span id="l25.4" class="difflineplus">+++ b/chat/protocols/gtalk/gtalk.jsm</span>
<a href="#l25.5"></a><span id="l25.5" class="difflineat">@@ -1,20 +1,22 @@</span>
<a href="#l25.6"></a><span id="l25.6"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l25.7"></a><span id="l25.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l25.8"></a><span id="l25.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l25.9"></a><span id="l25.9"> </span>
<a href="#l25.10"></a><span id="l25.10" class="difflineplus">+var EXPORTED_SYMBOLS = [&quot;GTalkProtocol&quot;];</span>
<a href="#l25.11"></a><span id="l25.11" class="difflineplus">+</span>
<a href="#l25.12"></a><span id="l25.12"> var { XPCOMUtils, l10nHelper } = ChromeUtils.import(</span>
<a href="#l25.13"></a><span id="l25.13">   &quot;resource:///modules/imXPCOMUtils.jsm&quot;</span>
<a href="#l25.14"></a><span id="l25.14"> );</span>
<a href="#l25.15"></a><span id="l25.15"> var { GenericProtocolPrototype } = ChromeUtils.import(</span>
<a href="#l25.16"></a><span id="l25.16">   &quot;resource:///modules/jsProtoHelper.jsm&quot;</span>
<a href="#l25.17"></a><span id="l25.17"> );</span>
<a href="#l25.18"></a><span id="l25.18"> var { XMPPAccountPrototype } = ChromeUtils.import(</span>
<a href="#l25.19"></a><span id="l25.19" class="difflineminus">-  &quot;resource:///modules/xmpp.jsm&quot;</span>
<a href="#l25.20"></a><span id="l25.20" class="difflineplus">+  &quot;resource:///modules/xmpp-base.jsm&quot;</span>
<a href="#l25.21"></a><span id="l25.21"> );</span>
<a href="#l25.22"></a><span id="l25.22"> var { XMPPSession } = ChromeUtils.import(</span>
<a href="#l25.23"></a><span id="l25.23">   &quot;resource:///modules/xmpp-session.jsm&quot;</span>
<a href="#l25.24"></a><span id="l25.24"> );</span>
<a href="#l25.25"></a><span id="l25.25"> var { Stanza } = ChromeUtils.import(&quot;resource:///modules/xmpp-xml.jsm&quot;);</span>
<a href="#l25.26"></a><span id="l25.26"> </span>
<a href="#l25.27"></a><span id="l25.27"> XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l25.28"></a><span id="l25.28">   l10nHelper(&quot;chrome://chat/locale/xmpp.properties&quot;)</span>
<a href="#l25.29"></a><span id="l25.29" class="difflineat">@@ -107,12 +109,9 @@ GTalkProtocol.prototype = {</span>
<a href="#l25.30"></a><span id="l25.30">         return _(&quot;options.resource&quot;);</span>
<a href="#l25.31"></a><span id="l25.31">       },</span>
<a href="#l25.32"></a><span id="l25.32">       default: &quot;&quot;,</span>
<a href="#l25.33"></a><span id="l25.33">     },</span>
<a href="#l25.34"></a><span id="l25.34">   },</span>
<a href="#l25.35"></a><span id="l25.35">   get chatHasTopic() {</span>
<a href="#l25.36"></a><span id="l25.36">     return true;</span>
<a href="#l25.37"></a><span id="l25.37">   },</span>
<a href="#l25.38"></a><span id="l25.38" class="difflineminus">-  classID: Components.ID(&quot;{38a224c1-6748-49a9-8ab2-efc362b1000d}&quot;),</span>
<a href="#l25.39"></a><span id="l25.39"> };</span>
<a href="#l25.40"></a><span id="l25.40" class="difflineminus">-</span>
<a href="#l25.41"></a><span id="l25.41" class="difflineminus">-var NSGetFactory = XPCOMUtils.generateNSGetFactory([GTalkProtocol]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1">deleted file mode 100644</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineminus">--- a/chat/protocols/gtalk/gtalk.manifest</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineplus">+++ /dev/null</span>
<a href="#l26.4"></a><span id="l26.4" class="difflineat">@@ -1,3 +0,0 @@</span>
<a href="#l26.5"></a><span id="l26.5" class="difflineminus">-component {38a224c1-6748-49a9-8ab2-efc362b1000d} gtalk.js</span>
<a href="#l26.6"></a><span id="l26.6" class="difflineminus">-contract @mozilla.org/chat/gtalk;1 {38a224c1-6748-49a9-8ab2-efc362b1000d}</span>
<a href="#l26.7"></a><span id="l26.7" class="difflineminus">-category im-protocol-plugin prpl-gtalk @mozilla.org/chat/gtalk;1</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/chat/protocols/gtalk/moz.build</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/chat/protocols/gtalk/moz.build</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -1,11 +1,14 @@</span>
<a href="#l27.4"></a><span id="l27.4"> # vim: set filetype=python:</span>
<a href="#l27.5"></a><span id="l27.5"> # This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l27.6"></a><span id="l27.6"> # License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l27.7"></a><span id="l27.7"> # file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l27.8"></a><span id="l27.8"> </span>
<a href="#l27.9"></a><span id="l27.9" class="difflineminus">-EXTRA_COMPONENTS += [</span>
<a href="#l27.10"></a><span id="l27.10" class="difflineminus">-    'gtalk.js',</span>
<a href="#l27.11"></a><span id="l27.11" class="difflineminus">-    'gtalk.manifest',</span>
<a href="#l27.12"></a><span id="l27.12" class="difflineplus">+JAR_MANIFESTS += ['jar.mn']</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineplus">+</span>
<a href="#l27.14"></a><span id="l27.14" class="difflineplus">+EXTRA_JS_MODULES += [</span>
<a href="#l27.15"></a><span id="l27.15" class="difflineplus">+    'gtalk.jsm',</span>
<a href="#l27.16"></a><span id="l27.16"> ]</span>
<a href="#l27.17"></a><span id="l27.17"> </span>
<a href="#l27.18"></a><span id="l27.18" class="difflineminus">-JAR_MANIFESTS += ['jar.mn']</span>
<a href="#l27.19"></a><span id="l27.19" class="difflineplus">+XPCOM_MANIFESTS += [</span>
<a href="#l27.20"></a><span id="l27.20" class="difflineplus">+    'components.conf',</span>
<a href="#l27.21"></a><span id="l27.21" class="difflineplus">+]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1">new file mode 100644</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineminus">--- /dev/null</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineplus">+++ b/chat/protocols/irc/components.conf</span>
<a href="#l28.4"></a><span id="l28.4" class="difflineat">@@ -0,0 +1,15 @@</span>
<a href="#l28.5"></a><span id="l28.5" class="difflineplus">+# -*- Mode: python; indent-tabs-mode: nil; tab-width: 40 -*-</span>
<a href="#l28.6"></a><span id="l28.6" class="difflineplus">+# vim: set filetype=python:</span>
<a href="#l28.7"></a><span id="l28.7" class="difflineplus">+# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l28.8"></a><span id="l28.8" class="difflineplus">+# License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l28.9"></a><span id="l28.9" class="difflineplus">+# file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l28.10"></a><span id="l28.10" class="difflineplus">+</span>
<a href="#l28.11"></a><span id="l28.11" class="difflineplus">+Classes = [</span>
<a href="#l28.12"></a><span id="l28.12" class="difflineplus">+  {</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineplus">+    'cid': '{607b2c0b-9504-483f-ad62-41de09238aec}',</span>
<a href="#l28.14"></a><span id="l28.14" class="difflineplus">+    'contract_ids': ['@mozilla.org/chat/irc;1'],</span>
<a href="#l28.15"></a><span id="l28.15" class="difflineplus">+    'jsm': 'resource:///modules/irc.jsm',</span>
<a href="#l28.16"></a><span id="l28.16" class="difflineplus">+    'constructor': 'ircProtocol',</span>
<a href="#l28.17"></a><span id="l28.17" class="difflineplus">+    'categories': {'im-protocol-plugin': 'prpl-irc'},</span>
<a href="#l28.18"></a><span id="l28.18" class="difflineplus">+  },</span>
<a href="#l28.19"></a><span id="l28.19" class="difflineplus">+]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1">rename from chat/protocols/irc/irc.js</span>
<a href="#l29.2"></a><span id="l29.2">rename to chat/protocols/irc/irc.jsm</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineminus">--- a/chat/protocols/irc/irc.js</span>
<a href="#l29.4"></a><span id="l29.4" class="difflineplus">+++ b/chat/protocols/irc/irc.jsm</span>
<a href="#l29.5"></a><span id="l29.5" class="difflineat">@@ -1,12 +1,14 @@</span>
<a href="#l29.6"></a><span id="l29.6"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l29.7"></a><span id="l29.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l29.8"></a><span id="l29.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l29.9"></a><span id="l29.9"> </span>
<a href="#l29.10"></a><span id="l29.10" class="difflineplus">+var EXPORTED_SYMBOLS = [&quot;ircProtocol&quot;];</span>
<a href="#l29.11"></a><span id="l29.11" class="difflineplus">+</span>
<a href="#l29.12"></a><span id="l29.12"> var {</span>
<a href="#l29.13"></a><span id="l29.13">   ClassInfo,</span>
<a href="#l29.14"></a><span id="l29.14">   clearTimeout,</span>
<a href="#l29.15"></a><span id="l29.15">   EmptyEnumerator,</span>
<a href="#l29.16"></a><span id="l29.16">   setTimeout,</span>
<a href="#l29.17"></a><span id="l29.17">   executeSoon,</span>
<a href="#l29.18"></a><span id="l29.18">   l10nHelper,</span>
<a href="#l29.19"></a><span id="l29.19">   XPCOMUtils,</span>
<a href="#l29.20"></a><span id="l29.20" class="difflineat">@@ -2412,12 +2414,9 @@ ircProtocol.prototype = {</span>
<a href="#l29.21"></a><span id="l29.21">   //  Passwords in IRC are optional, and are needed for certain functionality.</span>
<a href="#l29.22"></a><span id="l29.22">   get passwordOptional() {</span>
<a href="#l29.23"></a><span id="l29.23">     return true;</span>
<a href="#l29.24"></a><span id="l29.24">   },</span>
<a href="#l29.25"></a><span id="l29.25"> </span>
<a href="#l29.26"></a><span id="l29.26">   getAccount(aImAccount) {</span>
<a href="#l29.27"></a><span id="l29.27">     return new ircAccount(this, aImAccount);</span>
<a href="#l29.28"></a><span id="l29.28">   },</span>
<a href="#l29.29"></a><span id="l29.29" class="difflineminus">-  classID: Components.ID(&quot;{607b2c0b-9504-483f-ad62-41de09238aec}&quot;),</span>
<a href="#l29.30"></a><span id="l29.30"> };</span>
<a href="#l29.31"></a><span id="l29.31" class="difflineminus">-</span>
<a href="#l29.32"></a><span id="l29.32" class="difflineminus">-var NSGetFactory = XPCOMUtils.generateNSGetFactory([ircProtocol]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1">deleted file mode 100644</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineminus">--- a/chat/protocols/irc/irc.manifest</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineplus">+++ /dev/null</span>
<a href="#l30.4"></a><span id="l30.4" class="difflineat">@@ -1,3 +0,0 @@</span>
<a href="#l30.5"></a><span id="l30.5" class="difflineminus">-component {607b2c0b-9504-483f-ad62-41de09238aec} irc.js</span>
<a href="#l30.6"></a><span id="l30.6" class="difflineminus">-contract @mozilla.org/chat/irc;1 {607b2c0b-9504-483f-ad62-41de09238aec}</span>
<a href="#l30.7"></a><span id="l30.7" class="difflineminus">-category im-protocol-plugin prpl-irc @mozilla.org/chat/irc;1</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1" class="difflineminus">--- a/chat/protocols/irc/moz.build</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineplus">+++ b/chat/protocols/irc/moz.build</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineat">@@ -1,21 +1,17 @@</span>
<a href="#l31.4"></a><span id="l31.4"> # vim: set filetype=python:</span>
<a href="#l31.5"></a><span id="l31.5"> # This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l31.6"></a><span id="l31.6"> # License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l31.7"></a><span id="l31.7"> # file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l31.8"></a><span id="l31.8"> </span>
<a href="#l31.9"></a><span id="l31.9"> XPCSHELL_TESTS_MANIFESTS += ['test/xpcshell.ini']</span>
<a href="#l31.10"></a><span id="l31.10"> </span>
<a href="#l31.11"></a><span id="l31.11" class="difflineminus">-EXTRA_COMPONENTS += [</span>
<a href="#l31.12"></a><span id="l31.12" class="difflineminus">-    'irc.js',</span>
<a href="#l31.13"></a><span id="l31.13" class="difflineminus">-    'irc.manifest',</span>
<a href="#l31.14"></a><span id="l31.14" class="difflineminus">-]</span>
<a href="#l31.15"></a><span id="l31.15" class="difflineminus">-</span>
<a href="#l31.16"></a><span id="l31.16"> EXTRA_JS_MODULES += [</span>
<a href="#l31.17"></a><span id="l31.17" class="difflineplus">+    'irc.jsm',</span>
<a href="#l31.18"></a><span id="l31.18">     'ircBase.jsm',</span>
<a href="#l31.19"></a><span id="l31.19">     'ircCAP.jsm',</span>
<a href="#l31.20"></a><span id="l31.20">     'ircCommands.jsm',</span>
<a href="#l31.21"></a><span id="l31.21">     'ircCTCP.jsm',</span>
<a href="#l31.22"></a><span id="l31.22">     'ircDCC.jsm',</span>
<a href="#l31.23"></a><span id="l31.23">     'ircEchoMessage.jsm',</span>
<a href="#l31.24"></a><span id="l31.24">     'ircHandlers.jsm',</span>
<a href="#l31.25"></a><span id="l31.25">     'ircISUPPORT.jsm',</span>
<a href="#l31.26"></a><span id="l31.26" class="difflineat">@@ -24,8 +20,12 @@ EXTRA_JS_MODULES += [</span>
<a href="#l31.27"></a><span id="l31.27">     'ircSASL.jsm',</span>
<a href="#l31.28"></a><span id="l31.28">     'ircServerTime.jsm',</span>
<a href="#l31.29"></a><span id="l31.29">     'ircServices.jsm',</span>
<a href="#l31.30"></a><span id="l31.30">     'ircUtils.jsm',</span>
<a href="#l31.31"></a><span id="l31.31">     'ircWatchMonitor.jsm',</span>
<a href="#l31.32"></a><span id="l31.32"> ]</span>
<a href="#l31.33"></a><span id="l31.33"> </span>
<a href="#l31.34"></a><span id="l31.34"> JAR_MANIFESTS += ['jar.mn']</span>
<a href="#l31.35"></a><span id="l31.35" class="difflineplus">+</span>
<a href="#l31.36"></a><span id="l31.36" class="difflineplus">+XPCOM_MANIFESTS += [</span>
<a href="#l31.37"></a><span id="l31.37" class="difflineplus">+    'components.conf',</span>
<a href="#l31.38"></a><span id="l31.38" class="difflineplus">+]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1" class="difflineminus">--- a/chat/protocols/irc/test/test_ctcpQuote.js</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineplus">+++ b/chat/protocols/irc/test/test_ctcpQuote.js</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineat">@@ -1,14 +1,14 @@</span>
<a href="#l32.4"></a><span id="l32.4"> /* Any copyright is dedicated to the Public Domain.</span>
<a href="#l32.5"></a><span id="l32.5">  * http://creativecommons.org/publicdomain/zero/1.0/ */</span>
<a href="#l32.6"></a><span id="l32.6"> </span>
<a href="#l32.7"></a><span id="l32.7"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l32.8"></a><span id="l32.8"> var irc = {};</span>
<a href="#l32.9"></a><span id="l32.9" class="difflineminus">-Services.scriptloader.loadSubScript(&quot;resource:///components/irc.js&quot;, irc);</span>
<a href="#l32.10"></a><span id="l32.10" class="difflineplus">+Services.scriptloader.loadSubScript(&quot;resource:///modules/irc.jsm&quot;, irc);</span>
<a href="#l32.11"></a><span id="l32.11"> </span>
<a href="#l32.12"></a><span id="l32.12"> var input = [</span>
<a href="#l32.13"></a><span id="l32.13">   undefined,</span>
<a href="#l32.14"></a><span id="l32.14">   &quot;test&quot;,</span>
<a href="#l32.15"></a><span id="l32.15">   &quot;\\test&quot;,</span>
<a href="#l32.16"></a><span id="l32.16">   &quot;te\\st&quot;,</span>
<a href="#l32.17"></a><span id="l32.17">   &quot;test\\&quot;,</span>
<a href="#l32.18"></a><span id="l32.18">   &quot;\\\\test&quot;,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1" class="difflineminus">--- a/chat/protocols/irc/test/test_ircCommands.js</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineplus">+++ b/chat/protocols/irc/test/test_ircCommands.js</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineat">@@ -1,16 +1,15 @@</span>
<a href="#l33.4"></a><span id="l33.4"> /* Any copyright is dedicated to the Public Domain.</span>
<a href="#l33.5"></a><span id="l33.5">  * http://creativecommons.org/publicdomain/zero/1.0/ */</span>
<a href="#l33.6"></a><span id="l33.6"> </span>
<a href="#l33.7"></a><span id="l33.7"> var { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l33.8"></a><span id="l33.8"> var { commands } = ChromeUtils.import(&quot;resource:///modules/ircCommands.jsm&quot;);</span>
<a href="#l33.9"></a><span id="l33.9" class="difflineminus">-</span>
<a href="#l33.10"></a><span id="l33.10"> var irc = {};</span>
<a href="#l33.11"></a><span id="l33.11" class="difflineminus">-Services.scriptloader.loadSubScript(&quot;resource:///components/irc.js&quot;, irc);</span>
<a href="#l33.12"></a><span id="l33.12" class="difflineplus">+Services.scriptloader.loadSubScript(&quot;resource:///modules/irc.jsm&quot;, irc);</span>
<a href="#l33.13"></a><span id="l33.13"> </span>
<a href="#l33.14"></a><span id="l33.14"> // Ensure the commands have been initialized.</span>
<a href="#l33.15"></a><span id="l33.15"> Services.conversations.initConversations();</span>
<a href="#l33.16"></a><span id="l33.16"> </span>
<a href="#l33.17"></a><span id="l33.17"> var fakeProto = {</span>
<a href="#l33.18"></a><span id="l33.18">   id: &quot;fake-proto&quot;,</span>
<a href="#l33.19"></a><span id="l33.19"> };</span>
<a href="#l33.20"></a><span id="l33.20"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1" class="difflineminus">--- a/chat/protocols/irc/test/test_ircMessage.js</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineplus">+++ b/chat/protocols/irc/test/test_ircMessage.js</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineat">@@ -1,14 +1,14 @@</span>
<a href="#l34.4"></a><span id="l34.4"> /* Any copyright is dedicated to the Public Domain.</span>
<a href="#l34.5"></a><span id="l34.5">  * http://creativecommons.org/publicdomain/zero/1.0/ */</span>
<a href="#l34.6"></a><span id="l34.6"> </span>
<a href="#l34.7"></a><span id="l34.7"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l34.8"></a><span id="l34.8"> var irc = {};</span>
<a href="#l34.9"></a><span id="l34.9" class="difflineminus">-Services.scriptloader.loadSubScript(&quot;resource:///components/irc.js&quot;, irc);</span>
<a href="#l34.10"></a><span id="l34.10" class="difflineplus">+Services.scriptloader.loadSubScript(&quot;resource:///modules/irc.jsm&quot;, irc);</span>
<a href="#l34.11"></a><span id="l34.11"> </span>
<a href="#l34.12"></a><span id="l34.12"> var testData = [</span>
<a href="#l34.13"></a><span id="l34.13">   // First off, let's test the messages from RFC 2812.</span>
<a href="#l34.14"></a><span id="l34.14">   &quot;PASS secretpasswordhere&quot;,</span>
<a href="#l34.15"></a><span id="l34.15">   &quot;NICK Wiz&quot;,</span>
<a href="#l34.16"></a><span id="l34.16">   &quot;:WiZ!jto@tolsun.oulu.fi NICK Kilroy&quot;,</span>
<a href="#l34.17"></a><span id="l34.17">   &quot;USER guest 0 * :Ronnie Reagan&quot;,</span>
<a href="#l34.18"></a><span id="l34.18">   &quot;USER guest 8 * :Ronnie Reagan&quot;,</span>
<a href="#l34.19"></a><span id="l34.19" class="difflineat">@@ -148,17 +148,17 @@ function testRFC2812Messages() {</span>
<a href="#l34.20"></a><span id="l34.20">     }</span>
<a href="#l34.21"></a><span id="l34.21"> </span>
<a href="#l34.22"></a><span id="l34.22">     equal(stringMessage, expectedStringMessage);</span>
<a href="#l34.23"></a><span id="l34.23">   }</span>
<a href="#l34.24"></a><span id="l34.24"> </span>
<a href="#l34.25"></a><span id="l34.25">   run_next_test();</span>
<a href="#l34.26"></a><span id="l34.26"> }</span>
<a href="#l34.27"></a><span id="l34.27"> </span>
<a href="#l34.28"></a><span id="l34.28" class="difflineminus">-// Unreal sends a couple of broken messages, see ircMessage in irc.js for a</span>
<a href="#l34.29"></a><span id="l34.29" class="difflineplus">+// Unreal sends a couple of broken messages, see ircMessage in irc.jsm for a</span>
<a href="#l34.30"></a><span id="l34.30"> // description of what's wrong.</span>
<a href="#l34.31"></a><span id="l34.31"> function testBrokenUnrealMessages() {</span>
<a href="#l34.32"></a><span id="l34.32">   let messages = {</span>
<a href="#l34.33"></a><span id="l34.33">     // Two spaces after command.</span>
<a href="#l34.34"></a><span id="l34.34">     &quot;:gravel.mozilla.org 432  #momo :Erroneous Nickname: Illegal characters&quot;: {</span>
<a href="#l34.35"></a><span id="l34.35">       rawMessage:</span>
<a href="#l34.36"></a><span id="l34.36">         &quot;:gravel.mozilla.org 432  #momo :Erroneous Nickname: Illegal characters&quot;,</span>
<a href="#l34.37"></a><span id="l34.37">       command: &quot;432&quot;,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l35.1"></a><span id="l35.1" class="difflineminus">--- a/chat/protocols/irc/test/test_ircNonStandard.js</span>
<a href="#l35.2"></a><span id="l35.2" class="difflineplus">+++ b/chat/protocols/irc/test/test_ircNonStandard.js</span>
<a href="#l35.3"></a><span id="l35.3" class="difflineat">@@ -1,14 +1,14 @@</span>
<a href="#l35.4"></a><span id="l35.4"> /* Any copyright is dedicated to the Public Domain.</span>
<a href="#l35.5"></a><span id="l35.5">  * http://creativecommons.org/publicdomain/zero/1.0/ */</span>
<a href="#l35.6"></a><span id="l35.6"> </span>
<a href="#l35.7"></a><span id="l35.7"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l35.8"></a><span id="l35.8"> var irc = {};</span>
<a href="#l35.9"></a><span id="l35.9" class="difflineminus">-Services.scriptloader.loadSubScript(&quot;resource:///components/irc.js&quot;, irc);</span>
<a href="#l35.10"></a><span id="l35.10" class="difflineplus">+Services.scriptloader.loadSubScript(&quot;resource:///modules/irc.jsm&quot;, irc);</span>
<a href="#l35.11"></a><span id="l35.11"> const { ircNonStandard } = ChromeUtils.import(</span>
<a href="#l35.12"></a><span id="l35.12">   &quot;resource:///modules/ircNonStandard.jsm&quot;</span>
<a href="#l35.13"></a><span id="l35.13"> );</span>
<a href="#l35.14"></a><span id="l35.14"> </span>
<a href="#l35.15"></a><span id="l35.15"> // The function that is under test here.</span>
<a href="#l35.16"></a><span id="l35.16"> var NOTICE = ircNonStandard.commands.NOTICE;</span>
<a href="#l35.17"></a><span id="l35.17"> </span>
<a href="#l35.18"></a><span id="l35.18"> function FakeConversation() {}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l36.1"></a><span id="l36.1" class="difflineminus">--- a/chat/protocols/irc/test/test_ircServerTime.js</span>
<a href="#l36.2"></a><span id="l36.2" class="difflineplus">+++ b/chat/protocols/irc/test/test_ircServerTime.js</span>
<a href="#l36.3"></a><span id="l36.3" class="difflineat">@@ -2,17 +2,17 @@</span>
<a href="#l36.4"></a><span id="l36.4">  * http://creativecommons.org/publicdomain/zero/1.0/ */</span>
<a href="#l36.5"></a><span id="l36.5"> </span>
<a href="#l36.6"></a><span id="l36.6"> var { tagServerTime } = ChromeUtils.import(</span>
<a href="#l36.7"></a><span id="l36.7">   &quot;resource:///modules/ircServerTime.jsm&quot;</span>
<a href="#l36.8"></a><span id="l36.8"> );</span>
<a href="#l36.9"></a><span id="l36.9"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l36.10"></a><span id="l36.10"> </span>
<a href="#l36.11"></a><span id="l36.11"> var irc = {};</span>
<a href="#l36.12"></a><span id="l36.12" class="difflineminus">-Services.scriptloader.loadSubScript(&quot;resource:///components/irc.js&quot;, irc);</span>
<a href="#l36.13"></a><span id="l36.13" class="difflineplus">+Services.scriptloader.loadSubScript(&quot;resource:///modules/irc.jsm&quot;, irc);</span>
<a href="#l36.14"></a><span id="l36.14"> </span>
<a href="#l36.15"></a><span id="l36.15"> function getTags(aRawMsg) {</span>
<a href="#l36.16"></a><span id="l36.16">   const { tags } = irc.ircMessage(aRawMsg, &quot;doesnt@matter&quot;);</span>
<a href="#l36.17"></a><span id="l36.17"> </span>
<a href="#l36.18"></a><span id="l36.18">   return tags;</span>
<a href="#l36.19"></a><span id="l36.19"> }</span>
<a href="#l36.20"></a><span id="l36.20"> </span>
<a href="#l36.21"></a><span id="l36.21"> function run_test() {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l37.1"></a><span id="l37.1" class="difflineminus">--- a/chat/protocols/irc/test/test_sendBufferedCommand.js</span>
<a href="#l37.2"></a><span id="l37.2" class="difflineplus">+++ b/chat/protocols/irc/test/test_sendBufferedCommand.js</span>
<a href="#l37.3"></a><span id="l37.3" class="difflineat">@@ -1,15 +1,15 @@</span>
<a href="#l37.4"></a><span id="l37.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l37.5"></a><span id="l37.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l37.6"></a><span id="l37.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l37.7"></a><span id="l37.7"> </span>
<a href="#l37.8"></a><span id="l37.8"> var { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l37.9"></a><span id="l37.9"> var irc = {};</span>
<a href="#l37.10"></a><span id="l37.10" class="difflineminus">-Services.scriptloader.loadSubScript(&quot;resource:///components/irc.js&quot;, irc);</span>
<a href="#l37.11"></a><span id="l37.11" class="difflineplus">+Services.scriptloader.loadSubScript(&quot;resource:///modules/irc.jsm&quot;, irc);</span>
<a href="#l37.12"></a><span id="l37.12"> </span>
<a href="#l37.13"></a><span id="l37.13"> function FakeAccount() {</span>
<a href="#l37.14"></a><span id="l37.14">   this._commandBuffers = new Map();</span>
<a href="#l37.15"></a><span id="l37.15">   this.callbacks = [];</span>
<a href="#l37.16"></a><span id="l37.16"> }</span>
<a href="#l37.17"></a><span id="l37.17"> FakeAccount.prototype = {</span>
<a href="#l37.18"></a><span id="l37.18">   __proto__: irc.ircAccount.prototype,</span>
<a href="#l37.19"></a><span id="l37.19">   maxMessageLength: 60,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l38.1"></a><span id="l38.1" class="difflineminus">--- a/chat/protocols/irc/test/test_setMode.js</span>
<a href="#l38.2"></a><span id="l38.2" class="difflineplus">+++ b/chat/protocols/irc/test/test_setMode.js</span>
<a href="#l38.3"></a><span id="l38.3" class="difflineat">@@ -1,14 +1,14 @@</span>
<a href="#l38.4"></a><span id="l38.4"> /* Any copyright is dedicated to the Public Domain.</span>
<a href="#l38.5"></a><span id="l38.5">  * http://creativecommons.org/publicdomain/zero/1.0/ */</span>
<a href="#l38.6"></a><span id="l38.6"> </span>
<a href="#l38.7"></a><span id="l38.7"> var { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l38.8"></a><span id="l38.8"> var irc = {};</span>
<a href="#l38.9"></a><span id="l38.9" class="difflineminus">-Services.scriptloader.loadSubScript(&quot;resource:///components/irc.js&quot;, irc);</span>
<a href="#l38.10"></a><span id="l38.10" class="difflineplus">+Services.scriptloader.loadSubScript(&quot;resource:///modules/irc.jsm&quot;, irc);</span>
<a href="#l38.11"></a><span id="l38.11"> Services.conversations.initConversations();</span>
<a href="#l38.12"></a><span id="l38.12"> </span>
<a href="#l38.13"></a><span id="l38.13"> function FakeAccount() {</span>
<a href="#l38.14"></a><span id="l38.14">   this.normalizeNick = irc.ircAccount.prototype.normalizeNick.bind(this);</span>
<a href="#l38.15"></a><span id="l38.15"> }</span>
<a href="#l38.16"></a><span id="l38.16"> FakeAccount.prototype = {</span>
<a href="#l38.17"></a><span id="l38.17">   __proto__: irc.ircAccount.prototype,</span>
<a href="#l38.18"></a><span id="l38.18">   setWhois: (n, f) =&gt; true,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l39.1"></a><span id="l39.1" class="difflineminus">--- a/chat/protocols/irc/test/test_splitLongMessages.js</span>
<a href="#l39.2"></a><span id="l39.2" class="difflineplus">+++ b/chat/protocols/irc/test/test_splitLongMessages.js</span>
<a href="#l39.3"></a><span id="l39.3" class="difflineat">@@ -1,14 +1,14 @@</span>
<a href="#l39.4"></a><span id="l39.4"> /* Any copyright is dedicated to the Public Domain.</span>
<a href="#l39.5"></a><span id="l39.5">  * http://creativecommons.org/publicdomain/zero/1.0/ */</span>
<a href="#l39.6"></a><span id="l39.6"> </span>
<a href="#l39.7"></a><span id="l39.7"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l39.8"></a><span id="l39.8"> var irc = {};</span>
<a href="#l39.9"></a><span id="l39.9" class="difflineminus">-Services.scriptloader.loadSubScript(&quot;resource:///components/irc.js&quot;, irc);</span>
<a href="#l39.10"></a><span id="l39.10" class="difflineplus">+Services.scriptloader.loadSubScript(&quot;resource:///modules/irc.jsm&quot;, irc);</span>
<a href="#l39.11"></a><span id="l39.11"> </span>
<a href="#l39.12"></a><span id="l39.12"> var messages = {</span>
<a href="#l39.13"></a><span id="l39.13">   // Exactly 51 characters.</span>
<a href="#l39.14"></a><span id="l39.14">   &quot;This is a test.&quot;: [&quot;This is a test.&quot;],</span>
<a href="#l39.15"></a><span id="l39.15">   // Too long.</span>
<a href="#l39.16"></a><span id="l39.16">   &quot;This is a message that is too long.&quot;: [</span>
<a href="#l39.17"></a><span id="l39.17">     &quot;This is a&quot;,</span>
<a href="#l39.18"></a><span id="l39.18">     &quot;message that is&quot;,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l40.1"></a><span id="l40.1" class="difflineminus">--- a/chat/protocols/irc/test/test_tryNewNick.js</span>
<a href="#l40.2"></a><span id="l40.2" class="difflineplus">+++ b/chat/protocols/irc/test/test_tryNewNick.js</span>
<a href="#l40.3"></a><span id="l40.3" class="difflineat">@@ -1,14 +1,14 @@</span>
<a href="#l40.4"></a><span id="l40.4"> /* Any copyright is dedicated to the Public Domain.</span>
<a href="#l40.5"></a><span id="l40.5">  * http://creativecommons.org/publicdomain/zero/1.0/ */</span>
<a href="#l40.6"></a><span id="l40.6"> </span>
<a href="#l40.7"></a><span id="l40.7"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l40.8"></a><span id="l40.8"> var irc = {};</span>
<a href="#l40.9"></a><span id="l40.9" class="difflineminus">-Services.scriptloader.loadSubScript(&quot;resource:///components/irc.js&quot;, irc);</span>
<a href="#l40.10"></a><span id="l40.10" class="difflineplus">+Services.scriptloader.loadSubScript(&quot;resource:///modules/irc.jsm&quot;, irc);</span>
<a href="#l40.11"></a><span id="l40.11"> </span>
<a href="#l40.12"></a><span id="l40.12"> var fakeProto = {</span>
<a href="#l40.13"></a><span id="l40.13">   id: &quot;fake-proto&quot;,</span>
<a href="#l40.14"></a><span id="l40.14">   options: { alternateNicks: &quot;&quot; },</span>
<a href="#l40.15"></a><span id="l40.15">   _getOptionDefault(aOption) {</span>
<a href="#l40.16"></a><span id="l40.16">     return this.options[aOption];</span>
<a href="#l40.17"></a><span id="l40.17">   },</span>
<a href="#l40.18"></a><span id="l40.18"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l41.1"></a><span id="l41.1">new file mode 100644</span>
<a href="#l41.2"></a><span id="l41.2" class="difflineminus">--- /dev/null</span>
<a href="#l41.3"></a><span id="l41.3" class="difflineplus">+++ b/chat/protocols/jsTest/components.conf</span>
<a href="#l41.4"></a><span id="l41.4" class="difflineat">@@ -0,0 +1,15 @@</span>
<a href="#l41.5"></a><span id="l41.5" class="difflineplus">+# -*- Mode: python; indent-tabs-mode: nil; tab-width: 40 -*-</span>
<a href="#l41.6"></a><span id="l41.6" class="difflineplus">+# vim: set filetype=python:</span>
<a href="#l41.7"></a><span id="l41.7" class="difflineplus">+# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l41.8"></a><span id="l41.8" class="difflineplus">+# License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l41.9"></a><span id="l41.9" class="difflineplus">+# file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l41.10"></a><span id="l41.10" class="difflineplus">+</span>
<a href="#l41.11"></a><span id="l41.11" class="difflineplus">+Classes = [</span>
<a href="#l41.12"></a><span id="l41.12" class="difflineplus">+  {</span>
<a href="#l41.13"></a><span id="l41.13" class="difflineplus">+    'cid': '{a0774c5a-4aea-458b-9fbc-8d3cbf1a4630}',</span>
<a href="#l41.14"></a><span id="l41.14" class="difflineplus">+    'contract_ids': ['@mozilla.org/chat/jstest;1'],</span>
<a href="#l41.15"></a><span id="l41.15" class="difflineplus">+    'jsm': 'resource:///modules/jsTestProtocol.jsm',</span>
<a href="#l41.16"></a><span id="l41.16" class="difflineplus">+    'constructor': 'JSTestProtocol',</span>
<a href="#l41.17"></a><span id="l41.17" class="difflineplus">+    'categories': {'im-protocol-plugin': 'prpl-jstest'},</span>
<a href="#l41.18"></a><span id="l41.18" class="difflineplus">+  },</span>
<a href="#l41.19"></a><span id="l41.19" class="difflineplus">+]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l42.1"></a><span id="l42.1">rename from chat/protocols/jsTest/jsTestProtocol.js</span>
<a href="#l42.2"></a><span id="l42.2">rename to chat/protocols/jsTest/jsTestProtocol.jsm</span>
<a href="#l42.3"></a><span id="l42.3" class="difflineminus">--- a/chat/protocols/jsTest/jsTestProtocol.js</span>
<a href="#l42.4"></a><span id="l42.4" class="difflineplus">+++ b/chat/protocols/jsTest/jsTestProtocol.jsm</span>
<a href="#l42.5"></a><span id="l42.5" class="difflineat">@@ -1,15 +1,15 @@</span>
<a href="#l42.6"></a><span id="l42.6"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l42.7"></a><span id="l42.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l42.8"></a><span id="l42.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l42.9"></a><span id="l42.9"> </span>
<a href="#l42.10"></a><span id="l42.10" class="difflineminus">-var { XPCOMUtils, setTimeout } = ChromeUtils.import(</span>
<a href="#l42.11"></a><span id="l42.11" class="difflineminus">-  &quot;resource:///modules/imXPCOMUtils.jsm&quot;</span>
<a href="#l42.12"></a><span id="l42.12" class="difflineminus">-);</span>
<a href="#l42.13"></a><span id="l42.13" class="difflineplus">+var EXPORTED_SYMBOLS = [&quot;JSTestProtocol&quot;];</span>
<a href="#l42.14"></a><span id="l42.14" class="difflineplus">+</span>
<a href="#l42.15"></a><span id="l42.15" class="difflineplus">+var { setTimeout } = ChromeUtils.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l42.16"></a><span id="l42.16"> var {</span>
<a href="#l42.17"></a><span id="l42.17">   GenericAccountPrototype,</span>
<a href="#l42.18"></a><span id="l42.18">   GenericConvIMPrototype,</span>
<a href="#l42.19"></a><span id="l42.19">   GenericProtocolPrototype,</span>
<a href="#l42.20"></a><span id="l42.20"> } = ChromeUtils.import(&quot;resource:///modules/jsProtoHelper.jsm&quot;);</span>
<a href="#l42.21"></a><span id="l42.21"> </span>
<a href="#l42.22"></a><span id="l42.22"> function Conversation(aAccount) {</span>
<a href="#l42.23"></a><span id="l42.23">   this._init(aAccount);</span>
<a href="#l42.24"></a><span id="l42.24" class="difflineat">@@ -102,18 +102,18 @@ Account.prototype = {</span>
<a href="#l42.25"></a><span id="l42.25">       required: true,</span>
<a href="#l42.26"></a><span id="l42.26">     },</span>
<a href="#l42.27"></a><span id="l42.27">   },</span>
<a href="#l42.28"></a><span id="l42.28"> </span>
<a href="#l42.29"></a><span id="l42.29">   // Nothing to do.</span>
<a href="#l42.30"></a><span id="l42.30">   unInit() {},</span>
<a href="#l42.31"></a><span id="l42.31"> };</span>
<a href="#l42.32"></a><span id="l42.32"> </span>
<a href="#l42.33"></a><span id="l42.33" class="difflineminus">-function jsTestProtocol() {}</span>
<a href="#l42.34"></a><span id="l42.34" class="difflineminus">-jsTestProtocol.prototype = {</span>
<a href="#l42.35"></a><span id="l42.35" class="difflineplus">+function JSTestProtocol() {}</span>
<a href="#l42.36"></a><span id="l42.36" class="difflineplus">+JSTestProtocol.prototype = {</span>
<a href="#l42.37"></a><span id="l42.37">   __proto__: GenericProtocolPrototype,</span>
<a href="#l42.38"></a><span id="l42.38">   get name() {</span>
<a href="#l42.39"></a><span id="l42.39">     return &quot;JS Test&quot;;</span>
<a href="#l42.40"></a><span id="l42.40">   },</span>
<a href="#l42.41"></a><span id="l42.41">   options: {</span>
<a href="#l42.42"></a><span id="l42.42">     text: { label: &quot;Text option&quot;, default: &quot;foo&quot; },</span>
<a href="#l42.43"></a><span id="l42.43">     bool: { label: &quot;Boolean option&quot;, default: true },</span>
<a href="#l42.44"></a><span id="l42.44">     int: { label: &quot;Integer option&quot;, default: 42 },</span>
<a href="#l42.45"></a><span id="l42.45" class="difflineat">@@ -133,12 +133,9 @@ jsTestProtocol.prototype = {</span>
<a href="#l42.46"></a><span id="l42.46">       separator: &quot;@&quot;,</span>
<a href="#l42.47"></a><span id="l42.47">       defaultValue: &quot;default.server&quot;,</span>
<a href="#l42.48"></a><span id="l42.48">       reverse: true,</span>
<a href="#l42.49"></a><span id="l42.49">     },</span>
<a href="#l42.50"></a><span id="l42.50">   ],</span>
<a href="#l42.51"></a><span id="l42.51">   getAccount(aImAccount) {</span>
<a href="#l42.52"></a><span id="l42.52">     return new Account(this, aImAccount);</span>
<a href="#l42.53"></a><span id="l42.53">   },</span>
<a href="#l42.54"></a><span id="l42.54" class="difflineminus">-  classID: Components.ID(&quot;{a0774c5a-4aea-458b-9fbc-8d3cbf1a4630}&quot;),</span>
<a href="#l42.55"></a><span id="l42.55"> };</span>
<a href="#l42.56"></a><span id="l42.56" class="difflineminus">-</span>
<a href="#l42.57"></a><span id="l42.57" class="difflineminus">-var NSGetFactory = XPCOMUtils.generateNSGetFactory([jsTestProtocol]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l43.1"></a><span id="l43.1">deleted file mode 100644</span>
<a href="#l43.2"></a><span id="l43.2" class="difflineminus">--- a/chat/protocols/jsTest/jsTestProtocol.manifest</span>
<a href="#l43.3"></a><span id="l43.3" class="difflineplus">+++ /dev/null</span>
<a href="#l43.4"></a><span id="l43.4" class="difflineat">@@ -1,3 +0,0 @@</span>
<a href="#l43.5"></a><span id="l43.5" class="difflineminus">-component {a0774c5a-4aea-458b-9fbc-8d3cbf1a4630} jsTestProtocol.js</span>
<a href="#l43.6"></a><span id="l43.6" class="difflineminus">-contract @mozilla.org/chat/jstest;1 {a0774c5a-4aea-458b-9fbc-8d3cbf1a4630}</span>
<a href="#l43.7"></a><span id="l43.7" class="difflineminus">-category im-protocol-plugin prpl-jstest @mozilla.org/chat/jstest;1</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l44.1"></a><span id="l44.1" class="difflineminus">--- a/chat/protocols/jsTest/moz.build</span>
<a href="#l44.2"></a><span id="l44.2" class="difflineplus">+++ b/chat/protocols/jsTest/moz.build</span>
<a href="#l44.3"></a><span id="l44.3" class="difflineat">@@ -1,11 +1,14 @@</span>
<a href="#l44.4"></a><span id="l44.4"> # vim: set filetype=python:</span>
<a href="#l44.5"></a><span id="l44.5"> # This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l44.6"></a><span id="l44.6"> # License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l44.7"></a><span id="l44.7"> # file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l44.8"></a><span id="l44.8"> </span>
<a href="#l44.9"></a><span id="l44.9"> if CONFIG['MOZ_DEBUG']:</span>
<a href="#l44.10"></a><span id="l44.10" class="difflineminus">-    EXTRA_COMPONENTS += [</span>
<a href="#l44.11"></a><span id="l44.11" class="difflineminus">-        'jsTestProtocol.js',</span>
<a href="#l44.12"></a><span id="l44.12" class="difflineminus">-        'jsTestProtocol.manifest',</span>
<a href="#l44.13"></a><span id="l44.13" class="difflineplus">+    EXTRA_JS_MODULES += [</span>
<a href="#l44.14"></a><span id="l44.14" class="difflineplus">+        'jsTestProtocol.jsm',</span>
<a href="#l44.15"></a><span id="l44.15">     ]</span>
<a href="#l44.16"></a><span id="l44.16"> </span>
<a href="#l44.17"></a><span id="l44.17" class="difflineplus">+    XPCOM_MANIFESTS += [</span>
<a href="#l44.18"></a><span id="l44.18" class="difflineplus">+        'components.conf',</span>
<a href="#l44.19"></a><span id="l44.19" class="difflineplus">+    ]</span>
<a href="#l44.20"></a><span id="l44.20" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l45.1"></a><span id="l45.1">new file mode 100644</span>
<a href="#l45.2"></a><span id="l45.2" class="difflineminus">--- /dev/null</span>
<a href="#l45.3"></a><span id="l45.3" class="difflineplus">+++ b/chat/protocols/matrix/components.conf</span>
<a href="#l45.4"></a><span id="l45.4" class="difflineat">@@ -0,0 +1,15 @@</span>
<a href="#l45.5"></a><span id="l45.5" class="difflineplus">+# -*- Mode: python; indent-tabs-mode: nil; tab-width: 40 -*-</span>
<a href="#l45.6"></a><span id="l45.6" class="difflineplus">+# vim: set filetype=python:</span>
<a href="#l45.7"></a><span id="l45.7" class="difflineplus">+# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l45.8"></a><span id="l45.8" class="difflineplus">+# License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l45.9"></a><span id="l45.9" class="difflineplus">+# file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l45.10"></a><span id="l45.10" class="difflineplus">+</span>
<a href="#l45.11"></a><span id="l45.11" class="difflineplus">+Classes = [</span>
<a href="#l45.12"></a><span id="l45.12" class="difflineplus">+  {</span>
<a href="#l45.13"></a><span id="l45.13" class="difflineplus">+    'cid': '{e9653ac6-a671-11e6-bf84-60a44c717042}',</span>
<a href="#l45.14"></a><span id="l45.14" class="difflineplus">+    'contract_ids': ['@mozilla.org/chat/matrix;1'],</span>
<a href="#l45.15"></a><span id="l45.15" class="difflineplus">+    'jsm': 'resource:///modules/matrix.jsm',</span>
<a href="#l45.16"></a><span id="l45.16" class="difflineplus">+    'constructor': 'MatrixProtocol',</span>
<a href="#l45.17"></a><span id="l45.17" class="difflineplus">+    'categories': {'im-protocol-plugin': 'prpl-matrix'},</span>
<a href="#l45.18"></a><span id="l45.18" class="difflineplus">+  },</span>
<a href="#l45.19"></a><span id="l45.19" class="difflineplus">+]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l46.1"></a><span id="l46.1">rename from chat/protocols/matrix/matrix.js</span>
<a href="#l46.2"></a><span id="l46.2">rename to chat/protocols/matrix/matrix.jsm</span>
<a href="#l46.3"></a><span id="l46.3" class="difflineminus">--- a/chat/protocols/matrix/matrix.js</span>
<a href="#l46.4"></a><span id="l46.4" class="difflineplus">+++ b/chat/protocols/matrix/matrix.jsm</span>
<a href="#l46.5"></a><span id="l46.5" class="difflineat">@@ -1,12 +1,14 @@</span>
<a href="#l46.6"></a><span id="l46.6"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l46.7"></a><span id="l46.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l46.8"></a><span id="l46.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l46.9"></a><span id="l46.9"> </span>
<a href="#l46.10"></a><span id="l46.10" class="difflineplus">+var EXPORTED_SYMBOLS = [&quot;MatrixProtocol&quot;];</span>
<a href="#l46.11"></a><span id="l46.11" class="difflineplus">+</span>
<a href="#l46.12"></a><span id="l46.12"> var { XPCOMUtils, nsSimpleEnumerator, l10nHelper } = ChromeUtils.import(</span>
<a href="#l46.13"></a><span id="l46.13">   &quot;resource:///modules/imXPCOMUtils.jsm&quot;</span>
<a href="#l46.14"></a><span id="l46.14"> );</span>
<a href="#l46.15"></a><span id="l46.15"> var {</span>
<a href="#l46.16"></a><span id="l46.16">   GenericAccountPrototype,</span>
<a href="#l46.17"></a><span id="l46.17">   GenericConvChatPrototype,</span>
<a href="#l46.18"></a><span id="l46.18">   GenericConvChatBuddyPrototype,</span>
<a href="#l46.19"></a><span id="l46.19">   GenericProtocolPrototype,</span>
<a href="#l46.20"></a><span id="l46.20" class="difflineat">@@ -355,13 +357,9 @@ MatrixProtocol.prototype = {</span>
<a href="#l46.21"></a><span id="l46.21">       },</span>
<a href="#l46.22"></a><span id="l46.22">       default: 443,</span>
<a href="#l46.23"></a><span id="l46.23">     },</span>
<a href="#l46.24"></a><span id="l46.24">   },</span>
<a href="#l46.25"></a><span id="l46.25"> </span>
<a href="#l46.26"></a><span id="l46.26">   get chatHasTopic() {</span>
<a href="#l46.27"></a><span id="l46.27">     return true;</span>
<a href="#l46.28"></a><span id="l46.28">   },</span>
<a href="#l46.29"></a><span id="l46.29" class="difflineminus">-</span>
<a href="#l46.30"></a><span id="l46.30" class="difflineminus">-  classID: Components.ID(&quot;{e9653ac6-a671-11e6-bf84-60a44c717042}&quot;),</span>
<a href="#l46.31"></a><span id="l46.31"> };</span>
<a href="#l46.32"></a><span id="l46.32" class="difflineminus">-</span>
<a href="#l46.33"></a><span id="l46.33" class="difflineminus">-var NSGetFactory = XPCOMUtils.generateNSGetFactory([MatrixProtocol]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l47.1"></a><span id="l47.1">deleted file mode 100644</span>
<a href="#l47.2"></a><span id="l47.2" class="difflineminus">--- a/chat/protocols/matrix/matrix.manifest</span>
<a href="#l47.3"></a><span id="l47.3" class="difflineplus">+++ /dev/null</span>
<a href="#l47.4"></a><span id="l47.4" class="difflineat">@@ -1,4 +0,0 @@</span>
<a href="#l47.5"></a><span id="l47.5" class="difflineminus">-component {e9653ac6-a671-11e6-bf84-60a44c717042} matrix.js</span>
<a href="#l47.6"></a><span id="l47.6" class="difflineminus">-contract @mozilla.org/chat/matrix;1 {e9653ac6-a671-11e6-bf84-60a44c717042}</span>
<a href="#l47.7"></a><span id="l47.7" class="difflineminus">-category im-protocol-plugin prpl-matrix @mozilla.org/chat/matrix;1</span>
<a href="#l47.8"></a><span id="l47.8" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l48.1"></a><span id="l48.1" class="difflineminus">--- a/chat/protocols/matrix/moz.build</span>
<a href="#l48.2"></a><span id="l48.2" class="difflineplus">+++ b/chat/protocols/matrix/moz.build</span>
<a href="#l48.3"></a><span id="l48.3" class="difflineat">@@ -5,20 +5,20 @@</span>
<a href="#l48.4"></a><span id="l48.4"> </span>
<a href="#l48.5"></a><span id="l48.5"> # XPCSHELL_TESTS_MANIFESTS += []</span>
<a href="#l48.6"></a><span id="l48.6"> </span>
<a href="#l48.7"></a><span id="l48.7"> DIRS += [</span>
<a href="#l48.8"></a><span id="l48.8">     'lib',</span>
<a href="#l48.9"></a><span id="l48.9">     'shims',</span>
<a href="#l48.10"></a><span id="l48.10"> ]</span>
<a href="#l48.11"></a><span id="l48.11"> </span>
<a href="#l48.12"></a><span id="l48.12" class="difflineminus">-EXTRA_COMPONENTS += [</span>
<a href="#l48.13"></a><span id="l48.13" class="difflineminus">-    'matrix.js',</span>
<a href="#l48.14"></a><span id="l48.14" class="difflineminus">-    'matrix.manifest',</span>
<a href="#l48.15"></a><span id="l48.15" class="difflineminus">-]</span>
<a href="#l48.16"></a><span id="l48.16" class="difflineminus">-</span>
<a href="#l48.17"></a><span id="l48.17"> EXTRA_JS_MODULES += [</span>
<a href="#l48.18"></a><span id="l48.18">     'matrix-sdk.jsm',</span>
<a href="#l48.19"></a><span id="l48.19" class="difflineplus">+    'matrix.jsm',</span>
<a href="#l48.20"></a><span id="l48.20"> ]</span>
<a href="#l48.21"></a><span id="l48.21"> </span>
<a href="#l48.22"></a><span id="l48.22"> JAR_MANIFESTS += [</span>
<a href="#l48.23"></a><span id="l48.23">     'jar.mn',</span>
<a href="#l48.24"></a><span id="l48.24"> ]</span>
<a href="#l48.25"></a><span id="l48.25" class="difflineplus">+</span>
<a href="#l48.26"></a><span id="l48.26" class="difflineplus">+XPCOM_MANIFESTS += [</span>
<a href="#l48.27"></a><span id="l48.27" class="difflineplus">+    'components.conf',</span>
<a href="#l48.28"></a><span id="l48.28" class="difflineplus">+]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l49.1"></a><span id="l49.1">new file mode 100644</span>
<a href="#l49.2"></a><span id="l49.2" class="difflineminus">--- /dev/null</span>
<a href="#l49.3"></a><span id="l49.3" class="difflineplus">+++ b/chat/protocols/odnoklassniki/components.conf</span>
<a href="#l49.4"></a><span id="l49.4" class="difflineat">@@ -0,0 +1,15 @@</span>
<a href="#l49.5"></a><span id="l49.5" class="difflineplus">+# -*- Mode: python; indent-tabs-mode: nil; tab-width: 40 -*-</span>
<a href="#l49.6"></a><span id="l49.6" class="difflineplus">+# vim: set filetype=python:</span>
<a href="#l49.7"></a><span id="l49.7" class="difflineplus">+# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l49.8"></a><span id="l49.8" class="difflineplus">+# License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l49.9"></a><span id="l49.9" class="difflineplus">+# file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l49.10"></a><span id="l49.10" class="difflineplus">+</span>
<a href="#l49.11"></a><span id="l49.11" class="difflineplus">+Classes = [</span>
<a href="#l49.12"></a><span id="l49.12" class="difflineplus">+  {</span>
<a href="#l49.13"></a><span id="l49.13" class="difflineplus">+    'cid': '{29b09a83-81c1-2032-11e2-6d9bc4f8e969}',</span>
<a href="#l49.14"></a><span id="l49.14" class="difflineplus">+    'contract_ids': ['@mozilla.org/chat/odnoklassniki;1'],</span>
<a href="#l49.15"></a><span id="l49.15" class="difflineplus">+    'jsm': 'resource:///modules/odnoklassniki.jsm',</span>
<a href="#l49.16"></a><span id="l49.16" class="difflineplus">+    'constructor': 'OdnoklassnikiProtocol',</span>
<a href="#l49.17"></a><span id="l49.17" class="difflineplus">+    'categories': {'im-protocol-plugin': 'prpl-odnoklassniki'},</span>
<a href="#l49.18"></a><span id="l49.18" class="difflineplus">+  },</span>
<a href="#l49.19"></a><span id="l49.19" class="difflineplus">+]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l50.1"></a><span id="l50.1" class="difflineminus">--- a/chat/protocols/odnoklassniki/moz.build</span>
<a href="#l50.2"></a><span id="l50.2" class="difflineplus">+++ b/chat/protocols/odnoklassniki/moz.build</span>
<a href="#l50.3"></a><span id="l50.3" class="difflineat">@@ -1,11 +1,14 @@</span>
<a href="#l50.4"></a><span id="l50.4"> # vim: set filetype=python:</span>
<a href="#l50.5"></a><span id="l50.5"> # This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l50.6"></a><span id="l50.6"> # License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l50.7"></a><span id="l50.7"> # file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l50.8"></a><span id="l50.8"> </span>
<a href="#l50.9"></a><span id="l50.9" class="difflineminus">-EXTRA_COMPONENTS += [</span>
<a href="#l50.10"></a><span id="l50.10" class="difflineminus">-    'odnoklassniki.js',</span>
<a href="#l50.11"></a><span id="l50.11" class="difflineminus">-    'odnoklassniki.manifest',</span>
<a href="#l50.12"></a><span id="l50.12" class="difflineplus">+JAR_MANIFESTS += ['jar.mn']</span>
<a href="#l50.13"></a><span id="l50.13" class="difflineplus">+</span>
<a href="#l50.14"></a><span id="l50.14" class="difflineplus">+XPCOM_MANIFESTS += [</span>
<a href="#l50.15"></a><span id="l50.15" class="difflineplus">+    'components.conf',</span>
<a href="#l50.16"></a><span id="l50.16"> ]</span>
<a href="#l50.17"></a><span id="l50.17"> </span>
<a href="#l50.18"></a><span id="l50.18" class="difflineminus">-JAR_MANIFESTS += ['jar.mn']</span>
<a href="#l50.19"></a><span id="l50.19" class="difflineplus">+EXTRA_JS_MODULES += [</span>
<a href="#l50.20"></a><span id="l50.20" class="difflineplus">+    'odnoklassniki.jsm',</span>
<a href="#l50.21"></a><span id="l50.21" class="difflineplus">+]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l51.1"></a><span id="l51.1">rename from chat/protocols/odnoklassniki/odnoklassniki.js</span>
<a href="#l51.2"></a><span id="l51.2">rename to chat/protocols/odnoklassniki/odnoklassniki.jsm</span>
<a href="#l51.3"></a><span id="l51.3" class="difflineminus">--- a/chat/protocols/odnoklassniki/odnoklassniki.js</span>
<a href="#l51.4"></a><span id="l51.4" class="difflineplus">+++ b/chat/protocols/odnoklassniki/odnoklassniki.jsm</span>
<a href="#l51.5"></a><span id="l51.5" class="difflineat">@@ -1,20 +1,22 @@</span>
<a href="#l51.6"></a><span id="l51.6"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l51.7"></a><span id="l51.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l51.8"></a><span id="l51.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l51.9"></a><span id="l51.9"> </span>
<a href="#l51.10"></a><span id="l51.10" class="difflineplus">+var EXPORTED_SYMBOLS = [&quot;OdnoklassnikiProtocol&quot;];</span>
<a href="#l51.11"></a><span id="l51.11" class="difflineplus">+</span>
<a href="#l51.12"></a><span id="l51.12"> var { XPCOMUtils, l10nHelper } = ChromeUtils.import(</span>
<a href="#l51.13"></a><span id="l51.13">   &quot;resource:///modules/imXPCOMUtils.jsm&quot;</span>
<a href="#l51.14"></a><span id="l51.14"> );</span>
<a href="#l51.15"></a><span id="l51.15"> var { GenericProtocolPrototype } = ChromeUtils.import(</span>
<a href="#l51.16"></a><span id="l51.16">   &quot;resource:///modules/jsProtoHelper.jsm&quot;</span>
<a href="#l51.17"></a><span id="l51.17"> );</span>
<a href="#l51.18"></a><span id="l51.18"> var { XMPPAccountPrototype } = ChromeUtils.import(</span>
<a href="#l51.19"></a><span id="l51.19" class="difflineminus">-  &quot;resource:///modules/xmpp.jsm&quot;</span>
<a href="#l51.20"></a><span id="l51.20" class="difflineplus">+  &quot;resource:///modules/xmpp-base.jsm&quot;</span>
<a href="#l51.21"></a><span id="l51.21"> );</span>
<a href="#l51.22"></a><span id="l51.22"> var { XMPPSession, XMPPDefaultResource } = ChromeUtils.import(</span>
<a href="#l51.23"></a><span id="l51.23">   &quot;resource:///modules/xmpp-session.jsm&quot;</span>
<a href="#l51.24"></a><span id="l51.24"> );</span>
<a href="#l51.25"></a><span id="l51.25"> </span>
<a href="#l51.26"></a><span id="l51.26"> XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l51.27"></a><span id="l51.27">   l10nHelper(&quot;chrome://chat/locale/xmpp.properties&quot;)</span>
<a href="#l51.28"></a><span id="l51.28"> );</span>
<a href="#l51.29"></a><span id="l51.29" class="difflineat">@@ -70,12 +72,9 @@ OdnoklassnikiProtocol.prototype = {</span>
<a href="#l51.30"></a><span id="l51.30">     return &quot;chrome://prpl-odnoklassniki/skin/&quot;;</span>
<a href="#l51.31"></a><span id="l51.31">   },</span>
<a href="#l51.32"></a><span id="l51.32">   get usernameEmptyText() {</span>
<a href="#l51.33"></a><span id="l51.33">     return _(&quot;odnoklassniki.usernameHint&quot;);</span>
<a href="#l51.34"></a><span id="l51.34">   },</span>
<a href="#l51.35"></a><span id="l51.35">   getAccount(aImAccount) {</span>
<a href="#l51.36"></a><span id="l51.36">     return new OdnoklassnikiAccount(this, aImAccount);</span>
<a href="#l51.37"></a><span id="l51.37">   },</span>
<a href="#l51.38"></a><span id="l51.38" class="difflineminus">-  classID: Components.ID(&quot;{29b09a83-81c1-2032-11e2-6d9bc4f8e969}&quot;),</span>
<a href="#l51.39"></a><span id="l51.39"> };</span>
<a href="#l51.40"></a><span id="l51.40" class="difflineminus">-</span>
<a href="#l51.41"></a><span id="l51.41" class="difflineminus">-var NSGetFactory = XPCOMUtils.generateNSGetFactory([OdnoklassnikiProtocol]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l52.1"></a><span id="l52.1">deleted file mode 100644</span>
<a href="#l52.2"></a><span id="l52.2" class="difflineminus">--- a/chat/protocols/odnoklassniki/odnoklassniki.manifest</span>
<a href="#l52.3"></a><span id="l52.3" class="difflineplus">+++ /dev/null</span>
<a href="#l52.4"></a><span id="l52.4" class="difflineat">@@ -1,3 +0,0 @@</span>
<a href="#l52.5"></a><span id="l52.5" class="difflineminus">-component {29b09a83-81c1-2032-11e2-6d9bc4f8e969} odnoklassniki.js</span>
<a href="#l52.6"></a><span id="l52.6" class="difflineminus">-contract @mozilla.org/chat/odnoklassniki;1 {29b09a83-81c1-2032-11e2-6d9bc4f8e969}</span>
<a href="#l52.7"></a><span id="l52.7" class="difflineminus">-category im-protocol-plugin prpl-odnoklassniki @mozilla.org/chat/odnoklassniki;1</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l53.1"></a><span id="l53.1">new file mode 100644</span>
<a href="#l53.2"></a><span id="l53.2" class="difflineminus">--- /dev/null</span>
<a href="#l53.3"></a><span id="l53.3" class="difflineplus">+++ b/chat/protocols/skype/components.conf</span>
<a href="#l53.4"></a><span id="l53.4" class="difflineat">@@ -0,0 +1,15 @@</span>
<a href="#l53.5"></a><span id="l53.5" class="difflineplus">+# -*- Mode: python; indent-tabs-mode: nil; tab-width: 40 -*-</span>
<a href="#l53.6"></a><span id="l53.6" class="difflineplus">+# vim: set filetype=python:</span>
<a href="#l53.7"></a><span id="l53.7" class="difflineplus">+# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l53.8"></a><span id="l53.8" class="difflineplus">+# License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l53.9"></a><span id="l53.9" class="difflineplus">+# file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l53.10"></a><span id="l53.10" class="difflineplus">+</span>
<a href="#l53.11"></a><span id="l53.11" class="difflineplus">+Classes = [</span>
<a href="#l53.12"></a><span id="l53.12" class="difflineplus">+  {</span>
<a href="#l53.13"></a><span id="l53.13" class="difflineplus">+    'cid': '{8446c0f6-9f59-4710-844e-eaa6c1f49d35}',</span>
<a href="#l53.14"></a><span id="l53.14" class="difflineplus">+    'contract_ids': ['@mozilla.org/chat/skype;1'],</span>
<a href="#l53.15"></a><span id="l53.15" class="difflineplus">+    'jsm': 'resource:///modules/skype.jsm',</span>
<a href="#l53.16"></a><span id="l53.16" class="difflineplus">+    'constructor': 'SkypeProtocol',</span>
<a href="#l53.17"></a><span id="l53.17" class="difflineplus">+    'categories': {'im-protocol-plugin': 'prpl-skype'},</span>
<a href="#l53.18"></a><span id="l53.18" class="difflineplus">+  },</span>
<a href="#l53.19"></a><span id="l53.19" class="difflineplus">+]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l54.1"></a><span id="l54.1" class="difflineminus">--- a/chat/protocols/skype/moz.build</span>
<a href="#l54.2"></a><span id="l54.2" class="difflineplus">+++ b/chat/protocols/skype/moz.build</span>
<a href="#l54.3"></a><span id="l54.3" class="difflineat">@@ -1,13 +1,16 @@</span>
<a href="#l54.4"></a><span id="l54.4"> # vim: set filetype=python:</span>
<a href="#l54.5"></a><span id="l54.5"> # This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l54.6"></a><span id="l54.6"> # License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l54.7"></a><span id="l54.7"> # file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l54.8"></a><span id="l54.8"> </span>
<a href="#l54.9"></a><span id="l54.9"> XPCSHELL_TESTS_MANIFESTS += ['test/xpcshell.ini']</span>
<a href="#l54.10"></a><span id="l54.10"> </span>
<a href="#l54.11"></a><span id="l54.11" class="difflineminus">-EXTRA_COMPONENTS += [</span>
<a href="#l54.12"></a><span id="l54.12" class="difflineminus">-    'skype.js',</span>
<a href="#l54.13"></a><span id="l54.13" class="difflineminus">-    'skype.manifest',</span>
<a href="#l54.14"></a><span id="l54.14" class="difflineplus">+JAR_MANIFESTS += ['jar.mn']</span>
<a href="#l54.15"></a><span id="l54.15" class="difflineplus">+</span>
<a href="#l54.16"></a><span id="l54.16" class="difflineplus">+EXTRA_JS_MODULES += [</span>
<a href="#l54.17"></a><span id="l54.17" class="difflineplus">+    'skype.jsm',</span>
<a href="#l54.18"></a><span id="l54.18"> ]</span>
<a href="#l54.19"></a><span id="l54.19"> </span>
<a href="#l54.20"></a><span id="l54.20" class="difflineminus">-JAR_MANIFESTS += ['jar.mn']</span>
<a href="#l54.21"></a><span id="l54.21" class="difflineplus">+XPCOM_MANIFESTS += [</span>
<a href="#l54.22"></a><span id="l54.22" class="difflineplus">+    'components.conf',</span>
<a href="#l54.23"></a><span id="l54.23" class="difflineplus">+]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l55.1"></a><span id="l55.1">rename from chat/protocols/skype/skype.js</span>
<a href="#l55.2"></a><span id="l55.2">rename to chat/protocols/skype/skype.jsm</span>
<a href="#l55.3"></a><span id="l55.3" class="difflineminus">--- a/chat/protocols/skype/skype.js</span>
<a href="#l55.4"></a><span id="l55.4" class="difflineplus">+++ b/chat/protocols/skype/skype.jsm</span>
<a href="#l55.5"></a><span id="l55.5" class="difflineat">@@ -1,12 +1,13 @@</span>
<a href="#l55.6"></a><span id="l55.6"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l55.7"></a><span id="l55.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l55.8"></a><span id="l55.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l55.9"></a><span id="l55.9"> </span>
<a href="#l55.10"></a><span id="l55.10" class="difflineplus">+var EXPORTED_SYMBOLS = [&quot;SkypeProtocol&quot;];</span>
<a href="#l55.11"></a><span id="l55.11"> var { httpRequest } = ChromeUtils.import(&quot;resource://gre/modules/Http.jsm&quot;);</span>
<a href="#l55.12"></a><span id="l55.12"> var { StringToArrayBuffer } = ChromeUtils.import(</span>
<a href="#l55.13"></a><span id="l55.13">   &quot;resource:///modules/ArrayBufferUtils.jsm&quot;</span>
<a href="#l55.14"></a><span id="l55.14"> );</span>
<a href="#l55.15"></a><span id="l55.15"> var { bigInt } = ChromeUtils.import(&quot;resource:///modules/BigInteger.jsm&quot;);</span>
<a href="#l55.16"></a><span id="l55.16"> var { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l55.17"></a><span id="l55.17"> var {</span>
<a href="#l55.18"></a><span id="l55.18">   XPCOMUtils,</span>
<a href="#l55.19"></a><span id="l55.19" class="difflineat">@@ -951,12 +952,9 @@ SkypeProtocol.prototype = {</span>
<a href="#l55.20"></a><span id="l55.20"> </span>
<a href="#l55.21"></a><span id="l55.21">   get passwordOptional() {</span>
<a href="#l55.22"></a><span id="l55.22">     return false;</span>
<a href="#l55.23"></a><span id="l55.23">   },</span>
<a href="#l55.24"></a><span id="l55.24"> </span>
<a href="#l55.25"></a><span id="l55.25">   getAccount(aImAccount) {</span>
<a href="#l55.26"></a><span id="l55.26">     return new SkypeAccount(this, aImAccount);</span>
<a href="#l55.27"></a><span id="l55.27">   },</span>
<a href="#l55.28"></a><span id="l55.28" class="difflineminus">-  classID: Components.ID(&quot;{8446c0f6-9f59-4710-844e-eaa6c1f49d35}&quot;),</span>
<a href="#l55.29"></a><span id="l55.29"> };</span>
<a href="#l55.30"></a><span id="l55.30" class="difflineminus">-</span>
<a href="#l55.31"></a><span id="l55.31" class="difflineminus">-var NSGetFactory = XPCOMUtils.generateNSGetFactory([SkypeProtocol]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l56.1"></a><span id="l56.1">deleted file mode 100644</span>
<a href="#l56.2"></a><span id="l56.2" class="difflineminus">--- a/chat/protocols/skype/skype.manifest</span>
<a href="#l56.3"></a><span id="l56.3" class="difflineplus">+++ /dev/null</span>
<a href="#l56.4"></a><span id="l56.4" class="difflineat">@@ -1,3 +0,0 @@</span>
<a href="#l56.5"></a><span id="l56.5" class="difflineminus">-component {8446c0f6-9f59-4710-844e-eaa6c1f49d35} skype.js</span>
<a href="#l56.6"></a><span id="l56.6" class="difflineminus">-contract @mozilla.org/chat/skype;1 {8446c0f6-9f59-4710-844e-eaa6c1f49d35}</span>
<a href="#l56.7"></a><span id="l56.7" class="difflineminus">-category im-protocol-plugin prpl-skype @mozilla.org/chat/skype;1</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l57.1"></a><span id="l57.1" class="difflineminus">--- a/chat/protocols/skype/test/test_MagicSha256.js</span>
<a href="#l57.2"></a><span id="l57.2" class="difflineplus">+++ b/chat/protocols/skype/test/test_MagicSha256.js</span>
<a href="#l57.3"></a><span id="l57.3" class="difflineat">@@ -1,14 +1,14 @@</span>
<a href="#l57.4"></a><span id="l57.4"> /* Any copyright is dedicated to the Public Domain.</span>
<a href="#l57.5"></a><span id="l57.5">  * http://creativecommons.org/publicdomain/zero/1.0/ */</span>
<a href="#l57.6"></a><span id="l57.6"> </span>
<a href="#l57.7"></a><span id="l57.7"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l57.8"></a><span id="l57.8"> var skype = {};</span>
<a href="#l57.9"></a><span id="l57.9" class="difflineminus">-Services.scriptloader.loadSubScript(&quot;resource:///components/skype.js&quot;, skype);</span>
<a href="#l57.10"></a><span id="l57.10" class="difflineplus">+Services.scriptloader.loadSubScript(&quot;resource:///modules/skype.jsm&quot;, skype);</span>
<a href="#l57.11"></a><span id="l57.11"> </span>
<a href="#l57.12"></a><span id="l57.12"> var data = {</span>
<a href="#l57.13"></a><span id="l57.13">   &quot;1416264993&quot;: &quot;3a33ac47fe2ec1a33d569f4be5c69ddc&quot;,</span>
<a href="#l57.14"></a><span id="l57.14">   &quot;1416387358&quot;: &quot;eca9716e1eedcbe93320ba794cea3388&quot;,</span>
<a href="#l57.15"></a><span id="l57.15">   &quot;1416392361&quot;: &quot;2ed6fc80c3303caa137ae3fd4fcc7d80&quot;,</span>
<a href="#l57.16"></a><span id="l57.16"> };</span>
<a href="#l57.17"></a><span id="l57.17"> </span>
<a href="#l57.18"></a><span id="l57.18"> function run_test() {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l58.1"></a><span id="l58.1" class="difflineminus">--- a/chat/protocols/skype/test/test_contactUrlToName.js</span>
<a href="#l58.2"></a><span id="l58.2" class="difflineplus">+++ b/chat/protocols/skype/test/test_contactUrlToName.js</span>
<a href="#l58.3"></a><span id="l58.3" class="difflineat">@@ -1,14 +1,14 @@</span>
<a href="#l58.4"></a><span id="l58.4"> /* Any copyright is dedicated to the Public Domain.</span>
<a href="#l58.5"></a><span id="l58.5">  * http://creativecommons.org/publicdomain/zero/1.0/ */</span>
<a href="#l58.6"></a><span id="l58.6"> </span>
<a href="#l58.7"></a><span id="l58.7"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l58.8"></a><span id="l58.8"> var skype = {};</span>
<a href="#l58.9"></a><span id="l58.9" class="difflineminus">-Services.scriptloader.loadSubScript(&quot;resource:///components/skype.js&quot;, skype);</span>
<a href="#l58.10"></a><span id="l58.10" class="difflineplus">+Services.scriptloader.loadSubScript(&quot;resource:///modules/skype.jsm&quot;, skype);</span>
<a href="#l58.11"></a><span id="l58.11"> </span>
<a href="#l58.12"></a><span id="l58.12"> var data = {</span>
<a href="#l58.13"></a><span id="l58.13">   &quot;https://bay-client-s.gateway.messenger.live.com/v1/users/ME/contacts/8:clokep&quot;:</span>
<a href="#l58.14"></a><span id="l58.14">     &quot;clokep&quot;,</span>
<a href="#l58.15"></a><span id="l58.15">   &quot;https://bay-client-s.gateway.messenger.live.com/v1/users/8:clokep/presenceDocs/messagingService&quot;:</span>
<a href="#l58.16"></a><span id="l58.16">     &quot;clokep&quot;,</span>
<a href="#l58.17"></a><span id="l58.17"> };</span>
<a href="#l58.18"></a><span id="l58.18"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l59.1"></a><span id="l59.1">new file mode 100644</span>
<a href="#l59.2"></a><span id="l59.2" class="difflineminus">--- /dev/null</span>
<a href="#l59.3"></a><span id="l59.3" class="difflineplus">+++ b/chat/protocols/twitter/components.conf</span>
<a href="#l59.4"></a><span id="l59.4" class="difflineat">@@ -0,0 +1,15 @@</span>
<a href="#l59.5"></a><span id="l59.5" class="difflineplus">+# -*- Mode: python; indent-tabs-mode: nil; tab-width: 40 -*-</span>
<a href="#l59.6"></a><span id="l59.6" class="difflineplus">+# vim: set filetype=python:</span>
<a href="#l59.7"></a><span id="l59.7" class="difflineplus">+# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l59.8"></a><span id="l59.8" class="difflineplus">+# License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l59.9"></a><span id="l59.9" class="difflineplus">+# file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l59.10"></a><span id="l59.10" class="difflineplus">+</span>
<a href="#l59.11"></a><span id="l59.11" class="difflineplus">+Classes = [</span>
<a href="#l59.12"></a><span id="l59.12" class="difflineplus">+  {</span>
<a href="#l59.13"></a><span id="l59.13" class="difflineplus">+    'cid': '{31082ff6-1de8-422b-ab60-ca0ac0b2af13}',</span>
<a href="#l59.14"></a><span id="l59.14" class="difflineplus">+    'contract_ids': ['@mozilla.org/chat/twitter;1'],</span>
<a href="#l59.15"></a><span id="l59.15" class="difflineplus">+    'jsm': 'resource:///modules/twitter.jsm',</span>
<a href="#l59.16"></a><span id="l59.16" class="difflineplus">+    'constructor': 'TwitterProtocol',</span>
<a href="#l59.17"></a><span id="l59.17" class="difflineplus">+    'categories': {'im-protocol-plugin': 'prpl-twitter'},</span>
<a href="#l59.18"></a><span id="l59.18" class="difflineplus">+  },</span>
<a href="#l59.19"></a><span id="l59.19" class="difflineplus">+]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l60.1"></a><span id="l60.1" class="difflineminus">--- a/chat/protocols/twitter/moz.build</span>
<a href="#l60.2"></a><span id="l60.2" class="difflineplus">+++ b/chat/protocols/twitter/moz.build</span>
<a href="#l60.3"></a><span id="l60.3" class="difflineat">@@ -1,14 +1,15 @@</span>
<a href="#l60.4"></a><span id="l60.4"> # vim: set filetype=python:</span>
<a href="#l60.5"></a><span id="l60.5"> # This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l60.6"></a><span id="l60.6"> # License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l60.7"></a><span id="l60.7"> # file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l60.8"></a><span id="l60.8"> </span>
<a href="#l60.9"></a><span id="l60.9" class="difflineminus">-EXTRA_COMPONENTS += [</span>
<a href="#l60.10"></a><span id="l60.10" class="difflineminus">-    'twitter.js',</span>
<a href="#l60.11"></a><span id="l60.11" class="difflineminus">-    'twitter.manifest',</span>
<a href="#l60.12"></a><span id="l60.12" class="difflineplus">+EXTRA_JS_MODULES += [</span>
<a href="#l60.13"></a><span id="l60.13" class="difflineplus">+    'twitter-text.jsm',</span>
<a href="#l60.14"></a><span id="l60.14" class="difflineplus">+    'twitter.jsm',</span>
<a href="#l60.15"></a><span id="l60.15"> ]</span>
<a href="#l60.16"></a><span id="l60.16"> </span>
<a href="#l60.17"></a><span id="l60.17" class="difflineminus">-EXTRA_JS_MODULES += [</span>
<a href="#l60.18"></a><span id="l60.18" class="difflineminus">-    'twitter-text.jsm',</span>
<a href="#l60.19"></a><span id="l60.19" class="difflineplus">+JAR_MANIFESTS += ['jar.mn']</span>
<a href="#l60.20"></a><span id="l60.20" class="difflineplus">+</span>
<a href="#l60.21"></a><span id="l60.21" class="difflineplus">+XPCOM_MANIFESTS += [</span>
<a href="#l60.22"></a><span id="l60.22" class="difflineplus">+    'components.conf',</span>
<a href="#l60.23"></a><span id="l60.23"> ]</span>
<a href="#l60.24"></a><span id="l60.24" class="difflineminus">-JAR_MANIFESTS += ['jar.mn']</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l61.1"></a><span id="l61.1">rename from chat/protocols/twitter/twitter.js</span>
<a href="#l61.2"></a><span id="l61.2">rename to chat/protocols/twitter/twitter.jsm</span>
<a href="#l61.3"></a><span id="l61.3" class="difflineminus">--- a/chat/protocols/twitter/twitter.js</span>
<a href="#l61.4"></a><span id="l61.4" class="difflineplus">+++ b/chat/protocols/twitter/twitter.jsm</span>
<a href="#l61.5"></a><span id="l61.5" class="difflineat">@@ -1,12 +1,14 @@</span>
<a href="#l61.6"></a><span id="l61.6"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l61.7"></a><span id="l61.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l61.8"></a><span id="l61.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l61.9"></a><span id="l61.9"> </span>
<a href="#l61.10"></a><span id="l61.10" class="difflineplus">+var EXPORTED_SYMBOLS = [&quot;TwitterProtocol&quot;];</span>
<a href="#l61.11"></a><span id="l61.11" class="difflineplus">+</span>
<a href="#l61.12"></a><span id="l61.12"> var { httpRequest, percentEncode } = ChromeUtils.import(</span>
<a href="#l61.13"></a><span id="l61.13">   &quot;resource://gre/modules/Http.jsm&quot;</span>
<a href="#l61.14"></a><span id="l61.14"> );</span>
<a href="#l61.15"></a><span id="l61.15"> var { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l61.16"></a><span id="l61.16"> var {</span>
<a href="#l61.17"></a><span id="l61.17">   XPCOMUtils,</span>
<a href="#l61.18"></a><span id="l61.18">   setTimeout,</span>
<a href="#l61.19"></a><span id="l61.19">   clearTimeout,</span>
<a href="#l61.20"></a><span id="l61.20" class="difflineat">@@ -1567,12 +1569,9 @@ TwitterProtocol.prototype = {</span>
<a href="#l61.21"></a><span id="l61.21">         aMsg.split(&quot; &quot;).forEach(account.stopFollowing, account);</span>
<a href="#l61.22"></a><span id="l61.22">         return true;</span>
<a href="#l61.23"></a><span id="l61.23">       },</span>
<a href="#l61.24"></a><span id="l61.24">     },</span>
<a href="#l61.25"></a><span id="l61.25">   ],</span>
<a href="#l61.26"></a><span id="l61.26">   getAccount(aImAccount) {</span>
<a href="#l61.27"></a><span id="l61.27">     return new Account(this, aImAccount);</span>
<a href="#l61.28"></a><span id="l61.28">   },</span>
<a href="#l61.29"></a><span id="l61.29" class="difflineminus">-  classID: Components.ID(&quot;{31082ff6-1de8-422b-ab60-ca0ac0b2af13}&quot;),</span>
<a href="#l61.30"></a><span id="l61.30"> };</span>
<a href="#l61.31"></a><span id="l61.31" class="difflineminus">-</span>
<a href="#l61.32"></a><span id="l61.32" class="difflineminus">-var NSGetFactory = XPCOMUtils.generateNSGetFactory([TwitterProtocol]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l62.1"></a><span id="l62.1">deleted file mode 100644</span>
<a href="#l62.2"></a><span id="l62.2" class="difflineminus">--- a/chat/protocols/twitter/twitter.manifest</span>
<a href="#l62.3"></a><span id="l62.3" class="difflineplus">+++ /dev/null</span>
<a href="#l62.4"></a><span id="l62.4" class="difflineat">@@ -1,3 +0,0 @@</span>
<a href="#l62.5"></a><span id="l62.5" class="difflineminus">-component {31082ff6-1de8-422b-ab60-ca0ac0b2af13} twitter.js</span>
<a href="#l62.6"></a><span id="l62.6" class="difflineminus">-contract @mozilla.org/chat/twitter;1 {31082ff6-1de8-422b-ab60-ca0ac0b2af13}</span>
<a href="#l62.7"></a><span id="l62.7" class="difflineminus">-category im-protocol-plugin prpl-twitter @mozilla.org/chat/twitter;1</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l63.1"></a><span id="l63.1">new file mode 100644</span>
<a href="#l63.2"></a><span id="l63.2" class="difflineminus">--- /dev/null</span>
<a href="#l63.3"></a><span id="l63.3" class="difflineplus">+++ b/chat/protocols/xmpp/components.conf</span>
<a href="#l63.4"></a><span id="l63.4" class="difflineat">@@ -0,0 +1,15 @@</span>
<a href="#l63.5"></a><span id="l63.5" class="difflineplus">+# -*- Mode: python; indent-tabs-mode: nil; tab-width: 40 -*-</span>
<a href="#l63.6"></a><span id="l63.6" class="difflineplus">+# vim: set filetype=python:</span>
<a href="#l63.7"></a><span id="l63.7" class="difflineplus">+# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l63.8"></a><span id="l63.8" class="difflineplus">+# License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l63.9"></a><span id="l63.9" class="difflineplus">+# file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l63.10"></a><span id="l63.10" class="difflineplus">+</span>
<a href="#l63.11"></a><span id="l63.11" class="difflineplus">+Classes = [</span>
<a href="#l63.12"></a><span id="l63.12" class="difflineplus">+  {</span>
<a href="#l63.13"></a><span id="l63.13" class="difflineplus">+    'cid': '{dde786d1-6f59-43d0-9bc8-b505a757fb30}',</span>
<a href="#l63.14"></a><span id="l63.14" class="difflineplus">+    'contract_ids': ['@mozilla.org/chat/xmpp;1'],</span>
<a href="#l63.15"></a><span id="l63.15" class="difflineplus">+    'jsm': 'resource:///modules/xmpp.jsm',</span>
<a href="#l63.16"></a><span id="l63.16" class="difflineplus">+    'constructor': 'XMPPProtocol',</span>
<a href="#l63.17"></a><span id="l63.17" class="difflineplus">+    'categories': {'im-protocol-plugin': 'prpl-jabber'},</span>
<a href="#l63.18"></a><span id="l63.18" class="difflineplus">+  },</span>
<a href="#l63.19"></a><span id="l63.19" class="difflineplus">+]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l64.1"></a><span id="l64.1" class="difflineminus">--- a/chat/protocols/xmpp/moz.build</span>
<a href="#l64.2"></a><span id="l64.2" class="difflineplus">+++ b/chat/protocols/xmpp/moz.build</span>
<a href="#l64.3"></a><span id="l64.3" class="difflineat">@@ -1,21 +1,21 @@</span>
<a href="#l64.4"></a><span id="l64.4"> # vim: set filetype=python:</span>
<a href="#l64.5"></a><span id="l64.5"> # This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l64.6"></a><span id="l64.6"> # License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l64.7"></a><span id="l64.7"> # file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l64.8"></a><span id="l64.8"> </span>
<a href="#l64.9"></a><span id="l64.9"> XPCSHELL_TESTS_MANIFESTS += ['test/xpcshell.ini']</span>
<a href="#l64.10"></a><span id="l64.10"> </span>
<a href="#l64.11"></a><span id="l64.11" class="difflineminus">-EXTRA_COMPONENTS += [</span>
<a href="#l64.12"></a><span id="l64.12" class="difflineminus">-    'xmpp.js',</span>
<a href="#l64.13"></a><span id="l64.13" class="difflineminus">-    'xmpp.manifest',</span>
<a href="#l64.14"></a><span id="l64.14" class="difflineminus">-]</span>
<a href="#l64.15"></a><span id="l64.15" class="difflineminus">-</span>
<a href="#l64.16"></a><span id="l64.16"> EXTRA_JS_MODULES += [</span>
<a href="#l64.17"></a><span id="l64.17">     'xmpp-authmechs.jsm',</span>
<a href="#l64.18"></a><span id="l64.18" class="difflineplus">+    'xmpp-base.jsm',</span>
<a href="#l64.19"></a><span id="l64.19">     'xmpp-commands.jsm',</span>
<a href="#l64.20"></a><span id="l64.20">     'xmpp-session.jsm',</span>
<a href="#l64.21"></a><span id="l64.21">     'xmpp-xml.jsm',</span>
<a href="#l64.22"></a><span id="l64.22">     'xmpp.jsm',</span>
<a href="#l64.23"></a><span id="l64.23"> ]</span>
<a href="#l64.24"></a><span id="l64.24"> </span>
<a href="#l64.25"></a><span id="l64.25"> JAR_MANIFESTS += ['jar.mn']</span>
<a href="#l64.26"></a><span id="l64.26" class="difflineplus">+</span>
<a href="#l64.27"></a><span id="l64.27" class="difflineplus">+XPCOM_MANIFESTS += [</span>
<a href="#l64.28"></a><span id="l64.28" class="difflineplus">+    'components.conf',</span>
<a href="#l64.29"></a><span id="l64.29" class="difflineplus">+]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l65.1"></a><span id="l65.1" class="difflineminus">--- a/chat/protocols/xmpp/test/test_dnsSrv.js</span>
<a href="#l65.2"></a><span id="l65.2" class="difflineplus">+++ b/chat/protocols/xmpp/test/test_dnsSrv.js</span>
<a href="#l65.3"></a><span id="l65.3" class="difflineat">@@ -1,14 +1,14 @@</span>
<a href="#l65.4"></a><span id="l65.4"> /* Any copyright is dedicated to the Public Domain.</span>
<a href="#l65.5"></a><span id="l65.5">  * http://creativecommons.org/publicdomain/zero/1.0/ */</span>
<a href="#l65.6"></a><span id="l65.6"> </span>
<a href="#l65.7"></a><span id="l65.7"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l65.8"></a><span id="l65.8"> var { XMPPAccountPrototype } = ChromeUtils.import(</span>
<a href="#l65.9"></a><span id="l65.9" class="difflineminus">-  &quot;resource:///modules/xmpp.jsm&quot;</span>
<a href="#l65.10"></a><span id="l65.10" class="difflineplus">+  &quot;resource:///modules/xmpp-base.jsm&quot;</span>
<a href="#l65.11"></a><span id="l65.11"> );</span>
<a href="#l65.12"></a><span id="l65.12"> var { XMPPSession } = ChromeUtils.import(</span>
<a href="#l65.13"></a><span id="l65.13">   &quot;resource:///modules/xmpp-session.jsm&quot;</span>
<a href="#l65.14"></a><span id="l65.14"> );</span>
<a href="#l65.15"></a><span id="l65.15"> </span>
<a href="#l65.16"></a><span id="l65.16"> var dns = {};</span>
<a href="#l65.17"></a><span id="l65.17"> Services.scriptloader.loadSubScript(&quot;resource:///modules/DNS.jsm&quot;, dns);</span>
<a href="#l65.18"></a><span id="l65.18"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l66.1"></a><span id="l66.1" class="difflineminus">--- a/chat/protocols/xmpp/test/test_parseJidAndNormalization.js</span>
<a href="#l66.2"></a><span id="l66.2" class="difflineplus">+++ b/chat/protocols/xmpp/test/test_parseJidAndNormalization.js</span>
<a href="#l66.3"></a><span id="l66.3" class="difflineat">@@ -1,14 +1,14 @@</span>
<a href="#l66.4"></a><span id="l66.4"> /* Any copyright is dedicated to the Public Domain.</span>
<a href="#l66.5"></a><span id="l66.5">  * http://creativecommons.org/publicdomain/zero/1.0/ */</span>
<a href="#l66.6"></a><span id="l66.6"> </span>
<a href="#l66.7"></a><span id="l66.7"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l66.8"></a><span id="l66.8"> var { XMPPAccountPrototype } = ChromeUtils.import(</span>
<a href="#l66.9"></a><span id="l66.9" class="difflineminus">-  &quot;resource:///modules/xmpp.jsm&quot;</span>
<a href="#l66.10"></a><span id="l66.10" class="difflineplus">+  &quot;resource:///modules/xmpp-base.jsm&quot;</span>
<a href="#l66.11"></a><span id="l66.11"> );</span>
<a href="#l66.12"></a><span id="l66.12"> </span>
<a href="#l66.13"></a><span id="l66.13"> var TEST_DATA = {</span>
<a href="#l66.14"></a><span id="l66.14">   &quot;abdelrhman@instantbird&quot;: {</span>
<a href="#l66.15"></a><span id="l66.15">     node: &quot;abdelrhman&quot;,</span>
<a href="#l66.16"></a><span id="l66.16">     domain: &quot;instantbird&quot;,</span>
<a href="#l66.17"></a><span id="l66.17">     jid: &quot;abdelrhman@instantbird&quot;,</span>
<a href="#l66.18"></a><span id="l66.18">     normalized: &quot;abdelrhman@instantbird&quot;,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l67.1"></a><span id="l67.1" class="difflineminus">--- a/chat/protocols/xmpp/test/test_parseVCard.js</span>
<a href="#l67.2"></a><span id="l67.2" class="difflineplus">+++ b/chat/protocols/xmpp/test/test_parseVCard.js</span>
<a href="#l67.3"></a><span id="l67.3" class="difflineat">@@ -1,13 +1,13 @@</span>
<a href="#l67.4"></a><span id="l67.4"> /* Any copyright is dedicated to the Public Domain.</span>
<a href="#l67.5"></a><span id="l67.5">  * http://creativecommons.org/publicdomain/zero/1.0/ */</span>
<a href="#l67.6"></a><span id="l67.6"> </span>
<a href="#l67.7"></a><span id="l67.7"> var { XMPPAccountPrototype } = ChromeUtils.import(</span>
<a href="#l67.8"></a><span id="l67.8" class="difflineminus">-  &quot;resource:///modules/xmpp.jsm&quot;</span>
<a href="#l67.9"></a><span id="l67.9" class="difflineplus">+  &quot;resource:///modules/xmpp-base.jsm&quot;</span>
<a href="#l67.10"></a><span id="l67.10"> );</span>
<a href="#l67.11"></a><span id="l67.11"> var { XMPPParser } = ChromeUtils.import(&quot;resource:///modules/xmpp-xml.jsm&quot;);</span>
<a href="#l67.12"></a><span id="l67.12"> </span>
<a href="#l67.13"></a><span id="l67.13"> /*</span>
<a href="#l67.14"></a><span id="l67.14">  * Open an input stream, instantiate an XMPP parser, and feed the input string</span>
<a href="#l67.15"></a><span id="l67.15">  * into it. Then assert that the resulting vCard matches the expected result.</span>
<a href="#l67.16"></a><span id="l67.16">  */</span>
<a href="#l67.17"></a><span id="l67.17"> function _test_vcard(aInput, aExpectedResult) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l68.1"></a><span id="l68.1">copy from chat/protocols/xmpp/xmpp.jsm</span>
<a href="#l68.2"></a><span id="l68.2">copy to chat/protocols/xmpp/xmpp-base.jsm</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l69.1"></a><span id="l69.1">deleted file mode 100644</span>
<a href="#l69.2"></a><span id="l69.2" class="difflineminus">--- a/chat/protocols/xmpp/xmpp.js</span>
<a href="#l69.3"></a><span id="l69.3" class="difflineplus">+++ /dev/null</span>
<a href="#l69.4"></a><span id="l69.4" class="difflineat">@@ -1,106 +0,0 @@</span>
<a href="#l69.5"></a><span id="l69.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l69.6"></a><span id="l69.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l69.7"></a><span id="l69.7" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l69.8"></a><span id="l69.8" class="difflineminus">-</span>
<a href="#l69.9"></a><span id="l69.9" class="difflineminus">-var { XPCOMUtils, l10nHelper } = ChromeUtils.import(</span>
<a href="#l69.10"></a><span id="l69.10" class="difflineminus">-  &quot;resource:///modules/imXPCOMUtils.jsm&quot;</span>
<a href="#l69.11"></a><span id="l69.11" class="difflineminus">-);</span>
<a href="#l69.12"></a><span id="l69.12" class="difflineminus">-var { GenericProtocolPrototype } = ChromeUtils.import(</span>
<a href="#l69.13"></a><span id="l69.13" class="difflineminus">-  &quot;resource:///modules/jsProtoHelper.jsm&quot;</span>
<a href="#l69.14"></a><span id="l69.14" class="difflineminus">-);</span>
<a href="#l69.15"></a><span id="l69.15" class="difflineminus">-var { XMPPAccountPrototype } = ChromeUtils.import(</span>
<a href="#l69.16"></a><span id="l69.16" class="difflineminus">-  &quot;resource:///modules/xmpp.jsm&quot;</span>
<a href="#l69.17"></a><span id="l69.17" class="difflineminus">-);</span>
<a href="#l69.18"></a><span id="l69.18" class="difflineminus">-</span>
<a href="#l69.19"></a><span id="l69.19" class="difflineminus">-XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l69.20"></a><span id="l69.20" class="difflineminus">-  l10nHelper(&quot;chrome://chat/locale/xmpp.properties&quot;)</span>
<a href="#l69.21"></a><span id="l69.21" class="difflineminus">-);</span>
<a href="#l69.22"></a><span id="l69.22" class="difflineminus">-</span>
<a href="#l69.23"></a><span id="l69.23" class="difflineminus">-function XMPPAccount(aProtoInstance, aImAccount) {</span>
<a href="#l69.24"></a><span id="l69.24" class="difflineminus">-  this._init(aProtoInstance, aImAccount);</span>
<a href="#l69.25"></a><span id="l69.25" class="difflineminus">-}</span>
<a href="#l69.26"></a><span id="l69.26" class="difflineminus">-XMPPAccount.prototype = XMPPAccountPrototype;</span>
<a href="#l69.27"></a><span id="l69.27" class="difflineminus">-</span>
<a href="#l69.28"></a><span id="l69.28" class="difflineminus">-function XMPPProtocol() {</span>
<a href="#l69.29"></a><span id="l69.29" class="difflineminus">-  ChromeUtils.import(&quot;resource:///modules/xmpp-commands.jsm&quot;, this);</span>
<a href="#l69.30"></a><span id="l69.30" class="difflineminus">-  this.registerCommands();</span>
<a href="#l69.31"></a><span id="l69.31" class="difflineminus">-}</span>
<a href="#l69.32"></a><span id="l69.32" class="difflineminus">-XMPPProtocol.prototype = {</span>
<a href="#l69.33"></a><span id="l69.33" class="difflineminus">-  __proto__: GenericProtocolPrototype,</span>
<a href="#l69.34"></a><span id="l69.34" class="difflineminus">-  get normalizedName() {</span>
<a href="#l69.35"></a><span id="l69.35" class="difflineminus">-    return &quot;jabber&quot;;</span>
<a href="#l69.36"></a><span id="l69.36" class="difflineminus">-  },</span>
<a href="#l69.37"></a><span id="l69.37" class="difflineminus">-  get name() {</span>
<a href="#l69.38"></a><span id="l69.38" class="difflineminus">-    return &quot;XMPP&quot;;</span>
<a href="#l69.39"></a><span id="l69.39" class="difflineminus">-  },</span>
<a href="#l69.40"></a><span id="l69.40" class="difflineminus">-  get iconBaseURI() {</span>
<a href="#l69.41"></a><span id="l69.41" class="difflineminus">-    return &quot;chrome://prpl-jabber/skin/&quot;;</span>
<a href="#l69.42"></a><span id="l69.42" class="difflineminus">-  },</span>
<a href="#l69.43"></a><span id="l69.43" class="difflineminus">-  getAccount(aImAccount) {</span>
<a href="#l69.44"></a><span id="l69.44" class="difflineminus">-    return new XMPPAccount(this, aImAccount);</span>
<a href="#l69.45"></a><span id="l69.45" class="difflineminus">-  },</span>
<a href="#l69.46"></a><span id="l69.46" class="difflineminus">-</span>
<a href="#l69.47"></a><span id="l69.47" class="difflineminus">-  usernameSplits: [</span>
<a href="#l69.48"></a><span id="l69.48" class="difflineminus">-    {</span>
<a href="#l69.49"></a><span id="l69.49" class="difflineminus">-      get label() {</span>
<a href="#l69.50"></a><span id="l69.50" class="difflineminus">-        return _(&quot;options.domain&quot;);</span>
<a href="#l69.51"></a><span id="l69.51" class="difflineminus">-      },</span>
<a href="#l69.52"></a><span id="l69.52" class="difflineminus">-      separator: &quot;@&quot;,</span>
<a href="#l69.53"></a><span id="l69.53" class="difflineminus">-      defaultValue: &quot;jabber.org&quot;,</span>
<a href="#l69.54"></a><span id="l69.54" class="difflineminus">-      reverse: true,</span>
<a href="#l69.55"></a><span id="l69.55" class="difflineminus">-    },</span>
<a href="#l69.56"></a><span id="l69.56" class="difflineminus">-  ],</span>
<a href="#l69.57"></a><span id="l69.57" class="difflineminus">-</span>
<a href="#l69.58"></a><span id="l69.58" class="difflineminus">-  options: {</span>
<a href="#l69.59"></a><span id="l69.59" class="difflineminus">-    resource: {</span>
<a href="#l69.60"></a><span id="l69.60" class="difflineminus">-      get label() {</span>
<a href="#l69.61"></a><span id="l69.61" class="difflineminus">-        return _(&quot;options.resource&quot;);</span>
<a href="#l69.62"></a><span id="l69.62" class="difflineminus">-      },</span>
<a href="#l69.63"></a><span id="l69.63" class="difflineminus">-      default: &quot;&quot;,</span>
<a href="#l69.64"></a><span id="l69.64" class="difflineminus">-    },</span>
<a href="#l69.65"></a><span id="l69.65" class="difflineminus">-    priority: {</span>
<a href="#l69.66"></a><span id="l69.66" class="difflineminus">-      get label() {</span>
<a href="#l69.67"></a><span id="l69.67" class="difflineminus">-        return _(&quot;options.priority&quot;);</span>
<a href="#l69.68"></a><span id="l69.68" class="difflineminus">-      },</span>
<a href="#l69.69"></a><span id="l69.69" class="difflineminus">-      default: 0,</span>
<a href="#l69.70"></a><span id="l69.70" class="difflineminus">-    },</span>
<a href="#l69.71"></a><span id="l69.71" class="difflineminus">-    connection_security: {</span>
<a href="#l69.72"></a><span id="l69.72" class="difflineminus">-      get label() {</span>
<a href="#l69.73"></a><span id="l69.73" class="difflineminus">-        return _(&quot;options.connectionSecurity&quot;);</span>
<a href="#l69.74"></a><span id="l69.74" class="difflineminus">-      },</span>
<a href="#l69.75"></a><span id="l69.75" class="difflineminus">-      listValues: {</span>
<a href="#l69.76"></a><span id="l69.76" class="difflineminus">-        get require_tls() {</span>
<a href="#l69.77"></a><span id="l69.77" class="difflineminus">-          return _(&quot;options.connectionSecurity.requireEncryption&quot;);</span>
<a href="#l69.78"></a><span id="l69.78" class="difflineminus">-        },</span>
<a href="#l69.79"></a><span id="l69.79" class="difflineminus">-        get opportunistic_tls() {</span>
<a href="#l69.80"></a><span id="l69.80" class="difflineminus">-          return _(&quot;options.connectionSecurity.opportunisticTLS&quot;);</span>
<a href="#l69.81"></a><span id="l69.81" class="difflineminus">-        },</span>
<a href="#l69.82"></a><span id="l69.82" class="difflineminus">-        get allow_unencrypted_plain_auth() {</span>
<a href="#l69.83"></a><span id="l69.83" class="difflineminus">-          return _(&quot;options.connectionSecurity.allowUnencryptedAuth&quot;);</span>
<a href="#l69.84"></a><span id="l69.84" class="difflineminus">-        },</span>
<a href="#l69.85"></a><span id="l69.85" class="difflineminus">-        // &quot;old_ssl&quot; and &quot;none&quot; are also supported, but not exposed in the UI.</span>
<a href="#l69.86"></a><span id="l69.86" class="difflineminus">-        // Any unknown value will fallback to the opportunistic_tls behavior.</span>
<a href="#l69.87"></a><span id="l69.87" class="difflineminus">-      },</span>
<a href="#l69.88"></a><span id="l69.88" class="difflineminus">-      default: &quot;require_tls&quot;,</span>
<a href="#l69.89"></a><span id="l69.89" class="difflineminus">-    },</span>
<a href="#l69.90"></a><span id="l69.90" class="difflineminus">-    server: {</span>
<a href="#l69.91"></a><span id="l69.91" class="difflineminus">-      get label() {</span>
<a href="#l69.92"></a><span id="l69.92" class="difflineminus">-        return _(&quot;options.connectServer&quot;);</span>
<a href="#l69.93"></a><span id="l69.93" class="difflineminus">-      },</span>
<a href="#l69.94"></a><span id="l69.94" class="difflineminus">-      default: &quot;&quot;,</span>
<a href="#l69.95"></a><span id="l69.95" class="difflineminus">-    },</span>
<a href="#l69.96"></a><span id="l69.96" class="difflineminus">-    port: {</span>
<a href="#l69.97"></a><span id="l69.97" class="difflineminus">-      get label() {</span>
<a href="#l69.98"></a><span id="l69.98" class="difflineminus">-        return _(&quot;options.connectPort&quot;);</span>
<a href="#l69.99"></a><span id="l69.99" class="difflineminus">-      },</span>
<a href="#l69.100"></a><span id="l69.100" class="difflineminus">-      default: 5222,</span>
<a href="#l69.101"></a><span id="l69.101" class="difflineminus">-    },</span>
<a href="#l69.102"></a><span id="l69.102" class="difflineminus">-  },</span>
<a href="#l69.103"></a><span id="l69.103" class="difflineminus">-  get chatHasTopic() {</span>
<a href="#l69.104"></a><span id="l69.104" class="difflineminus">-    return true;</span>
<a href="#l69.105"></a><span id="l69.105" class="difflineminus">-  },</span>
<a href="#l69.106"></a><span id="l69.106" class="difflineminus">-</span>
<a href="#l69.107"></a><span id="l69.107" class="difflineminus">-  classID: Components.ID(&quot;{dde786d1-6f59-43d0-9bc8-b505a757fb30}&quot;),</span>
<a href="#l69.108"></a><span id="l69.108" class="difflineminus">-};</span>
<a href="#l69.109"></a><span id="l69.109" class="difflineminus">-</span>
<a href="#l69.110"></a><span id="l69.110" class="difflineminus">-var NSGetFactory = XPCOMUtils.generateNSGetFactory([XMPPProtocol]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l70.1"></a><span id="l70.1" class="difflineminus">--- a/chat/protocols/xmpp/xmpp.jsm</span>
<a href="#l70.2"></a><span id="l70.2" class="difflineplus">+++ b/chat/protocols/xmpp/xmpp.jsm</span>
<a href="#l70.3"></a><span id="l70.3" class="difflineat">@@ -1,3324 +1,104 @@</span>
<a href="#l70.4"></a><span id="l70.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l70.5"></a><span id="l70.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l70.6"></a><span id="l70.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l70.7"></a><span id="l70.7"> </span>
<a href="#l70.8"></a><span id="l70.8" class="difflineminus">-this.EXPORTED_SYMBOLS = [</span>
<a href="#l70.9"></a><span id="l70.9" class="difflineminus">-  &quot;XMPPConversationPrototype&quot;,</span>
<a href="#l70.10"></a><span id="l70.10" class="difflineminus">-  &quot;XMPPMUCConversationPrototype&quot;,</span>
<a href="#l70.11"></a><span id="l70.11" class="difflineminus">-  &quot;XMPPAccountBuddyPrototype&quot;,</span>
<a href="#l70.12"></a><span id="l70.12" class="difflineminus">-  &quot;XMPPAccountPrototype&quot;,</span>
<a href="#l70.13"></a><span id="l70.13" class="difflineminus">-];</span>
<a href="#l70.14"></a><span id="l70.14" class="difflineplus">+var EXPORTED_SYMBOLS = [&quot;XMPPProtocol&quot;];</span>
<a href="#l70.15"></a><span id="l70.15"> </span>
<a href="#l70.16"></a><span id="l70.16" class="difflineminus">-const { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l70.17"></a><span id="l70.17" class="difflineminus">-const { Status } = ChromeUtils.import(&quot;resource:///modules/imStatusUtils.jsm&quot;);</span>
<a href="#l70.18"></a><span id="l70.18" class="difflineminus">-const {</span>
<a href="#l70.19"></a><span id="l70.19" class="difflineminus">-  XPCOMUtils,</span>
<a href="#l70.20"></a><span id="l70.20" class="difflineminus">-  setTimeout,</span>
<a href="#l70.21"></a><span id="l70.21" class="difflineminus">-  clearTimeout,</span>
<a href="#l70.22"></a><span id="l70.22" class="difflineminus">-  executeSoon,</span>
<a href="#l70.23"></a><span id="l70.23" class="difflineminus">-  nsSimpleEnumerator,</span>
<a href="#l70.24"></a><span id="l70.24" class="difflineminus">-  EmptyEnumerator,</span>
<a href="#l70.25"></a><span id="l70.25" class="difflineminus">-  ClassInfo,</span>
<a href="#l70.26"></a><span id="l70.26" class="difflineminus">-  l10nHelper,</span>
<a href="#l70.27"></a><span id="l70.27" class="difflineminus">-} = ChromeUtils.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l70.28"></a><span id="l70.28" class="difflineminus">-var {</span>
<a href="#l70.29"></a><span id="l70.29" class="difflineminus">-  GenericAccountPrototype,</span>
<a href="#l70.30"></a><span id="l70.30" class="difflineminus">-  GenericAccountBuddyPrototype,</span>
<a href="#l70.31"></a><span id="l70.31" class="difflineminus">-  GenericConvIMPrototype,</span>
<a href="#l70.32"></a><span id="l70.32" class="difflineminus">-  GenericConvChatPrototype,</span>
<a href="#l70.33"></a><span id="l70.33" class="difflineminus">-  GenericConversationPrototype,</span>
<a href="#l70.34"></a><span id="l70.34" class="difflineminus">-  TooltipInfo,</span>
<a href="#l70.35"></a><span id="l70.35" class="difflineminus">-} = ChromeUtils.import(&quot;resource:///modules/jsProtoHelper.jsm&quot;);</span>
<a href="#l70.36"></a><span id="l70.36" class="difflineminus">-const { NormalizedMap } = ChromeUtils.import(</span>
<a href="#l70.37"></a><span id="l70.37" class="difflineminus">-  &quot;resource:///modules/NormalizedMap.jsm&quot;</span>
<a href="#l70.38"></a><span id="l70.38" class="difflineplus">+var { XPCOMUtils, l10nHelper } = ChromeUtils.import(</span>
<a href="#l70.39"></a><span id="l70.39" class="difflineplus">+  &quot;resource:///modules/imXPCOMUtils.jsm&quot;</span>
<a href="#l70.40"></a><span id="l70.40"> );</span>
<a href="#l70.41"></a><span id="l70.41" class="difflineminus">-var { Stanza, SupportedFeatures } = ChromeUtils.import(</span>
<a href="#l70.42"></a><span id="l70.42" class="difflineminus">-  &quot;resource:///modules/xmpp-xml.jsm&quot;</span>
<a href="#l70.43"></a><span id="l70.43" class="difflineminus">-);</span>
<a href="#l70.44"></a><span id="l70.44" class="difflineminus">-var { XMPPSession } = ChromeUtils.import(</span>
<a href="#l70.45"></a><span id="l70.45" class="difflineminus">-  &quot;resource:///modules/xmpp-session.jsm&quot;</span>
<a href="#l70.46"></a><span id="l70.46" class="difflineminus">-);</span>
<a href="#l70.47"></a><span id="l70.47" class="difflineminus">-</span>
<a href="#l70.48"></a><span id="l70.48" class="difflineminus">-ChromeUtils.defineModuleGetter(</span>
<a href="#l70.49"></a><span id="l70.49" class="difflineminus">-  this,</span>
<a href="#l70.50"></a><span id="l70.50" class="difflineminus">-  &quot;DownloadUtils&quot;,</span>
<a href="#l70.51"></a><span id="l70.51" class="difflineminus">-  &quot;resource://gre/modules/DownloadUtils.jsm&quot;</span>
<a href="#l70.52"></a><span id="l70.52" class="difflineminus">-);</span>
<a href="#l70.53"></a><span id="l70.53" class="difflineminus">-ChromeUtils.defineModuleGetter(</span>
<a href="#l70.54"></a><span id="l70.54" class="difflineminus">-  this,</span>
<a href="#l70.55"></a><span id="l70.55" class="difflineminus">-  &quot;FileUtils&quot;,</span>
<a href="#l70.56"></a><span id="l70.56" class="difflineminus">-  &quot;resource://gre/modules/FileUtils.jsm&quot;</span>
<a href="#l70.57"></a><span id="l70.57" class="difflineplus">+var { GenericProtocolPrototype } = ChromeUtils.import(</span>
<a href="#l70.58"></a><span id="l70.58" class="difflineplus">+  &quot;resource:///modules/jsProtoHelper.jsm&quot;</span>
<a href="#l70.59"></a><span id="l70.59"> );</span>
<a href="#l70.60"></a><span id="l70.60" class="difflineminus">-ChromeUtils.defineModuleGetter(</span>
<a href="#l70.61"></a><span id="l70.61" class="difflineminus">-  this,</span>
<a href="#l70.62"></a><span id="l70.62" class="difflineminus">-  &quot;NetUtil&quot;,</span>
<a href="#l70.63"></a><span id="l70.63" class="difflineminus">-  &quot;resource://gre/modules/NetUtil.jsm&quot;</span>
<a href="#l70.64"></a><span id="l70.64" class="difflineminus">-);</span>
<a href="#l70.65"></a><span id="l70.65" class="difflineminus">-XPCOMUtils.defineLazyServiceGetter(</span>
<a href="#l70.66"></a><span id="l70.66" class="difflineminus">-  this,</span>
<a href="#l70.67"></a><span id="l70.67" class="difflineminus">-  &quot;imgTools&quot;,</span>
<a href="#l70.68"></a><span id="l70.68" class="difflineminus">-  &quot;@mozilla.org/image/tools;1&quot;,</span>
<a href="#l70.69"></a><span id="l70.69" class="difflineminus">-  &quot;imgITools&quot;</span>
<a href="#l70.70"></a><span id="l70.70" class="difflineminus">-);</span>
<a href="#l70.71"></a><span id="l70.71" class="difflineminus">-XPCOMUtils.defineLazyServiceGetter(</span>
<a href="#l70.72"></a><span id="l70.72" class="difflineminus">-  this,</span>
<a href="#l70.73"></a><span id="l70.73" class="difflineminus">-  &quot;UuidGenerator&quot;,</span>
<a href="#l70.74"></a><span id="l70.74" class="difflineminus">-  &quot;@mozilla.org/uuid-generator;1&quot;,</span>
<a href="#l70.75"></a><span id="l70.75" class="difflineminus">-  &quot;nsIUUIDGenerator&quot;</span>
<a href="#l70.76"></a><span id="l70.76" class="difflineplus">+var { XMPPAccountPrototype } = ChromeUtils.import(</span>
<a href="#l70.77"></a><span id="l70.77" class="difflineplus">+  &quot;resource:///modules/xmpp-base.jsm&quot;</span>
<a href="#l70.78"></a><span id="l70.78"> );</span>
<a href="#l70.79"></a><span id="l70.79"> </span>
<a href="#l70.80"></a><span id="l70.80"> XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l70.81"></a><span id="l70.81">   l10nHelper(&quot;chrome://chat/locale/xmpp.properties&quot;)</span>
<a href="#l70.82"></a><span id="l70.82"> );</span>
<a href="#l70.83"></a><span id="l70.83"> </span>
<a href="#l70.84"></a><span id="l70.84" class="difflineminus">-XPCOMUtils.defineLazyGetter(this, &quot;TXTToHTML&quot;, function() {</span>
<a href="#l70.85"></a><span id="l70.85" class="difflineminus">-  let cs = Cc[&quot;@mozilla.org/txttohtmlconv;1&quot;].getService(Ci.mozITXTToHTMLConv);</span>
<a href="#l70.86"></a><span id="l70.86" class="difflineminus">-  return aTxt =&gt; cs.scanTXT(aTxt, cs.kEntities);</span>
<a href="#l70.87"></a><span id="l70.87" class="difflineminus">-});</span>
<a href="#l70.88"></a><span id="l70.88" class="difflineminus">-</span>
<a href="#l70.89"></a><span id="l70.89" class="difflineminus">-// Parses the status from a presence stanza into an object of statusType,</span>
<a href="#l70.90"></a><span id="l70.90" class="difflineminus">-// statusText and idleSince.</span>
<a href="#l70.91"></a><span id="l70.91" class="difflineminus">-function parseStatus(aStanza) {</span>
<a href="#l70.92"></a><span id="l70.92" class="difflineminus">-  let statusType = Ci.imIStatusInfo.STATUS_AVAILABLE;</span>
<a href="#l70.93"></a><span id="l70.93" class="difflineminus">-  let show = aStanza.getElement([&quot;show&quot;]);</span>
<a href="#l70.94"></a><span id="l70.94" class="difflineminus">-  if (show) {</span>
<a href="#l70.95"></a><span id="l70.95" class="difflineminus">-    show = show.innerText;</span>
<a href="#l70.96"></a><span id="l70.96" class="difflineminus">-    if (show == &quot;away&quot;) {</span>
<a href="#l70.97"></a><span id="l70.97" class="difflineminus">-      statusType = Ci.imIStatusInfo.STATUS_AWAY;</span>
<a href="#l70.98"></a><span id="l70.98" class="difflineminus">-    } else if (show == &quot;chat&quot;) {</span>
<a href="#l70.99"></a><span id="l70.99" class="difflineminus">-      statusType = Ci.imIStatusInfo.STATUS_AVAILABLE; // FIXME</span>
<a href="#l70.100"></a><span id="l70.100" class="difflineminus">-    } else if (show == &quot;dnd&quot;) {</span>
<a href="#l70.101"></a><span id="l70.101" class="difflineminus">-      statusType = Ci.imIStatusInfo.STATUS_UNAVAILABLE;</span>
<a href="#l70.102"></a><span id="l70.102" class="difflineminus">-    } else if (show == &quot;xa&quot;) {</span>
<a href="#l70.103"></a><span id="l70.103" class="difflineminus">-      statusType = Ci.imIStatusInfo.STATUS_IDLE;</span>
<a href="#l70.104"></a><span id="l70.104" class="difflineminus">-    }</span>
<a href="#l70.105"></a><span id="l70.105" class="difflineminus">-  }</span>
<a href="#l70.106"></a><span id="l70.106" class="difflineminus">-</span>
<a href="#l70.107"></a><span id="l70.107" class="difflineminus">-  let idleSince = 0;</span>
<a href="#l70.108"></a><span id="l70.108" class="difflineminus">-  let date = _getDelay(aStanza);</span>
<a href="#l70.109"></a><span id="l70.109" class="difflineminus">-  if (date) {</span>
<a href="#l70.110"></a><span id="l70.110" class="difflineminus">-    idleSince = date.getTime();</span>
<a href="#l70.111"></a><span id="l70.111" class="difflineminus">-  }</span>
<a href="#l70.112"></a><span id="l70.112" class="difflineminus">-</span>
<a href="#l70.113"></a><span id="l70.113" class="difflineminus">-  let query = aStanza.getElement([&quot;query&quot;]);</span>
<a href="#l70.114"></a><span id="l70.114" class="difflineminus">-  if (query &amp;&amp; query.uri == Stanza.NS.last) {</span>
<a href="#l70.115"></a><span id="l70.115" class="difflineminus">-    let now = Math.floor(Date.now() / 1000);</span>
<a href="#l70.116"></a><span id="l70.116" class="difflineminus">-    idleSince = now - parseInt(query.attributes.seconds, 10);</span>
<a href="#l70.117"></a><span id="l70.117" class="difflineminus">-    statusType = Ci.imIStatusInfo.STATUS_IDLE;</span>
<a href="#l70.118"></a><span id="l70.118" class="difflineminus">-  }</span>
<a href="#l70.119"></a><span id="l70.119" class="difflineminus">-</span>
<a href="#l70.120"></a><span id="l70.120" class="difflineminus">-  // Mark official Android clients as mobile.</span>
<a href="#l70.121"></a><span id="l70.121" class="difflineminus">-  const kAndroidNodeURI = &quot;http://www.android.com/gtalk/client/caps&quot;;</span>
<a href="#l70.122"></a><span id="l70.122" class="difflineminus">-  if (</span>
<a href="#l70.123"></a><span id="l70.123" class="difflineminus">-    aStanza</span>
<a href="#l70.124"></a><span id="l70.124" class="difflineminus">-      .getChildrenByNS(Stanza.NS.caps)</span>
<a href="#l70.125"></a><span id="l70.125" class="difflineminus">-      .some(s =&gt; s.localName == &quot;c&quot; &amp;&amp; s.attributes.node == kAndroidNodeURI)</span>
<a href="#l70.126"></a><span id="l70.126" class="difflineminus">-  ) {</span>
<a href="#l70.127"></a><span id="l70.127" class="difflineminus">-    statusType = Ci.imIStatusInfo.STATUS_MOBILE;</span>
<a href="#l70.128"></a><span id="l70.128" class="difflineminus">-  }</span>
<a href="#l70.129"></a><span id="l70.129" class="difflineminus">-</span>
<a href="#l70.130"></a><span id="l70.130" class="difflineminus">-  let status = aStanza.getElement([&quot;status&quot;]);</span>
<a href="#l70.131"></a><span id="l70.131" class="difflineminus">-  status = status ? status.innerText : &quot;&quot;;</span>
<a href="#l70.132"></a><span id="l70.132" class="difflineminus">-</span>
<a href="#l70.133"></a><span id="l70.133" class="difflineminus">-  return { statusType, statusText: status, idleSince };</span>
<a href="#l70.134"></a><span id="l70.134" class="difflineminus">-}</span>
<a href="#l70.135"></a><span id="l70.135" class="difflineminus">-</span>
<a href="#l70.136"></a><span id="l70.136" class="difflineminus">-// Returns a Date object for the delay value (stamp) in aStanza if it exists,</span>
<a href="#l70.137"></a><span id="l70.137" class="difflineminus">-// otherwise returns undefined.</span>
<a href="#l70.138"></a><span id="l70.138" class="difflineminus">-function _getDelay(aStanza) {</span>
<a href="#l70.139"></a><span id="l70.139" class="difflineminus">-  // XEP-0203: Delayed Delivery.</span>
<a href="#l70.140"></a><span id="l70.140" class="difflineminus">-  let date;</span>
<a href="#l70.141"></a><span id="l70.141" class="difflineminus">-  let delay = aStanza.getElement([&quot;delay&quot;]);</span>
<a href="#l70.142"></a><span id="l70.142" class="difflineminus">-  if (delay &amp;&amp; delay.uri == Stanza.NS.delay) {</span>
<a href="#l70.143"></a><span id="l70.143" class="difflineminus">-    if (delay.attributes.stamp) {</span>
<a href="#l70.144"></a><span id="l70.144" class="difflineminus">-      date = new Date(delay.attributes.stamp);</span>
<a href="#l70.145"></a><span id="l70.145" class="difflineminus">-    }</span>
<a href="#l70.146"></a><span id="l70.146" class="difflineminus">-  }</span>
<a href="#l70.147"></a><span id="l70.147" class="difflineminus">-  if (date &amp;&amp; isNaN(date.getTime())) {</span>
<a href="#l70.148"></a><span id="l70.148" class="difflineminus">-    return undefined;</span>
<a href="#l70.149"></a><span id="l70.149" class="difflineminus">-  }</span>
<a href="#l70.150"></a><span id="l70.150" class="difflineminus">-</span>
<a href="#l70.151"></a><span id="l70.151" class="difflineminus">-  return date;</span>
<a href="#l70.152"></a><span id="l70.152" class="difflineminus">-}</span>
<a href="#l70.153"></a><span id="l70.153" class="difflineminus">-</span>
<a href="#l70.154"></a><span id="l70.154" class="difflineminus">-// Writes aMsg in aConv as an outgoing message with optional date as the</span>
<a href="#l70.155"></a><span id="l70.155" class="difflineminus">-// message may be sent from another client.</span>
<a href="#l70.156"></a><span id="l70.156" class="difflineminus">-function _displaySentMsg(aConv, aMsg, aDate) {</span>
<a href="#l70.157"></a><span id="l70.157" class="difflineminus">-  let who;</span>
<a href="#l70.158"></a><span id="l70.158" class="difflineminus">-  if (aConv._account._connection) {</span>
<a href="#l70.159"></a><span id="l70.159" class="difflineminus">-    who = aConv._account._connection._jid.jid;</span>
<a href="#l70.160"></a><span id="l70.160" class="difflineminus">-  }</span>
<a href="#l70.161"></a><span id="l70.161" class="difflineminus">-  if (!who) {</span>
<a href="#l70.162"></a><span id="l70.162" class="difflineminus">-    who = aConv._account.name;</span>
<a href="#l70.163"></a><span id="l70.163" class="difflineminus">-  }</span>
<a href="#l70.164"></a><span id="l70.164" class="difflineminus">-</span>
<a href="#l70.165"></a><span id="l70.165" class="difflineminus">-  let flags = { outgoing: true };</span>
<a href="#l70.166"></a><span id="l70.166" class="difflineminus">-  flags._alias = aConv.account.alias || aConv.account.statusInfo.displayName;</span>
<a href="#l70.167"></a><span id="l70.167" class="difflineminus">-</span>
<a href="#l70.168"></a><span id="l70.168" class="difflineminus">-  if (aDate) {</span>
<a href="#l70.169"></a><span id="l70.169" class="difflineminus">-    flags.time = aDate / 1000;</span>
<a href="#l70.170"></a><span id="l70.170" class="difflineminus">-    flags.delayed = true;</span>
<a href="#l70.171"></a><span id="l70.171" class="difflineminus">-  }</span>
<a href="#l70.172"></a><span id="l70.172" class="difflineminus">-  aConv.writeMessage(who, aMsg, flags);</span>
<a href="#l70.173"></a><span id="l70.173" class="difflineminus">-}</span>
<a href="#l70.174"></a><span id="l70.174" class="difflineminus">-</span>
<a href="#l70.175"></a><span id="l70.175" class="difflineminus">-// The timespan after which we consider roomInfo to be stale.</span>
<a href="#l70.176"></a><span id="l70.176" class="difflineminus">-var kListRefreshInterval = 12 * 60 * 60 * 1000; // 12 hours.</span>
<a href="#l70.177"></a><span id="l70.177" class="difflineminus">-</span>
<a href="#l70.178"></a><span id="l70.178" class="difflineminus">-/* This is an ordered list, used to determine chat buddy flags:</span>
<a href="#l70.179"></a><span id="l70.179" class="difflineminus">- *  index &lt; member    -&gt; noFlags</span>
<a href="#l70.180"></a><span id="l70.180" class="difflineminus">- *  index = member    -&gt; voiced</span>
<a href="#l70.181"></a><span id="l70.181" class="difflineminus">- *          moderator -&gt; halfOp</span>
<a href="#l70.182"></a><span id="l70.182" class="difflineminus">- *          admin     -&gt; op</span>
<a href="#l70.183"></a><span id="l70.183" class="difflineminus">- *          owner     -&gt; founder</span>
<a href="#l70.184"></a><span id="l70.184" class="difflineminus">- */</span>
<a href="#l70.185"></a><span id="l70.185" class="difflineminus">-var kRoles = [</span>
<a href="#l70.186"></a><span id="l70.186" class="difflineminus">-  &quot;outcast&quot;,</span>
<a href="#l70.187"></a><span id="l70.187" class="difflineminus">-  &quot;visitor&quot;,</span>
<a href="#l70.188"></a><span id="l70.188" class="difflineminus">-  &quot;participant&quot;,</span>
<a href="#l70.189"></a><span id="l70.189" class="difflineminus">-  &quot;member&quot;,</span>
<a href="#l70.190"></a><span id="l70.190" class="difflineminus">-  &quot;moderator&quot;,</span>
<a href="#l70.191"></a><span id="l70.191" class="difflineminus">-  &quot;admin&quot;,</span>
<a href="#l70.192"></a><span id="l70.192" class="difflineminus">-  &quot;owner&quot;,</span>
<a href="#l70.193"></a><span id="l70.193" class="difflineminus">-];</span>
<a href="#l70.194"></a><span id="l70.194" class="difflineminus">-</span>
<a href="#l70.195"></a><span id="l70.195" class="difflineminus">-function MUCParticipant(aNick, aJid, aPresenceStanza) {</span>
<a href="#l70.196"></a><span id="l70.196" class="difflineminus">-  this._jid = aJid;</span>
<a href="#l70.197"></a><span id="l70.197" class="difflineminus">-  this.name = aNick;</span>
<a href="#l70.198"></a><span id="l70.198" class="difflineminus">-  this.onPresenceStanza(aPresenceStanza);</span>
<a href="#l70.199"></a><span id="l70.199" class="difflineplus">+function XMPPAccount(aProtoInstance, aImAccount) {</span>
<a href="#l70.200"></a><span id="l70.200" class="difflineplus">+  this._init(aProtoInstance, aImAccount);</span>
<a href="#l70.201"></a><span id="l70.201"> }</span>
<a href="#l70.202"></a><span id="l70.202" class="difflineminus">-MUCParticipant.prototype = {</span>
<a href="#l70.203"></a><span id="l70.203" class="difflineminus">-  __proto__: ClassInfo(&quot;prplIConvChatBuddy&quot;, &quot;XMPP ConvChatBuddy object&quot;),</span>
<a href="#l70.204"></a><span id="l70.204" class="difflineminus">-</span>
<a href="#l70.205"></a><span id="l70.205" class="difflineminus">-  buddy: false,</span>
<a href="#l70.206"></a><span id="l70.206" class="difflineminus">-</span>
<a href="#l70.207"></a><span id="l70.207" class="difflineminus">-  // The occupant jid of the participant which is of the form room@domain/nick.</span>
<a href="#l70.208"></a><span id="l70.208" class="difflineminus">-  _jid: null,</span>
<a href="#l70.209"></a><span id="l70.209" class="difflineminus">-</span>
<a href="#l70.210"></a><span id="l70.210" class="difflineminus">-  // The real jid of the participant which is of the form local@domain/resource.</span>
<a href="#l70.211"></a><span id="l70.211" class="difflineminus">-  accountJid: null,</span>
<a href="#l70.212"></a><span id="l70.212" class="difflineminus">-</span>
<a href="#l70.213"></a><span id="l70.213" class="difflineminus">-  statusType: null,</span>
<a href="#l70.214"></a><span id="l70.214" class="difflineminus">-  statusText: null,</span>
<a href="#l70.215"></a><span id="l70.215" class="difflineminus">-  get alias() {</span>
<a href="#l70.216"></a><span id="l70.216" class="difflineminus">-    return this.name;</span>
<a href="#l70.217"></a><span id="l70.217" class="difflineminus">-  },</span>
<a href="#l70.218"></a><span id="l70.218" class="difflineminus">-</span>
<a href="#l70.219"></a><span id="l70.219" class="difflineminus">-  role: 2, // &quot;participant&quot; by default</span>
<a href="#l70.220"></a><span id="l70.220" class="difflineminus">-</span>
<a href="#l70.221"></a><span id="l70.221" class="difflineminus">-  // Called when a presence stanza is received for this participant.</span>
<a href="#l70.222"></a><span id="l70.222" class="difflineminus">-  onPresenceStanza(aStanza) {</span>
<a href="#l70.223"></a><span id="l70.223" class="difflineminus">-    let statusInfo = parseStatus(aStanza);</span>
<a href="#l70.224"></a><span id="l70.224" class="difflineminus">-    this.statusType = statusInfo.statusType;</span>
<a href="#l70.225"></a><span id="l70.225" class="difflineminus">-    this.statusText = statusInfo.statusText;</span>
<a href="#l70.226"></a><span id="l70.226" class="difflineminus">-</span>
<a href="#l70.227"></a><span id="l70.227" class="difflineminus">-    let x = aStanza.children.filter(</span>
<a href="#l70.228"></a><span id="l70.228" class="difflineminus">-      child =&gt; child.localName == &quot;x&quot; &amp;&amp; child.uri == Stanza.NS.muc_user</span>
<a href="#l70.229"></a><span id="l70.229" class="difflineminus">-    );</span>
<a href="#l70.230"></a><span id="l70.230" class="difflineminus">-    if (x.length == 0) {</span>
<a href="#l70.231"></a><span id="l70.231" class="difflineminus">-      return;</span>
<a href="#l70.232"></a><span id="l70.232" class="difflineminus">-    }</span>
<a href="#l70.233"></a><span id="l70.233" class="difflineminus">-</span>
<a href="#l70.234"></a><span id="l70.234" class="difflineminus">-    // XEP-0045 (7.2.3): We only expect a single &lt;x/&gt; element of this namespace,</span>
<a href="#l70.235"></a><span id="l70.235" class="difflineminus">-    // so we ignore any others.</span>
<a href="#l70.236"></a><span id="l70.236" class="difflineminus">-    x = x[0];</span>
<a href="#l70.237"></a><span id="l70.237" class="difflineminus">-</span>
<a href="#l70.238"></a><span id="l70.238" class="difflineminus">-    let item = x.getElement([&quot;item&quot;]);</span>
<a href="#l70.239"></a><span id="l70.239" class="difflineminus">-    if (!item) {</span>
<a href="#l70.240"></a><span id="l70.240" class="difflineminus">-      return;</span>
<a href="#l70.241"></a><span id="l70.241" class="difflineminus">-    }</span>
<a href="#l70.242"></a><span id="l70.242" class="difflineminus">-</span>
<a href="#l70.243"></a><span id="l70.243" class="difflineminus">-    this.role = Math.max(</span>
<a href="#l70.244"></a><span id="l70.244" class="difflineminus">-      kRoles.indexOf(item.attributes.role),</span>
<a href="#l70.245"></a><span id="l70.245" class="difflineminus">-      kRoles.indexOf(item.attributes.affiliation)</span>
<a href="#l70.246"></a><span id="l70.246" class="difflineminus">-    );</span>
<a href="#l70.247"></a><span id="l70.247" class="difflineminus">-</span>
<a href="#l70.248"></a><span id="l70.248" class="difflineminus">-    let accountJid = item.attributes.jid;</span>
<a href="#l70.249"></a><span id="l70.249" class="difflineminus">-    if (accountJid) {</span>
<a href="#l70.250"></a><span id="l70.250" class="difflineminus">-      this.accountJid = accountJid;</span>
<a href="#l70.251"></a><span id="l70.251" class="difflineminus">-    }</span>
<a href="#l70.252"></a><span id="l70.252" class="difflineminus">-  },</span>
<a href="#l70.253"></a><span id="l70.253" class="difflineminus">-</span>
<a href="#l70.254"></a><span id="l70.254" class="difflineminus">-  get noFlags() {</span>
<a href="#l70.255"></a><span id="l70.255" class="difflineminus">-    return this.role &lt; kRoles.indexOf(&quot;member&quot;);</span>
<a href="#l70.256"></a><span id="l70.256" class="difflineminus">-  },</span>
<a href="#l70.257"></a><span id="l70.257" class="difflineminus">-  get voiced() {</span>
<a href="#l70.258"></a><span id="l70.258" class="difflineminus">-    return this.role == kRoles.indexOf(&quot;member&quot;);</span>
<a href="#l70.259"></a><span id="l70.259" class="difflineminus">-  },</span>
<a href="#l70.260"></a><span id="l70.260" class="difflineminus">-  get halfOp() {</span>
<a href="#l70.261"></a><span id="l70.261" class="difflineminus">-    return this.role == kRoles.indexOf(&quot;moderator&quot;);</span>
<a href="#l70.262"></a><span id="l70.262" class="difflineminus">-  },</span>
<a href="#l70.263"></a><span id="l70.263" class="difflineminus">-  get op() {</span>
<a href="#l70.264"></a><span id="l70.264" class="difflineminus">-    return this.role == kRoles.indexOf(&quot;admin&quot;);</span>
<a href="#l70.265"></a><span id="l70.265" class="difflineminus">-  },</span>
<a href="#l70.266"></a><span id="l70.266" class="difflineminus">-  get founder() {</span>
<a href="#l70.267"></a><span id="l70.267" class="difflineminus">-    return this.role == kRoles.indexOf(&quot;owner&quot;);</span>
<a href="#l70.268"></a><span id="l70.268" class="difflineminus">-  },</span>
<a href="#l70.269"></a><span id="l70.269" class="difflineminus">-  typing: false,</span>
<a href="#l70.270"></a><span id="l70.270" class="difflineminus">-};</span>
<a href="#l70.271"></a><span id="l70.271" class="difflineminus">-</span>
<a href="#l70.272"></a><span id="l70.272" class="difflineminus">-// MUC (Multi-User Chat)</span>
<a href="#l70.273"></a><span id="l70.273" class="difflineminus">-var XMPPMUCConversationPrototype = {</span>
<a href="#l70.274"></a><span id="l70.274" class="difflineminus">-  __proto__: GenericConvChatPrototype,</span>
<a href="#l70.275"></a><span id="l70.275" class="difflineminus">-  // By default users are not in a MUC.</span>
<a href="#l70.276"></a><span id="l70.276" class="difflineminus">-  _left: true,</span>
<a href="#l70.277"></a><span id="l70.277" class="difflineminus">-</span>
<a href="#l70.278"></a><span id="l70.278" class="difflineminus">-  // Tracks all received messages to avoid possible duplication if the server</span>
<a href="#l70.279"></a><span id="l70.279" class="difflineminus">-  // sends us the last few messages again when we rejoin a room.</span>
<a href="#l70.280"></a><span id="l70.280" class="difflineminus">-  _messageIds: new Set(),</span>
<a href="#l70.281"></a><span id="l70.281" class="difflineminus">-</span>
<a href="#l70.282"></a><span id="l70.282" class="difflineminus">-  _init(aAccount, aJID, aNick) {</span>
<a href="#l70.283"></a><span id="l70.283" class="difflineminus">-    this._messageIds = new Set();</span>
<a href="#l70.284"></a><span id="l70.284" class="difflineminus">-    GenericConvChatPrototype._init.call(this, aAccount, aJID, aNick);</span>
<a href="#l70.285"></a><span id="l70.285" class="difflineminus">-  },</span>
<a href="#l70.286"></a><span id="l70.286" class="difflineminus">-</span>
<a href="#l70.287"></a><span id="l70.287" class="difflineminus">-  _targetResource: &quot;&quot;,</span>
<a href="#l70.288"></a><span id="l70.288" class="difflineminus">-</span>
<a href="#l70.289"></a><span id="l70.289" class="difflineminus">-  // True while we are rejoining a room previously parted by the user.</span>
<a href="#l70.290"></a><span id="l70.290" class="difflineminus">-  _rejoined: false,</span>
<a href="#l70.291"></a><span id="l70.291" class="difflineminus">-</span>
<a href="#l70.292"></a><span id="l70.292" class="difflineminus">-  get topic() {</span>
<a href="#l70.293"></a><span id="l70.293" class="difflineminus">-    return this._topic;</span>
<a href="#l70.294"></a><span id="l70.294" class="difflineminus">-  },</span>
<a href="#l70.295"></a><span id="l70.295" class="difflineminus">-  set topic(aTopic) {</span>
<a href="#l70.296"></a><span id="l70.296" class="difflineminus">-    // XEP-0045 (8.1): Modifying the room subject.</span>
<a href="#l70.297"></a><span id="l70.297" class="difflineminus">-    let subject = Stanza.node(&quot;subject&quot;, null, null, aTopic.trim());</span>
<a href="#l70.298"></a><span id="l70.298" class="difflineminus">-    let s = Stanza.message(</span>
<a href="#l70.299"></a><span id="l70.299" class="difflineminus">-      this.name,</span>
<a href="#l70.300"></a><span id="l70.300" class="difflineminus">-      null,</span>
<a href="#l70.301"></a><span id="l70.301" class="difflineminus">-      null,</span>
<a href="#l70.302"></a><span id="l70.302" class="difflineminus">-      { type: &quot;groupchat&quot; },</span>
<a href="#l70.303"></a><span id="l70.303" class="difflineminus">-      subject</span>
<a href="#l70.304"></a><span id="l70.304" class="difflineminus">-    );</span>
<a href="#l70.305"></a><span id="l70.305" class="difflineminus">-    let notAuthorized = _(&quot;conversation.error.changeTopicFailedNotAuthorized&quot;);</span>
<a href="#l70.306"></a><span id="l70.306" class="difflineminus">-    this._account.sendStanza(</span>
<a href="#l70.307"></a><span id="l70.307" class="difflineminus">-      s,</span>
<a href="#l70.308"></a><span id="l70.308" class="difflineminus">-      this._account.handleErrors(</span>
<a href="#l70.309"></a><span id="l70.309" class="difflineminus">-        {</span>
<a href="#l70.310"></a><span id="l70.310" class="difflineminus">-          forbidden: notAuthorized,</span>
<a href="#l70.311"></a><span id="l70.311" class="difflineminus">-          notAcceptable: notAuthorized,</span>
<a href="#l70.312"></a><span id="l70.312" class="difflineminus">-          itemNotFound: notAuthorized,</span>
<a href="#l70.313"></a><span id="l70.313" class="difflineminus">-        },</span>
<a href="#l70.314"></a><span id="l70.314" class="difflineminus">-        this</span>
<a href="#l70.315"></a><span id="l70.315" class="difflineminus">-      )</span>
<a href="#l70.316"></a><span id="l70.316" class="difflineminus">-    );</span>
<a href="#l70.317"></a><span id="l70.317" class="difflineminus">-  },</span>
<a href="#l70.318"></a><span id="l70.318" class="difflineminus">-  get topicSettable() {</span>
<a href="#l70.319"></a><span id="l70.319" class="difflineminus">-    return true;</span>
<a href="#l70.320"></a><span id="l70.320" class="difflineminus">-  },</span>
<a href="#l70.321"></a><span id="l70.321" class="difflineminus">-</span>
<a href="#l70.322"></a><span id="l70.322" class="difflineminus">-  /* Called when the user enters a chat message */</span>
<a href="#l70.323"></a><span id="l70.323" class="difflineminus">-  sendMsg(aMsg) {</span>
<a href="#l70.324"></a><span id="l70.324" class="difflineminus">-    // XEP-0045 (7.4): Sending a message to all occupants in a room.</span>
<a href="#l70.325"></a><span id="l70.325" class="difflineminus">-    let s = Stanza.message(this.name, aMsg, null, { type: &quot;groupchat&quot; });</span>
<a href="#l70.326"></a><span id="l70.326" class="difflineminus">-    let notInRoom = _(</span>
<a href="#l70.327"></a><span id="l70.327" class="difflineminus">-      &quot;conversation.error.sendFailedAsNotInRoom&quot;,</span>
<a href="#l70.328"></a><span id="l70.328" class="difflineminus">-      this.name,</span>
<a href="#l70.329"></a><span id="l70.329" class="difflineminus">-      aMsg</span>
<a href="#l70.330"></a><span id="l70.330" class="difflineminus">-    );</span>
<a href="#l70.331"></a><span id="l70.331" class="difflineminus">-    this._account.sendStanza(</span>
<a href="#l70.332"></a><span id="l70.332" class="difflineminus">-      s,</span>
<a href="#l70.333"></a><span id="l70.333" class="difflineminus">-      this._account.handleErrors(</span>
<a href="#l70.334"></a><span id="l70.334" class="difflineminus">-        {</span>
<a href="#l70.335"></a><span id="l70.335" class="difflineminus">-          itemNotFound: notInRoom,</span>
<a href="#l70.336"></a><span id="l70.336" class="difflineminus">-          notAcceptable: notInRoom,</span>
<a href="#l70.337"></a><span id="l70.337" class="difflineminus">-        },</span>
<a href="#l70.338"></a><span id="l70.338" class="difflineminus">-        this</span>
<a href="#l70.339"></a><span id="l70.339" class="difflineminus">-      )</span>
<a href="#l70.340"></a><span id="l70.340" class="difflineminus">-    );</span>
<a href="#l70.341"></a><span id="l70.341" class="difflineminus">-  },</span>
<a href="#l70.342"></a><span id="l70.342" class="difflineminus">-</span>
<a href="#l70.343"></a><span id="l70.343" class="difflineminus">-  /* Called by the account when a presence stanza is received for this muc */</span>
<a href="#l70.344"></a><span id="l70.344" class="difflineminus">-  onPresenceStanza(aStanza) {</span>
<a href="#l70.345"></a><span id="l70.345" class="difflineminus">-    let from = aStanza.attributes.from;</span>
<a href="#l70.346"></a><span id="l70.346" class="difflineminus">-    let nick = this._account._parseJID(from).resource;</span>
<a href="#l70.347"></a><span id="l70.347" class="difflineminus">-    let jid = this._account.normalize(from);</span>
<a href="#l70.348"></a><span id="l70.348" class="difflineminus">-    let x = aStanza.getElements([&quot;x&quot;]).find(e =&gt; e.uri == Stanza.NS.muc_user);</span>
<a href="#l70.349"></a><span id="l70.349" class="difflineminus">-</span>
<a href="#l70.350"></a><span id="l70.350" class="difflineminus">-    // Check if the join failed.</span>
<a href="#l70.351"></a><span id="l70.351" class="difflineminus">-    if (this.left &amp;&amp; aStanza.attributes.type == &quot;error&quot;) {</span>
<a href="#l70.352"></a><span id="l70.352" class="difflineminus">-      let error = this._account.parseError(aStanza);</span>
<a href="#l70.353"></a><span id="l70.353" class="difflineminus">-      let message;</span>
<a href="#l70.354"></a><span id="l70.354" class="difflineminus">-      switch (error.condition) {</span>
<a href="#l70.355"></a><span id="l70.355" class="difflineminus">-        case &quot;not-authorized&quot;:</span>
<a href="#l70.356"></a><span id="l70.356" class="difflineminus">-        case &quot;registration-required&quot;:</span>
<a href="#l70.357"></a><span id="l70.357" class="difflineminus">-          // XEP-0045 (7.2.7): Members-Only Rooms.</span>
<a href="#l70.358"></a><span id="l70.358" class="difflineminus">-          message = _(&quot;conversation.error.joinFailedNotAuthorized&quot;);</span>
<a href="#l70.359"></a><span id="l70.359" class="difflineminus">-          break;</span>
<a href="#l70.360"></a><span id="l70.360" class="difflineminus">-        case &quot;not-allowed&quot;:</span>
<a href="#l70.361"></a><span id="l70.361" class="difflineminus">-          message = _(&quot;conversation.error.creationFailedNotAllowed&quot;);</span>
<a href="#l70.362"></a><span id="l70.362" class="difflineminus">-          break;</span>
<a href="#l70.363"></a><span id="l70.363" class="difflineminus">-        case &quot;remote-server-not-found&quot;:</span>
<a href="#l70.364"></a><span id="l70.364" class="difflineminus">-          message = _(</span>
<a href="#l70.365"></a><span id="l70.365" class="difflineminus">-            &quot;conversation.error.joinFailedRemoteServerNotFound&quot;,</span>
<a href="#l70.366"></a><span id="l70.366" class="difflineminus">-            this.name</span>
<a href="#l70.367"></a><span id="l70.367" class="difflineminus">-          );</span>
<a href="#l70.368"></a><span id="l70.368" class="difflineminus">-          break;</span>
<a href="#l70.369"></a><span id="l70.369" class="difflineminus">-        case &quot;forbidden&quot;:</span>
<a href="#l70.370"></a><span id="l70.370" class="difflineminus">-          // XEP-0045 (7.2.8): Banned users.</span>
<a href="#l70.371"></a><span id="l70.371" class="difflineminus">-          message = _(&quot;conversation.error.joinForbidden&quot;, this.name);</span>
<a href="#l70.372"></a><span id="l70.372" class="difflineminus">-          break;</span>
<a href="#l70.373"></a><span id="l70.373" class="difflineminus">-        default:</span>
<a href="#l70.374"></a><span id="l70.374" class="difflineminus">-          message = _(&quot;conversation.error.joinFailed&quot;, this.name);</span>
<a href="#l70.375"></a><span id="l70.375" class="difflineminus">-          this.ERROR(&quot;Failed to join MUC: &quot; + aStanza.convertToString());</span>
<a href="#l70.376"></a><span id="l70.376" class="difflineminus">-          break;</span>
<a href="#l70.377"></a><span id="l70.377" class="difflineminus">-      }</span>
<a href="#l70.378"></a><span id="l70.378" class="difflineminus">-      this.writeMessage(this.name, message, { system: true, error: true });</span>
<a href="#l70.379"></a><span id="l70.379" class="difflineminus">-      this.joining = false;</span>
<a href="#l70.380"></a><span id="l70.380" class="difflineminus">-      return;</span>
<a href="#l70.381"></a><span id="l70.381" class="difflineminus">-    }</span>
<a href="#l70.382"></a><span id="l70.382" class="difflineminus">-</span>
<a href="#l70.383"></a><span id="l70.383" class="difflineminus">-    if (!x) {</span>
<a href="#l70.384"></a><span id="l70.384" class="difflineminus">-      this.WARN(</span>
<a href="#l70.385"></a><span id="l70.385" class="difflineminus">-        &quot;Received a MUC presence stanza without an x element or &quot; +</span>
<a href="#l70.386"></a><span id="l70.386" class="difflineminus">-          &quot;with a namespace we don't handle.&quot;</span>
<a href="#l70.387"></a><span id="l70.387" class="difflineminus">-      );</span>
<a href="#l70.388"></a><span id="l70.388" class="difflineminus">-      return;</span>
<a href="#l70.389"></a><span id="l70.389" class="difflineminus">-    }</span>
<a href="#l70.390"></a><span id="l70.390" class="difflineminus">-    let codes = x.getElements([&quot;status&quot;]).map(elt =&gt; elt.attributes.code);</span>
<a href="#l70.391"></a><span id="l70.391" class="difflineminus">-    let item = x.getElement([&quot;item&quot;]);</span>
<a href="#l70.392"></a><span id="l70.392" class="difflineminus">-</span>
<a href="#l70.393"></a><span id="l70.393" class="difflineminus">-    // Changes the nickname of a participant for this muc.</span>
<a href="#l70.394"></a><span id="l70.394" class="difflineminus">-    let changeNick = () =&gt; {</span>
<a href="#l70.395"></a><span id="l70.395" class="difflineminus">-      if (!item || !item.attributes.nick) {</span>
<a href="#l70.396"></a><span id="l70.396" class="difflineminus">-        this.WARN(</span>
<a href="#l70.397"></a><span id="l70.397" class="difflineminus">-          &quot;Received a MUC presence code 303 or 210 stanza without an &quot; +</span>
<a href="#l70.398"></a><span id="l70.398" class="difflineminus">-            &quot;item element or a nick attribute.&quot;</span>
<a href="#l70.399"></a><span id="l70.399" class="difflineminus">-        );</span>
<a href="#l70.400"></a><span id="l70.400" class="difflineminus">-        return;</span>
<a href="#l70.401"></a><span id="l70.401" class="difflineminus">-      }</span>
<a href="#l70.402"></a><span id="l70.402" class="difflineminus">-      let newNick = item.attributes.nick;</span>
<a href="#l70.403"></a><span id="l70.403" class="difflineminus">-      this.updateNick(nick, newNick, nick == this.nick);</span>
<a href="#l70.404"></a><span id="l70.404" class="difflineminus">-    };</span>
<a href="#l70.405"></a><span id="l70.405" class="difflineminus">-</span>
<a href="#l70.406"></a><span id="l70.406" class="difflineminus">-    if (aStanza.attributes.type == &quot;unavailable&quot;) {</span>
<a href="#l70.407"></a><span id="l70.407" class="difflineminus">-      if (!this._participants.has(nick)) {</span>
<a href="#l70.408"></a><span id="l70.408" class="difflineminus">-        this.WARN(</span>
<a href="#l70.409"></a><span id="l70.409" class="difflineminus">-          &quot;received unavailable presence for an unknown MUC participant: &quot; +</span>
<a href="#l70.410"></a><span id="l70.410" class="difflineminus">-            from</span>
<a href="#l70.411"></a><span id="l70.411" class="difflineminus">-        );</span>
<a href="#l70.412"></a><span id="l70.412" class="difflineminus">-        return;</span>
<a href="#l70.413"></a><span id="l70.413" class="difflineminus">-      }</span>
<a href="#l70.414"></a><span id="l70.414" class="difflineminus">-      if (codes.includes(&quot;303&quot;)) {</span>
<a href="#l70.415"></a><span id="l70.415" class="difflineminus">-        // XEP-0045 (7.6): Changing Nickname.</span>
<a href="#l70.416"></a><span id="l70.416" class="difflineminus">-        // Service Updates Nick for user.</span>
<a href="#l70.417"></a><span id="l70.417" class="difflineminus">-        changeNick();</span>
<a href="#l70.418"></a><span id="l70.418" class="difflineminus">-        return;</span>
<a href="#l70.419"></a><span id="l70.419" class="difflineminus">-      }</span>
<a href="#l70.420"></a><span id="l70.420" class="difflineminus">-      if (item &amp;&amp; item.attributes.role == &quot;none&quot;) {</span>
<a href="#l70.421"></a><span id="l70.421" class="difflineminus">-        // XEP-0045: an occupant has left the room.</span>
<a href="#l70.422"></a><span id="l70.422" class="difflineminus">-        this.removeParticipant(nick);</span>
<a href="#l70.423"></a><span id="l70.423" class="difflineminus">-</span>
<a href="#l70.424"></a><span id="l70.424" class="difflineminus">-        // Who caused the participant to leave the room.</span>
<a href="#l70.425"></a><span id="l70.425" class="difflineminus">-        let actor = item.getElement([&quot;actor&quot;]);</span>
<a href="#l70.426"></a><span id="l70.426" class="difflineminus">-        let actorNick = actor ? actor.attributes.nick : &quot;&quot;;</span>
<a href="#l70.427"></a><span id="l70.427" class="difflineminus">-        let isActor = actorNick ? &quot;.actor&quot; : &quot;&quot;;</span>
<a href="#l70.428"></a><span id="l70.428" class="difflineminus">-</span>
<a href="#l70.429"></a><span id="l70.429" class="difflineminus">-        // Why the participant left.</span>
<a href="#l70.430"></a><span id="l70.430" class="difflineminus">-        let reasonNode = item.getElement([&quot;reason&quot;]);</span>
<a href="#l70.431"></a><span id="l70.431" class="difflineminus">-        let reason = reasonNode ? reasonNode.innerText : &quot;&quot;;</span>
<a href="#l70.432"></a><span id="l70.432" class="difflineminus">-        let isReason = reason ? &quot;.reason&quot; : &quot;&quot;;</span>
<a href="#l70.433"></a><span id="l70.433" class="difflineplus">+XMPPAccount.prototype = XMPPAccountPrototype;</span>
<a href="#l70.434"></a><span id="l70.434"> </span>
<a href="#l70.435"></a><span id="l70.435" class="difflineminus">-        let isYou = nick == this.nick ? &quot;.you&quot; : &quot;&quot;;</span>
<a href="#l70.436"></a><span id="l70.436" class="difflineminus">-        let affectedNick = isYou ? &quot;&quot; : nick;</span>
<a href="#l70.437"></a><span id="l70.437" class="difflineminus">-        if (isYou) {</span>
<a href="#l70.438"></a><span id="l70.438" class="difflineminus">-          this.left = true;</span>
<a href="#l70.439"></a><span id="l70.439" class="difflineminus">-        }</span>
<a href="#l70.440"></a><span id="l70.440" class="difflineminus">-</span>
<a href="#l70.441"></a><span id="l70.441" class="difflineminus">-        let message;</span>
<a href="#l70.442"></a><span id="l70.442" class="difflineminus">-        if (codes.includes(&quot;301&quot;)) {</span>
<a href="#l70.443"></a><span id="l70.443" class="difflineminus">-          // XEP-0045 (9.1): Banning a User.</span>
<a href="#l70.444"></a><span id="l70.444" class="difflineminus">-          message = &quot;conversation.message.banned&quot;;</span>
<a href="#l70.445"></a><span id="l70.445" class="difflineminus">-        } else if (codes.includes(&quot;307&quot;)) {</span>
<a href="#l70.446"></a><span id="l70.446" class="difflineminus">-          // XEP-0045 (8.2): Kicking an Occupant.</span>
<a href="#l70.447"></a><span id="l70.447" class="difflineminus">-          message = &quot;conversation.message.kicked&quot;;</span>
<a href="#l70.448"></a><span id="l70.448" class="difflineminus">-        } else if (codes.includes(&quot;322&quot;) || codes.includes(&quot;321&quot;)) {</span>
<a href="#l70.449"></a><span id="l70.449" class="difflineminus">-          // XEP-0045: Inform user that he or she is being removed from the</span>
<a href="#l70.450"></a><span id="l70.450" class="difflineminus">-          // room because the room has been changed to members-only and the</span>
<a href="#l70.451"></a><span id="l70.451" class="difflineminus">-          // user is not a member.</span>
<a href="#l70.452"></a><span id="l70.452" class="difflineminus">-          message = &quot;conversation.message.removedNonMember&quot;;</span>
<a href="#l70.453"></a><span id="l70.453" class="difflineminus">-        } else if (codes.includes(&quot;332&quot;)) {</span>
<a href="#l70.454"></a><span id="l70.454" class="difflineminus">-          // XEP-0045: Inform user that he or she is being removed from the</span>
<a href="#l70.455"></a><span id="l70.455" class="difflineminus">-          // room because the MUC service is being shut down.</span>
<a href="#l70.456"></a><span id="l70.456" class="difflineminus">-          message = &quot;conversation.message.mucShutdown&quot;;</span>
<a href="#l70.457"></a><span id="l70.457" class="difflineminus">-</span>
<a href="#l70.458"></a><span id="l70.458" class="difflineminus">-          // The reason here just duplicates what's in the system message.</span>
<a href="#l70.459"></a><span id="l70.459" class="difflineminus">-          reason = isReason = &quot;&quot;;</span>
<a href="#l70.460"></a><span id="l70.460" class="difflineminus">-        } else {</span>
<a href="#l70.461"></a><span id="l70.461" class="difflineminus">-          // XEP-0045 (7.14): Received when the user parts a room.</span>
<a href="#l70.462"></a><span id="l70.462" class="difflineminus">-          message = &quot;conversation.message.parted&quot;;</span>
<a href="#l70.463"></a><span id="l70.463" class="difflineminus">-</span>
<a href="#l70.464"></a><span id="l70.464" class="difflineminus">-          // The reason is in a status element in this case.</span>
<a href="#l70.465"></a><span id="l70.465" class="difflineminus">-          reasonNode = aStanza.getElement([&quot;status&quot;]);</span>
<a href="#l70.466"></a><span id="l70.466" class="difflineminus">-          reason = reasonNode ? reasonNode.innerText : &quot;&quot;;</span>
<a href="#l70.467"></a><span id="l70.467" class="difflineminus">-          isReason = reason ? &quot;.reason&quot; : &quot;&quot;;</span>
<a href="#l70.468"></a><span id="l70.468" class="difflineminus">-        }</span>
<a href="#l70.469"></a><span id="l70.469" class="difflineminus">-</span>
<a href="#l70.470"></a><span id="l70.470" class="difflineminus">-        if (message) {</span>
<a href="#l70.471"></a><span id="l70.471" class="difflineminus">-          let messageID = message + isYou + isActor + isReason;</span>
<a href="#l70.472"></a><span id="l70.472" class="difflineminus">-          let params = [actorNick, affectedNick, reason].filter(s =&gt; s);</span>
<a href="#l70.473"></a><span id="l70.473" class="difflineminus">-          this.writeMessage(this.name, _(messageID, ...params), {</span>
<a href="#l70.474"></a><span id="l70.474" class="difflineminus">-            system: true,</span>
<a href="#l70.475"></a><span id="l70.475" class="difflineminus">-          });</span>
<a href="#l70.476"></a><span id="l70.476" class="difflineminus">-        }</span>
<a href="#l70.477"></a><span id="l70.477" class="difflineminus">-      } else {</span>
<a href="#l70.478"></a><span id="l70.478" class="difflineminus">-        this.WARN(&quot;Unhandled type==unavailable MUC presence stanza.&quot;);</span>
<a href="#l70.479"></a><span id="l70.479" class="difflineminus">-      }</span>
<a href="#l70.480"></a><span id="l70.480" class="difflineminus">-      return;</span>
<a href="#l70.481"></a><span id="l70.481" class="difflineminus">-    }</span>
<a href="#l70.482"></a><span id="l70.482" class="difflineminus">-</span>
<a href="#l70.483"></a><span id="l70.483" class="difflineminus">-    if (codes.includes(&quot;201&quot;)) {</span>
<a href="#l70.484"></a><span id="l70.484" class="difflineminus">-      // XEP-0045 (10.1): Creating room.</span>
<a href="#l70.485"></a><span id="l70.485" class="difflineminus">-      // Service Acknowledges Room Creation</span>
<a href="#l70.486"></a><span id="l70.486" class="difflineminus">-      // and Room is awaiting configuration.</span>
<a href="#l70.487"></a><span id="l70.487" class="difflineminus">-      // XEP-0045 (10.1.2): Instant room.</span>
<a href="#l70.488"></a><span id="l70.488" class="difflineminus">-      let query = Stanza.node(</span>
<a href="#l70.489"></a><span id="l70.489" class="difflineminus">-        &quot;query&quot;,</span>
<a href="#l70.490"></a><span id="l70.490" class="difflineminus">-        Stanza.NS.muc_owner,</span>
<a href="#l70.491"></a><span id="l70.491" class="difflineminus">-        null,</span>
<a href="#l70.492"></a><span id="l70.492" class="difflineminus">-        Stanza.node(&quot;x&quot;, Stanza.NS.xdata, { type: &quot;submit&quot; })</span>
<a href="#l70.493"></a><span id="l70.493" class="difflineminus">-      );</span>
<a href="#l70.494"></a><span id="l70.494" class="difflineminus">-      let s = Stanza.iq(&quot;set&quot;, null, jid, query);</span>
<a href="#l70.495"></a><span id="l70.495" class="difflineminus">-      this._account.sendStanza(s, aStanzaReceived =&gt; {</span>
<a href="#l70.496"></a><span id="l70.496" class="difflineminus">-        if (aStanzaReceived.attributes.type != &quot;result&quot;) {</span>
<a href="#l70.497"></a><span id="l70.497" class="difflineminus">-          return false;</span>
<a href="#l70.498"></a><span id="l70.498" class="difflineminus">-        }</span>
<a href="#l70.499"></a><span id="l70.499" class="difflineminus">-</span>
<a href="#l70.500"></a><span id="l70.500" class="difflineminus">-        // XEP-0045: Service Informs New Room Owner of Success</span>
<a href="#l70.501"></a><span id="l70.501" class="difflineminus">-        // for instant and reserved rooms.</span>
<a href="#l70.502"></a><span id="l70.502" class="difflineminus">-        this.left = false;</span>
<a href="#l70.503"></a><span id="l70.503" class="difflineminus">-        this.joining = false;</span>
<a href="#l70.504"></a><span id="l70.504" class="difflineminus">-        return true;</span>
<a href="#l70.505"></a><span id="l70.505" class="difflineminus">-      });</span>
<a href="#l70.506"></a><span id="l70.506" class="difflineminus">-    } else if (codes.includes(&quot;210&quot;)) {</span>
<a href="#l70.507"></a><span id="l70.507" class="difflineminus">-      // XEP-0045 (7.6): Changing Nickname.</span>
<a href="#l70.508"></a><span id="l70.508" class="difflineminus">-      // Service modifies this user's nickname in accordance with local service</span>
<a href="#l70.509"></a><span id="l70.509" class="difflineminus">-      // policies.</span>
<a href="#l70.510"></a><span id="l70.510" class="difflineminus">-      changeNick();</span>
<a href="#l70.511"></a><span id="l70.511" class="difflineminus">-      return;</span>
<a href="#l70.512"></a><span id="l70.512" class="difflineminus">-    } else if (codes.includes(&quot;110&quot;)) {</span>
<a href="#l70.513"></a><span id="l70.513" class="difflineminus">-      // XEP-0045: Room exists and joined successfully.</span>
<a href="#l70.514"></a><span id="l70.514" class="difflineminus">-      this.left = false;</span>
<a href="#l70.515"></a><span id="l70.515" class="difflineminus">-      this.joining = false;</span>
<a href="#l70.516"></a><span id="l70.516" class="difflineminus">-      // TODO (Bug 1172350): Implement Service Discovery Extensions (XEP-0128) to obtain</span>
<a href="#l70.517"></a><span id="l70.517" class="difflineminus">-      // configuration of this room.</span>
<a href="#l70.518"></a><span id="l70.518" class="difflineminus">-    }</span>
<a href="#l70.519"></a><span id="l70.519" class="difflineminus">-</span>
<a href="#l70.520"></a><span id="l70.520" class="difflineminus">-    if (!this._participants.get(nick)) {</span>
<a href="#l70.521"></a><span id="l70.521" class="difflineminus">-      let participant = new MUCParticipant(nick, from, aStanza);</span>
<a href="#l70.522"></a><span id="l70.522" class="difflineminus">-      this._participants.set(nick, participant);</span>
<a href="#l70.523"></a><span id="l70.523" class="difflineminus">-      this.notifyObservers(</span>
<a href="#l70.524"></a><span id="l70.524" class="difflineminus">-        new nsSimpleEnumerator([participant]),</span>
<a href="#l70.525"></a><span id="l70.525" class="difflineminus">-        &quot;chat-buddy-add&quot;</span>
<a href="#l70.526"></a><span id="l70.526" class="difflineminus">-      );</span>
<a href="#l70.527"></a><span id="l70.527" class="difflineminus">-      if (this.nick != nick &amp;&amp; !this.joining) {</span>
<a href="#l70.528"></a><span id="l70.528" class="difflineminus">-        this.writeMessage(this.name, _(&quot;conversation.message.join&quot;, nick), {</span>
<a href="#l70.529"></a><span id="l70.529" class="difflineminus">-          system: true,</span>
<a href="#l70.530"></a><span id="l70.530" class="difflineminus">-        });</span>
<a href="#l70.531"></a><span id="l70.531" class="difflineminus">-      } else if (this.nick == nick &amp;&amp; this._rejoined) {</span>
<a href="#l70.532"></a><span id="l70.532" class="difflineminus">-        this.writeMessage(this.name, _(&quot;conversation.message.rejoined&quot;), {</span>
<a href="#l70.533"></a><span id="l70.533" class="difflineminus">-          system: true,</span>
<a href="#l70.534"></a><span id="l70.534" class="difflineminus">-        });</span>
<a href="#l70.535"></a><span id="l70.535" class="difflineminus">-        this._rejoined = false;</span>
<a href="#l70.536"></a><span id="l70.536" class="difflineminus">-      }</span>
<a href="#l70.537"></a><span id="l70.537" class="difflineminus">-    } else {</span>
<a href="#l70.538"></a><span id="l70.538" class="difflineminus">-      this._participants.get(nick).onPresenceStanza(aStanza);</span>
<a href="#l70.539"></a><span id="l70.539" class="difflineminus">-      this.notifyObservers(this._participants.get(nick), &quot;chat-buddy-update&quot;);</span>
<a href="#l70.540"></a><span id="l70.540" class="difflineminus">-    }</span>
<a href="#l70.541"></a><span id="l70.541" class="difflineminus">-  },</span>
<a href="#l70.542"></a><span id="l70.542" class="difflineminus">-</span>
<a href="#l70.543"></a><span id="l70.543" class="difflineminus">-  /* Called by the account when a message is received for this muc */</span>
<a href="#l70.544"></a><span id="l70.544" class="difflineminus">-  incomingMessage(aMsg, aStanza, aDate) {</span>
<a href="#l70.545"></a><span id="l70.545" class="difflineminus">-    let from = this._account._parseJID(aStanza.attributes.from).resource;</span>
<a href="#l70.546"></a><span id="l70.546" class="difflineminus">-    let id = aStanza.attributes.id;</span>
<a href="#l70.547"></a><span id="l70.547" class="difflineminus">-    let flags = {};</span>
<a href="#l70.548"></a><span id="l70.548" class="difflineminus">-    if (!from) {</span>
<a href="#l70.549"></a><span id="l70.549" class="difflineminus">-      flags.system = true;</span>
<a href="#l70.550"></a><span id="l70.550" class="difflineminus">-      from = this.name;</span>
<a href="#l70.551"></a><span id="l70.551" class="difflineminus">-    } else if (aStanza.attributes.type == &quot;error&quot;) {</span>
<a href="#l70.552"></a><span id="l70.552" class="difflineminus">-      aMsg = _(&quot;conversation.error.notDelivered&quot;, aMsg);</span>
<a href="#l70.553"></a><span id="l70.553" class="difflineminus">-      flags.system = true;</span>
<a href="#l70.554"></a><span id="l70.554" class="difflineminus">-      flags.error = true;</span>
<a href="#l70.555"></a><span id="l70.555" class="difflineminus">-    } else if (from == this._nick) {</span>
<a href="#l70.556"></a><span id="l70.556" class="difflineminus">-      flags.outgoing = true;</span>
<a href="#l70.557"></a><span id="l70.557" class="difflineminus">-    } else {</span>
<a href="#l70.558"></a><span id="l70.558" class="difflineminus">-      flags.incoming = true;</span>
<a href="#l70.559"></a><span id="l70.559" class="difflineminus">-    }</span>
<a href="#l70.560"></a><span id="l70.560" class="difflineminus">-    if (aDate) {</span>
<a href="#l70.561"></a><span id="l70.561" class="difflineminus">-      flags.time = aDate / 1000;</span>
<a href="#l70.562"></a><span id="l70.562" class="difflineminus">-      flags.delayed = true;</span>
<a href="#l70.563"></a><span id="l70.563" class="difflineminus">-    }</span>
<a href="#l70.564"></a><span id="l70.564" class="difflineminus">-    if (id) {</span>
<a href="#l70.565"></a><span id="l70.565" class="difflineminus">-      // Checks if a message exists in conversation to avoid duplication.</span>
<a href="#l70.566"></a><span id="l70.566" class="difflineminus">-      if (this._messageIds.has(id)) {</span>
<a href="#l70.567"></a><span id="l70.567" class="difflineminus">-        return;</span>
<a href="#l70.568"></a><span id="l70.568" class="difflineminus">-      }</span>
<a href="#l70.569"></a><span id="l70.569" class="difflineminus">-      this._messageIds.add(id);</span>
<a href="#l70.570"></a><span id="l70.570" class="difflineminus">-    }</span>
<a href="#l70.571"></a><span id="l70.571" class="difflineminus">-    this.writeMessage(from, aMsg, flags);</span>
<a href="#l70.572"></a><span id="l70.572" class="difflineminus">-  },</span>
<a href="#l70.573"></a><span id="l70.573" class="difflineminus">-</span>
<a href="#l70.574"></a><span id="l70.574" class="difflineminus">-  getNormalizedChatBuddyName(aNick) {</span>
<a href="#l70.575"></a><span id="l70.575" class="difflineminus">-    return this._account.normalizeFullJid(this.name + &quot;/&quot; + aNick);</span>
<a href="#l70.576"></a><span id="l70.576" class="difflineminus">-  },</span>
<a href="#l70.577"></a><span id="l70.577" class="difflineminus">-</span>
<a href="#l70.578"></a><span id="l70.578" class="difflineminus">-  // Leaves MUC conversation.</span>
<a href="#l70.579"></a><span id="l70.579" class="difflineminus">-  part(aMsg = null) {</span>
<a href="#l70.580"></a><span id="l70.580" class="difflineminus">-    let s = Stanza.presence(</span>
<a href="#l70.581"></a><span id="l70.581" class="difflineminus">-      { to: this.name + &quot;/&quot; + this._nick, type: &quot;unavailable&quot; },</span>
<a href="#l70.582"></a><span id="l70.582" class="difflineminus">-      aMsg ? Stanza.node(&quot;status&quot;, null, null, aMsg.trim()) : null</span>
<a href="#l70.583"></a><span id="l70.583" class="difflineminus">-    );</span>
<a href="#l70.584"></a><span id="l70.584" class="difflineminus">-    this._account.sendStanza(s);</span>
<a href="#l70.585"></a><span id="l70.585" class="difflineminus">-    delete this.chatRoomFields;</span>
<a href="#l70.586"></a><span id="l70.586" class="difflineplus">+function XMPPProtocol() {</span>
<a href="#l70.587"></a><span id="l70.587" class="difflineplus">+  ChromeUtils.import(&quot;resource:///modules/xmpp-commands.jsm&quot;, this);</span>
<a href="#l70.588"></a><span id="l70.588" class="difflineplus">+  this.registerCommands();</span>
<a href="#l70.589"></a><span id="l70.589" class="difflineplus">+}</span>
<a href="#l70.590"></a><span id="l70.590" class="difflineplus">+XMPPProtocol.prototype = {</span>
<a href="#l70.591"></a><span id="l70.591" class="difflineplus">+  __proto__: GenericProtocolPrototype,</span>
<a href="#l70.592"></a><span id="l70.592" class="difflineplus">+  get normalizedName() {</span>
<a href="#l70.593"></a><span id="l70.593" class="difflineplus">+    return &quot;jabber&quot;;</span>
<a href="#l70.594"></a><span id="l70.594">   },</span>
<a href="#l70.595"></a><span id="l70.595" class="difflineminus">-</span>
<a href="#l70.596"></a><span id="l70.596" class="difflineminus">-  // Invites a user to MUC conversation.</span>
<a href="#l70.597"></a><span id="l70.597" class="difflineminus">-  invite(aJID, aMsg = null) {</span>
<a href="#l70.598"></a><span id="l70.598" class="difflineminus">-    // XEP-0045 (7.8): Inviting Another User to a Room.</span>
<a href="#l70.599"></a><span id="l70.599" class="difflineminus">-    // XEP-0045 (7.8.2): Mediated Invitation.</span>
<a href="#l70.600"></a><span id="l70.600" class="difflineminus">-    let invite = Stanza.node(</span>
<a href="#l70.601"></a><span id="l70.601" class="difflineminus">-      &quot;invite&quot;,</span>
<a href="#l70.602"></a><span id="l70.602" class="difflineminus">-      null,</span>
<a href="#l70.603"></a><span id="l70.603" class="difflineminus">-      { to: aJID },</span>
<a href="#l70.604"></a><span id="l70.604" class="difflineminus">-      aMsg ? Stanza.node(&quot;reason&quot;, null, null, aMsg) : null</span>
<a href="#l70.605"></a><span id="l70.605" class="difflineminus">-    );</span>
<a href="#l70.606"></a><span id="l70.606" class="difflineminus">-    let x = Stanza.node(&quot;x&quot;, Stanza.NS.muc_user, null, invite);</span>
<a href="#l70.607"></a><span id="l70.607" class="difflineminus">-    let s = Stanza.node(&quot;message&quot;, null, { to: this.name }, x);</span>
<a href="#l70.608"></a><span id="l70.608" class="difflineminus">-    this._account.sendStanza(</span>
<a href="#l70.609"></a><span id="l70.609" class="difflineminus">-      s,</span>
<a href="#l70.610"></a><span id="l70.610" class="difflineminus">-      this._account.handleErrors(</span>
<a href="#l70.611"></a><span id="l70.611" class="difflineminus">-        {</span>
<a href="#l70.612"></a><span id="l70.612" class="difflineminus">-          forbidden: _(&quot;conversation.error.inviteFailedForbidden&quot;),</span>
<a href="#l70.613"></a><span id="l70.613" class="difflineminus">-          // ejabberd uses error not-allowed to indicate that this account does not</span>
<a href="#l70.614"></a><span id="l70.614" class="difflineminus">-          // have the required privileges to invite users instead of forbidden error,</span>
<a href="#l70.615"></a><span id="l70.615" class="difflineminus">-          // and this is not mentioned in the spec (XEP-0045).</span>
<a href="#l70.616"></a><span id="l70.616" class="difflineminus">-          notAllowed: _(&quot;conversation.error.inviteFailedForbidden&quot;),</span>
<a href="#l70.617"></a><span id="l70.617" class="difflineminus">-          itemNotFound: _(&quot;conversation.error.failedJIDNotFound&quot;, aJID),</span>
<a href="#l70.618"></a><span id="l70.618" class="difflineminus">-        },</span>
<a href="#l70.619"></a><span id="l70.619" class="difflineminus">-        this</span>
<a href="#l70.620"></a><span id="l70.620" class="difflineminus">-      )</span>
<a href="#l70.621"></a><span id="l70.621" class="difflineminus">-    );</span>
<a href="#l70.622"></a><span id="l70.622" class="difflineminus">-  },</span>
<a href="#l70.623"></a><span id="l70.623" class="difflineminus">-</span>
<a href="#l70.624"></a><span id="l70.624" class="difflineminus">-  // Bans a participant from MUC conversation.</span>
<a href="#l70.625"></a><span id="l70.625" class="difflineminus">-  ban(aNickName, aMsg = null) {</span>
<a href="#l70.626"></a><span id="l70.626" class="difflineminus">-    // XEP-0045 (9.1): Banning a User.</span>
<a href="#l70.627"></a><span id="l70.627" class="difflineminus">-    let participant = this._participants.get(aNickName);</span>
<a href="#l70.628"></a><span id="l70.628" class="difflineminus">-    if (!participant) {</span>
<a href="#l70.629"></a><span id="l70.629" class="difflineminus">-      this.writeMessage(</span>
<a href="#l70.630"></a><span id="l70.630" class="difflineminus">-        this.name,</span>
<a href="#l70.631"></a><span id="l70.631" class="difflineminus">-        _(&quot;conversation.error.nickNotInRoom&quot;, aNickName),</span>
<a href="#l70.632"></a><span id="l70.632" class="difflineminus">-        { system: true }</span>
<a href="#l70.633"></a><span id="l70.633" class="difflineminus">-      );</span>
<a href="#l70.634"></a><span id="l70.634" class="difflineminus">-      return;</span>
<a href="#l70.635"></a><span id="l70.635" class="difflineminus">-    }</span>
<a href="#l70.636"></a><span id="l70.636" class="difflineminus">-    if (!participant.accountJid) {</span>
<a href="#l70.637"></a><span id="l70.637" class="difflineminus">-      this.writeMessage(</span>
<a href="#l70.638"></a><span id="l70.638" class="difflineminus">-        this.name,</span>
<a href="#l70.639"></a><span id="l70.639" class="difflineminus">-        _(&quot;conversation.error.banCommandAnonymousRoom&quot;),</span>
<a href="#l70.640"></a><span id="l70.640" class="difflineminus">-        { system: true }</span>
<a href="#l70.641"></a><span id="l70.641" class="difflineminus">-      );</span>
<a href="#l70.642"></a><span id="l70.642" class="difflineminus">-      return;</span>
<a href="#l70.643"></a><span id="l70.643" class="difflineminus">-    }</span>
<a href="#l70.644"></a><span id="l70.644" class="difflineminus">-</span>
<a href="#l70.645"></a><span id="l70.645" class="difflineminus">-    let attributes = { affiliation: &quot;outcast&quot;, jid: participant.accountJid };</span>
<a href="#l70.646"></a><span id="l70.646" class="difflineminus">-    let item = Stanza.node(</span>
<a href="#l70.647"></a><span id="l70.647" class="difflineminus">-      &quot;item&quot;,</span>
<a href="#l70.648"></a><span id="l70.648" class="difflineminus">-      null,</span>
<a href="#l70.649"></a><span id="l70.649" class="difflineminus">-      attributes,</span>
<a href="#l70.650"></a><span id="l70.650" class="difflineminus">-      aMsg ? Stanza.node(&quot;reason&quot;, null, null, aMsg) : null</span>
<a href="#l70.651"></a><span id="l70.651" class="difflineminus">-    );</span>
<a href="#l70.652"></a><span id="l70.652" class="difflineminus">-    let s = Stanza.iq(</span>
<a href="#l70.653"></a><span id="l70.653" class="difflineminus">-      &quot;set&quot;,</span>
<a href="#l70.654"></a><span id="l70.654" class="difflineminus">-      null,</span>
<a href="#l70.655"></a><span id="l70.655" class="difflineminus">-      this.name,</span>
<a href="#l70.656"></a><span id="l70.656" class="difflineminus">-      Stanza.node(&quot;query&quot;, Stanza.NS.muc_admin, null, item)</span>
<a href="#l70.657"></a><span id="l70.657" class="difflineminus">-    );</span>
<a href="#l70.658"></a><span id="l70.658" class="difflineminus">-    this._account.sendStanza(s, this._banKickHandler, this);</span>
<a href="#l70.659"></a><span id="l70.659" class="difflineminus">-  },</span>
<a href="#l70.660"></a><span id="l70.660" class="difflineminus">-</span>
<a href="#l70.661"></a><span id="l70.661" class="difflineminus">-  // Kicks a participant from MUC conversation.</span>
<a href="#l70.662"></a><span id="l70.662" class="difflineminus">-  kick(aNickName, aMsg = null) {</span>
<a href="#l70.663"></a><span id="l70.663" class="difflineminus">-    // XEP-0045 (8.2): Kicking an Occupant.</span>
<a href="#l70.664"></a><span id="l70.664" class="difflineminus">-    let attributes = { role: &quot;none&quot;, nick: aNickName };</span>
<a href="#l70.665"></a><span id="l70.665" class="difflineminus">-    let item = Stanza.node(</span>
<a href="#l70.666"></a><span id="l70.666" class="difflineminus">-      &quot;item&quot;,</span>
<a href="#l70.667"></a><span id="l70.667" class="difflineminus">-      null,</span>
<a href="#l70.668"></a><span id="l70.668" class="difflineminus">-      attributes,</span>
<a href="#l70.669"></a><span id="l70.669" class="difflineminus">-      aMsg ? Stanza.node(&quot;reason&quot;, null, null, aMsg) : null</span>
<a href="#l70.670"></a><span id="l70.670" class="difflineminus">-    );</span>
<a href="#l70.671"></a><span id="l70.671" class="difflineminus">-    let s = Stanza.iq(</span>
<a href="#l70.672"></a><span id="l70.672" class="difflineminus">-      &quot;set&quot;,</span>
<a href="#l70.673"></a><span id="l70.673" class="difflineminus">-      null,</span>
<a href="#l70.674"></a><span id="l70.674" class="difflineminus">-      this.name,</span>
<a href="#l70.675"></a><span id="l70.675" class="difflineminus">-      Stanza.node(&quot;query&quot;, Stanza.NS.muc_admin, null, item)</span>
<a href="#l70.676"></a><span id="l70.676" class="difflineminus">-    );</span>
<a href="#l70.677"></a><span id="l70.677" class="difflineminus">-    this._account.sendStanza(s, this._banKickHandler, this);</span>
<a href="#l70.678"></a><span id="l70.678" class="difflineminus">-  },</span>
<a href="#l70.679"></a><span id="l70.679" class="difflineminus">-</span>
<a href="#l70.680"></a><span id="l70.680" class="difflineminus">-  // Callback for ban and kick commands.</span>
<a href="#l70.681"></a><span id="l70.681" class="difflineminus">-  _banKickHandler(aStanza) {</span>
<a href="#l70.682"></a><span id="l70.682" class="difflineminus">-    return this._account._handleResult(</span>
<a href="#l70.683"></a><span id="l70.683" class="difflineminus">-      {</span>
<a href="#l70.684"></a><span id="l70.684" class="difflineminus">-        notAllowed: _(&quot;conversation.error.banKickCommandNotAllowed&quot;),</span>
<a href="#l70.685"></a><span id="l70.685" class="difflineminus">-        conflict: _(&quot;conversation.error.banKickCommandConflict&quot;),</span>
<a href="#l70.686"></a><span id="l70.686" class="difflineminus">-      },</span>
<a href="#l70.687"></a><span id="l70.687" class="difflineminus">-      this</span>
<a href="#l70.688"></a><span id="l70.688" class="difflineminus">-    )(aStanza);</span>
<a href="#l70.689"></a><span id="l70.689" class="difflineplus">+  get name() {</span>
<a href="#l70.690"></a><span id="l70.690" class="difflineplus">+    return &quot;XMPP&quot;;</span>
<a href="#l70.691"></a><span id="l70.691">   },</span>
<a href="#l70.692"></a><span id="l70.692" class="difflineminus">-</span>
<a href="#l70.693"></a><span id="l70.693" class="difflineminus">-  // Changes nick in MUC conversation to a new one.</span>
<a href="#l70.694"></a><span id="l70.694" class="difflineminus">-  setNick(aNewNick) {</span>
<a href="#l70.695"></a><span id="l70.695" class="difflineminus">-    // XEP-0045 (7.6): Changing Nickname.</span>
<a href="#l70.696"></a><span id="l70.696" class="difflineminus">-    let s = Stanza.presence({ to: this.name + &quot;/&quot; + aNewNick }, null);</span>
<a href="#l70.697"></a><span id="l70.697" class="difflineminus">-    this._account.sendStanza(</span>
<a href="#l70.698"></a><span id="l70.698" class="difflineminus">-      s,</span>
<a href="#l70.699"></a><span id="l70.699" class="difflineminus">-      this._account.handleErrors(</span>
<a href="#l70.700"></a><span id="l70.700" class="difflineminus">-        {</span>
<a href="#l70.701"></a><span id="l70.701" class="difflineminus">-          // XEP-0045 (7.6): Changing Nickname (example 53).</span>
<a href="#l70.702"></a><span id="l70.702" class="difflineminus">-          // TODO: We should discover if the user has a reserved nickname (maybe</span>
<a href="#l70.703"></a><span id="l70.703" class="difflineminus">-          // before joining a room), cf. XEP-0045 (7.12).</span>
<a href="#l70.704"></a><span id="l70.704" class="difflineminus">-          notAcceptable: _(</span>
<a href="#l70.705"></a><span id="l70.705" class="difflineminus">-            &quot;conversation.error.changeNickFailedNotAcceptable&quot;,</span>
<a href="#l70.706"></a><span id="l70.706" class="difflineminus">-            aNewNick</span>
<a href="#l70.707"></a><span id="l70.707" class="difflineminus">-          ),</span>
<a href="#l70.708"></a><span id="l70.708" class="difflineminus">-          // XEP-0045 (7.2.9): Nickname Conflict.</span>
<a href="#l70.709"></a><span id="l70.709" class="difflineminus">-          conflict: _(&quot;conversation.error.changeNickFailedConflict&quot;, aNewNick),</span>
<a href="#l70.710"></a><span id="l70.710" class="difflineminus">-        },</span>
<a href="#l70.711"></a><span id="l70.711" class="difflineminus">-        this</span>
<a href="#l70.712"></a><span id="l70.712" class="difflineminus">-      )</span>
<a href="#l70.713"></a><span id="l70.713" class="difflineminus">-    );</span>
<a href="#l70.714"></a><span id="l70.714" class="difflineminus">-  },</span>
<a href="#l70.715"></a><span id="l70.715" class="difflineminus">-</span>
<a href="#l70.716"></a><span id="l70.716" class="difflineminus">-  // Called by the account when a message stanza is received for this muc and</span>
<a href="#l70.717"></a><span id="l70.717" class="difflineminus">-  // needs to be handled.</span>
<a href="#l70.718"></a><span id="l70.718" class="difflineminus">-  onMessageStanza(aStanza) {</span>
<a href="#l70.719"></a><span id="l70.719" class="difflineminus">-    let x = aStanza.getElement([&quot;x&quot;]);</span>
<a href="#l70.720"></a><span id="l70.720" class="difflineminus">-    let decline = x.getElement([&quot;decline&quot;]);</span>
<a href="#l70.721"></a><span id="l70.721" class="difflineminus">-    if (decline) {</span>
<a href="#l70.722"></a><span id="l70.722" class="difflineminus">-      // XEP-0045 (7.8): Inviting Another User to a Room.</span>
<a href="#l70.723"></a><span id="l70.723" class="difflineminus">-      // XEP-0045 (7.8.2): Mediated Invitation.</span>
<a href="#l70.724"></a><span id="l70.724" class="difflineminus">-      let invitee = decline.attributes.jid;</span>
<a href="#l70.725"></a><span id="l70.725" class="difflineminus">-      let reasonNode = decline.getElement([&quot;reason&quot;]);</span>
<a href="#l70.726"></a><span id="l70.726" class="difflineminus">-      let reason = reasonNode ? reasonNode.innerText : &quot;&quot;;</span>
<a href="#l70.727"></a><span id="l70.727" class="difflineminus">-      let msg;</span>
<a href="#l70.728"></a><span id="l70.728" class="difflineminus">-      if (reason) {</span>
<a href="#l70.729"></a><span id="l70.729" class="difflineminus">-        msg = _(</span>
<a href="#l70.730"></a><span id="l70.730" class="difflineminus">-          &quot;conversation.message.invitationDeclined.reason&quot;,</span>
<a href="#l70.731"></a><span id="l70.731" class="difflineminus">-          invitee,</span>
<a href="#l70.732"></a><span id="l70.732" class="difflineminus">-          reason</span>
<a href="#l70.733"></a><span id="l70.733" class="difflineminus">-        );</span>
<a href="#l70.734"></a><span id="l70.734" class="difflineminus">-      } else {</span>
<a href="#l70.735"></a><span id="l70.735" class="difflineminus">-        msg = _(&quot;conversation.message.invitationDeclined&quot;, invitee);</span>
<a href="#l70.736"></a><span id="l70.736" class="difflineminus">-      }</span>
<a href="#l70.737"></a><span id="l70.737" class="difflineminus">-</span>
<a href="#l70.738"></a><span id="l70.738" class="difflineminus">-      this.writeMessage(this.name, msg, { system: true });</span>
<a href="#l70.739"></a><span id="l70.739" class="difflineminus">-    } else {</span>
<a href="#l70.740"></a><span id="l70.740" class="difflineminus">-      this.WARN(&quot;Unhandled message stanza.&quot;);</span>
<a href="#l70.741"></a><span id="l70.741" class="difflineminus">-    }</span>
<a href="#l70.742"></a><span id="l70.742" class="difflineplus">+  get iconBaseURI() {</span>
<a href="#l70.743"></a><span id="l70.743" class="difflineplus">+    return &quot;chrome://prpl-jabber/skin/&quot;;</span>
<a href="#l70.744"></a><span id="l70.744">   },</span>
<a href="#l70.745"></a><span id="l70.745" class="difflineminus">-</span>
<a href="#l70.746"></a><span id="l70.746" class="difflineminus">-  /* Called when the user closed the conversation */</span>
<a href="#l70.747"></a><span id="l70.747" class="difflineminus">-  close() {</span>
<a href="#l70.748"></a><span id="l70.748" class="difflineminus">-    if (!this.left) {</span>
<a href="#l70.749"></a><span id="l70.749" class="difflineminus">-      this.part();</span>
<a href="#l70.750"></a><span id="l70.750" class="difflineminus">-    }</span>
<a href="#l70.751"></a><span id="l70.751" class="difflineminus">-    GenericConvChatPrototype.close.call(this);</span>
<a href="#l70.752"></a><span id="l70.752" class="difflineminus">-  },</span>
<a href="#l70.753"></a><span id="l70.753" class="difflineminus">-  unInit() {</span>
<a href="#l70.754"></a><span id="l70.754" class="difflineminus">-    this._account.removeConversation(this.name);</span>
<a href="#l70.755"></a><span id="l70.755" class="difflineminus">-    GenericConvChatPrototype.unInit.call(this);</span>
<a href="#l70.756"></a><span id="l70.756" class="difflineminus">-  },</span>
<a href="#l70.757"></a><span id="l70.757" class="difflineminus">-};</span>
<a href="#l70.758"></a><span id="l70.758" class="difflineminus">-function XMPPMUCConversation(aAccount, aJID, aNick) {</span>
<a href="#l70.759"></a><span id="l70.759" class="difflineminus">-  this._init(aAccount, aJID, aNick);</span>
<a href="#l70.760"></a><span id="l70.760" class="difflineminus">-}</span>
<a href="#l70.761"></a><span id="l70.761" class="difflineminus">-XMPPMUCConversation.prototype = XMPPMUCConversationPrototype;</span>
<a href="#l70.762"></a><span id="l70.762" class="difflineminus">-</span>
<a href="#l70.763"></a><span id="l70.763" class="difflineminus">-/* Helper class for buddy conversations */</span>
<a href="#l70.764"></a><span id="l70.764" class="difflineminus">-var XMPPConversationPrototype = {</span>
<a href="#l70.765"></a><span id="l70.765" class="difflineminus">-  __proto__: GenericConvIMPrototype,</span>
<a href="#l70.766"></a><span id="l70.766" class="difflineminus">-</span>
<a href="#l70.767"></a><span id="l70.767" class="difflineminus">-  _typingTimer: null,</span>
<a href="#l70.768"></a><span id="l70.768" class="difflineminus">-  supportChatStateNotifications: true,</span>
<a href="#l70.769"></a><span id="l70.769" class="difflineminus">-  _typingState: &quot;active&quot;,</span>
<a href="#l70.770"></a><span id="l70.770" class="difflineminus">-</span>
<a href="#l70.771"></a><span id="l70.771" class="difflineminus">-  // Indicates that current conversation is with a MUC participant and the</span>
<a href="#l70.772"></a><span id="l70.772" class="difflineminus">-  // recipient jid (stored in the userName) is of the form room@domain/nick.</span>
<a href="#l70.773"></a><span id="l70.773" class="difflineminus">-  _isMucParticipant: false,</span>
<a href="#l70.774"></a><span id="l70.774" class="difflineminus">-</span>
<a href="#l70.775"></a><span id="l70.775" class="difflineminus">-  get buddy() {</span>
<a href="#l70.776"></a><span id="l70.776" class="difflineminus">-    return this._account._buddies.get(this.name);</span>
<a href="#l70.777"></a><span id="l70.777" class="difflineminus">-  },</span>
<a href="#l70.778"></a><span id="l70.778" class="difflineminus">-  get title() {</span>
<a href="#l70.779"></a><span id="l70.779" class="difflineminus">-    return this.contactDisplayName;</span>
<a href="#l70.780"></a><span id="l70.780" class="difflineminus">-  },</span>
<a href="#l70.781"></a><span id="l70.781" class="difflineminus">-  get contactDisplayName() {</span>
<a href="#l70.782"></a><span id="l70.782" class="difflineminus">-    return this.buddy ? this.buddy.contactDisplayName : this.name;</span>
<a href="#l70.783"></a><span id="l70.783" class="difflineminus">-  },</span>
<a href="#l70.784"></a><span id="l70.784" class="difflineminus">-  get userName() {</span>
<a href="#l70.785"></a><span id="l70.785" class="difflineminus">-    return this.buddy ? this.buddy.userName : this.name;</span>
<a href="#l70.786"></a><span id="l70.786" class="difflineminus">-  },</span>
<a href="#l70.787"></a><span id="l70.787" class="difflineminus">-</span>
<a href="#l70.788"></a><span id="l70.788" class="difflineminus">-  // Returns jid (room@domain/nick) if it is with a MUC participant, and the</span>
<a href="#l70.789"></a><span id="l70.789" class="difflineminus">-  // name of conversation otherwise.</span>
<a href="#l70.790"></a><span id="l70.790" class="difflineminus">-  get normalizedName() {</span>
<a href="#l70.791"></a><span id="l70.791" class="difflineminus">-    if (this._isMucParticipant) {</span>
<a href="#l70.792"></a><span id="l70.792" class="difflineminus">-      return this._account.normalizeFullJid(this.name);</span>
<a href="#l70.793"></a><span id="l70.793" class="difflineminus">-    }</span>
<a href="#l70.794"></a><span id="l70.794" class="difflineminus">-    return this._account.normalize(this.name);</span>
<a href="#l70.795"></a><span id="l70.795" class="difflineplus">+  getAccount(aImAccount) {</span>
<a href="#l70.796"></a><span id="l70.796" class="difflineplus">+    return new XMPPAccount(this, aImAccount);</span>
<a href="#l70.797"></a><span id="l70.797">   },</span>
<a href="#l70.798"></a><span id="l70.798"> </span>
<a href="#l70.799"></a><span id="l70.799" class="difflineminus">-  // Used to avoid showing full jids in typing notifications.</span>
<a href="#l70.800"></a><span id="l70.800" class="difflineminus">-  get shortName() {</span>
<a href="#l70.801"></a><span id="l70.801" class="difflineminus">-    if (this.buddy) {</span>
<a href="#l70.802"></a><span id="l70.802" class="difflineminus">-      return this.buddy.contactDisplayName;</span>
<a href="#l70.803"></a><span id="l70.803" class="difflineminus">-    }</span>
<a href="#l70.804"></a><span id="l70.804" class="difflineminus">-</span>
<a href="#l70.805"></a><span id="l70.805" class="difflineminus">-    let jid = this._account._parseJID(this.name);</span>
<a href="#l70.806"></a><span id="l70.806" class="difflineminus">-    if (!jid) {</span>
<a href="#l70.807"></a><span id="l70.807" class="difflineminus">-      return this.name;</span>
<a href="#l70.808"></a><span id="l70.808" class="difflineminus">-    }</span>
<a href="#l70.809"></a><span id="l70.809" class="difflineminus">-</span>
<a href="#l70.810"></a><span id="l70.810" class="difflineminus">-    // Returns nick of the recipient if conversation is with a participant of</span>
<a href="#l70.811"></a><span id="l70.811" class="difflineminus">-    // a MUC we are in as jid of the recipient is of the form room@domain/nick.</span>
<a href="#l70.812"></a><span id="l70.812" class="difflineminus">-    if (this._isMucParticipant) {</span>
<a href="#l70.813"></a><span id="l70.813" class="difflineminus">-      return jid.resource;</span>
<a href="#l70.814"></a><span id="l70.814" class="difflineminus">-    }</span>
<a href="#l70.815"></a><span id="l70.815" class="difflineminus">-</span>
<a href="#l70.816"></a><span id="l70.816" class="difflineminus">-    return jid.node;</span>
<a href="#l70.817"></a><span id="l70.817" class="difflineminus">-  },</span>
<a href="#l70.818"></a><span id="l70.818" class="difflineminus">-</span>
<a href="#l70.819"></a><span id="l70.819" class="difflineminus">-  get shouldSendTypingNotifications() {</span>
<a href="#l70.820"></a><span id="l70.820" class="difflineminus">-    return (</span>
<a href="#l70.821"></a><span id="l70.821" class="difflineminus">-      this.supportChatStateNotifications &amp;&amp;</span>
<a href="#l70.822"></a><span id="l70.822" class="difflineminus">-      Services.prefs.getBoolPref(&quot;purple.conversations.im.send_typing&quot;)</span>
<a href="#l70.823"></a><span id="l70.823" class="difflineminus">-    );</span>
<a href="#l70.824"></a><span id="l70.824" class="difflineminus">-  },</span>
<a href="#l70.825"></a><span id="l70.825" class="difflineminus">-</span>
<a href="#l70.826"></a><span id="l70.826" class="difflineminus">-  /* Called when the user is typing a message</span>
<a href="#l70.827"></a><span id="l70.827" class="difflineminus">-   * aString - the currently typed message</span>
<a href="#l70.828"></a><span id="l70.828" class="difflineminus">-   * Returns the number of characters that can still be typed */</span>
<a href="#l70.829"></a><span id="l70.829" class="difflineminus">-  sendTyping(aString) {</span>
<a href="#l70.830"></a><span id="l70.830" class="difflineminus">-    if (!this.shouldSendTypingNotifications) {</span>
<a href="#l70.831"></a><span id="l70.831" class="difflineminus">-      return Ci.prplIConversation.NO_TYPING_LIMIT;</span>
<a href="#l70.832"></a><span id="l70.832" class="difflineminus">-    }</span>
<a href="#l70.833"></a><span id="l70.833" class="difflineminus">-</span>
<a href="#l70.834"></a><span id="l70.834" class="difflineminus">-    this._cancelTypingTimer();</span>
<a href="#l70.835"></a><span id="l70.835" class="difflineminus">-    if (aString.length) {</span>
<a href="#l70.836"></a><span id="l70.836" class="difflineminus">-      this._typingTimer = setTimeout(this.finishedComposing.bind(this), 10000);</span>
<a href="#l70.837"></a><span id="l70.837" class="difflineminus">-    }</span>
<a href="#l70.838"></a><span id="l70.838" class="difflineminus">-</span>
<a href="#l70.839"></a><span id="l70.839" class="difflineminus">-    this._setTypingState(aString.length ? &quot;composing&quot; : &quot;active&quot;);</span>
<a href="#l70.840"></a><span id="l70.840" class="difflineminus">-</span>
<a href="#l70.841"></a><span id="l70.841" class="difflineminus">-    return Ci.prplIConversation.NO_TYPING_LIMIT;</span>
<a href="#l70.842"></a><span id="l70.842" class="difflineminus">-  },</span>
<a href="#l70.843"></a><span id="l70.843" class="difflineminus">-</span>
<a href="#l70.844"></a><span id="l70.844" class="difflineminus">-  finishedComposing() {</span>
<a href="#l70.845"></a><span id="l70.845" class="difflineminus">-    if (!this.shouldSendTypingNotifications) {</span>
<a href="#l70.846"></a><span id="l70.846" class="difflineminus">-      return;</span>
<a href="#l70.847"></a><span id="l70.847" class="difflineminus">-    }</span>
<a href="#l70.848"></a><span id="l70.848" class="difflineminus">-</span>
<a href="#l70.849"></a><span id="l70.849" class="difflineminus">-    this._setTypingState(&quot;paused&quot;);</span>
<a href="#l70.850"></a><span id="l70.850" class="difflineminus">-  },</span>
<a href="#l70.851"></a><span id="l70.851" class="difflineminus">-</span>
<a href="#l70.852"></a><span id="l70.852" class="difflineminus">-  _setTypingState(aNewState) {</span>
<a href="#l70.853"></a><span id="l70.853" class="difflineminus">-    if (this._typingState == aNewState) {</span>
<a href="#l70.854"></a><span id="l70.854" class="difflineminus">-      return;</span>
<a href="#l70.855"></a><span id="l70.855" class="difflineminus">-    }</span>
<a href="#l70.856"></a><span id="l70.856" class="difflineminus">-</span>
<a href="#l70.857"></a><span id="l70.857" class="difflineminus">-    let s = Stanza.message(this.to, null, aNewState);</span>
<a href="#l70.858"></a><span id="l70.858" class="difflineminus">-</span>
<a href="#l70.859"></a><span id="l70.859" class="difflineminus">-    // We don't care about errors in response to typing notifications</span>
<a href="#l70.860"></a><span id="l70.860" class="difflineminus">-    // (e.g. because the user has left the room when talking to a MUC</span>
<a href="#l70.861"></a><span id="l70.861" class="difflineminus">-    // participant).</span>
<a href="#l70.862"></a><span id="l70.862" class="difflineminus">-    this._account.sendStanza(s, () =&gt; true);</span>
<a href="#l70.863"></a><span id="l70.863" class="difflineminus">-</span>
<a href="#l70.864"></a><span id="l70.864" class="difflineminus">-    this._typingState = aNewState;</span>
<a href="#l70.865"></a><span id="l70.865" class="difflineminus">-  },</span>
<a href="#l70.866"></a><span id="l70.866" class="difflineminus">-  _cancelTypingTimer() {</span>
<a href="#l70.867"></a><span id="l70.867" class="difflineminus">-    if (this._typingTimer) {</span>
<a href="#l70.868"></a><span id="l70.868" class="difflineminus">-      clearTimeout(this._typingTimer);</span>
<a href="#l70.869"></a><span id="l70.869" class="difflineminus">-      delete this._typingTimer;</span>
<a href="#l70.870"></a><span id="l70.870" class="difflineminus">-    }</span>
<a href="#l70.871"></a><span id="l70.871" class="difflineminus">-  },</span>
<a href="#l70.872"></a><span id="l70.872" class="difflineminus">-</span>
<a href="#l70.873"></a><span id="l70.873" class="difflineminus">-  // Holds the resource of user that you are currently talking to, but if the</span>
<a href="#l70.874"></a><span id="l70.874" class="difflineminus">-  // user is a participant of a MUC we are in, holds the nick of user you are</span>
<a href="#l70.875"></a><span id="l70.875" class="difflineminus">-  // talking to.</span>
<a href="#l70.876"></a><span id="l70.876" class="difflineminus">-  _targetResource: &quot;&quot;,</span>
<a href="#l70.877"></a><span id="l70.877" class="difflineminus">-</span>
<a href="#l70.878"></a><span id="l70.878" class="difflineminus">-  get to() {</span>
<a href="#l70.879"></a><span id="l70.879" class="difflineminus">-    if (!this._targetResource || this._isMucParticipant) {</span>
<a href="#l70.880"></a><span id="l70.880" class="difflineminus">-      return this.userName;</span>
<a href="#l70.881"></a><span id="l70.881" class="difflineminus">-    }</span>
<a href="#l70.882"></a><span id="l70.882" class="difflineminus">-    return this.userName + &quot;/&quot; + this._targetResource;</span>
<a href="#l70.883"></a><span id="l70.883" class="difflineminus">-  },</span>
<a href="#l70.884"></a><span id="l70.884" class="difflineminus">-</span>
<a href="#l70.885"></a><span id="l70.885" class="difflineminus">-  /* Called when the user enters a chat message */</span>
<a href="#l70.886"></a><span id="l70.886" class="difflineminus">-  sendMsg(aMsg) {</span>
<a href="#l70.887"></a><span id="l70.887" class="difflineminus">-    this._cancelTypingTimer();</span>
<a href="#l70.888"></a><span id="l70.888" class="difflineminus">-    let cs = this.shouldSendTypingNotifications ? &quot;active&quot; : null;</span>
<a href="#l70.889"></a><span id="l70.889" class="difflineminus">-    let s = Stanza.message(this.to, aMsg, cs);</span>
<a href="#l70.890"></a><span id="l70.890" class="difflineminus">-    this._account.sendStanza(s);</span>
<a href="#l70.891"></a><span id="l70.891" class="difflineminus">-    _displaySentMsg(this, aMsg);</span>
<a href="#l70.892"></a><span id="l70.892" class="difflineminus">-    delete this._typingState;</span>
<a href="#l70.893"></a><span id="l70.893" class="difflineminus">-  },</span>
<a href="#l70.894"></a><span id="l70.894" class="difflineminus">-</span>
<a href="#l70.895"></a><span id="l70.895" class="difflineminus">-  // Invites the contact to a MUC room.</span>
<a href="#l70.896"></a><span id="l70.896" class="difflineminus">-  invite(aRoomJid, aPassword = null) {</span>
<a href="#l70.897"></a><span id="l70.897" class="difflineminus">-    // XEP-0045 (7.8): Inviting Another User to a Room.</span>
<a href="#l70.898"></a><span id="l70.898" class="difflineminus">-    // XEP-0045 (7.8.1) and XEP-0249: Direct Invitation.</span>
<a href="#l70.899"></a><span id="l70.899" class="difflineminus">-    let x = Stanza.node(&quot;x&quot;, Stanza.NS.conference, {</span>
<a href="#l70.900"></a><span id="l70.900" class="difflineminus">-      jid: aRoomJid,</span>
<a href="#l70.901"></a><span id="l70.901" class="difflineminus">-      password: aPassword,</span>
<a href="#l70.902"></a><span id="l70.902" class="difflineminus">-    });</span>
<a href="#l70.903"></a><span id="l70.903" class="difflineminus">-    this._account.sendStanza(Stanza.node(&quot;message&quot;, null, { to: this.to }, x));</span>
<a href="#l70.904"></a><span id="l70.904" class="difflineminus">-  },</span>
<a href="#l70.905"></a><span id="l70.905" class="difflineminus">-</span>
<a href="#l70.906"></a><span id="l70.906" class="difflineminus">-  // Query the user for its Software Version.</span>
<a href="#l70.907"></a><span id="l70.907" class="difflineminus">-  // XEP-0092: Software Version.</span>
<a href="#l70.908"></a><span id="l70.908" class="difflineminus">-  getVersion() {</span>
<a href="#l70.909"></a><span id="l70.909" class="difflineminus">-    // TODO: Use Service Discovery to determine if the user's client supports</span>
<a href="#l70.910"></a><span id="l70.910" class="difflineminus">-    // jabber:iq:version protocol.</span>
<a href="#l70.911"></a><span id="l70.911" class="difflineminus">-</span>
<a href="#l70.912"></a><span id="l70.912" class="difflineminus">-    let s = Stanza.iq(</span>
<a href="#l70.913"></a><span id="l70.913" class="difflineminus">-      &quot;get&quot;,</span>
<a href="#l70.914"></a><span id="l70.914" class="difflineminus">-      null,</span>
<a href="#l70.915"></a><span id="l70.915" class="difflineminus">-      this.to,</span>
<a href="#l70.916"></a><span id="l70.916" class="difflineminus">-      Stanza.node(&quot;query&quot;, Stanza.NS.version)</span>
<a href="#l70.917"></a><span id="l70.917" class="difflineminus">-    );</span>
<a href="#l70.918"></a><span id="l70.918" class="difflineminus">-    this._account.sendStanza(s, aStanza =&gt; {</span>
<a href="#l70.919"></a><span id="l70.919" class="difflineminus">-      // TODO: handle other errors that can result from querying</span>
<a href="#l70.920"></a><span id="l70.920" class="difflineminus">-      // user for its software version.</span>
<a href="#l70.921"></a><span id="l70.921" class="difflineminus">-      if (</span>
<a href="#l70.922"></a><span id="l70.922" class="difflineminus">-        this._account.handleErrors(</span>
<a href="#l70.923"></a><span id="l70.923" class="difflineminus">-          {</span>
<a href="#l70.924"></a><span id="l70.924" class="difflineminus">-            default: _(&quot;conversation.error.version.unknown&quot;),</span>
<a href="#l70.925"></a><span id="l70.925" class="difflineminus">-          },</span>
<a href="#l70.926"></a><span id="l70.926" class="difflineminus">-          this</span>
<a href="#l70.927"></a><span id="l70.927" class="difflineminus">-        )(aStanza)</span>
<a href="#l70.928"></a><span id="l70.928" class="difflineminus">-      ) {</span>
<a href="#l70.929"></a><span id="l70.929" class="difflineminus">-        return;</span>
<a href="#l70.930"></a><span id="l70.930" class="difflineminus">-      }</span>
<a href="#l70.931"></a><span id="l70.931" class="difflineminus">-</span>
<a href="#l70.932"></a><span id="l70.932" class="difflineminus">-      let query = aStanza.getElement([&quot;query&quot;]);</span>
<a href="#l70.933"></a><span id="l70.933" class="difflineminus">-      if (!query || query.uri != Stanza.NS.version) {</span>
<a href="#l70.934"></a><span id="l70.934" class="difflineminus">-        this.WARN(</span>
<a href="#l70.935"></a><span id="l70.935" class="difflineminus">-          &quot;Received a response to version query which does not &quot; +</span>
<a href="#l70.936"></a><span id="l70.936" class="difflineminus">-            &quot;contain query element or 'jabber:iq:version' namespace.&quot;</span>
<a href="#l70.937"></a><span id="l70.937" class="difflineminus">-        );</span>
<a href="#l70.938"></a><span id="l70.938" class="difflineminus">-        return;</span>
<a href="#l70.939"></a><span id="l70.939" class="difflineminus">-      }</span>
<a href="#l70.940"></a><span id="l70.940" class="difflineminus">-</span>
<a href="#l70.941"></a><span id="l70.941" class="difflineminus">-      let name = query.getElement([&quot;name&quot;]);</span>
<a href="#l70.942"></a><span id="l70.942" class="difflineminus">-      let version = query.getElement([&quot;version&quot;]);</span>
<a href="#l70.943"></a><span id="l70.943" class="difflineminus">-      if (!name || !version) {</span>
<a href="#l70.944"></a><span id="l70.944" class="difflineminus">-        // XEP-0092: name and version elements are REQUIRED.</span>
<a href="#l70.945"></a><span id="l70.945" class="difflineminus">-        this.WARN(</span>
<a href="#l70.946"></a><span id="l70.946" class="difflineminus">-          &quot;Received a response to version query which does not &quot; +</span>
<a href="#l70.947"></a><span id="l70.947" class="difflineminus">-            &quot;contain name or version.&quot;</span>
<a href="#l70.948"></a><span id="l70.948" class="difflineminus">-        );</span>
<a href="#l70.949"></a><span id="l70.949" class="difflineminus">-        return;</span>
<a href="#l70.950"></a><span id="l70.950" class="difflineminus">-      }</span>
<a href="#l70.951"></a><span id="l70.951" class="difflineminus">-</span>
<a href="#l70.952"></a><span id="l70.952" class="difflineminus">-      let messageID = &quot;conversation.message.version&quot;;</span>
<a href="#l70.953"></a><span id="l70.953" class="difflineminus">-      let params = [this.shortName, name.innerText, version.innerText];</span>
<a href="#l70.954"></a><span id="l70.954" class="difflineminus">-</span>
<a href="#l70.955"></a><span id="l70.955" class="difflineminus">-      // XEP-0092: os is OPTIONAL.</span>
<a href="#l70.956"></a><span id="l70.956" class="difflineminus">-      let os = query.getElement([&quot;os&quot;]);</span>
<a href="#l70.957"></a><span id="l70.957" class="difflineminus">-      if (os) {</span>
<a href="#l70.958"></a><span id="l70.958" class="difflineminus">-        params.push(os.innerText);</span>
<a href="#l70.959"></a><span id="l70.959" class="difflineminus">-        messageID += &quot;WithOS&quot;;</span>
<a href="#l70.960"></a><span id="l70.960" class="difflineminus">-      }</span>
<a href="#l70.961"></a><span id="l70.961" class="difflineminus">-</span>
<a href="#l70.962"></a><span id="l70.962" class="difflineminus">-      this.writeMessage(this.name, _(messageID, ...params), { system: true });</span>
<a href="#l70.963"></a><span id="l70.963" class="difflineminus">-    });</span>
<a href="#l70.964"></a><span id="l70.964" class="difflineminus">-  },</span>
<a href="#l70.965"></a><span id="l70.965" class="difflineminus">-</span>
<a href="#l70.966"></a><span id="l70.966" class="difflineminus">-  /* Perform entity escaping before displaying the message. We assume incoming</span>
<a href="#l70.967"></a><span id="l70.967" class="difflineminus">-     messages have already been escaped, and will otherwise be filtered. */</span>
<a href="#l70.968"></a><span id="l70.968" class="difflineminus">-  prepareForDisplaying(aMsg) {</span>
<a href="#l70.969"></a><span id="l70.969" class="difflineminus">-    if (aMsg.outgoing &amp;&amp; !aMsg.system) {</span>
<a href="#l70.970"></a><span id="l70.970" class="difflineminus">-      aMsg.displayMessage = TXTToHTML(aMsg.displayMessage);</span>
<a href="#l70.971"></a><span id="l70.971" class="difflineminus">-    }</span>
<a href="#l70.972"></a><span id="l70.972" class="difflineminus">-    GenericConversationPrototype.prepareForDisplaying.apply(this, arguments);</span>
<a href="#l70.973"></a><span id="l70.973" class="difflineminus">-  },</span>
<a href="#l70.974"></a><span id="l70.974" class="difflineminus">-</span>
<a href="#l70.975"></a><span id="l70.975" class="difflineminus">-  /* Called by the account when a message is received from the buddy */</span>
<a href="#l70.976"></a><span id="l70.976" class="difflineminus">-  incomingMessage(aMsg, aStanza, aDate) {</span>
<a href="#l70.977"></a><span id="l70.977" class="difflineminus">-    let from = aStanza.attributes.from;</span>
<a href="#l70.978"></a><span id="l70.978" class="difflineminus">-    this._targetResource = this._account._parseJID(from).resource;</span>
<a href="#l70.979"></a><span id="l70.979" class="difflineminus">-    let flags = {};</span>
<a href="#l70.980"></a><span id="l70.980" class="difflineminus">-    let error = this._account.parseError(aStanza);</span>
<a href="#l70.981"></a><span id="l70.981" class="difflineminus">-    if (error) {</span>
<a href="#l70.982"></a><span id="l70.982" class="difflineminus">-      let norm = this._account.normalize(from);</span>
<a href="#l70.983"></a><span id="l70.983" class="difflineminus">-      let muc = this._account._mucs.get(norm);</span>
<a href="#l70.984"></a><span id="l70.984" class="difflineminus">-</span>
<a href="#l70.985"></a><span id="l70.985" class="difflineminus">-      if (!aMsg) {</span>
<a href="#l70.986"></a><span id="l70.986" class="difflineminus">-        // Failed outgoing message.</span>
<a href="#l70.987"></a><span id="l70.987" class="difflineminus">-        switch (error.condition) {</span>
<a href="#l70.988"></a><span id="l70.988" class="difflineminus">-          case &quot;remote-server-not-found&quot;:</span>
<a href="#l70.989"></a><span id="l70.989" class="difflineminus">-            aMsg = _(&quot;conversation.error.remoteServerNotFound&quot;);</span>
<a href="#l70.990"></a><span id="l70.990" class="difflineminus">-            break;</span>
<a href="#l70.991"></a><span id="l70.991" class="difflineminus">-          case &quot;service-unavailable&quot;:</span>
<a href="#l70.992"></a><span id="l70.992" class="difflineminus">-            aMsg = _(</span>
<a href="#l70.993"></a><span id="l70.993" class="difflineminus">-              &quot;conversation.error.sendServiceUnavailable&quot;,</span>
<a href="#l70.994"></a><span id="l70.994" class="difflineminus">-              this.shortName</span>
<a href="#l70.995"></a><span id="l70.995" class="difflineminus">-            );</span>
<a href="#l70.996"></a><span id="l70.996" class="difflineminus">-            break;</span>
<a href="#l70.997"></a><span id="l70.997" class="difflineminus">-          default:</span>
<a href="#l70.998"></a><span id="l70.998" class="difflineminus">-            aMsg = _(&quot;conversation.error.unknownSendError&quot;);</span>
<a href="#l70.999"></a><span id="l70.999" class="difflineminus">-            break;</span>
<a href="#l70.1000"></a><span id="l70.1000" class="difflineminus">-        }</span>
<a href="#l70.1001"></a><span id="l70.1001" class="difflineminus">-      } else if (</span>
<a href="#l70.1002"></a><span id="l70.1002" class="difflineminus">-        this._isMucParticipant &amp;&amp;</span>
<a href="#l70.1003"></a><span id="l70.1003" class="difflineminus">-        muc &amp;&amp;</span>
<a href="#l70.1004"></a><span id="l70.1004" class="difflineminus">-        !muc.left &amp;&amp;</span>
<a href="#l70.1005"></a><span id="l70.1005" class="difflineminus">-        error.condition == &quot;item-not-found&quot;</span>
<a href="#l70.1006"></a><span id="l70.1006" class="difflineminus">-      ) {</span>
<a href="#l70.1007"></a><span id="l70.1007" class="difflineminus">-        // XEP-0045 (7.5): MUC private messages.</span>
<a href="#l70.1008"></a><span id="l70.1008" class="difflineminus">-        // If we try to send to participant not in a room we are in.</span>
<a href="#l70.1009"></a><span id="l70.1009" class="difflineminus">-        aMsg = _(</span>
<a href="#l70.1010"></a><span id="l70.1010" class="difflineminus">-          &quot;conversation.error.sendFailedAsRecipientNotInRoom&quot;,</span>
<a href="#l70.1011"></a><span id="l70.1011" class="difflineminus">-          this._targetResource,</span>
<a href="#l70.1012"></a><span id="l70.1012" class="difflineminus">-          aMsg</span>
<a href="#l70.1013"></a><span id="l70.1013" class="difflineminus">-        );</span>
<a href="#l70.1014"></a><span id="l70.1014" class="difflineminus">-      } else if (</span>
<a href="#l70.1015"></a><span id="l70.1015" class="difflineminus">-        this._isMucParticipant &amp;&amp;</span>
<a href="#l70.1016"></a><span id="l70.1016" class="difflineminus">-        (error.condition == &quot;item-not-found&quot; ||</span>
<a href="#l70.1017"></a><span id="l70.1017" class="difflineminus">-          error.condition == &quot;not-acceptable&quot;)</span>
<a href="#l70.1018"></a><span id="l70.1018" class="difflineminus">-      ) {</span>
<a href="#l70.1019"></a><span id="l70.1019" class="difflineminus">-        // If we left a room and try to send to a participant in it or the</span>
<a href="#l70.1020"></a><span id="l70.1020" class="difflineminus">-        // room is removed.</span>
<a href="#l70.1021"></a><span id="l70.1021" class="difflineminus">-        aMsg = _(</span>
<a href="#l70.1022"></a><span id="l70.1022" class="difflineminus">-          &quot;conversation.error.sendFailedAsNotInRoom&quot;,</span>
<a href="#l70.1023"></a><span id="l70.1023" class="difflineminus">-          this._account.normalize(from),</span>
<a href="#l70.1024"></a><span id="l70.1024" class="difflineminus">-          aMsg</span>
<a href="#l70.1025"></a><span id="l70.1025" class="difflineminus">-        );</span>
<a href="#l70.1026"></a><span id="l70.1026" class="difflineminus">-      } else {</span>
<a href="#l70.1027"></a><span id="l70.1027" class="difflineminus">-        aMsg = _(&quot;conversation.error.notDelivered&quot;, aMsg);</span>
<a href="#l70.1028"></a><span id="l70.1028" class="difflineminus">-      }</span>
<a href="#l70.1029"></a><span id="l70.1029" class="difflineminus">-      flags.system = true;</span>
<a href="#l70.1030"></a><span id="l70.1030" class="difflineminus">-      flags.error = true;</span>
<a href="#l70.1031"></a><span id="l70.1031" class="difflineminus">-    } else {</span>
<a href="#l70.1032"></a><span id="l70.1032" class="difflineminus">-      flags = { incoming: true, _alias: this.contactDisplayName };</span>
<a href="#l70.1033"></a><span id="l70.1033" class="difflineminus">-    }</span>
<a href="#l70.1034"></a><span id="l70.1034" class="difflineminus">-    if (aDate) {</span>
<a href="#l70.1035"></a><span id="l70.1035" class="difflineminus">-      flags.time = aDate / 1000;</span>
<a href="#l70.1036"></a><span id="l70.1036" class="difflineminus">-      flags.delayed = true;</span>
<a href="#l70.1037"></a><span id="l70.1037" class="difflineminus">-    }</span>
<a href="#l70.1038"></a><span id="l70.1038" class="difflineminus">-    this.writeMessage(from, aMsg, flags);</span>
<a href="#l70.1039"></a><span id="l70.1039" class="difflineminus">-  },</span>
<a href="#l70.1040"></a><span id="l70.1040" class="difflineminus">-</span>
<a href="#l70.1041"></a><span id="l70.1041" class="difflineminus">-  /* Called when the user closed the conversation */</span>
<a href="#l70.1042"></a><span id="l70.1042" class="difflineminus">-  close() {</span>
<a href="#l70.1043"></a><span id="l70.1043" class="difflineminus">-    // TODO send the stanza indicating we have left the conversation?</span>
<a href="#l70.1044"></a><span id="l70.1044" class="difflineminus">-    GenericConvIMPrototype.close.call(this);</span>
<a href="#l70.1045"></a><span id="l70.1045" class="difflineminus">-  },</span>
<a href="#l70.1046"></a><span id="l70.1046" class="difflineminus">-  unInit() {</span>
<a href="#l70.1047"></a><span id="l70.1047" class="difflineminus">-    this._account.removeConversation(this.normalizedName);</span>
<a href="#l70.1048"></a><span id="l70.1048" class="difflineminus">-    GenericConvIMPrototype.unInit.call(this);</span>
<a href="#l70.1049"></a><span id="l70.1049" class="difflineminus">-  },</span>
<a href="#l70.1050"></a><span id="l70.1050" class="difflineminus">-};</span>
<a href="#l70.1051"></a><span id="l70.1051" class="difflineminus">-</span>
<a href="#l70.1052"></a><span id="l70.1052" class="difflineminus">-// Creates XMPP conversation.</span>
<a href="#l70.1053"></a><span id="l70.1053" class="difflineminus">-function XMPPConversation(aAccount, aNormalizedName, aMucParticipant) {</span>
<a href="#l70.1054"></a><span id="l70.1054" class="difflineminus">-  this._init(aAccount, aNormalizedName);</span>
<a href="#l70.1055"></a><span id="l70.1055" class="difflineminus">-  if (aMucParticipant) {</span>
<a href="#l70.1056"></a><span id="l70.1056" class="difflineminus">-    this._isMucParticipant = true;</span>
<a href="#l70.1057"></a><span id="l70.1057" class="difflineminus">-  }</span>
<a href="#l70.1058"></a><span id="l70.1058" class="difflineminus">-}</span>
<a href="#l70.1059"></a><span id="l70.1059" class="difflineminus">-XMPPConversation.prototype = XMPPConversationPrototype;</span>
<a href="#l70.1060"></a><span id="l70.1060" class="difflineminus">-</span>
<a href="#l70.1061"></a><span id="l70.1061" class="difflineminus">-/* Helper class for buddies */</span>
<a href="#l70.1062"></a><span id="l70.1062" class="difflineminus">-var XMPPAccountBuddyPrototype = {</span>
<a href="#l70.1063"></a><span id="l70.1063" class="difflineminus">-  __proto__: GenericAccountBuddyPrototype,</span>
<a href="#l70.1064"></a><span id="l70.1064" class="difflineminus">-</span>
<a href="#l70.1065"></a><span id="l70.1065" class="difflineminus">-  subscription: &quot;none&quot;,</span>
<a href="#l70.1066"></a><span id="l70.1066" class="difflineminus">-  // Returns a list of TooltipInfo objects to be displayed when the user</span>
<a href="#l70.1067"></a><span id="l70.1067" class="difflineminus">-  // hovers over the buddy.</span>
<a href="#l70.1068"></a><span id="l70.1068" class="difflineminus">-  getTooltipInfo() {</span>
<a href="#l70.1069"></a><span id="l70.1069" class="difflineminus">-    if (!this._account.connected) {</span>
<a href="#l70.1070"></a><span id="l70.1070" class="difflineminus">-      return null;</span>
<a href="#l70.1071"></a><span id="l70.1071" class="difflineminus">-    }</span>
<a href="#l70.1072"></a><span id="l70.1072" class="difflineminus">-</span>
<a href="#l70.1073"></a><span id="l70.1073" class="difflineminus">-    let tooltipInfo = [];</span>
<a href="#l70.1074"></a><span id="l70.1074" class="difflineminus">-    if (this._resources) {</span>
<a href="#l70.1075"></a><span id="l70.1075" class="difflineminus">-      for (let r in this._resources) {</span>
<a href="#l70.1076"></a><span id="l70.1076" class="difflineminus">-        let status = this._resources[r];</span>
<a href="#l70.1077"></a><span id="l70.1077" class="difflineminus">-        let statusString = Status.toLabel(status.statusType);</span>
<a href="#l70.1078"></a><span id="l70.1078" class="difflineminus">-        if (</span>
<a href="#l70.1079"></a><span id="l70.1079" class="difflineminus">-          status.statusType == Ci.imIStatusInfo.STATUS_IDLE &amp;&amp;</span>
<a href="#l70.1080"></a><span id="l70.1080" class="difflineminus">-          status.idleSince</span>
<a href="#l70.1081"></a><span id="l70.1081" class="difflineminus">-        ) {</span>
<a href="#l70.1082"></a><span id="l70.1082" class="difflineminus">-          let now = Math.floor(Date.now() / 1000);</span>
<a href="#l70.1083"></a><span id="l70.1083" class="difflineminus">-          let valuesAndUnits = DownloadUtils.convertTimeUnits(</span>
<a href="#l70.1084"></a><span id="l70.1084" class="difflineminus">-            now - status.idleSince</span>
<a href="#l70.1085"></a><span id="l70.1085" class="difflineminus">-          );</span>
<a href="#l70.1086"></a><span id="l70.1086" class="difflineminus">-          if (!valuesAndUnits[2]) {</span>
<a href="#l70.1087"></a><span id="l70.1087" class="difflineminus">-            valuesAndUnits.splice(2, 2);</span>
<a href="#l70.1088"></a><span id="l70.1088" class="difflineminus">-          }</span>
<a href="#l70.1089"></a><span id="l70.1089" class="difflineminus">-          statusString += &quot; (&quot; + valuesAndUnits.join(&quot; &quot;) + &quot;)&quot;;</span>
<a href="#l70.1090"></a><span id="l70.1090" class="difflineminus">-        }</span>
<a href="#l70.1091"></a><span id="l70.1091" class="difflineminus">-        if (status.statusText) {</span>
<a href="#l70.1092"></a><span id="l70.1092" class="difflineminus">-          statusString += &quot; - &quot; + status.statusText;</span>
<a href="#l70.1093"></a><span id="l70.1093" class="difflineminus">-        }</span>
<a href="#l70.1094"></a><span id="l70.1094" class="difflineminus">-        let label = r ? _(&quot;tooltip.status&quot;, r) : _(&quot;tooltip.statusNoResource&quot;);</span>
<a href="#l70.1095"></a><span id="l70.1095" class="difflineminus">-        tooltipInfo.push(new TooltipInfo(label, statusString));</span>
<a href="#l70.1096"></a><span id="l70.1096" class="difflineminus">-      }</span>
<a href="#l70.1097"></a><span id="l70.1097" class="difflineminus">-    }</span>
<a href="#l70.1098"></a><span id="l70.1098" class="difflineminus">-</span>
<a href="#l70.1099"></a><span id="l70.1099" class="difflineminus">-    // The subscription value is interesting to display only in unusual cases.</span>
<a href="#l70.1100"></a><span id="l70.1100" class="difflineminus">-    if (this.subscription != &quot;both&quot;) {</span>
<a href="#l70.1101"></a><span id="l70.1101" class="difflineminus">-      tooltipInfo.push(</span>
<a href="#l70.1102"></a><span id="l70.1102" class="difflineminus">-        new TooltipInfo(_(&quot;tooltip.subscription&quot;), this.subscription)</span>
<a href="#l70.1103"></a><span id="l70.1103" class="difflineminus">-      );</span>
<a href="#l70.1104"></a><span id="l70.1104" class="difflineminus">-    }</span>
<a href="#l70.1105"></a><span id="l70.1105" class="difflineminus">-</span>
<a href="#l70.1106"></a><span id="l70.1106" class="difflineminus">-    return new nsSimpleEnumerator(tooltipInfo);</span>
<a href="#l70.1107"></a><span id="l70.1107" class="difflineminus">-  },</span>
<a href="#l70.1108"></a><span id="l70.1108" class="difflineminus">-</span>
<a href="#l70.1109"></a><span id="l70.1109" class="difflineminus">-  // _rosterAlias is the value stored in the roster on the XMPP</span>
<a href="#l70.1110"></a><span id="l70.1110" class="difflineminus">-  // server. For most servers we will be read/write.</span>
<a href="#l70.1111"></a><span id="l70.1111" class="difflineminus">-  _rosterAlias: &quot;&quot;,</span>
<a href="#l70.1112"></a><span id="l70.1112" class="difflineminus">-  set rosterAlias(aNewAlias) {</span>
<a href="#l70.1113"></a><span id="l70.1113" class="difflineminus">-    let old = this.displayName;</span>
<a href="#l70.1114"></a><span id="l70.1114" class="difflineminus">-    this._rosterAlias = aNewAlias;</span>
<a href="#l70.1115"></a><span id="l70.1115" class="difflineminus">-    if (old != this.displayName) {</span>
<a href="#l70.1116"></a><span id="l70.1116" class="difflineminus">-      this._notifyObservers(&quot;display-name-changed&quot;, old);</span>
<a href="#l70.1117"></a><span id="l70.1117" class="difflineminus">-    }</span>
<a href="#l70.1118"></a><span id="l70.1118" class="difflineminus">-  },</span>
<a href="#l70.1119"></a><span id="l70.1119" class="difflineminus">-  _vCardReceived: false,</span>
<a href="#l70.1120"></a><span id="l70.1120" class="difflineminus">-  // _vCardFormattedName is the display name the contact has set for</span>
<a href="#l70.1121"></a><span id="l70.1121" class="difflineminus">-  // himself in his vCard. It's read-only from our point of view.</span>
<a href="#l70.1122"></a><span id="l70.1122" class="difflineminus">-  _vCardFormattedName: &quot;&quot;,</span>
<a href="#l70.1123"></a><span id="l70.1123" class="difflineminus">-  set vCardFormattedName(aNewFormattedName) {</span>
<a href="#l70.1124"></a><span id="l70.1124" class="difflineminus">-    let old = this.displayName;</span>
<a href="#l70.1125"></a><span id="l70.1125" class="difflineminus">-    this._vCardFormattedName = aNewFormattedName;</span>
<a href="#l70.1126"></a><span id="l70.1126" class="difflineminus">-    if (old != this.displayName) {</span>
<a href="#l70.1127"></a><span id="l70.1127" class="difflineminus">-      this._notifyObservers(&quot;display-name-changed&quot;, old);</span>
<a href="#l70.1128"></a><span id="l70.1128" class="difflineminus">-    }</span>
<a href="#l70.1129"></a><span id="l70.1129" class="difflineminus">-  },</span>
<a href="#l70.1130"></a><span id="l70.1130" class="difflineminus">-</span>
<a href="#l70.1131"></a><span id="l70.1131" class="difflineminus">-  // _serverAlias is set by jsProtoHelper to the value we cached in sqlite.</span>
<a href="#l70.1132"></a><span id="l70.1132" class="difflineminus">-  // Use it only if we have neither of the other two values; usually because</span>
<a href="#l70.1133"></a><span id="l70.1133" class="difflineminus">-  // we haven't connected to the server yet.</span>
<a href="#l70.1134"></a><span id="l70.1134" class="difflineminus">-  get serverAlias() {</span>
<a href="#l70.1135"></a><span id="l70.1135" class="difflineminus">-    return this._rosterAlias || this._vCardFormattedName || this._serverAlias;</span>
<a href="#l70.1136"></a><span id="l70.1136" class="difflineminus">-  },</span>
<a href="#l70.1137"></a><span id="l70.1137" class="difflineminus">-  set serverAlias(aNewAlias) {</span>
<a href="#l70.1138"></a><span id="l70.1138" class="difflineminus">-    if (!this._rosterItem) {</span>
<a href="#l70.1139"></a><span id="l70.1139" class="difflineminus">-      this.ERROR(</span>
<a href="#l70.1140"></a><span id="l70.1140" class="difflineminus">-        &quot;attempting to update the server alias of an account buddy &quot; +</span>
<a href="#l70.1141"></a><span id="l70.1141" class="difflineminus">-          &quot;for which we haven't received a roster item.&quot;</span>
<a href="#l70.1142"></a><span id="l70.1142" class="difflineminus">-      );</span>
<a href="#l70.1143"></a><span id="l70.1143" class="difflineminus">-      return;</span>
<a href="#l70.1144"></a><span id="l70.1144" class="difflineminus">-    }</span>
<a href="#l70.1145"></a><span id="l70.1145" class="difflineminus">-</span>
<a href="#l70.1146"></a><span id="l70.1146" class="difflineminus">-    let item = this._rosterItem;</span>
<a href="#l70.1147"></a><span id="l70.1147" class="difflineminus">-    if (aNewAlias) {</span>
<a href="#l70.1148"></a><span id="l70.1148" class="difflineminus">-      item.attributes.name = aNewAlias;</span>
<a href="#l70.1149"></a><span id="l70.1149" class="difflineminus">-    } else if (&quot;name&quot; in item.attributes) {</span>
<a href="#l70.1150"></a><span id="l70.1150" class="difflineminus">-      delete item.attributes.name;</span>
<a href="#l70.1151"></a><span id="l70.1151" class="difflineminus">-    }</span>
<a href="#l70.1152"></a><span id="l70.1152" class="difflineplus">+  usernameSplits: [</span>
<a href="#l70.1153"></a><span id="l70.1153" class="difflineplus">+    {</span>
<a href="#l70.1154"></a><span id="l70.1154" class="difflineplus">+      get label() {</span>
<a href="#l70.1155"></a><span id="l70.1155" class="difflineplus">+        return _(&quot;options.domain&quot;);</span>
<a href="#l70.1156"></a><span id="l70.1156" class="difflineplus">+      },</span>
<a href="#l70.1157"></a><span id="l70.1157" class="difflineplus">+      separator: &quot;@&quot;,</span>
<a href="#l70.1158"></a><span id="l70.1158" class="difflineplus">+      defaultValue: &quot;jabber.org&quot;,</span>
<a href="#l70.1159"></a><span id="l70.1159" class="difflineplus">+      reverse: true,</span>
<a href="#l70.1160"></a><span id="l70.1160" class="difflineplus">+    },</span>
<a href="#l70.1161"></a><span id="l70.1161" class="difflineplus">+  ],</span>
<a href="#l70.1162"></a><span id="l70.1162"> </span>
<a href="#l70.1163"></a><span id="l70.1163" class="difflineminus">-    let s = Stanza.iq(</span>
<a href="#l70.1164"></a><span id="l70.1164" class="difflineminus">-      &quot;set&quot;,</span>
<a href="#l70.1165"></a><span id="l70.1165" class="difflineminus">-      null,</span>
<a href="#l70.1166"></a><span id="l70.1166" class="difflineminus">-      null,</span>
<a href="#l70.1167"></a><span id="l70.1167" class="difflineminus">-      Stanza.node(&quot;query&quot;, Stanza.NS.roster, null, item)</span>
<a href="#l70.1168"></a><span id="l70.1168" class="difflineminus">-    );</span>
<a href="#l70.1169"></a><span id="l70.1169" class="difflineminus">-    this._account.sendStanza(s);</span>
<a href="#l70.1170"></a><span id="l70.1170" class="difflineminus">-</span>
<a href="#l70.1171"></a><span id="l70.1171" class="difflineminus">-    // If we are going to change the alias on the server, discard the cached</span>
<a href="#l70.1172"></a><span id="l70.1172" class="difflineminus">-    // value that we got from our local sqlite storage at startup.</span>
<a href="#l70.1173"></a><span id="l70.1173" class="difflineminus">-    delete this._serverAlias;</span>
<a href="#l70.1174"></a><span id="l70.1174" class="difflineminus">-  },</span>
<a href="#l70.1175"></a><span id="l70.1175" class="difflineminus">-</span>
<a href="#l70.1176"></a><span id="l70.1176" class="difflineminus">-  /* Display name of the buddy */</span>
<a href="#l70.1177"></a><span id="l70.1177" class="difflineminus">-  get contactDisplayName() {</span>
<a href="#l70.1178"></a><span id="l70.1178" class="difflineminus">-    return this.buddy.contact.displayName || this.displayName;</span>
<a href="#l70.1179"></a><span id="l70.1179" class="difflineminus">-  },</span>
<a href="#l70.1180"></a><span id="l70.1180" class="difflineminus">-</span>
<a href="#l70.1181"></a><span id="l70.1181" class="difflineminus">-  get tag() {</span>
<a href="#l70.1182"></a><span id="l70.1182" class="difflineminus">-    return this._tag;</span>
<a href="#l70.1183"></a><span id="l70.1183" class="difflineminus">-  },</span>
<a href="#l70.1184"></a><span id="l70.1184" class="difflineminus">-  set tag(aNewTag) {</span>
<a href="#l70.1185"></a><span id="l70.1185" class="difflineminus">-    let oldTag = this._tag;</span>
<a href="#l70.1186"></a><span id="l70.1186" class="difflineminus">-    if (oldTag.name == aNewTag.name) {</span>
<a href="#l70.1187"></a><span id="l70.1187" class="difflineminus">-      this.ERROR(&quot;attempting to set the tag to the same value&quot;);</span>
<a href="#l70.1188"></a><span id="l70.1188" class="difflineminus">-      return;</span>
<a href="#l70.1189"></a><span id="l70.1189" class="difflineminus">-    }</span>
<a href="#l70.1190"></a><span id="l70.1190" class="difflineminus">-</span>
<a href="#l70.1191"></a><span id="l70.1191" class="difflineminus">-    this._tag = aNewTag;</span>
<a href="#l70.1192"></a><span id="l70.1192" class="difflineminus">-    Services.contacts.accountBuddyMoved(this, oldTag, aNewTag);</span>
<a href="#l70.1193"></a><span id="l70.1193" class="difflineminus">-</span>
<a href="#l70.1194"></a><span id="l70.1194" class="difflineminus">-    if (!this._rosterItem) {</span>
<a href="#l70.1195"></a><span id="l70.1195" class="difflineminus">-      this.ERROR(</span>
<a href="#l70.1196"></a><span id="l70.1196" class="difflineminus">-        &quot;attempting to change the tag of an account buddy without roster item&quot;</span>
<a href="#l70.1197"></a><span id="l70.1197" class="difflineminus">-      );</span>
<a href="#l70.1198"></a><span id="l70.1198" class="difflineminus">-      return;</span>
<a href="#l70.1199"></a><span id="l70.1199" class="difflineminus">-    }</span>
<a href="#l70.1200"></a><span id="l70.1200" class="difflineminus">-</span>
<a href="#l70.1201"></a><span id="l70.1201" class="difflineminus">-    let item = this._rosterItem;</span>
<a href="#l70.1202"></a><span id="l70.1202" class="difflineminus">-    let oldXML = item.getXML();</span>
<a href="#l70.1203"></a><span id="l70.1203" class="difflineminus">-    // Remove the old tag if it was listed in the roster item.</span>
<a href="#l70.1204"></a><span id="l70.1204" class="difflineminus">-    item.children = item.children.filter(</span>
<a href="#l70.1205"></a><span id="l70.1205" class="difflineminus">-      c =&gt; c.qName != &quot;group&quot; || c.innerText != oldTag.name</span>
<a href="#l70.1206"></a><span id="l70.1206" class="difflineminus">-    );</span>
<a href="#l70.1207"></a><span id="l70.1207" class="difflineminus">-    // Ensure the new tag is listed.</span>
<a href="#l70.1208"></a><span id="l70.1208" class="difflineminus">-    let newTagName = aNewTag.name;</span>
<a href="#l70.1209"></a><span id="l70.1209" class="difflineminus">-    if (!item.getChildren(&quot;group&quot;).some(g =&gt; g.innerText == newTagName)) {</span>
<a href="#l70.1210"></a><span id="l70.1210" class="difflineminus">-      item.addChild(Stanza.node(&quot;group&quot;, null, null, newTagName));</span>
<a href="#l70.1211"></a><span id="l70.1211" class="difflineminus">-    }</span>
<a href="#l70.1212"></a><span id="l70.1212" class="difflineminus">-    // Avoid sending anything to the server if the roster item hasn't changed.</span>
<a href="#l70.1213"></a><span id="l70.1213" class="difflineminus">-    // It's possible that the roster item hasn't changed if the roster</span>
<a href="#l70.1214"></a><span id="l70.1214" class="difflineminus">-    // item had several groups and the user moved locally the contact</span>
<a href="#l70.1215"></a><span id="l70.1215" class="difflineminus">-    // to another group where it already was on the server.</span>
<a href="#l70.1216"></a><span id="l70.1216" class="difflineminus">-    if (item.getXML() == oldXML) {</span>
<a href="#l70.1217"></a><span id="l70.1217" class="difflineminus">-      return;</span>
<a href="#l70.1218"></a><span id="l70.1218" class="difflineminus">-    }</span>
<a href="#l70.1219"></a><span id="l70.1219" class="difflineminus">-</span>
<a href="#l70.1220"></a><span id="l70.1220" class="difflineminus">-    let s = Stanza.iq(</span>
<a href="#l70.1221"></a><span id="l70.1221" class="difflineminus">-      &quot;set&quot;,</span>
<a href="#l70.1222"></a><span id="l70.1222" class="difflineminus">-      null,</span>
<a href="#l70.1223"></a><span id="l70.1223" class="difflineminus">-      null,</span>
<a href="#l70.1224"></a><span id="l70.1224" class="difflineminus">-      Stanza.node(&quot;query&quot;, Stanza.NS.roster, null, item)</span>
<a href="#l70.1225"></a><span id="l70.1225" class="difflineminus">-    );</span>
<a href="#l70.1226"></a><span id="l70.1226" class="difflineminus">-    this._account.sendStanza(s);</span>
<a href="#l70.1227"></a><span id="l70.1227" class="difflineminus">-  },</span>
<a href="#l70.1228"></a><span id="l70.1228" class="difflineminus">-</span>
<a href="#l70.1229"></a><span id="l70.1229" class="difflineminus">-  remove() {</span>
<a href="#l70.1230"></a><span id="l70.1230" class="difflineminus">-    if (!this._account.connected) {</span>
<a href="#l70.1231"></a><span id="l70.1231" class="difflineminus">-      return;</span>
<a href="#l70.1232"></a><span id="l70.1232" class="difflineminus">-    }</span>
<a href="#l70.1233"></a><span id="l70.1233" class="difflineminus">-</span>
<a href="#l70.1234"></a><span id="l70.1234" class="difflineminus">-    let s = Stanza.iq(</span>
<a href="#l70.1235"></a><span id="l70.1235" class="difflineminus">-      &quot;set&quot;,</span>
<a href="#l70.1236"></a><span id="l70.1236" class="difflineminus">-      null,</span>
<a href="#l70.1237"></a><span id="l70.1237" class="difflineminus">-      null,</span>
<a href="#l70.1238"></a><span id="l70.1238" class="difflineminus">-      Stanza.node(</span>
<a href="#l70.1239"></a><span id="l70.1239" class="difflineminus">-        &quot;query&quot;,</span>
<a href="#l70.1240"></a><span id="l70.1240" class="difflineminus">-        Stanza.NS.roster,</span>
<a href="#l70.1241"></a><span id="l70.1241" class="difflineminus">-        null,</span>
<a href="#l70.1242"></a><span id="l70.1242" class="difflineminus">-        Stanza.node(&quot;item&quot;, null, {</span>
<a href="#l70.1243"></a><span id="l70.1243" class="difflineminus">-          jid: this.normalizedName,</span>
<a href="#l70.1244"></a><span id="l70.1244" class="difflineminus">-          subscription: &quot;remove&quot;,</span>
<a href="#l70.1245"></a><span id="l70.1245" class="difflineminus">-        })</span>
<a href="#l70.1246"></a><span id="l70.1246" class="difflineminus">-      )</span>
<a href="#l70.1247"></a><span id="l70.1247" class="difflineminus">-    );</span>
<a href="#l70.1248"></a><span id="l70.1248" class="difflineminus">-    this._account.sendStanza(s);</span>
<a href="#l70.1249"></a><span id="l70.1249" class="difflineminus">-  },</span>
<a href="#l70.1250"></a><span id="l70.1250" class="difflineminus">-</span>
<a href="#l70.1251"></a><span id="l70.1251" class="difflineminus">-  _photoHash: null,</span>
<a href="#l70.1252"></a><span id="l70.1252" class="difflineminus">-  _saveIcon(aPhotoNode) {</span>
<a href="#l70.1253"></a><span id="l70.1253" class="difflineminus">-    // Some servers seem to send a photo node without a type declared.</span>
<a href="#l70.1254"></a><span id="l70.1254" class="difflineminus">-    let type = aPhotoNode.getElement([&quot;TYPE&quot;]);</span>
<a href="#l70.1255"></a><span id="l70.1255" class="difflineminus">-    if (!type) {</span>
<a href="#l70.1256"></a><span id="l70.1256" class="difflineminus">-      return;</span>
<a href="#l70.1257"></a><span id="l70.1257" class="difflineminus">-    }</span>
<a href="#l70.1258"></a><span id="l70.1258" class="difflineminus">-    type = type.innerText;</span>
<a href="#l70.1259"></a><span id="l70.1259" class="difflineminus">-    const kExt = {</span>
<a href="#l70.1260"></a><span id="l70.1260" class="difflineminus">-      &quot;image/gif&quot;: &quot;gif&quot;,</span>
<a href="#l70.1261"></a><span id="l70.1261" class="difflineminus">-      &quot;image/jpeg&quot;: &quot;jpg&quot;,</span>
<a href="#l70.1262"></a><span id="l70.1262" class="difflineminus">-      &quot;image/png&quot;: &quot;png&quot;,</span>
<a href="#l70.1263"></a><span id="l70.1263" class="difflineminus">-    };</span>
<a href="#l70.1264"></a><span id="l70.1264" class="difflineminus">-    if (!kExt.hasOwnProperty(type)) {</span>
<a href="#l70.1265"></a><span id="l70.1265" class="difflineminus">-      return;</span>
<a href="#l70.1266"></a><span id="l70.1266" class="difflineminus">-    }</span>
<a href="#l70.1267"></a><span id="l70.1267" class="difflineminus">-</span>
<a href="#l70.1268"></a><span id="l70.1268" class="difflineminus">-    let content = &quot;&quot;,</span>
<a href="#l70.1269"></a><span id="l70.1269" class="difflineminus">-      data = &quot;&quot;;</span>
<a href="#l70.1270"></a><span id="l70.1270" class="difflineminus">-    // Strip all characters not allowed in base64 before parsing.</span>
<a href="#l70.1271"></a><span id="l70.1271" class="difflineminus">-    let parseBase64 = aBase =&gt; atob(aBase.replace(/[^A-Za-z0-9\+\/\=]/g, &quot;&quot;));</span>
<a href="#l70.1272"></a><span id="l70.1272" class="difflineminus">-    for (let line of aPhotoNode.getElement([&quot;BINVAL&quot;]).innerText.split(&quot;\n&quot;)) {</span>
<a href="#l70.1273"></a><span id="l70.1273" class="difflineminus">-      data += line;</span>
<a href="#l70.1274"></a><span id="l70.1274" class="difflineminus">-      // Mozilla's atob() doesn't handle padding with &quot;=&quot; or &quot;==&quot;</span>
<a href="#l70.1275"></a><span id="l70.1275" class="difflineminus">-      // unless it's at the end of the string, so we have to work around that.</span>
<a href="#l70.1276"></a><span id="l70.1276" class="difflineminus">-      if (line.endsWith(&quot;=&quot;)) {</span>
<a href="#l70.1277"></a><span id="l70.1277" class="difflineminus">-        content += parseBase64(data);</span>
<a href="#l70.1278"></a><span id="l70.1278" class="difflineminus">-        data = &quot;&quot;;</span>
<a href="#l70.1279"></a><span id="l70.1279" class="difflineminus">-      }</span>
<a href="#l70.1280"></a><span id="l70.1280" class="difflineminus">-    }</span>
<a href="#l70.1281"></a><span id="l70.1281" class="difflineminus">-    content += parseBase64(data);</span>
<a href="#l70.1282"></a><span id="l70.1282" class="difflineminus">-</span>
<a href="#l70.1283"></a><span id="l70.1283" class="difflineminus">-    // Store a sha1 hash of the photo we have just received.</span>
<a href="#l70.1284"></a><span id="l70.1284" class="difflineminus">-    let ch = Cc[&quot;@mozilla.org/security/hash;1&quot;].createInstance(</span>
<a href="#l70.1285"></a><span id="l70.1285" class="difflineminus">-      Ci.nsICryptoHash</span>
<a href="#l70.1286"></a><span id="l70.1286" class="difflineminus">-    );</span>
<a href="#l70.1287"></a><span id="l70.1287" class="difflineminus">-    ch.init(ch.SHA1);</span>
<a href="#l70.1288"></a><span id="l70.1288" class="difflineminus">-    let dataArray = Object.keys(content).map(i =&gt; content.charCodeAt(i));</span>
<a href="#l70.1289"></a><span id="l70.1289" class="difflineminus">-    ch.update(dataArray, dataArray.length);</span>
<a href="#l70.1290"></a><span id="l70.1290" class="difflineminus">-    let hash = ch.finish(false);</span>
<a href="#l70.1291"></a><span id="l70.1291" class="difflineminus">-    function toHexString(charCode) {</span>
<a href="#l70.1292"></a><span id="l70.1292" class="difflineminus">-      return (&quot;0&quot; + charCode.toString(16)).slice(-2);</span>
<a href="#l70.1293"></a><span id="l70.1293" class="difflineminus">-    }</span>
<a href="#l70.1294"></a><span id="l70.1294" class="difflineminus">-    this._photoHash = Object.keys(hash)</span>
<a href="#l70.1295"></a><span id="l70.1295" class="difflineminus">-      .map(i =&gt; toHexString(hash.charCodeAt(i)))</span>
<a href="#l70.1296"></a><span id="l70.1296" class="difflineminus">-      .join(&quot;&quot;);</span>
<a href="#l70.1297"></a><span id="l70.1297" class="difflineminus">-</span>
<a href="#l70.1298"></a><span id="l70.1298" class="difflineminus">-    let istream = Cc[&quot;@mozilla.org/io/string-input-stream;1&quot;].createInstance(</span>
<a href="#l70.1299"></a><span id="l70.1299" class="difflineminus">-      Ci.nsIStringInputStream</span>
<a href="#l70.1300"></a><span id="l70.1300" class="difflineminus">-    );</span>
<a href="#l70.1301"></a><span id="l70.1301" class="difflineminus">-    istream.setData(content, content.length);</span>
<a href="#l70.1302"></a><span id="l70.1302" class="difflineminus">-</span>
<a href="#l70.1303"></a><span id="l70.1303" class="difflineminus">-    let fileName = this._photoHash + &quot;.&quot; + kExt[type];</span>
<a href="#l70.1304"></a><span id="l70.1304" class="difflineminus">-    let file = FileUtils.getFile(&quot;ProfD&quot;, [</span>
<a href="#l70.1305"></a><span id="l70.1305" class="difflineminus">-      &quot;icons&quot;,</span>
<a href="#l70.1306"></a><span id="l70.1306" class="difflineminus">-      this.account.protocol.normalizedName,</span>
<a href="#l70.1307"></a><span id="l70.1307" class="difflineminus">-      this.account.normalizedName,</span>
<a href="#l70.1308"></a><span id="l70.1308" class="difflineminus">-      fileName,</span>
<a href="#l70.1309"></a><span id="l70.1309" class="difflineminus">-    ]);</span>
<a href="#l70.1310"></a><span id="l70.1310" class="difflineminus">-    let ostream = FileUtils.openSafeFileOutputStream(file);</span>
<a href="#l70.1311"></a><span id="l70.1311" class="difflineminus">-    let buddy = this;</span>
<a href="#l70.1312"></a><span id="l70.1312" class="difflineminus">-    NetUtil.asyncCopy(istream, ostream, function(rc) {</span>
<a href="#l70.1313"></a><span id="l70.1313" class="difflineminus">-      if (Components.isSuccessCode(rc)) {</span>
<a href="#l70.1314"></a><span id="l70.1314" class="difflineminus">-        buddy.buddyIconFilename = Services.io.newFileURI(file).spec;</span>
<a href="#l70.1315"></a><span id="l70.1315" class="difflineminus">-      }</span>
<a href="#l70.1316"></a><span id="l70.1316" class="difflineminus">-    });</span>
<a href="#l70.1317"></a><span id="l70.1317" class="difflineminus">-  },</span>
<a href="#l70.1318"></a><span id="l70.1318" class="difflineminus">-</span>
<a href="#l70.1319"></a><span id="l70.1319" class="difflineminus">-  _preferredResource: undefined,</span>
<a href="#l70.1320"></a><span id="l70.1320" class="difflineminus">-  _resources: null,</span>
<a href="#l70.1321"></a><span id="l70.1321" class="difflineminus">-  onAccountDisconnected() {</span>
<a href="#l70.1322"></a><span id="l70.1322" class="difflineminus">-    delete this._preferredResource;</span>
<a href="#l70.1323"></a><span id="l70.1323" class="difflineminus">-    delete this._resources;</span>
<a href="#l70.1324"></a><span id="l70.1324" class="difflineminus">-  },</span>
<a href="#l70.1325"></a><span id="l70.1325" class="difflineminus">-  // Called by the account when a presence stanza is received for this buddy.</span>
<a href="#l70.1326"></a><span id="l70.1326" class="difflineminus">-  onPresenceStanza(aStanza) {</span>
<a href="#l70.1327"></a><span id="l70.1327" class="difflineminus">-    let preferred = this._preferredResource;</span>
<a href="#l70.1328"></a><span id="l70.1328" class="difflineminus">-</span>
<a href="#l70.1329"></a><span id="l70.1329" class="difflineminus">-    // Facebook chat's XMPP server doesn't send resources, let's</span>
<a href="#l70.1330"></a><span id="l70.1330" class="difflineminus">-    // replace undefined resources with empty resources.</span>
<a href="#l70.1331"></a><span id="l70.1331" class="difflineminus">-    let resource =</span>
<a href="#l70.1332"></a><span id="l70.1332" class="difflineminus">-      this._account._parseJID(aStanza.attributes.from).resource || &quot;&quot;;</span>
<a href="#l70.1333"></a><span id="l70.1333" class="difflineminus">-</span>
<a href="#l70.1334"></a><span id="l70.1334" class="difflineminus">-    let type = aStanza.attributes.type;</span>
<a href="#l70.1335"></a><span id="l70.1335" class="difflineminus">-</span>
<a href="#l70.1336"></a><span id="l70.1336" class="difflineminus">-    // Reset typing status if the buddy is in a conversation and becomes unavailable.</span>
<a href="#l70.1337"></a><span id="l70.1337" class="difflineminus">-    let conv = this._account._conv.get(this.normalizedName);</span>
<a href="#l70.1338"></a><span id="l70.1338" class="difflineminus">-    if (type == &quot;unavailable&quot; &amp;&amp; conv) {</span>
<a href="#l70.1339"></a><span id="l70.1339" class="difflineminus">-      conv.updateTyping(Ci.prplIConvIM.NOT_TYPING, this.contactDisplayName);</span>
<a href="#l70.1340"></a><span id="l70.1340" class="difflineminus">-    }</span>
<a href="#l70.1341"></a><span id="l70.1341" class="difflineminus">-</span>
<a href="#l70.1342"></a><span id="l70.1342" class="difflineminus">-    if (type == &quot;unavailable&quot; || type == &quot;error&quot;) {</span>
<a href="#l70.1343"></a><span id="l70.1343" class="difflineminus">-      if (!this._resources || !(resource in this._resources)) {</span>
<a href="#l70.1344"></a><span id="l70.1344" class="difflineminus">-        // Ignore for already offline resources.</span>
<a href="#l70.1345"></a><span id="l70.1345" class="difflineminus">-        return;</span>
<a href="#l70.1346"></a><span id="l70.1346" class="difflineminus">-      }</span>
<a href="#l70.1347"></a><span id="l70.1347" class="difflineminus">-      delete this._resources[resource];</span>
<a href="#l70.1348"></a><span id="l70.1348" class="difflineminus">-      if (preferred == resource) {</span>
<a href="#l70.1349"></a><span id="l70.1349" class="difflineminus">-        preferred = undefined;</span>
<a href="#l70.1350"></a><span id="l70.1350" class="difflineminus">-      }</span>
<a href="#l70.1351"></a><span id="l70.1351" class="difflineminus">-    } else {</span>
<a href="#l70.1352"></a><span id="l70.1352" class="difflineminus">-      let statusInfo = parseStatus(aStanza);</span>
<a href="#l70.1353"></a><span id="l70.1353" class="difflineminus">-      let priority = aStanza.getElement([&quot;priority&quot;]);</span>
<a href="#l70.1354"></a><span id="l70.1354" class="difflineminus">-      priority = priority ? parseInt(priority.innerText, 10) : 0;</span>
<a href="#l70.1355"></a><span id="l70.1355" class="difflineminus">-</span>
<a href="#l70.1356"></a><span id="l70.1356" class="difflineminus">-      if (!this._resources) {</span>
<a href="#l70.1357"></a><span id="l70.1357" class="difflineminus">-        this._resources = {};</span>
<a href="#l70.1358"></a><span id="l70.1358" class="difflineminus">-      }</span>
<a href="#l70.1359"></a><span id="l70.1359" class="difflineminus">-      this._resources[resource] = {</span>
<a href="#l70.1360"></a><span id="l70.1360" class="difflineminus">-        statusType: statusInfo.statusType,</span>
<a href="#l70.1361"></a><span id="l70.1361" class="difflineminus">-        statusText: statusInfo.statusText,</span>
<a href="#l70.1362"></a><span id="l70.1362" class="difflineminus">-        idleSince: statusInfo.idleSince,</span>
<a href="#l70.1363"></a><span id="l70.1363" class="difflineminus">-        priority,</span>
<a href="#l70.1364"></a><span id="l70.1364" class="difflineminus">-        stanza: aStanza,</span>
<a href="#l70.1365"></a><span id="l70.1365" class="difflineminus">-      };</span>
<a href="#l70.1366"></a><span id="l70.1366" class="difflineminus">-    }</span>
<a href="#l70.1367"></a><span id="l70.1367" class="difflineminus">-</span>
<a href="#l70.1368"></a><span id="l70.1368" class="difflineminus">-    let photo = aStanza.getElement([&quot;x&quot;, &quot;photo&quot;]);</span>
<a href="#l70.1369"></a><span id="l70.1369" class="difflineminus">-    if (photo &amp;&amp; photo.uri == Stanza.NS.vcard_update) {</span>
<a href="#l70.1370"></a><span id="l70.1370" class="difflineminus">-      let hash = photo.innerText;</span>
<a href="#l70.1371"></a><span id="l70.1371" class="difflineminus">-      if (hash &amp;&amp; hash != this._photoHash) {</span>
<a href="#l70.1372"></a><span id="l70.1372" class="difflineminus">-        this._account._addVCardRequest(this.normalizedName);</span>
<a href="#l70.1373"></a><span id="l70.1373" class="difflineminus">-      } else if (!hash &amp;&amp; this._photoHash) {</span>
<a href="#l70.1374"></a><span id="l70.1374" class="difflineminus">-        delete this._photoHash;</span>
<a href="#l70.1375"></a><span id="l70.1375" class="difflineminus">-        this.buddyIconFilename = &quot;&quot;;</span>
<a href="#l70.1376"></a><span id="l70.1376" class="difflineminus">-      }</span>
<a href="#l70.1377"></a><span id="l70.1377" class="difflineminus">-    }</span>
<a href="#l70.1378"></a><span id="l70.1378" class="difflineminus">-</span>
<a href="#l70.1379"></a><span id="l70.1379" class="difflineminus">-    for (let r in this._resources) {</span>
<a href="#l70.1380"></a><span id="l70.1380" class="difflineminus">-      if (</span>
<a href="#l70.1381"></a><span id="l70.1381" class="difflineminus">-        preferred === undefined ||</span>
<a href="#l70.1382"></a><span id="l70.1382" class="difflineminus">-        this._resources[r].statusType &gt; this._resources[preferred].statusType</span>
<a href="#l70.1383"></a><span id="l70.1383" class="difflineminus">-      ) {</span>
<a href="#l70.1384"></a><span id="l70.1384" class="difflineminus">-        // FIXME also compare priorities...</span>
<a href="#l70.1385"></a><span id="l70.1385" class="difflineminus">-        preferred = r;</span>
<a href="#l70.1386"></a><span id="l70.1386" class="difflineminus">-      }</span>
<a href="#l70.1387"></a><span id="l70.1387" class="difflineminus">-    }</span>
<a href="#l70.1388"></a><span id="l70.1388" class="difflineminus">-    if (</span>
<a href="#l70.1389"></a><span id="l70.1389" class="difflineminus">-      preferred != undefined &amp;&amp;</span>
<a href="#l70.1390"></a><span id="l70.1390" class="difflineminus">-      preferred == this._preferredResource &amp;&amp;</span>
<a href="#l70.1391"></a><span id="l70.1391" class="difflineminus">-      resource != preferred</span>
<a href="#l70.1392"></a><span id="l70.1392" class="difflineminus">-    ) {</span>
<a href="#l70.1393"></a><span id="l70.1393" class="difflineminus">-      // The presence information change is only for an unused resource,</span>
<a href="#l70.1394"></a><span id="l70.1394" class="difflineminus">-      // only potential buddy tooltips need to be refreshed.</span>
<a href="#l70.1395"></a><span id="l70.1395" class="difflineminus">-      this._notifyObservers(&quot;status-detail-changed&quot;);</span>
<a href="#l70.1396"></a><span id="l70.1396" class="difflineminus">-      return;</span>
<a href="#l70.1397"></a><span id="l70.1397" class="difflineminus">-    }</span>
<a href="#l70.1398"></a><span id="l70.1398" class="difflineminus">-</span>
<a href="#l70.1399"></a><span id="l70.1399" class="difflineminus">-    // Presence info has changed enough that if we are having a</span>
<a href="#l70.1400"></a><span id="l70.1400" class="difflineminus">-    // conversation with one resource of this buddy, we should send</span>
<a href="#l70.1401"></a><span id="l70.1401" class="difflineminus">-    // the next message to all resources.</span>
<a href="#l70.1402"></a><span id="l70.1402" class="difflineminus">-    // FIXME: the test here isn't exactly right...</span>
<a href="#l70.1403"></a><span id="l70.1403" class="difflineminus">-    if (</span>
<a href="#l70.1404"></a><span id="l70.1404" class="difflineminus">-      this._preferredResource != preferred &amp;&amp;</span>
<a href="#l70.1405"></a><span id="l70.1405" class="difflineminus">-      this._account._conv.has(this.normalizedName)</span>
<a href="#l70.1406"></a><span id="l70.1406" class="difflineminus">-    ) {</span>
<a href="#l70.1407"></a><span id="l70.1407" class="difflineminus">-      delete this._account._conv.get(this.normalizedName)._targetResource;</span>
<a href="#l70.1408"></a><span id="l70.1408" class="difflineminus">-    }</span>
<a href="#l70.1409"></a><span id="l70.1409" class="difflineminus">-</span>
<a href="#l70.1410"></a><span id="l70.1410" class="difflineminus">-    this._preferredResource = preferred;</span>
<a href="#l70.1411"></a><span id="l70.1411" class="difflineminus">-    if (preferred === undefined) {</span>
<a href="#l70.1412"></a><span id="l70.1412" class="difflineminus">-      let statusType = Ci.imIStatusInfo.STATUS_UNKNOWN;</span>
<a href="#l70.1413"></a><span id="l70.1413" class="difflineminus">-      if (type == &quot;unavailable&quot;) {</span>
<a href="#l70.1414"></a><span id="l70.1414" class="difflineminus">-        statusType = Ci.imIStatusInfo.STATUS_OFFLINE;</span>
<a href="#l70.1415"></a><span id="l70.1415" class="difflineminus">-      }</span>
<a href="#l70.1416"></a><span id="l70.1416" class="difflineminus">-      this.setStatus(statusType, &quot;&quot;);</span>
<a href="#l70.1417"></a><span id="l70.1417" class="difflineminus">-    } else {</span>
<a href="#l70.1418"></a><span id="l70.1418" class="difflineminus">-      preferred = this._resources[preferred];</span>
<a href="#l70.1419"></a><span id="l70.1419" class="difflineminus">-      this.setStatus(preferred.statusType, preferred.statusText);</span>
<a href="#l70.1420"></a><span id="l70.1420" class="difflineminus">-    }</span>
<a href="#l70.1421"></a><span id="l70.1421" class="difflineminus">-  },</span>
<a href="#l70.1422"></a><span id="l70.1422" class="difflineminus">-</span>
<a href="#l70.1423"></a><span id="l70.1423" class="difflineminus">-  /* Can send messages to buddies who appear offline */</span>
<a href="#l70.1424"></a><span id="l70.1424" class="difflineminus">-  get canSendMessage() {</span>
<a href="#l70.1425"></a><span id="l70.1425" class="difflineminus">-    return this.account.connected;</span>
<a href="#l70.1426"></a><span id="l70.1426" class="difflineminus">-  },</span>
<a href="#l70.1427"></a><span id="l70.1427" class="difflineminus">-</span>
<a href="#l70.1428"></a><span id="l70.1428" class="difflineminus">-  /* Called when the user wants to chat with the buddy */</span>
<a href="#l70.1429"></a><span id="l70.1429" class="difflineminus">-  createConversation() {</span>
<a href="#l70.1430"></a><span id="l70.1430" class="difflineminus">-    return this._account.createConversation(this.normalizedName);</span>
<a href="#l70.1431"></a><span id="l70.1431" class="difflineminus">-  },</span>
<a href="#l70.1432"></a><span id="l70.1432" class="difflineminus">-};</span>
<a href="#l70.1433"></a><span id="l70.1433" class="difflineminus">-function XMPPAccountBuddy(aAccount, aBuddy, aTag, aUserName) {</span>
<a href="#l70.1434"></a><span id="l70.1434" class="difflineminus">-  this._init(aAccount, aBuddy, aTag, aUserName);</span>
<a href="#l70.1435"></a><span id="l70.1435" class="difflineminus">-}</span>
<a href="#l70.1436"></a><span id="l70.1436" class="difflineminus">-XMPPAccountBuddy.prototype = XMPPAccountBuddyPrototype;</span>
<a href="#l70.1437"></a><span id="l70.1437" class="difflineminus">-</span>
<a href="#l70.1438"></a><span id="l70.1438" class="difflineminus">-var XMPPRoomInfoPrototype = {</span>
<a href="#l70.1439"></a><span id="l70.1439" class="difflineminus">-  __proto__: ClassInfo(&quot;prplIRoomInfo&quot;, &quot;XMPP RoomInfo Object&quot;),</span>
<a href="#l70.1440"></a><span id="l70.1440" class="difflineminus">-  get topic() {</span>
<a href="#l70.1441"></a><span id="l70.1441" class="difflineminus">-    return &quot;&quot;;</span>
<a href="#l70.1442"></a><span id="l70.1442" class="difflineminus">-  },</span>
<a href="#l70.1443"></a><span id="l70.1443" class="difflineminus">-  get participantCount() {</span>
<a href="#l70.1444"></a><span id="l70.1444" class="difflineminus">-    return Ci.prplIRoomInfo.NO_PARTICIPANT_COUNT;</span>
<a href="#l70.1445"></a><span id="l70.1445" class="difflineminus">-  },</span>
<a href="#l70.1446"></a><span id="l70.1446" class="difflineminus">-  get chatRoomFieldValues() {</span>
<a href="#l70.1447"></a><span id="l70.1447" class="difflineminus">-    let roomJid = this._account._roomList.get(this.name);</span>
<a href="#l70.1448"></a><span id="l70.1448" class="difflineminus">-    return this._account.getChatRoomDefaultFieldValues(roomJid);</span>
<a href="#l70.1449"></a><span id="l70.1449" class="difflineminus">-  },</span>
<a href="#l70.1450"></a><span id="l70.1450" class="difflineminus">-};</span>
<a href="#l70.1451"></a><span id="l70.1451" class="difflineminus">-function XMPPRoomInfo(aName, aAccount) {</span>
<a href="#l70.1452"></a><span id="l70.1452" class="difflineminus">-  this.name = aName;</span>
<a href="#l70.1453"></a><span id="l70.1453" class="difflineminus">-  this._account = aAccount;</span>
<a href="#l70.1454"></a><span id="l70.1454" class="difflineminus">-}</span>
<a href="#l70.1455"></a><span id="l70.1455" class="difflineminus">-XMPPRoomInfo.prototype = XMPPRoomInfoPrototype;</span>
<a href="#l70.1456"></a><span id="l70.1456" class="difflineminus">-</span>
<a href="#l70.1457"></a><span id="l70.1457" class="difflineminus">-/* Helper class for account */</span>
<a href="#l70.1458"></a><span id="l70.1458" class="difflineminus">-var XMPPAccountPrototype = {</span>
<a href="#l70.1459"></a><span id="l70.1459" class="difflineminus">-  __proto__: GenericAccountPrototype,</span>
<a href="#l70.1460"></a><span id="l70.1460" class="difflineminus">-</span>
<a href="#l70.1461"></a><span id="l70.1461" class="difflineminus">-  _jid: null, // parsed Jabber ID: node, domain, resource</span>
<a href="#l70.1462"></a><span id="l70.1462" class="difflineminus">-  _connection: null, // XMPPSession socket</span>
<a href="#l70.1463"></a><span id="l70.1463" class="difflineminus">-  authMechanisms: null, // hook to let prpls tweak the list of auth mechanisms</span>
<a href="#l70.1464"></a><span id="l70.1464" class="difflineminus">-</span>
<a href="#l70.1465"></a><span id="l70.1465" class="difflineminus">-  // Contains the domain of MUC service which is obtained using service</span>
<a href="#l70.1466"></a><span id="l70.1466" class="difflineminus">-  // discovery.</span>
<a href="#l70.1467"></a><span id="l70.1467" class="difflineminus">-  _mucService: null,</span>
<a href="#l70.1468"></a><span id="l70.1468" class="difflineminus">-</span>
<a href="#l70.1469"></a><span id="l70.1469" class="difflineminus">-  // Maps room names to room jid.</span>
<a href="#l70.1470"></a><span id="l70.1470" class="difflineminus">-  _roomList: new Map(),</span>
<a href="#l70.1471"></a><span id="l70.1471" class="difflineminus">-</span>
<a href="#l70.1472"></a><span id="l70.1472" class="difflineminus">-  // Callbacks used when roomInfo is available.</span>
<a href="#l70.1473"></a><span id="l70.1473" class="difflineminus">-  _roomInfoCallbacks: new Set(),</span>
<a href="#l70.1474"></a><span id="l70.1474" class="difflineminus">-</span>
<a href="#l70.1475"></a><span id="l70.1475" class="difflineminus">-  // Determines if roomInfo that we have is expired or not.</span>
<a href="#l70.1476"></a><span id="l70.1476" class="difflineminus">-  _lastListTime: 0,</span>
<a href="#l70.1477"></a><span id="l70.1477" class="difflineminus">-  get isRoomInfoStale() {</span>
<a href="#l70.1478"></a><span id="l70.1478" class="difflineminus">-    return Date.now() - this._lastListTime &gt; kListRefreshInterval;</span>
<a href="#l70.1479"></a><span id="l70.1479" class="difflineminus">-  },</span>
<a href="#l70.1480"></a><span id="l70.1480" class="difflineminus">-</span>
<a href="#l70.1481"></a><span id="l70.1481" class="difflineminus">-  // If true, we are waiting for replies.</span>
<a href="#l70.1482"></a><span id="l70.1482" class="difflineminus">-  _pendingList: false,</span>
<a href="#l70.1483"></a><span id="l70.1483" class="difflineminus">-</span>
<a href="#l70.1484"></a><span id="l70.1484" class="difflineminus">-  // An array of jids for which we still need to request vCards.</span>
<a href="#l70.1485"></a><span id="l70.1485" class="difflineminus">-  _pendingVCardRequests: [],</span>
<a href="#l70.1486"></a><span id="l70.1486" class="difflineminus">-</span>
<a href="#l70.1487"></a><span id="l70.1487" class="difflineminus">-  // XEP-0280: Message Carbons.</span>
<a href="#l70.1488"></a><span id="l70.1488" class="difflineminus">-  // If true, message carbons are currently enabled.</span>
<a href="#l70.1489"></a><span id="l70.1489" class="difflineminus">-  _isCarbonsEnabled: false,</span>
<a href="#l70.1490"></a><span id="l70.1490" class="difflineminus">-</span>
<a href="#l70.1491"></a><span id="l70.1491" class="difflineminus">-  /* Generate unique id for a stanza. Using id and unique sid is defined in</span>
<a href="#l70.1492"></a><span id="l70.1492" class="difflineminus">-   * RFC 6120 (Section 8.2.3, 4.7.3).</span>
<a href="#l70.1493"></a><span id="l70.1493" class="difflineminus">-   */</span>
<a href="#l70.1494"></a><span id="l70.1494" class="difflineminus">-  generateId: () =&gt;</span>
<a href="#l70.1495"></a><span id="l70.1495" class="difflineminus">-    UuidGenerator.generateUUID()</span>
<a href="#l70.1496"></a><span id="l70.1496" class="difflineminus">-      .toString()</span>
<a href="#l70.1497"></a><span id="l70.1497" class="difflineminus">-      .slice(1, -1),</span>
<a href="#l70.1498"></a><span id="l70.1498" class="difflineminus">-</span>
<a href="#l70.1499"></a><span id="l70.1499" class="difflineminus">-  _init(aProtoInstance, aImAccount) {</span>
<a href="#l70.1500"></a><span id="l70.1500" class="difflineminus">-    GenericAccountPrototype._init.call(this, aProtoInstance, aImAccount);</span>
<a href="#l70.1501"></a><span id="l70.1501" class="difflineminus">-</span>
<a href="#l70.1502"></a><span id="l70.1502" class="difflineminus">-    // Ongoing conversations.</span>
<a href="#l70.1503"></a><span id="l70.1503" class="difflineminus">-    // The keys of this._conv are assumed to be normalized like account@domain</span>
<a href="#l70.1504"></a><span id="l70.1504" class="difflineminus">-    // for normal conversations and like room@domain/nick for MUC participant</span>
<a href="#l70.1505"></a><span id="l70.1505" class="difflineminus">-    // convs.</span>
<a href="#l70.1506"></a><span id="l70.1506" class="difflineminus">-    this._conv = new NormalizedMap(this.normalizeFullJid.bind(this));</span>
<a href="#l70.1507"></a><span id="l70.1507" class="difflineminus">-</span>
<a href="#l70.1508"></a><span id="l70.1508" class="difflineminus">-    this._buddies = new NormalizedMap(this.normalize.bind(this));</span>
<a href="#l70.1509"></a><span id="l70.1509" class="difflineminus">-    this._mucs = new NormalizedMap(this.normalize.bind(this));</span>
<a href="#l70.1510"></a><span id="l70.1510" class="difflineminus">-  },</span>
<a href="#l70.1511"></a><span id="l70.1511" class="difflineminus">-</span>
<a href="#l70.1512"></a><span id="l70.1512" class="difflineminus">-  get canJoinChat() {</span>
<a href="#l70.1513"></a><span id="l70.1513" class="difflineminus">-    return true;</span>
<a href="#l70.1514"></a><span id="l70.1514" class="difflineminus">-  },</span>
<a href="#l70.1515"></a><span id="l70.1515" class="difflineminus">-  chatRoomFields: {</span>
<a href="#l70.1516"></a><span id="l70.1516" class="difflineminus">-    room: {</span>
<a href="#l70.1517"></a><span id="l70.1517" class="difflineplus">+  options: {</span>
<a href="#l70.1518"></a><span id="l70.1518" class="difflineplus">+    resource: {</span>
<a href="#l70.1519"></a><span id="l70.1519" class="difflineplus">+      get label() {</span>
<a href="#l70.1520"></a><span id="l70.1520" class="difflineplus">+        return _(&quot;options.resource&quot;);</span>
<a href="#l70.1521"></a><span id="l70.1521" class="difflineplus">+      },</span>
<a href="#l70.1522"></a><span id="l70.1522" class="difflineplus">+      default: &quot;&quot;,</span>
<a href="#l70.1523"></a><span id="l70.1523" class="difflineplus">+    },</span>
<a href="#l70.1524"></a><span id="l70.1524" class="difflineplus">+    priority: {</span>
<a href="#l70.1525"></a><span id="l70.1525" class="difflineplus">+      get label() {</span>
<a href="#l70.1526"></a><span id="l70.1526" class="difflineplus">+        return _(&quot;options.priority&quot;);</span>
<a href="#l70.1527"></a><span id="l70.1527" class="difflineplus">+      },</span>
<a href="#l70.1528"></a><span id="l70.1528" class="difflineplus">+      default: 0,</span>
<a href="#l70.1529"></a><span id="l70.1529" class="difflineplus">+    },</span>
<a href="#l70.1530"></a><span id="l70.1530" class="difflineplus">+    connection_security: {</span>
<a href="#l70.1531"></a><span id="l70.1531">       get label() {</span>
<a href="#l70.1532"></a><span id="l70.1532" class="difflineminus">-        return _(&quot;chatRoomField.room&quot;);</span>
<a href="#l70.1533"></a><span id="l70.1533" class="difflineplus">+        return _(&quot;options.connectionSecurity&quot;);</span>
<a href="#l70.1534"></a><span id="l70.1534">       },</span>
<a href="#l70.1535"></a><span id="l70.1535" class="difflineminus">-      required: true,</span>
<a href="#l70.1536"></a><span id="l70.1536" class="difflineplus">+      listValues: {</span>
<a href="#l70.1537"></a><span id="l70.1537" class="difflineplus">+        get require_tls() {</span>
<a href="#l70.1538"></a><span id="l70.1538" class="difflineplus">+          return _(&quot;options.connectionSecurity.requireEncryption&quot;);</span>
<a href="#l70.1539"></a><span id="l70.1539" class="difflineplus">+        },</span>
<a href="#l70.1540"></a><span id="l70.1540" class="difflineplus">+        get opportunistic_tls() {</span>
<a href="#l70.1541"></a><span id="l70.1541" class="difflineplus">+          return _(&quot;options.connectionSecurity.opportunisticTLS&quot;);</span>
<a href="#l70.1542"></a><span id="l70.1542" class="difflineplus">+        },</span>
<a href="#l70.1543"></a><span id="l70.1543" class="difflineplus">+        get allow_unencrypted_plain_auth() {</span>
<a href="#l70.1544"></a><span id="l70.1544" class="difflineplus">+          return _(&quot;options.connectionSecurity.allowUnencryptedAuth&quot;);</span>
<a href="#l70.1545"></a><span id="l70.1545" class="difflineplus">+        },</span>
<a href="#l70.1546"></a><span id="l70.1546" class="difflineplus">+        // &quot;old_ssl&quot; and &quot;none&quot; are also supported, but not exposed in the UI.</span>
<a href="#l70.1547"></a><span id="l70.1547" class="difflineplus">+        // Any unknown value will fallback to the opportunistic_tls behavior.</span>
<a href="#l70.1548"></a><span id="l70.1548" class="difflineplus">+      },</span>
<a href="#l70.1549"></a><span id="l70.1549" class="difflineplus">+      default: &quot;require_tls&quot;,</span>
<a href="#l70.1550"></a><span id="l70.1550">     },</span>
<a href="#l70.1551"></a><span id="l70.1551">     server: {</span>
<a href="#l70.1552"></a><span id="l70.1552">       get label() {</span>
<a href="#l70.1553"></a><span id="l70.1553" class="difflineminus">-        return _(&quot;chatRoomField.server&quot;);</span>
<a href="#l70.1554"></a><span id="l70.1554" class="difflineminus">-      },</span>
<a href="#l70.1555"></a><span id="l70.1555" class="difflineminus">-      required: true,</span>
<a href="#l70.1556"></a><span id="l70.1556" class="difflineminus">-    },</span>
<a href="#l70.1557"></a><span id="l70.1557" class="difflineminus">-    nick: {</span>
<a href="#l70.1558"></a><span id="l70.1558" class="difflineminus">-      get label() {</span>
<a href="#l70.1559"></a><span id="l70.1559" class="difflineminus">-        return _(&quot;chatRoomField.nick&quot;);</span>
<a href="#l70.1560"></a><span id="l70.1560" class="difflineplus">+        return _(&quot;options.connectServer&quot;);</span>
<a href="#l70.1561"></a><span id="l70.1561">       },</span>
<a href="#l70.1562"></a><span id="l70.1562" class="difflineminus">-      required: true,</span>
<a href="#l70.1563"></a><span id="l70.1563" class="difflineplus">+      default: &quot;&quot;,</span>
<a href="#l70.1564"></a><span id="l70.1564">     },</span>
<a href="#l70.1565"></a><span id="l70.1565" class="difflineminus">-    password: {</span>
<a href="#l70.1566"></a><span id="l70.1566" class="difflineplus">+    port: {</span>
<a href="#l70.1567"></a><span id="l70.1567">       get label() {</span>
<a href="#l70.1568"></a><span id="l70.1568" class="difflineminus">-        return _(&quot;chatRoomField.password&quot;);</span>
<a href="#l70.1569"></a><span id="l70.1569" class="difflineplus">+        return _(&quot;options.connectPort&quot;);</span>
<a href="#l70.1570"></a><span id="l70.1570">       },</span>
<a href="#l70.1571"></a><span id="l70.1571" class="difflineminus">-      isPassword: true,</span>
<a href="#l70.1572"></a><span id="l70.1572" class="difflineplus">+      default: 5222,</span>
<a href="#l70.1573"></a><span id="l70.1573">     },</span>
<a href="#l70.1574"></a><span id="l70.1574">   },</span>
<a href="#l70.1575"></a><span id="l70.1575" class="difflineminus">-  parseDefaultChatName(aDefaultChatName) {</span>
<a href="#l70.1576"></a><span id="l70.1576" class="difflineminus">-    if (!aDefaultChatName) {</span>
<a href="#l70.1577"></a><span id="l70.1577" class="difflineminus">-      return { nick: this._jid.node };</span>
<a href="#l70.1578"></a><span id="l70.1578" class="difflineminus">-    }</span>
<a href="#l70.1579"></a><span id="l70.1579" class="difflineminus">-</span>
<a href="#l70.1580"></a><span id="l70.1580" class="difflineminus">-    let params = aDefaultChatName.trim().split(/\s+/);</span>
<a href="#l70.1581"></a><span id="l70.1581" class="difflineminus">-    let jid = this._parseJID(params[0]);</span>
<a href="#l70.1582"></a><span id="l70.1582" class="difflineminus">-</span>
<a href="#l70.1583"></a><span id="l70.1583" class="difflineminus">-    // We swap node and domain as domain is required for parseJID, but node and</span>
<a href="#l70.1584"></a><span id="l70.1584" class="difflineminus">-    // resource are optional. In MUC join command, Node is required as it</span>
<a href="#l70.1585"></a><span id="l70.1585" class="difflineminus">-    // represents a room, but domain and resource are optional as we get muc</span>
<a href="#l70.1586"></a><span id="l70.1586" class="difflineminus">-    // domain from service discovery.</span>
<a href="#l70.1587"></a><span id="l70.1587" class="difflineminus">-    if (!jid.node &amp;&amp; jid.domain) {</span>
<a href="#l70.1588"></a><span id="l70.1588" class="difflineminus">-      [jid.node, jid.domain] = [jid.domain, jid.node];</span>
<a href="#l70.1589"></a><span id="l70.1589" class="difflineminus">-    }</span>
<a href="#l70.1590"></a><span id="l70.1590" class="difflineminus">-</span>
<a href="#l70.1591"></a><span id="l70.1591" class="difflineminus">-    let chatFields = {</span>
<a href="#l70.1592"></a><span id="l70.1592" class="difflineminus">-      room: jid.node,</span>
<a href="#l70.1593"></a><span id="l70.1593" class="difflineminus">-      server: jid.domain || this._mucService,</span>
<a href="#l70.1594"></a><span id="l70.1594" class="difflineminus">-      nick: jid.resource || this._jid.node,</span>
<a href="#l70.1595"></a><span id="l70.1595" class="difflineminus">-    };</span>
<a href="#l70.1596"></a><span id="l70.1596" class="difflineminus">-    if (params.length &gt; 1) {</span>
<a href="#l70.1597"></a><span id="l70.1597" class="difflineminus">-      chatFields.password = params[1];</span>
<a href="#l70.1598"></a><span id="l70.1598" class="difflineminus">-    }</span>
<a href="#l70.1599"></a><span id="l70.1599" class="difflineminus">-    return chatFields;</span>
<a href="#l70.1600"></a><span id="l70.1600" class="difflineminus">-  },</span>
<a href="#l70.1601"></a><span id="l70.1601" class="difflineminus">-  getChatRoomDefaultFieldValues(aDefaultChatName) {</span>
<a href="#l70.1602"></a><span id="l70.1602" class="difflineminus">-    let rv = GenericAccountPrototype.getChatRoomDefaultFieldValues.call(</span>
<a href="#l70.1603"></a><span id="l70.1603" class="difflineminus">-      this,</span>
<a href="#l70.1604"></a><span id="l70.1604" class="difflineminus">-      aDefaultChatName</span>
<a href="#l70.1605"></a><span id="l70.1605" class="difflineminus">-    );</span>
<a href="#l70.1606"></a><span id="l70.1606" class="difflineminus">-    if (!rv.values.nick) {</span>
<a href="#l70.1607"></a><span id="l70.1607" class="difflineminus">-      rv.values.nick = this._jid.node;</span>
<a href="#l70.1608"></a><span id="l70.1608" class="difflineminus">-    }</span>
<a href="#l70.1609"></a><span id="l70.1609" class="difflineminus">-    if (!rv.values.server &amp;&amp; this._mucService) {</span>
<a href="#l70.1610"></a><span id="l70.1610" class="difflineminus">-      rv.values.server = this._mucService;</span>
<a href="#l70.1611"></a><span id="l70.1611" class="difflineminus">-    }</span>
<a href="#l70.1612"></a><span id="l70.1612" class="difflineminus">-</span>
<a href="#l70.1613"></a><span id="l70.1613" class="difflineminus">-    return rv;</span>
<a href="#l70.1614"></a><span id="l70.1614" class="difflineminus">-  },</span>
<a href="#l70.1615"></a><span id="l70.1615" class="difflineminus">-</span>
<a href="#l70.1616"></a><span id="l70.1616" class="difflineminus">-  // XEP-0045: Requests joining room if it exists or</span>
<a href="#l70.1617"></a><span id="l70.1617" class="difflineminus">-  // creating room if it does not exist.</span>
<a href="#l70.1618"></a><span id="l70.1618" class="difflineminus">-  joinChat(aComponents) {</span>
<a href="#l70.1619"></a><span id="l70.1619" class="difflineminus">-    let jid =</span>
<a href="#l70.1620"></a><span id="l70.1620" class="difflineminus">-      aComponents.getValue(&quot;room&quot;) + &quot;@&quot; + aComponents.getValue(&quot;server&quot;);</span>
<a href="#l70.1621"></a><span id="l70.1621" class="difflineminus">-    let nick = aComponents.getValue(&quot;nick&quot;);</span>
<a href="#l70.1622"></a><span id="l70.1622" class="difflineminus">-</span>
<a href="#l70.1623"></a><span id="l70.1623" class="difflineminus">-    let muc = this._mucs.get(jid);</span>
<a href="#l70.1624"></a><span id="l70.1624" class="difflineminus">-    if (muc) {</span>
<a href="#l70.1625"></a><span id="l70.1625" class="difflineminus">-      if (!muc.left) {</span>
<a href="#l70.1626"></a><span id="l70.1626" class="difflineminus">-        // We are already in this conversation.</span>
<a href="#l70.1627"></a><span id="l70.1627" class="difflineminus">-        return muc;</span>
<a href="#l70.1628"></a><span id="l70.1628" class="difflineminus">-      } else if (!muc.chatRoomFields) {</span>
<a href="#l70.1629"></a><span id="l70.1629" class="difflineminus">-        // We are rejoining a room that was parted by the user.</span>
<a href="#l70.1630"></a><span id="l70.1630" class="difflineminus">-        muc._rejoined = true;</span>
<a href="#l70.1631"></a><span id="l70.1631" class="difflineminus">-      }</span>
<a href="#l70.1632"></a><span id="l70.1632" class="difflineminus">-    } else {</span>
<a href="#l70.1633"></a><span id="l70.1633" class="difflineminus">-      muc = new this._MUCConversationConstructor(this, jid, nick);</span>
<a href="#l70.1634"></a><span id="l70.1634" class="difflineminus">-      this._mucs.set(jid, muc);</span>
<a href="#l70.1635"></a><span id="l70.1635" class="difflineminus">-    }</span>
<a href="#l70.1636"></a><span id="l70.1636" class="difflineminus">-</span>
<a href="#l70.1637"></a><span id="l70.1637" class="difflineminus">-    // Store the prplIChatRoomFieldValues to enable later reconnections.</span>
<a href="#l70.1638"></a><span id="l70.1638" class="difflineminus">-    muc.chatRoomFields = aComponents;</span>
<a href="#l70.1639"></a><span id="l70.1639" class="difflineminus">-    muc.joining = true;</span>
<a href="#l70.1640"></a><span id="l70.1640" class="difflineminus">-    muc.removeAllParticipants();</span>
<a href="#l70.1641"></a><span id="l70.1641" class="difflineminus">-</span>
<a href="#l70.1642"></a><span id="l70.1642" class="difflineminus">-    let password = aComponents.getValue(&quot;password&quot;);</span>
<a href="#l70.1643"></a><span id="l70.1643" class="difflineminus">-    let x = Stanza.node(</span>
<a href="#l70.1644"></a><span id="l70.1644" class="difflineminus">-      &quot;x&quot;,</span>
<a href="#l70.1645"></a><span id="l70.1645" class="difflineminus">-      Stanza.NS.muc,</span>
<a href="#l70.1646"></a><span id="l70.1646" class="difflineminus">-      null,</span>
<a href="#l70.1647"></a><span id="l70.1647" class="difflineminus">-      password ? Stanza.node(&quot;password&quot;, null, null, password) : null</span>
<a href="#l70.1648"></a><span id="l70.1648" class="difflineminus">-    );</span>
<a href="#l70.1649"></a><span id="l70.1649" class="difflineminus">-    let logString;</span>
<a href="#l70.1650"></a><span id="l70.1650" class="difflineminus">-    if (password) {</span>
<a href="#l70.1651"></a><span id="l70.1651" class="difflineminus">-      logString =</span>
<a href="#l70.1652"></a><span id="l70.1652" class="difflineminus">-        &quot;&lt;presence .../&gt; (Stanza containing password to join MUC &quot; +</span>
<a href="#l70.1653"></a><span id="l70.1653" class="difflineminus">-        jid +</span>
<a href="#l70.1654"></a><span id="l70.1654" class="difflineminus">-        &quot;/&quot; +</span>
<a href="#l70.1655"></a><span id="l70.1655" class="difflineminus">-        nick +</span>
<a href="#l70.1656"></a><span id="l70.1656" class="difflineminus">-        &quot; not logged)&quot;;</span>
<a href="#l70.1657"></a><span id="l70.1657" class="difflineminus">-    }</span>
<a href="#l70.1658"></a><span id="l70.1658" class="difflineminus">-    this.sendStanza(</span>
<a href="#l70.1659"></a><span id="l70.1659" class="difflineminus">-      Stanza.presence({ to: jid + &quot;/&quot; + nick }, x),</span>
<a href="#l70.1660"></a><span id="l70.1660" class="difflineminus">-      undefined,</span>
<a href="#l70.1661"></a><span id="l70.1661" class="difflineminus">-      undefined,</span>
<a href="#l70.1662"></a><span id="l70.1662" class="difflineminus">-      logString</span>
<a href="#l70.1663"></a><span id="l70.1663" class="difflineminus">-    );</span>
<a href="#l70.1664"></a><span id="l70.1664" class="difflineminus">-    return muc;</span>
<a href="#l70.1665"></a><span id="l70.1665" class="difflineminus">-  },</span>
<a href="#l70.1666"></a><span id="l70.1666" class="difflineminus">-</span>
<a href="#l70.1667"></a><span id="l70.1667" class="difflineminus">-  _idleSince: 0,</span>
<a href="#l70.1668"></a><span id="l70.1668" class="difflineminus">-  observe(aSubject, aTopic, aData) {</span>
<a href="#l70.1669"></a><span id="l70.1669" class="difflineminus">-    if (aTopic == &quot;idle-time-changed&quot;) {</span>
<a href="#l70.1670"></a><span id="l70.1670" class="difflineminus">-      let idleTime = parseInt(aData, 10);</span>
<a href="#l70.1671"></a><span id="l70.1671" class="difflineminus">-      if (idleTime) {</span>
<a href="#l70.1672"></a><span id="l70.1672" class="difflineminus">-        this._idleSince = Math.floor(Date.now() / 1000) - idleTime;</span>
<a href="#l70.1673"></a><span id="l70.1673" class="difflineminus">-      } else {</span>
<a href="#l70.1674"></a><span id="l70.1674" class="difflineminus">-        delete this._idleSince;</span>
<a href="#l70.1675"></a><span id="l70.1675" class="difflineminus">-      }</span>
<a href="#l70.1676"></a><span id="l70.1676" class="difflineminus">-      this._shouldSendPresenceForIdlenessChange = true;</span>
<a href="#l70.1677"></a><span id="l70.1677" class="difflineminus">-      executeSoon(</span>
<a href="#l70.1678"></a><span id="l70.1678" class="difflineminus">-        function() {</span>
<a href="#l70.1679"></a><span id="l70.1679" class="difflineminus">-          if (&quot;_shouldSendPresenceForIdlenessChange&quot; in this) {</span>
<a href="#l70.1680"></a><span id="l70.1680" class="difflineminus">-            this._sendPresence();</span>
<a href="#l70.1681"></a><span id="l70.1681" class="difflineminus">-          }</span>
<a href="#l70.1682"></a><span id="l70.1682" class="difflineminus">-        }.bind(this)</span>
<a href="#l70.1683"></a><span id="l70.1683" class="difflineminus">-      );</span>
<a href="#l70.1684"></a><span id="l70.1684" class="difflineminus">-    } else if (aTopic == &quot;status-changed&quot;) {</span>
<a href="#l70.1685"></a><span id="l70.1685" class="difflineminus">-      this._sendPresence();</span>
<a href="#l70.1686"></a><span id="l70.1686" class="difflineminus">-    } else if (aTopic == &quot;user-icon-changed&quot;) {</span>
<a href="#l70.1687"></a><span id="l70.1687" class="difflineminus">-      delete this._cachedUserIcon;</span>
<a href="#l70.1688"></a><span id="l70.1688" class="difflineminus">-      this._forceUserIconUpdate = true;</span>
<a href="#l70.1689"></a><span id="l70.1689" class="difflineminus">-      this._sendVCard();</span>
<a href="#l70.1690"></a><span id="l70.1690" class="difflineminus">-    } else if (aTopic == &quot;user-display-name-changed&quot;) {</span>
<a href="#l70.1691"></a><span id="l70.1691" class="difflineminus">-      this._forceUserDisplayNameUpdate = true;</span>
<a href="#l70.1692"></a><span id="l70.1692" class="difflineminus">-    }</span>
<a href="#l70.1693"></a><span id="l70.1693" class="difflineminus">-    this._sendVCard();</span>
<a href="#l70.1694"></a><span id="l70.1694" class="difflineminus">-  },</span>
<a href="#l70.1695"></a><span id="l70.1695" class="difflineminus">-</span>
<a href="#l70.1696"></a><span id="l70.1696" class="difflineminus">-  /* GenericAccountPrototype events */</span>
<a href="#l70.1697"></a><span id="l70.1697" class="difflineminus">-  /* Connect to the server */</span>
<a href="#l70.1698"></a><span id="l70.1698" class="difflineminus">-  connect() {</span>
<a href="#l70.1699"></a><span id="l70.1699" class="difflineminus">-    this._jid = this._parseJID(this.name);</span>
<a href="#l70.1700"></a><span id="l70.1700" class="difflineminus">-</span>
<a href="#l70.1701"></a><span id="l70.1701" class="difflineminus">-    // For the resource, if the user has edited the option, always use that.</span>
<a href="#l70.1702"></a><span id="l70.1702" class="difflineminus">-    if (this.prefs.prefHasUserValue(&quot;resource&quot;)) {</span>
<a href="#l70.1703"></a><span id="l70.1703" class="difflineminus">-      let resource = this.getString(&quot;resource&quot;);</span>
<a href="#l70.1704"></a><span id="l70.1704" class="difflineminus">-</span>
<a href="#l70.1705"></a><span id="l70.1705" class="difflineminus">-      // this._jid needs to be updated. This value is however never used</span>
<a href="#l70.1706"></a><span id="l70.1706" class="difflineminus">-      // because while connected it's the jid of the session that's</span>
<a href="#l70.1707"></a><span id="l70.1707" class="difflineminus">-      // interesting.</span>
<a href="#l70.1708"></a><span id="l70.1708" class="difflineminus">-      this._jid = this._setJID(this._jid.domain, this._jid.node, resource);</span>
<a href="#l70.1709"></a><span id="l70.1709" class="difflineminus">-    } else if (this._jid.resource) {</span>
<a href="#l70.1710"></a><span id="l70.1710" class="difflineminus">-      // If there is a resource in the account name (inherited from libpurple),</span>
<a href="#l70.1711"></a><span id="l70.1711" class="difflineminus">-      // migrate it to the pref so it appears correctly in the advanced account</span>
<a href="#l70.1712"></a><span id="l70.1712" class="difflineminus">-      // options next time.</span>
<a href="#l70.1713"></a><span id="l70.1713" class="difflineminus">-      this.prefs.setStringPref(&quot;resource&quot;, this._jid.resource);</span>
<a href="#l70.1714"></a><span id="l70.1714" class="difflineminus">-    }</span>
<a href="#l70.1715"></a><span id="l70.1715" class="difflineminus">-</span>
<a href="#l70.1716"></a><span id="l70.1716" class="difflineminus">-    this._connection = new XMPPSession(</span>
<a href="#l70.1717"></a><span id="l70.1717" class="difflineminus">-      this.getString(&quot;server&quot;) || this._jid.domain,</span>
<a href="#l70.1718"></a><span id="l70.1718" class="difflineminus">-      this.getInt(&quot;port&quot;) || 5222,</span>
<a href="#l70.1719"></a><span id="l70.1719" class="difflineminus">-      this.getString(&quot;connection_security&quot;),</span>
<a href="#l70.1720"></a><span id="l70.1720" class="difflineminus">-      this._jid,</span>
<a href="#l70.1721"></a><span id="l70.1721" class="difflineminus">-      this.imAccount.password,</span>
<a href="#l70.1722"></a><span id="l70.1722" class="difflineminus">-      this</span>
<a href="#l70.1723"></a><span id="l70.1723" class="difflineminus">-    );</span>
<a href="#l70.1724"></a><span id="l70.1724" class="difflineminus">-  },</span>
<a href="#l70.1725"></a><span id="l70.1725" class="difflineminus">-</span>
<a href="#l70.1726"></a><span id="l70.1726" class="difflineminus">-  remove() {</span>
<a href="#l70.1727"></a><span id="l70.1727" class="difflineminus">-    this._conv.forEach(conv =&gt; conv.close());</span>
<a href="#l70.1728"></a><span id="l70.1728" class="difflineminus">-    this._mucs.forEach(muc =&gt; muc.close());</span>
<a href="#l70.1729"></a><span id="l70.1729" class="difflineminus">-    this._buddies.forEach((buddy, jid) =&gt; this._forgetRosterItem(jid));</span>
<a href="#l70.1730"></a><span id="l70.1730" class="difflineminus">-  },</span>
<a href="#l70.1731"></a><span id="l70.1731" class="difflineminus">-</span>
<a href="#l70.1732"></a><span id="l70.1732" class="difflineminus">-  unInit() {</span>
<a href="#l70.1733"></a><span id="l70.1733" class="difflineminus">-    if (this._connection) {</span>
<a href="#l70.1734"></a><span id="l70.1734" class="difflineminus">-      this._disconnect(undefined, undefined, true);</span>
<a href="#l70.1735"></a><span id="l70.1735" class="difflineminus">-    }</span>
<a href="#l70.1736"></a><span id="l70.1736" class="difflineminus">-    delete this._jid;</span>
<a href="#l70.1737"></a><span id="l70.1737" class="difflineminus">-    delete this._conv;</span>
<a href="#l70.1738"></a><span id="l70.1738" class="difflineminus">-    delete this._buddies;</span>
<a href="#l70.1739"></a><span id="l70.1739" class="difflineminus">-    delete this._mucs;</span>
<a href="#l70.1740"></a><span id="l70.1740" class="difflineminus">-  },</span>
<a href="#l70.1741"></a><span id="l70.1741" class="difflineminus">-</span>
<a href="#l70.1742"></a><span id="l70.1742" class="difflineminus">-  /* Disconnect from the server */</span>
<a href="#l70.1743"></a><span id="l70.1743" class="difflineminus">-  disconnect() {</span>
<a href="#l70.1744"></a><span id="l70.1744" class="difflineminus">-    this._disconnect();</span>
<a href="#l70.1745"></a><span id="l70.1745" class="difflineminus">-  },</span>
<a href="#l70.1746"></a><span id="l70.1746" class="difflineminus">-</span>
<a href="#l70.1747"></a><span id="l70.1747" class="difflineminus">-  addBuddy(aTag, aName) {</span>
<a href="#l70.1748"></a><span id="l70.1748" class="difflineminus">-    if (!this._connection) {</span>
<a href="#l70.1749"></a><span id="l70.1749" class="difflineminus">-      throw new Error(&quot;The account isn't connected&quot;);</span>
<a href="#l70.1750"></a><span id="l70.1750" class="difflineminus">-    }</span>
<a href="#l70.1751"></a><span id="l70.1751" class="difflineminus">-</span>
<a href="#l70.1752"></a><span id="l70.1752" class="difflineminus">-    let jid = this.normalize(aName);</span>
<a href="#l70.1753"></a><span id="l70.1753" class="difflineminus">-    if (!jid || !jid.includes(&quot;@&quot;)) {</span>
<a href="#l70.1754"></a><span id="l70.1754" class="difflineminus">-      throw new Error(&quot;Invalid username&quot;);</span>
<a href="#l70.1755"></a><span id="l70.1755" class="difflineminus">-    }</span>
<a href="#l70.1756"></a><span id="l70.1756" class="difflineminus">-</span>
<a href="#l70.1757"></a><span id="l70.1757" class="difflineminus">-    if (this._buddies.has(jid)) {</span>
<a href="#l70.1758"></a><span id="l70.1758" class="difflineminus">-      let subscription = this._buddies.get(jid).subscription;</span>
<a href="#l70.1759"></a><span id="l70.1759" class="difflineminus">-      if (subscription &amp;&amp; (subscription == &quot;both&quot; || subscription == &quot;to&quot;)) {</span>
<a href="#l70.1760"></a><span id="l70.1760" class="difflineminus">-        this.DEBUG(&quot;not re-adding an existing buddy&quot;);</span>
<a href="#l70.1761"></a><span id="l70.1761" class="difflineminus">-        return;</span>
<a href="#l70.1762"></a><span id="l70.1762" class="difflineminus">-      }</span>
<a href="#l70.1763"></a><span id="l70.1763" class="difflineminus">-    } else {</span>
<a href="#l70.1764"></a><span id="l70.1764" class="difflineminus">-      let s = Stanza.iq(</span>
<a href="#l70.1765"></a><span id="l70.1765" class="difflineminus">-        &quot;set&quot;,</span>
<a href="#l70.1766"></a><span id="l70.1766" class="difflineminus">-        null,</span>
<a href="#l70.1767"></a><span id="l70.1767" class="difflineminus">-        null,</span>
<a href="#l70.1768"></a><span id="l70.1768" class="difflineminus">-        Stanza.node(</span>
<a href="#l70.1769"></a><span id="l70.1769" class="difflineminus">-          &quot;query&quot;,</span>
<a href="#l70.1770"></a><span id="l70.1770" class="difflineminus">-          Stanza.NS.roster,</span>
<a href="#l70.1771"></a><span id="l70.1771" class="difflineminus">-          null,</span>
<a href="#l70.1772"></a><span id="l70.1772" class="difflineminus">-          Stanza.node(</span>
<a href="#l70.1773"></a><span id="l70.1773" class="difflineminus">-            &quot;item&quot;,</span>
<a href="#l70.1774"></a><span id="l70.1774" class="difflineminus">-            null,</span>
<a href="#l70.1775"></a><span id="l70.1775" class="difflineminus">-            { jid },</span>
<a href="#l70.1776"></a><span id="l70.1776" class="difflineminus">-            Stanza.node(&quot;group&quot;, null, null, aTag.name)</span>
<a href="#l70.1777"></a><span id="l70.1777" class="difflineminus">-          )</span>
<a href="#l70.1778"></a><span id="l70.1778" class="difflineminus">-        )</span>
<a href="#l70.1779"></a><span id="l70.1779" class="difflineminus">-      );</span>
<a href="#l70.1780"></a><span id="l70.1780" class="difflineminus">-      this.sendStanza(</span>
<a href="#l70.1781"></a><span id="l70.1781" class="difflineminus">-        s,</span>
<a href="#l70.1782"></a><span id="l70.1782" class="difflineminus">-        this._handleResult({</span>
<a href="#l70.1783"></a><span id="l70.1783" class="difflineminus">-          default: aError =&gt; {</span>
<a href="#l70.1784"></a><span id="l70.1784" class="difflineminus">-            this.WARN(</span>
<a href="#l70.1785"></a><span id="l70.1785" class="difflineminus">-              &quot;Unable to add a roster item due to &quot; + aError + &quot; error.&quot;</span>
<a href="#l70.1786"></a><span id="l70.1786" class="difflineminus">-            );</span>
<a href="#l70.1787"></a><span id="l70.1787" class="difflineminus">-          },</span>
<a href="#l70.1788"></a><span id="l70.1788" class="difflineminus">-        })</span>
<a href="#l70.1789"></a><span id="l70.1789" class="difflineminus">-      );</span>
<a href="#l70.1790"></a><span id="l70.1790" class="difflineminus">-    }</span>
<a href="#l70.1791"></a><span id="l70.1791" class="difflineminus">-    this.sendStanza(Stanza.presence({ to: jid, type: &quot;subscribe&quot; }));</span>
<a href="#l70.1792"></a><span id="l70.1792" class="difflineminus">-  },</span>
<a href="#l70.1793"></a><span id="l70.1793" class="difflineminus">-</span>
<a href="#l70.1794"></a><span id="l70.1794" class="difflineminus">-  /* Loads a buddy from the local storage.</span>
<a href="#l70.1795"></a><span id="l70.1795" class="difflineminus">-   * Called for each buddy locally stored before connecting</span>
<a href="#l70.1796"></a><span id="l70.1796" class="difflineminus">-   * to the server. */</span>
<a href="#l70.1797"></a><span id="l70.1797" class="difflineminus">-  loadBuddy(aBuddy, aTag) {</span>
<a href="#l70.1798"></a><span id="l70.1798" class="difflineminus">-    let buddy = new this._accountBuddyConstructor(this, aBuddy, aTag);</span>
<a href="#l70.1799"></a><span id="l70.1799" class="difflineminus">-    this._buddies.set(buddy.normalizedName, buddy);</span>
<a href="#l70.1800"></a><span id="l70.1800" class="difflineminus">-    return buddy;</span>
<a href="#l70.1801"></a><span id="l70.1801" class="difflineminus">-  },</span>
<a href="#l70.1802"></a><span id="l70.1802" class="difflineminus">-</span>
<a href="#l70.1803"></a><span id="l70.1803" class="difflineminus">-  /* Replies to a buddy request in order to accept it or deny it. */</span>
<a href="#l70.1804"></a><span id="l70.1804" class="difflineminus">-  replyToBuddyRequest(aReply, aRequest) {</span>
<a href="#l70.1805"></a><span id="l70.1805" class="difflineminus">-    if (!this._connection) {</span>
<a href="#l70.1806"></a><span id="l70.1806" class="difflineminus">-      return;</span>
<a href="#l70.1807"></a><span id="l70.1807" class="difflineminus">-    }</span>
<a href="#l70.1808"></a><span id="l70.1808" class="difflineminus">-    let s = Stanza.presence({ to: aRequest.userName, type: aReply });</span>
<a href="#l70.1809"></a><span id="l70.1809" class="difflineminus">-    this.sendStanza(s);</span>
<a href="#l70.1810"></a><span id="l70.1810" class="difflineminus">-    this.removeBuddyRequest(aRequest);</span>
<a href="#l70.1811"></a><span id="l70.1811" class="difflineminus">-  },</span>
<a href="#l70.1812"></a><span id="l70.1812" class="difflineminus">-</span>
<a href="#l70.1813"></a><span id="l70.1813" class="difflineminus">-  requestBuddyInfo(aJid) {</span>
<a href="#l70.1814"></a><span id="l70.1814" class="difflineminus">-    if (!this.connected) {</span>
<a href="#l70.1815"></a><span id="l70.1815" class="difflineminus">-      Services.obs.notifyObservers(EmptyEnumerator, &quot;user-info-received&quot;, aJid);</span>
<a href="#l70.1816"></a><span id="l70.1816" class="difflineminus">-      return;</span>
<a href="#l70.1817"></a><span id="l70.1817" class="difflineminus">-    }</span>
<a href="#l70.1818"></a><span id="l70.1818" class="difflineminus">-</span>
<a href="#l70.1819"></a><span id="l70.1819" class="difflineminus">-    let userName;</span>
<a href="#l70.1820"></a><span id="l70.1820" class="difflineminus">-    let tooltipInfo = [];</span>
<a href="#l70.1821"></a><span id="l70.1821" class="difflineminus">-    let jid = this._parseJID(aJid);</span>
<a href="#l70.1822"></a><span id="l70.1822" class="difflineminus">-    let muc = this._mucs.get(jid.node + &quot;@&quot; + jid.domain);</span>
<a href="#l70.1823"></a><span id="l70.1823" class="difflineminus">-    let participant;</span>
<a href="#l70.1824"></a><span id="l70.1824" class="difflineminus">-    if (muc) {</span>
<a href="#l70.1825"></a><span id="l70.1825" class="difflineminus">-      participant = muc._participants.get(jid.resource);</span>
<a href="#l70.1826"></a><span id="l70.1826" class="difflineminus">-      if (participant) {</span>
<a href="#l70.1827"></a><span id="l70.1827" class="difflineminus">-        if (participant.accountJid) {</span>
<a href="#l70.1828"></a><span id="l70.1828" class="difflineminus">-          userName = participant.accountJid;</span>
<a href="#l70.1829"></a><span id="l70.1829" class="difflineminus">-        }</span>
<a href="#l70.1830"></a><span id="l70.1830" class="difflineminus">-        if (!muc.left) {</span>
<a href="#l70.1831"></a><span id="l70.1831" class="difflineminus">-          let statusType = participant.statusType;</span>
<a href="#l70.1832"></a><span id="l70.1832" class="difflineminus">-          let statusText = participant.statusText;</span>
<a href="#l70.1833"></a><span id="l70.1833" class="difflineminus">-          tooltipInfo.push(</span>
<a href="#l70.1834"></a><span id="l70.1834" class="difflineminus">-            new TooltipInfo(statusType, statusText, Ci.prplITooltipInfo.status)</span>
<a href="#l70.1835"></a><span id="l70.1835" class="difflineminus">-          );</span>
<a href="#l70.1836"></a><span id="l70.1836" class="difflineminus">-</span>
<a href="#l70.1837"></a><span id="l70.1837" class="difflineminus">-          if (participant.buddyIconFilename) {</span>
<a href="#l70.1838"></a><span id="l70.1838" class="difflineminus">-            tooltipInfo.push(</span>
<a href="#l70.1839"></a><span id="l70.1839" class="difflineminus">-              new TooltipInfo(</span>
<a href="#l70.1840"></a><span id="l70.1840" class="difflineminus">-                null,</span>
<a href="#l70.1841"></a><span id="l70.1841" class="difflineminus">-                participant.buddyIconFilename,</span>
<a href="#l70.1842"></a><span id="l70.1842" class="difflineminus">-                Ci.prplITooltipInfo.icon</span>
<a href="#l70.1843"></a><span id="l70.1843" class="difflineminus">-              )</span>
<a href="#l70.1844"></a><span id="l70.1844" class="difflineminus">-            );</span>
<a href="#l70.1845"></a><span id="l70.1845" class="difflineminus">-          }</span>
<a href="#l70.1846"></a><span id="l70.1846" class="difflineminus">-        }</span>
<a href="#l70.1847"></a><span id="l70.1847" class="difflineminus">-      }</span>
<a href="#l70.1848"></a><span id="l70.1848" class="difflineminus">-    }</span>
<a href="#l70.1849"></a><span id="l70.1849" class="difflineminus">-    Services.obs.notifyObservers(</span>
<a href="#l70.1850"></a><span id="l70.1850" class="difflineminus">-      new nsSimpleEnumerator(tooltipInfo),</span>
<a href="#l70.1851"></a><span id="l70.1851" class="difflineminus">-      &quot;user-info-received&quot;,</span>
<a href="#l70.1852"></a><span id="l70.1852" class="difflineminus">-      aJid</span>
<a href="#l70.1853"></a><span id="l70.1853" class="difflineminus">-    );</span>
<a href="#l70.1854"></a><span id="l70.1854" class="difflineminus">-</span>
<a href="#l70.1855"></a><span id="l70.1855" class="difflineminus">-    let iq = Stanza.iq(</span>
<a href="#l70.1856"></a><span id="l70.1856" class="difflineminus">-      &quot;get&quot;,</span>
<a href="#l70.1857"></a><span id="l70.1857" class="difflineminus">-      null,</span>
<a href="#l70.1858"></a><span id="l70.1858" class="difflineminus">-      aJid,</span>
<a href="#l70.1859"></a><span id="l70.1859" class="difflineminus">-      Stanza.node(&quot;vCard&quot;, Stanza.NS.vcard)</span>
<a href="#l70.1860"></a><span id="l70.1860" class="difflineminus">-    );</span>
<a href="#l70.1861"></a><span id="l70.1861" class="difflineminus">-    this.sendStanza(iq, aStanza =&gt; {</span>
<a href="#l70.1862"></a><span id="l70.1862" class="difflineminus">-      let vCardInfo = {};</span>
<a href="#l70.1863"></a><span id="l70.1863" class="difflineminus">-      let vCardNode = aStanza.getElement([&quot;vCard&quot;]);</span>
<a href="#l70.1864"></a><span id="l70.1864" class="difflineminus">-</span>
<a href="#l70.1865"></a><span id="l70.1865" class="difflineminus">-      // In the case of an error response, we just notify the observers with</span>
<a href="#l70.1866"></a><span id="l70.1866" class="difflineminus">-      // what info we already have.</span>
<a href="#l70.1867"></a><span id="l70.1867" class="difflineminus">-      if (aStanza.attributes.type == &quot;result&quot; &amp;&amp; vCardNode) {</span>
<a href="#l70.1868"></a><span id="l70.1868" class="difflineminus">-        vCardInfo = this.parseVCard(vCardNode);</span>
<a href="#l70.1869"></a><span id="l70.1869" class="difflineminus">-      }</span>
<a href="#l70.1870"></a><span id="l70.1870" class="difflineminus">-</span>
<a href="#l70.1871"></a><span id="l70.1871" class="difflineminus">-      // The real jid of participant which is of the form local@domain/resource.</span>
<a href="#l70.1872"></a><span id="l70.1872" class="difflineminus">-      // We consider the jid is provided by server is more correct than jid is</span>
<a href="#l70.1873"></a><span id="l70.1873" class="difflineminus">-      // set by the user.</span>
<a href="#l70.1874"></a><span id="l70.1874" class="difflineminus">-      if (userName) {</span>
<a href="#l70.1875"></a><span id="l70.1875" class="difflineminus">-        vCardInfo.userName = userName;</span>
<a href="#l70.1876"></a><span id="l70.1876" class="difflineminus">-      }</span>
<a href="#l70.1877"></a><span id="l70.1877" class="difflineminus">-</span>
<a href="#l70.1878"></a><span id="l70.1878" class="difflineminus">-      // vCard fields we want to display in the tooltip.</span>
<a href="#l70.1879"></a><span id="l70.1879" class="difflineminus">-      const kTooltipFields = [</span>
<a href="#l70.1880"></a><span id="l70.1880" class="difflineminus">-        &quot;userName&quot;,</span>
<a href="#l70.1881"></a><span id="l70.1881" class="difflineminus">-        &quot;fullName&quot;,</span>
<a href="#l70.1882"></a><span id="l70.1882" class="difflineminus">-        &quot;nickname&quot;,</span>
<a href="#l70.1883"></a><span id="l70.1883" class="difflineminus">-        &quot;title&quot;,</span>
<a href="#l70.1884"></a><span id="l70.1884" class="difflineminus">-        &quot;organization&quot;,</span>
<a href="#l70.1885"></a><span id="l70.1885" class="difflineminus">-        &quot;email&quot;,</span>
<a href="#l70.1886"></a><span id="l70.1886" class="difflineminus">-        &quot;birthday&quot;,</span>
<a href="#l70.1887"></a><span id="l70.1887" class="difflineminus">-        &quot;locality&quot;,</span>
<a href="#l70.1888"></a><span id="l70.1888" class="difflineminus">-        &quot;country&quot;,</span>
<a href="#l70.1889"></a><span id="l70.1889" class="difflineminus">-        &quot;telephone&quot;,</span>
<a href="#l70.1890"></a><span id="l70.1890" class="difflineminus">-      ];</span>
<a href="#l70.1891"></a><span id="l70.1891" class="difflineminus">-</span>
<a href="#l70.1892"></a><span id="l70.1892" class="difflineminus">-      let tooltipInfo = [];</span>
<a href="#l70.1893"></a><span id="l70.1893" class="difflineminus">-      for (let field of kTooltipFields) {</span>
<a href="#l70.1894"></a><span id="l70.1894" class="difflineminus">-        if (vCardInfo.hasOwnProperty(field)) {</span>
<a href="#l70.1895"></a><span id="l70.1895" class="difflineminus">-          tooltipInfo.push(</span>
<a href="#l70.1896"></a><span id="l70.1896" class="difflineminus">-            new TooltipInfo(_(&quot;tooltip.&quot; + field), vCardInfo[field])</span>
<a href="#l70.1897"></a><span id="l70.1897" class="difflineminus">-          );</span>
<a href="#l70.1898"></a><span id="l70.1898" class="difflineminus">-        }</span>
<a href="#l70.1899"></a><span id="l70.1899" class="difflineminus">-      }</span>
<a href="#l70.1900"></a><span id="l70.1900" class="difflineminus">-      if (vCardInfo.photo) {</span>
<a href="#l70.1901"></a><span id="l70.1901" class="difflineminus">-        let dataURI = this._getPhotoURI(vCardInfo.photo);</span>
<a href="#l70.1902"></a><span id="l70.1902" class="difflineminus">-</span>
<a href="#l70.1903"></a><span id="l70.1903" class="difflineminus">-        // Store the photo URI for this participant.</span>
<a href="#l70.1904"></a><span id="l70.1904" class="difflineminus">-        if (participant) {</span>
<a href="#l70.1905"></a><span id="l70.1905" class="difflineminus">-          participant.buddyIconFilename = dataURI;</span>
<a href="#l70.1906"></a><span id="l70.1906" class="difflineminus">-        }</span>
<a href="#l70.1907"></a><span id="l70.1907" class="difflineminus">-</span>
<a href="#l70.1908"></a><span id="l70.1908" class="difflineminus">-        tooltipInfo.push(</span>
<a href="#l70.1909"></a><span id="l70.1909" class="difflineminus">-          new TooltipInfo(null, dataURI, Ci.prplITooltipInfo.icon)</span>
<a href="#l70.1910"></a><span id="l70.1910" class="difflineminus">-        );</span>
<a href="#l70.1911"></a><span id="l70.1911" class="difflineminus">-      }</span>
<a href="#l70.1912"></a><span id="l70.1912" class="difflineminus">-      Services.obs.notifyObservers(</span>
<a href="#l70.1913"></a><span id="l70.1913" class="difflineminus">-        new nsSimpleEnumerator(tooltipInfo),</span>
<a href="#l70.1914"></a><span id="l70.1914" class="difflineminus">-        &quot;user-info-received&quot;,</span>
<a href="#l70.1915"></a><span id="l70.1915" class="difflineminus">-        aJid</span>
<a href="#l70.1916"></a><span id="l70.1916" class="difflineminus">-      );</span>
<a href="#l70.1917"></a><span id="l70.1917" class="difflineminus">-    });</span>
<a href="#l70.1918"></a><span id="l70.1918" class="difflineminus">-  },</span>
<a href="#l70.1919"></a><span id="l70.1919" class="difflineminus">-</span>
<a href="#l70.1920"></a><span id="l70.1920" class="difflineminus">-  // Parses the photo node of a received vCard if exists and returns string of</span>
<a href="#l70.1921"></a><span id="l70.1921" class="difflineminus">-  // data URI, otherwise returns null.</span>
<a href="#l70.1922"></a><span id="l70.1922" class="difflineminus">-  _getPhotoURI(aPhotoNode) {</span>
<a href="#l70.1923"></a><span id="l70.1923" class="difflineminus">-    if (!aPhotoNode) {</span>
<a href="#l70.1924"></a><span id="l70.1924" class="difflineminus">-      return null;</span>
<a href="#l70.1925"></a><span id="l70.1925" class="difflineminus">-    }</span>
<a href="#l70.1926"></a><span id="l70.1926" class="difflineminus">-</span>
<a href="#l70.1927"></a><span id="l70.1927" class="difflineminus">-    let type = aPhotoNode.getElement([&quot;TYPE&quot;]);</span>
<a href="#l70.1928"></a><span id="l70.1928" class="difflineminus">-    let value = aPhotoNode.getElement([&quot;BINVAL&quot;]);</span>
<a href="#l70.1929"></a><span id="l70.1929" class="difflineminus">-    if (!type || !value) {</span>
<a href="#l70.1930"></a><span id="l70.1930" class="difflineminus">-      return null;</span>
<a href="#l70.1931"></a><span id="l70.1931" class="difflineminus">-    }</span>
<a href="#l70.1932"></a><span id="l70.1932" class="difflineminus">-</span>
<a href="#l70.1933"></a><span id="l70.1933" class="difflineminus">-    return &quot;data:&quot; + type.innerText + &quot;;base64,&quot; + value.innerText;</span>
<a href="#l70.1934"></a><span id="l70.1934" class="difflineminus">-  },</span>
<a href="#l70.1935"></a><span id="l70.1935" class="difflineminus">-</span>
<a href="#l70.1936"></a><span id="l70.1936" class="difflineminus">-  // Parses the vCard into the properties of the returned object.</span>
<a href="#l70.1937"></a><span id="l70.1937" class="difflineminus">-  parseVCard(aVCardNode) {</span>
<a href="#l70.1938"></a><span id="l70.1938" class="difflineminus">-    // XEP-0054: vcard-temp.</span>
<a href="#l70.1939"></a><span id="l70.1939" class="difflineminus">-    let aResult = {};</span>
<a href="#l70.1940"></a><span id="l70.1940" class="difflineminus">-    for (let node of aVCardNode.children.filter(</span>
<a href="#l70.1941"></a><span id="l70.1941" class="difflineminus">-      child =&gt; child.type == &quot;node&quot;</span>
<a href="#l70.1942"></a><span id="l70.1942" class="difflineminus">-    )) {</span>
<a href="#l70.1943"></a><span id="l70.1943" class="difflineminus">-      let localName = node.localName;</span>
<a href="#l70.1944"></a><span id="l70.1944" class="difflineminus">-      let innerText = node.innerText;</span>
<a href="#l70.1945"></a><span id="l70.1945" class="difflineminus">-      if (innerText) {</span>
<a href="#l70.1946"></a><span id="l70.1946" class="difflineminus">-        if (localName == &quot;FN&quot;) {</span>
<a href="#l70.1947"></a><span id="l70.1947" class="difflineminus">-          aResult.fullName = innerText;</span>
<a href="#l70.1948"></a><span id="l70.1948" class="difflineminus">-        } else if (localName == &quot;NICKNAME&quot;) {</span>
<a href="#l70.1949"></a><span id="l70.1949" class="difflineminus">-          aResult.nickname = innerText;</span>
<a href="#l70.1950"></a><span id="l70.1950" class="difflineminus">-        } else if (localName == &quot;TITLE&quot;) {</span>
<a href="#l70.1951"></a><span id="l70.1951" class="difflineminus">-          aResult.title = innerText;</span>
<a href="#l70.1952"></a><span id="l70.1952" class="difflineminus">-        } else if (localName == &quot;BDAY&quot;) {</span>
<a href="#l70.1953"></a><span id="l70.1953" class="difflineminus">-          aResult.birthday = innerText;</span>
<a href="#l70.1954"></a><span id="l70.1954" class="difflineminus">-        } else if (localName == &quot;JABBERID&quot;) {</span>
<a href="#l70.1955"></a><span id="l70.1955" class="difflineminus">-          aResult.userName = innerText;</span>
<a href="#l70.1956"></a><span id="l70.1956" class="difflineminus">-        }</span>
<a href="#l70.1957"></a><span id="l70.1957" class="difflineminus">-      }</span>
<a href="#l70.1958"></a><span id="l70.1958" class="difflineminus">-      if (localName == &quot;ORG&quot;) {</span>
<a href="#l70.1959"></a><span id="l70.1959" class="difflineminus">-        let organization = node.getElement([&quot;ORGNAME&quot;]);</span>
<a href="#l70.1960"></a><span id="l70.1960" class="difflineminus">-        if (organization &amp;&amp; organization.innerText) {</span>
<a href="#l70.1961"></a><span id="l70.1961" class="difflineminus">-          aResult.organization = organization.innerText;</span>
<a href="#l70.1962"></a><span id="l70.1962" class="difflineminus">-        }</span>
<a href="#l70.1963"></a><span id="l70.1963" class="difflineminus">-      } else if (localName == &quot;EMAIL&quot;) {</span>
<a href="#l70.1964"></a><span id="l70.1964" class="difflineminus">-        let userID = node.getElement([&quot;USERID&quot;]);</span>
<a href="#l70.1965"></a><span id="l70.1965" class="difflineminus">-        if (userID &amp;&amp; userID.innerText) {</span>
<a href="#l70.1966"></a><span id="l70.1966" class="difflineminus">-          aResult.email = userID.innerText;</span>
<a href="#l70.1967"></a><span id="l70.1967" class="difflineminus">-        }</span>
<a href="#l70.1968"></a><span id="l70.1968" class="difflineminus">-      } else if (localName == &quot;ADR&quot;) {</span>
<a href="#l70.1969"></a><span id="l70.1969" class="difflineminus">-        let locality = node.getElement([&quot;LOCALITY&quot;]);</span>
<a href="#l70.1970"></a><span id="l70.1970" class="difflineminus">-        if (locality &amp;&amp; locality.innerText) {</span>
<a href="#l70.1971"></a><span id="l70.1971" class="difflineminus">-          aResult.locality = locality.innerText;</span>
<a href="#l70.1972"></a><span id="l70.1972" class="difflineminus">-        }</span>
<a href="#l70.1973"></a><span id="l70.1973" class="difflineminus">-</span>
<a href="#l70.1974"></a><span id="l70.1974" class="difflineminus">-        let country = node.getElement([&quot;CTRY&quot;]);</span>
<a href="#l70.1975"></a><span id="l70.1975" class="difflineminus">-        if (country &amp;&amp; country.innerText) {</span>
<a href="#l70.1976"></a><span id="l70.1976" class="difflineminus">-          aResult.country = country.innerText;</span>
<a href="#l70.1977"></a><span id="l70.1977" class="difflineminus">-        }</span>
<a href="#l70.1978"></a><span id="l70.1978" class="difflineminus">-      } else if (localName == &quot;PHOTO&quot;) {</span>
<a href="#l70.1979"></a><span id="l70.1979" class="difflineminus">-        aResult.photo = node;</span>
<a href="#l70.1980"></a><span id="l70.1980" class="difflineminus">-      } else if (localName == &quot;TEL&quot;) {</span>
<a href="#l70.1981"></a><span id="l70.1981" class="difflineminus">-        let number = node.getElement([&quot;NUMBER&quot;]);</span>
<a href="#l70.1982"></a><span id="l70.1982" class="difflineminus">-        if (number &amp;&amp; number.innerText) {</span>
<a href="#l70.1983"></a><span id="l70.1983" class="difflineminus">-          aResult.telephone = number.innerText;</span>
<a href="#l70.1984"></a><span id="l70.1984" class="difflineminus">-        }</span>
<a href="#l70.1985"></a><span id="l70.1985" class="difflineminus">-      }</span>
<a href="#l70.1986"></a><span id="l70.1986" class="difflineminus">-      // TODO: Parse the other fields of vCard and display it in system messages</span>
<a href="#l70.1987"></a><span id="l70.1987" class="difflineminus">-      // in response to /whois.</span>
<a href="#l70.1988"></a><span id="l70.1988" class="difflineminus">-    }</span>
<a href="#l70.1989"></a><span id="l70.1989" class="difflineminus">-    return aResult;</span>
<a href="#l70.1990"></a><span id="l70.1990" class="difflineminus">-  },</span>
<a href="#l70.1991"></a><span id="l70.1991" class="difflineminus">-</span>
<a href="#l70.1992"></a><span id="l70.1992" class="difflineminus">-  // Returns undefined if not an error stanza, and an object</span>
<a href="#l70.1993"></a><span id="l70.1993" class="difflineminus">-  // describing the error otherwise:</span>
<a href="#l70.1994"></a><span id="l70.1994" class="difflineminus">-  parseError(aStanza) {</span>
<a href="#l70.1995"></a><span id="l70.1995" class="difflineminus">-    if (aStanza.attributes.type != &quot;error&quot;) {</span>
<a href="#l70.1996"></a><span id="l70.1996" class="difflineminus">-      return undefined;</span>
<a href="#l70.1997"></a><span id="l70.1997" class="difflineminus">-    }</span>
<a href="#l70.1998"></a><span id="l70.1998" class="difflineminus">-</span>
<a href="#l70.1999"></a><span id="l70.1999" class="difflineminus">-    let retval = { stanza: aStanza };</span>
<a href="#l70.2000"></a><span id="l70.2000" class="difflineminus">-    let error = aStanza.getElement([&quot;error&quot;]);</span>
<a href="#l70.2001"></a><span id="l70.2001" class="difflineminus">-</span>
<a href="#l70.2002"></a><span id="l70.2002" class="difflineminus">-    // RFC 6120 Section 8.3.2: Type must be one of</span>
<a href="#l70.2003"></a><span id="l70.2003" class="difflineminus">-    // auth -- retry after providing credentials</span>
<a href="#l70.2004"></a><span id="l70.2004" class="difflineminus">-    // cancel -- do not retry (the error cannot be remedied)</span>
<a href="#l70.2005"></a><span id="l70.2005" class="difflineminus">-    // continue -- proceed (the condition was only a warning)</span>
<a href="#l70.2006"></a><span id="l70.2006" class="difflineminus">-    // modify -- retry after changing the data sent</span>
<a href="#l70.2007"></a><span id="l70.2007" class="difflineminus">-    // wait -- retry after waiting (the error is temporary).</span>
<a href="#l70.2008"></a><span id="l70.2008" class="difflineminus">-    retval.type = error.attributes.type;</span>
<a href="#l70.2009"></a><span id="l70.2009" class="difflineminus">-</span>
<a href="#l70.2010"></a><span id="l70.2010" class="difflineminus">-    // RFC 6120 Section 8.3.3.</span>
<a href="#l70.2011"></a><span id="l70.2011" class="difflineminus">-    const kDefinedConditions = [</span>
<a href="#l70.2012"></a><span id="l70.2012" class="difflineminus">-      &quot;bad-request&quot;,</span>
<a href="#l70.2013"></a><span id="l70.2013" class="difflineminus">-      &quot;conflict&quot;,</span>
<a href="#l70.2014"></a><span id="l70.2014" class="difflineminus">-      &quot;feature-not-implemented&quot;,</span>
<a href="#l70.2015"></a><span id="l70.2015" class="difflineminus">-      &quot;forbidden&quot;,</span>
<a href="#l70.2016"></a><span id="l70.2016" class="difflineminus">-      &quot;gone&quot;,</span>
<a href="#l70.2017"></a><span id="l70.2017" class="difflineminus">-      &quot;internal-server-error&quot;,</span>
<a href="#l70.2018"></a><span id="l70.2018" class="difflineminus">-      &quot;item-not-found&quot;,</span>
<a href="#l70.2019"></a><span id="l70.2019" class="difflineminus">-      &quot;jid-malformed&quot;,</span>
<a href="#l70.2020"></a><span id="l70.2020" class="difflineminus">-      &quot;not-acceptable&quot;,</span>
<a href="#l70.2021"></a><span id="l70.2021" class="difflineminus">-      &quot;not-allowed&quot;,</span>
<a href="#l70.2022"></a><span id="l70.2022" class="difflineminus">-      &quot;not-authorized&quot;,</span>
<a href="#l70.2023"></a><span id="l70.2023" class="difflineminus">-      &quot;policy-violation&quot;,</span>
<a href="#l70.2024"></a><span id="l70.2024" class="difflineminus">-      &quot;recipient-unavailable&quot;,</span>
<a href="#l70.2025"></a><span id="l70.2025" class="difflineminus">-      &quot;redirect&quot;,</span>
<a href="#l70.2026"></a><span id="l70.2026" class="difflineminus">-      &quot;registration-required&quot;,</span>
<a href="#l70.2027"></a><span id="l70.2027" class="difflineminus">-      &quot;remote-server-not-found&quot;,</span>
<a href="#l70.2028"></a><span id="l70.2028" class="difflineminus">-      &quot;remote-server-timeout&quot;,</span>
<a href="#l70.2029"></a><span id="l70.2029" class="difflineminus">-      &quot;resource-constraint&quot;,</span>
<a href="#l70.2030"></a><span id="l70.2030" class="difflineminus">-      &quot;service-unavailable&quot;,</span>
<a href="#l70.2031"></a><span id="l70.2031" class="difflineminus">-      &quot;subscription-required&quot;,</span>
<a href="#l70.2032"></a><span id="l70.2032" class="difflineminus">-      &quot;undefined-condition&quot;,</span>
<a href="#l70.2033"></a><span id="l70.2033" class="difflineminus">-      &quot;unexpected-request&quot;,</span>
<a href="#l70.2034"></a><span id="l70.2034" class="difflineminus">-    ];</span>
<a href="#l70.2035"></a><span id="l70.2035" class="difflineminus">-    let condition = kDefinedConditions.find(c =&gt; error.getElement([c]));</span>
<a href="#l70.2036"></a><span id="l70.2036" class="difflineminus">-    if (!condition) {</span>
<a href="#l70.2037"></a><span id="l70.2037" class="difflineminus">-      // RFC 6120 Section 8.3.2.</span>
<a href="#l70.2038"></a><span id="l70.2038" class="difflineminus">-      this.WARN(</span>
<a href="#l70.2039"></a><span id="l70.2039" class="difflineminus">-        &quot;Nonstandard or missing defined-condition element in error stanza.&quot;</span>
<a href="#l70.2040"></a><span id="l70.2040" class="difflineminus">-      );</span>
<a href="#l70.2041"></a><span id="l70.2041" class="difflineminus">-      condition = &quot;undefined-condition&quot;;</span>
<a href="#l70.2042"></a><span id="l70.2042" class="difflineminus">-    }</span>
<a href="#l70.2043"></a><span id="l70.2043" class="difflineminus">-    retval.condition = condition;</span>
<a href="#l70.2044"></a><span id="l70.2044" class="difflineminus">-</span>
<a href="#l70.2045"></a><span id="l70.2045" class="difflineminus">-    let errortext = error.getElement([&quot;text&quot;]);</span>
<a href="#l70.2046"></a><span id="l70.2046" class="difflineminus">-    if (errortext) {</span>
<a href="#l70.2047"></a><span id="l70.2047" class="difflineminus">-      retval.text = errortext.innerText;</span>
<a href="#l70.2048"></a><span id="l70.2048" class="difflineminus">-    }</span>
<a href="#l70.2049"></a><span id="l70.2049" class="difflineminus">-</span>
<a href="#l70.2050"></a><span id="l70.2050" class="difflineminus">-    return retval;</span>
<a href="#l70.2051"></a><span id="l70.2051" class="difflineminus">-  },</span>
<a href="#l70.2052"></a><span id="l70.2052" class="difflineminus">-</span>
<a href="#l70.2053"></a><span id="l70.2053" class="difflineminus">-  // Returns an error-handling callback for use with sendStanza generated</span>
<a href="#l70.2054"></a><span id="l70.2054" class="difflineminus">-  // from aHandlers, an object defining the error handlers.</span>
<a href="#l70.2055"></a><span id="l70.2055" class="difflineminus">-  // If the stanza passed to the callback is an error stanza, it checks if</span>
<a href="#l70.2056"></a><span id="l70.2056" class="difflineminus">-  // aHandlers contains a property with the name of the defined condition</span>
<a href="#l70.2057"></a><span id="l70.2057" class="difflineminus">-  // of the error.</span>
<a href="#l70.2058"></a><span id="l70.2058" class="difflineminus">-  // * If the property is a function, it is called with the parsed error</span>
<a href="#l70.2059"></a><span id="l70.2059" class="difflineminus">-  //   as its argument, bound to aThis (if provided).</span>
<a href="#l70.2060"></a><span id="l70.2060" class="difflineminus">-  //   It should return true if the error was handled.</span>
<a href="#l70.2061"></a><span id="l70.2061" class="difflineminus">-  // * If the property is a string, it is displayed as a system message</span>
<a href="#l70.2062"></a><span id="l70.2062" class="difflineminus">-  //   in the conversation given by aThis.</span>
<a href="#l70.2063"></a><span id="l70.2063" class="difflineminus">-  handleErrors(aHandlers, aThis) {</span>
<a href="#l70.2064"></a><span id="l70.2064" class="difflineminus">-    return aStanza =&gt; {</span>
<a href="#l70.2065"></a><span id="l70.2065" class="difflineminus">-      if (!aHandlers) {</span>
<a href="#l70.2066"></a><span id="l70.2066" class="difflineminus">-        return false;</span>
<a href="#l70.2067"></a><span id="l70.2067" class="difflineminus">-      }</span>
<a href="#l70.2068"></a><span id="l70.2068" class="difflineminus">-</span>
<a href="#l70.2069"></a><span id="l70.2069" class="difflineminus">-      let error = this.parseError(aStanza);</span>
<a href="#l70.2070"></a><span id="l70.2070" class="difflineminus">-      if (!error) {</span>
<a href="#l70.2071"></a><span id="l70.2071" class="difflineminus">-        return false;</span>
<a href="#l70.2072"></a><span id="l70.2072" class="difflineminus">-      }</span>
<a href="#l70.2073"></a><span id="l70.2073" class="difflineminus">-</span>
<a href="#l70.2074"></a><span id="l70.2074" class="difflineminus">-      let toCamelCase = aStr =&gt; {</span>
<a href="#l70.2075"></a><span id="l70.2075" class="difflineminus">-        // Turn defined condition string into a valid camelcase</span>
<a href="#l70.2076"></a><span id="l70.2076" class="difflineminus">-        // JS property name.</span>
<a href="#l70.2077"></a><span id="l70.2077" class="difflineminus">-        let capitalize = s =&gt; s[0].toUpperCase() + s.slice(1);</span>
<a href="#l70.2078"></a><span id="l70.2078" class="difflineminus">-        let uncapitalize = s =&gt; s[0].toLowerCase() + s.slice(1);</span>
<a href="#l70.2079"></a><span id="l70.2079" class="difflineminus">-        return uncapitalize(</span>
<a href="#l70.2080"></a><span id="l70.2080" class="difflineminus">-          aStr</span>
<a href="#l70.2081"></a><span id="l70.2081" class="difflineminus">-            .split(&quot;-&quot;)</span>
<a href="#l70.2082"></a><span id="l70.2082" class="difflineminus">-            .map(capitalize)</span>
<a href="#l70.2083"></a><span id="l70.2083" class="difflineminus">-            .join(&quot;&quot;)</span>
<a href="#l70.2084"></a><span id="l70.2084" class="difflineminus">-        );</span>
<a href="#l70.2085"></a><span id="l70.2085" class="difflineminus">-      };</span>
<a href="#l70.2086"></a><span id="l70.2086" class="difflineminus">-      let condition = toCamelCase(error.condition);</span>
<a href="#l70.2087"></a><span id="l70.2087" class="difflineminus">-      // Check if we have a handler property for this kind of error or a</span>
<a href="#l70.2088"></a><span id="l70.2088" class="difflineminus">-      // default handler.</span>
<a href="#l70.2089"></a><span id="l70.2089" class="difflineminus">-      if (!(condition in aHandlers) &amp;&amp; !(&quot;default&quot; in aHandlers)) {</span>
<a href="#l70.2090"></a><span id="l70.2090" class="difflineminus">-        return false;</span>
<a href="#l70.2091"></a><span id="l70.2091" class="difflineminus">-      }</span>
<a href="#l70.2092"></a><span id="l70.2092" class="difflineminus">-</span>
<a href="#l70.2093"></a><span id="l70.2093" class="difflineminus">-      // Try to get the handler for condition, if we cannot get it, try to get</span>
<a href="#l70.2094"></a><span id="l70.2094" class="difflineminus">-      // the default handler.</span>
<a href="#l70.2095"></a><span id="l70.2095" class="difflineminus">-      let handler = aHandlers[condition];</span>
<a href="#l70.2096"></a><span id="l70.2096" class="difflineminus">-      if (!handler) {</span>
<a href="#l70.2097"></a><span id="l70.2097" class="difflineminus">-        handler = aHandlers.default;</span>
<a href="#l70.2098"></a><span id="l70.2098" class="difflineminus">-      }</span>
<a href="#l70.2099"></a><span id="l70.2099" class="difflineminus">-</span>
<a href="#l70.2100"></a><span id="l70.2100" class="difflineminus">-      if (typeof handler == &quot;string&quot;) {</span>
<a href="#l70.2101"></a><span id="l70.2101" class="difflineminus">-        // The string is an error message to be displayed in the conversation.</span>
<a href="#l70.2102"></a><span id="l70.2102" class="difflineminus">-        if (!aThis || !aThis.writeMessage) {</span>
<a href="#l70.2103"></a><span id="l70.2103" class="difflineminus">-          this.ERROR(</span>
<a href="#l70.2104"></a><span id="l70.2104" class="difflineminus">-            &quot;HandleErrors was passed an error message string, but &quot; +</span>
<a href="#l70.2105"></a><span id="l70.2105" class="difflineminus">-              &quot;no conversation to display it in:\n&quot; +</span>
<a href="#l70.2106"></a><span id="l70.2106" class="difflineminus">-              handler</span>
<a href="#l70.2107"></a><span id="l70.2107" class="difflineminus">-          );</span>
<a href="#l70.2108"></a><span id="l70.2108" class="difflineminus">-          return true;</span>
<a href="#l70.2109"></a><span id="l70.2109" class="difflineminus">-        }</span>
<a href="#l70.2110"></a><span id="l70.2110" class="difflineminus">-        aThis.writeMessage(aThis.name, handler, { system: true, error: true });</span>
<a href="#l70.2111"></a><span id="l70.2111" class="difflineminus">-        return true;</span>
<a href="#l70.2112"></a><span id="l70.2112" class="difflineminus">-      } else if (typeof handler == &quot;function&quot;) {</span>
<a href="#l70.2113"></a><span id="l70.2113" class="difflineminus">-        // If we're given a function, call this error handler.</span>
<a href="#l70.2114"></a><span id="l70.2114" class="difflineminus">-        return handler.call(aThis, error);</span>
<a href="#l70.2115"></a><span id="l70.2115" class="difflineminus">-      }</span>
<a href="#l70.2116"></a><span id="l70.2116" class="difflineminus">-</span>
<a href="#l70.2117"></a><span id="l70.2117" class="difflineminus">-      // If this happens, there's a bug somewhere.</span>
<a href="#l70.2118"></a><span id="l70.2118" class="difflineminus">-      this.ERROR(</span>
<a href="#l70.2119"></a><span id="l70.2119" class="difflineminus">-        &quot;HandleErrors was passed a handler for '&quot; +</span>
<a href="#l70.2120"></a><span id="l70.2120" class="difflineminus">-          condition +</span>
<a href="#l70.2121"></a><span id="l70.2121" class="difflineminus">-          &quot;'' which is neither a function nor a string.&quot;</span>
<a href="#l70.2122"></a><span id="l70.2122" class="difflineminus">-      );</span>
<a href="#l70.2123"></a><span id="l70.2123" class="difflineminus">-      return false;</span>
<a href="#l70.2124"></a><span id="l70.2124" class="difflineminus">-    };</span>
<a href="#l70.2125"></a><span id="l70.2125" class="difflineminus">-  },</span>
<a href="#l70.2126"></a><span id="l70.2126" class="difflineminus">-</span>
<a href="#l70.2127"></a><span id="l70.2127" class="difflineminus">-  // Returns a callback suitable for use in sendStanza, to handle type==result</span>
<a href="#l70.2128"></a><span id="l70.2128" class="difflineminus">-  // responses. aHandlers and aThis are passed on to handleErrors for error</span>
<a href="#l70.2129"></a><span id="l70.2129" class="difflineminus">-  // handling.</span>
<a href="#l70.2130"></a><span id="l70.2130" class="difflineminus">-  _handleResult(aHandlers, aThis) {</span>
<a href="#l70.2131"></a><span id="l70.2131" class="difflineminus">-    return aStanza =&gt; {</span>
<a href="#l70.2132"></a><span id="l70.2132" class="difflineminus">-      if (aStanza.attributes.type == &quot;result&quot;) {</span>
<a href="#l70.2133"></a><span id="l70.2133" class="difflineminus">-        return true;</span>
<a href="#l70.2134"></a><span id="l70.2134" class="difflineminus">-      }</span>
<a href="#l70.2135"></a><span id="l70.2135" class="difflineminus">-      return this.handleErrors(aHandlers, aThis)(aStanza);</span>
<a href="#l70.2136"></a><span id="l70.2136" class="difflineminus">-    };</span>
<a href="#l70.2137"></a><span id="l70.2137" class="difflineminus">-  },</span>
<a href="#l70.2138"></a><span id="l70.2138" class="difflineminus">-</span>
<a href="#l70.2139"></a><span id="l70.2139" class="difflineminus">-  /* XMPPSession events */</span>
<a href="#l70.2140"></a><span id="l70.2140" class="difflineminus">-</span>
<a href="#l70.2141"></a><span id="l70.2141" class="difflineminus">-  /* Called when the XMPP session is started */</span>
<a href="#l70.2142"></a><span id="l70.2142" class="difflineminus">-  onConnection() {</span>
<a href="#l70.2143"></a><span id="l70.2143" class="difflineminus">-    // Request the roster. The account will be marked as connected when this is</span>
<a href="#l70.2144"></a><span id="l70.2144" class="difflineminus">-    // complete.</span>
<a href="#l70.2145"></a><span id="l70.2145" class="difflineminus">-    this.reportConnecting(_(&quot;connection.downloadingRoster&quot;));</span>
<a href="#l70.2146"></a><span id="l70.2146" class="difflineminus">-    let s = Stanza.iq(</span>
<a href="#l70.2147"></a><span id="l70.2147" class="difflineminus">-      &quot;get&quot;,</span>
<a href="#l70.2148"></a><span id="l70.2148" class="difflineminus">-      null,</span>
<a href="#l70.2149"></a><span id="l70.2149" class="difflineminus">-      null,</span>
<a href="#l70.2150"></a><span id="l70.2150" class="difflineminus">-      Stanza.node(&quot;query&quot;, Stanza.NS.roster)</span>
<a href="#l70.2151"></a><span id="l70.2151" class="difflineminus">-    );</span>
<a href="#l70.2152"></a><span id="l70.2152" class="difflineminus">-    this.sendStanza(s, this.onRoster, this);</span>
<a href="#l70.2153"></a><span id="l70.2153" class="difflineminus">-</span>
<a href="#l70.2154"></a><span id="l70.2154" class="difflineminus">-    // XEP-0030 and XEP-0045 (6): Service Discovery.</span>
<a href="#l70.2155"></a><span id="l70.2155" class="difflineminus">-    // Queries Server for Associated Services.</span>
<a href="#l70.2156"></a><span id="l70.2156" class="difflineminus">-    let iq = Stanza.iq(</span>
<a href="#l70.2157"></a><span id="l70.2157" class="difflineminus">-      &quot;get&quot;,</span>
<a href="#l70.2158"></a><span id="l70.2158" class="difflineminus">-      null,</span>
<a href="#l70.2159"></a><span id="l70.2159" class="difflineminus">-      this._jid.domain,</span>
<a href="#l70.2160"></a><span id="l70.2160" class="difflineminus">-      Stanza.node(&quot;query&quot;, Stanza.NS.disco_items)</span>
<a href="#l70.2161"></a><span id="l70.2161" class="difflineminus">-    );</span>
<a href="#l70.2162"></a><span id="l70.2162" class="difflineminus">-    this.sendStanza(iq, this.onServiceDiscovery, this);</span>
<a href="#l70.2163"></a><span id="l70.2163" class="difflineminus">-</span>
<a href="#l70.2164"></a><span id="l70.2164" class="difflineminus">-    // XEP-0030: Service Discovery Information Features.</span>
<a href="#l70.2165"></a><span id="l70.2165" class="difflineminus">-    iq = Stanza.iq(</span>
<a href="#l70.2166"></a><span id="l70.2166" class="difflineminus">-      &quot;get&quot;,</span>
<a href="#l70.2167"></a><span id="l70.2167" class="difflineminus">-      null,</span>
<a href="#l70.2168"></a><span id="l70.2168" class="difflineminus">-      this._jid.domain,</span>
<a href="#l70.2169"></a><span id="l70.2169" class="difflineminus">-      Stanza.node(&quot;query&quot;, Stanza.NS.disco_info)</span>
<a href="#l70.2170"></a><span id="l70.2170" class="difflineminus">-    );</span>
<a href="#l70.2171"></a><span id="l70.2171" class="difflineminus">-    this.sendStanza(iq, this.onServiceDiscoveryInfo, this);</span>
<a href="#l70.2172"></a><span id="l70.2172" class="difflineminus">-  },</span>
<a href="#l70.2173"></a><span id="l70.2173" class="difflineminus">-</span>
<a href="#l70.2174"></a><span id="l70.2174" class="difflineminus">-  /* Called whenever a stanza is received */</span>
<a href="#l70.2175"></a><span id="l70.2175" class="difflineminus">-  onXmppStanza(aStanza) {},</span>
<a href="#l70.2176"></a><span id="l70.2176" class="difflineminus">-</span>
<a href="#l70.2177"></a><span id="l70.2177" class="difflineminus">-  /* Called when a iq stanza is received */</span>
<a href="#l70.2178"></a><span id="l70.2178" class="difflineminus">-  onIQStanza(aStanza) {</span>
<a href="#l70.2179"></a><span id="l70.2179" class="difflineminus">-    let type = aStanza.attributes.type;</span>
<a href="#l70.2180"></a><span id="l70.2180" class="difflineminus">-    if (type == &quot;set&quot;) {</span>
<a href="#l70.2181"></a><span id="l70.2181" class="difflineminus">-      for (let query of aStanza.getChildren(&quot;query&quot;)) {</span>
<a href="#l70.2182"></a><span id="l70.2182" class="difflineminus">-        if (query.uri != Stanza.NS.roster) {</span>
<a href="#l70.2183"></a><span id="l70.2183" class="difflineminus">-          continue;</span>
<a href="#l70.2184"></a><span id="l70.2184" class="difflineminus">-        }</span>
<a href="#l70.2185"></a><span id="l70.2185" class="difflineminus">-</span>
<a href="#l70.2186"></a><span id="l70.2186" class="difflineminus">-        // RFC 6121 2.1.6 (Roster push):</span>
<a href="#l70.2187"></a><span id="l70.2187" class="difflineminus">-        // A receiving client MUST ignore the stanza unless it has no 'from'</span>
<a href="#l70.2188"></a><span id="l70.2188" class="difflineminus">-        // attribute (i.e., implicitly from the bare JID of the user's</span>
<a href="#l70.2189"></a><span id="l70.2189" class="difflineminus">-        // account) or it has a 'from' attribute whose value matches the</span>
<a href="#l70.2190"></a><span id="l70.2190" class="difflineminus">-        // user's bare JID &lt;user@domainpart&gt;.</span>
<a href="#l70.2191"></a><span id="l70.2191" class="difflineminus">-        let from = aStanza.attributes.from;</span>
<a href="#l70.2192"></a><span id="l70.2192" class="difflineminus">-        if (from &amp;&amp; from != this._jid.node + &quot;@&quot; + this._jid.domain) {</span>
<a href="#l70.2193"></a><span id="l70.2193" class="difflineminus">-          this.WARN(&quot;Ignoring potentially spoofed roster push.&quot;);</span>
<a href="#l70.2194"></a><span id="l70.2194" class="difflineminus">-          return;</span>
<a href="#l70.2195"></a><span id="l70.2195" class="difflineminus">-        }</span>
<a href="#l70.2196"></a><span id="l70.2196" class="difflineminus">-</span>
<a href="#l70.2197"></a><span id="l70.2197" class="difflineminus">-        for (let item of query.getChildren(&quot;item&quot;)) {</span>
<a href="#l70.2198"></a><span id="l70.2198" class="difflineminus">-          this._onRosterItem(item, true);</span>
<a href="#l70.2199"></a><span id="l70.2199" class="difflineminus">-        }</span>
<a href="#l70.2200"></a><span id="l70.2200" class="difflineminus">-        return;</span>
<a href="#l70.2201"></a><span id="l70.2201" class="difflineminus">-      }</span>
<a href="#l70.2202"></a><span id="l70.2202" class="difflineminus">-    } else if (type == &quot;get&quot;) {</span>
<a href="#l70.2203"></a><span id="l70.2203" class="difflineminus">-      let id = aStanza.attributes.id;</span>
<a href="#l70.2204"></a><span id="l70.2204" class="difflineminus">-      let from = aStanza.attributes.from;</span>
<a href="#l70.2205"></a><span id="l70.2205" class="difflineminus">-</span>
<a href="#l70.2206"></a><span id="l70.2206" class="difflineminus">-      // XEP-0199: XMPP server-to-client ping (XEP-0199)</span>
<a href="#l70.2207"></a><span id="l70.2207" class="difflineminus">-      let ping = aStanza.getElement([&quot;ping&quot;]);</span>
<a href="#l70.2208"></a><span id="l70.2208" class="difflineminus">-      if (ping &amp;&amp; ping.uri == Stanza.NS.ping) {</span>
<a href="#l70.2209"></a><span id="l70.2209" class="difflineminus">-        if (from == this._jid.domain) {</span>
<a href="#l70.2210"></a><span id="l70.2210" class="difflineminus">-          this.sendStanza(Stanza.iq(&quot;result&quot;, id, this._jid.domain));</span>
<a href="#l70.2211"></a><span id="l70.2211" class="difflineminus">-        }</span>
<a href="#l70.2212"></a><span id="l70.2212" class="difflineminus">-        return;</span>
<a href="#l70.2213"></a><span id="l70.2213" class="difflineminus">-      }</span>
<a href="#l70.2214"></a><span id="l70.2214" class="difflineminus">-</span>
<a href="#l70.2215"></a><span id="l70.2215" class="difflineminus">-      let query = aStanza.getElement([&quot;query&quot;]);</span>
<a href="#l70.2216"></a><span id="l70.2216" class="difflineminus">-      if (query &amp;&amp; query.uri == Stanza.NS.version) {</span>
<a href="#l70.2217"></a><span id="l70.2217" class="difflineminus">-        // XEP-0092: Software Version.</span>
<a href="#l70.2218"></a><span id="l70.2218" class="difflineminus">-        let children = [];</span>
<a href="#l70.2219"></a><span id="l70.2219" class="difflineminus">-        children.push(Stanza.node(&quot;name&quot;, null, null, Services.appinfo.name));</span>
<a href="#l70.2220"></a><span id="l70.2220" class="difflineminus">-        children.push(</span>
<a href="#l70.2221"></a><span id="l70.2221" class="difflineminus">-          Stanza.node(&quot;version&quot;, null, null, Services.appinfo.version)</span>
<a href="#l70.2222"></a><span id="l70.2222" class="difflineminus">-        );</span>
<a href="#l70.2223"></a><span id="l70.2223" class="difflineminus">-        let versionQuery = Stanza.node(</span>
<a href="#l70.2224"></a><span id="l70.2224" class="difflineminus">-          &quot;query&quot;,</span>
<a href="#l70.2225"></a><span id="l70.2225" class="difflineminus">-          Stanza.NS.version,</span>
<a href="#l70.2226"></a><span id="l70.2226" class="difflineminus">-          null,</span>
<a href="#l70.2227"></a><span id="l70.2227" class="difflineminus">-          children</span>
<a href="#l70.2228"></a><span id="l70.2228" class="difflineminus">-        );</span>
<a href="#l70.2229"></a><span id="l70.2229" class="difflineminus">-        this.sendStanza(Stanza.iq(&quot;result&quot;, id, from, versionQuery));</span>
<a href="#l70.2230"></a><span id="l70.2230" class="difflineminus">-        return;</span>
<a href="#l70.2231"></a><span id="l70.2231" class="difflineminus">-      }</span>
<a href="#l70.2232"></a><span id="l70.2232" class="difflineminus">-      if (query &amp;&amp; query.uri == Stanza.NS.disco_info) {</span>
<a href="#l70.2233"></a><span id="l70.2233" class="difflineminus">-        // XEP-0030: Service Discovery.</span>
<a href="#l70.2234"></a><span id="l70.2234" class="difflineminus">-        let children = [];</span>
<a href="#l70.2235"></a><span id="l70.2235" class="difflineminus">-        if (aStanza.attributes.node == Stanza.NS.muc_rooms) {</span>
<a href="#l70.2236"></a><span id="l70.2236" class="difflineminus">-          // XEP-0045 (6.7): Room query.</span>
<a href="#l70.2237"></a><span id="l70.2237" class="difflineminus">-          // TODO: Currently, we return an empty &lt;query/&gt; element, but we</span>
<a href="#l70.2238"></a><span id="l70.2238" class="difflineminus">-          // should return non-private rooms.</span>
<a href="#l70.2239"></a><span id="l70.2239" class="difflineminus">-        } else {</span>
<a href="#l70.2240"></a><span id="l70.2240" class="difflineminus">-          children = SupportedFeatures.map(feature =&gt;</span>
<a href="#l70.2241"></a><span id="l70.2241" class="difflineminus">-            Stanza.node(&quot;feature&quot;, null, { var: feature })</span>
<a href="#l70.2242"></a><span id="l70.2242" class="difflineminus">-          );</span>
<a href="#l70.2243"></a><span id="l70.2243" class="difflineminus">-          children.unshift(</span>
<a href="#l70.2244"></a><span id="l70.2244" class="difflineminus">-            Stanza.node(&quot;identity&quot;, null, {</span>
<a href="#l70.2245"></a><span id="l70.2245" class="difflineminus">-              category: &quot;client&quot;,</span>
<a href="#l70.2246"></a><span id="l70.2246" class="difflineminus">-              type: &quot;pc&quot;,</span>
<a href="#l70.2247"></a><span id="l70.2247" class="difflineminus">-              name: Services.appinfo.name,</span>
<a href="#l70.2248"></a><span id="l70.2248" class="difflineminus">-            })</span>
<a href="#l70.2249"></a><span id="l70.2249" class="difflineminus">-          );</span>
<a href="#l70.2250"></a><span id="l70.2250" class="difflineminus">-        }</span>
<a href="#l70.2251"></a><span id="l70.2251" class="difflineminus">-        let discoveryQuery = Stanza.node(</span>
<a href="#l70.2252"></a><span id="l70.2252" class="difflineminus">-          &quot;query&quot;,</span>
<a href="#l70.2253"></a><span id="l70.2253" class="difflineminus">-          Stanza.NS.disco_info,</span>
<a href="#l70.2254"></a><span id="l70.2254" class="difflineminus">-          null,</span>
<a href="#l70.2255"></a><span id="l70.2255" class="difflineminus">-          children</span>
<a href="#l70.2256"></a><span id="l70.2256" class="difflineminus">-        );</span>
<a href="#l70.2257"></a><span id="l70.2257" class="difflineminus">-        this.sendStanza(Stanza.iq(&quot;result&quot;, id, from, discoveryQuery));</span>
<a href="#l70.2258"></a><span id="l70.2258" class="difflineminus">-        return;</span>
<a href="#l70.2259"></a><span id="l70.2259" class="difflineminus">-      }</span>
<a href="#l70.2260"></a><span id="l70.2260" class="difflineminus">-    }</span>
<a href="#l70.2261"></a><span id="l70.2261" class="difflineminus">-    this.WARN(`Unhandled IQ ${type} stanza.`);</span>
<a href="#l70.2262"></a><span id="l70.2262" class="difflineminus">-  },</span>
<a href="#l70.2263"></a><span id="l70.2263" class="difflineminus">-</span>
<a href="#l70.2264"></a><span id="l70.2264" class="difflineminus">-  /* Called when a presence stanza is received */</span>
<a href="#l70.2265"></a><span id="l70.2265" class="difflineminus">-  onPresenceStanza(aStanza) {</span>
<a href="#l70.2266"></a><span id="l70.2266" class="difflineminus">-    let from = aStanza.attributes.from;</span>
<a href="#l70.2267"></a><span id="l70.2267" class="difflineminus">-    this.DEBUG(&quot;Received presence stanza for &quot; + from);</span>
<a href="#l70.2268"></a><span id="l70.2268" class="difflineminus">-</span>
<a href="#l70.2269"></a><span id="l70.2269" class="difflineminus">-    let jid = this.normalize(from);</span>
<a href="#l70.2270"></a><span id="l70.2270" class="difflineminus">-    let type = aStanza.attributes.type;</span>
<a href="#l70.2271"></a><span id="l70.2271" class="difflineminus">-    if (type == &quot;subscribe&quot;) {</span>
<a href="#l70.2272"></a><span id="l70.2272" class="difflineminus">-      this.addBuddyRequest(</span>
<a href="#l70.2273"></a><span id="l70.2273" class="difflineminus">-        jid,</span>
<a href="#l70.2274"></a><span id="l70.2274" class="difflineminus">-        this.replyToBuddyRequest.bind(this, &quot;subscribed&quot;),</span>
<a href="#l70.2275"></a><span id="l70.2275" class="difflineminus">-        this.replyToBuddyRequest.bind(this, &quot;unsubscribed&quot;)</span>
<a href="#l70.2276"></a><span id="l70.2276" class="difflineminus">-      );</span>
<a href="#l70.2277"></a><span id="l70.2277" class="difflineminus">-    } else if (</span>
<a href="#l70.2278"></a><span id="l70.2278" class="difflineminus">-      type == &quot;unsubscribe&quot; ||</span>
<a href="#l70.2279"></a><span id="l70.2279" class="difflineminus">-      type == &quot;unsubscribed&quot; ||</span>
<a href="#l70.2280"></a><span id="l70.2280" class="difflineminus">-      type == &quot;subscribed&quot;</span>
<a href="#l70.2281"></a><span id="l70.2281" class="difflineminus">-    ) {</span>
<a href="#l70.2282"></a><span id="l70.2282" class="difflineminus">-      // Nothing useful to do for these presence stanzas, as we will also</span>
<a href="#l70.2283"></a><span id="l70.2283" class="difflineminus">-      // receive a roster push containing more or less the same information</span>
<a href="#l70.2284"></a><span id="l70.2284" class="difflineminus">-    } else if (this._buddies.has(jid)) {</span>
<a href="#l70.2285"></a><span id="l70.2285" class="difflineminus">-      this._buddies.get(jid).onPresenceStanza(aStanza);</span>
<a href="#l70.2286"></a><span id="l70.2286" class="difflineminus">-    } else if (this._mucs.has(jid)) {</span>
<a href="#l70.2287"></a><span id="l70.2287" class="difflineminus">-      this._mucs.get(jid).onPresenceStanza(aStanza);</span>
<a href="#l70.2288"></a><span id="l70.2288" class="difflineminus">-    } else if (jid != this.normalize(this._connection._jid.jid)) {</span>
<a href="#l70.2289"></a><span id="l70.2289" class="difflineminus">-      this.WARN(&quot;received presence stanza for unknown buddy &quot; + from);</span>
<a href="#l70.2290"></a><span id="l70.2290" class="difflineminus">-    } else if (</span>
<a href="#l70.2291"></a><span id="l70.2291" class="difflineminus">-      jid == this._jid.node + &quot;@&quot; + this._jid.domain &amp;&amp;</span>
<a href="#l70.2292"></a><span id="l70.2292" class="difflineminus">-      this._connection._resource != this._parseJID(from).resource</span>
<a href="#l70.2293"></a><span id="l70.2293" class="difflineminus">-    ) {</span>
<a href="#l70.2294"></a><span id="l70.2294" class="difflineminus">-      // Ignore presence stanzas for another resource.</span>
<a href="#l70.2295"></a><span id="l70.2295" class="difflineminus">-    } else {</span>
<a href="#l70.2296"></a><span id="l70.2296" class="difflineminus">-      this.WARN(&quot;Unhandled presence stanza.&quot;);</span>
<a href="#l70.2297"></a><span id="l70.2297" class="difflineminus">-    }</span>
<a href="#l70.2298"></a><span id="l70.2298" class="difflineminus">-  },</span>
<a href="#l70.2299"></a><span id="l70.2299" class="difflineminus">-</span>
<a href="#l70.2300"></a><span id="l70.2300" class="difflineminus">-  // XEP-0030: Discovering services and their features that are supported by</span>
<a href="#l70.2301"></a><span id="l70.2301" class="difflineminus">-  // the server.</span>
<a href="#l70.2302"></a><span id="l70.2302" class="difflineminus">-  onServiceDiscovery(aStanza) {</span>
<a href="#l70.2303"></a><span id="l70.2303" class="difflineminus">-    let query = aStanza.getElement([&quot;query&quot;]);</span>
<a href="#l70.2304"></a><span id="l70.2304" class="difflineminus">-    if (</span>
<a href="#l70.2305"></a><span id="l70.2305" class="difflineminus">-      aStanza.attributes.type != &quot;result&quot; ||</span>
<a href="#l70.2306"></a><span id="l70.2306" class="difflineminus">-      !query ||</span>
<a href="#l70.2307"></a><span id="l70.2307" class="difflineminus">-      query.uri != Stanza.NS.disco_items</span>
<a href="#l70.2308"></a><span id="l70.2308" class="difflineminus">-    ) {</span>
<a href="#l70.2309"></a><span id="l70.2309" class="difflineminus">-      this.LOG(&quot;Could not get services for this server: &quot; + this._jid.domain);</span>
<a href="#l70.2310"></a><span id="l70.2310" class="difflineminus">-      return true;</span>
<a href="#l70.2311"></a><span id="l70.2311" class="difflineminus">-    }</span>
<a href="#l70.2312"></a><span id="l70.2312" class="difflineminus">-</span>
<a href="#l70.2313"></a><span id="l70.2313" class="difflineminus">-    // Discovering the Features that are Supported by each service.</span>
<a href="#l70.2314"></a><span id="l70.2314" class="difflineminus">-    query.getElements([&quot;item&quot;]).forEach(item =&gt; {</span>
<a href="#l70.2315"></a><span id="l70.2315" class="difflineminus">-      let jid = item.attributes.jid;</span>
<a href="#l70.2316"></a><span id="l70.2316" class="difflineminus">-      if (!jid) {</span>
<a href="#l70.2317"></a><span id="l70.2317" class="difflineminus">-        return;</span>
<a href="#l70.2318"></a><span id="l70.2318" class="difflineminus">-      }</span>
<a href="#l70.2319"></a><span id="l70.2319" class="difflineminus">-      let iq = Stanza.iq(</span>
<a href="#l70.2320"></a><span id="l70.2320" class="difflineminus">-        &quot;get&quot;,</span>
<a href="#l70.2321"></a><span id="l70.2321" class="difflineminus">-        null,</span>
<a href="#l70.2322"></a><span id="l70.2322" class="difflineminus">-        jid,</span>
<a href="#l70.2323"></a><span id="l70.2323" class="difflineminus">-        Stanza.node(&quot;query&quot;, Stanza.NS.disco_info)</span>
<a href="#l70.2324"></a><span id="l70.2324" class="difflineminus">-      );</span>
<a href="#l70.2325"></a><span id="l70.2325" class="difflineminus">-      this.sendStanza(iq, receivedStanza =&gt; {</span>
<a href="#l70.2326"></a><span id="l70.2326" class="difflineminus">-        let query = receivedStanza.getElement([&quot;query&quot;]);</span>
<a href="#l70.2327"></a><span id="l70.2327" class="difflineminus">-        let from = receivedStanza.attributes.from;</span>
<a href="#l70.2328"></a><span id="l70.2328" class="difflineminus">-        if (</span>
<a href="#l70.2329"></a><span id="l70.2329" class="difflineminus">-          aStanza.attributes.type != &quot;result&quot; ||</span>
<a href="#l70.2330"></a><span id="l70.2330" class="difflineminus">-          !query ||</span>
<a href="#l70.2331"></a><span id="l70.2331" class="difflineminus">-          query.uri != Stanza.NS.disco_info</span>
<a href="#l70.2332"></a><span id="l70.2332" class="difflineminus">-        ) {</span>
<a href="#l70.2333"></a><span id="l70.2333" class="difflineminus">-          this.LOG(&quot;Could not get features for this service: &quot; + from);</span>
<a href="#l70.2334"></a><span id="l70.2334" class="difflineminus">-          return true;</span>
<a href="#l70.2335"></a><span id="l70.2335" class="difflineminus">-        }</span>
<a href="#l70.2336"></a><span id="l70.2336" class="difflineminus">-        let features = query</span>
<a href="#l70.2337"></a><span id="l70.2337" class="difflineminus">-          .getElements([&quot;feature&quot;])</span>
<a href="#l70.2338"></a><span id="l70.2338" class="difflineminus">-          .map(elt =&gt; elt.attributes.var);</span>
<a href="#l70.2339"></a><span id="l70.2339" class="difflineminus">-        let identity = query.getElement([&quot;identity&quot;]);</span>
<a href="#l70.2340"></a><span id="l70.2340" class="difflineminus">-        if (</span>
<a href="#l70.2341"></a><span id="l70.2341" class="difflineminus">-          identity &amp;&amp;</span>
<a href="#l70.2342"></a><span id="l70.2342" class="difflineminus">-          identity.attributes.category == &quot;conference&quot; &amp;&amp;</span>
<a href="#l70.2343"></a><span id="l70.2343" class="difflineminus">-          identity.attributes.type == &quot;text&quot; &amp;&amp;</span>
<a href="#l70.2344"></a><span id="l70.2344" class="difflineminus">-          features.includes(Stanza.NS.muc)</span>
<a href="#l70.2345"></a><span id="l70.2345" class="difflineminus">-        ) {</span>
<a href="#l70.2346"></a><span id="l70.2346" class="difflineminus">-          // XEP-0045 (6.2): this feature is for a MUC Service.</span>
<a href="#l70.2347"></a><span id="l70.2347" class="difflineminus">-          // XEP-0045 (15.2): Service Discovery Category/Type.</span>
<a href="#l70.2348"></a><span id="l70.2348" class="difflineminus">-          this._mucService = from;</span>
<a href="#l70.2349"></a><span id="l70.2349" class="difflineminus">-        }</span>
<a href="#l70.2350"></a><span id="l70.2350" class="difflineminus">-        // TODO: Handle other services that are supported by XMPP through</span>
<a href="#l70.2351"></a><span id="l70.2351" class="difflineminus">-        // their features.</span>
<a href="#l70.2352"></a><span id="l70.2352" class="difflineminus">-</span>
<a href="#l70.2353"></a><span id="l70.2353" class="difflineminus">-        return true;</span>
<a href="#l70.2354"></a><span id="l70.2354" class="difflineminus">-      });</span>
<a href="#l70.2355"></a><span id="l70.2355" class="difflineminus">-    });</span>
<a href="#l70.2356"></a><span id="l70.2356" class="difflineminus">-    return true;</span>
<a href="#l70.2357"></a><span id="l70.2357" class="difflineminus">-  },</span>
<a href="#l70.2358"></a><span id="l70.2358" class="difflineminus">-</span>
<a href="#l70.2359"></a><span id="l70.2359" class="difflineminus">-  // XEP-0030: Discovering Service Information and its features that are</span>
<a href="#l70.2360"></a><span id="l70.2360" class="difflineminus">-  // supported by the server.</span>
<a href="#l70.2361"></a><span id="l70.2361" class="difflineminus">-  onServiceDiscoveryInfo(aStanza) {</span>
<a href="#l70.2362"></a><span id="l70.2362" class="difflineminus">-    let query = aStanza.getElement([&quot;query&quot;]);</span>
<a href="#l70.2363"></a><span id="l70.2363" class="difflineminus">-    if (</span>
<a href="#l70.2364"></a><span id="l70.2364" class="difflineminus">-      aStanza.attributes.type != &quot;result&quot; ||</span>
<a href="#l70.2365"></a><span id="l70.2365" class="difflineminus">-      !query ||</span>
<a href="#l70.2366"></a><span id="l70.2366" class="difflineminus">-      query.uri != Stanza.NS.disco_info</span>
<a href="#l70.2367"></a><span id="l70.2367" class="difflineminus">-    ) {</span>
<a href="#l70.2368"></a><span id="l70.2368" class="difflineminus">-      this.LOG(&quot;Could not get features for this server: &quot; + this._jid.domain);</span>
<a href="#l70.2369"></a><span id="l70.2369" class="difflineminus">-      return true;</span>
<a href="#l70.2370"></a><span id="l70.2370" class="difflineminus">-    }</span>
<a href="#l70.2371"></a><span id="l70.2371" class="difflineminus">-</span>
<a href="#l70.2372"></a><span id="l70.2372" class="difflineminus">-    let features = query</span>
<a href="#l70.2373"></a><span id="l70.2373" class="difflineminus">-      .getElements([&quot;feature&quot;])</span>
<a href="#l70.2374"></a><span id="l70.2374" class="difflineminus">-      .map(elt =&gt; elt.attributes.var);</span>
<a href="#l70.2375"></a><span id="l70.2375" class="difflineminus">-    if (features.includes(Stanza.NS.carbons)) {</span>
<a href="#l70.2376"></a><span id="l70.2376" class="difflineminus">-      // XEP-0280: Message Carbons.</span>
<a href="#l70.2377"></a><span id="l70.2377" class="difflineminus">-      // Enabling Carbons on server, as it's disabled by default on server.</span>
<a href="#l70.2378"></a><span id="l70.2378" class="difflineminus">-      if (Services.prefs.getBoolPref(&quot;chat.xmpp.messageCarbons&quot;)) {</span>
<a href="#l70.2379"></a><span id="l70.2379" class="difflineminus">-        let iqStanza = Stanza.iq(</span>
<a href="#l70.2380"></a><span id="l70.2380" class="difflineminus">-          &quot;set&quot;,</span>
<a href="#l70.2381"></a><span id="l70.2381" class="difflineminus">-          null,</span>
<a href="#l70.2382"></a><span id="l70.2382" class="difflineminus">-          null,</span>
<a href="#l70.2383"></a><span id="l70.2383" class="difflineminus">-          Stanza.node(&quot;enable&quot;, Stanza.NS.carbons)</span>
<a href="#l70.2384"></a><span id="l70.2384" class="difflineminus">-        );</span>
<a href="#l70.2385"></a><span id="l70.2385" class="difflineminus">-        this.sendStanza(iqStanza, aStanza =&gt; {</span>
<a href="#l70.2386"></a><span id="l70.2386" class="difflineminus">-          let error = this.parseError(aStanza);</span>
<a href="#l70.2387"></a><span id="l70.2387" class="difflineminus">-          if (error) {</span>
<a href="#l70.2388"></a><span id="l70.2388" class="difflineminus">-            this.WARN(</span>
<a href="#l70.2389"></a><span id="l70.2389" class="difflineminus">-              &quot;Unable to enable message carbons due to &quot; +</span>
<a href="#l70.2390"></a><span id="l70.2390" class="difflineminus">-                error.condition +</span>
<a href="#l70.2391"></a><span id="l70.2391" class="difflineminus">-                &quot; error.&quot;</span>
<a href="#l70.2392"></a><span id="l70.2392" class="difflineminus">-            );</span>
<a href="#l70.2393"></a><span id="l70.2393" class="difflineminus">-            return true;</span>
<a href="#l70.2394"></a><span id="l70.2394" class="difflineminus">-          }</span>
<a href="#l70.2395"></a><span id="l70.2395" class="difflineminus">-</span>
<a href="#l70.2396"></a><span id="l70.2396" class="difflineminus">-          let type = aStanza.attributes.type;</span>
<a href="#l70.2397"></a><span id="l70.2397" class="difflineminus">-          if (type != &quot;result&quot;) {</span>
<a href="#l70.2398"></a><span id="l70.2398" class="difflineminus">-            this.WARN(</span>
<a href="#l70.2399"></a><span id="l70.2399" class="difflineminus">-              &quot;Received unexpected stanza with &quot; +</span>
<a href="#l70.2400"></a><span id="l70.2400" class="difflineminus">-                type +</span>
<a href="#l70.2401"></a><span id="l70.2401" class="difflineminus">-                &quot; type &quot; +</span>
<a href="#l70.2402"></a><span id="l70.2402" class="difflineminus">-                &quot;while enabling message carbons.&quot;</span>
<a href="#l70.2403"></a><span id="l70.2403" class="difflineminus">-            );</span>
<a href="#l70.2404"></a><span id="l70.2404" class="difflineminus">-            return true;</span>
<a href="#l70.2405"></a><span id="l70.2405" class="difflineminus">-          }</span>
<a href="#l70.2406"></a><span id="l70.2406" class="difflineminus">-</span>
<a href="#l70.2407"></a><span id="l70.2407" class="difflineminus">-          this.LOG(&quot;Message carbons enabled.&quot;);</span>
<a href="#l70.2408"></a><span id="l70.2408" class="difflineminus">-          this._isCarbonsEnabled = true;</span>
<a href="#l70.2409"></a><span id="l70.2409" class="difflineminus">-          return true;</span>
<a href="#l70.2410"></a><span id="l70.2410" class="difflineminus">-        });</span>
<a href="#l70.2411"></a><span id="l70.2411" class="difflineminus">-      }</span>
<a href="#l70.2412"></a><span id="l70.2412" class="difflineminus">-    }</span>
<a href="#l70.2413"></a><span id="l70.2413" class="difflineminus">-    // TODO: Handle other features that are supported by the server.</span>
<a href="#l70.2414"></a><span id="l70.2414" class="difflineplus">+  get chatHasTopic() {</span>
<a href="#l70.2415"></a><span id="l70.2415">     return true;</span>
<a href="#l70.2416"></a><span id="l70.2416">   },</span>
<a href="#l70.2417"></a><span id="l70.2417" class="difflineminus">-</span>
<a href="#l70.2418"></a><span id="l70.2418" class="difflineminus">-  requestRoomInfo(aCallback) {</span>
<a href="#l70.2419"></a><span id="l70.2419" class="difflineminus">-    if (this._roomInfoCallbacks.has(aCallback)) {</span>
<a href="#l70.2420"></a><span id="l70.2420" class="difflineminus">-      return;</span>
<a href="#l70.2421"></a><span id="l70.2421" class="difflineminus">-    }</span>
<a href="#l70.2422"></a><span id="l70.2422" class="difflineminus">-</span>
<a href="#l70.2423"></a><span id="l70.2423" class="difflineminus">-    if (this.isRoomInfoStale &amp;&amp; !this._pendingList) {</span>
<a href="#l70.2424"></a><span id="l70.2424" class="difflineminus">-      this._roomList = new Map();</span>
<a href="#l70.2425"></a><span id="l70.2425" class="difflineminus">-      this._lastListTime = Date.now();</span>
<a href="#l70.2426"></a><span id="l70.2426" class="difflineminus">-      this._roomInfoCallback = aCallback;</span>
<a href="#l70.2427"></a><span id="l70.2427" class="difflineminus">-      this._pendingList = true;</span>
<a href="#l70.2428"></a><span id="l70.2428" class="difflineminus">-</span>
<a href="#l70.2429"></a><span id="l70.2429" class="difflineminus">-      // XEP-0045 (6.3): Discovering Rooms.</span>
<a href="#l70.2430"></a><span id="l70.2430" class="difflineminus">-      let iq = Stanza.iq(</span>
<a href="#l70.2431"></a><span id="l70.2431" class="difflineminus">-        &quot;get&quot;,</span>
<a href="#l70.2432"></a><span id="l70.2432" class="difflineminus">-        null,</span>
<a href="#l70.2433"></a><span id="l70.2433" class="difflineminus">-        this._mucService,</span>
<a href="#l70.2434"></a><span id="l70.2434" class="difflineminus">-        Stanza.node(&quot;query&quot;, Stanza.NS.disco_items)</span>
<a href="#l70.2435"></a><span id="l70.2435" class="difflineminus">-      );</span>
<a href="#l70.2436"></a><span id="l70.2436" class="difflineminus">-      this.sendStanza(iq, this.onRoomDiscovery, this);</span>
<a href="#l70.2437"></a><span id="l70.2437" class="difflineminus">-    } else {</span>
<a href="#l70.2438"></a><span id="l70.2438" class="difflineminus">-      let rooms = [...this._roomList.keys()];</span>
<a href="#l70.2439"></a><span id="l70.2439" class="difflineminus">-      aCallback.onRoomInfoAvailable(rooms, !this._pendingList);</span>
<a href="#l70.2440"></a><span id="l70.2440" class="difflineminus">-    }</span>
<a href="#l70.2441"></a><span id="l70.2441" class="difflineminus">-</span>
<a href="#l70.2442"></a><span id="l70.2442" class="difflineminus">-    if (this._pendingList) {</span>
<a href="#l70.2443"></a><span id="l70.2443" class="difflineminus">-      this._roomInfoCallbacks.add(aCallback);</span>
<a href="#l70.2444"></a><span id="l70.2444" class="difflineminus">-    }</span>
<a href="#l70.2445"></a><span id="l70.2445" class="difflineminus">-  },</span>
<a href="#l70.2446"></a><span id="l70.2446" class="difflineminus">-</span>
<a href="#l70.2447"></a><span id="l70.2447" class="difflineminus">-  onRoomDiscovery(aStanza) {</span>
<a href="#l70.2448"></a><span id="l70.2448" class="difflineminus">-    let query = aStanza.getElement([&quot;query&quot;]);</span>
<a href="#l70.2449"></a><span id="l70.2449" class="difflineminus">-    if (!query || query.uri != Stanza.NS.disco_items) {</span>
<a href="#l70.2450"></a><span id="l70.2450" class="difflineminus">-      this.LOG(&quot;Could not get rooms for this server: &quot; + this._jid.domain);</span>
<a href="#l70.2451"></a><span id="l70.2451" class="difflineminus">-      return;</span>
<a href="#l70.2452"></a><span id="l70.2452" class="difflineminus">-    }</span>
<a href="#l70.2453"></a><span id="l70.2453" class="difflineminus">-</span>
<a href="#l70.2454"></a><span id="l70.2454" class="difflineminus">-    // XEP-0059: Result Set Management.</span>
<a href="#l70.2455"></a><span id="l70.2455" class="difflineminus">-    let set = query.getElement([&quot;set&quot;]);</span>
<a href="#l70.2456"></a><span id="l70.2456" class="difflineminus">-    let last = set ? set.getElement([&quot;last&quot;]) : null;</span>
<a href="#l70.2457"></a><span id="l70.2457" class="difflineminus">-    if (last) {</span>
<a href="#l70.2458"></a><span id="l70.2458" class="difflineminus">-      let iq = Stanza.iq(</span>
<a href="#l70.2459"></a><span id="l70.2459" class="difflineminus">-        &quot;get&quot;,</span>
<a href="#l70.2460"></a><span id="l70.2460" class="difflineminus">-        null,</span>
<a href="#l70.2461"></a><span id="l70.2461" class="difflineminus">-        this._mucService,</span>
<a href="#l70.2462"></a><span id="l70.2462" class="difflineminus">-        Stanza.node(&quot;query&quot;, Stanza.NS.disco_items)</span>
<a href="#l70.2463"></a><span id="l70.2463" class="difflineminus">-      );</span>
<a href="#l70.2464"></a><span id="l70.2464" class="difflineminus">-      this.sendStanza(iq, this.onRoomDiscovery, this);</span>
<a href="#l70.2465"></a><span id="l70.2465" class="difflineminus">-    } else {</span>
<a href="#l70.2466"></a><span id="l70.2466" class="difflineminus">-      this._pendingList = false;</span>
<a href="#l70.2467"></a><span id="l70.2467" class="difflineminus">-    }</span>
<a href="#l70.2468"></a><span id="l70.2468" class="difflineminus">-</span>
<a href="#l70.2469"></a><span id="l70.2469" class="difflineminus">-    let rooms = [];</span>
<a href="#l70.2470"></a><span id="l70.2470" class="difflineminus">-    query.getElements([&quot;item&quot;]).forEach(item =&gt; {</span>
<a href="#l70.2471"></a><span id="l70.2471" class="difflineminus">-      let jid = this._parseJID(item.attributes.jid);</span>
<a href="#l70.2472"></a><span id="l70.2472" class="difflineminus">-      if (!jid) {</span>
<a href="#l70.2473"></a><span id="l70.2473" class="difflineminus">-        return;</span>
<a href="#l70.2474"></a><span id="l70.2474" class="difflineminus">-      }</span>
<a href="#l70.2475"></a><span id="l70.2475" class="difflineminus">-</span>
<a href="#l70.2476"></a><span id="l70.2476" class="difflineminus">-      let name = item.attributes.name;</span>
<a href="#l70.2477"></a><span id="l70.2477" class="difflineminus">-      if (!name) {</span>
<a href="#l70.2478"></a><span id="l70.2478" class="difflineminus">-        name = jid.node ? jid.node : jid.jid;</span>
<a href="#l70.2479"></a><span id="l70.2479" class="difflineminus">-      }</span>
<a href="#l70.2480"></a><span id="l70.2480" class="difflineminus">-</span>
<a href="#l70.2481"></a><span id="l70.2481" class="difflineminus">-      this._roomList.set(name, jid.jid);</span>
<a href="#l70.2482"></a><span id="l70.2482" class="difflineminus">-      rooms.push(name);</span>
<a href="#l70.2483"></a><span id="l70.2483" class="difflineminus">-    });</span>
<a href="#l70.2484"></a><span id="l70.2484" class="difflineminus">-</span>
<a href="#l70.2485"></a><span id="l70.2485" class="difflineminus">-    this._roomInfoCallback.onRoomInfoAvailable(rooms, !this._pendingList);</span>
<a href="#l70.2486"></a><span id="l70.2486" class="difflineminus">-  },</span>
<a href="#l70.2487"></a><span id="l70.2487" class="difflineminus">-</span>
<a href="#l70.2488"></a><span id="l70.2488" class="difflineminus">-  getRoomInfo(aName) {</span>
<a href="#l70.2489"></a><span id="l70.2489" class="difflineminus">-    return new XMPPRoomInfo(aName, this);</span>
<a href="#l70.2490"></a><span id="l70.2490" class="difflineminus">-  },</span>
<a href="#l70.2491"></a><span id="l70.2491" class="difflineminus">-</span>
<a href="#l70.2492"></a><span id="l70.2492" class="difflineminus">-  // Returns null if not an invitation stanza, and an object</span>
<a href="#l70.2493"></a><span id="l70.2493" class="difflineminus">-  // describing the invitation otherwise.</span>
<a href="#l70.2494"></a><span id="l70.2494" class="difflineminus">-  parseInvitation(aStanza) {</span>
<a href="#l70.2495"></a><span id="l70.2495" class="difflineminus">-    let x = aStanza.getElement([&quot;x&quot;]);</span>
<a href="#l70.2496"></a><span id="l70.2496" class="difflineminus">-    if (!x) {</span>
<a href="#l70.2497"></a><span id="l70.2497" class="difflineminus">-      return null;</span>
<a href="#l70.2498"></a><span id="l70.2498" class="difflineminus">-    }</span>
<a href="#l70.2499"></a><span id="l70.2499" class="difflineminus">-    let retVal = {};</span>
<a href="#l70.2500"></a><span id="l70.2500" class="difflineminus">-</span>
<a href="#l70.2501"></a><span id="l70.2501" class="difflineminus">-    // XEP-0045. Direct Invitation (7.8.1)</span>
<a href="#l70.2502"></a><span id="l70.2502" class="difflineminus">-    // Described in XEP-0249.</span>
<a href="#l70.2503"></a><span id="l70.2503" class="difflineminus">-    // jid (chatroom) is required.</span>
<a href="#l70.2504"></a><span id="l70.2504" class="difflineminus">-    // Password, reason, continue and thread are optional.</span>
<a href="#l70.2505"></a><span id="l70.2505" class="difflineminus">-    if (x.uri == Stanza.NS.conference) {</span>
<a href="#l70.2506"></a><span id="l70.2506" class="difflineminus">-      if (!x.attributes.jid) {</span>
<a href="#l70.2507"></a><span id="l70.2507" class="difflineminus">-        this.WARN(&quot;Received an invitation with missing MUC jid.&quot;);</span>
<a href="#l70.2508"></a><span id="l70.2508" class="difflineminus">-        return null;</span>
<a href="#l70.2509"></a><span id="l70.2509" class="difflineminus">-      }</span>
<a href="#l70.2510"></a><span id="l70.2510" class="difflineminus">-      retVal.mucJid = this.normalize(x.attributes.jid);</span>
<a href="#l70.2511"></a><span id="l70.2511" class="difflineminus">-      retVal.from = this.normalize(aStanza.attributes.from);</span>
<a href="#l70.2512"></a><span id="l70.2512" class="difflineminus">-      retVal.password = x.attributes.password;</span>
<a href="#l70.2513"></a><span id="l70.2513" class="difflineminus">-      retVal.reason = x.attributes.reason;</span>
<a href="#l70.2514"></a><span id="l70.2514" class="difflineminus">-      retVal.continue = x.attributes.continue;</span>
<a href="#l70.2515"></a><span id="l70.2515" class="difflineminus">-      retVal.thread = x.attributes.thread;</span>
<a href="#l70.2516"></a><span id="l70.2516" class="difflineminus">-      return retVal;</span>
<a href="#l70.2517"></a><span id="l70.2517" class="difflineminus">-    }</span>
<a href="#l70.2518"></a><span id="l70.2518" class="difflineminus">-</span>
<a href="#l70.2519"></a><span id="l70.2519" class="difflineminus">-    // XEP-0045. Mediated Invitation (7.8.2)</span>
<a href="#l70.2520"></a><span id="l70.2520" class="difflineminus">-    // Sent by the chatroom on behalf of someone in the chatroom.</span>
<a href="#l70.2521"></a><span id="l70.2521" class="difflineminus">-    // jid (chatroom) and from (inviter) are required.</span>
<a href="#l70.2522"></a><span id="l70.2522" class="difflineminus">-    // password and reason are optional.</span>
<a href="#l70.2523"></a><span id="l70.2523" class="difflineminus">-    if (x.uri == Stanza.NS.muc_user) {</span>
<a href="#l70.2524"></a><span id="l70.2524" class="difflineminus">-      let invite = x.getElement([&quot;invite&quot;]);</span>
<a href="#l70.2525"></a><span id="l70.2525" class="difflineminus">-      if (!invite || !invite.attributes.from) {</span>
<a href="#l70.2526"></a><span id="l70.2526" class="difflineminus">-        this.WARN(&quot;Received an invitation with missing MUC invite or from.&quot;);</span>
<a href="#l70.2527"></a><span id="l70.2527" class="difflineminus">-        return null;</span>
<a href="#l70.2528"></a><span id="l70.2528" class="difflineminus">-      }</span>
<a href="#l70.2529"></a><span id="l70.2529" class="difflineminus">-      retVal.mucJid = this.normalize(aStanza.attributes.from);</span>
<a href="#l70.2530"></a><span id="l70.2530" class="difflineminus">-      retVal.from = this.normalize(invite.attributes.from);</span>
<a href="#l70.2531"></a><span id="l70.2531" class="difflineminus">-      let continueElement = invite.getElement([&quot;continue&quot;]);</span>
<a href="#l70.2532"></a><span id="l70.2532" class="difflineminus">-      retVal.continue = !!continueElement;</span>
<a href="#l70.2533"></a><span id="l70.2533" class="difflineminus">-      if (continueElement) {</span>
<a href="#l70.2534"></a><span id="l70.2534" class="difflineminus">-        retVal.thread = continueElement.attributes.thread;</span>
<a href="#l70.2535"></a><span id="l70.2535" class="difflineminus">-      }</span>
<a href="#l70.2536"></a><span id="l70.2536" class="difflineminus">-      if (x.getElement([&quot;password&quot;])) {</span>
<a href="#l70.2537"></a><span id="l70.2537" class="difflineminus">-        retVal.password = x.getElement([&quot;password&quot;]).innerText;</span>
<a href="#l70.2538"></a><span id="l70.2538" class="difflineminus">-      }</span>
<a href="#l70.2539"></a><span id="l70.2539" class="difflineminus">-      if (invite.getElement([&quot;reason&quot;])) {</span>
<a href="#l70.2540"></a><span id="l70.2540" class="difflineminus">-        retVal.reason = invite.getElement([&quot;reason&quot;]).innerText;</span>
<a href="#l70.2541"></a><span id="l70.2541" class="difflineminus">-      }</span>
<a href="#l70.2542"></a><span id="l70.2542" class="difflineminus">-      return retVal;</span>
<a href="#l70.2543"></a><span id="l70.2543" class="difflineminus">-    }</span>
<a href="#l70.2544"></a><span id="l70.2544" class="difflineminus">-</span>
<a href="#l70.2545"></a><span id="l70.2545" class="difflineminus">-    return null;</span>
<a href="#l70.2546"></a><span id="l70.2546" class="difflineminus">-  },</span>
<a href="#l70.2547"></a><span id="l70.2547" class="difflineminus">-</span>
<a href="#l70.2548"></a><span id="l70.2548" class="difflineminus">-  /* Called when a message stanza is received */</span>
<a href="#l70.2549"></a><span id="l70.2549" class="difflineminus">-  onMessageStanza(aStanza) {</span>
<a href="#l70.2550"></a><span id="l70.2550" class="difflineminus">-    // XEP-0280: Message Carbons.</span>
<a href="#l70.2551"></a><span id="l70.2551" class="difflineminus">-    // Sending and Receiving Messages.</span>
<a href="#l70.2552"></a><span id="l70.2552" class="difflineminus">-    // Indicates that the forwarded message was sent or received.</span>
<a href="#l70.2553"></a><span id="l70.2553" class="difflineminus">-    let isSent = false;</span>
<a href="#l70.2554"></a><span id="l70.2554" class="difflineminus">-    let carbonStanza =</span>
<a href="#l70.2555"></a><span id="l70.2555" class="difflineminus">-      aStanza.getElement([&quot;sent&quot;]) || aStanza.getElement([&quot;received&quot;]);</span>
<a href="#l70.2556"></a><span id="l70.2556" class="difflineminus">-    if (carbonStanza) {</span>
<a href="#l70.2557"></a><span id="l70.2557" class="difflineminus">-      if (carbonStanza.uri != Stanza.NS.carbons) {</span>
<a href="#l70.2558"></a><span id="l70.2558" class="difflineminus">-        this.WARN(</span>
<a href="#l70.2559"></a><span id="l70.2559" class="difflineminus">-          &quot;Received a forwarded message which does not '&quot; +</span>
<a href="#l70.2560"></a><span id="l70.2560" class="difflineminus">-            Stanza.NS.carbons +</span>
<a href="#l70.2561"></a><span id="l70.2561" class="difflineminus">-            &quot;' namespace.&quot;</span>
<a href="#l70.2562"></a><span id="l70.2562" class="difflineminus">-        );</span>
<a href="#l70.2563"></a><span id="l70.2563" class="difflineminus">-        return;</span>
<a href="#l70.2564"></a><span id="l70.2564" class="difflineminus">-      }</span>
<a href="#l70.2565"></a><span id="l70.2565" class="difflineminus">-</span>
<a href="#l70.2566"></a><span id="l70.2566" class="difflineminus">-      isSent = carbonStanza.localName == &quot;sent&quot;;</span>
<a href="#l70.2567"></a><span id="l70.2567" class="difflineminus">-      carbonStanza = carbonStanza.getElement([&quot;forwarded&quot;, &quot;message&quot;]);</span>
<a href="#l70.2568"></a><span id="l70.2568" class="difflineminus">-      if (this._isCarbonsEnabled) {</span>
<a href="#l70.2569"></a><span id="l70.2569" class="difflineminus">-        aStanza = carbonStanza;</span>
<a href="#l70.2570"></a><span id="l70.2570" class="difflineminus">-      } else {</span>
<a href="#l70.2571"></a><span id="l70.2571" class="difflineminus">-        this.WARN(</span>
<a href="#l70.2572"></a><span id="l70.2572" class="difflineminus">-          &quot;Received an unexpected forwarded message while message &quot; +</span>
<a href="#l70.2573"></a><span id="l70.2573" class="difflineminus">-            &quot;carbons are not enabled.&quot;</span>
<a href="#l70.2574"></a><span id="l70.2574" class="difflineminus">-        );</span>
<a href="#l70.2575"></a><span id="l70.2575" class="difflineminus">-        return;</span>
<a href="#l70.2576"></a><span id="l70.2576" class="difflineminus">-      }</span>
<a href="#l70.2577"></a><span id="l70.2577" class="difflineminus">-    }</span>
<a href="#l70.2578"></a><span id="l70.2578" class="difflineminus">-</span>
<a href="#l70.2579"></a><span id="l70.2579" class="difflineminus">-    // For forwarded sent messages, we need to use &quot;to&quot; attribute to</span>
<a href="#l70.2580"></a><span id="l70.2580" class="difflineminus">-    // get the right conversation as from in this case is this account.</span>
<a href="#l70.2581"></a><span id="l70.2581" class="difflineminus">-    let convJid = isSent ? aStanza.attributes.to : aStanza.attributes.from;</span>
<a href="#l70.2582"></a><span id="l70.2582" class="difflineminus">-</span>
<a href="#l70.2583"></a><span id="l70.2583" class="difflineminus">-    let normConvJid = this.normalize(convJid);</span>
<a href="#l70.2584"></a><span id="l70.2584" class="difflineminus">-    let isMuc = this._mucs.has(normConvJid);</span>
<a href="#l70.2585"></a><span id="l70.2585" class="difflineminus">-</span>
<a href="#l70.2586"></a><span id="l70.2586" class="difflineminus">-    let type = aStanza.attributes.type;</span>
<a href="#l70.2587"></a><span id="l70.2587" class="difflineminus">-    let x = aStanza.getElement([&quot;x&quot;]);</span>
<a href="#l70.2588"></a><span id="l70.2588" class="difflineminus">-    let body;</span>
<a href="#l70.2589"></a><span id="l70.2589" class="difflineminus">-    let b = aStanza.getElement([&quot;body&quot;]);</span>
<a href="#l70.2590"></a><span id="l70.2590" class="difflineminus">-    if (b) {</span>
<a href="#l70.2591"></a><span id="l70.2591" class="difflineminus">-      // If there's a &lt;body&gt; child we have more than just typing notifications.</span>
<a href="#l70.2592"></a><span id="l70.2592" class="difflineminus">-      // Prefer HTML (in &lt;html&gt;&lt;body&gt;) and use plain text (&lt;body&gt;) as fallback.</span>
<a href="#l70.2593"></a><span id="l70.2593" class="difflineminus">-      let htmlBody = aStanza.getElement([&quot;html&quot;, &quot;body&quot;]);</span>
<a href="#l70.2594"></a><span id="l70.2594" class="difflineminus">-      if (htmlBody) {</span>
<a href="#l70.2595"></a><span id="l70.2595" class="difflineminus">-        body = htmlBody.innerXML;</span>
<a href="#l70.2596"></a><span id="l70.2596" class="difflineminus">-      } else {</span>
<a href="#l70.2597"></a><span id="l70.2597" class="difflineminus">-        // Even if the message is in plain text, the prplIMessage</span>
<a href="#l70.2598"></a><span id="l70.2598" class="difflineminus">-        // should contain a string that's correctly escaped for</span>
<a href="#l70.2599"></a><span id="l70.2599" class="difflineminus">-        // insertion in an HTML document.</span>
<a href="#l70.2600"></a><span id="l70.2600" class="difflineminus">-        body = TXTToHTML(b.innerText);</span>
<a href="#l70.2601"></a><span id="l70.2601" class="difflineminus">-      }</span>
<a href="#l70.2602"></a><span id="l70.2602" class="difflineminus">-    }</span>
<a href="#l70.2603"></a><span id="l70.2603" class="difflineminus">-</span>
<a href="#l70.2604"></a><span id="l70.2604" class="difflineminus">-    let subject = aStanza.getElement([&quot;subject&quot;]);</span>
<a href="#l70.2605"></a><span id="l70.2605" class="difflineminus">-    // Ignore subject when !isMuc. We're being permissive about subject changes</span>
<a href="#l70.2606"></a><span id="l70.2606" class="difflineminus">-    // in the comment below, so we need to be careful about where that makes</span>
<a href="#l70.2607"></a><span id="l70.2607" class="difflineminus">-    // sense. Psi+'s OTR plugin includes a subject and body in its message</span>
<a href="#l70.2608"></a><span id="l70.2608" class="difflineminus">-    // stanzas.</span>
<a href="#l70.2609"></a><span id="l70.2609" class="difflineminus">-    if (subject &amp;&amp; isMuc) {</span>
<a href="#l70.2610"></a><span id="l70.2610" class="difflineminus">-      // XEP-0045 (7.2.16): Check for a subject element in the stanza and update</span>
<a href="#l70.2611"></a><span id="l70.2611" class="difflineminus">-      // the topic if it exists.</span>
<a href="#l70.2612"></a><span id="l70.2612" class="difflineminus">-      // We are breaking the spec because only a message that contains a</span>
<a href="#l70.2613"></a><span id="l70.2613" class="difflineminus">-      // &lt;subject/&gt; but no &lt;body/&gt; element shall be considered a subject change</span>
<a href="#l70.2614"></a><span id="l70.2614" class="difflineminus">-      // for MUC, but we ignore that to be compatible with ejabberd versions</span>
<a href="#l70.2615"></a><span id="l70.2615" class="difflineminus">-      // before 15.06.</span>
<a href="#l70.2616"></a><span id="l70.2616" class="difflineminus">-      let muc = this._mucs.get(normConvJid);</span>
<a href="#l70.2617"></a><span id="l70.2617" class="difflineminus">-      let nick = this._parseJID(convJid).resource;</span>
<a href="#l70.2618"></a><span id="l70.2618" class="difflineminus">-      // TODO There can be multiple subject elements with different xml:lang</span>
<a href="#l70.2619"></a><span id="l70.2619" class="difflineminus">-      // attributes.</span>
<a href="#l70.2620"></a><span id="l70.2620" class="difflineminus">-      muc.setTopic(subject.innerText, nick);</span>
<a href="#l70.2621"></a><span id="l70.2621" class="difflineminus">-      return;</span>
<a href="#l70.2622"></a><span id="l70.2622" class="difflineminus">-    }</span>
<a href="#l70.2623"></a><span id="l70.2623" class="difflineminus">-</span>
<a href="#l70.2624"></a><span id="l70.2624" class="difflineminus">-    let invitation = this.parseInvitation(aStanza);</span>
<a href="#l70.2625"></a><span id="l70.2625" class="difflineminus">-    if (invitation) {</span>
<a href="#l70.2626"></a><span id="l70.2626" class="difflineminus">-      let messageID;</span>
<a href="#l70.2627"></a><span id="l70.2627" class="difflineminus">-      if (invitation.reason) {</span>
<a href="#l70.2628"></a><span id="l70.2628" class="difflineminus">-        messageID = &quot;conversation.muc.invitationWithReason2&quot;;</span>
<a href="#l70.2629"></a><span id="l70.2629" class="difflineminus">-      } else {</span>
<a href="#l70.2630"></a><span id="l70.2630" class="difflineminus">-        messageID = &quot;conversation.muc.invitationWithoutReason&quot;;</span>
<a href="#l70.2631"></a><span id="l70.2631" class="difflineminus">-      }</span>
<a href="#l70.2632"></a><span id="l70.2632" class="difflineminus">-      if (invitation.password) {</span>
<a href="#l70.2633"></a><span id="l70.2633" class="difflineminus">-        messageID += &quot;.password&quot;;</span>
<a href="#l70.2634"></a><span id="l70.2634" class="difflineminus">-      }</span>
<a href="#l70.2635"></a><span id="l70.2635" class="difflineminus">-      let params = [</span>
<a href="#l70.2636"></a><span id="l70.2636" class="difflineminus">-        invitation.from,</span>
<a href="#l70.2637"></a><span id="l70.2637" class="difflineminus">-        invitation.mucJid,</span>
<a href="#l70.2638"></a><span id="l70.2638" class="difflineminus">-        invitation.password,</span>
<a href="#l70.2639"></a><span id="l70.2639" class="difflineminus">-        invitation.reason,</span>
<a href="#l70.2640"></a><span id="l70.2640" class="difflineminus">-      ].filter(s =&gt; s);</span>
<a href="#l70.2641"></a><span id="l70.2641" class="difflineminus">-      let message = _(messageID, ...params);</span>
<a href="#l70.2642"></a><span id="l70.2642" class="difflineminus">-</span>
<a href="#l70.2643"></a><span id="l70.2643" class="difflineminus">-      if (</span>
<a href="#l70.2644"></a><span id="l70.2644" class="difflineminus">-        Services.prefs.getIntPref(</span>
<a href="#l70.2645"></a><span id="l70.2645" class="difflineminus">-          &quot;messenger.conversations.autoAcceptChatInvitations&quot;</span>
<a href="#l70.2646"></a><span id="l70.2646" class="difflineminus">-        ) == 1</span>
<a href="#l70.2647"></a><span id="l70.2647" class="difflineminus">-      ) {</span>
<a href="#l70.2648"></a><span id="l70.2648" class="difflineminus">-        // Auto-accept the invitation.</span>
<a href="#l70.2649"></a><span id="l70.2649" class="difflineminus">-        let chatRoomFields = this.getChatRoomDefaultFieldValues(</span>
<a href="#l70.2650"></a><span id="l70.2650" class="difflineminus">-          invitation.mucJid</span>
<a href="#l70.2651"></a><span id="l70.2651" class="difflineminus">-        );</span>
<a href="#l70.2652"></a><span id="l70.2652" class="difflineminus">-        if (invitation.password) {</span>
<a href="#l70.2653"></a><span id="l70.2653" class="difflineminus">-          chatRoomFields.setValue(&quot;password&quot;, invitation.password);</span>
<a href="#l70.2654"></a><span id="l70.2654" class="difflineminus">-        }</span>
<a href="#l70.2655"></a><span id="l70.2655" class="difflineminus">-        let muc = this.joinChat(chatRoomFields);</span>
<a href="#l70.2656"></a><span id="l70.2656" class="difflineminus">-        muc.writeMessage(muc.name, message, { system: true });</span>
<a href="#l70.2657"></a><span id="l70.2657" class="difflineminus">-      } else {</span>
<a href="#l70.2658"></a><span id="l70.2658" class="difflineminus">-        // Otherwise, just notify the user.</span>
<a href="#l70.2659"></a><span id="l70.2659" class="difflineminus">-        let conv = this.createConversation(invitation.from);</span>
<a href="#l70.2660"></a><span id="l70.2660" class="difflineminus">-        if (conv) {</span>
<a href="#l70.2661"></a><span id="l70.2661" class="difflineminus">-          conv.writeMessage(invitation.from, message, { system: true });</span>
<a href="#l70.2662"></a><span id="l70.2662" class="difflineminus">-        }</span>
<a href="#l70.2663"></a><span id="l70.2663" class="difflineminus">-      }</span>
<a href="#l70.2664"></a><span id="l70.2664" class="difflineminus">-    }</span>
<a href="#l70.2665"></a><span id="l70.2665" class="difflineminus">-</span>
<a href="#l70.2666"></a><span id="l70.2666" class="difflineminus">-    if (body) {</span>
<a href="#l70.2667"></a><span id="l70.2667" class="difflineminus">-      let date = _getDelay(aStanza);</span>
<a href="#l70.2668"></a><span id="l70.2668" class="difflineminus">-      if (</span>
<a href="#l70.2669"></a><span id="l70.2669" class="difflineminus">-        type == &quot;groupchat&quot; ||</span>
<a href="#l70.2670"></a><span id="l70.2670" class="difflineminus">-        (type == &quot;error&quot; &amp;&amp; isMuc &amp;&amp; !this._conv.has(convJid))</span>
<a href="#l70.2671"></a><span id="l70.2671" class="difflineminus">-      ) {</span>
<a href="#l70.2672"></a><span id="l70.2672" class="difflineminus">-        if (!isMuc) {</span>
<a href="#l70.2673"></a><span id="l70.2673" class="difflineminus">-          this.WARN(</span>
<a href="#l70.2674"></a><span id="l70.2674" class="difflineminus">-            &quot;Received a groupchat message for unknown MUC &quot; + normConvJid</span>
<a href="#l70.2675"></a><span id="l70.2675" class="difflineminus">-          );</span>
<a href="#l70.2676"></a><span id="l70.2676" class="difflineminus">-          return;</span>
<a href="#l70.2677"></a><span id="l70.2677" class="difflineminus">-        }</span>
<a href="#l70.2678"></a><span id="l70.2678" class="difflineminus">-        let muc = this._mucs.get(normConvJid);</span>
<a href="#l70.2679"></a><span id="l70.2679" class="difflineminus">-        muc.incomingMessage(body, aStanza, date);</span>
<a href="#l70.2680"></a><span id="l70.2680" class="difflineminus">-        return;</span>
<a href="#l70.2681"></a><span id="l70.2681" class="difflineminus">-      }</span>
<a href="#l70.2682"></a><span id="l70.2682" class="difflineminus">-</span>
<a href="#l70.2683"></a><span id="l70.2683" class="difflineminus">-      let conv = this.createConversation(convJid);</span>
<a href="#l70.2684"></a><span id="l70.2684" class="difflineminus">-      if (!conv) {</span>
<a href="#l70.2685"></a><span id="l70.2685" class="difflineminus">-        return;</span>
<a href="#l70.2686"></a><span id="l70.2686" class="difflineminus">-      }</span>
<a href="#l70.2687"></a><span id="l70.2687" class="difflineminus">-</span>
<a href="#l70.2688"></a><span id="l70.2688" class="difflineminus">-      if (isSent) {</span>
<a href="#l70.2689"></a><span id="l70.2689" class="difflineminus">-        _displaySentMsg(conv, body, date);</span>
<a href="#l70.2690"></a><span id="l70.2690" class="difflineminus">-        return;</span>
<a href="#l70.2691"></a><span id="l70.2691" class="difflineminus">-      }</span>
<a href="#l70.2692"></a><span id="l70.2692" class="difflineminus">-      conv.incomingMessage(body, aStanza, date);</span>
<a href="#l70.2693"></a><span id="l70.2693" class="difflineminus">-    } else if (type == &quot;error&quot;) {</span>
<a href="#l70.2694"></a><span id="l70.2694" class="difflineminus">-      let conv = this.createConversation(convJid);</span>
<a href="#l70.2695"></a><span id="l70.2695" class="difflineminus">-      if (conv) {</span>
<a href="#l70.2696"></a><span id="l70.2696" class="difflineminus">-        conv.incomingMessage(null, aStanza);</span>
<a href="#l70.2697"></a><span id="l70.2697" class="difflineminus">-      }</span>
<a href="#l70.2698"></a><span id="l70.2698" class="difflineminus">-    } else if (x &amp;&amp; x.uri == Stanza.NS.muc_user) {</span>
<a href="#l70.2699"></a><span id="l70.2699" class="difflineminus">-      let muc = this._mucs.get(normConvJid);</span>
<a href="#l70.2700"></a><span id="l70.2700" class="difflineminus">-      if (!muc) {</span>
<a href="#l70.2701"></a><span id="l70.2701" class="difflineminus">-        this.WARN(</span>
<a href="#l70.2702"></a><span id="l70.2702" class="difflineminus">-          &quot;Received a groupchat message for unknown MUC &quot; + normConvJid</span>
<a href="#l70.2703"></a><span id="l70.2703" class="difflineminus">-        );</span>
<a href="#l70.2704"></a><span id="l70.2704" class="difflineminus">-        return;</span>
<a href="#l70.2705"></a><span id="l70.2705" class="difflineminus">-      }</span>
<a href="#l70.2706"></a><span id="l70.2706" class="difflineminus">-      muc.onMessageStanza(aStanza);</span>
<a href="#l70.2707"></a><span id="l70.2707" class="difflineminus">-      return;</span>
<a href="#l70.2708"></a><span id="l70.2708" class="difflineminus">-    }</span>
<a href="#l70.2709"></a><span id="l70.2709" class="difflineminus">-</span>
<a href="#l70.2710"></a><span id="l70.2710" class="difflineminus">-    // If this is a sent message carbon, the user is typing on another client.</span>
<a href="#l70.2711"></a><span id="l70.2711" class="difflineminus">-    if (isSent) {</span>
<a href="#l70.2712"></a><span id="l70.2712" class="difflineminus">-      return;</span>
<a href="#l70.2713"></a><span id="l70.2713" class="difflineminus">-    }</span>
<a href="#l70.2714"></a><span id="l70.2714" class="difflineminus">-</span>
<a href="#l70.2715"></a><span id="l70.2715" class="difflineminus">-    // Don't create a conversation to only display the typing notifications.</span>
<a href="#l70.2716"></a><span id="l70.2716" class="difflineminus">-    if (!this._conv.has(normConvJid) &amp;&amp; !this._conv.has(convJid)) {</span>
<a href="#l70.2717"></a><span id="l70.2717" class="difflineminus">-      return;</span>
<a href="#l70.2718"></a><span id="l70.2718" class="difflineminus">-    }</span>
<a href="#l70.2719"></a><span id="l70.2719" class="difflineminus">-</span>
<a href="#l70.2720"></a><span id="l70.2720" class="difflineminus">-    // Ignore errors while delivering typing notifications.</span>
<a href="#l70.2721"></a><span id="l70.2721" class="difflineminus">-    if (type == &quot;error&quot;) {</span>
<a href="#l70.2722"></a><span id="l70.2722" class="difflineminus">-      return;</span>
<a href="#l70.2723"></a><span id="l70.2723" class="difflineminus">-    }</span>
<a href="#l70.2724"></a><span id="l70.2724" class="difflineminus">-</span>
<a href="#l70.2725"></a><span id="l70.2725" class="difflineminus">-    let typingState = Ci.prplIConvIM.NOT_TYPING;</span>
<a href="#l70.2726"></a><span id="l70.2726" class="difflineminus">-    let state;</span>
<a href="#l70.2727"></a><span id="l70.2727" class="difflineminus">-    let s = aStanza.getChildrenByNS(Stanza.NS.chatstates);</span>
<a href="#l70.2728"></a><span id="l70.2728" class="difflineminus">-    if (s.length &gt; 0) {</span>
<a href="#l70.2729"></a><span id="l70.2729" class="difflineminus">-      state = s[0].localName;</span>
<a href="#l70.2730"></a><span id="l70.2730" class="difflineminus">-    }</span>
<a href="#l70.2731"></a><span id="l70.2731" class="difflineminus">-    if (state) {</span>
<a href="#l70.2732"></a><span id="l70.2732" class="difflineminus">-      this.DEBUG(state);</span>
<a href="#l70.2733"></a><span id="l70.2733" class="difflineminus">-      if (state == &quot;composing&quot;) {</span>
<a href="#l70.2734"></a><span id="l70.2734" class="difflineminus">-        typingState = Ci.prplIConvIM.TYPING;</span>
<a href="#l70.2735"></a><span id="l70.2735" class="difflineminus">-      } else if (state == &quot;paused&quot;) {</span>
<a href="#l70.2736"></a><span id="l70.2736" class="difflineminus">-        typingState = Ci.prplIConvIM.TYPED;</span>
<a href="#l70.2737"></a><span id="l70.2737" class="difflineminus">-      }</span>
<a href="#l70.2738"></a><span id="l70.2738" class="difflineminus">-    }</span>
<a href="#l70.2739"></a><span id="l70.2739" class="difflineminus">-    let convName = normConvJid;</span>
<a href="#l70.2740"></a><span id="l70.2740" class="difflineminus">-</span>
<a href="#l70.2741"></a><span id="l70.2741" class="difflineminus">-    // If the bare JID is a MUC that we have joined, use the full JID as this</span>
<a href="#l70.2742"></a><span id="l70.2742" class="difflineminus">-    // is a private message to a MUC participant.</span>
<a href="#l70.2743"></a><span id="l70.2743" class="difflineminus">-    if (isMuc) {</span>
<a href="#l70.2744"></a><span id="l70.2744" class="difflineminus">-      convName = convJid;</span>
<a href="#l70.2745"></a><span id="l70.2745" class="difflineminus">-    }</span>
<a href="#l70.2746"></a><span id="l70.2746" class="difflineminus">-</span>
<a href="#l70.2747"></a><span id="l70.2747" class="difflineminus">-    let conv = this._conv.get(convName);</span>
<a href="#l70.2748"></a><span id="l70.2748" class="difflineminus">-    if (!conv) {</span>
<a href="#l70.2749"></a><span id="l70.2749" class="difflineminus">-      return;</span>
<a href="#l70.2750"></a><span id="l70.2750" class="difflineminus">-    }</span>
<a href="#l70.2751"></a><span id="l70.2751" class="difflineminus">-    conv.updateTyping(typingState, conv.shortName);</span>
<a href="#l70.2752"></a><span id="l70.2752" class="difflineminus">-    conv.supportChatStateNotifications = !!state;</span>
<a href="#l70.2753"></a><span id="l70.2753" class="difflineminus">-  },</span>
<a href="#l70.2754"></a><span id="l70.2754" class="difflineminus">-</span>
<a href="#l70.2755"></a><span id="l70.2755" class="difflineminus">-  /* Called when there is an error in the xmpp session */</span>
<a href="#l70.2756"></a><span id="l70.2756" class="difflineminus">-  onError(aError, aException) {</span>
<a href="#l70.2757"></a><span id="l70.2757" class="difflineminus">-    if (aError === null || aError === undefined) {</span>
<a href="#l70.2758"></a><span id="l70.2758" class="difflineminus">-      aError = Ci.prplIAccount.ERROR_OTHER_ERROR;</span>
<a href="#l70.2759"></a><span id="l70.2759" class="difflineminus">-    }</span>
<a href="#l70.2760"></a><span id="l70.2760" class="difflineminus">-    this._disconnect(aError, aException.toString());</span>
<a href="#l70.2761"></a><span id="l70.2761" class="difflineminus">-  },</span>
<a href="#l70.2762"></a><span id="l70.2762" class="difflineminus">-</span>
<a href="#l70.2763"></a><span id="l70.2763" class="difflineminus">-  onVCard(aStanza) {</span>
<a href="#l70.2764"></a><span id="l70.2764" class="difflineminus">-    let jid = this._pendingVCardRequests.shift();</span>
<a href="#l70.2765"></a><span id="l70.2765" class="difflineminus">-    this._requestNextVCard();</span>
<a href="#l70.2766"></a><span id="l70.2766" class="difflineminus">-    if (!this._buddies.has(jid)) {</span>
<a href="#l70.2767"></a><span id="l70.2767" class="difflineminus">-      this.WARN(&quot;Received a vCard for unknown buddy &quot; + jid);</span>
<a href="#l70.2768"></a><span id="l70.2768" class="difflineminus">-      return;</span>
<a href="#l70.2769"></a><span id="l70.2769" class="difflineminus">-    }</span>
<a href="#l70.2770"></a><span id="l70.2770" class="difflineminus">-</span>
<a href="#l70.2771"></a><span id="l70.2771" class="difflineminus">-    let vCard = aStanza.getElement([&quot;vCard&quot;]);</span>
<a href="#l70.2772"></a><span id="l70.2772" class="difflineminus">-    let error = this.parseError(aStanza);</span>
<a href="#l70.2773"></a><span id="l70.2773" class="difflineminus">-    if (</span>
<a href="#l70.2774"></a><span id="l70.2774" class="difflineminus">-      (error &amp;&amp;</span>
<a href="#l70.2775"></a><span id="l70.2775" class="difflineminus">-        (error.condition == &quot;item-not-found&quot; ||</span>
<a href="#l70.2776"></a><span id="l70.2776" class="difflineminus">-          error.condition == &quot;service-unavailable&quot;)) ||</span>
<a href="#l70.2777"></a><span id="l70.2777" class="difflineminus">-      !vCard ||</span>
<a href="#l70.2778"></a><span id="l70.2778" class="difflineminus">-      !vCard.children.length</span>
<a href="#l70.2779"></a><span id="l70.2779" class="difflineminus">-    ) {</span>
<a href="#l70.2780"></a><span id="l70.2780" class="difflineminus">-      this.LOG(&quot;No vCard exists (or the user does not exist) for &quot; + jid);</span>
<a href="#l70.2781"></a><span id="l70.2781" class="difflineminus">-      return;</span>
<a href="#l70.2782"></a><span id="l70.2782" class="difflineminus">-    } else if (error) {</span>
<a href="#l70.2783"></a><span id="l70.2783" class="difflineminus">-      this.WARN(&quot;Received unexpected vCard error &quot; + error.condition);</span>
<a href="#l70.2784"></a><span id="l70.2784" class="difflineminus">-      return;</span>
<a href="#l70.2785"></a><span id="l70.2785" class="difflineminus">-    }</span>
<a href="#l70.2786"></a><span id="l70.2786" class="difflineminus">-</span>
<a href="#l70.2787"></a><span id="l70.2787" class="difflineminus">-    let buddy = this._buddies.get(jid);</span>
<a href="#l70.2788"></a><span id="l70.2788" class="difflineminus">-    let stanzaJid = this.normalize(aStanza.attributes.from);</span>
<a href="#l70.2789"></a><span id="l70.2789" class="difflineminus">-    if (jid &amp;&amp; jid != stanzaJid) {</span>
<a href="#l70.2790"></a><span id="l70.2790" class="difflineminus">-      this.ERROR(</span>
<a href="#l70.2791"></a><span id="l70.2791" class="difflineminus">-        &quot;Received vCard for a different jid (&quot; +</span>
<a href="#l70.2792"></a><span id="l70.2792" class="difflineminus">-          stanzaJid +</span>
<a href="#l70.2793"></a><span id="l70.2793" class="difflineminus">-          &quot;) &quot; +</span>
<a href="#l70.2794"></a><span id="l70.2794" class="difflineminus">-          &quot;than the requested &quot; +</span>
<a href="#l70.2795"></a><span id="l70.2795" class="difflineminus">-          jid</span>
<a href="#l70.2796"></a><span id="l70.2796" class="difflineminus">-      );</span>
<a href="#l70.2797"></a><span id="l70.2797" class="difflineminus">-    }</span>
<a href="#l70.2798"></a><span id="l70.2798" class="difflineminus">-</span>
<a href="#l70.2799"></a><span id="l70.2799" class="difflineminus">-    let foundFormattedName = false;</span>
<a href="#l70.2800"></a><span id="l70.2800" class="difflineminus">-    let vCardInfo = this.parseVCard(vCard);</span>
<a href="#l70.2801"></a><span id="l70.2801" class="difflineminus">-    if (vCardInfo.fullName) {</span>
<a href="#l70.2802"></a><span id="l70.2802" class="difflineminus">-      buddy.vCardFormattedName = vCardInfo.fullName;</span>
<a href="#l70.2803"></a><span id="l70.2803" class="difflineminus">-      foundFormattedName = true;</span>
<a href="#l70.2804"></a><span id="l70.2804" class="difflineminus">-    }</span>
<a href="#l70.2805"></a><span id="l70.2805" class="difflineminus">-    if (vCardInfo.photo) {</span>
<a href="#l70.2806"></a><span id="l70.2806" class="difflineminus">-      buddy._saveIcon(vCardInfo.photo);</span>
<a href="#l70.2807"></a><span id="l70.2807" class="difflineminus">-    }</span>
<a href="#l70.2808"></a><span id="l70.2808" class="difflineminus">-    if (!foundFormattedName &amp;&amp; buddy._vCardFormattedName) {</span>
<a href="#l70.2809"></a><span id="l70.2809" class="difflineminus">-      buddy.vCardFormattedName = &quot;&quot;;</span>
<a href="#l70.2810"></a><span id="l70.2810" class="difflineminus">-    }</span>
<a href="#l70.2811"></a><span id="l70.2811" class="difflineminus">-    buddy._vCardReceived = true;</span>
<a href="#l70.2812"></a><span id="l70.2812" class="difflineminus">-  },</span>
<a href="#l70.2813"></a><span id="l70.2813" class="difflineminus">-</span>
<a href="#l70.2814"></a><span id="l70.2814" class="difflineminus">-  _requestNextVCard() {</span>
<a href="#l70.2815"></a><span id="l70.2815" class="difflineminus">-    if (!this._pendingVCardRequests.length) {</span>
<a href="#l70.2816"></a><span id="l70.2816" class="difflineminus">-      return;</span>
<a href="#l70.2817"></a><span id="l70.2817" class="difflineminus">-    }</span>
<a href="#l70.2818"></a><span id="l70.2818" class="difflineminus">-    let s = Stanza.iq(</span>
<a href="#l70.2819"></a><span id="l70.2819" class="difflineminus">-      &quot;get&quot;,</span>
<a href="#l70.2820"></a><span id="l70.2820" class="difflineminus">-      null,</span>
<a href="#l70.2821"></a><span id="l70.2821" class="difflineminus">-      this._pendingVCardRequests[0],</span>
<a href="#l70.2822"></a><span id="l70.2822" class="difflineminus">-      Stanza.node(&quot;vCard&quot;, Stanza.NS.vcard)</span>
<a href="#l70.2823"></a><span id="l70.2823" class="difflineminus">-    );</span>
<a href="#l70.2824"></a><span id="l70.2824" class="difflineminus">-    this.sendStanza(s, this.onVCard, this);</span>
<a href="#l70.2825"></a><span id="l70.2825" class="difflineminus">-  },</span>
<a href="#l70.2826"></a><span id="l70.2826" class="difflineminus">-</span>
<a href="#l70.2827"></a><span id="l70.2827" class="difflineminus">-  _addVCardRequest(aJID) {</span>
<a href="#l70.2828"></a><span id="l70.2828" class="difflineminus">-    let requestPending = !!this._pendingVCardRequests.length;</span>
<a href="#l70.2829"></a><span id="l70.2829" class="difflineminus">-    this._pendingVCardRequests.push(aJID);</span>
<a href="#l70.2830"></a><span id="l70.2830" class="difflineminus">-    if (!requestPending) {</span>
<a href="#l70.2831"></a><span id="l70.2831" class="difflineminus">-      this._requestNextVCard();</span>
<a href="#l70.2832"></a><span id="l70.2832" class="difflineminus">-    }</span>
<a href="#l70.2833"></a><span id="l70.2833" class="difflineminus">-  },</span>
<a href="#l70.2834"></a><span id="l70.2834" class="difflineminus">-</span>
<a href="#l70.2835"></a><span id="l70.2835" class="difflineminus">-  // XEP-0029 (Section 2) and RFC 6122 (Section 2): The node and domain are</span>
<a href="#l70.2836"></a><span id="l70.2836" class="difflineminus">-  // lowercase, while resources are case sensitive and can contain spaces.</span>
<a href="#l70.2837"></a><span id="l70.2837" class="difflineminus">-  normalizeFullJid(aJID) {</span>
<a href="#l70.2838"></a><span id="l70.2838" class="difflineminus">-    return this._parseJID(aJID.trim()).jid;</span>
<a href="#l70.2839"></a><span id="l70.2839" class="difflineminus">-  },</span>
<a href="#l70.2840"></a><span id="l70.2840" class="difflineminus">-</span>
<a href="#l70.2841"></a><span id="l70.2841" class="difflineminus">-  // Standard normalization for XMPP removes the resource part of jids.</span>
<a href="#l70.2842"></a><span id="l70.2842" class="difflineminus">-  normalize(aJID) {</span>
<a href="#l70.2843"></a><span id="l70.2843" class="difflineminus">-    return aJID</span>
<a href="#l70.2844"></a><span id="l70.2844" class="difflineminus">-      .trim()</span>
<a href="#l70.2845"></a><span id="l70.2845" class="difflineminus">-      .split(&quot;/&quot;, 1)[0] // up to first slash</span>
<a href="#l70.2846"></a><span id="l70.2846" class="difflineminus">-      .toLowerCase();</span>
<a href="#l70.2847"></a><span id="l70.2847" class="difflineminus">-  },</span>
<a href="#l70.2848"></a><span id="l70.2848" class="difflineminus">-</span>
<a href="#l70.2849"></a><span id="l70.2849" class="difflineminus">-  // RFC 6122 (Section 2): [ localpart &quot;@&quot; ] domainpart [ &quot;/&quot; resourcepart ] is</span>
<a href="#l70.2850"></a><span id="l70.2850" class="difflineminus">-  // the form of jid.</span>
<a href="#l70.2851"></a><span id="l70.2851" class="difflineminus">-  // Localpart is parsed as node and optional.</span>
<a href="#l70.2852"></a><span id="l70.2852" class="difflineminus">-  // Domainpart is parsed as domain and required.</span>
<a href="#l70.2853"></a><span id="l70.2853" class="difflineminus">-  // resourcepart is parsed as resource and optional.</span>
<a href="#l70.2854"></a><span id="l70.2854" class="difflineminus">-  _parseJID(aJid) {</span>
<a href="#l70.2855"></a><span id="l70.2855" class="difflineminus">-    let match = /^(?:([^&quot;&amp;'/:&lt;&gt;@]+)@)?([^@/&lt;&gt;'\&quot;]+)(?:\/(.*))?$/.exec(</span>
<a href="#l70.2856"></a><span id="l70.2856" class="difflineminus">-      aJid.trim()</span>
<a href="#l70.2857"></a><span id="l70.2857" class="difflineminus">-    );</span>
<a href="#l70.2858"></a><span id="l70.2858" class="difflineminus">-    if (!match) {</span>
<a href="#l70.2859"></a><span id="l70.2859" class="difflineminus">-      return null;</span>
<a href="#l70.2860"></a><span id="l70.2860" class="difflineminus">-    }</span>
<a href="#l70.2861"></a><span id="l70.2861" class="difflineminus">-</span>
<a href="#l70.2862"></a><span id="l70.2862" class="difflineminus">-    let result = {</span>
<a href="#l70.2863"></a><span id="l70.2863" class="difflineminus">-      node: match[1],</span>
<a href="#l70.2864"></a><span id="l70.2864" class="difflineminus">-      domain: match[2].toLowerCase(),</span>
<a href="#l70.2865"></a><span id="l70.2865" class="difflineminus">-      resource: match[3],</span>
<a href="#l70.2866"></a><span id="l70.2866" class="difflineminus">-    };</span>
<a href="#l70.2867"></a><span id="l70.2867" class="difflineminus">-    return this._setJID(result.domain, result.node, result.resource);</span>
<a href="#l70.2868"></a><span id="l70.2868" class="difflineminus">-  },</span>
<a href="#l70.2869"></a><span id="l70.2869" class="difflineminus">-</span>
<a href="#l70.2870"></a><span id="l70.2870" class="difflineminus">-  // Constructs jid as an object from domain, node and resource parts.</span>
<a href="#l70.2871"></a><span id="l70.2871" class="difflineminus">-  // The object has properties (node, domain, resource and jid).</span>
<a href="#l70.2872"></a><span id="l70.2872" class="difflineminus">-  // aDomain is required, but aNode and aResource are optional.</span>
<a href="#l70.2873"></a><span id="l70.2873" class="difflineminus">-  _setJID(aDomain, aNode = null, aResource = null) {</span>
<a href="#l70.2874"></a><span id="l70.2874" class="difflineminus">-    if (!aDomain) {</span>
<a href="#l70.2875"></a><span id="l70.2875" class="difflineminus">-      throw new Error(&quot;aDomain must have a value&quot;);</span>
<a href="#l70.2876"></a><span id="l70.2876" class="difflineminus">-    }</span>
<a href="#l70.2877"></a><span id="l70.2877" class="difflineminus">-</span>
<a href="#l70.2878"></a><span id="l70.2878" class="difflineminus">-    let result = {</span>
<a href="#l70.2879"></a><span id="l70.2879" class="difflineminus">-      node: aNode,</span>
<a href="#l70.2880"></a><span id="l70.2880" class="difflineminus">-      domain: aDomain.toLowerCase(),</span>
<a href="#l70.2881"></a><span id="l70.2881" class="difflineminus">-      resource: aResource,</span>
<a href="#l70.2882"></a><span id="l70.2882" class="difflineminus">-    };</span>
<a href="#l70.2883"></a><span id="l70.2883" class="difflineminus">-    let jid = result.domain;</span>
<a href="#l70.2884"></a><span id="l70.2884" class="difflineminus">-    if (result.node) {</span>
<a href="#l70.2885"></a><span id="l70.2885" class="difflineminus">-      result.node = result.node.toLowerCase();</span>
<a href="#l70.2886"></a><span id="l70.2886" class="difflineminus">-      jid = result.node + &quot;@&quot; + jid;</span>
<a href="#l70.2887"></a><span id="l70.2887" class="difflineminus">-    }</span>
<a href="#l70.2888"></a><span id="l70.2888" class="difflineminus">-    if (result.resource) {</span>
<a href="#l70.2889"></a><span id="l70.2889" class="difflineminus">-      jid += &quot;/&quot; + result.resource;</span>
<a href="#l70.2890"></a><span id="l70.2890" class="difflineminus">-    }</span>
<a href="#l70.2891"></a><span id="l70.2891" class="difflineminus">-    result.jid = jid;</span>
<a href="#l70.2892"></a><span id="l70.2892" class="difflineminus">-    return result;</span>
<a href="#l70.2893"></a><span id="l70.2893" class="difflineminus">-  },</span>
<a href="#l70.2894"></a><span id="l70.2894" class="difflineminus">-</span>
<a href="#l70.2895"></a><span id="l70.2895" class="difflineminus">-  _onRosterItem(aItem, aNotifyOfUpdates) {</span>
<a href="#l70.2896"></a><span id="l70.2896" class="difflineminus">-    let jid = aItem.attributes.jid;</span>
<a href="#l70.2897"></a><span id="l70.2897" class="difflineminus">-    if (!jid) {</span>
<a href="#l70.2898"></a><span id="l70.2898" class="difflineminus">-      this.WARN(&quot;Received a roster item without jid: &quot; + aItem.getXML());</span>
<a href="#l70.2899"></a><span id="l70.2899" class="difflineminus">-      return &quot;&quot;;</span>
<a href="#l70.2900"></a><span id="l70.2900" class="difflineminus">-    }</span>
<a href="#l70.2901"></a><span id="l70.2901" class="difflineminus">-    jid = this.normalize(jid);</span>
<a href="#l70.2902"></a><span id="l70.2902" class="difflineminus">-</span>
<a href="#l70.2903"></a><span id="l70.2903" class="difflineminus">-    let subscription = &quot;&quot;;</span>
<a href="#l70.2904"></a><span id="l70.2904" class="difflineminus">-    if (&quot;subscription&quot; in aItem.attributes) {</span>
<a href="#l70.2905"></a><span id="l70.2905" class="difflineminus">-      subscription = aItem.attributes.subscription;</span>
<a href="#l70.2906"></a><span id="l70.2906" class="difflineminus">-    }</span>
<a href="#l70.2907"></a><span id="l70.2907" class="difflineminus">-    if (subscription == &quot;remove&quot;) {</span>
<a href="#l70.2908"></a><span id="l70.2908" class="difflineminus">-      this._forgetRosterItem(jid);</span>
<a href="#l70.2909"></a><span id="l70.2909" class="difflineminus">-      return &quot;&quot;;</span>
<a href="#l70.2910"></a><span id="l70.2910" class="difflineminus">-    }</span>
<a href="#l70.2911"></a><span id="l70.2911" class="difflineminus">-</span>
<a href="#l70.2912"></a><span id="l70.2912" class="difflineminus">-    let buddy;</span>
<a href="#l70.2913"></a><span id="l70.2913" class="difflineminus">-    if (this._buddies.has(jid)) {</span>
<a href="#l70.2914"></a><span id="l70.2914" class="difflineminus">-      buddy = this._buddies.get(jid);</span>
<a href="#l70.2915"></a><span id="l70.2915" class="difflineminus">-      let groups = aItem.getChildren(&quot;group&quot;);</span>
<a href="#l70.2916"></a><span id="l70.2916" class="difflineminus">-      if (groups.length) {</span>
<a href="#l70.2917"></a><span id="l70.2917" class="difflineminus">-        // If the server specified at least one group, ensure the group we use</span>
<a href="#l70.2918"></a><span id="l70.2918" class="difflineminus">-        // as the account buddy's tag is still a group on the server...</span>
<a href="#l70.2919"></a><span id="l70.2919" class="difflineminus">-        let tagName = buddy.tag.name;</span>
<a href="#l70.2920"></a><span id="l70.2920" class="difflineminus">-        if (!groups.some(g =&gt; g.innerText == tagName)) {</span>
<a href="#l70.2921"></a><span id="l70.2921" class="difflineminus">-          // ... otherwise we need to move our account buddy to a new group.</span>
<a href="#l70.2922"></a><span id="l70.2922" class="difflineminus">-          tagName = groups[0].innerText;</span>
<a href="#l70.2923"></a><span id="l70.2923" class="difflineminus">-          if (tagName) {</span>
<a href="#l70.2924"></a><span id="l70.2924" class="difflineminus">-            // Should always be true, but check just in case...</span>
<a href="#l70.2925"></a><span id="l70.2925" class="difflineminus">-            let oldTag = buddy.tag;</span>
<a href="#l70.2926"></a><span id="l70.2926" class="difflineminus">-            buddy._tag = Services.tags.createTag(tagName);</span>
<a href="#l70.2927"></a><span id="l70.2927" class="difflineminus">-            Services.contacts.accountBuddyMoved(buddy, oldTag, buddy._tag);</span>
<a href="#l70.2928"></a><span id="l70.2928" class="difflineminus">-          }</span>
<a href="#l70.2929"></a><span id="l70.2929" class="difflineminus">-        }</span>
<a href="#l70.2930"></a><span id="l70.2930" class="difflineminus">-      }</span>
<a href="#l70.2931"></a><span id="l70.2931" class="difflineminus">-    } else {</span>
<a href="#l70.2932"></a><span id="l70.2932" class="difflineminus">-      let tag;</span>
<a href="#l70.2933"></a><span id="l70.2933" class="difflineminus">-      for (let group of aItem.getChildren(&quot;group&quot;)) {</span>
<a href="#l70.2934"></a><span id="l70.2934" class="difflineminus">-        let name = group.innerText;</span>
<a href="#l70.2935"></a><span id="l70.2935" class="difflineminus">-        if (name) {</span>
<a href="#l70.2936"></a><span id="l70.2936" class="difflineminus">-          tag = Services.tags.createTag(name);</span>
<a href="#l70.2937"></a><span id="l70.2937" class="difflineminus">-          break; // TODO we should create an accountBuddy per group,</span>
<a href="#l70.2938"></a><span id="l70.2938" class="difflineminus">-          // but this._buddies would probably not like that...</span>
<a href="#l70.2939"></a><span id="l70.2939" class="difflineminus">-        }</span>
<a href="#l70.2940"></a><span id="l70.2940" class="difflineminus">-      }</span>
<a href="#l70.2941"></a><span id="l70.2941" class="difflineminus">-      buddy = new this._accountBuddyConstructor(</span>
<a href="#l70.2942"></a><span id="l70.2942" class="difflineminus">-        this,</span>
<a href="#l70.2943"></a><span id="l70.2943" class="difflineminus">-        null,</span>
<a href="#l70.2944"></a><span id="l70.2944" class="difflineminus">-        tag || Services.tags.defaultTag,</span>
<a href="#l70.2945"></a><span id="l70.2945" class="difflineminus">-        jid</span>
<a href="#l70.2946"></a><span id="l70.2946" class="difflineminus">-      );</span>
<a href="#l70.2947"></a><span id="l70.2947" class="difflineminus">-    }</span>
<a href="#l70.2948"></a><span id="l70.2948" class="difflineminus">-</span>
<a href="#l70.2949"></a><span id="l70.2949" class="difflineminus">-    // We request the vCard only if we haven't received it yet and are</span>
<a href="#l70.2950"></a><span id="l70.2950" class="difflineminus">-    // subscribed to presence for that contact.</span>
<a href="#l70.2951"></a><span id="l70.2951" class="difflineminus">-    if (</span>
<a href="#l70.2952"></a><span id="l70.2952" class="difflineminus">-      (subscription == &quot;both&quot; || subscription == &quot;to&quot;) &amp;&amp;</span>
<a href="#l70.2953"></a><span id="l70.2953" class="difflineminus">-      !buddy._vCardReceived</span>
<a href="#l70.2954"></a><span id="l70.2954" class="difflineminus">-    ) {</span>
<a href="#l70.2955"></a><span id="l70.2955" class="difflineminus">-      this._addVCardRequest(jid);</span>
<a href="#l70.2956"></a><span id="l70.2956" class="difflineminus">-    }</span>
<a href="#l70.2957"></a><span id="l70.2957" class="difflineminus">-</span>
<a href="#l70.2958"></a><span id="l70.2958" class="difflineminus">-    let alias = &quot;name&quot; in aItem.attributes ? aItem.attributes.name : &quot;&quot;;</span>
<a href="#l70.2959"></a><span id="l70.2959" class="difflineminus">-    if (alias) {</span>
<a href="#l70.2960"></a><span id="l70.2960" class="difflineminus">-      if (aNotifyOfUpdates &amp;&amp; this._buddies.has(jid)) {</span>
<a href="#l70.2961"></a><span id="l70.2961" class="difflineminus">-        buddy.rosterAlias = alias;</span>
<a href="#l70.2962"></a><span id="l70.2962" class="difflineminus">-      } else {</span>
<a href="#l70.2963"></a><span id="l70.2963" class="difflineminus">-        buddy._rosterAlias = alias;</span>
<a href="#l70.2964"></a><span id="l70.2964" class="difflineminus">-      }</span>
<a href="#l70.2965"></a><span id="l70.2965" class="difflineminus">-    } else if (buddy._rosterAlias) {</span>
<a href="#l70.2966"></a><span id="l70.2966" class="difflineminus">-      buddy.rosterAlias = &quot;&quot;;</span>
<a href="#l70.2967"></a><span id="l70.2967" class="difflineminus">-    }</span>
<a href="#l70.2968"></a><span id="l70.2968" class="difflineminus">-</span>
<a href="#l70.2969"></a><span id="l70.2969" class="difflineminus">-    if (subscription) {</span>
<a href="#l70.2970"></a><span id="l70.2970" class="difflineminus">-      buddy.subscription = subscription;</span>
<a href="#l70.2971"></a><span id="l70.2971" class="difflineminus">-    }</span>
<a href="#l70.2972"></a><span id="l70.2972" class="difflineminus">-    if (!this._buddies.has(jid)) {</span>
<a href="#l70.2973"></a><span id="l70.2973" class="difflineminus">-      this._buddies.set(jid, buddy);</span>
<a href="#l70.2974"></a><span id="l70.2974" class="difflineminus">-      Services.contacts.accountBuddyAdded(buddy);</span>
<a href="#l70.2975"></a><span id="l70.2975" class="difflineminus">-    } else if (aNotifyOfUpdates) {</span>
<a href="#l70.2976"></a><span id="l70.2976" class="difflineminus">-      buddy._notifyObservers(&quot;status-detail-changed&quot;);</span>
<a href="#l70.2977"></a><span id="l70.2977" class="difflineminus">-    }</span>
<a href="#l70.2978"></a><span id="l70.2978" class="difflineminus">-</span>
<a href="#l70.2979"></a><span id="l70.2979" class="difflineminus">-    // Keep the xml nodes of the item so that we don't have to</span>
<a href="#l70.2980"></a><span id="l70.2980" class="difflineminus">-    // recreate them when changing something (eg. the alias) in it.</span>
<a href="#l70.2981"></a><span id="l70.2981" class="difflineminus">-    buddy._rosterItem = aItem;</span>
<a href="#l70.2982"></a><span id="l70.2982" class="difflineminus">-</span>
<a href="#l70.2983"></a><span id="l70.2983" class="difflineminus">-    return jid;</span>
<a href="#l70.2984"></a><span id="l70.2984" class="difflineminus">-  },</span>
<a href="#l70.2985"></a><span id="l70.2985" class="difflineminus">-  _forgetRosterItem(aJID) {</span>
<a href="#l70.2986"></a><span id="l70.2986" class="difflineminus">-    Services.contacts.accountBuddyRemoved(this._buddies.get(aJID));</span>
<a href="#l70.2987"></a><span id="l70.2987" class="difflineminus">-    this._buddies.delete(aJID);</span>
<a href="#l70.2988"></a><span id="l70.2988" class="difflineminus">-  },</span>
<a href="#l70.2989"></a><span id="l70.2989" class="difflineminus">-</span>
<a href="#l70.2990"></a><span id="l70.2990" class="difflineminus">-  /* When the roster is received */</span>
<a href="#l70.2991"></a><span id="l70.2991" class="difflineminus">-  onRoster(aStanza) {</span>
<a href="#l70.2992"></a><span id="l70.2992" class="difflineminus">-    // For the first element that is a roster stanza.</span>
<a href="#l70.2993"></a><span id="l70.2993" class="difflineminus">-    for (let qe of aStanza.getChildren(&quot;query&quot;)) {</span>
<a href="#l70.2994"></a><span id="l70.2994" class="difflineminus">-      if (qe.uri != Stanza.NS.roster) {</span>
<a href="#l70.2995"></a><span id="l70.2995" class="difflineminus">-        continue;</span>
<a href="#l70.2996"></a><span id="l70.2996" class="difflineminus">-      }</span>
<a href="#l70.2997"></a><span id="l70.2997" class="difflineminus">-</span>
<a href="#l70.2998"></a><span id="l70.2998" class="difflineminus">-      // Find all the roster items in the new message.</span>
<a href="#l70.2999"></a><span id="l70.2999" class="difflineminus">-      let newRoster = new Set();</span>
<a href="#l70.3000"></a><span id="l70.3000" class="difflineminus">-      for (let item of qe.getChildren(&quot;item&quot;)) {</span>
<a href="#l70.3001"></a><span id="l70.3001" class="difflineminus">-        let jid = this._onRosterItem(item);</span>
<a href="#l70.3002"></a><span id="l70.3002" class="difflineminus">-        if (jid) {</span>
<a href="#l70.3003"></a><span id="l70.3003" class="difflineminus">-          newRoster.add(jid);</span>
<a href="#l70.3004"></a><span id="l70.3004" class="difflineminus">-        }</span>
<a href="#l70.3005"></a><span id="l70.3005" class="difflineminus">-      }</span>
<a href="#l70.3006"></a><span id="l70.3006" class="difflineminus">-      // If an item was in the old roster, but not in the new, forget it.</span>
<a href="#l70.3007"></a><span id="l70.3007" class="difflineminus">-      for (let jid of this._buddies.keys()) {</span>
<a href="#l70.3008"></a><span id="l70.3008" class="difflineminus">-        if (!newRoster.has(jid)) {</span>
<a href="#l70.3009"></a><span id="l70.3009" class="difflineminus">-          this._forgetRosterItem(jid);</span>
<a href="#l70.3010"></a><span id="l70.3010" class="difflineminus">-        }</span>
<a href="#l70.3011"></a><span id="l70.3011" class="difflineminus">-      }</span>
<a href="#l70.3012"></a><span id="l70.3012" class="difflineminus">-      break;</span>
<a href="#l70.3013"></a><span id="l70.3013" class="difflineminus">-    }</span>
<a href="#l70.3014"></a><span id="l70.3014" class="difflineminus">-</span>
<a href="#l70.3015"></a><span id="l70.3015" class="difflineminus">-    this._sendPresence();</span>
<a href="#l70.3016"></a><span id="l70.3016" class="difflineminus">-    this._buddies.forEach(b =&gt; {</span>
<a href="#l70.3017"></a><span id="l70.3017" class="difflineminus">-      if (b.subscription == &quot;both&quot; || b.subscription == &quot;to&quot;) {</span>
<a href="#l70.3018"></a><span id="l70.3018" class="difflineminus">-        b.setStatus(Ci.imIStatusInfo.STATUS_OFFLINE, &quot;&quot;);</span>
<a href="#l70.3019"></a><span id="l70.3019" class="difflineminus">-      }</span>
<a href="#l70.3020"></a><span id="l70.3020" class="difflineminus">-    });</span>
<a href="#l70.3021"></a><span id="l70.3021" class="difflineminus">-    this.reportConnected();</span>
<a href="#l70.3022"></a><span id="l70.3022" class="difflineminus">-    this._sendVCard();</span>
<a href="#l70.3023"></a><span id="l70.3023" class="difflineminus">-  },</span>
<a href="#l70.3024"></a><span id="l70.3024" class="difflineminus">-</span>
<a href="#l70.3025"></a><span id="l70.3025" class="difflineminus">-  /* Public methods */</span>
<a href="#l70.3026"></a><span id="l70.3026" class="difflineminus">-</span>
<a href="#l70.3027"></a><span id="l70.3027" class="difflineminus">-  sendStanza(aStanza, aCallback, aThis, aLogString) {</span>
<a href="#l70.3028"></a><span id="l70.3028" class="difflineminus">-    return this._connection.sendStanza(aStanza, aCallback, aThis, aLogString);</span>
<a href="#l70.3029"></a><span id="l70.3029" class="difflineminus">-  },</span>
<a href="#l70.3030"></a><span id="l70.3030" class="difflineminus">-</span>
<a href="#l70.3031"></a><span id="l70.3031" class="difflineminus">-  // Variations of the XMPP protocol can change these default constructors:</span>
<a href="#l70.3032"></a><span id="l70.3032" class="difflineminus">-  _conversationConstructor: XMPPConversation,</span>
<a href="#l70.3033"></a><span id="l70.3033" class="difflineminus">-  _MUCConversationConstructor: XMPPMUCConversation,</span>
<a href="#l70.3034"></a><span id="l70.3034" class="difflineminus">-  _accountBuddyConstructor: XMPPAccountBuddy,</span>
<a href="#l70.3035"></a><span id="l70.3035" class="difflineminus">-</span>
<a href="#l70.3036"></a><span id="l70.3036" class="difflineminus">-  /* Create a new conversation */</span>
<a href="#l70.3037"></a><span id="l70.3037" class="difflineminus">-  createConversation(aName) {</span>
<a href="#l70.3038"></a><span id="l70.3038" class="difflineminus">-    let convName = this.normalize(aName);</span>
<a href="#l70.3039"></a><span id="l70.3039" class="difflineminus">-</span>
<a href="#l70.3040"></a><span id="l70.3040" class="difflineminus">-    // Checks if conversation is with a participant of a MUC we are in. We do</span>
<a href="#l70.3041"></a><span id="l70.3041" class="difflineminus">-    // not want to strip the resource as it is of the form room@domain/nick.</span>
<a href="#l70.3042"></a><span id="l70.3042" class="difflineminus">-    let isMucParticipant = this._mucs.has(convName);</span>
<a href="#l70.3043"></a><span id="l70.3043" class="difflineminus">-    if (isMucParticipant) {</span>
<a href="#l70.3044"></a><span id="l70.3044" class="difflineminus">-      convName = this.normalizeFullJid(aName);</span>
<a href="#l70.3045"></a><span id="l70.3045" class="difflineminus">-    }</span>
<a href="#l70.3046"></a><span id="l70.3046" class="difflineminus">-</span>
<a href="#l70.3047"></a><span id="l70.3047" class="difflineminus">-    // Checking that the aName can be parsed and is not broken.</span>
<a href="#l70.3048"></a><span id="l70.3048" class="difflineminus">-    let jid = this._parseJID(convName);</span>
<a href="#l70.3049"></a><span id="l70.3049" class="difflineminus">-    if (</span>
<a href="#l70.3050"></a><span id="l70.3050" class="difflineminus">-      !jid ||</span>
<a href="#l70.3051"></a><span id="l70.3051" class="difflineminus">-      !jid.domain ||</span>
<a href="#l70.3052"></a><span id="l70.3052" class="difflineminus">-      (isMucParticipant &amp;&amp; (!jid.node || !jid.resource))</span>
<a href="#l70.3053"></a><span id="l70.3053" class="difflineminus">-    ) {</span>
<a href="#l70.3054"></a><span id="l70.3054" class="difflineminus">-      this.ERROR(&quot;Could not create conversation as jid is broken: &quot; + convName);</span>
<a href="#l70.3055"></a><span id="l70.3055" class="difflineminus">-      throw new Error(&quot;Invalid JID&quot;);</span>
<a href="#l70.3056"></a><span id="l70.3056" class="difflineminus">-    }</span>
<a href="#l70.3057"></a><span id="l70.3057" class="difflineminus">-</span>
<a href="#l70.3058"></a><span id="l70.3058" class="difflineminus">-    if (!this._conv.has(convName)) {</span>
<a href="#l70.3059"></a><span id="l70.3059" class="difflineminus">-      this._conv.set(</span>
<a href="#l70.3060"></a><span id="l70.3060" class="difflineminus">-        convName,</span>
<a href="#l70.3061"></a><span id="l70.3061" class="difflineminus">-        new this._conversationConstructor(this, convName, isMucParticipant)</span>
<a href="#l70.3062"></a><span id="l70.3062" class="difflineminus">-      );</span>
<a href="#l70.3063"></a><span id="l70.3063" class="difflineminus">-    }</span>
<a href="#l70.3064"></a><span id="l70.3064" class="difflineminus">-</span>
<a href="#l70.3065"></a><span id="l70.3065" class="difflineminus">-    return this._conv.get(convName);</span>
<a href="#l70.3066"></a><span id="l70.3066" class="difflineminus">-  },</span>
<a href="#l70.3067"></a><span id="l70.3067" class="difflineminus">-</span>
<a href="#l70.3068"></a><span id="l70.3068" class="difflineminus">-  /* Remove an existing conversation */</span>
<a href="#l70.3069"></a><span id="l70.3069" class="difflineminus">-  removeConversation(aNormalizedName) {</span>
<a href="#l70.3070"></a><span id="l70.3070" class="difflineminus">-    if (this._conv.has(aNormalizedName)) {</span>
<a href="#l70.3071"></a><span id="l70.3071" class="difflineminus">-      this._conv.delete(aNormalizedName);</span>
<a href="#l70.3072"></a><span id="l70.3072" class="difflineminus">-    } else if (this._mucs.has(aNormalizedName)) {</span>
<a href="#l70.3073"></a><span id="l70.3073" class="difflineminus">-      this._mucs.delete(aNormalizedName);</span>
<a href="#l70.3074"></a><span id="l70.3074" class="difflineminus">-    }</span>
<a href="#l70.3075"></a><span id="l70.3075" class="difflineminus">-  },</span>
<a href="#l70.3076"></a><span id="l70.3076" class="difflineminus">-</span>
<a href="#l70.3077"></a><span id="l70.3077" class="difflineminus">-  /* Private methods */</span>
<a href="#l70.3078"></a><span id="l70.3078" class="difflineminus">-</span>
<a href="#l70.3079"></a><span id="l70.3079" class="difflineminus">-  /* Disconnect from the server */</span>
<a href="#l70.3080"></a><span id="l70.3080" class="difflineminus">-  /* The aError and aErrorMessage parameters are passed to reportDisconnecting</span>
<a href="#l70.3081"></a><span id="l70.3081" class="difflineminus">-   * and used by the account manager.</span>
<a href="#l70.3082"></a><span id="l70.3082" class="difflineminus">-   * The aQuiet parameter is to avoid sending status change notifications</span>
<a href="#l70.3083"></a><span id="l70.3083" class="difflineminus">-   * during the uninitialization of the account. */</span>
<a href="#l70.3084"></a><span id="l70.3084" class="difflineminus">-  _disconnect(</span>
<a href="#l70.3085"></a><span id="l70.3085" class="difflineminus">-    aError = Ci.prplIAccount.NO_ERROR,</span>
<a href="#l70.3086"></a><span id="l70.3086" class="difflineminus">-    aErrorMessage = &quot;&quot;,</span>
<a href="#l70.3087"></a><span id="l70.3087" class="difflineminus">-    aQuiet = false</span>
<a href="#l70.3088"></a><span id="l70.3088" class="difflineminus">-  ) {</span>
<a href="#l70.3089"></a><span id="l70.3089" class="difflineminus">-    if (!this._connection) {</span>
<a href="#l70.3090"></a><span id="l70.3090" class="difflineminus">-      return;</span>
<a href="#l70.3091"></a><span id="l70.3091" class="difflineminus">-    }</span>
<a href="#l70.3092"></a><span id="l70.3092" class="difflineminus">-</span>
<a href="#l70.3093"></a><span id="l70.3093" class="difflineminus">-    this.reportDisconnecting(aError, aErrorMessage);</span>
<a href="#l70.3094"></a><span id="l70.3094" class="difflineminus">-</span>
<a href="#l70.3095"></a><span id="l70.3095" class="difflineminus">-    this._buddies.forEach(b =&gt; {</span>
<a href="#l70.3096"></a><span id="l70.3096" class="difflineminus">-      if (!aQuiet) {</span>
<a href="#l70.3097"></a><span id="l70.3097" class="difflineminus">-        b.setStatus(Ci.imIStatusInfo.STATUS_UNKNOWN, &quot;&quot;);</span>
<a href="#l70.3098"></a><span id="l70.3098" class="difflineminus">-      }</span>
<a href="#l70.3099"></a><span id="l70.3099" class="difflineminus">-      b.onAccountDisconnected();</span>
<a href="#l70.3100"></a><span id="l70.3100" class="difflineminus">-    });</span>
<a href="#l70.3101"></a><span id="l70.3101" class="difflineminus">-</span>
<a href="#l70.3102"></a><span id="l70.3102" class="difflineminus">-    this._mucs.forEach(muc =&gt; {</span>
<a href="#l70.3103"></a><span id="l70.3103" class="difflineminus">-      muc.joining = false; // In case we never finished joining.</span>
<a href="#l70.3104"></a><span id="l70.3104" class="difflineminus">-      muc.left = true;</span>
<a href="#l70.3105"></a><span id="l70.3105" class="difflineminus">-    });</span>
<a href="#l70.3106"></a><span id="l70.3106" class="difflineminus">-</span>
<a href="#l70.3107"></a><span id="l70.3107" class="difflineminus">-    this._connection.disconnect();</span>
<a href="#l70.3108"></a><span id="l70.3108" class="difflineminus">-    delete this._connection;</span>
<a href="#l70.3109"></a><span id="l70.3109" class="difflineminus">-</span>
<a href="#l70.3110"></a><span id="l70.3110" class="difflineminus">-    // We won't receive &quot;user-icon-changed&quot; notifications while the</span>
<a href="#l70.3111"></a><span id="l70.3111" class="difflineminus">-    // account isn't connected, so clear the cache to avoid keeping an</span>
<a href="#l70.3112"></a><span id="l70.3112" class="difflineminus">-    // obsolete icon.</span>
<a href="#l70.3113"></a><span id="l70.3113" class="difflineminus">-    delete this._cachedUserIcon;</span>
<a href="#l70.3114"></a><span id="l70.3114" class="difflineminus">-    // Also clear the cached user vCard, as we will want to redownload it</span>
<a href="#l70.3115"></a><span id="l70.3115" class="difflineminus">-    // after reconnecting.</span>
<a href="#l70.3116"></a><span id="l70.3116" class="difflineminus">-    delete this._userVCard;</span>
<a href="#l70.3117"></a><span id="l70.3117" class="difflineminus">-</span>
<a href="#l70.3118"></a><span id="l70.3118" class="difflineminus">-    // Clear vCard requests.</span>
<a href="#l70.3119"></a><span id="l70.3119" class="difflineminus">-    this._pendingVCardRequests = [];</span>
<a href="#l70.3120"></a><span id="l70.3120" class="difflineminus">-</span>
<a href="#l70.3121"></a><span id="l70.3121" class="difflineminus">-    this.reportDisconnected();</span>
<a href="#l70.3122"></a><span id="l70.3122" class="difflineminus">-  },</span>
<a href="#l70.3123"></a><span id="l70.3123" class="difflineminus">-</span>
<a href="#l70.3124"></a><span id="l70.3124" class="difflineminus">-  /* Set the user status on the server */</span>
<a href="#l70.3125"></a><span id="l70.3125" class="difflineminus">-  _sendPresence() {</span>
<a href="#l70.3126"></a><span id="l70.3126" class="difflineminus">-    delete this._shouldSendPresenceForIdlenessChange;</span>
<a href="#l70.3127"></a><span id="l70.3127" class="difflineminus">-</span>
<a href="#l70.3128"></a><span id="l70.3128" class="difflineminus">-    if (!this._connection) {</span>
<a href="#l70.3129"></a><span id="l70.3129" class="difflineminus">-      return;</span>
<a href="#l70.3130"></a><span id="l70.3130" class="difflineminus">-    }</span>
<a href="#l70.3131"></a><span id="l70.3131" class="difflineminus">-</span>
<a href="#l70.3132"></a><span id="l70.3132" class="difflineminus">-    let si = this.imAccount.statusInfo;</span>
<a href="#l70.3133"></a><span id="l70.3133" class="difflineminus">-    let statusType = si.statusType;</span>
<a href="#l70.3134"></a><span id="l70.3134" class="difflineminus">-    let show = &quot;&quot;;</span>
<a href="#l70.3135"></a><span id="l70.3135" class="difflineminus">-    if (statusType == Ci.imIStatusInfo.STATUS_UNAVAILABLE) {</span>
<a href="#l70.3136"></a><span id="l70.3136" class="difflineminus">-      show = &quot;dnd&quot;;</span>
<a href="#l70.3137"></a><span id="l70.3137" class="difflineminus">-    } else if (</span>
<a href="#l70.3138"></a><span id="l70.3138" class="difflineminus">-      statusType == Ci.imIStatusInfo.STATUS_AWAY ||</span>
<a href="#l70.3139"></a><span id="l70.3139" class="difflineminus">-      statusType == Ci.imIStatusInfo.STATUS_IDLE</span>
<a href="#l70.3140"></a><span id="l70.3140" class="difflineminus">-    ) {</span>
<a href="#l70.3141"></a><span id="l70.3141" class="difflineminus">-      show = &quot;away&quot;;</span>
<a href="#l70.3142"></a><span id="l70.3142" class="difflineminus">-    }</span>
<a href="#l70.3143"></a><span id="l70.3143" class="difflineminus">-    let children = [];</span>
<a href="#l70.3144"></a><span id="l70.3144" class="difflineminus">-    if (show) {</span>
<a href="#l70.3145"></a><span id="l70.3145" class="difflineminus">-      children.push(Stanza.node(&quot;show&quot;, null, null, show));</span>
<a href="#l70.3146"></a><span id="l70.3146" class="difflineminus">-    }</span>
<a href="#l70.3147"></a><span id="l70.3147" class="difflineminus">-    let statusText = si.statusText;</span>
<a href="#l70.3148"></a><span id="l70.3148" class="difflineminus">-    if (statusText) {</span>
<a href="#l70.3149"></a><span id="l70.3149" class="difflineminus">-      children.push(Stanza.node(&quot;status&quot;, null, null, statusText));</span>
<a href="#l70.3150"></a><span id="l70.3150" class="difflineminus">-    }</span>
<a href="#l70.3151"></a><span id="l70.3151" class="difflineminus">-    if (this._idleSince) {</span>
<a href="#l70.3152"></a><span id="l70.3152" class="difflineminus">-      let time = Math.floor(Date.now() / 1000) - this._idleSince;</span>
<a href="#l70.3153"></a><span id="l70.3153" class="difflineminus">-      children.push(Stanza.node(&quot;query&quot;, Stanza.NS.last, { seconds: time }));</span>
<a href="#l70.3154"></a><span id="l70.3154" class="difflineminus">-    }</span>
<a href="#l70.3155"></a><span id="l70.3155" class="difflineminus">-    if (this.prefs.prefHasUserValue(&quot;priority&quot;)) {</span>
<a href="#l70.3156"></a><span id="l70.3156" class="difflineminus">-      let priority = Math.max(-128, Math.min(127, this.getInt(&quot;priority&quot;)));</span>
<a href="#l70.3157"></a><span id="l70.3157" class="difflineminus">-      if (priority) {</span>
<a href="#l70.3158"></a><span id="l70.3158" class="difflineminus">-        children.push(Stanza.node(&quot;priority&quot;, null, null, priority.toString()));</span>
<a href="#l70.3159"></a><span id="l70.3159" class="difflineminus">-      }</span>
<a href="#l70.3160"></a><span id="l70.3160" class="difflineminus">-    }</span>
<a href="#l70.3161"></a><span id="l70.3161" class="difflineminus">-    this.sendStanza(</span>
<a href="#l70.3162"></a><span id="l70.3162" class="difflineminus">-      Stanza.presence({ &quot;xml:lang&quot;: &quot;en&quot; }, children),</span>
<a href="#l70.3163"></a><span id="l70.3163" class="difflineminus">-      aStanza =&gt; {</span>
<a href="#l70.3164"></a><span id="l70.3164" class="difflineminus">-        // As we are implicitly subscribed to our own presence (rfc6121#4), we</span>
<a href="#l70.3165"></a><span id="l70.3165" class="difflineminus">-        // will receive the presence stanza mirrored back to us. We don't need</span>
<a href="#l70.3166"></a><span id="l70.3166" class="difflineminus">-        // to do anything with this response.</span>
<a href="#l70.3167"></a><span id="l70.3167" class="difflineminus">-        return true;</span>
<a href="#l70.3168"></a><span id="l70.3168" class="difflineminus">-      }</span>
<a href="#l70.3169"></a><span id="l70.3169" class="difflineminus">-    );</span>
<a href="#l70.3170"></a><span id="l70.3170" class="difflineminus">-  },</span>
<a href="#l70.3171"></a><span id="l70.3171" class="difflineminus">-</span>
<a href="#l70.3172"></a><span id="l70.3172" class="difflineminus">-  _downloadingUserVCard: false,</span>
<a href="#l70.3173"></a><span id="l70.3173" class="difflineminus">-  _downloadUserVCard() {</span>
<a href="#l70.3174"></a><span id="l70.3174" class="difflineminus">-    // If a download is already in progress, don't start another one.</span>
<a href="#l70.3175"></a><span id="l70.3175" class="difflineminus">-    if (this._downloadingUserVCard) {</span>
<a href="#l70.3176"></a><span id="l70.3176" class="difflineminus">-      return;</span>
<a href="#l70.3177"></a><span id="l70.3177" class="difflineminus">-    }</span>
<a href="#l70.3178"></a><span id="l70.3178" class="difflineminus">-    this._downloadingUserVCard = true;</span>
<a href="#l70.3179"></a><span id="l70.3179" class="difflineminus">-    let s = Stanza.iq(&quot;get&quot;, null, null, Stanza.node(&quot;vCard&quot;, Stanza.NS.vcard));</span>
<a href="#l70.3180"></a><span id="l70.3180" class="difflineminus">-    this.sendStanza(s, this.onUserVCard, this);</span>
<a href="#l70.3181"></a><span id="l70.3181" class="difflineminus">-  },</span>
<a href="#l70.3182"></a><span id="l70.3182" class="difflineminus">-</span>
<a href="#l70.3183"></a><span id="l70.3183" class="difflineminus">-  onUserVCard(aStanza) {</span>
<a href="#l70.3184"></a><span id="l70.3184" class="difflineminus">-    delete this._downloadingUserVCard;</span>
<a href="#l70.3185"></a><span id="l70.3185" class="difflineminus">-    let userVCard = aStanza.getElement([&quot;vCard&quot;]) || null;</span>
<a href="#l70.3186"></a><span id="l70.3186" class="difflineminus">-    if (userVCard) {</span>
<a href="#l70.3187"></a><span id="l70.3187" class="difflineminus">-      // Strip any server-specific namespace off the incoming vcard</span>
<a href="#l70.3188"></a><span id="l70.3188" class="difflineminus">-      // before storing it.</span>
<a href="#l70.3189"></a><span id="l70.3189" class="difflineminus">-      this._userVCard = Stanza.node(</span>
<a href="#l70.3190"></a><span id="l70.3190" class="difflineminus">-        &quot;vCard&quot;,</span>
<a href="#l70.3191"></a><span id="l70.3191" class="difflineminus">-        Stanza.NS.vcard,</span>
<a href="#l70.3192"></a><span id="l70.3192" class="difflineminus">-        null,</span>
<a href="#l70.3193"></a><span id="l70.3193" class="difflineminus">-        userVCard.children</span>
<a href="#l70.3194"></a><span id="l70.3194" class="difflineminus">-      );</span>
<a href="#l70.3195"></a><span id="l70.3195" class="difflineminus">-    }</span>
<a href="#l70.3196"></a><span id="l70.3196" class="difflineminus">-</span>
<a href="#l70.3197"></a><span id="l70.3197" class="difflineminus">-    // If a user icon exists in the vCard we received from the server,</span>
<a href="#l70.3198"></a><span id="l70.3198" class="difflineminus">-    // we need to ensure the line breaks in its binval are exactly the</span>
<a href="#l70.3199"></a><span id="l70.3199" class="difflineminus">-    // same as those we would include if we sent the icon, and that</span>
<a href="#l70.3200"></a><span id="l70.3200" class="difflineminus">-    // there isn't any other whitespace.</span>
<a href="#l70.3201"></a><span id="l70.3201" class="difflineminus">-    if (this._userVCard) {</span>
<a href="#l70.3202"></a><span id="l70.3202" class="difflineminus">-      let binval = this._userVCard.getElement([&quot;PHOTO&quot;, &quot;BINVAL&quot;]);</span>
<a href="#l70.3203"></a><span id="l70.3203" class="difflineminus">-      if (binval &amp;&amp; binval.children.length) {</span>
<a href="#l70.3204"></a><span id="l70.3204" class="difflineminus">-        binval = binval.children[0];</span>
<a href="#l70.3205"></a><span id="l70.3205" class="difflineminus">-        binval.text = binval.text</span>
<a href="#l70.3206"></a><span id="l70.3206" class="difflineminus">-          .replace(/[^A-Za-z0-9\+\/\=]/g, &quot;&quot;)</span>
<a href="#l70.3207"></a><span id="l70.3207" class="difflineminus">-          .replace(/.{74}/g, &quot;$&amp;\n&quot;);</span>
<a href="#l70.3208"></a><span id="l70.3208" class="difflineminus">-      }</span>
<a href="#l70.3209"></a><span id="l70.3209" class="difflineminus">-    } else {</span>
<a href="#l70.3210"></a><span id="l70.3210" class="difflineminus">-      // Downloading the vCard failed.</span>
<a href="#l70.3211"></a><span id="l70.3211" class="difflineminus">-      if (</span>
<a href="#l70.3212"></a><span id="l70.3212" class="difflineminus">-        this.handleErrors({</span>
<a href="#l70.3213"></a><span id="l70.3213" class="difflineminus">-          itemNotFound: () =&gt; false, // OK, no vCard exists yet.</span>
<a href="#l70.3214"></a><span id="l70.3214" class="difflineminus">-          default: () =&gt; true,</span>
<a href="#l70.3215"></a><span id="l70.3215" class="difflineminus">-        })(aStanza)</span>
<a href="#l70.3216"></a><span id="l70.3216" class="difflineminus">-      ) {</span>
<a href="#l70.3217"></a><span id="l70.3217" class="difflineminus">-        this.WARN(</span>
<a href="#l70.3218"></a><span id="l70.3218" class="difflineminus">-          &quot;Unexpected error retrieving the user's vcard, &quot; +</span>
<a href="#l70.3219"></a><span id="l70.3219" class="difflineminus">-            &quot;so we won't attempt to set it either.&quot;</span>
<a href="#l70.3220"></a><span id="l70.3220" class="difflineminus">-        );</span>
<a href="#l70.3221"></a><span id="l70.3221" class="difflineminus">-        return;</span>
<a href="#l70.3222"></a><span id="l70.3222" class="difflineminus">-      }</span>
<a href="#l70.3223"></a><span id="l70.3223" class="difflineminus">-      // Set this so that we don't get into an infinite loop trying to download</span>
<a href="#l70.3224"></a><span id="l70.3224" class="difflineminus">-      // the vcard again. The check in sendVCard is for hasOwnProperty.</span>
<a href="#l70.3225"></a><span id="l70.3225" class="difflineminus">-      this._userVCard = null;</span>
<a href="#l70.3226"></a><span id="l70.3226" class="difflineminus">-    }</span>
<a href="#l70.3227"></a><span id="l70.3227" class="difflineminus">-    this._sendVCard();</span>
<a href="#l70.3228"></a><span id="l70.3228" class="difflineminus">-  },</span>
<a href="#l70.3229"></a><span id="l70.3229" class="difflineminus">-</span>
<a href="#l70.3230"></a><span id="l70.3230" class="difflineminus">-  _cachingUserIcon: false,</span>
<a href="#l70.3231"></a><span id="l70.3231" class="difflineminus">-  _cacheUserIcon() {</span>
<a href="#l70.3232"></a><span id="l70.3232" class="difflineminus">-    if (this._cachingUserIcon) {</span>
<a href="#l70.3233"></a><span id="l70.3233" class="difflineminus">-      return;</span>
<a href="#l70.3234"></a><span id="l70.3234" class="difflineminus">-    }</span>
<a href="#l70.3235"></a><span id="l70.3235" class="difflineminus">-</span>
<a href="#l70.3236"></a><span id="l70.3236" class="difflineminus">-    let userIcon = this.imAccount.statusInfo.getUserIcon();</span>
<a href="#l70.3237"></a><span id="l70.3237" class="difflineminus">-    if (!userIcon) {</span>
<a href="#l70.3238"></a><span id="l70.3238" class="difflineminus">-      this._cachedUserIcon = null;</span>
<a href="#l70.3239"></a><span id="l70.3239" class="difflineminus">-      this._sendVCard();</span>
<a href="#l70.3240"></a><span id="l70.3240" class="difflineminus">-      return;</span>
<a href="#l70.3241"></a><span id="l70.3241" class="difflineminus">-    }</span>
<a href="#l70.3242"></a><span id="l70.3242" class="difflineminus">-</span>
<a href="#l70.3243"></a><span id="l70.3243" class="difflineminus">-    this._cachingUserIcon = true;</span>
<a href="#l70.3244"></a><span id="l70.3244" class="difflineminus">-    let channel = NetUtil.newChannel({</span>
<a href="#l70.3245"></a><span id="l70.3245" class="difflineminus">-      uri: userIcon,</span>
<a href="#l70.3246"></a><span id="l70.3246" class="difflineminus">-      loadingPrincipal: Services.scriptSecurityManager.getSystemPrincipal(),</span>
<a href="#l70.3247"></a><span id="l70.3247" class="difflineminus">-      securityFlags: Ci.nsILoadInfo.SEC_REQUIRE_SAME_ORIGIN_DATA_INHERITS,</span>
<a href="#l70.3248"></a><span id="l70.3248" class="difflineminus">-      contentPolicyType: Ci.nsIContentPolicy.TYPE_IMAGE,</span>
<a href="#l70.3249"></a><span id="l70.3249" class="difflineminus">-    });</span>
<a href="#l70.3250"></a><span id="l70.3250" class="difflineminus">-    NetUtil.asyncFetch(channel, (inputStream, resultCode) =&gt; {</span>
<a href="#l70.3251"></a><span id="l70.3251" class="difflineminus">-      if (!Components.isSuccessCode(resultCode)) {</span>
<a href="#l70.3252"></a><span id="l70.3252" class="difflineminus">-        return;</span>
<a href="#l70.3253"></a><span id="l70.3253" class="difflineminus">-      }</span>
<a href="#l70.3254"></a><span id="l70.3254" class="difflineminus">-      try {</span>
<a href="#l70.3255"></a><span id="l70.3255" class="difflineminus">-        let type = channel.contentType;</span>
<a href="#l70.3256"></a><span id="l70.3256" class="difflineminus">-        let buffer = NetUtil.readInputStreamToString(</span>
<a href="#l70.3257"></a><span id="l70.3257" class="difflineminus">-          inputStream,</span>
<a href="#l70.3258"></a><span id="l70.3258" class="difflineminus">-          inputStream.available()</span>
<a href="#l70.3259"></a><span id="l70.3259" class="difflineminus">-        );</span>
<a href="#l70.3260"></a><span id="l70.3260" class="difflineminus">-        let readImage = imgTools.decodeImageFromBuffer(</span>
<a href="#l70.3261"></a><span id="l70.3261" class="difflineminus">-          buffer,</span>
<a href="#l70.3262"></a><span id="l70.3262" class="difflineminus">-          buffer.length,</span>
<a href="#l70.3263"></a><span id="l70.3263" class="difflineminus">-          type</span>
<a href="#l70.3264"></a><span id="l70.3264" class="difflineminus">-        );</span>
<a href="#l70.3265"></a><span id="l70.3265" class="difflineminus">-        let scaledImage;</span>
<a href="#l70.3266"></a><span id="l70.3266" class="difflineminus">-        if (readImage.width &lt;= 96 &amp;&amp; readImage.height &lt;= 96) {</span>
<a href="#l70.3267"></a><span id="l70.3267" class="difflineminus">-          scaledImage = imgTools.encodeImage(readImage, type);</span>
<a href="#l70.3268"></a><span id="l70.3268" class="difflineminus">-        } else {</span>
<a href="#l70.3269"></a><span id="l70.3269" class="difflineminus">-          if (type != &quot;image/jpeg&quot;) {</span>
<a href="#l70.3270"></a><span id="l70.3270" class="difflineminus">-            type = &quot;image/png&quot;;</span>
<a href="#l70.3271"></a><span id="l70.3271" class="difflineminus">-          }</span>
<a href="#l70.3272"></a><span id="l70.3272" class="difflineminus">-          scaledImage = imgTools.encodeScaledImage(readImage, type, 64, 64);</span>
<a href="#l70.3273"></a><span id="l70.3273" class="difflineminus">-        }</span>
<a href="#l70.3274"></a><span id="l70.3274" class="difflineminus">-</span>
<a href="#l70.3275"></a><span id="l70.3275" class="difflineminus">-        let bstream = Cc[&quot;@mozilla.org/binaryinputstream;1&quot;].createInstance(</span>
<a href="#l70.3276"></a><span id="l70.3276" class="difflineminus">-          Ci.nsIBinaryInputStream</span>
<a href="#l70.3277"></a><span id="l70.3277" class="difflineminus">-        );</span>
<a href="#l70.3278"></a><span id="l70.3278" class="difflineminus">-        bstream.setInputStream(scaledImage);</span>
<a href="#l70.3279"></a><span id="l70.3279" class="difflineminus">-</span>
<a href="#l70.3280"></a><span id="l70.3280" class="difflineminus">-        let data = bstream.readBytes(bstream.available());</span>
<a href="#l70.3281"></a><span id="l70.3281" class="difflineminus">-        this._cachedUserIcon = {</span>
<a href="#l70.3282"></a><span id="l70.3282" class="difflineminus">-          type,</span>
<a href="#l70.3283"></a><span id="l70.3283" class="difflineminus">-          binval: btoa(data).replace(/.{74}/g, &quot;$&amp;\n&quot;),</span>
<a href="#l70.3284"></a><span id="l70.3284" class="difflineminus">-        };</span>
<a href="#l70.3285"></a><span id="l70.3285" class="difflineminus">-      } catch (e) {</span>
<a href="#l70.3286"></a><span id="l70.3286" class="difflineminus">-        Cu.reportError(e);</span>
<a href="#l70.3287"></a><span id="l70.3287" class="difflineminus">-        this._cachedUserIcon = null;</span>
<a href="#l70.3288"></a><span id="l70.3288" class="difflineminus">-      }</span>
<a href="#l70.3289"></a><span id="l70.3289" class="difflineminus">-      delete this._cachingUserIcon;</span>
<a href="#l70.3290"></a><span id="l70.3290" class="difflineminus">-      this._sendVCard();</span>
<a href="#l70.3291"></a><span id="l70.3291" class="difflineminus">-    });</span>
<a href="#l70.3292"></a><span id="l70.3292" class="difflineminus">-  },</span>
<a href="#l70.3293"></a><span id="l70.3293" class="difflineminus">-  _sendVCard() {</span>
<a href="#l70.3294"></a><span id="l70.3294" class="difflineminus">-    if (!this._connection) {</span>
<a href="#l70.3295"></a><span id="l70.3295" class="difflineminus">-      return;</span>
<a href="#l70.3296"></a><span id="l70.3296" class="difflineminus">-    }</span>
<a href="#l70.3297"></a><span id="l70.3297" class="difflineminus">-</span>
<a href="#l70.3298"></a><span id="l70.3298" class="difflineminus">-    // We have to download the user's existing vCard before updating it.</span>
<a href="#l70.3299"></a><span id="l70.3299" class="difflineminus">-    // This lets us preserve the fields that we don't change or don't know.</span>
<a href="#l70.3300"></a><span id="l70.3300" class="difflineminus">-    // Some servers may reject a new vCard if we don't do this first.</span>
<a href="#l70.3301"></a><span id="l70.3301" class="difflineminus">-    if (!this.hasOwnProperty(&quot;_userVCard&quot;)) {</span>
<a href="#l70.3302"></a><span id="l70.3302" class="difflineminus">-      // The download of the vCard is asynchronous and will call _sendVCard back</span>
<a href="#l70.3303"></a><span id="l70.3303" class="difflineminus">-      // when the user's vCard has been received.</span>
<a href="#l70.3304"></a><span id="l70.3304" class="difflineminus">-      this._downloadUserVCard();</span>
<a href="#l70.3305"></a><span id="l70.3305" class="difflineminus">-      return;</span>
<a href="#l70.3306"></a><span id="l70.3306" class="difflineminus">-    }</span>
<a href="#l70.3307"></a><span id="l70.3307" class="difflineminus">-</span>
<a href="#l70.3308"></a><span id="l70.3308" class="difflineminus">-    // Read the local user icon asynchronously from the disk.</span>
<a href="#l70.3309"></a><span id="l70.3309" class="difflineminus">-    // _cacheUserIcon will call _sendVCard back once the icon is ready.</span>
<a href="#l70.3310"></a><span id="l70.3310" class="difflineminus">-    if (!this.hasOwnProperty(&quot;_cachedUserIcon&quot;)) {</span>
<a href="#l70.3311"></a><span id="l70.3311" class="difflineminus">-      this._cacheUserIcon();</span>
<a href="#l70.3312"></a><span id="l70.3312" class="difflineminus">-      return;</span>
<a href="#l70.3313"></a><span id="l70.3313" class="difflineminus">-    }</span>
<a href="#l70.3314"></a><span id="l70.3314" class="difflineminus">-</span>
<a href="#l70.3315"></a><span id="l70.3315" class="difflineminus">-    // If the user currently doesn't have any vCard on the server or</span>
<a href="#l70.3316"></a><span id="l70.3316" class="difflineminus">-    // the download failed, an empty new one.</span>
<a href="#l70.3317"></a><span id="l70.3317" class="difflineminus">-    if (!this._userVCard) {</span>
<a href="#l70.3318"></a><span id="l70.3318" class="difflineminus">-      this._userVCard = Stanza.node(&quot;vCard&quot;, Stanza.NS.vcard);</span>
<a href="#l70.3319"></a><span id="l70.3319" class="difflineminus">-    }</span>
<a href="#l70.3320"></a><span id="l70.3320" class="difflineminus">-</span>
<a href="#l70.3321"></a><span id="l70.3321" class="difflineminus">-    // Keep a serialized copy of the existing user vCard so that we</span>
<a href="#l70.3322"></a><span id="l70.3322" class="difflineminus">-    // can avoid resending identical data to the server.</span>
<a href="#l70.3323"></a><span id="l70.3323" class="difflineminus">-    let existingVCard = this._userVCard.getXML();</span>
<a href="#l70.3324"></a><span id="l70.3324" class="difflineminus">-</span>
<a href="#l70.3325"></a><span id="l70.3325" class="difflineminus">-    let fn = this._userVCard.getElement([&quot;FN&quot;]);</span>
<a href="#l70.3326"></a><span id="l70.3326" class="difflineminus">-    let displayName = this.imAccount.statusInfo.displayName;</span>
<a href="#l70.3327"></a><span id="l70.3327" class="difflineminus">-    if (displayName) {</span>
<a href="#l70.3328"></a><span id="l70.3328" class="difflineminus">-      // If a display name is set locally, update or add an FN field to the vCard.</span>
<a href="#l70.3329"></a><span id="l70.3329" class="difflineminus">-      if (!fn) {</span>
<a href="#l70.3330"></a><span id="l70.3330" class="difflineminus">-        this._userVCard.addChild(</span>
<a href="#l70.3331"></a><span id="l70.3331" class="difflineminus">-          Stanza.node(&quot;FN&quot;, Stanza.NS.vcard, null, displayName)</span>
<a href="#l70.3332"></a><span id="l70.3332" class="difflineminus">-        );</span>
<a href="#l70.3333"></a><span id="l70.3333" class="difflineminus">-      } else if (fn.children.length) {</span>
<a href="#l70.3334"></a><span id="l70.3334" class="difflineminus">-        fn.children[0].text = displayName;</span>
<a href="#l70.3335"></a><span id="l70.3335" class="difflineminus">-      } else {</span>
<a href="#l70.3336"></a><span id="l70.3336" class="difflineminus">-        fn.addText(displayName);</span>
<a href="#l70.3337"></a><span id="l70.3337" class="difflineminus">-      }</span>
<a href="#l70.3338"></a><span id="l70.3338" class="difflineminus">-    } else if (&quot;_forceUserDisplayNameUpdate&quot; in this) {</span>
<a href="#l70.3339"></a><span id="l70.3339" class="difflineminus">-      // We remove a display name stored on the server without replacing</span>
<a href="#l70.3340"></a><span id="l70.3340" class="difflineminus">-      // it with a new value only if this _sendVCard call is the result of</span>
<a href="#l70.3341"></a><span id="l70.3341" class="difflineminus">-      // a user action. This is to avoid removing data from the server each</span>
<a href="#l70.3342"></a><span id="l70.3342" class="difflineminus">-      // time the user connects from a new profile.</span>
<a href="#l70.3343"></a><span id="l70.3343" class="difflineminus">-      this._userVCard.children = this._userVCard.children.filter(</span>
<a href="#l70.3344"></a><span id="l70.3344" class="difflineminus">-        n =&gt; n.qName != &quot;FN&quot;</span>
<a href="#l70.3345"></a><span id="l70.3345" class="difflineminus">-      );</span>
<a href="#l70.3346"></a><span id="l70.3346" class="difflineminus">-    }</span>
<a href="#l70.3347"></a><span id="l70.3347" class="difflineminus">-    delete this._forceUserDisplayNameUpdate;</span>
<a href="#l70.3348"></a><span id="l70.3348" class="difflineminus">-</span>
<a href="#l70.3349"></a><span id="l70.3349" class="difflineminus">-    if (this._cachedUserIcon) {</span>
<a href="#l70.3350"></a><span id="l70.3350" class="difflineminus">-      // If we have a local user icon, update or add it in the PHOTO field.</span>
<a href="#l70.3351"></a><span id="l70.3351" class="difflineminus">-      let photoChildren = [</span>
<a href="#l70.3352"></a><span id="l70.3352" class="difflineminus">-        Stanza.node(&quot;TYPE&quot;, Stanza.NS.vcard, null, this._cachedUserIcon.type),</span>
<a href="#l70.3353"></a><span id="l70.3353" class="difflineminus">-        Stanza.node(</span>
<a href="#l70.3354"></a><span id="l70.3354" class="difflineminus">-          &quot;BINVAL&quot;,</span>
<a href="#l70.3355"></a><span id="l70.3355" class="difflineminus">-          Stanza.NS.vcard,</span>
<a href="#l70.3356"></a><span id="l70.3356" class="difflineminus">-          null,</span>
<a href="#l70.3357"></a><span id="l70.3357" class="difflineminus">-          this._cachedUserIcon.binval</span>
<a href="#l70.3358"></a><span id="l70.3358" class="difflineminus">-        ),</span>
<a href="#l70.3359"></a><span id="l70.3359" class="difflineminus">-      ];</span>
<a href="#l70.3360"></a><span id="l70.3360" class="difflineminus">-      let photo = this._userVCard.getElement([&quot;PHOTO&quot;]);</span>
<a href="#l70.3361"></a><span id="l70.3361" class="difflineminus">-      if (photo) {</span>
<a href="#l70.3362"></a><span id="l70.3362" class="difflineminus">-        photo.children = photoChildren;</span>
<a href="#l70.3363"></a><span id="l70.3363" class="difflineminus">-      } else {</span>
<a href="#l70.3364"></a><span id="l70.3364" class="difflineminus">-        this._userVCard.addChild(</span>
<a href="#l70.3365"></a><span id="l70.3365" class="difflineminus">-          Stanza.node(&quot;PHOTO&quot;, Stanza.NS.vcard, null, photoChildren)</span>
<a href="#l70.3366"></a><span id="l70.3366" class="difflineminus">-        );</span>
<a href="#l70.3367"></a><span id="l70.3367" class="difflineminus">-      }</span>
<a href="#l70.3368"></a><span id="l70.3368" class="difflineminus">-    } else if (&quot;_forceUserIconUpdate&quot; in this) {</span>
<a href="#l70.3369"></a><span id="l70.3369" class="difflineminus">-      // Like for the display name, we remove a photo without</span>
<a href="#l70.3370"></a><span id="l70.3370" class="difflineminus">-      // replacing it only if the call is caused by a user action.</span>
<a href="#l70.3371"></a><span id="l70.3371" class="difflineminus">-      this._userVCard.children = this._userVCard.children.filter(</span>
<a href="#l70.3372"></a><span id="l70.3372" class="difflineminus">-        n =&gt; n.qName != &quot;PHOTO&quot;</span>
<a href="#l70.3373"></a><span id="l70.3373" class="difflineminus">-      );</span>
<a href="#l70.3374"></a><span id="l70.3374" class="difflineminus">-    }</span>
<a href="#l70.3375"></a><span id="l70.3375" class="difflineminus">-    delete this._forceUserIconUpdate;</span>
<a href="#l70.3376"></a><span id="l70.3376" class="difflineminus">-</span>
<a href="#l70.3377"></a><span id="l70.3377" class="difflineminus">-    // Send the vCard only if it has really changed.</span>
<a href="#l70.3378"></a><span id="l70.3378" class="difflineminus">-    // We handle the result response from the server (it does not require</span>
<a href="#l70.3379"></a><span id="l70.3379" class="difflineminus">-    // any further action).</span>
<a href="#l70.3380"></a><span id="l70.3380" class="difflineminus">-    if (this._userVCard.getXML() != existingVCard) {</span>
<a href="#l70.3381"></a><span id="l70.3381" class="difflineminus">-      this.sendStanza(</span>
<a href="#l70.3382"></a><span id="l70.3382" class="difflineminus">-        Stanza.iq(&quot;set&quot;, null, null, this._userVCard),</span>
<a href="#l70.3383"></a><span id="l70.3383" class="difflineminus">-        this._handleResult()</span>
<a href="#l70.3384"></a><span id="l70.3384" class="difflineminus">-      );</span>
<a href="#l70.3385"></a><span id="l70.3385" class="difflineminus">-    } else {</span>
<a href="#l70.3386"></a><span id="l70.3386" class="difflineminus">-      this.LOG(</span>
<a href="#l70.3387"></a><span id="l70.3387" class="difflineminus">-        &quot;Not sending the vCard because the server stored vCard is identical.&quot;</span>
<a href="#l70.3388"></a><span id="l70.3388" class="difflineminus">-      );</span>
<a href="#l70.3389"></a><span id="l70.3389" class="difflineminus">-    }</span>
<a href="#l70.3390"></a><span id="l70.3390" class="difflineminus">-  },</span>
<a href="#l70.3391"></a><span id="l70.3391"> };</span>
<a href="#l70.3392"></a><span id="l70.3392" class="difflineminus">-function XMPPAccount(aProtocol, aImAccount) {</span>
<a href="#l70.3393"></a><span id="l70.3393" class="difflineminus">-  this._pendingVCardRequests = [];</span>
<a href="#l70.3394"></a><span id="l70.3394" class="difflineminus">-  this._init(aProtocol, aImAccount);</span>
<a href="#l70.3395"></a><span id="l70.3395" class="difflineminus">-}</span>
<a href="#l70.3396"></a><span id="l70.3396" class="difflineminus">-XMPPAccount.prototype = XMPPAccountPrototype;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l71.1"></a><span id="l71.1">deleted file mode 100644</span>
<a href="#l71.2"></a><span id="l71.2" class="difflineminus">--- a/chat/protocols/xmpp/xmpp.manifest</span>
<a href="#l71.3"></a><span id="l71.3" class="difflineplus">+++ /dev/null</span>
<a href="#l71.4"></a><span id="l71.4" class="difflineat">@@ -1,3 +0,0 @@</span>
<a href="#l71.5"></a><span id="l71.5" class="difflineminus">-component {dde786d1-6f59-43d0-9bc8-b505a757fb30} xmpp.js</span>
<a href="#l71.6"></a><span id="l71.6" class="difflineminus">-contract @mozilla.org/chat/xmpp;1 {dde786d1-6f59-43d0-9bc8-b505a757fb30}</span>
<a href="#l71.7"></a><span id="l71.7" class="difflineminus">-category im-protocol-plugin prpl-jabber @mozilla.org/chat/xmpp;1</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l72.1"></a><span id="l72.1">new file mode 100644</span>
<a href="#l72.2"></a><span id="l72.2" class="difflineminus">--- /dev/null</span>
<a href="#l72.3"></a><span id="l72.3" class="difflineplus">+++ b/chat/protocols/yahoo/components.conf</span>
<a href="#l72.4"></a><span id="l72.4" class="difflineat">@@ -0,0 +1,15 @@</span>
<a href="#l72.5"></a><span id="l72.5" class="difflineplus">+# -*- Mode: python; indent-tabs-mode: nil; tab-width: 40 -*-</span>
<a href="#l72.6"></a><span id="l72.6" class="difflineplus">+# vim: set filetype=python:</span>
<a href="#l72.7"></a><span id="l72.7" class="difflineplus">+# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l72.8"></a><span id="l72.8" class="difflineplus">+# License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l72.9"></a><span id="l72.9" class="difflineplus">+# file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l72.10"></a><span id="l72.10" class="difflineplus">+</span>
<a href="#l72.11"></a><span id="l72.11" class="difflineplus">+Classes = [</span>
<a href="#l72.12"></a><span id="l72.12" class="difflineplus">+  {</span>
<a href="#l72.13"></a><span id="l72.13" class="difflineplus">+    'cid': '{50ea817e-5d79-4657-91ae-aa0a52bdb98c}',</span>
<a href="#l72.14"></a><span id="l72.14" class="difflineplus">+    'contract_ids': ['@mozilla.org/chat/yahoo;1'],</span>
<a href="#l72.15"></a><span id="l72.15" class="difflineplus">+    'jsm': 'resource:///modules/yahoo.jsm',</span>
<a href="#l72.16"></a><span id="l72.16" class="difflineplus">+    'constructor': 'YahooProtocol',</span>
<a href="#l72.17"></a><span id="l72.17" class="difflineplus">+    'categories': {'im-protocol-plugin': 'prpl-yahoo'},</span>
<a href="#l72.18"></a><span id="l72.18" class="difflineplus">+  },</span>
<a href="#l72.19"></a><span id="l72.19" class="difflineplus">+]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l73.1"></a><span id="l73.1" class="difflineminus">--- a/chat/protocols/yahoo/moz.build</span>
<a href="#l73.2"></a><span id="l73.2" class="difflineplus">+++ b/chat/protocols/yahoo/moz.build</span>
<a href="#l73.3"></a><span id="l73.3" class="difflineat">@@ -1,11 +1,14 @@</span>
<a href="#l73.4"></a><span id="l73.4"> # vim: set filetype=python:</span>
<a href="#l73.5"></a><span id="l73.5"> # This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l73.6"></a><span id="l73.6"> # License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l73.7"></a><span id="l73.7"> # file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l73.8"></a><span id="l73.8"> </span>
<a href="#l73.9"></a><span id="l73.9" class="difflineminus">-EXTRA_COMPONENTS += [</span>
<a href="#l73.10"></a><span id="l73.10" class="difflineminus">-    'yahoo.js',</span>
<a href="#l73.11"></a><span id="l73.11" class="difflineminus">-    'yahoo.manifest',</span>
<a href="#l73.12"></a><span id="l73.12" class="difflineplus">+JAR_MANIFESTS += ['jar.mn']</span>
<a href="#l73.13"></a><span id="l73.13" class="difflineplus">+</span>
<a href="#l73.14"></a><span id="l73.14" class="difflineplus">+EXTRA_JS_MODULES += [</span>
<a href="#l73.15"></a><span id="l73.15" class="difflineplus">+    'yahoo.jsm',</span>
<a href="#l73.16"></a><span id="l73.16"> ]</span>
<a href="#l73.17"></a><span id="l73.17"> </span>
<a href="#l73.18"></a><span id="l73.18" class="difflineminus">-JAR_MANIFESTS += ['jar.mn']</span>
<a href="#l73.19"></a><span id="l73.19" class="difflineplus">+XPCOM_MANIFESTS += [</span>
<a href="#l73.20"></a><span id="l73.20" class="difflineplus">+    'components.conf',</span>
<a href="#l73.21"></a><span id="l73.21" class="difflineplus">+]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l74.1"></a><span id="l74.1">rename from chat/protocols/yahoo/yahoo.js</span>
<a href="#l74.2"></a><span id="l74.2">rename to chat/protocols/yahoo/yahoo.jsm</span>
<a href="#l74.3"></a><span id="l74.3" class="difflineminus">--- a/chat/protocols/yahoo/yahoo.js</span>
<a href="#l74.4"></a><span id="l74.4" class="difflineplus">+++ b/chat/protocols/yahoo/yahoo.jsm</span>
<a href="#l74.5"></a><span id="l74.5" class="difflineat">@@ -1,12 +1,14 @@</span>
<a href="#l74.6"></a><span id="l74.6"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l74.7"></a><span id="l74.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l74.8"></a><span id="l74.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l74.9"></a><span id="l74.9"> </span>
<a href="#l74.10"></a><span id="l74.10" class="difflineplus">+var EXPORTED_SYMBOLS = [&quot;YahooProtocol&quot;];</span>
<a href="#l74.11"></a><span id="l74.11" class="difflineplus">+</span>
<a href="#l74.12"></a><span id="l74.12"> var { XPCOMUtils, l10nHelper } = ChromeUtils.import(</span>
<a href="#l74.13"></a><span id="l74.13">   &quot;resource:///modules/imXPCOMUtils.jsm&quot;</span>
<a href="#l74.14"></a><span id="l74.14"> );</span>
<a href="#l74.15"></a><span id="l74.15"> var { GenericAccountPrototype, GenericProtocolPrototype } = ChromeUtils.import(</span>
<a href="#l74.16"></a><span id="l74.16">   &quot;resource:///modules/jsProtoHelper.jsm&quot;</span>
<a href="#l74.17"></a><span id="l74.17"> );</span>
<a href="#l74.18"></a><span id="l74.18"> </span>
<a href="#l74.19"></a><span id="l74.19"> XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l74.20"></a><span id="l74.20" class="difflineat">@@ -46,12 +48,9 @@ YahooProtocol.prototype = {</span>
<a href="#l74.21"></a><span id="l74.21">     return &quot;Yahoo&quot;;</span>
<a href="#l74.22"></a><span id="l74.22">   },</span>
<a href="#l74.23"></a><span id="l74.23">   get iconBaseURI() {</span>
<a href="#l74.24"></a><span id="l74.24">     return &quot;chrome://prpl-yahoo/skin/&quot;;</span>
<a href="#l74.25"></a><span id="l74.25">   },</span>
<a href="#l74.26"></a><span id="l74.26">   getAccount(aImAccount) {</span>
<a href="#l74.27"></a><span id="l74.27">     return new YahooAccount(this, aImAccount);</span>
<a href="#l74.28"></a><span id="l74.28">   },</span>
<a href="#l74.29"></a><span id="l74.29" class="difflineminus">-  classID: Components.ID(&quot;{50ea817e-5d79-4657-91ae-aa0a52bdb98c}&quot;),</span>
<a href="#l74.30"></a><span id="l74.30"> };</span>
<a href="#l74.31"></a><span id="l74.31" class="difflineminus">-</span>
<a href="#l74.32"></a><span id="l74.32" class="difflineminus">-var NSGetFactory = XPCOMUtils.generateNSGetFactory([YahooProtocol]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l75.1"></a><span id="l75.1">deleted file mode 100644</span>
<a href="#l75.2"></a><span id="l75.2" class="difflineminus">--- a/chat/protocols/yahoo/yahoo.manifest</span>
<a href="#l75.3"></a><span id="l75.3" class="difflineplus">+++ /dev/null</span>
<a href="#l75.4"></a><span id="l75.4" class="difflineat">@@ -1,3 +0,0 @@</span>
<a href="#l75.5"></a><span id="l75.5" class="difflineminus">-component {50ea817e-5d79-4657-91ae-aa0a52bdb98c} yahoo.js</span>
<a href="#l75.6"></a><span id="l75.6" class="difflineminus">-contract @mozilla.org/chat/yahoo;1 {50ea817e-5d79-4657-91ae-aa0a52bdb98c}</span>
<a href="#l75.7"></a><span id="l75.7" class="difflineminus">-category im-protocol-plugin prpl-yahoo @mozilla.org/chat/yahoo;1</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l76.1"></a><span id="l76.1" class="difflineminus">--- a/mail/installer/package-manifest.in</span>
<a href="#l76.2"></a><span id="l76.2" class="difflineplus">+++ b/mail/installer/package-manifest.in</span>
<a href="#l76.3"></a><span id="l76.3" class="difflineat">@@ -215,48 +215,16 @@</span>
<a href="#l76.4"></a><span id="l76.4"> #endif</span>
<a href="#l76.5"></a><span id="l76.5"> </span>
<a href="#l76.6"></a><span id="l76.6"> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<a href="#l76.7"></a><span id="l76.7"> ; instant messaging</span>
<a href="#l76.8"></a><span id="l76.8"> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<a href="#l76.9"></a><span id="l76.9"> @RESPATH@/@PREF_DIR@/chat-prefs.js</span>
<a href="#l76.10"></a><span id="l76.10"> @RESPATH@/chrome/chat@JAREXT@</span>
<a href="#l76.11"></a><span id="l76.11"> @RESPATH@/chrome/chat.manifest</span>
<a href="#l76.12"></a><span id="l76.12" class="difflineminus">-@RESPATH@/components/imAccounts.js</span>
<a href="#l76.13"></a><span id="l76.13" class="difflineminus">-@RESPATH@/components/imAccounts.manifest</span>
<a href="#l76.14"></a><span id="l76.14" class="difflineminus">-@RESPATH@/components/imCommands.js</span>
<a href="#l76.15"></a><span id="l76.15" class="difflineminus">-@RESPATH@/components/imCommands.manifest</span>
<a href="#l76.16"></a><span id="l76.16" class="difflineminus">-@RESPATH@/components/imContacts.js</span>
<a href="#l76.17"></a><span id="l76.17" class="difflineminus">-@RESPATH@/components/imContacts.manifest</span>
<a href="#l76.18"></a><span id="l76.18" class="difflineminus">-@RESPATH@/components/imConversations.js</span>
<a href="#l76.19"></a><span id="l76.19" class="difflineminus">-@RESPATH@/components/imConversations.manifest</span>
<a href="#l76.20"></a><span id="l76.20" class="difflineminus">-@RESPATH@/components/imCore.js</span>
<a href="#l76.21"></a><span id="l76.21" class="difflineminus">-@RESPATH@/components/imCore.manifest</span>
<a href="#l76.22"></a><span id="l76.22" class="difflineminus">-@RESPATH@/components/facebook.js</span>
<a href="#l76.23"></a><span id="l76.23" class="difflineminus">-@RESPATH@/components/facebook.manifest</span>
<a href="#l76.24"></a><span id="l76.24" class="difflineminus">-@RESPATH@/components/gtalk.js</span>
<a href="#l76.25"></a><span id="l76.25" class="difflineminus">-@RESPATH@/components/gtalk.manifest</span>
<a href="#l76.26"></a><span id="l76.26" class="difflineminus">-@RESPATH@/components/irc.js</span>
<a href="#l76.27"></a><span id="l76.27" class="difflineminus">-@RESPATH@/components/irc.manifest</span>
<a href="#l76.28"></a><span id="l76.28" class="difflineminus">-@RESPATH@/components/matrix.js</span>
<a href="#l76.29"></a><span id="l76.29" class="difflineminus">-@RESPATH@/components/matrix.manifest</span>
<a href="#l76.30"></a><span id="l76.30" class="difflineminus">-@RESPATH@/components/odnoklassniki.js</span>
<a href="#l76.31"></a><span id="l76.31" class="difflineminus">-@RESPATH@/components/odnoklassniki.manifest</span>
<a href="#l76.32"></a><span id="l76.32" class="difflineminus">-@RESPATH@/components/skype.js</span>
<a href="#l76.33"></a><span id="l76.33" class="difflineminus">-@RESPATH@/components/skype.manifest</span>
<a href="#l76.34"></a><span id="l76.34" class="difflineminus">-@RESPATH@/components/twitter.js</span>
<a href="#l76.35"></a><span id="l76.35" class="difflineminus">-@RESPATH@/components/twitter.manifest</span>
<a href="#l76.36"></a><span id="l76.36" class="difflineminus">-@RESPATH@/components/xmpp.js</span>
<a href="#l76.37"></a><span id="l76.37" class="difflineminus">-@RESPATH@/components/xmpp.manifest</span>
<a href="#l76.38"></a><span id="l76.38" class="difflineminus">-@RESPATH@/components/yahoo.js</span>
<a href="#l76.39"></a><span id="l76.39" class="difflineminus">-@RESPATH@/components/yahoo.manifest</span>
<a href="#l76.40"></a><span id="l76.40" class="difflineminus">-@RESPATH@/components/smileProtocolHandler.js</span>
<a href="#l76.41"></a><span id="l76.41" class="difflineminus">-@RESPATH@/components/smileProtocolHandler.manifest</span>
<a href="#l76.42"></a><span id="l76.42" class="difflineminus">-@RESPATH@/components/logger.js</span>
<a href="#l76.43"></a><span id="l76.43" class="difflineminus">-@RESPATH@/components/logger.manifest</span>
<a href="#l76.44"></a><span id="l76.44"> </span>
<a href="#l76.45"></a><span id="l76.45"> ; Thunderbird specific</span>
<a href="#l76.46"></a><span id="l76.46"> @RESPATH@/@PREF_DIR@/all-im.js</span>
<a href="#l76.47"></a><span id="l76.47"> </span>
<a href="#l76.48"></a><span id="l76.48"> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<a href="#l76.49"></a><span id="l76.49"> ; Chrome Files</span>
<a href="#l76.50"></a><span id="l76.50"> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<a href="#l76.51"></a><span id="l76.51"> </span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

