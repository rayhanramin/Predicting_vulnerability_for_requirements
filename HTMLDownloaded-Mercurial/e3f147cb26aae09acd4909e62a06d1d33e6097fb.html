<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 8043:e3f147cb26aae09acd4909e62a06d1d33e6097fb</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ e3f147cb26aae09acd4909e62a06d1d33e6097fb" />
<meta property="og:url" content="/comm-central/rev/e3f147cb26aae09acd4909e62a06d1d33e6097fb" />
<meta property="og:description" content="Bug 652855 - De-RDF the address book; r=standard8" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / e3f147cb26aae09acd4909e62a06d1d33e6097fb 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/e3f147cb26aae09acd4909e62a06d1d33e6097fb">shortlog</a> |
<a href="/comm-central/log/e3f147cb26aae09acd4909e62a06d1d33e6097fb">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/e3f147cb26aae09acd4909e62a06d1d33e6097fb">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/e3f147cb26aae09acd4909e62a06d1d33e6097fb">files</a> |
changeset |
<a href="/comm-central/raw-rev/e3f147cb26aae09acd4909e62a06d1d33e6097fb">raw</a>  | <a href="/comm-central/archive/e3f147cb26aae09acd4909e62a06d1d33e6097fb.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=652855">Bug 652855</a> - De-RDF the address book; r=standard8
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#77;&#105;&#107;&#101;&#32;&#67;&#111;&#110;&#108;&#101;&#121;&#32;&#60;&#109;&#99;&#111;&#110;&#108;&#101;&#121;&#64;&#109;&#111;&#122;&#105;&#108;&#108;&#97;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 04 Jul 2011 18:03:17 -0500</td></tr>

<tr>
 <td>changeset 8043</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/e3f147cb26aae09acd4909e62a06d1d33e6097fb">e3f147cb26aae09acd4909e62a06d1d33e6097fb</a></td>
</tr>



<tr>
<td>parent 8042</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/bc728348268b58d865327dcc493ca895190ef4f5">bc728348268b58d865327dcc493ca895190ef4f5</a>
</td>
</tr>

<tr>
<td>child 8044</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/ae84f8b74c90e52908360b1fd5cc7077b3b0ad57">ae84f8b74c90e52908360b1fd5cc7077b3b0ad57</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=e3f147cb26aae09acd4909e62a06d1d33e6097fb">6189</a></td></tr>
<tr><td>push user</td><td>squibblyflabbetydoo@gmail.com</td></tr>
<tr><td>push date</td><td class="date age">Mon, 04 Jul 2011 23:10:22 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@e3f147cb26aa [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=e3f147cb26aae09acd4909e62a06d1d33e6097fb">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=e3f147cb26aae09acd4909e62a06d1d33e6097fb&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=e3f147cb26aae09acd4909e62a06d1d33e6097fb&newProject=comm-central&newRevision=e3f147cb26aae09acd4909e62a06d1d33e6097fb&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=e3f147cb26aae09acd4909e62a06d1d33e6097fb&newProject=comm-central&newRevision=e3f147cb26aae09acd4909e62a06d1d33e6097fb&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=e3f147cb26aae09acd4909e62a06d1d33e6097fb&newProject=comm-central&newRevision=e3f147cb26aae09acd4909e62a06d1d33e6097fb&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28standard8%29&revcount=50">standard8</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=652855">652855</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=652855">Bug 652855</a> - De-RDF the address book; r=standard8</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mail/base/content/ABSearchDialog.js">mail/base/content/ABSearchDialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mail/base/content/ABSearchDialog.js">file</a> |
<a href="/comm-central/annotate/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mail/base/content/ABSearchDialog.js">annotate</a> |
<a href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mail/base/content/ABSearchDialog.js">diff</a> |
<a href="/comm-central/comparison/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mail/base/content/ABSearchDialog.js">comparison</a> |
<a href="/comm-central/log/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mail/base/content/ABSearchDialog.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mail/components/addrbook/content/abCommon.js">mail/components/addrbook/content/abCommon.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mail/components/addrbook/content/abCommon.js">file</a> |
<a href="/comm-central/annotate/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mail/components/addrbook/content/abCommon.js">annotate</a> |
<a href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mail/components/addrbook/content/abCommon.js">diff</a> |
<a href="/comm-central/comparison/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mail/components/addrbook/content/abCommon.js">comparison</a> |
<a href="/comm-central/log/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mail/components/addrbook/content/abCommon.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/public/nsAbBaseCID.h">mailnews/addrbook/public/nsAbBaseCID.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/public/nsAbBaseCID.h">file</a> |
<a href="/comm-central/annotate/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/public/nsAbBaseCID.h">annotate</a> |
<a href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/public/nsAbBaseCID.h">diff</a> |
<a href="/comm-central/comparison/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/public/nsAbBaseCID.h">comparison</a> |
<a href="/comm-central/log/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/public/nsAbBaseCID.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/public/nsIAbDirectory.idl">mailnews/addrbook/public/nsIAbDirectory.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/public/nsIAbDirectory.idl">file</a> |
<a href="/comm-central/annotate/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/public/nsIAbDirectory.idl">annotate</a> |
<a href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/public/nsIAbDirectory.idl">diff</a> |
<a href="/comm-central/comparison/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/public/nsIAbDirectory.idl">comparison</a> |
<a href="/comm-central/log/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/public/nsIAbDirectory.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/public/nsIAbMDBDirectory.idl">mailnews/addrbook/public/nsIAbMDBDirectory.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/public/nsIAbMDBDirectory.idl">file</a> |
<a href="/comm-central/annotate/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/public/nsIAbMDBDirectory.idl">annotate</a> |
<a href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/public/nsIAbMDBDirectory.idl">diff</a> |
<a href="/comm-central/comparison/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/public/nsIAbMDBDirectory.idl">comparison</a> |
<a href="/comm-central/log/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/public/nsIAbMDBDirectory.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/Makefile.in">mailnews/addrbook/src/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/Makefile.in">file</a> |
<a href="/comm-central/annotate/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/Makefile.in">annotate</a> |
<a href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/Makefile.in">diff</a> |
<a href="/comm-central/comparison/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/Makefile.in">comparison</a> |
<a href="/comm-central/log/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbBSDirectory.cpp">mailnews/addrbook/src/nsAbBSDirectory.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbBSDirectory.cpp">file</a> |
<a href="/comm-central/annotate/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbBSDirectory.cpp">annotate</a> |
<a href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbBSDirectory.cpp">diff</a> |
<a href="/comm-central/comparison/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbBSDirectory.cpp">comparison</a> |
<a href="/comm-central/log/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbBSDirectory.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbBSDirectory.h">mailnews/addrbook/src/nsAbBSDirectory.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbBSDirectory.h">file</a> |
<a href="/comm-central/annotate/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbBSDirectory.h">annotate</a> |
<a href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbBSDirectory.h">diff</a> |
<a href="/comm-central/comparison/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbBSDirectory.h">comparison</a> |
<a href="/comm-central/log/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbBSDirectory.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbDirProperty.cpp">mailnews/addrbook/src/nsAbDirProperty.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbDirProperty.cpp">file</a> |
<a href="/comm-central/annotate/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbDirProperty.cpp">annotate</a> |
<a href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbDirProperty.cpp">diff</a> |
<a href="/comm-central/comparison/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbDirProperty.cpp">comparison</a> |
<a href="/comm-central/log/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbDirProperty.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbDirProperty.h">mailnews/addrbook/src/nsAbDirProperty.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbDirProperty.h">file</a> |
<a href="/comm-central/annotate/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbDirProperty.h">annotate</a> |
<a href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbDirProperty.h">diff</a> |
<a href="/comm-central/comparison/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbDirProperty.h">comparison</a> |
<a href="/comm-central/log/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbDirProperty.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbDirectoryRDFResource.cpp">mailnews/addrbook/src/nsAbDirectoryRDFResource.cpp</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbDirectoryRDFResource.cpp">diff</a> |
<a href="/comm-central/comparison/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbDirectoryRDFResource.cpp">comparison</a> |
<a href="/comm-central/log/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbDirectoryRDFResource.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbDirectoryRDFResource.h">mailnews/addrbook/src/nsAbDirectoryRDFResource.h</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbDirectoryRDFResource.h">diff</a> |
<a href="/comm-central/comparison/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbDirectoryRDFResource.h">comparison</a> |
<a href="/comm-central/log/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbDirectoryRDFResource.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbLDAPDirFactory.cpp">mailnews/addrbook/src/nsAbLDAPDirFactory.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbLDAPDirFactory.cpp">file</a> |
<a href="/comm-central/annotate/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbLDAPDirFactory.cpp">annotate</a> |
<a href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbLDAPDirFactory.cpp">diff</a> |
<a href="/comm-central/comparison/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbLDAPDirFactory.cpp">comparison</a> |
<a href="/comm-central/log/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbLDAPDirFactory.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbLDAPDirectory.cpp">mailnews/addrbook/src/nsAbLDAPDirectory.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbLDAPDirectory.cpp">file</a> |
<a href="/comm-central/annotate/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbLDAPDirectory.cpp">annotate</a> |
<a href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbLDAPDirectory.cpp">diff</a> |
<a href="/comm-central/comparison/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbLDAPDirectory.cpp">comparison</a> |
<a href="/comm-central/log/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbLDAPDirectory.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbLDAPDirectory.h">mailnews/addrbook/src/nsAbLDAPDirectory.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbLDAPDirectory.h">file</a> |
<a href="/comm-central/annotate/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbLDAPDirectory.h">annotate</a> |
<a href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbLDAPDirectory.h">diff</a> |
<a href="/comm-central/comparison/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbLDAPDirectory.h">comparison</a> |
<a href="/comm-central/log/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbLDAPDirectory.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbMDBDirFactory.cpp">mailnews/addrbook/src/nsAbMDBDirFactory.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbMDBDirFactory.cpp">file</a> |
<a href="/comm-central/annotate/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbMDBDirFactory.cpp">annotate</a> |
<a href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbMDBDirFactory.cpp">diff</a> |
<a href="/comm-central/comparison/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbMDBDirFactory.cpp">comparison</a> |
<a href="/comm-central/log/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbMDBDirFactory.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbMDBDirProperty.cpp">mailnews/addrbook/src/nsAbMDBDirProperty.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbMDBDirProperty.cpp">file</a> |
<a href="/comm-central/annotate/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbMDBDirProperty.cpp">annotate</a> |
<a href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbMDBDirProperty.cpp">diff</a> |
<a href="/comm-central/comparison/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbMDBDirProperty.cpp">comparison</a> |
<a href="/comm-central/log/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbMDBDirProperty.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbMDBDirectory.cpp">mailnews/addrbook/src/nsAbMDBDirectory.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbMDBDirectory.cpp">file</a> |
<a href="/comm-central/annotate/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbMDBDirectory.cpp">annotate</a> |
<a href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbMDBDirectory.cpp">diff</a> |
<a href="/comm-central/comparison/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbMDBDirectory.cpp">comparison</a> |
<a href="/comm-central/log/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbMDBDirectory.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbMDBDirectory.h">mailnews/addrbook/src/nsAbMDBDirectory.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbMDBDirectory.h">file</a> |
<a href="/comm-central/annotate/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbMDBDirectory.h">annotate</a> |
<a href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbMDBDirectory.h">diff</a> |
<a href="/comm-central/comparison/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbMDBDirectory.h">comparison</a> |
<a href="/comm-central/log/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbMDBDirectory.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbManager.cpp">mailnews/addrbook/src/nsAbManager.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbManager.cpp">file</a> |
<a href="/comm-central/annotate/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbManager.cpp">annotate</a> |
<a href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbManager.cpp">diff</a> |
<a href="/comm-central/comparison/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbManager.cpp">comparison</a> |
<a href="/comm-central/log/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbManager.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbManager.h">mailnews/addrbook/src/nsAbManager.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbManager.h">file</a> |
<a href="/comm-central/annotate/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbManager.h">annotate</a> |
<a href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbManager.h">diff</a> |
<a href="/comm-central/comparison/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbManager.h">comparison</a> |
<a href="/comm-central/log/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbManager.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbOSXCard.h">mailnews/addrbook/src/nsAbOSXCard.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbOSXCard.h">file</a> |
<a href="/comm-central/annotate/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbOSXCard.h">annotate</a> |
<a href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbOSXCard.h">diff</a> |
<a href="/comm-central/comparison/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbOSXCard.h">comparison</a> |
<a href="/comm-central/log/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbOSXCard.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbOSXCard.mm">mailnews/addrbook/src/nsAbOSXCard.mm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbOSXCard.mm">file</a> |
<a href="/comm-central/annotate/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbOSXCard.mm">annotate</a> |
<a href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbOSXCard.mm">diff</a> |
<a href="/comm-central/comparison/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbOSXCard.mm">comparison</a> |
<a href="/comm-central/log/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbOSXCard.mm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbOSXDirectory.h">mailnews/addrbook/src/nsAbOSXDirectory.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbOSXDirectory.h">file</a> |
<a href="/comm-central/annotate/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbOSXDirectory.h">annotate</a> |
<a href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbOSXDirectory.h">diff</a> |
<a href="/comm-central/comparison/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbOSXDirectory.h">comparison</a> |
<a href="/comm-central/log/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbOSXDirectory.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbOSXDirectory.mm">mailnews/addrbook/src/nsAbOSXDirectory.mm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbOSXDirectory.mm">file</a> |
<a href="/comm-central/annotate/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbOSXDirectory.mm">annotate</a> |
<a href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbOSXDirectory.mm">diff</a> |
<a href="/comm-central/comparison/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbOSXDirectory.mm">comparison</a> |
<a href="/comm-central/log/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbOSXDirectory.mm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbOutlookDirFactory.cpp">mailnews/addrbook/src/nsAbOutlookDirFactory.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbOutlookDirFactory.cpp">file</a> |
<a href="/comm-central/annotate/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbOutlookDirFactory.cpp">annotate</a> |
<a href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbOutlookDirFactory.cpp">diff</a> |
<a href="/comm-central/comparison/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbOutlookDirFactory.cpp">comparison</a> |
<a href="/comm-central/log/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbOutlookDirFactory.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbOutlookDirectory.cpp">mailnews/addrbook/src/nsAbOutlookDirectory.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbOutlookDirectory.cpp">file</a> |
<a href="/comm-central/annotate/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbOutlookDirectory.cpp">annotate</a> |
<a href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbOutlookDirectory.cpp">diff</a> |
<a href="/comm-central/comparison/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbOutlookDirectory.cpp">comparison</a> |
<a href="/comm-central/log/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbOutlookDirectory.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbOutlookDirectory.h">mailnews/addrbook/src/nsAbOutlookDirectory.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbOutlookDirectory.h">file</a> |
<a href="/comm-central/annotate/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbOutlookDirectory.h">annotate</a> |
<a href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbOutlookDirectory.h">diff</a> |
<a href="/comm-central/comparison/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbOutlookDirectory.h">comparison</a> |
<a href="/comm-central/log/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbOutlookDirectory.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbRDFDataSource.cpp">mailnews/addrbook/src/nsAbRDFDataSource.cpp</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbRDFDataSource.cpp">diff</a> |
<a href="/comm-central/comparison/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbRDFDataSource.cpp">comparison</a> |
<a href="/comm-central/log/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbRDFDataSource.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbRDFDataSource.h">mailnews/addrbook/src/nsAbRDFDataSource.h</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbRDFDataSource.h">diff</a> |
<a href="/comm-central/comparison/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbRDFDataSource.h">comparison</a> |
<a href="/comm-central/log/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAbRDFDataSource.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAddrDatabase.cpp">mailnews/addrbook/src/nsAddrDatabase.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAddrDatabase.cpp">file</a> |
<a href="/comm-central/annotate/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAddrDatabase.cpp">annotate</a> |
<a href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAddrDatabase.cpp">diff</a> |
<a href="/comm-central/comparison/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAddrDatabase.cpp">comparison</a> |
<a href="/comm-central/log/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsAddrDatabase.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsDirectoryDataSource.cpp">mailnews/addrbook/src/nsDirectoryDataSource.cpp</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsDirectoryDataSource.cpp">diff</a> |
<a href="/comm-central/comparison/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsDirectoryDataSource.cpp">comparison</a> |
<a href="/comm-central/log/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsDirectoryDataSource.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsDirectoryDataSource.h">mailnews/addrbook/src/nsDirectoryDataSource.h</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsDirectoryDataSource.h">diff</a> |
<a href="/comm-central/comparison/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsDirectoryDataSource.h">comparison</a> |
<a href="/comm-central/log/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/src/nsDirectoryDataSource.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/test/unit/test_nsAbManager2.js">mailnews/addrbook/test/unit/test_nsAbManager2.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/test/unit/test_nsAbManager2.js">file</a> |
<a href="/comm-central/annotate/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/test/unit/test_nsAbManager2.js">annotate</a> |
<a href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/test/unit/test_nsAbManager2.js">diff</a> |
<a href="/comm-central/comparison/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/test/unit/test_nsAbManager2.js">comparison</a> |
<a href="/comm-central/log/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/addrbook/test/unit/test_nsAbManager2.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/base/search/src/nsMsgSearchTerm.cpp">mailnews/base/search/src/nsMsgSearchTerm.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/base/search/src/nsMsgSearchTerm.cpp">file</a> |
<a href="/comm-central/annotate/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/base/search/src/nsMsgSearchTerm.cpp">annotate</a> |
<a href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/base/search/src/nsMsgSearchTerm.cpp">diff</a> |
<a href="/comm-central/comparison/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/base/search/src/nsMsgSearchTerm.cpp">comparison</a> |
<a href="/comm-central/log/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/base/search/src/nsMsgSearchTerm.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/build/nsMailModule.cpp">mailnews/build/nsMailModule.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/build/nsMailModule.cpp">file</a> |
<a href="/comm-central/annotate/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/build/nsMailModule.cpp">annotate</a> |
<a href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/build/nsMailModule.cpp">diff</a> |
<a href="/comm-central/comparison/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/build/nsMailModule.cpp">comparison</a> |
<a href="/comm-central/log/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/build/nsMailModule.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/compose/src/nsMsgCompose.cpp">mailnews/compose/src/nsMsgCompose.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/compose/src/nsMsgCompose.cpp">file</a> |
<a href="/comm-central/annotate/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/compose/src/nsMsgCompose.cpp">annotate</a> |
<a href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/compose/src/nsMsgCompose.cpp">diff</a> |
<a href="/comm-central/comparison/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/compose/src/nsMsgCompose.cpp">comparison</a> |
<a href="/comm-central/log/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/compose/src/nsMsgCompose.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/compose/src/nsMsgCompose.h">mailnews/compose/src/nsMsgCompose.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/compose/src/nsMsgCompose.h">file</a> |
<a href="/comm-central/annotate/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/compose/src/nsMsgCompose.h">annotate</a> |
<a href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/compose/src/nsMsgCompose.h">diff</a> |
<a href="/comm-central/comparison/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/compose/src/nsMsgCompose.h">comparison</a> |
<a href="/comm-central/log/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/compose/src/nsMsgCompose.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/import/src/nsImportAddressBooks.cpp">mailnews/import/src/nsImportAddressBooks.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/import/src/nsImportAddressBooks.cpp">file</a> |
<a href="/comm-central/annotate/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/import/src/nsImportAddressBooks.cpp">annotate</a> |
<a href="/comm-central/diff/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/import/src/nsImportAddressBooks.cpp">diff</a> |
<a href="/comm-central/comparison/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/import/src/nsImportAddressBooks.cpp">comparison</a> |
<a href="/comm-central/log/e3f147cb26aae09acd4909e62a06d1d33e6097fb/mailnews/import/src/nsImportAddressBooks.cpp">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/base/content/ABSearchDialog.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/base/content/ABSearchDialog.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -29,16 +29,18 @@</span>
<a href="#l1.4"></a><span id="l1.4"> # use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l1.5"></a><span id="l1.5"> # decision by deleting the provisions above and replace them with the notice</span>
<a href="#l1.6"></a><span id="l1.6"> # and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l1.7"></a><span id="l1.7"> # the provisions above, a recipient may use your version of this file under</span>
<a href="#l1.8"></a><span id="l1.8"> # the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l1.9"></a><span id="l1.9"> #</span>
<a href="#l1.10"></a><span id="l1.10"> # ***** END LICENSE BLOCK *****</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+</span>
<a href="#l1.14"></a><span id="l1.14"> var searchSessionContractID = &quot;@mozilla.org/messenger/searchSession;1&quot;;</span>
<a href="#l1.15"></a><span id="l1.15"> var gSearchSession;</span>
<a href="#l1.16"></a><span id="l1.16"> </span>
<a href="#l1.17"></a><span id="l1.17"> var nsMsgSearchScope = Components.interfaces.nsMsgSearchScope;</span>
<a href="#l1.18"></a><span id="l1.18"> var nsIMsgSearchTerm = Components.interfaces.nsIMsgSearchTerm;</span>
<a href="#l1.19"></a><span id="l1.19"> var nsMsgSearchOp = Components.interfaces.nsMsgSearchOp;</span>
<a href="#l1.20"></a><span id="l1.20"> var nsMsgSearchAttrib = Components.interfaces.nsMsgSearchAttrib;</span>
<a href="#l1.21"></a><span id="l1.21"> var nsIAbDirectory = Components.interfaces.nsIAbDirectory;</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineat">@@ -47,18 +49,16 @@ var gStatusText;</span>
<a href="#l1.23"></a><span id="l1.23"> var gSearchBundle;</span>
<a href="#l1.24"></a><span id="l1.24"> var gAddressBookBundle;</span>
<a href="#l1.25"></a><span id="l1.25"> </span>
<a href="#l1.26"></a><span id="l1.26"> var gSearchStopButton;</span>
<a href="#l1.27"></a><span id="l1.27"> var gPropertiesButton;</span>
<a href="#l1.28"></a><span id="l1.28"> var gComposeButton;</span>
<a href="#l1.29"></a><span id="l1.29"> var gSearchPhoneticName = &quot;false&quot;;</span>
<a href="#l1.30"></a><span id="l1.30"> </span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-var gRDF = Components.classes[&quot;@mozilla.org/rdf/rdf-service;1&quot;].getService(Components.interfaces.nsIRDFService);</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineminus">-</span>
<a href="#l1.33"></a><span id="l1.33"> var gSearchAbViewListener = {</span>
<a href="#l1.34"></a><span id="l1.34">   onSelectionChanged: function() {</span>
<a href="#l1.35"></a><span id="l1.35">     UpdateCardView();</span>
<a href="#l1.36"></a><span id="l1.36">   },</span>
<a href="#l1.37"></a><span id="l1.37">   onCountChanged: function(total) {</span>
<a href="#l1.38"></a><span id="l1.38">     var statusText;</span>
<a href="#l1.39"></a><span id="l1.39">     switch (total) {</span>
<a href="#l1.40"></a><span id="l1.40">       case 0:</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineat">@@ -148,17 +148,17 @@ function SelectDirectory(aURI)</span>
<a href="#l1.42"></a><span id="l1.42">   if ( abPopup )</span>
<a href="#l1.43"></a><span id="l1.43">     abPopup.value = selectedAB;</span>
<a href="#l1.44"></a><span id="l1.44"> </span>
<a href="#l1.45"></a><span id="l1.45">   setSearchScope(GetScopeForDirectoryURI(selectedAB));</span>
<a href="#l1.46"></a><span id="l1.46"> }</span>
<a href="#l1.47"></a><span id="l1.47"> </span>
<a href="#l1.48"></a><span id="l1.48"> function GetScopeForDirectoryURI(aURI)</span>
<a href="#l1.49"></a><span id="l1.49"> {</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineminus">-  var directory = gRDF.GetResource(aURI).QueryInterface(nsIAbDirectory);</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineplus">+  var directory = MailServices.ab.getDirectory(aURI);</span>
<a href="#l1.52"></a><span id="l1.52">   var booleanAnd = gSearchBooleanRadiogroup.selectedItem.value == &quot;and&quot;;</span>
<a href="#l1.53"></a><span id="l1.53"> </span>
<a href="#l1.54"></a><span id="l1.54">   if (directory.isRemote) {</span>
<a href="#l1.55"></a><span id="l1.55">     if (booleanAnd)</span>
<a href="#l1.56"></a><span id="l1.56">       return nsMsgSearchScope.LDAPAnd;</span>
<a href="#l1.57"></a><span id="l1.57">     else </span>
<a href="#l1.58"></a><span id="l1.58">       return nsMsgSearchScope.LDAP;</span>
<a href="#l1.59"></a><span id="l1.59">   }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/components/addrbook/content/abCommon.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/components/addrbook/content/abCommon.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -38,17 +38,17 @@</span>
<a href="#l2.4"></a><span id="l2.4"> # and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l2.5"></a><span id="l2.5"> # the provisions above, a recipient may use your version of this file under</span>
<a href="#l2.6"></a><span id="l2.6"> # the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l2.7"></a><span id="l2.7"> #</span>
<a href="#l2.8"></a><span id="l2.8"> # ***** END LICENSE BLOCK *****</span>
<a href="#l2.9"></a><span id="l2.9"> </span>
<a href="#l2.10"></a><span id="l2.10"> Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-var gDirTree = 0;</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+var gDirTree;</span>
<a href="#l2.14"></a><span id="l2.14"> var abList = 0;</span>
<a href="#l2.15"></a><span id="l2.15"> var gAbResultsTree = null;</span>
<a href="#l2.16"></a><span id="l2.16"> var gAbView = null;</span>
<a href="#l2.17"></a><span id="l2.17"> var gAddressBookBundle;</span>
<a href="#l2.18"></a><span id="l2.18"> </span>
<a href="#l2.19"></a><span id="l2.19"> var gPrefs = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;].getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l2.20"></a><span id="l2.20"> var gHeaderParser = Components.classes[&quot;@mozilla.org/messenger/headerparser;1&quot;].getService(Components.interfaces.nsIMsgHeaderParser);</span>
<a href="#l2.21"></a><span id="l2.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/addrbook/public/nsAbBaseCID.h</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/addrbook/public/nsAbBaseCID.h</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -44,90 +44,59 @@</span>
<a href="#l3.4"></a><span id="l3.4"> </span>
<a href="#l3.5"></a><span id="l3.5"> //</span>
<a href="#l3.6"></a><span id="l3.6"> // The start of the contract ID for address book directory factories.</span>
<a href="#l3.7"></a><span id="l3.7"> //</span>
<a href="#l3.8"></a><span id="l3.8"> #define NS_AB_DIRECTORY_FACTORY_CONTRACTID_PREFIX \</span>
<a href="#l3.9"></a><span id="l3.9">   &quot;@mozilla.org/addressbook/directory-factory;1?name=&quot;</span>
<a href="#l3.10"></a><span id="l3.10"> </span>
<a href="#l3.11"></a><span id="l3.11"> //</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+// The start of the contract ID for address book directory types</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+//</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+#define NS_AB_DIRECTORY_TYPE_CONTRACTID_PREFIX \</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+  &quot;@mozilla.org/addressbook/directory;1?type=&quot;</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+//</span>
<a href="#l3.18"></a><span id="l3.18"> // nsAbManager</span>
<a href="#l3.19"></a><span id="l3.19"> //</span>
<a href="#l3.20"></a><span id="l3.20"> #define NS_ABMANAGER_CONTRACTID \</span>
<a href="#l3.21"></a><span id="l3.21">   &quot;@mozilla.org/abmanager;1&quot;</span>
<a href="#l3.22"></a><span id="l3.22"> </span>
<a href="#l3.23"></a><span id="l3.23"> #define NS_ABMANAGERSTARTUPHANDLER_CONTRACTID \</span>
<a href="#l3.24"></a><span id="l3.24">   &quot;@mozilla.org/commandlinehandler/general-startup;1?type=addressbook&quot;</span>
<a href="#l3.25"></a><span id="l3.25"> </span>
<a href="#l3.26"></a><span id="l3.26"> #define NS_ABMANAGER_CID \</span>
<a href="#l3.27"></a><span id="l3.27"> { /* {ad81b321-8a8a-42ca-a508-fe659de84586} */ \</span>
<a href="#l3.28"></a><span id="l3.28">   0xad81b321, 0x8a8a, 0x42ca, \</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineminus">-	{ 0xa5, 0x08, 0xfe, 0x65, 0x9d, 0x8e, 0x45, 0x86 }	\</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineplus">+  {0xa5, 0x08, 0xfe, 0x65, 0x9d, 0x8e, 0x45, 0x86} \</span>
<a href="#l3.31"></a><span id="l3.31"> }</span>
<a href="#l3.32"></a><span id="l3.32"> </span>
<a href="#l3.33"></a><span id="l3.33"> //</span>
<a href="#l3.34"></a><span id="l3.34"> // nsAbContentHandler</span>
<a href="#l3.35"></a><span id="l3.35"> //</span>
<a href="#l3.36"></a><span id="l3.36"> #define NS_ABCONTENTHANDLER_CID \</span>
<a href="#l3.37"></a><span id="l3.37"> { /* {a72ad552-0484-4b5f-8d45-2d79158d22e3} */ \</span>
<a href="#l3.38"></a><span id="l3.38">   0xa72ad552, 0x0484, 0x4b5f, \</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineminus">-	{ 0x8d, 0x45, 0x2d, 0x79, 0x15, 0x8d, 0x22, 0xe3 }	\</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineminus">-}</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineminus">-</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineminus">-//</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineminus">-// nsAbDirectoryDataSource</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineminus">-//</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineminus">-#define NS_ABDIRECTORYDATASOURCE_CONTRACTID \</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineminus">-  NS_RDF_DATASOURCE_CONTRACTID_PREFIX &quot;addressdirectory&quot;</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineminus">-</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineminus">-#define NS_ABDIRECTORYDATASOURCE_CID			\</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineminus">-{ /* 0A79186D-F754-11d2-A2DA-001083003D0C */		\</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineminus">-    0xa79186d, 0xf754, 0x11d2,				\</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineminus">-    {0xa2, 0xda, 0x0, 0x10, 0x83, 0x0, 0x3d, 0xc}	\</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineminus">-}</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineminus">-</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineminus">-//</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineminus">-// nsAbBSDirectory</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineminus">-//</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineminus">-#define NS_ABDIRECTORY_CONTRACTID \</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineminus">-  NS_RDF_RESOURCE_FACTORY_CONTRACTID_PREFIX &quot;moz-abdirectory&quot;</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineminus">-</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineminus">-#define NS_ABDIRECTORY_CID             	 			\</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineminus">-{ /* {012D3C24-1DD2-11B2-BA79-B4AD359FC461}*/			\</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineminus">-    	0x012D3C24, 0x1DD2, 0x11B2,				\</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineminus">-	{0xBA, 0x79, 0xB4, 0xAD, 0x35, 0x9F, 0xC4, 0x61}	\</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineplus">+	{0x8d, 0x45, 0x2d, 0x79, 0x15, 0x8d, 0x22, 0xe3}	\</span>
<a href="#l3.65"></a><span id="l3.65"> }</span>
<a href="#l3.66"></a><span id="l3.66"> </span>
<a href="#l3.67"></a><span id="l3.67"> </span>
<a href="#l3.68"></a><span id="l3.68"> //</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineminus">-// nsAbMDBDirectory</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineminus">-//</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineminus">-#define NS_ABMDBDIRECTORY_CONTRACTID \</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineminus">-  NS_RDF_RESOURCE_FACTORY_CONTRACTID_PREFIX &quot;moz-abmdbdirectory&quot;</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineminus">-</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineminus">-#define NS_ABMDBDIRECTORY_CID             		\</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineminus">-{ /* {e618f894-1dd1-11b2-889c-9aaefaa90dde}*/		\</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineminus">-    0xe618f894, 0x1dd1, 0x11b2,				\</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineminus">-    {0x88, 0x9c, 0x9a, 0xae, 0xfa, 0xa9, 0x0d, 0xde}	\</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineminus">-}</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineminus">-</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineplus">+// nsAbBSDirectory - the root address book</span>
<a href="#l3.81"></a><span id="l3.81"> //</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineminus">-// nsAbMDBCard</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineminus">-//</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineminus">-#define NS_ABMDBCARD_CONTRACTID \</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineminus">-  &quot;@mozilla.org/addressbook/moz-abmdbcard;1&quot;</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineplus">+#define NS_ABDIRECTORY_CONTRACTID \</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineplus">+  NS_AB_DIRECTORY_TYPE_CONTRACTID_PREFIX &quot;moz-abdirectory&quot;</span>
<a href="#l3.88"></a><span id="l3.88"> </span>
<a href="#l3.89"></a><span id="l3.89" class="difflineminus">-#define NS_ABMDBCARD_CID				\</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineminus">-{ /* {f578a5d2-1dd1-11b2-8841-f45cc5e765f8} */		\</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineminus">-    0xf578a5d2, 0x1dd1, 0x11b2,				\</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineminus">-    {0x88, 0x41, 0xf4, 0x5c, 0xc5, 0xe7, 0x65, 0xf8}	\</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineplus">+#define NS_ABDIRECTORY_CID \</span>
<a href="#l3.94"></a><span id="l3.94" class="difflineplus">+{ /* {012D3C24-1DD2-11B2-BA79-B4AD359FC461}*/ \</span>
<a href="#l3.95"></a><span id="l3.95" class="difflineplus">+    0x012D3C24, 0x1DD2, 0x11B2, \</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineplus">+    {0xBA, 0x79, 0xB4, 0xAD, 0x35, 0x9F, 0xC4, 0x61} \</span>
<a href="#l3.97"></a><span id="l3.97"> }</span>
<a href="#l3.98"></a><span id="l3.98"> </span>
<a href="#l3.99"></a><span id="l3.99"> </span>
<a href="#l3.100"></a><span id="l3.100" class="difflineminus">-</span>
<a href="#l3.101"></a><span id="l3.101"> //</span>
<a href="#l3.102"></a><span id="l3.102"> // nsAddressBookDB</span>
<a href="#l3.103"></a><span id="l3.103"> //</span>
<a href="#l3.104"></a><span id="l3.104"> #define NS_ADDRDATABASE_CONTRACTID \</span>
<a href="#l3.105"></a><span id="l3.105">   &quot;@mozilla.org/addressbook/carddatabase;1&quot;</span>
<a href="#l3.106"></a><span id="l3.106"> </span>
<a href="#l3.107"></a><span id="l3.107"> #define NS_ADDRDATABASE_CID						\</span>
<a href="#l3.108"></a><span id="l3.108"> { /* 63187917-1D19-11d3-A302-001083003D0C */		\</span>
<a href="#l3.109"></a><span id="l3.109" class="difflineat">@@ -212,31 +181,57 @@</span>
<a href="#l3.110"></a><span id="l3.110"> { /* {F8B212F2-742B-4A48-B7A0-4C44D4DDB121}*/			\</span>
<a href="#l3.111"></a><span id="l3.111"> 	0xF8B212F2, 0x742B, 0x4A48,				\</span>
<a href="#l3.112"></a><span id="l3.112"> 	{0xB7, 0xA0, 0x4C, 0x44, 0xD4, 0xDD, 0xB1, 0x21}	\</span>
<a href="#l3.113"></a><span id="l3.113"> }</span>
<a href="#l3.114"></a><span id="l3.114"> </span>
<a href="#l3.115"></a><span id="l3.115"> //</span>
<a href="#l3.116"></a><span id="l3.116"> // mdb directory factory</span>
<a href="#l3.117"></a><span id="l3.117"> //</span>
<a href="#l3.118"></a><span id="l3.118" class="difflineplus">+#define NS_ABMDBDIRECTORY &quot;moz-abmdbdirectory&quot;</span>
<a href="#l3.119"></a><span id="l3.119" class="difflineplus">+</span>
<a href="#l3.120"></a><span id="l3.120"> #define NS_ABMDBDIRFACTORY_CONTRACTID \</span>
<a href="#l3.121"></a><span id="l3.121" class="difflineminus">-  NS_AB_DIRECTORY_FACTORY_CONTRACTID_PREFIX &quot;moz-abmdbdirectory&quot;</span>
<a href="#l3.122"></a><span id="l3.122" class="difflineplus">+  NS_AB_DIRECTORY_FACTORY_CONTRACTID_PREFIX NS_ABMDBDIRECTORY</span>
<a href="#l3.123"></a><span id="l3.123"> </span>
<a href="#l3.124"></a><span id="l3.124"> #define NS_ABMDBDIRFACTORY_CID				\</span>
<a href="#l3.125"></a><span id="l3.125"> { /* {E1CB9C8A-722D-43E4-9D7B-7CCAE4B0338A}*/			\</span>
<a href="#l3.126"></a><span id="l3.126"> 	0xE1CB9C8A, 0x722D, 0x43E4,				\</span>
<a href="#l3.127"></a><span id="l3.127"> 	{0x9D, 0x7B, 0x7C, 0xCA, 0xE4, 0xB0, 0x33, 0x8A}	\</span>
<a href="#l3.128"></a><span id="l3.128"> }</span>
<a href="#l3.129"></a><span id="l3.129"> </span>
<a href="#l3.130"></a><span id="l3.130" class="difflineplus">+//</span>
<a href="#l3.131"></a><span id="l3.131" class="difflineplus">+// nsAbMDBDirectory</span>
<a href="#l3.132"></a><span id="l3.132" class="difflineplus">+//</span>
<a href="#l3.133"></a><span id="l3.133" class="difflineplus">+#define NS_ABMDBDIRECTORY_CONTRACTID \</span>
<a href="#l3.134"></a><span id="l3.134" class="difflineplus">+  NS_AB_DIRECTORY_TYPE_CONTRACTID_PREFIX NS_ABMDBDIRECTORY</span>
<a href="#l3.135"></a><span id="l3.135" class="difflineplus">+</span>
<a href="#l3.136"></a><span id="l3.136" class="difflineplus">+#define NS_ABMDBDIRECTORY_CID \</span>
<a href="#l3.137"></a><span id="l3.137" class="difflineplus">+{ /* {e618f894-1dd1-11b2-889c-9aaefaa90dde}*/ \</span>
<a href="#l3.138"></a><span id="l3.138" class="difflineplus">+  0xe618f894, 0x1dd1, 0x11b2, \</span>
<a href="#l3.139"></a><span id="l3.139" class="difflineplus">+  {0x88, 0x9c, 0x9a, 0xae, 0xfa, 0xa9, 0x0d, 0xde} \</span>
<a href="#l3.140"></a><span id="l3.140" class="difflineplus">+}</span>
<a href="#l3.141"></a><span id="l3.141" class="difflineplus">+</span>
<a href="#l3.142"></a><span id="l3.142" class="difflineplus">+//</span>
<a href="#l3.143"></a><span id="l3.143" class="difflineplus">+// nsAbMDBCard</span>
<a href="#l3.144"></a><span id="l3.144" class="difflineplus">+//</span>
<a href="#l3.145"></a><span id="l3.145" class="difflineplus">+#define NS_ABMDBCARD_CONTRACTID \</span>
<a href="#l3.146"></a><span id="l3.146" class="difflineplus">+  &quot;@mozilla.org/addressbook/moz-abmdbcard;1&quot;</span>
<a href="#l3.147"></a><span id="l3.147" class="difflineplus">+</span>
<a href="#l3.148"></a><span id="l3.148" class="difflineplus">+#define NS_ABMDBCARD_CID				\</span>
<a href="#l3.149"></a><span id="l3.149" class="difflineplus">+{ /* {f578a5d2-1dd1-11b2-8841-f45cc5e765f8} */		\</span>
<a href="#l3.150"></a><span id="l3.150" class="difflineplus">+    0xf578a5d2, 0x1dd1, 0x11b2,				\</span>
<a href="#l3.151"></a><span id="l3.151" class="difflineplus">+    {0x88, 0x41, 0xf4, 0x5c, 0xc5, 0xe7, 0x65, 0xf8}	\</span>
<a href="#l3.152"></a><span id="l3.152" class="difflineplus">+}</span>
<a href="#l3.153"></a><span id="l3.153" class="difflineplus">+</span>
<a href="#l3.154"></a><span id="l3.154"> #ifdef XP_WIN</span>
<a href="#l3.155"></a><span id="l3.155"> //</span>
<a href="#l3.156"></a><span id="l3.156"> // nsAbOutlookDirectory</span>
<a href="#l3.157"></a><span id="l3.157"> //</span>
<a href="#l3.158"></a><span id="l3.158"> #define NS_ABOUTLOOKDIRECTORY_CONTRACTID \</span>
<a href="#l3.159"></a><span id="l3.159" class="difflineminus">-  NS_RDF_RESOURCE_FACTORY_CONTRACTID_PREFIX &quot;moz-aboutlookdirectory&quot;</span>
<a href="#l3.160"></a><span id="l3.160" class="difflineplus">+  NS_AB_DIRECTORY_TYPE_CONTRACTID_PREFIX &quot;moz-aboutlookdirectory&quot;</span>
<a href="#l3.161"></a><span id="l3.161"> </span>
<a href="#l3.162"></a><span id="l3.162"> #define NS_ABOUTLOOKDIRECTORY_CID                       \</span>
<a href="#l3.163"></a><span id="l3.163"> { /* {9cc57822-0599-4c47-a399-1c6fa185a05c}*/           \</span>
<a href="#l3.164"></a><span id="l3.164">         0x9cc57822, 0x0599, 0x4c47,                     \</span>
<a href="#l3.165"></a><span id="l3.165">         {0xa3, 0x99, 0x1c, 0x6f, 0xa1, 0x85, 0xa0, 0x5c}        \</span>
<a href="#l3.166"></a><span id="l3.166"> }</span>
<a href="#l3.167"></a><span id="l3.167"> </span>
<a href="#l3.168"></a><span id="l3.168"> //</span>
<a href="#l3.169"></a><span id="l3.169" class="difflineat">@@ -292,17 +287,17 @@</span>
<a href="#l3.170"></a><span id="l3.170"> { /* {E162E335-541B-43B4-AAEA-FE591E240CAF}*/                   \</span>
<a href="#l3.171"></a><span id="l3.171">         0xE162E335, 0x541B, 0x43B4,                             \</span>
<a href="#l3.172"></a><span id="l3.172">         {0xAA, 0xEA, 0xFE, 0x59, 0x1E, 0x24, 0x0C, 0xAF}        \</span>
<a href="#l3.173"></a><span id="l3.173"> }</span>
<a href="#l3.174"></a><span id="l3.174"> </span>
<a href="#l3.175"></a><span id="l3.175"> // nsAbLDAPDirectory</span>
<a href="#l3.176"></a><span id="l3.176"> //</span>
<a href="#l3.177"></a><span id="l3.177"> #define NS_ABLDAPDIRECTORY_CONTRACTID \</span>
<a href="#l3.178"></a><span id="l3.178" class="difflineminus">-  NS_RDF_RESOURCE_FACTORY_CONTRACTID_PREFIX &quot;moz-abldapdirectory&quot;</span>
<a href="#l3.179"></a><span id="l3.179" class="difflineplus">+  NS_AB_DIRECTORY_TYPE_CONTRACTID_PREFIX  &quot;moz-abldapdirectory&quot;</span>
<a href="#l3.180"></a><span id="l3.180"> </span>
<a href="#l3.181"></a><span id="l3.181"> #define NS_ABLDAPDIRECTORY_CID             			\</span>
<a href="#l3.182"></a><span id="l3.182"> { /* {783E2777-66D7-4826-9E4B-8AB58C228A52}*/			\</span>
<a href="#l3.183"></a><span id="l3.183"> 	0x783E2777, 0x66D7, 0x4826,				\</span>
<a href="#l3.184"></a><span id="l3.184"> 	{0x9E, 0x4B, 0x8A, 0xB5, 0x8C, 0x22, 0x8A, 0x52}	\</span>
<a href="#l3.185"></a><span id="l3.185"> }</span>
<a href="#l3.186"></a><span id="l3.186"> </span>
<a href="#l3.187"></a><span id="l3.187"> // nsAbLDAPDirectoryQuery</span>
<a href="#l3.188"></a><span id="l3.188" class="difflineat">@@ -427,29 +422,29 @@</span>
<a href="#l3.189"></a><span id="l3.189"> #ifdef XP_MACOSX</span>
<a href="#l3.190"></a><span id="l3.190"> //</span>
<a href="#l3.191"></a><span id="l3.191"> // nsAbOSXDirectory</span>
<a href="#l3.192"></a><span id="l3.192"> //</span>
<a href="#l3.193"></a><span id="l3.193"> #define NS_ABOSXDIRECTORY_PREFIX &quot;moz-abosxdirectory&quot;</span>
<a href="#l3.194"></a><span id="l3.194"> #define NS_ABOSXCARD_PREFIX &quot;moz-abosxcard&quot;</span>
<a href="#l3.195"></a><span id="l3.195"> </span>
<a href="#l3.196"></a><span id="l3.196"> #define NS_ABOSXDIRECTORY_CONTRACTID \</span>
<a href="#l3.197"></a><span id="l3.197" class="difflineminus">-  NS_RDF_RESOURCE_FACTORY_CONTRACTID_PREFIX NS_ABOSXDIRECTORY_PREFIX</span>
<a href="#l3.198"></a><span id="l3.198" class="difflineplus">+  NS_AB_DIRECTORY_TYPE_CONTRACTID_PREFIX NS_ABOSXDIRECTORY_PREFIX</span>
<a href="#l3.199"></a><span id="l3.199"> </span>
<a href="#l3.200"></a><span id="l3.200"> #define NS_ABOSXDIRECTORY_CID                            \</span>
<a href="#l3.201"></a><span id="l3.201"> { /* {83781cc6-c682-11d6-bdeb-0005024967b8}*/            \</span>
<a href="#l3.202"></a><span id="l3.202">         0x83781cc6, 0xc682, 0x11d6,                      \</span>
<a href="#l3.203"></a><span id="l3.203">         {0xbd, 0xeb, 0x00, 0x05, 0x02, 0x49, 0x67, 0xb8} \</span>
<a href="#l3.204"></a><span id="l3.204"> }</span>
<a href="#l3.205"></a><span id="l3.205"> </span>
<a href="#l3.206"></a><span id="l3.206"> //</span>
<a href="#l3.207"></a><span id="l3.207"> // nsAbOSXCard</span>
<a href="#l3.208"></a><span id="l3.208"> //</span>
<a href="#l3.209"></a><span id="l3.209"> #define NS_ABOSXCARD_CONTRACTID \</span>
<a href="#l3.210"></a><span id="l3.210" class="difflineminus">-  NS_RDF_RESOURCE_FACTORY_CONTRACTID_PREFIX NS_ABOSXCARD_PREFIX</span>
<a href="#l3.211"></a><span id="l3.211" class="difflineplus">+  NS_AB_DIRECTORY_TYPE_CONTRACTID_PREFIX NS_ABOSXCARD_PREFIX</span>
<a href="#l3.212"></a><span id="l3.212"> </span>
<a href="#l3.213"></a><span id="l3.213"> #define NS_ABOSXCARD_CID                                 \</span>
<a href="#l3.214"></a><span id="l3.214"> { /* {89bbf582-c682-11d6-bc9d-0005024967b8}*/            \</span>
<a href="#l3.215"></a><span id="l3.215">         0x89bbf582, 0xc682, 0x11d6,                      \</span>
<a href="#l3.216"></a><span id="l3.216">         {0xbc, 0x9d, 0x00, 0x05, 0x02, 0x49, 0x67, 0xb8} \</span>
<a href="#l3.217"></a><span id="l3.217"> }</span>
<a href="#l3.218"></a><span id="l3.218"> </span>
<a href="#l3.219"></a><span id="l3.219"> //</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/addrbook/public/nsIAbDirectory.idl</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/addrbook/public/nsIAbDirectory.idl</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -40,38 +40,51 @@</span>
<a href="#l4.4"></a><span id="l4.4">  </span>
<a href="#l4.5"></a><span id="l4.5"> #include &quot;nsIAbCollection.idl&quot;</span>
<a href="#l4.6"></a><span id="l4.6"> #include &quot;nsIAbCard.idl&quot;</span>
<a href="#l4.7"></a><span id="l4.7"> </span>
<a href="#l4.8"></a><span id="l4.8"> interface nsISimpleEnumerator;</span>
<a href="#l4.9"></a><span id="l4.9"> interface nsIArray;</span>
<a href="#l4.10"></a><span id="l4.10"> interface nsIMutableArray;</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+/* moz-abdirectory:// is the URI to access nsAbBSDirectory,</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+ * which is the root directory for all types of address books</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+ * this is used to get all address book directories. */</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+</span>
<a href="#l4.16"></a><span id="l4.16"> %{C++</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineminus">-/* RDF root for all types of address books */</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineminus">-/* use this to get all directories, create new directory*/</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineminus">-#define kAllDirectoryRoot          &quot;moz-abdirectory://&quot; </span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+#define kAllDirectoryRoot          &quot;moz-abdirectory://&quot;</span>
<a href="#l4.21"></a><span id="l4.21"> </span>
<a href="#l4.22"></a><span id="l4.22"> #define kPersonalAddressbook       &quot;abook.mab&quot;</span>
<a href="#l4.23"></a><span id="l4.23"> #define kPersonalAddressbookUri    &quot;moz-abmdbdirectory://abook.mab&quot;</span>
<a href="#l4.24"></a><span id="l4.24"> #define kCollectedAddressbook      &quot;history.mab&quot;</span>
<a href="#l4.25"></a><span id="l4.25"> #define kCollectedAddressbookUri   &quot;moz-abmdbdirectory://history.mab&quot;</span>
<a href="#l4.26"></a><span id="l4.26"> </span>
<a href="#l4.27"></a><span id="l4.27"> #define kABFileName_PreviousSuffix &quot;.na2&quot; /* final v2 address book format */</span>
<a href="#l4.28"></a><span id="l4.28"> #define kABFileName_PreviousSuffixLen 4</span>
<a href="#l4.29"></a><span id="l4.29"> #define kABFileName_CurrentSuffix &quot;.mab&quot;  /* v3 address book extension */</span>
<a href="#l4.30"></a><span id="l4.30"> %}</span>
<a href="#l4.31"></a><span id="l4.31"> </span>
<a href="#l4.32"></a><span id="l4.32"> /**</span>
<a href="#l4.33"></a><span id="l4.33">  * A top-level address book directory.</span>
<a href="#l4.34"></a><span id="l4.34">  *</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+ * Please note that in order to be properly instantiated by nsIAbManager, every</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+ * type of nsIAbDirectory must have a contract ID of the form:</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+ *</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineplus">+ * @mozilla.org/addressbook/directory;1?type=&lt;AB URI Scheme&gt;</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+ *</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineplus">+ * Where AB URI Scheme does not include the ://.  For example, for the Mork-based</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineplus">+ * address book, the scheme is &quot;moz-abmdbdirectory&quot;, so the contract ID for</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+ * the Mork-based address book type is:</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineplus">+ *</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineplus">+ * @mozilla.org/addressbook/directory;1?type=moz-abmdbdirectory</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineplus">+ *</span>
<a href="#l4.46"></a><span id="l4.46">  * The UUID of an nsIAbDirectory is its preference ID and its name, concatenated</span>
<a href="#l4.47"></a><span id="l4.47">  * together.</span>
<a href="#l4.48"></a><span id="l4.48">  */</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineminus">-[scriptable, uuid(1f11f37e-7009-4a51-bbb1-041e9f75120a)]</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineplus">+[scriptable, uuid(81927b85-11a2-4967-8c90-19ca600cedf0)]</span>
<a href="#l4.51"></a><span id="l4.51"> interface nsIAbDirectory : nsIAbCollection {</span>
<a href="#l4.52"></a><span id="l4.52"> </span>
<a href="#l4.53"></a><span id="l4.53">   /**</span>
<a href="#l4.54"></a><span id="l4.54">    * The chrome URI to use for bringing up a dialog to edit this directory.</span>
<a href="#l4.55"></a><span id="l4.55">    * When opening the dialog, use a JS argument of</span>
<a href="#l4.56"></a><span id="l4.56">    * {selectedDirectory: thisdir} where thisdir is this directory that you just</span>
<a href="#l4.57"></a><span id="l4.57">    * got the chrome URI from.</span>
<a href="#l4.58"></a><span id="l4.58">    */</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineat">@@ -87,17 +100,17 @@ interface nsIAbDirectory : nsIAbCollecti</span>
<a href="#l4.60"></a><span id="l4.60">   // XXX This should really be replaced by a QI or something better</span>
<a href="#l4.61"></a><span id="l4.61">   readonly attribute long dirType;</span>
<a href="#l4.62"></a><span id="l4.62"> </span>
<a href="#l4.63"></a><span id="l4.63">   // eliminated a bit more.</span>
<a href="#l4.64"></a><span id="l4.64"> </span>
<a href="#l4.65"></a><span id="l4.65">   // The filename for address books within this directory.</span>
<a href="#l4.66"></a><span id="l4.66">   readonly attribute ACString fileName;</span>
<a href="#l4.67"></a><span id="l4.67"> </span>
<a href="#l4.68"></a><span id="l4.68" class="difflineminus">-  // The RDF resource URI of the address book</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineplus">+  // The URI of the address book</span>
<a href="#l4.70"></a><span id="l4.70">   readonly attribute ACString URI;</span>
<a href="#l4.71"></a><span id="l4.71"> </span>
<a href="#l4.72"></a><span id="l4.72">   // The position of the directory on the display.</span>
<a href="#l4.73"></a><span id="l4.73">   readonly attribute long position;</span>
<a href="#l4.74"></a><span id="l4.74"> </span>
<a href="#l4.75"></a><span id="l4.75">   // will be used for LDAP replication</span>
<a href="#l4.76"></a><span id="l4.76">   attribute unsigned long lastModifiedDate;</span>
<a href="#l4.77"></a><span id="l4.77"> </span>
<a href="#l4.78"></a><span id="l4.78" class="difflineat">@@ -115,16 +128,22 @@ interface nsIAbDirectory : nsIAbCollecti</span>
<a href="#l4.79"></a><span id="l4.79">   readonly attribute nsISimpleEnumerator childCards;</span>
<a href="#l4.80"></a><span id="l4.80"> </span>
<a href="#l4.81"></a><span id="l4.81">   /**</span>
<a href="#l4.82"></a><span id="l4.82">    * Returns true if this directory represents a query - i.e. the rdf resource</span>
<a href="#l4.83"></a><span id="l4.83">    * was something like moz-abmdbdirectory://abook.mab?....</span>
<a href="#l4.84"></a><span id="l4.84">    */</span>
<a href="#l4.85"></a><span id="l4.85">   readonly attribute boolean isQuery;</span>
<a href="#l4.86"></a><span id="l4.86"> </span>
<a href="#l4.87"></a><span id="l4.87" class="difflineplus">+  /**</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineplus">+   * Initializes a directory, pointing to a particular</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineplus">+   * URI</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineplus">+   */</span>
<a href="#l4.91"></a><span id="l4.91" class="difflineplus">+  void init(in string aURI);</span>
<a href="#l4.92"></a><span id="l4.92" class="difflineplus">+</span>
<a href="#l4.93"></a><span id="l4.93">   // Deletes either a mailing list or a top</span>
<a href="#l4.94"></a><span id="l4.94">   // level directory, which also updates the</span>
<a href="#l4.95"></a><span id="l4.95">   // preferences</span>
<a href="#l4.96"></a><span id="l4.96">   void deleteDirectory(in nsIAbDirectory directory);</span>
<a href="#l4.97"></a><span id="l4.97"> </span>
<a href="#l4.98"></a><span id="l4.98">   // Check if directory contains card</span>
<a href="#l4.99"></a><span id="l4.99">   // If the implementation is asynchronous the card</span>
<a href="#l4.100"></a><span id="l4.100">   // may not yet have arrived. If it is in the process</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/addrbook/public/nsIAbMDBDirectory.idl</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/addrbook/public/nsIAbMDBDirectory.idl</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -46,17 +46,17 @@ interface nsIAddrDatabase;</span>
<a href="#l5.4"></a><span id="l5.4"> %{C++</span>
<a href="#l5.5"></a><span id="l5.5"> #define kMDBDirectoryRoot          &quot;moz-abmdbdirectory://&quot;</span>
<a href="#l5.6"></a><span id="l5.6"> #define kMDBDirectoryRootLen       21</span>
<a href="#l5.7"></a><span id="l5.7"> %}</span>
<a href="#l5.8"></a><span id="l5.8"> </span>
<a href="#l5.9"></a><span id="l5.9"> [scriptable, uuid(744072be-1ba0-46bc-af24-46e22567a2ea)]</span>
<a href="#l5.10"></a><span id="l5.10"> interface nsIAbMDBDirectory : nsISupports {</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-	// Creates an RDF directory component from the</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+	// Creates a directory component from the</span>
<a href="#l5.14"></a><span id="l5.14"> 	// uriName, adds it to its children and returns</span>
<a href="#l5.15"></a><span id="l5.15"> 	// the component</span>
<a href="#l5.16"></a><span id="l5.16"> 	nsIAbDirectory addDirectory(in string uriName);</span>
<a href="#l5.17"></a><span id="l5.17"> </span>
<a href="#l5.18"></a><span id="l5.18">   /**</span>
<a href="#l5.19"></a><span id="l5.19">    * Supplies a nsILocalFile point to the database file for this directory</span>
<a href="#l5.20"></a><span id="l5.20">    *</span>
<a href="#l5.21"></a><span id="l5.21">    * @exception NS_ERROR_NOT_INITIALIZED If there is no filename preference</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/addrbook/src/Makefile.in</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/addrbook/src/Makefile.in</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -47,35 +47,32 @@ MODULE		= addrbook</span>
<a href="#l6.4"></a><span id="l6.4"> LIBRARY_NAME	= addrbook_s</span>
<a href="#l6.5"></a><span id="l6.5"> ifndef MOZ_INCOMPLETE_EXTERNAL_LINKAGE</span>
<a href="#l6.6"></a><span id="l6.6"> MOZILLA_INTERNAL_API = 1</span>
<a href="#l6.7"></a><span id="l6.7"> LIBXUL_LIBRARY = 1</span>
<a href="#l6.8"></a><span id="l6.8"> endif</span>
<a href="#l6.9"></a><span id="l6.9"> </span>
<a href="#l6.10"></a><span id="l6.10"> CPPSRCS		= \</span>
<a href="#l6.11"></a><span id="l6.11"> 		nsAbManager.cpp \</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-		nsAbRDFDataSource.cpp \</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-		nsDirectoryDataSource.cpp \</span>
<a href="#l6.14"></a><span id="l6.14"> 		nsAbCardProperty.cpp \</span>
<a href="#l6.15"></a><span id="l6.15"> 		nsDirPrefs.cpp \</span>
<a href="#l6.16"></a><span id="l6.16"> 		nsAddrDatabase.cpp \</span>
<a href="#l6.17"></a><span id="l6.17"> 		nsAbDirProperty.cpp \</span>
<a href="#l6.18"></a><span id="l6.18"> 		nsAbAddressCollector.cpp \</span>
<a href="#l6.19"></a><span id="l6.19"> 		nsAddbookProtocolHandler.cpp  \</span>
<a href="#l6.20"></a><span id="l6.20"> 		nsAbMDBDirProperty.cpp \</span>
<a href="#l6.21"></a><span id="l6.21"> 		nsAbMDBDirectory.cpp \</span>
<a href="#l6.22"></a><span id="l6.22"> 		nsAbMDBCard.cpp \</span>
<a href="#l6.23"></a><span id="l6.23"> 		nsAbBSDirectory.cpp \</span>
<a href="#l6.24"></a><span id="l6.24"> 		nsAddbookUrl.cpp    \</span>
<a href="#l6.25"></a><span id="l6.25"> 		nsAbDirFactoryService.cpp	\</span>
<a href="#l6.26"></a><span id="l6.26"> 		nsAbMDBDirFactory.cpp	\</span>
<a href="#l6.27"></a><span id="l6.27">                 nsAbDirectoryQuery.cpp    \</span>
<a href="#l6.28"></a><span id="l6.28">                 nsAbDirectoryQueryProxy.cpp    \</span>
<a href="#l6.29"></a><span id="l6.29">                 nsAbBooleanExpression.cpp \</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineminus">-                nsAbDirectoryRDFResource.cpp \</span>
<a href="#l6.31"></a><span id="l6.31">                 nsAbQueryStringToExpression.cpp \</span>
<a href="#l6.32"></a><span id="l6.32">                 nsAbView.cpp \</span>
<a href="#l6.33"></a><span id="l6.33">                 nsVCard.cpp \</span>
<a href="#l6.34"></a><span id="l6.34">                 nsVCardObj.cpp \</span>
<a href="#l6.35"></a><span id="l6.35">                 nsMsgVCardService.cpp \</span>
<a href="#l6.36"></a><span id="l6.36">                 nsAbLDIFService.cpp \</span>
<a href="#l6.37"></a><span id="l6.37">                 nsAbContentHandler.cpp \</span>
<a href="#l6.38"></a><span id="l6.38"> 		$(NULL)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbBSDirectory.cpp</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbBSDirectory.cpp</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -37,43 +37,45 @@</span>
<a href="#l7.4"></a><span id="l7.4">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l7.5"></a><span id="l7.5">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l7.6"></a><span id="l7.6">  *</span>
<a href="#l7.7"></a><span id="l7.7">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l7.8"></a><span id="l7.8"> </span>
<a href="#l7.9"></a><span id="l7.9"> #include &quot;nsIPrefService.h&quot;</span>
<a href="#l7.10"></a><span id="l7.10"> #include &quot;nsAbBSDirectory.h&quot;</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-#include &quot;nsRDFCID.h&quot;</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-#include &quot;nsIRDFService.h&quot;</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineminus">-</span>
<a href="#l7.15"></a><span id="l7.15"> #include &quot;nsDirPrefs.h&quot;</span>
<a href="#l7.16"></a><span id="l7.16"> #include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l7.17"></a><span id="l7.17"> #include &quot;nsAddrDatabase.h&quot;</span>
<a href="#l7.18"></a><span id="l7.18"> #include &quot;nsIAbManager.h&quot;</span>
<a href="#l7.19"></a><span id="l7.19"> #include &quot;nsIAbMDBDirectory.h&quot;</span>
<a href="#l7.20"></a><span id="l7.20"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l7.21"></a><span id="l7.21"> #include &quot;nsAbDirFactoryService.h&quot;</span>
<a href="#l7.22"></a><span id="l7.22"> #include &quot;nsAbMDBDirFactory.h&quot;</span>
<a href="#l7.23"></a><span id="l7.23"> #include &quot;nsArrayEnumerator.h&quot;</span>
<a href="#l7.24"></a><span id="l7.24"> </span>
<a href="#l7.25"></a><span id="l7.25"> #include &quot;nsCRTGlue.h&quot;</span>
<a href="#l7.26"></a><span id="l7.26"> </span>
<a href="#l7.27"></a><span id="l7.27"> nsAbBSDirectory::nsAbBSDirectory()</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineminus">-: nsRDFResource(),</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineminus">-mInitialized(PR_FALSE)</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineplus">+: mInitialized(PR_FALSE)</span>
<a href="#l7.31"></a><span id="l7.31"> {</span>
<a href="#l7.32"></a><span id="l7.32">   mServers.Init(13);</span>
<a href="#l7.33"></a><span id="l7.33"> }</span>
<a href="#l7.34"></a><span id="l7.34"> </span>
<a href="#l7.35"></a><span id="l7.35"> nsAbBSDirectory::~nsAbBSDirectory()</span>
<a href="#l7.36"></a><span id="l7.36"> {</span>
<a href="#l7.37"></a><span id="l7.37"> }</span>
<a href="#l7.38"></a><span id="l7.38"> </span>
<a href="#l7.39"></a><span id="l7.39" class="difflineminus">-NS_IMPL_ISUPPORTS_INHERITED1(nsAbBSDirectory, nsRDFResource, nsIAbDirectory)</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineplus">+NS_IMETHODIMP nsAbBSDirectory::Init(const char *aURI)</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineplus">+{</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineplus">+  mURI = aURI;</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineplus">+  return NS_OK;</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineplus">+}</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineplus">+</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineplus">+NS_IMPL_ISUPPORTS_INHERITED0(nsAbBSDirectory, nsAbDirProperty)</span>
<a href="#l7.47"></a><span id="l7.47"> </span>
<a href="#l7.48"></a><span id="l7.48"> nsresult nsAbBSDirectory::CreateDirectoriesFromFactory(const nsACString &amp;aURI,</span>
<a href="#l7.49"></a><span id="l7.49">                                                        DIR_Server *aServer,</span>
<a href="#l7.50"></a><span id="l7.50">                                                        PRBool aNotify)</span>
<a href="#l7.51"></a><span id="l7.51"> {</span>
<a href="#l7.52"></a><span id="l7.52">   nsresult rv;</span>
<a href="#l7.53"></a><span id="l7.53"> </span>
<a href="#l7.54"></a><span id="l7.54">   // Get the directory factory service</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineat">@@ -111,18 +113,16 @@ nsresult nsAbBSDirectory::CreateDirector</span>
<a href="#l7.56"></a><span id="l7.56">       continue;</span>
<a href="#l7.57"></a><span id="l7.57">     </span>
<a href="#l7.58"></a><span id="l7.58">     // Define a relationship between the preference</span>
<a href="#l7.59"></a><span id="l7.59">     // entry and the directory</span>
<a href="#l7.60"></a><span id="l7.60">     mServers.Put(childDir, aServer);</span>
<a href="#l7.61"></a><span id="l7.61"> </span>
<a href="#l7.62"></a><span id="l7.62">     mSubDirectories.AppendObject(childDir);</span>
<a href="#l7.63"></a><span id="l7.63"> </span>
<a href="#l7.64"></a><span id="l7.64" class="difflineminus">-    // Inform the listener, i.e. the RDF directory data</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineminus">-    // source that a new address book has been added</span>
<a href="#l7.66"></a><span id="l7.66">     if (aNotify &amp;&amp; abManager)</span>
<a href="#l7.67"></a><span id="l7.67">       abManager-&gt;NotifyDirectoryItemAdded(this, childDir);</span>
<a href="#l7.68"></a><span id="l7.68">   }</span>
<a href="#l7.69"></a><span id="l7.69">   </span>
<a href="#l7.70"></a><span id="l7.70">   return NS_OK;</span>
<a href="#l7.71"></a><span id="l7.71"> }</span>
<a href="#l7.72"></a><span id="l7.72"> </span>
<a href="#l7.73"></a><span id="l7.73"> NS_IMETHODIMP nsAbBSDirectory::GetChildNodes(nsISimpleEnumerator* *aResult)</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineat">@@ -315,19 +315,19 @@ NS_IMETHODIMP nsAbBSDirectory::DeleteDir</span>
<a href="#l7.75"></a><span id="l7.75">     nsCOMPtr&lt;nsIAbDirectory&gt; d = getDirectories.directories[i];</span>
<a href="#l7.76"></a><span id="l7.76"> </span>
<a href="#l7.77"></a><span id="l7.77">     mServers.Remove(d);</span>
<a href="#l7.78"></a><span id="l7.78">     rv = mSubDirectories.RemoveObject(d);</span>
<a href="#l7.79"></a><span id="l7.79"> </span>
<a href="#l7.80"></a><span id="l7.80">     if (abManager)</span>
<a href="#l7.81"></a><span id="l7.81">       abManager-&gt;NotifyDirectoryDeleted(this, d);</span>
<a href="#l7.82"></a><span id="l7.82"> </span>
<a href="#l7.83"></a><span id="l7.83" class="difflineminus">-    nsCOMPtr&lt;nsIRDFResource&gt; resource(do_QueryInterface (d, &amp;rv));</span>
<a href="#l7.84"></a><span id="l7.84">     nsCString uri;</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineminus">-    resource-&gt;GetValueUTF8(uri);</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineplus">+    rv = d-&gt;GetURI(uri);</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.88"></a><span id="l7.88"> </span>
<a href="#l7.89"></a><span id="l7.89">     nsCOMPtr&lt;nsIAbDirFactory&gt; dirFactory;</span>
<a href="#l7.90"></a><span id="l7.90">     rv = dirFactoryService-&gt;GetDirFactory(uri, getter_AddRefs(dirFactory));</span>
<a href="#l7.91"></a><span id="l7.91">     if (NS_FAILED(rv))</span>
<a href="#l7.92"></a><span id="l7.92">       continue;</span>
<a href="#l7.93"></a><span id="l7.93"> </span>
<a href="#l7.94"></a><span id="l7.94">     rv = dirFactory-&gt;DeleteDirectory(d);</span>
<a href="#l7.95"></a><span id="l7.95">   }</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineat">@@ -352,8 +352,18 @@ NS_IMETHODIMP nsAbBSDirectory::UseForAut</span>
<a href="#l7.97"></a><span id="l7.97">                                                   PRBool *aResult)</span>
<a href="#l7.98"></a><span id="l7.98"> {</span>
<a href="#l7.99"></a><span id="l7.99">   // For the &quot;root&quot; directory (kAllDirectoryRoot) always return true so that</span>
<a href="#l7.100"></a><span id="l7.100">   // we can search sub directories that may or may not be local.</span>
<a href="#l7.101"></a><span id="l7.101">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l7.102"></a><span id="l7.102">   *aResult = PR_TRUE;</span>
<a href="#l7.103"></a><span id="l7.103">   return NS_OK;</span>
<a href="#l7.104"></a><span id="l7.104"> }</span>
<a href="#l7.105"></a><span id="l7.105" class="difflineplus">+</span>
<a href="#l7.106"></a><span id="l7.106" class="difflineplus">+NS_IMETHODIMP nsAbBSDirectory::GetURI(nsACString &amp;aURI)</span>
<a href="#l7.107"></a><span id="l7.107" class="difflineplus">+{</span>
<a href="#l7.108"></a><span id="l7.108" class="difflineplus">+  if (mURI.IsEmpty())</span>
<a href="#l7.109"></a><span id="l7.109" class="difflineplus">+    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l7.110"></a><span id="l7.110" class="difflineplus">+</span>
<a href="#l7.111"></a><span id="l7.111" class="difflineplus">+  aURI = mURI;</span>
<a href="#l7.112"></a><span id="l7.112" class="difflineplus">+  return NS_OK;</span>
<a href="#l7.113"></a><span id="l7.113" class="difflineplus">+}</span>
<a href="#l7.114"></a><span id="l7.114" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbBSDirectory.h</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbBSDirectory.h</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -34,42 +34,43 @@</span>
<a href="#l8.4"></a><span id="l8.4">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l8.5"></a><span id="l8.5">  *</span>
<a href="#l8.6"></a><span id="l8.6">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l8.7"></a><span id="l8.7"> </span>
<a href="#l8.8"></a><span id="l8.8"> </span>
<a href="#l8.9"></a><span id="l8.9"> #ifndef nsAbBSDirectory_h__</span>
<a href="#l8.10"></a><span id="l8.10"> #define nsAbBSDirectory_h__</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-#include &quot;nsRDFResource.h&quot;</span>
<a href="#l8.13"></a><span id="l8.13"> #include &quot;nsAbDirProperty.h&quot;</span>
<a href="#l8.14"></a><span id="l8.14"> </span>
<a href="#l8.15"></a><span id="l8.15"> #include &quot;nsDataHashtable.h&quot;</span>
<a href="#l8.16"></a><span id="l8.16"> #include &quot;nsCOMArray.h&quot;</span>
<a href="#l8.17"></a><span id="l8.17"> </span>
<a href="#l8.18"></a><span id="l8.18" class="difflineminus">-class nsAbBSDirectory : public nsRDFResource, public nsAbDirProperty</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineplus">+class nsAbBSDirectory : public nsAbDirProperty</span>
<a href="#l8.20"></a><span id="l8.20"> {</span>
<a href="#l8.21"></a><span id="l8.21"> public:</span>
<a href="#l8.22"></a><span id="l8.22"> 	NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l8.23"></a><span id="l8.23"> </span>
<a href="#l8.24"></a><span id="l8.24"> 	nsAbBSDirectory();</span>
<a href="#l8.25"></a><span id="l8.25"> 	virtual ~nsAbBSDirectory();</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineminus">-	</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineplus">+</span>
<a href="#l8.28"></a><span id="l8.28"> 	// nsIAbDirectory methods</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineplus">+  NS_IMETHOD Init(const char *aURI);</span>
<a href="#l8.30"></a><span id="l8.30"> 	NS_IMETHOD GetChildNodes(nsISimpleEnumerator* *result);</span>
<a href="#l8.31"></a><span id="l8.31">   NS_IMETHOD CreateNewDirectory(const nsAString &amp;aDirName,</span>
<a href="#l8.32"></a><span id="l8.32">                                 const nsACString &amp;aURI,</span>
<a href="#l8.33"></a><span id="l8.33">                                 PRUint32 aType,</span>
<a href="#l8.34"></a><span id="l8.34">                                 const nsACString &amp;aPrefName,</span>
<a href="#l8.35"></a><span id="l8.35">                                 nsACString &amp;aResult);</span>
<a href="#l8.36"></a><span id="l8.36">   NS_IMETHOD CreateDirectoryByURI(const nsAString &amp;aDisplayName,</span>
<a href="#l8.37"></a><span id="l8.37">                                   const nsACString &amp;aURI);</span>
<a href="#l8.38"></a><span id="l8.38">   NS_IMETHOD DeleteDirectory(nsIAbDirectory *directory);</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineminus">-	NS_IMETHOD HasDirectory(nsIAbDirectory *dir, PRBool *hasDir);</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineplus">+  NS_IMETHOD HasDirectory(nsIAbDirectory *dir, PRBool *hasDir);</span>
<a href="#l8.41"></a><span id="l8.41">   NS_IMETHOD UseForAutocomplete(const nsACString &amp;aIdentityKey, PRBool *aResult);</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineplus">+  NS_IMETHOD GetURI(nsACString &amp;aURI);</span>
<a href="#l8.43"></a><span id="l8.43"> </span>
<a href="#l8.44"></a><span id="l8.44"> protected:</span>
<a href="#l8.45"></a><span id="l8.45">   nsresult EnsureInitialized();</span>
<a href="#l8.46"></a><span id="l8.46"> 	nsresult CreateDirectoriesFromFactory(const nsACString &amp;aURI,</span>
<a href="#l8.47"></a><span id="l8.47">                                         DIR_Server* aServer, PRBool aNotify);</span>
<a href="#l8.48"></a><span id="l8.48"> </span>
<a href="#l8.49"></a><span id="l8.49"> protected:</span>
<a href="#l8.50"></a><span id="l8.50"> 	PRBool mInitialized;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbDirProperty.cpp</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbDirProperty.cpp</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -41,24 +41,25 @@</span>
<a href="#l9.4"></a><span id="l9.4"> #include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l9.5"></a><span id="l9.5"> #include &quot;nsIAbCard.h&quot;</span>
<a href="#l9.6"></a><span id="l9.6"> #include &quot;nsDirPrefs.h&quot;</span>
<a href="#l9.7"></a><span id="l9.7"> #include &quot;nsIPrefService.h&quot;</span>
<a href="#l9.8"></a><span id="l9.8"> #include &quot;nsIPrefLocalizedString.h&quot;</span>
<a href="#l9.9"></a><span id="l9.9"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l9.10"></a><span id="l9.10"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l9.11"></a><span id="l9.11"> #include &quot;prmem.h&quot;</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-#include &quot;rdf.h&quot;</span>
<a href="#l9.13"></a><span id="l9.13"> #include &quot;nsIAbManager.h&quot;</span>
<a href="#l9.14"></a><span id="l9.14"> </span>
<a href="#l9.15"></a><span id="l9.15"> // From nsDirPrefs</span>
<a href="#l9.16"></a><span id="l9.16"> #define kDefaultPosition 1</span>
<a href="#l9.17"></a><span id="l9.17"> </span>
<a href="#l9.18"></a><span id="l9.18"> nsAbDirProperty::nsAbDirProperty(void)</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineminus">-  : m_LastModifiedDate(0)</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineplus">+  : m_LastModifiedDate(0),</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineplus">+    mIsValidURI(PR_FALSE),</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineplus">+    mIsQueryURI(PR_FALSE)</span>
<a href="#l9.23"></a><span id="l9.23"> {</span>
<a href="#l9.24"></a><span id="l9.24"> 	m_IsMailList = PR_FALSE;</span>
<a href="#l9.25"></a><span id="l9.25"> }</span>
<a href="#l9.26"></a><span id="l9.26"> </span>
<a href="#l9.27"></a><span id="l9.27"> nsAbDirProperty::~nsAbDirProperty(void)</span>
<a href="#l9.28"></a><span id="l9.28"> {</span>
<a href="#l9.29"></a><span id="l9.29"> #if 0</span>
<a href="#l9.30"></a><span id="l9.30">   // this code causes a regression #138647</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineat">@@ -71,17 +72,17 @@ nsAbDirProperty::~nsAbDirProperty(void)</span>
<a href="#l9.32"></a><span id="l9.32">     PRInt32 i;</span>
<a href="#l9.33"></a><span id="l9.33">     for (i = count - 1; i &gt;= 0; i--)</span>
<a href="#l9.34"></a><span id="l9.34">       m_AddressList-&gt;RemoveElementAt(i);</span>
<a href="#l9.35"></a><span id="l9.35">   }</span>
<a href="#l9.36"></a><span id="l9.36"> #endif</span>
<a href="#l9.37"></a><span id="l9.37"> }</span>
<a href="#l9.38"></a><span id="l9.38"> </span>
<a href="#l9.39"></a><span id="l9.39"> NS_IMPL_ISUPPORTS4(nsAbDirProperty, nsIAbDirectory, nsISupportsWeakReference,</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineminus">-                   nsIAbCollection, nsIAbItem)</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineplus">+                              nsIAbCollection, nsIAbItem)</span>
<a href="#l9.42"></a><span id="l9.42"> </span>
<a href="#l9.43"></a><span id="l9.43"> NS_IMETHODIMP nsAbDirProperty::GetUuid(nsACString &amp;uuid)</span>
<a href="#l9.44"></a><span id="l9.44"> {</span>
<a href="#l9.45"></a><span id="l9.45">   // XXX: not all directories have a dirPrefId...</span>
<a href="#l9.46"></a><span id="l9.46">   nsresult rv = GetDirPrefId(uuid);</span>
<a href="#l9.47"></a><span id="l9.47">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.48"></a><span id="l9.48">   uuid.Append('&amp;');</span>
<a href="#l9.49"></a><span id="l9.49">   nsString dirName;</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineat">@@ -187,23 +188,19 @@ NS_IMETHODIMP nsAbDirProperty::GetURI(ns</span>
<a href="#l9.51"></a><span id="l9.51"> </span>
<a href="#l9.52"></a><span id="l9.52"> NS_IMETHODIMP nsAbDirProperty::GetPosition(PRInt32 *aPosition)</span>
<a href="#l9.53"></a><span id="l9.53"> {</span>
<a href="#l9.54"></a><span id="l9.54">   return GetIntValue(&quot;position&quot;, kDefaultPosition, aPosition);</span>
<a href="#l9.55"></a><span id="l9.55"> }</span>
<a href="#l9.56"></a><span id="l9.56"> </span>
<a href="#l9.57"></a><span id="l9.57"> NS_IMETHODIMP nsAbDirProperty::GetLastModifiedDate(PRUint32 *aLastModifiedDate)</span>
<a href="#l9.58"></a><span id="l9.58"> {</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineminus">-	if (aLastModifiedDate)</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineminus">-	{</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineminus">-		*aLastModifiedDate = m_LastModifiedDate;</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineminus">-		return NS_OK;</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineminus">-	}</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineminus">-	else</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineminus">-		return NS_RDF_NO_VALUE;</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aLastModifiedDate);</span>
<a href="#l9.67"></a><span id="l9.67" class="difflineplus">+  *aLastModifiedDate = m_LastModifiedDate;</span>
<a href="#l9.68"></a><span id="l9.68" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.69"></a><span id="l9.69"> }</span>
<a href="#l9.70"></a><span id="l9.70"> </span>
<a href="#l9.71"></a><span id="l9.71"> NS_IMETHODIMP nsAbDirProperty::SetLastModifiedDate(PRUint32 aLastModifiedDate)</span>
<a href="#l9.72"></a><span id="l9.72"> {</span>
<a href="#l9.73"></a><span id="l9.73"> 	if (aLastModifiedDate)</span>
<a href="#l9.74"></a><span id="l9.74"> 	{</span>
<a href="#l9.75"></a><span id="l9.75"> 		m_LastModifiedDate = aLastModifiedDate;</span>
<a href="#l9.76"></a><span id="l9.76"> 	}</span>
<a href="#l9.77"></a><span id="l9.77" class="difflineat">@@ -288,18 +285,35 @@ NS_IMETHODIMP nsAbDirProperty::GetIsQuer</span>
<a href="#l9.78"></a><span id="l9.78"> {</span>
<a href="#l9.79"></a><span id="l9.79">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l9.80"></a><span id="l9.80">   // Mailing lists are not queries by default, individual directory types</span>
<a href="#l9.81"></a><span id="l9.81">   // will override this.</span>
<a href="#l9.82"></a><span id="l9.82">   *aResult = PR_FALSE;</span>
<a href="#l9.83"></a><span id="l9.83">   return NS_OK;</span>
<a href="#l9.84"></a><span id="l9.84"> }</span>
<a href="#l9.85"></a><span id="l9.85"> </span>
<a href="#l9.86"></a><span id="l9.86" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l9.87"></a><span id="l9.87" class="difflineplus">+nsAbDirProperty::Init(const char *aURI)</span>
<a href="#l9.88"></a><span id="l9.88" class="difflineplus">+{</span>
<a href="#l9.89"></a><span id="l9.89" class="difflineplus">+  mURINoQuery = aURI;</span>
<a href="#l9.90"></a><span id="l9.90" class="difflineplus">+  mURI = aURI;</span>
<a href="#l9.91"></a><span id="l9.91" class="difflineplus">+  mIsValidURI = PR_TRUE;</span>
<a href="#l9.92"></a><span id="l9.92" class="difflineplus">+</span>
<a href="#l9.93"></a><span id="l9.93" class="difflineplus">+  PRInt32 searchCharLocation = mURINoQuery.FindChar('?');</span>
<a href="#l9.94"></a><span id="l9.94" class="difflineplus">+  if (searchCharLocation &gt;= 0)</span>
<a href="#l9.95"></a><span id="l9.95" class="difflineplus">+  {</span>
<a href="#l9.96"></a><span id="l9.96" class="difflineplus">+    mQueryString = Substring(mURINoQuery, searchCharLocation + 1);</span>
<a href="#l9.97"></a><span id="l9.97" class="difflineplus">+    mURINoQuery.SetLength(searchCharLocation);</span>
<a href="#l9.98"></a><span id="l9.98" class="difflineplus">+    mIsQueryURI = PR_TRUE;</span>
<a href="#l9.99"></a><span id="l9.99" class="difflineplus">+  }</span>
<a href="#l9.100"></a><span id="l9.100" class="difflineplus">+</span>
<a href="#l9.101"></a><span id="l9.101" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.102"></a><span id="l9.102" class="difflineplus">+}</span>
<a href="#l9.103"></a><span id="l9.103" class="difflineplus">+</span>
<a href="#l9.104"></a><span id="l9.104"> // nsIAbDirectory NOT IMPLEMENTED methods</span>
<a href="#l9.105"></a><span id="l9.105" class="difflineminus">-</span>
<a href="#l9.106"></a><span id="l9.106"> NS_IMETHODIMP</span>
<a href="#l9.107"></a><span id="l9.107"> nsAbDirProperty::GetChildNodes(nsISimpleEnumerator **childList)</span>
<a href="#l9.108"></a><span id="l9.108"> { return NS_ERROR_NOT_IMPLEMENTED; }</span>
<a href="#l9.109"></a><span id="l9.109"> </span>
<a href="#l9.110"></a><span id="l9.110"> NS_IMETHODIMP</span>
<a href="#l9.111"></a><span id="l9.111"> nsAbDirProperty::GetChildCards(nsISimpleEnumerator **childCards)</span>
<a href="#l9.112"></a><span id="l9.112"> { return NS_ERROR_NOT_IMPLEMENTED; }</span>
<a href="#l9.113"></a><span id="l9.113"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbDirProperty.h</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbDirProperty.h</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -81,16 +81,23 @@ protected:</span>
<a href="#l10.4"></a><span id="l10.4"> 	PRUint32 m_LastModifiedDate;</span>
<a href="#l10.5"></a><span id="l10.5"> </span>
<a href="#l10.6"></a><span id="l10.6"> 	nsString m_ListDirName;</span>
<a href="#l10.7"></a><span id="l10.7"> 	nsString m_ListName;</span>
<a href="#l10.8"></a><span id="l10.8"> 	nsString m_ListNickName;</span>
<a href="#l10.9"></a><span id="l10.9"> 	nsString m_Description;</span>
<a href="#l10.10"></a><span id="l10.10"> 	PRBool   m_IsMailList;</span>
<a href="#l10.11"></a><span id="l10.11"> </span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+  nsCString mURI;</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+  nsCString mQueryString;</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+  nsCString mURINoQuery;</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineplus">+  PRBool mIsValidURI;</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+  PRBool mIsQueryURI;</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineplus">+</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineplus">+</span>
<a href="#l10.19"></a><span id="l10.19">   /*</span>
<a href="#l10.20"></a><span id="l10.20">    * Note that any derived implementations should ensure that this item</span>
<a href="#l10.21"></a><span id="l10.21">    * (m_DirPrefId) is correctly initialised correctly</span>
<a href="#l10.22"></a><span id="l10.22">    */</span>
<a href="#l10.23"></a><span id="l10.23">   nsCString m_DirPrefId;  // ie,&quot;ldap_2.servers.pab&quot;</span>
<a href="#l10.24"></a><span id="l10.24"> </span>
<a href="#l10.25"></a><span id="l10.25">   nsCOMPtr&lt;nsIPrefBranch&gt; m_DirectoryPrefs;</span>
<a href="#l10.26"></a><span id="l10.26">   nsCOMPtr&lt;nsIMutableArray&gt; m_AddressList;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1">deleted file mode 100644</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineminus">--- a/mailnews/addrbook/src/nsAbDirectoryRDFResource.cpp</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineplus">+++ /dev/null</span>
<a href="#l11.4"></a><span id="l11.4" class="difflineat">@@ -1,74 +0,0 @@</span>
<a href="#l11.5"></a><span id="l11.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l11.6"></a><span id="l11.6" class="difflineminus">-/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l11.7"></a><span id="l11.7" class="difflineminus">- * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l11.8"></a><span id="l11.8" class="difflineminus">- *</span>
<a href="#l11.9"></a><span id="l11.9" class="difflineminus">- * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l11.10"></a><span id="l11.10" class="difflineminus">- * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l11.11"></a><span id="l11.11" class="difflineminus">- * the License. You may obtain a copy of the License at</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">- * http://www.mozilla.org/MPL/</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">- *</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineminus">- * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineminus">- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineminus">- * for the specific language governing rights and limitations under the</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineminus">- * License.</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineminus">- *</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineminus">- * The Original Code is mozilla.org code.</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineminus">- *</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineminus">- * The Initial Developer of the Original Code is</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineminus">- * Sun Microsystems, Inc.</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineminus">- * Portions created by the Initial Developer are Copyright (C) 2001</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineminus">- * the Initial Developer. All Rights Reserved.</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineminus">- *</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineminus">- * Contributor(s):</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineminus">- *   Paul Sandoz &lt;paul.sandoz@sun.com&gt;</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineminus">- *</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineminus">- * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineminus">- * either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineminus">- * or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineminus">- * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineminus">- * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineminus">- * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineminus">- * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineminus">- * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineminus">- * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineminus">- * the provisions above, a recipient may use your version of this file under</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineminus">- * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineminus">- *</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineminus">- * ***** END LICENSE BLOCK ***** */</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineminus">-</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineminus">-#include &quot;nsAbDirectoryRDFResource.h&quot;</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineminus">-#include &quot;nsIURL.h&quot;</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineminus">-#include &quot;nsNetCID.h&quot;</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineminus">-#include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineminus">-#include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineminus">-</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineminus">-nsAbDirectoryRDFResource::nsAbDirectoryRDFResource () :</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineminus">-    nsRDFResource (),</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineminus">-    mIsValidURI (PR_FALSE),</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineminus">-    mIsQueryURI (PR_FALSE)</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineminus">-{</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineminus">-}</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineminus">-</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineminus">-nsAbDirectoryRDFResource::~nsAbDirectoryRDFResource ()</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineminus">-{</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineminus">-}</span>
<a href="#l11.59"></a><span id="l11.59" class="difflineminus">-</span>
<a href="#l11.60"></a><span id="l11.60" class="difflineminus">-NS_IMPL_ISUPPORTS_INHERITED0(nsAbDirectoryRDFResource, nsRDFResource)</span>
<a href="#l11.61"></a><span id="l11.61" class="difflineminus">-</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineminus">-NS_IMETHODIMP nsAbDirectoryRDFResource::Init(const char* aURI)</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineminus">-{</span>
<a href="#l11.64"></a><span id="l11.64" class="difflineminus">-    nsresult rv = nsRDFResource::Init (aURI);</span>
<a href="#l11.65"></a><span id="l11.65" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineminus">-</span>
<a href="#l11.67"></a><span id="l11.67" class="difflineminus">-    mURINoQuery = aURI;</span>
<a href="#l11.68"></a><span id="l11.68" class="difflineminus">-    mIsValidURI = PR_TRUE;</span>
<a href="#l11.69"></a><span id="l11.69" class="difflineminus">-</span>
<a href="#l11.70"></a><span id="l11.70" class="difflineminus">-    PRInt32 searchCharLocation = mURINoQuery.FindChar('?');</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineminus">-    if (searchCharLocation &gt;= 0) {</span>
<a href="#l11.72"></a><span id="l11.72" class="difflineminus">-        mQueryString = Substring(mURINoQuery, searchCharLocation + 1);</span>
<a href="#l11.73"></a><span id="l11.73" class="difflineminus">-        mURINoQuery.SetLength(searchCharLocation);</span>
<a href="#l11.74"></a><span id="l11.74" class="difflineminus">-        mIsQueryURI = PR_TRUE;</span>
<a href="#l11.75"></a><span id="l11.75" class="difflineminus">-    }</span>
<a href="#l11.76"></a><span id="l11.76" class="difflineminus">-</span>
<a href="#l11.77"></a><span id="l11.77" class="difflineminus">-    return rv;</span>
<a href="#l11.78"></a><span id="l11.78" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1">deleted file mode 100644</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineminus">--- a/mailnews/addrbook/src/nsAbDirectoryRDFResource.h</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineplus">+++ /dev/null</span>
<a href="#l12.4"></a><span id="l12.4" class="difflineat">@@ -1,64 +0,0 @@</span>
<a href="#l12.5"></a><span id="l12.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l12.6"></a><span id="l12.6" class="difflineminus">-/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l12.7"></a><span id="l12.7" class="difflineminus">- * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l12.8"></a><span id="l12.8" class="difflineminus">- *</span>
<a href="#l12.9"></a><span id="l12.9" class="difflineminus">- * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l12.10"></a><span id="l12.10" class="difflineminus">- * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l12.11"></a><span id="l12.11" class="difflineminus">- * the License. You may obtain a copy of the License at</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">- * http://www.mozilla.org/MPL/</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineminus">- *</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineminus">- * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineminus">- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineminus">- * for the specific language governing rights and limitations under the</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineminus">- * License.</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineminus">- *</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineminus">- * The Original Code is mozilla.org code.</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineminus">- *</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineminus">- * The Initial Developer of the Original Code is</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineminus">- * Sun Microsystems, Inc.</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineminus">- * Portions created by the Initial Developer are Copyright (C) 2001</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineminus">- * the Initial Developer. All Rights Reserved.</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineminus">- *</span>
<a href="#l12.26"></a><span id="l12.26" class="difflineminus">- * Contributor(s):</span>
<a href="#l12.27"></a><span id="l12.27" class="difflineminus">- *   Paul Sandoz &lt;paul.sandoz@sun.com&gt;</span>
<a href="#l12.28"></a><span id="l12.28" class="difflineminus">- *</span>
<a href="#l12.29"></a><span id="l12.29" class="difflineminus">- * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineminus">- * either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineminus">- * or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineminus">- * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineminus">- * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineminus">- * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineminus">- * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l12.36"></a><span id="l12.36" class="difflineminus">- * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineminus">- * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineminus">- * the provisions above, a recipient may use your version of this file under</span>
<a href="#l12.39"></a><span id="l12.39" class="difflineminus">- * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l12.40"></a><span id="l12.40" class="difflineminus">- *</span>
<a href="#l12.41"></a><span id="l12.41" class="difflineminus">- * ***** END LICENSE BLOCK ***** */</span>
<a href="#l12.42"></a><span id="l12.42" class="difflineminus">-</span>
<a href="#l12.43"></a><span id="l12.43" class="difflineminus">-#ifndef nsAbDirectoryRDFResource_h__</span>
<a href="#l12.44"></a><span id="l12.44" class="difflineminus">-#define nsAbDirectoryRDFResource_h__</span>
<a href="#l12.45"></a><span id="l12.45" class="difflineminus">-</span>
<a href="#l12.46"></a><span id="l12.46" class="difflineminus">-#include &quot;nsRDFResource.h&quot;</span>
<a href="#l12.47"></a><span id="l12.47" class="difflineminus">-#include &quot;nsStringGlue.h&quot;</span>
<a href="#l12.48"></a><span id="l12.48" class="difflineminus">-</span>
<a href="#l12.49"></a><span id="l12.49" class="difflineminus">-class nsAbDirectoryRDFResource : public nsRDFResource</span>
<a href="#l12.50"></a><span id="l12.50" class="difflineminus">-{</span>
<a href="#l12.51"></a><span id="l12.51" class="difflineminus">-public:</span>
<a href="#l12.52"></a><span id="l12.52" class="difflineminus">-    NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l12.53"></a><span id="l12.53" class="difflineminus">-</span>
<a href="#l12.54"></a><span id="l12.54" class="difflineminus">-    nsAbDirectoryRDFResource ();</span>
<a href="#l12.55"></a><span id="l12.55" class="difflineminus">-    virtual ~nsAbDirectoryRDFResource ();</span>
<a href="#l12.56"></a><span id="l12.56" class="difflineminus">-</span>
<a href="#l12.57"></a><span id="l12.57" class="difflineminus">-    // nsIRDFResource methods:</span>
<a href="#l12.58"></a><span id="l12.58" class="difflineminus">-    NS_IMETHOD Init(const char* aURI);</span>
<a href="#l12.59"></a><span id="l12.59" class="difflineminus">-    </span>
<a href="#l12.60"></a><span id="l12.60" class="difflineminus">-protected:</span>
<a href="#l12.61"></a><span id="l12.61" class="difflineminus">-    PRBool mIsValidURI;</span>
<a href="#l12.62"></a><span id="l12.62" class="difflineminus">-    PRBool mIsQueryURI;</span>
<a href="#l12.63"></a><span id="l12.63" class="difflineminus">-    nsCString mQueryString;</span>
<a href="#l12.64"></a><span id="l12.64" class="difflineminus">-    nsCString mURINoQuery;</span>
<a href="#l12.65"></a><span id="l12.65" class="difflineminus">-};</span>
<a href="#l12.66"></a><span id="l12.66" class="difflineminus">-</span>
<a href="#l12.67"></a><span id="l12.67" class="difflineminus">-#endif</span>
<a href="#l12.68"></a><span id="l12.68" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPDirFactory.cpp</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPDirFactory.cpp</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -106,9 +106,8 @@ nsAbLDAPDirFactory::GetDirectories(const</span>
<a href="#l13.4"></a><span id="l13.4"> NS_IMETHODIMP</span>
<a href="#l13.5"></a><span id="l13.5"> nsAbLDAPDirFactory::DeleteDirectory(nsIAbDirectory *directory)</span>
<a href="#l13.6"></a><span id="l13.6"> {</span>
<a href="#l13.7"></a><span id="l13.7">   // No actual deletion - as the LDAP Address Book is not physically</span>
<a href="#l13.8"></a><span id="l13.8">   // created in the corresponding CreateDirectory() unlike the Personal</span>
<a href="#l13.9"></a><span id="l13.9">   // Address Books. But we still need to return NS_OK from here.</span>
<a href="#l13.10"></a><span id="l13.10">   return NS_OK;</span>
<a href="#l13.11"></a><span id="l13.11"> }</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPDirectory.cpp</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPDirectory.cpp</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -71,31 +71,31 @@</span>
<a href="#l14.4"></a><span id="l14.4"> #include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l14.5"></a><span id="l14.5"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l14.6"></a><span id="l14.6"> </span>
<a href="#l14.7"></a><span id="l14.7"> #define kDefaultMaxHits 100</span>
<a href="#l14.8"></a><span id="l14.8"> </span>
<a href="#l14.9"></a><span id="l14.9"> using namespace mozilla;</span>
<a href="#l14.10"></a><span id="l14.10"> </span>
<a href="#l14.11"></a><span id="l14.11"> nsAbLDAPDirectory::nsAbLDAPDirectory() :</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-  nsAbDirectoryRDFResource(),</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+  nsAbDirProperty(),</span>
<a href="#l14.14"></a><span id="l14.14">   mPerformingQuery(PR_FALSE),</span>
<a href="#l14.15"></a><span id="l14.15">   mContext(0),</span>
<a href="#l14.16"></a><span id="l14.16">   mLock(&quot;nsAbLDAPDirectory.mLock&quot;)</span>
<a href="#l14.17"></a><span id="l14.17"> {</span>
<a href="#l14.18"></a><span id="l14.18">   mCache.Init();</span>
<a href="#l14.19"></a><span id="l14.19"> }</span>
<a href="#l14.20"></a><span id="l14.20"> </span>
<a href="#l14.21"></a><span id="l14.21"> nsAbLDAPDirectory::~nsAbLDAPDirectory()</span>
<a href="#l14.22"></a><span id="l14.22"> {</span>
<a href="#l14.23"></a><span id="l14.23"> }</span>
<a href="#l14.24"></a><span id="l14.24"> </span>
<a href="#l14.25"></a><span id="l14.25" class="difflineminus">-NS_IMPL_ISUPPORTS_INHERITED4(nsAbLDAPDirectory, nsAbDirectoryRDFResource,</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineminus">-                             nsIAbDirectory, nsISupportsWeakReference,</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineminus">-                             nsIAbDirSearchListener, nsIAbLDAPDirectory)</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineplus">+NS_IMPL_ISUPPORTS_INHERITED3(nsAbLDAPDirectory, nsAbDirProperty,</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineplus">+                             nsISupportsWeakReference, nsIAbDirSearchListener,</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineplus">+                             nsIAbLDAPDirectory)</span>
<a href="#l14.31"></a><span id="l14.31"> </span>
<a href="#l14.32"></a><span id="l14.32"> NS_IMETHODIMP nsAbLDAPDirectory::GetPropertiesChromeURI(nsACString &amp;aResult)</span>
<a href="#l14.33"></a><span id="l14.33"> {</span>
<a href="#l14.34"></a><span id="l14.34">   aResult.AssignLiteral(&quot;chrome://messenger/content/addressbook/pref-directory-add.xul&quot;);</span>
<a href="#l14.35"></a><span id="l14.35">   return NS_OK;</span>
<a href="#l14.36"></a><span id="l14.36"> }</span>
<a href="#l14.37"></a><span id="l14.37"> </span>
<a href="#l14.38"></a><span id="l14.38"> NS_IMETHODIMP nsAbLDAPDirectory::Init(const char* aURI)</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineat">@@ -108,17 +108,17 @@ NS_IMETHODIMP nsAbLDAPDirectory::Init(co</span>
<a href="#l14.40"></a><span id="l14.40">   // that's the URI we should have been passed.</span>
<a href="#l14.41"></a><span id="l14.41">   PRInt32 searchCharLocation = uri.FindChar('?', kLDAPDirectoryRootLen);</span>
<a href="#l14.42"></a><span id="l14.42"> </span>
<a href="#l14.43"></a><span id="l14.43">   if (searchCharLocation == -1)</span>
<a href="#l14.44"></a><span id="l14.44">     m_DirPrefId = Substring(uri, kLDAPDirectoryRootLen);</span>
<a href="#l14.45"></a><span id="l14.45">   else</span>
<a href="#l14.46"></a><span id="l14.46">     m_DirPrefId = Substring(uri, kLDAPDirectoryRootLen, searchCharLocation - kLDAPDirectoryRootLen);</span>
<a href="#l14.47"></a><span id="l14.47"> </span>
<a href="#l14.48"></a><span id="l14.48" class="difflineminus">-  return nsAbDirectoryRDFResource::Init(aURI);</span>
<a href="#l14.49"></a><span id="l14.49" class="difflineplus">+  return nsAbDirProperty::Init(aURI);</span>
<a href="#l14.50"></a><span id="l14.50"> }</span>
<a href="#l14.51"></a><span id="l14.51"> </span>
<a href="#l14.52"></a><span id="l14.52"> nsresult nsAbLDAPDirectory::Initiate()</span>
<a href="#l14.53"></a><span id="l14.53"> {</span>
<a href="#l14.54"></a><span id="l14.54">   return NS_OK;</span>
<a href="#l14.55"></a><span id="l14.55"> }</span>
<a href="#l14.56"></a><span id="l14.56"> </span>
<a href="#l14.57"></a><span id="l14.57"> /* </span>
<a href="#l14.58"></a><span id="l14.58" class="difflineat">@@ -223,17 +223,17 @@ NS_IMETHODIMP nsAbLDAPDirectory::GetLDAP</span>
<a href="#l14.59"></a><span id="l14.59">   // we can handle the case where the URI isn't specified (see comments</span>
<a href="#l14.60"></a><span id="l14.60">   // below)</span>
<a href="#l14.61"></a><span id="l14.61">   nsCAutoString URI;</span>
<a href="#l14.62"></a><span id="l14.62">   nsresult rv = GetStringValue(&quot;uri&quot;, EmptyCString(), URI);</span>
<a href="#l14.63"></a><span id="l14.63">   if (NS_FAILED(rv) || URI.IsEmpty())</span>
<a href="#l14.64"></a><span id="l14.64">   {</span>
<a href="#l14.65"></a><span id="l14.65">     /*</span>
<a href="#l14.66"></a><span id="l14.66">      * A recent change in Mozilla now means that the LDAP Address Book</span>
<a href="#l14.67"></a><span id="l14.67" class="difflineminus">-     * RDF Resource URI is based on the unique preference name value i.e.  </span>
<a href="#l14.68"></a><span id="l14.68" class="difflineplus">+     * URI is based on the unique preference name value i.e.</span>
<a href="#l14.69"></a><span id="l14.69">      * [moz-abldapdirectory://prefName]</span>
<a href="#l14.70"></a><span id="l14.70">      * Prior to this valid change it was based on the actual uri i.e. </span>
<a href="#l14.71"></a><span id="l14.71">      * [moz-abldapdirectory://host:port/basedn]</span>
<a href="#l14.72"></a><span id="l14.72">      * Basing the resource on the prefName allows these attributes to </span>
<a href="#l14.73"></a><span id="l14.73">      * change. </span>
<a href="#l14.74"></a><span id="l14.74">      *</span>
<a href="#l14.75"></a><span id="l14.75">      * But the uri value was also the means by which third-party</span>
<a href="#l14.76"></a><span id="l14.76">      * products could integrate with Mozilla's LDAP Address Books</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPDirectory.h</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPDirectory.h</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -35,29 +35,27 @@</span>
<a href="#l15.4"></a><span id="l15.4">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l15.5"></a><span id="l15.5">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l15.6"></a><span id="l15.6">  *</span>
<a href="#l15.7"></a><span id="l15.7">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l15.8"></a><span id="l15.8"> </span>
<a href="#l15.9"></a><span id="l15.9"> #ifndef nsAbLDAPDirectory_h__</span>
<a href="#l15.10"></a><span id="l15.10"> #define nsAbLDAPDirectory_h__</span>
<a href="#l15.11"></a><span id="l15.11"> </span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-#include &quot;nsAbDirectoryRDFResource.h&quot;</span>
<a href="#l15.13"></a><span id="l15.13"> #include &quot;nsAbDirProperty.h&quot;</span>
<a href="#l15.14"></a><span id="l15.14"> #include &quot;nsAbLDAPDirectoryModify.h&quot;</span>
<a href="#l15.15"></a><span id="l15.15"> #include &quot;nsIAbDirectoryQuery.h&quot;</span>
<a href="#l15.16"></a><span id="l15.16"> #include &quot;nsIAbDirectorySearch.h&quot;</span>
<a href="#l15.17"></a><span id="l15.17"> #include &quot;nsIAbDirSearchListener.h&quot;</span>
<a href="#l15.18"></a><span id="l15.18"> #include &quot;nsIAbLDAPDirectory.h&quot;</span>
<a href="#l15.19"></a><span id="l15.19"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l15.20"></a><span id="l15.20"> #include &quot;nsInterfaceHashtable.h&quot;</span>
<a href="#l15.21"></a><span id="l15.21"> #include &quot;mozilla/Mutex.h&quot;</span>
<a href="#l15.22"></a><span id="l15.22"> </span>
<a href="#l15.23"></a><span id="l15.23"> class nsAbLDAPDirectory :</span>
<a href="#l15.24"></a><span id="l15.24" class="difflineminus">-  public nsAbDirectoryRDFResource,    // nsIRDFResource</span>
<a href="#l15.25"></a><span id="l15.25">   public nsAbDirProperty,             // nsIAbDirectory</span>
<a href="#l15.26"></a><span id="l15.26">   public nsAbLDAPDirectoryModify,</span>
<a href="#l15.27"></a><span id="l15.27">   public nsIAbDirectorySearch,</span>
<a href="#l15.28"></a><span id="l15.28">   public nsIAbLDAPDirectory,</span>
<a href="#l15.29"></a><span id="l15.29">   public nsIAbDirSearchListener</span>
<a href="#l15.30"></a><span id="l15.30"> {</span>
<a href="#l15.31"></a><span id="l15.31"> public:</span>
<a href="#l15.32"></a><span id="l15.32">   NS_DECL_ISUPPORTS_INHERITED</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbMDBDirFactory.cpp</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbMDBDirFactory.cpp</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -36,20 +36,17 @@</span>
<a href="#l16.4"></a><span id="l16.4">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l16.5"></a><span id="l16.5">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l16.6"></a><span id="l16.6">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l16.7"></a><span id="l16.7">  *</span>
<a href="#l16.8"></a><span id="l16.8">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l16.9"></a><span id="l16.9"> </span>
<a href="#l16.10"></a><span id="l16.10"> #include &quot;nsAbMDBDirFactory.h&quot;</span>
<a href="#l16.11"></a><span id="l16.11"> #include &quot;nsAbUtils.h&quot;</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineminus">-#include &quot;nsIRDFService.h&quot;</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineminus">-#include &quot;nsIRDFResource.h&quot;</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineminus">-#include &quot;nsRDFResource.h&quot;</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineplus">+#include &quot;nsString.h&quot;</span>
<a href="#l16.17"></a><span id="l16.17"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l16.18"></a><span id="l16.18"> #include &quot;nsILocalFile.h&quot;</span>
<a href="#l16.19"></a><span id="l16.19"> #include &quot;nsIAbManager.h&quot;</span>
<a href="#l16.20"></a><span id="l16.20"> #include &quot;nsIAbMDBDirectory.h&quot;</span>
<a href="#l16.21"></a><span id="l16.21"> #include &quot;nsAbMDBDirFactory.h&quot;</span>
<a href="#l16.22"></a><span id="l16.22"> #include &quot;nsIAddrDBListener.h&quot;</span>
<a href="#l16.23"></a><span id="l16.23"> #include &quot;nsIAddrDatabase.h&quot;</span>
<a href="#l16.24"></a><span id="l16.24"> #include &quot;nsEnumeratorUtils.h&quot;</span>
<a href="#l16.25"></a><span id="l16.25" class="difflineat">@@ -71,32 +68,26 @@ NS_IMETHODIMP nsAbMDBDirFactory::GetDire</span>
<a href="#l16.26"></a><span id="l16.26">                                                 const nsACString &amp;aURI,</span>
<a href="#l16.27"></a><span id="l16.27">                                                 const nsACString &amp;aPrefName,</span>
<a href="#l16.28"></a><span id="l16.28">                                                 nsISimpleEnumerator **_retval)</span>
<a href="#l16.29"></a><span id="l16.29"> {</span>
<a href="#l16.30"></a><span id="l16.30">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l16.31"></a><span id="l16.31">   </span>
<a href="#l16.32"></a><span id="l16.32">   nsresult rv;</span>
<a href="#l16.33"></a><span id="l16.33"> </span>
<a href="#l16.34"></a><span id="l16.34" class="difflineminus">-  nsCOMPtr&lt;nsIRDFService&gt; rdf = do_GetService (NS_RDF_CONTRACTID &quot;/rdf-service;1&quot;, &amp;rv);</span>
<a href="#l16.35"></a><span id="l16.35" class="difflineplus">+  nsCOMPtr&lt;nsIAbManager&gt; abManager = do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l16.36"></a><span id="l16.36">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.37"></a><span id="l16.37"> </span>
<a href="#l16.38"></a><span id="l16.38" class="difflineminus">-  nsCOMPtr&lt;nsIRDFResource&gt; resource;</span>
<a href="#l16.39"></a><span id="l16.39" class="difflineminus">-  rv = rdf-&gt;GetResource(aURI, getter_AddRefs(resource));</span>
<a href="#l16.40"></a><span id="l16.40" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.41"></a><span id="l16.41" class="difflineminus">-</span>
<a href="#l16.42"></a><span id="l16.42" class="difflineminus">-  nsCOMPtr&lt;nsIAbDirectory&gt; directory(do_QueryInterface(resource, &amp;rv));</span>
<a href="#l16.43"></a><span id="l16.43" class="difflineplus">+  nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l16.44"></a><span id="l16.44" class="difflineplus">+  rv = abManager-&gt;GetDirectory(aURI, getter_AddRefs(directory));</span>
<a href="#l16.45"></a><span id="l16.45">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.46"></a><span id="l16.46"> </span>
<a href="#l16.47"></a><span id="l16.47">   rv = directory-&gt;SetDirPrefId(aPrefName);</span>
<a href="#l16.48"></a><span id="l16.48">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.49"></a><span id="l16.49"> </span>
<a href="#l16.50"></a><span id="l16.50" class="difflineminus">-  nsCOMPtr&lt;nsIAbManager&gt; abManager = do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l16.51"></a><span id="l16.51" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.52"></a><span id="l16.52" class="difflineminus">-</span>
<a href="#l16.53"></a><span id="l16.53">   nsCOMPtr&lt;nsILocalFile&gt; dbPath;</span>
<a href="#l16.54"></a><span id="l16.54">   rv = abManager-&gt;GetUserProfileDirectory(getter_AddRefs(dbPath));</span>
<a href="#l16.55"></a><span id="l16.55"> </span>
<a href="#l16.56"></a><span id="l16.56">   nsCOMPtr&lt;nsIAddrDatabase&gt; listDatabase;</span>
<a href="#l16.57"></a><span id="l16.57">   if (NS_SUCCEEDED(rv))</span>
<a href="#l16.58"></a><span id="l16.58">   {</span>
<a href="#l16.59"></a><span id="l16.59">     nsCAutoString fileName;</span>
<a href="#l16.60"></a><span id="l16.60">       </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbMDBDirProperty.cpp</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbMDBDirProperty.cpp</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -33,31 +33,29 @@</span>
<a href="#l17.4"></a><span id="l17.4">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l17.5"></a><span id="l17.5">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l17.6"></a><span id="l17.6">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l17.7"></a><span id="l17.7">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l17.8"></a><span id="l17.8">  *</span>
<a href="#l17.9"></a><span id="l17.9">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l17.10"></a><span id="l17.10"> </span>
<a href="#l17.11"></a><span id="l17.11"> #include &quot;nsAbMDBDirProperty.h&quot;	 </span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-#include &quot;nsIRDFService.h&quot;</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineminus">-#include &quot;nsIRDFResource.h&quot;</span>
<a href="#l17.14"></a><span id="l17.14"> #include &quot;nsIServiceManager.h&quot;</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineminus">-#include &quot;nsRDFCID.h&quot;</span>
<a href="#l17.16"></a><span id="l17.16"> #include &quot;nsStringGlue.h&quot;</span>
<a href="#l17.17"></a><span id="l17.17"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l17.18"></a><span id="l17.18"> #include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l17.19"></a><span id="l17.19"> #include &quot;nsAddrDatabase.h&quot;</span>
<a href="#l17.20"></a><span id="l17.20"> #include &quot;nsIAbCard.h&quot;</span>
<a href="#l17.21"></a><span id="l17.21"> #include &quot;nsIAbListener.h&quot;</span>
<a href="#l17.22"></a><span id="l17.22"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l17.23"></a><span id="l17.23"> #include &quot;mdb.h&quot;</span>
<a href="#l17.24"></a><span id="l17.24"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l17.25"></a><span id="l17.25"> </span>
<a href="#l17.26"></a><span id="l17.26"> nsAbMDBDirProperty::nsAbMDBDirProperty(void)</span>
<a href="#l17.27"></a><span id="l17.27" class="difflineplus">+  : nsAbDirProperty()</span>
<a href="#l17.28"></a><span id="l17.28"> {</span>
<a href="#l17.29"></a><span id="l17.29">   m_dbRowID = 0;</span>
<a href="#l17.30"></a><span id="l17.30"> }</span>
<a href="#l17.31"></a><span id="l17.31"> </span>
<a href="#l17.32"></a><span id="l17.32"> nsAbMDBDirProperty::~nsAbMDBDirProperty(void)</span>
<a href="#l17.33"></a><span id="l17.33"> { </span>
<a href="#l17.34"></a><span id="l17.34"> }</span>
<a href="#l17.35"></a><span id="l17.35"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbMDBDirectory.cpp</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbMDBDirectory.cpp</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -33,18 +33,16 @@</span>
<a href="#l18.4"></a><span id="l18.4">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l18.5"></a><span id="l18.5">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l18.6"></a><span id="l18.6">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l18.7"></a><span id="l18.7">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l18.8"></a><span id="l18.8">  *</span>
<a href="#l18.9"></a><span id="l18.9">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l18.10"></a><span id="l18.10"> </span>
<a href="#l18.11"></a><span id="l18.11"> #include &quot;nsAbMDBDirectory.h&quot; </span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-#include &quot;nsIRDFService.h&quot;</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineminus">-#include &quot;nsRDFCID.h&quot;</span>
<a href="#l18.14"></a><span id="l18.14"> #include &quot;nsStringGlue.h&quot;</span>
<a href="#l18.15"></a><span id="l18.15"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l18.16"></a><span id="l18.16"> #include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l18.17"></a><span id="l18.17"> #include &quot;nsAddrDatabase.h&quot;</span>
<a href="#l18.18"></a><span id="l18.18"> #include &quot;nsIAbListener.h&quot;</span>
<a href="#l18.19"></a><span id="l18.19"> #include &quot;nsIAbManager.h&quot;</span>
<a href="#l18.20"></a><span id="l18.20"> #include &quot;nsIURL.h&quot;</span>
<a href="#l18.21"></a><span id="l18.21"> #include &quot;nsNetCID.h&quot;</span>
<a href="#l18.22"></a><span id="l18.22" class="difflineat">@@ -61,33 +59,31 @@</span>
<a href="#l18.23"></a><span id="l18.23"> #include &quot;nsDirectoryServiceUtils.h&quot;</span>
<a href="#l18.24"></a><span id="l18.24"> #include &quot;nsILocalFile.h&quot;</span>
<a href="#l18.25"></a><span id="l18.25"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l18.26"></a><span id="l18.26"> #include &quot;nsMemory.h&quot;</span>
<a href="#l18.27"></a><span id="l18.27"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l18.28"></a><span id="l18.28"> #include &quot;nsUnicharUtils.h&quot;</span>
<a href="#l18.29"></a><span id="l18.29"> </span>
<a href="#l18.30"></a><span id="l18.30"> nsAbMDBDirectory::nsAbMDBDirectory(void):</span>
<a href="#l18.31"></a><span id="l18.31" class="difflineminus">-     nsAbDirectoryRDFResource(),</span>
<a href="#l18.32"></a><span id="l18.32" class="difflineplus">+     nsAbMDBDirProperty(),</span>
<a href="#l18.33"></a><span id="l18.33">      mPerformingQuery(PR_FALSE)</span>
<a href="#l18.34"></a><span id="l18.34"> {</span>
<a href="#l18.35"></a><span id="l18.35">   mSearchCache.Init();</span>
<a href="#l18.36"></a><span id="l18.36"> }</span>
<a href="#l18.37"></a><span id="l18.37"> </span>
<a href="#l18.38"></a><span id="l18.38"> nsAbMDBDirectory::~nsAbMDBDirectory(void)</span>
<a href="#l18.39"></a><span id="l18.39"> {</span>
<a href="#l18.40"></a><span id="l18.40">   if (mDatabase) {</span>
<a href="#l18.41"></a><span id="l18.41">     mDatabase-&gt;RemoveListener(this);</span>
<a href="#l18.42"></a><span id="l18.42">   }</span>
<a href="#l18.43"></a><span id="l18.43"> }</span>
<a href="#l18.44"></a><span id="l18.44"> </span>
<a href="#l18.45"></a><span id="l18.45" class="difflineminus">-NS_IMPL_ISUPPORTS_INHERITED6(nsAbMDBDirectory, nsAbDirectoryRDFResource,</span>
<a href="#l18.46"></a><span id="l18.46" class="difflineminus">-                             nsIAbDirectory, nsISupportsWeakReference,</span>
<a href="#l18.47"></a><span id="l18.47" class="difflineplus">+NS_IMPL_ISUPPORTS_INHERITED3(nsAbMDBDirectory, nsAbMDBDirProperty,</span>
<a href="#l18.48"></a><span id="l18.48">                              nsIAbDirSearchListener,</span>
<a href="#l18.49"></a><span id="l18.49" class="difflineminus">-                             nsIAbMDBDirectory,</span>
<a href="#l18.50"></a><span id="l18.50">                              nsIAbDirectorySearch,</span>
<a href="#l18.51"></a><span id="l18.51">                              nsIAddrDBListener)</span>
<a href="#l18.52"></a><span id="l18.52"> </span>
<a href="#l18.53"></a><span id="l18.53"> NS_IMETHODIMP nsAbMDBDirectory::Init(const char *aUri)</span>
<a href="#l18.54"></a><span id="l18.54"> {</span>
<a href="#l18.55"></a><span id="l18.55">   // We need to ensure  that the m_DirPrefId is initialized properly</span>
<a href="#l18.56"></a><span id="l18.56">   nsDependentCString uri(aUri);</span>
<a href="#l18.57"></a><span id="l18.57"> </span>
<a href="#l18.58"></a><span id="l18.58" class="difflineat">@@ -152,17 +148,17 @@ NS_IMETHODIMP nsAbMDBDirectory::Init(con</span>
<a href="#l18.59"></a><span id="l18.59">       }</span>
<a href="#l18.60"></a><span id="l18.60">     }     </span>
<a href="#l18.61"></a><span id="l18.61">     NS_FREE_XPCOM_ALLOCATED_POINTER_ARRAY(childCount, childArray);</span>
<a href="#l18.62"></a><span id="l18.62"> </span>
<a href="#l18.63"></a><span id="l18.63">     NS_ASSERTION(!m_DirPrefId.IsEmpty(),</span>
<a href="#l18.64"></a><span id="l18.64">                  &quot;Error, Could not set m_DirPrefId in nsAbMDBDirectory::Init&quot;);</span>
<a href="#l18.65"></a><span id="l18.65">   }</span>
<a href="#l18.66"></a><span id="l18.66"> </span>
<a href="#l18.67"></a><span id="l18.67" class="difflineminus">-  return nsAbDirectoryRDFResource::Init(aUri);</span>
<a href="#l18.68"></a><span id="l18.68" class="difflineplus">+  return nsAbDirProperty::Init(aUri);</span>
<a href="#l18.69"></a><span id="l18.69"> }</span>
<a href="#l18.70"></a><span id="l18.70"> </span>
<a href="#l18.71"></a><span id="l18.71"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l18.72"></a><span id="l18.72"> </span>
<a href="#l18.73"></a><span id="l18.73"> nsresult nsAbMDBDirectory::RemoveCardFromAddressList(nsIAbCard* card)</span>
<a href="#l18.74"></a><span id="l18.74"> {</span>
<a href="#l18.75"></a><span id="l18.75">   nsresult rv = NS_OK;</span>
<a href="#l18.76"></a><span id="l18.76">   PRUint32 listTotal;</span>
<a href="#l18.77"></a><span id="l18.77" class="difflineat">@@ -340,24 +336,21 @@ NS_IMETHODIMP nsAbMDBDirectory::AddDirec</span>
<a href="#l18.78"></a><span id="l18.78"> </span>
<a href="#l18.79"></a><span id="l18.79">   if (!childDir || !uriName)</span>
<a href="#l18.80"></a><span id="l18.80">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l18.81"></a><span id="l18.81"> </span>
<a href="#l18.82"></a><span id="l18.82">   if (mURI.IsEmpty())</span>
<a href="#l18.83"></a><span id="l18.83">     return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l18.84"></a><span id="l18.84"> </span>
<a href="#l18.85"></a><span id="l18.85">   nsresult rv = NS_OK;</span>
<a href="#l18.86"></a><span id="l18.86" class="difflineminus">-  nsCOMPtr&lt;nsIRDFService&gt; rdf(do_GetService(&quot;@mozilla.org/rdf/rdf-service;1&quot;, &amp;rv));</span>
<a href="#l18.87"></a><span id="l18.87" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.88"></a><span id="l18.88" class="difflineminus">-  </span>
<a href="#l18.89"></a><span id="l18.89" class="difflineminus">-  nsCOMPtr&lt;nsIRDFResource&gt; res;</span>
<a href="#l18.90"></a><span id="l18.90" class="difflineminus">-  rv = rdf-&gt;GetResource(nsDependentCString(uriName), getter_AddRefs(res));</span>
<a href="#l18.91"></a><span id="l18.91" class="difflineplus">+  nsCOMPtr&lt;nsIAbManager&gt; abManager = do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l18.92"></a><span id="l18.92">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.93"></a><span id="l18.93"> </span>
<a href="#l18.94"></a><span id="l18.94" class="difflineminus">-  nsCOMPtr&lt;nsIAbDirectory&gt; directory(do_QueryInterface(res, &amp;rv));</span>
<a href="#l18.95"></a><span id="l18.95" class="difflineplus">+  nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l18.96"></a><span id="l18.96" class="difflineplus">+  rv = abManager-&gt;GetDirectory(nsDependentCString(uriName), getter_AddRefs(directory));</span>
<a href="#l18.97"></a><span id="l18.97">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.98"></a><span id="l18.98"> </span>
<a href="#l18.99"></a><span id="l18.99">   if (mSubDirectories.IndexOf(directory) == -1)</span>
<a href="#l18.100"></a><span id="l18.100">     mSubDirectories.AppendObject(directory);</span>
<a href="#l18.101"></a><span id="l18.101">   NS_IF_ADDREF(*childDir = directory);</span>
<a href="#l18.102"></a><span id="l18.102">   return rv;</span>
<a href="#l18.103"></a><span id="l18.103"> }</span>
<a href="#l18.104"></a><span id="l18.104"> </span>
<a href="#l18.105"></a><span id="l18.105" class="difflineat">@@ -478,21 +471,22 @@ NS_IMETHODIMP nsAbMDBDirectory::DeleteCa</span>
<a href="#l18.106"></a><span id="l18.106">     // after delete, remove this query as a listener.</span>
<a href="#l18.107"></a><span id="l18.107">     nsCOMPtr&lt;nsIAddrDatabase&gt; database;</span>
<a href="#l18.108"></a><span id="l18.108">     rv = GetDatabase(getter_AddRefs(database));</span>
<a href="#l18.109"></a><span id="l18.109">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l18.110"></a><span id="l18.110"> </span>
<a href="#l18.111"></a><span id="l18.111">     rv = database-&gt;AddListener(this);</span>
<a href="#l18.112"></a><span id="l18.112">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.113"></a><span id="l18.113"> </span>
<a href="#l18.114"></a><span id="l18.114" class="difflineminus">-    nsCOMPtr&lt;nsIRDFResource&gt; resource;</span>
<a href="#l18.115"></a><span id="l18.115" class="difflineminus">-    rv = gRDFService-&gt;GetResource(mURINoQuery, getter_AddRefs(resource));</span>
<a href="#l18.116"></a><span id="l18.116" class="difflineplus">+    nsCOMPtr&lt;nsIAbManager&gt; abManager =</span>
<a href="#l18.117"></a><span id="l18.117" class="difflineplus">+        do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l18.118"></a><span id="l18.118">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.119"></a><span id="l18.119" class="difflineminus">-    </span>
<a href="#l18.120"></a><span id="l18.120" class="difflineminus">-    nsCOMPtr&lt;nsIAbDirectory&gt; directory = do_QueryInterface(resource, &amp;rv);</span>
<a href="#l18.121"></a><span id="l18.121" class="difflineplus">+</span>
<a href="#l18.122"></a><span id="l18.122" class="difflineplus">+    nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l18.123"></a><span id="l18.123" class="difflineplus">+    rv = abManager-&gt;GetDirectory(mURINoQuery, getter_AddRefs(directory));</span>
<a href="#l18.124"></a><span id="l18.124">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.125"></a><span id="l18.125"> </span>
<a href="#l18.126"></a><span id="l18.126">     rv = directory-&gt;DeleteCards(aCards);</span>
<a href="#l18.127"></a><span id="l18.127">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.128"></a><span id="l18.128"> </span>
<a href="#l18.129"></a><span id="l18.129">     rv = database-&gt;RemoveListener(this);</span>
<a href="#l18.130"></a><span id="l18.130">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.131"></a><span id="l18.131">     return rv;</span>
<a href="#l18.132"></a><span id="l18.132" class="difflineat">@@ -541,35 +535,31 @@ NS_IMETHODIMP nsAbMDBDirectory::DeleteCa</span>
<a href="#l18.133"></a><span id="l18.133">         }</span>
<a href="#l18.134"></a><span id="l18.134">         else</span>
<a href="#l18.135"></a><span id="l18.135">         {</span>
<a href="#l18.136"></a><span id="l18.136">           mDatabase-&gt;DeleteCard(card, PR_TRUE, this);</span>
<a href="#l18.137"></a><span id="l18.137">           PRBool bIsMailList = PR_FALSE;</span>
<a href="#l18.138"></a><span id="l18.138">           card-&gt;GetIsMailList(&amp;bIsMailList);</span>
<a href="#l18.139"></a><span id="l18.139">           if (bIsMailList)</span>
<a href="#l18.140"></a><span id="l18.140">           {</span>
<a href="#l18.141"></a><span id="l18.141" class="difflineminus">-            //to do, get mailing list dir side uri and notify rdf to remove it</span>
<a href="#l18.142"></a><span id="l18.142" class="difflineplus">+            //to do, get mailing list dir side uri and notify nsIAbManager to remove it</span>
<a href="#l18.143"></a><span id="l18.143">             nsCAutoString listUri(mURI);</span>
<a href="#l18.144"></a><span id="l18.144">             listUri.AppendLiteral(&quot;/MailList&quot;);</span>
<a href="#l18.145"></a><span id="l18.145">             listUri.AppendInt(rowID);</span>
<a href="#l18.146"></a><span id="l18.146">             if (!listUri.IsEmpty())</span>
<a href="#l18.147"></a><span id="l18.147">             {</span>
<a href="#l18.148"></a><span id="l18.148">               nsresult rv = NS_OK;</span>
<a href="#l18.149"></a><span id="l18.149" class="difflineminus">-              nsCOMPtr&lt;nsIRDFService&gt; rdfService = </span>
<a href="#l18.150"></a><span id="l18.150" class="difflineminus">-                       do_GetService(&quot;@mozilla.org/rdf/rdf-service;1&quot;, &amp;rv);</span>
<a href="#l18.151"></a><span id="l18.151" class="difflineminus">-</span>
<a href="#l18.152"></a><span id="l18.152" class="difflineminus">-              if (NS_FAILED(rv))</span>
<a href="#l18.153"></a><span id="l18.153" class="difflineminus">-                return rv;</span>
<a href="#l18.154"></a><span id="l18.154"> </span>
<a href="#l18.155"></a><span id="l18.155" class="difflineminus">-              nsCOMPtr&lt;nsIRDFResource&gt; listResource;</span>
<a href="#l18.156"></a><span id="l18.156" class="difflineminus">-              rv = rdfService-&gt;GetResource(listUri,</span>
<a href="#l18.157"></a><span id="l18.157" class="difflineminus">-                                           getter_AddRefs(listResource));</span>
<a href="#l18.158"></a><span id="l18.158" class="difflineminus">-              nsCOMPtr&lt;nsIAbDirectory&gt; listDir = do_QueryInterface(listResource, &amp;rv);</span>
<a href="#l18.159"></a><span id="l18.159" class="difflineminus">-              if (NS_FAILED(rv))</span>
<a href="#l18.160"></a><span id="l18.160" class="difflineminus">-                return rv;</span>
<a href="#l18.161"></a><span id="l18.161" class="difflineplus">+              nsCOMPtr&lt;nsIAbManager&gt; abManager =</span>
<a href="#l18.162"></a><span id="l18.162" class="difflineplus">+                  do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l18.163"></a><span id="l18.163" class="difflineplus">+              NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.164"></a><span id="l18.164" class="difflineplus">+</span>
<a href="#l18.165"></a><span id="l18.165" class="difflineplus">+              nsCOMPtr&lt;nsIAbDirectory&gt; listDir;</span>
<a href="#l18.166"></a><span id="l18.166" class="difflineplus">+              rv = abManager-&gt;GetDirectory(listUri, getter_AddRefs(listDir));</span>
<a href="#l18.167"></a><span id="l18.167" class="difflineplus">+              NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.168"></a><span id="l18.168"> </span>
<a href="#l18.169"></a><span id="l18.169">               PRUint32 dirIndex;</span>
<a href="#l18.170"></a><span id="l18.170">               if (m_AddressList &amp;&amp; NS_SUCCEEDED(m_AddressList-&gt;IndexOf(0, listDir, &amp;dirIndex)))</span>
<a href="#l18.171"></a><span id="l18.171">                 m_AddressList-&gt;RemoveElementAt(dirIndex);</span>
<a href="#l18.172"></a><span id="l18.172"> </span>
<a href="#l18.173"></a><span id="l18.173">               mSubDirectories.RemoveObject(listDir);</span>
<a href="#l18.174"></a><span id="l18.174"> </span>
<a href="#l18.175"></a><span id="l18.175">               if (listDir)</span>
<a href="#l18.176"></a><span id="l18.176" class="difflineat">@@ -940,22 +930,23 @@ NS_IMETHODIMP nsAbMDBDirectory::StartSea</span>
<a href="#l18.177"></a><span id="l18.177">   // don't search the subdirectories </span>
<a href="#l18.178"></a><span id="l18.178">   // if the current directory is a mailing list, it won't have any subdirectories</span>
<a href="#l18.179"></a><span id="l18.179">   // if the current directory is a addressbook, searching both it</span>
<a href="#l18.180"></a><span id="l18.180">   // and the subdirectories (the mailing lists), will yield duplicate results</span>
<a href="#l18.181"></a><span id="l18.181">   // because every entry in a mailing list will be an entry in the parent addressbook</span>
<a href="#l18.182"></a><span id="l18.182">   rv = arguments-&gt;SetQuerySubDirectories(PR_FALSE);</span>
<a href="#l18.183"></a><span id="l18.183">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.184"></a><span id="l18.184"> </span>
<a href="#l18.185"></a><span id="l18.185" class="difflineminus">-  // Get the directory without the query</span>
<a href="#l18.186"></a><span id="l18.186" class="difflineminus">-  nsCOMPtr&lt;nsIRDFResource&gt; resource;</span>
<a href="#l18.187"></a><span id="l18.187" class="difflineminus">-  rv = gRDFService-&gt;GetResource(mURINoQuery, getter_AddRefs(resource));</span>
<a href="#l18.188"></a><span id="l18.188" class="difflineplus">+  nsCOMPtr&lt;nsIAbManager&gt; abManager =</span>
<a href="#l18.189"></a><span id="l18.189" class="difflineplus">+      do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l18.190"></a><span id="l18.190">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.191"></a><span id="l18.191"> </span>
<a href="#l18.192"></a><span id="l18.192" class="difflineminus">-  nsCOMPtr&lt;nsIAbDirectory&gt; directory(do_QueryInterface(resource, &amp;rv));</span>
<a href="#l18.193"></a><span id="l18.193" class="difflineplus">+  // Get the directory without the query</span>
<a href="#l18.194"></a><span id="l18.194" class="difflineplus">+  nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l18.195"></a><span id="l18.195" class="difflineplus">+  rv = abManager-&gt;GetDirectory(mURINoQuery, getter_AddRefs(directory));</span>
<a href="#l18.196"></a><span id="l18.196">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.197"></a><span id="l18.197"> </span>
<a href="#l18.198"></a><span id="l18.198">   // Bug 280232 - something was causing continuous loops in searching. Add a</span>
<a href="#l18.199"></a><span id="l18.199">   // check here for the directory to search not being a query uri as well in</span>
<a href="#l18.200"></a><span id="l18.200">   // the hopes that will at least break us out of the continuous loop even if</span>
<a href="#l18.201"></a><span id="l18.201">   // we don't know how we got into it.</span>
<a href="#l18.202"></a><span id="l18.202">   PRBool isQuery;</span>
<a href="#l18.203"></a><span id="l18.203">   rv = directory-&gt;GetIsQuery(&amp;isQuery);</span>
<a href="#l18.204"></a><span id="l18.204" class="difflineat">@@ -1017,35 +1008,35 @@ nsresult nsAbMDBDirectory::GetAbDatabase</span>
<a href="#l18.205"></a><span id="l18.205">   if (mDatabase)</span>
<a href="#l18.206"></a><span id="l18.206">     return NS_OK;</span>
<a href="#l18.207"></a><span id="l18.207"> </span>
<a href="#l18.208"></a><span id="l18.208">   nsresult rv;</span>
<a href="#l18.209"></a><span id="l18.209"> </span>
<a href="#l18.210"></a><span id="l18.210">   if (m_IsMailList)</span>
<a href="#l18.211"></a><span id="l18.211">   {</span>
<a href="#l18.212"></a><span id="l18.212">     // Get the database of the parent directory.</span>
<a href="#l18.213"></a><span id="l18.213" class="difflineminus">-    nsCString parentURI(mURINoQuery);</span>
<a href="#l18.214"></a><span id="l18.214" class="difflineplus">+    nsCAutoString parentURI(mURINoQuery);</span>
<a href="#l18.215"></a><span id="l18.215"> </span>
<a href="#l18.216"></a><span id="l18.216">     PRInt32 pos = parentURI.RFindChar('/');</span>
<a href="#l18.217"></a><span id="l18.217"> </span>
<a href="#l18.218"></a><span id="l18.218">     // If we didn't find a / something really bad has happened</span>
<a href="#l18.219"></a><span id="l18.219">     if (pos == -1)</span>
<a href="#l18.220"></a><span id="l18.220">       return NS_ERROR_FAILURE;</span>
<a href="#l18.221"></a><span id="l18.221"> </span>
<a href="#l18.222"></a><span id="l18.222">     parentURI = StringHead(parentURI, pos);</span>
<a href="#l18.223"></a><span id="l18.223"> </span>
<a href="#l18.224"></a><span id="l18.224" class="difflineminus">-    nsCOMPtr&lt;nsIRDFService&gt; rdfService =</span>
<a href="#l18.225"></a><span id="l18.225" class="difflineminus">-      do_GetService(&quot;@mozilla.org/rdf/rdf-service;1&quot;, &amp;rv);</span>
<a href="#l18.226"></a><span id="l18.226" class="difflineplus">+    nsCOMPtr&lt;nsIAbManager&gt; abManager =</span>
<a href="#l18.227"></a><span id="l18.227" class="difflineplus">+        do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l18.228"></a><span id="l18.228">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.229"></a><span id="l18.229"> </span>
<a href="#l18.230"></a><span id="l18.230" class="difflineminus">-    nsCOMPtr&lt;nsIRDFResource&gt; resource;</span>
<a href="#l18.231"></a><span id="l18.231" class="difflineminus">-    rv = rdfService-&gt;GetResource(parentURI, getter_AddRefs(resource));</span>
<a href="#l18.232"></a><span id="l18.232" class="difflineplus">+    nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l18.233"></a><span id="l18.233" class="difflineplus">+    rv = abManager-&gt;GetDirectory(parentURI, getter_AddRefs(directory));</span>
<a href="#l18.234"></a><span id="l18.234">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.235"></a><span id="l18.235"> </span>
<a href="#l18.236"></a><span id="l18.236" class="difflineminus">-    nsCOMPtr&lt;nsIAbMDBDirectory&gt; mdbDir(do_QueryInterface(resource, &amp;rv));</span>
<a href="#l18.237"></a><span id="l18.237" class="difflineplus">+    nsCOMPtr&lt;nsIAbMDBDirectory&gt; mdbDir(do_QueryInterface(directory, &amp;rv));</span>
<a href="#l18.238"></a><span id="l18.238">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.239"></a><span id="l18.239"> </span>
<a href="#l18.240"></a><span id="l18.240">     rv = mdbDir-&gt;GetDatabase(getter_AddRefs(mDatabase));</span>
<a href="#l18.241"></a><span id="l18.241">   }</span>
<a href="#l18.242"></a><span id="l18.242">   else</span>
<a href="#l18.243"></a><span id="l18.243">     rv = GetDatabase(getter_AddRefs(mDatabase));</span>
<a href="#l18.244"></a><span id="l18.244"> </span>
<a href="#l18.245"></a><span id="l18.245">   if (NS_SUCCEEDED(rv))</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbMDBDirectory.h</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbMDBDirectory.h</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -47,38 +47,36 @@</span>
<a href="#l19.4"></a><span id="l19.4"> #include &quot;nsAbMDBDirProperty.h&quot;  </span>
<a href="#l19.5"></a><span id="l19.5"> #include &quot;nsIAbCard.h&quot;</span>
<a href="#l19.6"></a><span id="l19.6"> #include &quot;nsCOMArray.h&quot;</span>
<a href="#l19.7"></a><span id="l19.7"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l19.8"></a><span id="l19.8"> #include &quot;nsDirPrefs.h&quot;</span>
<a href="#l19.9"></a><span id="l19.9"> #include &quot;nsIAbDirectorySearch.h&quot;</span>
<a href="#l19.10"></a><span id="l19.10"> #include &quot;nsIAbDirSearchListener.h&quot;</span>
<a href="#l19.11"></a><span id="l19.11"> #include &quot;nsInterfaceHashtable.h&quot;</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-#include &quot;nsAbDirectoryRDFResource.h&quot;</span>
<a href="#l19.13"></a><span id="l19.13"> #include &quot;nsIAddrDBListener.h&quot;</span>
<a href="#l19.14"></a><span id="l19.14"> </span>
<a href="#l19.15"></a><span id="l19.15"> /* </span>
<a href="#l19.16"></a><span id="l19.16">  * Address Book Directory</span>
<a href="#l19.17"></a><span id="l19.17">  */ </span>
<a href="#l19.18"></a><span id="l19.18"> </span>
<a href="#l19.19"></a><span id="l19.19"> class nsAbMDBDirectory:</span>
<a href="#l19.20"></a><span id="l19.20" class="difflineminus">-  public nsAbDirectoryRDFResource, </span>
<a href="#l19.21"></a><span id="l19.21">   public nsAbMDBDirProperty,	// nsIAbDirectory, nsIAbMDBDirectory</span>
<a href="#l19.22"></a><span id="l19.22">   public nsIAbDirSearchListener,</span>
<a href="#l19.23"></a><span id="l19.23">   public nsIAddrDBListener, </span>
<a href="#l19.24"></a><span id="l19.24">   public nsIAbDirectorySearch</span>
<a href="#l19.25"></a><span id="l19.25"> {</span>
<a href="#l19.26"></a><span id="l19.26"> public: </span>
<a href="#l19.27"></a><span id="l19.27">   nsAbMDBDirectory(void);</span>
<a href="#l19.28"></a><span id="l19.28">   virtual ~nsAbMDBDirectory(void);</span>
<a href="#l19.29"></a><span id="l19.29"> </span>
<a href="#l19.30"></a><span id="l19.30">   NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l19.31"></a><span id="l19.31">   NS_DECL_NSIADDRDBLISTENER</span>
<a href="#l19.32"></a><span id="l19.32"> </span>
<a href="#l19.33"></a><span id="l19.33" class="difflineminus">-  // Override nsAbDirectoryRDFResource::Init</span>
<a href="#l19.34"></a><span id="l19.34" class="difflineplus">+  // Override nsAbMDBDirProperty::Init</span>
<a href="#l19.35"></a><span id="l19.35">   NS_IMETHOD Init(const char *aUri);</span>
<a href="#l19.36"></a><span id="l19.36"> </span>
<a href="#l19.37"></a><span id="l19.37">   // nsIAbMDBDirectory methods</span>
<a href="#l19.38"></a><span id="l19.38">   NS_IMETHOD GetURI(nsACString &amp;aURI);</span>
<a href="#l19.39"></a><span id="l19.39">   NS_IMETHOD ClearDatabase();</span>
<a href="#l19.40"></a><span id="l19.40">   NS_IMETHOD NotifyDirItemAdded(nsISupports *item) { return NotifyItemAdded(item);}</span>
<a href="#l19.41"></a><span id="l19.41">   NS_IMETHOD RemoveElementsFromAddressList();</span>
<a href="#l19.42"></a><span id="l19.42">   NS_IMETHOD RemoveEmailAddressAt(PRUint32 aIndex);</span>
<a href="#l19.43"></a><span id="l19.43" class="difflineat">@@ -124,12 +122,13 @@ protected:</span>
<a href="#l19.44"></a><span id="l19.44"> </span>
<a href="#l19.45"></a><span id="l19.45">   nsresult GetAbDatabase();</span>
<a href="#l19.46"></a><span id="l19.46">   nsCOMPtr&lt;nsIAddrDatabase&gt; mDatabase;  </span>
<a href="#l19.47"></a><span id="l19.47"> </span>
<a href="#l19.48"></a><span id="l19.48">   nsCOMArray&lt;nsIAbDirectory&gt; mSubDirectories;</span>
<a href="#l19.49"></a><span id="l19.49"> </span>
<a href="#l19.50"></a><span id="l19.50">   PRInt32 mContext;</span>
<a href="#l19.51"></a><span id="l19.51">   PRBool mPerformingQuery;</span>
<a href="#l19.52"></a><span id="l19.52" class="difflineplus">+</span>
<a href="#l19.53"></a><span id="l19.53">   nsInterfaceHashtable&lt;nsISupportsHashKey, nsIAbCard&gt; mSearchCache;</span>
<a href="#l19.54"></a><span id="l19.54"> };</span>
<a href="#l19.55"></a><span id="l19.55"> </span>
<a href="#l19.56"></a><span id="l19.56"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbManager.cpp</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbManager.cpp</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -45,19 +45,16 @@</span>
<a href="#l20.4"></a><span id="l20.4"> #include &quot;nsIOutputStream.h&quot;</span>
<a href="#l20.5"></a><span id="l20.5"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l20.6"></a><span id="l20.6"> #include &quot;nsMsgI18N.h&quot;</span>
<a href="#l20.7"></a><span id="l20.7"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l20.8"></a><span id="l20.8"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l20.9"></a><span id="l20.9"> #include &quot;nsAppDirectoryServiceDefs.h&quot;</span>
<a href="#l20.10"></a><span id="l20.10"> #include &quot;plstr.h&quot;</span>
<a href="#l20.11"></a><span id="l20.11"> #include &quot;prmem.h&quot;</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-#include &quot;nsIRDFResource.h&quot;</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineminus">-#include &quot;rdf.h&quot;</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineminus">-#include &quot;nsIRDFService.h&quot;</span>
<a href="#l20.15"></a><span id="l20.15"> #include &quot;nsIServiceManager.h&quot;</span>
<a href="#l20.16"></a><span id="l20.16"> #include &quot;nsIDOMWindow.h&quot;</span>
<a href="#l20.17"></a><span id="l20.17"> #include &quot;nsIFilePicker.h&quot;</span>
<a href="#l20.18"></a><span id="l20.18"> #include &quot;plbase64.h&quot;</span>
<a href="#l20.19"></a><span id="l20.19"> #include &quot;nsIWindowWatcher.h&quot;</span>
<a href="#l20.20"></a><span id="l20.20"> #include &quot;nsDirectoryServiceUtils.h&quot;</span>
<a href="#l20.21"></a><span id="l20.21"> #include &quot;nsVCard.h&quot;</span>
<a href="#l20.22"></a><span id="l20.22"> #include &quot;nsVCardObj.h&quot;</span>
<a href="#l20.23"></a><span id="l20.23" class="difflineat">@@ -65,16 +62,19 @@</span>
<a href="#l20.24"></a><span id="l20.24"> #include &quot;nsICommandLine.h&quot;</span>
<a href="#l20.25"></a><span id="l20.25"> #include &quot;nsILocalFile.h&quot;</span>
<a href="#l20.26"></a><span id="l20.26"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l20.27"></a><span id="l20.27"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l20.28"></a><span id="l20.28"> #include &quot;nsDirectoryServiceUtils.h&quot;</span>
<a href="#l20.29"></a><span id="l20.29"> #include &quot;nsIObserverService.h&quot;</span>
<a href="#l20.30"></a><span id="l20.30"> #include &quot;nsDirPrefs.h&quot;</span>
<a href="#l20.31"></a><span id="l20.31"> #include &quot;nsThreadUtils.h&quot;</span>
<a href="#l20.32"></a><span id="l20.32" class="difflineplus">+#include &quot;nsIAbDirFactory.h&quot;</span>
<a href="#l20.33"></a><span id="l20.33" class="difflineplus">+#include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l20.34"></a><span id="l20.34" class="difflineplus">+#include &quot;nsIIOService.h&quot;</span>
<a href="#l20.35"></a><span id="l20.35"> </span>
<a href="#l20.36"></a><span id="l20.36"> struct ExportAttributesTableStruct</span>
<a href="#l20.37"></a><span id="l20.37"> {</span>
<a href="#l20.38"></a><span id="l20.38">   const char* abPropertyName;</span>
<a href="#l20.39"></a><span id="l20.39">   PRUint32 plainTextStringID;</span>
<a href="#l20.40"></a><span id="l20.40"> };</span>
<a href="#l20.41"></a><span id="l20.41"> </span>
<a href="#l20.42"></a><span id="l20.42"> // our schema is not fixed yet, but we still want some sort of objectclass</span>
<a href="#l20.43"></a><span id="l20.43" class="difflineat">@@ -148,16 +148,17 @@ const ExportAttributesTableStruct EXPORT</span>
<a href="#l20.44"></a><span id="l20.44">   {kFamilyNameProperty},</span>
<a href="#l20.45"></a><span id="l20.45"> };</span>
<a href="#l20.46"></a><span id="l20.46"> </span>
<a href="#l20.47"></a><span id="l20.47"> //</span>
<a href="#l20.48"></a><span id="l20.48"> // nsAbManager</span>
<a href="#l20.49"></a><span id="l20.49"> //</span>
<a href="#l20.50"></a><span id="l20.50"> nsAbManager::nsAbManager()</span>
<a href="#l20.51"></a><span id="l20.51"> {</span>
<a href="#l20.52"></a><span id="l20.52" class="difflineplus">+  mAbStore.Init();</span>
<a href="#l20.53"></a><span id="l20.53"> }</span>
<a href="#l20.54"></a><span id="l20.54"> </span>
<a href="#l20.55"></a><span id="l20.55"> nsAbManager::~nsAbManager()</span>
<a href="#l20.56"></a><span id="l20.56"> {</span>
<a href="#l20.57"></a><span id="l20.57"> }</span>
<a href="#l20.58"></a><span id="l20.58"> </span>
<a href="#l20.59"></a><span id="l20.59"> NS_IMPL_THREADSAFE_ADDREF(nsAbManager)</span>
<a href="#l20.60"></a><span id="l20.60"> NS_IMPL_THREADSAFE_RELEASE(nsAbManager)</span>
<a href="#l20.61"></a><span id="l20.61" class="difflineat">@@ -226,118 +227,157 @@ NS_IMETHODIMP nsAbManager::Observe(nsISu</span>
<a href="#l20.62"></a><span id="l20.62"> NS_IMETHODIMP nsAbManager::GetDirectories(nsISimpleEnumerator **aResult)</span>
<a href="#l20.63"></a><span id="l20.63"> {</span>
<a href="#l20.64"></a><span id="l20.64">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l20.65"></a><span id="l20.65"> </span>
<a href="#l20.66"></a><span id="l20.66">   // We cache the top level AB to ensure that nsIAbDirectory items are not</span>
<a href="#l20.67"></a><span id="l20.67">   // created and dumped every time GetDirectories is called. This was causing</span>
<a href="#l20.68"></a><span id="l20.68">   // performance problems, especially with the content policy on messages</span>
<a href="#l20.69"></a><span id="l20.69">   // with lots of urls.</span>
<a href="#l20.70"></a><span id="l20.70" class="difflineplus">+  nsresult rv;</span>
<a href="#l20.71"></a><span id="l20.71" class="difflineplus">+  nsCOMPtr&lt;nsIAbDirectory&gt; rootAddressBook;</span>
<a href="#l20.72"></a><span id="l20.72" class="difflineplus">+  rv = GetRootDirectory(getter_AddRefs(rootAddressBook));</span>
<a href="#l20.73"></a><span id="l20.73" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.74"></a><span id="l20.74" class="difflineplus">+</span>
<a href="#l20.75"></a><span id="l20.75" class="difflineplus">+  return rootAddressBook-&gt;GetChildNodes(aResult);</span>
<a href="#l20.76"></a><span id="l20.76" class="difflineplus">+}</span>
<a href="#l20.77"></a><span id="l20.77" class="difflineplus">+</span>
<a href="#l20.78"></a><span id="l20.78" class="difflineplus">+nsresult</span>
<a href="#l20.79"></a><span id="l20.79" class="difflineplus">+nsAbManager::GetRootDirectory(nsIAbDirectory **aResult)</span>
<a href="#l20.80"></a><span id="l20.80" class="difflineplus">+{</span>
<a href="#l20.81"></a><span id="l20.81" class="difflineplus">+  // We cache the top level AB to ensure that nsIAbDirectory items are not</span>
<a href="#l20.82"></a><span id="l20.82" class="difflineplus">+  // created and dumped every time GetDirectories is called. This was causing</span>
<a href="#l20.83"></a><span id="l20.83" class="difflineplus">+  // performance problems, especially with the content policy on messages</span>
<a href="#l20.84"></a><span id="l20.84" class="difflineplus">+  // with lots of urls.</span>
<a href="#l20.85"></a><span id="l20.85" class="difflineplus">+  nsresult rv;</span>
<a href="#l20.86"></a><span id="l20.86" class="difflineplus">+</span>
<a href="#l20.87"></a><span id="l20.87">   if (!mCacheTopLevelAb)</span>
<a href="#l20.88"></a><span id="l20.88">   {</span>
<a href="#l20.89"></a><span id="l20.89" class="difflineminus">-    nsresult rv;</span>
<a href="#l20.90"></a><span id="l20.90" class="difflineminus">-    nsCOMPtr&lt;nsIRDFService&gt; rdfService(do_GetService(NS_RDF_CONTRACTID &quot;/rdf-service;1&quot;, &amp;rv));</span>
<a href="#l20.91"></a><span id="l20.91" class="difflineplus">+    nsCOMPtr&lt;nsIAbDirectory&gt; rootAddressBook(do_GetService(NS_ABDIRECTORY_CONTRACTID, &amp;rv));</span>
<a href="#l20.92"></a><span id="l20.92">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.93"></a><span id="l20.93" class="difflineminus">-</span>
<a href="#l20.94"></a><span id="l20.94" class="difflineminus">-    nsCOMPtr&lt;nsIRDFResource&gt; parentResource;</span>
<a href="#l20.95"></a><span id="l20.95" class="difflineminus">-    rv = rdfService-&gt;GetResource(NS_LITERAL_CSTRING(kAllDirectoryRoot),</span>
<a href="#l20.96"></a><span id="l20.96" class="difflineminus">-                                 getter_AddRefs(parentResource));</span>
<a href="#l20.97"></a><span id="l20.97" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.98"></a><span id="l20.98" class="difflineminus">-</span>
<a href="#l20.99"></a><span id="l20.99" class="difflineminus">-    mCacheTopLevelAb = do_QueryInterface(parentResource, &amp;rv);</span>
<a href="#l20.100"></a><span id="l20.100" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.101"></a><span id="l20.101" class="difflineplus">+    mCacheTopLevelAb = rootAddressBook;</span>
<a href="#l20.102"></a><span id="l20.102">   }</span>
<a href="#l20.103"></a><span id="l20.103"> </span>
<a href="#l20.104"></a><span id="l20.104" class="difflineminus">-  return mCacheTopLevelAb-&gt;GetChildNodes(aResult);</span>
<a href="#l20.105"></a><span id="l20.105" class="difflineplus">+  NS_IF_ADDREF(*aResult = mCacheTopLevelAb);</span>
<a href="#l20.106"></a><span id="l20.106" class="difflineplus">+  return NS_OK;</span>
<a href="#l20.107"></a><span id="l20.107"> }</span>
<a href="#l20.108"></a><span id="l20.108"> </span>
<a href="#l20.109"></a><span id="l20.109"> NS_IMETHODIMP nsAbManager::GetDirectory(const nsACString &amp;aURI,</span>
<a href="#l20.110"></a><span id="l20.110">                                         nsIAbDirectory **aResult)</span>
<a href="#l20.111"></a><span id="l20.111"> {</span>
<a href="#l20.112"></a><span id="l20.112">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l20.113"></a><span id="l20.113"> </span>
<a href="#l20.114"></a><span id="l20.114">   nsresult rv;</span>
<a href="#l20.115"></a><span id="l20.115" class="difflineminus">-  nsCOMPtr&lt;nsIRDFService&gt; rdfService(do_GetService(NS_RDF_CONTRACTID &quot;/rdf-service;1&quot;, &amp;rv));</span>
<a href="#l20.116"></a><span id="l20.116" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.117"></a><span id="l20.117" class="difflineplus">+  nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l20.118"></a><span id="l20.118" class="difflineplus">+</span>
<a href="#l20.119"></a><span id="l20.119" class="difflineplus">+  // Was the directory root requested?</span>
<a href="#l20.120"></a><span id="l20.120" class="difflineplus">+  if (aURI.Equals(NS_LITERAL_CSTRING(kAllDirectoryRoot)))</span>
<a href="#l20.121"></a><span id="l20.121" class="difflineplus">+  {</span>
<a href="#l20.122"></a><span id="l20.122" class="difflineplus">+    rv = GetRootDirectory(getter_AddRefs(directory));</span>
<a href="#l20.123"></a><span id="l20.123" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.124"></a><span id="l20.124" class="difflineplus">+    NS_IF_ADDREF(*aResult = directory);</span>
<a href="#l20.125"></a><span id="l20.125" class="difflineplus">+    return NS_OK;</span>
<a href="#l20.126"></a><span id="l20.126" class="difflineplus">+  }</span>
<a href="#l20.127"></a><span id="l20.127" class="difflineplus">+</span>
<a href="#l20.128"></a><span id="l20.128" class="difflineplus">+  // Do we have a copy of this directory already within our look-up table?</span>
<a href="#l20.129"></a><span id="l20.129" class="difflineplus">+  if (!mAbStore.Get(aURI, getter_AddRefs(directory)))</span>
<a href="#l20.130"></a><span id="l20.130" class="difflineplus">+  {</span>
<a href="#l20.131"></a><span id="l20.131" class="difflineplus">+    // The directory wasn't in our look-up table, so we need to instantiate</span>
<a href="#l20.132"></a><span id="l20.132" class="difflineplus">+    // it. First, extract the scheme from the URI...</span>
<a href="#l20.133"></a><span id="l20.133" class="difflineplus">+</span>
<a href="#l20.134"></a><span id="l20.134" class="difflineplus">+    nsCAutoString scheme;</span>
<a href="#l20.135"></a><span id="l20.135" class="difflineplus">+</span>
<a href="#l20.136"></a><span id="l20.136" class="difflineplus">+    PRInt32 colon = aURI.FindChar(':');</span>
<a href="#l20.137"></a><span id="l20.137" class="difflineplus">+    if (colon &lt;= 0)</span>
<a href="#l20.138"></a><span id="l20.138" class="difflineplus">+      return NS_ERROR_MALFORMED_URI;</span>
<a href="#l20.139"></a><span id="l20.139" class="difflineplus">+    scheme = Substring(aURI, 0, colon);</span>
<a href="#l20.140"></a><span id="l20.140"> </span>
<a href="#l20.141"></a><span id="l20.141" class="difflineminus">-  nsCOMPtr&lt;nsIRDFResource&gt; dirResource;</span>
<a href="#l20.142"></a><span id="l20.142" class="difflineminus">-  rv = rdfService-&gt;GetResource(aURI, getter_AddRefs(dirResource));</span>
<a href="#l20.143"></a><span id="l20.143" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.144"></a><span id="l20.144" class="difflineplus">+    // Construct the appropriate nsIAbDirectory...</span>
<a href="#l20.145"></a><span id="l20.145" class="difflineplus">+    nsCAutoString contractID;</span>
<a href="#l20.146"></a><span id="l20.146" class="difflineplus">+    contractID.AssignLiteral(NS_AB_DIRECTORY_TYPE_CONTRACTID_PREFIX);</span>
<a href="#l20.147"></a><span id="l20.147" class="difflineplus">+    contractID.Append(scheme);</span>
<a href="#l20.148"></a><span id="l20.148" class="difflineplus">+    directory = do_CreateInstance(contractID.get(), &amp;rv);</span>
<a href="#l20.149"></a><span id="l20.149" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.150"></a><span id="l20.150" class="difflineplus">+</span>
<a href="#l20.151"></a><span id="l20.151" class="difflineplus">+    // Init it with the URI</span>
<a href="#l20.152"></a><span id="l20.152" class="difflineplus">+    const nsAFlatCString&amp; flatURI = PromiseFlatCString(aURI);</span>
<a href="#l20.153"></a><span id="l20.153" class="difflineplus">+</span>
<a href="#l20.154"></a><span id="l20.154" class="difflineplus">+    rv = directory-&gt;Init(flatURI.get());</span>
<a href="#l20.155"></a><span id="l20.155" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.156"></a><span id="l20.156"> </span>
<a href="#l20.157"></a><span id="l20.157" class="difflineminus">-  return CallQueryInterface(dirResource, aResult);</span>
<a href="#l20.158"></a><span id="l20.158" class="difflineplus">+    // Check if this directory was initiated with a search query.  If so,</span>
<a href="#l20.159"></a><span id="l20.159" class="difflineplus">+    // we don't cache it.</span>
<a href="#l20.160"></a><span id="l20.160" class="difflineplus">+    PRBool isQuery = PR_FALSE;</span>
<a href="#l20.161"></a><span id="l20.161" class="difflineplus">+    rv = directory-&gt;GetIsQuery(&amp;isQuery);</span>
<a href="#l20.162"></a><span id="l20.162" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.163"></a><span id="l20.163" class="difflineplus">+</span>
<a href="#l20.164"></a><span id="l20.164" class="difflineplus">+    if (!isQuery)</span>
<a href="#l20.165"></a><span id="l20.165" class="difflineplus">+      mAbStore.Put(aURI, directory);</span>
<a href="#l20.166"></a><span id="l20.166" class="difflineplus">+  }</span>
<a href="#l20.167"></a><span id="l20.167" class="difflineplus">+  NS_IF_ADDREF(*aResult = directory);</span>
<a href="#l20.168"></a><span id="l20.168" class="difflineplus">+</span>
<a href="#l20.169"></a><span id="l20.169" class="difflineplus">+  return NS_OK;</span>
<a href="#l20.170"></a><span id="l20.170"> }</span>
<a href="#l20.171"></a><span id="l20.171"> </span>
<a href="#l20.172"></a><span id="l20.172"> NS_IMETHODIMP nsAbManager::NewAddressBook(const nsAString &amp;aDirName,</span>
<a href="#l20.173"></a><span id="l20.173">                                             const nsACString &amp;aURI,</span>
<a href="#l20.174"></a><span id="l20.174">                                             const PRUint32 aType,</span>
<a href="#l20.175"></a><span id="l20.175">                                             const nsACString &amp;aPrefName,</span>
<a href="#l20.176"></a><span id="l20.176">                                             nsACString &amp;aResult)</span>
<a href="#l20.177"></a><span id="l20.177"> {</span>
<a href="#l20.178"></a><span id="l20.178">   nsresult rv;</span>
<a href="#l20.179"></a><span id="l20.179"> </span>
<a href="#l20.180"></a><span id="l20.180" class="difflineminus">-  nsCOMPtr&lt;nsIRDFService&gt; rdfService = do_GetService (NS_RDF_CONTRACTID &quot;/rdf-service;1&quot;, &amp;rv);</span>
<a href="#l20.181"></a><span id="l20.181" class="difflineplus">+  nsCOMPtr&lt;nsIAbDirectory&gt; parentDir;</span>
<a href="#l20.182"></a><span id="l20.182" class="difflineplus">+  rv = GetRootDirectory(getter_AddRefs(parentDir));</span>
<a href="#l20.183"></a><span id="l20.183">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.184"></a><span id="l20.184" class="difflineminus">-</span>
<a href="#l20.185"></a><span id="l20.185" class="difflineminus">-  nsCOMPtr&lt;nsIRDFResource&gt; parentResource;</span>
<a href="#l20.186"></a><span id="l20.186" class="difflineminus">-  rv = rdfService-&gt;GetResource(NS_LITERAL_CSTRING(kAllDirectoryRoot),</span>
<a href="#l20.187"></a><span id="l20.187" class="difflineminus">-                               getter_AddRefs(parentResource));</span>
<a href="#l20.188"></a><span id="l20.188" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.189"></a><span id="l20.189" class="difflineminus">-</span>
<a href="#l20.190"></a><span id="l20.190" class="difflineminus">-  nsCOMPtr&lt;nsIAbDirectory&gt; parentDir = do_QueryInterface(parentResource, &amp;rv);</span>
<a href="#l20.191"></a><span id="l20.191" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.192"></a><span id="l20.192" class="difflineminus">-</span>
<a href="#l20.193"></a><span id="l20.193">   return parentDir-&gt;CreateNewDirectory(aDirName, aURI, aType, aPrefName, aResult);</span>
<a href="#l20.194"></a><span id="l20.194"> }</span>
<a href="#l20.195"></a><span id="l20.195"> </span>
<a href="#l20.196"></a><span id="l20.196"> NS_IMETHODIMP nsAbManager::DeleteAddressBook(const nsACString &amp;aURI)</span>
<a href="#l20.197"></a><span id="l20.197"> {</span>
<a href="#l20.198"></a><span id="l20.198">   // Find the address book</span>
<a href="#l20.199"></a><span id="l20.199">   nsresult rv;</span>
<a href="#l20.200"></a><span id="l20.200"> </span>
<a href="#l20.201"></a><span id="l20.201" class="difflineminus">-  nsCOMPtr&lt;nsIRDFService&gt; rdfService =</span>
<a href="#l20.202"></a><span id="l20.202" class="difflineminus">-    do_GetService(NS_RDF_CONTRACTID &quot;/rdf-service;1&quot;, &amp;rv);</span>
<a href="#l20.203"></a><span id="l20.203" class="difflineplus">+  nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l20.204"></a><span id="l20.204" class="difflineplus">+  rv = GetDirectory(aURI, getter_AddRefs(directory));</span>
<a href="#l20.205"></a><span id="l20.205">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.206"></a><span id="l20.206"> </span>
<a href="#l20.207"></a><span id="l20.207" class="difflineminus">-  nsCOMPtr&lt;nsIRDFResource&gt; directoryResource;</span>
<a href="#l20.208"></a><span id="l20.208" class="difflineminus">-  rv = rdfService-&gt;GetResource(aURI, getter_AddRefs(directoryResource));</span>
<a href="#l20.209"></a><span id="l20.209" class="difflineplus">+  nsCOMPtr&lt;nsIAbDirectory&gt; rootDirectory;</span>
<a href="#l20.210"></a><span id="l20.210" class="difflineplus">+  rv = GetRootDirectory(getter_AddRefs(rootDirectory));</span>
<a href="#l20.211"></a><span id="l20.211">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.212"></a><span id="l20.212"> </span>
<a href="#l20.213"></a><span id="l20.213" class="difflineminus">-  nsCOMPtr&lt;nsIAbDirectory&gt; directory = do_QueryInterface(directoryResource, &amp;rv);</span>
<a href="#l20.214"></a><span id="l20.214" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.215"></a><span id="l20.215" class="difflineminus">-</span>
<a href="#l20.216"></a><span id="l20.216" class="difflineminus">-  // Now find the parent directory</span>
<a href="#l20.217"></a><span id="l20.217" class="difflineminus">-  PRBool isMailList;</span>
<a href="#l20.218"></a><span id="l20.218" class="difflineminus">-  rv = directory-&gt;GetIsMailList(&amp;isMailList);</span>
<a href="#l20.219"></a><span id="l20.219" class="difflineplus">+  // Go through each of the children of the address book</span>
<a href="#l20.220"></a><span id="l20.220" class="difflineplus">+  // (so, the mailing lists) and remove their entries from</span>
<a href="#l20.221"></a><span id="l20.221" class="difflineplus">+  // the look up table.</span>
<a href="#l20.222"></a><span id="l20.222" class="difflineplus">+  nsCOMPtr&lt;nsISimpleEnumerator&gt; enumerator;</span>
<a href="#l20.223"></a><span id="l20.223" class="difflineplus">+  rv = directory-&gt;GetChildNodes(getter_AddRefs(enumerator));</span>
<a href="#l20.224"></a><span id="l20.224">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.225"></a><span id="l20.225"> </span>
<a href="#l20.226"></a><span id="l20.226" class="difflineminus">-  nsCString uriToUse;</span>
<a href="#l20.227"></a><span id="l20.227" class="difflineminus">-  if (!isMailList)</span>
<a href="#l20.228"></a><span id="l20.228" class="difflineminus">-    // We only accept one layer of address books at the moment.</span>
<a href="#l20.229"></a><span id="l20.229" class="difflineminus">-    uriToUse.AppendLiteral(kAllDirectoryRoot);</span>
<a href="#l20.230"></a><span id="l20.230" class="difflineminus">-  else</span>
<a href="#l20.231"></a><span id="l20.231" class="difflineplus">+  nsCOMPtr&lt;nsISupports&gt; item;</span>
<a href="#l20.232"></a><span id="l20.232" class="difflineplus">+  nsCOMPtr&lt;nsIAbDirectory&gt; childDirectory;</span>
<a href="#l20.233"></a><span id="l20.233" class="difflineplus">+  PRBool hasMore = PR_FALSE;</span>
<a href="#l20.234"></a><span id="l20.234" class="difflineplus">+  while (NS_SUCCEEDED(enumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore)</span>
<a href="#l20.235"></a><span id="l20.235">   {</span>
<a href="#l20.236"></a><span id="l20.236" class="difflineminus">-    uriToUse.Append(aURI);</span>
<a href="#l20.237"></a><span id="l20.237" class="difflineplus">+    rv = enumerator-&gt;GetNext(getter_AddRefs(item));</span>
<a href="#l20.238"></a><span id="l20.238" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.239"></a><span id="l20.239"> </span>
<a href="#l20.240"></a><span id="l20.240" class="difflineminus">-    PRInt32 pos = uriToUse.RFindChar('/');</span>
<a href="#l20.241"></a><span id="l20.241" class="difflineplus">+    childDirectory = do_QueryInterface(item, &amp;rv);</span>
<a href="#l20.242"></a><span id="l20.242" class="difflineplus">+    if (NS_SUCCEEDED(rv))</span>
<a href="#l20.243"></a><span id="l20.243" class="difflineplus">+    {</span>
<a href="#l20.244"></a><span id="l20.244" class="difflineplus">+      nsCString childURI;</span>
<a href="#l20.245"></a><span id="l20.245" class="difflineplus">+      rv = childDirectory-&gt;GetURI(childURI);</span>
<a href="#l20.246"></a><span id="l20.246" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.247"></a><span id="l20.247"> </span>
<a href="#l20.248"></a><span id="l20.248" class="difflineminus">-    // If we didn't find a / something really bad has happened</span>
<a href="#l20.249"></a><span id="l20.249" class="difflineminus">-    if (pos == -1)</span>
<a href="#l20.250"></a><span id="l20.250" class="difflineminus">-      return NS_ERROR_FAILURE;</span>
<a href="#l20.251"></a><span id="l20.251" class="difflineminus">-</span>
<a href="#l20.252"></a><span id="l20.252" class="difflineminus">-    uriToUse = StringHead(uriToUse, pos);</span>
<a href="#l20.253"></a><span id="l20.253" class="difflineplus">+      mAbStore.Remove(childURI);</span>
<a href="#l20.254"></a><span id="l20.254" class="difflineplus">+    }</span>
<a href="#l20.255"></a><span id="l20.255">   }</span>
<a href="#l20.256"></a><span id="l20.256"> </span>
<a href="#l20.257"></a><span id="l20.257" class="difflineminus">-  nsCOMPtr&lt;nsIRDFResource&gt; parentResource;</span>
<a href="#l20.258"></a><span id="l20.258" class="difflineminus">-  rv = rdfService-&gt;GetResource(uriToUse, getter_AddRefs(parentResource));</span>
<a href="#l20.259"></a><span id="l20.259" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.260"></a><span id="l20.260" class="difflineplus">+  mAbStore.Remove(aURI);</span>
<a href="#l20.261"></a><span id="l20.261"> </span>
<a href="#l20.262"></a><span id="l20.262" class="difflineminus">-  nsCOMPtr&lt;nsIAbDirectory&gt; parentDir(do_QueryInterface(parentResource, &amp;rv));</span>
<a href="#l20.263"></a><span id="l20.263" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.264"></a><span id="l20.264" class="difflineminus">-</span>
<a href="#l20.265"></a><span id="l20.265" class="difflineminus">-  return parentDir-&gt;DeleteDirectory(directory);</span>
<a href="#l20.266"></a><span id="l20.266" class="difflineplus">+  return rootDirectory-&gt;DeleteDirectory(directory);</span>
<a href="#l20.267"></a><span id="l20.267"> }</span>
<a href="#l20.268"></a><span id="l20.268"> </span>
<a href="#l20.269"></a><span id="l20.269"> NS_IMETHODIMP nsAbManager::AddAddressBookListener(nsIAbListener *aListener,</span>
<a href="#l20.270"></a><span id="l20.270">                                                   abListenerNotifyFlagValue aNotifyFlags)</span>
<a href="#l20.271"></a><span id="l20.271"> {</span>
<a href="#l20.272"></a><span id="l20.272">   NS_ENSURE_ARG_POINTER(aListener);</span>
<a href="#l20.273"></a><span id="l20.273"> </span>
<a href="#l20.274"></a><span id="l20.274">   abListener newListener(aListener, aNotifyFlags);</span>
<a href="#l20.275"></a><span id="l20.275" class="difflineat">@@ -408,34 +448,24 @@ NS_IMETHODIMP nsAbManager::GetUserProfil</span>
<a href="#l20.276"></a><span id="l20.276">   rv = NS_GetSpecialDirectory(NS_APP_USER_PROFILE_50_DIR, getter_AddRefs(profileDir));</span>
<a href="#l20.277"></a><span id="l20.277">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.278"></a><span id="l20.278"> </span>
<a href="#l20.279"></a><span id="l20.279">   return CallQueryInterface(profileDir, userDir);</span>
<a href="#l20.280"></a><span id="l20.280"> }</span>
<a href="#l20.281"></a><span id="l20.281"> </span>
<a href="#l20.282"></a><span id="l20.282"> NS_IMETHODIMP nsAbManager::MailListNameExists(const PRUnichar *name, PRBool *exist)</span>
<a href="#l20.283"></a><span id="l20.283"> {</span>
<a href="#l20.284"></a><span id="l20.284" class="difflineplus">+  nsresult rv;</span>
<a href="#l20.285"></a><span id="l20.285">   NS_ENSURE_ARG_POINTER(exist);</span>
<a href="#l20.286"></a><span id="l20.286"> </span>
<a href="#l20.287"></a><span id="l20.287">   *exist = PR_FALSE;</span>
<a href="#l20.288"></a><span id="l20.288"> </span>
<a href="#l20.289"></a><span id="l20.289" class="difflineminus">-  // Get the rdf service</span>
<a href="#l20.290"></a><span id="l20.290" class="difflineminus">-    nsresult rv;</span>
<a href="#l20.291"></a><span id="l20.291" class="difflineminus">-  nsCOMPtr&lt;nsIRDFService&gt; rdfService =</span>
<a href="#l20.292"></a><span id="l20.292" class="difflineminus">-    do_GetService(NS_RDF_CONTRACTID &quot;/rdf-service;1&quot;, &amp;rv);</span>
<a href="#l20.293"></a><span id="l20.293" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.294"></a><span id="l20.294" class="difflineminus">-</span>
<a href="#l20.295"></a><span id="l20.295">   // now get the top-level book</span>
<a href="#l20.296"></a><span id="l20.296" class="difflineminus">-    nsCOMPtr&lt;nsIRDFResource&gt; resource;</span>
<a href="#l20.297"></a><span id="l20.297" class="difflineminus">-  rv = rdfService-&gt;GetResource(NS_LITERAL_CSTRING(&quot;moz-abdirectory://&quot;),</span>
<a href="#l20.298"></a><span id="l20.298" class="difflineminus">-                                     getter_AddRefs(resource));</span>
<a href="#l20.299"></a><span id="l20.299" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.300"></a><span id="l20.300" class="difflineminus">-</span>
<a href="#l20.301"></a><span id="l20.301" class="difflineminus">-  nsCOMPtr&lt;nsIAbDirectory&gt; topDirectory(do_QueryInterface(resource, &amp;rv));</span>
<a href="#l20.302"></a><span id="l20.302" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.303"></a><span id="l20.303" class="difflineplus">+  nsCOMPtr&lt;nsIAbDirectory&gt; topDirectory;</span>
<a href="#l20.304"></a><span id="l20.304" class="difflineplus">+  rv = GetRootDirectory(getter_AddRefs(topDirectory));</span>
<a href="#l20.305"></a><span id="l20.305"> </span>
<a href="#l20.306"></a><span id="l20.306">   // now go through the address books</span>
<a href="#l20.307"></a><span id="l20.307">   nsCOMPtr&lt;nsISimpleEnumerator&gt; enumerator;</span>
<a href="#l20.308"></a><span id="l20.308">   rv = topDirectory-&gt;GetChildNodes(getter_AddRefs(enumerator));</span>
<a href="#l20.309"></a><span id="l20.309">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.310"></a><span id="l20.310"> </span>
<a href="#l20.311"></a><span id="l20.311">   nsCOMPtr&lt;nsISupports&gt; item;</span>
<a href="#l20.312"></a><span id="l20.312">   nsCOMPtr&lt;nsIAbMDBDirectory&gt; directory;</span>
<a href="#l20.313"></a><span id="l20.313" class="difflineat">@@ -953,28 +983,22 @@ nsresult nsAbManager::AppendLDIFForMailL</span>
<a href="#l20.314"></a><span id="l20.314"> </span>
<a href="#l20.315"></a><span id="l20.315">   rv = aCard-&gt;GetPropertyAsAString(kNotesProperty, attrValue);</span>
<a href="#l20.316"></a><span id="l20.316">   if (NS_SUCCEEDED(rv) &amp;&amp; !attrValue.IsEmpty()) {</span>
<a href="#l20.317"></a><span id="l20.317">     rv = AppendProperty(ldapAttributeName.get(), attrValue.get(), aResult);</span>
<a href="#l20.318"></a><span id="l20.318">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l20.319"></a><span id="l20.319">     aResult += MSG_LINEBREAK;</span>
<a href="#l20.320"></a><span id="l20.320">   }</span>
<a href="#l20.321"></a><span id="l20.321"> </span>
<a href="#l20.322"></a><span id="l20.322" class="difflineminus">-  nsCOMPtr&lt;nsIRDFService&gt; rdfService = do_GetService(&quot;@mozilla.org/rdf/rdf-service;1&quot;, &amp;rv);</span>
<a href="#l20.323"></a><span id="l20.323" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l20.324"></a><span id="l20.324" class="difflineminus">-</span>
<a href="#l20.325"></a><span id="l20.325">   nsCString mailListURI;</span>
<a href="#l20.326"></a><span id="l20.326">   rv = aCard-&gt;GetMailListURI(getter_Copies(mailListURI));</span>
<a href="#l20.327"></a><span id="l20.327" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l20.328"></a><span id="l20.328" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.329"></a><span id="l20.329"> </span>
<a href="#l20.330"></a><span id="l20.330" class="difflineminus">-  nsCOMPtr &lt;nsIRDFResource&gt; resource;</span>
<a href="#l20.331"></a><span id="l20.331" class="difflineminus">-  rv = rdfService-&gt;GetResource(mailListURI, getter_AddRefs(resource));</span>
<a href="#l20.332"></a><span id="l20.332" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l20.333"></a><span id="l20.333" class="difflineminus">-</span>
<a href="#l20.334"></a><span id="l20.334" class="difflineminus">-  nsCOMPtr &lt;nsIAbDirectory&gt; mailList = do_QueryInterface(resource, &amp;rv);</span>
<a href="#l20.335"></a><span id="l20.335" class="difflineplus">+  nsCOMPtr &lt;nsIAbDirectory&gt; mailList;</span>
<a href="#l20.336"></a><span id="l20.336" class="difflineplus">+  rv = GetDirectory(mailListURI, getter_AddRefs(mailList));</span>
<a href="#l20.337"></a><span id="l20.337">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l20.338"></a><span id="l20.338"> </span>
<a href="#l20.339"></a><span id="l20.339">   nsCOMPtr&lt;nsIMutableArray&gt; addresses;</span>
<a href="#l20.340"></a><span id="l20.340">   rv = mailList-&gt;GetAddressLists(getter_AddRefs(addresses));</span>
<a href="#l20.341"></a><span id="l20.341">   if (addresses) {</span>
<a href="#l20.342"></a><span id="l20.342">     PRUint32 total = 0;</span>
<a href="#l20.343"></a><span id="l20.343">     addresses-&gt;GetLength(&amp;total);</span>
<a href="#l20.344"></a><span id="l20.344">     if (total) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbManager.h</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbManager.h</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -38,18 +38,20 @@</span>
<a href="#l21.4"></a><span id="l21.4"> #ifndef __nsAbManager_h</span>
<a href="#l21.5"></a><span id="l21.5"> #define __nsAbManager_h</span>
<a href="#l21.6"></a><span id="l21.6">  </span>
<a href="#l21.7"></a><span id="l21.7"> #include &quot;nsIAbManager.h&quot;</span>
<a href="#l21.8"></a><span id="l21.8"> #include &quot;nsTObserverArray.h&quot;</span>
<a href="#l21.9"></a><span id="l21.9"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l21.10"></a><span id="l21.10"> #include &quot;nsICommandLineHandler.h&quot;</span>
<a href="#l21.11"></a><span id="l21.11"> #include &quot;nsIObserver.h&quot;</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineplus">+#include &quot;nsInterfaceHashtable.h&quot;</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineplus">+#include &quot;nsIAbDirFactoryService.h&quot;</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineplus">+#include &quot;nsIAbDirectory.h&quot;</span>
<a href="#l21.15"></a><span id="l21.15"> </span>
<a href="#l21.16"></a><span id="l21.16" class="difflineminus">-class nsIAbDirectory;</span>
<a href="#l21.17"></a><span id="l21.17"> class nsIAbLDAPAttributeMap;</span>
<a href="#l21.18"></a><span id="l21.18"> </span>
<a href="#l21.19"></a><span id="l21.19"> class nsAbManager : public nsIAbManager,</span>
<a href="#l21.20"></a><span id="l21.20">                     public nsICommandLineHandler,</span>
<a href="#l21.21"></a><span id="l21.21">                     public nsIObserver</span>
<a href="#l21.22"></a><span id="l21.22"> {</span>
<a href="#l21.23"></a><span id="l21.23">   </span>
<a href="#l21.24"></a><span id="l21.24"> public:</span>
<a href="#l21.25"></a><span id="l21.25" class="difflineat">@@ -59,16 +61,17 @@ public:</span>
<a href="#l21.26"></a><span id="l21.26"> 	NS_DECL_ISUPPORTS</span>
<a href="#l21.27"></a><span id="l21.27">  	NS_DECL_NSIABMANAGER</span>
<a href="#l21.28"></a><span id="l21.28">   NS_DECL_NSIOBSERVER</span>
<a href="#l21.29"></a><span id="l21.29">   NS_DECL_NSICOMMANDLINEHANDLER</span>
<a href="#l21.30"></a><span id="l21.30"> </span>
<a href="#l21.31"></a><span id="l21.31">   nsresult Init();</span>
<a href="#l21.32"></a><span id="l21.32"> </span>
<a href="#l21.33"></a><span id="l21.33"> private:</span>
<a href="#l21.34"></a><span id="l21.34" class="difflineplus">+  nsresult GetRootDirectory(nsIAbDirectory **aResult);</span>
<a href="#l21.35"></a><span id="l21.35">   nsresult ExportDirectoryToDelimitedText(nsIAbDirectory *aDirectory, const char *aDelim, PRUint32 aDelimLen, nsILocalFile *aLocalFile);</span>
<a href="#l21.36"></a><span id="l21.36">   nsresult ExportDirectoryToLDIF(nsIAbDirectory *aDirectory, nsILocalFile *aLocalFile);</span>
<a href="#l21.37"></a><span id="l21.37">   nsresult AppendLDIFForMailList(nsIAbCard *aCard, nsIAbLDAPAttributeMap *aAttrMap, nsACString &amp;aResult);</span>
<a href="#l21.38"></a><span id="l21.38">   nsresult AppendDNForCard(const char *aProperty, nsIAbCard *aCard, nsIAbLDAPAttributeMap *aAttrMap, nsACString &amp;aResult);</span>
<a href="#l21.39"></a><span id="l21.39">   nsresult AppendBasicLDIFForCard(nsIAbCard *aCard, nsIAbLDAPAttributeMap *aAttrMap, nsACString &amp;aResult);</span>
<a href="#l21.40"></a><span id="l21.40">   nsresult AppendProperty(const char *aProperty, const PRUnichar *aValue, nsACString &amp;aResult);</span>
<a href="#l21.41"></a><span id="l21.41">   PRBool IsSafeLDIFString(const PRUnichar *aStr);</span>
<a href="#l21.42"></a><span id="l21.42"> </span>
<a href="#l21.43"></a><span id="l21.43" class="difflineat">@@ -87,11 +90,12 @@ private:</span>
<a href="#l21.44"></a><span id="l21.44">     }</span>
<a href="#l21.45"></a><span id="l21.45">     int operator==(const abListener &amp;aListener) const {</span>
<a href="#l21.46"></a><span id="l21.46">       return mListener == aListener.mListener;</span>
<a href="#l21.47"></a><span id="l21.47">     }</span>
<a href="#l21.48"></a><span id="l21.48">   };</span>
<a href="#l21.49"></a><span id="l21.49"> </span>
<a href="#l21.50"></a><span id="l21.50">   nsTObserverArray&lt;abListener&gt; mListeners;</span>
<a href="#l21.51"></a><span id="l21.51">   nsCOMPtr&lt;nsIAbDirectory&gt; mCacheTopLevelAb;</span>
<a href="#l21.52"></a><span id="l21.52" class="difflineplus">+  nsInterfaceHashtable&lt;nsCStringHashKey, nsIAbDirectory&gt; mAbStore;</span>
<a href="#l21.53"></a><span id="l21.53"> };</span>
<a href="#l21.54"></a><span id="l21.54"> </span>
<a href="#l21.55"></a><span id="l21.55"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbOSXCard.h</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbOSXCard.h</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -36,43 +36,44 @@</span>
<a href="#l22.4"></a><span id="l22.4">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l22.5"></a><span id="l22.5">  *</span>
<a href="#l22.6"></a><span id="l22.6">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l22.7"></a><span id="l22.7"> </span>
<a href="#l22.8"></a><span id="l22.8"> #ifndef nsAbOSXCard_h___</span>
<a href="#l22.9"></a><span id="l22.9"> #define nsAbOSXCard_h___</span>
<a href="#l22.10"></a><span id="l22.10"> </span>
<a href="#l22.11"></a><span id="l22.11"> #include &quot;nsAbCardProperty.h&quot;</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-#include &quot;nsRDFResource.h&quot;</span>
<a href="#l22.13"></a><span id="l22.13"> </span>
<a href="#l22.14"></a><span id="l22.14"> #define NS_ABOSXCARD_URI_PREFIX NS_ABOSXCARD_PREFIX &quot;://&quot;</span>
<a href="#l22.15"></a><span id="l22.15"> </span>
<a href="#l22.16"></a><span id="l22.16"> #define NS_IABOSXCARD_IID \</span>
<a href="#l22.17"></a><span id="l22.17">   { 0xa7e5b697, 0x772d, 0x4fb5, \</span>
<a href="#l22.18"></a><span id="l22.18">     { 0x81, 0x16, 0x23, 0xb7, 0x5a, 0xac, 0x94, 0x56 } }</span>
<a href="#l22.19"></a><span id="l22.19"> </span>
<a href="#l22.20"></a><span id="l22.20"> class nsIAbOSXCard : public nsISupports</span>
<a href="#l22.21"></a><span id="l22.21"> {</span>
<a href="#l22.22"></a><span id="l22.22"> public:</span>
<a href="#l22.23"></a><span id="l22.23">   NS_DECLARE_STATIC_IID_ACCESSOR(NS_IABOSXCARD_IID)</span>
<a href="#l22.24"></a><span id="l22.24"> </span>
<a href="#l22.25"></a><span id="l22.25" class="difflineplus">+  virtual nsresult Init(const char *aUri) = 0;</span>
<a href="#l22.26"></a><span id="l22.26">   virtual nsresult Update(PRBool aNotify) = 0;</span>
<a href="#l22.27"></a><span id="l22.27" class="difflineplus">+  virtual nsresult GetURI(nsACString &amp;aURI) = 0;</span>
<a href="#l22.28"></a><span id="l22.28"> };</span>
<a href="#l22.29"></a><span id="l22.29"> </span>
<a href="#l22.30"></a><span id="l22.30"> NS_DEFINE_STATIC_IID_ACCESSOR(nsIAbOSXCard, NS_IABOSXCARD_IID)</span>
<a href="#l22.31"></a><span id="l22.31"> </span>
<a href="#l22.32"></a><span id="l22.32" class="difflineminus">-class nsAbOSXCard : public nsRDFResource, </span>
<a href="#l22.33"></a><span id="l22.33" class="difflineminus">-                    public nsAbCardProperty,</span>
<a href="#l22.34"></a><span id="l22.34" class="difflineplus">+class nsAbOSXCard : public nsAbCardProperty,</span>
<a href="#l22.35"></a><span id="l22.35">                     public nsIAbOSXCard</span>
<a href="#l22.36"></a><span id="l22.36"> {</span>
<a href="#l22.37"></a><span id="l22.37"> public:</span>
<a href="#l22.38"></a><span id="l22.38">   NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l22.39"></a><span id="l22.39">     </span>
<a href="#l22.40"></a><span id="l22.40" class="difflineminus">-  // nsIRDFResource method</span>
<a href="#l22.41"></a><span id="l22.41" class="difflineminus">-  NS_IMETHOD Init(const char *aUri);</span>
<a href="#l22.42"></a><span id="l22.42" class="difflineminus">-</span>
<a href="#l22.43"></a><span id="l22.43">   nsresult Update(PRBool aNotify);</span>
<a href="#l22.44"></a><span id="l22.44" class="difflineminus">-</span>
<a href="#l22.45"></a><span id="l22.45" class="difflineplus">+  nsresult GetURI(nsACString &amp;aURI);</span>
<a href="#l22.46"></a><span id="l22.46" class="difflineplus">+  nsresult Init(const char *aUri);</span>
<a href="#l22.47"></a><span id="l22.47">   // this is needed so nsAbOSXUtils.mm can get at nsAbCardProperty</span>
<a href="#l22.48"></a><span id="l22.48">   friend class nsAbOSXUtils;</span>
<a href="#l22.49"></a><span id="l22.49" class="difflineplus">+private:</span>
<a href="#l22.50"></a><span id="l22.50" class="difflineplus">+  nsCString mURI;</span>
<a href="#l22.51"></a><span id="l22.51" class="difflineplus">+</span>
<a href="#l22.52"></a><span id="l22.52"> };</span>
<a href="#l22.53"></a><span id="l22.53"> </span>
<a href="#l22.54"></a><span id="l22.54"> #endif // nsAbOSXCard_h___</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbOSXCard.mm</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbOSXCard.mm</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -50,19 +50,18 @@</span>
<a href="#l23.4"></a><span id="l23.4"> #define kABShowAsCompany (0)</span>
<a href="#l23.5"></a><span id="l23.5"> #define kABNameOrderingMask (0)</span>
<a href="#l23.6"></a><span id="l23.6"> #define kABDefaultNameOrdering (-1)</span>
<a href="#l23.7"></a><span id="l23.7"> #define kABFirstNameFirst (-1)</span>
<a href="#l23.8"></a><span id="l23.8"> #define kABOtherDatesProperty nil</span>
<a href="#l23.9"></a><span id="l23.9"> #define kABAnniversaryLabel nil</span>
<a href="#l23.10"></a><span id="l23.10"> #endif</span>
<a href="#l23.11"></a><span id="l23.11"> </span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-NS_IMPL_ISUPPORTS_INHERITED2(nsAbOSXCard,</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineminus">-                             nsRDFResource,</span>
<a href="#l23.14"></a><span id="l23.14" class="difflineminus">-                             nsIAbCard,</span>
<a href="#l23.15"></a><span id="l23.15" class="difflineplus">+NS_IMPL_ISUPPORTS_INHERITED1(nsAbOSXCard,</span>
<a href="#l23.16"></a><span id="l23.16" class="difflineplus">+                             nsAbCardProperty,</span>
<a href="#l23.17"></a><span id="l23.17">                              nsIAbOSXCard)</span>
<a href="#l23.18"></a><span id="l23.18"> </span>
<a href="#l23.19"></a><span id="l23.19"> #ifdef DEBUG</span>
<a href="#l23.20"></a><span id="l23.20"> static ABPropertyType</span>
<a href="#l23.21"></a><span id="l23.21"> GetPropertType(ABRecord *aCard, NSString *aProperty)</span>
<a href="#l23.22"></a><span id="l23.22"> {</span>
<a href="#l23.23"></a><span id="l23.23">   ABPropertyType propertyType = kABErrorInProperty;</span>
<a href="#l23.24"></a><span id="l23.24">   if ([aCard isKindOfClass:[ABPerson class]])</span>
<a href="#l23.25"></a><span id="l23.25" class="difflineat">@@ -83,18 +82,19 @@ SetStringProperty(nsAbOSXCard *aCard, co</span>
<a href="#l23.26"></a><span id="l23.26">   if (NS_FAILED(rv))</span>
<a href="#l23.27"></a><span id="l23.27">     oldValue.Truncate();</span>
<a href="#l23.28"></a><span id="l23.28"> </span>
<a href="#l23.29"></a><span id="l23.29">   if (!aNotify) {</span>
<a href="#l23.30"></a><span id="l23.30">     aCard-&gt;SetPropertyAsAString(aMemberName, aValue);</span>
<a href="#l23.31"></a><span id="l23.31">   }</span>
<a href="#l23.32"></a><span id="l23.32">   else if (!oldValue.Equals(aValue)) {</span>
<a href="#l23.33"></a><span id="l23.33">     aCard-&gt;SetPropertyAsAString(aMemberName, aValue);</span>
<a href="#l23.34"></a><span id="l23.34" class="difflineminus">-    </span>
<a href="#l23.35"></a><span id="l23.35" class="difflineminus">-    nsISupports *supports = NS_ISUPPORTS_CAST(nsRDFResource*, aCard);</span>
<a href="#l23.36"></a><span id="l23.36" class="difflineplus">+</span>
<a href="#l23.37"></a><span id="l23.37" class="difflineplus">+    nsISupports *supports = NS_ISUPPORTS_CAST(nsAbCardProperty*, aCard);</span>
<a href="#l23.38"></a><span id="l23.38" class="difflineplus">+</span>
<a href="#l23.39"></a><span id="l23.39">     aAbManager-&gt;NotifyItemPropertyChanged(supports, aMemberName,</span>
<a href="#l23.40"></a><span id="l23.40">                                           oldValue.get(), aValue.get());</span>
<a href="#l23.41"></a><span id="l23.41">   }</span>
<a href="#l23.42"></a><span id="l23.42"> }</span>
<a href="#l23.43"></a><span id="l23.43"> </span>
<a href="#l23.44"></a><span id="l23.44"> static void</span>
<a href="#l23.45"></a><span id="l23.45"> SetStringProperty(nsAbOSXCard *aCard, NSString *aValue, const char *aMemberName,</span>
<a href="#l23.46"></a><span id="l23.46">                   PRBool aNotify, nsIAbManager *aAbManager)</span>
<a href="#l23.47"></a><span id="l23.47" class="difflineat">@@ -172,32 +172,41 @@ MapMultiValue(nsAbOSXCard *aCard, ABReco</span>
<a href="#l23.48"></a><span id="l23.48">   }</span>
<a href="#l23.49"></a><span id="l23.49">   // String wasn't found, set value of card to empty if it was set previously</span>
<a href="#l23.50"></a><span id="l23.50">   SetStringProperty(aCard, EmptyString(), aMap.mPropertyName, aNotify,</span>
<a href="#l23.51"></a><span id="l23.51">                     aAbManager);</span>
<a href="#l23.52"></a><span id="l23.52">   </span>
<a href="#l23.53"></a><span id="l23.53">   return PR_FALSE;</span>
<a href="#l23.54"></a><span id="l23.54"> }</span>
<a href="#l23.55"></a><span id="l23.55"> </span>
<a href="#l23.56"></a><span id="l23.56" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l23.57"></a><span id="l23.57" class="difflineplus">+nsresult</span>
<a href="#l23.58"></a><span id="l23.58"> nsAbOSXCard::Init(const char *aUri)</span>
<a href="#l23.59"></a><span id="l23.59"> {</span>
<a href="#l23.60"></a><span id="l23.60">   if (strncmp(aUri, NS_ABOSXCARD_URI_PREFIX,</span>
<a href="#l23.61"></a><span id="l23.61">               sizeof(NS_ABOSXCARD_URI_PREFIX) - 1) != 0)</span>
<a href="#l23.62"></a><span id="l23.62">     return NS_ERROR_FAILURE;</span>
<a href="#l23.63"></a><span id="l23.63" class="difflineminus">-  </span>
<a href="#l23.64"></a><span id="l23.64" class="difflineminus">-  nsresult rv = nsRDFResource::Init(aUri);</span>
<a href="#l23.65"></a><span id="l23.65" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.66"></a><span id="l23.66" class="difflineminus">-  </span>
<a href="#l23.67"></a><span id="l23.67" class="difflineplus">+</span>
<a href="#l23.68"></a><span id="l23.68" class="difflineplus">+  mURI = aUri;</span>
<a href="#l23.69"></a><span id="l23.69" class="difflineplus">+</span>
<a href="#l23.70"></a><span id="l23.70">   SetLocalId(nsDependentCString(aUri));</span>
<a href="#l23.71"></a><span id="l23.71"> </span>
<a href="#l23.72"></a><span id="l23.72">   return Update(PR_FALSE);</span>
<a href="#l23.73"></a><span id="l23.73"> }</span>
<a href="#l23.74"></a><span id="l23.74"> </span>
<a href="#l23.75"></a><span id="l23.75"> nsresult</span>
<a href="#l23.76"></a><span id="l23.76" class="difflineplus">+nsAbOSXCard::GetURI(nsACString &amp;aURI)</span>
<a href="#l23.77"></a><span id="l23.77" class="difflineplus">+{</span>
<a href="#l23.78"></a><span id="l23.78" class="difflineplus">+  if (mURI.IsEmpty())</span>
<a href="#l23.79"></a><span id="l23.79" class="difflineplus">+    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l23.80"></a><span id="l23.80" class="difflineplus">+</span>
<a href="#l23.81"></a><span id="l23.81" class="difflineplus">+  aURI = mURI;</span>
<a href="#l23.82"></a><span id="l23.82" class="difflineplus">+  return NS_OK;</span>
<a href="#l23.83"></a><span id="l23.83" class="difflineplus">+}</span>
<a href="#l23.84"></a><span id="l23.84" class="difflineplus">+</span>
<a href="#l23.85"></a><span id="l23.85" class="difflineplus">+nsresult</span>
<a href="#l23.86"></a><span id="l23.86"> nsAbOSXCard::Update(PRBool aNotify)</span>
<a href="#l23.87"></a><span id="l23.87"> {</span>
<a href="#l23.88"></a><span id="l23.88">   ABAddressBook *addressBook = [ABAddressBook sharedAddressBook];</span>
<a href="#l23.89"></a><span id="l23.89"> </span>
<a href="#l23.90"></a><span id="l23.90">   const char *uid = &amp;((mURI.get())[16]);</span>
<a href="#l23.91"></a><span id="l23.91">   ABRecord *card = [addressBook recordForUniqueId:[NSString stringWithUTF8String:uid]];</span>
<a href="#l23.92"></a><span id="l23.92">   NS_ENSURE_TRUE(card, NS_ERROR_FAILURE);</span>
<a href="#l23.93"></a><span id="l23.93"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbOSXDirectory.h</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbOSXDirectory.h</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -35,24 +35,27 @@</span>
<a href="#l24.4"></a><span id="l24.4">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l24.5"></a><span id="l24.5">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l24.6"></a><span id="l24.6">  *</span>
<a href="#l24.7"></a><span id="l24.7">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l24.8"></a><span id="l24.8"> </span>
<a href="#l24.9"></a><span id="l24.9"> #ifndef nsAbOSXDirectory_h___</span>
<a href="#l24.10"></a><span id="l24.10"> #define nsAbOSXDirectory_h___</span>
<a href="#l24.11"></a><span id="l24.11"> </span>
<a href="#l24.12"></a><span id="l24.12" class="difflineplus">+#include &quot;nsISupports.h&quot;</span>
<a href="#l24.13"></a><span id="l24.13"> #include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l24.14"></a><span id="l24.14" class="difflineminus">-#include &quot;nsAbDirectoryRDFResource.h&quot;</span>
<a href="#l24.15"></a><span id="l24.15"> #include &quot;nsAbDirProperty.h&quot;</span>
<a href="#l24.16"></a><span id="l24.16"> #include &quot;nsIAbDirectoryQuery.h&quot;</span>
<a href="#l24.17"></a><span id="l24.17"> #include &quot;nsIAbDirectorySearch.h&quot;</span>
<a href="#l24.18"></a><span id="l24.18"> #include &quot;nsIAbDirSearchListener.h&quot;</span>
<a href="#l24.19"></a><span id="l24.19"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l24.20"></a><span id="l24.20" class="difflineplus">+#include &quot;nsInterfaceHashtable.h&quot;</span>
<a href="#l24.21"></a><span id="l24.21" class="difflineplus">+#include &quot;nsAbOSXCard.h&quot;</span>
<a href="#l24.22"></a><span id="l24.22"> </span>
<a href="#l24.23"></a><span id="l24.23" class="difflineplus">+#include &lt;CoreFoundation/CoreFoundation.h&gt;</span>
<a href="#l24.24"></a><span id="l24.24"> class nsIAbManager;</span>
<a href="#l24.25"></a><span id="l24.25"> class nsIAbBooleanExpression;</span>
<a href="#l24.26"></a><span id="l24.26"> </span>
<a href="#l24.27"></a><span id="l24.27"> #define NS_ABOSXDIRECTORY_URI_PREFIX NS_ABOSXDIRECTORY_PREFIX &quot;://&quot;</span>
<a href="#l24.28"></a><span id="l24.28"> </span>
<a href="#l24.29"></a><span id="l24.29"> #define NS_IABOSXDIRECTORY_IID \</span>
<a href="#l24.30"></a><span id="l24.30"> { 0x87ee4bd9, 0x8552, 0x498f, \</span>
<a href="#l24.31"></a><span id="l24.31">   { 0x80, 0x85, 0x34, 0xf0, 0x2a, 0xbb, 0x56, 0x16 } }</span>
<a href="#l24.32"></a><span id="l24.32" class="difflineat">@@ -69,33 +72,36 @@ public:</span>
<a href="#l24.33"></a><span id="l24.33">   virtual nsresult AssertCard(nsIAbManager *aManager,</span>
<a href="#l24.34"></a><span id="l24.34">                               nsIAbCard *aCard) = 0;</span>
<a href="#l24.35"></a><span id="l24.35">   virtual nsresult UnassertCard(nsIAbManager *aManager,</span>
<a href="#l24.36"></a><span id="l24.36">                                 nsIAbCard *aCard,</span>
<a href="#l24.37"></a><span id="l24.37">                                 nsIMutableArray *aCardList) = 0;</span>
<a href="#l24.38"></a><span id="l24.38">   virtual nsresult UnassertDirectory(nsIAbManager *aManager,</span>
<a href="#l24.39"></a><span id="l24.39">                                      nsIAbDirectory *aDirectory) = 0;</span>
<a href="#l24.40"></a><span id="l24.40">   virtual nsresult DeleteUid(const nsACString &amp;aUid) = 0;</span>
<a href="#l24.41"></a><span id="l24.41" class="difflineplus">+  virtual nsresult GetURI(nsACString &amp;aURI) = 0;</span>
<a href="#l24.42"></a><span id="l24.42" class="difflineplus">+  virtual nsresult Init(const char *aUri) = 0;</span>
<a href="#l24.43"></a><span id="l24.43" class="difflineplus">+  virtual nsresult GetCardByUri(const nsACString &amp;aUri, nsIAbOSXCard **aResult) = 0;</span>
<a href="#l24.44"></a><span id="l24.44"> };</span>
<a href="#l24.45"></a><span id="l24.45"> </span>
<a href="#l24.46"></a><span id="l24.46"> NS_DEFINE_STATIC_IID_ACCESSOR(nsIAbOSXDirectory, NS_IABOSXDIRECTORY_IID)</span>
<a href="#l24.47"></a><span id="l24.47"> </span>
<a href="#l24.48"></a><span id="l24.48" class="difflineminus">-class nsAbOSXDirectory : public nsAbDirectoryRDFResource,</span>
<a href="#l24.49"></a><span id="l24.49" class="difflineminus">-public nsAbDirProperty,</span>
<a href="#l24.50"></a><span id="l24.50" class="difflineplus">+class nsAbOSXDirectory : public nsAbDirProperty,</span>
<a href="#l24.51"></a><span id="l24.51"> public nsIAbDirSearchListener,</span>
<a href="#l24.52"></a><span id="l24.52"> public nsIAbOSXDirectory</span>
<a href="#l24.53"></a><span id="l24.53"> {</span>
<a href="#l24.54"></a><span id="l24.54"> public:</span>
<a href="#l24.55"></a><span id="l24.55" class="difflineplus">+  nsAbOSXDirectory();</span>
<a href="#l24.56"></a><span id="l24.56">   ~nsAbOSXDirectory();</span>
<a href="#l24.57"></a><span id="l24.57">   </span>
<a href="#l24.58"></a><span id="l24.58">   NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l24.59"></a><span id="l24.59">   NS_DECL_NSIABDIRSEARCHLISTENER</span>
<a href="#l24.60"></a><span id="l24.60">     </span>
<a href="#l24.61"></a><span id="l24.61" class="difflineminus">-    // nsAbDirectoryRDFResource method</span>
<a href="#l24.62"></a><span id="l24.62" class="difflineminus">-    NS_IMETHOD Init(const char *aUri);</span>
<a href="#l24.63"></a><span id="l24.63" class="difflineplus">+  // nsIAbOSXDirectory method</span>
<a href="#l24.64"></a><span id="l24.64" class="difflineplus">+  NS_IMETHOD Init(const char *aUri);</span>
<a href="#l24.65"></a><span id="l24.65">   </span>
<a href="#l24.66"></a><span id="l24.66">   // nsAbDirProperty methods</span>
<a href="#l24.67"></a><span id="l24.67">   NS_IMETHOD GetReadOnly(PRBool *aReadOnly);</span>
<a href="#l24.68"></a><span id="l24.68">   NS_IMETHOD GetChildCards(nsISimpleEnumerator **aCards);</span>
<a href="#l24.69"></a><span id="l24.69">   NS_IMETHOD GetChildNodes(nsISimpleEnumerator **aNodes);</span>
<a href="#l24.70"></a><span id="l24.70">   NS_IMETHOD GetIsQuery(PRBool *aResult);</span>
<a href="#l24.71"></a><span id="l24.71">   NS_IMETHOD HasCard(nsIAbCard *aCard, PRBool *aHasCard);</span>
<a href="#l24.72"></a><span id="l24.72">   NS_IMETHOD HasDirectory(nsIAbDirectory *aDirectory, PRBool *aHasDirectory);</span>
<a href="#l24.73"></a><span id="l24.73" class="difflineat">@@ -121,26 +127,33 @@ public:</span>
<a href="#l24.74"></a><span id="l24.74">                         nsIAbCard *aCard,</span>
<a href="#l24.75"></a><span id="l24.75">                         nsIMutableArray *aCardList);</span>
<a href="#l24.76"></a><span id="l24.76">   nsresult UnassertDirectory(nsIAbManager *aManager,</span>
<a href="#l24.77"></a><span id="l24.77">                              nsIAbDirectory *aDirectory);</span>
<a href="#l24.78"></a><span id="l24.78">   </span>
<a href="#l24.79"></a><span id="l24.79">   nsresult Update();</span>
<a href="#l24.80"></a><span id="l24.80"> </span>
<a href="#l24.81"></a><span id="l24.81">   nsresult DeleteUid(const nsACString &amp;aUid);</span>
<a href="#l24.82"></a><span id="l24.82" class="difflineplus">+</span>
<a href="#l24.83"></a><span id="l24.83" class="difflineplus">+  nsresult GetCardByUri(const nsACString &amp;aUri, nsIAbOSXCard **aResult);</span>
<a href="#l24.84"></a><span id="l24.84" class="difflineplus">+</span>
<a href="#l24.85"></a><span id="l24.85" class="difflineplus">+  nsresult GetRootOSXDirectory(nsIAbOSXDirectory **aResult);</span>
<a href="#l24.86"></a><span id="l24.86" class="difflineplus">+</span>
<a href="#l24.87"></a><span id="l24.87"> private:</span>
<a href="#l24.88"></a><span id="l24.88">   nsresult FallbackSearch(nsIAbBooleanExpression *aExpression,</span>
<a href="#l24.89"></a><span id="l24.89">                           nsISimpleEnumerator **aCards);</span>
<a href="#l24.90"></a><span id="l24.90"> </span>
<a href="#l24.91"></a><span id="l24.91">   // This is a list of nsIAbCards, kept separate from m_AddressList because:</span>
<a href="#l24.92"></a><span id="l24.92">   // - nsIAbDirectory items that are mailing lists, must keep a list of</span>
<a href="#l24.93"></a><span id="l24.93">   //   nsIAbCards in m_AddressList, however</span>
<a href="#l24.94"></a><span id="l24.94">   // - nsIAbDirectory items that are address books, must keep a list of</span>
<a href="#l24.95"></a><span id="l24.95">   //   nsIAbDirectory (i.e. mailing lists) in m_AddressList, AND no nsIAbCards.</span>
<a href="#l24.96"></a><span id="l24.96">   //</span>
<a href="#l24.97"></a><span id="l24.97">   // This wasn't too bad for mork, as that just gets a list from its database,</span>
<a href="#l24.98"></a><span id="l24.98">   // but because we store our own copy of the list, we must store a separate</span>
<a href="#l24.99"></a><span id="l24.99">   // list of nsIAbCards here. nsIMutableArray is used, because then it is</span>
<a href="#l24.100"></a><span id="l24.100">   // interchangeable with m_AddressList.</span>
<a href="#l24.101"></a><span id="l24.101">   nsCOMPtr&lt;nsIMutableArray&gt; mCardList;</span>
<a href="#l24.102"></a><span id="l24.102" class="difflineplus">+  nsInterfaceHashtable&lt;nsCStringHashKey, nsIAbOSXCard&gt; mCardStore;</span>
<a href="#l24.103"></a><span id="l24.103" class="difflineplus">+  nsCOMPtr&lt;nsIAbOSXDirectory&gt; mCacheTopLevelOSXAb;</span>
<a href="#l24.104"></a><span id="l24.104"> };</span>
<a href="#l24.105"></a><span id="l24.105"> </span>
<a href="#l24.106"></a><span id="l24.106"> #endif // nsAbOSXDirectory_h___</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbOSXDirectory.mm</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbOSXDirectory.mm</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -42,167 +42,215 @@</span>
<a href="#l25.4"></a><span id="l25.4"> #include &quot;nsAbOSXUtils.h&quot;</span>
<a href="#l25.5"></a><span id="l25.5"> #include &quot;nsAbQueryStringToExpression.h&quot;</span>
<a href="#l25.6"></a><span id="l25.6"> #include &quot;nsArrayEnumerator.h&quot;</span>
<a href="#l25.7"></a><span id="l25.7"> #include &quot;nsAutoPtr.h&quot;</span>
<a href="#l25.8"></a><span id="l25.8"> #include &quot;nsCOMArray.h&quot;</span>
<a href="#l25.9"></a><span id="l25.9"> #include &quot;nsEnumeratorUtils.h&quot;</span>
<a href="#l25.10"></a><span id="l25.10"> #include &quot;nsIAbDirectoryQueryProxy.h&quot;</span>
<a href="#l25.11"></a><span id="l25.11"> #include &quot;nsIAbManager.h&quot;</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-#include &quot;nsIRDFService.h&quot;</span>
<a href="#l25.13"></a><span id="l25.13"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l25.14"></a><span id="l25.14"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l25.15"></a><span id="l25.15"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l25.16"></a><span id="l25.16"> #include &quot;nsIAbBooleanExpression.h&quot;</span>
<a href="#l25.17"></a><span id="l25.17"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l25.18"></a><span id="l25.18" class="difflineplus">+#include &quot;nsISimpleEnumerator.h&quot;</span>
<a href="#l25.19"></a><span id="l25.19"> </span>
<a href="#l25.20"></a><span id="l25.20"> #include &lt;AddressBook/AddressBook.h&gt;</span>
<a href="#l25.21"></a><span id="l25.21"> #if (MAC_OS_X_VERSION_MAX_ALLOWED &lt; MAC_OS_X_VERSION_10_3)</span>
<a href="#l25.22"></a><span id="l25.22"> #define kABDeletedRecords @&quot;ABDeletedRecords&quot;</span>
<a href="#l25.23"></a><span id="l25.23"> #define kABUpdatedRecords @&quot;ABUpdatedRecords&quot;</span>
<a href="#l25.24"></a><span id="l25.24"> #define kABInsertedRecords @&quot;ABInsertedRecords&quot;</span>
<a href="#l25.25"></a><span id="l25.25"> #elif (MAC_OS_X_VERSION_MIN_REQUIRED &lt; MAC_OS_X_VERSION_10_3)</span>
<a href="#l25.26"></a><span id="l25.26"> #define kABDeletedRecords (kABDeletedRecords? kABDeletedRecords : @&quot;ABDeletedRecords&quot;)</span>
<a href="#l25.27"></a><span id="l25.27"> #define kABUpdatedRecords (kABUpdatedRecords ? kABUpdatedRecords : @&quot;ABUpdatedRecords&quot;)</span>
<a href="#l25.28"></a><span id="l25.28"> #define kABInsertedRecords (kABInsertedRecords ? kABInsertedRecords : @&quot;ABInsertedRecords&quot;)</span>
<a href="#l25.29"></a><span id="l25.29"> #endif</span>
<a href="#l25.30"></a><span id="l25.30"> </span>
<a href="#l25.31"></a><span id="l25.31" class="difflineplus">+/* Each nsAbOSXDirectory contains a lookup table for their respective</span>
<a href="#l25.32"></a><span id="l25.32" class="difflineplus">+ * nsAbOSXCard's.  We set the initial size of that lookup table here.</span>
<a href="#l25.33"></a><span id="l25.33" class="difflineplus">+ */</span>
<a href="#l25.34"></a><span id="l25.34" class="difflineplus">+#define OSX_CARD_STORE_INIT 100</span>
<a href="#l25.35"></a><span id="l25.35" class="difflineplus">+</span>
<a href="#l25.36"></a><span id="l25.36"> static nsresult</span>
<a href="#l25.37"></a><span id="l25.37" class="difflineminus">-ConvertToGroupResource(nsIRDFService *aRDFService, NSString *aUid,</span>
<a href="#l25.38"></a><span id="l25.38" class="difflineminus">-                       nsIAbDirectory **aResult)</span>
<a href="#l25.39"></a><span id="l25.39" class="difflineplus">+GetOrCreateGroup(NSString *aUid, nsIAbDirectory **aResult)</span>
<a href="#l25.40"></a><span id="l25.40"> {</span>
<a href="#l25.41"></a><span id="l25.41">   NS_ASSERTION(aUid, &quot;No UID for group!.&quot;);</span>
<a href="#l25.42"></a><span id="l25.42" class="difflineminus">-  </span>
<a href="#l25.43"></a><span id="l25.43" class="difflineminus">-  *aResult = nsnull;</span>
<a href="#l25.44"></a><span id="l25.44" class="difflineminus">-  </span>
<a href="#l25.45"></a><span id="l25.45" class="difflineplus">+</span>
<a href="#l25.46"></a><span id="l25.46">   nsCAutoString uri(NS_ABOSXDIRECTORY_URI_PREFIX);</span>
<a href="#l25.47"></a><span id="l25.47">   AppendToCString(aUid, uri);</span>
<a href="#l25.48"></a><span id="l25.48" class="difflineminus">-  </span>
<a href="#l25.49"></a><span id="l25.49" class="difflineminus">-  nsCOMPtr&lt;nsIRDFResource&gt; resource;</span>
<a href="#l25.50"></a><span id="l25.50" class="difflineminus">-  nsresult rv = aRDFService-&gt;GetResource(uri, getter_AddRefs(resource));</span>
<a href="#l25.51"></a><span id="l25.51" class="difflineplus">+</span>
<a href="#l25.52"></a><span id="l25.52" class="difflineplus">+  nsresult rv;</span>
<a href="#l25.53"></a><span id="l25.53" class="difflineplus">+  nsCOMPtr&lt;nsIAbManager&gt; abManager = do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l25.54"></a><span id="l25.54">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.55"></a><span id="l25.55" class="difflineminus">-  </span>
<a href="#l25.56"></a><span id="l25.56" class="difflineminus">-  return CallQueryInterface(resource, aResult);</span>
<a href="#l25.57"></a><span id="l25.57" class="difflineplus">+</span>
<a href="#l25.58"></a><span id="l25.58" class="difflineplus">+  nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l25.59"></a><span id="l25.59" class="difflineplus">+  rv = abManager-&gt;GetDirectory(uri, getter_AddRefs(directory));</span>
<a href="#l25.60"></a><span id="l25.60" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.61"></a><span id="l25.61" class="difflineplus">+</span>
<a href="#l25.62"></a><span id="l25.62" class="difflineplus">+  NS_IF_ADDREF(*aResult = directory);</span>
<a href="#l25.63"></a><span id="l25.63" class="difflineplus">+  return NS_OK;</span>
<a href="#l25.64"></a><span id="l25.64"> }</span>
<a href="#l25.65"></a><span id="l25.65"> </span>
<a href="#l25.66"></a><span id="l25.66"> static nsresult</span>
<a href="#l25.67"></a><span id="l25.67" class="difflineminus">-ConvertToCard(nsIRDFService *aRDFService, ABRecord *aRecord,</span>
<a href="#l25.68"></a><span id="l25.68" class="difflineminus">-              nsIAbCard **aResult)</span>
<a href="#l25.69"></a><span id="l25.69" class="difflineplus">+GetCard(ABRecord *aRecord, nsIAbCard **aResult, nsIAbOSXDirectory *osxDirectory)</span>
<a href="#l25.70"></a><span id="l25.70"> {</span>
<a href="#l25.71"></a><span id="l25.71" class="difflineminus">-  *aResult = nsnull;</span>
<a href="#l25.72"></a><span id="l25.72" class="difflineminus">-  </span>
<a href="#l25.73"></a><span id="l25.73">   NSString *uid = [aRecord uniqueId];</span>
<a href="#l25.74"></a><span id="l25.74">   NS_ASSERTION(uid, &quot;No UID for card!.&quot;);</span>
<a href="#l25.75"></a><span id="l25.75">   if (!uid)</span>
<a href="#l25.76"></a><span id="l25.76">     return NS_ERROR_FAILURE;</span>
<a href="#l25.77"></a><span id="l25.77" class="difflineminus">-  </span>
<a href="#l25.78"></a><span id="l25.78" class="difflineplus">+</span>
<a href="#l25.79"></a><span id="l25.79">   nsCAutoString uri(NS_ABOSXCARD_URI_PREFIX);</span>
<a href="#l25.80"></a><span id="l25.80">   AppendToCString(uid, uri);</span>
<a href="#l25.81"></a><span id="l25.81" class="difflineminus">-  </span>
<a href="#l25.82"></a><span id="l25.82" class="difflineminus">-  nsCOMPtr&lt;nsIRDFResource&gt; resource;</span>
<a href="#l25.83"></a><span id="l25.83" class="difflineminus">-  nsresult rv = aRDFService-&gt;GetResource(uri, getter_AddRefs(resource));</span>
<a href="#l25.84"></a><span id="l25.84" class="difflineplus">+  nsCOMPtr&lt;nsIAbOSXCard&gt; osxCard;</span>
<a href="#l25.85"></a><span id="l25.85" class="difflineplus">+  nsresult rv = osxDirectory-&gt;GetCardByUri(uri, getter_AddRefs(osxCard));</span>
<a href="#l25.86"></a><span id="l25.86">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.87"></a><span id="l25.87" class="difflineminus">-  </span>
<a href="#l25.88"></a><span id="l25.88" class="difflineminus">-  return CallQueryInterface(resource, aResult);</span>
<a href="#l25.89"></a><span id="l25.89" class="difflineplus">+</span>
<a href="#l25.90"></a><span id="l25.90" class="difflineplus">+  nsCOMPtr&lt;nsIAbCard&gt; card = do_QueryInterface(osxCard, &amp;rv);</span>
<a href="#l25.91"></a><span id="l25.91" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.92"></a><span id="l25.92" class="difflineplus">+</span>
<a href="#l25.93"></a><span id="l25.93" class="difflineplus">+  NS_IF_ADDREF(*aResult = card);</span>
<a href="#l25.94"></a><span id="l25.94" class="difflineplus">+  return NS_OK;</span>
<a href="#l25.95"></a><span id="l25.95"> }</span>
<a href="#l25.96"></a><span id="l25.96"> </span>
<a href="#l25.97"></a><span id="l25.97"> static nsresult</span>
<a href="#l25.98"></a><span id="l25.98" class="difflineminus">-Update(nsIRDFService *aRDFService, NSString *aUid)</span>
<a href="#l25.99"></a><span id="l25.99" class="difflineplus">+CreateCard(ABRecord *aRecord, nsIAbCard **aResult)</span>
<a href="#l25.100"></a><span id="l25.100" class="difflineplus">+{</span>
<a href="#l25.101"></a><span id="l25.101" class="difflineplus">+  NSString *uid = [aRecord uniqueId];</span>
<a href="#l25.102"></a><span id="l25.102" class="difflineplus">+  NS_ASSERTION(uid, &quot;No UID for card!.&quot;);</span>
<a href="#l25.103"></a><span id="l25.103" class="difflineplus">+  if (!uid)</span>
<a href="#l25.104"></a><span id="l25.104" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l25.105"></a><span id="l25.105" class="difflineplus">+</span>
<a href="#l25.106"></a><span id="l25.106" class="difflineplus">+  nsresult rv;</span>
<a href="#l25.107"></a><span id="l25.107" class="difflineplus">+  nsCOMPtr&lt;nsIAbOSXCard&gt; osxCard = do_CreateInstance(NS_ABOSXCARD_CONTRACTID, &amp;rv);</span>
<a href="#l25.108"></a><span id="l25.108" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.109"></a><span id="l25.109" class="difflineplus">+</span>
<a href="#l25.110"></a><span id="l25.110" class="difflineplus">+  nsCAutoString uri(NS_ABOSXCARD_URI_PREFIX);</span>
<a href="#l25.111"></a><span id="l25.111" class="difflineplus">+  AppendToCString(uid, uri);</span>
<a href="#l25.112"></a><span id="l25.112" class="difflineplus">+</span>
<a href="#l25.113"></a><span id="l25.113" class="difflineplus">+  rv = osxCard-&gt;Init(uri.get());</span>
<a href="#l25.114"></a><span id="l25.114" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.115"></a><span id="l25.115" class="difflineplus">+</span>
<a href="#l25.116"></a><span id="l25.116" class="difflineplus">+  nsCOMPtr&lt;nsIAbCard&gt; card = do_QueryInterface(osxCard, &amp;rv);</span>
<a href="#l25.117"></a><span id="l25.117" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.118"></a><span id="l25.118" class="difflineplus">+</span>
<a href="#l25.119"></a><span id="l25.119" class="difflineplus">+  NS_IF_ADDREF(*aResult = card);</span>
<a href="#l25.120"></a><span id="l25.120" class="difflineplus">+  return NS_OK;</span>
<a href="#l25.121"></a><span id="l25.121" class="difflineplus">+}</span>
<a href="#l25.122"></a><span id="l25.122" class="difflineplus">+</span>
<a href="#l25.123"></a><span id="l25.123" class="difflineplus">+static nsresult</span>
<a href="#l25.124"></a><span id="l25.124" class="difflineplus">+Sync(NSString *aUid)</span>
<a href="#l25.125"></a><span id="l25.125"> {</span>
<a href="#l25.126"></a><span id="l25.126">   ABAddressBook *addressBook = [ABAddressBook sharedAddressBook];</span>
<a href="#l25.127"></a><span id="l25.127">   ABRecord *card = [addressBook recordForUniqueId:aUid];</span>
<a href="#l25.128"></a><span id="l25.128" class="difflineminus">-  if ([card isKindOfClass:[ABGroup class]]) {</span>
<a href="#l25.129"></a><span id="l25.129" class="difflineplus">+  if ([card isKindOfClass:[ABGroup class]])</span>
<a href="#l25.130"></a><span id="l25.130" class="difflineplus">+  {</span>
<a href="#l25.131"></a><span id="l25.131">     nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l25.132"></a><span id="l25.132" class="difflineminus">-    ConvertToGroupResource(aRDFService, aUid, getter_AddRefs(directory));</span>
<a href="#l25.133"></a><span id="l25.133" class="difflineplus">+    GetOrCreateGroup(aUid, getter_AddRefs(directory));</span>
<a href="#l25.134"></a><span id="l25.134">     nsCOMPtr&lt;nsIAbOSXDirectory&gt; osxDirectory =</span>
<a href="#l25.135"></a><span id="l25.135">       do_QueryInterface(directory);</span>
<a href="#l25.136"></a><span id="l25.136">     </span>
<a href="#l25.137"></a><span id="l25.137">     osxDirectory-&gt;Update();</span>
<a href="#l25.138"></a><span id="l25.138">   }</span>
<a href="#l25.139"></a><span id="l25.139">   else {</span>
<a href="#l25.140"></a><span id="l25.140">     nsCOMPtr&lt;nsIAbCard&gt; abCard;</span>
<a href="#l25.141"></a><span id="l25.141" class="difflineminus">-    ConvertToCard(aRDFService, card, getter_AddRefs(abCard));</span>
<a href="#l25.142"></a><span id="l25.142" class="difflineplus">+    nsresult rv;</span>
<a href="#l25.143"></a><span id="l25.143" class="difflineplus">+</span>
<a href="#l25.144"></a><span id="l25.144" class="difflineplus">+    nsCOMPtr&lt;nsIAbManager&gt; abManager = do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l25.145"></a><span id="l25.145" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.146"></a><span id="l25.146" class="difflineplus">+</span>
<a href="#l25.147"></a><span id="l25.147" class="difflineplus">+    nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l25.148"></a><span id="l25.148" class="difflineplus">+    rv = abManager-&gt;GetDirectory(NS_LITERAL_CSTRING(NS_ABOSXDIRECTORY_URI_PREFIX&quot;/&quot;),</span>
<a href="#l25.149"></a><span id="l25.149" class="difflineplus">+                                 getter_AddRefs(directory));</span>
<a href="#l25.150"></a><span id="l25.150" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.151"></a><span id="l25.151" class="difflineplus">+</span>
<a href="#l25.152"></a><span id="l25.152" class="difflineplus">+    nsCOMPtr&lt;nsIAbOSXDirectory&gt; osxDirectory =</span>
<a href="#l25.153"></a><span id="l25.153" class="difflineplus">+      do_QueryInterface(directory, &amp;rv);</span>
<a href="#l25.154"></a><span id="l25.154" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.155"></a><span id="l25.155" class="difflineplus">+</span>
<a href="#l25.156"></a><span id="l25.156" class="difflineplus">+    rv = GetCard(card, getter_AddRefs(abCard), osxDirectory);</span>
<a href="#l25.157"></a><span id="l25.157" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.158"></a><span id="l25.158" class="difflineplus">+</span>
<a href="#l25.159"></a><span id="l25.159">     nsCOMPtr&lt;nsIAbOSXCard&gt; osxCard = do_QueryInterface(abCard);</span>
<a href="#l25.160"></a><span id="l25.160" class="difflineminus">-    </span>
<a href="#l25.161"></a><span id="l25.161">     osxCard-&gt;Update(PR_TRUE);</span>
<a href="#l25.162"></a><span id="l25.162">   }</span>
<a href="#l25.163"></a><span id="l25.163">   return NS_OK;</span>
<a href="#l25.164"></a><span id="l25.164"> }</span>
<a href="#l25.165"></a><span id="l25.165"> </span>
<a href="#l25.166"></a><span id="l25.166"> @interface ABChangedMonitor : NSObject</span>
<a href="#l25.167"></a><span id="l25.167"> -(void)ABChanged:(NSNotification *)aNotification;</span>
<a href="#l25.168"></a><span id="l25.168"> @end</span>
<a href="#l25.169"></a><span id="l25.169"> </span>
<a href="#l25.170"></a><span id="l25.170"> @implementation ABChangedMonitor</span>
<a href="#l25.171"></a><span id="l25.171"> -(void)ABChanged:(NSNotification *)aNotification</span>
<a href="#l25.172"></a><span id="l25.172"> {</span>
<a href="#l25.173"></a><span id="l25.173">   NSDictionary *changes = [aNotification userInfo];</span>
<a href="#l25.174"></a><span id="l25.174">   </span>
<a href="#l25.175"></a><span id="l25.175">   nsresult rv;</span>
<a href="#l25.176"></a><span id="l25.176" class="difflineminus">-  nsCOMPtr&lt;nsIRDFService&gt; rdfService =</span>
<a href="#l25.177"></a><span id="l25.177" class="difflineminus">-    do_GetService(&quot;@mozilla.org/rdf/rdf-service;1&quot;, &amp;rv);</span>
<a href="#l25.178"></a><span id="l25.178" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, );</span>
<a href="#l25.179"></a><span id="l25.179" class="difflineminus">-  </span>
<a href="#l25.180"></a><span id="l25.180">   NSArray *inserted = [changes objectForKey:kABInsertedRecords];</span>
<a href="#l25.181"></a><span id="l25.181" class="difflineplus">+</span>
<a href="#l25.182"></a><span id="l25.182">   if (inserted) {</span>
<a href="#l25.183"></a><span id="l25.183" class="difflineminus">-    nsCOMPtr&lt;nsIRDFResource&gt; resource;</span>
<a href="#l25.184"></a><span id="l25.184" class="difflineminus">-    rv = rdfService-&gt;GetResource(NS_LITERAL_CSTRING(NS_ABOSXDIRECTORY_URI_PREFIX&quot;/&quot;),</span>
<a href="#l25.185"></a><span id="l25.185" class="difflineminus">-                                 getter_AddRefs(resource));</span>
<a href="#l25.186"></a><span id="l25.186" class="difflineplus">+    nsCOMPtr&lt;nsIAbManager&gt; abManager = do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l25.187"></a><span id="l25.187">     NS_ENSURE_SUCCESS(rv, );</span>
<a href="#l25.188"></a><span id="l25.188" class="difflineminus">-    </span>
<a href="#l25.189"></a><span id="l25.189" class="difflineminus">-    nsCOMPtr&lt;nsIAbOSXDirectory&gt; osxDirectory =</span>
<a href="#l25.190"></a><span id="l25.190" class="difflineminus">-      do_QueryInterface(resource, &amp;rv);</span>
<a href="#l25.191"></a><span id="l25.191" class="difflineplus">+</span>
<a href="#l25.192"></a><span id="l25.192" class="difflineplus">+    nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l25.193"></a><span id="l25.193" class="difflineplus">+    rv = abManager-&gt;GetDirectory(NS_LITERAL_CSTRING(NS_ABOSXDIRECTORY_URI_PREFIX&quot;/&quot;),</span>
<a href="#l25.194"></a><span id="l25.194" class="difflineplus">+                                 getter_AddRefs(directory));</span>
<a href="#l25.195"></a><span id="l25.195">     NS_ENSURE_SUCCESS(rv, );</span>
<a href="#l25.196"></a><span id="l25.196" class="difflineminus">-    </span>
<a href="#l25.197"></a><span id="l25.197" class="difflineminus">-    nsCOMPtr&lt;nsIAbManager&gt; abManager =</span>
<a href="#l25.198"></a><span id="l25.198" class="difflineminus">-      do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l25.199"></a><span id="l25.199" class="difflineplus">+</span>
<a href="#l25.200"></a><span id="l25.200" class="difflineplus">+    nsCOMPtr&lt;nsIAbOSXDirectory&gt; osxDirectory =</span>
<a href="#l25.201"></a><span id="l25.201" class="difflineplus">+      do_QueryInterface(directory, &amp;rv);</span>
<a href="#l25.202"></a><span id="l25.202">     NS_ENSURE_SUCCESS(rv, );</span>
<a href="#l25.203"></a><span id="l25.203" class="difflineminus">-    </span>
<a href="#l25.204"></a><span id="l25.204" class="difflineplus">+</span>
<a href="#l25.205"></a><span id="l25.205">     unsigned int i, count = [inserted count];</span>
<a href="#l25.206"></a><span id="l25.206">     for (i = 0; i &lt; count; ++i) {</span>
<a href="#l25.207"></a><span id="l25.207">       ABAddressBook *addressBook =</span>
<a href="#l25.208"></a><span id="l25.208">       [ABAddressBook sharedAddressBook];</span>
<a href="#l25.209"></a><span id="l25.209">       ABRecord *card =</span>
<a href="#l25.210"></a><span id="l25.210">         [addressBook recordForUniqueId:[inserted objectAtIndex:i]];</span>
<a href="#l25.211"></a><span id="l25.211">       if ([card isKindOfClass:[ABGroup class]]) {</span>
<a href="#l25.212"></a><span id="l25.212">         nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l25.213"></a><span id="l25.213" class="difflineminus">-        ConvertToGroupResource(rdfService, [inserted objectAtIndex:i],</span>
<a href="#l25.214"></a><span id="l25.214" class="difflineminus">-                               getter_AddRefs(directory));</span>
<a href="#l25.215"></a><span id="l25.215" class="difflineplus">+        GetOrCreateGroup([inserted objectAtIndex:i],</span>
<a href="#l25.216"></a><span id="l25.216" class="difflineplus">+                         getter_AddRefs(directory));</span>
<a href="#l25.217"></a><span id="l25.217">         </span>
<a href="#l25.218"></a><span id="l25.218">         rv = osxDirectory-&gt;AssertDirectory(abManager, directory);</span>
<a href="#l25.219"></a><span id="l25.219">         NS_ENSURE_SUCCESS(rv, );</span>
<a href="#l25.220"></a><span id="l25.220">       }</span>
<a href="#l25.221"></a><span id="l25.221">       else {</span>
<a href="#l25.222"></a><span id="l25.222">         nsCOMPtr&lt;nsIAbCard&gt; abCard;</span>
<a href="#l25.223"></a><span id="l25.223" class="difflineminus">-        ConvertToCard(rdfService, card, getter_AddRefs(abCard));</span>
<a href="#l25.224"></a><span id="l25.224" class="difflineminus">-        </span>
<a href="#l25.225"></a><span id="l25.225" class="difflineplus">+       // Construct a card</span>
<a href="#l25.226"></a><span id="l25.226" class="difflineplus">+        nsresult rv = CreateCard(card, getter_AddRefs(abCard));</span>
<a href="#l25.227"></a><span id="l25.227">         rv = osxDirectory-&gt;AssertCard(abManager, abCard);</span>
<a href="#l25.228"></a><span id="l25.228">         NS_ENSURE_SUCCESS(rv, );</span>
<a href="#l25.229"></a><span id="l25.229">       }</span>
<a href="#l25.230"></a><span id="l25.230">     }</span>
<a href="#l25.231"></a><span id="l25.231">   }</span>
<a href="#l25.232"></a><span id="l25.232">   </span>
<a href="#l25.233"></a><span id="l25.233">   NSArray *updated = [changes objectForKey:kABUpdatedRecords];</span>
<a href="#l25.234"></a><span id="l25.234">   if (updated) {</span>
<a href="#l25.235"></a><span id="l25.235">     unsigned int i, count = [updated count];</span>
<a href="#l25.236"></a><span id="l25.236">     for (i = 0; i &lt; count; ++i) {</span>
<a href="#l25.237"></a><span id="l25.237">       NSString *uid = [updated objectAtIndex:i];</span>
<a href="#l25.238"></a><span id="l25.238" class="difflineminus">-      Update(rdfService, uid);</span>
<a href="#l25.239"></a><span id="l25.239" class="difflineplus">+      Sync(uid);</span>
<a href="#l25.240"></a><span id="l25.240">     }</span>
<a href="#l25.241"></a><span id="l25.241">   }</span>
<a href="#l25.242"></a><span id="l25.242">   </span>
<a href="#l25.243"></a><span id="l25.243">   NSArray *deleted = [changes objectForKey:kABDeletedRecords];</span>
<a href="#l25.244"></a><span id="l25.244">   if (deleted) {</span>
<a href="#l25.245"></a><span id="l25.245" class="difflineminus">-    nsCOMPtr&lt;nsIRDFResource&gt; resource;</span>
<a href="#l25.246"></a><span id="l25.246" class="difflineminus">-    rv = rdfService-&gt;GetResource(NS_LITERAL_CSTRING(NS_ABOSXDIRECTORY_URI_PREFIX&quot;/&quot;),</span>
<a href="#l25.247"></a><span id="l25.247" class="difflineminus">-                                 getter_AddRefs(resource));</span>
<a href="#l25.248"></a><span id="l25.248" class="difflineplus">+</span>
<a href="#l25.249"></a><span id="l25.249" class="difflineplus">+    nsCOMPtr&lt;nsIAbManager&gt; abManager = do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l25.250"></a><span id="l25.250">     NS_ENSURE_SUCCESS(rv, );</span>
<a href="#l25.251"></a><span id="l25.251" class="difflineminus">-    </span>
<a href="#l25.252"></a><span id="l25.252" class="difflineplus">+</span>
<a href="#l25.253"></a><span id="l25.253" class="difflineplus">+    nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l25.254"></a><span id="l25.254" class="difflineplus">+    rv = abManager-&gt;GetDirectory(NS_LITERAL_CSTRING(NS_ABOSXDIRECTORY_URI_PREFIX&quot;/&quot;),</span>
<a href="#l25.255"></a><span id="l25.255" class="difflineplus">+                                 getter_AddRefs(directory));</span>
<a href="#l25.256"></a><span id="l25.256" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, );</span>
<a href="#l25.257"></a><span id="l25.257" class="difflineplus">+</span>
<a href="#l25.258"></a><span id="l25.258">     nsCOMPtr&lt;nsIAbOSXDirectory&gt; osxDirectory =</span>
<a href="#l25.259"></a><span id="l25.259" class="difflineminus">-      do_QueryInterface(resource, &amp;rv);</span>
<a href="#l25.260"></a><span id="l25.260" class="difflineplus">+      do_QueryInterface(directory, &amp;rv);</span>
<a href="#l25.261"></a><span id="l25.261">     NS_ENSURE_SUCCESS(rv, );</span>
<a href="#l25.262"></a><span id="l25.262"> </span>
<a href="#l25.263"></a><span id="l25.263">     unsigned int i, count = [deleted count];</span>
<a href="#l25.264"></a><span id="l25.264">     for (i = 0; i &lt; count; ++i) {</span>
<a href="#l25.265"></a><span id="l25.265">       NSString *deletedUid = [deleted objectAtIndex:i];</span>
<a href="#l25.266"></a><span id="l25.266"> </span>
<a href="#l25.267"></a><span id="l25.267">       nsCAutoString uid;</span>
<a href="#l25.268"></a><span id="l25.268">       AppendToCString(deletedUid, uid);</span>
<a href="#l25.269"></a><span id="l25.269" class="difflineat">@@ -420,102 +468,131 @@ Search(nsIAbBooleanExpression *aExpressi</span>
<a href="#l25.270"></a><span id="l25.270"> {</span>
<a href="#l25.271"></a><span id="l25.271">   PRBool canHandle = PR_FALSE;</span>
<a href="#l25.272"></a><span id="l25.272">   ABSearchElement *searchElement;</span>
<a href="#l25.273"></a><span id="l25.273">   nsresult rv = BuildSearchElements(aExpression, canHandle, &amp;searchElement);</span>
<a href="#l25.274"></a><span id="l25.274">   NS_ENSURE_SUCCESS(rv, PR_FALSE);</span>
<a href="#l25.275"></a><span id="l25.275">   </span>
<a href="#l25.276"></a><span id="l25.276">   if (canHandle)</span>
<a href="#l25.277"></a><span id="l25.277">     *aResult = [[ABAddressBook sharedAddressBook] recordsMatchingSearchElement:searchElement];</span>
<a href="#l25.278"></a><span id="l25.278" class="difflineminus">-  </span>
<a href="#l25.279"></a><span id="l25.279" class="difflineplus">+</span>
<a href="#l25.280"></a><span id="l25.280">   return canHandle;</span>
<a href="#l25.281"></a><span id="l25.281"> }</span>
<a href="#l25.282"></a><span id="l25.282"> </span>
<a href="#l25.283"></a><span id="l25.283"> static PRUint32 sObserverCount = 0;</span>
<a href="#l25.284"></a><span id="l25.284"> static ABChangedMonitor *sObserver = nsnull;</span>
<a href="#l25.285"></a><span id="l25.285"> </span>
<a href="#l25.286"></a><span id="l25.286" class="difflineplus">+nsAbOSXDirectory::nsAbOSXDirectory()</span>
<a href="#l25.287"></a><span id="l25.287" class="difflineplus">+{</span>
<a href="#l25.288"></a><span id="l25.288" class="difflineplus">+  mCardStore.Init(OSX_CARD_STORE_INIT);</span>
<a href="#l25.289"></a><span id="l25.289" class="difflineplus">+}</span>
<a href="#l25.290"></a><span id="l25.290" class="difflineplus">+</span>
<a href="#l25.291"></a><span id="l25.291"> nsAbOSXDirectory::~nsAbOSXDirectory()</span>
<a href="#l25.292"></a><span id="l25.292"> {</span>
<a href="#l25.293"></a><span id="l25.293">   if (--sObserverCount == 0) {</span>
<a href="#l25.294"></a><span id="l25.294">     [[NSNotificationCenter defaultCenter] removeObserver:sObserver];</span>
<a href="#l25.295"></a><span id="l25.295">     [sObserver release];</span>
<a href="#l25.296"></a><span id="l25.296">   }</span>
<a href="#l25.297"></a><span id="l25.297"> }</span>
<a href="#l25.298"></a><span id="l25.298"> </span>
<a href="#l25.299"></a><span id="l25.299" class="difflineminus">-NS_IMPL_ISUPPORTS_INHERITED3(nsAbOSXDirectory,</span>
<a href="#l25.300"></a><span id="l25.300" class="difflineminus">-                             nsAbDirectoryRDFResource,</span>
<a href="#l25.301"></a><span id="l25.301" class="difflineminus">-                             nsIAbDirectory,</span>
<a href="#l25.302"></a><span id="l25.302" class="difflineplus">+NS_IMPL_ISUPPORTS_INHERITED2(nsAbOSXDirectory,</span>
<a href="#l25.303"></a><span id="l25.303" class="difflineplus">+                             nsAbDirProperty,</span>
<a href="#l25.304"></a><span id="l25.304">                              nsIAbOSXDirectory,</span>
<a href="#l25.305"></a><span id="l25.305">                              nsIAbDirSearchListener)</span>
<a href="#l25.306"></a><span id="l25.306"> </span>
<a href="#l25.307"></a><span id="l25.307"> NS_IMETHODIMP</span>
<a href="#l25.308"></a><span id="l25.308"> nsAbOSXDirectory::Init(const char *aUri)</span>
<a href="#l25.309"></a><span id="l25.309"> {</span>
<a href="#l25.310"></a><span id="l25.310" class="difflineplus">+  nsresult rv;</span>
<a href="#l25.311"></a><span id="l25.311" class="difflineplus">+  rv = nsAbDirProperty::Init(aUri);</span>
<a href="#l25.312"></a><span id="l25.312" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.313"></a><span id="l25.313" class="difflineplus">+</span>
<a href="#l25.314"></a><span id="l25.314">   ABAddressBook *addressBook = [ABAddressBook sharedAddressBook];</span>
<a href="#l25.315"></a><span id="l25.315">   if (sObserverCount == 0) {</span>
<a href="#l25.316"></a><span id="l25.316">     sObserver = [[ABChangedMonitor alloc] init];</span>
<a href="#l25.317"></a><span id="l25.317">     [[NSNotificationCenter defaultCenter] addObserver:(ABChangedMonitor*)sObserver</span>
<a href="#l25.318"></a><span id="l25.318">                                              selector:@selector(ABChanged:)</span>
<a href="#l25.319"></a><span id="l25.319">                                                  name:kABDatabaseChangedExternallyNotification</span>
<a href="#l25.320"></a><span id="l25.320">                                                object:nil];</span>
<a href="#l25.321"></a><span id="l25.321">   }</span>
<a href="#l25.322"></a><span id="l25.322">   ++sObserverCount;</span>
<a href="#l25.323"></a><span id="l25.323" class="difflineminus">-  </span>
<a href="#l25.324"></a><span id="l25.324" class="difflineminus">-  nsresult rv = nsAbDirectoryRDFResource::Init(aUri);</span>
<a href="#l25.325"></a><span id="l25.325" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.326"></a><span id="l25.326" class="difflineminus">-  </span>
<a href="#l25.327"></a><span id="l25.327" class="difflineplus">+</span>
<a href="#l25.328"></a><span id="l25.328">   NSArray *cards;</span>
<a href="#l25.329"></a><span id="l25.329">   nsCOMPtr&lt;nsIMutableArray&gt; cardList;</span>
<a href="#l25.330"></a><span id="l25.330" class="difflineminus">-  if (mURINoQuery.Length() &gt; sizeof(NS_ABOSXDIRECTORY_URI_PREFIX))</span>
<a href="#l25.331"></a><span id="l25.331" class="difflineminus">-  {</span>
<a href="#l25.332"></a><span id="l25.332" class="difflineminus">-    nsCAutoString uid(Substring(mURINoQuery, sizeof(NS_ABOSXDIRECTORY_URI_PREFIX) - 1));</span>
<a href="#l25.333"></a><span id="l25.333" class="difflineminus">-    ABRecord *card = [addressBook recordForUniqueId:[NSString stringWithUTF8String:uid.get()]];</span>
<a href="#l25.334"></a><span id="l25.334" class="difflineminus">-    NS_ASSERTION([card isKindOfClass:[ABGroup class]], &quot;Huh.&quot;);</span>
<a href="#l25.335"></a><span id="l25.335" class="difflineminus">-    </span>
<a href="#l25.336"></a><span id="l25.336" class="difflineminus">-    m_IsMailList = PR_TRUE;</span>
<a href="#l25.337"></a><span id="l25.337" class="difflineminus">-    AppendToString([card valueForProperty:kABGroupNameProperty], m_ListDirName);</span>
<a href="#l25.338"></a><span id="l25.338" class="difflineplus">+  PRBool isRootOSXDirectory = PR_FALSE;</span>
<a href="#l25.339"></a><span id="l25.339"> </span>
<a href="#l25.340"></a><span id="l25.340" class="difflineminus">-    ABGroup *group = (ABGroup*)[addressBook recordForUniqueId:[NSString stringWithUTF8String:nsCAutoString(Substring(mURINoQuery, 21)).get()]];</span>
<a href="#l25.341"></a><span id="l25.341" class="difflineminus">-    cards = [[group members] arrayByAddingObjectsFromArray:[group subgroups]];</span>
<a href="#l25.342"></a><span id="l25.342" class="difflineminus">-    if (!m_AddressList)</span>
<a href="#l25.343"></a><span id="l25.343" class="difflineminus">-      m_AddressList = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l25.344"></a><span id="l25.344" class="difflineminus">-    else</span>
<a href="#l25.345"></a><span id="l25.345" class="difflineminus">-      rv = m_AddressList-&gt;Clear();</span>
<a href="#l25.346"></a><span id="l25.346" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.347"></a><span id="l25.347" class="difflineplus">+  if (mURINoQuery.Length() &lt;= sizeof(NS_ABOSXDIRECTORY_URI_PREFIX))</span>
<a href="#l25.348"></a><span id="l25.348" class="difflineplus">+    isRootOSXDirectory = PR_TRUE;</span>
<a href="#l25.349"></a><span id="l25.349"> </span>
<a href="#l25.350"></a><span id="l25.350" class="difflineminus">-    cardList = m_AddressList;</span>
<a href="#l25.351"></a><span id="l25.351" class="difflineminus">-  }</span>
<a href="#l25.352"></a><span id="l25.352" class="difflineminus">-  else</span>
<a href="#l25.353"></a><span id="l25.353" class="difflineplus">+  if (isRootOSXDirectory)</span>
<a href="#l25.354"></a><span id="l25.354">   {</span>
<a href="#l25.355"></a><span id="l25.355">     m_DirPrefId.AssignLiteral(&quot;ldap_2.servers.osx&quot;);</span>
<a href="#l25.356"></a><span id="l25.356"> </span>
<a href="#l25.357"></a><span id="l25.357">     cards = [[addressBook people] arrayByAddingObjectsFromArray:[addressBook groups]];</span>
<a href="#l25.358"></a><span id="l25.358">     if (!mCardList)</span>
<a href="#l25.359"></a><span id="l25.359">       mCardList = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l25.360"></a><span id="l25.360">     else</span>
<a href="#l25.361"></a><span id="l25.361">       rv = mCardList-&gt;Clear();</span>
<a href="#l25.362"></a><span id="l25.362">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.363"></a><span id="l25.363"> </span>
<a href="#l25.364"></a><span id="l25.364">     cardList = mCardList;</span>
<a href="#l25.365"></a><span id="l25.365">   }</span>
<a href="#l25.366"></a><span id="l25.366" class="difflineplus">+  else</span>
<a href="#l25.367"></a><span id="l25.367" class="difflineplus">+  {</span>
<a href="#l25.368"></a><span id="l25.368" class="difflineplus">+    nsCAutoString uid(Substring(mURINoQuery, sizeof(NS_ABOSXDIRECTORY_URI_PREFIX) - 1));</span>
<a href="#l25.369"></a><span id="l25.369" class="difflineplus">+    ABRecord *card = [addressBook recordForUniqueId:[NSString stringWithUTF8String:uid.get()]];</span>
<a href="#l25.370"></a><span id="l25.370" class="difflineplus">+    NS_ASSERTION([card isKindOfClass:[ABGroup class]], &quot;Huh.&quot;);</span>
<a href="#l25.371"></a><span id="l25.371" class="difflineplus">+</span>
<a href="#l25.372"></a><span id="l25.372" class="difflineplus">+    m_IsMailList = PR_TRUE;</span>
<a href="#l25.373"></a><span id="l25.373" class="difflineplus">+    AppendToString([card valueForProperty:kABGroupNameProperty], m_ListDirName);</span>
<a href="#l25.374"></a><span id="l25.374" class="difflineplus">+</span>
<a href="#l25.375"></a><span id="l25.375" class="difflineplus">+    ABGroup *group = (ABGroup*)[addressBook recordForUniqueId:[NSString stringWithUTF8String:nsCAutoString(Substring(mURINoQuery, 21)).get()]];</span>
<a href="#l25.376"></a><span id="l25.376" class="difflineplus">+    cards = [[group members] arrayByAddingObjectsFromArray:[group subgroups]];</span>
<a href="#l25.377"></a><span id="l25.377" class="difflineplus">+</span>
<a href="#l25.378"></a><span id="l25.378" class="difflineplus">+    if (!m_AddressList)</span>
<a href="#l25.379"></a><span id="l25.379" class="difflineplus">+      m_AddressList = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l25.380"></a><span id="l25.380" class="difflineplus">+    else</span>
<a href="#l25.381"></a><span id="l25.381" class="difflineplus">+      rv = m_AddressList-&gt;Clear();</span>
<a href="#l25.382"></a><span id="l25.382" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.383"></a><span id="l25.383" class="difflineplus">+</span>
<a href="#l25.384"></a><span id="l25.384" class="difflineplus">+    cardList = m_AddressList;</span>
<a href="#l25.385"></a><span id="l25.385" class="difflineplus">+  }</span>
<a href="#l25.386"></a><span id="l25.386" class="difflineplus">+</span>
<a href="#l25.387"></a><span id="l25.387"> </span>
<a href="#l25.388"></a><span id="l25.388">   nsCAutoString ourUuid;</span>
<a href="#l25.389"></a><span id="l25.389">   GetUuid(ourUuid);</span>
<a href="#l25.390"></a><span id="l25.390"> </span>
<a href="#l25.391"></a><span id="l25.391">   unsigned int nbCards = [cards count];</span>
<a href="#l25.392"></a><span id="l25.392">   nsCOMPtr&lt;nsIAbCard&gt; card;</span>
<a href="#l25.393"></a><span id="l25.393" class="difflineplus">+  nsCOMPtr&lt;nsIAbManager&gt; abManager = do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l25.394"></a><span id="l25.394" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.395"></a><span id="l25.395" class="difflineplus">+</span>
<a href="#l25.396"></a><span id="l25.396" class="difflineplus">+  nsCOMPtr&lt;nsIAbOSXDirectory&gt; rootOSXDirectory;</span>
<a href="#l25.397"></a><span id="l25.397" class="difflineplus">+  if (!isRootOSXDirectory)</span>
<a href="#l25.398"></a><span id="l25.398" class="difflineplus">+  {</span>
<a href="#l25.399"></a><span id="l25.399" class="difflineplus">+    rv = GetRootOSXDirectory(getter_AddRefs(rootOSXDirectory));</span>
<a href="#l25.400"></a><span id="l25.400" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.401"></a><span id="l25.401" class="difflineplus">+  }</span>
<a href="#l25.402"></a><span id="l25.402" class="difflineplus">+</span>
<a href="#l25.403"></a><span id="l25.403">   for (unsigned int i = 0; i &lt; nbCards; ++i)</span>
<a href="#l25.404"></a><span id="l25.404">   {</span>
<a href="#l25.405"></a><span id="l25.405" class="difflineminus">-    rv = ConvertToCard(gRDFService, [cards objectAtIndex:i],</span>
<a href="#l25.406"></a><span id="l25.406" class="difflineminus">-                       getter_AddRefs(card));</span>
<a href="#l25.407"></a><span id="l25.407" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.408"></a><span id="l25.408" class="difflineplus">+    // If we're a Group, it's likely that the cards we're going</span>
<a href="#l25.409"></a><span id="l25.409" class="difflineplus">+    // to create were already created in the root nsAbOSXDirectory,</span>
<a href="#l25.410"></a><span id="l25.410" class="difflineplus">+    if (!isRootOSXDirectory)</span>
<a href="#l25.411"></a><span id="l25.411" class="difflineplus">+      rv = GetCard([cards objectAtIndex:i], getter_AddRefs(card),</span>
<a href="#l25.412"></a><span id="l25.412" class="difflineplus">+                   rootOSXDirectory);</span>
<a href="#l25.413"></a><span id="l25.413" class="difflineplus">+    else</span>
<a href="#l25.414"></a><span id="l25.414" class="difflineplus">+    {</span>
<a href="#l25.415"></a><span id="l25.415" class="difflineplus">+      // If we're not a Group, that means we're the root nsAbOSXDirectory,</span>
<a href="#l25.416"></a><span id="l25.416" class="difflineplus">+      // which means we have to create the cards from scratch.</span>
<a href="#l25.417"></a><span id="l25.417" class="difflineplus">+      rv = CreateCard([cards objectAtIndex:i], getter_AddRefs(card));</span>
<a href="#l25.418"></a><span id="l25.418" class="difflineplus">+    }</span>
<a href="#l25.419"></a><span id="l25.419"> </span>
<a href="#l25.420"></a><span id="l25.420" class="difflineminus">-    card-&gt;SetDirectoryId(ourUuid);</span>
<a href="#l25.421"></a><span id="l25.421" class="difflineminus">-</span>
<a href="#l25.422"></a><span id="l25.422" class="difflineminus">-    cardList-&gt;AppendElement(card, PR_FALSE);</span>
<a href="#l25.423"></a><span id="l25.423" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.424"></a><span id="l25.424" class="difflineplus">+    AssertCard(abManager, card);</span>
<a href="#l25.425"></a><span id="l25.425">   }</span>
<a href="#l25.426"></a><span id="l25.426"> </span>
<a href="#l25.427"></a><span id="l25.427">   return NS_OK;</span>
<a href="#l25.428"></a><span id="l25.428"> }</span>
<a href="#l25.429"></a><span id="l25.429"> </span>
<a href="#l25.430"></a><span id="l25.430"> NS_IMETHODIMP</span>
<a href="#l25.431"></a><span id="l25.431"> nsAbOSXDirectory::GetURI(nsACString &amp;aURI)</span>
<a href="#l25.432"></a><span id="l25.432"> {</span>
<a href="#l25.433"></a><span id="l25.433" class="difflineat">@@ -534,23 +611,24 @@ nsAbOSXDirectory::GetReadOnly(PRBool *aR</span>
<a href="#l25.434"></a><span id="l25.434">   *aReadOnly = PR_TRUE;</span>
<a href="#l25.435"></a><span id="l25.435">   return NS_OK;</span>
<a href="#l25.436"></a><span id="l25.436"> }</span>
<a href="#l25.437"></a><span id="l25.437"> </span>
<a href="#l25.438"></a><span id="l25.438"> static PRBool</span>
<a href="#l25.439"></a><span id="l25.439"> CheckRedundantCards(nsIAbManager *aManager, nsIAbDirectory *aDirectory,</span>
<a href="#l25.440"></a><span id="l25.440">                     nsIAbCard *aCard, NSMutableArray *aCardList)</span>
<a href="#l25.441"></a><span id="l25.441"> {</span>
<a href="#l25.442"></a><span id="l25.442" class="difflineminus">-  nsCOMPtr&lt;nsIRDFResource&gt; resource(do_QueryInterface(aCard));</span>
<a href="#l25.443"></a><span id="l25.443" class="difflineminus">-  if (!resource)</span>
<a href="#l25.444"></a><span id="l25.444" class="difflineminus">-    return PR_FALSE;</span>
<a href="#l25.445"></a><span id="l25.445" class="difflineminus">-  </span>
<a href="#l25.446"></a><span id="l25.446" class="difflineminus">-  const char* uri;</span>
<a href="#l25.447"></a><span id="l25.447" class="difflineminus">-  resource-&gt;GetValueConst(&amp;uri);</span>
<a href="#l25.448"></a><span id="l25.448" class="difflineminus">-  NSString *uid = [NSString stringWithUTF8String:(uri + 21)];</span>
<a href="#l25.449"></a><span id="l25.449" class="difflineplus">+  nsresult rv;</span>
<a href="#l25.450"></a><span id="l25.450" class="difflineplus">+  nsCOMPtr&lt;nsIAbOSXCard&gt; osxCard = do_QueryInterface(aCard, &amp;rv);</span>
<a href="#l25.451"></a><span id="l25.451" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, PR_FALSE);</span>
<a href="#l25.452"></a><span id="l25.452" class="difflineplus">+</span>
<a href="#l25.453"></a><span id="l25.453" class="difflineplus">+  nsCAutoString uri;</span>
<a href="#l25.454"></a><span id="l25.454" class="difflineplus">+  rv = osxCard-&gt;GetURI(uri);</span>
<a href="#l25.455"></a><span id="l25.455" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, PR_FALSE);</span>
<a href="#l25.456"></a><span id="l25.456" class="difflineplus">+  NSString *uid = [NSString stringWithUTF8String:(uri.get() + 21)];</span>
<a href="#l25.457"></a><span id="l25.457">   </span>
<a href="#l25.458"></a><span id="l25.458">   unsigned int i, count = [aCardList count];</span>
<a href="#l25.459"></a><span id="l25.459">   for (i = 0; i &lt; count; ++i) {</span>
<a href="#l25.460"></a><span id="l25.460">     if ([[[aCardList objectAtIndex:i] uniqueId] isEqualToString:uid]) {</span>
<a href="#l25.461"></a><span id="l25.461">       [aCardList removeObjectAtIndex:i];</span>
<a href="#l25.462"></a><span id="l25.462">       break;</span>
<a href="#l25.463"></a><span id="l25.463">     }</span>
<a href="#l25.464"></a><span id="l25.464">   }</span>
<a href="#l25.465"></a><span id="l25.465" class="difflineat">@@ -559,16 +637,41 @@ CheckRedundantCards(nsIAbManager *aManag</span>
<a href="#l25.466"></a><span id="l25.466">     aManager-&gt;NotifyDirectoryItemDeleted(aDirectory, aCard);</span>
<a href="#l25.467"></a><span id="l25.467">     return PR_TRUE;</span>
<a href="#l25.468"></a><span id="l25.468">   }</span>
<a href="#l25.469"></a><span id="l25.469">   </span>
<a href="#l25.470"></a><span id="l25.470">   return PR_FALSE;</span>
<a href="#l25.471"></a><span id="l25.471"> }</span>
<a href="#l25.472"></a><span id="l25.472"> </span>
<a href="#l25.473"></a><span id="l25.473"> nsresult</span>
<a href="#l25.474"></a><span id="l25.474" class="difflineplus">+nsAbOSXDirectory::GetRootOSXDirectory(nsIAbOSXDirectory **aResult)</span>
<a href="#l25.475"></a><span id="l25.475" class="difflineplus">+{</span>
<a href="#l25.476"></a><span id="l25.476" class="difflineplus">+  if (!mCacheTopLevelOSXAb)</span>
<a href="#l25.477"></a><span id="l25.477" class="difflineplus">+  {</span>
<a href="#l25.478"></a><span id="l25.478" class="difflineplus">+    // Attempt to get card from the toplevel directories</span>
<a href="#l25.479"></a><span id="l25.479" class="difflineplus">+    nsresult rv;</span>
<a href="#l25.480"></a><span id="l25.480" class="difflineplus">+    nsCOMPtr&lt;nsIAbManager&gt; abManager = do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l25.481"></a><span id="l25.481" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.482"></a><span id="l25.482" class="difflineplus">+</span>
<a href="#l25.483"></a><span id="l25.483" class="difflineplus">+    nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l25.484"></a><span id="l25.484" class="difflineplus">+    rv = abManager-&gt;GetDirectory(NS_LITERAL_CSTRING(NS_ABOSXDIRECTORY_URI_PREFIX&quot;/&quot;),</span>
<a href="#l25.485"></a><span id="l25.485" class="difflineplus">+                                 getter_AddRefs(directory));</span>
<a href="#l25.486"></a><span id="l25.486" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.487"></a><span id="l25.487" class="difflineplus">+</span>
<a href="#l25.488"></a><span id="l25.488" class="difflineplus">+    nsCOMPtr&lt;nsIAbOSXDirectory&gt; osxDirectory =</span>
<a href="#l25.489"></a><span id="l25.489" class="difflineplus">+      do_QueryInterface(directory, &amp;rv);</span>
<a href="#l25.490"></a><span id="l25.490" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.491"></a><span id="l25.491" class="difflineplus">+    mCacheTopLevelOSXAb = osxDirectory;</span>
<a href="#l25.492"></a><span id="l25.492" class="difflineplus">+  }</span>
<a href="#l25.493"></a><span id="l25.493" class="difflineplus">+</span>
<a href="#l25.494"></a><span id="l25.494" class="difflineplus">+  NS_IF_ADDREF(*aResult = mCacheTopLevelOSXAb);</span>
<a href="#l25.495"></a><span id="l25.495" class="difflineplus">+  return NS_OK;</span>
<a href="#l25.496"></a><span id="l25.496" class="difflineplus">+}</span>
<a href="#l25.497"></a><span id="l25.497" class="difflineplus">+</span>
<a href="#l25.498"></a><span id="l25.498" class="difflineplus">+nsresult</span>
<a href="#l25.499"></a><span id="l25.499"> nsAbOSXDirectory::Update()</span>
<a href="#l25.500"></a><span id="l25.500"> {</span>
<a href="#l25.501"></a><span id="l25.501">   nsresult rv;</span>
<a href="#l25.502"></a><span id="l25.502">   nsCOMPtr&lt;nsIAbManager&gt; abManager = do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l25.503"></a><span id="l25.503">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.504"></a><span id="l25.504">   </span>
<a href="#l25.505"></a><span id="l25.505">   if (mIsQueryURI) {</span>
<a href="#l25.506"></a><span id="l25.506">     return NS_OK;</span>
<a href="#l25.507"></a><span id="l25.507" class="difflineat">@@ -619,40 +722,49 @@ nsAbOSXDirectory::Update()</span>
<a href="#l25.508"></a><span id="l25.508"> </span>
<a href="#l25.509"></a><span id="l25.509">     if (CheckRedundantCards(abManager, this, card, mutableArray))</span>
<a href="#l25.510"></a><span id="l25.510">       cardList-&gt;RemoveElementAt(addressCount);</span>
<a href="#l25.511"></a><span id="l25.511">   }</span>
<a href="#l25.512"></a><span id="l25.512">   </span>
<a href="#l25.513"></a><span id="l25.513">   NSEnumerator *enumerator = [mutableArray objectEnumerator];</span>
<a href="#l25.514"></a><span id="l25.514">   ABRecord *card;</span>
<a href="#l25.515"></a><span id="l25.515">   nsCOMPtr&lt;nsIAbCard&gt; abCard;</span>
<a href="#l25.516"></a><span id="l25.516" class="difflineminus">-  while ((card = [enumerator nextObject])) {</span>
<a href="#l25.517"></a><span id="l25.517" class="difflineminus">-    rv = ConvertToCard(gRDFService, card, getter_AddRefs(abCard));</span>
<a href="#l25.518"></a><span id="l25.518" class="difflineplus">+  nsCOMPtr&lt;nsIAbOSXDirectory&gt; rootOSXDirectory;</span>
<a href="#l25.519"></a><span id="l25.519" class="difflineplus">+  rv = GetRootOSXDirectory(getter_AddRefs(rootOSXDirectory));</span>
<a href="#l25.520"></a><span id="l25.520" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.521"></a><span id="l25.521" class="difflineplus">+</span>
<a href="#l25.522"></a><span id="l25.522" class="difflineplus">+  while ((card = [enumerator nextObject]))</span>
<a href="#l25.523"></a><span id="l25.523" class="difflineplus">+  {</span>
<a href="#l25.524"></a><span id="l25.524" class="difflineplus">+    rv = GetCard(card, getter_AddRefs(abCard), rootOSXDirectory);</span>
<a href="#l25.525"></a><span id="l25.525" class="difflineplus">+    if (NS_FAILED(rv))</span>
<a href="#l25.526"></a><span id="l25.526" class="difflineplus">+      rv = CreateCard(card, getter_AddRefs(abCard));</span>
<a href="#l25.527"></a><span id="l25.527">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.528"></a><span id="l25.528" class="difflineminus">-</span>
<a href="#l25.529"></a><span id="l25.529">     AssertCard(abManager, abCard);</span>
<a href="#l25.530"></a><span id="l25.530">   }</span>
<a href="#l25.531"></a><span id="l25.531">   </span>
<a href="#l25.532"></a><span id="l25.532">   card = (ABRecord*)[addressBook recordForUniqueId:[NSString stringWithUTF8String:nsCAutoString(Substring(mURINoQuery, 21)).get()]];</span>
<a href="#l25.533"></a><span id="l25.533">   NSString * stringValue = [card valueForProperty:kABGroupNameProperty];</span>
<a href="#l25.534"></a><span id="l25.534" class="difflineminus">-  if (![stringValue isEqualToString:WrapString(m_ListDirName)]) {</span>
<a href="#l25.535"></a><span id="l25.535" class="difflineplus">+  if (![stringValue isEqualToString:WrapString(m_ListDirName)])</span>
<a href="#l25.536"></a><span id="l25.536" class="difflineplus">+  {</span>
<a href="#l25.537"></a><span id="l25.537">     nsAutoString oldValue(m_ListDirName);</span>
<a href="#l25.538"></a><span id="l25.538">     AssignToString(stringValue, m_ListDirName);</span>
<a href="#l25.539"></a><span id="l25.539" class="difflineminus">-    nsISupports *supports =</span>
<a href="#l25.540"></a><span id="l25.540" class="difflineminus">-      NS_ISUPPORTS_CAST(nsAbDirectoryRDFResource*, this);</span>
<a href="#l25.541"></a><span id="l25.541" class="difflineplus">+    nsCOMPtr&lt;nsISupports&gt; supports = do_QueryInterface(static_cast&lt;nsIAbDirectory *&gt;(this), &amp;rv);</span>
<a href="#l25.542"></a><span id="l25.542" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.543"></a><span id="l25.543">     abManager-&gt;NotifyItemPropertyChanged(supports, &quot;DirName&quot;,</span>
<a href="#l25.544"></a><span id="l25.544">                                          oldValue.get(), m_ListDirName.get());</span>
<a href="#l25.545"></a><span id="l25.545">   }</span>
<a href="#l25.546"></a><span id="l25.546">   </span>
<a href="#l25.547"></a><span id="l25.547" class="difflineminus">-  if (groups) {</span>
<a href="#l25.548"></a><span id="l25.548" class="difflineplus">+  if (groups)</span>
<a href="#l25.549"></a><span id="l25.549" class="difflineplus">+  {</span>
<a href="#l25.550"></a><span id="l25.550">     mutableArray = [NSMutableArray arrayWithArray:groups];</span>
<a href="#l25.551"></a><span id="l25.551">     nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l25.552"></a><span id="l25.552">     // It is ok to use m_AddressList here as only top-level directories have</span>
<a href="#l25.553"></a><span id="l25.553">     // groups, and they will be in m_AddressList</span>
<a href="#l25.554"></a><span id="l25.554" class="difflineminus">-    if (m_AddressList) {</span>
<a href="#l25.555"></a><span id="l25.555" class="difflineplus">+    if (m_AddressList)</span>
<a href="#l25.556"></a><span id="l25.556" class="difflineplus">+    {</span>
<a href="#l25.557"></a><span id="l25.557">       rv = m_AddressList-&gt;GetLength(&amp;addressCount);</span>
<a href="#l25.558"></a><span id="l25.558">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.559"></a><span id="l25.559"> </span>
<a href="#l25.560"></a><span id="l25.560">       while (addressCount--)</span>
<a href="#l25.561"></a><span id="l25.561">       {</span>
<a href="#l25.562"></a><span id="l25.562">         directory = do_QueryElementAt(m_AddressList, addressCount, &amp;rv);</span>
<a href="#l25.563"></a><span id="l25.563">         if (NS_FAILED(rv))</span>
<a href="#l25.564"></a><span id="l25.564">           continue;</span>
<a href="#l25.565"></a><span id="l25.565" class="difflineat">@@ -673,18 +785,17 @@ nsAbOSXDirectory::Update()</span>
<a href="#l25.566"></a><span id="l25.566">         if (j == arrayCount) {</span>
<a href="#l25.567"></a><span id="l25.567">           UnassertDirectory(abManager, directory);</span>
<a href="#l25.568"></a><span id="l25.568">         }</span>
<a href="#l25.569"></a><span id="l25.569">       }</span>
<a href="#l25.570"></a><span id="l25.570">     }</span>
<a href="#l25.571"></a><span id="l25.571">     </span>
<a href="#l25.572"></a><span id="l25.572">     enumerator = [mutableArray objectEnumerator];</span>
<a href="#l25.573"></a><span id="l25.573">     while ((card = [enumerator nextObject])) {</span>
<a href="#l25.574"></a><span id="l25.574" class="difflineminus">-      rv = ConvertToGroupResource(gRDFService, [card uniqueId],</span>
<a href="#l25.575"></a><span id="l25.575" class="difflineminus">-                                  getter_AddRefs(directory));</span>
<a href="#l25.576"></a><span id="l25.576" class="difflineplus">+      rv = GetOrCreateGroup([card uniqueId], getter_AddRefs(directory));</span>
<a href="#l25.577"></a><span id="l25.577">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.578"></a><span id="l25.578">       </span>
<a href="#l25.579"></a><span id="l25.579">       AssertDirectory(abManager, directory);</span>
<a href="#l25.580"></a><span id="l25.580">     }</span>
<a href="#l25.581"></a><span id="l25.581">   }</span>
<a href="#l25.582"></a><span id="l25.582">   </span>
<a href="#l25.583"></a><span id="l25.583">   return NS_OK;</span>
<a href="#l25.584"></a><span id="l25.584"> }</span>
<a href="#l25.585"></a><span id="l25.585" class="difflineat">@@ -708,18 +819,18 @@ nsAbOSXDirectory::AssertChildNodes()</span>
<a href="#l25.586"></a><span id="l25.586">   </span>
<a href="#l25.587"></a><span id="l25.587">   if (count &gt; 0 &amp;&amp; !m_AddressList) {</span>
<a href="#l25.588"></a><span id="l25.588">     m_AddressList = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l25.589"></a><span id="l25.589">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.590"></a><span id="l25.590">   }</span>
<a href="#l25.591"></a><span id="l25.591">   </span>
<a href="#l25.592"></a><span id="l25.592">   nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l25.593"></a><span id="l25.593">   for (i = 0; i &lt; count; ++i) {</span>
<a href="#l25.594"></a><span id="l25.594" class="difflineminus">-    rv = ConvertToGroupResource(gRDFService, [[groups objectAtIndex:i] uniqueId],</span>
<a href="#l25.595"></a><span id="l25.595" class="difflineminus">-                                getter_AddRefs(directory));</span>
<a href="#l25.596"></a><span id="l25.596" class="difflineplus">+    rv = GetOrCreateGroup([[groups objectAtIndex:i] uniqueId],</span>
<a href="#l25.597"></a><span id="l25.597" class="difflineplus">+                          getter_AddRefs(directory));</span>
<a href="#l25.598"></a><span id="l25.598">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.599"></a><span id="l25.599">     </span>
<a href="#l25.600"></a><span id="l25.600">     rv = AssertDirectory(abManager, directory);</span>
<a href="#l25.601"></a><span id="l25.601">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.602"></a><span id="l25.602">   }</span>
<a href="#l25.603"></a><span id="l25.603">   </span>
<a href="#l25.604"></a><span id="l25.604">   return NS_OK;</span>
<a href="#l25.605"></a><span id="l25.605"> }</span>
<a href="#l25.606"></a><span id="l25.606" class="difflineat">@@ -753,16 +864,27 @@ nsAbOSXDirectory::AssertCard(nsIAbManage</span>
<a href="#l25.607"></a><span id="l25.607">   nsCAutoString ourUuid;</span>
<a href="#l25.608"></a><span id="l25.608">   GetUuid(ourUuid);</span>
<a href="#l25.609"></a><span id="l25.609">   aCard-&gt;SetDirectoryId(ourUuid);</span>
<a href="#l25.610"></a><span id="l25.610"> </span>
<a href="#l25.611"></a><span id="l25.611">   nsresult rv = m_IsMailList ? m_AddressList-&gt;AppendElement(aCard, PR_FALSE) :</span>
<a href="#l25.612"></a><span id="l25.612">                                mCardList-&gt;AppendElement(aCard, PR_FALSE);</span>
<a href="#l25.613"></a><span id="l25.613">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.614"></a><span id="l25.614"> </span>
<a href="#l25.615"></a><span id="l25.615" class="difflineplus">+  // Get the card's URI and add it to our card store</span>
<a href="#l25.616"></a><span id="l25.616" class="difflineplus">+  nsCOMPtr&lt;nsIAbOSXCard&gt; osxCard = do_QueryInterface(aCard, &amp;rv);</span>
<a href="#l25.617"></a><span id="l25.617" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.618"></a><span id="l25.618" class="difflineplus">+</span>
<a href="#l25.619"></a><span id="l25.619" class="difflineplus">+  nsCString uri;</span>
<a href="#l25.620"></a><span id="l25.620" class="difflineplus">+  rv = osxCard-&gt;GetURI(uri);</span>
<a href="#l25.621"></a><span id="l25.621" class="difflineplus">+</span>
<a href="#l25.622"></a><span id="l25.622" class="difflineplus">+  nsCOMPtr&lt;nsIAbOSXCard&gt; retrievedCard;</span>
<a href="#l25.623"></a><span id="l25.623" class="difflineplus">+  if (!mCardStore.Get(uri, getter_AddRefs(retrievedCard)))</span>
<a href="#l25.624"></a><span id="l25.624" class="difflineplus">+    mCardStore.Put(uri, osxCard);</span>
<a href="#l25.625"></a><span id="l25.625" class="difflineplus">+</span>
<a href="#l25.626"></a><span id="l25.626">   return aManager-&gt;NotifyDirectoryItemAdded(this, aCard);</span>
<a href="#l25.627"></a><span id="l25.627"> }</span>
<a href="#l25.628"></a><span id="l25.628"> </span>
<a href="#l25.629"></a><span id="l25.629"> nsresult</span>
<a href="#l25.630"></a><span id="l25.630"> nsAbOSXDirectory::UnassertCard(nsIAbManager *aManager,</span>
<a href="#l25.631"></a><span id="l25.631">                                nsIAbCard *aCard,</span>
<a href="#l25.632"></a><span id="l25.632">                                nsIMutableArray *aCardList)</span>
<a href="#l25.633"></a><span id="l25.633"> {</span>
<a href="#l25.634"></a><span id="l25.634" class="difflineat">@@ -831,20 +953,29 @@ nsAbOSXDirectory::GetChildCards(nsISimpl</span>
<a href="#l25.635"></a><span id="l25.635">     nsCAutoString ourUuid;</span>
<a href="#l25.636"></a><span id="l25.636">     GetUuid(ourUuid);</span>
<a href="#l25.637"></a><span id="l25.637"> </span>
<a href="#l25.638"></a><span id="l25.638">     // Fill the results array and update the card list</span>
<a href="#l25.639"></a><span id="l25.639">     unsigned int nbCards = [cards count];</span>
<a href="#l25.640"></a><span id="l25.640">   </span>
<a href="#l25.641"></a><span id="l25.641">     unsigned int i;</span>
<a href="#l25.642"></a><span id="l25.642">     nsCOMPtr&lt;nsIAbCard&gt; card;</span>
<a href="#l25.643"></a><span id="l25.643" class="difflineplus">+    nsCOMPtr&lt;nsIAbOSXDirectory&gt; rootOSXDirectory;</span>
<a href="#l25.644"></a><span id="l25.644" class="difflineplus">+    rv = GetRootOSXDirectory(getter_AddRefs(rootOSXDirectory));</span>
<a href="#l25.645"></a><span id="l25.645" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.646"></a><span id="l25.646" class="difflineplus">+</span>
<a href="#l25.647"></a><span id="l25.647">     for (i = 0; i &lt; nbCards; ++i)</span>
<a href="#l25.648"></a><span id="l25.648">     {</span>
<a href="#l25.649"></a><span id="l25.649" class="difflineminus">-      rv = ConvertToCard(gRDFService, [cards objectAtIndex:i],</span>
<a href="#l25.650"></a><span id="l25.650" class="difflineminus">-                         getter_AddRefs(card));</span>
<a href="#l25.651"></a><span id="l25.651" class="difflineplus">+      rv = GetCard([cards objectAtIndex:i], getter_AddRefs(card),</span>
<a href="#l25.652"></a><span id="l25.652" class="difflineplus">+                   rootOSXDirectory);</span>
<a href="#l25.653"></a><span id="l25.653" class="difflineplus">+</span>
<a href="#l25.654"></a><span id="l25.654" class="difflineplus">+      if (NS_FAILED(rv))</span>
<a href="#l25.655"></a><span id="l25.655" class="difflineplus">+        rv = CreateCard([cards objectAtIndex:i],</span>
<a href="#l25.656"></a><span id="l25.656" class="difflineplus">+                        getter_AddRefs(card));</span>
<a href="#l25.657"></a><span id="l25.657" class="difflineplus">+</span>
<a href="#l25.658"></a><span id="l25.658">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.659"></a><span id="l25.659">       card-&gt;SetDirectoryId(ourUuid);</span>
<a href="#l25.660"></a><span id="l25.660"> </span>
<a href="#l25.661"></a><span id="l25.661">       mCardList-&gt;AppendElement(card, PR_FALSE);</span>
<a href="#l25.662"></a><span id="l25.662">     }</span>
<a href="#l25.663"></a><span id="l25.663"> </span>
<a href="#l25.664"></a><span id="l25.664">     return NS_NewArrayEnumerator(aCards, mCardList);</span>
<a href="#l25.665"></a><span id="l25.665">   }</span>
<a href="#l25.666"></a><span id="l25.666" class="difflineat">@@ -857,16 +988,57 @@ nsAbOSXDirectory::GetChildCards(nsISimpl</span>
<a href="#l25.667"></a><span id="l25.667"> NS_IMETHODIMP</span>
<a href="#l25.668"></a><span id="l25.668"> nsAbOSXDirectory::GetIsQuery(PRBool *aResult)</span>
<a href="#l25.669"></a><span id="l25.669"> {</span>
<a href="#l25.670"></a><span id="l25.670">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l25.671"></a><span id="l25.671">   *aResult = mIsQueryURI;</span>
<a href="#l25.672"></a><span id="l25.672">   return NS_OK;</span>
<a href="#l25.673"></a><span id="l25.673"> }</span>
<a href="#l25.674"></a><span id="l25.674"> </span>
<a href="#l25.675"></a><span id="l25.675" class="difflineplus">+/* Recursive method that searches for a child card by URI.  If it cannot find</span>
<a href="#l25.676"></a><span id="l25.676" class="difflineplus">+ * it within this directory, it checks all subfolders.</span>
<a href="#l25.677"></a><span id="l25.677" class="difflineplus">+ */</span>
<a href="#l25.678"></a><span id="l25.678" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l25.679"></a><span id="l25.679" class="difflineplus">+nsAbOSXDirectory::GetCardByUri(const nsACString &amp;aUri, nsIAbOSXCard **aResult)</span>
<a href="#l25.680"></a><span id="l25.680" class="difflineplus">+{</span>
<a href="#l25.681"></a><span id="l25.681" class="difflineplus">+  nsCOMPtr&lt;nsIAbOSXCard&gt; osxCard;</span>
<a href="#l25.682"></a><span id="l25.682" class="difflineplus">+</span>
<a href="#l25.683"></a><span id="l25.683" class="difflineplus">+  // Base Case</span>
<a href="#l25.684"></a><span id="l25.684" class="difflineplus">+  if (mCardStore.Get(aUri, getter_AddRefs(osxCard)))</span>
<a href="#l25.685"></a><span id="l25.685" class="difflineplus">+  {</span>
<a href="#l25.686"></a><span id="l25.686" class="difflineplus">+    NS_IF_ADDREF(*aResult = osxCard);</span>
<a href="#l25.687"></a><span id="l25.687" class="difflineplus">+    return NS_OK;</span>
<a href="#l25.688"></a><span id="l25.688" class="difflineplus">+  }</span>
<a href="#l25.689"></a><span id="l25.689" class="difflineplus">+  // Search children</span>
<a href="#l25.690"></a><span id="l25.690" class="difflineplus">+  nsCOMPtr&lt;nsISimpleEnumerator&gt; enumerator;</span>
<a href="#l25.691"></a><span id="l25.691" class="difflineplus">+  nsresult rv = this-&gt;GetChildNodes(getter_AddRefs(enumerator));</span>
<a href="#l25.692"></a><span id="l25.692" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.693"></a><span id="l25.693" class="difflineplus">+</span>
<a href="#l25.694"></a><span id="l25.694" class="difflineplus">+  nsCOMPtr&lt;nsISupports&gt; item;</span>
<a href="#l25.695"></a><span id="l25.695" class="difflineplus">+  PRBool hasMore = PR_FALSE;</span>
<a href="#l25.696"></a><span id="l25.696" class="difflineplus">+  while (NS_SUCCEEDED(enumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore)</span>
<a href="#l25.697"></a><span id="l25.697" class="difflineplus">+  {</span>
<a href="#l25.698"></a><span id="l25.698" class="difflineplus">+    rv = enumerator-&gt;GetNext(getter_AddRefs(item));</span>
<a href="#l25.699"></a><span id="l25.699" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.700"></a><span id="l25.700" class="difflineplus">+</span>
<a href="#l25.701"></a><span id="l25.701" class="difflineplus">+    nsCOMPtr&lt;nsIAbOSXDirectory&gt; childDirectory;</span>
<a href="#l25.702"></a><span id="l25.702" class="difflineplus">+    childDirectory = do_QueryInterface(item, &amp;rv);</span>
<a href="#l25.703"></a><span id="l25.703" class="difflineplus">+    if (NS_SUCCEEDED(rv))</span>
<a href="#l25.704"></a><span id="l25.704" class="difflineplus">+    {</span>
<a href="#l25.705"></a><span id="l25.705" class="difflineplus">+      rv = childDirectory-&gt;GetCardByUri(aUri, getter_AddRefs(osxCard));</span>
<a href="#l25.706"></a><span id="l25.706" class="difflineplus">+      if (NS_SUCCEEDED(rv))</span>
<a href="#l25.707"></a><span id="l25.707" class="difflineplus">+      {</span>
<a href="#l25.708"></a><span id="l25.708" class="difflineplus">+        NS_IF_ADDREF(*aResult = osxCard);</span>
<a href="#l25.709"></a><span id="l25.709" class="difflineplus">+        return NS_OK;</span>
<a href="#l25.710"></a><span id="l25.710" class="difflineplus">+      }</span>
<a href="#l25.711"></a><span id="l25.711" class="difflineplus">+    }</span>
<a href="#l25.712"></a><span id="l25.712" class="difflineplus">+  }</span>
<a href="#l25.713"></a><span id="l25.713" class="difflineplus">+  return NS_ERROR_FAILURE;</span>
<a href="#l25.714"></a><span id="l25.714" class="difflineplus">+}</span>
<a href="#l25.715"></a><span id="l25.715" class="difflineplus">+</span>
<a href="#l25.716"></a><span id="l25.716"> NS_IMETHODIMP</span>
<a href="#l25.717"></a><span id="l25.717"> nsAbOSXDirectory::GetCardFromProperty(const char *aProperty,</span>
<a href="#l25.718"></a><span id="l25.718">                                       const nsACString &amp;aValue,</span>
<a href="#l25.719"></a><span id="l25.719">                                       PRBool aCaseSensitive,</span>
<a href="#l25.720"></a><span id="l25.720">                                       nsIAbCard **aResult)</span>
<a href="#l25.721"></a><span id="l25.721"> {</span>
<a href="#l25.722"></a><span id="l25.722">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l25.723"></a><span id="l25.723"> </span>
<a href="#l25.724"></a><span id="l25.724" class="difflineat">@@ -1098,23 +1270,23 @@ nsAbOSXDirectory::FallbackSearch(nsIAbBo</span>
<a href="#l25.725"></a><span id="l25.725">   // list, it won't have any subdirectories. If the current directory is an</span>
<a href="#l25.726"></a><span id="l25.726">   // addressbook, searching both it and the subdirectories (the mailing</span>
<a href="#l25.727"></a><span id="l25.727">   // lists), will yield duplicate results because every entry in a mailing</span>
<a href="#l25.728"></a><span id="l25.728">   // list will be an entry in the parent addressbook.</span>
<a href="#l25.729"></a><span id="l25.729">   rv = arguments-&gt;SetQuerySubDirectories(PR_FALSE);</span>
<a href="#l25.730"></a><span id="l25.730">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.731"></a><span id="l25.731">   </span>
<a href="#l25.732"></a><span id="l25.732">   // Get the directory without the query</span>
<a href="#l25.733"></a><span id="l25.733" class="difflineminus">-  nsCOMPtr&lt;nsIRDFResource&gt; resource;</span>
<a href="#l25.734"></a><span id="l25.734" class="difflineminus">-  rv = gRDFService-&gt;GetResource(mURINoQuery, getter_AddRefs(resource));</span>
<a href="#l25.735"></a><span id="l25.735" class="difflineplus">+  nsCOMPtr&lt;nsIAbManager&gt; abManager = do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l25.736"></a><span id="l25.736">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.737"></a><span id="l25.737" class="difflineminus">-  </span>
<a href="#l25.738"></a><span id="l25.738" class="difflineminus">-  nsCOMPtr&lt;nsIAbDirectory&gt; directory = do_QueryInterface(resource, &amp;rv);</span>
<a href="#l25.739"></a><span id="l25.739" class="difflineplus">+</span>
<a href="#l25.740"></a><span id="l25.740" class="difflineplus">+  nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l25.741"></a><span id="l25.741" class="difflineplus">+  rv = abManager-&gt;GetDirectory(nsDependentCString(mURINoQuery), getter_AddRefs(directory));</span>
<a href="#l25.742"></a><span id="l25.742">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.743"></a><span id="l25.743" class="difflineminus">-  </span>
<a href="#l25.744"></a><span id="l25.744" class="difflineplus">+</span>
<a href="#l25.745"></a><span id="l25.745">   // Initiate the proxy query with the no query directory</span>
<a href="#l25.746"></a><span id="l25.746">   nsCOMPtr&lt;nsIAbDirectoryQueryProxy&gt; queryProxy = </span>
<a href="#l25.747"></a><span id="l25.747">     do_CreateInstance(NS_ABDIRECTORYQUERYPROXY_CONTRACTID, &amp;rv);</span>
<a href="#l25.748"></a><span id="l25.748">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.749"></a><span id="l25.749">   </span>
<a href="#l25.750"></a><span id="l25.750">   rv = queryProxy-&gt;Initiate();</span>
<a href="#l25.751"></a><span id="l25.751">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.752"></a><span id="l25.752">   </span>
<a href="#l25.753"></a><span id="l25.753" class="difflineat">@@ -1147,32 +1319,39 @@ nsresult nsAbOSXDirectory::DeleteUid(con</span>
<a href="#l25.754"></a><span id="l25.754">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.755"></a><span id="l25.755"> </span>
<a href="#l25.756"></a><span id="l25.756">   nsCAutoString uri(NS_ABOSXDIRECTORY_URI_PREFIX);</span>
<a href="#l25.757"></a><span id="l25.757">   uri.Append(aUid);</span>
<a href="#l25.758"></a><span id="l25.758"> </span>
<a href="#l25.759"></a><span id="l25.759">   // Iterate backwards in case we remove something</span>
<a href="#l25.760"></a><span id="l25.760">   while (addressCount--)</span>
<a href="#l25.761"></a><span id="l25.761">   {</span>
<a href="#l25.762"></a><span id="l25.762" class="difflineminus">-    nsCOMPtr&lt;nsIRDFResource&gt; resource(do_QueryElementAt(m_AddressList,</span>
<a href="#l25.763"></a><span id="l25.763" class="difflineminus">-                                                        addressCount, &amp;rv));</span>
<a href="#l25.764"></a><span id="l25.764" class="difflineplus">+    nsCOMPtr&lt;nsIAbItem&gt; abItem(do_QueryElementAt(m_AddressList,</span>
<a href="#l25.765"></a><span id="l25.765" class="difflineplus">+                                                 addressCount, &amp;rv));</span>
<a href="#l25.766"></a><span id="l25.766" class="difflineplus">+    if (NS_FAILED(rv))</span>
<a href="#l25.767"></a><span id="l25.767" class="difflineplus">+      continue;</span>
<a href="#l25.768"></a><span id="l25.768" class="difflineplus">+</span>
<a href="#l25.769"></a><span id="l25.769" class="difflineplus">+    nsCOMPtr&lt;nsIAbDirectory&gt; directory(do_QueryInterface(abItem, &amp;rv));</span>
<a href="#l25.770"></a><span id="l25.770">     if (NS_SUCCEEDED(rv))</span>
<a href="#l25.771"></a><span id="l25.771">     {</span>
<a href="#l25.772"></a><span id="l25.772" class="difflineminus">-      const char* dirUri;</span>
<a href="#l25.773"></a><span id="l25.773" class="difflineminus">-      resource-&gt;GetValueConst(&amp;dirUri);</span>
<a href="#l25.774"></a><span id="l25.774" class="difflineplus">+      nsCAutoString dirUri;</span>
<a href="#l25.775"></a><span id="l25.775" class="difflineplus">+      directory-&gt;GetURI(dirUri);</span>
<a href="#l25.776"></a><span id="l25.776">       if (uri.Equals(dirUri))</span>
<a href="#l25.777"></a><span id="l25.777" class="difflineplus">+        return UnassertDirectory(abManager, directory);</span>
<a href="#l25.778"></a><span id="l25.778" class="difflineplus">+    } else {</span>
<a href="#l25.779"></a><span id="l25.779" class="difflineplus">+      nsCOMPtr&lt;nsIAbOSXCard&gt; osxCard(do_QueryInterface(abItem, &amp;rv));</span>
<a href="#l25.780"></a><span id="l25.780" class="difflineplus">+      if (NS_SUCCEEDED(rv))</span>
<a href="#l25.781"></a><span id="l25.781">       {</span>
<a href="#l25.782"></a><span id="l25.782" class="difflineminus">-        nsCOMPtr&lt;nsIAbDirectory&gt; directory(do_QueryInterface(resource, &amp;rv));</span>
<a href="#l25.783"></a><span id="l25.783" class="difflineminus">-        if (NS_SUCCEEDED(rv))</span>
<a href="#l25.784"></a><span id="l25.784" class="difflineminus">-          // Match found, do the necessary and get out of here.</span>
<a href="#l25.785"></a><span id="l25.785" class="difflineminus">-          return UnassertDirectory(abManager, directory);</span>
<a href="#l25.786"></a><span id="l25.786" class="difflineminus">-        else</span>
<a href="#l25.787"></a><span id="l25.787" class="difflineplus">+        nsCAutoString cardUri;</span>
<a href="#l25.788"></a><span id="l25.788" class="difflineplus">+        osxCard-&gt;GetURI(cardUri);</span>
<a href="#l25.789"></a><span id="l25.789" class="difflineplus">+        if (uri.Equals(cardUri))</span>
<a href="#l25.790"></a><span id="l25.790">         {</span>
<a href="#l25.791"></a><span id="l25.791" class="difflineminus">-          nsCOMPtr&lt;nsIAbCard&gt; card(do_QueryInterface(resource, &amp;rv));</span>
<a href="#l25.792"></a><span id="l25.792" class="difflineminus">-          return UnassertCard(abManager, card, m_AddressList);</span>
<a href="#l25.793"></a><span id="l25.793" class="difflineplus">+          nsCOMPtr&lt;nsIAbCard&gt; card(do_QueryInterface(osxCard, &amp;rv));</span>
<a href="#l25.794"></a><span id="l25.794" class="difflineplus">+          if (NS_SUCCEEDED(rv))</span>
<a href="#l25.795"></a><span id="l25.795" class="difflineplus">+            return UnassertCard(abManager, card, m_AddressList);</span>
<a href="#l25.796"></a><span id="l25.796">         }</span>
<a href="#l25.797"></a><span id="l25.797">       }</span>
<a href="#l25.798"></a><span id="l25.798">     }</span>
<a href="#l25.799"></a><span id="l25.799">   }</span>
<a href="#l25.800"></a><span id="l25.800"> </span>
<a href="#l25.801"></a><span id="l25.801">   // Second, see if it is one of the cards.</span>
<a href="#l25.802"></a><span id="l25.802">   if (!mCardList)</span>
<a href="#l25.803"></a><span id="l25.803">     return NS_ERROR_FAILURE;</span>
<a href="#l25.804"></a><span id="l25.804" class="difflineat">@@ -1180,24 +1359,23 @@ nsresult nsAbOSXDirectory::DeleteUid(con</span>
<a href="#l25.805"></a><span id="l25.805">   uri = NS_ABOSXCARD_URI_PREFIX;</span>
<a href="#l25.806"></a><span id="l25.806">   uri.Append(aUid);</span>
<a href="#l25.807"></a><span id="l25.807"> </span>
<a href="#l25.808"></a><span id="l25.808">   rv = mCardList-&gt;GetLength(&amp;addressCount);</span>
<a href="#l25.809"></a><span id="l25.809">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.810"></a><span id="l25.810"> </span>
<a href="#l25.811"></a><span id="l25.811">   while (addressCount--)</span>
<a href="#l25.812"></a><span id="l25.812">   {</span>
<a href="#l25.813"></a><span id="l25.813" class="difflineminus">-    nsCOMPtr&lt;nsIAbCard&gt; card(do_QueryElementAt(mCardList, addressCount, &amp;rv));</span>
<a href="#l25.814"></a><span id="l25.814" class="difflineplus">+    nsCOMPtr&lt;nsIAbOSXCard&gt; osxCard(do_QueryElementAt(mCardList, addressCount, &amp;rv));</span>
<a href="#l25.815"></a><span id="l25.815">     if (NS_FAILED(rv))</span>
<a href="#l25.816"></a><span id="l25.816">       continue;</span>
<a href="#l25.817"></a><span id="l25.817"> </span>
<a href="#l25.818"></a><span id="l25.818" class="difflineminus">-    nsCOMPtr&lt;nsIRDFResource&gt; resource(do_QueryInterface(card));</span>
<a href="#l25.819"></a><span id="l25.819" class="difflineminus">-    if (!resource)</span>
<a href="#l25.820"></a><span id="l25.820" class="difflineminus">-      continue;</span>
<a href="#l25.821"></a><span id="l25.821" class="difflineplus">+    nsCAutoString cardUri;</span>
<a href="#l25.822"></a><span id="l25.822" class="difflineplus">+    osxCard-&gt;GetURI(cardUri);</span>
<a href="#l25.823"></a><span id="l25.823"> </span>
<a href="#l25.824"></a><span id="l25.824" class="difflineminus">-    const char* cardUri;</span>
<a href="#l25.825"></a><span id="l25.825" class="difflineminus">-    resource-&gt;GetValueConst(&amp;cardUri);</span>
<a href="#l25.826"></a><span id="l25.826" class="difflineminus">-</span>
<a href="#l25.827"></a><span id="l25.827" class="difflineminus">-    if (uri.Equals(cardUri))</span>
<a href="#l25.828"></a><span id="l25.828" class="difflineminus">-      return UnassertCard(abManager, card, mCardList);</span>
<a href="#l25.829"></a><span id="l25.829" class="difflineplus">+    if (uri.Equals(cardUri)) {</span>
<a href="#l25.830"></a><span id="l25.830" class="difflineplus">+      nsCOMPtr&lt;nsIAbCard&gt; card(do_QueryInterface(osxCard, &amp;rv));</span>
<a href="#l25.831"></a><span id="l25.831" class="difflineplus">+      if (NS_SUCCEEDED(rv))</span>
<a href="#l25.832"></a><span id="l25.832" class="difflineplus">+        return UnassertCard(abManager, card, mCardList);</span>
<a href="#l25.833"></a><span id="l25.833" class="difflineplus">+    }</span>
<a href="#l25.834"></a><span id="l25.834">   }</span>
<a href="#l25.835"></a><span id="l25.835">   return NS_OK;</span>
<a href="#l25.836"></a><span id="l25.836"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbOutlookDirFactory.cpp</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbOutlookDirFactory.cpp</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -34,20 +34,17 @@</span>
<a href="#l26.4"></a><span id="l26.4">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l26.5"></a><span id="l26.5">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l26.6"></a><span id="l26.6">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l26.7"></a><span id="l26.7">  *</span>
<a href="#l26.8"></a><span id="l26.8">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l26.9"></a><span id="l26.9"> #include &quot;nsAbOutlookDirFactory.h&quot;</span>
<a href="#l26.10"></a><span id="l26.10"> #include &quot;nsAbWinHelper.h&quot;</span>
<a href="#l26.11"></a><span id="l26.11"> #include &quot;nsIAbDirectory.h&quot;</span>
<a href="#l26.12"></a><span id="l26.12" class="difflineminus">-</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineminus">-#include &quot;nsIRDFService.h&quot;</span>
<a href="#l26.14"></a><span id="l26.14" class="difflineminus">-#include &quot;nsIRDFResource.h&quot;</span>
<a href="#l26.15"></a><span id="l26.15" class="difflineminus">-#include &quot;nsRDFResource.h&quot;</span>
<a href="#l26.16"></a><span id="l26.16" class="difflineplus">+#include &quot;nsIAbManager.h&quot;</span>
<a href="#l26.17"></a><span id="l26.17"> #include &quot;nsEnumeratorUtils.h&quot;</span>
<a href="#l26.18"></a><span id="l26.18"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l26.19"></a><span id="l26.19"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l26.20"></a><span id="l26.20"> #include &quot;nsArrayEnumerator.h&quot;</span>
<a href="#l26.21"></a><span id="l26.21"> #include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l26.22"></a><span id="l26.22"> </span>
<a href="#l26.23"></a><span id="l26.23"> #include &quot;prlog.h&quot;</span>
<a href="#l26.24"></a><span id="l26.24"> </span>
<a href="#l26.25"></a><span id="l26.25" class="difflineat">@@ -92,30 +89,31 @@ nsAbOutlookDirFactory::GetDirectories(co</span>
<a href="#l26.26"></a><span id="l26.26">   nsAbWinHelperGuard mapiAddBook(abType);</span>
<a href="#l26.27"></a><span id="l26.27">   nsMapiEntryArray folders;</span>
<a href="#l26.28"></a><span id="l26.28">   ULONG nbFolders = 0;</span>
<a href="#l26.29"></a><span id="l26.29">   nsCOMPtr&lt;nsIMutableArray&gt; directories(do_CreateInstance(NS_ARRAY_CONTRACTID));</span>
<a href="#l26.30"></a><span id="l26.30">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.31"></a><span id="l26.31">   if (!mapiAddBook-&gt;IsOK() || !mapiAddBook-&gt;GetFolders(folders)) {</span>
<a href="#l26.32"></a><span id="l26.32">     return NS_ERROR_FAILURE;</span>
<a href="#l26.33"></a><span id="l26.33">   }</span>
<a href="#l26.34"></a><span id="l26.34" class="difflineminus">-  nsCOMPtr&lt;nsIRDFService&gt; rdf(do_GetService(NS_RDF_CONTRACTID &quot;/rdf-service;1&quot;, &amp;rv));</span>
<a href="#l26.35"></a><span id="l26.35" class="difflineplus">+</span>
<a href="#l26.36"></a><span id="l26.36" class="difflineplus">+  nsCOMPtr&lt;nsIAbManager&gt; abManager(do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv));</span>
<a href="#l26.37"></a><span id="l26.37">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.38"></a><span id="l26.38">   nsCAutoString entryId;</span>
<a href="#l26.39"></a><span id="l26.39">   nsCAutoString uri;</span>
<a href="#l26.40"></a><span id="l26.40" class="difflineminus">-  nsCOMPtr&lt;nsIRDFResource&gt; resource;</span>
<a href="#l26.41"></a><span id="l26.41"> </span>
<a href="#l26.42"></a><span id="l26.42">   for (ULONG i = 0; i &lt; folders.mNbEntries; ++i) {</span>
<a href="#l26.43"></a><span id="l26.43">     folders.mEntries[i].ToString(entryId);</span>
<a href="#l26.44"></a><span id="l26.44">     buildAbWinUri(kOutlookDirectoryScheme, abType, uri);</span>
<a href="#l26.45"></a><span id="l26.45">     uri.Append(entryId);</span>
<a href="#l26.46"></a><span id="l26.46"> </span>
<a href="#l26.47"></a><span id="l26.47" class="difflineminus">-    rv = rdf-&gt;GetResource(uri, getter_AddRefs(resource));</span>
<a href="#l26.48"></a><span id="l26.48" class="difflineplus">+	nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l26.49"></a><span id="l26.49" class="difflineplus">+	rv = abManager-&gt;GetDirectory(uri, getter_AddRefs(directory));</span>
<a href="#l26.50"></a><span id="l26.50">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.51"></a><span id="l26.51" class="difflineminus">-    directories-&gt;AppendElement(resource, PR_FALSE);</span>
<a href="#l26.52"></a><span id="l26.52" class="difflineplus">+    directories-&gt;AppendElement(directory, PR_FALSE);</span>
<a href="#l26.53"></a><span id="l26.53">   }</span>
<a href="#l26.54"></a><span id="l26.54">   return NS_NewArrayEnumerator(aDirectories, directories);</span>
<a href="#l26.55"></a><span id="l26.55"> }</span>
<a href="#l26.56"></a><span id="l26.56"> </span>
<a href="#l26.57"></a><span id="l26.57"> // No actual deletion, since you cannot create the address books from Mozilla.</span>
<a href="#l26.58"></a><span id="l26.58"> NS_IMETHODIMP nsAbOutlookDirFactory::DeleteDirectory(nsIAbDirectory *aDirectory)</span>
<a href="#l26.59"></a><span id="l26.59"> {</span>
<a href="#l26.60"></a><span id="l26.60">   return NS_OK;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbOutlookDirectory.cpp</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbOutlookDirectory.cpp</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -34,18 +34,16 @@</span>
<a href="#l27.4"></a><span id="l27.4">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l27.5"></a><span id="l27.5">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l27.6"></a><span id="l27.6">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l27.7"></a><span id="l27.7">  *</span>
<a href="#l27.8"></a><span id="l27.8">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l27.9"></a><span id="l27.9"> #include &quot;nsAbOutlookDirectory.h&quot;</span>
<a href="#l27.10"></a><span id="l27.10"> #include &quot;nsAbWinHelper.h&quot;</span>
<a href="#l27.11"></a><span id="l27.11"> </span>
<a href="#l27.12"></a><span id="l27.12" class="difflineminus">-#include &quot;nsIRDFService.h&quot;</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineminus">-</span>
<a href="#l27.14"></a><span id="l27.14"> #include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l27.15"></a><span id="l27.15"> #include &quot;nsIAbCard.h&quot;</span>
<a href="#l27.16"></a><span id="l27.16"> #include &quot;nsStringGlue.h&quot;</span>
<a href="#l27.17"></a><span id="l27.17"> #include &quot;nsAbDirectoryQuery.h&quot;</span>
<a href="#l27.18"></a><span id="l27.18"> #include &quot;nsIAbBooleanExpression.h&quot;</span>
<a href="#l27.19"></a><span id="l27.19"> #include &quot;nsIAbManager.h&quot;</span>
<a href="#l27.20"></a><span id="l27.20"> #include &quot;nsIAbMDBDirectory.h&quot;</span>
<a href="#l27.21"></a><span id="l27.21"> #include &quot;nsAbQueryStringToExpression.h&quot;</span>
<a href="#l27.22"></a><span id="l27.22" class="difflineat">@@ -65,43 +63,41 @@</span>
<a href="#l27.23"></a><span id="l27.23"> #ifdef PR_LOGGING</span>
<a href="#l27.24"></a><span id="l27.24"> static PRLogModuleInfo* gAbOutlookDirectoryLog</span>
<a href="#l27.25"></a><span id="l27.25">     = PR_NewLogModule(&quot;nsAbOutlookDirectoryLog&quot;);</span>
<a href="#l27.26"></a><span id="l27.26"> #endif</span>
<a href="#l27.27"></a><span id="l27.27"> </span>
<a href="#l27.28"></a><span id="l27.28"> #define PRINTF(args) PR_LOG(gAbOutlookDirectoryLog, PR_LOG_DEBUG, args)</span>
<a href="#l27.29"></a><span id="l27.29"> </span>
<a href="#l27.30"></a><span id="l27.30"> nsAbOutlookDirectory::nsAbOutlookDirectory(void)</span>
<a href="#l27.31"></a><span id="l27.31" class="difflineminus">-: nsAbDirectoryRDFResource(), nsAbDirProperty(),</span>
<a href="#l27.32"></a><span id="l27.32" class="difflineminus">-mCurrentQueryId(0), mSearchContext(-1),</span>
<a href="#l27.33"></a><span id="l27.33" class="difflineminus">-mAbWinType(nsAbWinType_Unknown), mMapiData(nsnull)</span>
<a href="#l27.34"></a><span id="l27.34" class="difflineplus">+  : nsAbDirProperty(),</span>
<a href="#l27.35"></a><span id="l27.35" class="difflineplus">+  mCurrentQueryId(0), mSearchContext(-1),</span>
<a href="#l27.36"></a><span id="l27.36" class="difflineplus">+  mAbWinType(nsAbWinType_Unknown), mMapiData(nsnull)</span>
<a href="#l27.37"></a><span id="l27.37"> {</span>
<a href="#l27.38"></a><span id="l27.38">     mMapiData = new nsMapiEntry ;</span>
<a href="#l27.39"></a><span id="l27.39">     mProtector = PR_NewLock() ;</span>
<a href="#l27.40"></a><span id="l27.40"> }</span>
<a href="#l27.41"></a><span id="l27.41"> </span>
<a href="#l27.42"></a><span id="l27.42"> nsAbOutlookDirectory::~nsAbOutlookDirectory(void)</span>
<a href="#l27.43"></a><span id="l27.43"> {</span>
<a href="#l27.44"></a><span id="l27.44">     if (mMapiData) { delete mMapiData ; }</span>
<a href="#l27.45"></a><span id="l27.45">     if (mProtector) { PR_DestroyLock(mProtector) ; }</span>
<a href="#l27.46"></a><span id="l27.46"> }</span>
<a href="#l27.47"></a><span id="l27.47"> </span>
<a href="#l27.48"></a><span id="l27.48" class="difflineminus">-NS_IMPL_ISUPPORTS_INHERITED4(nsAbOutlookDirectory, nsAbDirectoryRDFResource, </span>
<a href="#l27.49"></a><span id="l27.49" class="difflineminus">-                             nsIAbDirectory, nsISupportsWeakReference,</span>
<a href="#l27.50"></a><span id="l27.50" class="difflineplus">+NS_IMPL_ISUPPORTS_INHERITED3(nsAbOutlookDirectory, nsAbDirProperty,</span>
<a href="#l27.51"></a><span id="l27.51">                              nsIAbDirectoryQuery, nsIAbDirectorySearch,</span>
<a href="#l27.52"></a><span id="l27.52">                              nsIAbDirSearchListener)</span>
<a href="#l27.53"></a><span id="l27.53"> </span>
<a href="#l27.54"></a><span id="l27.54" class="difflineminus">-// nsIRDFResource method</span>
<a href="#l27.55"></a><span id="l27.55"> NS_IMETHODIMP nsAbOutlookDirectory::Init(const char *aUri)</span>
<a href="#l27.56"></a><span id="l27.56"> {</span>
<a href="#l27.57"></a><span id="l27.57">   NS_ENSURE_TRUE(mQueryThreads.Init(), NS_ERROR_FAILURE);</span>
<a href="#l27.58"></a><span id="l27.58">   NS_ENSURE_TRUE(mCardList.Init(), NS_ERROR_FAILURE);</span>
<a href="#l27.59"></a><span id="l27.59" class="difflineminus">-  nsresult retCode = nsAbDirectoryRDFResource::Init(aUri);</span>
<a href="#l27.60"></a><span id="l27.60"> </span>
<a href="#l27.61"></a><span id="l27.61" class="difflineminus">-  NS_ENSURE_SUCCESS(retCode, retCode);</span>
<a href="#l27.62"></a><span id="l27.62" class="difflineplus">+  nsresult rv = nsAbDirProperty::Init(aUri);</span>
<a href="#l27.63"></a><span id="l27.63" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l27.64"></a><span id="l27.64"> </span>
<a href="#l27.65"></a><span id="l27.65">   nsCAutoString entry;</span>
<a href="#l27.66"></a><span id="l27.66">   nsCAutoString stub;</span>
<a href="#l27.67"></a><span id="l27.67"> </span>
<a href="#l27.68"></a><span id="l27.68">   mAbWinType = getAbWinType(kOutlookDirectoryScheme, mURINoQuery.get(), stub, entry);</span>
<a href="#l27.69"></a><span id="l27.69">   if (mAbWinType == nsAbWinType_Unknown) {</span>
<a href="#l27.70"></a><span id="l27.70">     PRINTF((&quot;Huge problem URI=%s.\n&quot;, mURINoQuery));</span>
<a href="#l27.71"></a><span id="l27.71">     return NS_ERROR_INVALID_ARG;</span>
<a href="#l27.72"></a><span id="l27.72" class="difflineat">@@ -177,153 +173,144 @@ NS_IMETHODIMP nsAbOutlookDirectory::GetC</span>
<a href="#l27.73"></a><span id="l27.73">   rv = GetChildNodes(nodeList);</span>
<a href="#l27.74"></a><span id="l27.74">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l27.75"></a><span id="l27.75"> </span>
<a href="#l27.76"></a><span id="l27.76">   return NS_NewArrayEnumerator(aNodes, nodeList);</span>
<a href="#l27.77"></a><span id="l27.77"> }</span>
<a href="#l27.78"></a><span id="l27.78"> </span>
<a href="#l27.79"></a><span id="l27.79"> NS_IMETHODIMP nsAbOutlookDirectory::GetChildCards(nsISimpleEnumerator **aCards)</span>
<a href="#l27.80"></a><span id="l27.80"> {</span>
<a href="#l27.81"></a><span id="l27.81" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aCards);</span>
<a href="#l27.82"></a><span id="l27.82" class="difflineminus">-</span>
<a href="#l27.83"></a><span id="l27.83" class="difflineminus">-    *aCards = nsnull;</span>
<a href="#l27.84"></a><span id="l27.84" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aCards);</span>
<a href="#l27.85"></a><span id="l27.85" class="difflineplus">+  *aCards = nsnull;</span>
<a href="#l27.86"></a><span id="l27.86"> </span>
<a href="#l27.87"></a><span id="l27.87" class="difflineminus">-    nsresult retCode;</span>
<a href="#l27.88"></a><span id="l27.88" class="difflineminus">-    nsCOMPtr&lt;nsIMutableArray&gt; cardList(do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;retCode));</span>
<a href="#l27.89"></a><span id="l27.89" class="difflineplus">+  nsresult rv;</span>
<a href="#l27.90"></a><span id="l27.90" class="difflineplus">+  nsCOMPtr&lt;nsIMutableArray&gt; cardList(do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l27.91"></a><span id="l27.91" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l27.92"></a><span id="l27.92"> </span>
<a href="#l27.93"></a><span id="l27.93" class="difflineminus">-    mCardList.Clear();</span>
<a href="#l27.94"></a><span id="l27.94" class="difflineplus">+  mCardList.Clear();</span>
<a href="#l27.95"></a><span id="l27.95"> </span>
<a href="#l27.96"></a><span id="l27.96" class="difflineminus">-    retCode = mIsQueryURI ? StartSearch() : GetChildCards(cardList, nsnull);</span>
<a href="#l27.97"></a><span id="l27.97" class="difflineplus">+  rv = mIsQueryURI ? StartSearch() : GetChildCards(cardList, nsnull);</span>
<a href="#l27.98"></a><span id="l27.98"> </span>
<a href="#l27.99"></a><span id="l27.99" class="difflineminus">-    if (NS_SUCCEEDED(retCode)) {</span>
<a href="#l27.100"></a><span id="l27.100" class="difflineminus">-        if (!m_AddressList)</span>
<a href="#l27.101"></a><span id="l27.101" class="difflineminus">-        {</span>
<a href="#l27.102"></a><span id="l27.102" class="difflineminus">-          m_AddressList = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;retCode);</span>
<a href="#l27.103"></a><span id="l27.103" class="difflineminus">-          NS_ENSURE_SUCCESS(retCode, retCode);</span>
<a href="#l27.104"></a><span id="l27.104" class="difflineminus">-        }</span>
<a href="#l27.105"></a><span id="l27.105" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l27.106"></a><span id="l27.106" class="difflineplus">+  if (!m_AddressList)</span>
<a href="#l27.107"></a><span id="l27.107" class="difflineplus">+  {</span>
<a href="#l27.108"></a><span id="l27.108" class="difflineplus">+    m_AddressList = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l27.109"></a><span id="l27.109" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l27.110"></a><span id="l27.110" class="difflineplus">+  }</span>
<a href="#l27.111"></a><span id="l27.111"> </span>
<a href="#l27.112"></a><span id="l27.112" class="difflineminus">-        // Fill the results array and update the card list</span>
<a href="#l27.113"></a><span id="l27.113" class="difflineminus">-        // Also update the address list and notify any changes.</span>
<a href="#l27.114"></a><span id="l27.114" class="difflineminus">-        PRUint32 nbCards = 0 ;</span>
<a href="#l27.115"></a><span id="l27.115" class="difflineminus">-        </span>
<a href="#l27.116"></a><span id="l27.116" class="difflineminus">-        NS_NewArrayEnumerator(aCards, cardList);</span>
<a href="#l27.117"></a><span id="l27.117" class="difflineminus">-        cardList-&gt;GetLength(&amp;nbCards);</span>
<a href="#l27.118"></a><span id="l27.118" class="difflineplus">+  // Fill the results array and update the card list</span>
<a href="#l27.119"></a><span id="l27.119" class="difflineplus">+  // Also update the address list and notify any changes.</span>
<a href="#l27.120"></a><span id="l27.120" class="difflineplus">+  PRUint32 nbCards = 0;</span>
<a href="#l27.121"></a><span id="l27.121"> </span>
<a href="#l27.122"></a><span id="l27.122" class="difflineminus">-        nsCOMPtr&lt;nsIAbCard&gt; card;</span>
<a href="#l27.123"></a><span id="l27.123" class="difflineplus">+  NS_NewArrayEnumerator(aCards, cardList);</span>
<a href="#l27.124"></a><span id="l27.124" class="difflineplus">+  cardList-&gt;GetLength(&amp;nbCards);</span>
<a href="#l27.125"></a><span id="l27.125"> </span>
<a href="#l27.126"></a><span id="l27.126" class="difflineminus">-        for (PRUint32 i = 0; i &lt; nbCards; ++i) {</span>
<a href="#l27.127"></a><span id="l27.127" class="difflineminus">-            card = do_QueryElementAt(cardList, i, &amp;retCode);</span>
<a href="#l27.128"></a><span id="l27.128" class="difflineminus">-            if (NS_FAILED(retCode))</span>
<a href="#l27.129"></a><span id="l27.129" class="difflineminus">-              continue;</span>
<a href="#l27.130"></a><span id="l27.130" class="difflineplus">+  nsCOMPtr&lt;nsIAbCard&gt; card;</span>
<a href="#l27.131"></a><span id="l27.131" class="difflineplus">+  nsCOMPtr&lt;nsIAbManager&gt; abManager(do_GetService(NS_ABMANAGER_CONTRACTID,</span>
<a href="#l27.132"></a><span id="l27.132" class="difflineplus">+                                   &amp;rv));</span>
<a href="#l27.133"></a><span id="l27.133" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l27.134"></a><span id="l27.134" class="difflineplus">+</span>
<a href="#l27.135"></a><span id="l27.135"> </span>
<a href="#l27.136"></a><span id="l27.136" class="difflineminus">-            if (!mCardList.Get(card, nsnull)) {</span>
<a href="#l27.137"></a><span id="l27.137" class="difflineminus">-                // We are dealing with a new element (probably directly</span>
<a href="#l27.138"></a><span id="l27.138" class="difflineminus">-                // added from Outlook), we may need to sync m_AddressList</span>
<a href="#l27.139"></a><span id="l27.139" class="difflineminus">-                mCardList.Put(card, card);</span>
<a href="#l27.140"></a><span id="l27.140" class="difflineminus">-</span>
<a href="#l27.141"></a><span id="l27.141" class="difflineminus">-                PRBool isMailList = PR_FALSE ;</span>
<a href="#l27.142"></a><span id="l27.142" class="difflineplus">+  for (PRUint32 i = 0; i &lt; nbCards; ++i)</span>
<a href="#l27.143"></a><span id="l27.143" class="difflineplus">+  {</span>
<a href="#l27.144"></a><span id="l27.144" class="difflineplus">+    card = do_QueryElementAt(cardList, i, &amp;rv);</span>
<a href="#l27.145"></a><span id="l27.145" class="difflineplus">+    if (NS_FAILED(rv))</span>
<a href="#l27.146"></a><span id="l27.146" class="difflineplus">+      continue;</span>
<a href="#l27.147"></a><span id="l27.147"> </span>
<a href="#l27.148"></a><span id="l27.148" class="difflineminus">-                retCode = card-&gt;GetIsMailList(&amp;isMailList) ;</span>
<a href="#l27.149"></a><span id="l27.149" class="difflineminus">-                NS_ENSURE_SUCCESS(retCode, retCode) ;</span>
<a href="#l27.150"></a><span id="l27.150" class="difflineminus">-                if (isMailList) {</span>
<a href="#l27.151"></a><span id="l27.151" class="difflineminus">-                    // We can have mailing lists only in folder, </span>
<a href="#l27.152"></a><span id="l27.152" class="difflineminus">-                    // we must add the directory to m_AddressList</span>
<a href="#l27.153"></a><span id="l27.153" class="difflineminus">-                    nsCString mailListUri;</span>
<a href="#l27.154"></a><span id="l27.154" class="difflineplus">+    if (!mCardList.Get(card, nsnull))</span>
<a href="#l27.155"></a><span id="l27.155" class="difflineplus">+    {</span>
<a href="#l27.156"></a><span id="l27.156" class="difflineplus">+      // We are dealing with a new element (probably directly</span>
<a href="#l27.157"></a><span id="l27.157" class="difflineplus">+      // added from Outlook), we may need to sync m_AddressList</span>
<a href="#l27.158"></a><span id="l27.158" class="difflineplus">+      mCardList.Put(card, card);</span>
<a href="#l27.159"></a><span id="l27.159"> </span>
<a href="#l27.160"></a><span id="l27.160" class="difflineminus">-                    retCode = card-&gt;GetMailListURI(getter_Copies(mailListUri)) ;</span>
<a href="#l27.161"></a><span id="l27.161" class="difflineminus">-                    NS_ENSURE_SUCCESS(retCode, retCode) ;</span>
<a href="#l27.162"></a><span id="l27.162" class="difflineminus">-                    nsCOMPtr&lt;nsIRDFResource&gt; resource ;</span>
<a href="#l27.163"></a><span id="l27.163" class="difflineplus">+      PRBool isMailList = PR_FALSE;</span>
<a href="#l27.164"></a><span id="l27.164"> </span>
<a href="#l27.165"></a><span id="l27.165" class="difflineminus">-                    retCode = gRDFService-&gt;GetResource(mailListUri, getter_AddRefs(resource)) ;</span>
<a href="#l27.166"></a><span id="l27.166" class="difflineminus">-                    NS_ENSURE_SUCCESS(retCode, retCode) ;</span>
<a href="#l27.167"></a><span id="l27.167" class="difflineminus">-                    nsCOMPtr&lt;nsIAbDirectory&gt; mailList(do_QueryInterface(resource, &amp;retCode)) ;</span>
<a href="#l27.168"></a><span id="l27.168" class="difflineminus">-                    </span>
<a href="#l27.169"></a><span id="l27.169" class="difflineminus">-                    NS_ENSURE_SUCCESS(retCode, retCode) ;</span>
<a href="#l27.170"></a><span id="l27.170" class="difflineminus">-                    m_AddressList-&gt;AppendElement(mailList, PR_FALSE);</span>
<a href="#l27.171"></a><span id="l27.171" class="difflineminus">-                    NotifyItemAddition(mailList) ;</span>
<a href="#l27.172"></a><span id="l27.172" class="difflineminus">-                }</span>
<a href="#l27.173"></a><span id="l27.173" class="difflineminus">-                else if (m_IsMailList) {</span>
<a href="#l27.174"></a><span id="l27.174" class="difflineminus">-                    m_AddressList-&gt;AppendElement(card, PR_FALSE);</span>
<a href="#l27.175"></a><span id="l27.175" class="difflineminus">-                    NotifyItemAddition(card) ;</span>
<a href="#l27.176"></a><span id="l27.176" class="difflineminus">-                }</span>
<a href="#l27.177"></a><span id="l27.177" class="difflineminus">-            }</span>
<a href="#l27.178"></a><span id="l27.178" class="difflineminus">-            else</span>
<a href="#l27.179"></a><span id="l27.179" class="difflineminus">-              NS_WARNING(&quot;Card wasn't stored&quot;);</span>
<a href="#l27.180"></a><span id="l27.180" class="difflineminus">-        }</span>
<a href="#l27.181"></a><span id="l27.181" class="difflineplus">+      rv = card-&gt;GetIsMailList(&amp;isMailList);</span>
<a href="#l27.182"></a><span id="l27.182" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l27.183"></a><span id="l27.183" class="difflineplus">+      if (isMailList)</span>
<a href="#l27.184"></a><span id="l27.184" class="difflineplus">+      {</span>
<a href="#l27.185"></a><span id="l27.185" class="difflineplus">+        // We can have mailing lists only in folder,</span>
<a href="#l27.186"></a><span id="l27.186" class="difflineplus">+        // we must add the directory to m_AddressList</span>
<a href="#l27.187"></a><span id="l27.187" class="difflineplus">+        nsCString mailListUri;</span>
<a href="#l27.188"></a><span id="l27.188" class="difflineplus">+        rv = card-&gt;GetMailListURI(getter_Copies(mailListUri));</span>
<a href="#l27.189"></a><span id="l27.189" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l27.190"></a><span id="l27.190" class="difflineplus">+        nsCOMPtr&lt;nsIAbDirectory&gt; mailList;</span>
<a href="#l27.191"></a><span id="l27.191" class="difflineplus">+        rv = abManager-&gt;GetDirectory(mailListUri, getter_AddRefs(mailList));</span>
<a href="#l27.192"></a><span id="l27.192" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l27.193"></a><span id="l27.193" class="difflineplus">+</span>
<a href="#l27.194"></a><span id="l27.194" class="difflineplus">+        m_AddressList-&gt;AppendElement(mailList, PR_FALSE);</span>
<a href="#l27.195"></a><span id="l27.195" class="difflineplus">+        NotifyItemAddition(mailList);</span>
<a href="#l27.196"></a><span id="l27.196" class="difflineplus">+      }</span>
<a href="#l27.197"></a><span id="l27.197" class="difflineplus">+      else if (m_IsMailList)</span>
<a href="#l27.198"></a><span id="l27.198" class="difflineplus">+      {</span>
<a href="#l27.199"></a><span id="l27.199" class="difflineplus">+        m_AddressList-&gt;AppendElement(card, PR_FALSE);</span>
<a href="#l27.200"></a><span id="l27.200" class="difflineplus">+        NotifyItemAddition(card);</span>
<a href="#l27.201"></a><span id="l27.201" class="difflineplus">+      }</span>
<a href="#l27.202"></a><span id="l27.202">     }</span>
<a href="#l27.203"></a><span id="l27.203" class="difflineminus">-    return retCode ;</span>
<a href="#l27.204"></a><span id="l27.204" class="difflineplus">+  }</span>
<a href="#l27.205"></a><span id="l27.205" class="difflineplus">+  return rv;</span>
<a href="#l27.206"></a><span id="l27.206"> }</span>
<a href="#l27.207"></a><span id="l27.207"> </span>
<a href="#l27.208"></a><span id="l27.208"> NS_IMETHODIMP nsAbOutlookDirectory::GetIsQuery(PRBool *aResult)</span>
<a href="#l27.209"></a><span id="l27.209"> {</span>
<a href="#l27.210"></a><span id="l27.210">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l27.211"></a><span id="l27.211">   *aResult = mIsQueryURI;</span>
<a href="#l27.212"></a><span id="l27.212">   return NS_OK;</span>
<a href="#l27.213"></a><span id="l27.213"> }</span>
<a href="#l27.214"></a><span id="l27.214"> </span>
<a href="#l27.215"></a><span id="l27.215"> NS_IMETHODIMP nsAbOutlookDirectory::HasCard(nsIAbCard *aCard, PRBool *aHasCard)</span>
<a href="#l27.216"></a><span id="l27.216"> {</span>
<a href="#l27.217"></a><span id="l27.217" class="difflineminus">-    if (!aCard || !aHasCard) { return NS_ERROR_NULL_POINTER ; }</span>
<a href="#l27.218"></a><span id="l27.218" class="difflineminus">-    *aHasCard = mCardList.Get(aCard, nsnull);</span>
<a href="#l27.219"></a><span id="l27.219" class="difflineminus">-    return NS_OK ;</span>
<a href="#l27.220"></a><span id="l27.220" class="difflineplus">+  if (!aCard || !aHasCard)</span>
<a href="#l27.221"></a><span id="l27.221" class="difflineplus">+    return NS_ERROR_NULL_POINTER;</span>
<a href="#l27.222"></a><span id="l27.222" class="difflineplus">+</span>
<a href="#l27.223"></a><span id="l27.223" class="difflineplus">+  *aHasCard = mCardList.Get(aCard, nsnull);</span>
<a href="#l27.224"></a><span id="l27.224" class="difflineplus">+  return NS_OK;</span>
<a href="#l27.225"></a><span id="l27.225"> }</span>
<a href="#l27.226"></a><span id="l27.226"> </span>
<a href="#l27.227"></a><span id="l27.227"> NS_IMETHODIMP nsAbOutlookDirectory::HasDirectory(nsIAbDirectory *aDirectory, PRBool *aHasDirectory)</span>
<a href="#l27.228"></a><span id="l27.228"> {</span>
<a href="#l27.229"></a><span id="l27.229" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aDirectory);</span>
<a href="#l27.230"></a><span id="l27.230" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aHasDirectory);</span>
<a href="#l27.231"></a><span id="l27.231" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aDirectory);</span>
<a href="#l27.232"></a><span id="l27.232" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aHasDirectory);</span>
<a href="#l27.233"></a><span id="l27.233" class="difflineplus">+</span>
<a href="#l27.234"></a><span id="l27.234" class="difflineplus">+  *aHasDirectory = PR_FALSE;</span>
<a href="#l27.235"></a><span id="l27.235"> </span>
<a href="#l27.236"></a><span id="l27.236" class="difflineminus">-    *aHasDirectory = PR_FALSE;</span>
<a href="#l27.237"></a><span id="l27.237" class="difflineminus">-    </span>
<a href="#l27.238"></a><span id="l27.238" class="difflineminus">-    PRUint32 pos;</span>
<a href="#l27.239"></a><span id="l27.239" class="difflineminus">-    if (m_AddressList &amp;&amp; NS_SUCCEEDED(m_AddressList-&gt;IndexOf(0, aDirectory, &amp;pos)))</span>
<a href="#l27.240"></a><span id="l27.240" class="difflineminus">-        *aHasDirectory = PR_TRUE;</span>
<a href="#l27.241"></a><span id="l27.241" class="difflineplus">+  PRUint32 pos;</span>
<a href="#l27.242"></a><span id="l27.242" class="difflineplus">+  if (m_AddressList &amp;&amp; NS_SUCCEEDED(m_AddressList-&gt;IndexOf(0, aDirectory, &amp;pos)))</span>
<a href="#l27.243"></a><span id="l27.243" class="difflineplus">+      *aHasDirectory = PR_TRUE;</span>
<a href="#l27.244"></a><span id="l27.244"> </span>
<a href="#l27.245"></a><span id="l27.245" class="difflineminus">-    return NS_OK ;</span>
<a href="#l27.246"></a><span id="l27.246" class="difflineplus">+  return NS_OK;</span>
<a href="#l27.247"></a><span id="l27.247"> }</span>
<a href="#l27.248"></a><span id="l27.248"> </span>
<a href="#l27.249"></a><span id="l27.249" class="difflineminus">-static nsresult ExtractEntryFromUri(nsIRDFResource *aResource, nsCString &amp;aEntry,</span>
<a href="#l27.250"></a><span id="l27.250" class="difflineminus">-                                    const char *aPrefix)</span>
<a href="#l27.251"></a><span id="l27.251" class="difflineminus">-{</span>
<a href="#l27.252"></a><span id="l27.252" class="difflineminus">-    aEntry.Truncate() ;</span>
<a href="#l27.253"></a><span id="l27.253" class="difflineminus">-    if (!aPrefix ) { return NS_ERROR_NULL_POINTER ; }</span>
<a href="#l27.254"></a><span id="l27.254" class="difflineminus">-    nsCString uri;</span>
<a href="#l27.255"></a><span id="l27.255" class="difflineminus">-    nsresult retCode = aResource-&gt;GetValue(getter_Copies(uri)) ;</span>
<a href="#l27.256"></a><span id="l27.256" class="difflineminus">-    </span>
<a href="#l27.257"></a><span id="l27.257" class="difflineminus">-    NS_ENSURE_SUCCESS(retCode, retCode) ;</span>
<a href="#l27.258"></a><span id="l27.258" class="difflineminus">-    nsCAutoString stub ;</span>
<a href="#l27.259"></a><span id="l27.259" class="difflineminus">-    nsAbWinType objType = getAbWinType(aPrefix, uri.get(), stub, aEntry) ;</span>
<a href="#l27.260"></a><span id="l27.260" class="difflineminus">-</span>
<a href="#l27.261"></a><span id="l27.261" class="difflineminus">-    return NS_OK ;</span>
<a href="#l27.262"></a><span id="l27.262" class="difflineminus">-}</span>
<a href="#l27.263"></a><span id="l27.263"> </span>
<a href="#l27.264"></a><span id="l27.264"> static nsresult ExtractCardEntry(nsIAbCard *aCard, nsCString&amp; aEntry)</span>
<a href="#l27.265"></a><span id="l27.265"> {</span>
<a href="#l27.266"></a><span id="l27.266" class="difflineminus">-    aEntry.Truncate() ;</span>
<a href="#l27.267"></a><span id="l27.267" class="difflineplus">+  aEntry.Truncate();</span>
<a href="#l27.268"></a><span id="l27.268"> </span>
<a href="#l27.269"></a><span id="l27.269" class="difflineminus">-    nsCString uri;</span>
<a href="#l27.270"></a><span id="l27.270" class="difflineminus">-    aCard-&gt;GetPropertyAsAUTF8String(&quot;OutlookEntryURI&quot;, uri);</span>
<a href="#l27.271"></a><span id="l27.271" class="difflineplus">+  nsCString uri;</span>
<a href="#l27.272"></a><span id="l27.272" class="difflineplus">+  aCard-&gt;GetPropertyAsAUTF8String(&quot;OutlookEntryURI&quot;, uri);</span>
<a href="#l27.273"></a><span id="l27.273"> </span>
<a href="#l27.274"></a><span id="l27.274" class="difflineminus">-    // If we don't have a URI, uri will be empty. getAbWinType doesn't set</span>
<a href="#l27.275"></a><span id="l27.275" class="difflineminus">-    // aEntry to anything if uri is empty, so it will be truncated, allowing us</span>
<a href="#l27.276"></a><span id="l27.276" class="difflineminus">-    // to accept cards not initialized by us.</span>
<a href="#l27.277"></a><span id="l27.277" class="difflineminus">-    nsCAutoString stub;</span>
<a href="#l27.278"></a><span id="l27.278" class="difflineminus">-    getAbWinType(kOutlookCardScheme, uri.get(), stub, aEntry);</span>
<a href="#l27.279"></a><span id="l27.279" class="difflineminus">-    return NS_OK;</span>
<a href="#l27.280"></a><span id="l27.280" class="difflineplus">+  // If we don't have a URI, uri will be empty. getAbWinType doesn't set</span>
<a href="#l27.281"></a><span id="l27.281" class="difflineplus">+  // aEntry to anything if uri is empty, so it will be truncated, allowing us</span>
<a href="#l27.282"></a><span id="l27.282" class="difflineplus">+  // to accept cards not initialized by us.</span>
<a href="#l27.283"></a><span id="l27.283" class="difflineplus">+  nsCAutoString stub;</span>
<a href="#l27.284"></a><span id="l27.284" class="difflineplus">+  getAbWinType(kOutlookCardScheme, uri.get(), stub, aEntry);</span>
<a href="#l27.285"></a><span id="l27.285" class="difflineplus">+  return NS_OK;</span>
<a href="#l27.286"></a><span id="l27.286"> }</span>
<a href="#l27.287"></a><span id="l27.287"> </span>
<a href="#l27.288"></a><span id="l27.288"> static nsresult ExtractDirectoryEntry(nsIAbDirectory *aDirectory, nsCString&amp; aEntry)</span>
<a href="#l27.289"></a><span id="l27.289"> {</span>
<a href="#l27.290"></a><span id="l27.290" class="difflineminus">-    aEntry.Truncate() ;</span>
<a href="#l27.291"></a><span id="l27.291" class="difflineminus">-    nsresult retCode = NS_OK ;</span>
<a href="#l27.292"></a><span id="l27.292" class="difflineminus">-    nsCOMPtr&lt;nsIRDFResource&gt; resource (do_QueryInterface(aDirectory, &amp;retCode)) ;</span>
<a href="#l27.293"></a><span id="l27.293" class="difflineminus">-    </span>
<a href="#l27.294"></a><span id="l27.294" class="difflineminus">-    // Receiving a non-RDF directory is accepted</span>
<a href="#l27.295"></a><span id="l27.295" class="difflineminus">-    if (NS_FAILED(retCode)) { return NS_OK ; }</span>
<a href="#l27.296"></a><span id="l27.296" class="difflineminus">-    return ExtractEntryFromUri(resource, aEntry, kOutlookDirectoryScheme) ;</span>
<a href="#l27.297"></a><span id="l27.297" class="difflineplus">+  aEntry.Truncate();</span>
<a href="#l27.298"></a><span id="l27.298" class="difflineplus">+  nsCString uri;</span>
<a href="#l27.299"></a><span id="l27.299" class="difflineplus">+  nsresult rv = aDirectory-&gt;GetURI(uri);</span>
<a href="#l27.300"></a><span id="l27.300" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l27.301"></a><span id="l27.301" class="difflineplus">+</span>
<a href="#l27.302"></a><span id="l27.302" class="difflineplus">+  nsCAutoString stub;</span>
<a href="#l27.303"></a><span id="l27.303" class="difflineplus">+  nsAbWinType objType = getAbWinType(kOutlookDirectoryScheme, uri.get(), stub, aEntry);</span>
<a href="#l27.304"></a><span id="l27.304" class="difflineplus">+</span>
<a href="#l27.305"></a><span id="l27.305" class="difflineplus">+  return NS_OK;</span>
<a href="#l27.306"></a><span id="l27.306"> }</span>
<a href="#l27.307"></a><span id="l27.307"> </span>
<a href="#l27.308"></a><span id="l27.308"> NS_IMETHODIMP nsAbOutlookDirectory::DeleteCards(nsIArray *aCardList)</span>
<a href="#l27.309"></a><span id="l27.309"> {</span>
<a href="#l27.310"></a><span id="l27.310">     if (mIsQueryURI) { return NS_ERROR_NOT_IMPLEMENTED ; }</span>
<a href="#l27.311"></a><span id="l27.311">     if (!aCardList) { return NS_ERROR_NULL_POINTER ; }</span>
<a href="#l27.312"></a><span id="l27.312">     PRUint32 nbCards = 0 ;</span>
<a href="#l27.313"></a><span id="l27.313">     nsresult retCode = NS_OK ;</span>
<a href="#l27.314"></a><span id="l27.314" class="difflineat">@@ -437,65 +424,74 @@ NS_IMETHODIMP nsAbOutlookDirectory::AddC</span>
<a href="#l27.315"></a><span id="l27.315"> NS_IMETHODIMP nsAbOutlookDirectory::DropCard(nsIAbCard *aData, PRBool needToCopyCard)</span>
<a href="#l27.316"></a><span id="l27.316"> {</span>
<a href="#l27.317"></a><span id="l27.317">     nsCOMPtr &lt;nsIAbCard&gt; addedCard;</span>
<a href="#l27.318"></a><span id="l27.318">     return AddCard(aData, getter_AddRefs(addedCard));</span>
<a href="#l27.319"></a><span id="l27.319"> }</span>
<a href="#l27.320"></a><span id="l27.320"> </span>
<a href="#l27.321"></a><span id="l27.321"> NS_IMETHODIMP nsAbOutlookDirectory::AddMailList(nsIAbDirectory *aMailList)</span>
<a href="#l27.322"></a><span id="l27.322"> {</span>
<a href="#l27.323"></a><span id="l27.323" class="difflineminus">-    if (mIsQueryURI) { return NS_ERROR_NOT_IMPLEMENTED ; }</span>
<a href="#l27.324"></a><span id="l27.324" class="difflineminus">-    if (!aMailList) { return NS_ERROR_NULL_POINTER ; }</span>
<a href="#l27.325"></a><span id="l27.325" class="difflineminus">-    if (m_IsMailList) { return NS_OK ; }</span>
<a href="#l27.326"></a><span id="l27.326" class="difflineminus">-    nsresult retCode = NS_OK ;</span>
<a href="#l27.327"></a><span id="l27.327" class="difflineminus">-    nsAbWinHelperGuard mapiAddBook (mAbWinType) ;</span>
<a href="#l27.328"></a><span id="l27.328" class="difflineminus">-    nsCAutoString entryString ;</span>
<a href="#l27.329"></a><span id="l27.329" class="difflineminus">-    nsMapiEntry newEntry ;</span>
<a href="#l27.330"></a><span id="l27.330" class="difflineminus">-    PRBool didCopy = PR_FALSE ;</span>
<a href="#l27.331"></a><span id="l27.331" class="difflineplus">+  if (mIsQueryURI)</span>
<a href="#l27.332"></a><span id="l27.332" class="difflineplus">+    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l27.333"></a><span id="l27.333" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aMailList);</span>
<a href="#l27.334"></a><span id="l27.334" class="difflineplus">+  if (m_IsMailList)</span>
<a href="#l27.335"></a><span id="l27.335" class="difflineplus">+    return NS_OK;</span>
<a href="#l27.336"></a><span id="l27.336" class="difflineplus">+  nsAbWinHelperGuard mapiAddBook (mAbWinType);</span>
<a href="#l27.337"></a><span id="l27.337" class="difflineplus">+  nsCAutoString entryString;</span>
<a href="#l27.338"></a><span id="l27.338" class="difflineplus">+  nsMapiEntry newEntry;</span>
<a href="#l27.339"></a><span id="l27.339" class="difflineplus">+  PRBool didCopy = PR_FALSE;</span>
<a href="#l27.340"></a><span id="l27.340"> </span>
<a href="#l27.341"></a><span id="l27.341" class="difflineminus">-    if (!mapiAddBook-&gt;IsOK()) { return NS_ERROR_FAILURE ; }</span>
<a href="#l27.342"></a><span id="l27.342" class="difflineminus">-    retCode = ExtractDirectoryEntry(aMailList, entryString) ;</span>
<a href="#l27.343"></a><span id="l27.343" class="difflineminus">-    if (NS_SUCCEEDED(retCode) &amp;&amp; !entryString.IsEmpty()) {</span>
<a href="#l27.344"></a><span id="l27.344" class="difflineminus">-        nsMapiEntry sourceEntry ;</span>
<a href="#l27.345"></a><span id="l27.345" class="difflineplus">+  if (!mapiAddBook-&gt;IsOK())</span>
<a href="#l27.346"></a><span id="l27.346" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l27.347"></a><span id="l27.347" class="difflineplus">+  nsresult rv = ExtractDirectoryEntry(aMailList, entryString);</span>
<a href="#l27.348"></a><span id="l27.348" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; !entryString.IsEmpty())</span>
<a href="#l27.349"></a><span id="l27.349" class="difflineplus">+  {</span>
<a href="#l27.350"></a><span id="l27.350" class="difflineplus">+      nsMapiEntry sourceEntry;</span>
<a href="#l27.351"></a><span id="l27.351"> </span>
<a href="#l27.352"></a><span id="l27.352" class="difflineminus">-        sourceEntry.Assign(entryString) ;</span>
<a href="#l27.353"></a><span id="l27.353" class="difflineminus">-        mapiAddBook-&gt;CopyEntry(*mMapiData, sourceEntry, newEntry) ;</span>
<a href="#l27.354"></a><span id="l27.354" class="difflineminus">-    }</span>
<a href="#l27.355"></a><span id="l27.355" class="difflineminus">-    if (newEntry.mByteCount == 0) {</span>
<a href="#l27.356"></a><span id="l27.356" class="difflineminus">-        if (!mapiAddBook-&gt;CreateDistList(*mMapiData, newEntry)) {</span>
<a href="#l27.357"></a><span id="l27.357" class="difflineminus">-            return NS_ERROR_FAILURE ; </span>
<a href="#l27.358"></a><span id="l27.358" class="difflineminus">-        }</span>
<a href="#l27.359"></a><span id="l27.359" class="difflineminus">-    }</span>
<a href="#l27.360"></a><span id="l27.360" class="difflineminus">-    else { didCopy = PR_TRUE ; }</span>
<a href="#l27.361"></a><span id="l27.361" class="difflineminus">-    newEntry.ToString(entryString) ;</span>
<a href="#l27.362"></a><span id="l27.362" class="difflineminus">-    nsCAutoString uri ;</span>
<a href="#l27.363"></a><span id="l27.363" class="difflineplus">+      sourceEntry.Assign(entryString);</span>
<a href="#l27.364"></a><span id="l27.364" class="difflineplus">+      mapiAddBook-&gt;CopyEntry(*mMapiData, sourceEntry, newEntry);</span>
<a href="#l27.365"></a><span id="l27.365" class="difflineplus">+  }</span>
<a href="#l27.366"></a><span id="l27.366" class="difflineplus">+  if (newEntry.mByteCount == 0)</span>
<a href="#l27.367"></a><span id="l27.367" class="difflineplus">+  {</span>
<a href="#l27.368"></a><span id="l27.368" class="difflineplus">+    if (!mapiAddBook-&gt;CreateDistList(*mMapiData, newEntry))</span>
<a href="#l27.369"></a><span id="l27.369" class="difflineplus">+        return NS_ERROR_FAILURE;</span>
<a href="#l27.370"></a><span id="l27.370" class="difflineplus">+  }</span>
<a href="#l27.371"></a><span id="l27.371" class="difflineplus">+  else {</span>
<a href="#l27.372"></a><span id="l27.372" class="difflineplus">+    didCopy = PR_TRUE;</span>
<a href="#l27.373"></a><span id="l27.373" class="difflineplus">+  }</span>
<a href="#l27.374"></a><span id="l27.374" class="difflineplus">+  newEntry.ToString(entryString);</span>
<a href="#l27.375"></a><span id="l27.375" class="difflineplus">+  nsCAutoString uri;</span>
<a href="#l27.376"></a><span id="l27.376" class="difflineplus">+</span>
<a href="#l27.377"></a><span id="l27.377" class="difflineplus">+  buildAbWinUri(kOutlookDirectoryScheme, mAbWinType, uri);</span>
<a href="#l27.378"></a><span id="l27.378" class="difflineplus">+  uri.Append(entryString);</span>
<a href="#l27.379"></a><span id="l27.379" class="difflineplus">+</span>
<a href="#l27.380"></a><span id="l27.380" class="difflineplus">+  nsCOMPtr&lt;nsIAbManager&gt; abManager(do_GetService(NS_ABMANAGER_CONTRACTID,</span>
<a href="#l27.381"></a><span id="l27.381" class="difflineplus">+                                   &amp;rv));</span>
<a href="#l27.382"></a><span id="l27.382" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l27.383"></a><span id="l27.383"> </span>
<a href="#l27.384"></a><span id="l27.384" class="difflineminus">-    buildAbWinUri(kOutlookDirectoryScheme, mAbWinType, uri) ;</span>
<a href="#l27.385"></a><span id="l27.385" class="difflineminus">-    uri.Append(entryString) ;</span>
<a href="#l27.386"></a><span id="l27.386" class="difflineminus">-    nsCOMPtr&lt;nsIRDFResource&gt; resource ;</span>
<a href="#l27.387"></a><span id="l27.387" class="difflineminus">-    retCode = gRDFService-&gt;GetResource(uri, getter_AddRefs(resource)) ;</span>
<a href="#l27.388"></a><span id="l27.388" class="difflineminus">-    NS_ENSURE_SUCCESS(retCode, retCode) ;</span>
<a href="#l27.389"></a><span id="l27.389" class="difflineminus">-    nsCOMPtr&lt;nsIAbDirectory&gt; newList(do_QueryInterface(resource, &amp;retCode)) ;</span>
<a href="#l27.390"></a><span id="l27.390" class="difflineminus">-    </span>
<a href="#l27.391"></a><span id="l27.391" class="difflineminus">-    NS_ENSURE_SUCCESS(retCode, retCode) ;</span>
<a href="#l27.392"></a><span id="l27.392" class="difflineminus">-    if (!didCopy) {</span>
<a href="#l27.393"></a><span id="l27.393" class="difflineminus">-        retCode = newList-&gt;CopyMailList(aMailList) ;</span>
<a href="#l27.394"></a><span id="l27.394" class="difflineminus">-        NS_ENSURE_SUCCESS(retCode, retCode) ;</span>
<a href="#l27.395"></a><span id="l27.395" class="difflineminus">-        retCode = newList-&gt;EditMailListToDatabase(nsnull);</span>
<a href="#l27.396"></a><span id="l27.396" class="difflineminus">-        NS_ENSURE_SUCCESS(retCode, retCode) ;</span>
<a href="#l27.397"></a><span id="l27.397" class="difflineminus">-    }</span>
<a href="#l27.398"></a><span id="l27.398" class="difflineplus">+  nsCOMPtr&lt;nsIAbDirectory&gt; newList;</span>
<a href="#l27.399"></a><span id="l27.399" class="difflineplus">+  rv = abManager-&gt;GetDirectory(uri, getter_AddRefs(newList));</span>
<a href="#l27.400"></a><span id="l27.400" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l27.401"></a><span id="l27.401"> </span>
<a href="#l27.402"></a><span id="l27.402" class="difflineminus">-    if (!m_AddressList)</span>
<a href="#l27.403"></a><span id="l27.403" class="difflineminus">-    {</span>
<a href="#l27.404"></a><span id="l27.404" class="difflineminus">-      m_AddressList = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;retCode);</span>
<a href="#l27.405"></a><span id="l27.405" class="difflineminus">-      NS_ENSURE_SUCCESS(retCode, retCode);</span>
<a href="#l27.406"></a><span id="l27.406" class="difflineminus">-    }</span>
<a href="#l27.407"></a><span id="l27.407" class="difflineminus">-    m_AddressList-&gt;AppendElement(newList, PR_FALSE);</span>
<a href="#l27.408"></a><span id="l27.408" class="difflineminus">-    NotifyItemAddition(newList) ;</span>
<a href="#l27.409"></a><span id="l27.409" class="difflineminus">-    return retCode ;</span>
<a href="#l27.410"></a><span id="l27.410" class="difflineplus">+  if (!didCopy)</span>
<a href="#l27.411"></a><span id="l27.411" class="difflineplus">+  {</span>
<a href="#l27.412"></a><span id="l27.412" class="difflineplus">+    rv = newList-&gt;CopyMailList(aMailList);</span>
<a href="#l27.413"></a><span id="l27.413" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l27.414"></a><span id="l27.414" class="difflineplus">+    rv = newList-&gt;EditMailListToDatabase(nsnull);</span>
<a href="#l27.415"></a><span id="l27.415" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l27.416"></a><span id="l27.416" class="difflineplus">+  }</span>
<a href="#l27.417"></a><span id="l27.417" class="difflineplus">+</span>
<a href="#l27.418"></a><span id="l27.418" class="difflineplus">+  if (!m_AddressList)</span>
<a href="#l27.419"></a><span id="l27.419" class="difflineplus">+  {</span>
<a href="#l27.420"></a><span id="l27.420" class="difflineplus">+    m_AddressList = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l27.421"></a><span id="l27.421" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l27.422"></a><span id="l27.422" class="difflineplus">+  }</span>
<a href="#l27.423"></a><span id="l27.423" class="difflineplus">+  m_AddressList-&gt;AppendElement(newList, PR_FALSE);</span>
<a href="#l27.424"></a><span id="l27.424" class="difflineplus">+  NotifyItemAddition(newList);</span>
<a href="#l27.425"></a><span id="l27.425" class="difflineplus">+  return rv;</span>
<a href="#l27.426"></a><span id="l27.426"> }</span>
<a href="#l27.427"></a><span id="l27.427"> </span>
<a href="#l27.428"></a><span id="l27.428"> NS_IMETHODIMP nsAbOutlookDirectory::EditMailListToDatabase(nsIAbCard *listCard)</span>
<a href="#l27.429"></a><span id="l27.429"> {</span>
<a href="#l27.430"></a><span id="l27.430">   if (mIsQueryURI)</span>
<a href="#l27.431"></a><span id="l27.431">     return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l27.432"></a><span id="l27.432"> </span>
<a href="#l27.433"></a><span id="l27.433">   nsresult rv;</span>
<a href="#l27.434"></a><span id="l27.434" class="difflineat">@@ -1088,48 +1084,52 @@ nsresult nsAbOutlookDirectory::GetChildC</span>
<a href="#l27.435"></a><span id="l27.435"> </span>
<a href="#l27.436"></a><span id="l27.436">     aCards-&gt;AppendElement(childCard, PR_FALSE);</span>
<a href="#l27.437"></a><span id="l27.437">   }</span>
<a href="#l27.438"></a><span id="l27.438">   return rv;</span>
<a href="#l27.439"></a><span id="l27.439"> }</span>
<a href="#l27.440"></a><span id="l27.440"> </span>
<a href="#l27.441"></a><span id="l27.441"> nsresult nsAbOutlookDirectory::GetChildNodes(nsIMutableArray* aNodes)</span>
<a href="#l27.442"></a><span id="l27.442"> {</span>
<a href="#l27.443"></a><span id="l27.443" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aNodes);</span>
<a href="#l27.444"></a><span id="l27.444" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aNodes);</span>
<a href="#l27.445"></a><span id="l27.445"> </span>
<a href="#l27.446"></a><span id="l27.446" class="difflineminus">-    aNodes-&gt;Clear();</span>
<a href="#l27.447"></a><span id="l27.447" class="difflineplus">+  aNodes-&gt;Clear();</span>
<a href="#l27.448"></a><span id="l27.448"> </span>
<a href="#l27.449"></a><span id="l27.449" class="difflineminus">-    nsAbWinHelperGuard mapiAddBook(mAbWinType);</span>
<a href="#l27.450"></a><span id="l27.450" class="difflineminus">-    nsMapiEntryArray nodeEntries;</span>
<a href="#l27.451"></a><span id="l27.451" class="difflineplus">+  nsAbWinHelperGuard mapiAddBook(mAbWinType);</span>
<a href="#l27.452"></a><span id="l27.452" class="difflineplus">+  nsMapiEntryArray nodeEntries;</span>
<a href="#l27.453"></a><span id="l27.453"> </span>
<a href="#l27.454"></a><span id="l27.454" class="difflineminus">-    if (!mapiAddBook-&gt;IsOK())</span>
<a href="#l27.455"></a><span id="l27.455" class="difflineminus">-        return NS_ERROR_FAILURE;</span>
<a href="#l27.456"></a><span id="l27.456" class="difflineplus">+  if (!mapiAddBook-&gt;IsOK())</span>
<a href="#l27.457"></a><span id="l27.457" class="difflineplus">+      return NS_ERROR_FAILURE;</span>
<a href="#l27.458"></a><span id="l27.458"> </span>
<a href="#l27.459"></a><span id="l27.459" class="difflineminus">-    if (!mapiAddBook-&gt;GetNodes(*mMapiData, nodeEntries)) </span>
<a href="#l27.460"></a><span id="l27.460" class="difflineminus">-    {</span>
<a href="#l27.461"></a><span id="l27.461" class="difflineminus">-        PRINTF((&quot;Cannot get nodes.\n&quot;));</span>
<a href="#l27.462"></a><span id="l27.462" class="difflineminus">-        return NS_ERROR_FAILURE;</span>
<a href="#l27.463"></a><span id="l27.463" class="difflineminus">-    }</span>
<a href="#l27.464"></a><span id="l27.464" class="difflineplus">+  if (!mapiAddBook-&gt;GetNodes(*mMapiData, nodeEntries))</span>
<a href="#l27.465"></a><span id="l27.465" class="difflineplus">+  {</span>
<a href="#l27.466"></a><span id="l27.466" class="difflineplus">+    PRINTF((&quot;Cannot get nodes.\n&quot;));</span>
<a href="#l27.467"></a><span id="l27.467" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l27.468"></a><span id="l27.468" class="difflineplus">+  }</span>
<a href="#l27.469"></a><span id="l27.469"> </span>
<a href="#l27.470"></a><span id="l27.470" class="difflineminus">-    nsCAutoString entryId;</span>
<a href="#l27.471"></a><span id="l27.471" class="difflineminus">-    nsCAutoString uriName;</span>
<a href="#l27.472"></a><span id="l27.472" class="difflineminus">-    nsCOMPtr&lt;nsIRDFResource&gt; resource;</span>
<a href="#l27.473"></a><span id="l27.473" class="difflineminus">-    nsresult rv = NS_OK;</span>
<a href="#l27.474"></a><span id="l27.474" class="difflineplus">+  nsCAutoString entryId;</span>
<a href="#l27.475"></a><span id="l27.475" class="difflineplus">+  nsCAutoString uriName;</span>
<a href="#l27.476"></a><span id="l27.476" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l27.477"></a><span id="l27.477" class="difflineplus">+</span>
<a href="#l27.478"></a><span id="l27.478" class="difflineplus">+  nsCOMPtr&lt;nsIAbManager&gt; abManager(do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv));</span>
<a href="#l27.479"></a><span id="l27.479" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l27.480"></a><span id="l27.480"> </span>
<a href="#l27.481"></a><span id="l27.481" class="difflineminus">-    for (ULONG node = 0; node &lt; nodeEntries.mNbEntries; ++node) </span>
<a href="#l27.482"></a><span id="l27.482" class="difflineminus">-        {</span>
<a href="#l27.483"></a><span id="l27.483" class="difflineminus">-        nodeEntries.mEntries[node].ToString(entryId);</span>
<a href="#l27.484"></a><span id="l27.484" class="difflineminus">-        buildAbWinUri(kOutlookDirectoryScheme, mAbWinType, uriName);</span>
<a href="#l27.485"></a><span id="l27.485" class="difflineminus">-        uriName.Append(entryId);</span>
<a href="#l27.486"></a><span id="l27.486" class="difflineplus">+  for (ULONG node = 0; node &lt; nodeEntries.mNbEntries; ++node)</span>
<a href="#l27.487"></a><span id="l27.487" class="difflineplus">+  {</span>
<a href="#l27.488"></a><span id="l27.488" class="difflineplus">+    nodeEntries.mEntries[node].ToString(entryId);</span>
<a href="#l27.489"></a><span id="l27.489" class="difflineplus">+    buildAbWinUri(kOutlookDirectoryScheme, mAbWinType, uriName);</span>
<a href="#l27.490"></a><span id="l27.490" class="difflineplus">+    uriName.Append(entryId);</span>
<a href="#l27.491"></a><span id="l27.491"> </span>
<a href="#l27.492"></a><span id="l27.492" class="difflineminus">-        rv = gRDFService-&gt;GetResource(uriName, getter_AddRefs(resource));</span>
<a href="#l27.493"></a><span id="l27.493" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l27.494"></a><span id="l27.494" class="difflineminus">-        aNodes-&gt;AppendElement(resource, PR_FALSE);</span>
<a href="#l27.495"></a><span id="l27.495" class="difflineminus">-    }</span>
<a href="#l27.496"></a><span id="l27.496" class="difflineminus">-    return rv;</span>
<a href="#l27.497"></a><span id="l27.497" class="difflineplus">+    nsCOMPtr &lt;nsIAbDirectory&gt; directory;</span>
<a href="#l27.498"></a><span id="l27.498" class="difflineplus">+    rv = abManager-&gt;GetDirectory(uriName, getter_AddRefs(directory));</span>
<a href="#l27.499"></a><span id="l27.499" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l27.500"></a><span id="l27.500" class="difflineplus">+</span>
<a href="#l27.501"></a><span id="l27.501" class="difflineplus">+    aNodes-&gt;AppendElement(directory, PR_FALSE);</span>
<a href="#l27.502"></a><span id="l27.502" class="difflineplus">+  }</span>
<a href="#l27.503"></a><span id="l27.503" class="difflineplus">+  return rv;</span>
<a href="#l27.504"></a><span id="l27.504"> }</span>
<a href="#l27.505"></a><span id="l27.505"> </span>
<a href="#l27.506"></a><span id="l27.506"> nsresult nsAbOutlookDirectory::NotifyItemDeletion(nsISupports *aItem) </span>
<a href="#l27.507"></a><span id="l27.507"> {</span>
<a href="#l27.508"></a><span id="l27.508">   nsresult rv;</span>
<a href="#l27.509"></a><span id="l27.509">   nsCOMPtr&lt;nsIAbManager&gt; abManager(do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv));</span>
<a href="#l27.510"></a><span id="l27.510"> </span>
<a href="#l27.511"></a><span id="l27.511">   if (NS_SUCCEEDED(rv))</span>
<a href="#l27.512"></a><span id="l27.512" class="difflineat">@@ -1216,17 +1216,17 @@ nsresult nsAbOutlookDirectory::CreateCar</span>
<a href="#l27.513"></a><span id="l27.513">     *aNewCard = nsnull ;</span>
<a href="#l27.514"></a><span id="l27.514">     nsresult retCode = NS_OK ;</span>
<a href="#l27.515"></a><span id="l27.515">     nsAbWinHelperGuard mapiAddBook (mAbWinType) ;</span>
<a href="#l27.516"></a><span id="l27.516">     nsMapiEntry newEntry ;</span>
<a href="#l27.517"></a><span id="l27.517">     nsCAutoString entryString ;</span>
<a href="#l27.518"></a><span id="l27.518">     PRBool didCopy = PR_FALSE ;</span>
<a href="#l27.519"></a><span id="l27.519"> </span>
<a href="#l27.520"></a><span id="l27.520">     if (!mapiAddBook-&gt;IsOK()) { return NS_ERROR_FAILURE ; }</span>
<a href="#l27.521"></a><span id="l27.521" class="difflineminus">-    // If we get a RDF resource and it maps onto an Outlook card uri,</span>
<a href="#l27.522"></a><span id="l27.522" class="difflineplus">+    // If we get an nsIAbCard that maps onto an Outlook card uri</span>
<a href="#l27.523"></a><span id="l27.523">     // we simply copy the contents of the Outlook card.</span>
<a href="#l27.524"></a><span id="l27.524">     retCode = ExtractCardEntry(aData, entryString) ;</span>
<a href="#l27.525"></a><span id="l27.525">     if (NS_SUCCEEDED(retCode) &amp;&amp; !entryString.IsEmpty()) {</span>
<a href="#l27.526"></a><span id="l27.526">         nsMapiEntry sourceEntry ;</span>
<a href="#l27.527"></a><span id="l27.527">         </span>
<a href="#l27.528"></a><span id="l27.528">         </span>
<a href="#l27.529"></a><span id="l27.529">         sourceEntry.Assign(entryString) ;</span>
<a href="#l27.530"></a><span id="l27.530">         if (m_IsMailList) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbOutlookDirectory.h</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbOutlookDirectory.h</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -33,61 +33,59 @@</span>
<a href="#l28.4"></a><span id="l28.4">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l28.5"></a><span id="l28.5">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l28.6"></a><span id="l28.6">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l28.7"></a><span id="l28.7">  *</span>
<a href="#l28.8"></a><span id="l28.8">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l28.9"></a><span id="l28.9"> #ifndef nsAbOutlookDirectory_h___</span>
<a href="#l28.10"></a><span id="l28.10"> #define nsAbOutlookDirectory_h___</span>
<a href="#l28.11"></a><span id="l28.11"> </span>
<a href="#l28.12"></a><span id="l28.12" class="difflineminus">-#include &quot;nsAbDirectoryRDFResource.h&quot;</span>
<a href="#l28.13"></a><span id="l28.13"> #include &quot;nsAbDirProperty.h&quot;</span>
<a href="#l28.14"></a><span id="l28.14"> #include &quot;nsIAbDirectoryQuery.h&quot;</span>
<a href="#l28.15"></a><span id="l28.15"> #include &quot;nsIAbDirectorySearch.h&quot;</span>
<a href="#l28.16"></a><span id="l28.16"> #include &quot;nsIAbDirSearchListener.h&quot;</span>
<a href="#l28.17"></a><span id="l28.17"> #include &quot;nsDataHashtable.h&quot;</span>
<a href="#l28.18"></a><span id="l28.18"> #include &quot;nsInterfaceHashtable.h&quot;</span>
<a href="#l28.19"></a><span id="l28.19"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l28.20"></a><span id="l28.20"> #include &quot;nsAbWinHelper.h&quot;</span>
<a href="#l28.21"></a><span id="l28.21"> </span>
<a href="#l28.22"></a><span id="l28.22"> struct nsMapiEntry ;</span>
<a href="#l28.23"></a><span id="l28.23"> </span>
<a href="#l28.24"></a><span id="l28.24" class="difflineminus">-class nsAbOutlookDirectory : public nsAbDirectoryRDFResource, // nsIRDFResource</span>
<a href="#l28.25"></a><span id="l28.25" class="difflineminus">-                             public nsAbDirProperty, // nsIAbDirectory</span>
<a href="#l28.26"></a><span id="l28.26" class="difflineplus">+class nsAbOutlookDirectory : public nsAbDirProperty, // nsIAbDirectory</span>
<a href="#l28.27"></a><span id="l28.27">                              public nsIAbDirectoryQuery,</span>
<a href="#l28.28"></a><span id="l28.28">                              public nsIAbDirectorySearch,</span>
<a href="#l28.29"></a><span id="l28.29">                              public nsIAbDirSearchListener,</span>
<a href="#l28.30"></a><span id="l28.30">                              public nsIAbDirectoryQueryResultListener</span>
<a href="#l28.31"></a><span id="l28.31"> {</span>
<a href="#l28.32"></a><span id="l28.32"> public:</span>
<a href="#l28.33"></a><span id="l28.33" class="difflineminus">-	NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l28.34"></a><span id="l28.34" class="difflineplus">+  NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l28.35"></a><span id="l28.35">   NS_DECL_NSIABDIRSEARCHLISTENER</span>
<a href="#l28.36"></a><span id="l28.36">   NS_DECL_NSIABDIRECTORYQUERYRESULTLISTENER</span>
<a href="#l28.37"></a><span id="l28.37"> </span>
<a href="#l28.38"></a><span id="l28.38">   nsAbOutlookDirectory(void);</span>
<a href="#l28.39"></a><span id="l28.39">   virtual ~nsAbOutlookDirectory(void);</span>
<a href="#l28.40"></a><span id="l28.40" class="difflineminus">-	</span>
<a href="#l28.41"></a><span id="l28.41" class="difflineminus">-	// nsAbDirProperty methods</span>
<a href="#l28.42"></a><span id="l28.42" class="difflineplus">+</span>
<a href="#l28.43"></a><span id="l28.43" class="difflineplus">+  // nsAbDirProperty methods</span>
<a href="#l28.44"></a><span id="l28.44">   NS_IMETHOD GetDirType(PRInt32 *aDirType);</span>
<a href="#l28.45"></a><span id="l28.45">   NS_IMETHOD GetURI(nsACString &amp;aURI);</span>
<a href="#l28.46"></a><span id="l28.46">   NS_IMETHOD GetChildCards(nsISimpleEnumerator **aCards);</span>
<a href="#l28.47"></a><span id="l28.47">   NS_IMETHOD GetChildNodes(nsISimpleEnumerator **aNodes);</span>
<a href="#l28.48"></a><span id="l28.48">   NS_IMETHOD GetIsQuery(PRBool *aResult);</span>
<a href="#l28.49"></a><span id="l28.49">   NS_IMETHOD HasCard(nsIAbCard *aCard, PRBool *aHasCard);</span>
<a href="#l28.50"></a><span id="l28.50">   NS_IMETHOD HasDirectory(nsIAbDirectory *aDirectory, PRBool *aHasDirectory);</span>
<a href="#l28.51"></a><span id="l28.51">   NS_IMETHOD DeleteCards(nsIArray *aCardList);</span>
<a href="#l28.52"></a><span id="l28.52">   NS_IMETHOD DeleteDirectory(nsIAbDirectory *aDirectory);</span>
<a href="#l28.53"></a><span id="l28.53">   NS_IMETHOD UseForAutocomplete(const nsACString &amp;aIdentityKey, PRBool *aResult);</span>
<a href="#l28.54"></a><span id="l28.54">   NS_IMETHOD AddCard(nsIAbCard *aData, nsIAbCard **addedCard);</span>
<a href="#l28.55"></a><span id="l28.55">   NS_IMETHOD ModifyCard(nsIAbCard *aModifiedCard);</span>
<a href="#l28.56"></a><span id="l28.56">   NS_IMETHOD DropCard(nsIAbCard *aData, PRBool needToCopyCard);</span>
<a href="#l28.57"></a><span id="l28.57">   NS_IMETHOD AddMailList(nsIAbDirectory *aMailList);</span>
<a href="#l28.58"></a><span id="l28.58">   NS_IMETHOD EditMailListToDatabase(nsIAbCard *listCard);</span>
<a href="#l28.59"></a><span id="l28.59">   </span>
<a href="#l28.60"></a><span id="l28.60" class="difflineminus">-  // nsAbDirectoryRDFResource method</span>
<a href="#l28.61"></a><span id="l28.61" class="difflineplus">+  // nsAbDirProperty method</span>
<a href="#l28.62"></a><span id="l28.62">   NS_IMETHOD Init(const char *aUri);</span>
<a href="#l28.63"></a><span id="l28.63">   // nsIAbDirectoryQuery methods</span>
<a href="#l28.64"></a><span id="l28.64">   NS_DECL_NSIABDIRECTORYQUERY</span>
<a href="#l28.65"></a><span id="l28.65">   // nsIAbDirectorySearch methods</span>
<a href="#l28.66"></a><span id="l28.66">   NS_DECL_NSIABDIRECTORYSEARCH</span>
<a href="#l28.67"></a><span id="l28.67">   // Perform a MAPI query (function executed in a separate thread)</span>
<a href="#l28.68"></a><span id="l28.68">   nsresult ExecuteQuery(SRestriction &amp;aRestriction,</span>
<a href="#l28.69"></a><span id="l28.69">                         nsIAbDirSearchListener *aListener,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1">deleted file mode 100644</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineminus">--- a/mailnews/addrbook/src/nsAbRDFDataSource.cpp</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineplus">+++ /dev/null</span>
<a href="#l29.4"></a><span id="l29.4" class="difflineat">@@ -1,448 +0,0 @@</span>
<a href="#l29.5"></a><span id="l29.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l29.6"></a><span id="l29.6" class="difflineminus">-/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l29.7"></a><span id="l29.7" class="difflineminus">- * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l29.8"></a><span id="l29.8" class="difflineminus">- *</span>
<a href="#l29.9"></a><span id="l29.9" class="difflineminus">- * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l29.10"></a><span id="l29.10" class="difflineminus">- * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l29.11"></a><span id="l29.11" class="difflineminus">- * the License. You may obtain a copy of the License at</span>
<a href="#l29.12"></a><span id="l29.12" class="difflineminus">- * http://www.mozilla.org/MPL/</span>
<a href="#l29.13"></a><span id="l29.13" class="difflineminus">- *</span>
<a href="#l29.14"></a><span id="l29.14" class="difflineminus">- * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l29.15"></a><span id="l29.15" class="difflineminus">- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l29.16"></a><span id="l29.16" class="difflineminus">- * for the specific language governing rights and limitations under the</span>
<a href="#l29.17"></a><span id="l29.17" class="difflineminus">- * License.</span>
<a href="#l29.18"></a><span id="l29.18" class="difflineminus">- *</span>
<a href="#l29.19"></a><span id="l29.19" class="difflineminus">- * The Original Code is mozilla.org code.</span>
<a href="#l29.20"></a><span id="l29.20" class="difflineminus">- *</span>
<a href="#l29.21"></a><span id="l29.21" class="difflineminus">- * The Initial Developer of the Original Code is</span>
<a href="#l29.22"></a><span id="l29.22" class="difflineminus">- * Netscape Communications Corporation.</span>
<a href="#l29.23"></a><span id="l29.23" class="difflineminus">- * Portions created by the Initial Developer are Copyright (C) 1999</span>
<a href="#l29.24"></a><span id="l29.24" class="difflineminus">- * the Initial Developer. All Rights Reserved.</span>
<a href="#l29.25"></a><span id="l29.25" class="difflineminus">- *</span>
<a href="#l29.26"></a><span id="l29.26" class="difflineminus">- * Contributor(s):</span>
<a href="#l29.27"></a><span id="l29.27" class="difflineminus">- *   Pierre Phaneuf &lt;pp@ludusdesign.com&gt;</span>
<a href="#l29.28"></a><span id="l29.28" class="difflineminus">- *   Mark Banner &lt;mark@standard8.demon.co.uk&gt;</span>
<a href="#l29.29"></a><span id="l29.29" class="difflineminus">- *</span>
<a href="#l29.30"></a><span id="l29.30" class="difflineminus">- * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l29.31"></a><span id="l29.31" class="difflineminus">- * either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l29.32"></a><span id="l29.32" class="difflineminus">- * or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l29.33"></a><span id="l29.33" class="difflineminus">- * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l29.34"></a><span id="l29.34" class="difflineminus">- * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l29.35"></a><span id="l29.35" class="difflineminus">- * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l29.36"></a><span id="l29.36" class="difflineminus">- * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l29.37"></a><span id="l29.37" class="difflineminus">- * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l29.38"></a><span id="l29.38" class="difflineminus">- * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l29.39"></a><span id="l29.39" class="difflineminus">- * the provisions above, a recipient may use your version of this file under</span>
<a href="#l29.40"></a><span id="l29.40" class="difflineminus">- * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l29.41"></a><span id="l29.41" class="difflineminus">- *</span>
<a href="#l29.42"></a><span id="l29.42" class="difflineminus">- * ***** END LICENSE BLOCK ***** */</span>
<a href="#l29.43"></a><span id="l29.43" class="difflineminus">-</span>
<a href="#l29.44"></a><span id="l29.44" class="difflineminus">-#include &quot;nsAbRDFDataSource.h&quot;</span>
<a href="#l29.45"></a><span id="l29.45" class="difflineminus">-#include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l29.46"></a><span id="l29.46" class="difflineminus">-#include &quot;nsIAbDirectory.h&quot;</span>
<a href="#l29.47"></a><span id="l29.47" class="difflineminus">-#include &quot;nsIAbCard.h&quot;</span>
<a href="#l29.48"></a><span id="l29.48" class="difflineminus">-</span>
<a href="#l29.49"></a><span id="l29.49" class="difflineminus">-#include &quot;rdf.h&quot;</span>
<a href="#l29.50"></a><span id="l29.50" class="difflineminus">-#include &quot;nsIRDFService.h&quot;</span>
<a href="#l29.51"></a><span id="l29.51" class="difflineminus">-#include &quot;nsRDFCID.h&quot;</span>
<a href="#l29.52"></a><span id="l29.52" class="difflineminus">-#include &quot;nsIRDFNode.h&quot;</span>
<a href="#l29.53"></a><span id="l29.53" class="difflineminus">-#include &quot;nsEnumeratorUtils.h&quot;</span>
<a href="#l29.54"></a><span id="l29.54" class="difflineminus">-#include &quot;nsIProxyObjectManager.h&quot;</span>
<a href="#l29.55"></a><span id="l29.55" class="difflineminus">-</span>
<a href="#l29.56"></a><span id="l29.56" class="difflineminus">-#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l29.57"></a><span id="l29.57" class="difflineminus">-#include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l29.58"></a><span id="l29.58" class="difflineminus">-#include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l29.59"></a><span id="l29.59" class="difflineminus">-#include &quot;nsThreadUtils.h&quot;</span>
<a href="#l29.60"></a><span id="l29.60" class="difflineminus">-#include &quot;nsXPCOMCIDInternal.h&quot;</span>
<a href="#l29.61"></a><span id="l29.61" class="difflineminus">-</span>
<a href="#l29.62"></a><span id="l29.62" class="difflineminus">-using namespace mozilla;</span>
<a href="#l29.63"></a><span id="l29.63" class="difflineminus">-</span>
<a href="#l29.64"></a><span id="l29.64" class="difflineminus">-// this is used for notification of observers using nsVoidArray</span>
<a href="#l29.65"></a><span id="l29.65" class="difflineminus">-typedef struct _nsAbRDFNotification {</span>
<a href="#l29.66"></a><span id="l29.66" class="difflineminus">-  nsIRDFDataSource *datasource;</span>
<a href="#l29.67"></a><span id="l29.67" class="difflineminus">-  nsIRDFResource *subject;</span>
<a href="#l29.68"></a><span id="l29.68" class="difflineminus">-  nsIRDFResource *property;</span>
<a href="#l29.69"></a><span id="l29.69" class="difflineminus">-  nsIRDFNode *object;</span>
<a href="#l29.70"></a><span id="l29.70" class="difflineminus">-} nsAbRDFNotification;</span>
<a href="#l29.71"></a><span id="l29.71" class="difflineminus">-</span>
<a href="#l29.72"></a><span id="l29.72" class="difflineminus">-nsresult nsAbRDFDataSource::createNode(const PRUnichar *str, nsIRDFNode **node)</span>
<a href="#l29.73"></a><span id="l29.73" class="difflineminus">-{</span>
<a href="#l29.74"></a><span id="l29.74" class="difflineminus">-  *node = nsnull;</span>
<a href="#l29.75"></a><span id="l29.75" class="difflineminus">-  nsresult rv;</span>
<a href="#l29.76"></a><span id="l29.76" class="difflineminus">-  nsCOMPtr&lt;nsIRDFService&gt; rdf(do_GetService(&quot;@mozilla.org/rdf/rdf-service;1&quot;, &amp;rv));</span>
<a href="#l29.77"></a><span id="l29.77" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv); // always check this before proceeding</span>
<a href="#l29.78"></a><span id="l29.78" class="difflineminus">-  nsCOMPtr&lt;nsIRDFLiteral&gt; value;</span>
<a href="#l29.79"></a><span id="l29.79" class="difflineminus">-  rv = rdf-&gt;GetLiteral(str, getter_AddRefs(value));</span>
<a href="#l29.80"></a><span id="l29.80" class="difflineminus">-  if (NS_SUCCEEDED(rv)) </span>
<a href="#l29.81"></a><span id="l29.81" class="difflineminus">-    NS_IF_ADDREF(*node = value);</span>
<a href="#l29.82"></a><span id="l29.82" class="difflineminus">-  return rv;</span>
<a href="#l29.83"></a><span id="l29.83" class="difflineminus">-}</span>
<a href="#l29.84"></a><span id="l29.84" class="difflineminus">-</span>
<a href="#l29.85"></a><span id="l29.85" class="difflineminus">-nsresult nsAbRDFDataSource::createBlobNode(PRUint8 *value, PRUint32 &amp;length, nsIRDFNode **node, nsIRDFService *rdfService)</span>
<a href="#l29.86"></a><span id="l29.86" class="difflineminus">-{</span>
<a href="#l29.87"></a><span id="l29.87" class="difflineminus">-  NS_ENSURE_ARG_POINTER(node);</span>
<a href="#l29.88"></a><span id="l29.88" class="difflineminus">-  NS_ENSURE_ARG_POINTER(rdfService);</span>
<a href="#l29.89"></a><span id="l29.89" class="difflineminus">-</span>
<a href="#l29.90"></a><span id="l29.90" class="difflineminus">-  *node = nsnull;</span>
<a href="#l29.91"></a><span id="l29.91" class="difflineminus">-  nsCOMPtr&lt;nsIRDFBlob&gt; blob;</span>
<a href="#l29.92"></a><span id="l29.92" class="difflineminus">-  nsresult rv = rdfService-&gt;GetBlobLiteral(value, length, getter_AddRefs(blob));</span>
<a href="#l29.93"></a><span id="l29.93" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l29.94"></a><span id="l29.94" class="difflineminus">-  NS_IF_ADDREF(*node = blob);</span>
<a href="#l29.95"></a><span id="l29.95" class="difflineminus">-  return rv;</span>
<a href="#l29.96"></a><span id="l29.96" class="difflineminus">-}</span>
<a href="#l29.97"></a><span id="l29.97" class="difflineminus">-</span>
<a href="#l29.98"></a><span id="l29.98" class="difflineminus">-PRBool nsAbRDFDataSource::changeEnumFunc(nsIRDFObserver *aObserver, void *aData)</span>
<a href="#l29.99"></a><span id="l29.99" class="difflineminus">-{</span>
<a href="#l29.100"></a><span id="l29.100" class="difflineminus">-  nsAbRDFNotification* note = (nsAbRDFNotification *)aData;</span>
<a href="#l29.101"></a><span id="l29.101" class="difflineminus">-  aObserver-&gt;OnChange(note-&gt;datasource,</span>
<a href="#l29.102"></a><span id="l29.102" class="difflineminus">-                     note-&gt;subject,</span>
<a href="#l29.103"></a><span id="l29.103" class="difflineminus">-                     note-&gt;property,</span>
<a href="#l29.104"></a><span id="l29.104" class="difflineminus">-                     nsnull, note-&gt;object);</span>
<a href="#l29.105"></a><span id="l29.105" class="difflineminus">-  return PR_TRUE;</span>
<a href="#l29.106"></a><span id="l29.106" class="difflineminus">-}</span>
<a href="#l29.107"></a><span id="l29.107" class="difflineminus">-</span>
<a href="#l29.108"></a><span id="l29.108" class="difflineminus">-PRBool nsAbRDFDataSource::assertEnumFunc(nsIRDFObserver *aObserver, void *aData)</span>
<a href="#l29.109"></a><span id="l29.109" class="difflineminus">-{</span>
<a href="#l29.110"></a><span id="l29.110" class="difflineminus">-  nsAbRDFNotification *note = (nsAbRDFNotification *)aData;</span>
<a href="#l29.111"></a><span id="l29.111" class="difflineminus">-  aObserver-&gt;OnAssert(note-&gt;datasource,</span>
<a href="#l29.112"></a><span id="l29.112" class="difflineminus">-                     note-&gt;subject,</span>
<a href="#l29.113"></a><span id="l29.113" class="difflineminus">-                     note-&gt;property,</span>
<a href="#l29.114"></a><span id="l29.114" class="difflineminus">-                     note-&gt;object);</span>
<a href="#l29.115"></a><span id="l29.115" class="difflineminus">-  return PR_TRUE;</span>
<a href="#l29.116"></a><span id="l29.116" class="difflineminus">-}</span>
<a href="#l29.117"></a><span id="l29.117" class="difflineminus">-</span>
<a href="#l29.118"></a><span id="l29.118" class="difflineminus">-PRBool nsAbRDFDataSource::unassertEnumFunc(nsIRDFObserver *aObserver, void *aData)</span>
<a href="#l29.119"></a><span id="l29.119" class="difflineminus">-{</span>
<a href="#l29.120"></a><span id="l29.120" class="difflineminus">-  nsAbRDFNotification* note = (nsAbRDFNotification *)aData;</span>
<a href="#l29.121"></a><span id="l29.121" class="difflineminus">-  aObserver-&gt;OnUnassert(note-&gt;datasource,</span>
<a href="#l29.122"></a><span id="l29.122" class="difflineminus">-                       note-&gt;subject,</span>
<a href="#l29.123"></a><span id="l29.123" class="difflineminus">-                       note-&gt;property,</span>
<a href="#l29.124"></a><span id="l29.124" class="difflineminus">-                       note-&gt;object);</span>
<a href="#l29.125"></a><span id="l29.125" class="difflineminus">-  return PR_TRUE;</span>
<a href="#l29.126"></a><span id="l29.126" class="difflineminus">-}</span>
<a href="#l29.127"></a><span id="l29.127" class="difflineminus">-</span>
<a href="#l29.128"></a><span id="l29.128" class="difflineminus">-nsresult nsAbRDFDataSource::CreateProxyObserver (nsIRDFObserver* observer,</span>
<a href="#l29.129"></a><span id="l29.129" class="difflineminus">-  nsIRDFObserver** proxyObserver)</span>
<a href="#l29.130"></a><span id="l29.130" class="difflineminus">-{</span>
<a href="#l29.131"></a><span id="l29.131" class="difflineminus">-  nsresult rv;</span>
<a href="#l29.132"></a><span id="l29.132" class="difflineminus">-</span>
<a href="#l29.133"></a><span id="l29.133" class="difflineminus">-  // Proxy the observer on the UI thread</span>
<a href="#l29.134"></a><span id="l29.134" class="difflineminus">-  /*</span>
<a href="#l29.135"></a><span id="l29.135" class="difflineminus">-   * TODO</span>
<a href="#l29.136"></a><span id="l29.136" class="difflineminus">-   * Currenly using NS_PROXY_ASYNC, however</span>
<a href="#l29.137"></a><span id="l29.137" class="difflineminus">-   * this can flood the event queue if</span>
<a href="#l29.138"></a><span id="l29.138" class="difflineminus">-   * rate of events on the observer is</span>
<a href="#l29.139"></a><span id="l29.139" class="difflineminus">-   * greater that the time to process the</span>
<a href="#l29.140"></a><span id="l29.140" class="difflineminus">-   * events.</span>
<a href="#l29.141"></a><span id="l29.141" class="difflineminus">-   * This causes the UI to pause.</span>
<a href="#l29.142"></a><span id="l29.142" class="difflineminus">-   */</span>
<a href="#l29.143"></a><span id="l29.143" class="difflineminus">-   nsCOMPtr&lt;nsIProxyObjectManager&gt; proxyObjMgr = do_GetService(NS_XPCOMPROXY_CONTRACTID, &amp;rv);</span>
<a href="#l29.144"></a><span id="l29.144" class="difflineminus">-   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l29.145"></a><span id="l29.145" class="difflineminus">-</span>
<a href="#l29.146"></a><span id="l29.146" class="difflineminus">-   rv = proxyObjMgr-&gt;GetProxyForObject (</span>
<a href="#l29.147"></a><span id="l29.147" class="difflineminus">-    NS_PROXY_TO_MAIN_THREAD,</span>
<a href="#l29.148"></a><span id="l29.148" class="difflineminus">-    NS_GET_IID(nsIRDFObserver),</span>
<a href="#l29.149"></a><span id="l29.149" class="difflineminus">-    observer,</span>
<a href="#l29.150"></a><span id="l29.150" class="difflineminus">-    NS_PROXY_ASYNC | NS_PROXY_ALWAYS,</span>
<a href="#l29.151"></a><span id="l29.151" class="difflineminus">-    (void** )proxyObserver);</span>
<a href="#l29.152"></a><span id="l29.152" class="difflineminus">-</span>
<a href="#l29.153"></a><span id="l29.153" class="difflineminus">-  return rv;</span>
<a href="#l29.154"></a><span id="l29.154" class="difflineminus">-}</span>
<a href="#l29.155"></a><span id="l29.155" class="difflineminus">-</span>
<a href="#l29.156"></a><span id="l29.156" class="difflineminus">-nsresult nsAbRDFDataSource::CreateProxyObservers ()</span>
<a href="#l29.157"></a><span id="l29.157" class="difflineminus">-{</span>
<a href="#l29.158"></a><span id="l29.158" class="difflineminus">-  nsresult rv = NS_OK;</span>
<a href="#l29.159"></a><span id="l29.159" class="difflineminus">-</span>
<a href="#l29.160"></a><span id="l29.160" class="difflineminus">-  PRUint32 nObservers = mObservers.Count();</span>
<a href="#l29.161"></a><span id="l29.161" class="difflineminus">-</span>
<a href="#l29.162"></a><span id="l29.162" class="difflineminus">-  PRUint32 nProxyObservers = mProxyObservers.Count();</span>
<a href="#l29.163"></a><span id="l29.163" class="difflineminus">-</span>
<a href="#l29.164"></a><span id="l29.164" class="difflineminus">-  /*</span>
<a href="#l29.165"></a><span id="l29.165" class="difflineminus">-   * For all the outstanding observers that</span>
<a href="#l29.166"></a><span id="l29.166" class="difflineminus">-   * have not been proxied</span>
<a href="#l29.167"></a><span id="l29.167" class="difflineminus">-   */</span>
<a href="#l29.168"></a><span id="l29.168" class="difflineminus">-  for (PRUint32 i = nProxyObservers; i &lt; nObservers; i++)</span>
<a href="#l29.169"></a><span id="l29.169" class="difflineminus">-  {</span>
<a href="#l29.170"></a><span id="l29.170" class="difflineminus">-    nsIRDFObserver * observer = mObservers.ObjectAt(i);</span>
<a href="#l29.171"></a><span id="l29.171" class="difflineminus">-</span>
<a href="#l29.172"></a><span id="l29.172" class="difflineminus">-    // Create the proxy</span>
<a href="#l29.173"></a><span id="l29.173" class="difflineminus">-    nsCOMPtr&lt;nsIRDFObserver&gt; proxyObserver;</span>
<a href="#l29.174"></a><span id="l29.174" class="difflineminus">-    rv = CreateProxyObserver (observer, getter_AddRefs (proxyObserver));</span>
<a href="#l29.175"></a><span id="l29.175" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l29.176"></a><span id="l29.176" class="difflineminus">-    mProxyObservers.AppendObject(proxyObserver);</span>
<a href="#l29.177"></a><span id="l29.177" class="difflineminus">-  }</span>
<a href="#l29.178"></a><span id="l29.178" class="difflineminus">-</span>
<a href="#l29.179"></a><span id="l29.179" class="difflineminus">-  return rv;</span>
<a href="#l29.180"></a><span id="l29.180" class="difflineminus">-}</span>
<a href="#l29.181"></a><span id="l29.181" class="difflineminus">-</span>
<a href="#l29.182"></a><span id="l29.182" class="difflineminus">-nsresult nsAbRDFDataSource::NotifyObservers(nsIRDFResource *subject,</span>
<a href="#l29.183"></a><span id="l29.183" class="difflineminus">-  nsIRDFResource *property,</span>
<a href="#l29.184"></a><span id="l29.184" class="difflineminus">-  nsIRDFNode *object,</span>
<a href="#l29.185"></a><span id="l29.185" class="difflineminus">-  PRBool assert,</span>
<a href="#l29.186"></a><span id="l29.186" class="difflineminus">-  PRBool change)</span>
<a href="#l29.187"></a><span id="l29.187" class="difflineminus">-{</span>
<a href="#l29.188"></a><span id="l29.188" class="difflineminus">-  NS_ASSERTION(!(change &amp;&amp; assert),</span>
<a href="#l29.189"></a><span id="l29.189" class="difflineminus">-                 &quot;Can't change and assert at the same time!\n&quot;);</span>
<a href="#l29.190"></a><span id="l29.190" class="difflineminus">-</span>
<a href="#l29.191"></a><span id="l29.191" class="difflineminus">-  nsresult rv;</span>
<a href="#l29.192"></a><span id="l29.192" class="difflineminus">-</span>
<a href="#l29.193"></a><span id="l29.193" class="difflineminus">-  MutexAutoLock lockGuard (mLock);</span>
<a href="#l29.194"></a><span id="l29.194" class="difflineminus">-</span>
<a href="#l29.195"></a><span id="l29.195" class="difflineminus">-  /*</span>
<a href="#l29.196"></a><span id="l29.196" class="difflineminus">-   * TODO</span>
<a href="#l29.197"></a><span id="l29.197" class="difflineminus">-   * Is the main thread always guaranteed to be</span>
<a href="#l29.198"></a><span id="l29.198" class="difflineminus">-   * the UI thread?</span>
<a href="#l29.199"></a><span id="l29.199" class="difflineminus">-   *</span>
<a href="#l29.200"></a><span id="l29.200" class="difflineminus">-   * Note that this also binds the data source</span>
<a href="#l29.201"></a><span id="l29.201" class="difflineminus">-   * to the UI which is supposedly the only</span>
<a href="#l29.202"></a><span id="l29.202" class="difflineminus">-   * place where it is used, but what about</span>
<a href="#l29.203"></a><span id="l29.203" class="difflineminus">-   * RDF datasources that are not UI specific</span>
<a href="#l29.204"></a><span id="l29.204" class="difflineminus">-   * but are used in the UI?</span>
<a href="#l29.205"></a><span id="l29.205" class="difflineminus">-   */</span>
<a href="#l29.206"></a><span id="l29.206" class="difflineminus">-  nsCOMArray&lt;nsIRDFObserver&gt; * observers;</span>
<a href="#l29.207"></a><span id="l29.207" class="difflineminus">-  if (NS_IsMainThread())</span>
<a href="#l29.208"></a><span id="l29.208" class="difflineminus">-  {</span>
<a href="#l29.209"></a><span id="l29.209" class="difflineminus">-    /*</span>
<a href="#l29.210"></a><span id="l29.210" class="difflineminus">-     * Since this is the UI Thread use the</span>
<a href="#l29.211"></a><span id="l29.211" class="difflineminus">-     * observers list directly for performance</span>
<a href="#l29.212"></a><span id="l29.212" class="difflineminus">-     */</span>
<a href="#l29.213"></a><span id="l29.213" class="difflineminus">-    observers = &amp;mObservers;</span>
<a href="#l29.214"></a><span id="l29.214" class="difflineminus">-  }</span>
<a href="#l29.215"></a><span id="l29.215" class="difflineminus">-  else</span>
<a href="#l29.216"></a><span id="l29.216" class="difflineminus">-  {</span>
<a href="#l29.217"></a><span id="l29.217" class="difflineminus">-    /*</span>
<a href="#l29.218"></a><span id="l29.218" class="difflineminus">-     * This is a different thread to the UI</span>
<a href="#l29.219"></a><span id="l29.219" class="difflineminus">-     * thread need to use proxies to the</span>
<a href="#l29.220"></a><span id="l29.220" class="difflineminus">-     * observers</span>
<a href="#l29.221"></a><span id="l29.221" class="difflineminus">-     *</span>
<a href="#l29.222"></a><span id="l29.222" class="difflineminus">-     * Create the proxies</span>
<a href="#l29.223"></a><span id="l29.223" class="difflineminus">-     */</span>
<a href="#l29.224"></a><span id="l29.224" class="difflineminus">-    rv = CreateProxyObservers();</span>
<a href="#l29.225"></a><span id="l29.225" class="difflineminus">-    NS_ENSURE_SUCCESS (rv, rv);</span>
<a href="#l29.226"></a><span id="l29.226" class="difflineminus">-    observers = &amp;mProxyObservers;</span>
<a href="#l29.227"></a><span id="l29.227" class="difflineminus">-  }</span>
<a href="#l29.228"></a><span id="l29.228" class="difflineminus">-</span>
<a href="#l29.229"></a><span id="l29.229" class="difflineminus">-  nsAbRDFNotification note = { this, subject, property, object };</span>
<a href="#l29.230"></a><span id="l29.230" class="difflineminus">-  if (change)</span>
<a href="#l29.231"></a><span id="l29.231" class="difflineminus">-    observers-&gt;EnumerateForwards(changeEnumFunc, &amp;note);</span>
<a href="#l29.232"></a><span id="l29.232" class="difflineminus">-  else if (assert)</span>
<a href="#l29.233"></a><span id="l29.233" class="difflineminus">-    observers-&gt;EnumerateForwards(assertEnumFunc, &amp;note);</span>
<a href="#l29.234"></a><span id="l29.234" class="difflineminus">-  else</span>
<a href="#l29.235"></a><span id="l29.235" class="difflineminus">-    observers-&gt;EnumerateForwards(unassertEnumFunc, &amp;note);</span>
<a href="#l29.236"></a><span id="l29.236" class="difflineminus">-</span>
<a href="#l29.237"></a><span id="l29.237" class="difflineminus">-  return NS_OK;</span>
<a href="#l29.238"></a><span id="l29.238" class="difflineminus">-}</span>
<a href="#l29.239"></a><span id="l29.239" class="difflineminus">-</span>
<a href="#l29.240"></a><span id="l29.240" class="difflineminus">-nsresult nsAbRDFDataSource::NotifyPropertyChanged(nsIRDFResource *resource,</span>
<a href="#l29.241"></a><span id="l29.241" class="difflineminus">-  nsIRDFResource *propertyResource,</span>
<a href="#l29.242"></a><span id="l29.242" class="difflineminus">-  const PRUnichar *oldValue,</span>
<a href="#l29.243"></a><span id="l29.243" class="difflineminus">-  const PRUnichar *newValue)</span>
<a href="#l29.244"></a><span id="l29.244" class="difflineminus">-{</span>
<a href="#l29.245"></a><span id="l29.245" class="difflineminus">-  nsCOMPtr&lt;nsIRDFNode&gt; newValueNode;</span>
<a href="#l29.246"></a><span id="l29.246" class="difflineminus">-  createNode(newValue, getter_AddRefs(newValueNode));</span>
<a href="#l29.247"></a><span id="l29.247" class="difflineminus">-  NotifyObservers(resource, propertyResource, newValueNode, PR_FALSE, PR_TRUE);</span>
<a href="#l29.248"></a><span id="l29.248" class="difflineminus">-  return NS_OK;</span>
<a href="#l29.249"></a><span id="l29.249" class="difflineminus">-}</span>
<a href="#l29.250"></a><span id="l29.250" class="difflineminus">-</span>
<a href="#l29.251"></a><span id="l29.251" class="difflineminus">-</span>
<a href="#l29.252"></a><span id="l29.252" class="difflineminus">-nsAbRDFDataSource::nsAbRDFDataSource():</span>
<a href="#l29.253"></a><span id="l29.253" class="difflineminus">-  mLock(&quot;nsAbRDFDataSource.mLock&quot;)</span>
<a href="#l29.254"></a><span id="l29.254" class="difflineminus">-{</span>
<a href="#l29.255"></a><span id="l29.255" class="difflineminus">-}</span>
<a href="#l29.256"></a><span id="l29.256" class="difflineminus">-</span>
<a href="#l29.257"></a><span id="l29.257" class="difflineminus">-nsAbRDFDataSource::~nsAbRDFDataSource (void)</span>
<a href="#l29.258"></a><span id="l29.258" class="difflineminus">-{</span>
<a href="#l29.259"></a><span id="l29.259" class="difflineminus">-}</span>
<a href="#l29.260"></a><span id="l29.260" class="difflineminus">-</span>
<a href="#l29.261"></a><span id="l29.261" class="difflineminus">-NS_IMPL_CYCLE_COLLECTION_CLASS(nsAbRDFDataSource)</span>
<a href="#l29.262"></a><span id="l29.262" class="difflineminus">-NS_IMPL_CYCLE_COLLECTION_UNLINK_BEGIN(nsAbRDFDataSource)</span>
<a href="#l29.263"></a><span id="l29.263" class="difflineminus">-  NS_IMPL_CYCLE_COLLECTION_UNLINK_NSCOMARRAY(mObservers)</span>
<a href="#l29.264"></a><span id="l29.264" class="difflineminus">-  NS_IMPL_CYCLE_COLLECTION_UNLINK_NSCOMARRAY(mProxyObservers)</span>
<a href="#l29.265"></a><span id="l29.265" class="difflineminus">-NS_IMPL_CYCLE_COLLECTION_UNLINK_END</span>
<a href="#l29.266"></a><span id="l29.266" class="difflineminus">-NS_IMPL_CYCLE_COLLECTION_TRAVERSE_BEGIN(nsAbRDFDataSource)</span>
<a href="#l29.267"></a><span id="l29.267" class="difflineminus">-  NS_IMPL_CYCLE_COLLECTION_TRAVERSE_NSCOMARRAY(mObservers)</span>
<a href="#l29.268"></a><span id="l29.268" class="difflineminus">-  NS_IMPL_CYCLE_COLLECTION_TRAVERSE_NSCOMARRAY(mProxyObservers)</span>
<a href="#l29.269"></a><span id="l29.269" class="difflineminus">-NS_IMPL_CYCLE_COLLECTION_TRAVERSE_END</span>
<a href="#l29.270"></a><span id="l29.270" class="difflineminus">-</span>
<a href="#l29.271"></a><span id="l29.271" class="difflineminus">-NS_IMPL_CYCLE_COLLECTING_ADDREF(nsAbRDFDataSource)</span>
<a href="#l29.272"></a><span id="l29.272" class="difflineminus">-NS_IMPL_CYCLE_COLLECTING_RELEASE(nsAbRDFDataSource)</span>
<a href="#l29.273"></a><span id="l29.273" class="difflineminus">-</span>
<a href="#l29.274"></a><span id="l29.274" class="difflineminus">-NS_INTERFACE_MAP_BEGIN(nsAbRDFDataSource)</span>
<a href="#l29.275"></a><span id="l29.275" class="difflineminus">-  NS_INTERFACE_MAP_ENTRY(nsIRDFDataSource)</span>
<a href="#l29.276"></a><span id="l29.276" class="difflineminus">-  NS_INTERFACE_MAP_ENTRY_AMBIGUOUS(nsISupports, nsIRDFDataSource)</span>
<a href="#l29.277"></a><span id="l29.277" class="difflineminus">-  NS_INTERFACE_MAP_ENTRIES_CYCLE_COLLECTION(nsAbRDFDataSource)</span>
<a href="#l29.278"></a><span id="l29.278" class="difflineminus">-NS_INTERFACE_MAP_END</span>
<a href="#l29.279"></a><span id="l29.279" class="difflineminus">-</span>
<a href="#l29.280"></a><span id="l29.280" class="difflineminus">- // nsIRDFDataSource methods</span>
<a href="#l29.281"></a><span id="l29.281" class="difflineminus">-NS_IMETHODIMP nsAbRDFDataSource::GetURI(char* *uri)</span>
<a href="#l29.282"></a><span id="l29.282" class="difflineminus">-{</span>
<a href="#l29.283"></a><span id="l29.283" class="difflineminus">-    NS_NOTREACHED(&quot;should be implemented by a subclass&quot;);</span>
<a href="#l29.284"></a><span id="l29.284" class="difflineminus">-    return NS_ERROR_UNEXPECTED;</span>
<a href="#l29.285"></a><span id="l29.285" class="difflineminus">-}</span>
<a href="#l29.286"></a><span id="l29.286" class="difflineminus">-</span>
<a href="#l29.287"></a><span id="l29.287" class="difflineminus">-NS_IMETHODIMP nsAbRDFDataSource::GetSource(nsIRDFResource* property,</span>
<a href="#l29.288"></a><span id="l29.288" class="difflineminus">-                                               nsIRDFNode* target,</span>
<a href="#l29.289"></a><span id="l29.289" class="difflineminus">-                                               PRBool tv,</span>
<a href="#l29.290"></a><span id="l29.290" class="difflineminus">-                                               nsIRDFResource** source /* out */)</span>
<a href="#l29.291"></a><span id="l29.291" class="difflineminus">-{</span>
<a href="#l29.292"></a><span id="l29.292" class="difflineminus">-    return NS_RDF_NO_VALUE;</span>
<a href="#l29.293"></a><span id="l29.293" class="difflineminus">-}</span>
<a href="#l29.294"></a><span id="l29.294" class="difflineminus">-</span>
<a href="#l29.295"></a><span id="l29.295" class="difflineminus">-NS_IMETHODIMP nsAbRDFDataSource::GetTarget(nsIRDFResource* source,</span>
<a href="#l29.296"></a><span id="l29.296" class="difflineminus">-                                               nsIRDFResource* property,</span>
<a href="#l29.297"></a><span id="l29.297" class="difflineminus">-                                               PRBool tv,</span>
<a href="#l29.298"></a><span id="l29.298" class="difflineminus">-                                               nsIRDFNode** target)</span>
<a href="#l29.299"></a><span id="l29.299" class="difflineminus">-{</span>
<a href="#l29.300"></a><span id="l29.300" class="difflineminus">-    return NS_RDF_NO_VALUE;</span>
<a href="#l29.301"></a><span id="l29.301" class="difflineminus">-}</span>
<a href="#l29.302"></a><span id="l29.302" class="difflineminus">-</span>
<a href="#l29.303"></a><span id="l29.303" class="difflineminus">-</span>
<a href="#l29.304"></a><span id="l29.304" class="difflineminus">-NS_IMETHODIMP nsAbRDFDataSource::GetSources(nsIRDFResource* property,</span>
<a href="#l29.305"></a><span id="l29.305" class="difflineminus">-                                                nsIRDFNode* target,</span>
<a href="#l29.306"></a><span id="l29.306" class="difflineminus">-                                                PRBool tv,</span>
<a href="#l29.307"></a><span id="l29.307" class="difflineminus">-                                                nsISimpleEnumerator** sources)</span>
<a href="#l29.308"></a><span id="l29.308" class="difflineminus">-{</span>
<a href="#l29.309"></a><span id="l29.309" class="difflineminus">-    return NS_RDF_NO_VALUE;</span>
<a href="#l29.310"></a><span id="l29.310" class="difflineminus">-}</span>
<a href="#l29.311"></a><span id="l29.311" class="difflineminus">-</span>
<a href="#l29.312"></a><span id="l29.312" class="difflineminus">-NS_IMETHODIMP nsAbRDFDataSource::GetTargets(nsIRDFResource* source,</span>
<a href="#l29.313"></a><span id="l29.313" class="difflineminus">-                                                nsIRDFResource* property,</span>
<a href="#l29.314"></a><span id="l29.314" class="difflineminus">-                                                PRBool tv,</span>
<a href="#l29.315"></a><span id="l29.315" class="difflineminus">-                                                nsISimpleEnumerator** targets)</span>
<a href="#l29.316"></a><span id="l29.316" class="difflineminus">-{</span>
<a href="#l29.317"></a><span id="l29.317" class="difflineminus">-    return NS_RDF_NO_VALUE;</span>
<a href="#l29.318"></a><span id="l29.318" class="difflineminus">-}</span>
<a href="#l29.319"></a><span id="l29.319" class="difflineminus">-</span>
<a href="#l29.320"></a><span id="l29.320" class="difflineminus">-NS_IMETHODIMP nsAbRDFDataSource::Assert(nsIRDFResource* source,</span>
<a href="#l29.321"></a><span id="l29.321" class="difflineminus">-                      nsIRDFResource* property,</span>
<a href="#l29.322"></a><span id="l29.322" class="difflineminus">-                      nsIRDFNode* target,</span>
<a href="#l29.323"></a><span id="l29.323" class="difflineminus">-                      PRBool tv)</span>
<a href="#l29.324"></a><span id="l29.324" class="difflineminus">-{</span>
<a href="#l29.325"></a><span id="l29.325" class="difflineminus">-    return NS_RDF_NO_VALUE;</span>
<a href="#l29.326"></a><span id="l29.326" class="difflineminus">-}</span>
<a href="#l29.327"></a><span id="l29.327" class="difflineminus">-</span>
<a href="#l29.328"></a><span id="l29.328" class="difflineminus">-NS_IMETHODIMP nsAbRDFDataSource::Unassert(nsIRDFResource* source,</span>
<a href="#l29.329"></a><span id="l29.329" class="difflineminus">-                        nsIRDFResource* property,</span>
<a href="#l29.330"></a><span id="l29.330" class="difflineminus">-                        nsIRDFNode* target)</span>
<a href="#l29.331"></a><span id="l29.331" class="difflineminus">-{</span>
<a href="#l29.332"></a><span id="l29.332" class="difflineminus">-    return NS_RDF_NO_VALUE;</span>
<a href="#l29.333"></a><span id="l29.333" class="difflineminus">-}</span>
<a href="#l29.334"></a><span id="l29.334" class="difflineminus">-</span>
<a href="#l29.335"></a><span id="l29.335" class="difflineminus">-NS_IMETHODIMP nsAbRDFDataSource::Change(nsIRDFResource *aSource,</span>
<a href="#l29.336"></a><span id="l29.336" class="difflineminus">-                                              nsIRDFResource *aProperty,</span>
<a href="#l29.337"></a><span id="l29.337" class="difflineminus">-                                              nsIRDFNode *aOldTarget,</span>
<a href="#l29.338"></a><span id="l29.338" class="difflineminus">-                                              nsIRDFNode *aNewTarget)</span>
<a href="#l29.339"></a><span id="l29.339" class="difflineminus">-{</span>
<a href="#l29.340"></a><span id="l29.340" class="difflineminus">-    return NS_RDF_NO_VALUE;</span>
<a href="#l29.341"></a><span id="l29.341" class="difflineminus">-}</span>
<a href="#l29.342"></a><span id="l29.342" class="difflineminus">-</span>
<a href="#l29.343"></a><span id="l29.343" class="difflineminus">-NS_IMETHODIMP nsAbRDFDataSource::Move(nsIRDFResource *aOldSource,</span>
<a href="#l29.344"></a><span id="l29.344" class="difflineminus">-                                            nsIRDFResource *aNewSource,</span>
<a href="#l29.345"></a><span id="l29.345" class="difflineminus">-                                            nsIRDFResource *aProperty,</span>
<a href="#l29.346"></a><span id="l29.346" class="difflineminus">-                                            nsIRDFNode *aTarget)</span>
<a href="#l29.347"></a><span id="l29.347" class="difflineminus">-{</span>
<a href="#l29.348"></a><span id="l29.348" class="difflineminus">-    return NS_RDF_NO_VALUE;</span>
<a href="#l29.349"></a><span id="l29.349" class="difflineminus">-}</span>
<a href="#l29.350"></a><span id="l29.350" class="difflineminus">-</span>
<a href="#l29.351"></a><span id="l29.351" class="difflineminus">-</span>
<a href="#l29.352"></a><span id="l29.352" class="difflineminus">-NS_IMETHODIMP nsAbRDFDataSource::HasAssertion(nsIRDFResource* source,</span>
<a href="#l29.353"></a><span id="l29.353" class="difflineminus">-                            nsIRDFResource* property,</span>
<a href="#l29.354"></a><span id="l29.354" class="difflineminus">-                            nsIRDFNode* target,</span>
<a href="#l29.355"></a><span id="l29.355" class="difflineminus">-                            PRBool tv,</span>
<a href="#l29.356"></a><span id="l29.356" class="difflineminus">-                            PRBool* hasAssertion)</span>
<a href="#l29.357"></a><span id="l29.357" class="difflineminus">-{</span>
<a href="#l29.358"></a><span id="l29.358" class="difflineminus">-    *hasAssertion = PR_FALSE;</span>
<a href="#l29.359"></a><span id="l29.359" class="difflineminus">-    return NS_OK;</span>
<a href="#l29.360"></a><span id="l29.360" class="difflineminus">-}</span>
<a href="#l29.361"></a><span id="l29.361" class="difflineminus">-</span>
<a href="#l29.362"></a><span id="l29.362" class="difflineminus">-NS_IMETHODIMP nsAbRDFDataSource::AddObserver(nsIRDFObserver* observer)</span>
<a href="#l29.363"></a><span id="l29.363" class="difflineminus">-{</span>
<a href="#l29.364"></a><span id="l29.364" class="difflineminus">-  // Lock the whole method</span>
<a href="#l29.365"></a><span id="l29.365" class="difflineminus">-  MutexAutoLock lockGuard (mLock);</span>
<a href="#l29.366"></a><span id="l29.366" class="difflineminus">-</span>
<a href="#l29.367"></a><span id="l29.367" class="difflineminus">-  // Do not add if already present</span>
<a href="#l29.368"></a><span id="l29.368" class="difflineminus">-  if (mObservers.IndexOf(observer) &gt;= 0)</span>
<a href="#l29.369"></a><span id="l29.369" class="difflineminus">-    return NS_OK;</span>
<a href="#l29.370"></a><span id="l29.370" class="difflineminus">-</span>
<a href="#l29.371"></a><span id="l29.371" class="difflineminus">-  mObservers.AppendObject(observer);</span>
<a href="#l29.372"></a><span id="l29.372" class="difflineminus">-  return NS_OK;</span>
<a href="#l29.373"></a><span id="l29.373" class="difflineminus">-}</span>
<a href="#l29.374"></a><span id="l29.374" class="difflineminus">-</span>
<a href="#l29.375"></a><span id="l29.375" class="difflineminus">-NS_IMETHODIMP nsAbRDFDataSource::RemoveObserver(nsIRDFObserver* observer)</span>
<a href="#l29.376"></a><span id="l29.376" class="difflineminus">-{</span>
<a href="#l29.377"></a><span id="l29.377" class="difflineminus">-  // Lock the whole method</span>
<a href="#l29.378"></a><span id="l29.378" class="difflineminus">-  MutexAutoLock lockGuard (mLock);</span>
<a href="#l29.379"></a><span id="l29.379" class="difflineminus">-  PRInt32 index = mObservers.IndexOf(observer);</span>
<a href="#l29.380"></a><span id="l29.380" class="difflineminus">-  if (index &gt;= 0)</span>
<a href="#l29.381"></a><span id="l29.381" class="difflineminus">-  {</span>
<a href="#l29.382"></a><span id="l29.382" class="difflineminus">-    mObservers.RemoveObjectAt(index);</span>
<a href="#l29.383"></a><span id="l29.383" class="difflineminus">-    mProxyObservers.RemoveObjectAt(index);</span>
<a href="#l29.384"></a><span id="l29.384" class="difflineminus">-  }</span>
<a href="#l29.385"></a><span id="l29.385" class="difflineminus">-</span>
<a href="#l29.386"></a><span id="l29.386" class="difflineminus">-  return NS_OK;</span>
<a href="#l29.387"></a><span id="l29.387" class="difflineminus">-}</span>
<a href="#l29.388"></a><span id="l29.388" class="difflineminus">-</span>
<a href="#l29.389"></a><span id="l29.389" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l29.390"></a><span id="l29.390" class="difflineminus">-nsAbRDFDataSource::HasArcIn(nsIRDFNode *aNode, nsIRDFResource *aArc, PRBool *result)</span>
<a href="#l29.391"></a><span id="l29.391" class="difflineminus">-{</span>
<a href="#l29.392"></a><span id="l29.392" class="difflineminus">-  *result = PR_FALSE;</span>
<a href="#l29.393"></a><span id="l29.393" class="difflineminus">-  return NS_OK;</span>
<a href="#l29.394"></a><span id="l29.394" class="difflineminus">-}</span>
<a href="#l29.395"></a><span id="l29.395" class="difflineminus">-</span>
<a href="#l29.396"></a><span id="l29.396" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l29.397"></a><span id="l29.397" class="difflineminus">-nsAbRDFDataSource::HasArcOut(nsIRDFResource *aSource, nsIRDFResource *aArc, PRBool *result)</span>
<a href="#l29.398"></a><span id="l29.398" class="difflineminus">-{</span>
<a href="#l29.399"></a><span id="l29.399" class="difflineminus">-  *result = PR_FALSE;</span>
<a href="#l29.400"></a><span id="l29.400" class="difflineminus">-  return NS_OK;</span>
<a href="#l29.401"></a><span id="l29.401" class="difflineminus">-}</span>
<a href="#l29.402"></a><span id="l29.402" class="difflineminus">-</span>
<a href="#l29.403"></a><span id="l29.403" class="difflineminus">-NS_IMETHODIMP nsAbRDFDataSource::ArcLabelsIn(nsIRDFNode* node,</span>
<a href="#l29.404"></a><span id="l29.404" class="difflineminus">-                                                nsISimpleEnumerator** labels)</span>
<a href="#l29.405"></a><span id="l29.405" class="difflineminus">-{</span>
<a href="#l29.406"></a><span id="l29.406" class="difflineminus">-    return NS_RDF_NO_VALUE;</span>
<a href="#l29.407"></a><span id="l29.407" class="difflineminus">-}</span>
<a href="#l29.408"></a><span id="l29.408" class="difflineminus">-</span>
<a href="#l29.409"></a><span id="l29.409" class="difflineminus">-NS_IMETHODIMP nsAbRDFDataSource::ArcLabelsOut(nsIRDFResource* source,</span>
<a href="#l29.410"></a><span id="l29.410" class="difflineminus">-                                                 nsISimpleEnumerator** labels)</span>
<a href="#l29.411"></a><span id="l29.411" class="difflineminus">-{</span>
<a href="#l29.412"></a><span id="l29.412" class="difflineminus">-    return NS_RDF_NO_VALUE;</span>
<a href="#l29.413"></a><span id="l29.413" class="difflineminus">-}</span>
<a href="#l29.414"></a><span id="l29.414" class="difflineminus">-</span>
<a href="#l29.415"></a><span id="l29.415" class="difflineminus">-NS_IMETHODIMP nsAbRDFDataSource::GetAllResources(nsISimpleEnumerator** aCursor)</span>
<a href="#l29.416"></a><span id="l29.416" class="difflineminus">-{</span>
<a href="#l29.417"></a><span id="l29.417" class="difflineminus">-    return NS_RDF_NO_VALUE;</span>
<a href="#l29.418"></a><span id="l29.418" class="difflineminus">-}</span>
<a href="#l29.419"></a><span id="l29.419" class="difflineminus">-</span>
<a href="#l29.420"></a><span id="l29.420" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l29.421"></a><span id="l29.421" class="difflineminus">-nsAbRDFDataSource::GetAllCmds(nsIRDFResource* source,</span>
<a href="#l29.422"></a><span id="l29.422" class="difflineminus">-                                      nsISimpleEnumerator/*&lt;nsIRDFResource&gt;*/** commands)</span>
<a href="#l29.423"></a><span id="l29.423" class="difflineminus">-{</span>
<a href="#l29.424"></a><span id="l29.424" class="difflineminus">-    return NS_RDF_NO_VALUE;</span>
<a href="#l29.425"></a><span id="l29.425" class="difflineminus">-}</span>
<a href="#l29.426"></a><span id="l29.426" class="difflineminus">-</span>
<a href="#l29.427"></a><span id="l29.427" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l29.428"></a><span id="l29.428" class="difflineminus">-nsAbRDFDataSource::IsCommandEnabled(nsISupportsArray/*&lt;nsIRDFResource&gt;*/* aSources,</span>
<a href="#l29.429"></a><span id="l29.429" class="difflineminus">-                                        nsIRDFResource*   aCommand,</span>
<a href="#l29.430"></a><span id="l29.430" class="difflineminus">-                                        nsISupportsArray/*&lt;nsIRDFResource&gt;*/* aArguments,</span>
<a href="#l29.431"></a><span id="l29.431" class="difflineminus">-                                        PRBool* aResult)</span>
<a href="#l29.432"></a><span id="l29.432" class="difflineminus">-{</span>
<a href="#l29.433"></a><span id="l29.433" class="difflineminus">-    return NS_RDF_NO_VALUE;</span>
<a href="#l29.434"></a><span id="l29.434" class="difflineminus">-}</span>
<a href="#l29.435"></a><span id="l29.435" class="difflineminus">-</span>
<a href="#l29.436"></a><span id="l29.436" class="difflineminus">-NS_IMETHODIMP nsAbRDFDataSource::DoCommand</span>
<a href="#l29.437"></a><span id="l29.437" class="difflineminus">-(nsISupportsArray * aSources, nsIRDFResource* aCommand, nsISupportsArray * aArguments)</span>
<a href="#l29.438"></a><span id="l29.438" class="difflineminus">-{</span>
<a href="#l29.439"></a><span id="l29.439" class="difflineminus">-    return NS_RDF_NO_VALUE;</span>
<a href="#l29.440"></a><span id="l29.440" class="difflineminus">-}</span>
<a href="#l29.441"></a><span id="l29.441" class="difflineminus">-</span>
<a href="#l29.442"></a><span id="l29.442" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l29.443"></a><span id="l29.443" class="difflineminus">-nsAbRDFDataSource::BeginUpdateBatch()</span>
<a href="#l29.444"></a><span id="l29.444" class="difflineminus">-{</span>
<a href="#l29.445"></a><span id="l29.445" class="difflineminus">-    return NS_OK;</span>
<a href="#l29.446"></a><span id="l29.446" class="difflineminus">-}</span>
<a href="#l29.447"></a><span id="l29.447" class="difflineminus">-</span>
<a href="#l29.448"></a><span id="l29.448" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l29.449"></a><span id="l29.449" class="difflineminus">-nsAbRDFDataSource::EndUpdateBatch()</span>
<a href="#l29.450"></a><span id="l29.450" class="difflineminus">-{</span>
<a href="#l29.451"></a><span id="l29.451" class="difflineminus">-    return NS_OK;</span>
<a href="#l29.452"></a><span id="l29.452" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1">deleted file mode 100644</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineminus">--- a/mailnews/addrbook/src/nsAbRDFDataSource.h</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineplus">+++ /dev/null</span>
<a href="#l30.4"></a><span id="l30.4" class="difflineat">@@ -1,97 +0,0 @@</span>
<a href="#l30.5"></a><span id="l30.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l30.6"></a><span id="l30.6" class="difflineminus">-/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l30.7"></a><span id="l30.7" class="difflineminus">- * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l30.8"></a><span id="l30.8" class="difflineminus">- *</span>
<a href="#l30.9"></a><span id="l30.9" class="difflineminus">- * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l30.10"></a><span id="l30.10" class="difflineminus">- * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l30.11"></a><span id="l30.11" class="difflineminus">- * the License. You may obtain a copy of the License at</span>
<a href="#l30.12"></a><span id="l30.12" class="difflineminus">- * http://www.mozilla.org/MPL/</span>
<a href="#l30.13"></a><span id="l30.13" class="difflineminus">- *</span>
<a href="#l30.14"></a><span id="l30.14" class="difflineminus">- * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l30.15"></a><span id="l30.15" class="difflineminus">- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l30.16"></a><span id="l30.16" class="difflineminus">- * for the specific language governing rights and limitations under the</span>
<a href="#l30.17"></a><span id="l30.17" class="difflineminus">- * License.</span>
<a href="#l30.18"></a><span id="l30.18" class="difflineminus">- *</span>
<a href="#l30.19"></a><span id="l30.19" class="difflineminus">- * The Original Code is mozilla.org code.</span>
<a href="#l30.20"></a><span id="l30.20" class="difflineminus">- *</span>
<a href="#l30.21"></a><span id="l30.21" class="difflineminus">- * The Initial Developer of the Original Code is</span>
<a href="#l30.22"></a><span id="l30.22" class="difflineminus">- * Netscape Communications Corporation.</span>
<a href="#l30.23"></a><span id="l30.23" class="difflineminus">- * Portions created by the Initial Developer are Copyright (C) 1999</span>
<a href="#l30.24"></a><span id="l30.24" class="difflineminus">- * the Initial Developer. All Rights Reserved.</span>
<a href="#l30.25"></a><span id="l30.25" class="difflineminus">- *</span>
<a href="#l30.26"></a><span id="l30.26" class="difflineminus">- * Contributor(s):</span>
<a href="#l30.27"></a><span id="l30.27" class="difflineminus">- *</span>
<a href="#l30.28"></a><span id="l30.28" class="difflineminus">- * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l30.29"></a><span id="l30.29" class="difflineminus">- * either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l30.30"></a><span id="l30.30" class="difflineminus">- * or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l30.31"></a><span id="l30.31" class="difflineminus">- * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l30.32"></a><span id="l30.32" class="difflineminus">- * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l30.33"></a><span id="l30.33" class="difflineminus">- * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l30.34"></a><span id="l30.34" class="difflineminus">- * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l30.35"></a><span id="l30.35" class="difflineminus">- * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l30.36"></a><span id="l30.36" class="difflineminus">- * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l30.37"></a><span id="l30.37" class="difflineminus">- * the provisions above, a recipient may use your version of this file under</span>
<a href="#l30.38"></a><span id="l30.38" class="difflineminus">- * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l30.39"></a><span id="l30.39" class="difflineminus">- *</span>
<a href="#l30.40"></a><span id="l30.40" class="difflineminus">- * ***** END LICENSE BLOCK ***** */</span>
<a href="#l30.41"></a><span id="l30.41" class="difflineminus">-</span>
<a href="#l30.42"></a><span id="l30.42" class="difflineminus">-#ifndef nsAbRDFDataSource_h__</span>
<a href="#l30.43"></a><span id="l30.43" class="difflineminus">-#define nsAbRDFDataSource_h__</span>
<a href="#l30.44"></a><span id="l30.44" class="difflineminus">-</span>
<a href="#l30.45"></a><span id="l30.45" class="difflineminus">-#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l30.46"></a><span id="l30.46" class="difflineminus">-#include &quot;nsIRDFDataSource.h&quot;</span>
<a href="#l30.47"></a><span id="l30.47" class="difflineminus">-#include &quot;nsIRDFService.h&quot;</span>
<a href="#l30.48"></a><span id="l30.48" class="difflineminus">-#include &quot;nsCOMArray.h&quot;</span>
<a href="#l30.49"></a><span id="l30.49" class="difflineminus">-#include &quot;nsStringGlue.h&quot;</span>
<a href="#l30.50"></a><span id="l30.50" class="difflineminus">-#include &quot;nsCycleCollectionParticipant.h&quot;</span>
<a href="#l30.51"></a><span id="l30.51" class="difflineminus">-#include &quot;mozilla/Mutex.h&quot;</span>
<a href="#l30.52"></a><span id="l30.52" class="difflineminus">-</span>
<a href="#l30.53"></a><span id="l30.53" class="difflineminus">-/**</span>
<a href="#l30.54"></a><span id="l30.54" class="difflineminus">- * The addressbook data source.</span>
<a href="#l30.55"></a><span id="l30.55" class="difflineminus">- */</span>
<a href="#l30.56"></a><span id="l30.56" class="difflineminus">-class nsAbRDFDataSource : public nsIRDFDataSource</span>
<a href="#l30.57"></a><span id="l30.57" class="difflineminus">-{</span>
<a href="#l30.58"></a><span id="l30.58" class="difflineminus">-public:</span>
<a href="#l30.59"></a><span id="l30.59" class="difflineminus">-  NS_DECL_CYCLE_COLLECTING_ISUPPORTS</span>
<a href="#l30.60"></a><span id="l30.60" class="difflineminus">-  NS_DECL_CYCLE_COLLECTION_CLASS_AMBIGUOUS(nsAbRDFDataSource,</span>
<a href="#l30.61"></a><span id="l30.61" class="difflineminus">-                                           nsIRDFDataSource)</span>
<a href="#l30.62"></a><span id="l30.62" class="difflineminus">-  NS_DECL_NSIRDFDATASOURCE</span>
<a href="#l30.63"></a><span id="l30.63" class="difflineminus">-</span>
<a href="#l30.64"></a><span id="l30.64" class="difflineminus">-  nsAbRDFDataSource();</span>
<a href="#l30.65"></a><span id="l30.65" class="difflineminus">-  virtual ~nsAbRDFDataSource();</span>
<a href="#l30.66"></a><span id="l30.66" class="difflineminus">-</span>
<a href="#l30.67"></a><span id="l30.67" class="difflineminus">-protected:</span>
<a href="#l30.68"></a><span id="l30.68" class="difflineminus">-</span>
<a href="#l30.69"></a><span id="l30.69" class="difflineminus">-  nsresult createNode(const PRUnichar *str, nsIRDFNode **node);</span>
<a href="#l30.70"></a><span id="l30.70" class="difflineminus">-  nsresult createBlobNode(PRUint8 *value, PRUint32 &amp;length, nsIRDFNode **node, nsIRDFService *rdfService);</span>
<a href="#l30.71"></a><span id="l30.71" class="difflineminus">-</span>
<a href="#l30.72"></a><span id="l30.72" class="difflineminus">-  nsresult NotifyPropertyChanged(</span>
<a href="#l30.73"></a><span id="l30.73" class="difflineminus">-    nsIRDFResource *resource,</span>
<a href="#l30.74"></a><span id="l30.74" class="difflineminus">-    nsIRDFResource *propertyResource,</span>
<a href="#l30.75"></a><span id="l30.75" class="difflineminus">-    const PRUnichar *oldValue,</span>
<a href="#l30.76"></a><span id="l30.76" class="difflineminus">-    const PRUnichar *newValue);</span>
<a href="#l30.77"></a><span id="l30.77" class="difflineminus">-</span>
<a href="#l30.78"></a><span id="l30.78" class="difflineminus">-  nsresult NotifyObservers(</span>
<a href="#l30.79"></a><span id="l30.79" class="difflineminus">-    nsIRDFResource *subject,</span>
<a href="#l30.80"></a><span id="l30.80" class="difflineminus">-    nsIRDFResource *property,</span>
<a href="#l30.81"></a><span id="l30.81" class="difflineminus">-    nsIRDFNode *object,</span>
<a href="#l30.82"></a><span id="l30.82" class="difflineminus">-    PRBool assert,</span>
<a href="#l30.83"></a><span id="l30.83" class="difflineminus">-    PRBool change);</span>
<a href="#l30.84"></a><span id="l30.84" class="difflineminus">-</span>
<a href="#l30.85"></a><span id="l30.85" class="difflineminus">-  nsresult CreateProxyObservers ();</span>
<a href="#l30.86"></a><span id="l30.86" class="difflineminus">-</span>
<a href="#l30.87"></a><span id="l30.87" class="difflineminus">-  nsresult CreateProxyObserver (</span>
<a href="#l30.88"></a><span id="l30.88" class="difflineminus">-  nsIRDFObserver* observer,</span>
<a href="#l30.89"></a><span id="l30.89" class="difflineminus">-  nsIRDFObserver** proxyObserver);</span>
<a href="#l30.90"></a><span id="l30.90" class="difflineminus">-</span>
<a href="#l30.91"></a><span id="l30.91" class="difflineminus">-  static PRBool assertEnumFunc(nsIRDFObserver *aObserver, void *aData);</span>
<a href="#l30.92"></a><span id="l30.92" class="difflineminus">-  static PRBool unassertEnumFunc(nsIRDFObserver *aObserver, void *aData);</span>
<a href="#l30.93"></a><span id="l30.93" class="difflineminus">-  static PRBool changeEnumFunc(nsIRDFObserver *aObserver, void *aData);</span>
<a href="#l30.94"></a><span id="l30.94" class="difflineminus">-</span>
<a href="#l30.95"></a><span id="l30.95" class="difflineminus">-private:</span>
<a href="#l30.96"></a><span id="l30.96" class="difflineminus">-  nsCOMArray&lt;nsIRDFObserver&gt; mObservers;</span>
<a href="#l30.97"></a><span id="l30.97" class="difflineminus">-  nsCOMArray&lt;nsIRDFObserver&gt; mProxyObservers;</span>
<a href="#l30.98"></a><span id="l30.98" class="difflineminus">-  mozilla::Mutex mLock;</span>
<a href="#l30.99"></a><span id="l30.99" class="difflineminus">-};</span>
<a href="#l30.100"></a><span id="l30.100" class="difflineminus">-</span>
<a href="#l30.101"></a><span id="l30.101" class="difflineminus">-#endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAddrDatabase.cpp</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAddrDatabase.cpp</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineat">@@ -38,43 +38,41 @@</span>
<a href="#l31.4"></a><span id="l31.4">  *</span>
<a href="#l31.5"></a><span id="l31.5">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l31.6"></a><span id="l31.6"> </span>
<a href="#l31.7"></a><span id="l31.7"> // this file implements the nsAddrDatabase interface using the MDB Interface.</span>
<a href="#l31.8"></a><span id="l31.8"> </span>
<a href="#l31.9"></a><span id="l31.9"> #include &quot;nsAddrDatabase.h&quot;</span>
<a href="#l31.10"></a><span id="l31.10"> #include &quot;nsStringGlue.h&quot;</span>
<a href="#l31.11"></a><span id="l31.11"> #include &quot;nsAutoPtr.h&quot;</span>
<a href="#l31.12"></a><span id="l31.12" class="difflineminus">-#include &quot;nsRDFCID.h&quot;</span>
<a href="#l31.13"></a><span id="l31.13"> #include &quot;nsUnicharUtils.h&quot;</span>
<a href="#l31.14"></a><span id="l31.14"> #include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l31.15"></a><span id="l31.15"> #include &quot;nsIAbMDBDirectory.h&quot;</span>
<a href="#l31.16"></a><span id="l31.16"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l31.17"></a><span id="l31.17"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l31.18"></a><span id="l31.18" class="difflineminus">-#include &quot;nsRDFCID.h&quot;</span>
<a href="#l31.19"></a><span id="l31.19"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l31.20"></a><span id="l31.20"> #include &quot;nsMorkCID.h&quot;</span>
<a href="#l31.21"></a><span id="l31.21"> #include &quot;nsIMdbFactoryFactory.h&quot;</span>
<a href="#l31.22"></a><span id="l31.22" class="difflineminus">-#include &quot;nsIRDFService.h&quot;</span>
<a href="#l31.23"></a><span id="l31.23"> #include &quot;nsIProxyObjectManager.h&quot;</span>
<a href="#l31.24"></a><span id="l31.24"> #include &quot;nsProxiedService.h&quot;</span>
<a href="#l31.25"></a><span id="l31.25"> #include &quot;prprf.h&quot;</span>
<a href="#l31.26"></a><span id="l31.26"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l31.27"></a><span id="l31.27"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l31.28"></a><span id="l31.28"> #include &quot;nsIPromptService.h&quot;</span>
<a href="#l31.29"></a><span id="l31.29"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l31.30"></a><span id="l31.30"> #include &quot;nsIFile.h&quot;</span>
<a href="#l31.31"></a><span id="l31.31"> #include &quot;nsEmbedCID.h&quot;</span>
<a href="#l31.32"></a><span id="l31.32"> #include &quot;nsXPCOMCIDInternal.h&quot;</span>
<a href="#l31.33"></a><span id="l31.33"> #include &quot;nsIProperty.h&quot;</span>
<a href="#l31.34"></a><span id="l31.34"> #include &quot;nsIVariant.h&quot;</span>
<a href="#l31.35"></a><span id="l31.35"> #include &quot;nsCOMArray.h&quot;</span>
<a href="#l31.36"></a><span id="l31.36"> #include &quot;nsArrayEnumerator.h&quot;</span>
<a href="#l31.37"></a><span id="l31.37"> #include &quot;nsIPrefService.h&quot;</span>
<a href="#l31.38"></a><span id="l31.38"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l31.39"></a><span id="l31.39" class="difflineplus">+#include &quot;nsIAbManager.h&quot;</span>
<a href="#l31.40"></a><span id="l31.40"> </span>
<a href="#l31.41"></a><span id="l31.41"> #define ID_PAB_TABLE            1</span>
<a href="#l31.42"></a><span id="l31.42"> #define ID_DELETEDCARDS_TABLE           2</span>
<a href="#l31.43"></a><span id="l31.43"> </span>
<a href="#l31.44"></a><span id="l31.44"> // There's two books by default, although Mac may have one more, so set this</span>
<a href="#l31.45"></a><span id="l31.45"> // to three. Its not going to affect much, but will save us a few reallocations</span>
<a href="#l31.46"></a><span id="l31.46"> // when the cache is allocated.</span>
<a href="#l31.47"></a><span id="l31.47"> const PRUint32 kInitialAddrDBCacheSize = 3;</span>
<a href="#l31.48"></a><span id="l31.48" class="difflineat">@@ -3192,55 +3190,59 @@ NS_IMETHODIMP nsAddrDatabase::GetCardsFr</span>
<a href="#l31.49"></a><span id="l31.49">       done = PR_TRUE;</span>
<a href="#l31.50"></a><span id="l31.50">   } while (!done);</span>
<a href="#l31.51"></a><span id="l31.51"> </span>
<a href="#l31.52"></a><span id="l31.52">   return NS_NewArrayEnumerator(cards, list);</span>
<a href="#l31.53"></a><span id="l31.53"> }</span>
<a href="#l31.54"></a><span id="l31.54"> </span>
<a href="#l31.55"></a><span id="l31.55"> NS_IMETHODIMP nsAddrDatabase::AddListDirNode(nsIMdbRow * listRow)</span>
<a href="#l31.56"></a><span id="l31.56"> {</span>
<a href="#l31.57"></a><span id="l31.57" class="difflineminus">-    nsresult rv = NS_OK;</span>
<a href="#l31.58"></a><span id="l31.58" class="difflineminus">-</span>
<a href="#l31.59"></a><span id="l31.59" class="difflineminus">-    static NS_DEFINE_CID(kRDFServiceCID, NS_RDFSERVICE_CID);</span>
<a href="#l31.60"></a><span id="l31.60" class="difflineminus">-    NS_WITH_PROXIED_SERVICE(nsIRDFService, rdfService, kRDFServiceCID,</span>
<a href="#l31.61"></a><span id="l31.61" class="difflineminus">-                            NS_PROXY_TO_MAIN_THREAD, &amp;rv);</span>
<a href="#l31.62"></a><span id="l31.62" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l31.63"></a><span id="l31.63" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l31.64"></a><span id="l31.64" class="difflineplus">+</span>
<a href="#l31.65"></a><span id="l31.65" class="difflineplus">+  NS_WITH_PROXIED_SERVICE(nsIAbManager, abManager, NS_ABMANAGER_CONTRACTID,</span>
<a href="#l31.66"></a><span id="l31.66" class="difflineplus">+                          NS_PROXY_TO_MAIN_THREAD, &amp;rv);</span>
<a href="#l31.67"></a><span id="l31.67" class="difflineplus">+</span>
<a href="#l31.68"></a><span id="l31.68" class="difflineplus">+  if (NS_SUCCEEDED(rv))</span>
<a href="#l31.69"></a><span id="l31.69" class="difflineplus">+  {</span>
<a href="#l31.70"></a><span id="l31.70" class="difflineplus">+    nsAutoString parentURI;</span>
<a href="#l31.71"></a><span id="l31.71" class="difflineplus">+    rv = m_dbName-&gt;GetLeafName(parentURI);</span>
<a href="#l31.72"></a><span id="l31.72" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l31.73"></a><span id="l31.73" class="difflineplus">+</span>
<a href="#l31.74"></a><span id="l31.74" class="difflineplus">+    parentURI.Replace(0, 0, NS_LITERAL_STRING(kMDBDirectoryRoot));</span>
<a href="#l31.75"></a><span id="l31.75" class="difflineplus">+</span>
<a href="#l31.76"></a><span id="l31.76" class="difflineplus">+    nsCOMPtr&lt;nsIAbDirectory&gt; parentDir;</span>
<a href="#l31.77"></a><span id="l31.77" class="difflineplus">+    rv = abManager-&gt;GetDirectory(NS_ConvertUTF16toUTF8(parentURI),</span>
<a href="#l31.78"></a><span id="l31.78" class="difflineplus">+                                 getter_AddRefs(parentDir));</span>
<a href="#l31.79"></a><span id="l31.79" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l31.80"></a><span id="l31.80" class="difflineplus">+</span>
<a href="#l31.81"></a><span id="l31.81" class="difflineplus">+    nsCOMPtr&lt;nsIProxyObjectManager&gt; proxyObjMgr =</span>
<a href="#l31.82"></a><span id="l31.82" class="difflineplus">+        do_GetService(NS_XPCOMPROXY_CONTRACTID, &amp;rv);</span>
<a href="#l31.83"></a><span id="l31.83" class="difflineplus">+</span>
<a href="#l31.84"></a><span id="l31.84" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l31.85"></a><span id="l31.85" class="difflineplus">+</span>
<a href="#l31.86"></a><span id="l31.86" class="difflineplus">+    nsCOMPtr&lt;nsIAbDirectory&gt; proxiedParentDir = nsnull;</span>
<a href="#l31.87"></a><span id="l31.87" class="difflineplus">+    rv = proxyObjMgr-&gt;GetProxyForObject(NS_PROXY_TO_MAIN_THREAD,</span>
<a href="#l31.88"></a><span id="l31.88" class="difflineplus">+                                        NS_GET_IID( nsIAbDirectory),</span>
<a href="#l31.89"></a><span id="l31.89" class="difflineplus">+                                        parentDir,</span>
<a href="#l31.90"></a><span id="l31.90" class="difflineplus">+                                        NS_PROXY_SYNC | NS_PROXY_ALWAYS,</span>
<a href="#l31.91"></a><span id="l31.91" class="difflineplus">+                                        getter_AddRefs(proxiedParentDir));</span>
<a href="#l31.92"></a><span id="l31.92" class="difflineplus">+    if (proxiedParentDir)</span>
<a href="#l31.93"></a><span id="l31.93">     {</span>
<a href="#l31.94"></a><span id="l31.94" class="difflineminus">-        nsCOMPtr&lt;nsIRDFResource&gt;    parentResource;</span>
<a href="#l31.95"></a><span id="l31.95" class="difflineminus">-</span>
<a href="#l31.96"></a><span id="l31.96" class="difflineminus">-        nsAutoString parentURI;</span>
<a href="#l31.97"></a><span id="l31.97" class="difflineminus">-        rv = m_dbName-&gt;GetLeafName(parentURI);</span>
<a href="#l31.98"></a><span id="l31.98" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l31.99"></a><span id="l31.99" class="difflineminus">-</span>
<a href="#l31.100"></a><span id="l31.100" class="difflineminus">-        parentURI.Replace(0, 0, NS_LITERAL_STRING(kMDBDirectoryRoot));</span>
<a href="#l31.101"></a><span id="l31.101" class="difflineminus">-</span>
<a href="#l31.102"></a><span id="l31.102" class="difflineminus">-        rv = rdfService-&gt;GetResource(NS_ConvertUTF16toUTF8(parentURI), getter_AddRefs(parentResource));</span>
<a href="#l31.103"></a><span id="l31.103" class="difflineminus">-        nsCOMPtr&lt;nsIAbDirectory&gt; parentDir;</span>
<a href="#l31.104"></a><span id="l31.104" class="difflineminus">-</span>
<a href="#l31.105"></a><span id="l31.105" class="difflineminus">-        nsCOMPtr&lt;nsIProxyObjectManager&gt; proxyObjMgr = do_GetService(NS_XPCOMPROXY_CONTRACTID, &amp;rv);</span>
<a href="#l31.106"></a><span id="l31.106" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l31.107"></a><span id="l31.107" class="difflineminus">-        rv = proxyObjMgr-&gt;GetProxyForObject( NS_PROXY_TO_MAIN_THREAD,</span>
<a href="#l31.108"></a><span id="l31.108" class="difflineminus">-                                   NS_GET_IID( nsIAbDirectory),</span>
<a href="#l31.109"></a><span id="l31.109" class="difflineminus">-                                   parentResource,</span>
<a href="#l31.110"></a><span id="l31.110" class="difflineminus">-                                   NS_PROXY_SYNC | NS_PROXY_ALWAYS,</span>
<a href="#l31.111"></a><span id="l31.111" class="difflineminus">-                                   getter_AddRefs( parentDir));</span>
<a href="#l31.112"></a><span id="l31.112" class="difflineminus">-        if (parentDir)</span>
<a href="#l31.113"></a><span id="l31.113" class="difflineminus">-        {</span>
<a href="#l31.114"></a><span id="l31.114" class="difflineminus">-            m_dbDirectory = do_GetWeakReference(parentDir);</span>
<a href="#l31.115"></a><span id="l31.115" class="difflineminus">-            nsCOMPtr&lt;nsIAbDirectory&gt; mailList;</span>
<a href="#l31.116"></a><span id="l31.116" class="difflineminus">-            rv = CreateABList(listRow, getter_AddRefs(mailList));</span>
<a href="#l31.117"></a><span id="l31.117" class="difflineminus">-            if (mailList)</span>
<a href="#l31.118"></a><span id="l31.118" class="difflineminus">-            {</span>
<a href="#l31.119"></a><span id="l31.119" class="difflineminus">-                nsCOMPtr&lt;nsIAbMDBDirectory&gt; dbparentDir(do_QueryInterface(parentDir, &amp;rv));</span>
<a href="#l31.120"></a><span id="l31.120" class="difflineminus">-                if(NS_SUCCEEDED(rv))</span>
<a href="#l31.121"></a><span id="l31.121" class="difflineminus">-                    dbparentDir-&gt;NotifyDirItemAdded(mailList);</span>
<a href="#l31.122"></a><span id="l31.122" class="difflineminus">-            }</span>
<a href="#l31.123"></a><span id="l31.123" class="difflineminus">-        }</span>
<a href="#l31.124"></a><span id="l31.124" class="difflineplus">+      m_dbDirectory = do_GetWeakReference(parentDir);</span>
<a href="#l31.125"></a><span id="l31.125" class="difflineplus">+      nsCOMPtr&lt;nsIAbDirectory&gt; mailList;</span>
<a href="#l31.126"></a><span id="l31.126" class="difflineplus">+      rv = CreateABList(listRow, getter_AddRefs(mailList));</span>
<a href="#l31.127"></a><span id="l31.127" class="difflineplus">+      if (mailList)</span>
<a href="#l31.128"></a><span id="l31.128" class="difflineplus">+      {</span>
<a href="#l31.129"></a><span id="l31.129" class="difflineplus">+        nsCOMPtr&lt;nsIAbMDBDirectory&gt; dbparentDir(do_QueryInterface(parentDir, &amp;rv));</span>
<a href="#l31.130"></a><span id="l31.130" class="difflineplus">+        if(NS_SUCCEEDED(rv))</span>
<a href="#l31.131"></a><span id="l31.131" class="difflineplus">+          dbparentDir-&gt;NotifyDirItemAdded(mailList);</span>
<a href="#l31.132"></a><span id="l31.132" class="difflineplus">+      }</span>
<a href="#l31.133"></a><span id="l31.133">     }</span>
<a href="#l31.134"></a><span id="l31.134" class="difflineminus">-    return rv;</span>
<a href="#l31.135"></a><span id="l31.135" class="difflineplus">+  }</span>
<a href="#l31.136"></a><span id="l31.136" class="difflineplus">+  return rv;</span>
<a href="#l31.137"></a><span id="l31.137"> }</span>
<a href="#l31.138"></a><span id="l31.138"> </span>
<a href="#l31.139"></a><span id="l31.139"> NS_IMETHODIMP nsAddrDatabase::FindMailListbyUnicodeName(const PRUnichar *listName, PRBool *exist)</span>
<a href="#l31.140"></a><span id="l31.140"> {</span>
<a href="#l31.141"></a><span id="l31.141">   nsAutoString unicodeString(listName);</span>
<a href="#l31.142"></a><span id="l31.142">   ToLowerCase(unicodeString);</span>
<a href="#l31.143"></a><span id="l31.143"> </span>
<a href="#l31.144"></a><span id="l31.144">   nsCOMPtr &lt;nsIMdbRow&gt; listRow;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1">deleted file mode 100644</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineminus">--- a/mailnews/addrbook/src/nsDirectoryDataSource.cpp</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineplus">+++ /dev/null</span>
<a href="#l32.4"></a><span id="l32.4" class="difflineat">@@ -1,690 +0,0 @@</span>
<a href="#l32.5"></a><span id="l32.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l32.6"></a><span id="l32.6" class="difflineminus">-/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l32.7"></a><span id="l32.7" class="difflineminus">- * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l32.8"></a><span id="l32.8" class="difflineminus">- *</span>
<a href="#l32.9"></a><span id="l32.9" class="difflineminus">- * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l32.10"></a><span id="l32.10" class="difflineminus">- * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l32.11"></a><span id="l32.11" class="difflineminus">- * the License. You may obtain a copy of the License at</span>
<a href="#l32.12"></a><span id="l32.12" class="difflineminus">- * http://www.mozilla.org/MPL/</span>
<a href="#l32.13"></a><span id="l32.13" class="difflineminus">- *</span>
<a href="#l32.14"></a><span id="l32.14" class="difflineminus">- * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l32.15"></a><span id="l32.15" class="difflineminus">- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l32.16"></a><span id="l32.16" class="difflineminus">- * for the specific language governing rights and limitations under the</span>
<a href="#l32.17"></a><span id="l32.17" class="difflineminus">- * License.</span>
<a href="#l32.18"></a><span id="l32.18" class="difflineminus">- *</span>
<a href="#l32.19"></a><span id="l32.19" class="difflineminus">- * The Original Code is mozilla.org code.</span>
<a href="#l32.20"></a><span id="l32.20" class="difflineminus">- *</span>
<a href="#l32.21"></a><span id="l32.21" class="difflineminus">- * The Initial Developer of the Original Code is</span>
<a href="#l32.22"></a><span id="l32.22" class="difflineminus">- * Netscape Communications Corporation.</span>
<a href="#l32.23"></a><span id="l32.23" class="difflineminus">- * Portions created by the Initial Developer are Copyright (C) 1999</span>
<a href="#l32.24"></a><span id="l32.24" class="difflineminus">- * the Initial Developer. All Rights Reserved.</span>
<a href="#l32.25"></a><span id="l32.25" class="difflineminus">- *</span>
<a href="#l32.26"></a><span id="l32.26" class="difflineminus">- * Contributor(s):</span>
<a href="#l32.27"></a><span id="l32.27" class="difflineminus">- *   Pierre Phaneuf &lt;pp@ludusdesign.com&gt;</span>
<a href="#l32.28"></a><span id="l32.28" class="difflineminus">- *   Seth Spitzer &lt;sspitzer@netscape.com&gt;</span>
<a href="#l32.29"></a><span id="l32.29" class="difflineminus">- *</span>
<a href="#l32.30"></a><span id="l32.30" class="difflineminus">- * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l32.31"></a><span id="l32.31" class="difflineminus">- * either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l32.32"></a><span id="l32.32" class="difflineminus">- * or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l32.33"></a><span id="l32.33" class="difflineminus">- * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l32.34"></a><span id="l32.34" class="difflineminus">- * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l32.35"></a><span id="l32.35" class="difflineminus">- * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l32.36"></a><span id="l32.36" class="difflineminus">- * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l32.37"></a><span id="l32.37" class="difflineminus">- * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l32.38"></a><span id="l32.38" class="difflineminus">- * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l32.39"></a><span id="l32.39" class="difflineminus">- * the provisions above, a recipient may use your version of this file under</span>
<a href="#l32.40"></a><span id="l32.40" class="difflineminus">- * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l32.41"></a><span id="l32.41" class="difflineminus">- *</span>
<a href="#l32.42"></a><span id="l32.42" class="difflineminus">- * ***** END LICENSE BLOCK ***** */</span>
<a href="#l32.43"></a><span id="l32.43" class="difflineminus">-</span>
<a href="#l32.44"></a><span id="l32.44" class="difflineminus">-#include &quot;nsDirectoryDataSource.h&quot;</span>
<a href="#l32.45"></a><span id="l32.45" class="difflineminus">-#include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l32.46"></a><span id="l32.46" class="difflineminus">-#include &quot;nsIAbDirectory.h&quot;</span>
<a href="#l32.47"></a><span id="l32.47" class="difflineminus">-#include &quot;nsIAbManager.h&quot;</span>
<a href="#l32.48"></a><span id="l32.48" class="difflineminus">-#include &quot;nsIAbCard.h&quot;</span>
<a href="#l32.49"></a><span id="l32.49" class="difflineminus">-#include &quot;nsIMutableArray.h&quot;</span>
<a href="#l32.50"></a><span id="l32.50" class="difflineminus">-#include &quot;nsArrayUtils.h&quot;</span>
<a href="#l32.51"></a><span id="l32.51" class="difflineminus">-#include &quot;nsArrayEnumerator.h&quot;</span>
<a href="#l32.52"></a><span id="l32.52" class="difflineminus">-#include &quot;rdf.h&quot;</span>
<a href="#l32.53"></a><span id="l32.53" class="difflineminus">-#include &quot;nsIRDFService.h&quot;</span>
<a href="#l32.54"></a><span id="l32.54" class="difflineminus">-#include &quot;nsRDFCID.h&quot;</span>
<a href="#l32.55"></a><span id="l32.55" class="difflineminus">-#include &quot;nsIRDFNode.h&quot;</span>
<a href="#l32.56"></a><span id="l32.56" class="difflineminus">-#include &quot;nsEnumeratorUtils.h&quot;</span>
<a href="#l32.57"></a><span id="l32.57" class="difflineminus">-#include &quot;nsIObserverService.h&quot;</span>
<a href="#l32.58"></a><span id="l32.58" class="difflineminus">-</span>
<a href="#l32.59"></a><span id="l32.59" class="difflineminus">-#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l32.60"></a><span id="l32.60" class="difflineminus">-#include &quot;nsStringGlue.h&quot;</span>
<a href="#l32.61"></a><span id="l32.61" class="difflineminus">-</span>
<a href="#l32.62"></a><span id="l32.62" class="difflineminus">-#include &quot;nsMsgRDFUtils.h&quot;</span>
<a href="#l32.63"></a><span id="l32.63" class="difflineminus">-#include &quot;nsILocaleService.h&quot;</span>
<a href="#l32.64"></a><span id="l32.64" class="difflineminus">-#include &quot;nsCollationCID.h&quot;</span>
<a href="#l32.65"></a><span id="l32.65" class="difflineminus">-#include &quot;prmem.h&quot;</span>
<a href="#l32.66"></a><span id="l32.66" class="difflineminus">-#include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l32.67"></a><span id="l32.67" class="difflineminus">-#include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l32.68"></a><span id="l32.68" class="difflineminus">-</span>
<a href="#l32.69"></a><span id="l32.69" class="difflineminus">-#define NC_RDF_DIRNAME              &quot;http://home.netscape.com/NC-rdf#DirName&quot;</span>
<a href="#l32.70"></a><span id="l32.70" class="difflineminus">-#define NC_RDF_DIRURI               &quot;http://home.netscape.com/NC-rdf#DirUri&quot;</span>
<a href="#l32.71"></a><span id="l32.71" class="difflineminus">-#define NC_RDF_ISMAILLIST           &quot;http://home.netscape.com/NC-rdf#IsMailList&quot;</span>
<a href="#l32.72"></a><span id="l32.72" class="difflineminus">-#define NC_RDF_ISREMOTE             &quot;http://home.netscape.com/NC-rdf#IsRemote&quot;</span>
<a href="#l32.73"></a><span id="l32.73" class="difflineminus">-#define NC_RDF_ISWRITEABLE          &quot;http://home.netscape.com/NC-rdf#IsWriteable&quot;</span>
<a href="#l32.74"></a><span id="l32.74" class="difflineminus">-#define NC_RDF_DIRTREENAMESORT      &quot;http://home.netscape.com/NC-rdf#DirTreeNameSort&quot;</span>
<a href="#l32.75"></a><span id="l32.75" class="difflineminus">-#define NC_RDF_SUPPORTSMAILINGLISTS &quot;http://home.netscape.com/NC-rdf#SupportsMailingLists&quot;</span>
<a href="#l32.76"></a><span id="l32.76" class="difflineminus">-</span>
<a href="#l32.77"></a><span id="l32.77" class="difflineminus">-////////////////////////////////////////////////////////////////////////</span>
<a href="#l32.78"></a><span id="l32.78" class="difflineminus">-</span>
<a href="#l32.79"></a><span id="l32.79" class="difflineminus">-nsAbDirectoryDataSource::nsAbDirectoryDataSource()</span>
<a href="#l32.80"></a><span id="l32.80" class="difflineminus">-{</span>
<a href="#l32.81"></a><span id="l32.81" class="difflineminus">-}</span>
<a href="#l32.82"></a><span id="l32.82" class="difflineminus">-</span>
<a href="#l32.83"></a><span id="l32.83" class="difflineminus">-nsAbDirectoryDataSource::~nsAbDirectoryDataSource()</span>
<a href="#l32.84"></a><span id="l32.84" class="difflineminus">-{</span>
<a href="#l32.85"></a><span id="l32.85" class="difflineminus">-}</span>
<a href="#l32.86"></a><span id="l32.86" class="difflineminus">-</span>
<a href="#l32.87"></a><span id="l32.87" class="difflineminus">-nsresult nsAbDirectoryDataSource::Cleanup()</span>
<a href="#l32.88"></a><span id="l32.88" class="difflineminus">-{</span>
<a href="#l32.89"></a><span id="l32.89" class="difflineminus">-  nsresult rv;</span>
<a href="#l32.90"></a><span id="l32.90" class="difflineminus">-  nsCOMPtr &lt;nsIRDFService&gt; rdf = do_GetService(&quot;@mozilla.org/rdf/rdf-service;1&quot;, &amp;rv);</span>
<a href="#l32.91"></a><span id="l32.91" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l32.92"></a><span id="l32.92" class="difflineminus">-</span>
<a href="#l32.93"></a><span id="l32.93" class="difflineminus">-  rv = rdf-&gt;UnregisterDataSource(this);</span>
<a href="#l32.94"></a><span id="l32.94" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l32.95"></a><span id="l32.95" class="difflineminus">-</span>
<a href="#l32.96"></a><span id="l32.96" class="difflineminus">-  nsCOMPtr&lt;nsIAbManager&gt; abManager = do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l32.97"></a><span id="l32.97" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l32.98"></a><span id="l32.98" class="difflineminus">-</span>
<a href="#l32.99"></a><span id="l32.99" class="difflineminus">-  rv = abManager-&gt;RemoveAddressBookListener(this);</span>
<a href="#l32.100"></a><span id="l32.100" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l32.101"></a><span id="l32.101" class="difflineminus">-</span>
<a href="#l32.102"></a><span id="l32.102" class="difflineminus">-  return NS_OK;</span>
<a href="#l32.103"></a><span id="l32.103" class="difflineminus">-}</span>
<a href="#l32.104"></a><span id="l32.104" class="difflineminus">-</span>
<a href="#l32.105"></a><span id="l32.105" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l32.106"></a><span id="l32.106" class="difflineminus">-nsAbDirectoryDataSource::Observe(nsISupports *aSubject, const char *aTopic, const PRUnichar *someData)</span>
<a href="#l32.107"></a><span id="l32.107" class="difflineminus">-{</span>
<a href="#l32.108"></a><span id="l32.108" class="difflineminus">-  if (!strcmp(aTopic,NS_XPCOM_SHUTDOWN_OBSERVER_ID))</span>
<a href="#l32.109"></a><span id="l32.109" class="difflineminus">-    return Cleanup();</span>
<a href="#l32.110"></a><span id="l32.110" class="difflineminus">-</span>
<a href="#l32.111"></a><span id="l32.111" class="difflineminus">-  return NS_OK;</span>
<a href="#l32.112"></a><span id="l32.112" class="difflineminus">-}</span>
<a href="#l32.113"></a><span id="l32.113" class="difflineminus">-</span>
<a href="#l32.114"></a><span id="l32.114" class="difflineminus">-nsresult</span>
<a href="#l32.115"></a><span id="l32.115" class="difflineminus">-nsAbDirectoryDataSource::Init()</span>
<a href="#l32.116"></a><span id="l32.116" class="difflineminus">-{</span>
<a href="#l32.117"></a><span id="l32.117" class="difflineminus">-  nsresult rv;</span>
<a href="#l32.118"></a><span id="l32.118" class="difflineminus">-  nsCOMPtr&lt;nsIAbManager&gt; abManager = do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l32.119"></a><span id="l32.119" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l32.120"></a><span id="l32.120" class="difflineminus">-</span>
<a href="#l32.121"></a><span id="l32.121" class="difflineminus">-  // this listener cares about all events</span>
<a href="#l32.122"></a><span id="l32.122" class="difflineminus">-  rv = abManager-&gt;AddAddressBookListener(this, nsIAbListener::all);</span>
<a href="#l32.123"></a><span id="l32.123" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l32.124"></a><span id="l32.124" class="difflineminus">-</span>
<a href="#l32.125"></a><span id="l32.125" class="difflineminus">-  nsCOMPtr &lt;nsIRDFService&gt; rdf = do_GetService(&quot;@mozilla.org/rdf/rdf-service;1&quot;, &amp;rv);</span>
<a href="#l32.126"></a><span id="l32.126" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l32.127"></a><span id="l32.127" class="difflineminus">-</span>
<a href="#l32.128"></a><span id="l32.128" class="difflineminus">-  rv = rdf-&gt;RegisterDataSource(this, PR_FALSE);</span>
<a href="#l32.129"></a><span id="l32.129" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l32.130"></a><span id="l32.130" class="difflineminus">-</span>
<a href="#l32.131"></a><span id="l32.131" class="difflineminus">-  rv = rdf-&gt;GetResource(NS_LITERAL_CSTRING(NC_RDF_CHILD),</span>
<a href="#l32.132"></a><span id="l32.132" class="difflineminus">-                        getter_AddRefs(kNC_Child));</span>
<a href="#l32.133"></a><span id="l32.133" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l32.134"></a><span id="l32.134" class="difflineminus">-  rv = rdf-&gt;GetResource(NS_LITERAL_CSTRING(NC_RDF_DIRNAME),</span>
<a href="#l32.135"></a><span id="l32.135" class="difflineminus">-                        getter_AddRefs(kNC_DirName));</span>
<a href="#l32.136"></a><span id="l32.136" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l32.137"></a><span id="l32.137" class="difflineminus">-  rv = rdf-&gt;GetResource(NS_LITERAL_CSTRING(NC_RDF_DIRURI),</span>
<a href="#l32.138"></a><span id="l32.138" class="difflineminus">-                        getter_AddRefs(kNC_DirUri));</span>
<a href="#l32.139"></a><span id="l32.139" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l32.140"></a><span id="l32.140" class="difflineminus">-  rv = rdf-&gt;GetResource(NS_LITERAL_CSTRING(NC_RDF_ISMAILLIST),</span>
<a href="#l32.141"></a><span id="l32.141" class="difflineminus">-                        getter_AddRefs(kNC_IsMailList));</span>
<a href="#l32.142"></a><span id="l32.142" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l32.143"></a><span id="l32.143" class="difflineminus">-  rv = rdf-&gt;GetResource(NS_LITERAL_CSTRING(NC_RDF_ISREMOTE),</span>
<a href="#l32.144"></a><span id="l32.144" class="difflineminus">-                        getter_AddRefs(kNC_IsRemote));</span>
<a href="#l32.145"></a><span id="l32.145" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l32.146"></a><span id="l32.146" class="difflineminus">-  rv = rdf-&gt;GetResource(NS_LITERAL_CSTRING(NC_RDF_ISSECURE),</span>
<a href="#l32.147"></a><span id="l32.147" class="difflineminus">-                        getter_AddRefs(kNC_IsSecure));</span>
<a href="#l32.148"></a><span id="l32.148" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l32.149"></a><span id="l32.149" class="difflineminus">-  rv = rdf-&gt;GetResource(NS_LITERAL_CSTRING(NC_RDF_ISWRITEABLE),</span>
<a href="#l32.150"></a><span id="l32.150" class="difflineminus">-                        getter_AddRefs(kNC_IsWriteable));</span>
<a href="#l32.151"></a><span id="l32.151" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l32.152"></a><span id="l32.152" class="difflineminus">-  rv = rdf-&gt;GetResource(NS_LITERAL_CSTRING(NC_RDF_DIRTREENAMESORT), getter_AddRefs(kNC_DirTreeNameSort));</span>
<a href="#l32.153"></a><span id="l32.153" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l32.154"></a><span id="l32.154" class="difflineminus">-  rv = rdf-&gt;GetResource(NS_LITERAL_CSTRING(NC_RDF_SUPPORTSMAILINGLISTS),</span>
<a href="#l32.155"></a><span id="l32.155" class="difflineminus">-                        getter_AddRefs(kNC_SupportsMailingLists));</span>
<a href="#l32.156"></a><span id="l32.156" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l32.157"></a><span id="l32.157" class="difflineminus">-  rv = createNode(NS_LITERAL_STRING(&quot;true&quot;).get(), getter_AddRefs(kTrueLiteral));</span>
<a href="#l32.158"></a><span id="l32.158" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l32.159"></a><span id="l32.159" class="difflineminus">-  rv = createNode(NS_LITERAL_STRING(&quot;false&quot;).get(), getter_AddRefs(kFalseLiteral));</span>
<a href="#l32.160"></a><span id="l32.160" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l32.161"></a><span id="l32.161" class="difflineminus">-</span>
<a href="#l32.162"></a><span id="l32.162" class="difflineminus">-  nsCOMPtr&lt;nsIObserverService&gt; observerService = do_GetService(&quot;@mozilla.org/observer-service;1&quot;, &amp;rv);</span>
<a href="#l32.163"></a><span id="l32.163" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l32.164"></a><span id="l32.164" class="difflineminus">-</span>
<a href="#l32.165"></a><span id="l32.165" class="difflineminus">-  // since the observer (this) supports weak ref,</span>
<a href="#l32.166"></a><span id="l32.166" class="difflineminus">-  // and we call AddObserver() with PR_TRUE for ownsWeak</span>
<a href="#l32.167"></a><span id="l32.167" class="difflineminus">-  // we don't need to remove our observer from the from the observer service</span>
<a href="#l32.168"></a><span id="l32.168" class="difflineminus">-  rv = observerService-&gt;AddObserver(this, NS_XPCOM_SHUTDOWN_OBSERVER_ID, PR_TRUE);</span>
<a href="#l32.169"></a><span id="l32.169" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l32.170"></a><span id="l32.170" class="difflineminus">-</span>
<a href="#l32.171"></a><span id="l32.171" class="difflineminus">-  return NS_OK;</span>
<a href="#l32.172"></a><span id="l32.172" class="difflineminus">-}</span>
<a href="#l32.173"></a><span id="l32.173" class="difflineminus">-</span>
<a href="#l32.174"></a><span id="l32.174" class="difflineminus">-NS_IMPL_ISUPPORTS_INHERITED3(nsAbDirectoryDataSource, nsAbRDFDataSource, nsIAbListener, nsIObserver, nsISupportsWeakReference)</span>
<a href="#l32.175"></a><span id="l32.175" class="difflineminus">-</span>
<a href="#l32.176"></a><span id="l32.176" class="difflineminus">- // nsIRDFDataSource methods</span>
<a href="#l32.177"></a><span id="l32.177" class="difflineminus">-NS_IMETHODIMP nsAbDirectoryDataSource::GetURI(char* *uri)</span>
<a href="#l32.178"></a><span id="l32.178" class="difflineminus">-{</span>
<a href="#l32.179"></a><span id="l32.179" class="difflineminus">-  if ((*uri = strdup(&quot;rdf:addressdirectory&quot;)) == nsnull)</span>
<a href="#l32.180"></a><span id="l32.180" class="difflineminus">-    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l32.181"></a><span id="l32.181" class="difflineminus">-  else</span>
<a href="#l32.182"></a><span id="l32.182" class="difflineminus">-    return NS_OK;</span>
<a href="#l32.183"></a><span id="l32.183" class="difflineminus">-}</span>
<a href="#l32.184"></a><span id="l32.184" class="difflineminus">-</span>
<a href="#l32.185"></a><span id="l32.185" class="difflineminus">-NS_IMETHODIMP nsAbDirectoryDataSource::GetTarget(nsIRDFResource* source,</span>
<a href="#l32.186"></a><span id="l32.186" class="difflineminus">-                                               nsIRDFResource* property,</span>
<a href="#l32.187"></a><span id="l32.187" class="difflineminus">-                                               PRBool tv,</span>
<a href="#l32.188"></a><span id="l32.188" class="difflineminus">-                                               nsIRDFNode** target)</span>
<a href="#l32.189"></a><span id="l32.189" class="difflineminus">-{</span>
<a href="#l32.190"></a><span id="l32.190" class="difflineminus">-  nsresult rv = NS_RDF_NO_VALUE;</span>
<a href="#l32.191"></a><span id="l32.191" class="difflineminus">-  // we only have positive assertions in the mail data source.</span>
<a href="#l32.192"></a><span id="l32.192" class="difflineminus">-  if (! tv)</span>
<a href="#l32.193"></a><span id="l32.193" class="difflineminus">-    return NS_RDF_NO_VALUE;</span>
<a href="#l32.194"></a><span id="l32.194" class="difflineminus">-</span>
<a href="#l32.195"></a><span id="l32.195" class="difflineminus">-  nsCOMPtr&lt;nsIAbDirectory&gt; directory(do_QueryInterface(source, &amp;rv));</span>
<a href="#l32.196"></a><span id="l32.196" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; directory)</span>
<a href="#l32.197"></a><span id="l32.197" class="difflineminus">-    rv = createDirectoryNode(directory, property, target);</span>
<a href="#l32.198"></a><span id="l32.198" class="difflineminus">-  else</span>
<a href="#l32.199"></a><span id="l32.199" class="difflineminus">-    return NS_RDF_NO_VALUE;</span>
<a href="#l32.200"></a><span id="l32.200" class="difflineminus">-  return rv;</span>
<a href="#l32.201"></a><span id="l32.201" class="difflineminus">-}</span>
<a href="#l32.202"></a><span id="l32.202" class="difflineminus">-</span>
<a href="#l32.203"></a><span id="l32.203" class="difflineminus">-</span>
<a href="#l32.204"></a><span id="l32.204" class="difflineminus">-NS_IMETHODIMP nsAbDirectoryDataSource::GetTargets(nsIRDFResource* source,</span>
<a href="#l32.205"></a><span id="l32.205" class="difflineminus">-                                                  nsIRDFResource* property,</span>
<a href="#l32.206"></a><span id="l32.206" class="difflineminus">-                                                  PRBool tv,</span>
<a href="#l32.207"></a><span id="l32.207" class="difflineminus">-                                                  nsISimpleEnumerator** targets)</span>
<a href="#l32.208"></a><span id="l32.208" class="difflineminus">-{</span>
<a href="#l32.209"></a><span id="l32.209" class="difflineminus">-  nsresult rv = NS_RDF_NO_VALUE;</span>
<a href="#l32.210"></a><span id="l32.210" class="difflineminus">-  NS_ENSURE_ARG_POINTER(targets);</span>
<a href="#l32.211"></a><span id="l32.211" class="difflineminus">-</span>
<a href="#l32.212"></a><span id="l32.212" class="difflineminus">-  nsCOMPtr&lt;nsIAbDirectory&gt; directory(do_QueryInterface(source, &amp;rv));</span>
<a href="#l32.213"></a><span id="l32.213" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; directory)</span>
<a href="#l32.214"></a><span id="l32.214" class="difflineminus">-  {</span>
<a href="#l32.215"></a><span id="l32.215" class="difflineminus">-    if ((kNC_Child == property))</span>
<a href="#l32.216"></a><span id="l32.216" class="difflineminus">-    {</span>
<a href="#l32.217"></a><span id="l32.217" class="difflineminus">-      return directory-&gt;GetChildNodes(targets);</span>
<a href="#l32.218"></a><span id="l32.218" class="difflineminus">-    }</span>
<a href="#l32.219"></a><span id="l32.219" class="difflineminus">-    else if((kNC_DirName == property) ||</span>
<a href="#l32.220"></a><span id="l32.220" class="difflineminus">-      (kNC_DirUri == property) ||</span>
<a href="#l32.221"></a><span id="l32.221" class="difflineminus">-      (kNC_IsMailList == property) ||</span>
<a href="#l32.222"></a><span id="l32.222" class="difflineminus">-      (kNC_IsRemote == property) ||</span>
<a href="#l32.223"></a><span id="l32.223" class="difflineminus">-      (kNC_IsSecure == property) ||</span>
<a href="#l32.224"></a><span id="l32.224" class="difflineminus">-      (kNC_IsWriteable == property) ||</span>
<a href="#l32.225"></a><span id="l32.225" class="difflineminus">-      (kNC_DirTreeNameSort == property) ||</span>
<a href="#l32.226"></a><span id="l32.226" class="difflineminus">-      (kNC_SupportsMailingLists == property))</span>
<a href="#l32.227"></a><span id="l32.227" class="difflineminus">-    {</span>
<a href="#l32.228"></a><span id="l32.228" class="difflineminus">-      return NS_NewSingletonEnumerator(targets, property);</span>
<a href="#l32.229"></a><span id="l32.229" class="difflineminus">-    }</span>
<a href="#l32.230"></a><span id="l32.230" class="difflineminus">-  }</span>
<a href="#l32.231"></a><span id="l32.231" class="difflineminus">-  return NS_NewEmptyEnumerator(targets);</span>
<a href="#l32.232"></a><span id="l32.232" class="difflineminus">-}</span>
<a href="#l32.233"></a><span id="l32.233" class="difflineminus">-</span>
<a href="#l32.234"></a><span id="l32.234" class="difflineminus">-NS_IMETHODIMP nsAbDirectoryDataSource::Assert(nsIRDFResource* source,</span>
<a href="#l32.235"></a><span id="l32.235" class="difflineminus">-                      nsIRDFResource* property,</span>
<a href="#l32.236"></a><span id="l32.236" class="difflineminus">-                      nsIRDFNode* target,</span>
<a href="#l32.237"></a><span id="l32.237" class="difflineminus">-                      PRBool tv)</span>
<a href="#l32.238"></a><span id="l32.238" class="difflineminus">-{</span>
<a href="#l32.239"></a><span id="l32.239" class="difflineminus">-  nsresult rv;</span>
<a href="#l32.240"></a><span id="l32.240" class="difflineminus">-  nsCOMPtr&lt;nsIAbDirectory&gt; directory(do_QueryInterface(source, &amp;rv));</span>
<a href="#l32.241"></a><span id="l32.241" class="difflineminus">-  //We don't handle tv = PR_FALSE at the moment.</span>
<a href="#l32.242"></a><span id="l32.242" class="difflineminus">-  if(NS_SUCCEEDED(rv) &amp;&amp; tv)</span>
<a href="#l32.243"></a><span id="l32.243" class="difflineminus">-    return DoDirectoryAssert(directory, property, target);</span>
<a href="#l32.244"></a><span id="l32.244" class="difflineminus">-  else</span>
<a href="#l32.245"></a><span id="l32.245" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l32.246"></a><span id="l32.246" class="difflineminus">-}</span>
<a href="#l32.247"></a><span id="l32.247" class="difflineminus">-</span>
<a href="#l32.248"></a><span id="l32.248" class="difflineminus">-NS_IMETHODIMP nsAbDirectoryDataSource::HasAssertion(nsIRDFResource* source,</span>
<a href="#l32.249"></a><span id="l32.249" class="difflineminus">-                            nsIRDFResource* property,</span>
<a href="#l32.250"></a><span id="l32.250" class="difflineminus">-                            nsIRDFNode* target,</span>
<a href="#l32.251"></a><span id="l32.251" class="difflineminus">-                            PRBool tv,</span>
<a href="#l32.252"></a><span id="l32.252" class="difflineminus">-                            PRBool* hasAssertion)</span>
<a href="#l32.253"></a><span id="l32.253" class="difflineminus">-{</span>
<a href="#l32.254"></a><span id="l32.254" class="difflineminus">-  nsresult rv;</span>
<a href="#l32.255"></a><span id="l32.255" class="difflineminus">-  nsCOMPtr&lt;nsIAbDirectory&gt; directory(do_QueryInterface(source, &amp;rv));</span>
<a href="#l32.256"></a><span id="l32.256" class="difflineminus">-  if(NS_SUCCEEDED(rv))</span>
<a href="#l32.257"></a><span id="l32.257" class="difflineminus">-    return DoDirectoryHasAssertion(directory, property, target, tv, hasAssertion);</span>
<a href="#l32.258"></a><span id="l32.258" class="difflineminus">-  else</span>
<a href="#l32.259"></a><span id="l32.259" class="difflineminus">-    *hasAssertion = PR_FALSE;</span>
<a href="#l32.260"></a><span id="l32.260" class="difflineminus">-  return NS_OK;</span>
<a href="#l32.261"></a><span id="l32.261" class="difflineminus">-}</span>
<a href="#l32.262"></a><span id="l32.262" class="difflineminus">-</span>
<a href="#l32.263"></a><span id="l32.263" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l32.264"></a><span id="l32.264" class="difflineminus">-nsAbDirectoryDataSource::HasArcOut(nsIRDFResource *aSource, nsIRDFResource *aArc, PRBool *result)</span>
<a href="#l32.265"></a><span id="l32.265" class="difflineminus">-{</span>
<a href="#l32.266"></a><span id="l32.266" class="difflineminus">-  nsresult rv;</span>
<a href="#l32.267"></a><span id="l32.267" class="difflineminus">-  nsCOMPtr&lt;nsIAbDirectory&gt; directory(do_QueryInterface(aSource, &amp;rv));</span>
<a href="#l32.268"></a><span id="l32.268" class="difflineminus">-  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l32.269"></a><span id="l32.269" class="difflineminus">-    *result = (aArc == kNC_DirName ||</span>
<a href="#l32.270"></a><span id="l32.270" class="difflineminus">-               aArc == kNC_Child ||</span>
<a href="#l32.271"></a><span id="l32.271" class="difflineminus">-               aArc == kNC_DirUri ||</span>
<a href="#l32.272"></a><span id="l32.272" class="difflineminus">-               aArc == kNC_IsMailList ||</span>
<a href="#l32.273"></a><span id="l32.273" class="difflineminus">-               aArc == kNC_IsRemote ||</span>
<a href="#l32.274"></a><span id="l32.274" class="difflineminus">-               aArc == kNC_IsSecure ||</span>
<a href="#l32.275"></a><span id="l32.275" class="difflineminus">-               aArc == kNC_IsWriteable ||</span>
<a href="#l32.276"></a><span id="l32.276" class="difflineminus">-               aArc == kNC_DirTreeNameSort ||</span>
<a href="#l32.277"></a><span id="l32.277" class="difflineminus">-               aArc == kNC_SupportsMailingLists);</span>
<a href="#l32.278"></a><span id="l32.278" class="difflineminus">-  }</span>
<a href="#l32.279"></a><span id="l32.279" class="difflineminus">-  else {</span>
<a href="#l32.280"></a><span id="l32.280" class="difflineminus">-    *result = PR_FALSE;</span>
<a href="#l32.281"></a><span id="l32.281" class="difflineminus">-  }</span>
<a href="#l32.282"></a><span id="l32.282" class="difflineminus">-  return NS_OK;</span>
<a href="#l32.283"></a><span id="l32.283" class="difflineminus">-}</span>
<a href="#l32.284"></a><span id="l32.284" class="difflineminus">-</span>
<a href="#l32.285"></a><span id="l32.285" class="difflineminus">-NS_IMETHODIMP nsAbDirectoryDataSource::ArcLabelsOut(nsIRDFResource* source,</span>
<a href="#l32.286"></a><span id="l32.286" class="difflineminus">-                                                 nsISimpleEnumerator** labels)</span>
<a href="#l32.287"></a><span id="l32.287" class="difflineminus">-{</span>
<a href="#l32.288"></a><span id="l32.288" class="difflineminus">-  nsresult rv;</span>
<a href="#l32.289"></a><span id="l32.289" class="difflineminus">-</span>
<a href="#l32.290"></a><span id="l32.290" class="difflineminus">-  nsCOMPtr&lt;nsIAbDirectory&gt; directory(do_QueryInterface(source, &amp;rv));</span>
<a href="#l32.291"></a><span id="l32.291" class="difflineminus">-  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l32.292"></a><span id="l32.292" class="difflineminus">-    // Initialise with the number of items below, to save reallocating on each</span>
<a href="#l32.293"></a><span id="l32.293" class="difflineminus">-    // addition.</span>
<a href="#l32.294"></a><span id="l32.294" class="difflineminus">-    nsCOMArray&lt;nsIRDFResource&gt; arcs(9);</span>
<a href="#l32.295"></a><span id="l32.295" class="difflineminus">-</span>
<a href="#l32.296"></a><span id="l32.296" class="difflineminus">-    arcs.AppendObject(kNC_DirName);</span>
<a href="#l32.297"></a><span id="l32.297" class="difflineminus">-    arcs.AppendObject(kNC_Child);</span>
<a href="#l32.298"></a><span id="l32.298" class="difflineminus">-    arcs.AppendObject(kNC_DirUri);</span>
<a href="#l32.299"></a><span id="l32.299" class="difflineminus">-    arcs.AppendObject(kNC_IsMailList);</span>
<a href="#l32.300"></a><span id="l32.300" class="difflineminus">-    arcs.AppendObject(kNC_IsRemote);</span>
<a href="#l32.301"></a><span id="l32.301" class="difflineminus">-    arcs.AppendObject(kNC_IsSecure);</span>
<a href="#l32.302"></a><span id="l32.302" class="difflineminus">-    arcs.AppendObject(kNC_IsWriteable);</span>
<a href="#l32.303"></a><span id="l32.303" class="difflineminus">-    arcs.AppendObject(kNC_DirTreeNameSort);</span>
<a href="#l32.304"></a><span id="l32.304" class="difflineminus">-    arcs.AppendObject(kNC_SupportsMailingLists);</span>
<a href="#l32.305"></a><span id="l32.305" class="difflineminus">-</span>
<a href="#l32.306"></a><span id="l32.306" class="difflineminus">-    return NS_NewArrayEnumerator(labels, arcs);</span>
<a href="#l32.307"></a><span id="l32.307" class="difflineminus">-  }</span>
<a href="#l32.308"></a><span id="l32.308" class="difflineminus">-  return NS_NewEmptyEnumerator(labels);</span>
<a href="#l32.309"></a><span id="l32.309" class="difflineminus">-}</span>
<a href="#l32.310"></a><span id="l32.310" class="difflineminus">-</span>
<a href="#l32.311"></a><span id="l32.311" class="difflineminus">-NS_IMETHODIMP nsAbDirectoryDataSource::OnItemAdded(nsISupports *parentDirectory, nsISupports *item)</span>
<a href="#l32.312"></a><span id="l32.312" class="difflineminus">-{</span>
<a href="#l32.313"></a><span id="l32.313" class="difflineminus">-  nsresult rv;</span>
<a href="#l32.314"></a><span id="l32.314" class="difflineminus">-  nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l32.315"></a><span id="l32.315" class="difflineminus">-  nsCOMPtr&lt;nsIRDFResource&gt; parentResource;</span>
<a href="#l32.316"></a><span id="l32.316" class="difflineminus">-</span>
<a href="#l32.317"></a><span id="l32.317" class="difflineminus">-  if(NS_SUCCEEDED(parentDirectory-&gt;QueryInterface(NS_GET_IID(nsIRDFResource), getter_AddRefs(parentResource))))</span>
<a href="#l32.318"></a><span id="l32.318" class="difflineminus">-  {</span>
<a href="#l32.319"></a><span id="l32.319" class="difflineminus">-    //If we are adding a directory</span>
<a href="#l32.320"></a><span id="l32.320" class="difflineminus">-    if (NS_SUCCEEDED(item-&gt;QueryInterface(NS_GET_IID(nsIAbDirectory), getter_AddRefs(directory))))</span>
<a href="#l32.321"></a><span id="l32.321" class="difflineminus">-    {</span>
<a href="#l32.322"></a><span id="l32.322" class="difflineminus">-      nsCOMPtr&lt;nsIRDFNode&gt; itemNode(do_QueryInterface(item, &amp;rv));</span>
<a href="#l32.323"></a><span id="l32.323" class="difflineminus">-      if(NS_SUCCEEDED(rv))</span>
<a href="#l32.324"></a><span id="l32.324" class="difflineminus">-      {</span>
<a href="#l32.325"></a><span id="l32.325" class="difflineminus">-        //Notify a directory was added.</span>
<a href="#l32.326"></a><span id="l32.326" class="difflineminus">-        NotifyObservers(parentResource, kNC_Child, itemNode, PR_TRUE, PR_FALSE);</span>
<a href="#l32.327"></a><span id="l32.327" class="difflineminus">-      }</span>
<a href="#l32.328"></a><span id="l32.328" class="difflineminus">-    }</span>
<a href="#l32.329"></a><span id="l32.329" class="difflineminus">-  }</span>
<a href="#l32.330"></a><span id="l32.330" class="difflineminus">-</span>
<a href="#l32.331"></a><span id="l32.331" class="difflineminus">-  return NS_OK;</span>
<a href="#l32.332"></a><span id="l32.332" class="difflineminus">-}</span>
<a href="#l32.333"></a><span id="l32.333" class="difflineminus">-</span>
<a href="#l32.334"></a><span id="l32.334" class="difflineminus">-NS_IMETHODIMP nsAbDirectoryDataSource::OnItemRemoved(nsISupports *parentDirectory, nsISupports *item)</span>
<a href="#l32.335"></a><span id="l32.335" class="difflineminus">-{</span>
<a href="#l32.336"></a><span id="l32.336" class="difflineminus">-  nsresult rv;</span>
<a href="#l32.337"></a><span id="l32.337" class="difflineminus">-  nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l32.338"></a><span id="l32.338" class="difflineminus">-  nsCOMPtr&lt;nsIRDFResource&gt; parentResource;</span>
<a href="#l32.339"></a><span id="l32.339" class="difflineminus">-</span>
<a href="#l32.340"></a><span id="l32.340" class="difflineminus">-  if(NS_SUCCEEDED(parentDirectory-&gt;QueryInterface(NS_GET_IID(nsIRDFResource), getter_AddRefs(parentResource))))</span>
<a href="#l32.341"></a><span id="l32.341" class="difflineminus">-  {</span>
<a href="#l32.342"></a><span id="l32.342" class="difflineminus">-    //If we are removing a directory</span>
<a href="#l32.343"></a><span id="l32.343" class="difflineminus">-    if (NS_SUCCEEDED(item-&gt;QueryInterface(NS_GET_IID(nsIAbDirectory), getter_AddRefs(directory))))</span>
<a href="#l32.344"></a><span id="l32.344" class="difflineminus">-    {</span>
<a href="#l32.345"></a><span id="l32.345" class="difflineminus">-      nsCOMPtr&lt;nsIRDFNode&gt; itemNode(do_QueryInterface(item, &amp;rv));</span>
<a href="#l32.346"></a><span id="l32.346" class="difflineminus">-      if(NS_SUCCEEDED(rv))</span>
<a href="#l32.347"></a><span id="l32.347" class="difflineminus">-      {</span>
<a href="#l32.348"></a><span id="l32.348" class="difflineminus">-        //Notify a directory was deleted.</span>
<a href="#l32.349"></a><span id="l32.349" class="difflineminus">-        NotifyObservers(parentResource, kNC_Child, itemNode, PR_FALSE, PR_FALSE);</span>
<a href="#l32.350"></a><span id="l32.350" class="difflineminus">-      }</span>
<a href="#l32.351"></a><span id="l32.351" class="difflineminus">-    }</span>
<a href="#l32.352"></a><span id="l32.352" class="difflineminus">-  }</span>
<a href="#l32.353"></a><span id="l32.353" class="difflineminus">-  return NS_OK;</span>
<a href="#l32.354"></a><span id="l32.354" class="difflineminus">-}</span>
<a href="#l32.355"></a><span id="l32.355" class="difflineminus">-</span>
<a href="#l32.356"></a><span id="l32.356" class="difflineminus">-NS_IMETHODIMP nsAbDirectoryDataSource::OnItemPropertyChanged(nsISupports *item, const char *property,</span>
<a href="#l32.357"></a><span id="l32.357" class="difflineminus">-                               const PRUnichar *oldValue, const PRUnichar *newValue)</span>
<a href="#l32.358"></a><span id="l32.358" class="difflineminus">-</span>
<a href="#l32.359"></a><span id="l32.359" class="difflineminus">-{</span>
<a href="#l32.360"></a><span id="l32.360" class="difflineminus">-  nsresult rv;</span>
<a href="#l32.361"></a><span id="l32.361" class="difflineminus">-  nsCOMPtr&lt;nsIRDFResource&gt; resource(do_QueryInterface(item, &amp;rv));</span>
<a href="#l32.362"></a><span id="l32.362" class="difflineminus">-</span>
<a href="#l32.363"></a><span id="l32.363" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l32.364"></a><span id="l32.364" class="difflineminus">-  {</span>
<a href="#l32.365"></a><span id="l32.365" class="difflineminus">-    if (strcmp(&quot;DirName&quot;, property) == 0)</span>
<a href="#l32.366"></a><span id="l32.366" class="difflineminus">-    {</span>
<a href="#l32.367"></a><span id="l32.367" class="difflineminus">-      NotifyPropertyChanged(resource, kNC_DirName, oldValue, newValue);</span>
<a href="#l32.368"></a><span id="l32.368" class="difflineminus">-    }</span>
<a href="#l32.369"></a><span id="l32.369" class="difflineminus">-    else if (strcmp(&quot;IsSecure&quot;, property) == 0)</span>
<a href="#l32.370"></a><span id="l32.370" class="difflineminus">-    {</span>
<a href="#l32.371"></a><span id="l32.371" class="difflineminus">-      NotifyPropertyChanged(resource, kNC_IsSecure, oldValue, newValue);</span>
<a href="#l32.372"></a><span id="l32.372" class="difflineminus">-    }</span>
<a href="#l32.373"></a><span id="l32.373" class="difflineminus">-  }</span>
<a href="#l32.374"></a><span id="l32.374" class="difflineminus">-  return NS_OK;</span>
<a href="#l32.375"></a><span id="l32.375" class="difflineminus">-}</span>
<a href="#l32.376"></a><span id="l32.376" class="difflineminus">-</span>
<a href="#l32.377"></a><span id="l32.377" class="difflineminus">-nsresult nsAbDirectoryDataSource::createDirectoryNode(nsIAbDirectory* directory,</span>
<a href="#l32.378"></a><span id="l32.378" class="difflineminus">-                                                 nsIRDFResource* property,</span>
<a href="#l32.379"></a><span id="l32.379" class="difflineminus">-                                                 nsIRDFNode** target)</span>
<a href="#l32.380"></a><span id="l32.380" class="difflineminus">-{</span>
<a href="#l32.381"></a><span id="l32.381" class="difflineminus">-  nsresult rv = NS_RDF_NO_VALUE;</span>
<a href="#l32.382"></a><span id="l32.382" class="difflineminus">-</span>
<a href="#l32.383"></a><span id="l32.383" class="difflineminus">-  if ((kNC_DirName == property))</span>
<a href="#l32.384"></a><span id="l32.384" class="difflineminus">-    rv = createDirectoryNameNode(directory, target);</span>
<a href="#l32.385"></a><span id="l32.385" class="difflineminus">-  else if ((kNC_DirUri == property))</span>
<a href="#l32.386"></a><span id="l32.386" class="difflineminus">-    rv = createDirectoryUriNode(directory, target);</span>
<a href="#l32.387"></a><span id="l32.387" class="difflineminus">-  else if ((kNC_Child == property))</span>
<a href="#l32.388"></a><span id="l32.388" class="difflineminus">-    rv = createDirectoryChildNode(directory, target);</span>
<a href="#l32.389"></a><span id="l32.389" class="difflineminus">-  else if ((kNC_IsMailList == property))</span>
<a href="#l32.390"></a><span id="l32.390" class="difflineminus">-    rv = createDirectoryIsMailListNode(directory, target);</span>
<a href="#l32.391"></a><span id="l32.391" class="difflineminus">-  else if ((kNC_IsRemote == property))</span>
<a href="#l32.392"></a><span id="l32.392" class="difflineminus">-    rv = createDirectoryIsRemoteNode(directory, target);</span>
<a href="#l32.393"></a><span id="l32.393" class="difflineminus">-  else if ((kNC_IsSecure == property))</span>
<a href="#l32.394"></a><span id="l32.394" class="difflineminus">-    rv = createDirectoryIsSecureNode(directory, target);</span>
<a href="#l32.395"></a><span id="l32.395" class="difflineminus">-  else if ((kNC_IsWriteable == property))</span>
<a href="#l32.396"></a><span id="l32.396" class="difflineminus">-    rv = createDirectoryIsWriteableNode(directory, target);</span>
<a href="#l32.397"></a><span id="l32.397" class="difflineminus">-  else if ((kNC_DirTreeNameSort == property))</span>
<a href="#l32.398"></a><span id="l32.398" class="difflineminus">-    rv = createDirectoryTreeNameSortNode(directory, target);</span>
<a href="#l32.399"></a><span id="l32.399" class="difflineminus">-  else if ((kNC_SupportsMailingLists == property))</span>
<a href="#l32.400"></a><span id="l32.400" class="difflineminus">-    rv = createDirectorySupportsMailingListsNode(directory, target);</span>
<a href="#l32.401"></a><span id="l32.401" class="difflineminus">-  return rv;</span>
<a href="#l32.402"></a><span id="l32.402" class="difflineminus">-}</span>
<a href="#l32.403"></a><span id="l32.403" class="difflineminus">-</span>
<a href="#l32.404"></a><span id="l32.404" class="difflineminus">-</span>
<a href="#l32.405"></a><span id="l32.405" class="difflineminus">-nsresult nsAbDirectoryDataSource::createDirectoryNameNode(nsIAbDirectory *directory,</span>
<a href="#l32.406"></a><span id="l32.406" class="difflineminus">-                                                     nsIRDFNode **target)</span>
<a href="#l32.407"></a><span id="l32.407" class="difflineminus">-{</span>
<a href="#l32.408"></a><span id="l32.408" class="difflineminus">-  nsString name;</span>
<a href="#l32.409"></a><span id="l32.409" class="difflineminus">-  nsresult rv = directory-&gt;GetDirName(name);</span>
<a href="#l32.410"></a><span id="l32.410" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l32.411"></a><span id="l32.411" class="difflineminus">-  rv = createNode(name.get(), target);</span>
<a href="#l32.412"></a><span id="l32.412" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l32.413"></a><span id="l32.413" class="difflineminus">-  return rv;</span>
<a href="#l32.414"></a><span id="l32.414" class="difflineminus">-}</span>
<a href="#l32.415"></a><span id="l32.415" class="difflineminus">-</span>
<a href="#l32.416"></a><span id="l32.416" class="difflineminus">-nsresult nsAbDirectoryDataSource::createDirectoryUriNode(nsIAbDirectory *directory,</span>
<a href="#l32.417"></a><span id="l32.417" class="difflineminus">-                                                     nsIRDFNode **target)</span>
<a href="#l32.418"></a><span id="l32.418" class="difflineminus">-{</span>
<a href="#l32.419"></a><span id="l32.419" class="difflineminus">-  nsCOMPtr&lt;nsIRDFResource&gt; source(do_QueryInterface(directory));</span>
<a href="#l32.420"></a><span id="l32.420" class="difflineminus">-</span>
<a href="#l32.421"></a><span id="l32.421" class="difflineminus">-  nsCString uri;</span>
<a href="#l32.422"></a><span id="l32.422" class="difflineminus">-  nsresult rv = source-&gt;GetValue(getter_Copies(uri));</span>
<a href="#l32.423"></a><span id="l32.423" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l32.424"></a><span id="l32.424" class="difflineminus">-  nsAutoString nameString;</span>
<a href="#l32.425"></a><span id="l32.425" class="difflineminus">-  CopyASCIItoUTF16(uri, nameString);</span>
<a href="#l32.426"></a><span id="l32.426" class="difflineminus">-  rv = createNode(nameString.get(), target);</span>
<a href="#l32.427"></a><span id="l32.427" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l32.428"></a><span id="l32.428" class="difflineminus">-  return rv;</span>
<a href="#l32.429"></a><span id="l32.429" class="difflineminus">-}</span>
<a href="#l32.430"></a><span id="l32.430" class="difflineminus">-</span>
<a href="#l32.431"></a><span id="l32.431" class="difflineminus">-nsresult</span>
<a href="#l32.432"></a><span id="l32.432" class="difflineminus">-nsAbDirectoryDataSource::createDirectoryChildNode(nsIAbDirectory *directory,</span>
<a href="#l32.433"></a><span id="l32.433" class="difflineminus">-                                             nsIRDFNode **target)</span>
<a href="#l32.434"></a><span id="l32.434" class="difflineminus">-{</span>
<a href="#l32.435"></a><span id="l32.435" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; pAddressLists;</span>
<a href="#l32.436"></a><span id="l32.436" class="difflineminus">-  directory-&gt;GetAddressLists(getter_AddRefs(pAddressLists));</span>
<a href="#l32.437"></a><span id="l32.437" class="difflineminus">-</span>
<a href="#l32.438"></a><span id="l32.438" class="difflineminus">-  if (pAddressLists)</span>
<a href="#l32.439"></a><span id="l32.439" class="difflineminus">-  {</span>
<a href="#l32.440"></a><span id="l32.440" class="difflineminus">-    PRUint32 total = 0;</span>
<a href="#l32.441"></a><span id="l32.441" class="difflineminus">-    pAddressLists-&gt;GetLength(&amp;total);</span>
<a href="#l32.442"></a><span id="l32.442" class="difflineminus">-</span>
<a href="#l32.443"></a><span id="l32.443" class="difflineminus">-    if (total)</span>
<a href="#l32.444"></a><span id="l32.444" class="difflineminus">-    {</span>
<a href="#l32.445"></a><span id="l32.445" class="difflineminus">-      PRBool isMailList = PR_FALSE;</span>
<a href="#l32.446"></a><span id="l32.446" class="difflineminus">-      directory-&gt;GetIsMailList(&amp;isMailList);</span>
<a href="#l32.447"></a><span id="l32.447" class="difflineminus">-      if (!isMailList)</span>
<a href="#l32.448"></a><span id="l32.448" class="difflineminus">-      {</span>
<a href="#l32.449"></a><span id="l32.449" class="difflineminus">-        // fetch the last element</span>
<a href="#l32.450"></a><span id="l32.450" class="difflineminus">-        nsCOMPtr&lt;nsIRDFResource&gt; mailList = do_QueryElementAt(pAddressLists, total - 1);</span>
<a href="#l32.451"></a><span id="l32.451" class="difflineminus">-        NS_IF_ADDREF(*target = mailList);</span>
<a href="#l32.452"></a><span id="l32.452" class="difflineminus">-      }</span>
<a href="#l32.453"></a><span id="l32.453" class="difflineminus">-    } // if total</span>
<a href="#l32.454"></a><span id="l32.454" class="difflineminus">-  } // if pAddressLists</span>
<a href="#l32.455"></a><span id="l32.455" class="difflineminus">-</span>
<a href="#l32.456"></a><span id="l32.456" class="difflineminus">-  return (*target ? NS_OK : NS_RDF_NO_VALUE);</span>
<a href="#l32.457"></a><span id="l32.457" class="difflineminus">-}</span>
<a href="#l32.458"></a><span id="l32.458" class="difflineminus">-</span>
<a href="#l32.459"></a><span id="l32.459" class="difflineminus">-nsresult</span>
<a href="#l32.460"></a><span id="l32.460" class="difflineminus">-nsAbDirectoryDataSource::createDirectoryIsRemoteNode(nsIAbDirectory* directory,</span>
<a href="#l32.461"></a><span id="l32.461" class="difflineminus">-                                                     nsIRDFNode **target)</span>
<a href="#l32.462"></a><span id="l32.462" class="difflineminus">-{</span>
<a href="#l32.463"></a><span id="l32.463" class="difflineminus">-  PRBool isRemote;</span>
<a href="#l32.464"></a><span id="l32.464" class="difflineminus">-  nsresult rv = directory-&gt;GetIsRemote(&amp;isRemote);</span>
<a href="#l32.465"></a><span id="l32.465" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l32.466"></a><span id="l32.466" class="difflineminus">-</span>
<a href="#l32.467"></a><span id="l32.467" class="difflineminus">-  NS_IF_ADDREF(*target = (isRemote ? kTrueLiteral : kFalseLiteral));</span>
<a href="#l32.468"></a><span id="l32.468" class="difflineminus">-  return NS_OK;</span>
<a href="#l32.469"></a><span id="l32.469" class="difflineminus">-}</span>
<a href="#l32.470"></a><span id="l32.470" class="difflineminus">-</span>
<a href="#l32.471"></a><span id="l32.471" class="difflineminus">-nsresult</span>
<a href="#l32.472"></a><span id="l32.472" class="difflineminus">-nsAbDirectoryDataSource::createDirectoryIsSecureNode(nsIAbDirectory* directory,</span>
<a href="#l32.473"></a><span id="l32.473" class="difflineminus">-                                                     nsIRDFNode **target)</span>
<a href="#l32.474"></a><span id="l32.474" class="difflineminus">-{</span>
<a href="#l32.475"></a><span id="l32.475" class="difflineminus">-  PRBool IsSecure;</span>
<a href="#l32.476"></a><span id="l32.476" class="difflineminus">-  nsresult rv = directory-&gt;GetIsSecure(&amp;IsSecure);</span>
<a href="#l32.477"></a><span id="l32.477" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l32.478"></a><span id="l32.478" class="difflineminus">-</span>
<a href="#l32.479"></a><span id="l32.479" class="difflineminus">-  NS_IF_ADDREF(*target = (IsSecure ? kTrueLiteral : kFalseLiteral));</span>
<a href="#l32.480"></a><span id="l32.480" class="difflineminus">-  return NS_OK;</span>
<a href="#l32.481"></a><span id="l32.481" class="difflineminus">-}</span>
<a href="#l32.482"></a><span id="l32.482" class="difflineminus">-</span>
<a href="#l32.483"></a><span id="l32.483" class="difflineminus">-nsresult</span>
<a href="#l32.484"></a><span id="l32.484" class="difflineminus">-nsAbDirectoryDataSource::createDirectoryIsWriteableNode(nsIAbDirectory* directory,</span>
<a href="#l32.485"></a><span id="l32.485" class="difflineminus">-                                                        nsIRDFNode **target)</span>
<a href="#l32.486"></a><span id="l32.486" class="difflineminus">-{</span>
<a href="#l32.487"></a><span id="l32.487" class="difflineminus">-  PRBool isReadOnly;</span>
<a href="#l32.488"></a><span id="l32.488" class="difflineminus">-  nsresult rv = directory-&gt;GetReadOnly(&amp;isReadOnly);</span>
<a href="#l32.489"></a><span id="l32.489" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l32.490"></a><span id="l32.490" class="difflineminus">-</span>
<a href="#l32.491"></a><span id="l32.491" class="difflineminus">-  NS_IF_ADDREF(*target = (isReadOnly ? kFalseLiteral : kTrueLiteral));</span>
<a href="#l32.492"></a><span id="l32.492" class="difflineminus">-  return NS_OK;</span>
<a href="#l32.493"></a><span id="l32.493" class="difflineminus">-}</span>
<a href="#l32.494"></a><span id="l32.494" class="difflineminus">-</span>
<a href="#l32.495"></a><span id="l32.495" class="difflineminus">-nsresult</span>
<a href="#l32.496"></a><span id="l32.496" class="difflineminus">-nsAbDirectoryDataSource::createDirectoryIsMailListNode(nsIAbDirectory* directory,</span>
<a href="#l32.497"></a><span id="l32.497" class="difflineminus">-                                                       nsIRDFNode **target)</span>
<a href="#l32.498"></a><span id="l32.498" class="difflineminus">-{</span>
<a href="#l32.499"></a><span id="l32.499" class="difflineminus">-  PRBool isMailList;</span>
<a href="#l32.500"></a><span id="l32.500" class="difflineminus">-  nsresult rv = directory-&gt;GetIsMailList(&amp;isMailList);</span>
<a href="#l32.501"></a><span id="l32.501" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l32.502"></a><span id="l32.502" class="difflineminus">-</span>
<a href="#l32.503"></a><span id="l32.503" class="difflineminus">-  NS_IF_ADDREF(*target = (isMailList ? kTrueLiteral : kFalseLiteral));</span>
<a href="#l32.504"></a><span id="l32.504" class="difflineminus">-  return NS_OK;</span>
<a href="#l32.505"></a><span id="l32.505" class="difflineminus">-}</span>
<a href="#l32.506"></a><span id="l32.506" class="difflineminus">-</span>
<a href="#l32.507"></a><span id="l32.507" class="difflineminus">-nsresult</span>
<a href="#l32.508"></a><span id="l32.508" class="difflineminus">-nsAbDirectoryDataSource::createDirectorySupportsMailingListsNode(nsIAbDirectory* directory,</span>
<a href="#l32.509"></a><span id="l32.509" class="difflineminus">-                                                                 nsIRDFNode **target)</span>
<a href="#l32.510"></a><span id="l32.510" class="difflineminus">-{</span>
<a href="#l32.511"></a><span id="l32.511" class="difflineminus">-  PRBool supportsMailingLists;</span>
<a href="#l32.512"></a><span id="l32.512" class="difflineminus">-  nsresult rv = directory-&gt;GetSupportsMailingLists(&amp;supportsMailingLists);</span>
<a href="#l32.513"></a><span id="l32.513" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l32.514"></a><span id="l32.514" class="difflineminus">-</span>
<a href="#l32.515"></a><span id="l32.515" class="difflineminus">-  NS_IF_ADDREF(*target = (supportsMailingLists ? kTrueLiteral : kFalseLiteral));</span>
<a href="#l32.516"></a><span id="l32.516" class="difflineminus">-  return NS_OK;</span>
<a href="#l32.517"></a><span id="l32.517" class="difflineminus">-}</span>
<a href="#l32.518"></a><span id="l32.518" class="difflineminus">-</span>
<a href="#l32.519"></a><span id="l32.519" class="difflineminus">-nsresult</span>
<a href="#l32.520"></a><span id="l32.520" class="difflineminus">-nsAbDirectoryDataSource::createDirectoryTreeNameSortNode(nsIAbDirectory* directory, nsIRDFNode **target)</span>
<a href="#l32.521"></a><span id="l32.521" class="difflineminus">-{</span>
<a href="#l32.522"></a><span id="l32.522" class="difflineminus">-  nsString name;</span>
<a href="#l32.523"></a><span id="l32.523" class="difflineminus">-  nsresult rv = directory-&gt;GetDirName(name);</span>
<a href="#l32.524"></a><span id="l32.524" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l32.525"></a><span id="l32.525" class="difflineminus">-</span>
<a href="#l32.526"></a><span id="l32.526" class="difflineminus">-  /* sort addressbooks in this order - Personal Addressbook, Collected Addresses, MDB, LDAP -</span>
<a href="#l32.527"></a><span id="l32.527" class="difflineminus">-   * by prefixing address book names with numbers and using the xul sort service.</span>
<a href="#l32.528"></a><span id="l32.528" class="difflineminus">-   *</span>
<a href="#l32.529"></a><span id="l32.529" class="difflineminus">-   *  0Personal Address Book</span>
<a href="#l32.530"></a><span id="l32.530" class="difflineminus">-   *  1Collected Address Book</span>
<a href="#l32.531"></a><span id="l32.531" class="difflineminus">-   *  2MAB1</span>
<a href="#l32.532"></a><span id="l32.532" class="difflineminus">-   *    5MAB1LIST1</span>
<a href="#l32.533"></a><span id="l32.533" class="difflineminus">-   *    5MAB1LIST2</span>
<a href="#l32.534"></a><span id="l32.534" class="difflineminus">-   *  2MAB2</span>
<a href="#l32.535"></a><span id="l32.535" class="difflineminus">-   *    5MAB2LIST1</span>
<a href="#l32.536"></a><span id="l32.536" class="difflineminus">-   *    5MAB2LIST2</span>
<a href="#l32.537"></a><span id="l32.537" class="difflineminus">-   *  3LDAP1</span>
<a href="#l32.538"></a><span id="l32.538" class="difflineminus">-   *  3LDAP2</span>
<a href="#l32.539"></a><span id="l32.539" class="difflineminus">-   *  4MAPI1</span>
<a href="#l32.540"></a><span id="l32.540" class="difflineminus">-   *  4MAPI2</span>
<a href="#l32.541"></a><span id="l32.541" class="difflineminus">-   */</span>
<a href="#l32.542"></a><span id="l32.542" class="difflineminus">-</span>
<a href="#l32.543"></a><span id="l32.543" class="difflineminus">-  // Get isMailList</span>
<a href="#l32.544"></a><span id="l32.544" class="difflineminus">-  PRBool isMailList = PR_FALSE;</span>
<a href="#l32.545"></a><span id="l32.545" class="difflineminus">-  rv = directory-&gt;GetIsMailList(&amp;isMailList);</span>
<a href="#l32.546"></a><span id="l32.546" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l32.547"></a><span id="l32.547" class="difflineminus">-</span>
<a href="#l32.548"></a><span id="l32.548" class="difflineminus">-  nsAutoString sortString;</span>
<a href="#l32.549"></a><span id="l32.549" class="difflineminus">-</span>
<a href="#l32.550"></a><span id="l32.550" class="difflineminus">-  if (isMailList)</span>
<a href="#l32.551"></a><span id="l32.551" class="difflineminus">-    // Mailing Lists don't need a top level sort position.</span>
<a href="#l32.552"></a><span id="l32.552" class="difflineminus">-    sortString.AppendInt(5);</span>
<a href="#l32.553"></a><span id="l32.553" class="difflineminus">-  else</span>
<a href="#l32.554"></a><span id="l32.554" class="difflineminus">-  {</span>
<a href="#l32.555"></a><span id="l32.555" class="difflineminus">-    // If its not a mailing list, find out what else we need to know.</span>
<a href="#l32.556"></a><span id="l32.556" class="difflineminus">-    nsCOMPtr&lt;nsIRDFResource&gt; resource = do_QueryInterface(directory);</span>
<a href="#l32.557"></a><span id="l32.557" class="difflineminus">-    const char *uri = nsnull;</span>
<a href="#l32.558"></a><span id="l32.558" class="difflineminus">-    rv = resource-&gt;GetValueConst(&amp;uri);</span>
<a href="#l32.559"></a><span id="l32.559" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l32.560"></a><span id="l32.560" class="difflineminus">-</span>
<a href="#l32.561"></a><span id="l32.561" class="difflineminus">-    // Get directory type.</span>
<a href="#l32.562"></a><span id="l32.562" class="difflineminus">-    PRInt32 dirType;</span>
<a href="#l32.563"></a><span id="l32.563" class="difflineminus">-    rv = directory-&gt;GetDirType(&amp;dirType);</span>
<a href="#l32.564"></a><span id="l32.564" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l32.565"></a><span id="l32.565" class="difflineminus">-</span>
<a href="#l32.566"></a><span id="l32.566" class="difflineminus">-    PRInt32 position;</span>
<a href="#l32.567"></a><span id="l32.567" class="difflineminus">-    rv = directory-&gt;GetPosition(&amp;position);</span>
<a href="#l32.568"></a><span id="l32.568" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l32.569"></a><span id="l32.569" class="difflineminus">-</span>
<a href="#l32.570"></a><span id="l32.570" class="difflineminus">-    // top level sort will be by position. Sort by type under that...</span>
<a href="#l32.571"></a><span id="l32.571" class="difflineminus">-    sortString.Append((PRUnichar) (position + 'a'));</span>
<a href="#l32.572"></a><span id="l32.572" class="difflineminus">-</span>
<a href="#l32.573"></a><span id="l32.573" class="difflineminus">-    if (dirType == PABDirectory)</span>
<a href="#l32.574"></a><span id="l32.574" class="difflineminus">-    {</span>
<a href="#l32.575"></a><span id="l32.575" class="difflineminus">-      if (strcmp(uri, kPersonalAddressbookUri) == 0)</span>
<a href="#l32.576"></a><span id="l32.576" class="difflineminus">-        sortString.AppendInt(0);  // Personal addrbook</span>
<a href="#l32.577"></a><span id="l32.577" class="difflineminus">-      else if (strcmp(uri, kCollectedAddressbookUri) == 0)</span>
<a href="#l32.578"></a><span id="l32.578" class="difflineminus">-        sortString.AppendInt(1);  // Collected addrbook</span>
<a href="#l32.579"></a><span id="l32.579" class="difflineminus">-      else</span>
<a href="#l32.580"></a><span id="l32.580" class="difflineminus">-        sortString.AppendInt(2);  // Normal addrbook</span>
<a href="#l32.581"></a><span id="l32.581" class="difflineminus">-    }</span>
<a href="#l32.582"></a><span id="l32.582" class="difflineminus">-    else if (dirType == LDAPDirectory)</span>
<a href="#l32.583"></a><span id="l32.583" class="difflineminus">-      sortString.AppendInt(3);    // LDAP addrbook</span>
<a href="#l32.584"></a><span id="l32.584" class="difflineminus">-    else if (dirType == MAPIDirectory)</span>
<a href="#l32.585"></a><span id="l32.585" class="difflineminus">-      sortString.AppendInt(4);    // MAPI addrbook</span>
<a href="#l32.586"></a><span id="l32.586" class="difflineminus">-    else</span>
<a href="#l32.587"></a><span id="l32.587" class="difflineminus">-      sortString.AppendInt(6);    // everything else comes last</span>
<a href="#l32.588"></a><span id="l32.588" class="difflineminus">-  }</span>
<a href="#l32.589"></a><span id="l32.589" class="difflineminus">-</span>
<a href="#l32.590"></a><span id="l32.590" class="difflineminus">-  sortString += name;</span>
<a href="#l32.591"></a><span id="l32.591" class="difflineminus">-  PRUint8 *sortKey = nsnull;</span>
<a href="#l32.592"></a><span id="l32.592" class="difflineminus">-  PRUint32 sortKeyLength;</span>
<a href="#l32.593"></a><span id="l32.593" class="difflineminus">-  rv = CreateCollationKey(sortString, &amp;sortKey, &amp;sortKeyLength);</span>
<a href="#l32.594"></a><span id="l32.594" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l32.595"></a><span id="l32.595" class="difflineminus">-  nsCOMPtr &lt;nsIRDFService&gt; rdfService = do_GetService (NS_RDF_CONTRACTID &quot;/rdf-service;1&quot;, &amp;rv);</span>
<a href="#l32.596"></a><span id="l32.596" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l32.597"></a><span id="l32.597" class="difflineminus">-  createBlobNode(sortKey, sortKeyLength, target, rdfService);</span>
<a href="#l32.598"></a><span id="l32.598" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l32.599"></a><span id="l32.599" class="difflineminus">-  PR_Free(sortKey);</span>
<a href="#l32.600"></a><span id="l32.600" class="difflineminus">-</span>
<a href="#l32.601"></a><span id="l32.601" class="difflineminus">-  return NS_OK;</span>
<a href="#l32.602"></a><span id="l32.602" class="difflineminus">-</span>
<a href="#l32.603"></a><span id="l32.603" class="difflineminus">-}</span>
<a href="#l32.604"></a><span id="l32.604" class="difflineminus">-</span>
<a href="#l32.605"></a><span id="l32.605" class="difflineminus">-nsresult nsAbDirectoryDataSource::CreateCollationKey(const nsString &amp;aSource,  PRUint8 **aKey, PRUint32 *aLength)</span>
<a href="#l32.606"></a><span id="l32.606" class="difflineminus">-{</span>
<a href="#l32.607"></a><span id="l32.607" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aKey);</span>
<a href="#l32.608"></a><span id="l32.608" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aLength);</span>
<a href="#l32.609"></a><span id="l32.609" class="difflineminus">-</span>
<a href="#l32.610"></a><span id="l32.610" class="difflineminus">-  nsresult rv;</span>
<a href="#l32.611"></a><span id="l32.611" class="difflineminus">-  if (!mCollationKeyGenerator)</span>
<a href="#l32.612"></a><span id="l32.612" class="difflineminus">-  {</span>
<a href="#l32.613"></a><span id="l32.613" class="difflineminus">-    nsCOMPtr&lt;nsILocaleService&gt; localeSvc = do_GetService(NS_LOCALESERVICE_CONTRACTID,&amp;rv);</span>
<a href="#l32.614"></a><span id="l32.614" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l32.615"></a><span id="l32.615" class="difflineminus">-</span>
<a href="#l32.616"></a><span id="l32.616" class="difflineminus">-    nsCOMPtr&lt;nsILocale&gt; locale;</span>
<a href="#l32.617"></a><span id="l32.617" class="difflineminus">-    rv = localeSvc-&gt;GetApplicationLocale(getter_AddRefs(locale));</span>
<a href="#l32.618"></a><span id="l32.618" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l32.619"></a><span id="l32.619" class="difflineminus">-</span>
<a href="#l32.620"></a><span id="l32.620" class="difflineminus">-    nsCOMPtr &lt;nsICollationFactory&gt; factory = do_CreateInstance(NS_COLLATIONFACTORY_CONTRACTID, &amp;rv);</span>
<a href="#l32.621"></a><span id="l32.621" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l32.622"></a><span id="l32.622" class="difflineminus">-</span>
<a href="#l32.623"></a><span id="l32.623" class="difflineminus">-    rv = factory-&gt;CreateCollation(locale, getter_AddRefs(mCollationKeyGenerator));</span>
<a href="#l32.624"></a><span id="l32.624" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l32.625"></a><span id="l32.625" class="difflineminus">-  }</span>
<a href="#l32.626"></a><span id="l32.626" class="difflineminus">-</span>
<a href="#l32.627"></a><span id="l32.627" class="difflineminus">-  return mCollationKeyGenerator-&gt;AllocateRawSortKey(nsICollation::kCollationCaseInSensitive, aSource, aKey, aLength);</span>
<a href="#l32.628"></a><span id="l32.628" class="difflineminus">-}</span>
<a href="#l32.629"></a><span id="l32.629" class="difflineminus">-</span>
<a href="#l32.630"></a><span id="l32.630" class="difflineminus">-nsresult nsAbDirectoryDataSource::DoDirectoryAssert(nsIAbDirectory *directory, nsIRDFResource *property, nsIRDFNode *target)</span>
<a href="#l32.631"></a><span id="l32.631" class="difflineminus">-{</span>
<a href="#l32.632"></a><span id="l32.632" class="difflineminus">-  return NS_ERROR_FAILURE;</span>
<a href="#l32.633"></a><span id="l32.633" class="difflineminus">-}</span>
<a href="#l32.634"></a><span id="l32.634" class="difflineminus">-</span>
<a href="#l32.635"></a><span id="l32.635" class="difflineminus">-</span>
<a href="#l32.636"></a><span id="l32.636" class="difflineminus">-nsresult nsAbDirectoryDataSource::DoDirectoryHasAssertion(nsIAbDirectory *directory, nsIRDFResource *property, nsIRDFNode *target,</span>
<a href="#l32.637"></a><span id="l32.637" class="difflineminus">-                           PRBool tv, PRBool *hasAssertion)</span>
<a href="#l32.638"></a><span id="l32.638" class="difflineminus">-{</span>
<a href="#l32.639"></a><span id="l32.639" class="difflineminus">-  nsresult rv = NS_OK;</span>
<a href="#l32.640"></a><span id="l32.640" class="difflineminus">-  if (!hasAssertion)</span>
<a href="#l32.641"></a><span id="l32.641" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l32.642"></a><span id="l32.642" class="difflineminus">-</span>
<a href="#l32.643"></a><span id="l32.643" class="difflineminus">-  //We're not keeping track of negative assertions on directory.</span>
<a href="#l32.644"></a><span id="l32.644" class="difflineminus">-  if (!tv)</span>
<a href="#l32.645"></a><span id="l32.645" class="difflineminus">-  {</span>
<a href="#l32.646"></a><span id="l32.646" class="difflineminus">-    *hasAssertion = PR_FALSE;</span>
<a href="#l32.647"></a><span id="l32.647" class="difflineminus">-    return NS_OK;</span>
<a href="#l32.648"></a><span id="l32.648" class="difflineminus">-  }</span>
<a href="#l32.649"></a><span id="l32.649" class="difflineminus">-</span>
<a href="#l32.650"></a><span id="l32.650" class="difflineminus">-  if ((kNC_Child == property))</span>
<a href="#l32.651"></a><span id="l32.651" class="difflineminus">-  {</span>
<a href="#l32.652"></a><span id="l32.652" class="difflineminus">-    nsCOMPtr&lt;nsIAbDirectory&gt; newDirectory(do_QueryInterface(target, &amp;rv));</span>
<a href="#l32.653"></a><span id="l32.653" class="difflineminus">-    if(NS_SUCCEEDED(rv))</span>
<a href="#l32.654"></a><span id="l32.654" class="difflineminus">-      rv = directory-&gt;HasDirectory(newDirectory, hasAssertion);</span>
<a href="#l32.655"></a><span id="l32.655" class="difflineminus">-  }</span>
<a href="#l32.656"></a><span id="l32.656" class="difflineminus">-  else if ((kNC_IsMailList == property) || (kNC_IsRemote == property) ||</span>
<a href="#l32.657"></a><span id="l32.657" class="difflineminus">-            (kNC_IsSecure == property) || (kNC_IsWriteable == property) ||</span>
<a href="#l32.658"></a><span id="l32.658" class="difflineminus">-            (kNC_SupportsMailingLists == property))</span>
<a href="#l32.659"></a><span id="l32.659" class="difflineminus">-  {</span>
<a href="#l32.660"></a><span id="l32.660" class="difflineminus">-    nsCOMPtr&lt;nsIRDFResource&gt; dirResource(do_QueryInterface(directory, &amp;rv));</span>
<a href="#l32.661"></a><span id="l32.661" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l32.662"></a><span id="l32.662" class="difflineminus">-    rv = GetTargetHasAssertion(this, dirResource, property, tv, target, hasAssertion);</span>
<a href="#l32.663"></a><span id="l32.663" class="difflineminus">-  }</span>
<a href="#l32.664"></a><span id="l32.664" class="difflineminus">-  else</span>
<a href="#l32.665"></a><span id="l32.665" class="difflineminus">-    *hasAssertion = PR_FALSE;</span>
<a href="#l32.666"></a><span id="l32.666" class="difflineminus">-</span>
<a href="#l32.667"></a><span id="l32.667" class="difflineminus">-  return rv;</span>
<a href="#l32.668"></a><span id="l32.668" class="difflineminus">-</span>
<a href="#l32.669"></a><span id="l32.669" class="difflineminus">-}</span>
<a href="#l32.670"></a><span id="l32.670" class="difflineminus">-</span>
<a href="#l32.671"></a><span id="l32.671" class="difflineminus">-nsresult nsAbDirectoryDataSource::GetTargetHasAssertion(nsIRDFDataSource *dataSource, nsIRDFResource* dirResource,</span>
<a href="#l32.672"></a><span id="l32.672" class="difflineminus">-                 nsIRDFResource *property,PRBool tv, nsIRDFNode *target,PRBool* hasAssertion)</span>
<a href="#l32.673"></a><span id="l32.673" class="difflineminus">-{</span>
<a href="#l32.674"></a><span id="l32.674" class="difflineminus">-  nsresult rv;</span>
<a href="#l32.675"></a><span id="l32.675" class="difflineminus">-  if(!hasAssertion)</span>
<a href="#l32.676"></a><span id="l32.676" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l32.677"></a><span id="l32.677" class="difflineminus">-</span>
<a href="#l32.678"></a><span id="l32.678" class="difflineminus">-  nsCOMPtr&lt;nsIRDFNode&gt; currentTarget;</span>
<a href="#l32.679"></a><span id="l32.679" class="difflineminus">-</span>
<a href="#l32.680"></a><span id="l32.680" class="difflineminus">-  rv = dataSource-&gt;GetTarget(dirResource, property,tv, getter_AddRefs(currentTarget));</span>
<a href="#l32.681"></a><span id="l32.681" class="difflineminus">-  if(NS_SUCCEEDED(rv))</span>
<a href="#l32.682"></a><span id="l32.682" class="difflineminus">-  {</span>
<a href="#l32.683"></a><span id="l32.683" class="difflineminus">-    nsCOMPtr&lt;nsIRDFLiteral&gt; value1(do_QueryInterface(target));</span>
<a href="#l32.684"></a><span id="l32.684" class="difflineminus">-    nsCOMPtr&lt;nsIRDFLiteral&gt; value2(do_QueryInterface(currentTarget));</span>
<a href="#l32.685"></a><span id="l32.685" class="difflineminus">-    if(value1 &amp;&amp; value2)</span>
<a href="#l32.686"></a><span id="l32.686" class="difflineminus">-      //If the two values are equal then it has this assertion</span>
<a href="#l32.687"></a><span id="l32.687" class="difflineminus">-      *hasAssertion = (value1 == value2);</span>
<a href="#l32.688"></a><span id="l32.688" class="difflineminus">-  }</span>
<a href="#l32.689"></a><span id="l32.689" class="difflineminus">-  else</span>
<a href="#l32.690"></a><span id="l32.690" class="difflineminus">-    rv = NS_NOINTERFACE;</span>
<a href="#l32.691"></a><span id="l32.691" class="difflineminus">-</span>
<a href="#l32.692"></a><span id="l32.692" class="difflineminus">-  return rv;</span>
<a href="#l32.693"></a><span id="l32.693" class="difflineminus">-</span>
<a href="#l32.694"></a><span id="l32.694" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1">deleted file mode 100644</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineminus">--- a/mailnews/addrbook/src/nsDirectoryDataSource.h</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineplus">+++ /dev/null</span>
<a href="#l33.4"></a><span id="l33.4" class="difflineat">@@ -1,152 +0,0 @@</span>
<a href="#l33.5"></a><span id="l33.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l33.6"></a><span id="l33.6" class="difflineminus">-/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l33.7"></a><span id="l33.7" class="difflineminus">- * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l33.8"></a><span id="l33.8" class="difflineminus">- *</span>
<a href="#l33.9"></a><span id="l33.9" class="difflineminus">- * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l33.10"></a><span id="l33.10" class="difflineminus">- * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l33.11"></a><span id="l33.11" class="difflineminus">- * the License. You may obtain a copy of the License at</span>
<a href="#l33.12"></a><span id="l33.12" class="difflineminus">- * http://www.mozilla.org/MPL/</span>
<a href="#l33.13"></a><span id="l33.13" class="difflineminus">- *</span>
<a href="#l33.14"></a><span id="l33.14" class="difflineminus">- * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l33.15"></a><span id="l33.15" class="difflineminus">- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l33.16"></a><span id="l33.16" class="difflineminus">- * for the specific language governing rights and limitations under the</span>
<a href="#l33.17"></a><span id="l33.17" class="difflineminus">- * License.</span>
<a href="#l33.18"></a><span id="l33.18" class="difflineminus">- *</span>
<a href="#l33.19"></a><span id="l33.19" class="difflineminus">- * The Original Code is mozilla.org code.</span>
<a href="#l33.20"></a><span id="l33.20" class="difflineminus">- *</span>
<a href="#l33.21"></a><span id="l33.21" class="difflineminus">- * The Initial Developer of the Original Code is</span>
<a href="#l33.22"></a><span id="l33.22" class="difflineminus">- * Netscape Communications Corporation.</span>
<a href="#l33.23"></a><span id="l33.23" class="difflineminus">- * Portions created by the Initial Developer are Copyright (C) 1999</span>
<a href="#l33.24"></a><span id="l33.24" class="difflineminus">- * the Initial Developer. All Rights Reserved.</span>
<a href="#l33.25"></a><span id="l33.25" class="difflineminus">- *</span>
<a href="#l33.26"></a><span id="l33.26" class="difflineminus">- * Contributor(s):</span>
<a href="#l33.27"></a><span id="l33.27" class="difflineminus">- *   Seth Spitzer &lt;sspitzer@netscape.com&gt;</span>
<a href="#l33.28"></a><span id="l33.28" class="difflineminus">- *</span>
<a href="#l33.29"></a><span id="l33.29" class="difflineminus">- * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l33.30"></a><span id="l33.30" class="difflineminus">- * either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l33.31"></a><span id="l33.31" class="difflineminus">- * or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l33.32"></a><span id="l33.32" class="difflineminus">- * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l33.33"></a><span id="l33.33" class="difflineminus">- * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l33.34"></a><span id="l33.34" class="difflineminus">- * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l33.35"></a><span id="l33.35" class="difflineminus">- * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l33.36"></a><span id="l33.36" class="difflineminus">- * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l33.37"></a><span id="l33.37" class="difflineminus">- * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l33.38"></a><span id="l33.38" class="difflineminus">- * the provisions above, a recipient may use your version of this file under</span>
<a href="#l33.39"></a><span id="l33.39" class="difflineminus">- * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l33.40"></a><span id="l33.40" class="difflineminus">- *</span>
<a href="#l33.41"></a><span id="l33.41" class="difflineminus">- * ***** END LICENSE BLOCK ***** */</span>
<a href="#l33.42"></a><span id="l33.42" class="difflineminus">-#ifndef __nsDirectoryDataSource_h</span>
<a href="#l33.43"></a><span id="l33.43" class="difflineminus">-#define __nsDirectoryDataSource_h</span>
<a href="#l33.44"></a><span id="l33.44" class="difflineminus">- </span>
<a href="#l33.45"></a><span id="l33.45" class="difflineminus">-</span>
<a href="#l33.46"></a><span id="l33.46" class="difflineminus">-#include &quot;nsAbRDFDataSource.h&quot;</span>
<a href="#l33.47"></a><span id="l33.47" class="difflineminus">-#include &quot;nsIRDFService.h&quot;</span>
<a href="#l33.48"></a><span id="l33.48" class="difflineminus">-#include &quot;nsIAbListener.h&quot;</span>
<a href="#l33.49"></a><span id="l33.49" class="difflineminus">-#include &quot;nsIAbDirectory.h&quot;</span>
<a href="#l33.50"></a><span id="l33.50" class="difflineminus">-#include &quot;nsDirPrefs.h&quot;</span>
<a href="#l33.51"></a><span id="l33.51" class="difflineminus">-#include &quot;nsIAbListener.h&quot;</span>
<a href="#l33.52"></a><span id="l33.52" class="difflineminus">-#include &quot;nsIObserver.h&quot;</span>
<a href="#l33.53"></a><span id="l33.53" class="difflineminus">-#include &quot;nsWeakReference.h&quot;</span>
<a href="#l33.54"></a><span id="l33.54" class="difflineminus">-#include &quot;nsICollation.h&quot;</span>
<a href="#l33.55"></a><span id="l33.55" class="difflineminus">-</span>
<a href="#l33.56"></a><span id="l33.56" class="difflineminus">-/**</span>
<a href="#l33.57"></a><span id="l33.57" class="difflineminus">- * The addressbook data source.</span>
<a href="#l33.58"></a><span id="l33.58" class="difflineminus">- */</span>
<a href="#l33.59"></a><span id="l33.59" class="difflineminus">-class nsAbDirectoryDataSource : public nsAbRDFDataSource,</span>
<a href="#l33.60"></a><span id="l33.60" class="difflineminus">-                  public nsIAbListener, public nsIObserver, public nsSupportsWeakReference</span>
<a href="#l33.61"></a><span id="l33.61" class="difflineminus">-{</span>
<a href="#l33.62"></a><span id="l33.62" class="difflineminus">-private:</span>
<a href="#l33.63"></a><span id="l33.63" class="difflineminus">-  PRBool  mInitialized;</span>
<a href="#l33.64"></a><span id="l33.64" class="difflineminus">-</span>
<a href="#l33.65"></a><span id="l33.65" class="difflineminus">-public:</span>
<a href="#l33.66"></a><span id="l33.66" class="difflineminus">-  </span>
<a href="#l33.67"></a><span id="l33.67" class="difflineminus">-  NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l33.68"></a><span id="l33.68" class="difflineminus">-  NS_DECL_NSIABLISTENER</span>
<a href="#l33.69"></a><span id="l33.69" class="difflineminus">-  NS_DECL_NSIOBSERVER</span>
<a href="#l33.70"></a><span id="l33.70" class="difflineminus">-</span>
<a href="#l33.71"></a><span id="l33.71" class="difflineminus">-  nsAbDirectoryDataSource(void);</span>
<a href="#l33.72"></a><span id="l33.72" class="difflineminus">-  virtual ~nsAbDirectoryDataSource (void);</span>
<a href="#l33.73"></a><span id="l33.73" class="difflineminus">-  virtual nsresult Init();</span>
<a href="#l33.74"></a><span id="l33.74" class="difflineminus">-</span>
<a href="#l33.75"></a><span id="l33.75" class="difflineminus">-  // nsIRDFDataSource methods</span>
<a href="#l33.76"></a><span id="l33.76" class="difflineminus">-  NS_IMETHOD GetURI(char* *uri);</span>
<a href="#l33.77"></a><span id="l33.77" class="difflineminus">-</span>
<a href="#l33.78"></a><span id="l33.78" class="difflineminus">-  NS_IMETHOD GetTarget(nsIRDFResource* source,</span>
<a href="#l33.79"></a><span id="l33.79" class="difflineminus">-             nsIRDFResource* property,</span>
<a href="#l33.80"></a><span id="l33.80" class="difflineminus">-             PRBool tv,</span>
<a href="#l33.81"></a><span id="l33.81" class="difflineminus">-             nsIRDFNode** target);</span>
<a href="#l33.82"></a><span id="l33.82" class="difflineminus">-</span>
<a href="#l33.83"></a><span id="l33.83" class="difflineminus">-  NS_IMETHOD GetTargets(nsIRDFResource* source,</span>
<a href="#l33.84"></a><span id="l33.84" class="difflineminus">-            nsIRDFResource* property,    </span>
<a href="#l33.85"></a><span id="l33.85" class="difflineminus">-            PRBool tv,</span>
<a href="#l33.86"></a><span id="l33.86" class="difflineminus">-            nsISimpleEnumerator** targets);</span>
<a href="#l33.87"></a><span id="l33.87" class="difflineminus">-</span>
<a href="#l33.88"></a><span id="l33.88" class="difflineminus">-  NS_IMETHOD Assert(nsIRDFResource* source,</span>
<a href="#l33.89"></a><span id="l33.89" class="difflineminus">-          nsIRDFResource* property, </span>
<a href="#l33.90"></a><span id="l33.90" class="difflineminus">-          nsIRDFNode* target,</span>
<a href="#l33.91"></a><span id="l33.91" class="difflineminus">-          PRBool tv);</span>
<a href="#l33.92"></a><span id="l33.92" class="difflineminus">-</span>
<a href="#l33.93"></a><span id="l33.93" class="difflineminus">-  NS_IMETHOD HasAssertion(nsIRDFResource* source,</span>
<a href="#l33.94"></a><span id="l33.94" class="difflineminus">-              nsIRDFResource* property,</span>
<a href="#l33.95"></a><span id="l33.95" class="difflineminus">-              nsIRDFNode* target,</span>
<a href="#l33.96"></a><span id="l33.96" class="difflineminus">-              PRBool tv,</span>
<a href="#l33.97"></a><span id="l33.97" class="difflineminus">-              PRBool* hasAssertion);</span>
<a href="#l33.98"></a><span id="l33.98" class="difflineminus">-</span>
<a href="#l33.99"></a><span id="l33.99" class="difflineminus">-  NS_IMETHOD HasArcOut(nsIRDFResource *aSource, nsIRDFResource *aArc, PRBool *result);</span>
<a href="#l33.100"></a><span id="l33.100" class="difflineminus">-</span>
<a href="#l33.101"></a><span id="l33.101" class="difflineminus">-  NS_IMETHOD ArcLabelsOut(nsIRDFResource* source,</span>
<a href="#l33.102"></a><span id="l33.102" class="difflineminus">-              nsISimpleEnumerator** labels); </span>
<a href="#l33.103"></a><span id="l33.103" class="difflineminus">-</span>
<a href="#l33.104"></a><span id="l33.104" class="difflineminus">-protected:</span>
<a href="#l33.105"></a><span id="l33.105" class="difflineminus">-</span>
<a href="#l33.106"></a><span id="l33.106" class="difflineminus">-  nsresult createDirectoryNode(nsIAbDirectory* directory, nsIRDFResource* property,</span>
<a href="#l33.107"></a><span id="l33.107" class="difflineminus">-                                 nsIRDFNode** target);</span>
<a href="#l33.108"></a><span id="l33.108" class="difflineminus">-  nsresult createDirectoryNameNode(nsIAbDirectory *directory,</span>
<a href="#l33.109"></a><span id="l33.109" class="difflineminus">-                                     nsIRDFNode **target);</span>
<a href="#l33.110"></a><span id="l33.110" class="difflineminus">-  nsresult createDirectoryUriNode(nsIAbDirectory *directory,</span>
<a href="#l33.111"></a><span id="l33.111" class="difflineminus">-                                     nsIRDFNode **target);</span>
<a href="#l33.112"></a><span id="l33.112" class="difflineminus">-  nsresult createDirectoryChildNode(nsIAbDirectory *directory,</span>
<a href="#l33.113"></a><span id="l33.113" class="difflineminus">-                                      nsIRDFNode **target);</span>
<a href="#l33.114"></a><span id="l33.114" class="difflineminus">-  nsresult createDirectoryIsMailListNode(nsIAbDirectory *directory,</span>
<a href="#l33.115"></a><span id="l33.115" class="difflineminus">-                                      nsIRDFNode **target);</span>
<a href="#l33.116"></a><span id="l33.116" class="difflineminus">-  nsresult createDirectoryIsRemoteNode(nsIAbDirectory *directory,</span>
<a href="#l33.117"></a><span id="l33.117" class="difflineminus">-    nsIRDFNode **target);</span>
<a href="#l33.118"></a><span id="l33.118" class="difflineminus">-  nsresult createDirectoryIsSecureNode(nsIAbDirectory *directory,</span>
<a href="#l33.119"></a><span id="l33.119" class="difflineminus">-    nsIRDFNode **target);</span>
<a href="#l33.120"></a><span id="l33.120" class="difflineminus">-  nsresult createDirectoryIsWriteableNode(nsIAbDirectory *directory,</span>
<a href="#l33.121"></a><span id="l33.121" class="difflineminus">-                                            nsIRDFNode **target);</span>
<a href="#l33.122"></a><span id="l33.122" class="difflineminus">-  nsresult createDirectorySupportsMailingListsNode(nsIAbDirectory* directory,</span>
<a href="#l33.123"></a><span id="l33.123" class="difflineminus">-                                                   nsIRDFNode **target);</span>
<a href="#l33.124"></a><span id="l33.124" class="difflineminus">-  nsresult createDirectoryTreeNameSortNode(nsIAbDirectory *directory,</span>
<a href="#l33.125"></a><span id="l33.125" class="difflineminus">-                                            nsIRDFNode **target);</span>
<a href="#l33.126"></a><span id="l33.126" class="difflineminus">-</span>
<a href="#l33.127"></a><span id="l33.127" class="difflineminus">-  nsresult DoDirectoryAssert(nsIAbDirectory *directory, </span>
<a href="#l33.128"></a><span id="l33.128" class="difflineminus">-          nsIRDFResource *property, nsIRDFNode *target);</span>
<a href="#l33.129"></a><span id="l33.129" class="difflineminus">-  nsresult DoDirectoryHasAssertion(nsIAbDirectory *directory, </span>
<a href="#l33.130"></a><span id="l33.130" class="difflineminus">-               nsIRDFResource *property, nsIRDFNode *target,</span>
<a href="#l33.131"></a><span id="l33.131" class="difflineminus">-               PRBool tv, PRBool *hasAssertion);</span>
<a href="#l33.132"></a><span id="l33.132" class="difflineminus">-</span>
<a href="#l33.133"></a><span id="l33.133" class="difflineminus">-  nsresult GetTargetHasAssertion(nsIRDFDataSource *dataSource, nsIRDFResource* dirResource,</span>
<a href="#l33.134"></a><span id="l33.134" class="difflineminus">-                 nsIRDFResource *property,PRBool tv, nsIRDFNode *target,PRBool* hasAssertion);</span>
<a href="#l33.135"></a><span id="l33.135" class="difflineminus">-  nsresult CreateCollationKey(const nsString &amp;aSource,  PRUint8 **aKey, PRUint32 *aLength);</span>
<a href="#l33.136"></a><span id="l33.136" class="difflineminus">-</span>
<a href="#l33.137"></a><span id="l33.137" class="difflineminus">-  nsCOMPtr&lt;nsIRDFResource&gt; kNC_Child;</span>
<a href="#l33.138"></a><span id="l33.138" class="difflineminus">-  nsCOMPtr&lt;nsIRDFResource&gt; kNC_DirName;</span>
<a href="#l33.139"></a><span id="l33.139" class="difflineminus">-  nsCOMPtr&lt;nsIRDFResource&gt; kNC_DirUri;</span>
<a href="#l33.140"></a><span id="l33.140" class="difflineminus">-  nsCOMPtr&lt;nsIRDFResource&gt; kNC_IsMailList;</span>
<a href="#l33.141"></a><span id="l33.141" class="difflineminus">-  nsCOMPtr&lt;nsIRDFResource&gt; kNC_IsRemote;</span>
<a href="#l33.142"></a><span id="l33.142" class="difflineminus">-  nsCOMPtr&lt;nsIRDFResource&gt; kNC_IsSecure;</span>
<a href="#l33.143"></a><span id="l33.143" class="difflineminus">-  nsCOMPtr&lt;nsIRDFResource&gt; kNC_IsWriteable;</span>
<a href="#l33.144"></a><span id="l33.144" class="difflineminus">-  nsCOMPtr&lt;nsIRDFResource&gt; kNC_DirTreeNameSort;</span>
<a href="#l33.145"></a><span id="l33.145" class="difflineminus">-  nsCOMPtr&lt;nsIRDFResource&gt; kNC_SupportsMailingLists;</span>
<a href="#l33.146"></a><span id="l33.146" class="difflineminus">-  nsCOMPtr&lt;nsICollation&gt; mCollationKeyGenerator;</span>
<a href="#l33.147"></a><span id="l33.147" class="difflineminus">-</span>
<a href="#l33.148"></a><span id="l33.148" class="difflineminus">-  //Cached literals</span>
<a href="#l33.149"></a><span id="l33.149" class="difflineminus">-  nsCOMPtr&lt;nsIRDFNode&gt; kTrueLiteral;</span>
<a href="#l33.150"></a><span id="l33.150" class="difflineminus">-  nsCOMPtr&lt;nsIRDFNode&gt; kFalseLiteral;</span>
<a href="#l33.151"></a><span id="l33.151" class="difflineminus">-</span>
<a href="#l33.152"></a><span id="l33.152" class="difflineminus">-private:</span>
<a href="#l33.153"></a><span id="l33.153" class="difflineminus">-  nsresult Cleanup();</span>
<a href="#l33.154"></a><span id="l33.154" class="difflineminus">-};</span>
<a href="#l33.155"></a><span id="l33.155" class="difflineminus">-</span>
<a href="#l33.156"></a><span id="l33.156" class="difflineminus">-#endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_nsAbManager2.js</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_nsAbManager2.js</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineat">@@ -117,17 +117,17 @@ function run_test() {</span>
<a href="#l34.4"></a><span id="l34.4">   for (i = 0; i &lt; numListenerOptions; ++i) {</span>
<a href="#l34.5"></a><span id="l34.5">     gAblSingle[i] = new abL;</span>
<a href="#l34.6"></a><span id="l34.6">     gAbManager.addAddressBookListener(gAblSingle[i], 1 &lt;&lt; i);</span>
<a href="#l34.7"></a><span id="l34.7">   }</span>
<a href="#l34.8"></a><span id="l34.8"> </span>
<a href="#l34.9"></a><span id="l34.9">   var expectedABs = [kPABData.URI, kCABData.URI];</span>
<a href="#l34.10"></a><span id="l34.10"> </span>
<a href="#l34.11"></a><span id="l34.11">   // Check the OS X Address Book if available</span>
<a href="#l34.12"></a><span id="l34.12" class="difflineminus">-  if (&quot;@mozilla.org/rdf/resource-factory;1?name=moz-abosxdirectory&quot; in</span>
<a href="#l34.13"></a><span id="l34.13" class="difflineplus">+  if (&quot;@mozilla.org/addressbook/directory;1?type=moz-abosxdirectory&quot; in</span>
<a href="#l34.14"></a><span id="l34.14">       Components.classes)</span>
<a href="#l34.15"></a><span id="l34.15">     expectedABs.push(kOSXData.URI);</span>
<a href="#l34.16"></a><span id="l34.16"> </span>
<a href="#l34.17"></a><span id="l34.17">   // Test - Check initial directories</span>
<a href="#l34.18"></a><span id="l34.18"> </span>
<a href="#l34.19"></a><span id="l34.19">   checkDirs(gAbManager.directories, expectedABs);</span>
<a href="#l34.20"></a><span id="l34.20"> </span>
<a href="#l34.21"></a><span id="l34.21">   // Test - Add a directory</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l35.1"></a><span id="l35.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgSearchTerm.cpp</span>
<a href="#l35.2"></a><span id="l35.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgSearchTerm.cpp</span>
<a href="#l35.3"></a><span id="l35.3" class="difflineat">@@ -57,30 +57,31 @@</span>
<a href="#l35.4"></a><span id="l35.4"> #include &quot;nsMsgSearchValue.h&quot;</span>
<a href="#l35.5"></a><span id="l35.5"> #include &quot;nsMsgI18N.h&quot;</span>
<a href="#l35.6"></a><span id="l35.6"> #include &quot;nsIMimeConverter.h&quot;</span>
<a href="#l35.7"></a><span id="l35.7"> #include &quot;nsMsgMimeCID.h&quot;</span>
<a href="#l35.8"></a><span id="l35.8"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l35.9"></a><span id="l35.9"> #include &quot;nsIPrefService.h&quot;</span>
<a href="#l35.10"></a><span id="l35.10"> #include &quot;nsIMsgFilterPlugin.h&quot;</span>
<a href="#l35.11"></a><span id="l35.11"> #include &quot;nsILocalFile.h&quot;</span>
<a href="#l35.12"></a><span id="l35.12" class="difflineminus">-#include &quot;nsIRDFService.h&quot;</span>
<a href="#l35.13"></a><span id="l35.13"> #include &quot;nsISupportsObsolete.h&quot;</span>
<a href="#l35.14"></a><span id="l35.14"> #include &quot;nsNetCID.h&quot;</span>
<a href="#l35.15"></a><span id="l35.15"> #include &quot;nsIFileStreams.h&quot;</span>
<a href="#l35.16"></a><span id="l35.16"> #include &quot;nsUnicharUtils.h&quot;</span>
<a href="#l35.17"></a><span id="l35.17"> #include &quot;nsIAbCard.h&quot;</span>
<a href="#l35.18"></a><span id="l35.18"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l35.19"></a><span id="l35.19"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l35.20"></a><span id="l35.20"> #include &quot;nsMemory.h&quot;</span>
<a href="#l35.21"></a><span id="l35.21"> #include &lt;ctype.h&gt;</span>
<a href="#l35.22"></a><span id="l35.22"> #include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l35.23"></a><span id="l35.23"> #include &quot;nsIMsgTagService.h&quot;</span>
<a href="#l35.24"></a><span id="l35.24"> #include &quot;nsMsgMessageFlags.h&quot;</span>
<a href="#l35.25"></a><span id="l35.25"> #include &quot;nsIMsgFilterService.h&quot;</span>
<a href="#l35.26"></a><span id="l35.26" class="difflineplus">+#include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l35.27"></a><span id="l35.27" class="difflineplus">+#include &quot;nsIAbManager.h&quot;</span>
<a href="#l35.28"></a><span id="l35.28"> </span>
<a href="#l35.29"></a><span id="l35.29"> //---------------------------------------------------------------------------</span>
<a href="#l35.30"></a><span id="l35.30"> // nsMsgSearchTerm specifies one criterion, e.g. name contains phil</span>
<a href="#l35.31"></a><span id="l35.31"> //---------------------------------------------------------------------------</span>
<a href="#l35.32"></a><span id="l35.32"> </span>
<a href="#l35.33"></a><span id="l35.33"> </span>
<a href="#l35.34"></a><span id="l35.34"> //-----------------------------------------------------------------------------</span>
<a href="#l35.35"></a><span id="l35.35"> //-------------------- Implementation of nsMsgSearchTerm -----------------------</span>
<a href="#l35.36"></a><span id="l35.36" class="difflineat">@@ -1026,24 +1027,20 @@ nsresult nsMsgSearchTerm::InitializeAddr</span>
<a href="#l35.37"></a><span id="l35.37">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l35.38"></a><span id="l35.38"> </span>
<a href="#l35.39"></a><span id="l35.39">     if (!uri.Equals(m_value.string))</span>
<a href="#l35.40"></a><span id="l35.40">       // clear out the directory....we are no longer pointing to the right one</span>
<a href="#l35.41"></a><span id="l35.41">       mDirectory = nsnull;</span>
<a href="#l35.42"></a><span id="l35.42">   }</span>
<a href="#l35.43"></a><span id="l35.43">   if (!mDirectory)</span>
<a href="#l35.44"></a><span id="l35.44">   {</span>
<a href="#l35.45"></a><span id="l35.45" class="difflineminus">-    nsCOMPtr &lt;nsIRDFService&gt; rdfService = do_GetService(&quot;@mozilla.org/rdf/rdf-service;1&quot;,&amp;rv);</span>
<a href="#l35.46"></a><span id="l35.46" class="difflineplus">+    nsCOMPtr&lt;nsIAbManager&gt; abManager = do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l35.47"></a><span id="l35.47">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l35.48"></a><span id="l35.48"> </span>
<a href="#l35.49"></a><span id="l35.49" class="difflineminus">-    nsCOMPtr &lt;nsIRDFResource&gt; resource;</span>
<a href="#l35.50"></a><span id="l35.50" class="difflineminus">-    rv = rdfService-&gt;GetResource(nsDependentCString(m_value.string), getter_AddRefs(resource));</span>
<a href="#l35.51"></a><span id="l35.51" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l35.52"></a><span id="l35.52" class="difflineminus">-</span>
<a href="#l35.53"></a><span id="l35.53" class="difflineminus">-    mDirectory = do_QueryInterface(resource, &amp;rv);</span>
<a href="#l35.54"></a><span id="l35.54" class="difflineplus">+    rv = abManager-&gt;GetDirectory(nsDependentCString(m_value.string), getter_AddRefs(mDirectory));</span>
<a href="#l35.55"></a><span id="l35.55">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l35.56"></a><span id="l35.56">   }</span>
<a href="#l35.57"></a><span id="l35.57"> </span>
<a href="#l35.58"></a><span id="l35.58">   return NS_OK;</span>
<a href="#l35.59"></a><span id="l35.59"> }</span>
<a href="#l35.60"></a><span id="l35.60"> </span>
<a href="#l35.61"></a><span id="l35.61"> nsresult nsMsgSearchTerm::MatchInAddressBook(const char * aAddress, PRBool *pResult)</span>
<a href="#l35.62"></a><span id="l35.62"> {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l36.1"></a><span id="l36.1" class="difflineminus">--- a/mailnews/build/nsMailModule.cpp</span>
<a href="#l36.2"></a><span id="l36.2" class="difflineplus">+++ b/mailnews/build/nsMailModule.cpp</span>
<a href="#l36.3"></a><span id="l36.3" class="difflineat">@@ -148,17 +148,16 @@</span>
<a href="#l36.4"></a><span id="l36.4"> #include &quot;nsMessengerContentHandler.h&quot;</span>
<a href="#l36.5"></a><span id="l36.5"> #include &quot;nsStopwatch.h&quot;</span>
<a href="#l36.6"></a><span id="l36.6"> #include &quot;MailNewsDLF.h&quot;</span>
<a href="#l36.7"></a><span id="l36.7"> </span>
<a href="#l36.8"></a><span id="l36.8"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l36.9"></a><span id="l36.9"> // addrbook includes</span>
<a href="#l36.10"></a><span id="l36.10"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l36.11"></a><span id="l36.11"> #include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l36.12"></a><span id="l36.12" class="difflineminus">-#include &quot;nsDirectoryDataSource.h&quot;</span>
<a href="#l36.13"></a><span id="l36.13"> #include &quot;nsAbBSDirectory.h&quot;</span>
<a href="#l36.14"></a><span id="l36.14"> #include &quot;nsAbMDBDirectory.h&quot;</span>
<a href="#l36.15"></a><span id="l36.15"> #include &quot;nsAbMDBCard.h&quot;</span>
<a href="#l36.16"></a><span id="l36.16"> #include &quot;nsAbDirFactoryService.h&quot;</span>
<a href="#l36.17"></a><span id="l36.17"> #include &quot;nsAbMDBDirFactory.h&quot;</span>
<a href="#l36.18"></a><span id="l36.18"> #include &quot;nsAddrDatabase.h&quot;</span>
<a href="#l36.19"></a><span id="l36.19"> #include &quot;nsAbManager.h&quot;</span>
<a href="#l36.20"></a><span id="l36.20"> #include &quot;nsAbContentHandler.h&quot;</span>
<a href="#l36.21"></a><span id="l36.21" class="difflineat">@@ -185,16 +184,17 @@</span>
<a href="#l36.22"></a><span id="l36.22"> #include &quot;nsAbLDAPReplicationData.h&quot;</span>
<a href="#l36.23"></a><span id="l36.23"> // XXX These files are not being built as they don't work. Bug 311632 should</span>
<a href="#l36.24"></a><span id="l36.24"> // fix them.</span>
<a href="#l36.25"></a><span id="l36.25"> //#include &quot;nsAbLDAPChangeLogQuery.h&quot;</span>
<a href="#l36.26"></a><span id="l36.26"> //#include &quot;nsAbLDAPChangeLogData.h&quot;</span>
<a href="#l36.27"></a><span id="l36.27"> #include &quot;nsLDAPAutoCompleteSession.h&quot;</span>
<a href="#l36.28"></a><span id="l36.28"> #endif</span>
<a href="#l36.29"></a><span id="l36.29"> </span>
<a href="#l36.30"></a><span id="l36.30" class="difflineplus">+</span>
<a href="#l36.31"></a><span id="l36.31"> #if defined(XP_WIN) &amp;&amp; !defined(__MINGW32__)</span>
<a href="#l36.32"></a><span id="l36.32"> #include &quot;nsAbOutlookDirFactory.h&quot;</span>
<a href="#l36.33"></a><span id="l36.33"> #include &quot;nsAbOutlookDirectory.h&quot;</span>
<a href="#l36.34"></a><span id="l36.34"> #endif</span>
<a href="#l36.35"></a><span id="l36.35"> </span>
<a href="#l36.36"></a><span id="l36.36"> #ifdef XP_MACOSX</span>
<a href="#l36.37"></a><span id="l36.37"> #include &quot;nsAbOSXDirectory.h&quot;</span>
<a href="#l36.38"></a><span id="l36.38"> #include &quot;nsAbOSXCard.h&quot;</span>
<a href="#l36.39"></a><span id="l36.39" class="difflineat">@@ -459,17 +459,16 @@ NS_DEFINE_NAMED_CID(MAILDIRPROVIDER_CID)</span>
<a href="#l36.40"></a><span id="l36.40"> NS_DEFINE_NAMED_CID(NS_STOPWATCH_CID);</span>
<a href="#l36.41"></a><span id="l36.41"> NS_DEFINE_NAMED_CID(NS_MAILNEWSDLF_CID);</span>
<a href="#l36.42"></a><span id="l36.42"> </span>
<a href="#l36.43"></a><span id="l36.43"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l36.44"></a><span id="l36.44"> // addrbook factories</span>
<a href="#l36.45"></a><span id="l36.45"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l36.46"></a><span id="l36.46"> NS_GENERIC_FACTORY_CONSTRUCTOR_INIT(nsAbManager,Init)</span>
<a href="#l36.47"></a><span id="l36.47"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbContentHandler)</span>
<a href="#l36.48"></a><span id="l36.48" class="difflineminus">-NS_GENERIC_FACTORY_CONSTRUCTOR_INIT(nsAbDirectoryDataSource,Init)</span>
<a href="#l36.49"></a><span id="l36.49"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbDirProperty)</span>
<a href="#l36.50"></a><span id="l36.50"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbCardProperty)</span>
<a href="#l36.51"></a><span id="l36.51"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbBSDirectory)</span>
<a href="#l36.52"></a><span id="l36.52"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbMDBDirectory)</span>
<a href="#l36.53"></a><span id="l36.53"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbMDBCard)</span>
<a href="#l36.54"></a><span id="l36.54"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAddrDatabase)</span>
<a href="#l36.55"></a><span id="l36.55"> NS_GENERIC_FACTORY_CONSTRUCTOR_INIT(nsAbAddressCollector,Init)</span>
<a href="#l36.56"></a><span id="l36.56"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAddbookUrl)</span>
<a href="#l36.57"></a><span id="l36.57" class="difflineat">@@ -481,45 +480,46 @@ NS_GENERIC_FACTORY_CONSTRUCTOR(nsAddbook</span>
<a href="#l36.58"></a><span id="l36.58"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbOutlookDirectory)</span>
<a href="#l36.59"></a><span id="l36.59"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbOutlookDirFactory)</span>
<a href="#l36.60"></a><span id="l36.60"> #endif</span>
<a href="#l36.61"></a><span id="l36.61"> </span>
<a href="#l36.62"></a><span id="l36.62"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbDirectoryQueryArguments)</span>
<a href="#l36.63"></a><span id="l36.63"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbBooleanConditionString)</span>
<a href="#l36.64"></a><span id="l36.64"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbBooleanExpression)</span>
<a href="#l36.65"></a><span id="l36.65"> </span>
<a href="#l36.66"></a><span id="l36.66" class="difflineplus">+</span>
<a href="#l36.67"></a><span id="l36.67"> #if defined(MOZ_LDAP_XPCOM)</span>
<a href="#l36.68"></a><span id="l36.68"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbLDAPDirectory)</span>
<a href="#l36.69"></a><span id="l36.69"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbLDAPDirectoryQuery)</span>
<a href="#l36.70"></a><span id="l36.70"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbLDAPCard)</span>
<a href="#l36.71"></a><span id="l36.71"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbLDAPDirFactory)</span>
<a href="#l36.72"></a><span id="l36.72"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbLDAPAutoCompFormatter)</span>
<a href="#l36.73"></a><span id="l36.73"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbLDAPReplicationService)</span>
<a href="#l36.74"></a><span id="l36.74"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbLDAPReplicationQuery)</span>
<a href="#l36.75"></a><span id="l36.75"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbLDAPProcessReplicationData)</span>
<a href="#l36.76"></a><span id="l36.76"> // XXX These files are not being built as they don't work. Bug 311632 should</span>
<a href="#l36.77"></a><span id="l36.77"> // fix them.</span>
<a href="#l36.78"></a><span id="l36.78"> //NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbLDAPChangeLogQuery)</span>
<a href="#l36.79"></a><span id="l36.79"> //NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbLDAPProcessChangeLogData)</span>
<a href="#l36.80"></a><span id="l36.80"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsLDAPAutoCompleteSession)</span>
<a href="#l36.81"></a><span id="l36.81"> #endif</span>
<a href="#l36.82"></a><span id="l36.82"> </span>
<a href="#l36.83"></a><span id="l36.83" class="difflineplus">+</span>
<a href="#l36.84"></a><span id="l36.84"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbDirectoryQueryProxy)</span>
<a href="#l36.85"></a><span id="l36.85"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbView)</span>
<a href="#l36.86"></a><span id="l36.86"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsMsgVCardService)</span>
<a href="#l36.87"></a><span id="l36.87"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbLDIFService)</span>
<a href="#l36.88"></a><span id="l36.88"> </span>
<a href="#l36.89"></a><span id="l36.89"> #ifdef XP_MACOSX</span>
<a href="#l36.90"></a><span id="l36.90"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbOSXDirectory)</span>
<a href="#l36.91"></a><span id="l36.91"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbOSXCard)</span>
<a href="#l36.92"></a><span id="l36.92"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbOSXDirFactory)</span>
<a href="#l36.93"></a><span id="l36.93"> #endif</span>
<a href="#l36.94"></a><span id="l36.94"> </span>
<a href="#l36.95"></a><span id="l36.95"> NS_DEFINE_NAMED_CID(NS_ABMANAGER_CID);</span>
<a href="#l36.96"></a><span id="l36.96" class="difflineminus">-NS_DEFINE_NAMED_CID(NS_ABDIRECTORYDATASOURCE_CID);</span>
<a href="#l36.97"></a><span id="l36.97"> NS_DEFINE_NAMED_CID(NS_ABDIRECTORY_CID);</span>
<a href="#l36.98"></a><span id="l36.98"> NS_DEFINE_NAMED_CID(NS_ABMDBDIRECTORY_CID);</span>
<a href="#l36.99"></a><span id="l36.99"> NS_DEFINE_NAMED_CID(NS_ABMDBCARD_CID);</span>
<a href="#l36.100"></a><span id="l36.100"> NS_DEFINE_NAMED_CID(NS_ADDRDATABASE_CID);</span>
<a href="#l36.101"></a><span id="l36.101"> NS_DEFINE_NAMED_CID(NS_ABCARDPROPERTY_CID);</span>
<a href="#l36.102"></a><span id="l36.102"> NS_DEFINE_NAMED_CID(NS_ABDIRPROPERTY_CID);</span>
<a href="#l36.103"></a><span id="l36.103"> NS_DEFINE_NAMED_CID(NS_ABADDRESSCOLLECTOR_CID);</span>
<a href="#l36.104"></a><span id="l36.104"> NS_DEFINE_NAMED_CID(NS_ADDBOOKURL_CID);</span>
<a href="#l36.105"></a><span id="l36.105" class="difflineat">@@ -529,16 +529,17 @@ NS_DEFINE_NAMED_CID(NS_ABDIRFACTORYSERVI</span>
<a href="#l36.106"></a><span id="l36.106"> NS_DEFINE_NAMED_CID(NS_ABMDBDIRFACTORY_CID);</span>
<a href="#l36.107"></a><span id="l36.107"> NS_DEFINE_NAMED_CID(NS_ABDIRECTORYQUERYARGUMENTS_CID);</span>
<a href="#l36.108"></a><span id="l36.108"> NS_DEFINE_NAMED_CID(NS_BOOLEANCONDITIONSTRING_CID);</span>
<a href="#l36.109"></a><span id="l36.109"> NS_DEFINE_NAMED_CID(NS_BOOLEANEXPRESSION_CID);</span>
<a href="#l36.110"></a><span id="l36.110"> #if defined(XP_WIN) &amp;&amp; !defined(__MINGW32__)</span>
<a href="#l36.111"></a><span id="l36.111"> NS_DEFINE_NAMED_CID(NS_ABOUTLOOKDIRECTORY_CID);</span>
<a href="#l36.112"></a><span id="l36.112"> NS_DEFINE_NAMED_CID(NS_ABOUTLOOKDIRFACTORY_CID);</span>
<a href="#l36.113"></a><span id="l36.113"> #endif</span>
<a href="#l36.114"></a><span id="l36.114" class="difflineplus">+</span>
<a href="#l36.115"></a><span id="l36.115"> #if defined(MOZ_LDAP_XPCOM)</span>
<a href="#l36.116"></a><span id="l36.116"> NS_DEFINE_NAMED_CID(NS_ABLDAPDIRECTORY_CID);</span>
<a href="#l36.117"></a><span id="l36.117"> NS_DEFINE_NAMED_CID(NS_ABLDAPDIRECTORYQUERY_CID);</span>
<a href="#l36.118"></a><span id="l36.118"> NS_DEFINE_NAMED_CID(NS_ABLDAPCARD_CID);</span>
<a href="#l36.119"></a><span id="l36.119"> NS_DEFINE_NAMED_CID(NS_ABLDAPDIRFACTORY_CID);</span>
<a href="#l36.120"></a><span id="l36.120"> NS_DEFINE_NAMED_CID(NS_ABLDAP_REPLICATIONSERVICE_CID);</span>
<a href="#l36.121"></a><span id="l36.121"> NS_DEFINE_NAMED_CID(NS_ABLDAP_REPLICATIONQUERY_CID);</span>
<a href="#l36.122"></a><span id="l36.122"> NS_DEFINE_NAMED_CID(NS_ABLDAP_PROCESSREPLICATIONDATA_CID);</span>
<a href="#l36.123"></a><span id="l36.123" class="difflineat">@@ -853,17 +854,16 @@ const mozilla::Module::CIDEntry kMailNew</span>
<a href="#l36.124"></a><span id="l36.124">   { &amp;kNS_MESSENGERCONTENTHANDLER_CID, false, NULL, nsMessengerContentHandlerConstructor},</span>
<a href="#l36.125"></a><span id="l36.125">   { &amp;kNS_MSGCONTENTPOLICY_CID, false, NULL, nsMsgContentPolicyConstructor},</span>
<a href="#l36.126"></a><span id="l36.126">   { &amp;kNS_MSGSHUTDOWNSERVICE_CID, false, NULL, nsMsgShutdownServiceConstructor},</span>
<a href="#l36.127"></a><span id="l36.127">   { &amp;kMAILDIRPROVIDER_CID, false, NULL, nsMailDirProviderConstructor},</span>
<a href="#l36.128"></a><span id="l36.128">   { &amp;kNS_STOPWATCH_CID, false, NULL, nsStopwatchConstructor},</span>
<a href="#l36.129"></a><span id="l36.129">   { &amp;kNS_MAILNEWSDLF_CID, false, NULL, MailNewsDLFConstructor},</span>
<a href="#l36.130"></a><span id="l36.130">   // Address Book Entries</span>
<a href="#l36.131"></a><span id="l36.131">   { &amp;kNS_ABMANAGER_CID, false, NULL, nsAbManagerConstructor },</span>
<a href="#l36.132"></a><span id="l36.132" class="difflineminus">-  { &amp;kNS_ABDIRECTORYDATASOURCE_CID, false, NULL, nsAbDirectoryDataSourceConstructor },</span>
<a href="#l36.133"></a><span id="l36.133">   { &amp;kNS_ABDIRECTORY_CID, false, NULL, nsAbBSDirectoryConstructor },</span>
<a href="#l36.134"></a><span id="l36.134">   { &amp;kNS_ABMDBDIRECTORY_CID, false, NULL, nsAbMDBDirectoryConstructor },</span>
<a href="#l36.135"></a><span id="l36.135">   { &amp;kNS_ABMDBCARD_CID, false, NULL, nsAbMDBCardConstructor },</span>
<a href="#l36.136"></a><span id="l36.136">   { &amp;kNS_ADDRDATABASE_CID, false, NULL, nsAddrDatabaseConstructor },</span>
<a href="#l36.137"></a><span id="l36.137">   { &amp;kNS_ABCARDPROPERTY_CID, false, NULL, nsAbCardPropertyConstructor },</span>
<a href="#l36.138"></a><span id="l36.138">   { &amp;kNS_ABDIRPROPERTY_CID, false, NULL, nsAbDirPropertyConstructor },</span>
<a href="#l36.139"></a><span id="l36.139">   { &amp;kNS_ABADDRESSCOLLECTOR_CID, false, NULL, nsAbAddressCollectorConstructor },</span>
<a href="#l36.140"></a><span id="l36.140">   { &amp;kNS_ADDBOOKURL_CID, false, NULL, nsAddbookUrlConstructor },</span>
<a href="#l36.141"></a><span id="l36.141" class="difflineat">@@ -874,16 +874,17 @@ const mozilla::Module::CIDEntry kMailNew</span>
<a href="#l36.142"></a><span id="l36.142">   { &amp;kNS_ABMDBDIRFACTORY_CID, false, NULL, nsAbMDBDirFactoryConstructor },</span>
<a href="#l36.143"></a><span id="l36.143"> #if defined(XP_WIN) &amp;&amp; !defined(__MINGW32__)</span>
<a href="#l36.144"></a><span id="l36.144">   { &amp;kNS_ABOUTLOOKDIRECTORY_CID, false, NULL, nsAbOutlookDirectoryConstructor },</span>
<a href="#l36.145"></a><span id="l36.145">   { &amp;kNS_ABOUTLOOKDIRFACTORY_CID, false, NULL, nsAbOutlookDirFactoryConstructor },</span>
<a href="#l36.146"></a><span id="l36.146"> #endif</span>
<a href="#l36.147"></a><span id="l36.147">   { &amp;kNS_ABDIRECTORYQUERYARGUMENTS_CID, false, NULL, nsAbDirectoryQueryArgumentsConstructor },</span>
<a href="#l36.148"></a><span id="l36.148">   { &amp;kNS_BOOLEANCONDITIONSTRING_CID, false, NULL, nsAbBooleanConditionStringConstructor },</span>
<a href="#l36.149"></a><span id="l36.149">   { &amp;kNS_BOOLEANEXPRESSION_CID, false, NULL, nsAbBooleanExpressionConstructor },</span>
<a href="#l36.150"></a><span id="l36.150" class="difflineplus">+</span>
<a href="#l36.151"></a><span id="l36.151"> #if defined(MOZ_LDAP_XPCOM)</span>
<a href="#l36.152"></a><span id="l36.152">   { &amp;kNS_ABLDAPDIRECTORY_CID, false, NULL, nsAbLDAPDirectoryConstructor },</span>
<a href="#l36.153"></a><span id="l36.153">   { &amp;kNS_ABLDAPDIRECTORYQUERY_CID, false, NULL, nsAbLDAPDirectoryQueryConstructor },</span>
<a href="#l36.154"></a><span id="l36.154">   { &amp;kNS_ABLDAPCARD_CID, false, NULL, nsAbLDAPCardConstructor },</span>
<a href="#l36.155"></a><span id="l36.155">   { &amp;kNS_ABLDAP_REPLICATIONSERVICE_CID, false, NULL, nsAbLDAPReplicationServiceConstructor },</span>
<a href="#l36.156"></a><span id="l36.156">   { &amp;kNS_ABLDAP_REPLICATIONQUERY_CID, false, NULL, nsAbLDAPReplicationQueryConstructor },</span>
<a href="#l36.157"></a><span id="l36.157">   { &amp;kNS_ABLDAP_PROCESSREPLICATIONDATA_CID, false, NULL, nsAbLDAPProcessReplicationDataConstructor },</span>
<a href="#l36.158"></a><span id="l36.158">   { &amp;kNS_ABLDAPDIRFACTORY_CID, false, NULL, nsAbLDAPDirFactoryConstructor },</span>
<a href="#l36.159"></a><span id="l36.159" class="difflineat">@@ -1050,17 +1051,16 @@ const mozilla::Module::ContractIDEntry k</span>
<a href="#l36.160"></a><span id="l36.160">   { NS_MSGCONTENTPOLICY_CONTRACTID, &amp;kNS_MSGCONTENTPOLICY_CID },</span>
<a href="#l36.161"></a><span id="l36.161">   { NS_MSGSHUTDOWNSERVICE_CONTRACTID, &amp;kNS_MSGSHUTDOWNSERVICE_CID },</span>
<a href="#l36.162"></a><span id="l36.162">   { NS_MAILDIRPROVIDER_CONTRACTID, &amp;kMAILDIRPROVIDER_CID },</span>
<a href="#l36.163"></a><span id="l36.163">   { NS_STOPWATCH_CONTRACTID, &amp;kNS_STOPWATCH_CID },</span>
<a href="#l36.164"></a><span id="l36.164">   { NS_MAILNEWSDLF_CONTRACTID, &amp;kNS_MAILNEWSDLF_CID },</span>
<a href="#l36.165"></a><span id="l36.165">   // Address Book Entries</span>
<a href="#l36.166"></a><span id="l36.166">   { NS_ABMANAGER_CONTRACTID, &amp;kNS_ABMANAGER_CID },</span>
<a href="#l36.167"></a><span id="l36.167">   { NS_ABMANAGERSTARTUPHANDLER_CONTRACTID, &amp;kNS_ABMANAGER_CID },</span>
<a href="#l36.168"></a><span id="l36.168" class="difflineminus">-  { NS_ABDIRECTORYDATASOURCE_CONTRACTID, &amp;kNS_ABDIRECTORYDATASOURCE_CID },</span>
<a href="#l36.169"></a><span id="l36.169">   { NS_ABDIRECTORY_CONTRACTID, &amp;kNS_ABDIRECTORY_CID },</span>
<a href="#l36.170"></a><span id="l36.170">   { NS_ABMDBDIRECTORY_CONTRACTID, &amp;kNS_ABMDBDIRECTORY_CID },</span>
<a href="#l36.171"></a><span id="l36.171">   { NS_ABMDBCARD_CONTRACTID, &amp;kNS_ABMDBCARD_CID },</span>
<a href="#l36.172"></a><span id="l36.172">   { NS_ADDRDATABASE_CONTRACTID, &amp;kNS_ADDRDATABASE_CID },</span>
<a href="#l36.173"></a><span id="l36.173">   { NS_ABCARDPROPERTY_CONTRACTID, &amp;kNS_ABCARDPROPERTY_CID },</span>
<a href="#l36.174"></a><span id="l36.174">   { NS_ABDIRPROPERTY_CONTRACTID, &amp;kNS_ABDIRPROPERTY_CID },</span>
<a href="#l36.175"></a><span id="l36.175">   { NS_ABADDRESSCOLLECTOR_CONTRACTID, &amp;kNS_ABADDRESSCOLLECTOR_CID },</span>
<a href="#l36.176"></a><span id="l36.176">   { NS_ADDBOOKURL_CONTRACTID, &amp;kNS_ADDBOOKURL_CID },</span>
<a href="#l36.177"></a><span id="l36.177" class="difflineat">@@ -1071,29 +1071,31 @@ const mozilla::Module::ContractIDEntry k</span>
<a href="#l36.178"></a><span id="l36.178">   { NS_ABMDBDIRFACTORY_CONTRACTID, &amp;kNS_ABMDBDIRFACTORY_CID },</span>
<a href="#l36.179"></a><span id="l36.179"> #if defined(XP_WIN) &amp;&amp; !defined(__MINGW32__)</span>
<a href="#l36.180"></a><span id="l36.180">   { NS_ABOUTLOOKDIRECTORY_CONTRACTID, &amp;kNS_ABOUTLOOKDIRECTORY_CID },</span>
<a href="#l36.181"></a><span id="l36.181">   { NS_ABOUTLOOKDIRFACTORY_CONTRACTID, &amp;kNS_ABOUTLOOKDIRFACTORY_CID },</span>
<a href="#l36.182"></a><span id="l36.182"> #endif</span>
<a href="#l36.183"></a><span id="l36.183">   { NS_ABDIRECTORYQUERYARGUMENTS_CONTRACTID, &amp;kNS_ABDIRECTORYQUERYARGUMENTS_CID },</span>
<a href="#l36.184"></a><span id="l36.184">   { NS_BOOLEANCONDITIONSTRING_CONTRACTID, &amp;kNS_BOOLEANCONDITIONSTRING_CID },</span>
<a href="#l36.185"></a><span id="l36.185">   { NS_BOOLEANEXPRESSION_CONTRACTID, &amp;kNS_BOOLEANEXPRESSION_CID },</span>
<a href="#l36.186"></a><span id="l36.186" class="difflineplus">+</span>
<a href="#l36.187"></a><span id="l36.187"> #if defined(MOZ_LDAP_XPCOM)</span>
<a href="#l36.188"></a><span id="l36.188">   { NS_ABLDAPDIRECTORY_CONTRACTID, &amp;kNS_ABLDAPDIRECTORY_CID },</span>
<a href="#l36.189"></a><span id="l36.189">   { NS_ABLDAPDIRECTORYQUERY_CONTRACTID, &amp;kNS_ABLDAPDIRECTORYQUERY_CID },</span>
<a href="#l36.190"></a><span id="l36.190">   { NS_ABLDAPCARD_CONTRACTID, &amp;kNS_ABLDAPCARD_CID },</span>
<a href="#l36.191"></a><span id="l36.191">   { NS_ABLDAPDIRFACTORY_CONTRACTID, &amp;kNS_ABLDAPDIRFACTORY_CID },</span>
<a href="#l36.192"></a><span id="l36.192">   { NS_ABLDAP_REPLICATIONSERVICE_CONTRACTID, &amp;kNS_ABLDAP_REPLICATIONSERVICE_CID },</span>
<a href="#l36.193"></a><span id="l36.193">   { NS_ABLDAP_REPLICATIONQUERY_CONTRACTID, &amp;kNS_ABLDAP_REPLICATIONQUERY_CID },</span>
<a href="#l36.194"></a><span id="l36.194">   { NS_ABLDAP_PROCESSREPLICATIONDATA_CONTRACTID, &amp;kNS_ABLDAP_PROCESSREPLICATIONDATA_CID },</span>
<a href="#l36.195"></a><span id="l36.195">   { NS_ABLDAPACDIRFACTORY_CONTRACTID, &amp;kNS_ABLDAPDIRFACTORY_CID },</span>
<a href="#l36.196"></a><span id="l36.196">   { NS_ABLDAPSACDIRFACTORY_CONTRACTID, &amp;kNS_ABLDAPDIRFACTORY_CID },</span>
<a href="#l36.197"></a><span id="l36.197">   { NS_ABLDAPAUTOCOMPFORMATTER_CONTRACTID, &amp;kNS_ABLDAPAUTOCOMPFORMATTER_CID },</span>
<a href="#l36.198"></a><span id="l36.198">   { &quot;@mozilla.org/autocompleteSession;1?type=ldap&quot;, &amp;kNS_LDAPAUTOCOMPLETESESSION_CID },</span>
<a href="#l36.199"></a><span id="l36.199"> #endif</span>
<a href="#l36.200"></a><span id="l36.200" class="difflineplus">+</span>
<a href="#l36.201"></a><span id="l36.201">   { NS_ABDIRECTORYQUERYPROXY_CONTRACTID, &amp;kNS_ABDIRECTORYQUERYPROXY_CID },</span>
<a href="#l36.202"></a><span id="l36.202"> #ifdef XP_MACOSX</span>
<a href="#l36.203"></a><span id="l36.203">   { NS_ABOSXDIRECTORY_CONTRACTID, &amp;kNS_ABOSXDIRECTORY_CID },</span>
<a href="#l36.204"></a><span id="l36.204">   { NS_ABOSXCARD_CONTRACTID, &amp;kNS_ABOSXCARD_CID },</span>
<a href="#l36.205"></a><span id="l36.205">   { NS_ABOSXDIRFACTORY_CONTRACTID, &amp;kNS_ABOSXDIRFACTORY_CID },</span>
<a href="#l36.206"></a><span id="l36.206"> #endif</span>
<a href="#l36.207"></a><span id="l36.207">   { NS_ABVIEW_CONTRACTID, &amp;kNS_ABVIEW_CID },</span>
<a href="#l36.208"></a><span id="l36.208">   { NS_MSGVCARDSERVICE_CONTRACTID, &amp;kNS_MSGVCARDSERVICE_CID },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l37.1"></a><span id="l37.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgCompose.cpp</span>
<a href="#l37.2"></a><span id="l37.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgCompose.cpp</span>
<a href="#l37.3"></a><span id="l37.3" class="difflineat">@@ -108,16 +108,17 @@</span>
<a href="#l37.4"></a><span id="l37.4"> #include &quot;nsIMsgProgress.h&quot;</span>
<a href="#l37.5"></a><span id="l37.5"> #include &quot;nsMsgFolderFlags.h&quot;</span>
<a href="#l37.6"></a><span id="l37.6"> #include &quot;nsIMsgDatabase.h&quot;</span>
<a href="#l37.7"></a><span id="l37.7"> #include &quot;nsStringStream.h&quot;</span>
<a href="#l37.8"></a><span id="l37.8"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l37.9"></a><span id="l37.9"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l37.10"></a><span id="l37.10"> #include &quot;nsIMsgWindow.h&quot;</span>
<a href="#l37.11"></a><span id="l37.11"> #include &quot;nsITextToSubURI.h&quot;</span>
<a href="#l37.12"></a><span id="l37.12" class="difflineplus">+#include &quot;nsIAbManager.h&quot;</span>
<a href="#l37.13"></a><span id="l37.13"> </span>
<a href="#l37.14"></a><span id="l37.14"> static void GetReplyHeaderInfo(PRInt32* reply_header_type,</span>
<a href="#l37.15"></a><span id="l37.15">                                nsString&amp; reply_header_locale,</span>
<a href="#l37.16"></a><span id="l37.16">                                nsString&amp; reply_header_authorwrote,</span>
<a href="#l37.17"></a><span id="l37.17">                                nsString&amp; reply_header_ondate,</span>
<a href="#l37.18"></a><span id="l37.18">                                nsString&amp; reply_header_separator,</span>
<a href="#l37.19"></a><span id="l37.19">                                nsString&amp; reply_header_colon,</span>
<a href="#l37.20"></a><span id="l37.20">                                nsString&amp; reply_header_originalmessage)</span>
<a href="#l37.21"></a><span id="l37.21" class="difflineat">@@ -4466,30 +4467,28 @@ nsresult nsMsgCompose::AttachmentPrettyN</span>
<a href="#l37.22"></a><span id="l37.22">   }</span>
<a href="#l37.23"></a><span id="l37.23">   if (MsgLowerCaseEqualsLiteral(StringHead(scheme, 5), &quot;http:&quot;))</span>
<a href="#l37.24"></a><span id="l37.24">     _retval.Cut(0, 7);</span>
<a href="#l37.25"></a><span id="l37.25"> </span>
<a href="#l37.26"></a><span id="l37.26">   return NS_OK;</span>
<a href="#l37.27"></a><span id="l37.27"> }</span>
<a href="#l37.28"></a><span id="l37.28"> </span>
<a href="#l37.29"></a><span id="l37.29"> nsresult nsMsgCompose::GetABDirectories(const nsACString&amp; aDirUri,</span>
<a href="#l37.30"></a><span id="l37.30" class="difflineminus">-                                        nsIRDFService *aRDFService,</span>
<a href="#l37.31"></a><span id="l37.31">                                         nsCOMArray&lt;nsIAbDirectory&gt; &amp;aDirArray)</span>
<a href="#l37.32"></a><span id="l37.32"> {</span>
<a href="#l37.33"></a><span id="l37.33">   static PRBool collectedAddressbookFound;</span>
<a href="#l37.34"></a><span id="l37.34">   if (aDirUri.EqualsLiteral(kMDBDirectoryRoot))</span>
<a href="#l37.35"></a><span id="l37.35">     collectedAddressbookFound = PR_FALSE;</span>
<a href="#l37.36"></a><span id="l37.36"> </span>
<a href="#l37.37"></a><span id="l37.37">   nsresult rv;</span>
<a href="#l37.38"></a><span id="l37.38" class="difflineminus">-  nsCOMPtr&lt;nsIRDFResource&gt; resource;</span>
<a href="#l37.39"></a><span id="l37.39" class="difflineminus">-  rv = aRDFService-&gt;GetResource(aDirUri, getter_AddRefs(resource));</span>
<a href="#l37.40"></a><span id="l37.40" class="difflineplus">+  nsCOMPtr&lt;nsIAbManager&gt; abManager = do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l37.41"></a><span id="l37.41">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l37.42"></a><span id="l37.42"> </span>
<a href="#l37.43"></a><span id="l37.43" class="difflineminus">-  // query interface</span>
<a href="#l37.44"></a><span id="l37.44" class="difflineminus">-  nsCOMPtr&lt;nsIAbDirectory&gt; directory(do_QueryInterface(resource, &amp;rv));</span>
<a href="#l37.45"></a><span id="l37.45" class="difflineplus">+  nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l37.46"></a><span id="l37.46" class="difflineplus">+  rv = abManager-&gt;GetDirectory(aDirUri, getter_AddRefs(directory));</span>
<a href="#l37.47"></a><span id="l37.47">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l37.48"></a><span id="l37.48"> </span>
<a href="#l37.49"></a><span id="l37.49">   nsCOMPtr&lt;nsISimpleEnumerator&gt; subDirectories;</span>
<a href="#l37.50"></a><span id="l37.50">   if (NS_SUCCEEDED(directory-&gt;GetChildNodes(getter_AddRefs(subDirectories))) &amp;&amp; subDirectories)</span>
<a href="#l37.51"></a><span id="l37.51">   {</span>
<a href="#l37.52"></a><span id="l37.52">     nsCOMPtr&lt;nsISupports&gt; item;</span>
<a href="#l37.53"></a><span id="l37.53">     PRBool hasMore;</span>
<a href="#l37.54"></a><span id="l37.54">     while (NS_SUCCEEDED(rv = subDirectories-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore)</span>
<a href="#l37.55"></a><span id="l37.55" class="difflineat">@@ -4525,17 +4524,17 @@ nsresult nsMsgCompose::GetABDirectories(</span>
<a href="#l37.56"></a><span id="l37.56">               if (collectedAddressbookFound &amp;&amp; count &gt; 1)</span>
<a href="#l37.57"></a><span id="l37.57">                 pos = count - 1;</span>
<a href="#l37.58"></a><span id="l37.58">               else</span>
<a href="#l37.59"></a><span id="l37.59">                 pos = count;</span>
<a href="#l37.60"></a><span id="l37.60">             }</span>
<a href="#l37.61"></a><span id="l37.61">           }</span>
<a href="#l37.62"></a><span id="l37.62"> </span>
<a href="#l37.63"></a><span id="l37.63">           aDirArray.InsertObjectAt(directory, pos);</span>
<a href="#l37.64"></a><span id="l37.64" class="difflineminus">-          rv = GetABDirectories(uri, aRDFService, aDirArray);</span>
<a href="#l37.65"></a><span id="l37.65" class="difflineplus">+          rv = GetABDirectories(uri, aDirArray);</span>
<a href="#l37.66"></a><span id="l37.66">         }</span>
<a href="#l37.67"></a><span id="l37.67">       }</span>
<a href="#l37.68"></a><span id="l37.68">     }</span>
<a href="#l37.69"></a><span id="l37.69">   }</span>
<a href="#l37.70"></a><span id="l37.70">   return rv;</span>
<a href="#l37.71"></a><span id="l37.71"> }</span>
<a href="#l37.72"></a><span id="l37.72"> </span>
<a href="#l37.73"></a><span id="l37.73"> nsresult nsMsgCompose::BuildMailListArray(nsIAbDirectory* parentDir,</span>
<a href="#l37.74"></a><span id="l37.74" class="difflineat">@@ -4661,21 +4660,18 @@ nsMsgCompose::CheckAndPopulateRecipients</span>
<a href="#l37.75"></a><span id="l37.75">   PRBool stillNeedToSearch = PR_TRUE;</span>
<a href="#l37.76"></a><span id="l37.76">   nsCOMPtr&lt;nsIAbDirectory&gt; abDirectory;</span>
<a href="#l37.77"></a><span id="l37.77">   nsCOMPtr&lt;nsIAbCard&gt; existingCard;</span>
<a href="#l37.78"></a><span id="l37.78">   nsCOMPtr&lt;nsIMutableArray&gt; mailListAddresses;</span>
<a href="#l37.79"></a><span id="l37.79">   nsCOMPtr&lt;nsIMsgHeaderParser&gt; parser(do_GetService(NS_MAILNEWS_MIME_HEADER_PARSER_CONTRACTID));</span>
<a href="#l37.80"></a><span id="l37.80">   nsCOMPtr&lt;nsISupportsArray&gt; mailListArray(do_CreateInstance(NS_SUPPORTSARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l37.81"></a><span id="l37.81">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l37.82"></a><span id="l37.82"> </span>
<a href="#l37.83"></a><span id="l37.83" class="difflineminus">-  nsCOMPtr&lt;nsIRDFService&gt; rdfService(do_GetService(&quot;@mozilla.org/rdf/rdf-service;1&quot;, &amp;rv));</span>
<a href="#l37.84"></a><span id="l37.84" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l37.85"></a><span id="l37.85" class="difflineminus">-</span>
<a href="#l37.86"></a><span id="l37.86">   nsCOMArray&lt;nsIAbDirectory&gt; addrbookDirArray;</span>
<a href="#l37.87"></a><span id="l37.87" class="difflineminus">-  rv = GetABDirectories(NS_LITERAL_CSTRING(kAllDirectoryRoot), rdfService,</span>
<a href="#l37.88"></a><span id="l37.88" class="difflineplus">+  rv = GetABDirectories(NS_LITERAL_CSTRING(kAllDirectoryRoot),</span>
<a href="#l37.89"></a><span id="l37.89">                         addrbookDirArray);</span>
<a href="#l37.90"></a><span id="l37.90">   if (NS_SUCCEEDED(rv))</span>
<a href="#l37.91"></a><span id="l37.91">   {</span>
<a href="#l37.92"></a><span id="l37.92">     nsString dirPath;</span>
<a href="#l37.93"></a><span id="l37.93">     PRUint32 nbrAddressbook = addrbookDirArray.Count();</span>
<a href="#l37.94"></a><span id="l37.94"> </span>
<a href="#l37.95"></a><span id="l37.95">     for (k = 0; k &lt; nbrAddressbook &amp;&amp; stillNeedToSearch; ++k)</span>
<a href="#l37.96"></a><span id="l37.96">     {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l38.1"></a><span id="l38.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgCompose.h</span>
<a href="#l38.2"></a><span id="l38.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgCompose.h</span>
<a href="#l38.3"></a><span id="l38.3" class="difflineat">@@ -104,17 +104,16 @@ private:</span>
<a href="#l38.4"></a><span id="l38.4">   //m_folderName to store the value of the saved drafts folder.</span>
<a href="#l38.5"></a><span id="l38.5">   nsCString                     m_folderName;</span>
<a href="#l38.6"></a><span id="l38.6"> </span>
<a href="#l38.7"></a><span id="l38.7">  private:</span>
<a href="#l38.8"></a><span id="l38.8">   nsresult _SendMsg(MSG_DeliverMode deliverMode, nsIMsgIdentity *identity, const char *accountKey, PRBool entityConversionDone);</span>
<a href="#l38.9"></a><span id="l38.9">   nsresult CreateMessage(const char * originalMsgURI, MSG_ComposeType type, nsIMsgCompFields* compFields);</span>
<a href="#l38.10"></a><span id="l38.10">   void CleanUpRecipients(nsString&amp; recipients);</span>
<a href="#l38.11"></a><span id="l38.11">   nsresult GetABDirectories(const nsACString&amp; aDirUri,</span>
<a href="#l38.12"></a><span id="l38.12" class="difflineminus">-                            nsIRDFService *aRDFService,</span>
<a href="#l38.13"></a><span id="l38.13">                             nsCOMArray&lt;nsIAbDirectory&gt; &amp;aDirArray);</span>
<a href="#l38.14"></a><span id="l38.14">   nsresult BuildMailListArray(nsIAbDirectory* parentDir,</span>
<a href="#l38.15"></a><span id="l38.15">                               nsISupportsArray* array);</span>
<a href="#l38.16"></a><span id="l38.16">   nsresult GetMailListAddresses(nsString&amp; name, nsISupportsArray* mailListArray, nsIMutableArray** addresses);</span>
<a href="#l38.17"></a><span id="l38.17">   nsresult TagConvertible(nsIDOMNode *node,  PRInt32 *_retval);</span>
<a href="#l38.18"></a><span id="l38.18">   nsresult _BodyConvertible(nsIDOMNode *node, PRInt32 *_retval);</span>
<a href="#l38.19"></a><span id="l38.19"> </span>
<a href="#l38.20"></a><span id="l38.20">   PRBool IsLastWindow();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l39.1"></a><span id="l39.1" class="difflineminus">--- a/mailnews/import/src/nsImportAddressBooks.cpp</span>
<a href="#l39.2"></a><span id="l39.2" class="difflineplus">+++ b/mailnews/import/src/nsImportAddressBooks.cpp</span>
<a href="#l39.3"></a><span id="l39.3" class="difflineat">@@ -44,31 +44,31 @@</span>
<a href="#l39.4"></a><span id="l39.4"> #include &quot;nsISupportsPrimitives.h&quot;</span>
<a href="#l39.5"></a><span id="l39.5"> #include &quot;nsIImportABDescriptor.h&quot;</span>
<a href="#l39.6"></a><span id="l39.6"> #include &quot;nsIImportFieldMap.h&quot;</span>
<a href="#l39.7"></a><span id="l39.7"> #include &quot;nsStringGlue.h&quot;</span>
<a href="#l39.8"></a><span id="l39.8"> #include &quot;nsILocalFile.h&quot;</span>
<a href="#l39.9"></a><span id="l39.9"> #include &quot;nsIAddrDatabase.h&quot;</span>
<a href="#l39.10"></a><span id="l39.10"> #include &quot;nsIAbManager.h&quot;</span>
<a href="#l39.11"></a><span id="l39.11"> #include &quot;nsIAbLDIFService.h&quot;</span>
<a href="#l39.12"></a><span id="l39.12" class="difflineminus">-#include &quot;nsIRDFService.h&quot;</span>
<a href="#l39.13"></a><span id="l39.13" class="difflineminus">-#include &quot;nsRDFCID.h&quot;</span>
<a href="#l39.14"></a><span id="l39.14"> #include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l39.15"></a><span id="l39.15"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l39.16"></a><span id="l39.16"> #include &quot;nsImportStringBundle.h&quot;</span>
<a href="#l39.17"></a><span id="l39.17"> #include &quot;nsTextFormatter.h&quot;</span>
<a href="#l39.18"></a><span id="l39.18"> #include &quot;nsIProxyObjectManager.h&quot;</span>
<a href="#l39.19"></a><span id="l39.19"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l39.20"></a><span id="l39.20"> #include &quot;msgCore.h&quot;</span>
<a href="#l39.21"></a><span id="l39.21"> #include &quot;ImportDebug.h&quot;</span>
<a href="#l39.22"></a><span id="l39.22"> #include &quot;nsIAbMDBDirectory.h&quot;</span>
<a href="#l39.23"></a><span id="l39.23"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l39.24"></a><span id="l39.24"> #include &quot;nsXPCOMCIDInternal.h&quot;</span>
<a href="#l39.25"></a><span id="l39.25" class="difflineplus">+#include &quot;nsISupportsArray.h&quot;</span>
<a href="#l39.26"></a><span id="l39.26" class="difflineplus">+#include &quot;nsProxiedService.h&quot;</span>
<a href="#l39.27"></a><span id="l39.27" class="difflineplus">+#include &quot;nsCOMArray.h&quot;</span>
<a href="#l39.28"></a><span id="l39.28"> </span>
<a href="#l39.29"></a><span id="l39.29" class="difflineminus">-static NS_DEFINE_CID(kRDFServiceCID, NS_RDFSERVICE_CID);</span>
<a href="#l39.30"></a><span id="l39.30"> static void ImportAddressThread( void *stuff);</span>
<a href="#l39.31"></a><span id="l39.31"> </span>
<a href="#l39.32"></a><span id="l39.32"> </span>
<a href="#l39.33"></a><span id="l39.33"> class AddressThreadData;</span>
<a href="#l39.34"></a><span id="l39.34"> </span>
<a href="#l39.35"></a><span id="l39.35"> class nsImportGenericAddressBooks : public nsIImportGeneric</span>
<a href="#l39.36"></a><span id="l39.36"> {</span>
<a href="#l39.37"></a><span id="l39.37"> public:</span>
<a href="#l39.38"></a><span id="l39.38" class="difflineat">@@ -102,17 +102,18 @@ private:</span>
<a href="#l39.39"></a><span id="l39.39"> </span>
<a href="#l39.40"></a><span id="l39.40"> public:</span>
<a href="#l39.41"></a><span id="l39.41">   static void  SetLogs( nsString&amp; success, nsString&amp; error, nsISupportsString *pSuccess, nsISupportsString *pError);</span>
<a href="#l39.42"></a><span id="l39.42">   static void ReportError(const PRUnichar *pName, nsString *pStream,</span>
<a href="#l39.43"></a><span id="l39.43">                           nsIStringBundle *aBundle);</span>
<a href="#l39.44"></a><span id="l39.44"> </span>
<a href="#l39.45"></a><span id="l39.45"> private:</span>
<a href="#l39.46"></a><span id="l39.46">   nsIImportAddressBooks *    m_pInterface;</span>
<a href="#l39.47"></a><span id="l39.47" class="difflineminus">-  nsISupportsArray *      m_pBooks;</span>
<a href="#l39.48"></a><span id="l39.48" class="difflineplus">+  nsISupportsArray *m_pBooks;</span>
<a href="#l39.49"></a><span id="l39.49" class="difflineplus">+  nsCOMArray&lt;nsIAddrDatabase&gt; m_DBs;</span>
<a href="#l39.50"></a><span id="l39.50">   nsCOMPtr &lt;nsIFile&gt;              m_pLocation;</span>
<a href="#l39.51"></a><span id="l39.51">   nsIImportFieldMap *      m_pFieldMap;</span>
<a href="#l39.52"></a><span id="l39.52">   PRBool            m_autoFind;</span>
<a href="#l39.53"></a><span id="l39.53">   PRUnichar *          m_description;</span>
<a href="#l39.54"></a><span id="l39.54">   PRBool            m_gotLocation;</span>
<a href="#l39.55"></a><span id="l39.55">   PRBool            m_found;</span>
<a href="#l39.56"></a><span id="l39.56">   PRBool            m_userVerify;</span>
<a href="#l39.57"></a><span id="l39.57">   nsISupportsString *    m_pSuccessLog;</span>
<a href="#l39.58"></a><span id="l39.58" class="difflineat">@@ -128,16 +129,17 @@ class AddressThreadData {</span>
<a href="#l39.59"></a><span id="l39.59"> public:</span>
<a href="#l39.60"></a><span id="l39.60">   PRBool            driverAlive;</span>
<a href="#l39.61"></a><span id="l39.61">   PRBool            threadAlive;</span>
<a href="#l39.62"></a><span id="l39.62">   PRBool            abort;</span>
<a href="#l39.63"></a><span id="l39.63">   PRBool            fatalError;</span>
<a href="#l39.64"></a><span id="l39.64">   PRUint32          currentTotal;</span>
<a href="#l39.65"></a><span id="l39.65">   PRUint32          currentSize;</span>
<a href="#l39.66"></a><span id="l39.66">   nsISupportsArray *      books;</span>
<a href="#l39.67"></a><span id="l39.67" class="difflineplus">+  nsCOMArray&lt;nsIAddrDatabase&gt;* dBs;</span>
<a href="#l39.68"></a><span id="l39.68">   nsIAbLDIFService *ldifService;</span>
<a href="#l39.69"></a><span id="l39.69">   nsIImportAddressBooks *    addressImport;</span>
<a href="#l39.70"></a><span id="l39.70">   nsIImportFieldMap *      fieldMap;</span>
<a href="#l39.71"></a><span id="l39.71">   nsISupportsString *    successLog;</span>
<a href="#l39.72"></a><span id="l39.72">   nsISupportsString *    errorLog;</span>
<a href="#l39.73"></a><span id="l39.73">   char *            pDestinationUri;</span>
<a href="#l39.74"></a><span id="l39.74">     nsIStringBundle*            stringBundle;</span>
<a href="#l39.75"></a><span id="l39.75"> </span>
<a href="#l39.76"></a><span id="l39.76" class="difflineat">@@ -527,16 +529,123 @@ void nsImportGenericAddressBooks::SetLog</span>
<a href="#l39.77"></a><span id="l39.77">   }</span>
<a href="#l39.78"></a><span id="l39.78">   if (pError) {</span>
<a href="#l39.79"></a><span id="l39.79">     pError-&gt;GetData(str);</span>
<a href="#l39.80"></a><span id="l39.80">         str.Append(error);</span>
<a href="#l39.81"></a><span id="l39.81">         pError-&gt;SetData(error);</span>
<a href="#l39.82"></a><span id="l39.82">   }</span>
<a href="#l39.83"></a><span id="l39.83"> }</span>
<a href="#l39.84"></a><span id="l39.84"> </span>
<a href="#l39.85"></a><span id="l39.85" class="difflineplus">+already_AddRefed&lt;nsIAddrDatabase&gt; GetAddressBookFromUri(const char *pUri)</span>
<a href="#l39.86"></a><span id="l39.86" class="difflineplus">+{</span>
<a href="#l39.87"></a><span id="l39.87" class="difflineplus">+  if (!pUri)</span>
<a href="#l39.88"></a><span id="l39.88" class="difflineplus">+    return nsnull;</span>
<a href="#l39.89"></a><span id="l39.89" class="difflineplus">+</span>
<a href="#l39.90"></a><span id="l39.90" class="difflineplus">+  nsCOMPtr&lt;nsIAbManager&gt; abManager = do_GetService(NS_ABMANAGER_CONTRACTID);</span>
<a href="#l39.91"></a><span id="l39.91" class="difflineplus">+  if (!abManager)</span>
<a href="#l39.92"></a><span id="l39.92" class="difflineplus">+    return nsnull;</span>
<a href="#l39.93"></a><span id="l39.93" class="difflineplus">+</span>
<a href="#l39.94"></a><span id="l39.94" class="difflineplus">+  nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l39.95"></a><span id="l39.95" class="difflineplus">+  abManager-&gt;GetDirectory(nsDependentCString(pUri),</span>
<a href="#l39.96"></a><span id="l39.96" class="difflineplus">+                          getter_AddRefs(directory));</span>
<a href="#l39.97"></a><span id="l39.97" class="difflineplus">+  if (!directory)</span>
<a href="#l39.98"></a><span id="l39.98" class="difflineplus">+    return nsnull;</span>
<a href="#l39.99"></a><span id="l39.99" class="difflineplus">+</span>
<a href="#l39.100"></a><span id="l39.100" class="difflineplus">+  nsCOMPtr&lt;nsIAbMDBDirectory&gt; mdbDirectory = do_QueryInterface(directory);</span>
<a href="#l39.101"></a><span id="l39.101" class="difflineplus">+  if (!mdbDirectory)</span>
<a href="#l39.102"></a><span id="l39.102" class="difflineplus">+    return nsnull;</span>
<a href="#l39.103"></a><span id="l39.103" class="difflineplus">+</span>
<a href="#l39.104"></a><span id="l39.104" class="difflineplus">+  nsIAddrDatabase *pDatabase = nsnull;</span>
<a href="#l39.105"></a><span id="l39.105" class="difflineplus">+  mdbDirectory-&gt;GetDatabase(&amp;pDatabase);</span>
<a href="#l39.106"></a><span id="l39.106" class="difflineplus">+  return pDatabase;</span>
<a href="#l39.107"></a><span id="l39.107" class="difflineplus">+}</span>
<a href="#l39.108"></a><span id="l39.108" class="difflineplus">+</span>
<a href="#l39.109"></a><span id="l39.109" class="difflineplus">+already_AddRefed&lt;nsIAddrDatabase&gt; GetAddressBook(const PRUnichar *name,</span>
<a href="#l39.110"></a><span id="l39.110" class="difflineplus">+                                                 PRBool makeNew)</span>
<a href="#l39.111"></a><span id="l39.111" class="difflineplus">+{</span>
<a href="#l39.112"></a><span id="l39.112" class="difflineplus">+  if (!makeNew) {</span>
<a href="#l39.113"></a><span id="l39.113" class="difflineplus">+    // FIXME: How do I get the list of address books and look for a</span>
<a href="#l39.114"></a><span id="l39.114" class="difflineplus">+    // specific name.  Major bogosity!</span>
<a href="#l39.115"></a><span id="l39.115" class="difflineplus">+    // For now, assume we didn't find anything with that name</span>
<a href="#l39.116"></a><span id="l39.116" class="difflineplus">+  }</span>
<a href="#l39.117"></a><span id="l39.117" class="difflineplus">+</span>
<a href="#l39.118"></a><span id="l39.118" class="difflineplus">+  IMPORT_LOG0( &quot;In GetAddressBook\n&quot;);</span>
<a href="#l39.119"></a><span id="l39.119" class="difflineplus">+</span>
<a href="#l39.120"></a><span id="l39.120" class="difflineplus">+  nsresult rv;</span>
<a href="#l39.121"></a><span id="l39.121" class="difflineplus">+  nsIAddrDatabase *pDatabase = nsnull;</span>
<a href="#l39.122"></a><span id="l39.122" class="difflineplus">+  nsCOMPtr&lt;nsILocalFile&gt; dbPath;</span>
<a href="#l39.123"></a><span id="l39.123" class="difflineplus">+  nsCOMPtr&lt;nsIAbManager&gt; abManager = do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l39.124"></a><span id="l39.124" class="difflineplus">+  if (NS_SUCCEEDED(rv))</span>
<a href="#l39.125"></a><span id="l39.125" class="difflineplus">+  {</span>
<a href="#l39.126"></a><span id="l39.126" class="difflineplus">+    /* Get the profile directory */</span>
<a href="#l39.127"></a><span id="l39.127" class="difflineplus">+    rv = abManager-&gt;GetUserProfileDirectory(getter_AddRefs(dbPath));</span>
<a href="#l39.128"></a><span id="l39.128" class="difflineplus">+    if (NS_SUCCEEDED(rv))</span>
<a href="#l39.129"></a><span id="l39.129" class="difflineplus">+    {</span>
<a href="#l39.130"></a><span id="l39.130" class="difflineplus">+      // Create a new address book file - we don't care what the file</span>
<a href="#l39.131"></a><span id="l39.131" class="difflineplus">+      // name is, as long as it's unique</span>
<a href="#l39.132"></a><span id="l39.132" class="difflineplus">+      rv = dbPath-&gt;Append(NS_LITERAL_STRING(&quot;impab.mab&quot;));</span>
<a href="#l39.133"></a><span id="l39.133" class="difflineplus">+      if (NS_SUCCEEDED(rv))</span>
<a href="#l39.134"></a><span id="l39.134" class="difflineplus">+      {</span>
<a href="#l39.135"></a><span id="l39.135" class="difflineplus">+        rv = dbPath-&gt;CreateUnique(nsIFile::NORMAL_FILE_TYPE, 0600);</span>
<a href="#l39.136"></a><span id="l39.136" class="difflineplus">+</span>
<a href="#l39.137"></a><span id="l39.137" class="difflineplus">+        if (NS_SUCCEEDED(rv))</span>
<a href="#l39.138"></a><span id="l39.138" class="difflineplus">+        {</span>
<a href="#l39.139"></a><span id="l39.139" class="difflineplus">+          IMPORT_LOG0( &quot;Getting the address database factory\n&quot;);</span>
<a href="#l39.140"></a><span id="l39.140" class="difflineplus">+</span>
<a href="#l39.141"></a><span id="l39.141" class="difflineplus">+          nsCOMPtr&lt;nsIAddrDatabase&gt; addrDBFactory =</span>
<a href="#l39.142"></a><span id="l39.142" class="difflineplus">+            do_GetService(NS_ADDRDATABASE_CONTRACTID, &amp;rv);</span>
<a href="#l39.143"></a><span id="l39.143" class="difflineplus">+          if (NS_FAILED(rv))</span>
<a href="#l39.144"></a><span id="l39.144" class="difflineplus">+            return nsnull;</span>
<a href="#l39.145"></a><span id="l39.145" class="difflineplus">+</span>
<a href="#l39.146"></a><span id="l39.146" class="difflineplus">+          IMPORT_LOG0( &quot;Opening the new address book\n&quot;);</span>
<a href="#l39.147"></a><span id="l39.147" class="difflineplus">+          rv = addrDBFactory-&gt;Open(dbPath, PR_TRUE, PR_TRUE,</span>
<a href="#l39.148"></a><span id="l39.148" class="difflineplus">+                                   &amp;pDatabase);</span>
<a href="#l39.149"></a><span id="l39.149" class="difflineplus">+        }</span>
<a href="#l39.150"></a><span id="l39.150" class="difflineplus">+      }</span>
<a href="#l39.151"></a><span id="l39.151" class="difflineplus">+    }</span>
<a href="#l39.152"></a><span id="l39.152" class="difflineplus">+  }</span>
<a href="#l39.153"></a><span id="l39.153" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l39.154"></a><span id="l39.154" class="difflineplus">+  {</span>
<a href="#l39.155"></a><span id="l39.155" class="difflineplus">+    IMPORT_LOG0( &quot;Failed to get the user profile directory from the address book session\n&quot;);</span>
<a href="#l39.156"></a><span id="l39.156" class="difflineplus">+  }</span>
<a href="#l39.157"></a><span id="l39.157" class="difflineplus">+</span>
<a href="#l39.158"></a><span id="l39.158" class="difflineplus">+  if (pDatabase &amp;&amp; dbPath)</span>
<a href="#l39.159"></a><span id="l39.159" class="difflineplus">+  {</span>
<a href="#l39.160"></a><span id="l39.160" class="difflineplus">+    // We made a database, add it to the UI?!?!?!?!?!?!</span>
<a href="#l39.161"></a><span id="l39.161" class="difflineplus">+    // This is major bogosity again!  Why doesn't the address book</span>
<a href="#l39.162"></a><span id="l39.162" class="difflineplus">+    // just handle this properly for me?  Uggggg...</span>
<a href="#l39.163"></a><span id="l39.163" class="difflineplus">+</span>
<a href="#l39.164"></a><span id="l39.164" class="difflineplus">+    nsCOMPtr&lt;nsIAbDirectory&gt; parentDir;</span>
<a href="#l39.165"></a><span id="l39.165" class="difflineplus">+    abManager-&gt;GetDirectory(NS_LITERAL_CSTRING(kAllDirectoryRoot),</span>
<a href="#l39.166"></a><span id="l39.166" class="difflineplus">+                            getter_AddRefs(parentDir));</span>
<a href="#l39.167"></a><span id="l39.167" class="difflineplus">+    if (parentDir)</span>
<a href="#l39.168"></a><span id="l39.168" class="difflineplus">+    {</span>
<a href="#l39.169"></a><span id="l39.169" class="difflineplus">+      nsCAutoString URI(&quot;moz-abmdbdirectory://&quot;);</span>
<a href="#l39.170"></a><span id="l39.170" class="difflineplus">+      nsCAutoString leafName;</span>
<a href="#l39.171"></a><span id="l39.171" class="difflineplus">+      rv = dbPath-&gt;GetNativeLeafName(leafName);</span>
<a href="#l39.172"></a><span id="l39.172" class="difflineplus">+      if (NS_FAILED(rv))</span>
<a href="#l39.173"></a><span id="l39.173" class="difflineplus">+        IMPORT_LOG0( &quot;*** Error: Unable to get name of database file\n&quot;);</span>
<a href="#l39.174"></a><span id="l39.174" class="difflineplus">+      else</span>
<a href="#l39.175"></a><span id="l39.175" class="difflineplus">+      {</span>
<a href="#l39.176"></a><span id="l39.176" class="difflineplus">+        URI.Append(leafName);</span>
<a href="#l39.177"></a><span id="l39.177" class="difflineplus">+        rv = parentDir-&gt;CreateDirectoryByURI(nsDependentString(name), URI);</span>
<a href="#l39.178"></a><span id="l39.178" class="difflineplus">+        if (NS_FAILED(rv))</span>
<a href="#l39.179"></a><span id="l39.179" class="difflineplus">+          IMPORT_LOG0( &quot;*** Error: Unable to create address book directory\n&quot;);</span>
<a href="#l39.180"></a><span id="l39.180" class="difflineplus">+      }</span>
<a href="#l39.181"></a><span id="l39.181" class="difflineplus">+    }</span>
<a href="#l39.182"></a><span id="l39.182" class="difflineplus">+</span>
<a href="#l39.183"></a><span id="l39.183" class="difflineplus">+    if (NS_SUCCEEDED(rv))</span>
<a href="#l39.184"></a><span id="l39.184" class="difflineplus">+      IMPORT_LOG0( &quot;Added new address book to the UI\n&quot;);</span>
<a href="#l39.185"></a><span id="l39.185" class="difflineplus">+    else</span>
<a href="#l39.186"></a><span id="l39.186" class="difflineplus">+      IMPORT_LOG0( &quot;*** Error: An error occurred while adding the address book to the UI\n&quot;);</span>
<a href="#l39.187"></a><span id="l39.187" class="difflineplus">+  }</span>
<a href="#l39.188"></a><span id="l39.188" class="difflineplus">+</span>
<a href="#l39.189"></a><span id="l39.189" class="difflineplus">+  return pDatabase;</span>
<a href="#l39.190"></a><span id="l39.190" class="difflineplus">+}</span>
<a href="#l39.191"></a><span id="l39.191" class="difflineplus">+</span>
<a href="#l39.192"></a><span id="l39.192"> NS_IMETHODIMP nsImportGenericAddressBooks::BeginImport(nsISupportsString *successLog, nsISupportsString *errorLog, PRBool *_retval)</span>
<a href="#l39.193"></a><span id="l39.193"> {</span>
<a href="#l39.194"></a><span id="l39.194">   NS_PRECONDITION(_retval != nsnull, &quot;null ptr&quot;);</span>
<a href="#l39.195"></a><span id="l39.195">     if (!_retval)</span>
<a href="#l39.196"></a><span id="l39.196">         return NS_ERROR_NULL_POINTER;</span>
<a href="#l39.197"></a><span id="l39.197"> </span>
<a href="#l39.198"></a><span id="l39.198">   nsString  success;</span>
<a href="#l39.199"></a><span id="l39.199">   nsString  error;</span>
<a href="#l39.200"></a><span id="l39.200" class="difflineat">@@ -591,16 +700,38 @@ NS_IMETHODIMP nsImportGenericAddressBook</span>
<a href="#l39.201"></a><span id="l39.201">   NS_IF_ADDREF( m_pFieldMap);</span>
<a href="#l39.202"></a><span id="l39.202">   m_pThreadData-&gt;errorLog = m_pErrorLog;</span>
<a href="#l39.203"></a><span id="l39.203">   NS_IF_ADDREF( m_pErrorLog);</span>
<a href="#l39.204"></a><span id="l39.204">   m_pThreadData-&gt;successLog = m_pSuccessLog;</span>
<a href="#l39.205"></a><span id="l39.205">   NS_IF_ADDREF( m_pSuccessLog);</span>
<a href="#l39.206"></a><span id="l39.206">   if (m_pDestinationUri)</span>
<a href="#l39.207"></a><span id="l39.207">     m_pThreadData-&gt;pDestinationUri = strdup( m_pDestinationUri);</span>
<a href="#l39.208"></a><span id="l39.208"> </span>
<a href="#l39.209"></a><span id="l39.209" class="difflineplus">+  PRUint32 count = 0;</span>
<a href="#l39.210"></a><span id="l39.210" class="difflineplus">+  m_pBooks-&gt;Count(&amp;count);</span>
<a href="#l39.211"></a><span id="l39.211" class="difflineplus">+  // Create/obtain any address books that we need here, so that we don't need</span>
<a href="#l39.212"></a><span id="l39.212" class="difflineplus">+  // to do so inside the import thread which would just proxy the create</span>
<a href="#l39.213"></a><span id="l39.213" class="difflineplus">+  // operations back to the main thread anyway.</span>
<a href="#l39.214"></a><span id="l39.214" class="difflineplus">+  nsCOMPtr&lt;nsIAddrDatabase&gt; db = GetAddressBookFromUri(m_pDestinationUri);</span>
<a href="#l39.215"></a><span id="l39.215" class="difflineplus">+  for (PRUint32 i = 0; i &lt; count; ++i)</span>
<a href="#l39.216"></a><span id="l39.216" class="difflineplus">+  {</span>
<a href="#l39.217"></a><span id="l39.217" class="difflineplus">+    nsCOMPtr&lt;nsIImportABDescriptor&gt; book = do_QueryElementAt(m_pBooks, i);</span>
<a href="#l39.218"></a><span id="l39.218" class="difflineplus">+    if (book)</span>
<a href="#l39.219"></a><span id="l39.219" class="difflineplus">+    {</span>
<a href="#l39.220"></a><span id="l39.220" class="difflineplus">+      if (!db)</span>
<a href="#l39.221"></a><span id="l39.221" class="difflineplus">+      {</span>
<a href="#l39.222"></a><span id="l39.222" class="difflineplus">+        nsString name;</span>
<a href="#l39.223"></a><span id="l39.223" class="difflineplus">+        book-&gt;GetPreferredName(name);</span>
<a href="#l39.224"></a><span id="l39.224" class="difflineplus">+        db = GetAddressBook(name.get(), PR_TRUE);</span>
<a href="#l39.225"></a><span id="l39.225" class="difflineplus">+      }</span>
<a href="#l39.226"></a><span id="l39.226" class="difflineplus">+      m_DBs.AppendObject(db);</span>
<a href="#l39.227"></a><span id="l39.227" class="difflineplus">+    }</span>
<a href="#l39.228"></a><span id="l39.228" class="difflineplus">+  }</span>
<a href="#l39.229"></a><span id="l39.229" class="difflineplus">+  m_pThreadData-&gt;dBs = &amp;m_DBs;</span>
<a href="#l39.230"></a><span id="l39.230" class="difflineplus">+</span>
<a href="#l39.231"></a><span id="l39.231">   NS_IF_ADDREF(m_pThreadData-&gt;stringBundle = m_stringBundle);</span>
<a href="#l39.232"></a><span id="l39.232"> </span>
<a href="#l39.233"></a><span id="l39.233">   nsresult rv;</span>
<a href="#l39.234"></a><span id="l39.234">   nsCOMPtr&lt;nsIAbLDIFService&gt; ldifService(do_GetService(NS_ABLDIFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l39.235"></a><span id="l39.235">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l39.236"></a><span id="l39.236"> </span>
<a href="#l39.237"></a><span id="l39.237">   nsCOMPtr&lt;nsIProxyObjectManager&gt; proxyObjectManager =</span>
<a href="#l39.238"></a><span id="l39.238">     do_GetService(NS_XPCOMPROXY_CONTRACTID, &amp;rv);</span>
<a href="#l39.239"></a><span id="l39.239" class="difflineat">@@ -755,182 +886,16 @@ void AddressThreadData::DriverAbort()</span>
<a href="#l39.240"></a><span id="l39.240">     // FIXME: Do whatever is necessary to abort what has already been imported!</span>
<a href="#l39.241"></a><span id="l39.241">   }</span>
<a href="#l39.242"></a><span id="l39.242">   else</span>
<a href="#l39.243"></a><span id="l39.243">     abort = PR_TRUE;</span>
<a href="#l39.244"></a><span id="l39.244">   DriverDelete();</span>
<a href="#l39.245"></a><span id="l39.245"> }</span>
<a href="#l39.246"></a><span id="l39.246"> </span>
<a href="#l39.247"></a><span id="l39.247"> </span>
<a href="#l39.248"></a><span id="l39.248" class="difflineminus">-already_AddRefed&lt;nsIAddrDatabase&gt; GetAddressBookFromUri(const char *pUri)</span>
<a href="#l39.249"></a><span id="l39.249" class="difflineminus">-{</span>
<a href="#l39.250"></a><span id="l39.250" class="difflineminus">-  nsIAddrDatabase *  pDatabase = nsnull;</span>
<a href="#l39.251"></a><span id="l39.251" class="difflineminus">-  if (pUri) {</span>
<a href="#l39.252"></a><span id="l39.252" class="difflineminus">-    nsresult rv;</span>
<a href="#l39.253"></a><span id="l39.253" class="difflineminus">-    nsCOMPtr&lt;nsIProxyObjectManager&gt; proxyObjectManager =</span>
<a href="#l39.254"></a><span id="l39.254" class="difflineminus">-      do_GetService(NS_XPCOMPROXY_CONTRACTID, &amp;rv);</span>
<a href="#l39.255"></a><span id="l39.255" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l39.256"></a><span id="l39.256" class="difflineminus">-      return nsnull;</span>
<a href="#l39.257"></a><span id="l39.257" class="difflineminus">-</span>
<a href="#l39.258"></a><span id="l39.258" class="difflineminus">-    nsCOMPtr&lt;nsIRDFService&gt; mainRdfService =</span>
<a href="#l39.259"></a><span id="l39.259" class="difflineminus">-      do_GetService(kRDFServiceCID, &amp;rv);</span>
<a href="#l39.260"></a><span id="l39.260" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l39.261"></a><span id="l39.261" class="difflineminus">-      return nsnull;</span>
<a href="#l39.262"></a><span id="l39.262" class="difflineminus">-</span>
<a href="#l39.263"></a><span id="l39.263" class="difflineminus">-    nsIRDFService *rdfService = nsnull;</span>
<a href="#l39.264"></a><span id="l39.264" class="difflineminus">-    rv = proxyObjectManager-&gt;GetProxyForObject(NS_PROXY_TO_MAIN_THREAD,</span>
<a href="#l39.265"></a><span id="l39.265" class="difflineminus">-                                               NS_GET_IID(nsIRDFService),</span>
<a href="#l39.266"></a><span id="l39.266" class="difflineminus">-                                               mainRdfService,</span>
<a href="#l39.267"></a><span id="l39.267" class="difflineminus">-                                               NS_PROXY_SYNC,</span>
<a href="#l39.268"></a><span id="l39.268" class="difflineminus">-                                               (void**)&amp;rdfService);</span>
<a href="#l39.269"></a><span id="l39.269" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; rdfService)</span>
<a href="#l39.270"></a><span id="l39.270" class="difflineminus">-    {</span>
<a href="#l39.271"></a><span id="l39.271" class="difflineminus">-      nsCOMPtr&lt;nsIRDFResource&gt; resource;</span>
<a href="#l39.272"></a><span id="l39.272" class="difflineminus">-      rv = rdfService-&gt;GetResource(nsDependentCString(pUri),</span>
<a href="#l39.273"></a><span id="l39.273" class="difflineminus">-                                        getter_AddRefs(resource));</span>
<a href="#l39.274"></a><span id="l39.274" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l39.275"></a><span id="l39.275" class="difflineminus">-      {</span>
<a href="#l39.276"></a><span id="l39.276" class="difflineminus">-        nsCOMPtr&lt;nsIAbMDBDirectory&gt; directory = do_QueryInterface(resource, &amp;rv);</span>
<a href="#l39.277"></a><span id="l39.277" class="difflineminus">-        if (NS_SUCCEEDED(rv))</span>
<a href="#l39.278"></a><span id="l39.278" class="difflineminus">-          directory-&gt;GetDatabase(&amp;pDatabase);</span>
<a href="#l39.279"></a><span id="l39.279" class="difflineminus">-      }</span>
<a href="#l39.280"></a><span id="l39.280" class="difflineminus">-    }</span>
<a href="#l39.281"></a><span id="l39.281" class="difflineminus">-  }</span>
<a href="#l39.282"></a><span id="l39.282" class="difflineminus">-</span>
<a href="#l39.283"></a><span id="l39.283" class="difflineminus">-  return pDatabase;</span>
<a href="#l39.284"></a><span id="l39.284" class="difflineminus">-}</span>
<a href="#l39.285"></a><span id="l39.285" class="difflineminus">-</span>
<a href="#l39.286"></a><span id="l39.286" class="difflineminus">-already_AddRefed&lt;nsIAddrDatabase&gt; GetAddressBook(const PRUnichar *name,</span>
<a href="#l39.287"></a><span id="l39.287" class="difflineminus">-                                                 PRBool makeNew)</span>
<a href="#l39.288"></a><span id="l39.288" class="difflineminus">-{</span>
<a href="#l39.289"></a><span id="l39.289" class="difflineminus">-  nsresult      rv = NS_OK;</span>
<a href="#l39.290"></a><span id="l39.290" class="difflineminus">-</span>
<a href="#l39.291"></a><span id="l39.291" class="difflineminus">-  if (!makeNew) {</span>
<a href="#l39.292"></a><span id="l39.292" class="difflineminus">-    // FIXME: How do I get the list of address books and look for a</span>
<a href="#l39.293"></a><span id="l39.293" class="difflineminus">-    // specific name.  Major bogosity!</span>
<a href="#l39.294"></a><span id="l39.294" class="difflineminus">-    // For now, assume we didn't find anything with that name</span>
<a href="#l39.295"></a><span id="l39.295" class="difflineminus">-  }</span>
<a href="#l39.296"></a><span id="l39.296" class="difflineminus">-</span>
<a href="#l39.297"></a><span id="l39.297" class="difflineminus">-  IMPORT_LOG0( &quot;In GetAddressBook\n&quot;);</span>
<a href="#l39.298"></a><span id="l39.298" class="difflineminus">-</span>
<a href="#l39.299"></a><span id="l39.299" class="difflineminus">-  nsIAddrDatabase *  pDatabase = nsnull;</span>
<a href="#l39.300"></a><span id="l39.300" class="difflineminus">-</span>
<a href="#l39.301"></a><span id="l39.301" class="difflineminus">-  /* Get the profile directory */</span>
<a href="#l39.302"></a><span id="l39.302" class="difflineminus">-  nsCOMPtr&lt;nsILocalFile&gt; dbPath;</span>
<a href="#l39.303"></a><span id="l39.303" class="difflineminus">-</span>
<a href="#l39.304"></a><span id="l39.304" class="difflineminus">-  nsCOMPtr&lt;nsIProxyObjectManager&gt; proxyObjectManager =</span>
<a href="#l39.305"></a><span id="l39.305" class="difflineminus">-    do_GetService(NS_XPCOMPROXY_CONTRACTID, &amp;rv);</span>
<a href="#l39.306"></a><span id="l39.306" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l39.307"></a><span id="l39.307" class="difflineminus">-    return nsnull;</span>
<a href="#l39.308"></a><span id="l39.308" class="difflineminus">-</span>
<a href="#l39.309"></a><span id="l39.309" class="difflineminus">-  nsCOMPtr&lt;nsIAbManager&gt; abMan = do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l39.310"></a><span id="l39.310" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l39.311"></a><span id="l39.311" class="difflineminus">-    return nsnull;</span>
<a href="#l39.312"></a><span id="l39.312" class="difflineminus">-</span>
<a href="#l39.313"></a><span id="l39.313" class="difflineminus">-  nsCOMPtr&lt;nsIAbManager&gt; abManager;</span>
<a href="#l39.314"></a><span id="l39.314" class="difflineminus">-  rv = proxyObjectManager-&gt;GetProxyForObject(NS_PROXY_TO_MAIN_THREAD,</span>
<a href="#l39.315"></a><span id="l39.315" class="difflineminus">-                                             NS_GET_IID(nsIAbManager),</span>
<a href="#l39.316"></a><span id="l39.316" class="difflineminus">-                                             abMan,</span>
<a href="#l39.317"></a><span id="l39.317" class="difflineminus">-                                             NS_PROXY_SYNC,</span>
<a href="#l39.318"></a><span id="l39.318" class="difflineminus">-                                             getter_AddRefs(abManager));</span>
<a href="#l39.319"></a><span id="l39.319" class="difflineminus">-</span>
<a href="#l39.320"></a><span id="l39.320" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l39.321"></a><span id="l39.321" class="difflineminus">-    rv = abManager-&gt;GetUserProfileDirectory(getter_AddRefs(dbPath));</span>
<a href="#l39.322"></a><span id="l39.322" class="difflineminus">-  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l39.323"></a><span id="l39.323" class="difflineminus">-    // Create a new address book file - we don't care what the file</span>
<a href="#l39.324"></a><span id="l39.324" class="difflineminus">-    // name is, as long as it's unique</span>
<a href="#l39.325"></a><span id="l39.325" class="difflineminus">-    rv = dbPath-&gt;Append(NS_LITERAL_STRING(&quot;impab.mab&quot;));</span>
<a href="#l39.326"></a><span id="l39.326" class="difflineminus">-        if (NS_SUCCEEDED(rv)) {</span>
<a href="#l39.327"></a><span id="l39.327" class="difflineminus">-          rv = dbPath-&gt;CreateUnique(nsIFile::NORMAL_FILE_TYPE, 0600);</span>
<a href="#l39.328"></a><span id="l39.328" class="difflineminus">-</span>
<a href="#l39.329"></a><span id="l39.329" class="difflineminus">-          if (NS_SUCCEEDED(rv)) {</span>
<a href="#l39.330"></a><span id="l39.330" class="difflineminus">-            IMPORT_LOG0( &quot;Getting the address database factory\n&quot;);</span>
<a href="#l39.331"></a><span id="l39.331" class="difflineminus">-</span>
<a href="#l39.332"></a><span id="l39.332" class="difflineminus">-            nsCOMPtr&lt;nsIAddrDatabase&gt; addrDatabaseFactory =</span>
<a href="#l39.333"></a><span id="l39.333" class="difflineminus">-              do_GetService(NS_ADDRDATABASE_CONTRACTID, &amp;rv);</span>
<a href="#l39.334"></a><span id="l39.334" class="difflineminus">-            if (NS_FAILED(rv))</span>
<a href="#l39.335"></a><span id="l39.335" class="difflineminus">-              return nsnull;</span>
<a href="#l39.336"></a><span id="l39.336" class="difflineminus">-</span>
<a href="#l39.337"></a><span id="l39.337" class="difflineminus">-            nsCOMPtr&lt;nsIAddrDatabase&gt; addrDBFactory;</span>
<a href="#l39.338"></a><span id="l39.338" class="difflineminus">-            rv = proxyObjectManager-&gt;GetProxyForObject(NS_PROXY_TO_MAIN_THREAD,</span>
<a href="#l39.339"></a><span id="l39.339" class="difflineminus">-                                                       NS_GET_IID(nsIAddrDatabase),</span>
<a href="#l39.340"></a><span id="l39.340" class="difflineminus">-                                                       addrDatabaseFactory,</span>
<a href="#l39.341"></a><span id="l39.341" class="difflineminus">-                                                       NS_PROXY_SYNC,</span>
<a href="#l39.342"></a><span id="l39.342" class="difflineminus">-                                                       getter_AddRefs(addrDBFactory));</span>
<a href="#l39.343"></a><span id="l39.343" class="difflineminus">-            if (NS_SUCCEEDED(rv) &amp;&amp; addrDBFactory) {</span>
<a href="#l39.344"></a><span id="l39.344" class="difflineminus">-              IMPORT_LOG0( &quot;Opening the new address book\n&quot;);</span>
<a href="#l39.345"></a><span id="l39.345" class="difflineminus">-              nsCOMPtr&lt;nsIAddrDatabase&gt; nonProxyDatabase;</span>
<a href="#l39.346"></a><span id="l39.346" class="difflineminus">-              rv = addrDBFactory-&gt;Open(dbPath, PR_TRUE, PR_TRUE,</span>
<a href="#l39.347"></a><span id="l39.347" class="difflineminus">-                                       getter_AddRefs(nonProxyDatabase));</span>
<a href="#l39.348"></a><span id="l39.348" class="difflineminus">-              if (nonProxyDatabase)</span>
<a href="#l39.349"></a><span id="l39.349" class="difflineminus">-                rv = proxyObjectManager-&gt;GetProxyForObject(NS_PROXY_TO_MAIN_THREAD,</span>
<a href="#l39.350"></a><span id="l39.350" class="difflineminus">-                                                           NS_GET_IID(nsIAddrDatabase),</span>
<a href="#l39.351"></a><span id="l39.351" class="difflineminus">-                                                           nonProxyDatabase,</span>
<a href="#l39.352"></a><span id="l39.352" class="difflineminus">-                                                           NS_PROXY_SYNC,</span>
<a href="#l39.353"></a><span id="l39.353" class="difflineminus">-                                                           (void**)&amp;pDatabase);</span>
<a href="#l39.354"></a><span id="l39.354" class="difflineminus">-                </span>
<a href="#l39.355"></a><span id="l39.355" class="difflineminus">-            }</span>
<a href="#l39.356"></a><span id="l39.356" class="difflineminus">-          }</span>
<a href="#l39.357"></a><span id="l39.357" class="difflineminus">-        }</span>
<a href="#l39.358"></a><span id="l39.358" class="difflineminus">-  }</span>
<a href="#l39.359"></a><span id="l39.359" class="difflineminus">-  if (NS_FAILED(rv)) {</span>
<a href="#l39.360"></a><span id="l39.360" class="difflineminus">-    IMPORT_LOG0( &quot;Failed to get the user profile directory from the address book session\n&quot;);</span>
<a href="#l39.361"></a><span id="l39.361" class="difflineminus">-  }</span>
<a href="#l39.362"></a><span id="l39.362" class="difflineminus">-</span>
<a href="#l39.363"></a><span id="l39.363" class="difflineminus">-</span>
<a href="#l39.364"></a><span id="l39.364" class="difflineminus">-  if (pDatabase) {</span>
<a href="#l39.365"></a><span id="l39.365" class="difflineminus">-    // We made a database, add it to the UI?!?!?!?!?!?!</span>
<a href="#l39.366"></a><span id="l39.366" class="difflineminus">-    // This is major bogosity again!  Why doesn't the address book</span>
<a href="#l39.367"></a><span id="l39.367" class="difflineminus">-    // just handle this properly for me?  Uggggg...</span>
<a href="#l39.368"></a><span id="l39.368" class="difflineminus">-</span>
<a href="#l39.369"></a><span id="l39.369" class="difflineminus">-    nsCOMPtr&lt;nsIAbDirectory&gt; nonProxyParentDir;</span>
<a href="#l39.370"></a><span id="l39.370" class="difflineminus">-    abManager-&gt;GetDirectory(NS_LITERAL_CSTRING(kAllDirectoryRoot),</span>
<a href="#l39.371"></a><span id="l39.371" class="difflineminus">-                            getter_AddRefs(nonProxyParentDir));</span>
<a href="#l39.372"></a><span id="l39.372" class="difflineminus">-    nsCOMPtr&lt;nsIAbDirectory&gt; parentDir;</span>
<a href="#l39.373"></a><span id="l39.373" class="difflineminus">-    /*</span>
<a href="#l39.374"></a><span id="l39.374" class="difflineminus">-     * TODO</span>
<a href="#l39.375"></a><span id="l39.375" class="difflineminus">-     * This may not be required in the future since the</span>
<a href="#l39.376"></a><span id="l39.376" class="difflineminus">-     * primary listeners of the nsIAbDirectory will be</span>
<a href="#l39.377"></a><span id="l39.377" class="difflineminus">-     * RDF directory datasource which propagates events to</span>
<a href="#l39.378"></a><span id="l39.378" class="difflineminus">-     * RDF Observers. In the future the RDF directory datasource</span>
<a href="#l39.379"></a><span id="l39.379" class="difflineminus">-     * will proxy the observers because asynchronous directory</span>
<a href="#l39.380"></a><span id="l39.380" class="difflineminus">-     * implementations, such as LDAP, will assert results from</span>
<a href="#l39.381"></a><span id="l39.381" class="difflineminus">-     * a thread other than the UI thread.</span>
<a href="#l39.382"></a><span id="l39.382" class="difflineminus">-     *</span>
<a href="#l39.383"></a><span id="l39.383" class="difflineminus">-     */</span>
<a href="#l39.384"></a><span id="l39.384" class="difflineminus">-    rv = proxyObjectManager-&gt;GetProxyForObject(NS_PROXY_TO_MAIN_THREAD,</span>
<a href="#l39.385"></a><span id="l39.385" class="difflineminus">-                                               NS_GET_IID(nsIAbDirectory),</span>
<a href="#l39.386"></a><span id="l39.386" class="difflineminus">-                                               nonProxyParentDir,</span>
<a href="#l39.387"></a><span id="l39.387" class="difflineminus">-                                               NS_PROXY_SYNC | NS_PROXY_ALWAYS,</span>
<a href="#l39.388"></a><span id="l39.388" class="difflineminus">-                                               getter_AddRefs(parentDir));</span>
<a href="#l39.389"></a><span id="l39.389" class="difflineminus">-    if (parentDir)</span>
<a href="#l39.390"></a><span id="l39.390" class="difflineminus">-    {</span>
<a href="#l39.391"></a><span id="l39.391" class="difflineminus">-      nsCAutoString URI(&quot;moz-abmdbdirectory://&quot;);</span>
<a href="#l39.392"></a><span id="l39.392" class="difflineminus">-      nsCAutoString leafName;</span>
<a href="#l39.393"></a><span id="l39.393" class="difflineminus">-      rv = dbPath-&gt;GetNativeLeafName(leafName);</span>
<a href="#l39.394"></a><span id="l39.394" class="difflineminus">-      if (NS_FAILED(rv))</span>
<a href="#l39.395"></a><span id="l39.395" class="difflineminus">-        IMPORT_LOG0( &quot;*** Error: Unable to get name of database file\n&quot;);</span>
<a href="#l39.396"></a><span id="l39.396" class="difflineminus">-      else</span>
<a href="#l39.397"></a><span id="l39.397" class="difflineminus">-      {</span>
<a href="#l39.398"></a><span id="l39.398" class="difflineminus">-        URI.Append(leafName);</span>
<a href="#l39.399"></a><span id="l39.399" class="difflineminus">-        rv = parentDir-&gt;CreateDirectoryByURI(nsDependentString(name), URI);</span>
<a href="#l39.400"></a><span id="l39.400" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l39.401"></a><span id="l39.401" class="difflineminus">-          IMPORT_LOG0( &quot;*** Error: Unable to create address book directory\n&quot;);</span>
<a href="#l39.402"></a><span id="l39.402" class="difflineminus">-      }</span>
<a href="#l39.403"></a><span id="l39.403" class="difflineminus">-    }</span>
<a href="#l39.404"></a><span id="l39.404" class="difflineminus">-</span>
<a href="#l39.405"></a><span id="l39.405" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l39.406"></a><span id="l39.406" class="difflineminus">-      IMPORT_LOG0( &quot;Added new address book to the UI\n&quot;);</span>
<a href="#l39.407"></a><span id="l39.407" class="difflineminus">-    else</span>
<a href="#l39.408"></a><span id="l39.408" class="difflineminus">-      IMPORT_LOG0( &quot;*** Error: An error occurred while adding the address book to the UI\n&quot;);</span>
<a href="#l39.409"></a><span id="l39.409" class="difflineminus">-  }</span>
<a href="#l39.410"></a><span id="l39.410" class="difflineminus">-</span>
<a href="#l39.411"></a><span id="l39.411" class="difflineminus">-  return pDatabase;</span>
<a href="#l39.412"></a><span id="l39.412" class="difflineminus">-}</span>
<a href="#l39.413"></a><span id="l39.413" class="difflineminus">-</span>
<a href="#l39.414"></a><span id="l39.414"> void nsImportGenericAddressBooks::ReportError(const PRUnichar *pName,</span>
<a href="#l39.415"></a><span id="l39.415">                                               nsString *pStream,</span>
<a href="#l39.416"></a><span id="l39.416">                                               nsIStringBundle* aBundle)</span>
<a href="#l39.417"></a><span id="l39.417"> {</span>
<a href="#l39.418"></a><span id="l39.418">   if (!pStream)</span>
<a href="#l39.419"></a><span id="l39.419">     return;</span>
<a href="#l39.420"></a><span id="l39.420">   // load the error string</span>
<a href="#l39.421"></a><span id="l39.421">   PRUnichar *pFmt = nsImportStringBundle::GetStringByID( IMPORT_ERROR_GETABOOK, aBundle);</span>
<a href="#l39.422"></a><span id="l39.422" class="difflineat">@@ -943,22 +908,19 @@ void nsImportGenericAddressBooks::Report</span>
<a href="#l39.423"></a><span id="l39.423"> </span>
<a href="#l39.424"></a><span id="l39.424"> static void ImportAddressThread( void *stuff)</span>
<a href="#l39.425"></a><span id="l39.425"> {</span>
<a href="#l39.426"></a><span id="l39.426">   IMPORT_LOG0( &quot;In Begin ImportAddressThread\n&quot;);</span>
<a href="#l39.427"></a><span id="l39.427"> </span>
<a href="#l39.428"></a><span id="l39.428">   AddressThreadData *pData = (AddressThreadData *)stuff;</span>
<a href="#l39.429"></a><span id="l39.429">   PRUint32  count = 0;</span>
<a href="#l39.430"></a><span id="l39.430">   nsresult   rv = pData-&gt;books-&gt;Count( &amp;count);</span>
<a href="#l39.431"></a><span id="l39.431" class="difflineminus">-</span>
<a href="#l39.432"></a><span id="l39.432">   PRUint32          i;</span>
<a href="#l39.433"></a><span id="l39.433">   PRBool            import;</span>
<a href="#l39.434"></a><span id="l39.434">   PRUint32          size;</span>
<a href="#l39.435"></a><span id="l39.435" class="difflineminus">-  nsCOMPtr&lt;nsIAddrDatabase&gt;  destDB( getter_AddRefs( GetAddressBookFromUri( pData-&gt;pDestinationUri)));</span>
<a href="#l39.436"></a><span id="l39.436" class="difflineminus">-  nsCOMPtr&lt;nsIAddrDatabase&gt; pDestDB;</span>
<a href="#l39.437"></a><span id="l39.437"> </span>
<a href="#l39.438"></a><span id="l39.438">   nsString          success;</span>
<a href="#l39.439"></a><span id="l39.439">   nsString          error;</span>
<a href="#l39.440"></a><span id="l39.440"> </span>
<a href="#l39.441"></a><span id="l39.441">     nsCOMPtr&lt;nsIStringBundle&gt; pBundle;</span>
<a href="#l39.442"></a><span id="l39.442">     rv = nsImportStringBundle::GetStringBundleProxy(pData-&gt;stringBundle, getter_AddRefs(pBundle));</span>
<a href="#l39.443"></a><span id="l39.443">     if (NS_FAILED(rv))</span>
<a href="#l39.444"></a><span id="l39.444">     {</span>
<a href="#l39.445"></a><span id="l39.445" class="difflineat">@@ -974,32 +936,28 @@ static void ImportAddressThread( void *s</span>
<a href="#l39.446"></a><span id="l39.446">       size = 0;</span>
<a href="#l39.447"></a><span id="l39.447">       rv = book-&gt;GetImport( &amp;import);</span>
<a href="#l39.448"></a><span id="l39.448">       if (import)</span>
<a href="#l39.449"></a><span id="l39.449">         rv = book-&gt;GetSize( &amp;size);</span>
<a href="#l39.450"></a><span id="l39.450"> </span>
<a href="#l39.451"></a><span id="l39.451">       if (size &amp;&amp; import) {</span>
<a href="#l39.452"></a><span id="l39.452">         nsString name;</span>
<a href="#l39.453"></a><span id="l39.453">         book-&gt;GetPreferredName(name);</span>
<a href="#l39.454"></a><span id="l39.454" class="difflineminus">-        if (destDB) {</span>
<a href="#l39.455"></a><span id="l39.455" class="difflineminus">-          pDestDB = destDB;</span>
<a href="#l39.456"></a><span id="l39.456" class="difflineminus">-        }</span>
<a href="#l39.457"></a><span id="l39.457" class="difflineminus">-        else {</span>
<a href="#l39.458"></a><span id="l39.458" class="difflineminus">-          pDestDB = GetAddressBook(name.get(), PR_TRUE);</span>
<a href="#l39.459"></a><span id="l39.459" class="difflineminus">-        }</span>
<a href="#l39.460"></a><span id="l39.460" class="difflineplus">+</span>
<a href="#l39.461"></a><span id="l39.461" class="difflineplus">+        nsCOMPtr&lt;nsIAddrDatabase&gt; db = pData-&gt;dBs-&gt;ObjectAt(i);</span>
<a href="#l39.462"></a><span id="l39.462"> </span>
<a href="#l39.463"></a><span id="l39.463">         nsCOMPtr&lt;nsIProxyObjectManager&gt; proxyObjectManager =</span>
<a href="#l39.464"></a><span id="l39.464">           do_GetService(NS_XPCOMPROXY_CONTRACTID, &amp;rv);</span>
<a href="#l39.465"></a><span id="l39.465">         if (NS_FAILED(rv))</span>
<a href="#l39.466"></a><span id="l39.466">           return;</span>
<a href="#l39.467"></a><span id="l39.467"> </span>
<a href="#l39.468"></a><span id="l39.468">         nsCOMPtr&lt;nsIAddrDatabase&gt; proxyAddrDatabase;</span>
<a href="#l39.469"></a><span id="l39.469">         rv = proxyObjectManager-&gt;GetProxyForObject(NS_PROXY_TO_MAIN_THREAD,</span>
<a href="#l39.470"></a><span id="l39.470">                                                    NS_GET_IID(nsIAddrDatabase),</span>
<a href="#l39.471"></a><span id="l39.471" class="difflineminus">-                                                   pDestDB,</span>
<a href="#l39.472"></a><span id="l39.472" class="difflineplus">+                                                   db,</span>
<a href="#l39.473"></a><span id="l39.473">                                                    NS_PROXY_SYNC | NS_PROXY_ALWAYS,</span>
<a href="#l39.474"></a><span id="l39.474">                                                    getter_AddRefs(proxyAddrDatabase));</span>
<a href="#l39.475"></a><span id="l39.475">         if (NS_FAILED(rv))</span>
<a href="#l39.476"></a><span id="l39.476">           return;</span>
<a href="#l39.477"></a><span id="l39.477"> </span>
<a href="#l39.478"></a><span id="l39.478"> </span>
<a href="#l39.479"></a><span id="l39.479">         PRBool fatalError = PR_FALSE;</span>
<a href="#l39.480"></a><span id="l39.480">         pData-&gt;currentSize = size;</span>
<a href="#l39.481"></a><span id="l39.481" class="difflineat">@@ -1050,20 +1008,16 @@ static void ImportAddressThread( void *s</span>
<a href="#l39.482"></a><span id="l39.482">         }</span>
<a href="#l39.483"></a><span id="l39.483"> </span>
<a href="#l39.484"></a><span id="l39.484">         if (fatalError) {</span>
<a href="#l39.485"></a><span id="l39.485">           pData-&gt;fatalError = PR_TRUE;</span>
<a href="#l39.486"></a><span id="l39.486">           break;</span>
<a href="#l39.487"></a><span id="l39.487">         }</span>
<a href="#l39.488"></a><span id="l39.488">       }</span>
<a href="#l39.489"></a><span id="l39.489">     }</span>
<a href="#l39.490"></a><span id="l39.490" class="difflineminus">-</span>
<a href="#l39.491"></a><span id="l39.491" class="difflineminus">-    if (destDB) {</span>
<a href="#l39.492"></a><span id="l39.492" class="difflineminus">-      destDB-&gt;Close( PR_TRUE);</span>
<a href="#l39.493"></a><span id="l39.493" class="difflineminus">-    }</span>
<a href="#l39.494"></a><span id="l39.494">   }</span>
<a href="#l39.495"></a><span id="l39.495"> </span>
<a href="#l39.496"></a><span id="l39.496"> </span>
<a href="#l39.497"></a><span id="l39.497">   nsImportGenericAddressBooks::SetLogs( success, error, pData-&gt;successLog, pData-&gt;errorLog);</span>
<a href="#l39.498"></a><span id="l39.498"> </span>
<a href="#l39.499"></a><span id="l39.499">   if (pData-&gt;abort || pData-&gt;fatalError) {</span>
<a href="#l39.500"></a><span id="l39.500">     // FIXME: do what is necessary to get rid of what has been imported so far.</span>
<a href="#l39.501"></a><span id="l39.501">     // Nothing if we went into an existing address book!  Otherwise, delete</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

