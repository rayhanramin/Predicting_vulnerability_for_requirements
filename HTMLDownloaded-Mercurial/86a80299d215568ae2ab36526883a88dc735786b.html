<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 27709:86a80299d215568ae2ab36526883a88dc735786b</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 86a80299d215568ae2ab36526883a88dc735786b" />
<meta property="og:url" content="/comm-central/rev/86a80299d215568ae2ab36526883a88dc735786b" />
<meta property="og:description" content="Bug 420506 - Remove RDF code forked in bug 1459748 and mailnews/base/src/nsMsgRDFUtils.{cpp|h}. r=jorgk" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 86a80299d215568ae2ab36526883a88dc735786b 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/86a80299d215568ae2ab36526883a88dc735786b">shortlog</a> |
<a href="/comm-central/log/86a80299d215568ae2ab36526883a88dc735786b">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/86a80299d215568ae2ab36526883a88dc735786b">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/86a80299d215568ae2ab36526883a88dc735786b">files</a> |
changeset |
<a href="/comm-central/raw-rev/86a80299d215568ae2ab36526883a88dc735786b">raw</a>  | <a href="/comm-central/archive/86a80299d215568ae2ab36526883a88dc735786b.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=420506">Bug 420506</a> - Remove RDF code forked in <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1459748">bug 1459748</a> and mailnews/base/src/nsMsgRDFUtils.{cpp|h}. r=jorgk
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#66;&#101;&#110;&#32;&#67;&#97;&#109;&#112;&#98;&#101;&#108;&#108;&#32;&#60;&#98;&#101;&#110;&#99;&#64;&#116;&#104;&#117;&#110;&#100;&#101;&#114;&#98;&#105;&#114;&#100;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Tue, 24 Sep 2019 18:32:29 +1200</td></tr>

<tr>
 <td>changeset 27709</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/86a80299d215568ae2ab36526883a88dc735786b">86a80299d215568ae2ab36526883a88dc735786b</a></td>
</tr>



<tr>
<td>parent 27708</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/62176929a3c9aebc346b044da5caa233845b5f76">62176929a3c9aebc346b044da5caa233845b5f76</a>
</td>
</tr>

<tr>
<td>child 27710</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/e0bb49101c46d8713912a7d934d8114bd2f0017e">e0bb49101c46d8713912a7d934d8114bd2f0017e</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=86a80299d215568ae2ab36526883a88dc735786b">16455</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Wed, 25 Sep 2019 07:08:15 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@e0bb49101c46 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=e0bb49101c46d8713912a7d934d8114bd2f0017e">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=e0bb49101c46d8713912a7d934d8114bd2f0017e&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=e0bb49101c46d8713912a7d934d8114bd2f0017e&newProject=comm-central&newRevision=1fec6625cb317ef1f2bee10a9099cbe946331170&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=e0bb49101c46d8713912a7d934d8114bd2f0017e&newProject=comm-central&newRevision=1fec6625cb317ef1f2bee10a9099cbe946331170&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=e0bb49101c46d8713912a7d934d8114bd2f0017e&newProject=comm-central&newRevision=1fec6625cb317ef1f2bee10a9099cbe946331170&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28jorgk%29&revcount=50">jorgk</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=420506">420506</a>, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1459748">1459748</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=420506">Bug 420506</a> - Remove RDF code forked in <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1459748">bug 1459748</a> and mailnews/base/src/nsMsgRDFUtils.{cpp|h}. r=jorgk</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/mailnews/base/src/nsMsgRDFUtils.cpp">mailnews/base/src/nsMsgRDFUtils.cpp</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/mailnews/base/src/nsMsgRDFUtils.cpp">diff</a> |
<a href="/comm-central/comparison/86a80299d215568ae2ab36526883a88dc735786b/mailnews/base/src/nsMsgRDFUtils.cpp">comparison</a> |
<a href="/comm-central/log/86a80299d215568ae2ab36526883a88dc735786b/mailnews/base/src/nsMsgRDFUtils.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/mailnews/base/src/nsMsgRDFUtils.h">mailnews/base/src/nsMsgRDFUtils.h</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/mailnews/base/src/nsMsgRDFUtils.h">diff</a> |
<a href="/comm-central/comparison/86a80299d215568ae2ab36526883a88dc735786b/mailnews/base/src/nsMsgRDFUtils.h">comparison</a> |
<a href="/comm-central/log/86a80299d215568ae2ab36526883a88dc735786b/mailnews/base/src/nsMsgRDFUtils.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/moz.build">rdf/base/moz.build</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/moz.build">diff</a> |
<a href="/comm-central/comparison/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/moz.build">comparison</a> |
<a href="/comm-central/log/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/moz.build">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsCompositeDataSource.cpp">rdf/base/nsCompositeDataSource.cpp</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsCompositeDataSource.cpp">diff</a> |
<a href="/comm-central/comparison/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsCompositeDataSource.cpp">comparison</a> |
<a href="/comm-central/log/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsCompositeDataSource.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsContainerEnumerator.cpp">rdf/base/nsContainerEnumerator.cpp</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsContainerEnumerator.cpp">diff</a> |
<a href="/comm-central/comparison/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsContainerEnumerator.cpp">comparison</a> |
<a href="/comm-central/log/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsContainerEnumerator.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsDefaultResourceFactory.cpp">rdf/base/nsDefaultResourceFactory.cpp</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsDefaultResourceFactory.cpp">diff</a> |
<a href="/comm-central/comparison/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsDefaultResourceFactory.cpp">comparison</a> |
<a href="/comm-central/log/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsDefaultResourceFactory.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFCompositeDataSource.idl">rdf/base/nsIRDFCompositeDataSource.idl</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFCompositeDataSource.idl">diff</a> |
<a href="/comm-central/comparison/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFCompositeDataSource.idl">comparison</a> |
<a href="/comm-central/log/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFCompositeDataSource.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFContainer.idl">rdf/base/nsIRDFContainer.idl</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFContainer.idl">diff</a> |
<a href="/comm-central/comparison/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFContainer.idl">comparison</a> |
<a href="/comm-central/log/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFContainer.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFContainerUtils.idl">rdf/base/nsIRDFContainerUtils.idl</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFContainerUtils.idl">diff</a> |
<a href="/comm-central/comparison/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFContainerUtils.idl">comparison</a> |
<a href="/comm-central/log/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFContainerUtils.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFContentSink.h">rdf/base/nsIRDFContentSink.h</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFContentSink.h">diff</a> |
<a href="/comm-central/comparison/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFContentSink.h">comparison</a> |
<a href="/comm-central/log/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFContentSink.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFDataSource.idl">rdf/base/nsIRDFDataSource.idl</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFDataSource.idl">diff</a> |
<a href="/comm-central/comparison/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFDataSource.idl">comparison</a> |
<a href="/comm-central/log/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFDataSource.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFDelegateFactory.idl">rdf/base/nsIRDFDelegateFactory.idl</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFDelegateFactory.idl">diff</a> |
<a href="/comm-central/comparison/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFDelegateFactory.idl">comparison</a> |
<a href="/comm-central/log/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFDelegateFactory.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFInMemoryDataSource.idl">rdf/base/nsIRDFInMemoryDataSource.idl</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFInMemoryDataSource.idl">diff</a> |
<a href="/comm-central/comparison/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFInMemoryDataSource.idl">comparison</a> |
<a href="/comm-central/log/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFInMemoryDataSource.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFInferDataSource.idl">rdf/base/nsIRDFInferDataSource.idl</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFInferDataSource.idl">diff</a> |
<a href="/comm-central/comparison/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFInferDataSource.idl">comparison</a> |
<a href="/comm-central/log/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFInferDataSource.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFLiteral.idl">rdf/base/nsIRDFLiteral.idl</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFLiteral.idl">diff</a> |
<a href="/comm-central/comparison/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFLiteral.idl">comparison</a> |
<a href="/comm-central/log/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFLiteral.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFNode.idl">rdf/base/nsIRDFNode.idl</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFNode.idl">diff</a> |
<a href="/comm-central/comparison/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFNode.idl">comparison</a> |
<a href="/comm-central/log/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFNode.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFObserver.idl">rdf/base/nsIRDFObserver.idl</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFObserver.idl">diff</a> |
<a href="/comm-central/comparison/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFObserver.idl">comparison</a> |
<a href="/comm-central/log/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFObserver.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFPropagatableDataSource.idl">rdf/base/nsIRDFPropagatableDataSource.idl</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFPropagatableDataSource.idl">diff</a> |
<a href="/comm-central/comparison/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFPropagatableDataSource.idl">comparison</a> |
<a href="/comm-central/log/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFPropagatableDataSource.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFPurgeableDataSource.idl">rdf/base/nsIRDFPurgeableDataSource.idl</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFPurgeableDataSource.idl">diff</a> |
<a href="/comm-central/comparison/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFPurgeableDataSource.idl">comparison</a> |
<a href="/comm-central/log/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFPurgeableDataSource.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFRemoteDataSource.idl">rdf/base/nsIRDFRemoteDataSource.idl</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFRemoteDataSource.idl">diff</a> |
<a href="/comm-central/comparison/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFRemoteDataSource.idl">comparison</a> |
<a href="/comm-central/log/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFRemoteDataSource.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFResource.idl">rdf/base/nsIRDFResource.idl</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFResource.idl">diff</a> |
<a href="/comm-central/comparison/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFResource.idl">comparison</a> |
<a href="/comm-central/log/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFResource.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFService.idl">rdf/base/nsIRDFService.idl</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFService.idl">diff</a> |
<a href="/comm-central/comparison/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFService.idl">comparison</a> |
<a href="/comm-central/log/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFService.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFXMLParser.idl">rdf/base/nsIRDFXMLParser.idl</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFXMLParser.idl">diff</a> |
<a href="/comm-central/comparison/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFXMLParser.idl">comparison</a> |
<a href="/comm-central/log/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFXMLParser.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFXMLSerializer.idl">rdf/base/nsIRDFXMLSerializer.idl</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFXMLSerializer.idl">diff</a> |
<a href="/comm-central/comparison/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFXMLSerializer.idl">comparison</a> |
<a href="/comm-central/log/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFXMLSerializer.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFXMLSink.idl">rdf/base/nsIRDFXMLSink.idl</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFXMLSink.idl">diff</a> |
<a href="/comm-central/comparison/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFXMLSink.idl">comparison</a> |
<a href="/comm-central/log/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFXMLSink.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFXMLSource.idl">rdf/base/nsIRDFXMLSource.idl</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFXMLSource.idl">diff</a> |
<a href="/comm-central/comparison/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFXMLSource.idl">comparison</a> |
<a href="/comm-central/log/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsIRDFXMLSource.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsInMemoryDataSource.cpp">rdf/base/nsInMemoryDataSource.cpp</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsInMemoryDataSource.cpp">diff</a> |
<a href="/comm-central/comparison/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsInMemoryDataSource.cpp">comparison</a> |
<a href="/comm-central/log/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsInMemoryDataSource.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsNameSpaceMap.cpp">rdf/base/nsNameSpaceMap.cpp</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsNameSpaceMap.cpp">diff</a> |
<a href="/comm-central/comparison/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsNameSpaceMap.cpp">comparison</a> |
<a href="/comm-central/log/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsNameSpaceMap.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsNameSpaceMap.h">rdf/base/nsNameSpaceMap.h</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsNameSpaceMap.h">diff</a> |
<a href="/comm-central/comparison/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsNameSpaceMap.h">comparison</a> |
<a href="/comm-central/log/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsNameSpaceMap.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsRDFBaseDataSources.h">rdf/base/nsRDFBaseDataSources.h</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsRDFBaseDataSources.h">diff</a> |
<a href="/comm-central/comparison/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsRDFBaseDataSources.h">comparison</a> |
<a href="/comm-central/log/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsRDFBaseDataSources.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsRDFContainer.cpp">rdf/base/nsRDFContainer.cpp</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsRDFContainer.cpp">diff</a> |
<a href="/comm-central/comparison/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsRDFContainer.cpp">comparison</a> |
<a href="/comm-central/log/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsRDFContainer.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsRDFContainerUtils.cpp">rdf/base/nsRDFContainerUtils.cpp</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsRDFContainerUtils.cpp">diff</a> |
<a href="/comm-central/comparison/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsRDFContainerUtils.cpp">comparison</a> |
<a href="/comm-central/log/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsRDFContainerUtils.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsRDFContentSink.cpp">rdf/base/nsRDFContentSink.cpp</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsRDFContentSink.cpp">diff</a> |
<a href="/comm-central/comparison/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsRDFContentSink.cpp">comparison</a> |
<a href="/comm-central/log/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsRDFContentSink.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsRDFResource.cpp">rdf/base/nsRDFResource.cpp</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsRDFResource.cpp">diff</a> |
<a href="/comm-central/comparison/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsRDFResource.cpp">comparison</a> |
<a href="/comm-central/log/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsRDFResource.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsRDFResource.h">rdf/base/nsRDFResource.h</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsRDFResource.h">diff</a> |
<a href="/comm-central/comparison/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsRDFResource.h">comparison</a> |
<a href="/comm-central/log/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsRDFResource.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsRDFService.cpp">rdf/base/nsRDFService.cpp</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsRDFService.cpp">diff</a> |
<a href="/comm-central/comparison/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsRDFService.cpp">comparison</a> |
<a href="/comm-central/log/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsRDFService.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsRDFService.h">rdf/base/nsRDFService.h</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsRDFService.h">diff</a> |
<a href="/comm-central/comparison/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsRDFService.h">comparison</a> |
<a href="/comm-central/log/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsRDFService.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsRDFXMLDataSource.cpp">rdf/base/nsRDFXMLDataSource.cpp</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsRDFXMLDataSource.cpp">diff</a> |
<a href="/comm-central/comparison/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsRDFXMLDataSource.cpp">comparison</a> |
<a href="/comm-central/log/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsRDFXMLDataSource.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsRDFXMLParser.cpp">rdf/base/nsRDFXMLParser.cpp</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsRDFXMLParser.cpp">diff</a> |
<a href="/comm-central/comparison/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsRDFXMLParser.cpp">comparison</a> |
<a href="/comm-central/log/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsRDFXMLParser.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsRDFXMLParser.h">rdf/base/nsRDFXMLParser.h</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsRDFXMLParser.h">diff</a> |
<a href="/comm-central/comparison/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsRDFXMLParser.h">comparison</a> |
<a href="/comm-central/log/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsRDFXMLParser.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsRDFXMLSerializer.cpp">rdf/base/nsRDFXMLSerializer.cpp</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsRDFXMLSerializer.cpp">diff</a> |
<a href="/comm-central/comparison/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsRDFXMLSerializer.cpp">comparison</a> |
<a href="/comm-central/log/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsRDFXMLSerializer.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsRDFXMLSerializer.h">rdf/base/nsRDFXMLSerializer.h</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsRDFXMLSerializer.h">diff</a> |
<a href="/comm-central/comparison/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsRDFXMLSerializer.h">comparison</a> |
<a href="/comm-central/log/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/nsRDFXMLSerializer.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/rdf.h">rdf/base/rdf.h</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/rdf.h">diff</a> |
<a href="/comm-central/comparison/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/rdf.h">comparison</a> |
<a href="/comm-central/log/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/rdf.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/rdfIDataSource.idl">rdf/base/rdfIDataSource.idl</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/rdfIDataSource.idl">diff</a> |
<a href="/comm-central/comparison/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/rdfIDataSource.idl">comparison</a> |
<a href="/comm-central/log/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/rdfIDataSource.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/rdfITripleVisitor.idl">rdf/base/rdfITripleVisitor.idl</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/rdfITripleVisitor.idl">diff</a> |
<a href="/comm-central/comparison/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/rdfITripleVisitor.idl">comparison</a> |
<a href="/comm-central/log/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/rdfITripleVisitor.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/rdfutil.cpp">rdf/base/rdfutil.cpp</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/rdfutil.cpp">diff</a> |
<a href="/comm-central/comparison/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/rdfutil.cpp">comparison</a> |
<a href="/comm-central/log/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/rdfutil.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/rdfutil.h">rdf/base/rdfutil.h</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/rdfutil.h">diff</a> |
<a href="/comm-central/comparison/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/rdfutil.h">comparison</a> |
<a href="/comm-central/log/86a80299d215568ae2ab36526883a88dc735786b/rdf/base/rdfutil.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/build/moz.build">rdf/build/moz.build</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/build/moz.build">diff</a> |
<a href="/comm-central/comparison/86a80299d215568ae2ab36526883a88dc735786b/rdf/build/moz.build">comparison</a> |
<a href="/comm-central/log/86a80299d215568ae2ab36526883a88dc735786b/rdf/build/moz.build">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/build/nsRDFCID.h">rdf/build/nsRDFCID.h</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/build/nsRDFCID.h">diff</a> |
<a href="/comm-central/comparison/86a80299d215568ae2ab36526883a88dc735786b/rdf/build/nsRDFCID.h">comparison</a> |
<a href="/comm-central/log/86a80299d215568ae2ab36526883a88dc735786b/rdf/build/nsRDFCID.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/build/nsRDFModule.cpp">rdf/build/nsRDFModule.cpp</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/build/nsRDFModule.cpp">diff</a> |
<a href="/comm-central/comparison/86a80299d215568ae2ab36526883a88dc735786b/rdf/build/nsRDFModule.cpp">comparison</a> |
<a href="/comm-central/log/86a80299d215568ae2ab36526883a88dc735786b/rdf/build/nsRDFModule.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/datasource/moz.build">rdf/datasource/moz.build</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/datasource/moz.build">diff</a> |
<a href="/comm-central/comparison/86a80299d215568ae2ab36526883a88dc735786b/rdf/datasource/moz.build">comparison</a> |
<a href="/comm-central/log/86a80299d215568ae2ab36526883a88dc735786b/rdf/datasource/moz.build">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/datasource/nsILocalStore.h">rdf/datasource/nsILocalStore.h</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/datasource/nsILocalStore.h">diff</a> |
<a href="/comm-central/comparison/86a80299d215568ae2ab36526883a88dc735786b/rdf/datasource/nsILocalStore.h">comparison</a> |
<a href="/comm-central/log/86a80299d215568ae2ab36526883a88dc735786b/rdf/datasource/nsILocalStore.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/datasource/nsIRDFFTP.h">rdf/datasource/nsIRDFFTP.h</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/datasource/nsIRDFFTP.h">diff</a> |
<a href="/comm-central/comparison/86a80299d215568ae2ab36526883a88dc735786b/rdf/datasource/nsIRDFFTP.h">comparison</a> |
<a href="/comm-central/log/86a80299d215568ae2ab36526883a88dc735786b/rdf/datasource/nsIRDFFTP.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/datasource/nsLocalStore.cpp">rdf/datasource/nsLocalStore.cpp</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/datasource/nsLocalStore.cpp">diff</a> |
<a href="/comm-central/comparison/86a80299d215568ae2ab36526883a88dc735786b/rdf/datasource/nsLocalStore.cpp">comparison</a> |
<a href="/comm-central/log/86a80299d215568ae2ab36526883a88dc735786b/rdf/datasource/nsLocalStore.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/datasource/nsRDFBuiltInDataSources.h">rdf/datasource/nsRDFBuiltInDataSources.h</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/datasource/nsRDFBuiltInDataSources.h">diff</a> |
<a href="/comm-central/comparison/86a80299d215568ae2ab36526883a88dc735786b/rdf/datasource/nsRDFBuiltInDataSources.h">comparison</a> |
<a href="/comm-central/log/86a80299d215568ae2ab36526883a88dc735786b/rdf/datasource/nsRDFBuiltInDataSources.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/moz.build">rdf/moz.build</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/86a80299d215568ae2ab36526883a88dc735786b/rdf/moz.build">diff</a> |
<a href="/comm-central/comparison/86a80299d215568ae2ab36526883a88dc735786b/rdf/moz.build">comparison</a> |
<a href="/comm-central/log/86a80299d215568ae2ab36526883a88dc735786b/rdf/moz.build">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1">deleted file mode 100644</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineminus">--- a/mailnews/base/src/nsMsgRDFUtils.cpp</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineplus">+++ /dev/null</span>
<a href="#l1.4"></a><span id="l1.4" class="difflineat">@@ -1,77 +0,0 @@</span>
<a href="#l1.5"></a><span id="l1.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l1.6"></a><span id="l1.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l1.7"></a><span id="l1.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l1.8"></a><span id="l1.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l1.9"></a><span id="l1.9" class="difflineminus">-#include &quot;nsMsgRDFUtils.h&quot;</span>
<a href="#l1.10"></a><span id="l1.10" class="difflineminus">-#include &quot;nsIServiceManager.h&quot;</span>
<a href="#l1.11"></a><span id="l1.11" class="difflineminus">-#include &quot;prprf.h&quot;</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-#include &quot;nsMemory.h&quot;</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineminus">-nsresult createNode(const char16_t *str, nsIRDFNode **node,</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineminus">-                    nsIRDFService *rdfService) {</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineminus">-  nsresult rv;</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineminus">-  nsCOMPtr&lt;nsIRDFLiteral&gt; value;</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineminus">-</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineminus">-  NS_ASSERTION(rdfService, &quot;rdfService is null&quot;);</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineminus">-  if (!rdfService) return NS_OK;</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineminus">-</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineminus">-  if (str) {</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineminus">-    rv = rdfService-&gt;GetLiteral(str, getter_AddRefs(value));</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineminus">-  } else {</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineminus">-    rv = rdfService-&gt;GetLiteral(EmptyString().get(), getter_AddRefs(value));</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineminus">-  }</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineminus">-</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineminus">-  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineminus">-    value.forget(node);</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-  }</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineminus">-  return rv;</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineminus">-}</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineminus">-</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineminus">-nsresult createIntNode(int32_t value, nsIRDFNode **node,</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineminus">-                       nsIRDFService *rdfService) {</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineminus">-  *node = nullptr;</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineminus">-  nsresult rv;</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineminus">-  if (!rdfService) return NS_ERROR_NULL_POINTER;</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineminus">-  nsCOMPtr&lt;nsIRDFInt&gt; num;</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineminus">-  rv = rdfService-&gt;GetIntLiteral(value, getter_AddRefs(num));</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineminus">-  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineminus">-    num.forget(node);</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineminus">-  }</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineminus">-  return rv;</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineminus">-}</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineminus">-</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineminus">-nsresult createBlobNode(uint8_t *value, uint32_t &amp;length, nsIRDFNode **node,</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineminus">-                        nsIRDFService *rdfService) {</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineminus">-  NS_ENSURE_ARG_POINTER(node);</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineminus">-  NS_ENSURE_ARG_POINTER(rdfService);</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineminus">-</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineminus">-  *node = nullptr;</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineminus">-  nsCOMPtr&lt;nsIRDFBlob&gt; blob;</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineminus">-  nsresult rv = rdfService-&gt;GetBlobLiteral(value, length, getter_AddRefs(blob));</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineminus">-  blob.forget(node);</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineminus">-  return rv;</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineminus">-}</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineminus">-</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineminus">-nsresult GetTargetHasAssertion(nsIRDFDataSource *dataSource,</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineminus">-                               nsIRDFResource *folderResource,</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineminus">-                               nsIRDFResource *property, bool tv,</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineminus">-                               nsIRDFNode *target, bool *hasAssertion) {</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineminus">-  NS_ENSURE_ARG_POINTER(hasAssertion);</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineminus">-</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineminus">-  nsCOMPtr&lt;nsIRDFNode&gt; currentTarget;</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineminus">-</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineminus">-  nsresult rv = dataSource-&gt;GetTarget(folderResource, property, tv,</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineminus">-                                      getter_AddRefs(currentTarget));</span>
<a href="#l1.71"></a><span id="l1.71" class="difflineminus">-  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l1.72"></a><span id="l1.72" class="difflineminus">-    nsCOMPtr&lt;nsIRDFLiteral&gt; value1(do_QueryInterface(target));</span>
<a href="#l1.73"></a><span id="l1.73" class="difflineminus">-    nsCOMPtr&lt;nsIRDFLiteral&gt; value2(do_QueryInterface(currentTarget));</span>
<a href="#l1.74"></a><span id="l1.74" class="difflineminus">-    if (value1 &amp;&amp; value2)</span>
<a href="#l1.75"></a><span id="l1.75" class="difflineminus">-      // If the two values are equal then it has this assertion</span>
<a href="#l1.76"></a><span id="l1.76" class="difflineminus">-      *hasAssertion = (value1 == value2);</span>
<a href="#l1.77"></a><span id="l1.77" class="difflineminus">-  } else</span>
<a href="#l1.78"></a><span id="l1.78" class="difflineminus">-    rv = NS_NOINTERFACE;</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineminus">-</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineminus">-  return rv;</span>
<a href="#l1.81"></a><span id="l1.81" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1">deleted file mode 100644</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineminus">--- a/mailnews/base/src/nsMsgRDFUtils.h</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineplus">+++ /dev/null</span>
<a href="#l2.4"></a><span id="l2.4" class="difflineat">@@ -1,109 +0,0 @@</span>
<a href="#l2.5"></a><span id="l2.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l2.6"></a><span id="l2.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l2.7"></a><span id="l2.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l2.8"></a><span id="l2.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l2.9"></a><span id="l2.9" class="difflineminus">-</span>
<a href="#l2.10"></a><span id="l2.10" class="difflineminus">-// This file holds some useful utility functions and declarations used by our</span>
<a href="#l2.11"></a><span id="l2.11" class="difflineminus">-// datasources.</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-#include &quot;rdf.h&quot;</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-#include &quot;nsIRDFResource.h&quot;</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineminus">-#include &quot;nsIRDFNode.h&quot;</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineminus">-#include &quot;nsIRDFDataSource.h&quot;</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineminus">-#include &quot;nsIRDFService.h&quot;</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineminus">-#include &quot;nsString.h&quot;</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineminus">-</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineminus">-// this is used for notification of observers using nsVoidArray</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineminus">-typedef struct _nsMsgRDFNotification {</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineminus">-  nsIRDFDataSource *datasource;</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineminus">-  nsIRDFResource *subject;</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineminus">-  nsIRDFResource *property;</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineminus">-  nsIRDFNode *newObject;</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineminus">-  nsIRDFNode *oldObject;</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineminus">-} nsMsgRDFNotification;</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineminus">-</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineminus">-// clang-format off</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineminus">-// Some property declarations</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-#define NC_RDF_CHILD                        NC_NAMESPACE_URI &quot;child&quot;</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineminus">-#define NC_RDF_NAME                         NC_NAMESPACE_URI &quot;Name&quot;</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineminus">-#define NC_RDF_OPEN                         NC_NAMESPACE_URI &quot;open&quot;</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineminus">-#define NC_RDF_FOLDERTREENAME               NC_NAMESPACE_URI &quot;FolderTreeName&quot;</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineminus">-#define NC_RDF_FOLDERTREESIMPLENAME         NC_NAMESPACE_URI &quot;FolderTreeSimpleName&quot;</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineminus">-#define NC_RDF_FOLDER                       NC_NAMESPACE_URI &quot;Folder&quot;</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineminus">-#define NC_RDF_SPECIALFOLDER                NC_NAMESPACE_URI &quot;SpecialFolder&quot;</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineminus">-#define NC_RDF_SERVERTYPE                   NC_NAMESPACE_URI &quot;ServerType&quot;</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineminus">-#define NC_RDF_CANCREATEFOLDERSONSERVER     NC_NAMESPACE_URI &quot;CanCreateFoldersOnServer&quot;</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineminus">-#define NC_RDF_CANFILEMESSAGESONSERVER      NC_NAMESPACE_URI &quot;CanFileMessagesOnServer&quot;</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineminus">-#define NC_RDF_ISSERVER                     NC_NAMESPACE_URI &quot;IsServer&quot;</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineminus">-#define NC_RDF_ISSECURE                     NC_NAMESPACE_URI &quot;IsSecure&quot;</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineminus">-#define NC_RDF_CANSUBSCRIBE                 NC_NAMESPACE_URI &quot;CanSubscribe&quot;</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineminus">-#define NC_RDF_SUPPORTSOFFLINE              NC_NAMESPACE_URI &quot;SupportsOffline&quot;</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineminus">-#define NC_RDF_CANFILEMESSAGES              NC_NAMESPACE_URI &quot;CanFileMessages&quot;</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineminus">-#define NC_RDF_CANCREATESUBFOLDERS          NC_NAMESPACE_URI &quot;CanCreateSubfolders&quot;</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineminus">-#define NC_RDF_CANRENAME                    NC_NAMESPACE_URI &quot;CanRename&quot;</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineminus">-#define NC_RDF_CANCOMPACT                   NC_NAMESPACE_URI &quot;CanCompact&quot;</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineminus">-#define NC_RDF_TOTALMESSAGES                NC_NAMESPACE_URI &quot;TotalMessages&quot;</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineminus">-#define NC_RDF_TOTALUNREADMESSAGES          NC_NAMESPACE_URI &quot;TotalUnreadMessages&quot;</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineminus">-#define NC_RDF_FOLDERSIZE                   NC_NAMESPACE_URI &quot;FolderSize&quot;</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineminus">-#define NC_RDF_CHARSET                      NC_NAMESPACE_URI &quot;Charset&quot;</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineminus">-#define NC_RDF_BIFFSTATE                    NC_NAMESPACE_URI &quot;BiffState&quot;</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineminus">-#define NC_RDF_HASUNREADMESSAGES            NC_NAMESPACE_URI &quot;HasUnreadMessages&quot;</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineminus">-#define NC_RDF_SUBFOLDERSHAVEUNREADMESSAGES NC_NAMESPACE_URI &quot;SubfoldersHaveUnreadMessages&quot;</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineminus">-#define NC_RDF_NOSELECT                     NC_NAMESPACE_URI &quot;NoSelect&quot;</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineminus">-#define NC_RDF_VIRTUALFOLDER                NC_NAMESPACE_URI &quot;Virtual&quot;</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineminus">-#define NC_RDF_IMAPSHARED                   NC_NAMESPACE_URI &quot;ImapShared&quot;</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineminus">-#define NC_RDF_NEWMESSAGES                  NC_NAMESPACE_URI &quot;NewMessages&quot;</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineminus">-#define NC_RDF_SYNCHRONIZE                  NC_NAMESPACE_URI &quot;Synchronize&quot;</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineminus">-#define NC_RDF_SYNCDISABLED                 NC_NAMESPACE_URI &quot;SyncDisabled&quot;</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineminus">-#define NC_RDF_KEY                          NC_NAMESPACE_URI &quot;Key&quot;</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineminus">-#define NC_RDF_CANSEARCHMESSAGES            NC_NAMESPACE_URI &quot;CanSearchMessages&quot;</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineminus">-#define NC_RDF_ISDEFERRED                   NC_NAMESPACE_URI &quot;IsDeferred&quot;</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineminus">-</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineminus">-// Sort Properties</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineminus">-#define NC_RDF_SUBJECT_COLLATION_SORT       NC_NAMESPACE_URI &quot;Subject?collation=true&quot;</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineminus">-#define NC_RDF_SENDER_COLLATION_SORT        NC_NAMESPACE_URI &quot;Sender?collation=true&quot;</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineminus">-#define NC_RDF_RECIPIENT_COLLATION_SORT     NC_NAMESPACE_URI &quot;Recipient?collation=true&quot;</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineminus">-#define NC_RDF_ORDERRECEIVED_SORT           NC_NAMESPACE_URI &quot;OrderReceived?sort=true&quot;</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineminus">-#define NC_RDF_PRIORITY_SORT                NC_NAMESPACE_URI &quot;Priority?sort=true&quot;</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineminus">-#define NC_RDF_DATE_SORT                    NC_NAMESPACE_URI &quot;Date?sort=true&quot;</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineminus">-#define NC_RDF_SIZE_SORT                    NC_NAMESPACE_URI &quot;Size?sort=true&quot;</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineminus">-#define NC_RDF_ISUNREAD_SORT                NC_NAMESPACE_URI &quot;IsUnread?sort=true&quot;</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineminus">-#define NC_RDF_FLAGGED_SORT                 NC_NAMESPACE_URI &quot;Flagged?sort=true&quot;</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineminus">-</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineminus">-#define NC_RDF_NAME_SORT                    NC_NAMESPACE_URI &quot;Name?sort=true&quot;</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineminus">-#define NC_RDF_FOLDERTREENAME_SORT          NC_NAMESPACE_URI &quot;FolderTreeName?sort=true&quot;</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineminus">-</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineminus">-// Folder Commands</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineminus">-#define NC_RDF_DELETE                       NC_NAMESPACE_URI &quot;Delete&quot;</span>
<a href="#l2.82"></a><span id="l2.82" class="difflineminus">-#define NC_RDF_REALLY_DELETE                NC_NAMESPACE_URI &quot;ReallyDelete&quot;</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineminus">-#define NC_RDF_NEWFOLDER                    NC_NAMESPACE_URI &quot;NewFolder&quot;</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineminus">-#define NC_RDF_GETNEWMESSAGES               NC_NAMESPACE_URI &quot;GetNewMessages&quot;</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineminus">-#define NC_RDF_COPY                         NC_NAMESPACE_URI &quot;Copy&quot;</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineminus">-#define NC_RDF_MOVE                         NC_NAMESPACE_URI &quot;Move&quot;</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineminus">-#define NC_RDF_COPYFOLDER                   NC_NAMESPACE_URI &quot;CopyFolder&quot;</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineminus">-#define NC_RDF_MOVEFOLDER                   NC_NAMESPACE_URI &quot;MoveFolder&quot;</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineminus">-#define NC_RDF_MARKALLMESSAGESREAD          NC_NAMESPACE_URI &quot;MarkAllMessagesRead&quot;</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineminus">-#define NC_RDF_COMPACT                      NC_NAMESPACE_URI &quot;Compact&quot;</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineminus">-#define NC_RDF_COMPACTALL                   NC_NAMESPACE_URI &quot;CompactAll&quot;</span>
<a href="#l2.92"></a><span id="l2.92" class="difflineminus">-#define NC_RDF_RENAME                       NC_NAMESPACE_URI &quot;Rename&quot;</span>
<a href="#l2.93"></a><span id="l2.93" class="difflineminus">-#define NC_RDF_EMPTYTRASH                   NC_NAMESPACE_URI &quot;EmptyTrash&quot;</span>
<a href="#l2.94"></a><span id="l2.94" class="difflineminus">-// clang-format on</span>
<a href="#l2.95"></a><span id="l2.95" class="difflineminus">-</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineminus">-nsresult createNode(const char16_t *str, nsIRDFNode **,</span>
<a href="#l2.97"></a><span id="l2.97" class="difflineminus">-                    nsIRDFService *rdfService);</span>
<a href="#l2.98"></a><span id="l2.98" class="difflineminus">-</span>
<a href="#l2.99"></a><span id="l2.99" class="difflineminus">-// Given an int32_t creates an nsIRDFNode that is really an int literal.</span>
<a href="#l2.100"></a><span id="l2.100" class="difflineminus">-nsresult createIntNode(int32_t value, nsIRDFNode **node,</span>
<a href="#l2.101"></a><span id="l2.101" class="difflineminus">-                       nsIRDFService *rdfService);</span>
<a href="#l2.102"></a><span id="l2.102" class="difflineminus">-</span>
<a href="#l2.103"></a><span id="l2.103" class="difflineminus">-// Given an nsIRDFBlob creates an nsIRDFNode that is really an blob literal.</span>
<a href="#l2.104"></a><span id="l2.104" class="difflineminus">-nsresult createBlobNode(uint8_t *value, uint32_t &amp;length, nsIRDFNode **node,</span>
<a href="#l2.105"></a><span id="l2.105" class="difflineminus">-                        nsIRDFService *rdfService);</span>
<a href="#l2.106"></a><span id="l2.106" class="difflineminus">-</span>
<a href="#l2.107"></a><span id="l2.107" class="difflineminus">-// Assertion for a datasource that will just call GetTarget on property.  When</span>
<a href="#l2.108"></a><span id="l2.108" class="difflineminus">-// all of our datasources derive from our datasource baseclass, this should be</span>
<a href="#l2.109"></a><span id="l2.109" class="difflineminus">-// moved there and the first parameter will no longer be needed.</span>
<a href="#l2.110"></a><span id="l2.110" class="difflineminus">-nsresult GetTargetHasAssertion(nsIRDFDataSource *dataSource,</span>
<a href="#l2.111"></a><span id="l2.111" class="difflineminus">-                               nsIRDFResource *folderResource,</span>
<a href="#l2.112"></a><span id="l2.112" class="difflineminus">-                               nsIRDFResource *property, bool tv,</span>
<a href="#l2.113"></a><span id="l2.113" class="difflineminus">-                               nsIRDFNode *target, bool *hasAssertion);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1">deleted file mode 100644</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineminus">--- a/rdf/base/moz.build</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineplus">+++ /dev/null</span>
<a href="#l3.4"></a><span id="l3.4" class="difflineat">@@ -1,59 +0,0 @@</span>
<a href="#l3.5"></a><span id="l3.5" class="difflineminus">-# -*- Mode: python; indent-tabs-mode: nil; tab-width: 40 -*-</span>
<a href="#l3.6"></a><span id="l3.6" class="difflineminus">-# vim: set filetype=python:</span>
<a href="#l3.7"></a><span id="l3.7" class="difflineminus">-# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l3.8"></a><span id="l3.8" class="difflineminus">-# License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l3.9"></a><span id="l3.9" class="difflineminus">-# file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l3.10"></a><span id="l3.10" class="difflineminus">-</span>
<a href="#l3.11"></a><span id="l3.11" class="difflineminus">-XPIDL_SOURCES += [</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-    'nsIRDFCompositeDataSource.idl',</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-    'nsIRDFContainer.idl',</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-    'nsIRDFContainerUtils.idl',</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">-    'nsIRDFDataSource.idl',</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineminus">-    'nsIRDFDelegateFactory.idl',</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineminus">-    'nsIRDFInferDataSource.idl',</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineminus">-    'nsIRDFInMemoryDataSource.idl',</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineminus">-    'nsIRDFLiteral.idl',</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineminus">-    'nsIRDFNode.idl',</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineminus">-    'nsIRDFObserver.idl',</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineminus">-    'nsIRDFPropagatableDataSource.idl',</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineminus">-    'nsIRDFPurgeableDataSource.idl',</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineminus">-    'nsIRDFRemoteDataSource.idl',</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineminus">-    'nsIRDFResource.idl',</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineminus">-    'nsIRDFService.idl',</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineminus">-    'nsIRDFXMLParser.idl',</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineminus">-    'nsIRDFXMLSerializer.idl',</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineminus">-    'nsIRDFXMLSink.idl',</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineminus">-    'nsIRDFXMLSource.idl',</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineminus">-    'rdfIDataSource.idl',</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineminus">-    'rdfITripleVisitor.idl',</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineminus">-]</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineminus">-</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineminus">-XPIDL_MODULE = 'rdf'</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineminus">-</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineminus">-EXPORTS += [</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineminus">-    'nsIRDFContentSink.h',</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineminus">-    'nsRDFResource.h',</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineminus">-    'rdf.h',</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineminus">-]</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineminus">-</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineminus">-UNIFIED_SOURCES += [</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineminus">-    'nsCompositeDataSource.cpp',</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineminus">-    'nsContainerEnumerator.cpp',</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineminus">-    'nsDefaultResourceFactory.cpp',</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineminus">-    'nsInMemoryDataSource.cpp',</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineminus">-    'nsNameSpaceMap.cpp',</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineminus">-    'nsRDFContainer.cpp',</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineminus">-    'nsRDFContainerUtils.cpp',</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineminus">-    'nsRDFContentSink.cpp',</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineminus">-    'nsRDFResource.cpp',</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineminus">-    'nsRDFService.cpp',</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineminus">-    'nsRDFXMLDataSource.cpp',</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineminus">-    'nsRDFXMLParser.cpp',</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineminus">-    'nsRDFXMLSerializer.cpp',</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineminus">-    'rdfutil.cpp',</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineminus">-]</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineminus">-</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineminus">-FINAL_LIBRARY = 'xul'</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineminus">-</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineminus">-if CONFIG['CC_TYPE'] in ('clang', 'gcc'):</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineminus">-    CXXFLAGS += ['-Wno-error=shadow']</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1">deleted file mode 100644</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineminus">--- a/rdf/base/nsCompositeDataSource.cpp</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineplus">+++ /dev/null</span>
<a href="#l4.4"></a><span id="l4.4" class="difflineat">@@ -1,1355 +0,0 @@</span>
<a href="#l4.5"></a><span id="l4.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l4.6"></a><span id="l4.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l4.7"></a><span id="l4.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l4.8"></a><span id="l4.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l4.9"></a><span id="l4.9" class="difflineminus">-</span>
<a href="#l4.10"></a><span id="l4.10" class="difflineminus">-/*</span>
<a href="#l4.11"></a><span id="l4.11" class="difflineminus">-</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-  A simple composite data source implementation. A composit data</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-  source is just a strategy for combining individual data sources into</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">-  a collective graph.</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineminus">-</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineminus">-</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineminus">-  1) A composite data source holds a sequence of data sources. The set</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineminus">-     of data sources can be specified during creation of the</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineminus">-     database. Data sources can also be added/deleted from a database</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineminus">-     later.</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineminus">-</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineminus">-  2) The aggregation mechanism is based on simple super-positioning of</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineminus">-     the graphs from the datasources. If there is a conflict (i.e.,</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineminus">-     data source A has a true arc from foo to bar while data source B</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineminus">-     has a false arc from foo to bar), the data source that it earlier</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineminus">-     in the sequence wins.</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineminus">-</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineminus">-     The implementation below doesn't really do this and needs to be</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineminus">-     fixed.</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineminus">-</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineminus">-*/</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineminus">-</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineminus">-#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineminus">-#include &quot;nsIComponentManager.h&quot;</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineminus">-#include &quot;nsIRDFCompositeDataSource.h&quot;</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineminus">-#include &quot;nsIRDFNode.h&quot;</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineminus">-#include &quot;nsIRDFObserver.h&quot;</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineminus">-#include &quot;nsIRDFRemoteDataSource.h&quot;</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineminus">-#include &quot;nsTArray.h&quot;</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineminus">-#include &quot;nsCOMArray.h&quot;</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineminus">-#include &quot;nsArrayEnumerator.h&quot;</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineminus">-#include &quot;nsSimpleEnumerator.h&quot;</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineminus">-#include &quot;nsString.h&quot;</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineminus">-#include &quot;rdf.h&quot;</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineminus">-#include &quot;nsCycleCollectionParticipant.h&quot;</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineminus">-</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineminus">-#include &quot;nsEnumeratorUtils.h&quot;</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineminus">-</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineminus">-#include &quot;mozilla/Logging.h&quot;</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineminus">-#include &lt;stdio.h&gt;</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineminus">-mozilla::LazyLogModule nsRDFLog(&quot;RDF&quot;);</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineminus">-</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineminus">-//----------------------------------------------------------------------</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineminus">-//</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineminus">-// CompositeDataSourceImpl</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineminus">-//</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineminus">-</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineminus">-class CompositeEnumeratorImpl;</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineminus">-class CompositeArcsInOutEnumeratorImpl;</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineminus">-class CompositeAssertionEnumeratorImpl;</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineminus">-</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineminus">-class CompositeDataSourceImpl : public nsIRDFCompositeDataSource,</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineminus">-                                public nsIRDFObserver</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineminus">-{</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineminus">-public:</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineminus">-    CompositeDataSourceImpl(void);</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineminus">-    explicit CompositeDataSourceImpl(char** dataSources);</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineminus">-</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineminus">-    // nsISupports interface</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineminus">-    NS_DECL_CYCLE_COLLECTING_ISUPPORTS</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineminus">-    NS_DECL_CYCLE_COLLECTION_CLASS_AMBIGUOUS(CompositeDataSourceImpl,</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineminus">-                                             nsIRDFCompositeDataSource)</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineminus">-</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineminus">-    // nsIRDFDataSource interface</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineminus">-    NS_DECL_NSIRDFDATASOURCE</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineminus">-</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineminus">-    // nsIRDFCompositeDataSource interface</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineminus">-    NS_DECL_NSIRDFCOMPOSITEDATASOURCE</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineminus">-</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineminus">-    // nsIRDFObserver interface</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineminus">-    NS_DECL_NSIRDFOBSERVER</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineminus">-</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineminus">-    bool HasAssertionN(int n, nsIRDFResource* source,</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineminus">-                            nsIRDFResource* property,</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineminus">-                            nsIRDFNode* target,</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineminus">-                            bool tv);</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineminus">-</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineminus">-protected:</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineminus">-    nsCOMArray&lt;nsIRDFObserver&gt; mObservers;</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineminus">-    nsCOMArray&lt;nsIRDFDataSource&gt; mDataSources;</span>
<a href="#l4.91"></a><span id="l4.91" class="difflineminus">-</span>
<a href="#l4.92"></a><span id="l4.92" class="difflineminus">-    bool        mAllowNegativeAssertions;</span>
<a href="#l4.93"></a><span id="l4.93" class="difflineminus">-    bool        mCoalesceDuplicateArcs;</span>
<a href="#l4.94"></a><span id="l4.94" class="difflineminus">-    int32_t     mUpdateBatchNest;</span>
<a href="#l4.95"></a><span id="l4.95" class="difflineminus">-</span>
<a href="#l4.96"></a><span id="l4.96" class="difflineminus">-    virtual ~CompositeDataSourceImpl() {}</span>
<a href="#l4.97"></a><span id="l4.97" class="difflineminus">-</span>
<a href="#l4.98"></a><span id="l4.98" class="difflineminus">-    friend class CompositeEnumeratorImpl;</span>
<a href="#l4.99"></a><span id="l4.99" class="difflineminus">-    friend class CompositeArcsInOutEnumeratorImpl;</span>
<a href="#l4.100"></a><span id="l4.100" class="difflineminus">-    friend class CompositeAssertionEnumeratorImpl;</span>
<a href="#l4.101"></a><span id="l4.101" class="difflineminus">-};</span>
<a href="#l4.102"></a><span id="l4.102" class="difflineminus">-</span>
<a href="#l4.103"></a><span id="l4.103" class="difflineminus">-//----------------------------------------------------------------------</span>
<a href="#l4.104"></a><span id="l4.104" class="difflineminus">-//</span>
<a href="#l4.105"></a><span id="l4.105" class="difflineminus">-// CompositeEnumeratorImpl</span>
<a href="#l4.106"></a><span id="l4.106" class="difflineminus">-//</span>
<a href="#l4.107"></a><span id="l4.107" class="difflineminus">-</span>
<a href="#l4.108"></a><span id="l4.108" class="difflineminus">-class CompositeEnumeratorImpl : public nsSimpleEnumerator</span>
<a href="#l4.109"></a><span id="l4.109" class="difflineminus">-{</span>
<a href="#l4.110"></a><span id="l4.110" class="difflineminus">-    const nsID&amp; DefaultInterface() override</span>
<a href="#l4.111"></a><span id="l4.111" class="difflineminus">-    {</span>
<a href="#l4.112"></a><span id="l4.112" class="difflineminus">-      return NS_GET_IID(nsIRDFNode);</span>
<a href="#l4.113"></a><span id="l4.113" class="difflineminus">-    }</span>
<a href="#l4.114"></a><span id="l4.114" class="difflineminus">-</span>
<a href="#l4.115"></a><span id="l4.115" class="difflineminus">-    // nsISimpleEnumerator interface</span>
<a href="#l4.116"></a><span id="l4.116" class="difflineminus">-    NS_DECL_NSISIMPLEENUMERATOR</span>
<a href="#l4.117"></a><span id="l4.117" class="difflineminus">-</span>
<a href="#l4.118"></a><span id="l4.118" class="difflineminus">-    // pure abstract methods to be overridden</span>
<a href="#l4.119"></a><span id="l4.119" class="difflineminus">-    virtual nsresult</span>
<a href="#l4.120"></a><span id="l4.120" class="difflineminus">-    GetEnumerator(nsIRDFDataSource* aDataSource, nsISimpleEnumerator** aResult) = 0;</span>
<a href="#l4.121"></a><span id="l4.121" class="difflineminus">-</span>
<a href="#l4.122"></a><span id="l4.122" class="difflineminus">-    virtual nsresult</span>
<a href="#l4.123"></a><span id="l4.123" class="difflineminus">-    HasNegation(nsIRDFDataSource* aDataSource, nsIRDFNode* aNode, bool* aResult) = 0;</span>
<a href="#l4.124"></a><span id="l4.124" class="difflineminus">-</span>
<a href="#l4.125"></a><span id="l4.125" class="difflineminus">-protected:</span>
<a href="#l4.126"></a><span id="l4.126" class="difflineminus">-    CompositeEnumeratorImpl(CompositeDataSourceImpl* aCompositeDataSource,</span>
<a href="#l4.127"></a><span id="l4.127" class="difflineminus">-                            bool aAllowNegativeAssertions,</span>
<a href="#l4.128"></a><span id="l4.128" class="difflineminus">-                            bool aCoalesceDuplicateArcs);</span>
<a href="#l4.129"></a><span id="l4.129" class="difflineminus">-</span>
<a href="#l4.130"></a><span id="l4.130" class="difflineminus">-    ~CompositeEnumeratorImpl() override;</span>
<a href="#l4.131"></a><span id="l4.131" class="difflineminus">-</span>
<a href="#l4.132"></a><span id="l4.132" class="difflineminus">-    CompositeDataSourceImpl* mCompositeDataSource;</span>
<a href="#l4.133"></a><span id="l4.133" class="difflineminus">-</span>
<a href="#l4.134"></a><span id="l4.134" class="difflineminus">-    nsISimpleEnumerator* mCurrent;</span>
<a href="#l4.135"></a><span id="l4.135" class="difflineminus">-    nsIRDFNode*  mResult;</span>
<a href="#l4.136"></a><span id="l4.136" class="difflineminus">-    int32_t      mNext;</span>
<a href="#l4.137"></a><span id="l4.137" class="difflineminus">-    AutoTArray&lt;nsCOMPtr&lt;nsIRDFNode&gt;, 8&gt;  mAlreadyReturned;</span>
<a href="#l4.138"></a><span id="l4.138" class="difflineminus">-    bool mAllowNegativeAssertions;</span>
<a href="#l4.139"></a><span id="l4.139" class="difflineminus">-    bool mCoalesceDuplicateArcs;</span>
<a href="#l4.140"></a><span id="l4.140" class="difflineminus">-};</span>
<a href="#l4.141"></a><span id="l4.141" class="difflineminus">-</span>
<a href="#l4.142"></a><span id="l4.142" class="difflineminus">-</span>
<a href="#l4.143"></a><span id="l4.143" class="difflineminus">-CompositeEnumeratorImpl::CompositeEnumeratorImpl(CompositeDataSourceImpl* aCompositeDataSource,</span>
<a href="#l4.144"></a><span id="l4.144" class="difflineminus">-                                                 bool aAllowNegativeAssertions,</span>
<a href="#l4.145"></a><span id="l4.145" class="difflineminus">-                                                 bool aCoalesceDuplicateArcs)</span>
<a href="#l4.146"></a><span id="l4.146" class="difflineminus">-    : mCompositeDataSource(aCompositeDataSource),</span>
<a href="#l4.147"></a><span id="l4.147" class="difflineminus">-      mCurrent(nullptr),</span>
<a href="#l4.148"></a><span id="l4.148" class="difflineminus">-      mResult(nullptr),</span>
<a href="#l4.149"></a><span id="l4.149" class="difflineminus">-      mNext(0),</span>
<a href="#l4.150"></a><span id="l4.150" class="difflineminus">-      mAllowNegativeAssertions(aAllowNegativeAssertions),</span>
<a href="#l4.151"></a><span id="l4.151" class="difflineminus">-      mCoalesceDuplicateArcs(aCoalesceDuplicateArcs)</span>
<a href="#l4.152"></a><span id="l4.152" class="difflineminus">-{</span>
<a href="#l4.153"></a><span id="l4.153" class="difflineminus">-    NS_ADDREF(mCompositeDataSource);</span>
<a href="#l4.154"></a><span id="l4.154" class="difflineminus">-}</span>
<a href="#l4.155"></a><span id="l4.155" class="difflineminus">-</span>
<a href="#l4.156"></a><span id="l4.156" class="difflineminus">-</span>
<a href="#l4.157"></a><span id="l4.157" class="difflineminus">-CompositeEnumeratorImpl::~CompositeEnumeratorImpl(void)</span>
<a href="#l4.158"></a><span id="l4.158" class="difflineminus">-{</span>
<a href="#l4.159"></a><span id="l4.159" class="difflineminus">-    NS_IF_RELEASE(mCurrent);</span>
<a href="#l4.160"></a><span id="l4.160" class="difflineminus">-    NS_IF_RELEASE(mResult);</span>
<a href="#l4.161"></a><span id="l4.161" class="difflineminus">-    NS_RELEASE(mCompositeDataSource);</span>
<a href="#l4.162"></a><span id="l4.162" class="difflineminus">-}</span>
<a href="#l4.163"></a><span id="l4.163" class="difflineminus">-</span>
<a href="#l4.164"></a><span id="l4.164" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l4.165"></a><span id="l4.165" class="difflineminus">-CompositeEnumeratorImpl::HasMoreElements(bool* aResult)</span>
<a href="#l4.166"></a><span id="l4.166" class="difflineminus">-{</span>
<a href="#l4.167"></a><span id="l4.167" class="difflineminus">-    NS_ASSERTION(aResult != nullptr, &quot;null ptr&quot;);</span>
<a href="#l4.168"></a><span id="l4.168" class="difflineminus">-    if (! aResult)</span>
<a href="#l4.169"></a><span id="l4.169" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l4.170"></a><span id="l4.170" class="difflineminus">-</span>
<a href="#l4.171"></a><span id="l4.171" class="difflineminus">-    nsresult rv;</span>
<a href="#l4.172"></a><span id="l4.172" class="difflineminus">-</span>
<a href="#l4.173"></a><span id="l4.173" class="difflineminus">-    // If we've already queued up a next target, then yep, there are</span>
<a href="#l4.174"></a><span id="l4.174" class="difflineminus">-    // more elements.</span>
<a href="#l4.175"></a><span id="l4.175" class="difflineminus">-    if (mResult) {</span>
<a href="#l4.176"></a><span id="l4.176" class="difflineminus">-        *aResult = true;</span>
<a href="#l4.177"></a><span id="l4.177" class="difflineminus">-        return NS_OK;</span>
<a href="#l4.178"></a><span id="l4.178" class="difflineminus">-    }</span>
<a href="#l4.179"></a><span id="l4.179" class="difflineminus">-</span>
<a href="#l4.180"></a><span id="l4.180" class="difflineminus">-    // Otherwise, we'll need to find a next target, switching cursors</span>
<a href="#l4.181"></a><span id="l4.181" class="difflineminus">-    // if necessary.</span>
<a href="#l4.182"></a><span id="l4.182" class="difflineminus">-    for ( ; mNext &lt; mCompositeDataSource-&gt;mDataSources.Count(); ++mNext) {</span>
<a href="#l4.183"></a><span id="l4.183" class="difflineminus">-        if (! mCurrent) {</span>
<a href="#l4.184"></a><span id="l4.184" class="difflineminus">-            // We don't have a current enumerator, so create a new one on</span>
<a href="#l4.185"></a><span id="l4.185" class="difflineminus">-            // the next data source.</span>
<a href="#l4.186"></a><span id="l4.186" class="difflineminus">-            nsIRDFDataSource* datasource =</span>
<a href="#l4.187"></a><span id="l4.187" class="difflineminus">-                mCompositeDataSource-&gt;mDataSources[mNext];</span>
<a href="#l4.188"></a><span id="l4.188" class="difflineminus">-</span>
<a href="#l4.189"></a><span id="l4.189" class="difflineminus">-            rv = GetEnumerator(datasource, &amp;mCurrent);</span>
<a href="#l4.190"></a><span id="l4.190" class="difflineminus">-            if (NS_FAILED(rv)) return rv;</span>
<a href="#l4.191"></a><span id="l4.191" class="difflineminus">-            if (rv == NS_RDF_NO_VALUE)</span>
<a href="#l4.192"></a><span id="l4.192" class="difflineminus">-                continue;</span>
<a href="#l4.193"></a><span id="l4.193" class="difflineminus">-</span>
<a href="#l4.194"></a><span id="l4.194" class="difflineminus">-            NS_ASSERTION(mCurrent != nullptr, &quot;you're always supposed to return an enumerator from GetEnumerator, punk.&quot;);</span>
<a href="#l4.195"></a><span id="l4.195" class="difflineminus">-            if (! mCurrent)</span>
<a href="#l4.196"></a><span id="l4.196" class="difflineminus">-                continue;</span>
<a href="#l4.197"></a><span id="l4.197" class="difflineminus">-        }</span>
<a href="#l4.198"></a><span id="l4.198" class="difflineminus">-</span>
<a href="#l4.199"></a><span id="l4.199" class="difflineminus">-        do {</span>
<a href="#l4.200"></a><span id="l4.200" class="difflineminus">-            int32_t i;</span>
<a href="#l4.201"></a><span id="l4.201" class="difflineminus">-</span>
<a href="#l4.202"></a><span id="l4.202" class="difflineminus">-            bool hasMore;</span>
<a href="#l4.203"></a><span id="l4.203" class="difflineminus">-            rv = mCurrent-&gt;HasMoreElements(&amp;hasMore);</span>
<a href="#l4.204"></a><span id="l4.204" class="difflineminus">-            if (NS_FAILED(rv)) return rv;</span>
<a href="#l4.205"></a><span id="l4.205" class="difflineminus">-</span>
<a href="#l4.206"></a><span id="l4.206" class="difflineminus">-            // Is the current enumerator depleted?</span>
<a href="#l4.207"></a><span id="l4.207" class="difflineminus">-            if (! hasMore) {</span>
<a href="#l4.208"></a><span id="l4.208" class="difflineminus">-                NS_RELEASE(mCurrent);</span>
<a href="#l4.209"></a><span id="l4.209" class="difflineminus">-                break;</span>
<a href="#l4.210"></a><span id="l4.210" class="difflineminus">-            }</span>
<a href="#l4.211"></a><span id="l4.211" class="difflineminus">-</span>
<a href="#l4.212"></a><span id="l4.212" class="difflineminus">-            // Even if the current enumerator has more elements, we still</span>
<a href="#l4.213"></a><span id="l4.213" class="difflineminus">-            // need to check that the current element isn't masked by</span>
<a href="#l4.214"></a><span id="l4.214" class="difflineminus">-            // a negation in an earlier data source.</span>
<a href="#l4.215"></a><span id="l4.215" class="difflineminus">-</span>
<a href="#l4.216"></a><span id="l4.216" class="difflineminus">-            // &quot;Peek&quot; ahead and pull out the next target.</span>
<a href="#l4.217"></a><span id="l4.217" class="difflineminus">-            nsCOMPtr&lt;nsISupports&gt; result;</span>
<a href="#l4.218"></a><span id="l4.218" class="difflineminus">-            rv = mCurrent-&gt;GetNext(getter_AddRefs(result));</span>
<a href="#l4.219"></a><span id="l4.219" class="difflineminus">-            if (NS_FAILED(rv)) return rv;</span>
<a href="#l4.220"></a><span id="l4.220" class="difflineminus">-</span>
<a href="#l4.221"></a><span id="l4.221" class="difflineminus">-            rv = result-&gt;QueryInterface(NS_GET_IID(nsIRDFNode), (void**) &amp;mResult);</span>
<a href="#l4.222"></a><span id="l4.222" class="difflineminus">-            if (NS_FAILED(rv)) return rv;</span>
<a href="#l4.223"></a><span id="l4.223" class="difflineminus">-</span>
<a href="#l4.224"></a><span id="l4.224" class="difflineminus">-            if (mAllowNegativeAssertions)</span>
<a href="#l4.225"></a><span id="l4.225" class="difflineminus">-            {</span>
<a href="#l4.226"></a><span id="l4.226" class="difflineminus">-                // See if any previous data source negates this</span>
<a href="#l4.227"></a><span id="l4.227" class="difflineminus">-                bool hasNegation = false;</span>
<a href="#l4.228"></a><span id="l4.228" class="difflineminus">-                for (i = mNext - 1; i &gt;= 0; --i)</span>
<a href="#l4.229"></a><span id="l4.229" class="difflineminus">-                {</span>
<a href="#l4.230"></a><span id="l4.230" class="difflineminus">-                    nsIRDFDataSource* datasource =</span>
<a href="#l4.231"></a><span id="l4.231" class="difflineminus">-                        mCompositeDataSource-&gt;mDataSources[i];</span>
<a href="#l4.232"></a><span id="l4.232" class="difflineminus">-</span>
<a href="#l4.233"></a><span id="l4.233" class="difflineminus">-                    rv = HasNegation(datasource, mResult, &amp;hasNegation);</span>
<a href="#l4.234"></a><span id="l4.234" class="difflineminus">-                    if (NS_FAILED(rv)) return rv;</span>
<a href="#l4.235"></a><span id="l4.235" class="difflineminus">-</span>
<a href="#l4.236"></a><span id="l4.236" class="difflineminus">-                    if (hasNegation)</span>
<a href="#l4.237"></a><span id="l4.237" class="difflineminus">-                        break;</span>
<a href="#l4.238"></a><span id="l4.238" class="difflineminus">-                }</span>
<a href="#l4.239"></a><span id="l4.239" class="difflineminus">-</span>
<a href="#l4.240"></a><span id="l4.240" class="difflineminus">-                // if so, we've gotta keep looking</span>
<a href="#l4.241"></a><span id="l4.241" class="difflineminus">-                if (hasNegation)</span>
<a href="#l4.242"></a><span id="l4.242" class="difflineminus">-                {</span>
<a href="#l4.243"></a><span id="l4.243" class="difflineminus">-                    NS_RELEASE(mResult);</span>
<a href="#l4.244"></a><span id="l4.244" class="difflineminus">-                    continue;</span>
<a href="#l4.245"></a><span id="l4.245" class="difflineminus">-                }</span>
<a href="#l4.246"></a><span id="l4.246" class="difflineminus">-            }</span>
<a href="#l4.247"></a><span id="l4.247" class="difflineminus">-</span>
<a href="#l4.248"></a><span id="l4.248" class="difflineminus">-            if (mCoalesceDuplicateArcs)</span>
<a href="#l4.249"></a><span id="l4.249" class="difflineminus">-            {</span>
<a href="#l4.250"></a><span id="l4.250" class="difflineminus">-                // Now see if we've returned it once already.</span>
<a href="#l4.251"></a><span id="l4.251" class="difflineminus">-                // XXX N.B. performance here...may want to hash if things get large?</span>
<a href="#l4.252"></a><span id="l4.252" class="difflineminus">-                bool alreadyReturned = false;</span>
<a href="#l4.253"></a><span id="l4.253" class="difflineminus">-                for (i = mAlreadyReturned.Length() - 1; i &gt;= 0; --i)</span>
<a href="#l4.254"></a><span id="l4.254" class="difflineminus">-                {</span>
<a href="#l4.255"></a><span id="l4.255" class="difflineminus">-                    if (mAlreadyReturned[i] == mResult)</span>
<a href="#l4.256"></a><span id="l4.256" class="difflineminus">-                    {</span>
<a href="#l4.257"></a><span id="l4.257" class="difflineminus">-                        alreadyReturned = true;</span>
<a href="#l4.258"></a><span id="l4.258" class="difflineminus">-                        break;</span>
<a href="#l4.259"></a><span id="l4.259" class="difflineminus">-                    }</span>
<a href="#l4.260"></a><span id="l4.260" class="difflineminus">-                }</span>
<a href="#l4.261"></a><span id="l4.261" class="difflineminus">-                if (alreadyReturned)</span>
<a href="#l4.262"></a><span id="l4.262" class="difflineminus">-                {</span>
<a href="#l4.263"></a><span id="l4.263" class="difflineminus">-                    NS_RELEASE(mResult);</span>
<a href="#l4.264"></a><span id="l4.264" class="difflineminus">-                    continue;</span>
<a href="#l4.265"></a><span id="l4.265" class="difflineminus">-                }</span>
<a href="#l4.266"></a><span id="l4.266" class="difflineminus">-            }</span>
<a href="#l4.267"></a><span id="l4.267" class="difflineminus">-</span>
<a href="#l4.268"></a><span id="l4.268" class="difflineminus">-            // If we get here, then we've really found one. It'll</span>
<a href="#l4.269"></a><span id="l4.269" class="difflineminus">-            // remain cached in mResult until GetNext() sucks it out.</span>
<a href="#l4.270"></a><span id="l4.270" class="difflineminus">-            *aResult = true;</span>
<a href="#l4.271"></a><span id="l4.271" class="difflineminus">-</span>
<a href="#l4.272"></a><span id="l4.272" class="difflineminus">-            // Remember that we returned it, so we don't return duplicates.</span>
<a href="#l4.273"></a><span id="l4.273" class="difflineminus">-</span>
<a href="#l4.274"></a><span id="l4.274" class="difflineminus">-            // XXX I wonder if we should make unique-checking be</span>
<a href="#l4.275"></a><span id="l4.275" class="difflineminus">-            // optional. This could get to be pretty expensive (this</span>
<a href="#l4.276"></a><span id="l4.276" class="difflineminus">-            // implementation turns iteration into O(n^2)).</span>
<a href="#l4.277"></a><span id="l4.277" class="difflineminus">-</span>
<a href="#l4.278"></a><span id="l4.278" class="difflineminus">-            if (mCoalesceDuplicateArcs)</span>
<a href="#l4.279"></a><span id="l4.279" class="difflineminus">-            {</span>
<a href="#l4.280"></a><span id="l4.280" class="difflineminus">-                mAlreadyReturned.AppendElement(mResult);</span>
<a href="#l4.281"></a><span id="l4.281" class="difflineminus">-            }</span>
<a href="#l4.282"></a><span id="l4.282" class="difflineminus">-</span>
<a href="#l4.283"></a><span id="l4.283" class="difflineminus">-            return NS_OK;</span>
<a href="#l4.284"></a><span id="l4.284" class="difflineminus">-        } while (1);</span>
<a href="#l4.285"></a><span id="l4.285" class="difflineminus">-    }</span>
<a href="#l4.286"></a><span id="l4.286" class="difflineminus">-</span>
<a href="#l4.287"></a><span id="l4.287" class="difflineminus">-    // if we get here, there aren't any elements left.</span>
<a href="#l4.288"></a><span id="l4.288" class="difflineminus">-    *aResult = false;</span>
<a href="#l4.289"></a><span id="l4.289" class="difflineminus">-    return NS_OK;</span>
<a href="#l4.290"></a><span id="l4.290" class="difflineminus">-}</span>
<a href="#l4.291"></a><span id="l4.291" class="difflineminus">-</span>
<a href="#l4.292"></a><span id="l4.292" class="difflineminus">-</span>
<a href="#l4.293"></a><span id="l4.293" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l4.294"></a><span id="l4.294" class="difflineminus">-CompositeEnumeratorImpl::GetNext(nsISupports** aResult)</span>
<a href="#l4.295"></a><span id="l4.295" class="difflineminus">-{</span>
<a href="#l4.296"></a><span id="l4.296" class="difflineminus">-    nsresult rv;</span>
<a href="#l4.297"></a><span id="l4.297" class="difflineminus">-</span>
<a href="#l4.298"></a><span id="l4.298" class="difflineminus">-    bool hasMore;</span>
<a href="#l4.299"></a><span id="l4.299" class="difflineminus">-    rv = HasMoreElements(&amp;hasMore);</span>
<a href="#l4.300"></a><span id="l4.300" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l4.301"></a><span id="l4.301" class="difflineminus">-</span>
<a href="#l4.302"></a><span id="l4.302" class="difflineminus">-    if (! hasMore)</span>
<a href="#l4.303"></a><span id="l4.303" class="difflineminus">-        return NS_ERROR_UNEXPECTED;</span>
<a href="#l4.304"></a><span id="l4.304" class="difflineminus">-</span>
<a href="#l4.305"></a><span id="l4.305" class="difflineminus">-    // Don't AddRef: we &quot;transfer&quot; ownership to the caller</span>
<a href="#l4.306"></a><span id="l4.306" class="difflineminus">-    *aResult = mResult;</span>
<a href="#l4.307"></a><span id="l4.307" class="difflineminus">-    mResult = nullptr;</span>
<a href="#l4.308"></a><span id="l4.308" class="difflineminus">-</span>
<a href="#l4.309"></a><span id="l4.309" class="difflineminus">-    return NS_OK;</span>
<a href="#l4.310"></a><span id="l4.310" class="difflineminus">-}</span>
<a href="#l4.311"></a><span id="l4.311" class="difflineminus">-</span>
<a href="#l4.312"></a><span id="l4.312" class="difflineminus">-//----------------------------------------------------------------------</span>
<a href="#l4.313"></a><span id="l4.313" class="difflineminus">-//</span>
<a href="#l4.314"></a><span id="l4.314" class="difflineminus">-// CompositeArcsInOutEnumeratorImpl</span>
<a href="#l4.315"></a><span id="l4.315" class="difflineminus">-//</span>
<a href="#l4.316"></a><span id="l4.316" class="difflineminus">-//</span>
<a href="#l4.317"></a><span id="l4.317" class="difflineminus">-</span>
<a href="#l4.318"></a><span id="l4.318" class="difflineminus">-class CompositeArcsInOutEnumeratorImpl : public CompositeEnumeratorImpl</span>
<a href="#l4.319"></a><span id="l4.319" class="difflineminus">-{</span>
<a href="#l4.320"></a><span id="l4.320" class="difflineminus">-public:</span>
<a href="#l4.321"></a><span id="l4.321" class="difflineminus">-    enum Type { eArcsIn, eArcsOut };</span>
<a href="#l4.322"></a><span id="l4.322" class="difflineminus">-</span>
<a href="#l4.323"></a><span id="l4.323" class="difflineminus">-    virtual ~CompositeArcsInOutEnumeratorImpl();</span>
<a href="#l4.324"></a><span id="l4.324" class="difflineminus">-</span>
<a href="#l4.325"></a><span id="l4.325" class="difflineminus">-    virtual nsresult</span>
<a href="#l4.326"></a><span id="l4.326" class="difflineminus">-    GetEnumerator(nsIRDFDataSource* aDataSource, nsISimpleEnumerator** aResult) override;</span>
<a href="#l4.327"></a><span id="l4.327" class="difflineminus">-</span>
<a href="#l4.328"></a><span id="l4.328" class="difflineminus">-    virtual nsresult</span>
<a href="#l4.329"></a><span id="l4.329" class="difflineminus">-    HasNegation(nsIRDFDataSource* aDataSource, nsIRDFNode* aNode, bool* aResult) override;</span>
<a href="#l4.330"></a><span id="l4.330" class="difflineminus">-</span>
<a href="#l4.331"></a><span id="l4.331" class="difflineminus">-    CompositeArcsInOutEnumeratorImpl(CompositeDataSourceImpl* aCompositeDataSource,</span>
<a href="#l4.332"></a><span id="l4.332" class="difflineminus">-                                     nsIRDFNode* aNode,</span>
<a href="#l4.333"></a><span id="l4.333" class="difflineminus">-                                     Type aType,</span>
<a href="#l4.334"></a><span id="l4.334" class="difflineminus">-                                     bool aAllowNegativeAssertions,</span>
<a href="#l4.335"></a><span id="l4.335" class="difflineminus">-                                     bool aCoalesceDuplicateArcs);</span>
<a href="#l4.336"></a><span id="l4.336" class="difflineminus">-</span>
<a href="#l4.337"></a><span id="l4.337" class="difflineminus">-private:</span>
<a href="#l4.338"></a><span id="l4.338" class="difflineminus">-    nsIRDFNode* mNode;</span>
<a href="#l4.339"></a><span id="l4.339" class="difflineminus">-    Type        mType;</span>
<a href="#l4.340"></a><span id="l4.340" class="difflineminus">-};</span>
<a href="#l4.341"></a><span id="l4.341" class="difflineminus">-</span>
<a href="#l4.342"></a><span id="l4.342" class="difflineminus">-</span>
<a href="#l4.343"></a><span id="l4.343" class="difflineminus">-CompositeArcsInOutEnumeratorImpl::CompositeArcsInOutEnumeratorImpl(</span>
<a href="#l4.344"></a><span id="l4.344" class="difflineminus">-                CompositeDataSourceImpl* aCompositeDataSource,</span>
<a href="#l4.345"></a><span id="l4.345" class="difflineminus">-                nsIRDFNode* aNode,</span>
<a href="#l4.346"></a><span id="l4.346" class="difflineminus">-                Type aType,</span>
<a href="#l4.347"></a><span id="l4.347" class="difflineminus">-                bool aAllowNegativeAssertions,</span>
<a href="#l4.348"></a><span id="l4.348" class="difflineminus">-                bool aCoalesceDuplicateArcs)</span>
<a href="#l4.349"></a><span id="l4.349" class="difflineminus">-    : CompositeEnumeratorImpl(aCompositeDataSource, aAllowNegativeAssertions, aCoalesceDuplicateArcs),</span>
<a href="#l4.350"></a><span id="l4.350" class="difflineminus">-      mNode(aNode),</span>
<a href="#l4.351"></a><span id="l4.351" class="difflineminus">-      mType(aType)</span>
<a href="#l4.352"></a><span id="l4.352" class="difflineminus">-{</span>
<a href="#l4.353"></a><span id="l4.353" class="difflineminus">-    NS_ADDREF(mNode);</span>
<a href="#l4.354"></a><span id="l4.354" class="difflineminus">-}</span>
<a href="#l4.355"></a><span id="l4.355" class="difflineminus">-</span>
<a href="#l4.356"></a><span id="l4.356" class="difflineminus">-CompositeArcsInOutEnumeratorImpl::~CompositeArcsInOutEnumeratorImpl()</span>
<a href="#l4.357"></a><span id="l4.357" class="difflineminus">-{</span>
<a href="#l4.358"></a><span id="l4.358" class="difflineminus">-    NS_RELEASE(mNode);</span>
<a href="#l4.359"></a><span id="l4.359" class="difflineminus">-}</span>
<a href="#l4.360"></a><span id="l4.360" class="difflineminus">-</span>
<a href="#l4.361"></a><span id="l4.361" class="difflineminus">-</span>
<a href="#l4.362"></a><span id="l4.362" class="difflineminus">-nsresult</span>
<a href="#l4.363"></a><span id="l4.363" class="difflineminus">-CompositeArcsInOutEnumeratorImpl::GetEnumerator(</span>
<a href="#l4.364"></a><span id="l4.364" class="difflineminus">-                 nsIRDFDataSource* aDataSource,</span>
<a href="#l4.365"></a><span id="l4.365" class="difflineminus">-                 nsISimpleEnumerator** aResult)</span>
<a href="#l4.366"></a><span id="l4.366" class="difflineminus">-{</span>
<a href="#l4.367"></a><span id="l4.367" class="difflineminus">-    if (mType == eArcsIn) {</span>
<a href="#l4.368"></a><span id="l4.368" class="difflineminus">-        return aDataSource-&gt;ArcLabelsIn(mNode, aResult);</span>
<a href="#l4.369"></a><span id="l4.369" class="difflineminus">-    }</span>
<a href="#l4.370"></a><span id="l4.370" class="difflineminus">-    else {</span>
<a href="#l4.371"></a><span id="l4.371" class="difflineminus">-        nsCOMPtr&lt;nsIRDFResource&gt; resource( do_QueryInterface(mNode) );</span>
<a href="#l4.372"></a><span id="l4.372" class="difflineminus">-        return aDataSource-&gt;ArcLabelsOut(resource, aResult);</span>
<a href="#l4.373"></a><span id="l4.373" class="difflineminus">-    }</span>
<a href="#l4.374"></a><span id="l4.374" class="difflineminus">-}</span>
<a href="#l4.375"></a><span id="l4.375" class="difflineminus">-</span>
<a href="#l4.376"></a><span id="l4.376" class="difflineminus">-nsresult</span>
<a href="#l4.377"></a><span id="l4.377" class="difflineminus">-CompositeArcsInOutEnumeratorImpl::HasNegation(</span>
<a href="#l4.378"></a><span id="l4.378" class="difflineminus">-                 nsIRDFDataSource* aDataSource,</span>
<a href="#l4.379"></a><span id="l4.379" class="difflineminus">-                 nsIRDFNode* aNode,</span>
<a href="#l4.380"></a><span id="l4.380" class="difflineminus">-                 bool* aResult)</span>
<a href="#l4.381"></a><span id="l4.381" class="difflineminus">-{</span>
<a href="#l4.382"></a><span id="l4.382" class="difflineminus">-    *aResult = false;</span>
<a href="#l4.383"></a><span id="l4.383" class="difflineminus">-    return NS_OK;</span>
<a href="#l4.384"></a><span id="l4.384" class="difflineminus">-}</span>
<a href="#l4.385"></a><span id="l4.385" class="difflineminus">-</span>
<a href="#l4.386"></a><span id="l4.386" class="difflineminus">-</span>
<a href="#l4.387"></a><span id="l4.387" class="difflineminus">-//----------------------------------------------------------------------</span>
<a href="#l4.388"></a><span id="l4.388" class="difflineminus">-//</span>
<a href="#l4.389"></a><span id="l4.389" class="difflineminus">-// CompositeAssertionEnumeratorImpl</span>
<a href="#l4.390"></a><span id="l4.390" class="difflineminus">-//</span>
<a href="#l4.391"></a><span id="l4.391" class="difflineminus">-</span>
<a href="#l4.392"></a><span id="l4.392" class="difflineminus">-class CompositeAssertionEnumeratorImpl : public CompositeEnumeratorImpl</span>
<a href="#l4.393"></a><span id="l4.393" class="difflineminus">-{</span>
<a href="#l4.394"></a><span id="l4.394" class="difflineminus">-public:</span>
<a href="#l4.395"></a><span id="l4.395" class="difflineminus">-    virtual nsresult</span>
<a href="#l4.396"></a><span id="l4.396" class="difflineminus">-    GetEnumerator(nsIRDFDataSource* aDataSource, nsISimpleEnumerator** aResult) override;</span>
<a href="#l4.397"></a><span id="l4.397" class="difflineminus">-</span>
<a href="#l4.398"></a><span id="l4.398" class="difflineminus">-    virtual nsresult</span>
<a href="#l4.399"></a><span id="l4.399" class="difflineminus">-    HasNegation(nsIRDFDataSource* aDataSource, nsIRDFNode* aNode, bool* aResult) override;</span>
<a href="#l4.400"></a><span id="l4.400" class="difflineminus">-</span>
<a href="#l4.401"></a><span id="l4.401" class="difflineminus">-    CompositeAssertionEnumeratorImpl(CompositeDataSourceImpl* aCompositeDataSource,</span>
<a href="#l4.402"></a><span id="l4.402" class="difflineminus">-                                     nsIRDFResource* aSource,</span>
<a href="#l4.403"></a><span id="l4.403" class="difflineminus">-                                     nsIRDFResource* aProperty,</span>
<a href="#l4.404"></a><span id="l4.404" class="difflineminus">-                                     nsIRDFNode* aTarget,</span>
<a href="#l4.405"></a><span id="l4.405" class="difflineminus">-                                     bool aTruthValue,</span>
<a href="#l4.406"></a><span id="l4.406" class="difflineminus">-                                     bool aAllowNegativeAssertions,</span>
<a href="#l4.407"></a><span id="l4.407" class="difflineminus">-                                     bool aCoalesceDuplicateArcs);</span>
<a href="#l4.408"></a><span id="l4.408" class="difflineminus">-</span>
<a href="#l4.409"></a><span id="l4.409" class="difflineminus">-    virtual ~CompositeAssertionEnumeratorImpl();</span>
<a href="#l4.410"></a><span id="l4.410" class="difflineminus">-</span>
<a href="#l4.411"></a><span id="l4.411" class="difflineminus">-private:</span>
<a href="#l4.412"></a><span id="l4.412" class="difflineminus">-    nsIRDFResource* mSource;</span>
<a href="#l4.413"></a><span id="l4.413" class="difflineminus">-    nsIRDFResource* mProperty;</span>
<a href="#l4.414"></a><span id="l4.414" class="difflineminus">-    nsIRDFNode*     mTarget;</span>
<a href="#l4.415"></a><span id="l4.415" class="difflineminus">-    bool            mTruthValue;</span>
<a href="#l4.416"></a><span id="l4.416" class="difflineminus">-};</span>
<a href="#l4.417"></a><span id="l4.417" class="difflineminus">-</span>
<a href="#l4.418"></a><span id="l4.418" class="difflineminus">-</span>
<a href="#l4.419"></a><span id="l4.419" class="difflineminus">-CompositeAssertionEnumeratorImpl::CompositeAssertionEnumeratorImpl(</span>
<a href="#l4.420"></a><span id="l4.420" class="difflineminus">-                  CompositeDataSourceImpl* aCompositeDataSource,</span>
<a href="#l4.421"></a><span id="l4.421" class="difflineminus">-                  nsIRDFResource* aSource,</span>
<a href="#l4.422"></a><span id="l4.422" class="difflineminus">-                  nsIRDFResource* aProperty,</span>
<a href="#l4.423"></a><span id="l4.423" class="difflineminus">-                  nsIRDFNode* aTarget,</span>
<a href="#l4.424"></a><span id="l4.424" class="difflineminus">-                  bool aTruthValue,</span>
<a href="#l4.425"></a><span id="l4.425" class="difflineminus">-                  bool aAllowNegativeAssertions,</span>
<a href="#l4.426"></a><span id="l4.426" class="difflineminus">-                  bool aCoalesceDuplicateArcs)</span>
<a href="#l4.427"></a><span id="l4.427" class="difflineminus">-    : CompositeEnumeratorImpl(aCompositeDataSource, aAllowNegativeAssertions, aCoalesceDuplicateArcs),</span>
<a href="#l4.428"></a><span id="l4.428" class="difflineminus">-      mSource(aSource),</span>
<a href="#l4.429"></a><span id="l4.429" class="difflineminus">-      mProperty(aProperty),</span>
<a href="#l4.430"></a><span id="l4.430" class="difflineminus">-      mTarget(aTarget),</span>
<a href="#l4.431"></a><span id="l4.431" class="difflineminus">-      mTruthValue(aTruthValue)</span>
<a href="#l4.432"></a><span id="l4.432" class="difflineminus">-{</span>
<a href="#l4.433"></a><span id="l4.433" class="difflineminus">-    NS_IF_ADDREF(mSource);</span>
<a href="#l4.434"></a><span id="l4.434" class="difflineminus">-    NS_ADDREF(mProperty); // always must be specified</span>
<a href="#l4.435"></a><span id="l4.435" class="difflineminus">-    NS_IF_ADDREF(mTarget);</span>
<a href="#l4.436"></a><span id="l4.436" class="difflineminus">-}</span>
<a href="#l4.437"></a><span id="l4.437" class="difflineminus">-</span>
<a href="#l4.438"></a><span id="l4.438" class="difflineminus">-CompositeAssertionEnumeratorImpl::~CompositeAssertionEnumeratorImpl()</span>
<a href="#l4.439"></a><span id="l4.439" class="difflineminus">-{</span>
<a href="#l4.440"></a><span id="l4.440" class="difflineminus">-    NS_IF_RELEASE(mSource);</span>
<a href="#l4.441"></a><span id="l4.441" class="difflineminus">-    NS_RELEASE(mProperty);</span>
<a href="#l4.442"></a><span id="l4.442" class="difflineminus">-    NS_IF_RELEASE(mTarget);</span>
<a href="#l4.443"></a><span id="l4.443" class="difflineminus">-}</span>
<a href="#l4.444"></a><span id="l4.444" class="difflineminus">-</span>
<a href="#l4.445"></a><span id="l4.445" class="difflineminus">-</span>
<a href="#l4.446"></a><span id="l4.446" class="difflineminus">-nsresult</span>
<a href="#l4.447"></a><span id="l4.447" class="difflineminus">-CompositeAssertionEnumeratorImpl::GetEnumerator(</span>
<a href="#l4.448"></a><span id="l4.448" class="difflineminus">-                 nsIRDFDataSource* aDataSource,</span>
<a href="#l4.449"></a><span id="l4.449" class="difflineminus">-                 nsISimpleEnumerator** aResult)</span>
<a href="#l4.450"></a><span id="l4.450" class="difflineminus">-{</span>
<a href="#l4.451"></a><span id="l4.451" class="difflineminus">-    if (mSource) {</span>
<a href="#l4.452"></a><span id="l4.452" class="difflineminus">-        return aDataSource-&gt;GetTargets(mSource, mProperty, mTruthValue, aResult);</span>
<a href="#l4.453"></a><span id="l4.453" class="difflineminus">-    }</span>
<a href="#l4.454"></a><span id="l4.454" class="difflineminus">-    else {</span>
<a href="#l4.455"></a><span id="l4.455" class="difflineminus">-        return aDataSource-&gt;GetSources(mProperty, mTarget, mTruthValue, aResult);</span>
<a href="#l4.456"></a><span id="l4.456" class="difflineminus">-    }</span>
<a href="#l4.457"></a><span id="l4.457" class="difflineminus">-}</span>
<a href="#l4.458"></a><span id="l4.458" class="difflineminus">-</span>
<a href="#l4.459"></a><span id="l4.459" class="difflineminus">-nsresult</span>
<a href="#l4.460"></a><span id="l4.460" class="difflineminus">-CompositeAssertionEnumeratorImpl::HasNegation(</span>
<a href="#l4.461"></a><span id="l4.461" class="difflineminus">-                 nsIRDFDataSource* aDataSource,</span>
<a href="#l4.462"></a><span id="l4.462" class="difflineminus">-                 nsIRDFNode* aNode,</span>
<a href="#l4.463"></a><span id="l4.463" class="difflineminus">-                 bool* aResult)</span>
<a href="#l4.464"></a><span id="l4.464" class="difflineminus">-{</span>
<a href="#l4.465"></a><span id="l4.465" class="difflineminus">-    if (mSource) {</span>
<a href="#l4.466"></a><span id="l4.466" class="difflineminus">-        return aDataSource-&gt;HasAssertion(mSource, mProperty, aNode, !mTruthValue, aResult);</span>
<a href="#l4.467"></a><span id="l4.467" class="difflineminus">-    }</span>
<a href="#l4.468"></a><span id="l4.468" class="difflineminus">-    else {</span>
<a href="#l4.469"></a><span id="l4.469" class="difflineminus">-        nsCOMPtr&lt;nsIRDFResource&gt; source( do_QueryInterface(aNode) );</span>
<a href="#l4.470"></a><span id="l4.470" class="difflineminus">-        return aDataSource-&gt;HasAssertion(source, mProperty, mTarget, !mTruthValue, aResult);</span>
<a href="#l4.471"></a><span id="l4.471" class="difflineminus">-    }</span>
<a href="#l4.472"></a><span id="l4.472" class="difflineminus">-}</span>
<a href="#l4.473"></a><span id="l4.473" class="difflineminus">-</span>
<a href="#l4.474"></a><span id="l4.474" class="difflineminus">-////////////////////////////////////////////////////////////////////////</span>
<a href="#l4.475"></a><span id="l4.475" class="difflineminus">-</span>
<a href="#l4.476"></a><span id="l4.476" class="difflineminus">-nsresult</span>
<a href="#l4.477"></a><span id="l4.477" class="difflineminus">-NS_NewRDFCompositeDataSource(nsIRDFCompositeDataSource** result)</span>
<a href="#l4.478"></a><span id="l4.478" class="difflineminus">-{</span>
<a href="#l4.479"></a><span id="l4.479" class="difflineminus">-    CompositeDataSourceImpl* db = new CompositeDataSourceImpl();</span>
<a href="#l4.480"></a><span id="l4.480" class="difflineminus">-    if (! db)</span>
<a href="#l4.481"></a><span id="l4.481" class="difflineminus">-        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l4.482"></a><span id="l4.482" class="difflineminus">-</span>
<a href="#l4.483"></a><span id="l4.483" class="difflineminus">-    *result = db;</span>
<a href="#l4.484"></a><span id="l4.484" class="difflineminus">-    NS_ADDREF(*result);</span>
<a href="#l4.485"></a><span id="l4.485" class="difflineminus">-    return NS_OK;</span>
<a href="#l4.486"></a><span id="l4.486" class="difflineminus">-}</span>
<a href="#l4.487"></a><span id="l4.487" class="difflineminus">-</span>
<a href="#l4.488"></a><span id="l4.488" class="difflineminus">-</span>
<a href="#l4.489"></a><span id="l4.489" class="difflineminus">-CompositeDataSourceImpl::CompositeDataSourceImpl(void)</span>
<a href="#l4.490"></a><span id="l4.490" class="difflineminus">-	: mAllowNegativeAssertions(true),</span>
<a href="#l4.491"></a><span id="l4.491" class="difflineminus">-	  mCoalesceDuplicateArcs(true),</span>
<a href="#l4.492"></a><span id="l4.492" class="difflineminus">-      mUpdateBatchNest(0)</span>
<a href="#l4.493"></a><span id="l4.493" class="difflineminus">-{</span>
<a href="#l4.494"></a><span id="l4.494" class="difflineminus">-}</span>
<a href="#l4.495"></a><span id="l4.495" class="difflineminus">-</span>
<a href="#l4.496"></a><span id="l4.496" class="difflineminus">-//----------------------------------------------------------------------</span>
<a href="#l4.497"></a><span id="l4.497" class="difflineminus">-//</span>
<a href="#l4.498"></a><span id="l4.498" class="difflineminus">-// nsISupports interface</span>
<a href="#l4.499"></a><span id="l4.499" class="difflineminus">-//</span>
<a href="#l4.500"></a><span id="l4.500" class="difflineminus">-</span>
<a href="#l4.501"></a><span id="l4.501" class="difflineminus">-NS_IMPL_CYCLE_COLLECTION_CLASS(CompositeDataSourceImpl)</span>
<a href="#l4.502"></a><span id="l4.502" class="difflineminus">-</span>
<a href="#l4.503"></a><span id="l4.503" class="difflineminus">-NS_IMPL_CYCLE_COLLECTION_UNLINK_BEGIN(CompositeDataSourceImpl)</span>
<a href="#l4.504"></a><span id="l4.504" class="difflineminus">-    uint32_t i, count = tmp-&gt;mDataSources.Count();</span>
<a href="#l4.505"></a><span id="l4.505" class="difflineminus">-    for (i = count; i &gt; 0; --i) {</span>
<a href="#l4.506"></a><span id="l4.506" class="difflineminus">-        tmp-&gt;mDataSources[i - 1]-&gt;RemoveObserver(tmp);</span>
<a href="#l4.507"></a><span id="l4.507" class="difflineminus">-        tmp-&gt;mDataSources.RemoveObjectAt(i - 1);</span>
<a href="#l4.508"></a><span id="l4.508" class="difflineminus">-    }</span>
<a href="#l4.509"></a><span id="l4.509" class="difflineminus">-    NS_IMPL_CYCLE_COLLECTION_UNLINK(mObservers);</span>
<a href="#l4.510"></a><span id="l4.510" class="difflineminus">-NS_IMPL_CYCLE_COLLECTION_UNLINK_END</span>
<a href="#l4.511"></a><span id="l4.511" class="difflineminus">-NS_IMPL_CYCLE_COLLECTION_TRAVERSE_BEGIN(CompositeDataSourceImpl)</span>
<a href="#l4.512"></a><span id="l4.512" class="difflineminus">-    NS_IMPL_CYCLE_COLLECTION_TRAVERSE(mObservers)</span>
<a href="#l4.513"></a><span id="l4.513" class="difflineminus">-    NS_IMPL_CYCLE_COLLECTION_TRAVERSE(mDataSources)</span>
<a href="#l4.514"></a><span id="l4.514" class="difflineminus">-NS_IMPL_CYCLE_COLLECTION_TRAVERSE_END</span>
<a href="#l4.515"></a><span id="l4.515" class="difflineminus">-</span>
<a href="#l4.516"></a><span id="l4.516" class="difflineminus">-</span>
<a href="#l4.517"></a><span id="l4.517" class="difflineminus">-NS_IMPL_CYCLE_COLLECTING_ADDREF(CompositeDataSourceImpl)</span>
<a href="#l4.518"></a><span id="l4.518" class="difflineminus">-NS_IMPL_CYCLE_COLLECTING_RELEASE(CompositeDataSourceImpl)</span>
<a href="#l4.519"></a><span id="l4.519" class="difflineminus">-</span>
<a href="#l4.520"></a><span id="l4.520" class="difflineminus">-NS_INTERFACE_MAP_BEGIN_CYCLE_COLLECTION(CompositeDataSourceImpl)</span>
<a href="#l4.521"></a><span id="l4.521" class="difflineminus">-    NS_INTERFACE_MAP_ENTRY(nsIRDFCompositeDataSource)</span>
<a href="#l4.522"></a><span id="l4.522" class="difflineminus">-    NS_INTERFACE_MAP_ENTRY(nsIRDFDataSource)</span>
<a href="#l4.523"></a><span id="l4.523" class="difflineminus">-    NS_INTERFACE_MAP_ENTRY(nsIRDFObserver)</span>
<a href="#l4.524"></a><span id="l4.524" class="difflineminus">-    NS_INTERFACE_MAP_ENTRY(nsIRDFCompositeDataSource)</span>
<a href="#l4.525"></a><span id="l4.525" class="difflineminus">-    NS_INTERFACE_MAP_ENTRY_AMBIGUOUS(nsISupports, nsIRDFCompositeDataSource)</span>
<a href="#l4.526"></a><span id="l4.526" class="difflineminus">-NS_INTERFACE_MAP_END</span>
<a href="#l4.527"></a><span id="l4.527" class="difflineminus">-</span>
<a href="#l4.528"></a><span id="l4.528" class="difflineminus">-</span>
<a href="#l4.529"></a><span id="l4.529" class="difflineminus">-//----------------------------------------------------------------------</span>
<a href="#l4.530"></a><span id="l4.530" class="difflineminus">-//</span>
<a href="#l4.531"></a><span id="l4.531" class="difflineminus">-// nsIRDFDataSource interface</span>
<a href="#l4.532"></a><span id="l4.532" class="difflineminus">-//</span>
<a href="#l4.533"></a><span id="l4.533" class="difflineminus">-</span>
<a href="#l4.534"></a><span id="l4.534" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l4.535"></a><span id="l4.535" class="difflineminus">-CompositeDataSourceImpl::GetURI(nsACString&amp; aURI)</span>
<a href="#l4.536"></a><span id="l4.536" class="difflineminus">-{</span>
<a href="#l4.537"></a><span id="l4.537" class="difflineminus">-    aURI.SetIsVoid(true);</span>
<a href="#l4.538"></a><span id="l4.538" class="difflineminus">-    return NS_OK;</span>
<a href="#l4.539"></a><span id="l4.539" class="difflineminus">-}</span>
<a href="#l4.540"></a><span id="l4.540" class="difflineminus">-</span>
<a href="#l4.541"></a><span id="l4.541" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l4.542"></a><span id="l4.542" class="difflineminus">-CompositeDataSourceImpl::GetSource(nsIRDFResource* property,</span>
<a href="#l4.543"></a><span id="l4.543" class="difflineminus">-                                   nsIRDFNode* target,</span>
<a href="#l4.544"></a><span id="l4.544" class="difflineminus">-                                   bool tv,</span>
<a href="#l4.545"></a><span id="l4.545" class="difflineminus">-                                   nsIRDFResource** source)</span>
<a href="#l4.546"></a><span id="l4.546" class="difflineminus">-{</span>
<a href="#l4.547"></a><span id="l4.547" class="difflineminus">-	if (!mAllowNegativeAssertions &amp;&amp; !tv)</span>
<a href="#l4.548"></a><span id="l4.548" class="difflineminus">-		return(NS_RDF_NO_VALUE);</span>
<a href="#l4.549"></a><span id="l4.549" class="difflineminus">-</span>
<a href="#l4.550"></a><span id="l4.550" class="difflineminus">-    int32_t count = mDataSources.Count();</span>
<a href="#l4.551"></a><span id="l4.551" class="difflineminus">-    for (int32_t i = 0; i &lt; count; ++i) {</span>
<a href="#l4.552"></a><span id="l4.552" class="difflineminus">-        nsresult rv;</span>
<a href="#l4.553"></a><span id="l4.553" class="difflineminus">-        rv = mDataSources[i]-&gt;GetSource(property, target, tv, source);</span>
<a href="#l4.554"></a><span id="l4.554" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l4.555"></a><span id="l4.555" class="difflineminus">-</span>
<a href="#l4.556"></a><span id="l4.556" class="difflineminus">-        if (rv == NS_RDF_NO_VALUE)</span>
<a href="#l4.557"></a><span id="l4.557" class="difflineminus">-            continue;</span>
<a href="#l4.558"></a><span id="l4.558" class="difflineminus">-</span>
<a href="#l4.559"></a><span id="l4.559" class="difflineminus">-        if (!mAllowNegativeAssertions) return(NS_OK);</span>
<a href="#l4.560"></a><span id="l4.560" class="difflineminus">-</span>
<a href="#l4.561"></a><span id="l4.561" class="difflineminus">-        // okay, found it. make sure we don't have the opposite</span>
<a href="#l4.562"></a><span id="l4.562" class="difflineminus">-        // asserted in a more local data source</span>
<a href="#l4.563"></a><span id="l4.563" class="difflineminus">-        if (!HasAssertionN(count-1, *source, property, target, !tv))</span>
<a href="#l4.564"></a><span id="l4.564" class="difflineminus">-            return NS_OK;</span>
<a href="#l4.565"></a><span id="l4.565" class="difflineminus">-</span>
<a href="#l4.566"></a><span id="l4.566" class="difflineminus">-        NS_RELEASE(*source);</span>
<a href="#l4.567"></a><span id="l4.567" class="difflineminus">-        return NS_RDF_NO_VALUE;</span>
<a href="#l4.568"></a><span id="l4.568" class="difflineminus">-    }</span>
<a href="#l4.569"></a><span id="l4.569" class="difflineminus">-    return NS_RDF_NO_VALUE;</span>
<a href="#l4.570"></a><span id="l4.570" class="difflineminus">-}</span>
<a href="#l4.571"></a><span id="l4.571" class="difflineminus">-</span>
<a href="#l4.572"></a><span id="l4.572" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l4.573"></a><span id="l4.573" class="difflineminus">-CompositeDataSourceImpl::GetSources(nsIRDFResource* aProperty,</span>
<a href="#l4.574"></a><span id="l4.574" class="difflineminus">-                                    nsIRDFNode* aTarget,</span>
<a href="#l4.575"></a><span id="l4.575" class="difflineminus">-                                    bool aTruthValue,</span>
<a href="#l4.576"></a><span id="l4.576" class="difflineminus">-                                    nsISimpleEnumerator** aResult)</span>
<a href="#l4.577"></a><span id="l4.577" class="difflineminus">-{</span>
<a href="#l4.578"></a><span id="l4.578" class="difflineminus">-    NS_ASSERTION(aProperty != nullptr, &quot;null ptr&quot;);</span>
<a href="#l4.579"></a><span id="l4.579" class="difflineminus">-    if (! aProperty)</span>
<a href="#l4.580"></a><span id="l4.580" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l4.581"></a><span id="l4.581" class="difflineminus">-</span>
<a href="#l4.582"></a><span id="l4.582" class="difflineminus">-    NS_ASSERTION(aTarget != nullptr, &quot;null ptr&quot;);</span>
<a href="#l4.583"></a><span id="l4.583" class="difflineminus">-    if (! aTarget)</span>
<a href="#l4.584"></a><span id="l4.584" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l4.585"></a><span id="l4.585" class="difflineminus">-</span>
<a href="#l4.586"></a><span id="l4.586" class="difflineminus">-    NS_ASSERTION(aResult != nullptr, &quot;null ptr&quot;);</span>
<a href="#l4.587"></a><span id="l4.587" class="difflineminus">-    if (! aResult)</span>
<a href="#l4.588"></a><span id="l4.588" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l4.589"></a><span id="l4.589" class="difflineminus">-</span>
<a href="#l4.590"></a><span id="l4.590" class="difflineminus">-    if (! mAllowNegativeAssertions &amp;&amp; ! aTruthValue)</span>
<a href="#l4.591"></a><span id="l4.591" class="difflineminus">-        return(NS_RDF_NO_VALUE);</span>
<a href="#l4.592"></a><span id="l4.592" class="difflineminus">-</span>
<a href="#l4.593"></a><span id="l4.593" class="difflineminus">-    *aResult = new CompositeAssertionEnumeratorImpl(this, nullptr, aProperty,</span>
<a href="#l4.594"></a><span id="l4.594" class="difflineminus">-                                                    aTarget, aTruthValue,</span>
<a href="#l4.595"></a><span id="l4.595" class="difflineminus">-                                                    mAllowNegativeAssertions,</span>
<a href="#l4.596"></a><span id="l4.596" class="difflineminus">-                                                    mCoalesceDuplicateArcs);</span>
<a href="#l4.597"></a><span id="l4.597" class="difflineminus">-</span>
<a href="#l4.598"></a><span id="l4.598" class="difflineminus">-    if (! *aResult)</span>
<a href="#l4.599"></a><span id="l4.599" class="difflineminus">-        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l4.600"></a><span id="l4.600" class="difflineminus">-</span>
<a href="#l4.601"></a><span id="l4.601" class="difflineminus">-    NS_ADDREF(*aResult);</span>
<a href="#l4.602"></a><span id="l4.602" class="difflineminus">-    return NS_OK;</span>
<a href="#l4.603"></a><span id="l4.603" class="difflineminus">-}</span>
<a href="#l4.604"></a><span id="l4.604" class="difflineminus">-</span>
<a href="#l4.605"></a><span id="l4.605" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l4.606"></a><span id="l4.606" class="difflineminus">-CompositeDataSourceImpl::GetTarget(nsIRDFResource* aSource,</span>
<a href="#l4.607"></a><span id="l4.607" class="difflineminus">-                                   nsIRDFResource* aProperty,</span>
<a href="#l4.608"></a><span id="l4.608" class="difflineminus">-                                   bool aTruthValue,</span>
<a href="#l4.609"></a><span id="l4.609" class="difflineminus">-                                   nsIRDFNode** aResult)</span>
<a href="#l4.610"></a><span id="l4.610" class="difflineminus">-{</span>
<a href="#l4.611"></a><span id="l4.611" class="difflineminus">-    NS_ASSERTION(aSource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l4.612"></a><span id="l4.612" class="difflineminus">-    if (! aSource)</span>
<a href="#l4.613"></a><span id="l4.613" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l4.614"></a><span id="l4.614" class="difflineminus">-</span>
<a href="#l4.615"></a><span id="l4.615" class="difflineminus">-    NS_ASSERTION(aProperty != nullptr, &quot;null ptr&quot;);</span>
<a href="#l4.616"></a><span id="l4.616" class="difflineminus">-    if (! aProperty)</span>
<a href="#l4.617"></a><span id="l4.617" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l4.618"></a><span id="l4.618" class="difflineminus">-</span>
<a href="#l4.619"></a><span id="l4.619" class="difflineminus">-    NS_ASSERTION(aResult != nullptr, &quot;null ptr&quot;);</span>
<a href="#l4.620"></a><span id="l4.620" class="difflineminus">-    if (! aResult)</span>
<a href="#l4.621"></a><span id="l4.621" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l4.622"></a><span id="l4.622" class="difflineminus">-</span>
<a href="#l4.623"></a><span id="l4.623" class="difflineminus">-    if (! mAllowNegativeAssertions &amp;&amp; ! aTruthValue)</span>
<a href="#l4.624"></a><span id="l4.624" class="difflineminus">-        return(NS_RDF_NO_VALUE);</span>
<a href="#l4.625"></a><span id="l4.625" class="difflineminus">-</span>
<a href="#l4.626"></a><span id="l4.626" class="difflineminus">-    int32_t count = mDataSources.Count();</span>
<a href="#l4.627"></a><span id="l4.627" class="difflineminus">-    for (int32_t i = 0; i &lt; count; ++i) {</span>
<a href="#l4.628"></a><span id="l4.628" class="difflineminus">-        nsresult rv;</span>
<a href="#l4.629"></a><span id="l4.629" class="difflineminus">-        rv = mDataSources[i]-&gt;GetTarget(aSource, aProperty, aTruthValue,</span>
<a href="#l4.630"></a><span id="l4.630" class="difflineminus">-                                        aResult);</span>
<a href="#l4.631"></a><span id="l4.631" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l4.632"></a><span id="l4.632" class="difflineminus">-            return rv;</span>
<a href="#l4.633"></a><span id="l4.633" class="difflineminus">-</span>
<a href="#l4.634"></a><span id="l4.634" class="difflineminus">-        if (rv == NS_OK) {</span>
<a href="#l4.635"></a><span id="l4.635" class="difflineminus">-            // okay, found it. make sure we don't have the opposite</span>
<a href="#l4.636"></a><span id="l4.636" class="difflineminus">-            // asserted in an earlier data source</span>
<a href="#l4.637"></a><span id="l4.637" class="difflineminus">-</span>
<a href="#l4.638"></a><span id="l4.638" class="difflineminus">-            if (mAllowNegativeAssertions) {</span>
<a href="#l4.639"></a><span id="l4.639" class="difflineminus">-                if (HasAssertionN(count-1, aSource, aProperty, *aResult, !aTruthValue)) {</span>
<a href="#l4.640"></a><span id="l4.640" class="difflineminus">-                    // whoops, it's been negated.</span>
<a href="#l4.641"></a><span id="l4.641" class="difflineminus">-                    NS_RELEASE(*aResult);</span>
<a href="#l4.642"></a><span id="l4.642" class="difflineminus">-                    return NS_RDF_NO_VALUE;</span>
<a href="#l4.643"></a><span id="l4.643" class="difflineminus">-                }</span>
<a href="#l4.644"></a><span id="l4.644" class="difflineminus">-            }</span>
<a href="#l4.645"></a><span id="l4.645" class="difflineminus">-            return NS_OK;</span>
<a href="#l4.646"></a><span id="l4.646" class="difflineminus">-        }</span>
<a href="#l4.647"></a><span id="l4.647" class="difflineminus">-    }</span>
<a href="#l4.648"></a><span id="l4.648" class="difflineminus">-</span>
<a href="#l4.649"></a><span id="l4.649" class="difflineminus">-    // Otherwise, we couldn't find it at all.</span>
<a href="#l4.650"></a><span id="l4.650" class="difflineminus">-    return NS_RDF_NO_VALUE;</span>
<a href="#l4.651"></a><span id="l4.651" class="difflineminus">-}</span>
<a href="#l4.652"></a><span id="l4.652" class="difflineminus">-</span>
<a href="#l4.653"></a><span id="l4.653" class="difflineminus">-bool</span>
<a href="#l4.654"></a><span id="l4.654" class="difflineminus">-CompositeDataSourceImpl::HasAssertionN(int n,</span>
<a href="#l4.655"></a><span id="l4.655" class="difflineminus">-                                       nsIRDFResource* aSource,</span>
<a href="#l4.656"></a><span id="l4.656" class="difflineminus">-                                       nsIRDFResource* aProperty,</span>
<a href="#l4.657"></a><span id="l4.657" class="difflineminus">-                                       nsIRDFNode* aTarget,</span>
<a href="#l4.658"></a><span id="l4.658" class="difflineminus">-                                       bool aTruthValue)</span>
<a href="#l4.659"></a><span id="l4.659" class="difflineminus">-{</span>
<a href="#l4.660"></a><span id="l4.660" class="difflineminus">-    nsresult rv;</span>
<a href="#l4.661"></a><span id="l4.661" class="difflineminus">-    for (int32_t m = 0; m &lt; n; ++m) {</span>
<a href="#l4.662"></a><span id="l4.662" class="difflineminus">-        bool result;</span>
<a href="#l4.663"></a><span id="l4.663" class="difflineminus">-        rv = mDataSources[m]-&gt;HasAssertion(aSource, aProperty, aTarget,</span>
<a href="#l4.664"></a><span id="l4.664" class="difflineminus">-                                           aTruthValue, &amp;result);</span>
<a href="#l4.665"></a><span id="l4.665" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l4.666"></a><span id="l4.666" class="difflineminus">-            return false;</span>
<a href="#l4.667"></a><span id="l4.667" class="difflineminus">-</span>
<a href="#l4.668"></a><span id="l4.668" class="difflineminus">-        // found it!</span>
<a href="#l4.669"></a><span id="l4.669" class="difflineminus">-        if (result)</span>
<a href="#l4.670"></a><span id="l4.670" class="difflineminus">-            return true;</span>
<a href="#l4.671"></a><span id="l4.671" class="difflineminus">-    }</span>
<a href="#l4.672"></a><span id="l4.672" class="difflineminus">-    return false;</span>
<a href="#l4.673"></a><span id="l4.673" class="difflineminus">-}</span>
<a href="#l4.674"></a><span id="l4.674" class="difflineminus">-</span>
<a href="#l4.675"></a><span id="l4.675" class="difflineminus">-</span>
<a href="#l4.676"></a><span id="l4.676" class="difflineminus">-</span>
<a href="#l4.677"></a><span id="l4.677" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l4.678"></a><span id="l4.678" class="difflineminus">-CompositeDataSourceImpl::GetTargets(nsIRDFResource* aSource,</span>
<a href="#l4.679"></a><span id="l4.679" class="difflineminus">-                                    nsIRDFResource* aProperty,</span>
<a href="#l4.680"></a><span id="l4.680" class="difflineminus">-                                    bool aTruthValue,</span>
<a href="#l4.681"></a><span id="l4.681" class="difflineminus">-                                    nsISimpleEnumerator** aResult)</span>
<a href="#l4.682"></a><span id="l4.682" class="difflineminus">-{</span>
<a href="#l4.683"></a><span id="l4.683" class="difflineminus">-    NS_ASSERTION(aSource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l4.684"></a><span id="l4.684" class="difflineminus">-    if (! aSource)</span>
<a href="#l4.685"></a><span id="l4.685" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l4.686"></a><span id="l4.686" class="difflineminus">-</span>
<a href="#l4.687"></a><span id="l4.687" class="difflineminus">-    NS_ASSERTION(aProperty != nullptr, &quot;null ptr&quot;);</span>
<a href="#l4.688"></a><span id="l4.688" class="difflineminus">-    if (! aProperty)</span>
<a href="#l4.689"></a><span id="l4.689" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l4.690"></a><span id="l4.690" class="difflineminus">-</span>
<a href="#l4.691"></a><span id="l4.691" class="difflineminus">-    NS_ASSERTION(aResult != nullptr, &quot;null ptr&quot;);</span>
<a href="#l4.692"></a><span id="l4.692" class="difflineminus">-    if (! aResult)</span>
<a href="#l4.693"></a><span id="l4.693" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l4.694"></a><span id="l4.694" class="difflineminus">-</span>
<a href="#l4.695"></a><span id="l4.695" class="difflineminus">-    if (! mAllowNegativeAssertions &amp;&amp; ! aTruthValue)</span>
<a href="#l4.696"></a><span id="l4.696" class="difflineminus">-        return(NS_RDF_NO_VALUE);</span>
<a href="#l4.697"></a><span id="l4.697" class="difflineminus">-</span>
<a href="#l4.698"></a><span id="l4.698" class="difflineminus">-    *aResult =</span>
<a href="#l4.699"></a><span id="l4.699" class="difflineminus">-        new CompositeAssertionEnumeratorImpl(this,</span>
<a href="#l4.700"></a><span id="l4.700" class="difflineminus">-                                             aSource, aProperty, nullptr,</span>
<a href="#l4.701"></a><span id="l4.701" class="difflineminus">-                                             aTruthValue,</span>
<a href="#l4.702"></a><span id="l4.702" class="difflineminus">-                                             mAllowNegativeAssertions,</span>
<a href="#l4.703"></a><span id="l4.703" class="difflineminus">-                                             mCoalesceDuplicateArcs);</span>
<a href="#l4.704"></a><span id="l4.704" class="difflineminus">-</span>
<a href="#l4.705"></a><span id="l4.705" class="difflineminus">-    if (! *aResult)</span>
<a href="#l4.706"></a><span id="l4.706" class="difflineminus">-        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l4.707"></a><span id="l4.707" class="difflineminus">-</span>
<a href="#l4.708"></a><span id="l4.708" class="difflineminus">-    NS_ADDREF(*aResult);</span>
<a href="#l4.709"></a><span id="l4.709" class="difflineminus">-    return NS_OK;</span>
<a href="#l4.710"></a><span id="l4.710" class="difflineminus">-}</span>
<a href="#l4.711"></a><span id="l4.711" class="difflineminus">-</span>
<a href="#l4.712"></a><span id="l4.712" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l4.713"></a><span id="l4.713" class="difflineminus">-CompositeDataSourceImpl::Assert(nsIRDFResource* aSource,</span>
<a href="#l4.714"></a><span id="l4.714" class="difflineminus">-                                nsIRDFResource* aProperty,</span>
<a href="#l4.715"></a><span id="l4.715" class="difflineminus">-                                nsIRDFNode* aTarget,</span>
<a href="#l4.716"></a><span id="l4.716" class="difflineminus">-                                bool aTruthValue)</span>
<a href="#l4.717"></a><span id="l4.717" class="difflineminus">-{</span>
<a href="#l4.718"></a><span id="l4.718" class="difflineminus">-    NS_ASSERTION(aSource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l4.719"></a><span id="l4.719" class="difflineminus">-    if (! aSource)</span>
<a href="#l4.720"></a><span id="l4.720" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l4.721"></a><span id="l4.721" class="difflineminus">-</span>
<a href="#l4.722"></a><span id="l4.722" class="difflineminus">-    NS_ASSERTION(aProperty != nullptr, &quot;null ptr&quot;);</span>
<a href="#l4.723"></a><span id="l4.723" class="difflineminus">-    if (! aProperty)</span>
<a href="#l4.724"></a><span id="l4.724" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l4.725"></a><span id="l4.725" class="difflineminus">-</span>
<a href="#l4.726"></a><span id="l4.726" class="difflineminus">-    NS_ASSERTION(aTarget != nullptr, &quot;null ptr&quot;);</span>
<a href="#l4.727"></a><span id="l4.727" class="difflineminus">-    if (! aTarget)</span>
<a href="#l4.728"></a><span id="l4.728" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l4.729"></a><span id="l4.729" class="difflineminus">-</span>
<a href="#l4.730"></a><span id="l4.730" class="difflineminus">-    if (! mAllowNegativeAssertions &amp;&amp; ! aTruthValue)</span>
<a href="#l4.731"></a><span id="l4.731" class="difflineminus">-        return(NS_RDF_ASSERTION_REJECTED);</span>
<a href="#l4.732"></a><span id="l4.732" class="difflineminus">-</span>
<a href="#l4.733"></a><span id="l4.733" class="difflineminus">-    nsresult rv;</span>
<a href="#l4.734"></a><span id="l4.734" class="difflineminus">-</span>
<a href="#l4.735"></a><span id="l4.735" class="difflineminus">-    // XXX Need to add back the stuff for unblocking ...</span>
<a href="#l4.736"></a><span id="l4.736" class="difflineminus">-</span>
<a href="#l4.737"></a><span id="l4.737" class="difflineminus">-    // We iterate backwards from the last data source which was added</span>
<a href="#l4.738"></a><span id="l4.738" class="difflineminus">-    // (&quot;the most remote&quot;) to the first (&quot;the most local&quot;), trying to</span>
<a href="#l4.739"></a><span id="l4.739" class="difflineminus">-    // apply the assertion in each.</span>
<a href="#l4.740"></a><span id="l4.740" class="difflineminus">-    for (int32_t i = mDataSources.Count() - 1; i &gt;= 0; --i) {</span>
<a href="#l4.741"></a><span id="l4.741" class="difflineminus">-        rv = mDataSources[i]-&gt;Assert(aSource, aProperty, aTarget, aTruthValue);</span>
<a href="#l4.742"></a><span id="l4.742" class="difflineminus">-        if (NS_RDF_ASSERTION_ACCEPTED == rv)</span>
<a href="#l4.743"></a><span id="l4.743" class="difflineminus">-            return rv;</span>
<a href="#l4.744"></a><span id="l4.744" class="difflineminus">-</span>
<a href="#l4.745"></a><span id="l4.745" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l4.746"></a><span id="l4.746" class="difflineminus">-            return rv;</span>
<a href="#l4.747"></a><span id="l4.747" class="difflineminus">-    }</span>
<a href="#l4.748"></a><span id="l4.748" class="difflineminus">-</span>
<a href="#l4.749"></a><span id="l4.749" class="difflineminus">-    // nobody wanted to accept it</span>
<a href="#l4.750"></a><span id="l4.750" class="difflineminus">-    return NS_RDF_ASSERTION_REJECTED;</span>
<a href="#l4.751"></a><span id="l4.751" class="difflineminus">-}</span>
<a href="#l4.752"></a><span id="l4.752" class="difflineminus">-</span>
<a href="#l4.753"></a><span id="l4.753" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l4.754"></a><span id="l4.754" class="difflineminus">-CompositeDataSourceImpl::Unassert(nsIRDFResource* aSource,</span>
<a href="#l4.755"></a><span id="l4.755" class="difflineminus">-                                  nsIRDFResource* aProperty,</span>
<a href="#l4.756"></a><span id="l4.756" class="difflineminus">-                                  nsIRDFNode* aTarget)</span>
<a href="#l4.757"></a><span id="l4.757" class="difflineminus">-{</span>
<a href="#l4.758"></a><span id="l4.758" class="difflineminus">-    NS_ASSERTION(aSource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l4.759"></a><span id="l4.759" class="difflineminus">-    if (! aSource)</span>
<a href="#l4.760"></a><span id="l4.760" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l4.761"></a><span id="l4.761" class="difflineminus">-</span>
<a href="#l4.762"></a><span id="l4.762" class="difflineminus">-    NS_ASSERTION(aProperty != nullptr, &quot;null ptr&quot;);</span>
<a href="#l4.763"></a><span id="l4.763" class="difflineminus">-    if (! aProperty)</span>
<a href="#l4.764"></a><span id="l4.764" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l4.765"></a><span id="l4.765" class="difflineminus">-</span>
<a href="#l4.766"></a><span id="l4.766" class="difflineminus">-    NS_ASSERTION(aTarget != nullptr, &quot;null ptr&quot;);</span>
<a href="#l4.767"></a><span id="l4.767" class="difflineminus">-    if (! aTarget)</span>
<a href="#l4.768"></a><span id="l4.768" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l4.769"></a><span id="l4.769" class="difflineminus">-</span>
<a href="#l4.770"></a><span id="l4.770" class="difflineminus">-    nsresult rv;</span>
<a href="#l4.771"></a><span id="l4.771" class="difflineminus">-</span>
<a href="#l4.772"></a><span id="l4.772" class="difflineminus">-    // Iterate through each of the datasources, starting with &quot;the</span>
<a href="#l4.773"></a><span id="l4.773" class="difflineminus">-    // most local&quot; and moving to &quot;the most remote&quot;. If _any_ of the</span>
<a href="#l4.774"></a><span id="l4.774" class="difflineminus">-    // datasources have the assertion, attempt to unassert it.</span>
<a href="#l4.775"></a><span id="l4.775" class="difflineminus">-    bool unasserted = true;</span>
<a href="#l4.776"></a><span id="l4.776" class="difflineminus">-    int32_t i;</span>
<a href="#l4.777"></a><span id="l4.777" class="difflineminus">-    int32_t count = mDataSources.Count();</span>
<a href="#l4.778"></a><span id="l4.778" class="difflineminus">-    for (i = 0; i &lt; count; ++i) {</span>
<a href="#l4.779"></a><span id="l4.779" class="difflineminus">-        nsIRDFDataSource* ds = mDataSources[i];</span>
<a href="#l4.780"></a><span id="l4.780" class="difflineminus">-</span>
<a href="#l4.781"></a><span id="l4.781" class="difflineminus">-        bool hasAssertion;</span>
<a href="#l4.782"></a><span id="l4.782" class="difflineminus">-        rv = ds-&gt;HasAssertion(aSource, aProperty, aTarget, true, &amp;hasAssertion);</span>
<a href="#l4.783"></a><span id="l4.783" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l4.784"></a><span id="l4.784" class="difflineminus">-</span>
<a href="#l4.785"></a><span id="l4.785" class="difflineminus">-        if (hasAssertion) {</span>
<a href="#l4.786"></a><span id="l4.786" class="difflineminus">-            rv = ds-&gt;Unassert(aSource, aProperty, aTarget);</span>
<a href="#l4.787"></a><span id="l4.787" class="difflineminus">-            if (NS_FAILED(rv)) return rv;</span>
<a href="#l4.788"></a><span id="l4.788" class="difflineminus">-</span>
<a href="#l4.789"></a><span id="l4.789" class="difflineminus">-            if (rv != NS_RDF_ASSERTION_ACCEPTED) {</span>
<a href="#l4.790"></a><span id="l4.790" class="difflineminus">-                unasserted = false;</span>
<a href="#l4.791"></a><span id="l4.791" class="difflineminus">-                break;</span>
<a href="#l4.792"></a><span id="l4.792" class="difflineminus">-            }</span>
<a href="#l4.793"></a><span id="l4.793" class="difflineminus">-        }</span>
<a href="#l4.794"></a><span id="l4.794" class="difflineminus">-    }</span>
<a href="#l4.795"></a><span id="l4.795" class="difflineminus">-</span>
<a href="#l4.796"></a><span id="l4.796" class="difflineminus">-    // Either none of the datasources had it, or they were all willing</span>
<a href="#l4.797"></a><span id="l4.797" class="difflineminus">-    // to let it be unasserted.</span>
<a href="#l4.798"></a><span id="l4.798" class="difflineminus">-    if (unasserted)</span>
<a href="#l4.799"></a><span id="l4.799" class="difflineminus">-        return NS_RDF_ASSERTION_ACCEPTED;</span>
<a href="#l4.800"></a><span id="l4.800" class="difflineminus">-</span>
<a href="#l4.801"></a><span id="l4.801" class="difflineminus">-    // If we get here, one of the datasources already had the</span>
<a href="#l4.802"></a><span id="l4.802" class="difflineminus">-    // assertion, and was adamant about not letting us remove</span>
<a href="#l4.803"></a><span id="l4.803" class="difflineminus">-    // it. Iterate from the &quot;most local&quot; to the &quot;most remote&quot;</span>
<a href="#l4.804"></a><span id="l4.804" class="difflineminus">-    // attempting to assert the negation...</span>
<a href="#l4.805"></a><span id="l4.805" class="difflineminus">-    for (i = 0; i &lt; count; ++i) {</span>
<a href="#l4.806"></a><span id="l4.806" class="difflineminus">-        rv = mDataSources[i]-&gt;Assert(aSource, aProperty, aTarget, false);</span>
<a href="#l4.807"></a><span id="l4.807" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l4.808"></a><span id="l4.808" class="difflineminus">-</span>
<a href="#l4.809"></a><span id="l4.809" class="difflineminus">-        // Did it take?</span>
<a href="#l4.810"></a><span id="l4.810" class="difflineminus">-        if (rv == NS_RDF_ASSERTION_ACCEPTED)</span>
<a href="#l4.811"></a><span id="l4.811" class="difflineminus">-            return rv;</span>
<a href="#l4.812"></a><span id="l4.812" class="difflineminus">-    }</span>
<a href="#l4.813"></a><span id="l4.813" class="difflineminus">-</span>
<a href="#l4.814"></a><span id="l4.814" class="difflineminus">-    // Couln't get anyone to accept the negation, either.</span>
<a href="#l4.815"></a><span id="l4.815" class="difflineminus">-    return NS_RDF_ASSERTION_REJECTED;</span>
<a href="#l4.816"></a><span id="l4.816" class="difflineminus">-}</span>
<a href="#l4.817"></a><span id="l4.817" class="difflineminus">-</span>
<a href="#l4.818"></a><span id="l4.818" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l4.819"></a><span id="l4.819" class="difflineminus">-CompositeDataSourceImpl::Change(nsIRDFResource* aSource,</span>
<a href="#l4.820"></a><span id="l4.820" class="difflineminus">-                                nsIRDFResource* aProperty,</span>
<a href="#l4.821"></a><span id="l4.821" class="difflineminus">-                                nsIRDFNode* aOldTarget,</span>
<a href="#l4.822"></a><span id="l4.822" class="difflineminus">-                                nsIRDFNode* aNewTarget)</span>
<a href="#l4.823"></a><span id="l4.823" class="difflineminus">-{</span>
<a href="#l4.824"></a><span id="l4.824" class="difflineminus">-    NS_ASSERTION(aSource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l4.825"></a><span id="l4.825" class="difflineminus">-    if (! aSource)</span>
<a href="#l4.826"></a><span id="l4.826" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l4.827"></a><span id="l4.827" class="difflineminus">-</span>
<a href="#l4.828"></a><span id="l4.828" class="difflineminus">-    NS_ASSERTION(aProperty != nullptr, &quot;null ptr&quot;);</span>
<a href="#l4.829"></a><span id="l4.829" class="difflineminus">-    if (! aProperty)</span>
<a href="#l4.830"></a><span id="l4.830" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l4.831"></a><span id="l4.831" class="difflineminus">-</span>
<a href="#l4.832"></a><span id="l4.832" class="difflineminus">-    NS_ASSERTION(aOldTarget != nullptr, &quot;null ptr&quot;);</span>
<a href="#l4.833"></a><span id="l4.833" class="difflineminus">-    if (! aOldTarget)</span>
<a href="#l4.834"></a><span id="l4.834" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l4.835"></a><span id="l4.835" class="difflineminus">-</span>
<a href="#l4.836"></a><span id="l4.836" class="difflineminus">-    NS_ASSERTION(aNewTarget != nullptr, &quot;null ptr&quot;);</span>
<a href="#l4.837"></a><span id="l4.837" class="difflineminus">-    if (! aNewTarget)</span>
<a href="#l4.838"></a><span id="l4.838" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l4.839"></a><span id="l4.839" class="difflineminus">-</span>
<a href="#l4.840"></a><span id="l4.840" class="difflineminus">-    nsresult rv;</span>
<a href="#l4.841"></a><span id="l4.841" class="difflineminus">-</span>
<a href="#l4.842"></a><span id="l4.842" class="difflineminus">-    // XXX So we're assuming that a datasource _must_ accept the</span>
<a href="#l4.843"></a><span id="l4.843" class="difflineminus">-    // atomic change; i.e., we can't split it up across two</span>
<a href="#l4.844"></a><span id="l4.844" class="difflineminus">-    // datasources. That sucks.</span>
<a href="#l4.845"></a><span id="l4.845" class="difflineminus">-</span>
<a href="#l4.846"></a><span id="l4.846" class="difflineminus">-    // We iterate backwards from the last data source which was added</span>
<a href="#l4.847"></a><span id="l4.847" class="difflineminus">-    // (&quot;the most remote&quot;) to the first (&quot;the most local&quot;), trying to</span>
<a href="#l4.848"></a><span id="l4.848" class="difflineminus">-    // apply the change in each.</span>
<a href="#l4.849"></a><span id="l4.849" class="difflineminus">-    for (int32_t i = mDataSources.Count() - 1; i &gt;= 0; --i) {</span>
<a href="#l4.850"></a><span id="l4.850" class="difflineminus">-        rv = mDataSources[i]-&gt;Change(aSource, aProperty, aOldTarget, aNewTarget);</span>
<a href="#l4.851"></a><span id="l4.851" class="difflineminus">-        if (NS_RDF_ASSERTION_ACCEPTED == rv)</span>
<a href="#l4.852"></a><span id="l4.852" class="difflineminus">-            return rv;</span>
<a href="#l4.853"></a><span id="l4.853" class="difflineminus">-</span>
<a href="#l4.854"></a><span id="l4.854" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l4.855"></a><span id="l4.855" class="difflineminus">-            return rv;</span>
<a href="#l4.856"></a><span id="l4.856" class="difflineminus">-    }</span>
<a href="#l4.857"></a><span id="l4.857" class="difflineminus">-</span>
<a href="#l4.858"></a><span id="l4.858" class="difflineminus">-    // nobody wanted to accept it</span>
<a href="#l4.859"></a><span id="l4.859" class="difflineminus">-    return NS_RDF_ASSERTION_REJECTED;</span>
<a href="#l4.860"></a><span id="l4.860" class="difflineminus">-}</span>
<a href="#l4.861"></a><span id="l4.861" class="difflineminus">-</span>
<a href="#l4.862"></a><span id="l4.862" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l4.863"></a><span id="l4.863" class="difflineminus">-CompositeDataSourceImpl::Move(nsIRDFResource* aOldSource,</span>
<a href="#l4.864"></a><span id="l4.864" class="difflineminus">-                              nsIRDFResource* aNewSource,</span>
<a href="#l4.865"></a><span id="l4.865" class="difflineminus">-                              nsIRDFResource* aProperty,</span>
<a href="#l4.866"></a><span id="l4.866" class="difflineminus">-                              nsIRDFNode* aTarget)</span>
<a href="#l4.867"></a><span id="l4.867" class="difflineminus">-{</span>
<a href="#l4.868"></a><span id="l4.868" class="difflineminus">-    NS_ASSERTION(aOldSource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l4.869"></a><span id="l4.869" class="difflineminus">-    if (! aOldSource)</span>
<a href="#l4.870"></a><span id="l4.870" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l4.871"></a><span id="l4.871" class="difflineminus">-</span>
<a href="#l4.872"></a><span id="l4.872" class="difflineminus">-    NS_ASSERTION(aNewSource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l4.873"></a><span id="l4.873" class="difflineminus">-    if (! aNewSource)</span>
<a href="#l4.874"></a><span id="l4.874" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l4.875"></a><span id="l4.875" class="difflineminus">-</span>
<a href="#l4.876"></a><span id="l4.876" class="difflineminus">-    NS_ASSERTION(aProperty != nullptr, &quot;null ptr&quot;);</span>
<a href="#l4.877"></a><span id="l4.877" class="difflineminus">-    if (! aProperty)</span>
<a href="#l4.878"></a><span id="l4.878" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l4.879"></a><span id="l4.879" class="difflineminus">-</span>
<a href="#l4.880"></a><span id="l4.880" class="difflineminus">-    NS_ASSERTION(aTarget != nullptr, &quot;null ptr&quot;);</span>
<a href="#l4.881"></a><span id="l4.881" class="difflineminus">-    if (! aTarget)</span>
<a href="#l4.882"></a><span id="l4.882" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l4.883"></a><span id="l4.883" class="difflineminus">-</span>
<a href="#l4.884"></a><span id="l4.884" class="difflineminus">-    nsresult rv;</span>
<a href="#l4.885"></a><span id="l4.885" class="difflineminus">-</span>
<a href="#l4.886"></a><span id="l4.886" class="difflineminus">-    // XXX So we're assuming that a datasource _must_ accept the</span>
<a href="#l4.887"></a><span id="l4.887" class="difflineminus">-    // atomic move; i.e., we can't split it up across two</span>
<a href="#l4.888"></a><span id="l4.888" class="difflineminus">-    // datasources. That sucks.</span>
<a href="#l4.889"></a><span id="l4.889" class="difflineminus">-</span>
<a href="#l4.890"></a><span id="l4.890" class="difflineminus">-    // We iterate backwards from the last data source which was added</span>
<a href="#l4.891"></a><span id="l4.891" class="difflineminus">-    // (&quot;the most remote&quot;) to the first (&quot;the most local&quot;), trying to</span>
<a href="#l4.892"></a><span id="l4.892" class="difflineminus">-    // apply the assertion in each.</span>
<a href="#l4.893"></a><span id="l4.893" class="difflineminus">-    for (int32_t i = mDataSources.Count() - 1; i &gt;= 0; --i) {</span>
<a href="#l4.894"></a><span id="l4.894" class="difflineminus">-        rv = mDataSources[i]-&gt;Move(aOldSource, aNewSource, aProperty, aTarget);</span>
<a href="#l4.895"></a><span id="l4.895" class="difflineminus">-        if (NS_RDF_ASSERTION_ACCEPTED == rv)</span>
<a href="#l4.896"></a><span id="l4.896" class="difflineminus">-            return rv;</span>
<a href="#l4.897"></a><span id="l4.897" class="difflineminus">-</span>
<a href="#l4.898"></a><span id="l4.898" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l4.899"></a><span id="l4.899" class="difflineminus">-            return rv;</span>
<a href="#l4.900"></a><span id="l4.900" class="difflineminus">-    }</span>
<a href="#l4.901"></a><span id="l4.901" class="difflineminus">-</span>
<a href="#l4.902"></a><span id="l4.902" class="difflineminus">-    // nobody wanted to accept it</span>
<a href="#l4.903"></a><span id="l4.903" class="difflineminus">-    return NS_RDF_ASSERTION_REJECTED;</span>
<a href="#l4.904"></a><span id="l4.904" class="difflineminus">-}</span>
<a href="#l4.905"></a><span id="l4.905" class="difflineminus">-</span>
<a href="#l4.906"></a><span id="l4.906" class="difflineminus">-</span>
<a href="#l4.907"></a><span id="l4.907" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l4.908"></a><span id="l4.908" class="difflineminus">-CompositeDataSourceImpl::HasAssertion(nsIRDFResource* aSource,</span>
<a href="#l4.909"></a><span id="l4.909" class="difflineminus">-                                      nsIRDFResource* aProperty,</span>
<a href="#l4.910"></a><span id="l4.910" class="difflineminus">-                                      nsIRDFNode* aTarget,</span>
<a href="#l4.911"></a><span id="l4.911" class="difflineminus">-                                      bool aTruthValue,</span>
<a href="#l4.912"></a><span id="l4.912" class="difflineminus">-                                      bool* aResult)</span>
<a href="#l4.913"></a><span id="l4.913" class="difflineminus">-{</span>
<a href="#l4.914"></a><span id="l4.914" class="difflineminus">-    NS_ASSERTION(aSource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l4.915"></a><span id="l4.915" class="difflineminus">-    if (! aSource)</span>
<a href="#l4.916"></a><span id="l4.916" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l4.917"></a><span id="l4.917" class="difflineminus">-</span>
<a href="#l4.918"></a><span id="l4.918" class="difflineminus">-    NS_ASSERTION(aProperty != nullptr, &quot;null ptr&quot;);</span>
<a href="#l4.919"></a><span id="l4.919" class="difflineminus">-    if (! aProperty)</span>
<a href="#l4.920"></a><span id="l4.920" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l4.921"></a><span id="l4.921" class="difflineminus">-</span>
<a href="#l4.922"></a><span id="l4.922" class="difflineminus">-    NS_ASSERTION(aResult != nullptr, &quot;null ptr&quot;);</span>
<a href="#l4.923"></a><span id="l4.923" class="difflineminus">-    if (! aResult)</span>
<a href="#l4.924"></a><span id="l4.924" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l4.925"></a><span id="l4.925" class="difflineminus">-</span>
<a href="#l4.926"></a><span id="l4.926" class="difflineminus">-    if (! mAllowNegativeAssertions &amp;&amp; ! aTruthValue)</span>
<a href="#l4.927"></a><span id="l4.927" class="difflineminus">-    {</span>
<a href="#l4.928"></a><span id="l4.928" class="difflineminus">-        *aResult = false;</span>
<a href="#l4.929"></a><span id="l4.929" class="difflineminus">-        return(NS_OK);</span>
<a href="#l4.930"></a><span id="l4.930" class="difflineminus">-    }</span>
<a href="#l4.931"></a><span id="l4.931" class="difflineminus">-</span>
<a href="#l4.932"></a><span id="l4.932" class="difflineminus">-    nsresult rv;</span>
<a href="#l4.933"></a><span id="l4.933" class="difflineminus">-</span>
<a href="#l4.934"></a><span id="l4.934" class="difflineminus">-    // Otherwise, look through all the data sources to see if anyone</span>
<a href="#l4.935"></a><span id="l4.935" class="difflineminus">-    // has the positive...</span>
<a href="#l4.936"></a><span id="l4.936" class="difflineminus">-    int32_t count = mDataSources.Count();</span>
<a href="#l4.937"></a><span id="l4.937" class="difflineminus">-    for (int32_t i = 0; i &lt; count; ++i) {</span>
<a href="#l4.938"></a><span id="l4.938" class="difflineminus">-        nsIRDFDataSource* datasource = mDataSources[i];</span>
<a href="#l4.939"></a><span id="l4.939" class="difflineminus">-        rv = datasource-&gt;HasAssertion(aSource, aProperty, aTarget, aTruthValue, aResult);</span>
<a href="#l4.940"></a><span id="l4.940" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l4.941"></a><span id="l4.941" class="difflineminus">-</span>
<a href="#l4.942"></a><span id="l4.942" class="difflineminus">-        if (*aResult)</span>
<a href="#l4.943"></a><span id="l4.943" class="difflineminus">-            return NS_OK;</span>
<a href="#l4.944"></a><span id="l4.944" class="difflineminus">-</span>
<a href="#l4.945"></a><span id="l4.945" class="difflineminus">-        if (mAllowNegativeAssertions)</span>
<a href="#l4.946"></a><span id="l4.946" class="difflineminus">-        {</span>
<a href="#l4.947"></a><span id="l4.947" class="difflineminus">-            bool hasNegation;</span>
<a href="#l4.948"></a><span id="l4.948" class="difflineminus">-            rv = datasource-&gt;HasAssertion(aSource, aProperty, aTarget, !aTruthValue, &amp;hasNegation);</span>
<a href="#l4.949"></a><span id="l4.949" class="difflineminus">-            if (NS_FAILED(rv)) return rv;</span>
<a href="#l4.950"></a><span id="l4.950" class="difflineminus">-</span>
<a href="#l4.951"></a><span id="l4.951" class="difflineminus">-            if (hasNegation)</span>
<a href="#l4.952"></a><span id="l4.952" class="difflineminus">-            {</span>
<a href="#l4.953"></a><span id="l4.953" class="difflineminus">-                *aResult = false;</span>
<a href="#l4.954"></a><span id="l4.954" class="difflineminus">-                return NS_OK;</span>
<a href="#l4.955"></a><span id="l4.955" class="difflineminus">-            }</span>
<a href="#l4.956"></a><span id="l4.956" class="difflineminus">-        }</span>
<a href="#l4.957"></a><span id="l4.957" class="difflineminus">-    }</span>
<a href="#l4.958"></a><span id="l4.958" class="difflineminus">-</span>
<a href="#l4.959"></a><span id="l4.959" class="difflineminus">-    // If we get here, nobody had the assertion at all</span>
<a href="#l4.960"></a><span id="l4.960" class="difflineminus">-    *aResult = false;</span>
<a href="#l4.961"></a><span id="l4.961" class="difflineminus">-    return NS_OK;</span>
<a href="#l4.962"></a><span id="l4.962" class="difflineminus">-}</span>
<a href="#l4.963"></a><span id="l4.963" class="difflineminus">-</span>
<a href="#l4.964"></a><span id="l4.964" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l4.965"></a><span id="l4.965" class="difflineminus">-CompositeDataSourceImpl::AddObserver(nsIRDFObserver* aObserver)</span>
<a href="#l4.966"></a><span id="l4.966" class="difflineminus">-{</span>
<a href="#l4.967"></a><span id="l4.967" class="difflineminus">-    NS_ASSERTION(aObserver != nullptr, &quot;null ptr&quot;);</span>
<a href="#l4.968"></a><span id="l4.968" class="difflineminus">-    if (! aObserver)</span>
<a href="#l4.969"></a><span id="l4.969" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l4.970"></a><span id="l4.970" class="difflineminus">-</span>
<a href="#l4.971"></a><span id="l4.971" class="difflineminus">-    // XXX ensure uniqueness?</span>
<a href="#l4.972"></a><span id="l4.972" class="difflineminus">-    mObservers.AppendObject(aObserver);</span>
<a href="#l4.973"></a><span id="l4.973" class="difflineminus">-</span>
<a href="#l4.974"></a><span id="l4.974" class="difflineminus">-    return NS_OK;</span>
<a href="#l4.975"></a><span id="l4.975" class="difflineminus">-}</span>
<a href="#l4.976"></a><span id="l4.976" class="difflineminus">-</span>
<a href="#l4.977"></a><span id="l4.977" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l4.978"></a><span id="l4.978" class="difflineminus">-CompositeDataSourceImpl::RemoveObserver(nsIRDFObserver* aObserver)</span>
<a href="#l4.979"></a><span id="l4.979" class="difflineminus">-{</span>
<a href="#l4.980"></a><span id="l4.980" class="difflineminus">-    NS_ASSERTION(aObserver != nullptr, &quot;null ptr&quot;);</span>
<a href="#l4.981"></a><span id="l4.981" class="difflineminus">-    if (! aObserver)</span>
<a href="#l4.982"></a><span id="l4.982" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l4.983"></a><span id="l4.983" class="difflineminus">-</span>
<a href="#l4.984"></a><span id="l4.984" class="difflineminus">-    mObservers.RemoveObject(aObserver);</span>
<a href="#l4.985"></a><span id="l4.985" class="difflineminus">-</span>
<a href="#l4.986"></a><span id="l4.986" class="difflineminus">-    return NS_OK;</span>
<a href="#l4.987"></a><span id="l4.987" class="difflineminus">-}</span>
<a href="#l4.988"></a><span id="l4.988" class="difflineminus">-</span>
<a href="#l4.989"></a><span id="l4.989" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l4.990"></a><span id="l4.990" class="difflineminus">-CompositeDataSourceImpl::HasArcIn(nsIRDFNode *aNode, nsIRDFResource *aArc, bool *result)</span>
<a href="#l4.991"></a><span id="l4.991" class="difflineminus">-{</span>
<a href="#l4.992"></a><span id="l4.992" class="difflineminus">-    nsresult rv;</span>
<a href="#l4.993"></a><span id="l4.993" class="difflineminus">-    *result = false;</span>
<a href="#l4.994"></a><span id="l4.994" class="difflineminus">-    int32_t count = mDataSources.Count();</span>
<a href="#l4.995"></a><span id="l4.995" class="difflineminus">-    for (int32_t i = 0; i &lt; count; ++i) {</span>
<a href="#l4.996"></a><span id="l4.996" class="difflineminus">-        rv = mDataSources[i]-&gt;HasArcIn(aNode, aArc, result);</span>
<a href="#l4.997"></a><span id="l4.997" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l4.998"></a><span id="l4.998" class="difflineminus">-        if (*result)</span>
<a href="#l4.999"></a><span id="l4.999" class="difflineminus">-            return NS_OK;</span>
<a href="#l4.1000"></a><span id="l4.1000" class="difflineminus">-    }</span>
<a href="#l4.1001"></a><span id="l4.1001" class="difflineminus">-    return NS_OK;</span>
<a href="#l4.1002"></a><span id="l4.1002" class="difflineminus">-}</span>
<a href="#l4.1003"></a><span id="l4.1003" class="difflineminus">-</span>
<a href="#l4.1004"></a><span id="l4.1004" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l4.1005"></a><span id="l4.1005" class="difflineminus">-CompositeDataSourceImpl::HasArcOut(nsIRDFResource *aSource, nsIRDFResource *aArc, bool *result)</span>
<a href="#l4.1006"></a><span id="l4.1006" class="difflineminus">-{</span>
<a href="#l4.1007"></a><span id="l4.1007" class="difflineminus">-    nsresult rv;</span>
<a href="#l4.1008"></a><span id="l4.1008" class="difflineminus">-    *result = false;</span>
<a href="#l4.1009"></a><span id="l4.1009" class="difflineminus">-    int32_t count = mDataSources.Count();</span>
<a href="#l4.1010"></a><span id="l4.1010" class="difflineminus">-    for (int32_t i = 0; i &lt; count; ++i) {</span>
<a href="#l4.1011"></a><span id="l4.1011" class="difflineminus">-        rv = mDataSources[i]-&gt;HasArcOut(aSource, aArc, result);</span>
<a href="#l4.1012"></a><span id="l4.1012" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l4.1013"></a><span id="l4.1013" class="difflineminus">-        if (*result)</span>
<a href="#l4.1014"></a><span id="l4.1014" class="difflineminus">-            return NS_OK;</span>
<a href="#l4.1015"></a><span id="l4.1015" class="difflineminus">-    }</span>
<a href="#l4.1016"></a><span id="l4.1016" class="difflineminus">-    return NS_OK;</span>
<a href="#l4.1017"></a><span id="l4.1017" class="difflineminus">-}</span>
<a href="#l4.1018"></a><span id="l4.1018" class="difflineminus">-</span>
<a href="#l4.1019"></a><span id="l4.1019" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l4.1020"></a><span id="l4.1020" class="difflineminus">-CompositeDataSourceImpl::ArcLabelsIn(nsIRDFNode* aTarget, nsISimpleEnumerator** aResult)</span>
<a href="#l4.1021"></a><span id="l4.1021" class="difflineminus">-{</span>
<a href="#l4.1022"></a><span id="l4.1022" class="difflineminus">-    NS_ASSERTION(aTarget != nullptr, &quot;null ptr&quot;);</span>
<a href="#l4.1023"></a><span id="l4.1023" class="difflineminus">-    if (! aTarget)</span>
<a href="#l4.1024"></a><span id="l4.1024" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l4.1025"></a><span id="l4.1025" class="difflineminus">-</span>
<a href="#l4.1026"></a><span id="l4.1026" class="difflineminus">-    NS_ASSERTION(aResult != nullptr, &quot;null ptr&quot;);</span>
<a href="#l4.1027"></a><span id="l4.1027" class="difflineminus">-    if (! aResult)</span>
<a href="#l4.1028"></a><span id="l4.1028" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l4.1029"></a><span id="l4.1029" class="difflineminus">-</span>
<a href="#l4.1030"></a><span id="l4.1030" class="difflineminus">-    nsISimpleEnumerator* result =</span>
<a href="#l4.1031"></a><span id="l4.1031" class="difflineminus">-        new CompositeArcsInOutEnumeratorImpl(this, aTarget,</span>
<a href="#l4.1032"></a><span id="l4.1032" class="difflineminus">-                                             CompositeArcsInOutEnumeratorImpl::eArcsIn,</span>
<a href="#l4.1033"></a><span id="l4.1033" class="difflineminus">-                                             mAllowNegativeAssertions,</span>
<a href="#l4.1034"></a><span id="l4.1034" class="difflineminus">-                                             mCoalesceDuplicateArcs);</span>
<a href="#l4.1035"></a><span id="l4.1035" class="difflineminus">-</span>
<a href="#l4.1036"></a><span id="l4.1036" class="difflineminus">-    if (! result)</span>
<a href="#l4.1037"></a><span id="l4.1037" class="difflineminus">-        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l4.1038"></a><span id="l4.1038" class="difflineminus">-</span>
<a href="#l4.1039"></a><span id="l4.1039" class="difflineminus">-    NS_ADDREF(result);</span>
<a href="#l4.1040"></a><span id="l4.1040" class="difflineminus">-    *aResult = result;</span>
<a href="#l4.1041"></a><span id="l4.1041" class="difflineminus">-    return NS_OK;</span>
<a href="#l4.1042"></a><span id="l4.1042" class="difflineminus">-}</span>
<a href="#l4.1043"></a><span id="l4.1043" class="difflineminus">-</span>
<a href="#l4.1044"></a><span id="l4.1044" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l4.1045"></a><span id="l4.1045" class="difflineminus">-CompositeDataSourceImpl::ArcLabelsOut(nsIRDFResource* aSource,</span>
<a href="#l4.1046"></a><span id="l4.1046" class="difflineminus">-                                      nsISimpleEnumerator** aResult)</span>
<a href="#l4.1047"></a><span id="l4.1047" class="difflineminus">-{</span>
<a href="#l4.1048"></a><span id="l4.1048" class="difflineminus">-    NS_ASSERTION(aSource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l4.1049"></a><span id="l4.1049" class="difflineminus">-    if (! aSource)</span>
<a href="#l4.1050"></a><span id="l4.1050" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l4.1051"></a><span id="l4.1051" class="difflineminus">-</span>
<a href="#l4.1052"></a><span id="l4.1052" class="difflineminus">-    NS_ASSERTION(aResult != nullptr, &quot;null ptr&quot;);</span>
<a href="#l4.1053"></a><span id="l4.1053" class="difflineminus">-    if (! aResult)</span>
<a href="#l4.1054"></a><span id="l4.1054" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l4.1055"></a><span id="l4.1055" class="difflineminus">-</span>
<a href="#l4.1056"></a><span id="l4.1056" class="difflineminus">-    nsISimpleEnumerator* result =</span>
<a href="#l4.1057"></a><span id="l4.1057" class="difflineminus">-        new CompositeArcsInOutEnumeratorImpl(this, aSource,</span>
<a href="#l4.1058"></a><span id="l4.1058" class="difflineminus">-                                             CompositeArcsInOutEnumeratorImpl::eArcsOut,</span>
<a href="#l4.1059"></a><span id="l4.1059" class="difflineminus">-                                             mAllowNegativeAssertions,</span>
<a href="#l4.1060"></a><span id="l4.1060" class="difflineminus">-                                             mCoalesceDuplicateArcs);</span>
<a href="#l4.1061"></a><span id="l4.1061" class="difflineminus">-</span>
<a href="#l4.1062"></a><span id="l4.1062" class="difflineminus">-    if (! result)</span>
<a href="#l4.1063"></a><span id="l4.1063" class="difflineminus">-        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l4.1064"></a><span id="l4.1064" class="difflineminus">-</span>
<a href="#l4.1065"></a><span id="l4.1065" class="difflineminus">-    NS_ADDREF(result);</span>
<a href="#l4.1066"></a><span id="l4.1066" class="difflineminus">-    *aResult = result;</span>
<a href="#l4.1067"></a><span id="l4.1067" class="difflineminus">-    return NS_OK;</span>
<a href="#l4.1068"></a><span id="l4.1068" class="difflineminus">-}</span>
<a href="#l4.1069"></a><span id="l4.1069" class="difflineminus">-</span>
<a href="#l4.1070"></a><span id="l4.1070" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l4.1071"></a><span id="l4.1071" class="difflineminus">-CompositeDataSourceImpl::GetAllResources(nsISimpleEnumerator** aResult)</span>
<a href="#l4.1072"></a><span id="l4.1072" class="difflineminus">-{</span>
<a href="#l4.1073"></a><span id="l4.1073" class="difflineminus">-    MOZ_ASSERT_UNREACHABLE(&quot;CompositeDataSourceImpl::GetAllResources&quot;);</span>
<a href="#l4.1074"></a><span id="l4.1074" class="difflineminus">-    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l4.1075"></a><span id="l4.1075" class="difflineminus">-}</span>
<a href="#l4.1076"></a><span id="l4.1076" class="difflineminus">-</span>
<a href="#l4.1077"></a><span id="l4.1077" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l4.1078"></a><span id="l4.1078" class="difflineminus">-CompositeDataSourceImpl::GetAllCmds(nsIRDFResource* source,</span>
<a href="#l4.1079"></a><span id="l4.1079" class="difflineminus">-                                    nsISimpleEnumerator/*&lt;nsIRDFResource&gt;*/** result)</span>
<a href="#l4.1080"></a><span id="l4.1080" class="difflineminus">-{</span>
<a href="#l4.1081"></a><span id="l4.1081" class="difflineminus">-    nsresult rv;</span>
<a href="#l4.1082"></a><span id="l4.1082" class="difflineminus">-    nsCOMPtr&lt;nsISimpleEnumerator&gt; set;</span>
<a href="#l4.1083"></a><span id="l4.1083" class="difflineminus">-</span>
<a href="#l4.1084"></a><span id="l4.1084" class="difflineminus">-    for (int32_t i = 0; i &lt; mDataSources.Count(); i++)</span>
<a href="#l4.1085"></a><span id="l4.1085" class="difflineminus">-    {</span>
<a href="#l4.1086"></a><span id="l4.1086" class="difflineminus">-        nsCOMPtr&lt;nsISimpleEnumerator&gt; dsCmds;</span>
<a href="#l4.1087"></a><span id="l4.1087" class="difflineminus">-</span>
<a href="#l4.1088"></a><span id="l4.1088" class="difflineminus">-        rv = mDataSources[i]-&gt;GetAllCmds(source, getter_AddRefs(dsCmds));</span>
<a href="#l4.1089"></a><span id="l4.1089" class="difflineminus">-        if (NS_SUCCEEDED(rv))</span>
<a href="#l4.1090"></a><span id="l4.1090" class="difflineminus">-        {</span>
<a href="#l4.1091"></a><span id="l4.1091" class="difflineminus">-            nsCOMPtr&lt;nsISimpleEnumerator&gt; tmp;</span>
<a href="#l4.1092"></a><span id="l4.1092" class="difflineminus">-            rv = NS_NewUnionEnumerator(getter_AddRefs(tmp), set, dsCmds);</span>
<a href="#l4.1093"></a><span id="l4.1093" class="difflineminus">-            set.swap(tmp);</span>
<a href="#l4.1094"></a><span id="l4.1094" class="difflineminus">-            if (NS_FAILED(rv)) return(rv);</span>
<a href="#l4.1095"></a><span id="l4.1095" class="difflineminus">-        }</span>
<a href="#l4.1096"></a><span id="l4.1096" class="difflineminus">-    }</span>
<a href="#l4.1097"></a><span id="l4.1097" class="difflineminus">-</span>
<a href="#l4.1098"></a><span id="l4.1098" class="difflineminus">-    set.forget(result);</span>
<a href="#l4.1099"></a><span id="l4.1099" class="difflineminus">-    return NS_OK;</span>
<a href="#l4.1100"></a><span id="l4.1100" class="difflineminus">-}</span>
<a href="#l4.1101"></a><span id="l4.1101" class="difflineminus">-</span>
<a href="#l4.1102"></a><span id="l4.1102" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l4.1103"></a><span id="l4.1103" class="difflineminus">-CompositeDataSourceImpl::IsCommandEnabled(nsISupports/* nsIRDFResource container */* aSources,</span>
<a href="#l4.1104"></a><span id="l4.1104" class="difflineminus">-                                          nsIRDFResource*   aCommand,</span>
<a href="#l4.1105"></a><span id="l4.1105" class="difflineminus">-                                          nsISupports/* nsIRDFResource container */* aArguments,</span>
<a href="#l4.1106"></a><span id="l4.1106" class="difflineminus">-                                          bool* aResult)</span>
<a href="#l4.1107"></a><span id="l4.1107" class="difflineminus">-{</span>
<a href="#l4.1108"></a><span id="l4.1108" class="difflineminus">-    nsresult rv;</span>
<a href="#l4.1109"></a><span id="l4.1109" class="difflineminus">-    for (int32_t i = mDataSources.Count() - 1; i &gt;= 0; --i) {</span>
<a href="#l4.1110"></a><span id="l4.1110" class="difflineminus">-        bool enabled = true;</span>
<a href="#l4.1111"></a><span id="l4.1111" class="difflineminus">-        rv = mDataSources[i]-&gt;IsCommandEnabled(aSources, aCommand, aArguments, &amp;enabled);</span>
<a href="#l4.1112"></a><span id="l4.1112" class="difflineminus">-        if (NS_FAILED(rv) &amp;&amp; (rv != NS_ERROR_NOT_IMPLEMENTED))</span>
<a href="#l4.1113"></a><span id="l4.1113" class="difflineminus">-        {</span>
<a href="#l4.1114"></a><span id="l4.1114" class="difflineminus">-            return(rv);</span>
<a href="#l4.1115"></a><span id="l4.1115" class="difflineminus">-        }</span>
<a href="#l4.1116"></a><span id="l4.1116" class="difflineminus">-</span>
<a href="#l4.1117"></a><span id="l4.1117" class="difflineminus">-        if (! enabled) {</span>
<a href="#l4.1118"></a><span id="l4.1118" class="difflineminus">-            *aResult = false;</span>
<a href="#l4.1119"></a><span id="l4.1119" class="difflineminus">-            return(NS_OK);</span>
<a href="#l4.1120"></a><span id="l4.1120" class="difflineminus">-        }</span>
<a href="#l4.1121"></a><span id="l4.1121" class="difflineminus">-    }</span>
<a href="#l4.1122"></a><span id="l4.1122" class="difflineminus">-    *aResult = true;</span>
<a href="#l4.1123"></a><span id="l4.1123" class="difflineminus">-    return(NS_OK);</span>
<a href="#l4.1124"></a><span id="l4.1124" class="difflineminus">-}</span>
<a href="#l4.1125"></a><span id="l4.1125" class="difflineminus">-</span>
<a href="#l4.1126"></a><span id="l4.1126" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l4.1127"></a><span id="l4.1127" class="difflineminus">-CompositeDataSourceImpl::DoCommand(nsISupports/* nsIRDFResource container */* aSources,</span>
<a href="#l4.1128"></a><span id="l4.1128" class="difflineminus">-                                   nsIRDFResource*   aCommand,</span>
<a href="#l4.1129"></a><span id="l4.1129" class="difflineminus">-                                   nsISupports/* nsIRDFResource container */* aArguments)</span>
<a href="#l4.1130"></a><span id="l4.1130" class="difflineminus">-{</span>
<a href="#l4.1131"></a><span id="l4.1131" class="difflineminus">-    for (int32_t i = mDataSources.Count() - 1; i &gt;= 0; --i) {</span>
<a href="#l4.1132"></a><span id="l4.1132" class="difflineminus">-        nsresult rv = mDataSources[i]-&gt;DoCommand(aSources, aCommand, aArguments);</span>
<a href="#l4.1133"></a><span id="l4.1133" class="difflineminus">-        if (NS_FAILED(rv) &amp;&amp; (rv != NS_ERROR_NOT_IMPLEMENTED))</span>
<a href="#l4.1134"></a><span id="l4.1134" class="difflineminus">-        {</span>
<a href="#l4.1135"></a><span id="l4.1135" class="difflineminus">-            return(rv);   // all datasources must succeed</span>
<a href="#l4.1136"></a><span id="l4.1136" class="difflineminus">-        }</span>
<a href="#l4.1137"></a><span id="l4.1137" class="difflineminus">-    }</span>
<a href="#l4.1138"></a><span id="l4.1138" class="difflineminus">-    return(NS_OK);</span>
<a href="#l4.1139"></a><span id="l4.1139" class="difflineminus">-}</span>
<a href="#l4.1140"></a><span id="l4.1140" class="difflineminus">-</span>
<a href="#l4.1141"></a><span id="l4.1141" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l4.1142"></a><span id="l4.1142" class="difflineminus">-CompositeDataSourceImpl::BeginUpdateBatch()</span>
<a href="#l4.1143"></a><span id="l4.1143" class="difflineminus">-{</span>
<a href="#l4.1144"></a><span id="l4.1144" class="difflineminus">-    for (int32_t i = mDataSources.Count() - 1; i &gt;= 0; --i) {</span>
<a href="#l4.1145"></a><span id="l4.1145" class="difflineminus">-        mDataSources[i]-&gt;BeginUpdateBatch();</span>
<a href="#l4.1146"></a><span id="l4.1146" class="difflineminus">-    }</span>
<a href="#l4.1147"></a><span id="l4.1147" class="difflineminus">-    return NS_OK;</span>
<a href="#l4.1148"></a><span id="l4.1148" class="difflineminus">-}</span>
<a href="#l4.1149"></a><span id="l4.1149" class="difflineminus">-</span>
<a href="#l4.1150"></a><span id="l4.1150" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l4.1151"></a><span id="l4.1151" class="difflineminus">-CompositeDataSourceImpl::EndUpdateBatch()</span>
<a href="#l4.1152"></a><span id="l4.1152" class="difflineminus">-{</span>
<a href="#l4.1153"></a><span id="l4.1153" class="difflineminus">-    for (int32_t i = mDataSources.Count() - 1; i &gt;= 0; --i) {</span>
<a href="#l4.1154"></a><span id="l4.1154" class="difflineminus">-        mDataSources[i]-&gt;EndUpdateBatch();</span>
<a href="#l4.1155"></a><span id="l4.1155" class="difflineminus">-    }</span>
<a href="#l4.1156"></a><span id="l4.1156" class="difflineminus">-    return NS_OK;</span>
<a href="#l4.1157"></a><span id="l4.1157" class="difflineminus">-}</span>
<a href="#l4.1158"></a><span id="l4.1158" class="difflineminus">-</span>
<a href="#l4.1159"></a><span id="l4.1159" class="difflineminus">-////////////////////////////////////////////////////////////////////////</span>
<a href="#l4.1160"></a><span id="l4.1160" class="difflineminus">-// nsIRDFCompositeDataSource methods</span>
<a href="#l4.1161"></a><span id="l4.1161" class="difflineminus">-// XXX rvg We should make this take an additional argument specifying where</span>
<a href="#l4.1162"></a><span id="l4.1162" class="difflineminus">-// in the sequence of data sources (of the db), the new data source should</span>
<a href="#l4.1163"></a><span id="l4.1163" class="difflineminus">-// fit in. Right now, the new datasource gets stuck at the end.</span>
<a href="#l4.1164"></a><span id="l4.1164" class="difflineminus">-// need to add the observers of the CompositeDataSourceImpl to the new data source.</span>
<a href="#l4.1165"></a><span id="l4.1165" class="difflineminus">-</span>
<a href="#l4.1166"></a><span id="l4.1166" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l4.1167"></a><span id="l4.1167" class="difflineminus">-CompositeDataSourceImpl::GetAllowNegativeAssertions(bool *aAllowNegativeAssertions)</span>
<a href="#l4.1168"></a><span id="l4.1168" class="difflineminus">-{</span>
<a href="#l4.1169"></a><span id="l4.1169" class="difflineminus">-	*aAllowNegativeAssertions = mAllowNegativeAssertions;</span>
<a href="#l4.1170"></a><span id="l4.1170" class="difflineminus">-	return(NS_OK);</span>
<a href="#l4.1171"></a><span id="l4.1171" class="difflineminus">-}</span>
<a href="#l4.1172"></a><span id="l4.1172" class="difflineminus">-</span>
<a href="#l4.1173"></a><span id="l4.1173" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l4.1174"></a><span id="l4.1174" class="difflineminus">-CompositeDataSourceImpl::SetAllowNegativeAssertions(bool aAllowNegativeAssertions)</span>
<a href="#l4.1175"></a><span id="l4.1175" class="difflineminus">-{</span>
<a href="#l4.1176"></a><span id="l4.1176" class="difflineminus">-	mAllowNegativeAssertions = aAllowNegativeAssertions;</span>
<a href="#l4.1177"></a><span id="l4.1177" class="difflineminus">-	return(NS_OK);</span>
<a href="#l4.1178"></a><span id="l4.1178" class="difflineminus">-}</span>
<a href="#l4.1179"></a><span id="l4.1179" class="difflineminus">-</span>
<a href="#l4.1180"></a><span id="l4.1180" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l4.1181"></a><span id="l4.1181" class="difflineminus">-CompositeDataSourceImpl::GetCoalesceDuplicateArcs(bool *aCoalesceDuplicateArcs)</span>
<a href="#l4.1182"></a><span id="l4.1182" class="difflineminus">-{</span>
<a href="#l4.1183"></a><span id="l4.1183" class="difflineminus">-	*aCoalesceDuplicateArcs = mCoalesceDuplicateArcs;</span>
<a href="#l4.1184"></a><span id="l4.1184" class="difflineminus">-	return(NS_OK);</span>
<a href="#l4.1185"></a><span id="l4.1185" class="difflineminus">-}</span>
<a href="#l4.1186"></a><span id="l4.1186" class="difflineminus">-</span>
<a href="#l4.1187"></a><span id="l4.1187" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l4.1188"></a><span id="l4.1188" class="difflineminus">-CompositeDataSourceImpl::SetCoalesceDuplicateArcs(bool aCoalesceDuplicateArcs)</span>
<a href="#l4.1189"></a><span id="l4.1189" class="difflineminus">-{</span>
<a href="#l4.1190"></a><span id="l4.1190" class="difflineminus">-	mCoalesceDuplicateArcs = aCoalesceDuplicateArcs;</span>
<a href="#l4.1191"></a><span id="l4.1191" class="difflineminus">-	return(NS_OK);</span>
<a href="#l4.1192"></a><span id="l4.1192" class="difflineminus">-}</span>
<a href="#l4.1193"></a><span id="l4.1193" class="difflineminus">-</span>
<a href="#l4.1194"></a><span id="l4.1194" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l4.1195"></a><span id="l4.1195" class="difflineminus">-CompositeDataSourceImpl::AddDataSource(nsIRDFDataSource* aDataSource)</span>
<a href="#l4.1196"></a><span id="l4.1196" class="difflineminus">-{</span>
<a href="#l4.1197"></a><span id="l4.1197" class="difflineminus">-    NS_ASSERTION(aDataSource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l4.1198"></a><span id="l4.1198" class="difflineminus">-    if (! aDataSource)</span>
<a href="#l4.1199"></a><span id="l4.1199" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l4.1200"></a><span id="l4.1200" class="difflineminus">-</span>
<a href="#l4.1201"></a><span id="l4.1201" class="difflineminus">-    mDataSources.AppendObject(aDataSource);</span>
<a href="#l4.1202"></a><span id="l4.1202" class="difflineminus">-    aDataSource-&gt;AddObserver(this);</span>
<a href="#l4.1203"></a><span id="l4.1203" class="difflineminus">-    return NS_OK;</span>
<a href="#l4.1204"></a><span id="l4.1204" class="difflineminus">-}</span>
<a href="#l4.1205"></a><span id="l4.1205" class="difflineminus">-</span>
<a href="#l4.1206"></a><span id="l4.1206" class="difflineminus">-</span>
<a href="#l4.1207"></a><span id="l4.1207" class="difflineminus">-</span>
<a href="#l4.1208"></a><span id="l4.1208" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l4.1209"></a><span id="l4.1209" class="difflineminus">-CompositeDataSourceImpl::RemoveDataSource(nsIRDFDataSource* aDataSource)</span>
<a href="#l4.1210"></a><span id="l4.1210" class="difflineminus">-{</span>
<a href="#l4.1211"></a><span id="l4.1211" class="difflineminus">-    NS_ASSERTION(aDataSource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l4.1212"></a><span id="l4.1212" class="difflineminus">-    if (! aDataSource)</span>
<a href="#l4.1213"></a><span id="l4.1213" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l4.1214"></a><span id="l4.1214" class="difflineminus">-</span>
<a href="#l4.1215"></a><span id="l4.1215" class="difflineminus">-</span>
<a href="#l4.1216"></a><span id="l4.1216" class="difflineminus">-    if (mDataSources.IndexOf(aDataSource) &gt;= 0) {</span>
<a href="#l4.1217"></a><span id="l4.1217" class="difflineminus">-        aDataSource-&gt;RemoveObserver(this);</span>
<a href="#l4.1218"></a><span id="l4.1218" class="difflineminus">-        mDataSources.RemoveObject(aDataSource);</span>
<a href="#l4.1219"></a><span id="l4.1219" class="difflineminus">-    }</span>
<a href="#l4.1220"></a><span id="l4.1220" class="difflineminus">-    return NS_OK;</span>
<a href="#l4.1221"></a><span id="l4.1221" class="difflineminus">-}</span>
<a href="#l4.1222"></a><span id="l4.1222" class="difflineminus">-</span>
<a href="#l4.1223"></a><span id="l4.1223" class="difflineminus">-</span>
<a href="#l4.1224"></a><span id="l4.1224" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l4.1225"></a><span id="l4.1225" class="difflineminus">-CompositeDataSourceImpl::GetDataSources(nsISimpleEnumerator** _result)</span>
<a href="#l4.1226"></a><span id="l4.1226" class="difflineminus">-{</span>
<a href="#l4.1227"></a><span id="l4.1227" class="difflineminus">-    // NS_NewArrayEnumerator for an nsCOMArray takes a snapshot of the</span>
<a href="#l4.1228"></a><span id="l4.1228" class="difflineminus">-    // current state.</span>
<a href="#l4.1229"></a><span id="l4.1229" class="difflineminus">-    return NS_NewArrayEnumerator(_result, mDataSources);</span>
<a href="#l4.1230"></a><span id="l4.1230" class="difflineminus">-}</span>
<a href="#l4.1231"></a><span id="l4.1231" class="difflineminus">-</span>
<a href="#l4.1232"></a><span id="l4.1232" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l4.1233"></a><span id="l4.1233" class="difflineminus">-CompositeDataSourceImpl::OnAssert(nsIRDFDataSource* aDataSource,</span>
<a href="#l4.1234"></a><span id="l4.1234" class="difflineminus">-                                  nsIRDFResource* aSource,</span>
<a href="#l4.1235"></a><span id="l4.1235" class="difflineminus">-                                  nsIRDFResource* aProperty,</span>
<a href="#l4.1236"></a><span id="l4.1236" class="difflineminus">-                                  nsIRDFNode* aTarget)</span>
<a href="#l4.1237"></a><span id="l4.1237" class="difflineminus">-{</span>
<a href="#l4.1238"></a><span id="l4.1238" class="difflineminus">-    // Make sure that the assertion isn't masked by another</span>
<a href="#l4.1239"></a><span id="l4.1239" class="difflineminus">-    // datasource.</span>
<a href="#l4.1240"></a><span id="l4.1240" class="difflineminus">-    //</span>
<a href="#l4.1241"></a><span id="l4.1241" class="difflineminus">-    // XXX We could make this more efficient if we knew _which_</span>
<a href="#l4.1242"></a><span id="l4.1242" class="difflineminus">-    // datasource actually served up the OnAssert(): we could use</span>
<a href="#l4.1243"></a><span id="l4.1243" class="difflineminus">-    // HasAssertionN() to only search datasources _before_ the</span>
<a href="#l4.1244"></a><span id="l4.1244" class="difflineminus">-    // datasource that coughed up the assertion.</span>
<a href="#l4.1245"></a><span id="l4.1245" class="difflineminus">-	nsresult	rv = NS_OK;</span>
<a href="#l4.1246"></a><span id="l4.1246" class="difflineminus">-</span>
<a href="#l4.1247"></a><span id="l4.1247" class="difflineminus">-	if (mAllowNegativeAssertions)</span>
<a href="#l4.1248"></a><span id="l4.1248" class="difflineminus">-	{</span>
<a href="#l4.1249"></a><span id="l4.1249" class="difflineminus">-		bool hasAssertion;</span>
<a href="#l4.1250"></a><span id="l4.1250" class="difflineminus">-		rv = HasAssertion(aSource, aProperty, aTarget, true, &amp;hasAssertion);</span>
<a href="#l4.1251"></a><span id="l4.1251" class="difflineminus">-		if (NS_FAILED(rv)) return rv;</span>
<a href="#l4.1252"></a><span id="l4.1252" class="difflineminus">-</span>
<a href="#l4.1253"></a><span id="l4.1253" class="difflineminus">-		if (! hasAssertion)</span>
<a href="#l4.1254"></a><span id="l4.1254" class="difflineminus">-			return(NS_OK);</span>
<a href="#l4.1255"></a><span id="l4.1255" class="difflineminus">-	}</span>
<a href="#l4.1256"></a><span id="l4.1256" class="difflineminus">-</span>
<a href="#l4.1257"></a><span id="l4.1257" class="difflineminus">-    for (int32_t i = mObservers.Count() - 1; i &gt;= 0; --i) {</span>
<a href="#l4.1258"></a><span id="l4.1258" class="difflineminus">-        mObservers[i]-&gt;OnAssert(this, aSource, aProperty, aTarget);</span>
<a href="#l4.1259"></a><span id="l4.1259" class="difflineminus">-    }</span>
<a href="#l4.1260"></a><span id="l4.1260" class="difflineminus">-    return NS_OK;</span>
<a href="#l4.1261"></a><span id="l4.1261" class="difflineminus">-}</span>
<a href="#l4.1262"></a><span id="l4.1262" class="difflineminus">-</span>
<a href="#l4.1263"></a><span id="l4.1263" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l4.1264"></a><span id="l4.1264" class="difflineminus">-CompositeDataSourceImpl::OnUnassert(nsIRDFDataSource* aDataSource,</span>
<a href="#l4.1265"></a><span id="l4.1265" class="difflineminus">-                                    nsIRDFResource* aSource,</span>
<a href="#l4.1266"></a><span id="l4.1266" class="difflineminus">-                                    nsIRDFResource* aProperty,</span>
<a href="#l4.1267"></a><span id="l4.1267" class="difflineminus">-                                    nsIRDFNode* aTarget)</span>
<a href="#l4.1268"></a><span id="l4.1268" class="difflineminus">-{</span>
<a href="#l4.1269"></a><span id="l4.1269" class="difflineminus">-    // Make sure that the un-assertion doesn't just unmask the</span>
<a href="#l4.1270"></a><span id="l4.1270" class="difflineminus">-    // same assertion in a different datasource.</span>
<a href="#l4.1271"></a><span id="l4.1271" class="difflineminus">-    //</span>
<a href="#l4.1272"></a><span id="l4.1272" class="difflineminus">-    // XXX We could make this more efficient if we knew _which_</span>
<a href="#l4.1273"></a><span id="l4.1273" class="difflineminus">-    // datasource actually served up the OnAssert(): we could use</span>
<a href="#l4.1274"></a><span id="l4.1274" class="difflineminus">-    // HasAssertionN() to only search datasources _before_ the</span>
<a href="#l4.1275"></a><span id="l4.1275" class="difflineminus">-    // datasource that coughed up the assertion.</span>
<a href="#l4.1276"></a><span id="l4.1276" class="difflineminus">-    nsresult rv;</span>
<a href="#l4.1277"></a><span id="l4.1277" class="difflineminus">-</span>
<a href="#l4.1278"></a><span id="l4.1278" class="difflineminus">-	if (mAllowNegativeAssertions)</span>
<a href="#l4.1279"></a><span id="l4.1279" class="difflineminus">-	{</span>
<a href="#l4.1280"></a><span id="l4.1280" class="difflineminus">-		bool hasAssertion;</span>
<a href="#l4.1281"></a><span id="l4.1281" class="difflineminus">-		rv = HasAssertion(aSource, aProperty, aTarget, true, &amp;hasAssertion);</span>
<a href="#l4.1282"></a><span id="l4.1282" class="difflineminus">-		if (NS_FAILED(rv)) return rv;</span>
<a href="#l4.1283"></a><span id="l4.1283" class="difflineminus">-</span>
<a href="#l4.1284"></a><span id="l4.1284" class="difflineminus">-		if (hasAssertion)</span>
<a href="#l4.1285"></a><span id="l4.1285" class="difflineminus">-			return NS_OK;</span>
<a href="#l4.1286"></a><span id="l4.1286" class="difflineminus">-	}</span>
<a href="#l4.1287"></a><span id="l4.1287" class="difflineminus">-</span>
<a href="#l4.1288"></a><span id="l4.1288" class="difflineminus">-    for (int32_t i = mObservers.Count() - 1; i &gt;= 0; --i) {</span>
<a href="#l4.1289"></a><span id="l4.1289" class="difflineminus">-        mObservers[i]-&gt;OnUnassert(this, aSource, aProperty, aTarget);</span>
<a href="#l4.1290"></a><span id="l4.1290" class="difflineminus">-    }</span>
<a href="#l4.1291"></a><span id="l4.1291" class="difflineminus">-    return NS_OK;</span>
<a href="#l4.1292"></a><span id="l4.1292" class="difflineminus">-}</span>
<a href="#l4.1293"></a><span id="l4.1293" class="difflineminus">-</span>
<a href="#l4.1294"></a><span id="l4.1294" class="difflineminus">-</span>
<a href="#l4.1295"></a><span id="l4.1295" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l4.1296"></a><span id="l4.1296" class="difflineminus">-CompositeDataSourceImpl::OnChange(nsIRDFDataSource* aDataSource,</span>
<a href="#l4.1297"></a><span id="l4.1297" class="difflineminus">-                                  nsIRDFResource* aSource,</span>
<a href="#l4.1298"></a><span id="l4.1298" class="difflineminus">-                                  nsIRDFResource* aProperty,</span>
<a href="#l4.1299"></a><span id="l4.1299" class="difflineminus">-                                  nsIRDFNode* aOldTarget,</span>
<a href="#l4.1300"></a><span id="l4.1300" class="difflineminus">-                                  nsIRDFNode* aNewTarget)</span>
<a href="#l4.1301"></a><span id="l4.1301" class="difflineminus">-{</span>
<a href="#l4.1302"></a><span id="l4.1302" class="difflineminus">-    // Make sure that the change is actually visible, and not hidden</span>
<a href="#l4.1303"></a><span id="l4.1303" class="difflineminus">-    // by an assertion in a different datasource.</span>
<a href="#l4.1304"></a><span id="l4.1304" class="difflineminus">-    //</span>
<a href="#l4.1305"></a><span id="l4.1305" class="difflineminus">-    // XXX Because of aggregation, this could actually mutate into a</span>
<a href="#l4.1306"></a><span id="l4.1306" class="difflineminus">-    // variety of OnAssert or OnChange notifications, which we'll</span>
<a href="#l4.1307"></a><span id="l4.1307" class="difflineminus">-    // ignore for now :-/.</span>
<a href="#l4.1308"></a><span id="l4.1308" class="difflineminus">-    for (int32_t i = mObservers.Count() - 1; i &gt;= 0; --i) {</span>
<a href="#l4.1309"></a><span id="l4.1309" class="difflineminus">-        mObservers[i]-&gt;OnChange(this, aSource, aProperty,</span>
<a href="#l4.1310"></a><span id="l4.1310" class="difflineminus">-                                aOldTarget, aNewTarget);</span>
<a href="#l4.1311"></a><span id="l4.1311" class="difflineminus">-    }</span>
<a href="#l4.1312"></a><span id="l4.1312" class="difflineminus">-    return NS_OK;</span>
<a href="#l4.1313"></a><span id="l4.1313" class="difflineminus">-}</span>
<a href="#l4.1314"></a><span id="l4.1314" class="difflineminus">-</span>
<a href="#l4.1315"></a><span id="l4.1315" class="difflineminus">-</span>
<a href="#l4.1316"></a><span id="l4.1316" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l4.1317"></a><span id="l4.1317" class="difflineminus">-CompositeDataSourceImpl::OnMove(nsIRDFDataSource* aDataSource,</span>
<a href="#l4.1318"></a><span id="l4.1318" class="difflineminus">-                                nsIRDFResource* aOldSource,</span>
<a href="#l4.1319"></a><span id="l4.1319" class="difflineminus">-                                nsIRDFResource* aNewSource,</span>
<a href="#l4.1320"></a><span id="l4.1320" class="difflineminus">-                                nsIRDFResource* aProperty,</span>
<a href="#l4.1321"></a><span id="l4.1321" class="difflineminus">-                                nsIRDFNode* aTarget)</span>
<a href="#l4.1322"></a><span id="l4.1322" class="difflineminus">-{</span>
<a href="#l4.1323"></a><span id="l4.1323" class="difflineminus">-    // Make sure that the move is actually visible, and not hidden</span>
<a href="#l4.1324"></a><span id="l4.1324" class="difflineminus">-    // by an assertion in a different datasource.</span>
<a href="#l4.1325"></a><span id="l4.1325" class="difflineminus">-    //</span>
<a href="#l4.1326"></a><span id="l4.1326" class="difflineminus">-    // XXX Because of aggregation, this could actually mutate into a</span>
<a href="#l4.1327"></a><span id="l4.1327" class="difflineminus">-    // variety of OnAssert or OnMove notifications, which we'll</span>
<a href="#l4.1328"></a><span id="l4.1328" class="difflineminus">-    // ignore for now :-/.</span>
<a href="#l4.1329"></a><span id="l4.1329" class="difflineminus">-    for (int32_t i = mObservers.Count() - 1; i &gt;= 0; --i) {</span>
<a href="#l4.1330"></a><span id="l4.1330" class="difflineminus">-        mObservers[i]-&gt;OnMove(this, aOldSource, aNewSource,</span>
<a href="#l4.1331"></a><span id="l4.1331" class="difflineminus">-                              aProperty, aTarget);</span>
<a href="#l4.1332"></a><span id="l4.1332" class="difflineminus">-    }</span>
<a href="#l4.1333"></a><span id="l4.1333" class="difflineminus">-    return NS_OK;</span>
<a href="#l4.1334"></a><span id="l4.1334" class="difflineminus">-}</span>
<a href="#l4.1335"></a><span id="l4.1335" class="difflineminus">-</span>
<a href="#l4.1336"></a><span id="l4.1336" class="difflineminus">-</span>
<a href="#l4.1337"></a><span id="l4.1337" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l4.1338"></a><span id="l4.1338" class="difflineminus">-CompositeDataSourceImpl::OnBeginUpdateBatch(nsIRDFDataSource* aDataSource)</span>
<a href="#l4.1339"></a><span id="l4.1339" class="difflineminus">-{</span>
<a href="#l4.1340"></a><span id="l4.1340" class="difflineminus">-    if (mUpdateBatchNest++ == 0) {</span>
<a href="#l4.1341"></a><span id="l4.1341" class="difflineminus">-        for (int32_t i = mObservers.Count() - 1; i &gt;= 0; --i) {</span>
<a href="#l4.1342"></a><span id="l4.1342" class="difflineminus">-            mObservers[i]-&gt;OnBeginUpdateBatch(this);</span>
<a href="#l4.1343"></a><span id="l4.1343" class="difflineminus">-        }</span>
<a href="#l4.1344"></a><span id="l4.1344" class="difflineminus">-    }</span>
<a href="#l4.1345"></a><span id="l4.1345" class="difflineminus">-    return NS_OK;</span>
<a href="#l4.1346"></a><span id="l4.1346" class="difflineminus">-}</span>
<a href="#l4.1347"></a><span id="l4.1347" class="difflineminus">-</span>
<a href="#l4.1348"></a><span id="l4.1348" class="difflineminus">-</span>
<a href="#l4.1349"></a><span id="l4.1349" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l4.1350"></a><span id="l4.1350" class="difflineminus">-CompositeDataSourceImpl::OnEndUpdateBatch(nsIRDFDataSource* aDataSource)</span>
<a href="#l4.1351"></a><span id="l4.1351" class="difflineminus">-{</span>
<a href="#l4.1352"></a><span id="l4.1352" class="difflineminus">-    NS_ASSERTION(mUpdateBatchNest &gt; 0, &quot;badly nested update batch&quot;);</span>
<a href="#l4.1353"></a><span id="l4.1353" class="difflineminus">-    if (--mUpdateBatchNest == 0) {</span>
<a href="#l4.1354"></a><span id="l4.1354" class="difflineminus">-        for (int32_t i = mObservers.Count() - 1; i &gt;= 0; --i) {</span>
<a href="#l4.1355"></a><span id="l4.1355" class="difflineminus">-            mObservers[i]-&gt;OnEndUpdateBatch(this);</span>
<a href="#l4.1356"></a><span id="l4.1356" class="difflineminus">-        }</span>
<a href="#l4.1357"></a><span id="l4.1357" class="difflineminus">-    }</span>
<a href="#l4.1358"></a><span id="l4.1358" class="difflineminus">-    return NS_OK;</span>
<a href="#l4.1359"></a><span id="l4.1359" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1">deleted file mode 100644</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineminus">--- a/rdf/base/nsContainerEnumerator.cpp</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineplus">+++ /dev/null</span>
<a href="#l5.4"></a><span id="l5.4" class="difflineat">@@ -1,264 +0,0 @@</span>
<a href="#l5.5"></a><span id="l5.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l5.6"></a><span id="l5.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l5.7"></a><span id="l5.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l5.8"></a><span id="l5.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l5.9"></a><span id="l5.9" class="difflineminus">-</span>
<a href="#l5.10"></a><span id="l5.10" class="difflineminus">-/*</span>
<a href="#l5.11"></a><span id="l5.11" class="difflineminus">-</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-  A simple cursor that enumerates the elements of an RDF container</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-  (RDF:Bag, RDF:Seq, or RDF:Alt).</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineminus">-</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineminus">-  Caveats</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineminus">-  -------</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineminus">-</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineminus">-  1. This uses an implementation-specific detail to determine the</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineminus">-     index of the last element in the container; specifically, the RDF</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineminus">-     utilities maintain a counter attribute on the container that</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineminus">-     holds the numeric value of the next value that is to be</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineminus">-     assigned. So, this cursor will bust if you use it with a bag that</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineminus">-     hasn't been created using the RDF utility routines.</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineminus">-</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineminus">- */</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineminus">-</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineminus">-#include &quot;nscore.h&quot;</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineminus">-#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineminus">-#include &quot;nsIRDFContainerUtils.h&quot;</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineminus">-#include &quot;nsIRDFDataSource.h&quot;</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineminus">-#include &quot;nsIRDFNode.h&quot;</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineminus">-#include &quot;nsIRDFService.h&quot;</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineminus">-#include &quot;nsIServiceManager.h&quot;</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineminus">-#include &quot;nsRDFCID.h&quot;</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineminus">-#include &quot;nsString.h&quot;</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineminus">-#include &quot;nsSimpleEnumerator.h&quot;</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineminus">-#include &quot;mozilla/Logging.h&quot;</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineminus">-#include &quot;rdf.h&quot;</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineminus">-#include &quot;rdfutil.h&quot;</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineminus">-</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineminus">-////////////////////////////////////////////////////////////////////////</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineminus">-</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineminus">-class ContainerEnumeratorImpl : public nsSimpleEnumerator {</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineminus">-private:</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineminus">-    // pseudo-constants</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineminus">-    static nsrefcnt              gRefCnt;</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineminus">-    static nsIRDFResource*       kRDF_nextVal;</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineminus">-    static nsIRDFContainerUtils* gRDFC;</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineminus">-</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineminus">-    nsCOMPtr&lt;nsIRDFDataSource&gt;      mDataSource;</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineminus">-    nsCOMPtr&lt;nsIRDFResource&gt;        mContainer;</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineminus">-    nsCOMPtr&lt;nsIRDFResource&gt;        mOrdinalProperty;</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineminus">-</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineminus">-    nsCOMPtr&lt;nsISimpleEnumerator&gt;   mCurrent;</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineminus">-    nsCOMPtr&lt;nsIRDFNode&gt;            mResult;</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineminus">-    int32_t mNextIndex;</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineminus">-</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineminus">-    ~ContainerEnumeratorImpl() override;</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineminus">-</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineminus">-public:</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineminus">-    const nsID&amp; DefaultInterface() override</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineminus">-    {</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineminus">-      return NS_GET_IID(nsIRDFNode);</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineminus">-    }</span>
<a href="#l5.65"></a><span id="l5.65" class="difflineminus">-</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineminus">-    NS_DECL_NSISIMPLEENUMERATOR</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineminus">-</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineminus">-    ContainerEnumeratorImpl(nsIRDFDataSource* ds, nsIRDFResource* container);</span>
<a href="#l5.69"></a><span id="l5.69" class="difflineminus">-</span>
<a href="#l5.70"></a><span id="l5.70" class="difflineminus">-    nsresult Init();</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineminus">-};</span>
<a href="#l5.72"></a><span id="l5.72" class="difflineminus">-</span>
<a href="#l5.73"></a><span id="l5.73" class="difflineminus">-nsrefcnt              ContainerEnumeratorImpl::gRefCnt;</span>
<a href="#l5.74"></a><span id="l5.74" class="difflineminus">-nsIRDFResource*       ContainerEnumeratorImpl::kRDF_nextVal;</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineminus">-nsIRDFContainerUtils* ContainerEnumeratorImpl::gRDFC;</span>
<a href="#l5.76"></a><span id="l5.76" class="difflineminus">-</span>
<a href="#l5.77"></a><span id="l5.77" class="difflineminus">-</span>
<a href="#l5.78"></a><span id="l5.78" class="difflineminus">-ContainerEnumeratorImpl::ContainerEnumeratorImpl(nsIRDFDataSource* aDataSource,</span>
<a href="#l5.79"></a><span id="l5.79" class="difflineminus">-                                                 nsIRDFResource* aContainer)</span>
<a href="#l5.80"></a><span id="l5.80" class="difflineminus">-    : mDataSource(aDataSource),</span>
<a href="#l5.81"></a><span id="l5.81" class="difflineminus">-      mContainer(aContainer),</span>
<a href="#l5.82"></a><span id="l5.82" class="difflineminus">-      mNextIndex(1)</span>
<a href="#l5.83"></a><span id="l5.83" class="difflineminus">-{</span>
<a href="#l5.84"></a><span id="l5.84" class="difflineminus">-}</span>
<a href="#l5.85"></a><span id="l5.85" class="difflineminus">-</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineminus">-nsresult</span>
<a href="#l5.87"></a><span id="l5.87" class="difflineminus">-ContainerEnumeratorImpl::Init()</span>
<a href="#l5.88"></a><span id="l5.88" class="difflineminus">-{</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineminus">-    if (gRefCnt++ == 0) {</span>
<a href="#l5.90"></a><span id="l5.90" class="difflineminus">-        nsresult rv;</span>
<a href="#l5.91"></a><span id="l5.91" class="difflineminus">-</span>
<a href="#l5.92"></a><span id="l5.92" class="difflineminus">-        NS_DEFINE_CID(kRDFServiceCID, NS_RDFSERVICE_CID);</span>
<a href="#l5.93"></a><span id="l5.93" class="difflineminus">-        nsCOMPtr&lt;nsIRDFService&gt; rdf = do_GetService(kRDFServiceCID);</span>
<a href="#l5.94"></a><span id="l5.94" class="difflineminus">-        NS_ASSERTION(rdf != nullptr, &quot;unable to acquire resource manager&quot;);</span>
<a href="#l5.95"></a><span id="l5.95" class="difflineminus">-        if (! rdf)</span>
<a href="#l5.96"></a><span id="l5.96" class="difflineminus">-            return NS_ERROR_FAILURE;</span>
<a href="#l5.97"></a><span id="l5.97" class="difflineminus">-</span>
<a href="#l5.98"></a><span id="l5.98" class="difflineminus">-        rv = rdf-&gt;GetResource(NS_LITERAL_CSTRING(RDF_NAMESPACE_URI &quot;nextVal&quot;), &amp;kRDF_nextVal);</span>
<a href="#l5.99"></a><span id="l5.99" class="difflineminus">-        NS_ASSERTION(NS_SUCCEEDED(rv), &quot;unable to get resource&quot;);</span>
<a href="#l5.100"></a><span id="l5.100" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l5.101"></a><span id="l5.101" class="difflineminus">-</span>
<a href="#l5.102"></a><span id="l5.102" class="difflineminus">-        NS_DEFINE_CID(kRDFContainerUtilsCID, NS_RDFCONTAINERUTILS_CID);</span>
<a href="#l5.103"></a><span id="l5.103" class="difflineminus">-        rv = CallGetService(kRDFContainerUtilsCID, &amp;gRDFC);</span>
<a href="#l5.104"></a><span id="l5.104" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l5.105"></a><span id="l5.105" class="difflineminus">-    }</span>
<a href="#l5.106"></a><span id="l5.106" class="difflineminus">-</span>
<a href="#l5.107"></a><span id="l5.107" class="difflineminus">-    return NS_OK;</span>
<a href="#l5.108"></a><span id="l5.108" class="difflineminus">-}</span>
<a href="#l5.109"></a><span id="l5.109" class="difflineminus">-</span>
<a href="#l5.110"></a><span id="l5.110" class="difflineminus">-</span>
<a href="#l5.111"></a><span id="l5.111" class="difflineminus">-ContainerEnumeratorImpl::~ContainerEnumeratorImpl()</span>
<a href="#l5.112"></a><span id="l5.112" class="difflineminus">-{</span>
<a href="#l5.113"></a><span id="l5.113" class="difflineminus">-    if (--gRefCnt == 0) {</span>
<a href="#l5.114"></a><span id="l5.114" class="difflineminus">-        NS_IF_RELEASE(kRDF_nextVal);</span>
<a href="#l5.115"></a><span id="l5.115" class="difflineminus">-        NS_IF_RELEASE(gRDFC);</span>
<a href="#l5.116"></a><span id="l5.116" class="difflineminus">-    }</span>
<a href="#l5.117"></a><span id="l5.117" class="difflineminus">-}</span>
<a href="#l5.118"></a><span id="l5.118" class="difflineminus">-</span>
<a href="#l5.119"></a><span id="l5.119" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l5.120"></a><span id="l5.120" class="difflineminus">-ContainerEnumeratorImpl::HasMoreElements(bool* aResult)</span>
<a href="#l5.121"></a><span id="l5.121" class="difflineminus">-{</span>
<a href="#l5.122"></a><span id="l5.122" class="difflineminus">-    NS_ASSERTION(aResult != nullptr, &quot;null ptr&quot;);</span>
<a href="#l5.123"></a><span id="l5.123" class="difflineminus">-    if (! aResult)</span>
<a href="#l5.124"></a><span id="l5.124" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l5.125"></a><span id="l5.125" class="difflineminus">-</span>
<a href="#l5.126"></a><span id="l5.126" class="difflineminus">-    nsresult rv;</span>
<a href="#l5.127"></a><span id="l5.127" class="difflineminus">-</span>
<a href="#l5.128"></a><span id="l5.128" class="difflineminus">-    // If we've already queued up a next value, then we know there are more elements.</span>
<a href="#l5.129"></a><span id="l5.129" class="difflineminus">-    if (mResult) {</span>
<a href="#l5.130"></a><span id="l5.130" class="difflineminus">-        *aResult = true;</span>
<a href="#l5.131"></a><span id="l5.131" class="difflineminus">-        return NS_OK;</span>
<a href="#l5.132"></a><span id="l5.132" class="difflineminus">-    }</span>
<a href="#l5.133"></a><span id="l5.133" class="difflineminus">-</span>
<a href="#l5.134"></a><span id="l5.134" class="difflineminus">-    // Otherwise, we need to grovel</span>
<a href="#l5.135"></a><span id="l5.135" class="difflineminus">-</span>
<a href="#l5.136"></a><span id="l5.136" class="difflineminus">-    // Figure out the upper bound so we'll know when we're done. Since it's</span>
<a href="#l5.137"></a><span id="l5.137" class="difflineminus">-    // possible that we're targeting a composite datasource, we'll need to</span>
<a href="#l5.138"></a><span id="l5.138" class="difflineminus">-    // &quot;GetTargets()&quot; and take the maximum value of &quot;nextVal&quot; to know the</span>
<a href="#l5.139"></a><span id="l5.139" class="difflineminus">-    // upper bound.</span>
<a href="#l5.140"></a><span id="l5.140" class="difflineminus">-    //</span>
<a href="#l5.141"></a><span id="l5.141" class="difflineminus">-    // Remember that since nextVal is the next index that we'd assign</span>
<a href="#l5.142"></a><span id="l5.142" class="difflineminus">-    // to an element in a container, it's *one more* than count of</span>
<a href="#l5.143"></a><span id="l5.143" class="difflineminus">-    // elements in the container.</span>
<a href="#l5.144"></a><span id="l5.144" class="difflineminus">-    int32_t max = 0;</span>
<a href="#l5.145"></a><span id="l5.145" class="difflineminus">-</span>
<a href="#l5.146"></a><span id="l5.146" class="difflineminus">-    nsCOMPtr&lt;nsISimpleEnumerator&gt; targets;</span>
<a href="#l5.147"></a><span id="l5.147" class="difflineminus">-    rv = mDataSource-&gt;GetTargets(mContainer, kRDF_nextVal, true, getter_AddRefs(targets));</span>
<a href="#l5.148"></a><span id="l5.148" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l5.149"></a><span id="l5.149" class="difflineminus">-</span>
<a href="#l5.150"></a><span id="l5.150" class="difflineminus">-    while (1) {</span>
<a href="#l5.151"></a><span id="l5.151" class="difflineminus">-        bool hasmore;</span>
<a href="#l5.152"></a><span id="l5.152" class="difflineminus">-        targets-&gt;HasMoreElements(&amp;hasmore);</span>
<a href="#l5.153"></a><span id="l5.153" class="difflineminus">-        if (! hasmore)</span>
<a href="#l5.154"></a><span id="l5.154" class="difflineminus">-            break;</span>
<a href="#l5.155"></a><span id="l5.155" class="difflineminus">-</span>
<a href="#l5.156"></a><span id="l5.156" class="difflineminus">-        nsCOMPtr&lt;nsISupports&gt; isupports;</span>
<a href="#l5.157"></a><span id="l5.157" class="difflineminus">-        targets-&gt;GetNext(getter_AddRefs(isupports));</span>
<a href="#l5.158"></a><span id="l5.158" class="difflineminus">-</span>
<a href="#l5.159"></a><span id="l5.159" class="difflineminus">-        nsCOMPtr&lt;nsIRDFLiteral&gt; nextValLiteral = do_QueryInterface(isupports);</span>
<a href="#l5.160"></a><span id="l5.160" class="difflineminus">-        if (! nextValLiteral)</span>
<a href="#l5.161"></a><span id="l5.161" class="difflineminus">-             continue;</span>
<a href="#l5.162"></a><span id="l5.162" class="difflineminus">-</span>
<a href="#l5.163"></a><span id="l5.163" class="difflineminus">-         const char16_t *nextValStr;</span>
<a href="#l5.164"></a><span id="l5.164" class="difflineminus">-         nextValLiteral-&gt;GetValueConst(&amp;nextValStr);</span>
<a href="#l5.165"></a><span id="l5.165" class="difflineminus">-</span>
<a href="#l5.166"></a><span id="l5.166" class="difflineminus">-         nsresult err;</span>
<a href="#l5.167"></a><span id="l5.167" class="difflineminus">-         int32_t nextVal = nsAutoString(nextValStr).ToInteger(&amp;err);</span>
<a href="#l5.168"></a><span id="l5.168" class="difflineminus">-</span>
<a href="#l5.169"></a><span id="l5.169" class="difflineminus">-         if (nextVal &gt; max)</span>
<a href="#l5.170"></a><span id="l5.170" class="difflineminus">-             max = nextVal;</span>
<a href="#l5.171"></a><span id="l5.171" class="difflineminus">-    }</span>
<a href="#l5.172"></a><span id="l5.172" class="difflineminus">-</span>
<a href="#l5.173"></a><span id="l5.173" class="difflineminus">-    // Now pre-fetch our next value into mResult.</span>
<a href="#l5.174"></a><span id="l5.174" class="difflineminus">-    while (mCurrent || mNextIndex &lt; max) {</span>
<a href="#l5.175"></a><span id="l5.175" class="difflineminus">-</span>
<a href="#l5.176"></a><span id="l5.176" class="difflineminus">-        // If mCurrent has been depleted, then conjure up a new one</span>
<a href="#l5.177"></a><span id="l5.177" class="difflineminus">-        if (! mCurrent) {</span>
<a href="#l5.178"></a><span id="l5.178" class="difflineminus">-            rv = gRDFC-&gt;IndexToOrdinalResource(mNextIndex, getter_AddRefs(mOrdinalProperty));</span>
<a href="#l5.179"></a><span id="l5.179" class="difflineminus">-            if (NS_FAILED(rv)) return rv;</span>
<a href="#l5.180"></a><span id="l5.180" class="difflineminus">-</span>
<a href="#l5.181"></a><span id="l5.181" class="difflineminus">-            rv = mDataSource-&gt;GetTargets(mContainer, mOrdinalProperty, true, getter_AddRefs(mCurrent));</span>
<a href="#l5.182"></a><span id="l5.182" class="difflineminus">-            if (NS_FAILED(rv)) return rv;</span>
<a href="#l5.183"></a><span id="l5.183" class="difflineminus">-</span>
<a href="#l5.184"></a><span id="l5.184" class="difflineminus">-            ++mNextIndex;</span>
<a href="#l5.185"></a><span id="l5.185" class="difflineminus">-        }</span>
<a href="#l5.186"></a><span id="l5.186" class="difflineminus">-</span>
<a href="#l5.187"></a><span id="l5.187" class="difflineminus">-        if (mCurrent) {</span>
<a href="#l5.188"></a><span id="l5.188" class="difflineminus">-            bool hasMore;</span>
<a href="#l5.189"></a><span id="l5.189" class="difflineminus">-            rv = mCurrent-&gt;HasMoreElements(&amp;hasMore);</span>
<a href="#l5.190"></a><span id="l5.190" class="difflineminus">-            if (NS_FAILED(rv)) return rv;</span>
<a href="#l5.191"></a><span id="l5.191" class="difflineminus">-</span>
<a href="#l5.192"></a><span id="l5.192" class="difflineminus">-            // Is the current enumerator depleted? If so, iterate to</span>
<a href="#l5.193"></a><span id="l5.193" class="difflineminus">-            // the next index.</span>
<a href="#l5.194"></a><span id="l5.194" class="difflineminus">-            if (! hasMore) {</span>
<a href="#l5.195"></a><span id="l5.195" class="difflineminus">-                mCurrent = nullptr;</span>
<a href="#l5.196"></a><span id="l5.196" class="difflineminus">-                continue;</span>
<a href="#l5.197"></a><span id="l5.197" class="difflineminus">-            }</span>
<a href="#l5.198"></a><span id="l5.198" class="difflineminus">-</span>
<a href="#l5.199"></a><span id="l5.199" class="difflineminus">-            // &quot;Peek&quot; ahead and pull out the next target.</span>
<a href="#l5.200"></a><span id="l5.200" class="difflineminus">-            nsCOMPtr&lt;nsISupports&gt; result;</span>
<a href="#l5.201"></a><span id="l5.201" class="difflineminus">-            rv = mCurrent-&gt;GetNext(getter_AddRefs(result));</span>
<a href="#l5.202"></a><span id="l5.202" class="difflineminus">-            if (NS_FAILED(rv)) return rv;</span>
<a href="#l5.203"></a><span id="l5.203" class="difflineminus">-</span>
<a href="#l5.204"></a><span id="l5.204" class="difflineminus">-            mResult = do_QueryInterface(result, &amp;rv);</span>
<a href="#l5.205"></a><span id="l5.205" class="difflineminus">-            if (NS_FAILED(rv)) return rv;</span>
<a href="#l5.206"></a><span id="l5.206" class="difflineminus">-</span>
<a href="#l5.207"></a><span id="l5.207" class="difflineminus">-            *aResult = true;</span>
<a href="#l5.208"></a><span id="l5.208" class="difflineminus">-            return NS_OK;</span>
<a href="#l5.209"></a><span id="l5.209" class="difflineminus">-        }</span>
<a href="#l5.210"></a><span id="l5.210" class="difflineminus">-    }</span>
<a href="#l5.211"></a><span id="l5.211" class="difflineminus">-</span>
<a href="#l5.212"></a><span id="l5.212" class="difflineminus">-    // If we get here, we ran out of elements. The cursor is empty.</span>
<a href="#l5.213"></a><span id="l5.213" class="difflineminus">-    *aResult = false;</span>
<a href="#l5.214"></a><span id="l5.214" class="difflineminus">-    return NS_OK;</span>
<a href="#l5.215"></a><span id="l5.215" class="difflineminus">-}</span>
<a href="#l5.216"></a><span id="l5.216" class="difflineminus">-</span>
<a href="#l5.217"></a><span id="l5.217" class="difflineminus">-</span>
<a href="#l5.218"></a><span id="l5.218" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l5.219"></a><span id="l5.219" class="difflineminus">-ContainerEnumeratorImpl::GetNext(nsISupports** aResult)</span>
<a href="#l5.220"></a><span id="l5.220" class="difflineminus">-{</span>
<a href="#l5.221"></a><span id="l5.221" class="difflineminus">-    nsresult rv;</span>
<a href="#l5.222"></a><span id="l5.222" class="difflineminus">-</span>
<a href="#l5.223"></a><span id="l5.223" class="difflineminus">-    bool hasMore;</span>
<a href="#l5.224"></a><span id="l5.224" class="difflineminus">-    rv = HasMoreElements(&amp;hasMore);</span>
<a href="#l5.225"></a><span id="l5.225" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l5.226"></a><span id="l5.226" class="difflineminus">-</span>
<a href="#l5.227"></a><span id="l5.227" class="difflineminus">-    if (! hasMore)</span>
<a href="#l5.228"></a><span id="l5.228" class="difflineminus">-        return NS_ERROR_UNEXPECTED;</span>
<a href="#l5.229"></a><span id="l5.229" class="difflineminus">-</span>
<a href="#l5.230"></a><span id="l5.230" class="difflineminus">-    NS_ADDREF(*aResult = mResult);</span>
<a href="#l5.231"></a><span id="l5.231" class="difflineminus">-    mResult = nullptr;</span>
<a href="#l5.232"></a><span id="l5.232" class="difflineminus">-</span>
<a href="#l5.233"></a><span id="l5.233" class="difflineminus">-    return NS_OK;</span>
<a href="#l5.234"></a><span id="l5.234" class="difflineminus">-}</span>
<a href="#l5.235"></a><span id="l5.235" class="difflineminus">-</span>
<a href="#l5.236"></a><span id="l5.236" class="difflineminus">-</span>
<a href="#l5.237"></a><span id="l5.237" class="difflineminus">-////////////////////////////////////////////////////////////////////////</span>
<a href="#l5.238"></a><span id="l5.238" class="difflineminus">-</span>
<a href="#l5.239"></a><span id="l5.239" class="difflineminus">-nsresult</span>
<a href="#l5.240"></a><span id="l5.240" class="difflineminus">-NS_NewContainerEnumerator(nsIRDFDataSource* aDataSource,</span>
<a href="#l5.241"></a><span id="l5.241" class="difflineminus">-                          nsIRDFResource* aContainer,</span>
<a href="#l5.242"></a><span id="l5.242" class="difflineminus">-                          nsISimpleEnumerator** aResult)</span>
<a href="#l5.243"></a><span id="l5.243" class="difflineminus">-{</span>
<a href="#l5.244"></a><span id="l5.244" class="difflineminus">-    NS_ASSERTION(aDataSource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l5.245"></a><span id="l5.245" class="difflineminus">-    if (! aDataSource)</span>
<a href="#l5.246"></a><span id="l5.246" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l5.247"></a><span id="l5.247" class="difflineminus">-</span>
<a href="#l5.248"></a><span id="l5.248" class="difflineminus">-    NS_ASSERTION(aContainer != nullptr, &quot;null ptr&quot;);</span>
<a href="#l5.249"></a><span id="l5.249" class="difflineminus">-    if (! aContainer)</span>
<a href="#l5.250"></a><span id="l5.250" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l5.251"></a><span id="l5.251" class="difflineminus">-</span>
<a href="#l5.252"></a><span id="l5.252" class="difflineminus">-    NS_ASSERTION(aResult != nullptr, &quot;null ptr&quot;);</span>
<a href="#l5.253"></a><span id="l5.253" class="difflineminus">-    if (! aResult)</span>
<a href="#l5.254"></a><span id="l5.254" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l5.255"></a><span id="l5.255" class="difflineminus">-</span>
<a href="#l5.256"></a><span id="l5.256" class="difflineminus">-    ContainerEnumeratorImpl* result = new ContainerEnumeratorImpl(aDataSource, aContainer);</span>
<a href="#l5.257"></a><span id="l5.257" class="difflineminus">-    if (! result)</span>
<a href="#l5.258"></a><span id="l5.258" class="difflineminus">-        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l5.259"></a><span id="l5.259" class="difflineminus">-</span>
<a href="#l5.260"></a><span id="l5.260" class="difflineminus">-    NS_ADDREF(result);</span>
<a href="#l5.261"></a><span id="l5.261" class="difflineminus">-</span>
<a href="#l5.262"></a><span id="l5.262" class="difflineminus">-    nsresult rv = result-&gt;Init();</span>
<a href="#l5.263"></a><span id="l5.263" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l5.264"></a><span id="l5.264" class="difflineminus">-        NS_RELEASE(result);</span>
<a href="#l5.265"></a><span id="l5.265" class="difflineminus">-</span>
<a href="#l5.266"></a><span id="l5.266" class="difflineminus">-    *aResult = result;</span>
<a href="#l5.267"></a><span id="l5.267" class="difflineminus">-    return rv;</span>
<a href="#l5.268"></a><span id="l5.268" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1">deleted file mode 100644</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineminus">--- a/rdf/base/nsDefaultResourceFactory.cpp</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineplus">+++ /dev/null</span>
<a href="#l6.4"></a><span id="l6.4" class="difflineat">@@ -1,30 +0,0 @@</span>
<a href="#l6.5"></a><span id="l6.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l6.6"></a><span id="l6.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l6.7"></a><span id="l6.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l6.8"></a><span id="l6.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l6.9"></a><span id="l6.9" class="difflineminus">-</span>
<a href="#l6.10"></a><span id="l6.10" class="difflineminus">-/*</span>
<a href="#l6.11"></a><span id="l6.11" class="difflineminus">-</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-  The default resource factory implementation. This resource factory</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-  produces nsIRDFResource objects for any URI prefix that is not</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-  covered by some other factory.</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineminus">-</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineminus">- */</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineminus">-</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineminus">-#include &quot;nsRDFResource.h&quot;</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineminus">-</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineminus">-nsresult</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineminus">-NS_NewDefaultResource(nsIRDFResource** aResult)</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineminus">-{</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineminus">-    NS_ASSERTION(aResult != nullptr, &quot;null ptr&quot;);</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineminus">-    if (! aResult)</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineminus">-</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineminus">-    nsRDFResource* resource = new nsRDFResource();</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineminus">-    if (! resource)</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineminus">-        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineminus">-</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">-    NS_ADDREF(resource);</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineminus">-    *aResult = resource;</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineminus">-    return NS_OK;</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1">deleted file mode 100644</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineminus">--- a/rdf/base/nsIRDFCompositeDataSource.idl</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineplus">+++ /dev/null</span>
<a href="#l7.4"></a><span id="l7.4" class="difflineat">@@ -1,68 +0,0 @@</span>
<a href="#l7.5"></a><span id="l7.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l7.6"></a><span id="l7.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l7.7"></a><span id="l7.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l7.8"></a><span id="l7.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l7.9"></a><span id="l7.9" class="difflineminus">-</span>
<a href="#l7.10"></a><span id="l7.10" class="difflineminus">-#include &quot;nsIRDFDataSource.idl&quot;</span>
<a href="#l7.11"></a><span id="l7.11" class="difflineminus">-</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-interface nsISimpleEnumerator;</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineminus">-/**</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineminus">- * An nsIRDFCompositeDataSource composes individual data sources, providing</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineminus">- * the illusion of a single, coherent RDF graph.</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineminus">- */</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineminus">-[scriptable, uuid(96343820-307C-11D2-BC15-00805F912FE7)]</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineminus">-interface nsIRDFCompositeDataSource : nsIRDFDataSource {</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineminus">-</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineminus">-    /**</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineminus">-     *</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineminus">-     * Set this value to &lt;code&gt;true&lt;/code&gt; if the composite datasource</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineminus">-     * may contains at least one datasource that has &lt;em&gt;negative&lt;/em&gt;</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineminus">-     * assertions. (This is the default.)</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineminus">-     *</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineminus">-     * Set this value to &lt;code&gt;false&lt;/code&gt; if none of the datasources</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineminus">-     * being composed contains a negative assertion. This allows the</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineminus">-     * composite datasource to perform some query optimizations.</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineminus">-     *</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">-     * By default, this value is &lt;code&gt;true&lt;/true&gt;.</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineminus">-     */</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineminus">-    attribute boolean allowNegativeAssertions;</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineminus">-</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineminus">-    /**</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineminus">-     * Set to &lt;code&gt;true&lt;/code&gt; if the composite datasource should</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineminus">-     * take care to coalesce duplicate arcs when returning values from</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineminus">-     * queries. (This is the default.)</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineminus">-     *</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineminus">-     * Set to &lt;code&gt;false&lt;/code&gt; if the composite datasource shouldn't</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineminus">-     * bother to check for duplicates. This allows the composite</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineminus">-     * datasource to more efficiently answer queries.</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineminus">-     *</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineminus">-     * By default, this value is &lt;code&gt;true&lt;/code&gt;.</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineminus">-     */</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineminus">-    attribute boolean coalesceDuplicateArcs;</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineminus">-</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineminus">-    /**</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineminus">-     * Add a datasource the the composite data source.</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineminus">-     * @param aDataSource the datasource to add to composite</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineminus">-     */</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineminus">-    void AddDataSource(in nsIRDFDataSource aDataSource);</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineminus">-</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineminus">-    /**</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineminus">-     * Remove a datasource from the composite data source.</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineminus">-     * @param aDataSource the datasource to remove from the composite</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineminus">-     */</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineminus">-    void RemoveDataSource(in nsIRDFDataSource aDataSource);</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineminus">-</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineminus">-    /**</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineminus">-     * Retrieve the datasources in the composite data source.</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineminus">-     * @return an nsISimpleEnumerator that will enumerate each</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineminus">-     * of the datasources in the composite</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineminus">-     */</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineminus">-    nsISimpleEnumerator GetDataSources();</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineminus">-};</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineminus">-</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineminus">-%{C++</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineminus">-extern nsresult</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineminus">-NS_NewRDFCompositeDataSource(nsIRDFCompositeDataSource** result);</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineminus">-%}</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1">deleted file mode 100644</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineminus">--- a/rdf/base/nsIRDFContainer.idl</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineplus">+++ /dev/null</span>
<a href="#l8.4"></a><span id="l8.4" class="difflineat">@@ -1,94 +0,0 @@</span>
<a href="#l8.5"></a><span id="l8.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l8.6"></a><span id="l8.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l8.7"></a><span id="l8.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l8.8"></a><span id="l8.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l8.9"></a><span id="l8.9" class="difflineminus">-</span>
<a href="#l8.10"></a><span id="l8.10" class="difflineminus">-#include &quot;nsISupports.idl&quot;</span>
<a href="#l8.11"></a><span id="l8.11" class="difflineminus">-#include &quot;nsIRDFDataSource.idl&quot;</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-#include &quot;nsIRDFResource.idl&quot;</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-#include &quot;nsIRDFNode.idl&quot;</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineminus">-#include &quot;nsISimpleEnumerator.idl&quot;</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineminus">-</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineminus">-// A wrapper for manipulating RDF containers</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineminus">-[scriptable, uuid(D4214E90-FB94-11D2-BDD8-00104BDE6048)]</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineminus">-interface nsIRDFContainer : nsISupports {</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineminus">-    readonly attribute nsIRDFDataSource DataSource;</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineminus">-    readonly attribute nsIRDFResource   Resource;</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineminus">-</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineminus">-    /**</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineminus">-     * Initialize the container wrapper to the specified resource</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineminus">-     * using the specified datasource for context.</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineminus">-     */</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineminus">-    void Init(in nsIRDFDataSource aDataSource, in nsIRDFResource aContainer);</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineminus">-</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineminus">-    /**</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineminus">-     * Return the number of elements in the container. Note that this</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineminus">-     * may not always be accurate due to aggregation.</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-     */</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineminus">-    long GetCount();</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineminus">-</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineminus">-    /**</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineminus">-     * Return an enumerator that can be used to enumerate the contents</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineminus">-     * of the container in ascending order.</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineminus">-     */</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineminus">-    nsISimpleEnumerator GetElements();</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineminus">-</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineminus">-    /**</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineminus">-     * Append an element to the container, assigning it the next</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineminus">-     * available ordinal.</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineminus">-     */</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineminus">-    void AppendElement(in nsIRDFNode aElement);</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineminus">-</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineminus">-    /**</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineminus">-     * Remove the first occurence of the specified element from the</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineminus">-     * container. If aRenumber is 'true', then the underlying RDF graph</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineminus">-     * will be 're-numbered' to account for the removal.</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineminus">-     */</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineminus">-    void RemoveElement(in nsIRDFNode aElement, in boolean aRenumber);</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineminus">-</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineminus">-    /**</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineminus">-     * Insert aElement at the specified index. If aRenumber is 'true', then</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineminus">-     * the underlying RDF graph will be 're-numbered' to accomodate the new</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineminus">-     * element.</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineminus">-     */</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineminus">-    void InsertElementAt(in nsIRDFNode aElement, in long aIndex, in boolean aRenumber);</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineminus">-</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineminus">-    /**</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineminus">-     * Remove the element at the specified index. If aRenumber is 'true', then</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineminus">-     * the underlying RDF graph will be 're-numbered' to account for the</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineminus">-     * removal.</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineminus">-     *</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineminus">-     * @return the element that was removed.</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineminus">-     */</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineminus">-    nsIRDFNode RemoveElementAt(in long aIndex, in boolean aRenumber);</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineminus">-</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineminus">-    /**</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineminus">-     * Determine the index of an element in the container.</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineminus">-     *</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineminus">-     * @return The index of the specified element in the container. If</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineminus">-     * the element is not contained in the container, this function</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineminus">-     * returns '-1'.</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineminus">-     */</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineminus">-    long IndexOf(in nsIRDFNode aElement);</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineminus">-};</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineminus">-</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineminus">-%{C++</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineminus">-nsresult</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineminus">-NS_NewRDFContainer(nsIRDFContainer** aResult);</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineminus">-</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineminus">-nsresult</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineminus">-NS_NewRDFContainer(nsIRDFDataSource* aDataSource,</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineminus">-                   nsIRDFResource* aResource,</span>
<a href="#l8.86"></a><span id="l8.86" class="difflineminus">-                   nsIRDFContainer** aResult);</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineminus">-</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineminus">-/**</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineminus">- * Create a cursor on a container that enumerates its contents in</span>
<a href="#l8.90"></a><span id="l8.90" class="difflineminus">- * order</span>
<a href="#l8.91"></a><span id="l8.91" class="difflineminus">- */</span>
<a href="#l8.92"></a><span id="l8.92" class="difflineminus">-nsresult</span>
<a href="#l8.93"></a><span id="l8.93" class="difflineminus">-NS_NewContainerEnumerator(nsIRDFDataSource* aDataSource,</span>
<a href="#l8.94"></a><span id="l8.94" class="difflineminus">-                          nsIRDFResource* aContainer,</span>
<a href="#l8.95"></a><span id="l8.95" class="difflineminus">-                          nsISimpleEnumerator** aResult);</span>
<a href="#l8.96"></a><span id="l8.96" class="difflineminus">-</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineminus">-</span>
<a href="#l8.98"></a><span id="l8.98" class="difflineminus">-%}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1">deleted file mode 100644</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineminus">--- a/rdf/base/nsIRDFContainerUtils.idl</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineplus">+++ /dev/null</span>
<a href="#l9.4"></a><span id="l9.4" class="difflineat">@@ -1,82 +0,0 @@</span>
<a href="#l9.5"></a><span id="l9.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l9.6"></a><span id="l9.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l9.7"></a><span id="l9.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l9.8"></a><span id="l9.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l9.9"></a><span id="l9.9" class="difflineminus">-</span>
<a href="#l9.10"></a><span id="l9.10" class="difflineminus">-#include &quot;nsISupports.idl&quot;</span>
<a href="#l9.11"></a><span id="l9.11" class="difflineminus">-#include &quot;nsIRDFContainer.idl&quot;</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-#include &quot;nsIRDFResource.idl&quot;</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">-</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineminus">-</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineminus">-// Container utilities</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineminus">-[scriptable, uuid(D4214E91-FB94-11D2-BDD8-00104BDE6048)]</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineminus">-interface nsIRDFContainerUtils : nsISupports {</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineminus">-    /**</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineminus">-     * Returns 'true' if the property is an RDF ordinal property.</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineminus">-     */</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineminus">-    boolean IsOrdinalProperty(in nsIRDFResource aProperty);</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineminus">-</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineminus">-    /**</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineminus">-     * Convert the specified index to an ordinal property.</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineminus">-     */</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineminus">-    nsIRDFResource IndexToOrdinalResource(in long aIndex);</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineminus">-</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineminus">-    /**</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineminus">-     * Convert the specified ordinal property into an index</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineminus">-     */</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineminus">-    long OrdinalResourceToIndex(in nsIRDFResource aOrdinal);</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineminus">-</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineminus">-    /**</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineminus">-     * Return 'true' if the specified resource is a container</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineminus">-     */</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineminus">-    boolean IsContainer(in nsIRDFDataSource aDataSource, in nsIRDFResource aResource);</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineminus">-</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineminus">-    /**</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineminus">-     * Return 'true' if the specified resource is a container and it is empty</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineminus">-     */</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineminus">-    boolean IsEmpty(in nsIRDFDataSource aDataSource, in nsIRDFResource aResource);</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineminus">-</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineminus">-    /**</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineminus">-     * Return 'true' if the specified resource is a bag</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineminus">-     */</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineminus">-    boolean IsBag(in nsIRDFDataSource aDataSource, in nsIRDFResource aResource);</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineminus">-</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineminus">-    /**</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineminus">-     * Return 'true' if the specified resource is a sequence</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineminus">-     */</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineminus">-    boolean IsSeq(in nsIRDFDataSource aDataSource, in nsIRDFResource aResource);</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineminus">-</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineminus">-    /**</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineminus">-     * Return 'true' if the specified resource is an alternation</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineminus">-     */</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineminus">-    boolean IsAlt(in nsIRDFDataSource aDataSource, in nsIRDFResource aResource);</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineminus">-</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineminus">-    /**</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineminus">-     * Decorates the specified resource appropriately to make it</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineminus">-     * usable as an empty bag in the specified data source.</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineminus">-     */</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineminus">-    nsIRDFContainer MakeBag(in nsIRDFDataSource aDataSource, in nsIRDFResource aResource);</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineminus">-</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineminus">-    /**</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineminus">-     * Decorates the specified resource appropriately to make it</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineminus">-     * usable as an empty sequence in the specified data source.</span>
<a href="#l9.67"></a><span id="l9.67" class="difflineminus">-     */</span>
<a href="#l9.68"></a><span id="l9.68" class="difflineminus">-    nsIRDFContainer MakeSeq(in nsIRDFDataSource aDataSource, in nsIRDFResource aResource);</span>
<a href="#l9.69"></a><span id="l9.69" class="difflineminus">-</span>
<a href="#l9.70"></a><span id="l9.70" class="difflineminus">-    /**</span>
<a href="#l9.71"></a><span id="l9.71" class="difflineminus">-     * Decorates the specified resource appropriately to make it</span>
<a href="#l9.72"></a><span id="l9.72" class="difflineminus">-     * usable as an empty alternation in the specified data source.</span>
<a href="#l9.73"></a><span id="l9.73" class="difflineminus">-     */</span>
<a href="#l9.74"></a><span id="l9.74" class="difflineminus">-    nsIRDFContainer MakeAlt(in nsIRDFDataSource aDataSource, in nsIRDFResource aResource);</span>
<a href="#l9.75"></a><span id="l9.75" class="difflineminus">-</span>
<a href="#l9.76"></a><span id="l9.76" class="difflineminus">-    /**</span>
<a href="#l9.77"></a><span id="l9.77" class="difflineminus">-     * Retrieve the index of element in the container. Returns -1 if</span>
<a href="#l9.78"></a><span id="l9.78" class="difflineminus">-     * the element is not in the container.</span>
<a href="#l9.79"></a><span id="l9.79" class="difflineminus">-     */</span>
<a href="#l9.80"></a><span id="l9.80" class="difflineminus">-    long indexOf(in nsIRDFDataSource aDataSource, in nsIRDFResource aContainer, in nsIRDFNode aElement);</span>
<a href="#l9.81"></a><span id="l9.81" class="difflineminus">-};</span>
<a href="#l9.82"></a><span id="l9.82" class="difflineminus">-</span>
<a href="#l9.83"></a><span id="l9.83" class="difflineminus">-%{C++</span>
<a href="#l9.84"></a><span id="l9.84" class="difflineminus">-extern nsresult</span>
<a href="#l9.85"></a><span id="l9.85" class="difflineminus">-NS_NewRDFContainerUtils(nsIRDFContainerUtils** aResult);</span>
<a href="#l9.86"></a><span id="l9.86" class="difflineminus">-%}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1">deleted file mode 100644</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineminus">--- a/rdf/base/nsIRDFContentSink.h</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineplus">+++ /dev/null</span>
<a href="#l10.4"></a><span id="l10.4" class="difflineat">@@ -1,57 +0,0 @@</span>
<a href="#l10.5"></a><span id="l10.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l10.6"></a><span id="l10.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l10.7"></a><span id="l10.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l10.8"></a><span id="l10.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l10.9"></a><span id="l10.9" class="difflineminus">-</span>
<a href="#l10.10"></a><span id="l10.10" class="difflineminus">-/*</span>
<a href="#l10.11"></a><span id="l10.11" class="difflineminus">-</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-  An RDF-specific content sink. The content sink is targeted by the</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-  parser for building the RDF content model.</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineminus">-</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineminus">- */</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineminus">-</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineminus">-#ifndef nsIRDFContentSink_h___</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineminus">-#define nsIRDFContentSink_h___</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineminus">-</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineminus">-#include &quot;nsIXMLContentSink.h&quot;</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineminus">-class nsIRDFDataSource;</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineminus">-class nsIURI;</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineminus">-</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineminus">-// {3a7459d7-d723-483c-aef0-404fc48e09b8}</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineminus">-#define NS_IRDFCONTENTSINK_IID \</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineminus">-{ 0x3a7459d7, 0xd723, 0x483c, { 0xae, 0xf0, 0x40, 0x4f, 0xc4, 0x8e, 0x09, 0xb8 } }</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineminus">-</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineminus">-/**</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineminus">- * This interface represents a content sink for RDF files.</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineminus">- */</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineminus">-</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineminus">-class nsIRDFContentSink : public nsIXMLContentSink {</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineminus">-public:</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineminus">-    NS_DECLARE_STATIC_IID_ACCESSOR(NS_IRDFCONTENTSINK_IID)</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineminus">-</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineminus">-    /**</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineminus">-     * Initialize the content sink.</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineminus">-     */</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineminus">-    NS_IMETHOD Init(nsIURI* aURL) = 0;</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineminus">-</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineminus">-    /**</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineminus">-     * Set the content sink's RDF Data source</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineminus">-     */</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineminus">-    NS_IMETHOD SetDataSource(nsIRDFDataSource* aDataSource) = 0;</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineminus">-</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineminus">-    /**</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineminus">-     * Retrieve the content sink's RDF data source.</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineminus">-     */</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineminus">-    NS_IMETHOD GetDataSource(nsIRDFDataSource*&amp; rDataSource) = 0;</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineminus">-};</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineminus">-</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineminus">-NS_DEFINE_STATIC_IID_ACCESSOR(nsIRDFContentSink, NS_IRDFCONTENTSINK_IID)</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineminus">-</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineminus">-/**</span>
<a href="#l10.55"></a><span id="l10.55" class="difflineminus">- * This constructs a content sink that can be used without a</span>
<a href="#l10.56"></a><span id="l10.56" class="difflineminus">- * document, say, to create a stand-alone in-memory graph.</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineminus">- */</span>
<a href="#l10.58"></a><span id="l10.58" class="difflineminus">-nsresult</span>
<a href="#l10.59"></a><span id="l10.59" class="difflineminus">-NS_NewRDFContentSink(nsIRDFContentSink** aResult);</span>
<a href="#l10.60"></a><span id="l10.60" class="difflineminus">-</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineminus">-#endif // nsIRDFContentSink_h___</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1">deleted file mode 100644</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineminus">--- a/rdf/base/nsIRDFDataSource.idl</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineplus">+++ /dev/null</span>
<a href="#l11.4"></a><span id="l11.4" class="difflineat">@@ -1,181 +0,0 @@</span>
<a href="#l11.5"></a><span id="l11.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l11.6"></a><span id="l11.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l11.7"></a><span id="l11.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l11.8"></a><span id="l11.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l11.9"></a><span id="l11.9" class="difflineminus">-</span>
<a href="#l11.10"></a><span id="l11.10" class="difflineminus">-#include &quot;nsISupports.idl&quot;</span>
<a href="#l11.11"></a><span id="l11.11" class="difflineminus">-#include &quot;nsIRDFResource.idl&quot;</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-#include &quot;nsIRDFNode.idl&quot;</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-#include &quot;nsISimpleEnumerator.idl&quot;</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineminus">-#include &quot;nsIRDFObserver.idl&quot;</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineminus">-</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineminus">-[scriptable, uuid(0F78DA58-8321-11d2-8EAC-00805F29F370)]</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineminus">-interface nsIRDFDataSource : nsISupports</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineminus">-{</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineminus">-    /** The &quot;URI&quot; of the data source. This used by the RDF service's</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineminus">-     * |GetDataSource()| method to cache datasources.</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineminus">-     */</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineminus">-    readonly attribute ACString URI;</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineminus">-</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineminus">-    /** Find an RDF resource that points to a given node over the</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineminus">-     * specified arc &amp; truth value</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineminus">-     *</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineminus">-     * @throws NS_RDF_NO_VALUE if there is no source that leads</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineminus">-     * to the target with the specified property.</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineminus">-     */</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineminus">-    nsIRDFResource GetSource(in nsIRDFResource aProperty,</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineminus">-                             in nsIRDFNode     aTarget,</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineminus">-                             in boolean        aTruthValue);</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineminus">-</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineminus">-    /**</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineminus">-     * Find all RDF resources that point to a given node over the</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineminus">-     * specified arc &amp; truth value</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineminus">-     */</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineminus">-    nsISimpleEnumerator GetSources(in nsIRDFResource aProperty,</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineminus">-                                   in nsIRDFNode     aTarget,</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineminus">-                                   in boolean        aTruthValue);</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineminus">-</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineminus">-    /**</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineminus">-     * Find a child of that is related to the source by the given arc</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineminus">-     * arc and truth value</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineminus">-     *</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineminus">-     * @throws NS_RDF_NO_VALUE if there is no target accessible from the</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineminus">-     * source via the specified property.</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineminus">-     */</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineminus">-    nsIRDFNode GetTarget(in nsIRDFResource aSource,</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineminus">-                         in nsIRDFResource aProperty,</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineminus">-                         in boolean        aTruthValue);</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineminus">-</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineminus">-    /**</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineminus">-     * Find all children of that are related to the source by the given arc</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineminus">-     * arc and truth value.</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineminus">-     */</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineminus">-    nsISimpleEnumerator GetTargets(in nsIRDFResource aSource,</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineminus">-                                   in nsIRDFResource aProperty,</span>
<a href="#l11.59"></a><span id="l11.59" class="difflineminus">-                                   in boolean aTruthValue);</span>
<a href="#l11.60"></a><span id="l11.60" class="difflineminus">-</span>
<a href="#l11.61"></a><span id="l11.61" class="difflineminus">-    /**</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineminus">-     * Add an assertion to the graph.</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineminus">-     */</span>
<a href="#l11.64"></a><span id="l11.64" class="difflineminus">-    void Assert(in nsIRDFResource aSource, </span>
<a href="#l11.65"></a><span id="l11.65" class="difflineminus">-                in nsIRDFResource aProperty, </span>
<a href="#l11.66"></a><span id="l11.66" class="difflineminus">-                in nsIRDFNode     aTarget,</span>
<a href="#l11.67"></a><span id="l11.67" class="difflineminus">-                in boolean        aTruthValue);</span>
<a href="#l11.68"></a><span id="l11.68" class="difflineminus">-</span>
<a href="#l11.69"></a><span id="l11.69" class="difflineminus">-    /**</span>
<a href="#l11.70"></a><span id="l11.70" class="difflineminus">-     * Remove an assertion from the graph.</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineminus">-     */</span>
<a href="#l11.72"></a><span id="l11.72" class="difflineminus">-    void Unassert(in nsIRDFResource aSource,</span>
<a href="#l11.73"></a><span id="l11.73" class="difflineminus">-                  in nsIRDFResource aProperty,</span>
<a href="#l11.74"></a><span id="l11.74" class="difflineminus">-                  in nsIRDFNode     aTarget);</span>
<a href="#l11.75"></a><span id="l11.75" class="difflineminus">-</span>
<a href="#l11.76"></a><span id="l11.76" class="difflineminus">-    /**</span>
<a href="#l11.77"></a><span id="l11.77" class="difflineminus">-     * Change an assertion from</span>
<a href="#l11.78"></a><span id="l11.78" class="difflineminus">-     *</span>
<a href="#l11.79"></a><span id="l11.79" class="difflineminus">-     *   [aSource]--[aProperty]--&gt;[aOldTarget]</span>
<a href="#l11.80"></a><span id="l11.80" class="difflineminus">-     *</span>
<a href="#l11.81"></a><span id="l11.81" class="difflineminus">-     * to</span>
<a href="#l11.82"></a><span id="l11.82" class="difflineminus">-     * </span>
<a href="#l11.83"></a><span id="l11.83" class="difflineminus">-     *   [aSource]--[aProperty]--&gt;[aNewTarget]</span>
<a href="#l11.84"></a><span id="l11.84" class="difflineminus">-     */</span>
<a href="#l11.85"></a><span id="l11.85" class="difflineminus">-    void Change(in nsIRDFResource aSource,</span>
<a href="#l11.86"></a><span id="l11.86" class="difflineminus">-                in nsIRDFResource aProperty,</span>
<a href="#l11.87"></a><span id="l11.87" class="difflineminus">-                in nsIRDFNode     aOldTarget,</span>
<a href="#l11.88"></a><span id="l11.88" class="difflineminus">-                in nsIRDFNode     aNewTarget);</span>
<a href="#l11.89"></a><span id="l11.89" class="difflineminus">-</span>
<a href="#l11.90"></a><span id="l11.90" class="difflineminus">-    /**</span>
<a href="#l11.91"></a><span id="l11.91" class="difflineminus">-     * 'Move' an assertion from</span>
<a href="#l11.92"></a><span id="l11.92" class="difflineminus">-     *</span>
<a href="#l11.93"></a><span id="l11.93" class="difflineminus">-     *   [aOldSource]--[aProperty]--&gt;[aTarget]</span>
<a href="#l11.94"></a><span id="l11.94" class="difflineminus">-     *</span>
<a href="#l11.95"></a><span id="l11.95" class="difflineminus">-     * to</span>
<a href="#l11.96"></a><span id="l11.96" class="difflineminus">-     * </span>
<a href="#l11.97"></a><span id="l11.97" class="difflineminus">-     *   [aNewSource]--[aProperty]--&gt;[aTarget]</span>
<a href="#l11.98"></a><span id="l11.98" class="difflineminus">-     */</span>
<a href="#l11.99"></a><span id="l11.99" class="difflineminus">-    void Move(in nsIRDFResource aOldSource,</span>
<a href="#l11.100"></a><span id="l11.100" class="difflineminus">-              in nsIRDFResource aNewSource,</span>
<a href="#l11.101"></a><span id="l11.101" class="difflineminus">-              in nsIRDFResource aProperty,</span>
<a href="#l11.102"></a><span id="l11.102" class="difflineminus">-              in nsIRDFNode     aTarget);</span>
<a href="#l11.103"></a><span id="l11.103" class="difflineminus">-</span>
<a href="#l11.104"></a><span id="l11.104" class="difflineminus">-    /**</span>
<a href="#l11.105"></a><span id="l11.105" class="difflineminus">-     * Query whether an assertion exists in this graph.</span>
<a href="#l11.106"></a><span id="l11.106" class="difflineminus">-     */</span>
<a href="#l11.107"></a><span id="l11.107" class="difflineminus">-    boolean HasAssertion(in nsIRDFResource aSource,</span>
<a href="#l11.108"></a><span id="l11.108" class="difflineminus">-                         in nsIRDFResource aProperty,</span>
<a href="#l11.109"></a><span id="l11.109" class="difflineminus">-                         in nsIRDFNode     aTarget,</span>
<a href="#l11.110"></a><span id="l11.110" class="difflineminus">-                         in boolean        aTruthValue);</span>
<a href="#l11.111"></a><span id="l11.111" class="difflineminus">-</span>
<a href="#l11.112"></a><span id="l11.112" class="difflineminus">-    /**</span>
<a href="#l11.113"></a><span id="l11.113" class="difflineminus">-     * Add an observer to this data source. If the datasource</span>
<a href="#l11.114"></a><span id="l11.114" class="difflineminus">-     * supports observers, the datasource source should hold a strong</span>
<a href="#l11.115"></a><span id="l11.115" class="difflineminus">-     * reference to the observer.</span>
<a href="#l11.116"></a><span id="l11.116" class="difflineminus">-     */</span>
<a href="#l11.117"></a><span id="l11.117" class="difflineminus">-    void AddObserver(in nsIRDFObserver aObserver);</span>
<a href="#l11.118"></a><span id="l11.118" class="difflineminus">-</span>
<a href="#l11.119"></a><span id="l11.119" class="difflineminus">-    /**</span>
<a href="#l11.120"></a><span id="l11.120" class="difflineminus">-     * Remove an observer from this data source.</span>
<a href="#l11.121"></a><span id="l11.121" class="difflineminus">-     */</span>
<a href="#l11.122"></a><span id="l11.122" class="difflineminus">-    void RemoveObserver(in nsIRDFObserver aObserver);</span>
<a href="#l11.123"></a><span id="l11.123" class="difflineminus">-</span>
<a href="#l11.124"></a><span id="l11.124" class="difflineminus">-    /**</span>
<a href="#l11.125"></a><span id="l11.125" class="difflineminus">-     * Get a cursor to iterate over all the arcs that point into a node.</span>
<a href="#l11.126"></a><span id="l11.126" class="difflineminus">-     */</span>
<a href="#l11.127"></a><span id="l11.127" class="difflineminus">-    nsISimpleEnumerator ArcLabelsIn(in nsIRDFNode aNode);</span>
<a href="#l11.128"></a><span id="l11.128" class="difflineminus">-</span>
<a href="#l11.129"></a><span id="l11.129" class="difflineminus">-    /**</span>
<a href="#l11.130"></a><span id="l11.130" class="difflineminus">-     * Get a cursor to iterate over all the arcs that originate in</span>
<a href="#l11.131"></a><span id="l11.131" class="difflineminus">-     * a resource.</span>
<a href="#l11.132"></a><span id="l11.132" class="difflineminus">-     */</span>
<a href="#l11.133"></a><span id="l11.133" class="difflineminus">-    nsISimpleEnumerator ArcLabelsOut(in nsIRDFResource aSource);</span>
<a href="#l11.134"></a><span id="l11.134" class="difflineminus">-</span>
<a href="#l11.135"></a><span id="l11.135" class="difflineminus">-    /**</span>
<a href="#l11.136"></a><span id="l11.136" class="difflineminus">-     * Retrieve all of the resources that the data source currently</span>
<a href="#l11.137"></a><span id="l11.137" class="difflineminus">-     * refers to.</span>
<a href="#l11.138"></a><span id="l11.138" class="difflineminus">-     */</span>
<a href="#l11.139"></a><span id="l11.139" class="difflineminus">-    nsISimpleEnumerator GetAllResources();</span>
<a href="#l11.140"></a><span id="l11.140" class="difflineminus">-</span>
<a href="#l11.141"></a><span id="l11.141" class="difflineminus">-    /**</span>
<a href="#l11.142"></a><span id="l11.142" class="difflineminus">-     * Returns whether a given command is enabled for a set of sources. </span>
<a href="#l11.143"></a><span id="l11.143" class="difflineminus">-     */</span>
<a href="#l11.144"></a><span id="l11.144" class="difflineminus">-    boolean IsCommandEnabled(in nsISupports aSources,</span>
<a href="#l11.145"></a><span id="l11.145" class="difflineminus">-                             in nsIRDFResource   aCommand,</span>
<a href="#l11.146"></a><span id="l11.146" class="difflineminus">-                             in nsISupports aArguments);</span>
<a href="#l11.147"></a><span id="l11.147" class="difflineminus">-</span>
<a href="#l11.148"></a><span id="l11.148" class="difflineminus">-    /**</span>
<a href="#l11.149"></a><span id="l11.149" class="difflineminus">-     * Perform the specified command on set of sources.</span>
<a href="#l11.150"></a><span id="l11.150" class="difflineminus">-     */</span>
<a href="#l11.151"></a><span id="l11.151" class="difflineminus">-    void DoCommand(in nsISupports aSources,</span>
<a href="#l11.152"></a><span id="l11.152" class="difflineminus">-                   in nsIRDFResource   aCommand,</span>
<a href="#l11.153"></a><span id="l11.153" class="difflineminus">-                   in nsISupports aArguments);</span>
<a href="#l11.154"></a><span id="l11.154" class="difflineminus">-</span>
<a href="#l11.155"></a><span id="l11.155" class="difflineminus">-    /**</span>
<a href="#l11.156"></a><span id="l11.156" class="difflineminus">-     * Returns the set of all commands defined for a given source.</span>
<a href="#l11.157"></a><span id="l11.157" class="difflineminus">-     */</span>
<a href="#l11.158"></a><span id="l11.158" class="difflineminus">-    nsISimpleEnumerator GetAllCmds(in nsIRDFResource aSource);</span>
<a href="#l11.159"></a><span id="l11.159" class="difflineminus">-</span>
<a href="#l11.160"></a><span id="l11.160" class="difflineminus">-    /**</span>
<a href="#l11.161"></a><span id="l11.161" class="difflineminus">-     * Returns true if the specified node is pointed to by the specified arc.</span>
<a href="#l11.162"></a><span id="l11.162" class="difflineminus">-     * Equivalent to enumerating ArcLabelsIn and comparing for the specified arc.</span>
<a href="#l11.163"></a><span id="l11.163" class="difflineminus">-     */</span>
<a href="#l11.164"></a><span id="l11.164" class="difflineminus">-    boolean hasArcIn(in nsIRDFNode aNode, in nsIRDFResource aArc);</span>
<a href="#l11.165"></a><span id="l11.165" class="difflineminus">-</span>
<a href="#l11.166"></a><span id="l11.166" class="difflineminus">-    /**</span>
<a href="#l11.167"></a><span id="l11.167" class="difflineminus">-     * Returns true if the specified node has the specified outward arc.</span>
<a href="#l11.168"></a><span id="l11.168" class="difflineminus">-     * Equivalent to enumerating ArcLabelsOut and comparing for the specified arc.</span>
<a href="#l11.169"></a><span id="l11.169" class="difflineminus">-     */</span>
<a href="#l11.170"></a><span id="l11.170" class="difflineminus">-    boolean hasArcOut(in nsIRDFResource aSource, in nsIRDFResource aArc);</span>
<a href="#l11.171"></a><span id="l11.171" class="difflineminus">-</span>
<a href="#l11.172"></a><span id="l11.172" class="difflineminus">-    /**</span>
<a href="#l11.173"></a><span id="l11.173" class="difflineminus">-     * Notify observers that the datasource is about to send several</span>
<a href="#l11.174"></a><span id="l11.174" class="difflineminus">-     * notifications at once.</span>
<a href="#l11.175"></a><span id="l11.175" class="difflineminus">-     * This must be followed by calling endUpdateBatch(), otherwise</span>
<a href="#l11.176"></a><span id="l11.176" class="difflineminus">-     * viewers will get out of sync.</span>
<a href="#l11.177"></a><span id="l11.177" class="difflineminus">-     */</span>
<a href="#l11.178"></a><span id="l11.178" class="difflineminus">-    void beginUpdateBatch();</span>
<a href="#l11.179"></a><span id="l11.179" class="difflineminus">-</span>
<a href="#l11.180"></a><span id="l11.180" class="difflineminus">-    /**</span>
<a href="#l11.181"></a><span id="l11.181" class="difflineminus">-     * Notify observers that the datasource has completed issuing</span>
<a href="#l11.182"></a><span id="l11.182" class="difflineminus">-     * a notification group.</span>
<a href="#l11.183"></a><span id="l11.183" class="difflineminus">-     */</span>
<a href="#l11.184"></a><span id="l11.184" class="difflineminus">-    void endUpdateBatch();</span>
<a href="#l11.185"></a><span id="l11.185" class="difflineminus">-};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1">deleted file mode 100644</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineminus">--- a/rdf/base/nsIRDFDelegateFactory.idl</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineplus">+++ /dev/null</span>
<a href="#l12.4"></a><span id="l12.4" class="difflineat">@@ -1,40 +0,0 @@</span>
<a href="#l12.5"></a><span id="l12.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l12.6"></a><span id="l12.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l12.7"></a><span id="l12.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l12.8"></a><span id="l12.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l12.9"></a><span id="l12.9" class="difflineminus">-</span>
<a href="#l12.10"></a><span id="l12.10" class="difflineminus">-/*</span>
<a href="#l12.11"></a><span id="l12.11" class="difflineminus">-</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-  An interface used for runtime pseudo-aggregation of RDF delegate</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineminus">-  objects.</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineminus">-</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineminus">-*/</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineminus">-</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineminus">-#include &quot;nsrootidl.idl&quot;</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineminus">-#include &quot;nsISupports.idl&quot;</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineminus">-interface nsIRDFResource;</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineminus">-</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineminus">-/**</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineminus">- * This interface should be implemented by an XPCOM factory that</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineminus">- * is registered to handle &quot;@mozilla.org/rdf/delegate-factory/[key]/[scheme];1&quot;</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineminus">- * ContractIDs.</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineminus">- *</span>
<a href="#l12.26"></a><span id="l12.26" class="difflineminus">- * The factory will be invoked to create delegate objects from</span>
<a href="#l12.27"></a><span id="l12.27" class="difflineminus">- * nsIRDFResource::GetDelegate().</span>
<a href="#l12.28"></a><span id="l12.28" class="difflineminus">- */</span>
<a href="#l12.29"></a><span id="l12.29" class="difflineminus">-[scriptable, uuid(A1B89470-A124-11d3-BE59-0020A6361667)]</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineminus">-interface nsIRDFDelegateFactory : nsISupports</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineminus">-{</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineminus">-    /**</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineminus">-     * Create a delegate for the specified RDF resource.</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineminus">-     *</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineminus">-     * The created delegate should forward AddRef() and Release()</span>
<a href="#l12.36"></a><span id="l12.36" class="difflineminus">-     * calls to the aOuter object.</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineminus">-     */</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineminus">-    void CreateDelegate(in nsIRDFResource aOuter,</span>
<a href="#l12.39"></a><span id="l12.39" class="difflineminus">-                        in string aKey,</span>
<a href="#l12.40"></a><span id="l12.40" class="difflineminus">-                        in nsIIDRef aIID,</span>
<a href="#l12.41"></a><span id="l12.41" class="difflineminus">-                        [retval, iid_is(aIID)] out nsQIResult aResult);</span>
<a href="#l12.42"></a><span id="l12.42" class="difflineminus">-};</span>
<a href="#l12.43"></a><span id="l12.43" class="difflineminus">-</span>
<a href="#l12.44"></a><span id="l12.44" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1">deleted file mode 100644</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineminus">--- a/rdf/base/nsIRDFInMemoryDataSource.idl</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineplus">+++ /dev/null</span>
<a href="#l13.4"></a><span id="l13.4" class="difflineat">@@ -1,14 +0,0 @@</span>
<a href="#l13.5"></a><span id="l13.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l13.6"></a><span id="l13.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l13.7"></a><span id="l13.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l13.8"></a><span id="l13.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l13.9"></a><span id="l13.9" class="difflineminus">-</span>
<a href="#l13.10"></a><span id="l13.10" class="difflineminus">-#include &quot;nsISupports.idl&quot;</span>
<a href="#l13.11"></a><span id="l13.11" class="difflineminus">-#include &quot;nsIRDFResource.idl&quot;</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-#include &quot;nsIRDFNode.idl&quot;</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineminus">-</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineminus">-[scriptable, uuid(17C4E0AA-1DD2-11B2-8029-BF6F668DE500)]</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineminus">-interface nsIRDFInMemoryDataSource : nsISupports</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineminus">-{</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineminus">-    void EnsureFastContainment(in nsIRDFResource aSource);</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineminus">-};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1">deleted file mode 100644</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineminus">--- a/rdf/base/nsIRDFInferDataSource.idl</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineplus">+++ /dev/null</span>
<a href="#l14.4"></a><span id="l14.4" class="difflineat">@@ -1,28 +0,0 @@</span>
<a href="#l14.5"></a><span id="l14.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l14.6"></a><span id="l14.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l14.7"></a><span id="l14.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l14.8"></a><span id="l14.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l14.9"></a><span id="l14.9" class="difflineminus">-</span>
<a href="#l14.10"></a><span id="l14.10" class="difflineminus">-#include &quot;nsIRDFDataSource.idl&quot;</span>
<a href="#l14.11"></a><span id="l14.11" class="difflineminus">-</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-/**</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineminus">- * An nsIRDFInferDataSource is implemented by a infer engine. This</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineminus">- * engine mimics assertions in addition to those in the baseDataSource</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineminus">- * according to a particular vocabulary.</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineminus">- * Infer engines have contract IDs in the form of</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineminus">- * &quot;@mozilla.org/rdf/infer-datasource;1?engine=&quot;</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineminus">- */</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineminus">-</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineminus">-[scriptable, uuid(2b04860f-4017-40f6-8a57-784a1e35077a)]</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineminus">-interface nsIRDFInferDataSource : nsIRDFDataSource {</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineminus">-    /**</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineminus">-     *</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineminus">-     * The wrapped datasource.</span>
<a href="#l14.25"></a><span id="l14.25" class="difflineminus">-     *</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineminus">-     * The InferDataSource contains all arcs from the wrapped</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineminus">-     * datasource plus those infered by the vocabulary implemented</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineminus">-     * by the InferDataSource.</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineminus">-     */</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineminus">-    attribute nsIRDFDataSource baseDataSource;</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineminus">-};</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1">deleted file mode 100644</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineminus">--- a/rdf/base/nsIRDFLiteral.idl</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineplus">+++ /dev/null</span>
<a href="#l15.4"></a><span id="l15.4" class="difflineat">@@ -1,68 +0,0 @@</span>
<a href="#l15.5"></a><span id="l15.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l15.6"></a><span id="l15.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l15.7"></a><span id="l15.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l15.8"></a><span id="l15.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l15.9"></a><span id="l15.9" class="difflineminus">-</span>
<a href="#l15.10"></a><span id="l15.10" class="difflineminus">-#include &quot;nsIRDFNode.idl&quot;</span>
<a href="#l15.11"></a><span id="l15.11" class="difflineminus">-</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-%{C++</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineminus">-#include &quot;nscore.h&quot; // for char16_t</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineminus">-%}</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineminus">-</span>
<a href="#l15.16"></a><span id="l15.16" class="difflineminus">-[ptr] native const_octet_ptr(const uint8_t);</span>
<a href="#l15.17"></a><span id="l15.17" class="difflineminus">-</span>
<a href="#l15.18"></a><span id="l15.18" class="difflineminus">-/**</span>
<a href="#l15.19"></a><span id="l15.19" class="difflineminus">- * A literal node in the graph, whose value is a string.</span>
<a href="#l15.20"></a><span id="l15.20" class="difflineminus">- */</span>
<a href="#l15.21"></a><span id="l15.21" class="difflineminus">-[scriptable, uuid(E0C493D2-9542-11d2-8EB8-00805F29F370)]</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineminus">-interface nsIRDFLiteral : nsIRDFNode {</span>
<a href="#l15.23"></a><span id="l15.23" class="difflineminus">-    /**</span>
<a href="#l15.24"></a><span id="l15.24" class="difflineminus">-     * The Unicode string value of the literal.</span>
<a href="#l15.25"></a><span id="l15.25" class="difflineminus">-     */</span>
<a href="#l15.26"></a><span id="l15.26" class="difflineminus">-    readonly attribute wstring Value;</span>
<a href="#l15.27"></a><span id="l15.27" class="difflineminus">-</span>
<a href="#l15.28"></a><span id="l15.28" class="difflineminus">-    /**</span>
<a href="#l15.29"></a><span id="l15.29" class="difflineminus">-     * An unscriptable version used to avoid a string copy. Meant</span>
<a href="#l15.30"></a><span id="l15.30" class="difflineminus">-     * for use as a performance optimization.</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineminus">-     */</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineminus">-    [noscript] void GetValueConst([shared] out wstring aConstValue);</span>
<a href="#l15.33"></a><span id="l15.33" class="difflineminus">-};</span>
<a href="#l15.34"></a><span id="l15.34" class="difflineminus">-</span>
<a href="#l15.35"></a><span id="l15.35" class="difflineminus">-/**</span>
<a href="#l15.36"></a><span id="l15.36" class="difflineminus">- * A literal node in the graph, whose value is a date</span>
<a href="#l15.37"></a><span id="l15.37" class="difflineminus">- */</span>
<a href="#l15.38"></a><span id="l15.38" class="difflineminus">-[scriptable, uuid(E13A24E1-C77A-11d2-80BE-006097B76B8E)]</span>
<a href="#l15.39"></a><span id="l15.39" class="difflineminus">-interface nsIRDFDate : nsIRDFNode {</span>
<a href="#l15.40"></a><span id="l15.40" class="difflineminus">-    /**</span>
<a href="#l15.41"></a><span id="l15.41" class="difflineminus">-     * The date value of the literal</span>
<a href="#l15.42"></a><span id="l15.42" class="difflineminus">-     */</span>
<a href="#l15.43"></a><span id="l15.43" class="difflineminus">-    readonly attribute PRTime Value;</span>
<a href="#l15.44"></a><span id="l15.44" class="difflineminus">-};</span>
<a href="#l15.45"></a><span id="l15.45" class="difflineminus">-</span>
<a href="#l15.46"></a><span id="l15.46" class="difflineminus">-/**</span>
<a href="#l15.47"></a><span id="l15.47" class="difflineminus">- * A literal node in the graph, whose value is an integer</span>
<a href="#l15.48"></a><span id="l15.48" class="difflineminus">- */</span>
<a href="#l15.49"></a><span id="l15.49" class="difflineminus">-[scriptable, uuid(E13A24E3-C77A-11d2-80BE-006097B76B8E)]</span>
<a href="#l15.50"></a><span id="l15.50" class="difflineminus">-interface nsIRDFInt : nsIRDFNode {</span>
<a href="#l15.51"></a><span id="l15.51" class="difflineminus">-    /**</span>
<a href="#l15.52"></a><span id="l15.52" class="difflineminus">-     * The integer value of the literal</span>
<a href="#l15.53"></a><span id="l15.53" class="difflineminus">-     */</span>
<a href="#l15.54"></a><span id="l15.54" class="difflineminus">-    readonly attribute long Value;</span>
<a href="#l15.55"></a><span id="l15.55" class="difflineminus">-};</span>
<a href="#l15.56"></a><span id="l15.56" class="difflineminus">-</span>
<a href="#l15.57"></a><span id="l15.57" class="difflineminus">-/**</span>
<a href="#l15.58"></a><span id="l15.58" class="difflineminus">- * A literal node in the graph, whose value is arbitrary</span>
<a href="#l15.59"></a><span id="l15.59" class="difflineminus">- * binary data.</span>
<a href="#l15.60"></a><span id="l15.60" class="difflineminus">- */</span>
<a href="#l15.61"></a><span id="l15.61" class="difflineminus">-[scriptable, uuid(237f85a2-1dd2-11b2-94af-8122582fc45e)]</span>
<a href="#l15.62"></a><span id="l15.62" class="difflineminus">-interface nsIRDFBlob : nsIRDFNode {</span>
<a href="#l15.63"></a><span id="l15.63" class="difflineminus">-    /**</span>
<a href="#l15.64"></a><span id="l15.64" class="difflineminus">-     * The binary data.</span>
<a href="#l15.65"></a><span id="l15.65" class="difflineminus">-     */</span>
<a href="#l15.66"></a><span id="l15.66" class="difflineminus">-    [noscript] readonly attribute const_octet_ptr value;</span>
<a href="#l15.67"></a><span id="l15.67" class="difflineminus">-</span>
<a href="#l15.68"></a><span id="l15.68" class="difflineminus">-    /**</span>
<a href="#l15.69"></a><span id="l15.69" class="difflineminus">-     * The data's length.</span>
<a href="#l15.70"></a><span id="l15.70" class="difflineminus">-     */</span>
<a href="#l15.71"></a><span id="l15.71" class="difflineminus">-    readonly attribute long length;</span>
<a href="#l15.72"></a><span id="l15.72" class="difflineminus">-};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1">deleted file mode 100644</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineminus">--- a/rdf/base/nsIRDFNode.idl</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineplus">+++ /dev/null</span>
<a href="#l16.4"></a><span id="l16.4" class="difflineat">@@ -1,15 +0,0 @@</span>
<a href="#l16.5"></a><span id="l16.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l16.6"></a><span id="l16.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l16.7"></a><span id="l16.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l16.8"></a><span id="l16.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l16.9"></a><span id="l16.9" class="difflineminus">-</span>
<a href="#l16.10"></a><span id="l16.10" class="difflineminus">-#include &quot;nsISupports.idl&quot;</span>
<a href="#l16.11"></a><span id="l16.11" class="difflineminus">-</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-// An nsIRDFNode object is an abstract placeholder for a node in the</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineminus">-// RDF data model. Its concreted implementations (e.g., nsIRDFResource</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineminus">-// or nsIRDFLiteral) are the actual objects that populate the graph.</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineminus">-[scriptable, uuid(0F78DA50-8321-11d2-8EAC-00805F29F370)]</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineminus">-interface nsIRDFNode : nsISupports {</span>
<a href="#l16.17"></a><span id="l16.17" class="difflineminus">-    // Determine if two nodes are identical</span>
<a href="#l16.18"></a><span id="l16.18" class="difflineminus">-    boolean EqualsNode(in nsIRDFNode aNode);</span>
<a href="#l16.19"></a><span id="l16.19" class="difflineminus">-};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1">deleted file mode 100644</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineminus">--- a/rdf/base/nsIRDFObserver.idl</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineplus">+++ /dev/null</span>
<a href="#l17.4"></a><span id="l17.4" class="difflineat">@@ -1,94 +0,0 @@</span>
<a href="#l17.5"></a><span id="l17.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l17.6"></a><span id="l17.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l17.7"></a><span id="l17.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l17.8"></a><span id="l17.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l17.9"></a><span id="l17.9" class="difflineminus">-</span>
<a href="#l17.10"></a><span id="l17.10" class="difflineminus">-#include &quot;nsISupports.idl&quot;</span>
<a href="#l17.11"></a><span id="l17.11" class="difflineminus">-#include &quot;nsIRDFResource.idl&quot;</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-#include &quot;nsIRDFNode.idl&quot;</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineminus">-</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineminus">-interface nsIRDFDataSource;</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineminus">-</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineminus">-// An nsIRDFObserver object is an observer that will be notified</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineminus">-// when assertions are made or removed from a datasource</span>
<a href="#l17.18"></a><span id="l17.18" class="difflineminus">-[scriptable, uuid(3CC75360-484A-11D2-BC16-00805F912FE7)]</span>
<a href="#l17.19"></a><span id="l17.19" class="difflineminus">-interface nsIRDFObserver : nsISupports {</span>
<a href="#l17.20"></a><span id="l17.20" class="difflineminus">-    /**</span>
<a href="#l17.21"></a><span id="l17.21" class="difflineminus">-     * This method is called whenever a new assertion is made</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineminus">-     * in the data source</span>
<a href="#l17.23"></a><span id="l17.23" class="difflineminus">-     * @param aDataSource the datasource that is issuing</span>
<a href="#l17.24"></a><span id="l17.24" class="difflineminus">-     *   the notification.</span>
<a href="#l17.25"></a><span id="l17.25" class="difflineminus">-     * @param aSource the subject of the assertion</span>
<a href="#l17.26"></a><span id="l17.26" class="difflineminus">-     * @param aProperty the predicate of the assertion</span>
<a href="#l17.27"></a><span id="l17.27" class="difflineminus">-     * @param aTarget the object of the assertion</span>
<a href="#l17.28"></a><span id="l17.28" class="difflineminus">-     */</span>
<a href="#l17.29"></a><span id="l17.29" class="difflineminus">-    void onAssert(in nsIRDFDataSource aDataSource,</span>
<a href="#l17.30"></a><span id="l17.30" class="difflineminus">-                  in nsIRDFResource aSource,</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineminus">-                  in nsIRDFResource aProperty,</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineminus">-                  in nsIRDFNode     aTarget);</span>
<a href="#l17.33"></a><span id="l17.33" class="difflineminus">-</span>
<a href="#l17.34"></a><span id="l17.34" class="difflineminus">-    /**</span>
<a href="#l17.35"></a><span id="l17.35" class="difflineminus">-     * This method is called whenever an assertion is removed</span>
<a href="#l17.36"></a><span id="l17.36" class="difflineminus">-     * from the data source</span>
<a href="#l17.37"></a><span id="l17.37" class="difflineminus">-     * @param aDataSource the datasource that is issuing</span>
<a href="#l17.38"></a><span id="l17.38" class="difflineminus">-     *   the notification.</span>
<a href="#l17.39"></a><span id="l17.39" class="difflineminus">-     * @param aSource the subject of the assertion</span>
<a href="#l17.40"></a><span id="l17.40" class="difflineminus">-     * @param aProperty the predicate of the assertion</span>
<a href="#l17.41"></a><span id="l17.41" class="difflineminus">-     * @param aTarget the object of the assertion</span>
<a href="#l17.42"></a><span id="l17.42" class="difflineminus">-     */</span>
<a href="#l17.43"></a><span id="l17.43" class="difflineminus">-    void onUnassert(in nsIRDFDataSource aDataSource,</span>
<a href="#l17.44"></a><span id="l17.44" class="difflineminus">-                    in nsIRDFResource aSource,</span>
<a href="#l17.45"></a><span id="l17.45" class="difflineminus">-                    in nsIRDFResource aProperty,</span>
<a href="#l17.46"></a><span id="l17.46" class="difflineminus">-                    in nsIRDFNode     aTarget);</span>
<a href="#l17.47"></a><span id="l17.47" class="difflineminus">-</span>
<a href="#l17.48"></a><span id="l17.48" class="difflineminus">-    /**</span>
<a href="#l17.49"></a><span id="l17.49" class="difflineminus">-     * This method is called when the object of an assertion</span>
<a href="#l17.50"></a><span id="l17.50" class="difflineminus">-     * changes from one value to another.</span>
<a href="#l17.51"></a><span id="l17.51" class="difflineminus">-     * @param aDataSource the datasource that is issuing</span>
<a href="#l17.52"></a><span id="l17.52" class="difflineminus">-     *   the notification.</span>
<a href="#l17.53"></a><span id="l17.53" class="difflineminus">-     * @param aSource the subject of the assertion</span>
<a href="#l17.54"></a><span id="l17.54" class="difflineminus">-     * @param aProperty the predicate of the assertion</span>
<a href="#l17.55"></a><span id="l17.55" class="difflineminus">-     * @param aOldTarget the old object of the assertion</span>
<a href="#l17.56"></a><span id="l17.56" class="difflineminus">-     * @param aNewTarget the new object of the assertion</span>
<a href="#l17.57"></a><span id="l17.57" class="difflineminus">-     */</span>
<a href="#l17.58"></a><span id="l17.58" class="difflineminus">-    void onChange(in nsIRDFDataSource aDataSource,</span>
<a href="#l17.59"></a><span id="l17.59" class="difflineminus">-                  in nsIRDFResource aSource,</span>
<a href="#l17.60"></a><span id="l17.60" class="difflineminus">-                  in nsIRDFResource aProperty,</span>
<a href="#l17.61"></a><span id="l17.61" class="difflineminus">-                  in nsIRDFNode     aOldTarget,</span>
<a href="#l17.62"></a><span id="l17.62" class="difflineminus">-                  in nsIRDFNode     aNewTarget);</span>
<a href="#l17.63"></a><span id="l17.63" class="difflineminus">-</span>
<a href="#l17.64"></a><span id="l17.64" class="difflineminus">-    /**</span>
<a href="#l17.65"></a><span id="l17.65" class="difflineminus">-     * This method is called when the subject of an assertion</span>
<a href="#l17.66"></a><span id="l17.66" class="difflineminus">-     * changes from one value to another.</span>
<a href="#l17.67"></a><span id="l17.67" class="difflineminus">-     * @param aDataSource the datasource that is issuing</span>
<a href="#l17.68"></a><span id="l17.68" class="difflineminus">-     *   the notification.</span>
<a href="#l17.69"></a><span id="l17.69" class="difflineminus">-     * @param aOldSource the old subject of the assertion</span>
<a href="#l17.70"></a><span id="l17.70" class="difflineminus">-     * @param aNewSource the new subject of the assertion</span>
<a href="#l17.71"></a><span id="l17.71" class="difflineminus">-     * @param aProperty the predicate of the assertion</span>
<a href="#l17.72"></a><span id="l17.72" class="difflineminus">-     * @param aTarget the object of the assertion</span>
<a href="#l17.73"></a><span id="l17.73" class="difflineminus">-     */</span>
<a href="#l17.74"></a><span id="l17.74" class="difflineminus">-    void onMove(in nsIRDFDataSource aDataSource,</span>
<a href="#l17.75"></a><span id="l17.75" class="difflineminus">-                in nsIRDFResource aOldSource,</span>
<a href="#l17.76"></a><span id="l17.76" class="difflineminus">-                in nsIRDFResource aNewSource,</span>
<a href="#l17.77"></a><span id="l17.77" class="difflineminus">-                in nsIRDFResource aProperty,</span>
<a href="#l17.78"></a><span id="l17.78" class="difflineminus">-                in nsIRDFNode     aTarget);</span>
<a href="#l17.79"></a><span id="l17.79" class="difflineminus">-</span>
<a href="#l17.80"></a><span id="l17.80" class="difflineminus">-    /**</span>
<a href="#l17.81"></a><span id="l17.81" class="difflineminus">-     * This method is called when a datasource is about to</span>
<a href="#l17.82"></a><span id="l17.82" class="difflineminus">-     * send several notifications at once. The observer can</span>
<a href="#l17.83"></a><span id="l17.83" class="difflineminus">-     * use this as a cue to optimize its behavior. The observer</span>
<a href="#l17.84"></a><span id="l17.84" class="difflineminus">-     * can expect the datasource to call endUpdateBatch() when</span>
<a href="#l17.85"></a><span id="l17.85" class="difflineminus">-     * the group of notifications has completed.</span>
<a href="#l17.86"></a><span id="l17.86" class="difflineminus">-     * @param aDataSource the datasource that is going to</span>
<a href="#l17.87"></a><span id="l17.87" class="difflineminus">-     *   be issuing the notifications.</span>
<a href="#l17.88"></a><span id="l17.88" class="difflineminus">-     */</span>
<a href="#l17.89"></a><span id="l17.89" class="difflineminus">-    void onBeginUpdateBatch(in nsIRDFDataSource aDataSource);</span>
<a href="#l17.90"></a><span id="l17.90" class="difflineminus">-</span>
<a href="#l17.91"></a><span id="l17.91" class="difflineminus">-    /**</span>
<a href="#l17.92"></a><span id="l17.92" class="difflineminus">-     * This method is called when a datasource has completed</span>
<a href="#l17.93"></a><span id="l17.93" class="difflineminus">-     * issuing a notification group.</span>
<a href="#l17.94"></a><span id="l17.94" class="difflineminus">-     * @param aDataSource the datasource that has finished</span>
<a href="#l17.95"></a><span id="l17.95" class="difflineminus">-     *   issuing a group of notifications</span>
<a href="#l17.96"></a><span id="l17.96" class="difflineminus">-     */</span>
<a href="#l17.97"></a><span id="l17.97" class="difflineminus">-    void onEndUpdateBatch(in nsIRDFDataSource aDataSource);</span>
<a href="#l17.98"></a><span id="l17.98" class="difflineminus">-};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1">deleted file mode 100644</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineminus">--- a/rdf/base/nsIRDFPropagatableDataSource.idl</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineplus">+++ /dev/null</span>
<a href="#l18.4"></a><span id="l18.4" class="difflineat">@@ -1,27 +0,0 @@</span>
<a href="#l18.5"></a><span id="l18.5" class="difflineminus">-/* -*- Mode: idl; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l18.6"></a><span id="l18.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l18.7"></a><span id="l18.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l18.8"></a><span id="l18.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l18.9"></a><span id="l18.9" class="difflineminus">-</span>
<a href="#l18.10"></a><span id="l18.10" class="difflineminus">-</span>
<a href="#l18.11"></a><span id="l18.11" class="difflineminus">-#include &quot;nsISupports.idl&quot;</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineminus">-/**</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineminus">- * An nsIRDFPropagatableDataSource provides an ability to suppress</span>
<a href="#l18.15"></a><span id="l18.15" class="difflineminus">- * synchronization notifications.</span>
<a href="#l18.16"></a><span id="l18.16" class="difflineminus">- */</span>
<a href="#l18.17"></a><span id="l18.17" class="difflineminus">-[scriptable, uuid(5a9b4770-9fcb-4307-a12e-4b6708e78b97)]</span>
<a href="#l18.18"></a><span id="l18.18" class="difflineminus">-interface nsIRDFPropagatableDataSource: nsISupports {</span>
<a href="#l18.19"></a><span id="l18.19" class="difflineminus">-</span>
<a href="#l18.20"></a><span id="l18.20" class="difflineminus">-  /**</span>
<a href="#l18.21"></a><span id="l18.21" class="difflineminus">-   * Set this value to &lt;code&gt;true&lt;/code&gt; to enable synchronization</span>
<a href="#l18.22"></a><span id="l18.22" class="difflineminus">-   * notifications.</span>
<a href="#l18.23"></a><span id="l18.23" class="difflineminus">-   *</span>
<a href="#l18.24"></a><span id="l18.24" class="difflineminus">-   * Set this value to &lt;code&gt;false&lt;/code&gt; to disable synchronization</span>
<a href="#l18.25"></a><span id="l18.25" class="difflineminus">-   * notifications.</span>
<a href="#l18.26"></a><span id="l18.26" class="difflineminus">-   *</span>
<a href="#l18.27"></a><span id="l18.27" class="difflineminus">-   * By default, this value is &lt;code&gt;true&lt;/code&gt;.</span>
<a href="#l18.28"></a><span id="l18.28" class="difflineminus">-   */</span>
<a href="#l18.29"></a><span id="l18.29" class="difflineminus">-  attribute boolean propagateChanges;</span>
<a href="#l18.30"></a><span id="l18.30" class="difflineminus">-</span>
<a href="#l18.31"></a><span id="l18.31" class="difflineminus">-};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1">deleted file mode 100644</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineminus">--- a/rdf/base/nsIRDFPurgeableDataSource.idl</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineplus">+++ /dev/null</span>
<a href="#l19.4"></a><span id="l19.4" class="difflineat">@@ -1,19 +0,0 @@</span>
<a href="#l19.5"></a><span id="l19.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l19.6"></a><span id="l19.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l19.7"></a><span id="l19.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l19.8"></a><span id="l19.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l19.9"></a><span id="l19.9" class="difflineminus">-</span>
<a href="#l19.10"></a><span id="l19.10" class="difflineminus">-#include &quot;nsISupports.idl&quot;</span>
<a href="#l19.11"></a><span id="l19.11" class="difflineminus">-#include &quot;nsIRDFResource.idl&quot;</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-#include &quot;nsIRDFNode.idl&quot;</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineminus">-</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineminus">-[scriptable, uuid(951700F0-FED0-11D2-BDD9-00104BDE6048)]</span>
<a href="#l19.15"></a><span id="l19.15" class="difflineminus">-interface nsIRDFPurgeableDataSource : nsISupports</span>
<a href="#l19.16"></a><span id="l19.16" class="difflineminus">-{</span>
<a href="#l19.17"></a><span id="l19.17" class="difflineminus">-    boolean Mark(in nsIRDFResource aSource,</span>
<a href="#l19.18"></a><span id="l19.18" class="difflineminus">-                 in nsIRDFResource aProperty,</span>
<a href="#l19.19"></a><span id="l19.19" class="difflineminus">-                 in nsIRDFNode aTarget,</span>
<a href="#l19.20"></a><span id="l19.20" class="difflineminus">-                 in boolean aTruthValue);</span>
<a href="#l19.21"></a><span id="l19.21" class="difflineminus">-</span>
<a href="#l19.22"></a><span id="l19.22" class="difflineminus">-    void Sweep();</span>
<a href="#l19.23"></a><span id="l19.23" class="difflineminus">-};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1">deleted file mode 100644</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineminus">--- a/rdf/base/nsIRDFRemoteDataSource.idl</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineplus">+++ /dev/null</span>
<a href="#l20.4"></a><span id="l20.4" class="difflineat">@@ -1,44 +0,0 @@</span>
<a href="#l20.5"></a><span id="l20.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l20.6"></a><span id="l20.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l20.7"></a><span id="l20.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l20.8"></a><span id="l20.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l20.9"></a><span id="l20.9" class="difflineminus">-</span>
<a href="#l20.10"></a><span id="l20.10" class="difflineminus">-#include &quot;nsISupports.idl&quot;</span>
<a href="#l20.11"></a><span id="l20.11" class="difflineminus">-</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-/**</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineminus">- * A datasource that may load asynchronously</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineminus">- */</span>
<a href="#l20.15"></a><span id="l20.15" class="difflineminus">-[scriptable, uuid(1D297320-27F7-11d3-BE01-000064657374)]</span>
<a href="#l20.16"></a><span id="l20.16" class="difflineminus">-interface nsIRDFRemoteDataSource : nsISupports</span>
<a href="#l20.17"></a><span id="l20.17" class="difflineminus">-{</span>
<a href="#l20.18"></a><span id="l20.18" class="difflineminus">-    /**</span>
<a href="#l20.19"></a><span id="l20.19" class="difflineminus">-     * This value is &lt;code&gt;true&lt;/code&gt; when the datasource has</span>
<a href="#l20.20"></a><span id="l20.20" class="difflineminus">-     * fully loaded itself.</span>
<a href="#l20.21"></a><span id="l20.21" class="difflineminus">-     */</span>
<a href="#l20.22"></a><span id="l20.22" class="difflineminus">-    readonly attribute boolean loaded;</span>
<a href="#l20.23"></a><span id="l20.23" class="difflineminus">-</span>
<a href="#l20.24"></a><span id="l20.24" class="difflineminus">-    /**</span>
<a href="#l20.25"></a><span id="l20.25" class="difflineminus">-     * Specify the URI for the data source: this is the prefix</span>
<a href="#l20.26"></a><span id="l20.26" class="difflineminus">-     * that will be used to register the data source in the</span>
<a href="#l20.27"></a><span id="l20.27" class="difflineminus">-     * data source registry.</span>
<a href="#l20.28"></a><span id="l20.28" class="difflineminus">-     * @param aURI the URI to load</span>
<a href="#l20.29"></a><span id="l20.29" class="difflineminus">-     */</span>
<a href="#l20.30"></a><span id="l20.30" class="difflineminus">-    void Init(in string aURI);</span>
<a href="#l20.31"></a><span id="l20.31" class="difflineminus">-</span>
<a href="#l20.32"></a><span id="l20.32" class="difflineminus">-    /**</span>
<a href="#l20.33"></a><span id="l20.33" class="difflineminus">-     * Refresh the remote datasource, re-loading its contents</span>
<a href="#l20.34"></a><span id="l20.34" class="difflineminus">-     * from the URI.</span>
<a href="#l20.35"></a><span id="l20.35" class="difflineminus">-     *</span>
<a href="#l20.36"></a><span id="l20.36" class="difflineminus">-     * @param aBlocking If &lt;code&gt;true&lt;/code&gt;, the call will block</span>
<a href="#l20.37"></a><span id="l20.37" class="difflineminus">-     * until the datasource has completely reloaded.</span>
<a href="#l20.38"></a><span id="l20.38" class="difflineminus">-     */</span>
<a href="#l20.39"></a><span id="l20.39" class="difflineminus">-    void Refresh(in boolean aBlocking);</span>
<a href="#l20.40"></a><span id="l20.40" class="difflineminus">-</span>
<a href="#l20.41"></a><span id="l20.41" class="difflineminus">-    /**</span>
<a href="#l20.42"></a><span id="l20.42" class="difflineminus">-     * Request that a data source write its contents out to </span>
<a href="#l20.43"></a><span id="l20.43" class="difflineminus">-     * permanent storage, if applicable.</span>
<a href="#l20.44"></a><span id="l20.44" class="difflineminus">-     */</span>
<a href="#l20.45"></a><span id="l20.45" class="difflineminus">-    void Flush();</span>
<a href="#l20.46"></a><span id="l20.46" class="difflineminus">-    void FlushTo(in string aURI);</span>
<a href="#l20.47"></a><span id="l20.47" class="difflineminus">-};</span>
<a href="#l20.48"></a><span id="l20.48" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1">deleted file mode 100644</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineminus">--- a/rdf/base/nsIRDFResource.idl</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineplus">+++ /dev/null</span>
<a href="#l21.4"></a><span id="l21.4" class="difflineat">@@ -1,81 +0,0 @@</span>
<a href="#l21.5"></a><span id="l21.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l21.6"></a><span id="l21.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l21.7"></a><span id="l21.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l21.8"></a><span id="l21.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l21.9"></a><span id="l21.9" class="difflineminus">-</span>
<a href="#l21.10"></a><span id="l21.10" class="difflineminus">-#include &quot;nsrootidl.idl&quot;</span>
<a href="#l21.11"></a><span id="l21.11" class="difflineminus">-#include &quot;nsIRDFNode.idl&quot;</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineminus">-</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineminus">-/**</span>
<a href="#l21.15"></a><span id="l21.15" class="difflineminus">- * An nsIRDFResource is an object that has unique identity in the </span>
<a href="#l21.16"></a><span id="l21.16" class="difflineminus">- * RDF data model. The object's identity is determined by its URI.</span>
<a href="#l21.17"></a><span id="l21.17" class="difflineminus">- */</span>
<a href="#l21.18"></a><span id="l21.18" class="difflineminus">-[scriptable, uuid(fb9686a7-719a-49dc-9107-10dea5739341)]</span>
<a href="#l21.19"></a><span id="l21.19" class="difflineminus">-interface nsIRDFResource : nsIRDFNode {</span>
<a href="#l21.20"></a><span id="l21.20" class="difflineminus">-    /**</span>
<a href="#l21.21"></a><span id="l21.21" class="difflineminus">-     * The single-byte string value of the resource.</span>
<a href="#l21.22"></a><span id="l21.22" class="difflineminus">-     * @note THIS IS OBSOLETE. C++ should use GetValueConst and script</span>
<a href="#l21.23"></a><span id="l21.23" class="difflineminus">-     *       should use .valueUTF8</span>
<a href="#l21.24"></a><span id="l21.24" class="difflineminus">-     */</span>
<a href="#l21.25"></a><span id="l21.25" class="difflineminus">-    readonly attribute string Value;</span>
<a href="#l21.26"></a><span id="l21.26" class="difflineminus">-</span>
<a href="#l21.27"></a><span id="l21.27" class="difflineminus">-    /**</span>
<a href="#l21.28"></a><span id="l21.28" class="difflineminus">-     * The UTF-8 URI of the resource.</span>
<a href="#l21.29"></a><span id="l21.29" class="difflineminus">-     */</span>
<a href="#l21.30"></a><span id="l21.30" class="difflineminus">-    readonly attribute AUTF8String ValueUTF8;</span>
<a href="#l21.31"></a><span id="l21.31" class="difflineminus">-</span>
<a href="#l21.32"></a><span id="l21.32" class="difflineminus">-    /**</span>
<a href="#l21.33"></a><span id="l21.33" class="difflineminus">-     * An unscriptable version used to avoid a string copy. Meant</span>
<a href="#l21.34"></a><span id="l21.34" class="difflineminus">-     * for use as a performance optimization. The string is encoded</span>
<a href="#l21.35"></a><span id="l21.35" class="difflineminus">-     * in UTF-8.</span>
<a href="#l21.36"></a><span id="l21.36" class="difflineminus">-     */</span>
<a href="#l21.37"></a><span id="l21.37" class="difflineminus">-    [noscript] void GetValueConst([shared] out string aConstValue);</span>
<a href="#l21.38"></a><span id="l21.38" class="difflineminus">-</span>
<a href="#l21.39"></a><span id="l21.39" class="difflineminus">-    /**</span>
<a href="#l21.40"></a><span id="l21.40" class="difflineminus">-     * This method is called by the nsIRDFService after constructing</span>
<a href="#l21.41"></a><span id="l21.41" class="difflineminus">-     * a resource object to initialize its URI. You would not normally</span>
<a href="#l21.42"></a><span id="l21.42" class="difflineminus">-     * call this method directly</span>
<a href="#l21.43"></a><span id="l21.43" class="difflineminus">-     */</span>
<a href="#l21.44"></a><span id="l21.44" class="difflineminus">-    void Init(in string uri);</span>
<a href="#l21.45"></a><span id="l21.45" class="difflineminus">-</span>
<a href="#l21.46"></a><span id="l21.46" class="difflineminus">-    /**</span>
<a href="#l21.47"></a><span id="l21.47" class="difflineminus">-     * Determine if the resource has the given URI.</span>
<a href="#l21.48"></a><span id="l21.48" class="difflineminus">-     */</span>
<a href="#l21.49"></a><span id="l21.49" class="difflineminus">-    boolean EqualsString(in string aURI);</span>
<a href="#l21.50"></a><span id="l21.50" class="difflineminus">-</span>
<a href="#l21.51"></a><span id="l21.51" class="difflineminus">-    /**</span>
<a href="#l21.52"></a><span id="l21.52" class="difflineminus">-     * Retrieve the &quot;delegate&quot; object for this resource. A resource</span>
<a href="#l21.53"></a><span id="l21.53" class="difflineminus">-     * may have several delegate objects, each of whose lifetimes is</span>
<a href="#l21.54"></a><span id="l21.54" class="difflineminus">-     * bound to the life of the resource object.</span>
<a href="#l21.55"></a><span id="l21.55" class="difflineminus">-     *</span>
<a href="#l21.56"></a><span id="l21.56" class="difflineminus">-     * This method will return the delegate for the given key after</span>
<a href="#l21.57"></a><span id="l21.57" class="difflineminus">-     * QueryInterface()-ing it to the requested IID.</span>
<a href="#l21.58"></a><span id="l21.58" class="difflineminus">-     *</span>
<a href="#l21.59"></a><span id="l21.59" class="difflineminus">-     * If no delegate exists for the specified key, this method will</span>
<a href="#l21.60"></a><span id="l21.60" class="difflineminus">-     * attempt to create one using the component manager. Specifically,</span>
<a href="#l21.61"></a><span id="l21.61" class="difflineminus">-     * it will combine aKey with the resource's URI scheme to produce</span>
<a href="#l21.62"></a><span id="l21.62" class="difflineminus">-     * a ContractID as follows:</span>
<a href="#l21.63"></a><span id="l21.63" class="difflineminus">-     *</span>
<a href="#l21.64"></a><span id="l21.64" class="difflineminus">-     *   component:/rdf/delegate-factory/[key]/[scheme]</span>
<a href="#l21.65"></a><span id="l21.65" class="difflineminus">-     *</span>
<a href="#l21.66"></a><span id="l21.66" class="difflineminus">-     * This ContractID will be used to locate a factory using the</span>
<a href="#l21.67"></a><span id="l21.67" class="difflineminus">-     * FindFactory() method of nsIComponentManager. If the nsIFactory</span>
<a href="#l21.68"></a><span id="l21.68" class="difflineminus">-     * exists, it will be used to create a &quot;delegate factory&quot;; that</span>
<a href="#l21.69"></a><span id="l21.69" class="difflineminus">-     * is, an object that supports nsIRDFDelegateFactory. The delegate</span>
<a href="#l21.70"></a><span id="l21.70" class="difflineminus">-     * factory will be used to construct the delegate object.</span>
<a href="#l21.71"></a><span id="l21.71" class="difflineminus">-     */</span>
<a href="#l21.72"></a><span id="l21.72" class="difflineminus">-    void GetDelegate(in string aKey, in nsIIDRef aIID,</span>
<a href="#l21.73"></a><span id="l21.73" class="difflineminus">-                     [iid_is(aIID),retval] out nsQIResult aResult);</span>
<a href="#l21.74"></a><span id="l21.74" class="difflineminus">-</span>
<a href="#l21.75"></a><span id="l21.75" class="difflineminus">-    /**</span>
<a href="#l21.76"></a><span id="l21.76" class="difflineminus">-     * Force a delegate to be &quot;unbound&quot; from the resource.</span>
<a href="#l21.77"></a><span id="l21.77" class="difflineminus">-     *</span>
<a href="#l21.78"></a><span id="l21.78" class="difflineminus">-     * Normally, a delegate object's lifetime will be identical to</span>
<a href="#l21.79"></a><span id="l21.79" class="difflineminus">-     * that of the resource to which it is bound; this method allows a</span>
<a href="#l21.80"></a><span id="l21.80" class="difflineminus">-     * delegate to unlink itself from an RDF resource prematurely.</span>
<a href="#l21.81"></a><span id="l21.81" class="difflineminus">-     */</span>
<a href="#l21.82"></a><span id="l21.82" class="difflineminus">-    void ReleaseDelegate(in string aKey);</span>
<a href="#l21.83"></a><span id="l21.83" class="difflineminus">-};</span>
<a href="#l21.84"></a><span id="l21.84" class="difflineminus">-</span>
<a href="#l21.85"></a><span id="l21.85" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1">deleted file mode 100644</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineminus">--- a/rdf/base/nsIRDFService.idl</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineplus">+++ /dev/null</span>
<a href="#l22.4"></a><span id="l22.4" class="difflineat">@@ -1,146 +0,0 @@</span>
<a href="#l22.5"></a><span id="l22.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l22.6"></a><span id="l22.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l22.7"></a><span id="l22.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l22.8"></a><span id="l22.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l22.9"></a><span id="l22.9" class="difflineminus">-</span>
<a href="#l22.10"></a><span id="l22.10" class="difflineminus">-#include &quot;nsISupports.idl&quot;</span>
<a href="#l22.11"></a><span id="l22.11" class="difflineminus">-#include &quot;nsIRDFResource.idl&quot;</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-#include &quot;nsIRDFLiteral.idl&quot;</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineminus">-#include &quot;nsIRDFDataSource.idl&quot;</span>
<a href="#l22.14"></a><span id="l22.14" class="difflineminus">-</span>
<a href="#l22.15"></a><span id="l22.15" class="difflineminus">-</span>
<a href="#l22.16"></a><span id="l22.16" class="difflineminus">-/**</span>
<a href="#l22.17"></a><span id="l22.17" class="difflineminus">- * The RDF service interface. This is a singleton object which should be</span>
<a href="#l22.18"></a><span id="l22.18" class="difflineminus">- * obtained from the &lt;code&gt;nsServiceManager&lt;/code&gt;.</span>
<a href="#l22.19"></a><span id="l22.19" class="difflineminus">- */</span>
<a href="#l22.20"></a><span id="l22.20" class="difflineminus">-[scriptable, uuid(BFD05261-834C-11d2-8EAC-00805F29F370)]</span>
<a href="#l22.21"></a><span id="l22.21" class="difflineminus">-interface nsIRDFService : nsISupports {</span>
<a href="#l22.22"></a><span id="l22.22" class="difflineminus">-    /**</span>
<a href="#l22.23"></a><span id="l22.23" class="difflineminus">-     * Construct an RDF resource from a single-byte URI. &lt;code&gt;nsIRDFService&lt;/code&gt;</span>
<a href="#l22.24"></a><span id="l22.24" class="difflineminus">-     * caches resources that are in-use, so multiple calls to &lt;code&gt;GetResource()&lt;/code&gt;</span>
<a href="#l22.25"></a><span id="l22.25" class="difflineminus">-     * for the same &lt;code&gt;uri&lt;/code&gt; will return identical pointers. FindResource</span>
<a href="#l22.26"></a><span id="l22.26" class="difflineminus">-     * is used to find out whether there already exists a resource corresponding to that url.</span>
<a href="#l22.27"></a><span id="l22.27" class="difflineminus">-     */</span>
<a href="#l22.28"></a><span id="l22.28" class="difflineminus">-    nsIRDFResource GetResource(in AUTF8String aURI);</span>
<a href="#l22.29"></a><span id="l22.29" class="difflineminus">-</span>
<a href="#l22.30"></a><span id="l22.30" class="difflineminus">-    /**</span>
<a href="#l22.31"></a><span id="l22.31" class="difflineminus">-     * Construct an RDF resource from a Unicode URI. This is provided</span>
<a href="#l22.32"></a><span id="l22.32" class="difflineminus">-     * as a convenience method, allowing automatic, in-line C++</span>
<a href="#l22.33"></a><span id="l22.33" class="difflineminus">-     * conversion from &lt;code&gt;nsString&lt;/code&gt; objects. The &lt;code&gt;uri&lt;/code&gt; will</span>
<a href="#l22.34"></a><span id="l22.34" class="difflineminus">-     * be converted to a single-byte representation internally.</span>
<a href="#l22.35"></a><span id="l22.35" class="difflineminus">-     */</span>
<a href="#l22.36"></a><span id="l22.36" class="difflineminus">-    nsIRDFResource GetUnicodeResource(in AString aURI);</span>
<a href="#l22.37"></a><span id="l22.37" class="difflineminus">-</span>
<a href="#l22.38"></a><span id="l22.38" class="difflineminus">-    nsIRDFResource GetAnonymousResource();</span>
<a href="#l22.39"></a><span id="l22.39" class="difflineminus">-</span>
<a href="#l22.40"></a><span id="l22.40" class="difflineminus">-    /**</span>
<a href="#l22.41"></a><span id="l22.41" class="difflineminus">-     * Construct an RDF literal from a Unicode string.</span>
<a href="#l22.42"></a><span id="l22.42" class="difflineminus">-     */</span>
<a href="#l22.43"></a><span id="l22.43" class="difflineminus">-    nsIRDFLiteral  GetLiteral(in wstring aValue);</span>
<a href="#l22.44"></a><span id="l22.44" class="difflineminus">-</span>
<a href="#l22.45"></a><span id="l22.45" class="difflineminus">-    /**</span>
<a href="#l22.46"></a><span id="l22.46" class="difflineminus">-     * Construct an RDF literal from a PRTime.</span>
<a href="#l22.47"></a><span id="l22.47" class="difflineminus">-     */</span>
<a href="#l22.48"></a><span id="l22.48" class="difflineminus">-    nsIRDFDate     GetDateLiteral(in PRTime aValue);</span>
<a href="#l22.49"></a><span id="l22.49" class="difflineminus">-</span>
<a href="#l22.50"></a><span id="l22.50" class="difflineminus">-    /**</span>
<a href="#l22.51"></a><span id="l22.51" class="difflineminus">-     * Construct an RDF literal from an int.</span>
<a href="#l22.52"></a><span id="l22.52" class="difflineminus">-     */</span>
<a href="#l22.53"></a><span id="l22.53" class="difflineminus">-    nsIRDFInt      GetIntLiteral(in long aValue);</span>
<a href="#l22.54"></a><span id="l22.54" class="difflineminus">-</span>
<a href="#l22.55"></a><span id="l22.55" class="difflineminus">-    /**</span>
<a href="#l22.56"></a><span id="l22.56" class="difflineminus">-     * Construct an RDF literal from a data blob</span>
<a href="#l22.57"></a><span id="l22.57" class="difflineminus">-     */</span>
<a href="#l22.58"></a><span id="l22.58" class="difflineminus">-    [noscript] nsIRDFBlob getBlobLiteral(in const_octet_ptr aValue, in long aLength);</span>
<a href="#l22.59"></a><span id="l22.59" class="difflineminus">-</span>
<a href="#l22.60"></a><span id="l22.60" class="difflineminus">-    boolean IsAnonymousResource(in nsIRDFResource aResource);</span>
<a href="#l22.61"></a><span id="l22.61" class="difflineminus">-</span>
<a href="#l22.62"></a><span id="l22.62" class="difflineminus">-    /**</span>
<a href="#l22.63"></a><span id="l22.63" class="difflineminus">-     * Registers a resource with the RDF system, making it unique w.r.t.</span>
<a href="#l22.64"></a><span id="l22.64" class="difflineminus">-     * GetResource.</span>
<a href="#l22.65"></a><span id="l22.65" class="difflineminus">-     *</span>
<a href="#l22.66"></a><span id="l22.66" class="difflineminus">-     * An implementation of nsIRDFResource should call this in its</span>
<a href="#l22.67"></a><span id="l22.67" class="difflineminus">-     * Init() method if it wishes the resource to be globally unique</span>
<a href="#l22.68"></a><span id="l22.68" class="difflineminus">-     * (which is usually the case).</span>
<a href="#l22.69"></a><span id="l22.69" class="difflineminus">-     *</span>
<a href="#l22.70"></a><span id="l22.70" class="difflineminus">-     * @note that the resource will &lt;i&gt;not&lt;/i&gt; be ref-counted by the</span>
<a href="#l22.71"></a><span id="l22.71" class="difflineminus">-     * RDF service: the assumption is that the resource implementation</span>
<a href="#l22.72"></a><span id="l22.72" class="difflineminus">-     * will call nsIRDFService::UnregisterResource() when the last</span>
<a href="#l22.73"></a><span id="l22.73" class="difflineminus">-     * reference to the resource is released.</span>
<a href="#l22.74"></a><span id="l22.74" class="difflineminus">-     *</span>
<a href="#l22.75"></a><span id="l22.75" class="difflineminus">-     * @note that the nsIRDFService implementation may choose to</span>
<a href="#l22.76"></a><span id="l22.76" class="difflineminus">-     * maintain a reference to the resource's URI; therefore, the</span>
<a href="#l22.77"></a><span id="l22.77" class="difflineminus">-     * resource implementation should ensure that the resource's URI</span>
<a href="#l22.78"></a><span id="l22.78" class="difflineminus">-     * (accessible via nsIRDFResource::GetValue(const char* *aURI)) is</span>
<a href="#l22.79"></a><span id="l22.79" class="difflineminus">-     * valid before calling RegisterResource(). Furthermore, the</span>
<a href="#l22.80"></a><span id="l22.80" class="difflineminus">-     * resource implementation should ensure that this pointer</span>
<a href="#l22.81"></a><span id="l22.81" class="difflineminus">-     * &lt;i&gt;remains&lt;/i&gt; valid for the lifetime of the resource. (The</span>
<a href="#l22.82"></a><span id="l22.82" class="difflineminus">-     * implementation of the resource cache in nsIRDFService uses the</span>
<a href="#l22.83"></a><span id="l22.83" class="difflineminus">-     * URI maintained &quot;internally&quot; in the resource as a key into the</span>
<a href="#l22.84"></a><span id="l22.84" class="difflineminus">-     * cache rather than copying the resource URI itself.)</span>
<a href="#l22.85"></a><span id="l22.85" class="difflineminus">-     */</span>
<a href="#l22.86"></a><span id="l22.86" class="difflineminus">-    void RegisterResource(in nsIRDFResource aResource, in boolean aReplace);</span>
<a href="#l22.87"></a><span id="l22.87" class="difflineminus">-</span>
<a href="#l22.88"></a><span id="l22.88" class="difflineminus">-    /**</span>
<a href="#l22.89"></a><span id="l22.89" class="difflineminus">-     * Called to notify the resource manager that a resource is no</span>
<a href="#l22.90"></a><span id="l22.90" class="difflineminus">-     * longer in use. This method should only be called from the</span>
<a href="#l22.91"></a><span id="l22.91" class="difflineminus">-     * destructor of a &quot;custom&quot; resource implementation to notify the</span>
<a href="#l22.92"></a><span id="l22.92" class="difflineminus">-     * RDF service that the last reference to the resource has been</span>
<a href="#l22.93"></a><span id="l22.93" class="difflineminus">-     * released, so the resource is no longer valid.</span>
<a href="#l22.94"></a><span id="l22.94" class="difflineminus">-     *</span>
<a href="#l22.95"></a><span id="l22.95" class="difflineminus">-     * @note As mentioned in nsIRDFResourceFactory::CreateResource(),</span>
<a href="#l22.96"></a><span id="l22.96" class="difflineminus">-     * the RDF service will use the result of</span>
<a href="#l22.97"></a><span id="l22.97" class="difflineminus">-     * nsIRDFResource::GetValue() as a key into its cache. For this</span>
<a href="#l22.98"></a><span id="l22.98" class="difflineminus">-     * reason, you must always un-cache the resource &lt;b&gt;before&lt;/b&gt;</span>
<a href="#l22.99"></a><span id="l22.99" class="difflineminus">-     * releasing the storage for the &lt;code&gt;const char*&lt;/code&gt; URI.</span>
<a href="#l22.100"></a><span id="l22.100" class="difflineminus">-     */</span>
<a href="#l22.101"></a><span id="l22.101" class="difflineminus">-    void UnregisterResource(in nsIRDFResource aResource);</span>
<a href="#l22.102"></a><span id="l22.102" class="difflineminus">-</span>
<a href="#l22.103"></a><span id="l22.103" class="difflineminus">-    /**</span>
<a href="#l22.104"></a><span id="l22.104" class="difflineminus">-     * Register a &lt;i&gt;named data source&lt;/i&gt;. The RDF service will call</span>
<a href="#l22.105"></a><span id="l22.105" class="difflineminus">-     * &lt;code&gt;nsIRDFDataSource::GetURI()&lt;/code&gt; to determine the URI under</span>
<a href="#l22.106"></a><span id="l22.106" class="difflineminus">-     * which to register the data source.</span>
<a href="#l22.107"></a><span id="l22.107" class="difflineminus">-     *</span>
<a href="#l22.108"></a><span id="l22.108" class="difflineminus">-     * @note that the data source will &lt;i&gt;not&lt;/i&gt; be refcounted by the</span>
<a href="#l22.109"></a><span id="l22.109" class="difflineminus">-     * RDF service! The assumption is that an RDF data source</span>
<a href="#l22.110"></a><span id="l22.110" class="difflineminus">-     * registers with the service once it is initialized (via</span>
<a href="#l22.111"></a><span id="l22.111" class="difflineminus">-     * &lt;code&gt;nsIRDFDataSource::Init()&lt;/code&gt;), and unregisters when the</span>
<a href="#l22.112"></a><span id="l22.112" class="difflineminus">-     * last reference to the data source is released.</span>
<a href="#l22.113"></a><span id="l22.113" class="difflineminus">-     */</span>
<a href="#l22.114"></a><span id="l22.114" class="difflineminus">-    void RegisterDataSource(in nsIRDFDataSource aDataSource,</span>
<a href="#l22.115"></a><span id="l22.115" class="difflineminus">-                            in boolean          aReplace);</span>
<a href="#l22.116"></a><span id="l22.116" class="difflineminus">-</span>
<a href="#l22.117"></a><span id="l22.117" class="difflineminus">-    /**</span>
<a href="#l22.118"></a><span id="l22.118" class="difflineminus">-     * Unregister a &lt;i&gt;named data source&lt;/i&gt;. The RDF service will call</span>
<a href="#l22.119"></a><span id="l22.119" class="difflineminus">-     * &lt;code&gt;nsIRDFDataSource::GetURI()&lt;/code&gt; to determine the URI under which the</span>
<a href="#l22.120"></a><span id="l22.120" class="difflineminus">-     * data source was registered.</span>
<a href="#l22.121"></a><span id="l22.121" class="difflineminus">-     */</span>
<a href="#l22.122"></a><span id="l22.122" class="difflineminus">-    void UnregisterDataSource(in nsIRDFDataSource aDataSource);</span>
<a href="#l22.123"></a><span id="l22.123" class="difflineminus">-</span>
<a href="#l22.124"></a><span id="l22.124" class="difflineminus">-    /**</span>
<a href="#l22.125"></a><span id="l22.125" class="difflineminus">-     * Get the &lt;i&gt;named data source&lt;/i&gt; corresponding to the URI. If a data</span>
<a href="#l22.126"></a><span id="l22.126" class="difflineminus">-     * source has been registered via &lt;code&gt;RegisterDataSource()&lt;/code&gt;, that</span>
<a href="#l22.127"></a><span id="l22.127" class="difflineminus">-     * data source will be returned.</span>
<a href="#l22.128"></a><span id="l22.128" class="difflineminus">-     *</span>
<a href="#l22.129"></a><span id="l22.129" class="difflineminus">-     * If no data source is currently</span>
<a href="#l22.130"></a><span id="l22.130" class="difflineminus">-     * registered for the specified URI, and a data source &lt;i&gt;constructor&lt;/i&gt;</span>
<a href="#l22.131"></a><span id="l22.131" class="difflineminus">-     * function has been registered via &lt;code&gt;RegisterDatasourceConstructor()&lt;/code&gt;,</span>
<a href="#l22.132"></a><span id="l22.132" class="difflineminus">-     * the RDF service will call the constructor to attempt to construct a</span>
<a href="#l22.133"></a><span id="l22.133" class="difflineminus">-     * new data source. If construction is successful, the data source will</span>
<a href="#l22.134"></a><span id="l22.134" class="difflineminus">-     * be initialized via &lt;code&gt;nsIRDFDataSource::Init()&lt;/code&gt;.</span>
<a href="#l22.135"></a><span id="l22.135" class="difflineminus">-     */</span>
<a href="#l22.136"></a><span id="l22.136" class="difflineminus">-    nsIRDFDataSource GetDataSource(in string aURI);</span>
<a href="#l22.137"></a><span id="l22.137" class="difflineminus">-</span>
<a href="#l22.138"></a><span id="l22.138" class="difflineminus">-    /**</span>
<a href="#l22.139"></a><span id="l22.139" class="difflineminus">-     * Same as GetDataSource, but if a remote/XML data source needs to be</span>
<a href="#l22.140"></a><span id="l22.140" class="difflineminus">-     * constructed, then this method will issue a &lt;b&gt;blocking&lt;/b&gt; Refresh</span>
<a href="#l22.141"></a><span id="l22.141" class="difflineminus">-     * call on that data source.</span>
<a href="#l22.142"></a><span id="l22.142" class="difflineminus">-     */</span>
<a href="#l22.143"></a><span id="l22.143" class="difflineminus">-    nsIRDFDataSource GetDataSourceBlocking(in string aURI);</span>
<a href="#l22.144"></a><span id="l22.144" class="difflineminus">-};</span>
<a href="#l22.145"></a><span id="l22.145" class="difflineminus">-</span>
<a href="#l22.146"></a><span id="l22.146" class="difflineminus">-%{C++</span>
<a href="#l22.147"></a><span id="l22.147" class="difflineminus">-extern nsresult</span>
<a href="#l22.148"></a><span id="l22.148" class="difflineminus">-NS_NewRDFService(nsIRDFService** result);</span>
<a href="#l22.149"></a><span id="l22.149" class="difflineminus">-%}</span>
<a href="#l22.150"></a><span id="l22.150" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1">deleted file mode 100644</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineminus">--- a/rdf/base/nsIRDFXMLParser.idl</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineplus">+++ /dev/null</span>
<a href="#l23.4"></a><span id="l23.4" class="difflineat">@@ -1,33 +0,0 @@</span>
<a href="#l23.5"></a><span id="l23.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*-</span>
<a href="#l23.6"></a><span id="l23.6" class="difflineminus">- *</span>
<a href="#l23.7"></a><span id="l23.7" class="difflineminus">- * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l23.8"></a><span id="l23.8" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l23.9"></a><span id="l23.9" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l23.10"></a><span id="l23.10" class="difflineminus">-</span>
<a href="#l23.11"></a><span id="l23.11" class="difflineminus">-#include &quot;nsISupports.idl&quot;</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-#include &quot;nsIRDFDataSource.idl&quot;</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineminus">-#include &quot;nsIStreamListener.idl&quot;</span>
<a href="#l23.14"></a><span id="l23.14" class="difflineminus">-#include &quot;nsIURI.idl&quot;</span>
<a href="#l23.15"></a><span id="l23.15" class="difflineminus">-</span>
<a href="#l23.16"></a><span id="l23.16" class="difflineminus">-[scriptable, uuid(1831dd2e-1dd2-11b2-bdb3-86b7b50b70b5)]</span>
<a href="#l23.17"></a><span id="l23.17" class="difflineminus">-interface nsIRDFXMLParser : nsISupports</span>
<a href="#l23.18"></a><span id="l23.18" class="difflineminus">-{</span>
<a href="#l23.19"></a><span id="l23.19" class="difflineminus">-    /**</span>
<a href="#l23.20"></a><span id="l23.20" class="difflineminus">-     * Create a stream listener that can be used to asynchronously</span>
<a href="#l23.21"></a><span id="l23.21" class="difflineminus">-     * parse RDF/XML.</span>
<a href="#l23.22"></a><span id="l23.22" class="difflineminus">-     * @param aSink the RDF datasource the will receive the data</span>
<a href="#l23.23"></a><span id="l23.23" class="difflineminus">-     * @param aBaseURI the base URI used to resolve relative</span>
<a href="#l23.24"></a><span id="l23.24" class="difflineminus">-     *   references in the RDF/XML</span>
<a href="#l23.25"></a><span id="l23.25" class="difflineminus">-     * @return an nsIStreamListener object to handle the data</span>
<a href="#l23.26"></a><span id="l23.26" class="difflineminus">-     */</span>
<a href="#l23.27"></a><span id="l23.27" class="difflineminus">-    nsIStreamListener parseAsync(in nsIRDFDataSource aSink, in nsIURI aBaseURI);</span>
<a href="#l23.28"></a><span id="l23.28" class="difflineminus">-</span>
<a href="#l23.29"></a><span id="l23.29" class="difflineminus">-    /**</span>
<a href="#l23.30"></a><span id="l23.30" class="difflineminus">-     * Parse a string of RDF/XML</span>
<a href="#l23.31"></a><span id="l23.31" class="difflineminus">-     * @param aSink the RDF datasource that will receive the data</span>
<a href="#l23.32"></a><span id="l23.32" class="difflineminus">-     * @param aBaseURI the base URI used to resolve relative</span>
<a href="#l23.33"></a><span id="l23.33" class="difflineminus">-     *   references in the RDF/XML</span>
<a href="#l23.34"></a><span id="l23.34" class="difflineminus">-     * @param aSource a UTF8 string containing RDF/XML data.</span>
<a href="#l23.35"></a><span id="l23.35" class="difflineminus">-     */</span>
<a href="#l23.36"></a><span id="l23.36" class="difflineminus">-    void parseString(in nsIRDFDataSource aSink, in nsIURI aBaseURI, in AUTF8String aSource);</span>
<a href="#l23.37"></a><span id="l23.37" class="difflineminus">-};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1">deleted file mode 100644</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineminus">--- a/rdf/base/nsIRDFXMLSerializer.idl</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineplus">+++ /dev/null</span>
<a href="#l24.4"></a><span id="l24.4" class="difflineat">@@ -1,31 +0,0 @@</span>
<a href="#l24.5"></a><span id="l24.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*-</span>
<a href="#l24.6"></a><span id="l24.6" class="difflineminus">- *</span>
<a href="#l24.7"></a><span id="l24.7" class="difflineminus">- * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l24.8"></a><span id="l24.8" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l24.9"></a><span id="l24.9" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l24.10"></a><span id="l24.10" class="difflineminus">-</span>
<a href="#l24.11"></a><span id="l24.11" class="difflineminus">-#include &quot;nsISupports.idl&quot;</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-#include &quot;nsIRDFDataSource.idl&quot;</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineminus">-</span>
<a href="#l24.14"></a><span id="l24.14" class="difflineminus">-%{C++</span>
<a href="#l24.15"></a><span id="l24.15" class="difflineminus">-class nsAtom;</span>
<a href="#l24.16"></a><span id="l24.16" class="difflineminus">-%}</span>
<a href="#l24.17"></a><span id="l24.17" class="difflineminus">-[ptr] native nsAtomPtr(nsAtom);</span>
<a href="#l24.18"></a><span id="l24.18" class="difflineminus">-</span>
<a href="#l24.19"></a><span id="l24.19" class="difflineminus">-[scriptable, uuid(8ae1fbf8-1dd2-11b2-bd21-d728069cca92)]</span>
<a href="#l24.20"></a><span id="l24.20" class="difflineminus">-interface nsIRDFXMLSerializer : nsISupports</span>
<a href="#l24.21"></a><span id="l24.21" class="difflineminus">-{</span>
<a href="#l24.22"></a><span id="l24.22" class="difflineminus">-    /**</span>
<a href="#l24.23"></a><span id="l24.23" class="difflineminus">-     * Initialize the serializer with the specified datasource.</span>
<a href="#l24.24"></a><span id="l24.24" class="difflineminus">-     * @param aDataSource the datasource from which data will be</span>
<a href="#l24.25"></a><span id="l24.25" class="difflineminus">-     *   serialized</span>
<a href="#l24.26"></a><span id="l24.26" class="difflineminus">-     */</span>
<a href="#l24.27"></a><span id="l24.27" class="difflineminus">-    void init(in nsIRDFDataSource aDataSource);</span>
<a href="#l24.28"></a><span id="l24.28" class="difflineminus">-</span>
<a href="#l24.29"></a><span id="l24.29" class="difflineminus">-    /**</span>
<a href="#l24.30"></a><span id="l24.30" class="difflineminus">-     * Add the specified namespace to the serializer.</span>
<a href="#l24.31"></a><span id="l24.31" class="difflineminus">-     * @param aPrefix the attribute namespace prefix</span>
<a href="#l24.32"></a><span id="l24.32" class="difflineminus">-     * @param aURI the namespace URI</span>
<a href="#l24.33"></a><span id="l24.33" class="difflineminus">-     */</span>
<a href="#l24.34"></a><span id="l24.34" class="difflineminus">-    [noscript] void addNameSpace(in nsAtomPtr aPrefix, in AString aURI);</span>
<a href="#l24.35"></a><span id="l24.35" class="difflineminus">-};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1">deleted file mode 100644</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineminus">--- a/rdf/base/nsIRDFXMLSink.idl</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineplus">+++ /dev/null</span>
<a href="#l25.4"></a><span id="l25.4" class="difflineat">@@ -1,133 +0,0 @@</span>
<a href="#l25.5"></a><span id="l25.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l25.6"></a><span id="l25.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l25.7"></a><span id="l25.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l25.8"></a><span id="l25.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l25.9"></a><span id="l25.9" class="difflineminus">-</span>
<a href="#l25.10"></a><span id="l25.10" class="difflineminus">-/*</span>
<a href="#l25.11"></a><span id="l25.11" class="difflineminus">-</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-  Interfaces for the RDF/XML sink, which parses RDF/XML into</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineminus">-  a graph representation.</span>
<a href="#l25.14"></a><span id="l25.14" class="difflineminus">-</span>
<a href="#l25.15"></a><span id="l25.15" class="difflineminus">-*/</span>
<a href="#l25.16"></a><span id="l25.16" class="difflineminus">-</span>
<a href="#l25.17"></a><span id="l25.17" class="difflineminus">-#include &quot;nsISupports.idl&quot;</span>
<a href="#l25.18"></a><span id="l25.18" class="difflineminus">-</span>
<a href="#l25.19"></a><span id="l25.19" class="difflineminus">-%{C++</span>
<a href="#l25.20"></a><span id="l25.20" class="difflineminus">-class nsAtom;</span>
<a href="#l25.21"></a><span id="l25.21" class="difflineminus">-%}</span>
<a href="#l25.22"></a><span id="l25.22" class="difflineminus">-[ptr] native nsAtomPtr(nsAtom);</span>
<a href="#l25.23"></a><span id="l25.23" class="difflineminus">-</span>
<a href="#l25.24"></a><span id="l25.24" class="difflineminus">-// XXX Until these get scriptable. See nsIRDFXMLSink::AddNameSpace()</span>
<a href="#l25.25"></a><span id="l25.25" class="difflineminus">-[ref] native nsStringRef(nsString);</span>
<a href="#l25.26"></a><span id="l25.26" class="difflineminus">-%{C++</span>
<a href="#l25.27"></a><span id="l25.27" class="difflineminus">-#include &quot;nsStringFwd.h&quot;</span>
<a href="#l25.28"></a><span id="l25.28" class="difflineminus">-%}</span>
<a href="#l25.29"></a><span id="l25.29" class="difflineminus">-</span>
<a href="#l25.30"></a><span id="l25.30" class="difflineminus">-interface nsIRDFXMLSink;</span>
<a href="#l25.31"></a><span id="l25.31" class="difflineminus">-</span>
<a href="#l25.32"></a><span id="l25.32" class="difflineminus">-/**</span>
<a href="#l25.33"></a><span id="l25.33" class="difflineminus">- * An observer that is notified as progress is made on the load</span>
<a href="#l25.34"></a><span id="l25.34" class="difflineminus">- * of an RDF/XML document in an &lt;code&gt;nsIRDFXMLSink&lt;/code&gt;.</span>
<a href="#l25.35"></a><span id="l25.35" class="difflineminus">- */</span>
<a href="#l25.36"></a><span id="l25.36" class="difflineminus">-[scriptable, uuid(EB1A5D30-AB33-11D2-8EC6-00805F29F370)]</span>
<a href="#l25.37"></a><span id="l25.37" class="difflineminus">-interface nsIRDFXMLSinkObserver : nsISupports</span>
<a href="#l25.38"></a><span id="l25.38" class="difflineminus">-{</span>
<a href="#l25.39"></a><span id="l25.39" class="difflineminus">-    /**</span>
<a href="#l25.40"></a><span id="l25.40" class="difflineminus">-     * Called when the load begins.</span>
<a href="#l25.41"></a><span id="l25.41" class="difflineminus">-     * @param aSink the RDF/XML sink on which the load is beginning.</span>
<a href="#l25.42"></a><span id="l25.42" class="difflineminus">-     */</span>
<a href="#l25.43"></a><span id="l25.43" class="difflineminus">-    void onBeginLoad(in nsIRDFXMLSink aSink);</span>
<a href="#l25.44"></a><span id="l25.44" class="difflineminus">-</span>
<a href="#l25.45"></a><span id="l25.45" class="difflineminus">-    /**</span>
<a href="#l25.46"></a><span id="l25.46" class="difflineminus">-     * Called when the load is suspended (e.g., for network quantization).</span>
<a href="#l25.47"></a><span id="l25.47" class="difflineminus">-     * @param aSink the RDF/XML sink that is being interrupted.</span>
<a href="#l25.48"></a><span id="l25.48" class="difflineminus">-     */</span>
<a href="#l25.49"></a><span id="l25.49" class="difflineminus">-    void onInterrupt(in nsIRDFXMLSink aSink);</span>
<a href="#l25.50"></a><span id="l25.50" class="difflineminus">-</span>
<a href="#l25.51"></a><span id="l25.51" class="difflineminus">-    /**</span>
<a href="#l25.52"></a><span id="l25.52" class="difflineminus">-     * Called when a suspended load is resuming.</span>
<a href="#l25.53"></a><span id="l25.53" class="difflineminus">-     * @param aSink the RDF/XML sink that is resuming.</span>
<a href="#l25.54"></a><span id="l25.54" class="difflineminus">-     */</span>
<a href="#l25.55"></a><span id="l25.55" class="difflineminus">-    void onResume(in nsIRDFXMLSink aSink);</span>
<a href="#l25.56"></a><span id="l25.56" class="difflineminus">-</span>
<a href="#l25.57"></a><span id="l25.57" class="difflineminus">-    /**</span>
<a href="#l25.58"></a><span id="l25.58" class="difflineminus">-     * Called when an RDF/XML load completes successfully.</span>
<a href="#l25.59"></a><span id="l25.59" class="difflineminus">-     * @param aSink the RDF/XML sink that has finished loading.</span>
<a href="#l25.60"></a><span id="l25.60" class="difflineminus">-     */</span>
<a href="#l25.61"></a><span id="l25.61" class="difflineminus">-    void onEndLoad(in nsIRDFXMLSink aSink);</span>
<a href="#l25.62"></a><span id="l25.62" class="difflineminus">-</span>
<a href="#l25.63"></a><span id="l25.63" class="difflineminus">-    /**</span>
<a href="#l25.64"></a><span id="l25.64" class="difflineminus">-     * Called when an error occurs during the load</span>
<a href="#l25.65"></a><span id="l25.65" class="difflineminus">-     * @param aSink the RDF/XML sink in which the error occurred</span>
<a href="#l25.66"></a><span id="l25.66" class="difflineminus">-     * @param aStatus the networking result code</span>
<a href="#l25.67"></a><span id="l25.67" class="difflineminus">-     * @param aErrorMsg an error message, if applicable</span>
<a href="#l25.68"></a><span id="l25.68" class="difflineminus">-     */</span>
<a href="#l25.69"></a><span id="l25.69" class="difflineminus">-    void onError(in nsIRDFXMLSink aSink, in nsresult aStatus, in wstring aErrorMsg);</span>
<a href="#l25.70"></a><span id="l25.70" class="difflineminus">-};</span>
<a href="#l25.71"></a><span id="l25.71" class="difflineminus">-</span>
<a href="#l25.72"></a><span id="l25.72" class="difflineminus">-</span>
<a href="#l25.73"></a><span id="l25.73" class="difflineminus">-</span>
<a href="#l25.74"></a><span id="l25.74" class="difflineminus">-/**</span>
<a href="#l25.75"></a><span id="l25.75" class="difflineminus">- * A &quot;sink&quot; that receives and processes RDF/XML. This interface is used</span>
<a href="#l25.76"></a><span id="l25.76" class="difflineminus">- * by the RDF/XML parser.</span>
<a href="#l25.77"></a><span id="l25.77" class="difflineminus">- */</span>
<a href="#l25.78"></a><span id="l25.78" class="difflineminus">-[scriptable, uuid(EB1A5D31-AB33-11D2-8EC6-00805F29F370)]</span>
<a href="#l25.79"></a><span id="l25.79" class="difflineminus">-interface nsIRDFXMLSink : nsISupports</span>
<a href="#l25.80"></a><span id="l25.80" class="difflineminus">-{</span>
<a href="#l25.81"></a><span id="l25.81" class="difflineminus">-    /**</span>
<a href="#l25.82"></a><span id="l25.82" class="difflineminus">-     * Set to &lt;code&gt;true&lt;/code&gt; if the sink is read-only and cannot</span>
<a href="#l25.83"></a><span id="l25.83" class="difflineminus">-     * be modified</span>
<a href="#l25.84"></a><span id="l25.84" class="difflineminus">-     */</span>
<a href="#l25.85"></a><span id="l25.85" class="difflineminus">-    attribute boolean readOnly;</span>
<a href="#l25.86"></a><span id="l25.86" class="difflineminus">-</span>
<a href="#l25.87"></a><span id="l25.87" class="difflineminus">-    /**</span>
<a href="#l25.88"></a><span id="l25.88" class="difflineminus">-     * Initiate the RDF/XML load.</span>
<a href="#l25.89"></a><span id="l25.89" class="difflineminus">-     */</span>
<a href="#l25.90"></a><span id="l25.90" class="difflineminus">-    void beginLoad();</span>
<a href="#l25.91"></a><span id="l25.91" class="difflineminus">-</span>
<a href="#l25.92"></a><span id="l25.92" class="difflineminus">-    /**</span>
<a href="#l25.93"></a><span id="l25.93" class="difflineminus">-     * Suspend the RDF/XML load.</span>
<a href="#l25.94"></a><span id="l25.94" class="difflineminus">-     */</span>
<a href="#l25.95"></a><span id="l25.95" class="difflineminus">-    void interrupt();</span>
<a href="#l25.96"></a><span id="l25.96" class="difflineminus">-</span>
<a href="#l25.97"></a><span id="l25.97" class="difflineminus">-    /**</span>
<a href="#l25.98"></a><span id="l25.98" class="difflineminus">-     * Resume the RDF/XML load.</span>
<a href="#l25.99"></a><span id="l25.99" class="difflineminus">-     */</span>
<a href="#l25.100"></a><span id="l25.100" class="difflineminus">-    void resume();</span>
<a href="#l25.101"></a><span id="l25.101" class="difflineminus">-</span>
<a href="#l25.102"></a><span id="l25.102" class="difflineminus">-    /**</span>
<a href="#l25.103"></a><span id="l25.103" class="difflineminus">-     * Complete the RDF/XML load.</span>
<a href="#l25.104"></a><span id="l25.104" class="difflineminus">-     */</span>
<a href="#l25.105"></a><span id="l25.105" class="difflineminus">-    void endLoad();</span>
<a href="#l25.106"></a><span id="l25.106" class="difflineminus">-</span>
<a href="#l25.107"></a><span id="l25.107" class="difflineminus">-    /**</span>
<a href="#l25.108"></a><span id="l25.108" class="difflineminus">-     * Add namespace information to the RDF/XML sink.</span>
<a href="#l25.109"></a><span id="l25.109" class="difflineminus">-     * @param aPrefix the namespace prefix</span>
<a href="#l25.110"></a><span id="l25.110" class="difflineminus">-     * @param aURI the namespace URI</span>
<a href="#l25.111"></a><span id="l25.111" class="difflineminus">-     */</span>
<a href="#l25.112"></a><span id="l25.112" class="difflineminus">-    [noscript] void addNameSpace(in nsAtomPtr aPrefix,</span>
<a href="#l25.113"></a><span id="l25.113" class="difflineminus">-                                 [const] in nsStringRef aURI);</span>
<a href="#l25.114"></a><span id="l25.114" class="difflineminus">-</span>
<a href="#l25.115"></a><span id="l25.115" class="difflineminus">-    /**</span>
<a href="#l25.116"></a><span id="l25.116" class="difflineminus">-     * Add an observer that will be notified as the RDF/XML load</span>
<a href="#l25.117"></a><span id="l25.117" class="difflineminus">-     * progresses.</span>
<a href="#l25.118"></a><span id="l25.118" class="difflineminus">-     * &lt;p&gt;</span>
<a href="#l25.119"></a><span id="l25.119" class="difflineminus">-     *</span>
<a href="#l25.120"></a><span id="l25.120" class="difflineminus">-     * Note that the sink will acquire a strong reference to the</span>
<a href="#l25.121"></a><span id="l25.121" class="difflineminus">-     * observer, so care should be taken to avoid cyclical references</span>
<a href="#l25.122"></a><span id="l25.122" class="difflineminus">-     * that cannot be released (i.e., if the observer holds a</span>
<a href="#l25.123"></a><span id="l25.123" class="difflineminus">-     * reference to the sink, it should be sure that it eventually</span>
<a href="#l25.124"></a><span id="l25.124" class="difflineminus">-     * clears the reference).</span>
<a href="#l25.125"></a><span id="l25.125" class="difflineminus">-     *</span>
<a href="#l25.126"></a><span id="l25.126" class="difflineminus">-     * @param aObserver the observer to add to the sink's set of</span>
<a href="#l25.127"></a><span id="l25.127" class="difflineminus">-     * load observers.</span>
<a href="#l25.128"></a><span id="l25.128" class="difflineminus">-     */</span>
<a href="#l25.129"></a><span id="l25.129" class="difflineminus">-    void addXMLSinkObserver(in nsIRDFXMLSinkObserver aObserver);</span>
<a href="#l25.130"></a><span id="l25.130" class="difflineminus">-</span>
<a href="#l25.131"></a><span id="l25.131" class="difflineminus">-    /**</span>
<a href="#l25.132"></a><span id="l25.132" class="difflineminus">-     * Remove an observer from the sink's set of observers.</span>
<a href="#l25.133"></a><span id="l25.133" class="difflineminus">-     * @param aObserver the observer to remove.</span>
<a href="#l25.134"></a><span id="l25.134" class="difflineminus">-     */</span>
<a href="#l25.135"></a><span id="l25.135" class="difflineminus">-    void removeXMLSinkObserver(in nsIRDFXMLSinkObserver aObserver);</span>
<a href="#l25.136"></a><span id="l25.136" class="difflineminus">-};</span>
<a href="#l25.137"></a><span id="l25.137" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1">deleted file mode 100644</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineminus">--- a/rdf/base/nsIRDFXMLSource.idl</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineplus">+++ /dev/null</span>
<a href="#l26.4"></a><span id="l26.4" class="difflineat">@@ -1,20 +0,0 @@</span>
<a href="#l26.5"></a><span id="l26.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l26.6"></a><span id="l26.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l26.7"></a><span id="l26.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l26.8"></a><span id="l26.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l26.9"></a><span id="l26.9" class="difflineminus">-</span>
<a href="#l26.10"></a><span id="l26.10" class="difflineminus">-#include &quot;nsISupports.idl&quot;</span>
<a href="#l26.11"></a><span id="l26.11" class="difflineminus">-#include &quot;nsIOutputStream.idl&quot;</span>
<a href="#l26.12"></a><span id="l26.12" class="difflineminus">-</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineminus">-[scriptable, uuid(4DA56F10-99FE-11d2-8EBB-00805F29F370)]</span>
<a href="#l26.14"></a><span id="l26.14" class="difflineminus">-interface nsIRDFXMLSource : nsISupports</span>
<a href="#l26.15"></a><span id="l26.15" class="difflineminus">-{</span>
<a href="#l26.16"></a><span id="l26.16" class="difflineminus">-    /**</span>
<a href="#l26.17"></a><span id="l26.17" class="difflineminus">-     * Serialize the contents of the datasource to aStream.</span>
<a href="#l26.18"></a><span id="l26.18" class="difflineminus">-     * @param aStream the output stream the will receive the</span>
<a href="#l26.19"></a><span id="l26.19" class="difflineminus">-     *   RDF/XML. Currently, the output stream need only</span>
<a href="#l26.20"></a><span id="l26.20" class="difflineminus">-     *   implement the |write()| method.</span>
<a href="#l26.21"></a><span id="l26.21" class="difflineminus">-     */</span>
<a href="#l26.22"></a><span id="l26.22" class="difflineminus">-    void Serialize(in nsIOutputStream aStream);</span>
<a href="#l26.23"></a><span id="l26.23" class="difflineminus">-};</span>
<a href="#l26.24"></a><span id="l26.24" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1">deleted file mode 100644</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineminus">--- a/rdf/base/nsInMemoryDataSource.cpp</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineplus">+++ /dev/null</span>
<a href="#l27.4"></a><span id="l27.4" class="difflineat">@@ -1,1924 +0,0 @@</span>
<a href="#l27.5"></a><span id="l27.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*-</span>
<a href="#l27.6"></a><span id="l27.6" class="difflineminus">- *</span>
<a href="#l27.7"></a><span id="l27.7" class="difflineminus">- * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l27.8"></a><span id="l27.8" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l27.9"></a><span id="l27.9" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l27.10"></a><span id="l27.10" class="difflineminus">-</span>
<a href="#l27.11"></a><span id="l27.11" class="difflineminus">-/*</span>
<a href="#l27.12"></a><span id="l27.12" class="difflineminus">-</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineminus">-  Implementation for an in-memory RDF data store.</span>
<a href="#l27.14"></a><span id="l27.14" class="difflineminus">-</span>
<a href="#l27.15"></a><span id="l27.15" class="difflineminus">-  TO DO</span>
<a href="#l27.16"></a><span id="l27.16" class="difflineminus">-</span>
<a href="#l27.17"></a><span id="l27.17" class="difflineminus">-  1) Instrument this code to gather space and time performance</span>
<a href="#l27.18"></a><span id="l27.18" class="difflineminus">-     characteristics.</span>
<a href="#l27.19"></a><span id="l27.19" class="difflineminus">-</span>
<a href="#l27.20"></a><span id="l27.20" class="difflineminus">-  2) Optimize lookups for datasources which have a small number</span>
<a href="#l27.21"></a><span id="l27.21" class="difflineminus">-     of properties + fanning out to a large number of targets.</span>
<a href="#l27.22"></a><span id="l27.22" class="difflineminus">-</span>
<a href="#l27.23"></a><span id="l27.23" class="difflineminus">-  3) Complete implementation of thread-safety; specifically, make</span>
<a href="#l27.24"></a><span id="l27.24" class="difflineminus">-     assertions be reference counted objects (so that a cursor can</span>
<a href="#l27.25"></a><span id="l27.25" class="difflineminus">-     still refer to an assertion that gets removed from the graph).</span>
<a href="#l27.26"></a><span id="l27.26" class="difflineminus">-</span>
<a href="#l27.27"></a><span id="l27.27" class="difflineminus">- */</span>
<a href="#l27.28"></a><span id="l27.28" class="difflineminus">-</span>
<a href="#l27.29"></a><span id="l27.29" class="difflineminus">-#include &quot;nsAgg.h&quot;</span>
<a href="#l27.30"></a><span id="l27.30" class="difflineminus">-#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l27.31"></a><span id="l27.31" class="difflineminus">-#include &quot;nscore.h&quot;</span>
<a href="#l27.32"></a><span id="l27.32" class="difflineminus">-#include &quot;nsArrayEnumerator.h&quot;</span>
<a href="#l27.33"></a><span id="l27.33" class="difflineminus">-#include &quot;nsIOutputStream.h&quot;</span>
<a href="#l27.34"></a><span id="l27.34" class="difflineminus">-#include &quot;nsIRDFDataSource.h&quot;</span>
<a href="#l27.35"></a><span id="l27.35" class="difflineminus">-#include &quot;nsIRDFLiteral.h&quot;</span>
<a href="#l27.36"></a><span id="l27.36" class="difflineminus">-#include &quot;nsIRDFNode.h&quot;</span>
<a href="#l27.37"></a><span id="l27.37" class="difflineminus">-#include &quot;nsIRDFObserver.h&quot;</span>
<a href="#l27.38"></a><span id="l27.38" class="difflineminus">-#include &quot;nsIRDFInMemoryDataSource.h&quot;</span>
<a href="#l27.39"></a><span id="l27.39" class="difflineminus">-#include &quot;nsIRDFPropagatableDataSource.h&quot;</span>
<a href="#l27.40"></a><span id="l27.40" class="difflineminus">-#include &quot;nsIRDFPurgeableDataSource.h&quot;</span>
<a href="#l27.41"></a><span id="l27.41" class="difflineminus">-#include &quot;nsIRDFService.h&quot;</span>
<a href="#l27.42"></a><span id="l27.42" class="difflineminus">-#include &quot;nsIServiceManager.h&quot;</span>
<a href="#l27.43"></a><span id="l27.43" class="difflineminus">-#include &quot;nsCOMArray.h&quot;</span>
<a href="#l27.44"></a><span id="l27.44" class="difflineminus">-#include &quot;nsEnumeratorUtils.h&quot;</span>
<a href="#l27.45"></a><span id="l27.45" class="difflineminus">-#include &quot;nsSimpleEnumerator.h&quot;</span>
<a href="#l27.46"></a><span id="l27.46" class="difflineminus">-#include &quot;nsTArray.h&quot;</span>
<a href="#l27.47"></a><span id="l27.47" class="difflineminus">-#include &quot;nsCRT.h&quot;</span>
<a href="#l27.48"></a><span id="l27.48" class="difflineminus">-#include &quot;nsRDFCID.h&quot;</span>
<a href="#l27.49"></a><span id="l27.49" class="difflineminus">-#include &quot;nsRDFBaseDataSources.h&quot;</span>
<a href="#l27.50"></a><span id="l27.50" class="difflineminus">-#include &quot;nsString.h&quot;</span>
<a href="#l27.51"></a><span id="l27.51" class="difflineminus">-#include &quot;nsReadableUtils.h&quot;</span>
<a href="#l27.52"></a><span id="l27.52" class="difflineminus">-#include &quot;nsString.h&quot;</span>
<a href="#l27.53"></a><span id="l27.53" class="difflineminus">-#include &quot;rdfutil.h&quot;</span>
<a href="#l27.54"></a><span id="l27.54" class="difflineminus">-#include &quot;PLDHashTable.h&quot;</span>
<a href="#l27.55"></a><span id="l27.55" class="difflineminus">-#include &quot;plstr.h&quot;</span>
<a href="#l27.56"></a><span id="l27.56" class="difflineminus">-#include &quot;mozilla/Logging.h&quot;</span>
<a href="#l27.57"></a><span id="l27.57" class="difflineminus">-#include &quot;rdf.h&quot;</span>
<a href="#l27.58"></a><span id="l27.58" class="difflineminus">-</span>
<a href="#l27.59"></a><span id="l27.59" class="difflineminus">-#include &quot;rdfIDataSource.h&quot;</span>
<a href="#l27.60"></a><span id="l27.60" class="difflineminus">-#include &quot;rdfITripleVisitor.h&quot;</span>
<a href="#l27.61"></a><span id="l27.61" class="difflineminus">-</span>
<a href="#l27.62"></a><span id="l27.62" class="difflineminus">-using mozilla::LogLevel;</span>
<a href="#l27.63"></a><span id="l27.63" class="difflineminus">-</span>
<a href="#l27.64"></a><span id="l27.64" class="difflineminus">-// This struct is used as the slot value in the forward and reverse</span>
<a href="#l27.65"></a><span id="l27.65" class="difflineminus">-// arcs hash tables.</span>
<a href="#l27.66"></a><span id="l27.66" class="difflineminus">-//</span>
<a href="#l27.67"></a><span id="l27.67" class="difflineminus">-// Assertion objects are reference counted, because each Assertion's</span>
<a href="#l27.68"></a><span id="l27.68" class="difflineminus">-// ownership is shared between the datasource and any enumerators that</span>
<a href="#l27.69"></a><span id="l27.69" class="difflineminus">-// are currently iterating over the datasource.</span>
<a href="#l27.70"></a><span id="l27.70" class="difflineminus">-//</span>
<a href="#l27.71"></a><span id="l27.71" class="difflineminus">-class Assertion</span>
<a href="#l27.72"></a><span id="l27.72" class="difflineminus">-{</span>
<a href="#l27.73"></a><span id="l27.73" class="difflineminus">-public:</span>
<a href="#l27.74"></a><span id="l27.74" class="difflineminus">-    Assertion(nsIRDFResource* aSource,      // normal assertion</span>
<a href="#l27.75"></a><span id="l27.75" class="difflineminus">-              nsIRDFResource* aProperty,</span>
<a href="#l27.76"></a><span id="l27.76" class="difflineminus">-              nsIRDFNode* aTarget,</span>
<a href="#l27.77"></a><span id="l27.77" class="difflineminus">-              bool aTruthValue);</span>
<a href="#l27.78"></a><span id="l27.78" class="difflineminus">-    explicit Assertion(nsIRDFResource* aSource);     // PLDHashTable assertion variant</span>
<a href="#l27.79"></a><span id="l27.79" class="difflineminus">-</span>
<a href="#l27.80"></a><span id="l27.80" class="difflineminus">-private:</span>
<a href="#l27.81"></a><span id="l27.81" class="difflineminus">-    ~Assertion();</span>
<a href="#l27.82"></a><span id="l27.82" class="difflineminus">-</span>
<a href="#l27.83"></a><span id="l27.83" class="difflineminus">-public:</span>
<a href="#l27.84"></a><span id="l27.84" class="difflineminus">-    void AddRef() {</span>
<a href="#l27.85"></a><span id="l27.85" class="difflineminus">-        if (mRefCnt == UINT16_MAX) {</span>
<a href="#l27.86"></a><span id="l27.86" class="difflineminus">-            NS_WARNING(&quot;refcount overflow, leaking Assertion&quot;);</span>
<a href="#l27.87"></a><span id="l27.87" class="difflineminus">-            return;</span>
<a href="#l27.88"></a><span id="l27.88" class="difflineminus">-        }</span>
<a href="#l27.89"></a><span id="l27.89" class="difflineminus">-        ++mRefCnt;</span>
<a href="#l27.90"></a><span id="l27.90" class="difflineminus">-    }</span>
<a href="#l27.91"></a><span id="l27.91" class="difflineminus">-</span>
<a href="#l27.92"></a><span id="l27.92" class="difflineminus">-    void Release() {</span>
<a href="#l27.93"></a><span id="l27.93" class="difflineminus">-        if (mRefCnt == UINT16_MAX) {</span>
<a href="#l27.94"></a><span id="l27.94" class="difflineminus">-            NS_WARNING(&quot;refcount overflow, leaking Assertion&quot;);</span>
<a href="#l27.95"></a><span id="l27.95" class="difflineminus">-            return;</span>
<a href="#l27.96"></a><span id="l27.96" class="difflineminus">-        }</span>
<a href="#l27.97"></a><span id="l27.97" class="difflineminus">-        if (--mRefCnt == 0)</span>
<a href="#l27.98"></a><span id="l27.98" class="difflineminus">-            delete this;</span>
<a href="#l27.99"></a><span id="l27.99" class="difflineminus">-    }</span>
<a href="#l27.100"></a><span id="l27.100" class="difflineminus">-</span>
<a href="#l27.101"></a><span id="l27.101" class="difflineminus">-    // For nsIRDFPurgeableDataSource</span>
<a href="#l27.102"></a><span id="l27.102" class="difflineminus">-    inline  void    Mark()      { u.as.mMarked = true; }</span>
<a href="#l27.103"></a><span id="l27.103" class="difflineminus">-    inline  bool    IsMarked()  { return u.as.mMarked; }</span>
<a href="#l27.104"></a><span id="l27.104" class="difflineminus">-    inline  void    Unmark()    { u.as.mMarked = false; }</span>
<a href="#l27.105"></a><span id="l27.105" class="difflineminus">-</span>
<a href="#l27.106"></a><span id="l27.106" class="difflineminus">-    // public for now, because I'm too lazy to go thru and clean this up.</span>
<a href="#l27.107"></a><span id="l27.107" class="difflineminus">-</span>
<a href="#l27.108"></a><span id="l27.108" class="difflineminus">-    // These are shared between hash/as (see the union below)</span>
<a href="#l27.109"></a><span id="l27.109" class="difflineminus">-    nsIRDFResource*         mSource;</span>
<a href="#l27.110"></a><span id="l27.110" class="difflineminus">-    Assertion*              mNext;</span>
<a href="#l27.111"></a><span id="l27.111" class="difflineminus">-</span>
<a href="#l27.112"></a><span id="l27.112" class="difflineminus">-    union</span>
<a href="#l27.113"></a><span id="l27.113" class="difflineminus">-    {</span>
<a href="#l27.114"></a><span id="l27.114" class="difflineminus">-        struct hash</span>
<a href="#l27.115"></a><span id="l27.115" class="difflineminus">-        {</span>
<a href="#l27.116"></a><span id="l27.116" class="difflineminus">-            PLDHashTable*  mPropertyHash;</span>
<a href="#l27.117"></a><span id="l27.117" class="difflineminus">-        } hash;</span>
<a href="#l27.118"></a><span id="l27.118" class="difflineminus">-        struct as</span>
<a href="#l27.119"></a><span id="l27.119" class="difflineminus">-        {</span>
<a href="#l27.120"></a><span id="l27.120" class="difflineminus">-            nsIRDFResource* mProperty;</span>
<a href="#l27.121"></a><span id="l27.121" class="difflineminus">-            nsIRDFNode*     mTarget;</span>
<a href="#l27.122"></a><span id="l27.122" class="difflineminus">-            Assertion*      mInvNext;</span>
<a href="#l27.123"></a><span id="l27.123" class="difflineminus">-            // make sure bool are final elements</span>
<a href="#l27.124"></a><span id="l27.124" class="difflineminus">-            bool            mTruthValue;</span>
<a href="#l27.125"></a><span id="l27.125" class="difflineminus">-            bool            mMarked;</span>
<a href="#l27.126"></a><span id="l27.126" class="difflineminus">-        } as;</span>
<a href="#l27.127"></a><span id="l27.127" class="difflineminus">-    } u;</span>
<a href="#l27.128"></a><span id="l27.128" class="difflineminus">-</span>
<a href="#l27.129"></a><span id="l27.129" class="difflineminus">-    // also shared between hash/as (see the union above)</span>
<a href="#l27.130"></a><span id="l27.130" class="difflineminus">-    // but placed after union definition to ensure that</span>
<a href="#l27.131"></a><span id="l27.131" class="difflineminus">-    // all 32-bit entries are long aligned</span>
<a href="#l27.132"></a><span id="l27.132" class="difflineminus">-    uint16_t                    mRefCnt;</span>
<a href="#l27.133"></a><span id="l27.133" class="difflineminus">-    bool                        mHashEntry;</span>
<a href="#l27.134"></a><span id="l27.134" class="difflineminus">-};</span>
<a href="#l27.135"></a><span id="l27.135" class="difflineminus">-</span>
<a href="#l27.136"></a><span id="l27.136" class="difflineminus">-</span>
<a href="#l27.137"></a><span id="l27.137" class="difflineminus">-struct Entry : PLDHashEntryHdr {</span>
<a href="#l27.138"></a><span id="l27.138" class="difflineminus">-    nsIRDFNode*     mNode;</span>
<a href="#l27.139"></a><span id="l27.139" class="difflineminus">-    Assertion*      mAssertions;</span>
<a href="#l27.140"></a><span id="l27.140" class="difflineminus">-};</span>
<a href="#l27.141"></a><span id="l27.141" class="difflineminus">-</span>
<a href="#l27.142"></a><span id="l27.142" class="difflineminus">-</span>
<a href="#l27.143"></a><span id="l27.143" class="difflineminus">-Assertion::Assertion(nsIRDFResource* aSource)</span>
<a href="#l27.144"></a><span id="l27.144" class="difflineminus">-    : mSource(aSource),</span>
<a href="#l27.145"></a><span id="l27.145" class="difflineminus">-      mNext(nullptr),</span>
<a href="#l27.146"></a><span id="l27.146" class="difflineminus">-      mRefCnt(0),</span>
<a href="#l27.147"></a><span id="l27.147" class="difflineminus">-      mHashEntry(true)</span>
<a href="#l27.148"></a><span id="l27.148" class="difflineminus">-{</span>
<a href="#l27.149"></a><span id="l27.149" class="difflineminus">-    MOZ_COUNT_CTOR(Assertion);</span>
<a href="#l27.150"></a><span id="l27.150" class="difflineminus">-</span>
<a href="#l27.151"></a><span id="l27.151" class="difflineminus">-    NS_ADDREF(mSource);</span>
<a href="#l27.152"></a><span id="l27.152" class="difflineminus">-</span>
<a href="#l27.153"></a><span id="l27.153" class="difflineminus">-    u.hash.mPropertyHash =</span>
<a href="#l27.154"></a><span id="l27.154" class="difflineminus">-        new PLDHashTable(PLDHashTable::StubOps(), sizeof(Entry));</span>
<a href="#l27.155"></a><span id="l27.155" class="difflineminus">-}</span>
<a href="#l27.156"></a><span id="l27.156" class="difflineminus">-</span>
<a href="#l27.157"></a><span id="l27.157" class="difflineminus">-Assertion::Assertion(nsIRDFResource* aSource,</span>
<a href="#l27.158"></a><span id="l27.158" class="difflineminus">-                     nsIRDFResource* aProperty,</span>
<a href="#l27.159"></a><span id="l27.159" class="difflineminus">-                     nsIRDFNode* aTarget,</span>
<a href="#l27.160"></a><span id="l27.160" class="difflineminus">-                     bool aTruthValue)</span>
<a href="#l27.161"></a><span id="l27.161" class="difflineminus">-    : mSource(aSource),</span>
<a href="#l27.162"></a><span id="l27.162" class="difflineminus">-      mNext(nullptr),</span>
<a href="#l27.163"></a><span id="l27.163" class="difflineminus">-      mRefCnt(0),</span>
<a href="#l27.164"></a><span id="l27.164" class="difflineminus">-      mHashEntry(false)</span>
<a href="#l27.165"></a><span id="l27.165" class="difflineminus">-{</span>
<a href="#l27.166"></a><span id="l27.166" class="difflineminus">-    MOZ_COUNT_CTOR(Assertion);</span>
<a href="#l27.167"></a><span id="l27.167" class="difflineminus">-</span>
<a href="#l27.168"></a><span id="l27.168" class="difflineminus">-    u.as.mProperty = aProperty;</span>
<a href="#l27.169"></a><span id="l27.169" class="difflineminus">-    u.as.mTarget = aTarget;</span>
<a href="#l27.170"></a><span id="l27.170" class="difflineminus">-</span>
<a href="#l27.171"></a><span id="l27.171" class="difflineminus">-    NS_ADDREF(mSource);</span>
<a href="#l27.172"></a><span id="l27.172" class="difflineminus">-    NS_ADDREF(u.as.mProperty);</span>
<a href="#l27.173"></a><span id="l27.173" class="difflineminus">-    NS_ADDREF(u.as.mTarget);</span>
<a href="#l27.174"></a><span id="l27.174" class="difflineminus">-</span>
<a href="#l27.175"></a><span id="l27.175" class="difflineminus">-    u.as.mInvNext = nullptr;</span>
<a href="#l27.176"></a><span id="l27.176" class="difflineminus">-    u.as.mTruthValue = aTruthValue;</span>
<a href="#l27.177"></a><span id="l27.177" class="difflineminus">-    u.as.mMarked = false;</span>
<a href="#l27.178"></a><span id="l27.178" class="difflineminus">-}</span>
<a href="#l27.179"></a><span id="l27.179" class="difflineminus">-</span>
<a href="#l27.180"></a><span id="l27.180" class="difflineminus">-Assertion::~Assertion()</span>
<a href="#l27.181"></a><span id="l27.181" class="difflineminus">-{</span>
<a href="#l27.182"></a><span id="l27.182" class="difflineminus">-    if (mHashEntry &amp;&amp; u.hash.mPropertyHash) {</span>
<a href="#l27.183"></a><span id="l27.183" class="difflineminus">-        for (auto i = u.hash.mPropertyHash-&gt;Iter(); !i.Done(); i.Next()) {</span>
<a href="#l27.184"></a><span id="l27.184" class="difflineminus">-            auto entry = static_cast&lt;Entry*&gt;(i.Get());</span>
<a href="#l27.185"></a><span id="l27.185" class="difflineminus">-            Assertion* as = entry-&gt;mAssertions;</span>
<a href="#l27.186"></a><span id="l27.186" class="difflineminus">-            while (as) {</span>
<a href="#l27.187"></a><span id="l27.187" class="difflineminus">-                Assertion* doomed = as;</span>
<a href="#l27.188"></a><span id="l27.188" class="difflineminus">-                as = as-&gt;mNext;</span>
<a href="#l27.189"></a><span id="l27.189" class="difflineminus">-</span>
<a href="#l27.190"></a><span id="l27.190" class="difflineminus">-                // Unlink, and release the datasource's reference.</span>
<a href="#l27.191"></a><span id="l27.191" class="difflineminus">-                doomed-&gt;mNext = doomed-&gt;u.as.mInvNext = nullptr;</span>
<a href="#l27.192"></a><span id="l27.192" class="difflineminus">-                doomed-&gt;Release();</span>
<a href="#l27.193"></a><span id="l27.193" class="difflineminus">-            }</span>
<a href="#l27.194"></a><span id="l27.194" class="difflineminus">-        }</span>
<a href="#l27.195"></a><span id="l27.195" class="difflineminus">-        delete u.hash.mPropertyHash;</span>
<a href="#l27.196"></a><span id="l27.196" class="difflineminus">-        u.hash.mPropertyHash = nullptr;</span>
<a href="#l27.197"></a><span id="l27.197" class="difflineminus">-    }</span>
<a href="#l27.198"></a><span id="l27.198" class="difflineminus">-</span>
<a href="#l27.199"></a><span id="l27.199" class="difflineminus">-    MOZ_COUNT_DTOR(Assertion);</span>
<a href="#l27.200"></a><span id="l27.200" class="difflineminus">-#ifdef DEBUG_REFS</span>
<a href="#l27.201"></a><span id="l27.201" class="difflineminus">-    --gInstanceCount;</span>
<a href="#l27.202"></a><span id="l27.202" class="difflineminus">-    fprintf(stdout, &quot;%d - RDF: Assertion\n&quot;, gInstanceCount);</span>
<a href="#l27.203"></a><span id="l27.203" class="difflineminus">-#endif</span>
<a href="#l27.204"></a><span id="l27.204" class="difflineminus">-</span>
<a href="#l27.205"></a><span id="l27.205" class="difflineminus">-    NS_RELEASE(mSource);</span>
<a href="#l27.206"></a><span id="l27.206" class="difflineminus">-    if (!mHashEntry)</span>
<a href="#l27.207"></a><span id="l27.207" class="difflineminus">-    {</span>
<a href="#l27.208"></a><span id="l27.208" class="difflineminus">-        NS_RELEASE(u.as.mProperty);</span>
<a href="#l27.209"></a><span id="l27.209" class="difflineminus">-        NS_RELEASE(u.as.mTarget);</span>
<a href="#l27.210"></a><span id="l27.210" class="difflineminus">-    }</span>
<a href="#l27.211"></a><span id="l27.211" class="difflineminus">-}</span>
<a href="#l27.212"></a><span id="l27.212" class="difflineminus">-</span>
<a href="#l27.213"></a><span id="l27.213" class="difflineminus">-////////////////////////////////////////////////////////////////////////</span>
<a href="#l27.214"></a><span id="l27.214" class="difflineminus">-// InMemoryDataSource</span>
<a href="#l27.215"></a><span id="l27.215" class="difflineminus">-class InMemoryArcsEnumeratorImpl;</span>
<a href="#l27.216"></a><span id="l27.216" class="difflineminus">-class InMemoryAssertionEnumeratorImpl;</span>
<a href="#l27.217"></a><span id="l27.217" class="difflineminus">-class InMemoryResourceEnumeratorImpl;</span>
<a href="#l27.218"></a><span id="l27.218" class="difflineminus">-</span>
<a href="#l27.219"></a><span id="l27.219" class="difflineminus">-class InMemoryDataSource : public nsIRDFDataSource,</span>
<a href="#l27.220"></a><span id="l27.220" class="difflineminus">-                           public nsIRDFInMemoryDataSource,</span>
<a href="#l27.221"></a><span id="l27.221" class="difflineminus">-                           public nsIRDFPropagatableDataSource,</span>
<a href="#l27.222"></a><span id="l27.222" class="difflineminus">-                           public nsIRDFPurgeableDataSource,</span>
<a href="#l27.223"></a><span id="l27.223" class="difflineminus">-                           public rdfIDataSource</span>
<a href="#l27.224"></a><span id="l27.224" class="difflineminus">-{</span>
<a href="#l27.225"></a><span id="l27.225" class="difflineminus">-protected:</span>
<a href="#l27.226"></a><span id="l27.226" class="difflineminus">-    // These hash tables are keyed on pointers to nsIRDFResource</span>
<a href="#l27.227"></a><span id="l27.227" class="difflineminus">-    // objects (the nsIRDFService ensures that there is only ever one</span>
<a href="#l27.228"></a><span id="l27.228" class="difflineminus">-    // nsIRDFResource object per unique URI). The value of an entry is</span>
<a href="#l27.229"></a><span id="l27.229" class="difflineminus">-    // an Assertion struct, which is a linked list of (subject</span>
<a href="#l27.230"></a><span id="l27.230" class="difflineminus">-    // predicate object) triples.</span>
<a href="#l27.231"></a><span id="l27.231" class="difflineminus">-    PLDHashTable mForwardArcs;</span>
<a href="#l27.232"></a><span id="l27.232" class="difflineminus">-    PLDHashTable mReverseArcs;</span>
<a href="#l27.233"></a><span id="l27.233" class="difflineminus">-</span>
<a href="#l27.234"></a><span id="l27.234" class="difflineminus">-    nsCOMArray&lt;nsIRDFObserver&gt; mObservers;</span>
<a href="#l27.235"></a><span id="l27.235" class="difflineminus">-    uint32_t                   mNumObservers;</span>
<a href="#l27.236"></a><span id="l27.236" class="difflineminus">-</span>
<a href="#l27.237"></a><span id="l27.237" class="difflineminus">-    // VisitFoo needs to block writes, [Un]Assert only allowed</span>
<a href="#l27.238"></a><span id="l27.238" class="difflineminus">-    // during mReadCount == 0</span>
<a href="#l27.239"></a><span id="l27.239" class="difflineminus">-    uint32_t mReadCount;</span>
<a href="#l27.240"></a><span id="l27.240" class="difflineminus">-</span>
<a href="#l27.241"></a><span id="l27.241" class="difflineminus">-    friend class InMemoryArcsEnumeratorImpl;</span>
<a href="#l27.242"></a><span id="l27.242" class="difflineminus">-    friend class InMemoryAssertionEnumeratorImpl;</span>
<a href="#l27.243"></a><span id="l27.243" class="difflineminus">-    friend class InMemoryResourceEnumeratorImpl; // b/c it needs to enumerate mForwardArcs</span>
<a href="#l27.244"></a><span id="l27.244" class="difflineminus">-</span>
<a href="#l27.245"></a><span id="l27.245" class="difflineminus">-    // Thread-safe writer implementation methods.</span>
<a href="#l27.246"></a><span id="l27.246" class="difflineminus">-    nsresult</span>
<a href="#l27.247"></a><span id="l27.247" class="difflineminus">-    LockedAssert(nsIRDFResource* source,</span>
<a href="#l27.248"></a><span id="l27.248" class="difflineminus">-                 nsIRDFResource* property,</span>
<a href="#l27.249"></a><span id="l27.249" class="difflineminus">-                 nsIRDFNode* target,</span>
<a href="#l27.250"></a><span id="l27.250" class="difflineminus">-                 bool tv);</span>
<a href="#l27.251"></a><span id="l27.251" class="difflineminus">-</span>
<a href="#l27.252"></a><span id="l27.252" class="difflineminus">-    nsresult</span>
<a href="#l27.253"></a><span id="l27.253" class="difflineminus">-    LockedUnassert(nsIRDFResource* source,</span>
<a href="#l27.254"></a><span id="l27.254" class="difflineminus">-                   nsIRDFResource* property,</span>
<a href="#l27.255"></a><span id="l27.255" class="difflineminus">-                   nsIRDFNode* target);</span>
<a href="#l27.256"></a><span id="l27.256" class="difflineminus">-</span>
<a href="#l27.257"></a><span id="l27.257" class="difflineminus">-    explicit InMemoryDataSource(nsISupports* aOuter);</span>
<a href="#l27.258"></a><span id="l27.258" class="difflineminus">-    virtual ~InMemoryDataSource();</span>
<a href="#l27.259"></a><span id="l27.259" class="difflineminus">-</span>
<a href="#l27.260"></a><span id="l27.260" class="difflineminus">-    friend nsresult</span>
<a href="#l27.261"></a><span id="l27.261" class="difflineminus">-    NS_NewRDFInMemoryDataSource(nsISupports* aOuter, const nsIID&amp; aIID, void** aResult);</span>
<a href="#l27.262"></a><span id="l27.262" class="difflineminus">-</span>
<a href="#l27.263"></a><span id="l27.263" class="difflineminus">-public:</span>
<a href="#l27.264"></a><span id="l27.264" class="difflineminus">-    NS_DECL_CYCLE_COLLECTING_AGGREGATED</span>
<a href="#l27.265"></a><span id="l27.265" class="difflineminus">-    NS_DECL_AGGREGATED_CYCLE_COLLECTION_CLASS(InMemoryDataSource)</span>
<a href="#l27.266"></a><span id="l27.266" class="difflineminus">-</span>
<a href="#l27.267"></a><span id="l27.267" class="difflineminus">-    // nsIRDFDataSource methods</span>
<a href="#l27.268"></a><span id="l27.268" class="difflineminus">-    NS_DECL_NSIRDFDATASOURCE</span>
<a href="#l27.269"></a><span id="l27.269" class="difflineminus">-</span>
<a href="#l27.270"></a><span id="l27.270" class="difflineminus">-    // nsIRDFInMemoryDataSource methods</span>
<a href="#l27.271"></a><span id="l27.271" class="difflineminus">-    NS_DECL_NSIRDFINMEMORYDATASOURCE</span>
<a href="#l27.272"></a><span id="l27.272" class="difflineminus">-</span>
<a href="#l27.273"></a><span id="l27.273" class="difflineminus">-    // nsIRDFPropagatableDataSource methods</span>
<a href="#l27.274"></a><span id="l27.274" class="difflineminus">-    NS_DECL_NSIRDFPROPAGATABLEDATASOURCE</span>
<a href="#l27.275"></a><span id="l27.275" class="difflineminus">-</span>
<a href="#l27.276"></a><span id="l27.276" class="difflineminus">-    // nsIRDFPurgeableDataSource methods</span>
<a href="#l27.277"></a><span id="l27.277" class="difflineminus">-    NS_DECL_NSIRDFPURGEABLEDATASOURCE</span>
<a href="#l27.278"></a><span id="l27.278" class="difflineminus">-</span>
<a href="#l27.279"></a><span id="l27.279" class="difflineminus">-    // rdfIDataSource methods</span>
<a href="#l27.280"></a><span id="l27.280" class="difflineminus">-    NS_DECL_RDFIDATASOURCE</span>
<a href="#l27.281"></a><span id="l27.281" class="difflineminus">-</span>
<a href="#l27.282"></a><span id="l27.282" class="difflineminus">-protected:</span>
<a href="#l27.283"></a><span id="l27.283" class="difflineminus">-    struct SweepInfo {</span>
<a href="#l27.284"></a><span id="l27.284" class="difflineminus">-        Assertion* mUnassertList;</span>
<a href="#l27.285"></a><span id="l27.285" class="difflineminus">-        PLDHashTable* mReverseArcs;</span>
<a href="#l27.286"></a><span id="l27.286" class="difflineminus">-    };</span>
<a href="#l27.287"></a><span id="l27.287" class="difflineminus">-</span>
<a href="#l27.288"></a><span id="l27.288" class="difflineminus">-    static void</span>
<a href="#l27.289"></a><span id="l27.289" class="difflineminus">-    SweepForwardArcsEntries(PLDHashTable* aTable, SweepInfo* aArg);</span>
<a href="#l27.290"></a><span id="l27.290" class="difflineminus">-</span>
<a href="#l27.291"></a><span id="l27.291" class="difflineminus">-public:</span>
<a href="#l27.292"></a><span id="l27.292" class="difflineminus">-    // Implementation methods</span>
<a href="#l27.293"></a><span id="l27.293" class="difflineminus">-    Assertion*</span>
<a href="#l27.294"></a><span id="l27.294" class="difflineminus">-    GetForwardArcs(nsIRDFResource* u) {</span>
<a href="#l27.295"></a><span id="l27.295" class="difflineminus">-        PLDHashEntryHdr* hdr = mForwardArcs.Search(u);</span>
<a href="#l27.296"></a><span id="l27.296" class="difflineminus">-        return hdr ? static_cast&lt;Entry*&gt;(hdr)-&gt;mAssertions : nullptr;</span>
<a href="#l27.297"></a><span id="l27.297" class="difflineminus">-    }</span>
<a href="#l27.298"></a><span id="l27.298" class="difflineminus">-</span>
<a href="#l27.299"></a><span id="l27.299" class="difflineminus">-    Assertion*</span>
<a href="#l27.300"></a><span id="l27.300" class="difflineminus">-    GetReverseArcs(nsIRDFNode* v) {</span>
<a href="#l27.301"></a><span id="l27.301" class="difflineminus">-        PLDHashEntryHdr* hdr = mReverseArcs.Search(v);</span>
<a href="#l27.302"></a><span id="l27.302" class="difflineminus">-        return hdr ? static_cast&lt;Entry*&gt;(hdr)-&gt;mAssertions : nullptr;</span>
<a href="#l27.303"></a><span id="l27.303" class="difflineminus">-    }</span>
<a href="#l27.304"></a><span id="l27.304" class="difflineminus">-</span>
<a href="#l27.305"></a><span id="l27.305" class="difflineminus">-    void</span>
<a href="#l27.306"></a><span id="l27.306" class="difflineminus">-    SetForwardArcs(nsIRDFResource* u, Assertion* as) {</span>
<a href="#l27.307"></a><span id="l27.307" class="difflineminus">-        if (as) {</span>
<a href="#l27.308"></a><span id="l27.308" class="difflineminus">-            auto entry =</span>
<a href="#l27.309"></a><span id="l27.309" class="difflineminus">-                static_cast&lt;Entry*&gt;(mForwardArcs.Add(u, mozilla::fallible));</span>
<a href="#l27.310"></a><span id="l27.310" class="difflineminus">-            if (entry) {</span>
<a href="#l27.311"></a><span id="l27.311" class="difflineminus">-                entry-&gt;mNode = u;</span>
<a href="#l27.312"></a><span id="l27.312" class="difflineminus">-                entry-&gt;mAssertions = as;</span>
<a href="#l27.313"></a><span id="l27.313" class="difflineminus">-            }</span>
<a href="#l27.314"></a><span id="l27.314" class="difflineminus">-        }</span>
<a href="#l27.315"></a><span id="l27.315" class="difflineminus">-        else {</span>
<a href="#l27.316"></a><span id="l27.316" class="difflineminus">-            mForwardArcs.Remove(u);</span>
<a href="#l27.317"></a><span id="l27.317" class="difflineminus">-        }</span>
<a href="#l27.318"></a><span id="l27.318" class="difflineminus">-    }</span>
<a href="#l27.319"></a><span id="l27.319" class="difflineminus">-</span>
<a href="#l27.320"></a><span id="l27.320" class="difflineminus">-    void</span>
<a href="#l27.321"></a><span id="l27.321" class="difflineminus">-    SetReverseArcs(nsIRDFNode* v, Assertion* as) {</span>
<a href="#l27.322"></a><span id="l27.322" class="difflineminus">-        if (as) {</span>
<a href="#l27.323"></a><span id="l27.323" class="difflineminus">-            auto entry =</span>
<a href="#l27.324"></a><span id="l27.324" class="difflineminus">-                static_cast&lt;Entry*&gt;(mReverseArcs.Add(v, mozilla::fallible));</span>
<a href="#l27.325"></a><span id="l27.325" class="difflineminus">-            if (entry) {</span>
<a href="#l27.326"></a><span id="l27.326" class="difflineminus">-                entry-&gt;mNode = v;</span>
<a href="#l27.327"></a><span id="l27.327" class="difflineminus">-                entry-&gt;mAssertions = as;</span>
<a href="#l27.328"></a><span id="l27.328" class="difflineminus">-            }</span>
<a href="#l27.329"></a><span id="l27.329" class="difflineminus">-        }</span>
<a href="#l27.330"></a><span id="l27.330" class="difflineminus">-        else {</span>
<a href="#l27.331"></a><span id="l27.331" class="difflineminus">-            mReverseArcs.Remove(v);</span>
<a href="#l27.332"></a><span id="l27.332" class="difflineminus">-        }</span>
<a href="#l27.333"></a><span id="l27.333" class="difflineminus">-    }</span>
<a href="#l27.334"></a><span id="l27.334" class="difflineminus">-</span>
<a href="#l27.335"></a><span id="l27.335" class="difflineminus">-    void</span>
<a href="#l27.336"></a><span id="l27.336" class="difflineminus">-    LogOperation(const char* aOperation,</span>
<a href="#l27.337"></a><span id="l27.337" class="difflineminus">-                 nsIRDFResource* asource,</span>
<a href="#l27.338"></a><span id="l27.338" class="difflineminus">-                 nsIRDFResource* aProperty,</span>
<a href="#l27.339"></a><span id="l27.339" class="difflineminus">-                 nsIRDFNode* aTarget,</span>
<a href="#l27.340"></a><span id="l27.340" class="difflineminus">-                 bool aTruthValue = true);</span>
<a href="#l27.341"></a><span id="l27.341" class="difflineminus">-</span>
<a href="#l27.342"></a><span id="l27.342" class="difflineminus">-    bool    mPropagateChanges;</span>
<a href="#l27.343"></a><span id="l27.343" class="difflineminus">-</span>
<a href="#l27.344"></a><span id="l27.344" class="difflineminus">-private:</span>
<a href="#l27.345"></a><span id="l27.345" class="difflineminus">-    static mozilla::LazyLogModule gLog;</span>
<a href="#l27.346"></a><span id="l27.346" class="difflineminus">-};</span>
<a href="#l27.347"></a><span id="l27.347" class="difflineminus">-</span>
<a href="#l27.348"></a><span id="l27.348" class="difflineminus">-mozilla::LazyLogModule InMemoryDataSource::gLog(&quot;InMemoryDataSource&quot;);</span>
<a href="#l27.349"></a><span id="l27.349" class="difflineminus">-</span>
<a href="#l27.350"></a><span id="l27.350" class="difflineminus">-//----------------------------------------------------------------------</span>
<a href="#l27.351"></a><span id="l27.351" class="difflineminus">-//</span>
<a href="#l27.352"></a><span id="l27.352" class="difflineminus">-// InMemoryAssertionEnumeratorImpl</span>
<a href="#l27.353"></a><span id="l27.353" class="difflineminus">-//</span>
<a href="#l27.354"></a><span id="l27.354" class="difflineminus">-</span>
<a href="#l27.355"></a><span id="l27.355" class="difflineminus">-/**</span>
<a href="#l27.356"></a><span id="l27.356" class="difflineminus">- * InMemoryAssertionEnumeratorImpl</span>
<a href="#l27.357"></a><span id="l27.357" class="difflineminus">- */</span>
<a href="#l27.358"></a><span id="l27.358" class="difflineminus">-class InMemoryAssertionEnumeratorImpl : public nsSimpleEnumerator</span>
<a href="#l27.359"></a><span id="l27.359" class="difflineminus">-{</span>
<a href="#l27.360"></a><span id="l27.360" class="difflineminus">-private:</span>
<a href="#l27.361"></a><span id="l27.361" class="difflineminus">-    InMemoryDataSource* mDataSource;</span>
<a href="#l27.362"></a><span id="l27.362" class="difflineminus">-    nsIRDFResource* mSource;</span>
<a href="#l27.363"></a><span id="l27.363" class="difflineminus">-    nsIRDFResource* mProperty;</span>
<a href="#l27.364"></a><span id="l27.364" class="difflineminus">-    nsIRDFNode*     mTarget;</span>
<a href="#l27.365"></a><span id="l27.365" class="difflineminus">-    nsIRDFNode*     mValue;</span>
<a href="#l27.366"></a><span id="l27.366" class="difflineminus">-    bool            mTruthValue;</span>
<a href="#l27.367"></a><span id="l27.367" class="difflineminus">-    Assertion*      mNextAssertion;</span>
<a href="#l27.368"></a><span id="l27.368" class="difflineminus">-</span>
<a href="#l27.369"></a><span id="l27.369" class="difflineminus">-    ~InMemoryAssertionEnumeratorImpl() override;</span>
<a href="#l27.370"></a><span id="l27.370" class="difflineminus">-</span>
<a href="#l27.371"></a><span id="l27.371" class="difflineminus">-public:</span>
<a href="#l27.372"></a><span id="l27.372" class="difflineminus">-    const nsID&amp; DefaultInterface() override</span>
<a href="#l27.373"></a><span id="l27.373" class="difflineminus">-    {</span>
<a href="#l27.374"></a><span id="l27.374" class="difflineminus">-      return NS_GET_IID(nsIRDFNode);</span>
<a href="#l27.375"></a><span id="l27.375" class="difflineminus">-    }</span>
<a href="#l27.376"></a><span id="l27.376" class="difflineminus">-</span>
<a href="#l27.377"></a><span id="l27.377" class="difflineminus">-    // nsISimpleEnumerator interface</span>
<a href="#l27.378"></a><span id="l27.378" class="difflineminus">-    NS_DECL_NSISIMPLEENUMERATOR</span>
<a href="#l27.379"></a><span id="l27.379" class="difflineminus">-</span>
<a href="#l27.380"></a><span id="l27.380" class="difflineminus">-    InMemoryAssertionEnumeratorImpl(InMemoryDataSource* aDataSource,</span>
<a href="#l27.381"></a><span id="l27.381" class="difflineminus">-                                    nsIRDFResource* aSource,</span>
<a href="#l27.382"></a><span id="l27.382" class="difflineminus">-                                    nsIRDFResource* aProperty,</span>
<a href="#l27.383"></a><span id="l27.383" class="difflineminus">-                                    nsIRDFNode* aTarget,</span>
<a href="#l27.384"></a><span id="l27.384" class="difflineminus">-                                    bool aTruthValue);</span>
<a href="#l27.385"></a><span id="l27.385" class="difflineminus">-};</span>
<a href="#l27.386"></a><span id="l27.386" class="difflineminus">-</span>
<a href="#l27.387"></a><span id="l27.387" class="difflineminus">-////////////////////////////////////////////////////////////////////////</span>
<a href="#l27.388"></a><span id="l27.388" class="difflineminus">-</span>
<a href="#l27.389"></a><span id="l27.389" class="difflineminus">-</span>
<a href="#l27.390"></a><span id="l27.390" class="difflineminus">-InMemoryAssertionEnumeratorImpl::InMemoryAssertionEnumeratorImpl(</span>
<a href="#l27.391"></a><span id="l27.391" class="difflineminus">-                 InMemoryDataSource* aDataSource,</span>
<a href="#l27.392"></a><span id="l27.392" class="difflineminus">-                 nsIRDFResource* aSource,</span>
<a href="#l27.393"></a><span id="l27.393" class="difflineminus">-                 nsIRDFResource* aProperty,</span>
<a href="#l27.394"></a><span id="l27.394" class="difflineminus">-                 nsIRDFNode* aTarget,</span>
<a href="#l27.395"></a><span id="l27.395" class="difflineminus">-                 bool aTruthValue)</span>
<a href="#l27.396"></a><span id="l27.396" class="difflineminus">-    : mDataSource(aDataSource),</span>
<a href="#l27.397"></a><span id="l27.397" class="difflineminus">-      mSource(aSource),</span>
<a href="#l27.398"></a><span id="l27.398" class="difflineminus">-      mProperty(aProperty),</span>
<a href="#l27.399"></a><span id="l27.399" class="difflineminus">-      mTarget(aTarget),</span>
<a href="#l27.400"></a><span id="l27.400" class="difflineminus">-      mValue(nullptr),</span>
<a href="#l27.401"></a><span id="l27.401" class="difflineminus">-      mTruthValue(aTruthValue),</span>
<a href="#l27.402"></a><span id="l27.402" class="difflineminus">-      mNextAssertion(nullptr)</span>
<a href="#l27.403"></a><span id="l27.403" class="difflineminus">-{</span>
<a href="#l27.404"></a><span id="l27.404" class="difflineminus">-    NS_ADDREF(mDataSource);</span>
<a href="#l27.405"></a><span id="l27.405" class="difflineminus">-    NS_IF_ADDREF(mSource);</span>
<a href="#l27.406"></a><span id="l27.406" class="difflineminus">-    NS_ADDREF(mProperty);</span>
<a href="#l27.407"></a><span id="l27.407" class="difflineminus">-    NS_IF_ADDREF(mTarget);</span>
<a href="#l27.408"></a><span id="l27.408" class="difflineminus">-</span>
<a href="#l27.409"></a><span id="l27.409" class="difflineminus">-    if (mSource) {</span>
<a href="#l27.410"></a><span id="l27.410" class="difflineminus">-        mNextAssertion = mDataSource-&gt;GetForwardArcs(mSource);</span>
<a href="#l27.411"></a><span id="l27.411" class="difflineminus">-</span>
<a href="#l27.412"></a><span id="l27.412" class="difflineminus">-        if (mNextAssertion &amp;&amp; mNextAssertion-&gt;mHashEntry) {</span>
<a href="#l27.413"></a><span id="l27.413" class="difflineminus">-            // its our magical HASH_ENTRY forward hash for assertions</span>
<a href="#l27.414"></a><span id="l27.414" class="difflineminus">-            PLDHashEntryHdr* hdr =</span>
<a href="#l27.415"></a><span id="l27.415" class="difflineminus">-                mNextAssertion-&gt;u.hash.mPropertyHash-&gt;Search(aProperty);</span>
<a href="#l27.416"></a><span id="l27.416" class="difflineminus">-            mNextAssertion =</span>
<a href="#l27.417"></a><span id="l27.417" class="difflineminus">-                hdr ? static_cast&lt;Entry*&gt;(hdr)-&gt;mAssertions : nullptr;</span>
<a href="#l27.418"></a><span id="l27.418" class="difflineminus">-        }</span>
<a href="#l27.419"></a><span id="l27.419" class="difflineminus">-    }</span>
<a href="#l27.420"></a><span id="l27.420" class="difflineminus">-    else {</span>
<a href="#l27.421"></a><span id="l27.421" class="difflineminus">-        mNextAssertion = mDataSource-&gt;GetReverseArcs(mTarget);</span>
<a href="#l27.422"></a><span id="l27.422" class="difflineminus">-    }</span>
<a href="#l27.423"></a><span id="l27.423" class="difflineminus">-</span>
<a href="#l27.424"></a><span id="l27.424" class="difflineminus">-    // Add an owning reference from the enumerator</span>
<a href="#l27.425"></a><span id="l27.425" class="difflineminus">-    if (mNextAssertion)</span>
<a href="#l27.426"></a><span id="l27.426" class="difflineminus">-        mNextAssertion-&gt;AddRef();</span>
<a href="#l27.427"></a><span id="l27.427" class="difflineminus">-}</span>
<a href="#l27.428"></a><span id="l27.428" class="difflineminus">-</span>
<a href="#l27.429"></a><span id="l27.429" class="difflineminus">-InMemoryAssertionEnumeratorImpl::~InMemoryAssertionEnumeratorImpl()</span>
<a href="#l27.430"></a><span id="l27.430" class="difflineminus">-{</span>
<a href="#l27.431"></a><span id="l27.431" class="difflineminus">-#ifdef DEBUG_REFS</span>
<a href="#l27.432"></a><span id="l27.432" class="difflineminus">-    --gInstanceCount;</span>
<a href="#l27.433"></a><span id="l27.433" class="difflineminus">-    fprintf(stdout, &quot;%d - RDF: InMemoryAssertionEnumeratorImpl\n&quot;, gInstanceCount);</span>
<a href="#l27.434"></a><span id="l27.434" class="difflineminus">-#endif</span>
<a href="#l27.435"></a><span id="l27.435" class="difflineminus">-</span>
<a href="#l27.436"></a><span id="l27.436" class="difflineminus">-    if (mNextAssertion)</span>
<a href="#l27.437"></a><span id="l27.437" class="difflineminus">-        mNextAssertion-&gt;Release();</span>
<a href="#l27.438"></a><span id="l27.438" class="difflineminus">-</span>
<a href="#l27.439"></a><span id="l27.439" class="difflineminus">-    NS_IF_RELEASE(mDataSource);</span>
<a href="#l27.440"></a><span id="l27.440" class="difflineminus">-    NS_IF_RELEASE(mSource);</span>
<a href="#l27.441"></a><span id="l27.441" class="difflineminus">-    NS_IF_RELEASE(mProperty);</span>
<a href="#l27.442"></a><span id="l27.442" class="difflineminus">-    NS_IF_RELEASE(mTarget);</span>
<a href="#l27.443"></a><span id="l27.443" class="difflineminus">-    NS_IF_RELEASE(mValue);</span>
<a href="#l27.444"></a><span id="l27.444" class="difflineminus">-}</span>
<a href="#l27.445"></a><span id="l27.445" class="difflineminus">-</span>
<a href="#l27.446"></a><span id="l27.446" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l27.447"></a><span id="l27.447" class="difflineminus">-InMemoryAssertionEnumeratorImpl::HasMoreElements(bool* aResult)</span>
<a href="#l27.448"></a><span id="l27.448" class="difflineminus">-{</span>
<a href="#l27.449"></a><span id="l27.449" class="difflineminus">-    if (mValue) {</span>
<a href="#l27.450"></a><span id="l27.450" class="difflineminus">-        *aResult = true;</span>
<a href="#l27.451"></a><span id="l27.451" class="difflineminus">-        return NS_OK;</span>
<a href="#l27.452"></a><span id="l27.452" class="difflineminus">-    }</span>
<a href="#l27.453"></a><span id="l27.453" class="difflineminus">-</span>
<a href="#l27.454"></a><span id="l27.454" class="difflineminus">-    while (mNextAssertion) {</span>
<a href="#l27.455"></a><span id="l27.455" class="difflineminus">-        bool foundIt = false;</span>
<a href="#l27.456"></a><span id="l27.456" class="difflineminus">-        if ((mProperty == mNextAssertion-&gt;u.as.mProperty) &amp;&amp;</span>
<a href="#l27.457"></a><span id="l27.457" class="difflineminus">-            (mTruthValue == mNextAssertion-&gt;u.as.mTruthValue)) {</span>
<a href="#l27.458"></a><span id="l27.458" class="difflineminus">-            if (mSource) {</span>
<a href="#l27.459"></a><span id="l27.459" class="difflineminus">-                mValue = mNextAssertion-&gt;u.as.mTarget;</span>
<a href="#l27.460"></a><span id="l27.460" class="difflineminus">-                NS_ADDREF(mValue);</span>
<a href="#l27.461"></a><span id="l27.461" class="difflineminus">-            }</span>
<a href="#l27.462"></a><span id="l27.462" class="difflineminus">-            else {</span>
<a href="#l27.463"></a><span id="l27.463" class="difflineminus">-                mValue = mNextAssertion-&gt;mSource;</span>
<a href="#l27.464"></a><span id="l27.464" class="difflineminus">-                NS_ADDREF(mValue);</span>
<a href="#l27.465"></a><span id="l27.465" class="difflineminus">-            }</span>
<a href="#l27.466"></a><span id="l27.466" class="difflineminus">-            foundIt = true;</span>
<a href="#l27.467"></a><span id="l27.467" class="difflineminus">-        }</span>
<a href="#l27.468"></a><span id="l27.468" class="difflineminus">-</span>
<a href="#l27.469"></a><span id="l27.469" class="difflineminus">-        // Remember the last assertion we were holding on to</span>
<a href="#l27.470"></a><span id="l27.470" class="difflineminus">-        Assertion* as = mNextAssertion;</span>
<a href="#l27.471"></a><span id="l27.471" class="difflineminus">-</span>
<a href="#l27.472"></a><span id="l27.472" class="difflineminus">-        // iterate</span>
<a href="#l27.473"></a><span id="l27.473" class="difflineminus">-        mNextAssertion = (mSource) ? mNextAssertion-&gt;mNext : mNextAssertion-&gt;u.as.mInvNext;</span>
<a href="#l27.474"></a><span id="l27.474" class="difflineminus">-</span>
<a href="#l27.475"></a><span id="l27.475" class="difflineminus">-        // grab an owning reference from the enumerator to the next assertion</span>
<a href="#l27.476"></a><span id="l27.476" class="difflineminus">-        if (mNextAssertion)</span>
<a href="#l27.477"></a><span id="l27.477" class="difflineminus">-            mNextAssertion-&gt;AddRef();</span>
<a href="#l27.478"></a><span id="l27.478" class="difflineminus">-</span>
<a href="#l27.479"></a><span id="l27.479" class="difflineminus">-        // ...and release the reference from the enumerator to the old one.</span>
<a href="#l27.480"></a><span id="l27.480" class="difflineminus">-        as-&gt;Release();</span>
<a href="#l27.481"></a><span id="l27.481" class="difflineminus">-</span>
<a href="#l27.482"></a><span id="l27.482" class="difflineminus">-        if (foundIt) {</span>
<a href="#l27.483"></a><span id="l27.483" class="difflineminus">-            *aResult = true;</span>
<a href="#l27.484"></a><span id="l27.484" class="difflineminus">-            return NS_OK;</span>
<a href="#l27.485"></a><span id="l27.485" class="difflineminus">-        }</span>
<a href="#l27.486"></a><span id="l27.486" class="difflineminus">-    }</span>
<a href="#l27.487"></a><span id="l27.487" class="difflineminus">-</span>
<a href="#l27.488"></a><span id="l27.488" class="difflineminus">-    *aResult = false;</span>
<a href="#l27.489"></a><span id="l27.489" class="difflineminus">-    return NS_OK;</span>
<a href="#l27.490"></a><span id="l27.490" class="difflineminus">-}</span>
<a href="#l27.491"></a><span id="l27.491" class="difflineminus">-</span>
<a href="#l27.492"></a><span id="l27.492" class="difflineminus">-</span>
<a href="#l27.493"></a><span id="l27.493" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l27.494"></a><span id="l27.494" class="difflineminus">-InMemoryAssertionEnumeratorImpl::GetNext(nsISupports** aResult)</span>
<a href="#l27.495"></a><span id="l27.495" class="difflineminus">-{</span>
<a href="#l27.496"></a><span id="l27.496" class="difflineminus">-    nsresult rv;</span>
<a href="#l27.497"></a><span id="l27.497" class="difflineminus">-</span>
<a href="#l27.498"></a><span id="l27.498" class="difflineminus">-    bool hasMore;</span>
<a href="#l27.499"></a><span id="l27.499" class="difflineminus">-    rv = HasMoreElements(&amp;hasMore);</span>
<a href="#l27.500"></a><span id="l27.500" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l27.501"></a><span id="l27.501" class="difflineminus">-</span>
<a href="#l27.502"></a><span id="l27.502" class="difflineminus">-    if (! hasMore)</span>
<a href="#l27.503"></a><span id="l27.503" class="difflineminus">-        return NS_ERROR_UNEXPECTED;</span>
<a href="#l27.504"></a><span id="l27.504" class="difflineminus">-</span>
<a href="#l27.505"></a><span id="l27.505" class="difflineminus">-    // Don't AddRef: we &quot;transfer&quot; ownership to the caller</span>
<a href="#l27.506"></a><span id="l27.506" class="difflineminus">-    *aResult = mValue;</span>
<a href="#l27.507"></a><span id="l27.507" class="difflineminus">-    mValue = nullptr;</span>
<a href="#l27.508"></a><span id="l27.508" class="difflineminus">-</span>
<a href="#l27.509"></a><span id="l27.509" class="difflineminus">-    return NS_OK;</span>
<a href="#l27.510"></a><span id="l27.510" class="difflineminus">-}</span>
<a href="#l27.511"></a><span id="l27.511" class="difflineminus">-</span>
<a href="#l27.512"></a><span id="l27.512" class="difflineminus">-////////////////////////////////////////////////////////////////////////</span>
<a href="#l27.513"></a><span id="l27.513" class="difflineminus">-//</span>
<a href="#l27.514"></a><span id="l27.514" class="difflineminus">-</span>
<a href="#l27.515"></a><span id="l27.515" class="difflineminus">-/**</span>
<a href="#l27.516"></a><span id="l27.516" class="difflineminus">- * This class is a little bit bizarre in that it implements both the</span>
<a href="#l27.517"></a><span id="l27.517" class="difflineminus">- * &lt;tt&gt;nsIRDFArcsOutCursor&lt;/tt&gt; and &lt;tt&gt;nsIRDFArcsInCursor&lt;/tt&gt; interfaces.</span>
<a href="#l27.518"></a><span id="l27.518" class="difflineminus">- * Because the structure of the in-memory graph is pretty flexible, it's</span>
<a href="#l27.519"></a><span id="l27.519" class="difflineminus">- * fairly easy to parameterize this class. The only funky thing to watch</span>
<a href="#l27.520"></a><span id="l27.520" class="difflineminus">- * out for is the multiple inheritance clashes.</span>
<a href="#l27.521"></a><span id="l27.521" class="difflineminus">- */</span>
<a href="#l27.522"></a><span id="l27.522" class="difflineminus">-</span>
<a href="#l27.523"></a><span id="l27.523" class="difflineminus">-class InMemoryArcsEnumeratorImpl : public nsSimpleEnumerator</span>
<a href="#l27.524"></a><span id="l27.524" class="difflineminus">-{</span>
<a href="#l27.525"></a><span id="l27.525" class="difflineminus">-private:</span>
<a href="#l27.526"></a><span id="l27.526" class="difflineminus">-    InMemoryDataSource* mDataSource;</span>
<a href="#l27.527"></a><span id="l27.527" class="difflineminus">-    nsIRDFResource*     mSource;</span>
<a href="#l27.528"></a><span id="l27.528" class="difflineminus">-    nsIRDFNode*         mTarget;</span>
<a href="#l27.529"></a><span id="l27.529" class="difflineminus">-    AutoTArray&lt;nsCOMPtr&lt;nsIRDFResource&gt;, 8&gt; mAlreadyReturned;</span>
<a href="#l27.530"></a><span id="l27.530" class="difflineminus">-    nsIRDFResource*     mCurrent;</span>
<a href="#l27.531"></a><span id="l27.531" class="difflineminus">-    Assertion*          mAssertion;</span>
<a href="#l27.532"></a><span id="l27.532" class="difflineminus">-    nsCOMArray&lt;nsIRDFNode&gt;* mHashArcs;</span>
<a href="#l27.533"></a><span id="l27.533" class="difflineminus">-</span>
<a href="#l27.534"></a><span id="l27.534" class="difflineminus">-    ~InMemoryArcsEnumeratorImpl() override;</span>
<a href="#l27.535"></a><span id="l27.535" class="difflineminus">-</span>
<a href="#l27.536"></a><span id="l27.536" class="difflineminus">-public:</span>
<a href="#l27.537"></a><span id="l27.537" class="difflineminus">-    const nsID&amp; DefaultInterface() override</span>
<a href="#l27.538"></a><span id="l27.538" class="difflineminus">-    {</span>
<a href="#l27.539"></a><span id="l27.539" class="difflineminus">-      return NS_GET_IID(nsIRDFResource);</span>
<a href="#l27.540"></a><span id="l27.540" class="difflineminus">-    }</span>
<a href="#l27.541"></a><span id="l27.541" class="difflineminus">-</span>
<a href="#l27.542"></a><span id="l27.542" class="difflineminus">-    // nsISimpleEnumerator interface</span>
<a href="#l27.543"></a><span id="l27.543" class="difflineminus">-    NS_DECL_NSISIMPLEENUMERATOR</span>
<a href="#l27.544"></a><span id="l27.544" class="difflineminus">-</span>
<a href="#l27.545"></a><span id="l27.545" class="difflineminus">-    InMemoryArcsEnumeratorImpl(InMemoryDataSource* aDataSource,</span>
<a href="#l27.546"></a><span id="l27.546" class="difflineminus">-                               nsIRDFResource* aSource,</span>
<a href="#l27.547"></a><span id="l27.547" class="difflineminus">-                               nsIRDFNode* aTarget);</span>
<a href="#l27.548"></a><span id="l27.548" class="difflineminus">-};</span>
<a href="#l27.549"></a><span id="l27.549" class="difflineminus">-</span>
<a href="#l27.550"></a><span id="l27.550" class="difflineminus">-</span>
<a href="#l27.551"></a><span id="l27.551" class="difflineminus">-InMemoryArcsEnumeratorImpl::InMemoryArcsEnumeratorImpl(InMemoryDataSource* aDataSource,</span>
<a href="#l27.552"></a><span id="l27.552" class="difflineminus">-                                                       nsIRDFResource* aSource,</span>
<a href="#l27.553"></a><span id="l27.553" class="difflineminus">-                                                       nsIRDFNode* aTarget)</span>
<a href="#l27.554"></a><span id="l27.554" class="difflineminus">-    : mDataSource(aDataSource),</span>
<a href="#l27.555"></a><span id="l27.555" class="difflineminus">-      mSource(aSource),</span>
<a href="#l27.556"></a><span id="l27.556" class="difflineminus">-      mTarget(aTarget),</span>
<a href="#l27.557"></a><span id="l27.557" class="difflineminus">-      mCurrent(nullptr),</span>
<a href="#l27.558"></a><span id="l27.558" class="difflineminus">-      mHashArcs(nullptr)</span>
<a href="#l27.559"></a><span id="l27.559" class="difflineminus">-{</span>
<a href="#l27.560"></a><span id="l27.560" class="difflineminus">-    NS_ADDREF(mDataSource);</span>
<a href="#l27.561"></a><span id="l27.561" class="difflineminus">-    NS_IF_ADDREF(mSource);</span>
<a href="#l27.562"></a><span id="l27.562" class="difflineminus">-    NS_IF_ADDREF(mTarget);</span>
<a href="#l27.563"></a><span id="l27.563" class="difflineminus">-</span>
<a href="#l27.564"></a><span id="l27.564" class="difflineminus">-    if (mSource) {</span>
<a href="#l27.565"></a><span id="l27.565" class="difflineminus">-        // cast okay because it's a closed system</span>
<a href="#l27.566"></a><span id="l27.566" class="difflineminus">-        mAssertion = mDataSource-&gt;GetForwardArcs(mSource);</span>
<a href="#l27.567"></a><span id="l27.567" class="difflineminus">-</span>
<a href="#l27.568"></a><span id="l27.568" class="difflineminus">-        if (mAssertion &amp;&amp; mAssertion-&gt;mHashEntry) {</span>
<a href="#l27.569"></a><span id="l27.569" class="difflineminus">-            // its our magical HASH_ENTRY forward hash for assertions</span>
<a href="#l27.570"></a><span id="l27.570" class="difflineminus">-            mHashArcs = new nsCOMArray&lt;nsIRDFNode&gt;();</span>
<a href="#l27.571"></a><span id="l27.571" class="difflineminus">-            for (auto i = mAssertion-&gt;u.hash.mPropertyHash-&gt;Iter();</span>
<a href="#l27.572"></a><span id="l27.572" class="difflineminus">-                 !i.Done();</span>
<a href="#l27.573"></a><span id="l27.573" class="difflineminus">-                 i.Next()) {</span>
<a href="#l27.574"></a><span id="l27.574" class="difflineminus">-                auto entry = static_cast&lt;Entry*&gt;(i.Get());</span>
<a href="#l27.575"></a><span id="l27.575" class="difflineminus">-                mHashArcs-&gt;AppendElement(entry-&gt;mNode);</span>
<a href="#l27.576"></a><span id="l27.576" class="difflineminus">-            }</span>
<a href="#l27.577"></a><span id="l27.577" class="difflineminus">-            mAssertion = nullptr;</span>
<a href="#l27.578"></a><span id="l27.578" class="difflineminus">-        }</span>
<a href="#l27.579"></a><span id="l27.579" class="difflineminus">-    }</span>
<a href="#l27.580"></a><span id="l27.580" class="difflineminus">-    else {</span>
<a href="#l27.581"></a><span id="l27.581" class="difflineminus">-        mAssertion = mDataSource-&gt;GetReverseArcs(mTarget);</span>
<a href="#l27.582"></a><span id="l27.582" class="difflineminus">-    }</span>
<a href="#l27.583"></a><span id="l27.583" class="difflineminus">-}</span>
<a href="#l27.584"></a><span id="l27.584" class="difflineminus">-</span>
<a href="#l27.585"></a><span id="l27.585" class="difflineminus">-InMemoryArcsEnumeratorImpl::~InMemoryArcsEnumeratorImpl()</span>
<a href="#l27.586"></a><span id="l27.586" class="difflineminus">-{</span>
<a href="#l27.587"></a><span id="l27.587" class="difflineminus">-#ifdef DEBUG_REFS</span>
<a href="#l27.588"></a><span id="l27.588" class="difflineminus">-    --gInstanceCount;</span>
<a href="#l27.589"></a><span id="l27.589" class="difflineminus">-    fprintf(stdout, &quot;%d - RDF: InMemoryArcsEnumeratorImpl\n&quot;, gInstanceCount);</span>
<a href="#l27.590"></a><span id="l27.590" class="difflineminus">-#endif</span>
<a href="#l27.591"></a><span id="l27.591" class="difflineminus">-</span>
<a href="#l27.592"></a><span id="l27.592" class="difflineminus">-    NS_RELEASE(mDataSource);</span>
<a href="#l27.593"></a><span id="l27.593" class="difflineminus">-    NS_IF_RELEASE(mSource);</span>
<a href="#l27.594"></a><span id="l27.594" class="difflineminus">-    NS_IF_RELEASE(mTarget);</span>
<a href="#l27.595"></a><span id="l27.595" class="difflineminus">-    NS_IF_RELEASE(mCurrent);</span>
<a href="#l27.596"></a><span id="l27.596" class="difflineminus">-    delete mHashArcs;</span>
<a href="#l27.597"></a><span id="l27.597" class="difflineminus">-}</span>
<a href="#l27.598"></a><span id="l27.598" class="difflineminus">-</span>
<a href="#l27.599"></a><span id="l27.599" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l27.600"></a><span id="l27.600" class="difflineminus">-InMemoryArcsEnumeratorImpl::HasMoreElements(bool* aResult)</span>
<a href="#l27.601"></a><span id="l27.601" class="difflineminus">-{</span>
<a href="#l27.602"></a><span id="l27.602" class="difflineminus">-    NS_ASSERTION(aResult != nullptr, &quot;null ptr&quot;);</span>
<a href="#l27.603"></a><span id="l27.603" class="difflineminus">-    if (! aResult)</span>
<a href="#l27.604"></a><span id="l27.604" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l27.605"></a><span id="l27.605" class="difflineminus">-</span>
<a href="#l27.606"></a><span id="l27.606" class="difflineminus">-    if (mCurrent) {</span>
<a href="#l27.607"></a><span id="l27.607" class="difflineminus">-        *aResult = true;</span>
<a href="#l27.608"></a><span id="l27.608" class="difflineminus">-        return NS_OK;</span>
<a href="#l27.609"></a><span id="l27.609" class="difflineminus">-    }</span>
<a href="#l27.610"></a><span id="l27.610" class="difflineminus">-</span>
<a href="#l27.611"></a><span id="l27.611" class="difflineminus">-    if (mHashArcs) {</span>
<a href="#l27.612"></a><span id="l27.612" class="difflineminus">-        if (!mHashArcs-&gt;IsEmpty()) {</span>
<a href="#l27.613"></a><span id="l27.613" class="difflineminus">-            const uint32_t last = mHashArcs-&gt;Length() - 1;</span>
<a href="#l27.614"></a><span id="l27.614" class="difflineminus">-            nsCOMPtr&lt;nsIRDFResource&gt; tmp(do_QueryInterface(mHashArcs-&gt;ObjectAt(last)));</span>
<a href="#l27.615"></a><span id="l27.615" class="difflineminus">-            tmp.forget(&amp;mCurrent);</span>
<a href="#l27.616"></a><span id="l27.616" class="difflineminus">-            mHashArcs-&gt;RemoveElementAt(last);</span>
<a href="#l27.617"></a><span id="l27.617" class="difflineminus">-            *aResult = true;</span>
<a href="#l27.618"></a><span id="l27.618" class="difflineminus">-            return NS_OK;</span>
<a href="#l27.619"></a><span id="l27.619" class="difflineminus">-        }</span>
<a href="#l27.620"></a><span id="l27.620" class="difflineminus">-    }</span>
<a href="#l27.621"></a><span id="l27.621" class="difflineminus">-    else</span>
<a href="#l27.622"></a><span id="l27.622" class="difflineminus">-        while (mAssertion) {</span>
<a href="#l27.623"></a><span id="l27.623" class="difflineminus">-            nsIRDFResource* next = mAssertion-&gt;u.as.mProperty;</span>
<a href="#l27.624"></a><span id="l27.624" class="difflineminus">-</span>
<a href="#l27.625"></a><span id="l27.625" class="difflineminus">-            // &quot;next&quot; is the property arc we are tentatively going to return</span>
<a href="#l27.626"></a><span id="l27.626" class="difflineminus">-            // in a subsequent GetNext() call.  It is important to do two</span>
<a href="#l27.627"></a><span id="l27.627" class="difflineminus">-            // things, however, before that can happen:</span>
<a href="#l27.628"></a><span id="l27.628" class="difflineminus">-            //   1) Make sure it's not an arc we've already returned.</span>
<a href="#l27.629"></a><span id="l27.629" class="difflineminus">-            //   2) Make sure that |mAssertion| is not left pointing to</span>
<a href="#l27.630"></a><span id="l27.630" class="difflineminus">-            //      another assertion that has the same property as this one.</span>
<a href="#l27.631"></a><span id="l27.631" class="difflineminus">-            // The first is a practical concern; the second a defense against</span>
<a href="#l27.632"></a><span id="l27.632" class="difflineminus">-            // an obscure crash and other erratic behavior.  To ensure the</span>
<a href="#l27.633"></a><span id="l27.633" class="difflineminus">-            // second condition, skip down the chain until we find the next</span>
<a href="#l27.634"></a><span id="l27.634" class="difflineminus">-            // assertion with a property that doesn't match the current one.</span>
<a href="#l27.635"></a><span id="l27.635" class="difflineminus">-            // (All these assertions would be skipped via mAlreadyReturned</span>
<a href="#l27.636"></a><span id="l27.636" class="difflineminus">-            // checks anyways; this is even a bit faster.)</span>
<a href="#l27.637"></a><span id="l27.637" class="difflineminus">-</span>
<a href="#l27.638"></a><span id="l27.638" class="difflineminus">-            do {</span>
<a href="#l27.639"></a><span id="l27.639" class="difflineminus">-                mAssertion = (mSource ? mAssertion-&gt;mNext :</span>
<a href="#l27.640"></a><span id="l27.640" class="difflineminus">-                        mAssertion-&gt;u.as.mInvNext);</span>
<a href="#l27.641"></a><span id="l27.641" class="difflineminus">-            }</span>
<a href="#l27.642"></a><span id="l27.642" class="difflineminus">-            while (mAssertion &amp;&amp; (next == mAssertion-&gt;u.as.mProperty));</span>
<a href="#l27.643"></a><span id="l27.643" class="difflineminus">-</span>
<a href="#l27.644"></a><span id="l27.644" class="difflineminus">-            bool alreadyReturned = false;</span>
<a href="#l27.645"></a><span id="l27.645" class="difflineminus">-            for (int32_t i = mAlreadyReturned.Length() - 1; i &gt;= 0; --i) {</span>
<a href="#l27.646"></a><span id="l27.646" class="difflineminus">-                if (mAlreadyReturned[i] == next) {</span>
<a href="#l27.647"></a><span id="l27.647" class="difflineminus">-                    alreadyReturned = true;</span>
<a href="#l27.648"></a><span id="l27.648" class="difflineminus">-                    break;</span>
<a href="#l27.649"></a><span id="l27.649" class="difflineminus">-                }</span>
<a href="#l27.650"></a><span id="l27.650" class="difflineminus">-            }</span>
<a href="#l27.651"></a><span id="l27.651" class="difflineminus">-</span>
<a href="#l27.652"></a><span id="l27.652" class="difflineminus">-            if (! alreadyReturned) {</span>
<a href="#l27.653"></a><span id="l27.653" class="difflineminus">-                mCurrent = next;</span>
<a href="#l27.654"></a><span id="l27.654" class="difflineminus">-                NS_ADDREF(mCurrent);</span>
<a href="#l27.655"></a><span id="l27.655" class="difflineminus">-                *aResult = true;</span>
<a href="#l27.656"></a><span id="l27.656" class="difflineminus">-                return NS_OK;</span>
<a href="#l27.657"></a><span id="l27.657" class="difflineminus">-            }</span>
<a href="#l27.658"></a><span id="l27.658" class="difflineminus">-        }</span>
<a href="#l27.659"></a><span id="l27.659" class="difflineminus">-</span>
<a href="#l27.660"></a><span id="l27.660" class="difflineminus">-    *aResult = false;</span>
<a href="#l27.661"></a><span id="l27.661" class="difflineminus">-    return NS_OK;</span>
<a href="#l27.662"></a><span id="l27.662" class="difflineminus">-}</span>
<a href="#l27.663"></a><span id="l27.663" class="difflineminus">-</span>
<a href="#l27.664"></a><span id="l27.664" class="difflineminus">-</span>
<a href="#l27.665"></a><span id="l27.665" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l27.666"></a><span id="l27.666" class="difflineminus">-InMemoryArcsEnumeratorImpl::GetNext(nsISupports** aResult)</span>
<a href="#l27.667"></a><span id="l27.667" class="difflineminus">-{</span>
<a href="#l27.668"></a><span id="l27.668" class="difflineminus">-    nsresult rv;</span>
<a href="#l27.669"></a><span id="l27.669" class="difflineminus">-</span>
<a href="#l27.670"></a><span id="l27.670" class="difflineminus">-    bool hasMore;</span>
<a href="#l27.671"></a><span id="l27.671" class="difflineminus">-    rv = HasMoreElements(&amp;hasMore);</span>
<a href="#l27.672"></a><span id="l27.672" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l27.673"></a><span id="l27.673" class="difflineminus">-</span>
<a href="#l27.674"></a><span id="l27.674" class="difflineminus">-    if (! hasMore)</span>
<a href="#l27.675"></a><span id="l27.675" class="difflineminus">-        return NS_ERROR_UNEXPECTED;</span>
<a href="#l27.676"></a><span id="l27.676" class="difflineminus">-</span>
<a href="#l27.677"></a><span id="l27.677" class="difflineminus">-    // Add this to the set of things we've already returned so that we</span>
<a href="#l27.678"></a><span id="l27.678" class="difflineminus">-    // can ensure uniqueness</span>
<a href="#l27.679"></a><span id="l27.679" class="difflineminus">-    mAlreadyReturned.AppendElement(mCurrent);</span>
<a href="#l27.680"></a><span id="l27.680" class="difflineminus">-</span>
<a href="#l27.681"></a><span id="l27.681" class="difflineminus">-    // Don't AddRef: we &quot;transfer&quot; ownership to the caller</span>
<a href="#l27.682"></a><span id="l27.682" class="difflineminus">-    *aResult = mCurrent;</span>
<a href="#l27.683"></a><span id="l27.683" class="difflineminus">-    mCurrent = nullptr;</span>
<a href="#l27.684"></a><span id="l27.684" class="difflineminus">-</span>
<a href="#l27.685"></a><span id="l27.685" class="difflineminus">-    return NS_OK;</span>
<a href="#l27.686"></a><span id="l27.686" class="difflineminus">-}</span>
<a href="#l27.687"></a><span id="l27.687" class="difflineminus">-</span>
<a href="#l27.688"></a><span id="l27.688" class="difflineminus">-</span>
<a href="#l27.689"></a><span id="l27.689" class="difflineminus">-////////////////////////////////////////////////////////////////////////</span>
<a href="#l27.690"></a><span id="l27.690" class="difflineminus">-// InMemoryDataSource</span>
<a href="#l27.691"></a><span id="l27.691" class="difflineminus">-</span>
<a href="#l27.692"></a><span id="l27.692" class="difflineminus">-nsresult</span>
<a href="#l27.693"></a><span id="l27.693" class="difflineminus">-NS_NewRDFInMemoryDataSource(nsISupports* aOuter, const nsIID&amp; aIID, void** aResult)</span>
<a href="#l27.694"></a><span id="l27.694" class="difflineminus">-{</span>
<a href="#l27.695"></a><span id="l27.695" class="difflineminus">-    NS_ASSERTION(aResult != nullptr, &quot;null ptr&quot;);</span>
<a href="#l27.696"></a><span id="l27.696" class="difflineminus">-    if (! aResult)</span>
<a href="#l27.697"></a><span id="l27.697" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l27.698"></a><span id="l27.698" class="difflineminus">-    *aResult = nullptr;</span>
<a href="#l27.699"></a><span id="l27.699" class="difflineminus">-</span>
<a href="#l27.700"></a><span id="l27.700" class="difflineminus">-    if (aOuter &amp;&amp; !aIID.Equals(NS_GET_IID(nsISupports))) {</span>
<a href="#l27.701"></a><span id="l27.701" class="difflineminus">-        NS_ERROR(&quot;aggregation requires nsISupports&quot;);</span>
<a href="#l27.702"></a><span id="l27.702" class="difflineminus">-        return NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l27.703"></a><span id="l27.703" class="difflineminus">-    }</span>
<a href="#l27.704"></a><span id="l27.704" class="difflineminus">-</span>
<a href="#l27.705"></a><span id="l27.705" class="difflineminus">-    InMemoryDataSource* datasource = new InMemoryDataSource(aOuter);</span>
<a href="#l27.706"></a><span id="l27.706" class="difflineminus">-    NS_ADDREF(datasource);</span>
<a href="#l27.707"></a><span id="l27.707" class="difflineminus">-</span>
<a href="#l27.708"></a><span id="l27.708" class="difflineminus">-    datasource-&gt;fAggregated.AddRef();</span>
<a href="#l27.709"></a><span id="l27.709" class="difflineminus">-    nsresult rv = datasource-&gt;AggregatedQueryInterface(aIID, aResult); // This'll AddRef()</span>
<a href="#l27.710"></a><span id="l27.710" class="difflineminus">-    datasource-&gt;fAggregated.Release();</span>
<a href="#l27.711"></a><span id="l27.711" class="difflineminus">-</span>
<a href="#l27.712"></a><span id="l27.712" class="difflineminus">-    NS_RELEASE(datasource);</span>
<a href="#l27.713"></a><span id="l27.713" class="difflineminus">-    return rv;</span>
<a href="#l27.714"></a><span id="l27.714" class="difflineminus">-}</span>
<a href="#l27.715"></a><span id="l27.715" class="difflineminus">-</span>
<a href="#l27.716"></a><span id="l27.716" class="difflineminus">-</span>
<a href="#l27.717"></a><span id="l27.717" class="difflineminus">-InMemoryDataSource::InMemoryDataSource(nsISupports* aOuter)</span>
<a href="#l27.718"></a><span id="l27.718" class="difflineminus">-    : mForwardArcs(PLDHashTable::StubOps(), sizeof(Entry))</span>
<a href="#l27.719"></a><span id="l27.719" class="difflineminus">-    , mReverseArcs(PLDHashTable::StubOps(), sizeof(Entry))</span>
<a href="#l27.720"></a><span id="l27.720" class="difflineminus">-    , mNumObservers(0)</span>
<a href="#l27.721"></a><span id="l27.721" class="difflineminus">-    , mReadCount(0)</span>
<a href="#l27.722"></a><span id="l27.722" class="difflineminus">-{</span>
<a href="#l27.723"></a><span id="l27.723" class="difflineminus">-    NS_INIT_AGGREGATED(aOuter);</span>
<a href="#l27.724"></a><span id="l27.724" class="difflineminus">-</span>
<a href="#l27.725"></a><span id="l27.725" class="difflineminus">-    mPropagateChanges = true;</span>
<a href="#l27.726"></a><span id="l27.726" class="difflineminus">-}</span>
<a href="#l27.727"></a><span id="l27.727" class="difflineminus">-</span>
<a href="#l27.728"></a><span id="l27.728" class="difflineminus">-</span>
<a href="#l27.729"></a><span id="l27.729" class="difflineminus">-InMemoryDataSource::~InMemoryDataSource()</span>
<a href="#l27.730"></a><span id="l27.730" class="difflineminus">-{</span>
<a href="#l27.731"></a><span id="l27.731" class="difflineminus">-#ifdef DEBUG_REFS</span>
<a href="#l27.732"></a><span id="l27.732" class="difflineminus">-    --gInstanceCount;</span>
<a href="#l27.733"></a><span id="l27.733" class="difflineminus">-    fprintf(stdout, &quot;%d - RDF: InMemoryDataSource\n&quot;, gInstanceCount);</span>
<a href="#l27.734"></a><span id="l27.734" class="difflineminus">-#endif</span>
<a href="#l27.735"></a><span id="l27.735" class="difflineminus">-</span>
<a href="#l27.736"></a><span id="l27.736" class="difflineminus">-    if (mForwardArcs.EntryCount() &gt; 0) {</span>
<a href="#l27.737"></a><span id="l27.737" class="difflineminus">-        // This'll release all of the Assertion objects that are</span>
<a href="#l27.738"></a><span id="l27.738" class="difflineminus">-        // associated with this data source. We only need to do this</span>
<a href="#l27.739"></a><span id="l27.739" class="difflineminus">-        // for the forward arcs, because the reverse arcs table</span>
<a href="#l27.740"></a><span id="l27.740" class="difflineminus">-        // indexes the exact same set of resources.</span>
<a href="#l27.741"></a><span id="l27.741" class="difflineminus">-        for (auto iter = mForwardArcs.Iter(); !iter.Done(); iter.Next()) {</span>
<a href="#l27.742"></a><span id="l27.742" class="difflineminus">-            auto entry = static_cast&lt;Entry*&gt;(iter.Get());</span>
<a href="#l27.743"></a><span id="l27.743" class="difflineminus">-            Assertion* as = entry-&gt;mAssertions;</span>
<a href="#l27.744"></a><span id="l27.744" class="difflineminus">-            while (as) {</span>
<a href="#l27.745"></a><span id="l27.745" class="difflineminus">-                Assertion* doomed = as;</span>
<a href="#l27.746"></a><span id="l27.746" class="difflineminus">-                as = as-&gt;mNext;</span>
<a href="#l27.747"></a><span id="l27.747" class="difflineminus">-</span>
<a href="#l27.748"></a><span id="l27.748" class="difflineminus">-                // Unlink, and release the datasource's reference.</span>
<a href="#l27.749"></a><span id="l27.749" class="difflineminus">-                doomed-&gt;mNext = doomed-&gt;u.as.mInvNext = nullptr;</span>
<a href="#l27.750"></a><span id="l27.750" class="difflineminus">-                doomed-&gt;Release();</span>
<a href="#l27.751"></a><span id="l27.751" class="difflineminus">-            }</span>
<a href="#l27.752"></a><span id="l27.752" class="difflineminus">-        }</span>
<a href="#l27.753"></a><span id="l27.753" class="difflineminus">-    }</span>
<a href="#l27.754"></a><span id="l27.754" class="difflineminus">-</span>
<a href="#l27.755"></a><span id="l27.755" class="difflineminus">-    MOZ_LOG(gLog, LogLevel::Debug,</span>
<a href="#l27.756"></a><span id="l27.756" class="difflineminus">-           (&quot;InMemoryDataSource(%p): destroyed.&quot;, this));</span>
<a href="#l27.757"></a><span id="l27.757" class="difflineminus">-}</span>
<a href="#l27.758"></a><span id="l27.758" class="difflineminus">-</span>
<a href="#l27.759"></a><span id="l27.759" class="difflineminus">-</span>
<a href="#l27.760"></a><span id="l27.760" class="difflineminus">-////////////////////////////////////////////////////////////////////////</span>
<a href="#l27.761"></a><span id="l27.761" class="difflineminus">-</span>
<a href="#l27.762"></a><span id="l27.762" class="difflineminus">-NS_IMPL_CYCLE_COLLECTION_CLASS(InMemoryDataSource)</span>
<a href="#l27.763"></a><span id="l27.763" class="difflineminus">-</span>
<a href="#l27.764"></a><span id="l27.764" class="difflineminus">-NS_IMPL_CYCLE_COLLECTION_UNLINK_BEGIN(InMemoryDataSource)</span>
<a href="#l27.765"></a><span id="l27.765" class="difflineminus">-    NS_IMPL_CYCLE_COLLECTION_UNLINK(mObservers)</span>
<a href="#l27.766"></a><span id="l27.766" class="difflineminus">-NS_IMPL_CYCLE_COLLECTION_UNLINK_END</span>
<a href="#l27.767"></a><span id="l27.767" class="difflineminus">-NS_IMPL_CYCLE_COLLECTION_TRAVERSE_BEGIN_AGGREGATED(InMemoryDataSource)</span>
<a href="#l27.768"></a><span id="l27.768" class="difflineminus">-    NS_IMPL_CYCLE_COLLECTION_TRAVERSE(mObservers)</span>
<a href="#l27.769"></a><span id="l27.769" class="difflineminus">-NS_IMPL_CYCLE_COLLECTION_TRAVERSE_END</span>
<a href="#l27.770"></a><span id="l27.770" class="difflineminus">-</span>
<a href="#l27.771"></a><span id="l27.771" class="difflineminus">-NS_IMPL_CYCLE_COLLECTING_AGGREGATED(InMemoryDataSource)</span>
<a href="#l27.772"></a><span id="l27.772" class="difflineminus">-NS_INTERFACE_MAP_BEGIN_AGGREGATED(InMemoryDataSource)</span>
<a href="#l27.773"></a><span id="l27.773" class="difflineminus">-    NS_INTERFACE_MAP_ENTRIES_CYCLE_COLLECTION_AGGREGATED(InMemoryDataSource)</span>
<a href="#l27.774"></a><span id="l27.774" class="difflineminus">-    NS_INTERFACE_MAP_ENTRY(nsIRDFDataSource)</span>
<a href="#l27.775"></a><span id="l27.775" class="difflineminus">-    NS_INTERFACE_MAP_ENTRY(nsIRDFInMemoryDataSource)</span>
<a href="#l27.776"></a><span id="l27.776" class="difflineminus">-    NS_INTERFACE_MAP_ENTRY(nsIRDFPropagatableDataSource)</span>
<a href="#l27.777"></a><span id="l27.777" class="difflineminus">-    NS_INTERFACE_MAP_ENTRY(nsIRDFPurgeableDataSource)</span>
<a href="#l27.778"></a><span id="l27.778" class="difflineminus">-    NS_INTERFACE_MAP_ENTRY(rdfIDataSource)</span>
<a href="#l27.779"></a><span id="l27.779" class="difflineminus">-NS_INTERFACE_MAP_END</span>
<a href="#l27.780"></a><span id="l27.780" class="difflineminus">-</span>
<a href="#l27.781"></a><span id="l27.781" class="difflineminus">-////////////////////////////////////////////////////////////////////////</span>
<a href="#l27.782"></a><span id="l27.782" class="difflineminus">-</span>
<a href="#l27.783"></a><span id="l27.783" class="difflineminus">-</span>
<a href="#l27.784"></a><span id="l27.784" class="difflineminus">-void</span>
<a href="#l27.785"></a><span id="l27.785" class="difflineminus">-InMemoryDataSource::LogOperation(const char* aOperation,</span>
<a href="#l27.786"></a><span id="l27.786" class="difflineminus">-                                 nsIRDFResource* aSource,</span>
<a href="#l27.787"></a><span id="l27.787" class="difflineminus">-                                 nsIRDFResource* aProperty,</span>
<a href="#l27.788"></a><span id="l27.788" class="difflineminus">-                                 nsIRDFNode* aTarget,</span>
<a href="#l27.789"></a><span id="l27.789" class="difflineminus">-                                 bool aTruthValue)</span>
<a href="#l27.790"></a><span id="l27.790" class="difflineminus">-{</span>
<a href="#l27.791"></a><span id="l27.791" class="difflineminus">-    if (! MOZ_LOG_TEST(gLog, LogLevel::Debug))</span>
<a href="#l27.792"></a><span id="l27.792" class="difflineminus">-        return;</span>
<a href="#l27.793"></a><span id="l27.793" class="difflineminus">-</span>
<a href="#l27.794"></a><span id="l27.794" class="difflineminus">-    nsCString uri;</span>
<a href="#l27.795"></a><span id="l27.795" class="difflineminus">-    aSource-&gt;GetValue(getter_Copies(uri));</span>
<a href="#l27.796"></a><span id="l27.796" class="difflineminus">-    MOZ_LOG(gLog, LogLevel::Debug,</span>
<a href="#l27.797"></a><span id="l27.797" class="difflineminus">-           (&quot;InMemoryDataSource(%p): %s&quot;, this, aOperation));</span>
<a href="#l27.798"></a><span id="l27.798" class="difflineminus">-</span>
<a href="#l27.799"></a><span id="l27.799" class="difflineminus">-    MOZ_LOG(gLog, LogLevel::Debug,</span>
<a href="#l27.800"></a><span id="l27.800" class="difflineminus">-           (&quot;  [(%p)%s]--&quot;, aSource, uri.get()));</span>
<a href="#l27.801"></a><span id="l27.801" class="difflineminus">-</span>
<a href="#l27.802"></a><span id="l27.802" class="difflineminus">-    aProperty-&gt;GetValue(getter_Copies(uri));</span>
<a href="#l27.803"></a><span id="l27.803" class="difflineminus">-</span>
<a href="#l27.804"></a><span id="l27.804" class="difflineminus">-    char tv = (aTruthValue ? '-' : '!');</span>
<a href="#l27.805"></a><span id="l27.805" class="difflineminus">-    MOZ_LOG(gLog, LogLevel::Debug,</span>
<a href="#l27.806"></a><span id="l27.806" class="difflineminus">-           (&quot;  --%c[(%p)%s]--&quot;, tv, aProperty, uri.get()));</span>
<a href="#l27.807"></a><span id="l27.807" class="difflineminus">-</span>
<a href="#l27.808"></a><span id="l27.808" class="difflineminus">-    nsCOMPtr&lt;nsIRDFResource&gt; resource;</span>
<a href="#l27.809"></a><span id="l27.809" class="difflineminus">-    nsCOMPtr&lt;nsIRDFLiteral&gt; literal;</span>
<a href="#l27.810"></a><span id="l27.810" class="difflineminus">-</span>
<a href="#l27.811"></a><span id="l27.811" class="difflineminus">-    if ((resource = do_QueryInterface(aTarget)) != nullptr) {</span>
<a href="#l27.812"></a><span id="l27.812" class="difflineminus">-        resource-&gt;GetValue(getter_Copies(uri));</span>
<a href="#l27.813"></a><span id="l27.813" class="difflineminus">-        MOZ_LOG(gLog, LogLevel::Debug,</span>
<a href="#l27.814"></a><span id="l27.814" class="difflineminus">-           (&quot;  --&gt;[(%p)%s]&quot;, aTarget, uri.get()));</span>
<a href="#l27.815"></a><span id="l27.815" class="difflineminus">-    }</span>
<a href="#l27.816"></a><span id="l27.816" class="difflineminus">-    else if ((literal = do_QueryInterface(aTarget)) != nullptr) {</span>
<a href="#l27.817"></a><span id="l27.817" class="difflineminus">-        nsString value;</span>
<a href="#l27.818"></a><span id="l27.818" class="difflineminus">-        literal-&gt;GetValue(getter_Copies(value));</span>
<a href="#l27.819"></a><span id="l27.819" class="difflineminus">-        MOZ_LOG(gLog, LogLevel::Debug,</span>
<a href="#l27.820"></a><span id="l27.820" class="difflineminus">-           (&quot;  --&gt;(\&quot;%s\&quot;)\n&quot;, NS_ConvertUTF16toUTF8(value).get()));</span>
<a href="#l27.821"></a><span id="l27.821" class="difflineminus">-    }</span>
<a href="#l27.822"></a><span id="l27.822" class="difflineminus">-    else {</span>
<a href="#l27.823"></a><span id="l27.823" class="difflineminus">-        MOZ_LOG(gLog, LogLevel::Debug,</span>
<a href="#l27.824"></a><span id="l27.824" class="difflineminus">-           (&quot;  --&gt;(unknown-type)\n&quot;));</span>
<a href="#l27.825"></a><span id="l27.825" class="difflineminus">-    }</span>
<a href="#l27.826"></a><span id="l27.826" class="difflineminus">-}</span>
<a href="#l27.827"></a><span id="l27.827" class="difflineminus">-</span>
<a href="#l27.828"></a><span id="l27.828" class="difflineminus">-</span>
<a href="#l27.829"></a><span id="l27.829" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l27.830"></a><span id="l27.830" class="difflineminus">-InMemoryDataSource::GetURI(nsACString&amp; aURI)</span>
<a href="#l27.831"></a><span id="l27.831" class="difflineminus">-{</span>
<a href="#l27.832"></a><span id="l27.832" class="difflineminus">-    aURI.SetIsVoid(true);</span>
<a href="#l27.833"></a><span id="l27.833" class="difflineminus">-    return NS_OK;</span>
<a href="#l27.834"></a><span id="l27.834" class="difflineminus">-}</span>
<a href="#l27.835"></a><span id="l27.835" class="difflineminus">-</span>
<a href="#l27.836"></a><span id="l27.836" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l27.837"></a><span id="l27.837" class="difflineminus">-InMemoryDataSource::GetSource(nsIRDFResource* property,</span>
<a href="#l27.838"></a><span id="l27.838" class="difflineminus">-                              nsIRDFNode* target,</span>
<a href="#l27.839"></a><span id="l27.839" class="difflineminus">-                              bool tv,</span>
<a href="#l27.840"></a><span id="l27.840" class="difflineminus">-                              nsIRDFResource** source)</span>
<a href="#l27.841"></a><span id="l27.841" class="difflineminus">-{</span>
<a href="#l27.842"></a><span id="l27.842" class="difflineminus">-    NS_ASSERTION(source != nullptr, &quot;null ptr&quot;);</span>
<a href="#l27.843"></a><span id="l27.843" class="difflineminus">-    if (! source)</span>
<a href="#l27.844"></a><span id="l27.844" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l27.845"></a><span id="l27.845" class="difflineminus">-</span>
<a href="#l27.846"></a><span id="l27.846" class="difflineminus">-    NS_ASSERTION(property != nullptr, &quot;null ptr&quot;);</span>
<a href="#l27.847"></a><span id="l27.847" class="difflineminus">-    if (! property)</span>
<a href="#l27.848"></a><span id="l27.848" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l27.849"></a><span id="l27.849" class="difflineminus">-</span>
<a href="#l27.850"></a><span id="l27.850" class="difflineminus">-    NS_ASSERTION(target != nullptr, &quot;null ptr&quot;);</span>
<a href="#l27.851"></a><span id="l27.851" class="difflineminus">-    if (! target)</span>
<a href="#l27.852"></a><span id="l27.852" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l27.853"></a><span id="l27.853" class="difflineminus">-</span>
<a href="#l27.854"></a><span id="l27.854" class="difflineminus">-    for (Assertion* as = GetReverseArcs(target); as; as = as-&gt;u.as.mInvNext) {</span>
<a href="#l27.855"></a><span id="l27.855" class="difflineminus">-        if ((property == as-&gt;u.as.mProperty) &amp;&amp; (tv == as-&gt;u.as.mTruthValue)) {</span>
<a href="#l27.856"></a><span id="l27.856" class="difflineminus">-            *source = as-&gt;mSource;</span>
<a href="#l27.857"></a><span id="l27.857" class="difflineminus">-            NS_ADDREF(*source);</span>
<a href="#l27.858"></a><span id="l27.858" class="difflineminus">-            return NS_OK;</span>
<a href="#l27.859"></a><span id="l27.859" class="difflineminus">-        }</span>
<a href="#l27.860"></a><span id="l27.860" class="difflineminus">-    }</span>
<a href="#l27.861"></a><span id="l27.861" class="difflineminus">-    *source = nullptr;</span>
<a href="#l27.862"></a><span id="l27.862" class="difflineminus">-    return NS_RDF_NO_VALUE;</span>
<a href="#l27.863"></a><span id="l27.863" class="difflineminus">-}</span>
<a href="#l27.864"></a><span id="l27.864" class="difflineminus">-</span>
<a href="#l27.865"></a><span id="l27.865" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l27.866"></a><span id="l27.866" class="difflineminus">-InMemoryDataSource::GetTarget(nsIRDFResource* source,</span>
<a href="#l27.867"></a><span id="l27.867" class="difflineminus">-                              nsIRDFResource* property,</span>
<a href="#l27.868"></a><span id="l27.868" class="difflineminus">-                              bool tv,</span>
<a href="#l27.869"></a><span id="l27.869" class="difflineminus">-                              nsIRDFNode** target)</span>
<a href="#l27.870"></a><span id="l27.870" class="difflineminus">-{</span>
<a href="#l27.871"></a><span id="l27.871" class="difflineminus">-    NS_ASSERTION(source != nullptr, &quot;null ptr&quot;);</span>
<a href="#l27.872"></a><span id="l27.872" class="difflineminus">-    if (! source)</span>
<a href="#l27.873"></a><span id="l27.873" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l27.874"></a><span id="l27.874" class="difflineminus">-</span>
<a href="#l27.875"></a><span id="l27.875" class="difflineminus">-    NS_ASSERTION(property != nullptr, &quot;null ptr&quot;);</span>
<a href="#l27.876"></a><span id="l27.876" class="difflineminus">-    if (! property)</span>
<a href="#l27.877"></a><span id="l27.877" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l27.878"></a><span id="l27.878" class="difflineminus">-</span>
<a href="#l27.879"></a><span id="l27.879" class="difflineminus">-    NS_ASSERTION(target != nullptr, &quot;null ptr&quot;);</span>
<a href="#l27.880"></a><span id="l27.880" class="difflineminus">-    if (! target)</span>
<a href="#l27.881"></a><span id="l27.881" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l27.882"></a><span id="l27.882" class="difflineminus">-</span>
<a href="#l27.883"></a><span id="l27.883" class="difflineminus">-    Assertion *as = GetForwardArcs(source);</span>
<a href="#l27.884"></a><span id="l27.884" class="difflineminus">-    if (as &amp;&amp; as-&gt;mHashEntry) {</span>
<a href="#l27.885"></a><span id="l27.885" class="difflineminus">-        PLDHashEntryHdr* hdr = as-&gt;u.hash.mPropertyHash-&gt;Search(property);</span>
<a href="#l27.886"></a><span id="l27.886" class="difflineminus">-        Assertion* val = hdr ? static_cast&lt;Entry*&gt;(hdr)-&gt;mAssertions : nullptr;</span>
<a href="#l27.887"></a><span id="l27.887" class="difflineminus">-        while (val) {</span>
<a href="#l27.888"></a><span id="l27.888" class="difflineminus">-            if (tv == val-&gt;u.as.mTruthValue) {</span>
<a href="#l27.889"></a><span id="l27.889" class="difflineminus">-                *target = val-&gt;u.as.mTarget;</span>
<a href="#l27.890"></a><span id="l27.890" class="difflineminus">-                NS_IF_ADDREF(*target);</span>
<a href="#l27.891"></a><span id="l27.891" class="difflineminus">-                return NS_OK;</span>
<a href="#l27.892"></a><span id="l27.892" class="difflineminus">-            }</span>
<a href="#l27.893"></a><span id="l27.893" class="difflineminus">-            val = val-&gt;mNext;</span>
<a href="#l27.894"></a><span id="l27.894" class="difflineminus">-        }</span>
<a href="#l27.895"></a><span id="l27.895" class="difflineminus">-    }</span>
<a href="#l27.896"></a><span id="l27.896" class="difflineminus">-    else</span>
<a href="#l27.897"></a><span id="l27.897" class="difflineminus">-    for (; as != nullptr; as = as-&gt;mNext) {</span>
<a href="#l27.898"></a><span id="l27.898" class="difflineminus">-        if ((property == as-&gt;u.as.mProperty) &amp;&amp; (tv == (as-&gt;u.as.mTruthValue))) {</span>
<a href="#l27.899"></a><span id="l27.899" class="difflineminus">-            *target = as-&gt;u.as.mTarget;</span>
<a href="#l27.900"></a><span id="l27.900" class="difflineminus">-            NS_ADDREF(*target);</span>
<a href="#l27.901"></a><span id="l27.901" class="difflineminus">-            return NS_OK;</span>
<a href="#l27.902"></a><span id="l27.902" class="difflineminus">-        }</span>
<a href="#l27.903"></a><span id="l27.903" class="difflineminus">-    }</span>
<a href="#l27.904"></a><span id="l27.904" class="difflineminus">-</span>
<a href="#l27.905"></a><span id="l27.905" class="difflineminus">-    // If we get here, then there was no target with for the specified</span>
<a href="#l27.906"></a><span id="l27.906" class="difflineminus">-    // property &amp; truth value.</span>
<a href="#l27.907"></a><span id="l27.907" class="difflineminus">-    *target = nullptr;</span>
<a href="#l27.908"></a><span id="l27.908" class="difflineminus">-    return NS_RDF_NO_VALUE;</span>
<a href="#l27.909"></a><span id="l27.909" class="difflineminus">-}</span>
<a href="#l27.910"></a><span id="l27.910" class="difflineminus">-</span>
<a href="#l27.911"></a><span id="l27.911" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l27.912"></a><span id="l27.912" class="difflineminus">-InMemoryDataSource::HasAssertion(nsIRDFResource* source,</span>
<a href="#l27.913"></a><span id="l27.913" class="difflineminus">-                                 nsIRDFResource* property,</span>
<a href="#l27.914"></a><span id="l27.914" class="difflineminus">-                                 nsIRDFNode* target,</span>
<a href="#l27.915"></a><span id="l27.915" class="difflineminus">-                                 bool tv,</span>
<a href="#l27.916"></a><span id="l27.916" class="difflineminus">-                                 bool* hasAssertion)</span>
<a href="#l27.917"></a><span id="l27.917" class="difflineminus">-{</span>
<a href="#l27.918"></a><span id="l27.918" class="difflineminus">-    if (! source)</span>
<a href="#l27.919"></a><span id="l27.919" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l27.920"></a><span id="l27.920" class="difflineminus">-</span>
<a href="#l27.921"></a><span id="l27.921" class="difflineminus">-    if (! property)</span>
<a href="#l27.922"></a><span id="l27.922" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l27.923"></a><span id="l27.923" class="difflineminus">-</span>
<a href="#l27.924"></a><span id="l27.924" class="difflineminus">-    if (! target)</span>
<a href="#l27.925"></a><span id="l27.925" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l27.926"></a><span id="l27.926" class="difflineminus">-</span>
<a href="#l27.927"></a><span id="l27.927" class="difflineminus">-    Assertion *as = GetForwardArcs(source);</span>
<a href="#l27.928"></a><span id="l27.928" class="difflineminus">-    if (as &amp;&amp; as-&gt;mHashEntry) {</span>
<a href="#l27.929"></a><span id="l27.929" class="difflineminus">-        PLDHashEntryHdr* hdr = as-&gt;u.hash.mPropertyHash-&gt;Search(property);</span>
<a href="#l27.930"></a><span id="l27.930" class="difflineminus">-        Assertion* val = hdr ? static_cast&lt;Entry*&gt;(hdr)-&gt;mAssertions : nullptr;</span>
<a href="#l27.931"></a><span id="l27.931" class="difflineminus">-        while (val) {</span>
<a href="#l27.932"></a><span id="l27.932" class="difflineminus">-            if ((val-&gt;u.as.mTarget == target) &amp;&amp; (tv == (val-&gt;u.as.mTruthValue))) {</span>
<a href="#l27.933"></a><span id="l27.933" class="difflineminus">-                *hasAssertion = true;</span>
<a href="#l27.934"></a><span id="l27.934" class="difflineminus">-                return NS_OK;</span>
<a href="#l27.935"></a><span id="l27.935" class="difflineminus">-            }</span>
<a href="#l27.936"></a><span id="l27.936" class="difflineminus">-            val = val-&gt;mNext;</span>
<a href="#l27.937"></a><span id="l27.937" class="difflineminus">-        }</span>
<a href="#l27.938"></a><span id="l27.938" class="difflineminus">-    }</span>
<a href="#l27.939"></a><span id="l27.939" class="difflineminus">-    else</span>
<a href="#l27.940"></a><span id="l27.940" class="difflineminus">-    for (; as != nullptr; as = as-&gt;mNext) {</span>
<a href="#l27.941"></a><span id="l27.941" class="difflineminus">-        // check target first as its most unique</span>
<a href="#l27.942"></a><span id="l27.942" class="difflineminus">-        if (target != as-&gt;u.as.mTarget)</span>
<a href="#l27.943"></a><span id="l27.943" class="difflineminus">-            continue;</span>
<a href="#l27.944"></a><span id="l27.944" class="difflineminus">-</span>
<a href="#l27.945"></a><span id="l27.945" class="difflineminus">-        if (property != as-&gt;u.as.mProperty)</span>
<a href="#l27.946"></a><span id="l27.946" class="difflineminus">-            continue;</span>
<a href="#l27.947"></a><span id="l27.947" class="difflineminus">-</span>
<a href="#l27.948"></a><span id="l27.948" class="difflineminus">-        if (tv != (as-&gt;u.as.mTruthValue))</span>
<a href="#l27.949"></a><span id="l27.949" class="difflineminus">-            continue;</span>
<a href="#l27.950"></a><span id="l27.950" class="difflineminus">-</span>
<a href="#l27.951"></a><span id="l27.951" class="difflineminus">-        // found it!</span>
<a href="#l27.952"></a><span id="l27.952" class="difflineminus">-        *hasAssertion = true;</span>
<a href="#l27.953"></a><span id="l27.953" class="difflineminus">-        return NS_OK;</span>
<a href="#l27.954"></a><span id="l27.954" class="difflineminus">-    }</span>
<a href="#l27.955"></a><span id="l27.955" class="difflineminus">-</span>
<a href="#l27.956"></a><span id="l27.956" class="difflineminus">-    // If we get here, we couldn't find the assertion</span>
<a href="#l27.957"></a><span id="l27.957" class="difflineminus">-    *hasAssertion = false;</span>
<a href="#l27.958"></a><span id="l27.958" class="difflineminus">-    return NS_OK;</span>
<a href="#l27.959"></a><span id="l27.959" class="difflineminus">-}</span>
<a href="#l27.960"></a><span id="l27.960" class="difflineminus">-</span>
<a href="#l27.961"></a><span id="l27.961" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l27.962"></a><span id="l27.962" class="difflineminus">-InMemoryDataSource::GetSources(nsIRDFResource* aProperty,</span>
<a href="#l27.963"></a><span id="l27.963" class="difflineminus">-                               nsIRDFNode* aTarget,</span>
<a href="#l27.964"></a><span id="l27.964" class="difflineminus">-                               bool aTruthValue,</span>
<a href="#l27.965"></a><span id="l27.965" class="difflineminus">-                               nsISimpleEnumerator** aResult)</span>
<a href="#l27.966"></a><span id="l27.966" class="difflineminus">-{</span>
<a href="#l27.967"></a><span id="l27.967" class="difflineminus">-    NS_ASSERTION(aProperty != nullptr, &quot;null ptr&quot;);</span>
<a href="#l27.968"></a><span id="l27.968" class="difflineminus">-    if (! aProperty)</span>
<a href="#l27.969"></a><span id="l27.969" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l27.970"></a><span id="l27.970" class="difflineminus">-</span>
<a href="#l27.971"></a><span id="l27.971" class="difflineminus">-    NS_ASSERTION(aTarget != nullptr, &quot;null ptr&quot;);</span>
<a href="#l27.972"></a><span id="l27.972" class="difflineminus">-    if (! aTarget)</span>
<a href="#l27.973"></a><span id="l27.973" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l27.974"></a><span id="l27.974" class="difflineminus">-</span>
<a href="#l27.975"></a><span id="l27.975" class="difflineminus">-    NS_ASSERTION(aResult != nullptr, &quot;null ptr&quot;);</span>
<a href="#l27.976"></a><span id="l27.976" class="difflineminus">-    if (! aResult)</span>
<a href="#l27.977"></a><span id="l27.977" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l27.978"></a><span id="l27.978" class="difflineminus">-</span>
<a href="#l27.979"></a><span id="l27.979" class="difflineminus">-    InMemoryAssertionEnumeratorImpl* result =</span>
<a href="#l27.980"></a><span id="l27.980" class="difflineminus">-        new InMemoryAssertionEnumeratorImpl(this, nullptr, aProperty,</span>
<a href="#l27.981"></a><span id="l27.981" class="difflineminus">-                                            aTarget, aTruthValue);</span>
<a href="#l27.982"></a><span id="l27.982" class="difflineminus">-</span>
<a href="#l27.983"></a><span id="l27.983" class="difflineminus">-    if (! result)</span>
<a href="#l27.984"></a><span id="l27.984" class="difflineminus">-        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l27.985"></a><span id="l27.985" class="difflineminus">-</span>
<a href="#l27.986"></a><span id="l27.986" class="difflineminus">-    NS_ADDREF(result);</span>
<a href="#l27.987"></a><span id="l27.987" class="difflineminus">-    *aResult = result;</span>
<a href="#l27.988"></a><span id="l27.988" class="difflineminus">-</span>
<a href="#l27.989"></a><span id="l27.989" class="difflineminus">-    return NS_OK;</span>
<a href="#l27.990"></a><span id="l27.990" class="difflineminus">-}</span>
<a href="#l27.991"></a><span id="l27.991" class="difflineminus">-</span>
<a href="#l27.992"></a><span id="l27.992" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l27.993"></a><span id="l27.993" class="difflineminus">-InMemoryDataSource::GetTargets(nsIRDFResource* aSource,</span>
<a href="#l27.994"></a><span id="l27.994" class="difflineminus">-                               nsIRDFResource* aProperty,</span>
<a href="#l27.995"></a><span id="l27.995" class="difflineminus">-                               bool aTruthValue,</span>
<a href="#l27.996"></a><span id="l27.996" class="difflineminus">-                               nsISimpleEnumerator** aResult)</span>
<a href="#l27.997"></a><span id="l27.997" class="difflineminus">-{</span>
<a href="#l27.998"></a><span id="l27.998" class="difflineminus">-    NS_ASSERTION(aSource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l27.999"></a><span id="l27.999" class="difflineminus">-    if (! aSource)</span>
<a href="#l27.1000"></a><span id="l27.1000" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l27.1001"></a><span id="l27.1001" class="difflineminus">-</span>
<a href="#l27.1002"></a><span id="l27.1002" class="difflineminus">-    NS_ASSERTION(aProperty != nullptr, &quot;null ptr&quot;);</span>
<a href="#l27.1003"></a><span id="l27.1003" class="difflineminus">-    if (! aProperty)</span>
<a href="#l27.1004"></a><span id="l27.1004" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l27.1005"></a><span id="l27.1005" class="difflineminus">-</span>
<a href="#l27.1006"></a><span id="l27.1006" class="difflineminus">-    NS_ASSERTION(aResult != nullptr, &quot;null ptr&quot;);</span>
<a href="#l27.1007"></a><span id="l27.1007" class="difflineminus">-    if (! aResult)</span>
<a href="#l27.1008"></a><span id="l27.1008" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l27.1009"></a><span id="l27.1009" class="difflineminus">-</span>
<a href="#l27.1010"></a><span id="l27.1010" class="difflineminus">-    InMemoryAssertionEnumeratorImpl* result =</span>
<a href="#l27.1011"></a><span id="l27.1011" class="difflineminus">-        new InMemoryAssertionEnumeratorImpl(this, aSource, aProperty,</span>
<a href="#l27.1012"></a><span id="l27.1012" class="difflineminus">-                                            nullptr, aTruthValue);</span>
<a href="#l27.1013"></a><span id="l27.1013" class="difflineminus">-</span>
<a href="#l27.1014"></a><span id="l27.1014" class="difflineminus">-    if (! result)</span>
<a href="#l27.1015"></a><span id="l27.1015" class="difflineminus">-        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l27.1016"></a><span id="l27.1016" class="difflineminus">-</span>
<a href="#l27.1017"></a><span id="l27.1017" class="difflineminus">-    NS_ADDREF(result);</span>
<a href="#l27.1018"></a><span id="l27.1018" class="difflineminus">-    *aResult = result;</span>
<a href="#l27.1019"></a><span id="l27.1019" class="difflineminus">-</span>
<a href="#l27.1020"></a><span id="l27.1020" class="difflineminus">-    return NS_OK;</span>
<a href="#l27.1021"></a><span id="l27.1021" class="difflineminus">-}</span>
<a href="#l27.1022"></a><span id="l27.1022" class="difflineminus">-</span>
<a href="#l27.1023"></a><span id="l27.1023" class="difflineminus">-</span>
<a href="#l27.1024"></a><span id="l27.1024" class="difflineminus">-nsresult</span>
<a href="#l27.1025"></a><span id="l27.1025" class="difflineminus">-InMemoryDataSource::LockedAssert(nsIRDFResource* aSource,</span>
<a href="#l27.1026"></a><span id="l27.1026" class="difflineminus">-                                 nsIRDFResource* aProperty,</span>
<a href="#l27.1027"></a><span id="l27.1027" class="difflineminus">-                                 nsIRDFNode* aTarget,</span>
<a href="#l27.1028"></a><span id="l27.1028" class="difflineminus">-                                 bool aTruthValue)</span>
<a href="#l27.1029"></a><span id="l27.1029" class="difflineminus">-{</span>
<a href="#l27.1030"></a><span id="l27.1030" class="difflineminus">-    LogOperation(&quot;ASSERT&quot;, aSource, aProperty, aTarget, aTruthValue);</span>
<a href="#l27.1031"></a><span id="l27.1031" class="difflineminus">-</span>
<a href="#l27.1032"></a><span id="l27.1032" class="difflineminus">-    Assertion* next = GetForwardArcs(aSource);</span>
<a href="#l27.1033"></a><span id="l27.1033" class="difflineminus">-    Assertion* prev = next;</span>
<a href="#l27.1034"></a><span id="l27.1034" class="difflineminus">-    Assertion* as = nullptr;</span>
<a href="#l27.1035"></a><span id="l27.1035" class="difflineminus">-</span>
<a href="#l27.1036"></a><span id="l27.1036" class="difflineminus">-    bool    haveHash = (next) ? next-&gt;mHashEntry : false;</span>
<a href="#l27.1037"></a><span id="l27.1037" class="difflineminus">-    if (haveHash) {</span>
<a href="#l27.1038"></a><span id="l27.1038" class="difflineminus">-        PLDHashEntryHdr* hdr = next-&gt;u.hash.mPropertyHash-&gt;Search(aProperty);</span>
<a href="#l27.1039"></a><span id="l27.1039" class="difflineminus">-        Assertion* val = hdr ? static_cast&lt;Entry*&gt;(hdr)-&gt;mAssertions : nullptr;</span>
<a href="#l27.1040"></a><span id="l27.1040" class="difflineminus">-        while (val) {</span>
<a href="#l27.1041"></a><span id="l27.1041" class="difflineminus">-            if (val-&gt;u.as.mTarget == aTarget) {</span>
<a href="#l27.1042"></a><span id="l27.1042" class="difflineminus">-                // Wow, we already had the assertion. Make sure that the</span>
<a href="#l27.1043"></a><span id="l27.1043" class="difflineminus">-                // truth values are correct and bail.</span>
<a href="#l27.1044"></a><span id="l27.1044" class="difflineminus">-                val-&gt;u.as.mTruthValue = aTruthValue;</span>
<a href="#l27.1045"></a><span id="l27.1045" class="difflineminus">-                return NS_OK;</span>
<a href="#l27.1046"></a><span id="l27.1046" class="difflineminus">-            }</span>
<a href="#l27.1047"></a><span id="l27.1047" class="difflineminus">-            val = val-&gt;mNext;</span>
<a href="#l27.1048"></a><span id="l27.1048" class="difflineminus">-        }</span>
<a href="#l27.1049"></a><span id="l27.1049" class="difflineminus">-    }</span>
<a href="#l27.1050"></a><span id="l27.1050" class="difflineminus">-    else</span>
<a href="#l27.1051"></a><span id="l27.1051" class="difflineminus">-    {</span>
<a href="#l27.1052"></a><span id="l27.1052" class="difflineminus">-        while (next) {</span>
<a href="#l27.1053"></a><span id="l27.1053" class="difflineminus">-            // check target first as its most unique</span>
<a href="#l27.1054"></a><span id="l27.1054" class="difflineminus">-            if (aTarget == next-&gt;u.as.mTarget) {</span>
<a href="#l27.1055"></a><span id="l27.1055" class="difflineminus">-                if (aProperty == next-&gt;u.as.mProperty) {</span>
<a href="#l27.1056"></a><span id="l27.1056" class="difflineminus">-                    // Wow, we already had the assertion. Make sure that the</span>
<a href="#l27.1057"></a><span id="l27.1057" class="difflineminus">-                    // truth values are correct and bail.</span>
<a href="#l27.1058"></a><span id="l27.1058" class="difflineminus">-                    next-&gt;u.as.mTruthValue = aTruthValue;</span>
<a href="#l27.1059"></a><span id="l27.1059" class="difflineminus">-                    return NS_OK;</span>
<a href="#l27.1060"></a><span id="l27.1060" class="difflineminus">-                }</span>
<a href="#l27.1061"></a><span id="l27.1061" class="difflineminus">-            }</span>
<a href="#l27.1062"></a><span id="l27.1062" class="difflineminus">-</span>
<a href="#l27.1063"></a><span id="l27.1063" class="difflineminus">-            prev = next;</span>
<a href="#l27.1064"></a><span id="l27.1064" class="difflineminus">-            next = next-&gt;mNext;</span>
<a href="#l27.1065"></a><span id="l27.1065" class="difflineminus">-        }</span>
<a href="#l27.1066"></a><span id="l27.1066" class="difflineminus">-    }</span>
<a href="#l27.1067"></a><span id="l27.1067" class="difflineminus">-</span>
<a href="#l27.1068"></a><span id="l27.1068" class="difflineminus">-    as = new Assertion(aSource, aProperty, aTarget, aTruthValue);</span>
<a href="#l27.1069"></a><span id="l27.1069" class="difflineminus">-    if (! as)</span>
<a href="#l27.1070"></a><span id="l27.1070" class="difflineminus">-        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l27.1071"></a><span id="l27.1071" class="difflineminus">-</span>
<a href="#l27.1072"></a><span id="l27.1072" class="difflineminus">-    // Add the datasource's owning reference.</span>
<a href="#l27.1073"></a><span id="l27.1073" class="difflineminus">-    as-&gt;AddRef();</span>
<a href="#l27.1074"></a><span id="l27.1074" class="difflineminus">-</span>
<a href="#l27.1075"></a><span id="l27.1075" class="difflineminus">-    if (haveHash)</span>
<a href="#l27.1076"></a><span id="l27.1076" class="difflineminus">-    {</span>
<a href="#l27.1077"></a><span id="l27.1077" class="difflineminus">-        PLDHashEntryHdr* hdr = next-&gt;u.hash.mPropertyHash-&gt;Search(aProperty);</span>
<a href="#l27.1078"></a><span id="l27.1078" class="difflineminus">-        Assertion *asRef =</span>
<a href="#l27.1079"></a><span id="l27.1079" class="difflineminus">-            hdr ? static_cast&lt;Entry*&gt;(hdr)-&gt;mAssertions : nullptr;</span>
<a href="#l27.1080"></a><span id="l27.1080" class="difflineminus">-        if (asRef)</span>
<a href="#l27.1081"></a><span id="l27.1081" class="difflineminus">-        {</span>
<a href="#l27.1082"></a><span id="l27.1082" class="difflineminus">-            as-&gt;mNext = asRef-&gt;mNext;</span>
<a href="#l27.1083"></a><span id="l27.1083" class="difflineminus">-            asRef-&gt;mNext = as;</span>
<a href="#l27.1084"></a><span id="l27.1084" class="difflineminus">-        }</span>
<a href="#l27.1085"></a><span id="l27.1085" class="difflineminus">-        else</span>
<a href="#l27.1086"></a><span id="l27.1086" class="difflineminus">-        {</span>
<a href="#l27.1087"></a><span id="l27.1087" class="difflineminus">-            hdr = next-&gt;u.hash.mPropertyHash-&gt;Add(aProperty, mozilla::fallible);</span>
<a href="#l27.1088"></a><span id="l27.1088" class="difflineminus">-            if (hdr)</span>
<a href="#l27.1089"></a><span id="l27.1089" class="difflineminus">-            {</span>
<a href="#l27.1090"></a><span id="l27.1090" class="difflineminus">-                Entry* entry = static_cast&lt;Entry*&gt;(hdr);</span>
<a href="#l27.1091"></a><span id="l27.1091" class="difflineminus">-                entry-&gt;mNode = aProperty;</span>
<a href="#l27.1092"></a><span id="l27.1092" class="difflineminus">-                entry-&gt;mAssertions = as;</span>
<a href="#l27.1093"></a><span id="l27.1093" class="difflineminus">-            }</span>
<a href="#l27.1094"></a><span id="l27.1094" class="difflineminus">-        }</span>
<a href="#l27.1095"></a><span id="l27.1095" class="difflineminus">-    }</span>
<a href="#l27.1096"></a><span id="l27.1096" class="difflineminus">-    else</span>
<a href="#l27.1097"></a><span id="l27.1097" class="difflineminus">-    {</span>
<a href="#l27.1098"></a><span id="l27.1098" class="difflineminus">-        // Link it in to the &quot;forward arcs&quot; table</span>
<a href="#l27.1099"></a><span id="l27.1099" class="difflineminus">-        if (!prev) {</span>
<a href="#l27.1100"></a><span id="l27.1100" class="difflineminus">-            SetForwardArcs(aSource, as);</span>
<a href="#l27.1101"></a><span id="l27.1101" class="difflineminus">-        } else {</span>
<a href="#l27.1102"></a><span id="l27.1102" class="difflineminus">-            prev-&gt;mNext = as;</span>
<a href="#l27.1103"></a><span id="l27.1103" class="difflineminus">-        }</span>
<a href="#l27.1104"></a><span id="l27.1104" class="difflineminus">-    }</span>
<a href="#l27.1105"></a><span id="l27.1105" class="difflineminus">-</span>
<a href="#l27.1106"></a><span id="l27.1106" class="difflineminus">-    // Link it in to the &quot;reverse arcs&quot; table</span>
<a href="#l27.1107"></a><span id="l27.1107" class="difflineminus">-</span>
<a href="#l27.1108"></a><span id="l27.1108" class="difflineminus">-    next = GetReverseArcs(aTarget);</span>
<a href="#l27.1109"></a><span id="l27.1109" class="difflineminus">-    as-&gt;u.as.mInvNext = next;</span>
<a href="#l27.1110"></a><span id="l27.1110" class="difflineminus">-    next = as;</span>
<a href="#l27.1111"></a><span id="l27.1111" class="difflineminus">-    SetReverseArcs(aTarget, next);</span>
<a href="#l27.1112"></a><span id="l27.1112" class="difflineminus">-</span>
<a href="#l27.1113"></a><span id="l27.1113" class="difflineminus">-    return NS_OK;</span>
<a href="#l27.1114"></a><span id="l27.1114" class="difflineminus">-}</span>
<a href="#l27.1115"></a><span id="l27.1115" class="difflineminus">-</span>
<a href="#l27.1116"></a><span id="l27.1116" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l27.1117"></a><span id="l27.1117" class="difflineminus">-InMemoryDataSource::Assert(nsIRDFResource* aSource,</span>
<a href="#l27.1118"></a><span id="l27.1118" class="difflineminus">-                           nsIRDFResource* aProperty,</span>
<a href="#l27.1119"></a><span id="l27.1119" class="difflineminus">-                           nsIRDFNode* aTarget,</span>
<a href="#l27.1120"></a><span id="l27.1120" class="difflineminus">-                           bool aTruthValue)</span>
<a href="#l27.1121"></a><span id="l27.1121" class="difflineminus">-{</span>
<a href="#l27.1122"></a><span id="l27.1122" class="difflineminus">-    NS_ASSERTION(aSource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l27.1123"></a><span id="l27.1123" class="difflineminus">-    if (! aSource)</span>
<a href="#l27.1124"></a><span id="l27.1124" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l27.1125"></a><span id="l27.1125" class="difflineminus">-</span>
<a href="#l27.1126"></a><span id="l27.1126" class="difflineminus">-    NS_ASSERTION(aProperty != nullptr, &quot;null ptr&quot;);</span>
<a href="#l27.1127"></a><span id="l27.1127" class="difflineminus">-    if (! aProperty)</span>
<a href="#l27.1128"></a><span id="l27.1128" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l27.1129"></a><span id="l27.1129" class="difflineminus">-</span>
<a href="#l27.1130"></a><span id="l27.1130" class="difflineminus">-    NS_ASSERTION(aTarget != nullptr, &quot;null ptr&quot;);</span>
<a href="#l27.1131"></a><span id="l27.1131" class="difflineminus">-    if (! aTarget)</span>
<a href="#l27.1132"></a><span id="l27.1132" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l27.1133"></a><span id="l27.1133" class="difflineminus">-</span>
<a href="#l27.1134"></a><span id="l27.1134" class="difflineminus">-    if (mReadCount) {</span>
<a href="#l27.1135"></a><span id="l27.1135" class="difflineminus">-        NS_WARNING(&quot;Writing to InMemoryDataSource during read\n&quot;);</span>
<a href="#l27.1136"></a><span id="l27.1136" class="difflineminus">-        return NS_RDF_ASSERTION_REJECTED;</span>
<a href="#l27.1137"></a><span id="l27.1137" class="difflineminus">-    }</span>
<a href="#l27.1138"></a><span id="l27.1138" class="difflineminus">-</span>
<a href="#l27.1139"></a><span id="l27.1139" class="difflineminus">-    nsresult rv;</span>
<a href="#l27.1140"></a><span id="l27.1140" class="difflineminus">-    rv = LockedAssert(aSource, aProperty, aTarget, aTruthValue);</span>
<a href="#l27.1141"></a><span id="l27.1141" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l27.1142"></a><span id="l27.1142" class="difflineminus">-</span>
<a href="#l27.1143"></a><span id="l27.1143" class="difflineminus">-    // notify observers</span>
<a href="#l27.1144"></a><span id="l27.1144" class="difflineminus">-    for (int32_t i = (int32_t)mNumObservers - 1; mPropagateChanges &amp;&amp; i &gt;= 0; --i) {</span>
<a href="#l27.1145"></a><span id="l27.1145" class="difflineminus">-        nsIRDFObserver* obs = mObservers[i];</span>
<a href="#l27.1146"></a><span id="l27.1146" class="difflineminus">-</span>
<a href="#l27.1147"></a><span id="l27.1147" class="difflineminus">-        // XXX this should never happen, but it does, and we can't figure out why.</span>
<a href="#l27.1148"></a><span id="l27.1148" class="difflineminus">-        NS_ASSERTION(obs, &quot;observer array corrupted!&quot;);</span>
<a href="#l27.1149"></a><span id="l27.1149" class="difflineminus">-        if (! obs)</span>
<a href="#l27.1150"></a><span id="l27.1150" class="difflineminus">-          continue;</span>
<a href="#l27.1151"></a><span id="l27.1151" class="difflineminus">-</span>
<a href="#l27.1152"></a><span id="l27.1152" class="difflineminus">-        obs-&gt;OnAssert(this, aSource, aProperty, aTarget);</span>
<a href="#l27.1153"></a><span id="l27.1153" class="difflineminus">-        // XXX ignore return value?</span>
<a href="#l27.1154"></a><span id="l27.1154" class="difflineminus">-    }</span>
<a href="#l27.1155"></a><span id="l27.1155" class="difflineminus">-</span>
<a href="#l27.1156"></a><span id="l27.1156" class="difflineminus">-    return NS_RDF_ASSERTION_ACCEPTED;</span>
<a href="#l27.1157"></a><span id="l27.1157" class="difflineminus">-}</span>
<a href="#l27.1158"></a><span id="l27.1158" class="difflineminus">-</span>
<a href="#l27.1159"></a><span id="l27.1159" class="difflineminus">-</span>
<a href="#l27.1160"></a><span id="l27.1160" class="difflineminus">-nsresult</span>
<a href="#l27.1161"></a><span id="l27.1161" class="difflineminus">-InMemoryDataSource::LockedUnassert(nsIRDFResource* aSource,</span>
<a href="#l27.1162"></a><span id="l27.1162" class="difflineminus">-                                   nsIRDFResource* aProperty,</span>
<a href="#l27.1163"></a><span id="l27.1163" class="difflineminus">-                                   nsIRDFNode* aTarget)</span>
<a href="#l27.1164"></a><span id="l27.1164" class="difflineminus">-{</span>
<a href="#l27.1165"></a><span id="l27.1165" class="difflineminus">-    LogOperation(&quot;UNASSERT&quot;, aSource, aProperty, aTarget);</span>
<a href="#l27.1166"></a><span id="l27.1166" class="difflineminus">-</span>
<a href="#l27.1167"></a><span id="l27.1167" class="difflineminus">-    Assertion* next = GetForwardArcs(aSource);</span>
<a href="#l27.1168"></a><span id="l27.1168" class="difflineminus">-    Assertion* prev = next;</span>
<a href="#l27.1169"></a><span id="l27.1169" class="difflineminus">-    Assertion* root = next;</span>
<a href="#l27.1170"></a><span id="l27.1170" class="difflineminus">-    Assertion* as = nullptr;</span>
<a href="#l27.1171"></a><span id="l27.1171" class="difflineminus">-</span>
<a href="#l27.1172"></a><span id="l27.1172" class="difflineminus">-    bool    haveHash = (next) ? next-&gt;mHashEntry : false;</span>
<a href="#l27.1173"></a><span id="l27.1173" class="difflineminus">-    if (haveHash) {</span>
<a href="#l27.1174"></a><span id="l27.1174" class="difflineminus">-        PLDHashEntryHdr* hdr = next-&gt;u.hash.mPropertyHash-&gt;Search(aProperty);</span>
<a href="#l27.1175"></a><span id="l27.1175" class="difflineminus">-        prev = next = hdr ? static_cast&lt;Entry*&gt;(hdr)-&gt;mAssertions : nullptr;</span>
<a href="#l27.1176"></a><span id="l27.1176" class="difflineminus">-        bool first = true;</span>
<a href="#l27.1177"></a><span id="l27.1177" class="difflineminus">-        while (next) {</span>
<a href="#l27.1178"></a><span id="l27.1178" class="difflineminus">-            if (aTarget == next-&gt;u.as.mTarget) {</span>
<a href="#l27.1179"></a><span id="l27.1179" class="difflineminus">-                break;</span>
<a href="#l27.1180"></a><span id="l27.1180" class="difflineminus">-            }</span>
<a href="#l27.1181"></a><span id="l27.1181" class="difflineminus">-            first = false;</span>
<a href="#l27.1182"></a><span id="l27.1182" class="difflineminus">-            prev = next;</span>
<a href="#l27.1183"></a><span id="l27.1183" class="difflineminus">-            next = next-&gt;mNext;</span>
<a href="#l27.1184"></a><span id="l27.1184" class="difflineminus">-        }</span>
<a href="#l27.1185"></a><span id="l27.1185" class="difflineminus">-        // We don't even have the assertion, so just bail.</span>
<a href="#l27.1186"></a><span id="l27.1186" class="difflineminus">-        if (!next)</span>
<a href="#l27.1187"></a><span id="l27.1187" class="difflineminus">-            return NS_OK;</span>
<a href="#l27.1188"></a><span id="l27.1188" class="difflineminus">-</span>
<a href="#l27.1189"></a><span id="l27.1189" class="difflineminus">-        as = next;</span>
<a href="#l27.1190"></a><span id="l27.1190" class="difflineminus">-</span>
<a href="#l27.1191"></a><span id="l27.1191" class="difflineminus">-        if (first) {</span>
<a href="#l27.1192"></a><span id="l27.1192" class="difflineminus">-            root-&gt;u.hash.mPropertyHash-&gt;RawRemove(hdr);</span>
<a href="#l27.1193"></a><span id="l27.1193" class="difflineminus">-</span>
<a href="#l27.1194"></a><span id="l27.1194" class="difflineminus">-            if (next &amp;&amp; next-&gt;mNext) {</span>
<a href="#l27.1195"></a><span id="l27.1195" class="difflineminus">-                PLDHashEntryHdr* hdr =</span>
<a href="#l27.1196"></a><span id="l27.1196" class="difflineminus">-                    root-&gt;u.hash.mPropertyHash-&gt;Add(aProperty,</span>
<a href="#l27.1197"></a><span id="l27.1197" class="difflineminus">-                                                    mozilla::fallible);</span>
<a href="#l27.1198"></a><span id="l27.1198" class="difflineminus">-                if (hdr) {</span>
<a href="#l27.1199"></a><span id="l27.1199" class="difflineminus">-                    Entry* entry = static_cast&lt;Entry*&gt;(hdr);</span>
<a href="#l27.1200"></a><span id="l27.1200" class="difflineminus">-                    entry-&gt;mNode = aProperty;</span>
<a href="#l27.1201"></a><span id="l27.1201" class="difflineminus">-                    entry-&gt;mAssertions = next-&gt;mNext;</span>
<a href="#l27.1202"></a><span id="l27.1202" class="difflineminus">-                }</span>
<a href="#l27.1203"></a><span id="l27.1203" class="difflineminus">-            }</span>
<a href="#l27.1204"></a><span id="l27.1204" class="difflineminus">-            else {</span>
<a href="#l27.1205"></a><span id="l27.1205" class="difflineminus">-                // If this second-level hash empties out, clean it up.</span>
<a href="#l27.1206"></a><span id="l27.1206" class="difflineminus">-                if (!root-&gt;u.hash.mPropertyHash-&gt;EntryCount()) {</span>
<a href="#l27.1207"></a><span id="l27.1207" class="difflineminus">-                    root-&gt;Release();</span>
<a href="#l27.1208"></a><span id="l27.1208" class="difflineminus">-                    SetForwardArcs(aSource, nullptr);</span>
<a href="#l27.1209"></a><span id="l27.1209" class="difflineminus">-                }</span>
<a href="#l27.1210"></a><span id="l27.1210" class="difflineminus">-            }</span>
<a href="#l27.1211"></a><span id="l27.1211" class="difflineminus">-        }</span>
<a href="#l27.1212"></a><span id="l27.1212" class="difflineminus">-        else {</span>
<a href="#l27.1213"></a><span id="l27.1213" class="difflineminus">-            prev-&gt;mNext = next-&gt;mNext;</span>
<a href="#l27.1214"></a><span id="l27.1214" class="difflineminus">-        }</span>
<a href="#l27.1215"></a><span id="l27.1215" class="difflineminus">-    }</span>
<a href="#l27.1216"></a><span id="l27.1216" class="difflineminus">-    else</span>
<a href="#l27.1217"></a><span id="l27.1217" class="difflineminus">-    {</span>
<a href="#l27.1218"></a><span id="l27.1218" class="difflineminus">-        while (next) {</span>
<a href="#l27.1219"></a><span id="l27.1219" class="difflineminus">-            // check target first as its most unique</span>
<a href="#l27.1220"></a><span id="l27.1220" class="difflineminus">-            if (aTarget == next-&gt;u.as.mTarget) {</span>
<a href="#l27.1221"></a><span id="l27.1221" class="difflineminus">-                if (aProperty == next-&gt;u.as.mProperty) {</span>
<a href="#l27.1222"></a><span id="l27.1222" class="difflineminus">-                    if (prev == next) {</span>
<a href="#l27.1223"></a><span id="l27.1223" class="difflineminus">-                        SetForwardArcs(aSource, next-&gt;mNext);</span>
<a href="#l27.1224"></a><span id="l27.1224" class="difflineminus">-                    } else {</span>
<a href="#l27.1225"></a><span id="l27.1225" class="difflineminus">-                        prev-&gt;mNext = next-&gt;mNext;</span>
<a href="#l27.1226"></a><span id="l27.1226" class="difflineminus">-                    }</span>
<a href="#l27.1227"></a><span id="l27.1227" class="difflineminus">-                    as = next;</span>
<a href="#l27.1228"></a><span id="l27.1228" class="difflineminus">-                    break;</span>
<a href="#l27.1229"></a><span id="l27.1229" class="difflineminus">-                }</span>
<a href="#l27.1230"></a><span id="l27.1230" class="difflineminus">-            }</span>
<a href="#l27.1231"></a><span id="l27.1231" class="difflineminus">-</span>
<a href="#l27.1232"></a><span id="l27.1232" class="difflineminus">-            prev = next;</span>
<a href="#l27.1233"></a><span id="l27.1233" class="difflineminus">-            next = next-&gt;mNext;</span>
<a href="#l27.1234"></a><span id="l27.1234" class="difflineminus">-        }</span>
<a href="#l27.1235"></a><span id="l27.1235" class="difflineminus">-    }</span>
<a href="#l27.1236"></a><span id="l27.1236" class="difflineminus">-    // We don't even have the assertion, so just bail.</span>
<a href="#l27.1237"></a><span id="l27.1237" class="difflineminus">-    if (!as)</span>
<a href="#l27.1238"></a><span id="l27.1238" class="difflineminus">-        return NS_OK;</span>
<a href="#l27.1239"></a><span id="l27.1239" class="difflineminus">-</span>
<a href="#l27.1240"></a><span id="l27.1240" class="difflineminus">-#ifdef DEBUG</span>
<a href="#l27.1241"></a><span id="l27.1241" class="difflineminus">-    bool foundReverseArc = false;</span>
<a href="#l27.1242"></a><span id="l27.1242" class="difflineminus">-#endif</span>
<a href="#l27.1243"></a><span id="l27.1243" class="difflineminus">-</span>
<a href="#l27.1244"></a><span id="l27.1244" class="difflineminus">-    next = prev = GetReverseArcs(aTarget);</span>
<a href="#l27.1245"></a><span id="l27.1245" class="difflineminus">-    while (next) {</span>
<a href="#l27.1246"></a><span id="l27.1246" class="difflineminus">-        if (next == as) {</span>
<a href="#l27.1247"></a><span id="l27.1247" class="difflineminus">-            if (prev == next) {</span>
<a href="#l27.1248"></a><span id="l27.1248" class="difflineminus">-                SetReverseArcs(aTarget, next-&gt;u.as.mInvNext);</span>
<a href="#l27.1249"></a><span id="l27.1249" class="difflineminus">-            } else {</span>
<a href="#l27.1250"></a><span id="l27.1250" class="difflineminus">-                prev-&gt;u.as.mInvNext = next-&gt;u.as.mInvNext;</span>
<a href="#l27.1251"></a><span id="l27.1251" class="difflineminus">-            }</span>
<a href="#l27.1252"></a><span id="l27.1252" class="difflineminus">-#ifdef DEBUG</span>
<a href="#l27.1253"></a><span id="l27.1253" class="difflineminus">-            foundReverseArc = true;</span>
<a href="#l27.1254"></a><span id="l27.1254" class="difflineminus">-#endif</span>
<a href="#l27.1255"></a><span id="l27.1255" class="difflineminus">-            break;</span>
<a href="#l27.1256"></a><span id="l27.1256" class="difflineminus">-        }</span>
<a href="#l27.1257"></a><span id="l27.1257" class="difflineminus">-        prev = next;</span>
<a href="#l27.1258"></a><span id="l27.1258" class="difflineminus">-        next = next-&gt;u.as.mInvNext;</span>
<a href="#l27.1259"></a><span id="l27.1259" class="difflineminus">-    }</span>
<a href="#l27.1260"></a><span id="l27.1260" class="difflineminus">-</span>
<a href="#l27.1261"></a><span id="l27.1261" class="difflineminus">-#ifdef DEBUG</span>
<a href="#l27.1262"></a><span id="l27.1262" class="difflineminus">-    NS_ASSERTION(foundReverseArc, &quot;in-memory db corrupted: unable to find reverse arc&quot;);</span>
<a href="#l27.1263"></a><span id="l27.1263" class="difflineminus">-#endif</span>
<a href="#l27.1264"></a><span id="l27.1264" class="difflineminus">-</span>
<a href="#l27.1265"></a><span id="l27.1265" class="difflineminus">-    // Unlink, and release the datasource's reference</span>
<a href="#l27.1266"></a><span id="l27.1266" class="difflineminus">-    as-&gt;mNext = as-&gt;u.as.mInvNext = nullptr;</span>
<a href="#l27.1267"></a><span id="l27.1267" class="difflineminus">-    as-&gt;Release();</span>
<a href="#l27.1268"></a><span id="l27.1268" class="difflineminus">-</span>
<a href="#l27.1269"></a><span id="l27.1269" class="difflineminus">-    return NS_OK;</span>
<a href="#l27.1270"></a><span id="l27.1270" class="difflineminus">-}</span>
<a href="#l27.1271"></a><span id="l27.1271" class="difflineminus">-</span>
<a href="#l27.1272"></a><span id="l27.1272" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l27.1273"></a><span id="l27.1273" class="difflineminus">-InMemoryDataSource::Unassert(nsIRDFResource* aSource,</span>
<a href="#l27.1274"></a><span id="l27.1274" class="difflineminus">-                             nsIRDFResource* aProperty,</span>
<a href="#l27.1275"></a><span id="l27.1275" class="difflineminus">-                             nsIRDFNode* aTarget)</span>
<a href="#l27.1276"></a><span id="l27.1276" class="difflineminus">-{</span>
<a href="#l27.1277"></a><span id="l27.1277" class="difflineminus">-    NS_ASSERTION(aSource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l27.1278"></a><span id="l27.1278" class="difflineminus">-    if (! aSource)</span>
<a href="#l27.1279"></a><span id="l27.1279" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l27.1280"></a><span id="l27.1280" class="difflineminus">-</span>
<a href="#l27.1281"></a><span id="l27.1281" class="difflineminus">-    NS_ASSERTION(aProperty != nullptr, &quot;null ptr&quot;);</span>
<a href="#l27.1282"></a><span id="l27.1282" class="difflineminus">-    if (! aProperty)</span>
<a href="#l27.1283"></a><span id="l27.1283" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l27.1284"></a><span id="l27.1284" class="difflineminus">-</span>
<a href="#l27.1285"></a><span id="l27.1285" class="difflineminus">-    NS_ASSERTION(aTarget != nullptr, &quot;null ptr&quot;);</span>
<a href="#l27.1286"></a><span id="l27.1286" class="difflineminus">-    if (! aTarget)</span>
<a href="#l27.1287"></a><span id="l27.1287" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l27.1288"></a><span id="l27.1288" class="difflineminus">-</span>
<a href="#l27.1289"></a><span id="l27.1289" class="difflineminus">-    if (mReadCount) {</span>
<a href="#l27.1290"></a><span id="l27.1290" class="difflineminus">-        NS_WARNING(&quot;Writing to InMemoryDataSource during read\n&quot;);</span>
<a href="#l27.1291"></a><span id="l27.1291" class="difflineminus">-        return NS_RDF_ASSERTION_REJECTED;</span>
<a href="#l27.1292"></a><span id="l27.1292" class="difflineminus">-    }</span>
<a href="#l27.1293"></a><span id="l27.1293" class="difflineminus">-</span>
<a href="#l27.1294"></a><span id="l27.1294" class="difflineminus">-    nsresult rv;</span>
<a href="#l27.1295"></a><span id="l27.1295" class="difflineminus">-</span>
<a href="#l27.1296"></a><span id="l27.1296" class="difflineminus">-    rv = LockedUnassert(aSource, aProperty, aTarget);</span>
<a href="#l27.1297"></a><span id="l27.1297" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l27.1298"></a><span id="l27.1298" class="difflineminus">-</span>
<a href="#l27.1299"></a><span id="l27.1299" class="difflineminus">-    // Notify the world</span>
<a href="#l27.1300"></a><span id="l27.1300" class="difflineminus">-    for (int32_t i = int32_t(mNumObservers) - 1; mPropagateChanges &amp;&amp; i &gt;= 0; --i) {</span>
<a href="#l27.1301"></a><span id="l27.1301" class="difflineminus">-        nsIRDFObserver* obs = mObservers[i];</span>
<a href="#l27.1302"></a><span id="l27.1302" class="difflineminus">-</span>
<a href="#l27.1303"></a><span id="l27.1303" class="difflineminus">-        // XXX this should never happen, but it does, and we can't figure out why.</span>
<a href="#l27.1304"></a><span id="l27.1304" class="difflineminus">-        NS_ASSERTION(obs, &quot;observer array corrupted!&quot;);</span>
<a href="#l27.1305"></a><span id="l27.1305" class="difflineminus">-        if (! obs)</span>
<a href="#l27.1306"></a><span id="l27.1306" class="difflineminus">-          continue;</span>
<a href="#l27.1307"></a><span id="l27.1307" class="difflineminus">-</span>
<a href="#l27.1308"></a><span id="l27.1308" class="difflineminus">-        obs-&gt;OnUnassert(this, aSource, aProperty, aTarget);</span>
<a href="#l27.1309"></a><span id="l27.1309" class="difflineminus">-        // XXX ignore return value?</span>
<a href="#l27.1310"></a><span id="l27.1310" class="difflineminus">-    }</span>
<a href="#l27.1311"></a><span id="l27.1311" class="difflineminus">-</span>
<a href="#l27.1312"></a><span id="l27.1312" class="difflineminus">-    return NS_RDF_ASSERTION_ACCEPTED;</span>
<a href="#l27.1313"></a><span id="l27.1313" class="difflineminus">-}</span>
<a href="#l27.1314"></a><span id="l27.1314" class="difflineminus">-</span>
<a href="#l27.1315"></a><span id="l27.1315" class="difflineminus">-</span>
<a href="#l27.1316"></a><span id="l27.1316" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l27.1317"></a><span id="l27.1317" class="difflineminus">-InMemoryDataSource::Change(nsIRDFResource* aSource,</span>
<a href="#l27.1318"></a><span id="l27.1318" class="difflineminus">-                           nsIRDFResource* aProperty,</span>
<a href="#l27.1319"></a><span id="l27.1319" class="difflineminus">-                           nsIRDFNode* aOldTarget,</span>
<a href="#l27.1320"></a><span id="l27.1320" class="difflineminus">-                           nsIRDFNode* aNewTarget)</span>
<a href="#l27.1321"></a><span id="l27.1321" class="difflineminus">-{</span>
<a href="#l27.1322"></a><span id="l27.1322" class="difflineminus">-    NS_ASSERTION(aSource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l27.1323"></a><span id="l27.1323" class="difflineminus">-    if (! aSource)</span>
<a href="#l27.1324"></a><span id="l27.1324" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l27.1325"></a><span id="l27.1325" class="difflineminus">-</span>
<a href="#l27.1326"></a><span id="l27.1326" class="difflineminus">-    NS_ASSERTION(aProperty != nullptr, &quot;null ptr&quot;);</span>
<a href="#l27.1327"></a><span id="l27.1327" class="difflineminus">-    if (! aProperty)</span>
<a href="#l27.1328"></a><span id="l27.1328" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l27.1329"></a><span id="l27.1329" class="difflineminus">-</span>
<a href="#l27.1330"></a><span id="l27.1330" class="difflineminus">-    NS_ASSERTION(aOldTarget != nullptr, &quot;null ptr&quot;);</span>
<a href="#l27.1331"></a><span id="l27.1331" class="difflineminus">-    if (! aOldTarget)</span>
<a href="#l27.1332"></a><span id="l27.1332" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l27.1333"></a><span id="l27.1333" class="difflineminus">-</span>
<a href="#l27.1334"></a><span id="l27.1334" class="difflineminus">-    NS_ASSERTION(aNewTarget != nullptr, &quot;null ptr&quot;);</span>
<a href="#l27.1335"></a><span id="l27.1335" class="difflineminus">-    if (! aNewTarget)</span>
<a href="#l27.1336"></a><span id="l27.1336" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l27.1337"></a><span id="l27.1337" class="difflineminus">-</span>
<a href="#l27.1338"></a><span id="l27.1338" class="difflineminus">-    if (mReadCount) {</span>
<a href="#l27.1339"></a><span id="l27.1339" class="difflineminus">-        NS_WARNING(&quot;Writing to InMemoryDataSource during read\n&quot;);</span>
<a href="#l27.1340"></a><span id="l27.1340" class="difflineminus">-        return NS_RDF_ASSERTION_REJECTED;</span>
<a href="#l27.1341"></a><span id="l27.1341" class="difflineminus">-    }</span>
<a href="#l27.1342"></a><span id="l27.1342" class="difflineminus">-</span>
<a href="#l27.1343"></a><span id="l27.1343" class="difflineminus">-    nsresult rv;</span>
<a href="#l27.1344"></a><span id="l27.1344" class="difflineminus">-</span>
<a href="#l27.1345"></a><span id="l27.1345" class="difflineminus">-    // XXX We can implement LockedChange() if we decide that this</span>
<a href="#l27.1346"></a><span id="l27.1346" class="difflineminus">-    // is a performance bottleneck.</span>
<a href="#l27.1347"></a><span id="l27.1347" class="difflineminus">-</span>
<a href="#l27.1348"></a><span id="l27.1348" class="difflineminus">-    rv = LockedUnassert(aSource, aProperty, aOldTarget);</span>
<a href="#l27.1349"></a><span id="l27.1349" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l27.1350"></a><span id="l27.1350" class="difflineminus">-</span>
<a href="#l27.1351"></a><span id="l27.1351" class="difflineminus">-    rv = LockedAssert(aSource, aProperty, aNewTarget, true);</span>
<a href="#l27.1352"></a><span id="l27.1352" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l27.1353"></a><span id="l27.1353" class="difflineminus">-</span>
<a href="#l27.1354"></a><span id="l27.1354" class="difflineminus">-    // Notify the world</span>
<a href="#l27.1355"></a><span id="l27.1355" class="difflineminus">-    for (int32_t i = int32_t(mNumObservers) - 1; mPropagateChanges &amp;&amp; i &gt;= 0; --i) {</span>
<a href="#l27.1356"></a><span id="l27.1356" class="difflineminus">-        nsIRDFObserver* obs = mObservers[i];</span>
<a href="#l27.1357"></a><span id="l27.1357" class="difflineminus">-</span>
<a href="#l27.1358"></a><span id="l27.1358" class="difflineminus">-        // XXX this should never happen, but it does, and we can't figure out why.</span>
<a href="#l27.1359"></a><span id="l27.1359" class="difflineminus">-        NS_ASSERTION(obs, &quot;observer array corrupted!&quot;);</span>
<a href="#l27.1360"></a><span id="l27.1360" class="difflineminus">-        if (! obs)</span>
<a href="#l27.1361"></a><span id="l27.1361" class="difflineminus">-          continue;</span>
<a href="#l27.1362"></a><span id="l27.1362" class="difflineminus">-</span>
<a href="#l27.1363"></a><span id="l27.1363" class="difflineminus">-        obs-&gt;OnChange(this, aSource, aProperty, aOldTarget, aNewTarget);</span>
<a href="#l27.1364"></a><span id="l27.1364" class="difflineminus">-        // XXX ignore return value?</span>
<a href="#l27.1365"></a><span id="l27.1365" class="difflineminus">-    }</span>
<a href="#l27.1366"></a><span id="l27.1366" class="difflineminus">-</span>
<a href="#l27.1367"></a><span id="l27.1367" class="difflineminus">-    return NS_RDF_ASSERTION_ACCEPTED;</span>
<a href="#l27.1368"></a><span id="l27.1368" class="difflineminus">-}</span>
<a href="#l27.1369"></a><span id="l27.1369" class="difflineminus">-</span>
<a href="#l27.1370"></a><span id="l27.1370" class="difflineminus">-</span>
<a href="#l27.1371"></a><span id="l27.1371" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l27.1372"></a><span id="l27.1372" class="difflineminus">-InMemoryDataSource::Move(nsIRDFResource* aOldSource,</span>
<a href="#l27.1373"></a><span id="l27.1373" class="difflineminus">-                         nsIRDFResource* aNewSource,</span>
<a href="#l27.1374"></a><span id="l27.1374" class="difflineminus">-                         nsIRDFResource* aProperty,</span>
<a href="#l27.1375"></a><span id="l27.1375" class="difflineminus">-                         nsIRDFNode* aTarget)</span>
<a href="#l27.1376"></a><span id="l27.1376" class="difflineminus">-{</span>
<a href="#l27.1377"></a><span id="l27.1377" class="difflineminus">-    NS_ASSERTION(aOldSource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l27.1378"></a><span id="l27.1378" class="difflineminus">-    if (! aOldSource)</span>
<a href="#l27.1379"></a><span id="l27.1379" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l27.1380"></a><span id="l27.1380" class="difflineminus">-</span>
<a href="#l27.1381"></a><span id="l27.1381" class="difflineminus">-    NS_ASSERTION(aNewSource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l27.1382"></a><span id="l27.1382" class="difflineminus">-    if (! aNewSource)</span>
<a href="#l27.1383"></a><span id="l27.1383" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l27.1384"></a><span id="l27.1384" class="difflineminus">-</span>
<a href="#l27.1385"></a><span id="l27.1385" class="difflineminus">-    NS_ASSERTION(aProperty != nullptr, &quot;null ptr&quot;);</span>
<a href="#l27.1386"></a><span id="l27.1386" class="difflineminus">-    if (! aProperty)</span>
<a href="#l27.1387"></a><span id="l27.1387" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l27.1388"></a><span id="l27.1388" class="difflineminus">-</span>
<a href="#l27.1389"></a><span id="l27.1389" class="difflineminus">-    NS_ASSERTION(aTarget != nullptr, &quot;null ptr&quot;);</span>
<a href="#l27.1390"></a><span id="l27.1390" class="difflineminus">-    if (! aTarget)</span>
<a href="#l27.1391"></a><span id="l27.1391" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l27.1392"></a><span id="l27.1392" class="difflineminus">-</span>
<a href="#l27.1393"></a><span id="l27.1393" class="difflineminus">-    if (mReadCount) {</span>
<a href="#l27.1394"></a><span id="l27.1394" class="difflineminus">-        NS_WARNING(&quot;Writing to InMemoryDataSource during read\n&quot;);</span>
<a href="#l27.1395"></a><span id="l27.1395" class="difflineminus">-        return NS_RDF_ASSERTION_REJECTED;</span>
<a href="#l27.1396"></a><span id="l27.1396" class="difflineminus">-    }</span>
<a href="#l27.1397"></a><span id="l27.1397" class="difflineminus">-</span>
<a href="#l27.1398"></a><span id="l27.1398" class="difflineminus">-    nsresult rv;</span>
<a href="#l27.1399"></a><span id="l27.1399" class="difflineminus">-</span>
<a href="#l27.1400"></a><span id="l27.1400" class="difflineminus">-    // XXX We can implement LockedMove() if we decide that this</span>
<a href="#l27.1401"></a><span id="l27.1401" class="difflineminus">-    // is a performance bottleneck.</span>
<a href="#l27.1402"></a><span id="l27.1402" class="difflineminus">-</span>
<a href="#l27.1403"></a><span id="l27.1403" class="difflineminus">-    rv = LockedUnassert(aOldSource, aProperty, aTarget);</span>
<a href="#l27.1404"></a><span id="l27.1404" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l27.1405"></a><span id="l27.1405" class="difflineminus">-</span>
<a href="#l27.1406"></a><span id="l27.1406" class="difflineminus">-    rv = LockedAssert(aNewSource, aProperty, aTarget, true);</span>
<a href="#l27.1407"></a><span id="l27.1407" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l27.1408"></a><span id="l27.1408" class="difflineminus">-</span>
<a href="#l27.1409"></a><span id="l27.1409" class="difflineminus">-    // Notify the world</span>
<a href="#l27.1410"></a><span id="l27.1410" class="difflineminus">-    for (int32_t i = int32_t(mNumObservers) - 1; mPropagateChanges &amp;&amp; i &gt;= 0; --i) {</span>
<a href="#l27.1411"></a><span id="l27.1411" class="difflineminus">-        nsIRDFObserver* obs = mObservers[i];</span>
<a href="#l27.1412"></a><span id="l27.1412" class="difflineminus">-</span>
<a href="#l27.1413"></a><span id="l27.1413" class="difflineminus">-        // XXX this should never happen, but it does, and we can't figure out why.</span>
<a href="#l27.1414"></a><span id="l27.1414" class="difflineminus">-        NS_ASSERTION(obs, &quot;observer array corrupted!&quot;);</span>
<a href="#l27.1415"></a><span id="l27.1415" class="difflineminus">-        if (! obs)</span>
<a href="#l27.1416"></a><span id="l27.1416" class="difflineminus">-          continue;</span>
<a href="#l27.1417"></a><span id="l27.1417" class="difflineminus">-</span>
<a href="#l27.1418"></a><span id="l27.1418" class="difflineminus">-        obs-&gt;OnMove(this, aOldSource, aNewSource, aProperty, aTarget);</span>
<a href="#l27.1419"></a><span id="l27.1419" class="difflineminus">-        // XXX ignore return value?</span>
<a href="#l27.1420"></a><span id="l27.1420" class="difflineminus">-    }</span>
<a href="#l27.1421"></a><span id="l27.1421" class="difflineminus">-</span>
<a href="#l27.1422"></a><span id="l27.1422" class="difflineminus">-    return NS_RDF_ASSERTION_ACCEPTED;</span>
<a href="#l27.1423"></a><span id="l27.1423" class="difflineminus">-}</span>
<a href="#l27.1424"></a><span id="l27.1424" class="difflineminus">-</span>
<a href="#l27.1425"></a><span id="l27.1425" class="difflineminus">-</span>
<a href="#l27.1426"></a><span id="l27.1426" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l27.1427"></a><span id="l27.1427" class="difflineminus">-InMemoryDataSource::AddObserver(nsIRDFObserver* aObserver)</span>
<a href="#l27.1428"></a><span id="l27.1428" class="difflineminus">-{</span>
<a href="#l27.1429"></a><span id="l27.1429" class="difflineminus">-    NS_ASSERTION(aObserver != nullptr, &quot;null ptr&quot;);</span>
<a href="#l27.1430"></a><span id="l27.1430" class="difflineminus">-    if (! aObserver)</span>
<a href="#l27.1431"></a><span id="l27.1431" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l27.1432"></a><span id="l27.1432" class="difflineminus">-</span>
<a href="#l27.1433"></a><span id="l27.1433" class="difflineminus">-    mObservers.AppendObject(aObserver);</span>
<a href="#l27.1434"></a><span id="l27.1434" class="difflineminus">-    mNumObservers = mObservers.Count();</span>
<a href="#l27.1435"></a><span id="l27.1435" class="difflineminus">-</span>
<a href="#l27.1436"></a><span id="l27.1436" class="difflineminus">-    return NS_OK;</span>
<a href="#l27.1437"></a><span id="l27.1437" class="difflineminus">-}</span>
<a href="#l27.1438"></a><span id="l27.1438" class="difflineminus">-</span>
<a href="#l27.1439"></a><span id="l27.1439" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l27.1440"></a><span id="l27.1440" class="difflineminus">-InMemoryDataSource::RemoveObserver(nsIRDFObserver* aObserver)</span>
<a href="#l27.1441"></a><span id="l27.1441" class="difflineminus">-{</span>
<a href="#l27.1442"></a><span id="l27.1442" class="difflineminus">-    NS_ASSERTION(aObserver != nullptr, &quot;null ptr&quot;);</span>
<a href="#l27.1443"></a><span id="l27.1443" class="difflineminus">-    if (! aObserver)</span>
<a href="#l27.1444"></a><span id="l27.1444" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l27.1445"></a><span id="l27.1445" class="difflineminus">-</span>
<a href="#l27.1446"></a><span id="l27.1446" class="difflineminus">-    mObservers.RemoveObject(aObserver);</span>
<a href="#l27.1447"></a><span id="l27.1447" class="difflineminus">-    // note: use Count() instead of just decrementing</span>
<a href="#l27.1448"></a><span id="l27.1448" class="difflineminus">-    // in case aObserver wasn't in list, for example</span>
<a href="#l27.1449"></a><span id="l27.1449" class="difflineminus">-    mNumObservers = mObservers.Count();</span>
<a href="#l27.1450"></a><span id="l27.1450" class="difflineminus">-</span>
<a href="#l27.1451"></a><span id="l27.1451" class="difflineminus">-    return NS_OK;</span>
<a href="#l27.1452"></a><span id="l27.1452" class="difflineminus">-}</span>
<a href="#l27.1453"></a><span id="l27.1453" class="difflineminus">-</span>
<a href="#l27.1454"></a><span id="l27.1454" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l27.1455"></a><span id="l27.1455" class="difflineminus">-InMemoryDataSource::HasArcIn(nsIRDFNode *aNode, nsIRDFResource *aArc, bool *result)</span>
<a href="#l27.1456"></a><span id="l27.1456" class="difflineminus">-{</span>
<a href="#l27.1457"></a><span id="l27.1457" class="difflineminus">-    Assertion* ass = GetReverseArcs(aNode);</span>
<a href="#l27.1458"></a><span id="l27.1458" class="difflineminus">-    while (ass) {</span>
<a href="#l27.1459"></a><span id="l27.1459" class="difflineminus">-        nsIRDFResource* elbow = ass-&gt;u.as.mProperty;</span>
<a href="#l27.1460"></a><span id="l27.1460" class="difflineminus">-        if (elbow == aArc) {</span>
<a href="#l27.1461"></a><span id="l27.1461" class="difflineminus">-            *result = true;</span>
<a href="#l27.1462"></a><span id="l27.1462" class="difflineminus">-            return NS_OK;</span>
<a href="#l27.1463"></a><span id="l27.1463" class="difflineminus">-        }</span>
<a href="#l27.1464"></a><span id="l27.1464" class="difflineminus">-        ass = ass-&gt;u.as.mInvNext;</span>
<a href="#l27.1465"></a><span id="l27.1465" class="difflineminus">-    }</span>
<a href="#l27.1466"></a><span id="l27.1466" class="difflineminus">-    *result = false;</span>
<a href="#l27.1467"></a><span id="l27.1467" class="difflineminus">-    return NS_OK;</span>
<a href="#l27.1468"></a><span id="l27.1468" class="difflineminus">-}</span>
<a href="#l27.1469"></a><span id="l27.1469" class="difflineminus">-</span>
<a href="#l27.1470"></a><span id="l27.1470" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l27.1471"></a><span id="l27.1471" class="difflineminus">-InMemoryDataSource::HasArcOut(nsIRDFResource *aSource, nsIRDFResource *aArc, bool *result)</span>
<a href="#l27.1472"></a><span id="l27.1472" class="difflineminus">-{</span>
<a href="#l27.1473"></a><span id="l27.1473" class="difflineminus">-    Assertion* ass = GetForwardArcs(aSource);</span>
<a href="#l27.1474"></a><span id="l27.1474" class="difflineminus">-    if (ass &amp;&amp; ass-&gt;mHashEntry) {</span>
<a href="#l27.1475"></a><span id="l27.1475" class="difflineminus">-        PLDHashEntryHdr* hdr = ass-&gt;u.hash.mPropertyHash-&gt;Search(aArc);</span>
<a href="#l27.1476"></a><span id="l27.1476" class="difflineminus">-        Assertion* val = hdr ? static_cast&lt;Entry*&gt;(hdr)-&gt;mAssertions : nullptr;</span>
<a href="#l27.1477"></a><span id="l27.1477" class="difflineminus">-        if (val) {</span>
<a href="#l27.1478"></a><span id="l27.1478" class="difflineminus">-            *result = true;</span>
<a href="#l27.1479"></a><span id="l27.1479" class="difflineminus">-            return NS_OK;</span>
<a href="#l27.1480"></a><span id="l27.1480" class="difflineminus">-        }</span>
<a href="#l27.1481"></a><span id="l27.1481" class="difflineminus">-        ass = ass-&gt;mNext;</span>
<a href="#l27.1482"></a><span id="l27.1482" class="difflineminus">-    }</span>
<a href="#l27.1483"></a><span id="l27.1483" class="difflineminus">-    while (ass) {</span>
<a href="#l27.1484"></a><span id="l27.1484" class="difflineminus">-        nsIRDFResource* elbow = ass-&gt;u.as.mProperty;</span>
<a href="#l27.1485"></a><span id="l27.1485" class="difflineminus">-        if (elbow == aArc) {</span>
<a href="#l27.1486"></a><span id="l27.1486" class="difflineminus">-            *result = true;</span>
<a href="#l27.1487"></a><span id="l27.1487" class="difflineminus">-            return NS_OK;</span>
<a href="#l27.1488"></a><span id="l27.1488" class="difflineminus">-        }</span>
<a href="#l27.1489"></a><span id="l27.1489" class="difflineminus">-        ass = ass-&gt;mNext;</span>
<a href="#l27.1490"></a><span id="l27.1490" class="difflineminus">-    }</span>
<a href="#l27.1491"></a><span id="l27.1491" class="difflineminus">-    *result = false;</span>
<a href="#l27.1492"></a><span id="l27.1492" class="difflineminus">-    return NS_OK;</span>
<a href="#l27.1493"></a><span id="l27.1493" class="difflineminus">-}</span>
<a href="#l27.1494"></a><span id="l27.1494" class="difflineminus">-</span>
<a href="#l27.1495"></a><span id="l27.1495" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l27.1496"></a><span id="l27.1496" class="difflineminus">-InMemoryDataSource::ArcLabelsIn(nsIRDFNode* aTarget, nsISimpleEnumerator** aResult)</span>
<a href="#l27.1497"></a><span id="l27.1497" class="difflineminus">-{</span>
<a href="#l27.1498"></a><span id="l27.1498" class="difflineminus">-    NS_ASSERTION(aTarget != nullptr, &quot;null ptr&quot;);</span>
<a href="#l27.1499"></a><span id="l27.1499" class="difflineminus">-    if (! aTarget)</span>
<a href="#l27.1500"></a><span id="l27.1500" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l27.1501"></a><span id="l27.1501" class="difflineminus">-</span>
<a href="#l27.1502"></a><span id="l27.1502" class="difflineminus">-    InMemoryArcsEnumeratorImpl* result =</span>
<a href="#l27.1503"></a><span id="l27.1503" class="difflineminus">-        new InMemoryArcsEnumeratorImpl(this, nullptr, aTarget);</span>
<a href="#l27.1504"></a><span id="l27.1504" class="difflineminus">-</span>
<a href="#l27.1505"></a><span id="l27.1505" class="difflineminus">-    if (! result)</span>
<a href="#l27.1506"></a><span id="l27.1506" class="difflineminus">-        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l27.1507"></a><span id="l27.1507" class="difflineminus">-</span>
<a href="#l27.1508"></a><span id="l27.1508" class="difflineminus">-    NS_ADDREF(result);</span>
<a href="#l27.1509"></a><span id="l27.1509" class="difflineminus">-    *aResult = result;</span>
<a href="#l27.1510"></a><span id="l27.1510" class="difflineminus">-</span>
<a href="#l27.1511"></a><span id="l27.1511" class="difflineminus">-    return NS_OK;</span>
<a href="#l27.1512"></a><span id="l27.1512" class="difflineminus">-}</span>
<a href="#l27.1513"></a><span id="l27.1513" class="difflineminus">-</span>
<a href="#l27.1514"></a><span id="l27.1514" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l27.1515"></a><span id="l27.1515" class="difflineminus">-InMemoryDataSource::ArcLabelsOut(nsIRDFResource* aSource, nsISimpleEnumerator** aResult)</span>
<a href="#l27.1516"></a><span id="l27.1516" class="difflineminus">-{</span>
<a href="#l27.1517"></a><span id="l27.1517" class="difflineminus">-    NS_ASSERTION(aSource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l27.1518"></a><span id="l27.1518" class="difflineminus">-    if (! aSource)</span>
<a href="#l27.1519"></a><span id="l27.1519" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l27.1520"></a><span id="l27.1520" class="difflineminus">-</span>
<a href="#l27.1521"></a><span id="l27.1521" class="difflineminus">-    InMemoryArcsEnumeratorImpl* result =</span>
<a href="#l27.1522"></a><span id="l27.1522" class="difflineminus">-        new InMemoryArcsEnumeratorImpl(this, aSource, nullptr);</span>
<a href="#l27.1523"></a><span id="l27.1523" class="difflineminus">-</span>
<a href="#l27.1524"></a><span id="l27.1524" class="difflineminus">-    if (! result)</span>
<a href="#l27.1525"></a><span id="l27.1525" class="difflineminus">-        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l27.1526"></a><span id="l27.1526" class="difflineminus">-</span>
<a href="#l27.1527"></a><span id="l27.1527" class="difflineminus">-    NS_ADDREF(result);</span>
<a href="#l27.1528"></a><span id="l27.1528" class="difflineminus">-    *aResult = result;</span>
<a href="#l27.1529"></a><span id="l27.1529" class="difflineminus">-</span>
<a href="#l27.1530"></a><span id="l27.1530" class="difflineminus">-    return NS_OK;</span>
<a href="#l27.1531"></a><span id="l27.1531" class="difflineminus">-}</span>
<a href="#l27.1532"></a><span id="l27.1532" class="difflineminus">-</span>
<a href="#l27.1533"></a><span id="l27.1533" class="difflineminus">-</span>
<a href="#l27.1534"></a><span id="l27.1534" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l27.1535"></a><span id="l27.1535" class="difflineminus">-InMemoryDataSource::GetAllResources(nsISimpleEnumerator** aResult)</span>
<a href="#l27.1536"></a><span id="l27.1536" class="difflineminus">-{</span>
<a href="#l27.1537"></a><span id="l27.1537" class="difflineminus">-    nsCOMArray&lt;nsIRDFNode&gt; nodes;</span>
<a href="#l27.1538"></a><span id="l27.1538" class="difflineminus">-    nodes.SetCapacity(mForwardArcs.EntryCount());</span>
<a href="#l27.1539"></a><span id="l27.1539" class="difflineminus">-</span>
<a href="#l27.1540"></a><span id="l27.1540" class="difflineminus">-    // Get all of our entries into an nsCOMArray</span>
<a href="#l27.1541"></a><span id="l27.1541" class="difflineminus">-    for (auto iter = mForwardArcs.Iter(); !iter.Done(); iter.Next()) {</span>
<a href="#l27.1542"></a><span id="l27.1542" class="difflineminus">-        auto entry = static_cast&lt;Entry*&gt;(iter.Get());</span>
<a href="#l27.1543"></a><span id="l27.1543" class="difflineminus">-        nodes.AppendObject(entry-&gt;mNode);</span>
<a href="#l27.1544"></a><span id="l27.1544" class="difflineminus">-    }</span>
<a href="#l27.1545"></a><span id="l27.1545" class="difflineminus">-    return NS_NewArrayEnumerator(aResult, nodes);</span>
<a href="#l27.1546"></a><span id="l27.1546" class="difflineminus">-}</span>
<a href="#l27.1547"></a><span id="l27.1547" class="difflineminus">-</span>
<a href="#l27.1548"></a><span id="l27.1548" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l27.1549"></a><span id="l27.1549" class="difflineminus">-InMemoryDataSource::GetAllCmds(nsIRDFResource* source,</span>
<a href="#l27.1550"></a><span id="l27.1550" class="difflineminus">-                               nsISimpleEnumerator/*&lt;nsIRDFResource&gt;*/** commands)</span>
<a href="#l27.1551"></a><span id="l27.1551" class="difflineminus">-{</span>
<a href="#l27.1552"></a><span id="l27.1552" class="difflineminus">-    return(NS_NewEmptyEnumerator(commands));</span>
<a href="#l27.1553"></a><span id="l27.1553" class="difflineminus">-}</span>
<a href="#l27.1554"></a><span id="l27.1554" class="difflineminus">-</span>
<a href="#l27.1555"></a><span id="l27.1555" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l27.1556"></a><span id="l27.1556" class="difflineminus">-InMemoryDataSource::IsCommandEnabled(nsISupports* aSources,</span>
<a href="#l27.1557"></a><span id="l27.1557" class="difflineminus">-                                     nsIRDFResource*   aCommand,</span>
<a href="#l27.1558"></a><span id="l27.1558" class="difflineminus">-                                     nsISupports* aArguments,</span>
<a href="#l27.1559"></a><span id="l27.1559" class="difflineminus">-                                     bool* aResult)</span>
<a href="#l27.1560"></a><span id="l27.1560" class="difflineminus">-{</span>
<a href="#l27.1561"></a><span id="l27.1561" class="difflineminus">-    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l27.1562"></a><span id="l27.1562" class="difflineminus">-}</span>
<a href="#l27.1563"></a><span id="l27.1563" class="difflineminus">-</span>
<a href="#l27.1564"></a><span id="l27.1564" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l27.1565"></a><span id="l27.1565" class="difflineminus">-InMemoryDataSource::DoCommand(nsISupports* aSources,</span>
<a href="#l27.1566"></a><span id="l27.1566" class="difflineminus">-                              nsIRDFResource*   aCommand,</span>
<a href="#l27.1567"></a><span id="l27.1567" class="difflineminus">-                              nsISupports* aArguments)</span>
<a href="#l27.1568"></a><span id="l27.1568" class="difflineminus">-{</span>
<a href="#l27.1569"></a><span id="l27.1569" class="difflineminus">-    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l27.1570"></a><span id="l27.1570" class="difflineminus">-}</span>
<a href="#l27.1571"></a><span id="l27.1571" class="difflineminus">-</span>
<a href="#l27.1572"></a><span id="l27.1572" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l27.1573"></a><span id="l27.1573" class="difflineminus">-InMemoryDataSource::BeginUpdateBatch()</span>
<a href="#l27.1574"></a><span id="l27.1574" class="difflineminus">-{</span>
<a href="#l27.1575"></a><span id="l27.1575" class="difflineminus">-    for (int32_t i = int32_t(mNumObservers) - 1; mPropagateChanges &amp;&amp; i &gt;= 0; --i) {</span>
<a href="#l27.1576"></a><span id="l27.1576" class="difflineminus">-        nsIRDFObserver* obs = mObservers[i];</span>
<a href="#l27.1577"></a><span id="l27.1577" class="difflineminus">-        obs-&gt;OnBeginUpdateBatch(this);</span>
<a href="#l27.1578"></a><span id="l27.1578" class="difflineminus">-    }</span>
<a href="#l27.1579"></a><span id="l27.1579" class="difflineminus">-    return NS_OK;</span>
<a href="#l27.1580"></a><span id="l27.1580" class="difflineminus">-}</span>
<a href="#l27.1581"></a><span id="l27.1581" class="difflineminus">-</span>
<a href="#l27.1582"></a><span id="l27.1582" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l27.1583"></a><span id="l27.1583" class="difflineminus">-InMemoryDataSource::EndUpdateBatch()</span>
<a href="#l27.1584"></a><span id="l27.1584" class="difflineminus">-{</span>
<a href="#l27.1585"></a><span id="l27.1585" class="difflineminus">-    for (int32_t i = int32_t(mNumObservers) - 1; mPropagateChanges &amp;&amp; i &gt;= 0; --i) {</span>
<a href="#l27.1586"></a><span id="l27.1586" class="difflineminus">-        nsIRDFObserver* obs = mObservers[i];</span>
<a href="#l27.1587"></a><span id="l27.1587" class="difflineminus">-        obs-&gt;OnEndUpdateBatch(this);</span>
<a href="#l27.1588"></a><span id="l27.1588" class="difflineminus">-    }</span>
<a href="#l27.1589"></a><span id="l27.1589" class="difflineminus">-    return NS_OK;</span>
<a href="#l27.1590"></a><span id="l27.1590" class="difflineminus">-}</span>
<a href="#l27.1591"></a><span id="l27.1591" class="difflineminus">-</span>
<a href="#l27.1592"></a><span id="l27.1592" class="difflineminus">-</span>
<a href="#l27.1593"></a><span id="l27.1593" class="difflineminus">-</span>
<a href="#l27.1594"></a><span id="l27.1594" class="difflineminus">-////////////////////////////////////////////////////////////////////////</span>
<a href="#l27.1595"></a><span id="l27.1595" class="difflineminus">-// nsIRDFInMemoryDataSource methods</span>
<a href="#l27.1596"></a><span id="l27.1596" class="difflineminus">-</span>
<a href="#l27.1597"></a><span id="l27.1597" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l27.1598"></a><span id="l27.1598" class="difflineminus">-InMemoryDataSource::EnsureFastContainment(nsIRDFResource* aSource)</span>
<a href="#l27.1599"></a><span id="l27.1599" class="difflineminus">-{</span>
<a href="#l27.1600"></a><span id="l27.1600" class="difflineminus">-    Assertion *as = GetForwardArcs(aSource);</span>
<a href="#l27.1601"></a><span id="l27.1601" class="difflineminus">-    bool    haveHash = (as) ? as-&gt;mHashEntry : false;</span>
<a href="#l27.1602"></a><span id="l27.1602" class="difflineminus">-</span>
<a href="#l27.1603"></a><span id="l27.1603" class="difflineminus">-    // if its already a hash, then nothing to do</span>
<a href="#l27.1604"></a><span id="l27.1604" class="difflineminus">-    if (haveHash)   return(NS_OK);</span>
<a href="#l27.1605"></a><span id="l27.1605" class="difflineminus">-</span>
<a href="#l27.1606"></a><span id="l27.1606" class="difflineminus">-    // convert aSource in forward hash into a hash</span>
<a href="#l27.1607"></a><span id="l27.1607" class="difflineminus">-    Assertion *hashAssertion = new Assertion(aSource);</span>
<a href="#l27.1608"></a><span id="l27.1608" class="difflineminus">-    NS_ASSERTION(hashAssertion, &quot;unable to create Assertion&quot;);</span>
<a href="#l27.1609"></a><span id="l27.1609" class="difflineminus">-    if (!hashAssertion) return(NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l27.1610"></a><span id="l27.1610" class="difflineminus">-</span>
<a href="#l27.1611"></a><span id="l27.1611" class="difflineminus">-    // Add the datasource's owning reference.</span>
<a href="#l27.1612"></a><span id="l27.1612" class="difflineminus">-    hashAssertion-&gt;AddRef();</span>
<a href="#l27.1613"></a><span id="l27.1613" class="difflineminus">-</span>
<a href="#l27.1614"></a><span id="l27.1614" class="difflineminus">-    Assertion *first = GetForwardArcs(aSource);</span>
<a href="#l27.1615"></a><span id="l27.1615" class="difflineminus">-    SetForwardArcs(aSource, hashAssertion);</span>
<a href="#l27.1616"></a><span id="l27.1616" class="difflineminus">-</span>
<a href="#l27.1617"></a><span id="l27.1617" class="difflineminus">-    // mutate references of existing forward assertions into this hash</span>
<a href="#l27.1618"></a><span id="l27.1618" class="difflineminus">-    PLDHashTable *table = hashAssertion-&gt;u.hash.mPropertyHash;</span>
<a href="#l27.1619"></a><span id="l27.1619" class="difflineminus">-    Assertion *nextRef;</span>
<a href="#l27.1620"></a><span id="l27.1620" class="difflineminus">-    while(first) {</span>
<a href="#l27.1621"></a><span id="l27.1621" class="difflineminus">-        nextRef = first-&gt;mNext;</span>
<a href="#l27.1622"></a><span id="l27.1622" class="difflineminus">-        nsIRDFResource *prop = first-&gt;u.as.mProperty;</span>
<a href="#l27.1623"></a><span id="l27.1623" class="difflineminus">-</span>
<a href="#l27.1624"></a><span id="l27.1624" class="difflineminus">-        PLDHashEntryHdr* hdr = table-&gt;Search(prop);</span>
<a href="#l27.1625"></a><span id="l27.1625" class="difflineminus">-        Assertion* val = hdr ? static_cast&lt;Entry*&gt;(hdr)-&gt;mAssertions : nullptr;</span>
<a href="#l27.1626"></a><span id="l27.1626" class="difflineminus">-        if (val) {</span>
<a href="#l27.1627"></a><span id="l27.1627" class="difflineminus">-            first-&gt;mNext = val-&gt;mNext;</span>
<a href="#l27.1628"></a><span id="l27.1628" class="difflineminus">-            val-&gt;mNext = first;</span>
<a href="#l27.1629"></a><span id="l27.1629" class="difflineminus">-        }</span>
<a href="#l27.1630"></a><span id="l27.1630" class="difflineminus">-        else {</span>
<a href="#l27.1631"></a><span id="l27.1631" class="difflineminus">-            PLDHashEntryHdr* hdr = table-&gt;Add(prop, mozilla::fallible);</span>
<a href="#l27.1632"></a><span id="l27.1632" class="difflineminus">-            if (hdr) {</span>
<a href="#l27.1633"></a><span id="l27.1633" class="difflineminus">-                Entry* entry = static_cast&lt;Entry*&gt;(hdr);</span>
<a href="#l27.1634"></a><span id="l27.1634" class="difflineminus">-                entry-&gt;mNode = prop;</span>
<a href="#l27.1635"></a><span id="l27.1635" class="difflineminus">-                entry-&gt;mAssertions = first;</span>
<a href="#l27.1636"></a><span id="l27.1636" class="difflineminus">-                first-&gt;mNext = nullptr;</span>
<a href="#l27.1637"></a><span id="l27.1637" class="difflineminus">-            }</span>
<a href="#l27.1638"></a><span id="l27.1638" class="difflineminus">-        }</span>
<a href="#l27.1639"></a><span id="l27.1639" class="difflineminus">-        first = nextRef;</span>
<a href="#l27.1640"></a><span id="l27.1640" class="difflineminus">-    }</span>
<a href="#l27.1641"></a><span id="l27.1641" class="difflineminus">-    return(NS_OK);</span>
<a href="#l27.1642"></a><span id="l27.1642" class="difflineminus">-}</span>
<a href="#l27.1643"></a><span id="l27.1643" class="difflineminus">-</span>
<a href="#l27.1644"></a><span id="l27.1644" class="difflineminus">-</span>
<a href="#l27.1645"></a><span id="l27.1645" class="difflineminus">-////////////////////////////////////////////////////////////////////////</span>
<a href="#l27.1646"></a><span id="l27.1646" class="difflineminus">-// nsIRDFPropagatableDataSource methods</span>
<a href="#l27.1647"></a><span id="l27.1647" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l27.1648"></a><span id="l27.1648" class="difflineminus">-InMemoryDataSource::GetPropagateChanges(bool* aPropagateChanges)</span>
<a href="#l27.1649"></a><span id="l27.1649" class="difflineminus">-{</span>
<a href="#l27.1650"></a><span id="l27.1650" class="difflineminus">-    *aPropagateChanges = mPropagateChanges;</span>
<a href="#l27.1651"></a><span id="l27.1651" class="difflineminus">-    return NS_OK;</span>
<a href="#l27.1652"></a><span id="l27.1652" class="difflineminus">-}</span>
<a href="#l27.1653"></a><span id="l27.1653" class="difflineminus">-</span>
<a href="#l27.1654"></a><span id="l27.1654" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l27.1655"></a><span id="l27.1655" class="difflineminus">-InMemoryDataSource::SetPropagateChanges(bool aPropagateChanges)</span>
<a href="#l27.1656"></a><span id="l27.1656" class="difflineminus">-{</span>
<a href="#l27.1657"></a><span id="l27.1657" class="difflineminus">-    mPropagateChanges = aPropagateChanges;</span>
<a href="#l27.1658"></a><span id="l27.1658" class="difflineminus">-    return NS_OK;</span>
<a href="#l27.1659"></a><span id="l27.1659" class="difflineminus">-}</span>
<a href="#l27.1660"></a><span id="l27.1660" class="difflineminus">-</span>
<a href="#l27.1661"></a><span id="l27.1661" class="difflineminus">-</span>
<a href="#l27.1662"></a><span id="l27.1662" class="difflineminus">-////////////////////////////////////////////////////////////////////////</span>
<a href="#l27.1663"></a><span id="l27.1663" class="difflineminus">-// nsIRDFPurgeableDataSource methods</span>
<a href="#l27.1664"></a><span id="l27.1664" class="difflineminus">-</span>
<a href="#l27.1665"></a><span id="l27.1665" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l27.1666"></a><span id="l27.1666" class="difflineminus">-InMemoryDataSource::Mark(nsIRDFResource* aSource,</span>
<a href="#l27.1667"></a><span id="l27.1667" class="difflineminus">-                         nsIRDFResource* aProperty,</span>
<a href="#l27.1668"></a><span id="l27.1668" class="difflineminus">-                         nsIRDFNode* aTarget,</span>
<a href="#l27.1669"></a><span id="l27.1669" class="difflineminus">-                         bool aTruthValue,</span>
<a href="#l27.1670"></a><span id="l27.1670" class="difflineminus">-                         bool* aDidMark)</span>
<a href="#l27.1671"></a><span id="l27.1671" class="difflineminus">-{</span>
<a href="#l27.1672"></a><span id="l27.1672" class="difflineminus">-    NS_ASSERTION(aSource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l27.1673"></a><span id="l27.1673" class="difflineminus">-    if (! aSource)</span>
<a href="#l27.1674"></a><span id="l27.1674" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l27.1675"></a><span id="l27.1675" class="difflineminus">-</span>
<a href="#l27.1676"></a><span id="l27.1676" class="difflineminus">-    NS_ASSERTION(aProperty != nullptr, &quot;null ptr&quot;);</span>
<a href="#l27.1677"></a><span id="l27.1677" class="difflineminus">-    if (! aProperty)</span>
<a href="#l27.1678"></a><span id="l27.1678" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l27.1679"></a><span id="l27.1679" class="difflineminus">-</span>
<a href="#l27.1680"></a><span id="l27.1680" class="difflineminus">-    NS_ASSERTION(aTarget != nullptr, &quot;null ptr&quot;);</span>
<a href="#l27.1681"></a><span id="l27.1681" class="difflineminus">-    if (! aTarget)</span>
<a href="#l27.1682"></a><span id="l27.1682" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l27.1683"></a><span id="l27.1683" class="difflineminus">-</span>
<a href="#l27.1684"></a><span id="l27.1684" class="difflineminus">-    Assertion *as = GetForwardArcs(aSource);</span>
<a href="#l27.1685"></a><span id="l27.1685" class="difflineminus">-    if (as &amp;&amp; as-&gt;mHashEntry) {</span>
<a href="#l27.1686"></a><span id="l27.1686" class="difflineminus">-        PLDHashEntryHdr* hdr = as-&gt;u.hash.mPropertyHash-&gt;Search(aProperty);</span>
<a href="#l27.1687"></a><span id="l27.1687" class="difflineminus">-        Assertion* val = hdr ? static_cast&lt;Entry*&gt;(hdr)-&gt;mAssertions : nullptr;</span>
<a href="#l27.1688"></a><span id="l27.1688" class="difflineminus">-        while (val) {</span>
<a href="#l27.1689"></a><span id="l27.1689" class="difflineminus">-            if ((val-&gt;u.as.mTarget == aTarget) &amp;&amp;</span>
<a href="#l27.1690"></a><span id="l27.1690" class="difflineminus">-                (aTruthValue == (val-&gt;u.as.mTruthValue))) {</span>
<a href="#l27.1691"></a><span id="l27.1691" class="difflineminus">-</span>
<a href="#l27.1692"></a><span id="l27.1692" class="difflineminus">-                // found it! so mark it.</span>
<a href="#l27.1693"></a><span id="l27.1693" class="difflineminus">-                as-&gt;Mark();</span>
<a href="#l27.1694"></a><span id="l27.1694" class="difflineminus">-                *aDidMark = true;</span>
<a href="#l27.1695"></a><span id="l27.1695" class="difflineminus">-</span>
<a href="#l27.1696"></a><span id="l27.1696" class="difflineminus">-                LogOperation(&quot;MARK&quot;, aSource, aProperty, aTarget, aTruthValue);</span>
<a href="#l27.1697"></a><span id="l27.1697" class="difflineminus">-</span>
<a href="#l27.1698"></a><span id="l27.1698" class="difflineminus">-                return NS_OK;</span>
<a href="#l27.1699"></a><span id="l27.1699" class="difflineminus">-            }</span>
<a href="#l27.1700"></a><span id="l27.1700" class="difflineminus">-            val = val-&gt;mNext;</span>
<a href="#l27.1701"></a><span id="l27.1701" class="difflineminus">-        }</span>
<a href="#l27.1702"></a><span id="l27.1702" class="difflineminus">-    }</span>
<a href="#l27.1703"></a><span id="l27.1703" class="difflineminus">-    else for (; as != nullptr; as = as-&gt;mNext) {</span>
<a href="#l27.1704"></a><span id="l27.1704" class="difflineminus">-        // check target first as its most unique</span>
<a href="#l27.1705"></a><span id="l27.1705" class="difflineminus">-        if (aTarget != as-&gt;u.as.mTarget)</span>
<a href="#l27.1706"></a><span id="l27.1706" class="difflineminus">-            continue;</span>
<a href="#l27.1707"></a><span id="l27.1707" class="difflineminus">-</span>
<a href="#l27.1708"></a><span id="l27.1708" class="difflineminus">-        if (aProperty != as-&gt;u.as.mProperty)</span>
<a href="#l27.1709"></a><span id="l27.1709" class="difflineminus">-            continue;</span>
<a href="#l27.1710"></a><span id="l27.1710" class="difflineminus">-</span>
<a href="#l27.1711"></a><span id="l27.1711" class="difflineminus">-        if (aTruthValue != (as-&gt;u.as.mTruthValue))</span>
<a href="#l27.1712"></a><span id="l27.1712" class="difflineminus">-            continue;</span>
<a href="#l27.1713"></a><span id="l27.1713" class="difflineminus">-</span>
<a href="#l27.1714"></a><span id="l27.1714" class="difflineminus">-        // found it! so mark it.</span>
<a href="#l27.1715"></a><span id="l27.1715" class="difflineminus">-        as-&gt;Mark();</span>
<a href="#l27.1716"></a><span id="l27.1716" class="difflineminus">-        *aDidMark = true;</span>
<a href="#l27.1717"></a><span id="l27.1717" class="difflineminus">-</span>
<a href="#l27.1718"></a><span id="l27.1718" class="difflineminus">-        LogOperation(&quot;MARK&quot;, aSource, aProperty, aTarget, aTruthValue);</span>
<a href="#l27.1719"></a><span id="l27.1719" class="difflineminus">-</span>
<a href="#l27.1720"></a><span id="l27.1720" class="difflineminus">-        return NS_OK;</span>
<a href="#l27.1721"></a><span id="l27.1721" class="difflineminus">-    }</span>
<a href="#l27.1722"></a><span id="l27.1722" class="difflineminus">-</span>
<a href="#l27.1723"></a><span id="l27.1723" class="difflineminus">-    // If we get here, we couldn't find the assertion</span>
<a href="#l27.1724"></a><span id="l27.1724" class="difflineminus">-    *aDidMark = false;</span>
<a href="#l27.1725"></a><span id="l27.1725" class="difflineminus">-    return NS_OK;</span>
<a href="#l27.1726"></a><span id="l27.1726" class="difflineminus">-}</span>
<a href="#l27.1727"></a><span id="l27.1727" class="difflineminus">-</span>
<a href="#l27.1728"></a><span id="l27.1728" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l27.1729"></a><span id="l27.1729" class="difflineminus">-InMemoryDataSource::Sweep()</span>
<a href="#l27.1730"></a><span id="l27.1730" class="difflineminus">-{</span>
<a href="#l27.1731"></a><span id="l27.1731" class="difflineminus">-    SweepInfo info = { nullptr, &amp;mReverseArcs };</span>
<a href="#l27.1732"></a><span id="l27.1732" class="difflineminus">-</span>
<a href="#l27.1733"></a><span id="l27.1733" class="difflineminus">-    // Remove all the assertions, but don't notify anyone.</span>
<a href="#l27.1734"></a><span id="l27.1734" class="difflineminus">-    SweepForwardArcsEntries(&amp;mForwardArcs, &amp;info);</span>
<a href="#l27.1735"></a><span id="l27.1735" class="difflineminus">-</span>
<a href="#l27.1736"></a><span id="l27.1736" class="difflineminus">-    // Now do the notification.</span>
<a href="#l27.1737"></a><span id="l27.1737" class="difflineminus">-    Assertion* as = info.mUnassertList;</span>
<a href="#l27.1738"></a><span id="l27.1738" class="difflineminus">-    while (as) {</span>
<a href="#l27.1739"></a><span id="l27.1739" class="difflineminus">-        LogOperation(&quot;SWEEP&quot;, as-&gt;mSource, as-&gt;u.as.mProperty, as-&gt;u.as.mTarget, as-&gt;u.as.mTruthValue);</span>
<a href="#l27.1740"></a><span id="l27.1740" class="difflineminus">-        if (!(as-&gt;mHashEntry))</span>
<a href="#l27.1741"></a><span id="l27.1741" class="difflineminus">-        {</span>
<a href="#l27.1742"></a><span id="l27.1742" class="difflineminus">-            for (int32_t i = int32_t(mNumObservers) - 1; mPropagateChanges &amp;&amp; i &gt;= 0; --i) {</span>
<a href="#l27.1743"></a><span id="l27.1743" class="difflineminus">-                nsIRDFObserver* obs = mObservers[i];</span>
<a href="#l27.1744"></a><span id="l27.1744" class="difflineminus">-                // XXXbz other loops over mObservers null-check |obs| here!</span>
<a href="#l27.1745"></a><span id="l27.1745" class="difflineminus">-                obs-&gt;OnUnassert(this, as-&gt;mSource, as-&gt;u.as.mProperty, as-&gt;u.as.mTarget);</span>
<a href="#l27.1746"></a><span id="l27.1746" class="difflineminus">-                // XXX ignore return value?</span>
<a href="#l27.1747"></a><span id="l27.1747" class="difflineminus">-            }</span>
<a href="#l27.1748"></a><span id="l27.1748" class="difflineminus">-        }</span>
<a href="#l27.1749"></a><span id="l27.1749" class="difflineminus">-</span>
<a href="#l27.1750"></a><span id="l27.1750" class="difflineminus">-        Assertion* doomed = as;</span>
<a href="#l27.1751"></a><span id="l27.1751" class="difflineminus">-        as = as-&gt;mNext;</span>
<a href="#l27.1752"></a><span id="l27.1752" class="difflineminus">-</span>
<a href="#l27.1753"></a><span id="l27.1753" class="difflineminus">-        // Unlink, and release the datasource's reference</span>
<a href="#l27.1754"></a><span id="l27.1754" class="difflineminus">-        doomed-&gt;mNext = doomed-&gt;u.as.mInvNext = nullptr;</span>
<a href="#l27.1755"></a><span id="l27.1755" class="difflineminus">-        doomed-&gt;Release();</span>
<a href="#l27.1756"></a><span id="l27.1756" class="difflineminus">-    }</span>
<a href="#l27.1757"></a><span id="l27.1757" class="difflineminus">-</span>
<a href="#l27.1758"></a><span id="l27.1758" class="difflineminus">-    return NS_OK;</span>
<a href="#l27.1759"></a><span id="l27.1759" class="difflineminus">-}</span>
<a href="#l27.1760"></a><span id="l27.1760" class="difflineminus">-</span>
<a href="#l27.1761"></a><span id="l27.1761" class="difflineminus">-</span>
<a href="#l27.1762"></a><span id="l27.1762" class="difflineminus">-void</span>
<a href="#l27.1763"></a><span id="l27.1763" class="difflineminus">-InMemoryDataSource::SweepForwardArcsEntries(PLDHashTable* aTable,</span>
<a href="#l27.1764"></a><span id="l27.1764" class="difflineminus">-                                            SweepInfo* aInfo)</span>
<a href="#l27.1765"></a><span id="l27.1765" class="difflineminus">-{</span>
<a href="#l27.1766"></a><span id="l27.1766" class="difflineminus">-    for (auto iter = aTable-&gt;Iter(); !iter.Done(); iter.Next()) {</span>
<a href="#l27.1767"></a><span id="l27.1767" class="difflineminus">-        auto entry = static_cast&lt;Entry*&gt;(iter.Get());</span>
<a href="#l27.1768"></a><span id="l27.1768" class="difflineminus">-</span>
<a href="#l27.1769"></a><span id="l27.1769" class="difflineminus">-        Assertion* as = entry-&gt;mAssertions;</span>
<a href="#l27.1770"></a><span id="l27.1770" class="difflineminus">-        if (as &amp;&amp; (as-&gt;mHashEntry)) {</span>
<a href="#l27.1771"></a><span id="l27.1771" class="difflineminus">-            // Stuff in sub-hashes must be swept recursively (max depth: 1)</span>
<a href="#l27.1772"></a><span id="l27.1772" class="difflineminus">-            SweepForwardArcsEntries(as-&gt;u.hash.mPropertyHash, aInfo);</span>
<a href="#l27.1773"></a><span id="l27.1773" class="difflineminus">-</span>
<a href="#l27.1774"></a><span id="l27.1774" class="difflineminus">-            // If the sub-hash is now empty, clean it up.</span>
<a href="#l27.1775"></a><span id="l27.1775" class="difflineminus">-            if (!as-&gt;u.hash.mPropertyHash-&gt;EntryCount()) {</span>
<a href="#l27.1776"></a><span id="l27.1776" class="difflineminus">-                as-&gt;Release();</span>
<a href="#l27.1777"></a><span id="l27.1777" class="difflineminus">-                iter.Remove();</span>
<a href="#l27.1778"></a><span id="l27.1778" class="difflineminus">-            }</span>
<a href="#l27.1779"></a><span id="l27.1779" class="difflineminus">-            continue;</span>
<a href="#l27.1780"></a><span id="l27.1780" class="difflineminus">-        }</span>
<a href="#l27.1781"></a><span id="l27.1781" class="difflineminus">-</span>
<a href="#l27.1782"></a><span id="l27.1782" class="difflineminus">-        Assertion* prev = nullptr;</span>
<a href="#l27.1783"></a><span id="l27.1783" class="difflineminus">-        while (as) {</span>
<a href="#l27.1784"></a><span id="l27.1784" class="difflineminus">-            if (as-&gt;IsMarked()) {</span>
<a href="#l27.1785"></a><span id="l27.1785" class="difflineminus">-                prev = as;</span>
<a href="#l27.1786"></a><span id="l27.1786" class="difflineminus">-                as-&gt;Unmark();</span>
<a href="#l27.1787"></a><span id="l27.1787" class="difflineminus">-                as = as-&gt;mNext;</span>
<a href="#l27.1788"></a><span id="l27.1788" class="difflineminus">-            }</span>
<a href="#l27.1789"></a><span id="l27.1789" class="difflineminus">-            else {</span>
<a href="#l27.1790"></a><span id="l27.1790" class="difflineminus">-                // remove from the list of assertions in the datasource</span>
<a href="#l27.1791"></a><span id="l27.1791" class="difflineminus">-                Assertion* next = as-&gt;mNext;</span>
<a href="#l27.1792"></a><span id="l27.1792" class="difflineminus">-                if (prev) {</span>
<a href="#l27.1793"></a><span id="l27.1793" class="difflineminus">-                    prev-&gt;mNext = next;</span>
<a href="#l27.1794"></a><span id="l27.1794" class="difflineminus">-                }</span>
<a href="#l27.1795"></a><span id="l27.1795" class="difflineminus">-                else {</span>
<a href="#l27.1796"></a><span id="l27.1796" class="difflineminus">-                    // it's the first one. update the hashtable entry.</span>
<a href="#l27.1797"></a><span id="l27.1797" class="difflineminus">-                    entry-&gt;mAssertions = next;</span>
<a href="#l27.1798"></a><span id="l27.1798" class="difflineminus">-                }</span>
<a href="#l27.1799"></a><span id="l27.1799" class="difflineminus">-</span>
<a href="#l27.1800"></a><span id="l27.1800" class="difflineminus">-                // remove from the reverse arcs</span>
<a href="#l27.1801"></a><span id="l27.1801" class="difflineminus">-                PLDHashEntryHdr* hdr =</span>
<a href="#l27.1802"></a><span id="l27.1802" class="difflineminus">-                    aInfo-&gt;mReverseArcs-&gt;Search(as-&gt;u.as.mTarget);</span>
<a href="#l27.1803"></a><span id="l27.1803" class="difflineminus">-                NS_ASSERTION(hdr, &quot;no assertion in reverse arcs&quot;);</span>
<a href="#l27.1804"></a><span id="l27.1804" class="difflineminus">-</span>
<a href="#l27.1805"></a><span id="l27.1805" class="difflineminus">-                Entry* rentry = static_cast&lt;Entry*&gt;(hdr);</span>
<a href="#l27.1806"></a><span id="l27.1806" class="difflineminus">-                Assertion* ras = rentry-&gt;mAssertions;</span>
<a href="#l27.1807"></a><span id="l27.1807" class="difflineminus">-                Assertion* rprev = nullptr;</span>
<a href="#l27.1808"></a><span id="l27.1808" class="difflineminus">-                while (ras) {</span>
<a href="#l27.1809"></a><span id="l27.1809" class="difflineminus">-                    if (ras == as) {</span>
<a href="#l27.1810"></a><span id="l27.1810" class="difflineminus">-                        if (rprev) {</span>
<a href="#l27.1811"></a><span id="l27.1811" class="difflineminus">-                            rprev-&gt;u.as.mInvNext = ras-&gt;u.as.mInvNext;</span>
<a href="#l27.1812"></a><span id="l27.1812" class="difflineminus">-                        }</span>
<a href="#l27.1813"></a><span id="l27.1813" class="difflineminus">-                        else {</span>
<a href="#l27.1814"></a><span id="l27.1814" class="difflineminus">-                            // it's the first one. update the hashtable entry.</span>
<a href="#l27.1815"></a><span id="l27.1815" class="difflineminus">-                            rentry-&gt;mAssertions = ras-&gt;u.as.mInvNext;</span>
<a href="#l27.1816"></a><span id="l27.1816" class="difflineminus">-                        }</span>
<a href="#l27.1817"></a><span id="l27.1817" class="difflineminus">-                        as-&gt;u.as.mInvNext = nullptr; // for my sanity.</span>
<a href="#l27.1818"></a><span id="l27.1818" class="difflineminus">-                        break;</span>
<a href="#l27.1819"></a><span id="l27.1819" class="difflineminus">-                    }</span>
<a href="#l27.1820"></a><span id="l27.1820" class="difflineminus">-                    rprev = ras;</span>
<a href="#l27.1821"></a><span id="l27.1821" class="difflineminus">-                    ras = ras-&gt;u.as.mInvNext;</span>
<a href="#l27.1822"></a><span id="l27.1822" class="difflineminus">-                }</span>
<a href="#l27.1823"></a><span id="l27.1823" class="difflineminus">-</span>
<a href="#l27.1824"></a><span id="l27.1824" class="difflineminus">-                // Wow, it was the _only_ one. Unhash it.</span>
<a href="#l27.1825"></a><span id="l27.1825" class="difflineminus">-                if (! rentry-&gt;mAssertions) {</span>
<a href="#l27.1826"></a><span id="l27.1826" class="difflineminus">-                    aInfo-&gt;mReverseArcs-&gt;RawRemove(hdr);</span>
<a href="#l27.1827"></a><span id="l27.1827" class="difflineminus">-                }</span>
<a href="#l27.1828"></a><span id="l27.1828" class="difflineminus">-</span>
<a href="#l27.1829"></a><span id="l27.1829" class="difflineminus">-                // add to the list of assertions to unassert</span>
<a href="#l27.1830"></a><span id="l27.1830" class="difflineminus">-                as-&gt;mNext = aInfo-&gt;mUnassertList;</span>
<a href="#l27.1831"></a><span id="l27.1831" class="difflineminus">-                aInfo-&gt;mUnassertList = as;</span>
<a href="#l27.1832"></a><span id="l27.1832" class="difflineminus">-</span>
<a href="#l27.1833"></a><span id="l27.1833" class="difflineminus">-                // Advance to the next assertion</span>
<a href="#l27.1834"></a><span id="l27.1834" class="difflineminus">-                as = next;</span>
<a href="#l27.1835"></a><span id="l27.1835" class="difflineminus">-            }</span>
<a href="#l27.1836"></a><span id="l27.1836" class="difflineminus">-        }</span>
<a href="#l27.1837"></a><span id="l27.1837" class="difflineminus">-</span>
<a href="#l27.1838"></a><span id="l27.1838" class="difflineminus">-        // if no more assertions exist for this resource, then unhash it.</span>
<a href="#l27.1839"></a><span id="l27.1839" class="difflineminus">-        if (! entry-&gt;mAssertions) {</span>
<a href="#l27.1840"></a><span id="l27.1840" class="difflineminus">-            iter.Remove();</span>
<a href="#l27.1841"></a><span id="l27.1841" class="difflineminus">-        }</span>
<a href="#l27.1842"></a><span id="l27.1842" class="difflineminus">-    }</span>
<a href="#l27.1843"></a><span id="l27.1843" class="difflineminus">-}</span>
<a href="#l27.1844"></a><span id="l27.1844" class="difflineminus">-</span>
<a href="#l27.1845"></a><span id="l27.1845" class="difflineminus">-////////////////////////////////////////////////////////////////////////</span>
<a href="#l27.1846"></a><span id="l27.1846" class="difflineminus">-// rdfIDataSource methods</span>
<a href="#l27.1847"></a><span id="l27.1847" class="difflineminus">-</span>
<a href="#l27.1848"></a><span id="l27.1848" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l27.1849"></a><span id="l27.1849" class="difflineminus">-InMemoryDataSource::VisitAllSubjects(rdfITripleVisitor *aVisitor)</span>
<a href="#l27.1850"></a><span id="l27.1850" class="difflineminus">-{</span>
<a href="#l27.1851"></a><span id="l27.1851" class="difflineminus">-    // Lock datasource against writes</span>
<a href="#l27.1852"></a><span id="l27.1852" class="difflineminus">-    ++mReadCount;</span>
<a href="#l27.1853"></a><span id="l27.1853" class="difflineminus">-</span>
<a href="#l27.1854"></a><span id="l27.1854" class="difflineminus">-    // Enumerate all of our entries.</span>
<a href="#l27.1855"></a><span id="l27.1855" class="difflineminus">-    nsresult rv = NS_OK;</span>
<a href="#l27.1856"></a><span id="l27.1856" class="difflineminus">-    for (auto iter = mForwardArcs.Iter(); !iter.Done(); iter.Next()) {</span>
<a href="#l27.1857"></a><span id="l27.1857" class="difflineminus">-        auto entry = static_cast&lt;Entry*&gt;(iter.Get());</span>
<a href="#l27.1858"></a><span id="l27.1858" class="difflineminus">-        rv = aVisitor-&gt;Visit(entry-&gt;mNode, nullptr, nullptr, true);</span>
<a href="#l27.1859"></a><span id="l27.1859" class="difflineminus">-        if (NS_FAILED(rv) || rv == NS_RDF_STOP_VISIT) {</span>
<a href="#l27.1860"></a><span id="l27.1860" class="difflineminus">-            break;</span>
<a href="#l27.1861"></a><span id="l27.1861" class="difflineminus">-        }</span>
<a href="#l27.1862"></a><span id="l27.1862" class="difflineminus">-    }</span>
<a href="#l27.1863"></a><span id="l27.1863" class="difflineminus">-</span>
<a href="#l27.1864"></a><span id="l27.1864" class="difflineminus">-    // Unlock datasource</span>
<a href="#l27.1865"></a><span id="l27.1865" class="difflineminus">-    --mReadCount;</span>
<a href="#l27.1866"></a><span id="l27.1866" class="difflineminus">-</span>
<a href="#l27.1867"></a><span id="l27.1867" class="difflineminus">-    return rv;</span>
<a href="#l27.1868"></a><span id="l27.1868" class="difflineminus">-}</span>
<a href="#l27.1869"></a><span id="l27.1869" class="difflineminus">-</span>
<a href="#l27.1870"></a><span id="l27.1870" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l27.1871"></a><span id="l27.1871" class="difflineminus">-InMemoryDataSource::VisitAllTriples(rdfITripleVisitor *aVisitor)</span>
<a href="#l27.1872"></a><span id="l27.1872" class="difflineminus">-{</span>
<a href="#l27.1873"></a><span id="l27.1873" class="difflineminus">-    // Lock datasource against writes</span>
<a href="#l27.1874"></a><span id="l27.1874" class="difflineminus">-    ++mReadCount;</span>
<a href="#l27.1875"></a><span id="l27.1875" class="difflineminus">-</span>
<a href="#l27.1876"></a><span id="l27.1876" class="difflineminus">-    // Enumerate all of our entries.</span>
<a href="#l27.1877"></a><span id="l27.1877" class="difflineminus">-    nsresult rv = NS_OK;</span>
<a href="#l27.1878"></a><span id="l27.1878" class="difflineminus">-    for (auto iter = mForwardArcs.Iter(); !iter.Done(); iter.Next()) {</span>
<a href="#l27.1879"></a><span id="l27.1879" class="difflineminus">-        auto entry = static_cast&lt;Entry*&gt;(iter.Get());</span>
<a href="#l27.1880"></a><span id="l27.1880" class="difflineminus">-</span>
<a href="#l27.1881"></a><span id="l27.1881" class="difflineminus">-        if (entry-&gt;mAssertions-&gt;mHashEntry) {</span>
<a href="#l27.1882"></a><span id="l27.1882" class="difflineminus">-            for (auto iter = entry-&gt;mAssertions-&gt;u.hash.mPropertyHash-&gt;Iter();</span>
<a href="#l27.1883"></a><span id="l27.1883" class="difflineminus">-                 !iter.Done();</span>
<a href="#l27.1884"></a><span id="l27.1884" class="difflineminus">-                 iter.Next()) {</span>
<a href="#l27.1885"></a><span id="l27.1885" class="difflineminus">-                auto entry = static_cast&lt;Entry*&gt;(iter.Get());</span>
<a href="#l27.1886"></a><span id="l27.1886" class="difflineminus">-                Assertion* assertion = entry-&gt;mAssertions;</span>
<a href="#l27.1887"></a><span id="l27.1887" class="difflineminus">-                while (assertion) {</span>
<a href="#l27.1888"></a><span id="l27.1888" class="difflineminus">-                    NS_ASSERTION(!assertion-&gt;mHashEntry, &quot;shouldn't have to hashes&quot;);</span>
<a href="#l27.1889"></a><span id="l27.1889" class="difflineminus">-                    rv = aVisitor-&gt;Visit(entry-&gt;mNode, assertion-&gt;u.as.mProperty,</span>
<a href="#l27.1890"></a><span id="l27.1890" class="difflineminus">-                                                       assertion-&gt;u.as.mTarget,</span>
<a href="#l27.1891"></a><span id="l27.1891" class="difflineminus">-                                                       assertion-&gt;u.as.mTruthValue);</span>
<a href="#l27.1892"></a><span id="l27.1892" class="difflineminus">-                    if (NS_FAILED(rv)) {</span>
<a href="#l27.1893"></a><span id="l27.1893" class="difflineminus">-                        goto end;</span>
<a href="#l27.1894"></a><span id="l27.1894" class="difflineminus">-                    }</span>
<a href="#l27.1895"></a><span id="l27.1895" class="difflineminus">-                    if (rv == NS_RDF_STOP_VISIT) {</span>
<a href="#l27.1896"></a><span id="l27.1896" class="difflineminus">-                        goto inner_end;</span>
<a href="#l27.1897"></a><span id="l27.1897" class="difflineminus">-                    }</span>
<a href="#l27.1898"></a><span id="l27.1898" class="difflineminus">-                    assertion = assertion-&gt;mNext;</span>
<a href="#l27.1899"></a><span id="l27.1899" class="difflineminus">-                }</span>
<a href="#l27.1900"></a><span id="l27.1900" class="difflineminus">-            }</span>
<a href="#l27.1901"></a><span id="l27.1901" class="difflineminus">-</span>
<a href="#l27.1902"></a><span id="l27.1902" class="difflineminus">-        } else {</span>
<a href="#l27.1903"></a><span id="l27.1903" class="difflineminus">-            Assertion* assertion = entry-&gt;mAssertions;</span>
<a href="#l27.1904"></a><span id="l27.1904" class="difflineminus">-            while (assertion) {</span>
<a href="#l27.1905"></a><span id="l27.1905" class="difflineminus">-                NS_ASSERTION(!assertion-&gt;mHashEntry, &quot;shouldn't have to hashes&quot;);</span>
<a href="#l27.1906"></a><span id="l27.1906" class="difflineminus">-                rv = aVisitor-&gt;Visit(entry-&gt;mNode, assertion-&gt;u.as.mProperty,</span>
<a href="#l27.1907"></a><span id="l27.1907" class="difflineminus">-                                                   assertion-&gt;u.as.mTarget,</span>
<a href="#l27.1908"></a><span id="l27.1908" class="difflineminus">-                                                   assertion-&gt;u.as.mTruthValue);</span>
<a href="#l27.1909"></a><span id="l27.1909" class="difflineminus">-                if (NS_FAILED(rv) || rv == NS_RDF_STOP_VISIT) {</span>
<a href="#l27.1910"></a><span id="l27.1910" class="difflineminus">-                    goto end;</span>
<a href="#l27.1911"></a><span id="l27.1911" class="difflineminus">-                }</span>
<a href="#l27.1912"></a><span id="l27.1912" class="difflineminus">-                assertion = assertion-&gt;mNext;</span>
<a href="#l27.1913"></a><span id="l27.1913" class="difflineminus">-            }</span>
<a href="#l27.1914"></a><span id="l27.1914" class="difflineminus">-        }</span>
<a href="#l27.1915"></a><span id="l27.1915" class="difflineminus">-</span>
<a href="#l27.1916"></a><span id="l27.1916" class="difflineminus">-      inner_end:</span>
<a href="#l27.1917"></a><span id="l27.1917" class="difflineminus">-        (void) 0;</span>
<a href="#l27.1918"></a><span id="l27.1918" class="difflineminus">-    }</span>
<a href="#l27.1919"></a><span id="l27.1919" class="difflineminus">-</span>
<a href="#l27.1920"></a><span id="l27.1920" class="difflineminus">-  end:</span>
<a href="#l27.1921"></a><span id="l27.1921" class="difflineminus">-    // Unlock datasource</span>
<a href="#l27.1922"></a><span id="l27.1922" class="difflineminus">-    --mReadCount;</span>
<a href="#l27.1923"></a><span id="l27.1923" class="difflineminus">-</span>
<a href="#l27.1924"></a><span id="l27.1924" class="difflineminus">-    return rv;</span>
<a href="#l27.1925"></a><span id="l27.1925" class="difflineminus">-}</span>
<a href="#l27.1926"></a><span id="l27.1926" class="difflineminus">-</span>
<a href="#l27.1927"></a><span id="l27.1927" class="difflineminus">-////////////////////////////////////////////////////////////////////////</span>
<a href="#l27.1928"></a><span id="l27.1928" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1">deleted file mode 100644</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineminus">--- a/rdf/base/nsNameSpaceMap.cpp</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineplus">+++ /dev/null</span>
<a href="#l28.4"></a><span id="l28.4" class="difflineat">@@ -1,64 +0,0 @@</span>
<a href="#l28.5"></a><span id="l28.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*-</span>
<a href="#l28.6"></a><span id="l28.6" class="difflineminus">- *</span>
<a href="#l28.7"></a><span id="l28.7" class="difflineminus">- * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l28.8"></a><span id="l28.8" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l28.9"></a><span id="l28.9" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l28.10"></a><span id="l28.10" class="difflineminus">-</span>
<a href="#l28.11"></a><span id="l28.11" class="difflineminus">-#include &quot;nsNameSpaceMap.h&quot;</span>
<a href="#l28.12"></a><span id="l28.12" class="difflineminus">-#include &quot;nsReadableUtils.h&quot;</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineminus">-</span>
<a href="#l28.14"></a><span id="l28.14" class="difflineminus">-nsNameSpaceMap::nsNameSpaceMap()</span>
<a href="#l28.15"></a><span id="l28.15" class="difflineminus">-    : mEntries(nullptr)</span>
<a href="#l28.16"></a><span id="l28.16" class="difflineminus">-{</span>
<a href="#l28.17"></a><span id="l28.17" class="difflineminus">-    MOZ_COUNT_CTOR(nsNameSpaceMap);</span>
<a href="#l28.18"></a><span id="l28.18" class="difflineminus">-}</span>
<a href="#l28.19"></a><span id="l28.19" class="difflineminus">-</span>
<a href="#l28.20"></a><span id="l28.20" class="difflineminus">-nsNameSpaceMap::~nsNameSpaceMap()</span>
<a href="#l28.21"></a><span id="l28.21" class="difflineminus">-{</span>
<a href="#l28.22"></a><span id="l28.22" class="difflineminus">-    MOZ_COUNT_DTOR(nsNameSpaceMap);</span>
<a href="#l28.23"></a><span id="l28.23" class="difflineminus">-</span>
<a href="#l28.24"></a><span id="l28.24" class="difflineminus">-    while (mEntries) {</span>
<a href="#l28.25"></a><span id="l28.25" class="difflineminus">-        Entry* doomed = mEntries;</span>
<a href="#l28.26"></a><span id="l28.26" class="difflineminus">-        mEntries = mEntries-&gt;mNext;</span>
<a href="#l28.27"></a><span id="l28.27" class="difflineminus">-        delete doomed;</span>
<a href="#l28.28"></a><span id="l28.28" class="difflineminus">-    }</span>
<a href="#l28.29"></a><span id="l28.29" class="difflineminus">-}</span>
<a href="#l28.30"></a><span id="l28.30" class="difflineminus">-</span>
<a href="#l28.31"></a><span id="l28.31" class="difflineminus">-nsresult</span>
<a href="#l28.32"></a><span id="l28.32" class="difflineminus">-nsNameSpaceMap::Put(const nsAString&amp; aURI, nsAtom* aPrefix)</span>
<a href="#l28.33"></a><span id="l28.33" class="difflineminus">-{</span>
<a href="#l28.34"></a><span id="l28.34" class="difflineminus">-    nsCString uriUTF8;</span>
<a href="#l28.35"></a><span id="l28.35" class="difflineminus">-    AppendUTF16toUTF8(aURI, uriUTF8);</span>
<a href="#l28.36"></a><span id="l28.36" class="difflineminus">-    return Put(uriUTF8, aPrefix);</span>
<a href="#l28.37"></a><span id="l28.37" class="difflineminus">-}</span>
<a href="#l28.38"></a><span id="l28.38" class="difflineminus">-</span>
<a href="#l28.39"></a><span id="l28.39" class="difflineminus">-nsresult</span>
<a href="#l28.40"></a><span id="l28.40" class="difflineminus">-nsNameSpaceMap::Put(const nsACString&amp; aURI, nsAtom* aPrefix)</span>
<a href="#l28.41"></a><span id="l28.41" class="difflineminus">-{</span>
<a href="#l28.42"></a><span id="l28.42" class="difflineminus">-    Entry* entry;</span>
<a href="#l28.43"></a><span id="l28.43" class="difflineminus">-</span>
<a href="#l28.44"></a><span id="l28.44" class="difflineminus">-    // Make sure we're not adding a duplicate</span>
<a href="#l28.45"></a><span id="l28.45" class="difflineminus">-    for (entry = mEntries; entry != nullptr; entry = entry-&gt;mNext) {</span>
<a href="#l28.46"></a><span id="l28.46" class="difflineminus">-        if (entry-&gt;mURI == aURI || entry-&gt;mPrefix == aPrefix)</span>
<a href="#l28.47"></a><span id="l28.47" class="difflineminus">-            return NS_ERROR_FAILURE;</span>
<a href="#l28.48"></a><span id="l28.48" class="difflineminus">-    }</span>
<a href="#l28.49"></a><span id="l28.49" class="difflineminus">-</span>
<a href="#l28.50"></a><span id="l28.50" class="difflineminus">-    entry = new Entry(aURI, aPrefix);</span>
<a href="#l28.51"></a><span id="l28.51" class="difflineminus">-    if (! entry)</span>
<a href="#l28.52"></a><span id="l28.52" class="difflineminus">-        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l28.53"></a><span id="l28.53" class="difflineminus">-</span>
<a href="#l28.54"></a><span id="l28.54" class="difflineminus">-    entry-&gt;mNext = mEntries;</span>
<a href="#l28.55"></a><span id="l28.55" class="difflineminus">-    mEntries = entry;</span>
<a href="#l28.56"></a><span id="l28.56" class="difflineminus">-    return NS_OK;</span>
<a href="#l28.57"></a><span id="l28.57" class="difflineminus">-}</span>
<a href="#l28.58"></a><span id="l28.58" class="difflineminus">-</span>
<a href="#l28.59"></a><span id="l28.59" class="difflineminus">-nsNameSpaceMap::const_iterator</span>
<a href="#l28.60"></a><span id="l28.60" class="difflineminus">-nsNameSpaceMap::GetNameSpaceOf(const nsACString&amp; aURI) const</span>
<a href="#l28.61"></a><span id="l28.61" class="difflineminus">-{</span>
<a href="#l28.62"></a><span id="l28.62" class="difflineminus">-    for (Entry* entry = mEntries; entry != nullptr; entry = entry-&gt;mNext) {</span>
<a href="#l28.63"></a><span id="l28.63" class="difflineminus">-        if (StringBeginsWith(aURI, entry-&gt;mURI))</span>
<a href="#l28.64"></a><span id="l28.64" class="difflineminus">-            return const_iterator(entry);</span>
<a href="#l28.65"></a><span id="l28.65" class="difflineminus">-    }</span>
<a href="#l28.66"></a><span id="l28.66" class="difflineminus">-</span>
<a href="#l28.67"></a><span id="l28.67" class="difflineminus">-    return last();</span>
<a href="#l28.68"></a><span id="l28.68" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1">deleted file mode 100644</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineminus">--- a/rdf/base/nsNameSpaceMap.h</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineplus">+++ /dev/null</span>
<a href="#l29.4"></a><span id="l29.4" class="difflineat">@@ -1,98 +0,0 @@</span>
<a href="#l29.5"></a><span id="l29.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*-</span>
<a href="#l29.6"></a><span id="l29.6" class="difflineminus">- *</span>
<a href="#l29.7"></a><span id="l29.7" class="difflineminus">- * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l29.8"></a><span id="l29.8" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l29.9"></a><span id="l29.9" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l29.10"></a><span id="l29.10" class="difflineminus">-</span>
<a href="#l29.11"></a><span id="l29.11" class="difflineminus">-#ifndef nsNameSpaceMap_h__</span>
<a href="#l29.12"></a><span id="l29.12" class="difflineminus">-#define nsNameSpaceMap_h__</span>
<a href="#l29.13"></a><span id="l29.13" class="difflineminus">-</span>
<a href="#l29.14"></a><span id="l29.14" class="difflineminus">-#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l29.15"></a><span id="l29.15" class="difflineminus">-#include &quot;nsString.h&quot;</span>
<a href="#l29.16"></a><span id="l29.16" class="difflineminus">-#include &quot;nsAtom.h&quot;</span>
<a href="#l29.17"></a><span id="l29.17" class="difflineminus">-</span>
<a href="#l29.18"></a><span id="l29.18" class="difflineminus">-class nsNameSpaceMap</span>
<a href="#l29.19"></a><span id="l29.19" class="difflineminus">-{</span>
<a href="#l29.20"></a><span id="l29.20" class="difflineminus">-public:</span>
<a href="#l29.21"></a><span id="l29.21" class="difflineminus">-    class Entry {</span>
<a href="#l29.22"></a><span id="l29.22" class="difflineminus">-    public:</span>
<a href="#l29.23"></a><span id="l29.23" class="difflineminus">-        Entry(const nsACString&amp; aURI, nsAtom* aPrefix)</span>
<a href="#l29.24"></a><span id="l29.24" class="difflineminus">-            : mURI(aURI), mPrefix(aPrefix), mNext(nullptr) {</span>
<a href="#l29.25"></a><span id="l29.25" class="difflineminus">-            MOZ_COUNT_CTOR(nsNameSpaceMap::Entry); }</span>
<a href="#l29.26"></a><span id="l29.26" class="difflineminus">-</span>
<a href="#l29.27"></a><span id="l29.27" class="difflineminus">-        ~Entry() { MOZ_COUNT_DTOR(nsNameSpaceMap::Entry); }</span>
<a href="#l29.28"></a><span id="l29.28" class="difflineminus">-</span>
<a href="#l29.29"></a><span id="l29.29" class="difflineminus">-        nsCString mURI;</span>
<a href="#l29.30"></a><span id="l29.30" class="difflineminus">-        RefPtr&lt;nsAtom&gt; mPrefix;</span>
<a href="#l29.31"></a><span id="l29.31" class="difflineminus">-</span>
<a href="#l29.32"></a><span id="l29.32" class="difflineminus">-        Entry* mNext;</span>
<a href="#l29.33"></a><span id="l29.33" class="difflineminus">-    };</span>
<a href="#l29.34"></a><span id="l29.34" class="difflineminus">-</span>
<a href="#l29.35"></a><span id="l29.35" class="difflineminus">-    nsNameSpaceMap();</span>
<a href="#l29.36"></a><span id="l29.36" class="difflineminus">-    ~nsNameSpaceMap();</span>
<a href="#l29.37"></a><span id="l29.37" class="difflineminus">-</span>
<a href="#l29.38"></a><span id="l29.38" class="difflineminus">-    nsresult</span>
<a href="#l29.39"></a><span id="l29.39" class="difflineminus">-    Put(const nsAString&amp; aURI, nsAtom* aPrefix);</span>
<a href="#l29.40"></a><span id="l29.40" class="difflineminus">-</span>
<a href="#l29.41"></a><span id="l29.41" class="difflineminus">-    nsresult</span>
<a href="#l29.42"></a><span id="l29.42" class="difflineminus">-    Put(const nsACString&amp; aURI, nsAtom* aPrefix);</span>
<a href="#l29.43"></a><span id="l29.43" class="difflineminus">-</span>
<a href="#l29.44"></a><span id="l29.44" class="difflineminus">-    class const_iterator {</span>
<a href="#l29.45"></a><span id="l29.45" class="difflineminus">-    protected:</span>
<a href="#l29.46"></a><span id="l29.46" class="difflineminus">-        friend class nsNameSpaceMap;</span>
<a href="#l29.47"></a><span id="l29.47" class="difflineminus">-</span>
<a href="#l29.48"></a><span id="l29.48" class="difflineminus">-        explicit const_iterator(const Entry* aCurrent)</span>
<a href="#l29.49"></a><span id="l29.49" class="difflineminus">-            : mCurrent(aCurrent) {}</span>
<a href="#l29.50"></a><span id="l29.50" class="difflineminus">-</span>
<a href="#l29.51"></a><span id="l29.51" class="difflineminus">-        const Entry* mCurrent;</span>
<a href="#l29.52"></a><span id="l29.52" class="difflineminus">-</span>
<a href="#l29.53"></a><span id="l29.53" class="difflineminus">-    public:</span>
<a href="#l29.54"></a><span id="l29.54" class="difflineminus">-        const_iterator()</span>
<a href="#l29.55"></a><span id="l29.55" class="difflineminus">-            : mCurrent(nullptr) {}</span>
<a href="#l29.56"></a><span id="l29.56" class="difflineminus">-</span>
<a href="#l29.57"></a><span id="l29.57" class="difflineminus">-        const_iterator(const const_iterator&amp; iter)</span>
<a href="#l29.58"></a><span id="l29.58" class="difflineminus">-            : mCurrent(iter.mCurrent) {}</span>
<a href="#l29.59"></a><span id="l29.59" class="difflineminus">-</span>
<a href="#l29.60"></a><span id="l29.60" class="difflineminus">-        const_iterator&amp;</span>
<a href="#l29.61"></a><span id="l29.61" class="difflineminus">-        operator=(const const_iterator&amp; iter) {</span>
<a href="#l29.62"></a><span id="l29.62" class="difflineminus">-            mCurrent = iter.mCurrent;</span>
<a href="#l29.63"></a><span id="l29.63" class="difflineminus">-            return *this; }</span>
<a href="#l29.64"></a><span id="l29.64" class="difflineminus">-</span>
<a href="#l29.65"></a><span id="l29.65" class="difflineminus">-        const_iterator&amp;</span>
<a href="#l29.66"></a><span id="l29.66" class="difflineminus">-        operator++() {</span>
<a href="#l29.67"></a><span id="l29.67" class="difflineminus">-            mCurrent = mCurrent-&gt;mNext;</span>
<a href="#l29.68"></a><span id="l29.68" class="difflineminus">-            return *this; }</span>
<a href="#l29.69"></a><span id="l29.69" class="difflineminus">-</span>
<a href="#l29.70"></a><span id="l29.70" class="difflineminus">-        const_iterator</span>
<a href="#l29.71"></a><span id="l29.71" class="difflineminus">-        operator++(int) {</span>
<a href="#l29.72"></a><span id="l29.72" class="difflineminus">-            const_iterator tmp(*this);</span>
<a href="#l29.73"></a><span id="l29.73" class="difflineminus">-            mCurrent = mCurrent-&gt;mNext;</span>
<a href="#l29.74"></a><span id="l29.74" class="difflineminus">-            return tmp; }</span>
<a href="#l29.75"></a><span id="l29.75" class="difflineminus">-</span>
<a href="#l29.76"></a><span id="l29.76" class="difflineminus">-        const Entry* operator-&gt;() const { return mCurrent; }</span>
<a href="#l29.77"></a><span id="l29.77" class="difflineminus">-</span>
<a href="#l29.78"></a><span id="l29.78" class="difflineminus">-        const Entry&amp; operator*() const { return *mCurrent; }</span>
<a href="#l29.79"></a><span id="l29.79" class="difflineminus">-</span>
<a href="#l29.80"></a><span id="l29.80" class="difflineminus">-        bool</span>
<a href="#l29.81"></a><span id="l29.81" class="difflineminus">-        operator==(const const_iterator&amp; iter) const {</span>
<a href="#l29.82"></a><span id="l29.82" class="difflineminus">-            return mCurrent == iter.mCurrent; }</span>
<a href="#l29.83"></a><span id="l29.83" class="difflineminus">-</span>
<a href="#l29.84"></a><span id="l29.84" class="difflineminus">-        bool</span>
<a href="#l29.85"></a><span id="l29.85" class="difflineminus">-        operator!=(const const_iterator&amp; iter) const {</span>
<a href="#l29.86"></a><span id="l29.86" class="difflineminus">-            return ! iter.operator==(*this); }</span>
<a href="#l29.87"></a><span id="l29.87" class="difflineminus">-    };</span>
<a href="#l29.88"></a><span id="l29.88" class="difflineminus">-</span>
<a href="#l29.89"></a><span id="l29.89" class="difflineminus">-    const_iterator first() const {</span>
<a href="#l29.90"></a><span id="l29.90" class="difflineminus">-        return const_iterator(mEntries); }</span>
<a href="#l29.91"></a><span id="l29.91" class="difflineminus">-</span>
<a href="#l29.92"></a><span id="l29.92" class="difflineminus">-    const_iterator last() const {</span>
<a href="#l29.93"></a><span id="l29.93" class="difflineminus">-        return const_iterator(nullptr); }</span>
<a href="#l29.94"></a><span id="l29.94" class="difflineminus">-</span>
<a href="#l29.95"></a><span id="l29.95" class="difflineminus">-    const_iterator GetNameSpaceOf(const nsACString&amp; aURI) const;</span>
<a href="#l29.96"></a><span id="l29.96" class="difflineminus">-</span>
<a href="#l29.97"></a><span id="l29.97" class="difflineminus">-protected:</span>
<a href="#l29.98"></a><span id="l29.98" class="difflineminus">-    Entry* mEntries;</span>
<a href="#l29.99"></a><span id="l29.99" class="difflineminus">-};</span>
<a href="#l29.100"></a><span id="l29.100" class="difflineminus">-</span>
<a href="#l29.101"></a><span id="l29.101" class="difflineminus">-</span>
<a href="#l29.102"></a><span id="l29.102" class="difflineminus">-#endif // nsNameSpaceMap_h__</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1">deleted file mode 100644</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineminus">--- a/rdf/base/nsRDFBaseDataSources.h</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineplus">+++ /dev/null</span>
<a href="#l30.4"></a><span id="l30.4" class="difflineat">@@ -1,32 +0,0 @@</span>
<a href="#l30.5"></a><span id="l30.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l30.6"></a><span id="l30.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l30.7"></a><span id="l30.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l30.8"></a><span id="l30.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l30.9"></a><span id="l30.9" class="difflineminus">-</span>
<a href="#l30.10"></a><span id="l30.10" class="difflineminus">-/*</span>
<a href="#l30.11"></a><span id="l30.11" class="difflineminus">-</span>
<a href="#l30.12"></a><span id="l30.12" class="difflineminus">-  This header file just contains prototypes for the factory methods</span>
<a href="#l30.13"></a><span id="l30.13" class="difflineminus">-  for &quot;builtin&quot; data sources that are included in rdf.dll.</span>
<a href="#l30.14"></a><span id="l30.14" class="difflineminus">-</span>
<a href="#l30.15"></a><span id="l30.15" class="difflineminus">-  Each of these data sources is exposed to the external world via its</span>
<a href="#l30.16"></a><span id="l30.16" class="difflineminus">-  CID in ../include/nsRDFCID.h.</span>
<a href="#l30.17"></a><span id="l30.17" class="difflineminus">-</span>
<a href="#l30.18"></a><span id="l30.18" class="difflineminus">-*/</span>
<a href="#l30.19"></a><span id="l30.19" class="difflineminus">-</span>
<a href="#l30.20"></a><span id="l30.20" class="difflineminus">-#ifndef nsBaseDataSources_h__</span>
<a href="#l30.21"></a><span id="l30.21" class="difflineminus">-#define nsBaseDataSources_h__</span>
<a href="#l30.22"></a><span id="l30.22" class="difflineminus">-</span>
<a href="#l30.23"></a><span id="l30.23" class="difflineminus">-#include &quot;nsError.h&quot;</span>
<a href="#l30.24"></a><span id="l30.24" class="difflineminus">-class nsIRDFDataSource;</span>
<a href="#l30.25"></a><span id="l30.25" class="difflineminus">-</span>
<a href="#l30.26"></a><span id="l30.26" class="difflineminus">-// in nsInMemoryDataSource.cpp</span>
<a href="#l30.27"></a><span id="l30.27" class="difflineminus">-nsresult</span>
<a href="#l30.28"></a><span id="l30.28" class="difflineminus">-NS_NewRDFInMemoryDataSource(nsISupports* aOuter, const nsIID&amp; aIID, void** aResult);</span>
<a href="#l30.29"></a><span id="l30.29" class="difflineminus">-</span>
<a href="#l30.30"></a><span id="l30.30" class="difflineminus">-// in nsRDFXMLDataSource.cpp</span>
<a href="#l30.31"></a><span id="l30.31" class="difflineminus">-extern nsresult</span>
<a href="#l30.32"></a><span id="l30.32" class="difflineminus">-NS_NewRDFXMLDataSource(nsIRDFDataSource** aResult);</span>
<a href="#l30.33"></a><span id="l30.33" class="difflineminus">-</span>
<a href="#l30.34"></a><span id="l30.34" class="difflineminus">-#endif // nsBaseDataSources_h__</span>
<a href="#l30.35"></a><span id="l30.35" class="difflineminus">-</span>
<a href="#l30.36"></a><span id="l30.36" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1">deleted file mode 100644</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineminus">--- a/rdf/base/nsRDFContainer.cpp</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineplus">+++ /dev/null</span>
<a href="#l31.4"></a><span id="l31.4" class="difflineat">@@ -1,724 +0,0 @@</span>
<a href="#l31.5"></a><span id="l31.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l31.6"></a><span id="l31.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l31.7"></a><span id="l31.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l31.8"></a><span id="l31.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l31.9"></a><span id="l31.9" class="difflineminus">-</span>
<a href="#l31.10"></a><span id="l31.10" class="difflineminus">-/*</span>
<a href="#l31.11"></a><span id="l31.11" class="difflineminus">-</span>
<a href="#l31.12"></a><span id="l31.12" class="difflineminus">-  Implementation for the RDF container.</span>
<a href="#l31.13"></a><span id="l31.13" class="difflineminus">-</span>
<a href="#l31.14"></a><span id="l31.14" class="difflineminus">-  Notes</span>
<a href="#l31.15"></a><span id="l31.15" class="difflineminus">-  -----</span>
<a href="#l31.16"></a><span id="l31.16" class="difflineminus">-</span>
<a href="#l31.17"></a><span id="l31.17" class="difflineminus">-  1. RDF containers are one-indexed. This means that a lot of the loops</span>
<a href="#l31.18"></a><span id="l31.18" class="difflineminus">-     that you'd normally think you'd write like this:</span>
<a href="#l31.19"></a><span id="l31.19" class="difflineminus">-</span>
<a href="#l31.20"></a><span id="l31.20" class="difflineminus">-       for (i = 0; i &lt; count; ++i) {}</span>
<a href="#l31.21"></a><span id="l31.21" class="difflineminus">-</span>
<a href="#l31.22"></a><span id="l31.22" class="difflineminus">-     You've gotta write like this:</span>
<a href="#l31.23"></a><span id="l31.23" class="difflineminus">-</span>
<a href="#l31.24"></a><span id="l31.24" class="difflineminus">-       for (i = 1; i &lt;= count; ++i) {}</span>
<a href="#l31.25"></a><span id="l31.25" class="difflineminus">-</span>
<a href="#l31.26"></a><span id="l31.26" class="difflineminus">-     &quot;Sure, right, yeah, of course.&quot;, you say. Well maybe I'm just</span>
<a href="#l31.27"></a><span id="l31.27" class="difflineminus">-     thick, but it's easy to slip up.</span>
<a href="#l31.28"></a><span id="l31.28" class="difflineminus">-</span>
<a href="#l31.29"></a><span id="l31.29" class="difflineminus">-  2. The RDF:nextVal property on the container is an</span>
<a href="#l31.30"></a><span id="l31.30" class="difflineminus">-     implementation-level hack that is used to quickly compute the</span>
<a href="#l31.31"></a><span id="l31.31" class="difflineminus">-     next value for appending to the container. It will no doubt</span>
<a href="#l31.32"></a><span id="l31.32" class="difflineminus">-     become royally screwed up in the case of aggregation.</span>
<a href="#l31.33"></a><span id="l31.33" class="difflineminus">-</span>
<a href="#l31.34"></a><span id="l31.34" class="difflineminus">-  3. The RDF:nextVal property is also used to retrieve the count of</span>
<a href="#l31.35"></a><span id="l31.35" class="difflineminus">-     elements in the container.</span>
<a href="#l31.36"></a><span id="l31.36" class="difflineminus">-</span>
<a href="#l31.37"></a><span id="l31.37" class="difflineminus">- */</span>
<a href="#l31.38"></a><span id="l31.38" class="difflineminus">-</span>
<a href="#l31.39"></a><span id="l31.39" class="difflineminus">-</span>
<a href="#l31.40"></a><span id="l31.40" class="difflineminus">-#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l31.41"></a><span id="l31.41" class="difflineminus">-#include &quot;nsIRDFContainer.h&quot;</span>
<a href="#l31.42"></a><span id="l31.42" class="difflineminus">-#include &quot;nsIRDFContainerUtils.h&quot;</span>
<a href="#l31.43"></a><span id="l31.43" class="difflineminus">-#include &quot;nsIRDFInMemoryDataSource.h&quot;</span>
<a href="#l31.44"></a><span id="l31.44" class="difflineminus">-#include &quot;nsIRDFPropagatableDataSource.h&quot;</span>
<a href="#l31.45"></a><span id="l31.45" class="difflineminus">-#include &quot;nsIRDFService.h&quot;</span>
<a href="#l31.46"></a><span id="l31.46" class="difflineminus">-#include &quot;nsIServiceManager.h&quot;</span>
<a href="#l31.47"></a><span id="l31.47" class="difflineminus">-#include &quot;nsRDFCID.h&quot;</span>
<a href="#l31.48"></a><span id="l31.48" class="difflineminus">-#include &quot;nsString.h&quot;</span>
<a href="#l31.49"></a><span id="l31.49" class="difflineminus">-#include &quot;rdf.h&quot;</span>
<a href="#l31.50"></a><span id="l31.50" class="difflineminus">-</span>
<a href="#l31.51"></a><span id="l31.51" class="difflineminus">-#define RDF_SEQ_LIST_LIMIT   8</span>
<a href="#l31.52"></a><span id="l31.52" class="difflineminus">-</span>
<a href="#l31.53"></a><span id="l31.53" class="difflineminus">-class RDFContainerImpl : public nsIRDFContainer</span>
<a href="#l31.54"></a><span id="l31.54" class="difflineminus">-{</span>
<a href="#l31.55"></a><span id="l31.55" class="difflineminus">-public:</span>
<a href="#l31.56"></a><span id="l31.56" class="difflineminus">-</span>
<a href="#l31.57"></a><span id="l31.57" class="difflineminus">-    // nsISupports interface</span>
<a href="#l31.58"></a><span id="l31.58" class="difflineminus">-    NS_DECL_ISUPPORTS</span>
<a href="#l31.59"></a><span id="l31.59" class="difflineminus">-</span>
<a href="#l31.60"></a><span id="l31.60" class="difflineminus">-    // nsIRDFContainer interface</span>
<a href="#l31.61"></a><span id="l31.61" class="difflineminus">-    NS_DECL_NSIRDFCONTAINER</span>
<a href="#l31.62"></a><span id="l31.62" class="difflineminus">-</span>
<a href="#l31.63"></a><span id="l31.63" class="difflineminus">-private:</span>
<a href="#l31.64"></a><span id="l31.64" class="difflineminus">-    friend nsresult NS_NewRDFContainer(nsIRDFContainer** aResult);</span>
<a href="#l31.65"></a><span id="l31.65" class="difflineminus">-</span>
<a href="#l31.66"></a><span id="l31.66" class="difflineminus">-    RDFContainerImpl();</span>
<a href="#l31.67"></a><span id="l31.67" class="difflineminus">-    virtual ~RDFContainerImpl();</span>
<a href="#l31.68"></a><span id="l31.68" class="difflineminus">-</span>
<a href="#l31.69"></a><span id="l31.69" class="difflineminus">-    nsresult Init();</span>
<a href="#l31.70"></a><span id="l31.70" class="difflineminus">-</span>
<a href="#l31.71"></a><span id="l31.71" class="difflineminus">-    nsresult Renumber(int32_t aStartIndex, int32_t aIncrement);</span>
<a href="#l31.72"></a><span id="l31.72" class="difflineminus">-    nsresult SetNextValue(int32_t aIndex);</span>
<a href="#l31.73"></a><span id="l31.73" class="difflineminus">-    nsresult GetNextValue(nsIRDFResource** aResult);</span>
<a href="#l31.74"></a><span id="l31.74" class="difflineminus">-</span>
<a href="#l31.75"></a><span id="l31.75" class="difflineminus">-    nsIRDFDataSource* mDataSource;</span>
<a href="#l31.76"></a><span id="l31.76" class="difflineminus">-    nsIRDFResource*   mContainer;</span>
<a href="#l31.77"></a><span id="l31.77" class="difflineminus">-</span>
<a href="#l31.78"></a><span id="l31.78" class="difflineminus">-    // pseudo constants</span>
<a href="#l31.79"></a><span id="l31.79" class="difflineminus">-    static int32_t gRefCnt;</span>
<a href="#l31.80"></a><span id="l31.80" class="difflineminus">-    static nsIRDFService*        gRDFService;</span>
<a href="#l31.81"></a><span id="l31.81" class="difflineminus">-    static nsIRDFContainerUtils* gRDFContainerUtils;</span>
<a href="#l31.82"></a><span id="l31.82" class="difflineminus">-    static nsIRDFResource*       kRDF_nextVal;</span>
<a href="#l31.83"></a><span id="l31.83" class="difflineminus">-};</span>
<a href="#l31.84"></a><span id="l31.84" class="difflineminus">-</span>
<a href="#l31.85"></a><span id="l31.85" class="difflineminus">-</span>
<a href="#l31.86"></a><span id="l31.86" class="difflineminus">-int32_t               RDFContainerImpl::gRefCnt = 0;</span>
<a href="#l31.87"></a><span id="l31.87" class="difflineminus">-nsIRDFService*        RDFContainerImpl::gRDFService;</span>
<a href="#l31.88"></a><span id="l31.88" class="difflineminus">-nsIRDFContainerUtils* RDFContainerImpl::gRDFContainerUtils;</span>
<a href="#l31.89"></a><span id="l31.89" class="difflineminus">-nsIRDFResource*       RDFContainerImpl::kRDF_nextVal;</span>
<a href="#l31.90"></a><span id="l31.90" class="difflineminus">-</span>
<a href="#l31.91"></a><span id="l31.91" class="difflineminus">-////////////////////////////////////////////////////////////////////////</span>
<a href="#l31.92"></a><span id="l31.92" class="difflineminus">-// nsISupports interface</span>
<a href="#l31.93"></a><span id="l31.93" class="difflineminus">-</span>
<a href="#l31.94"></a><span id="l31.94" class="difflineminus">-NS_IMPL_ISUPPORTS(RDFContainerImpl, nsIRDFContainer)</span>
<a href="#l31.95"></a><span id="l31.95" class="difflineminus">-</span>
<a href="#l31.96"></a><span id="l31.96" class="difflineminus">-</span>
<a href="#l31.97"></a><span id="l31.97" class="difflineminus">-</span>
<a href="#l31.98"></a><span id="l31.98" class="difflineminus">-////////////////////////////////////////////////////////////////////////</span>
<a href="#l31.99"></a><span id="l31.99" class="difflineminus">-// nsIRDFContainer interface</span>
<a href="#l31.100"></a><span id="l31.100" class="difflineminus">-</span>
<a href="#l31.101"></a><span id="l31.101" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l31.102"></a><span id="l31.102" class="difflineminus">-RDFContainerImpl::GetDataSource(nsIRDFDataSource** _retval)</span>
<a href="#l31.103"></a><span id="l31.103" class="difflineminus">-{</span>
<a href="#l31.104"></a><span id="l31.104" class="difflineminus">-    *_retval = mDataSource;</span>
<a href="#l31.105"></a><span id="l31.105" class="difflineminus">-    NS_IF_ADDREF(*_retval);</span>
<a href="#l31.106"></a><span id="l31.106" class="difflineminus">-    return NS_OK;</span>
<a href="#l31.107"></a><span id="l31.107" class="difflineminus">-}</span>
<a href="#l31.108"></a><span id="l31.108" class="difflineminus">-</span>
<a href="#l31.109"></a><span id="l31.109" class="difflineminus">-</span>
<a href="#l31.110"></a><span id="l31.110" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l31.111"></a><span id="l31.111" class="difflineminus">-RDFContainerImpl::GetResource(nsIRDFResource** _retval)</span>
<a href="#l31.112"></a><span id="l31.112" class="difflineminus">-{</span>
<a href="#l31.113"></a><span id="l31.113" class="difflineminus">-    *_retval = mContainer;</span>
<a href="#l31.114"></a><span id="l31.114" class="difflineminus">-    NS_IF_ADDREF(*_retval);</span>
<a href="#l31.115"></a><span id="l31.115" class="difflineminus">-    return NS_OK;</span>
<a href="#l31.116"></a><span id="l31.116" class="difflineminus">-}</span>
<a href="#l31.117"></a><span id="l31.117" class="difflineminus">-</span>
<a href="#l31.118"></a><span id="l31.118" class="difflineminus">-</span>
<a href="#l31.119"></a><span id="l31.119" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l31.120"></a><span id="l31.120" class="difflineminus">-RDFContainerImpl::Init(nsIRDFDataSource *aDataSource, nsIRDFResource *aContainer)</span>
<a href="#l31.121"></a><span id="l31.121" class="difflineminus">-{</span>
<a href="#l31.122"></a><span id="l31.122" class="difflineminus">-    NS_ASSERTION(aDataSource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l31.123"></a><span id="l31.123" class="difflineminus">-    if (! aDataSource)</span>
<a href="#l31.124"></a><span id="l31.124" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l31.125"></a><span id="l31.125" class="difflineminus">-</span>
<a href="#l31.126"></a><span id="l31.126" class="difflineminus">-    NS_ASSERTION(aContainer != nullptr, &quot;null ptr&quot;);</span>
<a href="#l31.127"></a><span id="l31.127" class="difflineminus">-    if (! aContainer)</span>
<a href="#l31.128"></a><span id="l31.128" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l31.129"></a><span id="l31.129" class="difflineminus">-</span>
<a href="#l31.130"></a><span id="l31.130" class="difflineminus">-    nsresult rv;</span>
<a href="#l31.131"></a><span id="l31.131" class="difflineminus">-    bool isContainer;</span>
<a href="#l31.132"></a><span id="l31.132" class="difflineminus">-    rv = gRDFContainerUtils-&gt;IsContainer(aDataSource, aContainer, &amp;isContainer);</span>
<a href="#l31.133"></a><span id="l31.133" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l31.134"></a><span id="l31.134" class="difflineminus">-</span>
<a href="#l31.135"></a><span id="l31.135" class="difflineminus">-    // ``throw'' if we can't create a container on the specified</span>
<a href="#l31.136"></a><span id="l31.136" class="difflineminus">-    // datasource/resource combination.</span>
<a href="#l31.137"></a><span id="l31.137" class="difflineminus">-    if (! isContainer)</span>
<a href="#l31.138"></a><span id="l31.138" class="difflineminus">-        return NS_ERROR_FAILURE;</span>
<a href="#l31.139"></a><span id="l31.139" class="difflineminus">-</span>
<a href="#l31.140"></a><span id="l31.140" class="difflineminus">-    NS_IF_RELEASE(mDataSource);</span>
<a href="#l31.141"></a><span id="l31.141" class="difflineminus">-    mDataSource = aDataSource;</span>
<a href="#l31.142"></a><span id="l31.142" class="difflineminus">-    NS_ADDREF(mDataSource);</span>
<a href="#l31.143"></a><span id="l31.143" class="difflineminus">-</span>
<a href="#l31.144"></a><span id="l31.144" class="difflineminus">-    NS_IF_RELEASE(mContainer);</span>
<a href="#l31.145"></a><span id="l31.145" class="difflineminus">-    mContainer = aContainer;</span>
<a href="#l31.146"></a><span id="l31.146" class="difflineminus">-    NS_ADDREF(mContainer);</span>
<a href="#l31.147"></a><span id="l31.147" class="difflineminus">-</span>
<a href="#l31.148"></a><span id="l31.148" class="difflineminus">-    return NS_OK;</span>
<a href="#l31.149"></a><span id="l31.149" class="difflineminus">-}</span>
<a href="#l31.150"></a><span id="l31.150" class="difflineminus">-</span>
<a href="#l31.151"></a><span id="l31.151" class="difflineminus">-</span>
<a href="#l31.152"></a><span id="l31.152" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l31.153"></a><span id="l31.153" class="difflineminus">-RDFContainerImpl::GetCount(int32_t *aCount)</span>
<a href="#l31.154"></a><span id="l31.154" class="difflineminus">-{</span>
<a href="#l31.155"></a><span id="l31.155" class="difflineminus">-    if (!mDataSource || !mContainer)</span>
<a href="#l31.156"></a><span id="l31.156" class="difflineminus">-        return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l31.157"></a><span id="l31.157" class="difflineminus">-</span>
<a href="#l31.158"></a><span id="l31.158" class="difflineminus">-    nsresult rv;</span>
<a href="#l31.159"></a><span id="l31.159" class="difflineminus">-</span>
<a href="#l31.160"></a><span id="l31.160" class="difflineminus">-    // Get the next value, which hangs off of the bag via the</span>
<a href="#l31.161"></a><span id="l31.161" class="difflineminus">-    // RDF:nextVal property. This is the _next value_ that will get</span>
<a href="#l31.162"></a><span id="l31.162" class="difflineminus">-    // assigned in a one-indexed array. So, it's actually _one more_</span>
<a href="#l31.163"></a><span id="l31.163" class="difflineminus">-    // than the actual count of elements in the container.</span>
<a href="#l31.164"></a><span id="l31.164" class="difflineminus">-    //</span>
<a href="#l31.165"></a><span id="l31.165" class="difflineminus">-    // XXX To handle aggregation, this should probably be a</span>
<a href="#l31.166"></a><span id="l31.166" class="difflineminus">-    // GetTargets() that enumerates all of the values and picks the</span>
<a href="#l31.167"></a><span id="l31.167" class="difflineminus">-    // largest one.</span>
<a href="#l31.168"></a><span id="l31.168" class="difflineminus">-    nsCOMPtr&lt;nsIRDFNode&gt; nextValNode;</span>
<a href="#l31.169"></a><span id="l31.169" class="difflineminus">-    rv = mDataSource-&gt;GetTarget(mContainer, kRDF_nextVal, true, getter_AddRefs(nextValNode));</span>
<a href="#l31.170"></a><span id="l31.170" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l31.171"></a><span id="l31.171" class="difflineminus">-</span>
<a href="#l31.172"></a><span id="l31.172" class="difflineminus">-    if (rv == NS_RDF_NO_VALUE)</span>
<a href="#l31.173"></a><span id="l31.173" class="difflineminus">-        return NS_ERROR_UNEXPECTED;</span>
<a href="#l31.174"></a><span id="l31.174" class="difflineminus">-</span>
<a href="#l31.175"></a><span id="l31.175" class="difflineminus">-    nsCOMPtr&lt;nsIRDFLiteral&gt; nextValLiteral;</span>
<a href="#l31.176"></a><span id="l31.176" class="difflineminus">-    rv = nextValNode-&gt;QueryInterface(NS_GET_IID(nsIRDFLiteral), getter_AddRefs(nextValLiteral));</span>
<a href="#l31.177"></a><span id="l31.177" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l31.178"></a><span id="l31.178" class="difflineminus">-</span>
<a href="#l31.179"></a><span id="l31.179" class="difflineminus">-    const char16_t *s;</span>
<a href="#l31.180"></a><span id="l31.180" class="difflineminus">-    rv = nextValLiteral-&gt;GetValueConst( &amp;s );</span>
<a href="#l31.181"></a><span id="l31.181" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l31.182"></a><span id="l31.182" class="difflineminus">-</span>
<a href="#l31.183"></a><span id="l31.183" class="difflineminus">-    nsAutoString nextValStr(s);</span>
<a href="#l31.184"></a><span id="l31.184" class="difflineminus">-</span>
<a href="#l31.185"></a><span id="l31.185" class="difflineminus">-    int32_t nextVal;</span>
<a href="#l31.186"></a><span id="l31.186" class="difflineminus">-    nsresult err;</span>
<a href="#l31.187"></a><span id="l31.187" class="difflineminus">-    nextVal = nextValStr.ToInteger(&amp;err);</span>
<a href="#l31.188"></a><span id="l31.188" class="difflineminus">-    if (NS_FAILED(err))</span>
<a href="#l31.189"></a><span id="l31.189" class="difflineminus">-        return NS_ERROR_UNEXPECTED;</span>
<a href="#l31.190"></a><span id="l31.190" class="difflineminus">-</span>
<a href="#l31.191"></a><span id="l31.191" class="difflineminus">-    *aCount = nextVal - 1;</span>
<a href="#l31.192"></a><span id="l31.192" class="difflineminus">-    return NS_OK;</span>
<a href="#l31.193"></a><span id="l31.193" class="difflineminus">-}</span>
<a href="#l31.194"></a><span id="l31.194" class="difflineminus">-</span>
<a href="#l31.195"></a><span id="l31.195" class="difflineminus">-</span>
<a href="#l31.196"></a><span id="l31.196" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l31.197"></a><span id="l31.197" class="difflineminus">-RDFContainerImpl::GetElements(nsISimpleEnumerator **_retval)</span>
<a href="#l31.198"></a><span id="l31.198" class="difflineminus">-{</span>
<a href="#l31.199"></a><span id="l31.199" class="difflineminus">-    if (!mDataSource || !mContainer)</span>
<a href="#l31.200"></a><span id="l31.200" class="difflineminus">-        return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l31.201"></a><span id="l31.201" class="difflineminus">-</span>
<a href="#l31.202"></a><span id="l31.202" class="difflineminus">-    return NS_NewContainerEnumerator(mDataSource, mContainer, _retval);</span>
<a href="#l31.203"></a><span id="l31.203" class="difflineminus">-}</span>
<a href="#l31.204"></a><span id="l31.204" class="difflineminus">-</span>
<a href="#l31.205"></a><span id="l31.205" class="difflineminus">-</span>
<a href="#l31.206"></a><span id="l31.206" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l31.207"></a><span id="l31.207" class="difflineminus">-RDFContainerImpl::AppendElement(nsIRDFNode *aElement)</span>
<a href="#l31.208"></a><span id="l31.208" class="difflineminus">-{</span>
<a href="#l31.209"></a><span id="l31.209" class="difflineminus">-    if (!mDataSource || !mContainer)</span>
<a href="#l31.210"></a><span id="l31.210" class="difflineminus">-        return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l31.211"></a><span id="l31.211" class="difflineminus">-</span>
<a href="#l31.212"></a><span id="l31.212" class="difflineminus">-    NS_ASSERTION(aElement != nullptr, &quot;null ptr&quot;);</span>
<a href="#l31.213"></a><span id="l31.213" class="difflineminus">-    if (! aElement)</span>
<a href="#l31.214"></a><span id="l31.214" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l31.215"></a><span id="l31.215" class="difflineminus">-</span>
<a href="#l31.216"></a><span id="l31.216" class="difflineminus">-    nsresult rv;</span>
<a href="#l31.217"></a><span id="l31.217" class="difflineminus">-</span>
<a href="#l31.218"></a><span id="l31.218" class="difflineminus">-    nsCOMPtr&lt;nsIRDFResource&gt; nextVal;</span>
<a href="#l31.219"></a><span id="l31.219" class="difflineminus">-    rv = GetNextValue(getter_AddRefs(nextVal));</span>
<a href="#l31.220"></a><span id="l31.220" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l31.221"></a><span id="l31.221" class="difflineminus">-</span>
<a href="#l31.222"></a><span id="l31.222" class="difflineminus">-    rv = mDataSource-&gt;Assert(mContainer, nextVal, aElement, true);</span>
<a href="#l31.223"></a><span id="l31.223" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l31.224"></a><span id="l31.224" class="difflineminus">-</span>
<a href="#l31.225"></a><span id="l31.225" class="difflineminus">-    return NS_OK;</span>
<a href="#l31.226"></a><span id="l31.226" class="difflineminus">-}</span>
<a href="#l31.227"></a><span id="l31.227" class="difflineminus">-</span>
<a href="#l31.228"></a><span id="l31.228" class="difflineminus">-</span>
<a href="#l31.229"></a><span id="l31.229" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l31.230"></a><span id="l31.230" class="difflineminus">-RDFContainerImpl::RemoveElement(nsIRDFNode *aElement, bool aRenumber)</span>
<a href="#l31.231"></a><span id="l31.231" class="difflineminus">-{</span>
<a href="#l31.232"></a><span id="l31.232" class="difflineminus">-    if (!mDataSource || !mContainer)</span>
<a href="#l31.233"></a><span id="l31.233" class="difflineminus">-        return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l31.234"></a><span id="l31.234" class="difflineminus">-</span>
<a href="#l31.235"></a><span id="l31.235" class="difflineminus">-    NS_ASSERTION(aElement != nullptr, &quot;null ptr&quot;);</span>
<a href="#l31.236"></a><span id="l31.236" class="difflineminus">-    if (! aElement)</span>
<a href="#l31.237"></a><span id="l31.237" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l31.238"></a><span id="l31.238" class="difflineminus">-</span>
<a href="#l31.239"></a><span id="l31.239" class="difflineminus">-    nsresult rv;</span>
<a href="#l31.240"></a><span id="l31.240" class="difflineminus">-</span>
<a href="#l31.241"></a><span id="l31.241" class="difflineminus">-    int32_t idx;</span>
<a href="#l31.242"></a><span id="l31.242" class="difflineminus">-    rv = IndexOf(aElement, &amp;idx);</span>
<a href="#l31.243"></a><span id="l31.243" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l31.244"></a><span id="l31.244" class="difflineminus">-</span>
<a href="#l31.245"></a><span id="l31.245" class="difflineminus">-    if (idx &lt; 0)</span>
<a href="#l31.246"></a><span id="l31.246" class="difflineminus">-        return NS_OK;</span>
<a href="#l31.247"></a><span id="l31.247" class="difflineminus">-</span>
<a href="#l31.248"></a><span id="l31.248" class="difflineminus">-    // Remove the element.</span>
<a href="#l31.249"></a><span id="l31.249" class="difflineminus">-    nsCOMPtr&lt;nsIRDFResource&gt; ordinal;</span>
<a href="#l31.250"></a><span id="l31.250" class="difflineminus">-    rv = gRDFContainerUtils-&gt;IndexToOrdinalResource(idx,</span>
<a href="#l31.251"></a><span id="l31.251" class="difflineminus">-                                                    getter_AddRefs(ordinal));</span>
<a href="#l31.252"></a><span id="l31.252" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l31.253"></a><span id="l31.253" class="difflineminus">-</span>
<a href="#l31.254"></a><span id="l31.254" class="difflineminus">-    rv = mDataSource-&gt;Unassert(mContainer, ordinal, aElement);</span>
<a href="#l31.255"></a><span id="l31.255" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l31.256"></a><span id="l31.256" class="difflineminus">-</span>
<a href="#l31.257"></a><span id="l31.257" class="difflineminus">-    if (aRenumber) {</span>
<a href="#l31.258"></a><span id="l31.258" class="difflineminus">-        // Now slide the rest of the collection backwards to fill in</span>
<a href="#l31.259"></a><span id="l31.259" class="difflineminus">-        // the gap. This will have the side effect of completely</span>
<a href="#l31.260"></a><span id="l31.260" class="difflineminus">-        // renumber the container from index to the end.</span>
<a href="#l31.261"></a><span id="l31.261" class="difflineminus">-        rv = Renumber(idx + 1, -1);</span>
<a href="#l31.262"></a><span id="l31.262" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l31.263"></a><span id="l31.263" class="difflineminus">-    }</span>
<a href="#l31.264"></a><span id="l31.264" class="difflineminus">-</span>
<a href="#l31.265"></a><span id="l31.265" class="difflineminus">-    return NS_OK;</span>
<a href="#l31.266"></a><span id="l31.266" class="difflineminus">-}</span>
<a href="#l31.267"></a><span id="l31.267" class="difflineminus">-</span>
<a href="#l31.268"></a><span id="l31.268" class="difflineminus">-</span>
<a href="#l31.269"></a><span id="l31.269" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l31.270"></a><span id="l31.270" class="difflineminus">-RDFContainerImpl::InsertElementAt(nsIRDFNode *aElement, int32_t aIndex, bool aRenumber)</span>
<a href="#l31.271"></a><span id="l31.271" class="difflineminus">-{</span>
<a href="#l31.272"></a><span id="l31.272" class="difflineminus">-    if (!mDataSource || !mContainer)</span>
<a href="#l31.273"></a><span id="l31.273" class="difflineminus">-        return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l31.274"></a><span id="l31.274" class="difflineminus">-</span>
<a href="#l31.275"></a><span id="l31.275" class="difflineminus">-    NS_ASSERTION(aElement != nullptr, &quot;null ptr&quot;);</span>
<a href="#l31.276"></a><span id="l31.276" class="difflineminus">-    if (! aElement)</span>
<a href="#l31.277"></a><span id="l31.277" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l31.278"></a><span id="l31.278" class="difflineminus">-</span>
<a href="#l31.279"></a><span id="l31.279" class="difflineminus">-    NS_ASSERTION(aIndex &gt;= 1, &quot;illegal value&quot;);</span>
<a href="#l31.280"></a><span id="l31.280" class="difflineminus">-    if (aIndex &lt; 1)</span>
<a href="#l31.281"></a><span id="l31.281" class="difflineminus">-        return NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l31.282"></a><span id="l31.282" class="difflineminus">-</span>
<a href="#l31.283"></a><span id="l31.283" class="difflineminus">-    nsresult rv;</span>
<a href="#l31.284"></a><span id="l31.284" class="difflineminus">-</span>
<a href="#l31.285"></a><span id="l31.285" class="difflineminus">-    int32_t count;</span>
<a href="#l31.286"></a><span id="l31.286" class="difflineminus">-    rv = GetCount(&amp;count);</span>
<a href="#l31.287"></a><span id="l31.287" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l31.288"></a><span id="l31.288" class="difflineminus">-</span>
<a href="#l31.289"></a><span id="l31.289" class="difflineminus">-    NS_ASSERTION(aIndex &lt;= count + 1, &quot;illegal value&quot;);</span>
<a href="#l31.290"></a><span id="l31.290" class="difflineminus">-    if (aIndex &gt; count + 1)</span>
<a href="#l31.291"></a><span id="l31.291" class="difflineminus">-        return NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l31.292"></a><span id="l31.292" class="difflineminus">-</span>
<a href="#l31.293"></a><span id="l31.293" class="difflineminus">-    if (aRenumber) {</span>
<a href="#l31.294"></a><span id="l31.294" class="difflineminus">-        // Make a hole for the element. This will have the side effect of</span>
<a href="#l31.295"></a><span id="l31.295" class="difflineminus">-        // completely renumbering the container from 'aIndex' to 'count',</span>
<a href="#l31.296"></a><span id="l31.296" class="difflineminus">-        // and will spew assertions.</span>
<a href="#l31.297"></a><span id="l31.297" class="difflineminus">-        rv = Renumber(aIndex, +1);</span>
<a href="#l31.298"></a><span id="l31.298" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l31.299"></a><span id="l31.299" class="difflineminus">-    }</span>
<a href="#l31.300"></a><span id="l31.300" class="difflineminus">-</span>
<a href="#l31.301"></a><span id="l31.301" class="difflineminus">-    nsCOMPtr&lt;nsIRDFResource&gt; ordinal;</span>
<a href="#l31.302"></a><span id="l31.302" class="difflineminus">-    rv = gRDFContainerUtils-&gt;IndexToOrdinalResource(aIndex, getter_AddRefs(ordinal));</span>
<a href="#l31.303"></a><span id="l31.303" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l31.304"></a><span id="l31.304" class="difflineminus">-</span>
<a href="#l31.305"></a><span id="l31.305" class="difflineminus">-    rv = mDataSource-&gt;Assert(mContainer, ordinal, aElement, true);</span>
<a href="#l31.306"></a><span id="l31.306" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l31.307"></a><span id="l31.307" class="difflineminus">-</span>
<a href="#l31.308"></a><span id="l31.308" class="difflineminus">-    return NS_OK;</span>
<a href="#l31.309"></a><span id="l31.309" class="difflineminus">-}</span>
<a href="#l31.310"></a><span id="l31.310" class="difflineminus">-</span>
<a href="#l31.311"></a><span id="l31.311" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l31.312"></a><span id="l31.312" class="difflineminus">-RDFContainerImpl::RemoveElementAt(int32_t aIndex, bool aRenumber, nsIRDFNode** _retval)</span>
<a href="#l31.313"></a><span id="l31.313" class="difflineminus">-{</span>
<a href="#l31.314"></a><span id="l31.314" class="difflineminus">-    if (!mDataSource || !mContainer)</span>
<a href="#l31.315"></a><span id="l31.315" class="difflineminus">-        return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l31.316"></a><span id="l31.316" class="difflineminus">-</span>
<a href="#l31.317"></a><span id="l31.317" class="difflineminus">-    *_retval = nullptr;</span>
<a href="#l31.318"></a><span id="l31.318" class="difflineminus">-</span>
<a href="#l31.319"></a><span id="l31.319" class="difflineminus">-    if (aIndex&lt; 1)</span>
<a href="#l31.320"></a><span id="l31.320" class="difflineminus">-        return NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l31.321"></a><span id="l31.321" class="difflineminus">-</span>
<a href="#l31.322"></a><span id="l31.322" class="difflineminus">-    nsresult rv;</span>
<a href="#l31.323"></a><span id="l31.323" class="difflineminus">-</span>
<a href="#l31.324"></a><span id="l31.324" class="difflineminus">-    int32_t count;</span>
<a href="#l31.325"></a><span id="l31.325" class="difflineminus">-    rv = GetCount(&amp;count);</span>
<a href="#l31.326"></a><span id="l31.326" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l31.327"></a><span id="l31.327" class="difflineminus">-</span>
<a href="#l31.328"></a><span id="l31.328" class="difflineminus">-    if (aIndex &gt; count)</span>
<a href="#l31.329"></a><span id="l31.329" class="difflineminus">-        return NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l31.330"></a><span id="l31.330" class="difflineminus">-</span>
<a href="#l31.331"></a><span id="l31.331" class="difflineminus">-    nsCOMPtr&lt;nsIRDFResource&gt; ordinal;</span>
<a href="#l31.332"></a><span id="l31.332" class="difflineminus">-    rv = gRDFContainerUtils-&gt;IndexToOrdinalResource(aIndex, getter_AddRefs(ordinal));</span>
<a href="#l31.333"></a><span id="l31.333" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l31.334"></a><span id="l31.334" class="difflineminus">-</span>
<a href="#l31.335"></a><span id="l31.335" class="difflineminus">-    nsCOMPtr&lt;nsIRDFNode&gt; old;</span>
<a href="#l31.336"></a><span id="l31.336" class="difflineminus">-    rv = mDataSource-&gt;GetTarget(mContainer, ordinal, true, getter_AddRefs(old));</span>
<a href="#l31.337"></a><span id="l31.337" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l31.338"></a><span id="l31.338" class="difflineminus">-</span>
<a href="#l31.339"></a><span id="l31.339" class="difflineminus">-    if (rv == NS_OK) {</span>
<a href="#l31.340"></a><span id="l31.340" class="difflineminus">-        rv = mDataSource-&gt;Unassert(mContainer, ordinal, old);</span>
<a href="#l31.341"></a><span id="l31.341" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l31.342"></a><span id="l31.342" class="difflineminus">-</span>
<a href="#l31.343"></a><span id="l31.343" class="difflineminus">-        if (aRenumber) {</span>
<a href="#l31.344"></a><span id="l31.344" class="difflineminus">-            // Now slide the rest of the collection backwards to fill in</span>
<a href="#l31.345"></a><span id="l31.345" class="difflineminus">-            // the gap. This will have the side effect of completely</span>
<a href="#l31.346"></a><span id="l31.346" class="difflineminus">-            // renumber the container from index to the end.</span>
<a href="#l31.347"></a><span id="l31.347" class="difflineminus">-            rv = Renumber(aIndex + 1, -1);</span>
<a href="#l31.348"></a><span id="l31.348" class="difflineminus">-            if (NS_FAILED(rv)) return rv;</span>
<a href="#l31.349"></a><span id="l31.349" class="difflineminus">-        }</span>
<a href="#l31.350"></a><span id="l31.350" class="difflineminus">-    }</span>
<a href="#l31.351"></a><span id="l31.351" class="difflineminus">-</span>
<a href="#l31.352"></a><span id="l31.352" class="difflineminus">-    old.swap(*_retval);</span>
<a href="#l31.353"></a><span id="l31.353" class="difflineminus">-</span>
<a href="#l31.354"></a><span id="l31.354" class="difflineminus">-    return NS_OK;</span>
<a href="#l31.355"></a><span id="l31.355" class="difflineminus">-}</span>
<a href="#l31.356"></a><span id="l31.356" class="difflineminus">-</span>
<a href="#l31.357"></a><span id="l31.357" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l31.358"></a><span id="l31.358" class="difflineminus">-RDFContainerImpl::IndexOf(nsIRDFNode *aElement, int32_t *aIndex)</span>
<a href="#l31.359"></a><span id="l31.359" class="difflineminus">-{</span>
<a href="#l31.360"></a><span id="l31.360" class="difflineminus">-    if (!mDataSource || !mContainer)</span>
<a href="#l31.361"></a><span id="l31.361" class="difflineminus">-        return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l31.362"></a><span id="l31.362" class="difflineminus">-</span>
<a href="#l31.363"></a><span id="l31.363" class="difflineminus">-    return gRDFContainerUtils-&gt;IndexOf(mDataSource, mContainer,</span>
<a href="#l31.364"></a><span id="l31.364" class="difflineminus">-                                       aElement, aIndex);</span>
<a href="#l31.365"></a><span id="l31.365" class="difflineminus">-}</span>
<a href="#l31.366"></a><span id="l31.366" class="difflineminus">-</span>
<a href="#l31.367"></a><span id="l31.367" class="difflineminus">-</span>
<a href="#l31.368"></a><span id="l31.368" class="difflineminus">-////////////////////////////////////////////////////////////////////////</span>
<a href="#l31.369"></a><span id="l31.369" class="difflineminus">-</span>
<a href="#l31.370"></a><span id="l31.370" class="difflineminus">-</span>
<a href="#l31.371"></a><span id="l31.371" class="difflineminus">-RDFContainerImpl::RDFContainerImpl()</span>
<a href="#l31.372"></a><span id="l31.372" class="difflineminus">-    : mDataSource(nullptr), mContainer(nullptr)</span>
<a href="#l31.373"></a><span id="l31.373" class="difflineminus">-{</span>
<a href="#l31.374"></a><span id="l31.374" class="difflineminus">-}</span>
<a href="#l31.375"></a><span id="l31.375" class="difflineminus">-</span>
<a href="#l31.376"></a><span id="l31.376" class="difflineminus">-</span>
<a href="#l31.377"></a><span id="l31.377" class="difflineminus">-nsresult</span>
<a href="#l31.378"></a><span id="l31.378" class="difflineminus">-RDFContainerImpl::Init()</span>
<a href="#l31.379"></a><span id="l31.379" class="difflineminus">-{</span>
<a href="#l31.380"></a><span id="l31.380" class="difflineminus">-    if (gRefCnt++ == 0) {</span>
<a href="#l31.381"></a><span id="l31.381" class="difflineminus">-        nsresult rv;</span>
<a href="#l31.382"></a><span id="l31.382" class="difflineminus">-</span>
<a href="#l31.383"></a><span id="l31.383" class="difflineminus">-        NS_DEFINE_CID(kRDFServiceCID, NS_RDFSERVICE_CID);</span>
<a href="#l31.384"></a><span id="l31.384" class="difflineminus">-        rv = CallGetService(kRDFServiceCID, &amp;gRDFService);</span>
<a href="#l31.385"></a><span id="l31.385" class="difflineminus">-        if (NS_FAILED(rv)) {</span>
<a href="#l31.386"></a><span id="l31.386" class="difflineminus">-            NS_ERROR(&quot;unable to get RDF service&quot;);</span>
<a href="#l31.387"></a><span id="l31.387" class="difflineminus">-            return rv;</span>
<a href="#l31.388"></a><span id="l31.388" class="difflineminus">-        }</span>
<a href="#l31.389"></a><span id="l31.389" class="difflineminus">-</span>
<a href="#l31.390"></a><span id="l31.390" class="difflineminus">-        rv = gRDFService-&gt;GetResource(NS_LITERAL_CSTRING(RDF_NAMESPACE_URI &quot;nextVal&quot;),</span>
<a href="#l31.391"></a><span id="l31.391" class="difflineminus">-                                      &amp;kRDF_nextVal);</span>
<a href="#l31.392"></a><span id="l31.392" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l31.393"></a><span id="l31.393" class="difflineminus">-</span>
<a href="#l31.394"></a><span id="l31.394" class="difflineminus">-        NS_DEFINE_CID(kRDFContainerUtilsCID, NS_RDFCONTAINERUTILS_CID);</span>
<a href="#l31.395"></a><span id="l31.395" class="difflineminus">-        rv = CallGetService(kRDFContainerUtilsCID, &amp;gRDFContainerUtils);</span>
<a href="#l31.396"></a><span id="l31.396" class="difflineminus">-        if (NS_FAILED(rv)) {</span>
<a href="#l31.397"></a><span id="l31.397" class="difflineminus">-            NS_ERROR(&quot;unable to get RDF container utils service&quot;);</span>
<a href="#l31.398"></a><span id="l31.398" class="difflineminus">-            return rv;</span>
<a href="#l31.399"></a><span id="l31.399" class="difflineminus">-        }</span>
<a href="#l31.400"></a><span id="l31.400" class="difflineminus">-    }</span>
<a href="#l31.401"></a><span id="l31.401" class="difflineminus">-</span>
<a href="#l31.402"></a><span id="l31.402" class="difflineminus">-    return NS_OK;</span>
<a href="#l31.403"></a><span id="l31.403" class="difflineminus">-}</span>
<a href="#l31.404"></a><span id="l31.404" class="difflineminus">-</span>
<a href="#l31.405"></a><span id="l31.405" class="difflineminus">-</span>
<a href="#l31.406"></a><span id="l31.406" class="difflineminus">-RDFContainerImpl::~RDFContainerImpl()</span>
<a href="#l31.407"></a><span id="l31.407" class="difflineminus">-{</span>
<a href="#l31.408"></a><span id="l31.408" class="difflineminus">-#ifdef DEBUG_REFS</span>
<a href="#l31.409"></a><span id="l31.409" class="difflineminus">-    --gInstanceCount;</span>
<a href="#l31.410"></a><span id="l31.410" class="difflineminus">-    fprintf(stdout, &quot;%d - RDF: RDFContainerImpl\n&quot;, gInstanceCount);</span>
<a href="#l31.411"></a><span id="l31.411" class="difflineminus">-#endif</span>
<a href="#l31.412"></a><span id="l31.412" class="difflineminus">-</span>
<a href="#l31.413"></a><span id="l31.413" class="difflineminus">-    NS_IF_RELEASE(mContainer);</span>
<a href="#l31.414"></a><span id="l31.414" class="difflineminus">-    NS_IF_RELEASE(mDataSource);</span>
<a href="#l31.415"></a><span id="l31.415" class="difflineminus">-</span>
<a href="#l31.416"></a><span id="l31.416" class="difflineminus">-    if (--gRefCnt == 0) {</span>
<a href="#l31.417"></a><span id="l31.417" class="difflineminus">-        NS_IF_RELEASE(gRDFContainerUtils);</span>
<a href="#l31.418"></a><span id="l31.418" class="difflineminus">-        NS_IF_RELEASE(gRDFService);</span>
<a href="#l31.419"></a><span id="l31.419" class="difflineminus">-        NS_IF_RELEASE(kRDF_nextVal);</span>
<a href="#l31.420"></a><span id="l31.420" class="difflineminus">-    }</span>
<a href="#l31.421"></a><span id="l31.421" class="difflineminus">-}</span>
<a href="#l31.422"></a><span id="l31.422" class="difflineminus">-</span>
<a href="#l31.423"></a><span id="l31.423" class="difflineminus">-</span>
<a href="#l31.424"></a><span id="l31.424" class="difflineminus">-nsresult</span>
<a href="#l31.425"></a><span id="l31.425" class="difflineminus">-NS_NewRDFContainer(nsIRDFContainer** aResult)</span>
<a href="#l31.426"></a><span id="l31.426" class="difflineminus">-{</span>
<a href="#l31.427"></a><span id="l31.427" class="difflineminus">-    RDFContainerImpl* result = new RDFContainerImpl();</span>
<a href="#l31.428"></a><span id="l31.428" class="difflineminus">-    if (! result)</span>
<a href="#l31.429"></a><span id="l31.429" class="difflineminus">-        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l31.430"></a><span id="l31.430" class="difflineminus">-</span>
<a href="#l31.431"></a><span id="l31.431" class="difflineminus">-    nsresult rv;</span>
<a href="#l31.432"></a><span id="l31.432" class="difflineminus">-    rv = result-&gt;Init();</span>
<a href="#l31.433"></a><span id="l31.433" class="difflineminus">-    if (NS_FAILED(rv)) {</span>
<a href="#l31.434"></a><span id="l31.434" class="difflineminus">-        delete result;</span>
<a href="#l31.435"></a><span id="l31.435" class="difflineminus">-        return rv;</span>
<a href="#l31.436"></a><span id="l31.436" class="difflineminus">-    }</span>
<a href="#l31.437"></a><span id="l31.437" class="difflineminus">-</span>
<a href="#l31.438"></a><span id="l31.438" class="difflineminus">-    NS_ADDREF(result);</span>
<a href="#l31.439"></a><span id="l31.439" class="difflineminus">-    *aResult = result;</span>
<a href="#l31.440"></a><span id="l31.440" class="difflineminus">-    return NS_OK;</span>
<a href="#l31.441"></a><span id="l31.441" class="difflineminus">-}</span>
<a href="#l31.442"></a><span id="l31.442" class="difflineminus">-</span>
<a href="#l31.443"></a><span id="l31.443" class="difflineminus">-</span>
<a href="#l31.444"></a><span id="l31.444" class="difflineminus">-nsresult</span>
<a href="#l31.445"></a><span id="l31.445" class="difflineminus">-NS_NewRDFContainer(nsIRDFDataSource* aDataSource,</span>
<a href="#l31.446"></a><span id="l31.446" class="difflineminus">-                   nsIRDFResource* aResource,</span>
<a href="#l31.447"></a><span id="l31.447" class="difflineminus">-                   nsIRDFContainer** aResult)</span>
<a href="#l31.448"></a><span id="l31.448" class="difflineminus">-{</span>
<a href="#l31.449"></a><span id="l31.449" class="difflineminus">-    nsresult rv;</span>
<a href="#l31.450"></a><span id="l31.450" class="difflineminus">-    rv = NS_NewRDFContainer(aResult);</span>
<a href="#l31.451"></a><span id="l31.451" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l31.452"></a><span id="l31.452" class="difflineminus">-</span>
<a href="#l31.453"></a><span id="l31.453" class="difflineminus">-    rv = (*aResult)-&gt;Init(aDataSource, aResource);</span>
<a href="#l31.454"></a><span id="l31.454" class="difflineminus">-    if (NS_FAILED(rv)) {</span>
<a href="#l31.455"></a><span id="l31.455" class="difflineminus">-        NS_RELEASE(*aResult);</span>
<a href="#l31.456"></a><span id="l31.456" class="difflineminus">-    }</span>
<a href="#l31.457"></a><span id="l31.457" class="difflineminus">-    return rv;</span>
<a href="#l31.458"></a><span id="l31.458" class="difflineminus">-}</span>
<a href="#l31.459"></a><span id="l31.459" class="difflineminus">-</span>
<a href="#l31.460"></a><span id="l31.460" class="difflineminus">-</span>
<a href="#l31.461"></a><span id="l31.461" class="difflineminus">-nsresult</span>
<a href="#l31.462"></a><span id="l31.462" class="difflineminus">-RDFContainerImpl::Renumber(int32_t aStartIndex, int32_t aIncrement)</span>
<a href="#l31.463"></a><span id="l31.463" class="difflineminus">-{</span>
<a href="#l31.464"></a><span id="l31.464" class="difflineminus">-    if (!mDataSource || !mContainer)</span>
<a href="#l31.465"></a><span id="l31.465" class="difflineminus">-        return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l31.466"></a><span id="l31.466" class="difflineminus">-</span>
<a href="#l31.467"></a><span id="l31.467" class="difflineminus">-    // Renumber the elements in the container starting with</span>
<a href="#l31.468"></a><span id="l31.468" class="difflineminus">-    // aStartIndex, updating each element's index by aIncrement. For</span>
<a href="#l31.469"></a><span id="l31.469" class="difflineminus">-    // example,</span>
<a href="#l31.470"></a><span id="l31.470" class="difflineminus">-    //</span>
<a href="#l31.471"></a><span id="l31.471" class="difflineminus">-    //   (1:a 2:b 3:c)</span>
<a href="#l31.472"></a><span id="l31.472" class="difflineminus">-    //   Renumber(2, +1);</span>
<a href="#l31.473"></a><span id="l31.473" class="difflineminus">-    //   (1:a 3:b 4:c)</span>
<a href="#l31.474"></a><span id="l31.474" class="difflineminus">-    //   Renumber(3, -1);</span>
<a href="#l31.475"></a><span id="l31.475" class="difflineminus">-    //   (1:a 2:b 3:c)</span>
<a href="#l31.476"></a><span id="l31.476" class="difflineminus">-    //</span>
<a href="#l31.477"></a><span id="l31.477" class="difflineminus">-    nsresult rv;</span>
<a href="#l31.478"></a><span id="l31.478" class="difflineminus">-</span>
<a href="#l31.479"></a><span id="l31.479" class="difflineminus">-    if (! aIncrement)</span>
<a href="#l31.480"></a><span id="l31.480" class="difflineminus">-        return NS_OK;</span>
<a href="#l31.481"></a><span id="l31.481" class="difflineminus">-</span>
<a href="#l31.482"></a><span id="l31.482" class="difflineminus">-    int32_t count;</span>
<a href="#l31.483"></a><span id="l31.483" class="difflineminus">-    rv = GetCount(&amp;count);</span>
<a href="#l31.484"></a><span id="l31.484" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l31.485"></a><span id="l31.485" class="difflineminus">-</span>
<a href="#l31.486"></a><span id="l31.486" class="difflineminus">-    if (aIncrement &gt; 0) {</span>
<a href="#l31.487"></a><span id="l31.487" class="difflineminus">-        // Update the container's nextVal to reflect the</span>
<a href="#l31.488"></a><span id="l31.488" class="difflineminus">-        // renumbering. We do this now if aIncrement &gt; 0 because we'll</span>
<a href="#l31.489"></a><span id="l31.489" class="difflineminus">-        // want to be able to acknowledge that new elements are in the</span>
<a href="#l31.490"></a><span id="l31.490" class="difflineminus">-        // container.</span>
<a href="#l31.491"></a><span id="l31.491" class="difflineminus">-        rv = SetNextValue(count + aIncrement + 1);</span>
<a href="#l31.492"></a><span id="l31.492" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l31.493"></a><span id="l31.493" class="difflineminus">-    }</span>
<a href="#l31.494"></a><span id="l31.494" class="difflineminus">-</span>
<a href="#l31.495"></a><span id="l31.495" class="difflineminus">-    int32_t i;</span>
<a href="#l31.496"></a><span id="l31.496" class="difflineminus">-    if (aIncrement &lt; 0) {</span>
<a href="#l31.497"></a><span id="l31.497" class="difflineminus">-        i = aStartIndex;</span>
<a href="#l31.498"></a><span id="l31.498" class="difflineminus">-    }</span>
<a href="#l31.499"></a><span id="l31.499" class="difflineminus">-    else {</span>
<a href="#l31.500"></a><span id="l31.500" class="difflineminus">-        i = count; // we're one-indexed.</span>
<a href="#l31.501"></a><span id="l31.501" class="difflineminus">-    }</span>
<a href="#l31.502"></a><span id="l31.502" class="difflineminus">-</span>
<a href="#l31.503"></a><span id="l31.503" class="difflineminus">-    // Note: once we disable notifications, don't exit this method until</span>
<a href="#l31.504"></a><span id="l31.504" class="difflineminus">-    // enabling notifications</span>
<a href="#l31.505"></a><span id="l31.505" class="difflineminus">-    nsCOMPtr&lt;nsIRDFPropagatableDataSource&gt; propagatable =</span>
<a href="#l31.506"></a><span id="l31.506" class="difflineminus">-        do_QueryInterface(mDataSource);</span>
<a href="#l31.507"></a><span id="l31.507" class="difflineminus">-    if (propagatable) {</span>
<a href="#l31.508"></a><span id="l31.508" class="difflineminus">-        propagatable-&gt;SetPropagateChanges(false);</span>
<a href="#l31.509"></a><span id="l31.509" class="difflineminus">-    }</span>
<a href="#l31.510"></a><span id="l31.510" class="difflineminus">-</span>
<a href="#l31.511"></a><span id="l31.511" class="difflineminus">-    bool    err = false;</span>
<a href="#l31.512"></a><span id="l31.512" class="difflineminus">-    while (!err &amp;&amp; ((aIncrement &lt; 0) ? (i &lt;= count) : (i &gt;= aStartIndex)))</span>
<a href="#l31.513"></a><span id="l31.513" class="difflineminus">-    {</span>
<a href="#l31.514"></a><span id="l31.514" class="difflineminus">-        nsCOMPtr&lt;nsIRDFResource&gt; oldOrdinal;</span>
<a href="#l31.515"></a><span id="l31.515" class="difflineminus">-        rv = gRDFContainerUtils-&gt;IndexToOrdinalResource(i, getter_AddRefs(oldOrdinal));</span>
<a href="#l31.516"></a><span id="l31.516" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l31.517"></a><span id="l31.517" class="difflineminus">-        {</span>
<a href="#l31.518"></a><span id="l31.518" class="difflineminus">-            err = true;</span>
<a href="#l31.519"></a><span id="l31.519" class="difflineminus">-            continue;</span>
<a href="#l31.520"></a><span id="l31.520" class="difflineminus">-        }</span>
<a href="#l31.521"></a><span id="l31.521" class="difflineminus">-</span>
<a href="#l31.522"></a><span id="l31.522" class="difflineminus">-        nsCOMPtr&lt;nsIRDFResource&gt; newOrdinal;</span>
<a href="#l31.523"></a><span id="l31.523" class="difflineminus">-        rv = gRDFContainerUtils-&gt;IndexToOrdinalResource(i + aIncrement, getter_AddRefs(newOrdinal));</span>
<a href="#l31.524"></a><span id="l31.524" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l31.525"></a><span id="l31.525" class="difflineminus">-        {</span>
<a href="#l31.526"></a><span id="l31.526" class="difflineminus">-            err = true;</span>
<a href="#l31.527"></a><span id="l31.527" class="difflineminus">-            continue;</span>
<a href="#l31.528"></a><span id="l31.528" class="difflineminus">-        }</span>
<a href="#l31.529"></a><span id="l31.529" class="difflineminus">-</span>
<a href="#l31.530"></a><span id="l31.530" class="difflineminus">-        // Because of aggregation, we need to be paranoid about the</span>
<a href="#l31.531"></a><span id="l31.531" class="difflineminus">-        // possibility that &gt;1 element may be present per ordinal. If</span>
<a href="#l31.532"></a><span id="l31.532" class="difflineminus">-        // there _is_ in fact more than one element, they'll all get</span>
<a href="#l31.533"></a><span id="l31.533" class="difflineminus">-        // assigned to the same new ordinal; i.e., we don't make any</span>
<a href="#l31.534"></a><span id="l31.534" class="difflineminus">-        // attempt to &quot;clean up&quot; the duplicate numbering. (Doing so</span>
<a href="#l31.535"></a><span id="l31.535" class="difflineminus">-        // would require two passes.)</span>
<a href="#l31.536"></a><span id="l31.536" class="difflineminus">-        nsCOMPtr&lt;nsISimpleEnumerator&gt; targets;</span>
<a href="#l31.537"></a><span id="l31.537" class="difflineminus">-        rv = mDataSource-&gt;GetTargets(mContainer, oldOrdinal, true, getter_AddRefs(targets));</span>
<a href="#l31.538"></a><span id="l31.538" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l31.539"></a><span id="l31.539" class="difflineminus">-        {</span>
<a href="#l31.540"></a><span id="l31.540" class="difflineminus">-            err = true;</span>
<a href="#l31.541"></a><span id="l31.541" class="difflineminus">-            continue;</span>
<a href="#l31.542"></a><span id="l31.542" class="difflineminus">-        }</span>
<a href="#l31.543"></a><span id="l31.543" class="difflineminus">-</span>
<a href="#l31.544"></a><span id="l31.544" class="difflineminus">-        while (1) {</span>
<a href="#l31.545"></a><span id="l31.545" class="difflineminus">-            bool hasMore;</span>
<a href="#l31.546"></a><span id="l31.546" class="difflineminus">-            rv = targets-&gt;HasMoreElements(&amp;hasMore);</span>
<a href="#l31.547"></a><span id="l31.547" class="difflineminus">-            if (NS_FAILED(rv))</span>
<a href="#l31.548"></a><span id="l31.548" class="difflineminus">-            {</span>
<a href="#l31.549"></a><span id="l31.549" class="difflineminus">-                err = true;</span>
<a href="#l31.550"></a><span id="l31.550" class="difflineminus">-                break;</span>
<a href="#l31.551"></a><span id="l31.551" class="difflineminus">-            }</span>
<a href="#l31.552"></a><span id="l31.552" class="difflineminus">-</span>
<a href="#l31.553"></a><span id="l31.553" class="difflineminus">-            if (! hasMore)</span>
<a href="#l31.554"></a><span id="l31.554" class="difflineminus">-                break;</span>
<a href="#l31.555"></a><span id="l31.555" class="difflineminus">-</span>
<a href="#l31.556"></a><span id="l31.556" class="difflineminus">-            nsCOMPtr&lt;nsISupports&gt; isupports;</span>
<a href="#l31.557"></a><span id="l31.557" class="difflineminus">-            rv = targets-&gt;GetNext(getter_AddRefs(isupports));</span>
<a href="#l31.558"></a><span id="l31.558" class="difflineminus">-            if (NS_FAILED(rv))</span>
<a href="#l31.559"></a><span id="l31.559" class="difflineminus">-            {</span>
<a href="#l31.560"></a><span id="l31.560" class="difflineminus">-                err = true;</span>
<a href="#l31.561"></a><span id="l31.561" class="difflineminus">-                break;</span>
<a href="#l31.562"></a><span id="l31.562" class="difflineminus">-            }</span>
<a href="#l31.563"></a><span id="l31.563" class="difflineminus">-</span>
<a href="#l31.564"></a><span id="l31.564" class="difflineminus">-            nsCOMPtr&lt;nsIRDFNode&gt; element( do_QueryInterface(isupports) );</span>
<a href="#l31.565"></a><span id="l31.565" class="difflineminus">-            NS_ASSERTION(element != nullptr, &quot;something funky in the enumerator&quot;);</span>
<a href="#l31.566"></a><span id="l31.566" class="difflineminus">-            if (! element)</span>
<a href="#l31.567"></a><span id="l31.567" class="difflineminus">-            {</span>
<a href="#l31.568"></a><span id="l31.568" class="difflineminus">-                err = true;</span>
<a href="#l31.569"></a><span id="l31.569" class="difflineminus">-                rv = NS_ERROR_UNEXPECTED;</span>
<a href="#l31.570"></a><span id="l31.570" class="difflineminus">-                break;</span>
<a href="#l31.571"></a><span id="l31.571" class="difflineminus">-            }</span>
<a href="#l31.572"></a><span id="l31.572" class="difflineminus">-</span>
<a href="#l31.573"></a><span id="l31.573" class="difflineminus">-            rv = mDataSource-&gt;Unassert(mContainer, oldOrdinal, element);</span>
<a href="#l31.574"></a><span id="l31.574" class="difflineminus">-            if (NS_FAILED(rv))</span>
<a href="#l31.575"></a><span id="l31.575" class="difflineminus">-            {</span>
<a href="#l31.576"></a><span id="l31.576" class="difflineminus">-                err = true;</span>
<a href="#l31.577"></a><span id="l31.577" class="difflineminus">-                break;</span>
<a href="#l31.578"></a><span id="l31.578" class="difflineminus">-            }</span>
<a href="#l31.579"></a><span id="l31.579" class="difflineminus">-</span>
<a href="#l31.580"></a><span id="l31.580" class="difflineminus">-            rv = mDataSource-&gt;Assert(mContainer, newOrdinal, element, true);</span>
<a href="#l31.581"></a><span id="l31.581" class="difflineminus">-            if (NS_FAILED(rv))</span>
<a href="#l31.582"></a><span id="l31.582" class="difflineminus">-            {</span>
<a href="#l31.583"></a><span id="l31.583" class="difflineminus">-                err = true;</span>
<a href="#l31.584"></a><span id="l31.584" class="difflineminus">-                break;</span>
<a href="#l31.585"></a><span id="l31.585" class="difflineminus">-            }</span>
<a href="#l31.586"></a><span id="l31.586" class="difflineminus">-        }</span>
<a href="#l31.587"></a><span id="l31.587" class="difflineminus">-</span>
<a href="#l31.588"></a><span id="l31.588" class="difflineminus">-        i -= aIncrement;</span>
<a href="#l31.589"></a><span id="l31.589" class="difflineminus">-    }</span>
<a href="#l31.590"></a><span id="l31.590" class="difflineminus">-</span>
<a href="#l31.591"></a><span id="l31.591" class="difflineminus">-    if (!err &amp;&amp; (aIncrement &lt; 0))</span>
<a href="#l31.592"></a><span id="l31.592" class="difflineminus">-    {</span>
<a href="#l31.593"></a><span id="l31.593" class="difflineminus">-        // Update the container's nextVal to reflect the</span>
<a href="#l31.594"></a><span id="l31.594" class="difflineminus">-        // renumbering. We do this now if aIncrement &lt; 0 because, up</span>
<a href="#l31.595"></a><span id="l31.595" class="difflineminus">-        // until this point, we'll want people to be able to find</span>
<a href="#l31.596"></a><span id="l31.596" class="difflineminus">-        // things that are still &quot;at the end&quot;.</span>
<a href="#l31.597"></a><span id="l31.597" class="difflineminus">-        rv = SetNextValue(count + aIncrement + 1);</span>
<a href="#l31.598"></a><span id="l31.598" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l31.599"></a><span id="l31.599" class="difflineminus">-        {</span>
<a href="#l31.600"></a><span id="l31.600" class="difflineminus">-            err = true;</span>
<a href="#l31.601"></a><span id="l31.601" class="difflineminus">-        }</span>
<a href="#l31.602"></a><span id="l31.602" class="difflineminus">-    }</span>
<a href="#l31.603"></a><span id="l31.603" class="difflineminus">-</span>
<a href="#l31.604"></a><span id="l31.604" class="difflineminus">-    // Note: MUST enable notifications before exiting this method</span>
<a href="#l31.605"></a><span id="l31.605" class="difflineminus">-    if (propagatable) {</span>
<a href="#l31.606"></a><span id="l31.606" class="difflineminus">-        propagatable-&gt;SetPropagateChanges(true);</span>
<a href="#l31.607"></a><span id="l31.607" class="difflineminus">-    }</span>
<a href="#l31.608"></a><span id="l31.608" class="difflineminus">-</span>
<a href="#l31.609"></a><span id="l31.609" class="difflineminus">-    if (err) return(rv);</span>
<a href="#l31.610"></a><span id="l31.610" class="difflineminus">-</span>
<a href="#l31.611"></a><span id="l31.611" class="difflineminus">-    return NS_OK;</span>
<a href="#l31.612"></a><span id="l31.612" class="difflineminus">-}</span>
<a href="#l31.613"></a><span id="l31.613" class="difflineminus">-</span>
<a href="#l31.614"></a><span id="l31.614" class="difflineminus">-</span>
<a href="#l31.615"></a><span id="l31.615" class="difflineminus">-</span>
<a href="#l31.616"></a><span id="l31.616" class="difflineminus">-nsresult</span>
<a href="#l31.617"></a><span id="l31.617" class="difflineminus">-RDFContainerImpl::SetNextValue(int32_t aIndex)</span>
<a href="#l31.618"></a><span id="l31.618" class="difflineminus">-{</span>
<a href="#l31.619"></a><span id="l31.619" class="difflineminus">-    if (!mDataSource || !mContainer)</span>
<a href="#l31.620"></a><span id="l31.620" class="difflineminus">-        return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l31.621"></a><span id="l31.621" class="difflineminus">-</span>
<a href="#l31.622"></a><span id="l31.622" class="difflineminus">-    nsresult rv;</span>
<a href="#l31.623"></a><span id="l31.623" class="difflineminus">-</span>
<a href="#l31.624"></a><span id="l31.624" class="difflineminus">-    // Remove the current value of nextVal, if there is one.</span>
<a href="#l31.625"></a><span id="l31.625" class="difflineminus">-    nsCOMPtr&lt;nsIRDFNode&gt; nextValNode;</span>
<a href="#l31.626"></a><span id="l31.626" class="difflineminus">-    if (NS_SUCCEEDED(rv = mDataSource-&gt;GetTarget(mContainer,</span>
<a href="#l31.627"></a><span id="l31.627" class="difflineminus">-                                                 kRDF_nextVal,</span>
<a href="#l31.628"></a><span id="l31.628" class="difflineminus">-                                                 true,</span>
<a href="#l31.629"></a><span id="l31.629" class="difflineminus">-                                                 getter_AddRefs(nextValNode)))) {</span>
<a href="#l31.630"></a><span id="l31.630" class="difflineminus">-        if (NS_FAILED(rv = mDataSource-&gt;Unassert(mContainer, kRDF_nextVal, nextValNode))) {</span>
<a href="#l31.631"></a><span id="l31.631" class="difflineminus">-            NS_ERROR(&quot;unable to update nextVal&quot;);</span>
<a href="#l31.632"></a><span id="l31.632" class="difflineminus">-            return rv;</span>
<a href="#l31.633"></a><span id="l31.633" class="difflineminus">-        }</span>
<a href="#l31.634"></a><span id="l31.634" class="difflineminus">-    }</span>
<a href="#l31.635"></a><span id="l31.635" class="difflineminus">-</span>
<a href="#l31.636"></a><span id="l31.636" class="difflineminus">-    nsAutoString s;</span>
<a href="#l31.637"></a><span id="l31.637" class="difflineminus">-    s.AppendInt(aIndex, 10);</span>
<a href="#l31.638"></a><span id="l31.638" class="difflineminus">-</span>
<a href="#l31.639"></a><span id="l31.639" class="difflineminus">-    nsCOMPtr&lt;nsIRDFLiteral&gt; nextVal;</span>
<a href="#l31.640"></a><span id="l31.640" class="difflineminus">-    if (NS_FAILED(rv = gRDFService-&gt;GetLiteral(s.get(), getter_AddRefs(nextVal)))) {</span>
<a href="#l31.641"></a><span id="l31.641" class="difflineminus">-        NS_ERROR(&quot;unable to get nextVal literal&quot;);</span>
<a href="#l31.642"></a><span id="l31.642" class="difflineminus">-        return rv;</span>
<a href="#l31.643"></a><span id="l31.643" class="difflineminus">-    }</span>
<a href="#l31.644"></a><span id="l31.644" class="difflineminus">-</span>
<a href="#l31.645"></a><span id="l31.645" class="difflineminus">-    rv = mDataSource-&gt;Assert(mContainer, kRDF_nextVal, nextVal, true);</span>
<a href="#l31.646"></a><span id="l31.646" class="difflineminus">-    if (rv != NS_RDF_ASSERTION_ACCEPTED) {</span>
<a href="#l31.647"></a><span id="l31.647" class="difflineminus">-        NS_ERROR(&quot;unable to update nextVal&quot;);</span>
<a href="#l31.648"></a><span id="l31.648" class="difflineminus">-        return NS_ERROR_FAILURE;</span>
<a href="#l31.649"></a><span id="l31.649" class="difflineminus">-    }</span>
<a href="#l31.650"></a><span id="l31.650" class="difflineminus">-</span>
<a href="#l31.651"></a><span id="l31.651" class="difflineminus">-    return NS_OK;</span>
<a href="#l31.652"></a><span id="l31.652" class="difflineminus">-}</span>
<a href="#l31.653"></a><span id="l31.653" class="difflineminus">-</span>
<a href="#l31.654"></a><span id="l31.654" class="difflineminus">-</span>
<a href="#l31.655"></a><span id="l31.655" class="difflineminus">-nsresult</span>
<a href="#l31.656"></a><span id="l31.656" class="difflineminus">-RDFContainerImpl::GetNextValue(nsIRDFResource** aResult)</span>
<a href="#l31.657"></a><span id="l31.657" class="difflineminus">-{</span>
<a href="#l31.658"></a><span id="l31.658" class="difflineminus">-    if (!mDataSource || !mContainer)</span>
<a href="#l31.659"></a><span id="l31.659" class="difflineminus">-        return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l31.660"></a><span id="l31.660" class="difflineminus">-</span>
<a href="#l31.661"></a><span id="l31.661" class="difflineminus">-    nsresult rv;</span>
<a href="#l31.662"></a><span id="l31.662" class="difflineminus">-</span>
<a href="#l31.663"></a><span id="l31.663" class="difflineminus">-    // Get the next value, which hangs off of the bag via the</span>
<a href="#l31.664"></a><span id="l31.664" class="difflineminus">-    // RDF:nextVal property.</span>
<a href="#l31.665"></a><span id="l31.665" class="difflineminus">-    nsCOMPtr&lt;nsIRDFNode&gt; nextValNode;</span>
<a href="#l31.666"></a><span id="l31.666" class="difflineminus">-    rv = mDataSource-&gt;GetTarget(mContainer, kRDF_nextVal, true, getter_AddRefs(nextValNode));</span>
<a href="#l31.667"></a><span id="l31.667" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l31.668"></a><span id="l31.668" class="difflineminus">-</span>
<a href="#l31.669"></a><span id="l31.669" class="difflineminus">-    if (rv == NS_RDF_NO_VALUE)</span>
<a href="#l31.670"></a><span id="l31.670" class="difflineminus">-        return NS_ERROR_UNEXPECTED;</span>
<a href="#l31.671"></a><span id="l31.671" class="difflineminus">-</span>
<a href="#l31.672"></a><span id="l31.672" class="difflineminus">-    nsCOMPtr&lt;nsIRDFLiteral&gt; nextValLiteral;</span>
<a href="#l31.673"></a><span id="l31.673" class="difflineminus">-    rv = nextValNode-&gt;QueryInterface(NS_GET_IID(nsIRDFLiteral), getter_AddRefs(nextValLiteral));</span>
<a href="#l31.674"></a><span id="l31.674" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l31.675"></a><span id="l31.675" class="difflineminus">-</span>
<a href="#l31.676"></a><span id="l31.676" class="difflineminus">-    const char16_t* s;</span>
<a href="#l31.677"></a><span id="l31.677" class="difflineminus">-    rv = nextValLiteral-&gt;GetValueConst(&amp;s);</span>
<a href="#l31.678"></a><span id="l31.678" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l31.679"></a><span id="l31.679" class="difflineminus">-</span>
<a href="#l31.680"></a><span id="l31.680" class="difflineminus">-    int32_t nextVal = 0;</span>
<a href="#l31.681"></a><span id="l31.681" class="difflineminus">-    {</span>
<a href="#l31.682"></a><span id="l31.682" class="difflineminus">-        for (const char16_t* p = s; *p != 0; ++p) {</span>
<a href="#l31.683"></a><span id="l31.683" class="difflineminus">-            NS_ASSERTION(*p &gt;= '0' &amp;&amp; *p &lt;= '9', &quot;not a digit&quot;);</span>
<a href="#l31.684"></a><span id="l31.684" class="difflineminus">-            if (*p &lt; '0' || *p &gt; '9')</span>
<a href="#l31.685"></a><span id="l31.685" class="difflineminus">-                break;</span>
<a href="#l31.686"></a><span id="l31.686" class="difflineminus">-</span>
<a href="#l31.687"></a><span id="l31.687" class="difflineminus">-            nextVal *= 10;</span>
<a href="#l31.688"></a><span id="l31.688" class="difflineminus">-            nextVal += *p - '0';</span>
<a href="#l31.689"></a><span id="l31.689" class="difflineminus">-        }</span>
<a href="#l31.690"></a><span id="l31.690" class="difflineminus">-    }</span>
<a href="#l31.691"></a><span id="l31.691" class="difflineminus">-</span>
<a href="#l31.692"></a><span id="l31.692" class="difflineminus">-    static const char kRDFNameSpaceURI[] = RDF_NAMESPACE_URI;</span>
<a href="#l31.693"></a><span id="l31.693" class="difflineminus">-    nsAutoCStringN&lt;sizeof(kRDFNameSpaceURI) + 16&gt; nextValStr;</span>
<a href="#l31.694"></a><span id="l31.694" class="difflineminus">-    nextValStr = kRDFNameSpaceURI;</span>
<a href="#l31.695"></a><span id="l31.695" class="difflineminus">-    nextValStr.Append('_');</span>
<a href="#l31.696"></a><span id="l31.696" class="difflineminus">-    nextValStr.AppendInt(nextVal, 10);</span>
<a href="#l31.697"></a><span id="l31.697" class="difflineminus">-</span>
<a href="#l31.698"></a><span id="l31.698" class="difflineminus">-    rv = gRDFService-&gt;GetResource(nextValStr, aResult);</span>
<a href="#l31.699"></a><span id="l31.699" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l31.700"></a><span id="l31.700" class="difflineminus">-</span>
<a href="#l31.701"></a><span id="l31.701" class="difflineminus">-    // Now increment the RDF:nextVal property.</span>
<a href="#l31.702"></a><span id="l31.702" class="difflineminus">-    rv = mDataSource-&gt;Unassert(mContainer, kRDF_nextVal, nextValLiteral);</span>
<a href="#l31.703"></a><span id="l31.703" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l31.704"></a><span id="l31.704" class="difflineminus">-</span>
<a href="#l31.705"></a><span id="l31.705" class="difflineminus">-    ++nextVal;</span>
<a href="#l31.706"></a><span id="l31.706" class="difflineminus">-    nextValStr.Truncate();</span>
<a href="#l31.707"></a><span id="l31.707" class="difflineminus">-    nextValStr.AppendInt(nextVal, 10);</span>
<a href="#l31.708"></a><span id="l31.708" class="difflineminus">-</span>
<a href="#l31.709"></a><span id="l31.709" class="difflineminus">-    rv = gRDFService-&gt;GetLiteral(NS_ConvertASCIItoUTF16(nextValStr).get(), getter_AddRefs(nextValLiteral));</span>
<a href="#l31.710"></a><span id="l31.710" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l31.711"></a><span id="l31.711" class="difflineminus">-</span>
<a href="#l31.712"></a><span id="l31.712" class="difflineminus">-    rv = mDataSource-&gt;Assert(mContainer, kRDF_nextVal, nextValLiteral, true);</span>
<a href="#l31.713"></a><span id="l31.713" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l31.714"></a><span id="l31.714" class="difflineminus">-</span>
<a href="#l31.715"></a><span id="l31.715" class="difflineminus">-    if (RDF_SEQ_LIST_LIMIT == nextVal)</span>
<a href="#l31.716"></a><span id="l31.716" class="difflineminus">-    {</span>
<a href="#l31.717"></a><span id="l31.717" class="difflineminus">-        // focal point for RDF container mutation;</span>
<a href="#l31.718"></a><span id="l31.718" class="difflineminus">-        // basically, provide a hint to allow for fast access</span>
<a href="#l31.719"></a><span id="l31.719" class="difflineminus">-        nsCOMPtr&lt;nsIRDFInMemoryDataSource&gt; inMem = do_QueryInterface(mDataSource);</span>
<a href="#l31.720"></a><span id="l31.720" class="difflineminus">-        if (inMem)</span>
<a href="#l31.721"></a><span id="l31.721" class="difflineminus">-        {</span>
<a href="#l31.722"></a><span id="l31.722" class="difflineminus">-            // ignore error; failure just means slower access</span>
<a href="#l31.723"></a><span id="l31.723" class="difflineminus">-            (void)inMem-&gt;EnsureFastContainment(mContainer);</span>
<a href="#l31.724"></a><span id="l31.724" class="difflineminus">-        }</span>
<a href="#l31.725"></a><span id="l31.725" class="difflineminus">-    }</span>
<a href="#l31.726"></a><span id="l31.726" class="difflineminus">-</span>
<a href="#l31.727"></a><span id="l31.727" class="difflineminus">-    return NS_OK;</span>
<a href="#l31.728"></a><span id="l31.728" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1">deleted file mode 100644</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineminus">--- a/rdf/base/nsRDFContainerUtils.cpp</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineplus">+++ /dev/null</span>
<a href="#l32.4"></a><span id="l32.4" class="difflineat">@@ -1,513 +0,0 @@</span>
<a href="#l32.5"></a><span id="l32.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l32.6"></a><span id="l32.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l32.7"></a><span id="l32.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l32.8"></a><span id="l32.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l32.9"></a><span id="l32.9" class="difflineminus">-</span>
<a href="#l32.10"></a><span id="l32.10" class="difflineminus">-/*</span>
<a href="#l32.11"></a><span id="l32.11" class="difflineminus">-</span>
<a href="#l32.12"></a><span id="l32.12" class="difflineminus">-  Implementation for the RDF container utils.</span>
<a href="#l32.13"></a><span id="l32.13" class="difflineminus">-</span>
<a href="#l32.14"></a><span id="l32.14" class="difflineminus">- */</span>
<a href="#l32.15"></a><span id="l32.15" class="difflineminus">-</span>
<a href="#l32.16"></a><span id="l32.16" class="difflineminus">-</span>
<a href="#l32.17"></a><span id="l32.17" class="difflineminus">-#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l32.18"></a><span id="l32.18" class="difflineminus">-#include &quot;nsIServiceManager.h&quot;</span>
<a href="#l32.19"></a><span id="l32.19" class="difflineminus">-#include &quot;nsIRDFContainer.h&quot;</span>
<a href="#l32.20"></a><span id="l32.20" class="difflineminus">-#include &quot;nsIRDFContainerUtils.h&quot;</span>
<a href="#l32.21"></a><span id="l32.21" class="difflineminus">-#include &quot;nsIRDFService.h&quot;</span>
<a href="#l32.22"></a><span id="l32.22" class="difflineminus">-#include &quot;nsRDFCID.h&quot;</span>
<a href="#l32.23"></a><span id="l32.23" class="difflineminus">-#include &quot;nsString.h&quot;</span>
<a href="#l32.24"></a><span id="l32.24" class="difflineminus">-#include &quot;plstr.h&quot;</span>
<a href="#l32.25"></a><span id="l32.25" class="difflineminus">-#include &quot;rdf.h&quot;</span>
<a href="#l32.26"></a><span id="l32.26" class="difflineminus">-#include &quot;rdfutil.h&quot;</span>
<a href="#l32.27"></a><span id="l32.27" class="difflineminus">-</span>
<a href="#l32.28"></a><span id="l32.28" class="difflineminus">-class RDFContainerUtilsImpl : public nsIRDFContainerUtils</span>
<a href="#l32.29"></a><span id="l32.29" class="difflineminus">-{</span>
<a href="#l32.30"></a><span id="l32.30" class="difflineminus">-public:</span>
<a href="#l32.31"></a><span id="l32.31" class="difflineminus">-    // nsISupports interface</span>
<a href="#l32.32"></a><span id="l32.32" class="difflineminus">-    NS_DECL_ISUPPORTS</span>
<a href="#l32.33"></a><span id="l32.33" class="difflineminus">-</span>
<a href="#l32.34"></a><span id="l32.34" class="difflineminus">-    // nsIRDFContainerUtils interface</span>
<a href="#l32.35"></a><span id="l32.35" class="difflineminus">-    NS_DECL_NSIRDFCONTAINERUTILS</span>
<a href="#l32.36"></a><span id="l32.36" class="difflineminus">-</span>
<a href="#l32.37"></a><span id="l32.37" class="difflineminus">-private:</span>
<a href="#l32.38"></a><span id="l32.38" class="difflineminus">-    friend nsresult NS_NewRDFContainerUtils(nsIRDFContainerUtils** aResult);</span>
<a href="#l32.39"></a><span id="l32.39" class="difflineminus">-</span>
<a href="#l32.40"></a><span id="l32.40" class="difflineminus">-    RDFContainerUtilsImpl();</span>
<a href="#l32.41"></a><span id="l32.41" class="difflineminus">-    virtual ~RDFContainerUtilsImpl();</span>
<a href="#l32.42"></a><span id="l32.42" class="difflineminus">-</span>
<a href="#l32.43"></a><span id="l32.43" class="difflineminus">-    nsresult MakeContainer(nsIRDFDataSource* aDataSource,</span>
<a href="#l32.44"></a><span id="l32.44" class="difflineminus">-                           nsIRDFResource* aResource,</span>
<a href="#l32.45"></a><span id="l32.45" class="difflineminus">-                           nsIRDFResource* aType,</span>
<a href="#l32.46"></a><span id="l32.46" class="difflineminus">-                           nsIRDFContainer** aResult);</span>
<a href="#l32.47"></a><span id="l32.47" class="difflineminus">-</span>
<a href="#l32.48"></a><span id="l32.48" class="difflineminus">-    bool IsA(nsIRDFDataSource* aDataSource, nsIRDFResource* aResource, nsIRDFResource* aType);</span>
<a href="#l32.49"></a><span id="l32.49" class="difflineminus">-</span>
<a href="#l32.50"></a><span id="l32.50" class="difflineminus">-    // pseudo constants</span>
<a href="#l32.51"></a><span id="l32.51" class="difflineminus">-    static int32_t gRefCnt;</span>
<a href="#l32.52"></a><span id="l32.52" class="difflineminus">-    static nsIRDFService* gRDFService;</span>
<a href="#l32.53"></a><span id="l32.53" class="difflineminus">-    static nsIRDFResource* kRDF_instanceOf;</span>
<a href="#l32.54"></a><span id="l32.54" class="difflineminus">-    static nsIRDFResource* kRDF_nextVal;</span>
<a href="#l32.55"></a><span id="l32.55" class="difflineminus">-    static nsIRDFResource* kRDF_Bag;</span>
<a href="#l32.56"></a><span id="l32.56" class="difflineminus">-    static nsIRDFResource* kRDF_Seq;</span>
<a href="#l32.57"></a><span id="l32.57" class="difflineminus">-    static nsIRDFResource* kRDF_Alt;</span>
<a href="#l32.58"></a><span id="l32.58" class="difflineminus">-    static nsIRDFLiteral* kOne;</span>
<a href="#l32.59"></a><span id="l32.59" class="difflineminus">-    static const char kRDFNameSpaceURI[];</span>
<a href="#l32.60"></a><span id="l32.60" class="difflineminus">-};</span>
<a href="#l32.61"></a><span id="l32.61" class="difflineminus">-</span>
<a href="#l32.62"></a><span id="l32.62" class="difflineminus">-int32_t         RDFContainerUtilsImpl::gRefCnt = 0;</span>
<a href="#l32.63"></a><span id="l32.63" class="difflineminus">-nsIRDFService*  RDFContainerUtilsImpl::gRDFService;</span>
<a href="#l32.64"></a><span id="l32.64" class="difflineminus">-nsIRDFResource* RDFContainerUtilsImpl::kRDF_instanceOf;</span>
<a href="#l32.65"></a><span id="l32.65" class="difflineminus">-nsIRDFResource* RDFContainerUtilsImpl::kRDF_nextVal;</span>
<a href="#l32.66"></a><span id="l32.66" class="difflineminus">-nsIRDFResource* RDFContainerUtilsImpl::kRDF_Bag;</span>
<a href="#l32.67"></a><span id="l32.67" class="difflineminus">-nsIRDFResource* RDFContainerUtilsImpl::kRDF_Seq;</span>
<a href="#l32.68"></a><span id="l32.68" class="difflineminus">-nsIRDFResource* RDFContainerUtilsImpl::kRDF_Alt;</span>
<a href="#l32.69"></a><span id="l32.69" class="difflineminus">-nsIRDFLiteral*  RDFContainerUtilsImpl::kOne;</span>
<a href="#l32.70"></a><span id="l32.70" class="difflineminus">-const char      RDFContainerUtilsImpl::kRDFNameSpaceURI[] = RDF_NAMESPACE_URI;</span>
<a href="#l32.71"></a><span id="l32.71" class="difflineminus">-</span>
<a href="#l32.72"></a><span id="l32.72" class="difflineminus">-////////////////////////////////////////////////////////////////////////</span>
<a href="#l32.73"></a><span id="l32.73" class="difflineminus">-// nsISupports interface</span>
<a href="#l32.74"></a><span id="l32.74" class="difflineminus">-</span>
<a href="#l32.75"></a><span id="l32.75" class="difflineminus">-NS_IMPL_ISUPPORTS(RDFContainerUtilsImpl, nsIRDFContainerUtils)</span>
<a href="#l32.76"></a><span id="l32.76" class="difflineminus">-</span>
<a href="#l32.77"></a><span id="l32.77" class="difflineminus">-////////////////////////////////////////////////////////////////////////</span>
<a href="#l32.78"></a><span id="l32.78" class="difflineminus">-// nsIRDFContainerUtils interface</span>
<a href="#l32.79"></a><span id="l32.79" class="difflineminus">-</span>
<a href="#l32.80"></a><span id="l32.80" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l32.81"></a><span id="l32.81" class="difflineminus">-RDFContainerUtilsImpl::IsOrdinalProperty(nsIRDFResource *aProperty, bool *_retval)</span>
<a href="#l32.82"></a><span id="l32.82" class="difflineminus">-{</span>
<a href="#l32.83"></a><span id="l32.83" class="difflineminus">-    NS_ASSERTION(aProperty != nullptr, &quot;null ptr&quot;);</span>
<a href="#l32.84"></a><span id="l32.84" class="difflineminus">-    if (! aProperty)</span>
<a href="#l32.85"></a><span id="l32.85" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l32.86"></a><span id="l32.86" class="difflineminus">-</span>
<a href="#l32.87"></a><span id="l32.87" class="difflineminus">-    nsresult rv;</span>
<a href="#l32.88"></a><span id="l32.88" class="difflineminus">-</span>
<a href="#l32.89"></a><span id="l32.89" class="difflineminus">-    const char	*propertyStr;</span>
<a href="#l32.90"></a><span id="l32.90" class="difflineminus">-    rv = aProperty-&gt;GetValueConst( &amp;propertyStr );</span>
<a href="#l32.91"></a><span id="l32.91" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l32.92"></a><span id="l32.92" class="difflineminus">-</span>
<a href="#l32.93"></a><span id="l32.93" class="difflineminus">-    if (PL_strncmp(propertyStr, kRDFNameSpaceURI, sizeof(kRDFNameSpaceURI) - 1) != 0) {</span>
<a href="#l32.94"></a><span id="l32.94" class="difflineminus">-        *_retval = false;</span>
<a href="#l32.95"></a><span id="l32.95" class="difflineminus">-        return NS_OK;</span>
<a href="#l32.96"></a><span id="l32.96" class="difflineminus">-    }</span>
<a href="#l32.97"></a><span id="l32.97" class="difflineminus">-</span>
<a href="#l32.98"></a><span id="l32.98" class="difflineminus">-    const char* s = propertyStr;</span>
<a href="#l32.99"></a><span id="l32.99" class="difflineminus">-    s += sizeof(kRDFNameSpaceURI) - 1;</span>
<a href="#l32.100"></a><span id="l32.100" class="difflineminus">-    if (*s != '_') {</span>
<a href="#l32.101"></a><span id="l32.101" class="difflineminus">-        *_retval = false;</span>
<a href="#l32.102"></a><span id="l32.102" class="difflineminus">-        return NS_OK;</span>
<a href="#l32.103"></a><span id="l32.103" class="difflineminus">-    }</span>
<a href="#l32.104"></a><span id="l32.104" class="difflineminus">-</span>
<a href="#l32.105"></a><span id="l32.105" class="difflineminus">-    ++s;</span>
<a href="#l32.106"></a><span id="l32.106" class="difflineminus">-    while (*s) {</span>
<a href="#l32.107"></a><span id="l32.107" class="difflineminus">-        if (*s &lt; '0' || *s &gt; '9') {</span>
<a href="#l32.108"></a><span id="l32.108" class="difflineminus">-            *_retval = false;</span>
<a href="#l32.109"></a><span id="l32.109" class="difflineminus">-            return NS_OK;</span>
<a href="#l32.110"></a><span id="l32.110" class="difflineminus">-        }</span>
<a href="#l32.111"></a><span id="l32.111" class="difflineminus">-</span>
<a href="#l32.112"></a><span id="l32.112" class="difflineminus">-        ++s;</span>
<a href="#l32.113"></a><span id="l32.113" class="difflineminus">-    }</span>
<a href="#l32.114"></a><span id="l32.114" class="difflineminus">-</span>
<a href="#l32.115"></a><span id="l32.115" class="difflineminus">-    *_retval = true;</span>
<a href="#l32.116"></a><span id="l32.116" class="difflineminus">-    return NS_OK;</span>
<a href="#l32.117"></a><span id="l32.117" class="difflineminus">-}</span>
<a href="#l32.118"></a><span id="l32.118" class="difflineminus">-</span>
<a href="#l32.119"></a><span id="l32.119" class="difflineminus">-</span>
<a href="#l32.120"></a><span id="l32.120" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l32.121"></a><span id="l32.121" class="difflineminus">-RDFContainerUtilsImpl::IndexToOrdinalResource(int32_t aIndex, nsIRDFResource **aOrdinal)</span>
<a href="#l32.122"></a><span id="l32.122" class="difflineminus">-{</span>
<a href="#l32.123"></a><span id="l32.123" class="difflineminus">-    NS_ASSERTION(aIndex &gt; 0, &quot;illegal value&quot;);</span>
<a href="#l32.124"></a><span id="l32.124" class="difflineminus">-    if (aIndex &lt;= 0)</span>
<a href="#l32.125"></a><span id="l32.125" class="difflineminus">-        return NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l32.126"></a><span id="l32.126" class="difflineminus">-</span>
<a href="#l32.127"></a><span id="l32.127" class="difflineminus">-    nsAutoCString uri(kRDFNameSpaceURI);</span>
<a href="#l32.128"></a><span id="l32.128" class="difflineminus">-    uri.Append('_');</span>
<a href="#l32.129"></a><span id="l32.129" class="difflineminus">-    uri.AppendInt(aIndex);</span>
<a href="#l32.130"></a><span id="l32.130" class="difflineminus">-</span>
<a href="#l32.131"></a><span id="l32.131" class="difflineminus">-    nsresult rv = gRDFService-&gt;GetResource(uri, aOrdinal);</span>
<a href="#l32.132"></a><span id="l32.132" class="difflineminus">-    NS_ASSERTION(NS_SUCCEEDED(rv), &quot;unable to get ordinal resource&quot;);</span>
<a href="#l32.133"></a><span id="l32.133" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l32.134"></a><span id="l32.134" class="difflineminus">-</span>
<a href="#l32.135"></a><span id="l32.135" class="difflineminus">-    return NS_OK;</span>
<a href="#l32.136"></a><span id="l32.136" class="difflineminus">-}</span>
<a href="#l32.137"></a><span id="l32.137" class="difflineminus">-</span>
<a href="#l32.138"></a><span id="l32.138" class="difflineminus">-</span>
<a href="#l32.139"></a><span id="l32.139" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l32.140"></a><span id="l32.140" class="difflineminus">-RDFContainerUtilsImpl::OrdinalResourceToIndex(nsIRDFResource *aOrdinal, int32_t *aIndex)</span>
<a href="#l32.141"></a><span id="l32.141" class="difflineminus">-{</span>
<a href="#l32.142"></a><span id="l32.142" class="difflineminus">-    NS_ASSERTION(aOrdinal != nullptr, &quot;null ptr&quot;);</span>
<a href="#l32.143"></a><span id="l32.143" class="difflineminus">-    if (! aOrdinal)</span>
<a href="#l32.144"></a><span id="l32.144" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l32.145"></a><span id="l32.145" class="difflineminus">-</span>
<a href="#l32.146"></a><span id="l32.146" class="difflineminus">-    const char	*ordinalStr;</span>
<a href="#l32.147"></a><span id="l32.147" class="difflineminus">-    if (NS_FAILED(aOrdinal-&gt;GetValueConst( &amp;ordinalStr )))</span>
<a href="#l32.148"></a><span id="l32.148" class="difflineminus">-        return NS_ERROR_FAILURE;</span>
<a href="#l32.149"></a><span id="l32.149" class="difflineminus">-</span>
<a href="#l32.150"></a><span id="l32.150" class="difflineminus">-    const char* s = ordinalStr;</span>
<a href="#l32.151"></a><span id="l32.151" class="difflineminus">-    if (PL_strncmp(s, kRDFNameSpaceURI, sizeof(kRDFNameSpaceURI) - 1) != 0) {</span>
<a href="#l32.152"></a><span id="l32.152" class="difflineminus">-        NS_ERROR(&quot;not an ordinal&quot;);</span>
<a href="#l32.153"></a><span id="l32.153" class="difflineminus">-        return NS_ERROR_UNEXPECTED;</span>
<a href="#l32.154"></a><span id="l32.154" class="difflineminus">-    }</span>
<a href="#l32.155"></a><span id="l32.155" class="difflineminus">-</span>
<a href="#l32.156"></a><span id="l32.156" class="difflineminus">-    s += sizeof(kRDFNameSpaceURI) - 1;</span>
<a href="#l32.157"></a><span id="l32.157" class="difflineminus">-    if (*s != '_') {</span>
<a href="#l32.158"></a><span id="l32.158" class="difflineminus">-        NS_ERROR(&quot;not an ordinal&quot;);</span>
<a href="#l32.159"></a><span id="l32.159" class="difflineminus">-        return NS_ERROR_UNEXPECTED;</span>
<a href="#l32.160"></a><span id="l32.160" class="difflineminus">-    }</span>
<a href="#l32.161"></a><span id="l32.161" class="difflineminus">-</span>
<a href="#l32.162"></a><span id="l32.162" class="difflineminus">-    int32_t idx = 0;</span>
<a href="#l32.163"></a><span id="l32.163" class="difflineminus">-</span>
<a href="#l32.164"></a><span id="l32.164" class="difflineminus">-    ++s;</span>
<a href="#l32.165"></a><span id="l32.165" class="difflineminus">-    while (*s) {</span>
<a href="#l32.166"></a><span id="l32.166" class="difflineminus">-        if (*s &lt; '0' || *s &gt; '9') {</span>
<a href="#l32.167"></a><span id="l32.167" class="difflineminus">-            NS_ERROR(&quot;not an ordinal&quot;);</span>
<a href="#l32.168"></a><span id="l32.168" class="difflineminus">-            return NS_ERROR_UNEXPECTED;</span>
<a href="#l32.169"></a><span id="l32.169" class="difflineminus">-        }</span>
<a href="#l32.170"></a><span id="l32.170" class="difflineminus">-</span>
<a href="#l32.171"></a><span id="l32.171" class="difflineminus">-        idx *= 10;</span>
<a href="#l32.172"></a><span id="l32.172" class="difflineminus">-        idx += (*s - '0');</span>
<a href="#l32.173"></a><span id="l32.173" class="difflineminus">-</span>
<a href="#l32.174"></a><span id="l32.174" class="difflineminus">-        ++s;</span>
<a href="#l32.175"></a><span id="l32.175" class="difflineminus">-    }</span>
<a href="#l32.176"></a><span id="l32.176" class="difflineminus">-</span>
<a href="#l32.177"></a><span id="l32.177" class="difflineminus">-    *aIndex = idx;</span>
<a href="#l32.178"></a><span id="l32.178" class="difflineminus">-    return NS_OK;</span>
<a href="#l32.179"></a><span id="l32.179" class="difflineminus">-}</span>
<a href="#l32.180"></a><span id="l32.180" class="difflineminus">-</span>
<a href="#l32.181"></a><span id="l32.181" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l32.182"></a><span id="l32.182" class="difflineminus">-RDFContainerUtilsImpl::IsContainer(nsIRDFDataSource *aDataSource, nsIRDFResource *aResource, bool *_retval)</span>
<a href="#l32.183"></a><span id="l32.183" class="difflineminus">-{</span>
<a href="#l32.184"></a><span id="l32.184" class="difflineminus">-    NS_ASSERTION(aDataSource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l32.185"></a><span id="l32.185" class="difflineminus">-    if (! aDataSource)</span>
<a href="#l32.186"></a><span id="l32.186" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l32.187"></a><span id="l32.187" class="difflineminus">-</span>
<a href="#l32.188"></a><span id="l32.188" class="difflineminus">-    NS_ASSERTION(aResource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l32.189"></a><span id="l32.189" class="difflineminus">-    if (! aResource)</span>
<a href="#l32.190"></a><span id="l32.190" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l32.191"></a><span id="l32.191" class="difflineminus">-</span>
<a href="#l32.192"></a><span id="l32.192" class="difflineminus">-    NS_ASSERTION(_retval != nullptr, &quot;null ptr&quot;);</span>
<a href="#l32.193"></a><span id="l32.193" class="difflineminus">-    if (! _retval)</span>
<a href="#l32.194"></a><span id="l32.194" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l32.195"></a><span id="l32.195" class="difflineminus">-</span>
<a href="#l32.196"></a><span id="l32.196" class="difflineminus">-    if (IsA(aDataSource, aResource, kRDF_Seq) ||</span>
<a href="#l32.197"></a><span id="l32.197" class="difflineminus">-        IsA(aDataSource, aResource, kRDF_Bag) ||</span>
<a href="#l32.198"></a><span id="l32.198" class="difflineminus">-        IsA(aDataSource, aResource, kRDF_Alt)) {</span>
<a href="#l32.199"></a><span id="l32.199" class="difflineminus">-        *_retval = true;</span>
<a href="#l32.200"></a><span id="l32.200" class="difflineminus">-    }</span>
<a href="#l32.201"></a><span id="l32.201" class="difflineminus">-    else {</span>
<a href="#l32.202"></a><span id="l32.202" class="difflineminus">-        *_retval = false;</span>
<a href="#l32.203"></a><span id="l32.203" class="difflineminus">-    }</span>
<a href="#l32.204"></a><span id="l32.204" class="difflineminus">-    return NS_OK;</span>
<a href="#l32.205"></a><span id="l32.205" class="difflineminus">-}</span>
<a href="#l32.206"></a><span id="l32.206" class="difflineminus">-</span>
<a href="#l32.207"></a><span id="l32.207" class="difflineminus">-</span>
<a href="#l32.208"></a><span id="l32.208" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l32.209"></a><span id="l32.209" class="difflineminus">-RDFContainerUtilsImpl::IsEmpty(nsIRDFDataSource* aDataSource, nsIRDFResource* aResource, bool* _retval)</span>
<a href="#l32.210"></a><span id="l32.210" class="difflineminus">-{</span>
<a href="#l32.211"></a><span id="l32.211" class="difflineminus">-    if (! aDataSource)</span>
<a href="#l32.212"></a><span id="l32.212" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l32.213"></a><span id="l32.213" class="difflineminus">-</span>
<a href="#l32.214"></a><span id="l32.214" class="difflineminus">-    nsresult rv;</span>
<a href="#l32.215"></a><span id="l32.215" class="difflineminus">-</span>
<a href="#l32.216"></a><span id="l32.216" class="difflineminus">-    // By default, say that we're an empty container. Even if we're not</span>
<a href="#l32.217"></a><span id="l32.217" class="difflineminus">-    // really even a container.</span>
<a href="#l32.218"></a><span id="l32.218" class="difflineminus">-    *_retval = true;</span>
<a href="#l32.219"></a><span id="l32.219" class="difflineminus">-</span>
<a href="#l32.220"></a><span id="l32.220" class="difflineminus">-    nsCOMPtr&lt;nsIRDFNode&gt; nextValNode;</span>
<a href="#l32.221"></a><span id="l32.221" class="difflineminus">-    rv = aDataSource-&gt;GetTarget(aResource, kRDF_nextVal, true, getter_AddRefs(nextValNode));</span>
<a href="#l32.222"></a><span id="l32.222" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l32.223"></a><span id="l32.223" class="difflineminus">-</span>
<a href="#l32.224"></a><span id="l32.224" class="difflineminus">-    if (rv == NS_RDF_NO_VALUE)</span>
<a href="#l32.225"></a><span id="l32.225" class="difflineminus">-        return NS_OK;</span>
<a href="#l32.226"></a><span id="l32.226" class="difflineminus">-</span>
<a href="#l32.227"></a><span id="l32.227" class="difflineminus">-    nsCOMPtr&lt;nsIRDFLiteral&gt; nextValLiteral;</span>
<a href="#l32.228"></a><span id="l32.228" class="difflineminus">-    rv = nextValNode-&gt;QueryInterface(NS_GET_IID(nsIRDFLiteral), getter_AddRefs(nextValLiteral));</span>
<a href="#l32.229"></a><span id="l32.229" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l32.230"></a><span id="l32.230" class="difflineminus">-</span>
<a href="#l32.231"></a><span id="l32.231" class="difflineminus">-    if (nextValLiteral.get() != kOne)</span>
<a href="#l32.232"></a><span id="l32.232" class="difflineminus">-        *_retval = false;</span>
<a href="#l32.233"></a><span id="l32.233" class="difflineminus">-</span>
<a href="#l32.234"></a><span id="l32.234" class="difflineminus">-    return NS_OK;</span>
<a href="#l32.235"></a><span id="l32.235" class="difflineminus">-}</span>
<a href="#l32.236"></a><span id="l32.236" class="difflineminus">-</span>
<a href="#l32.237"></a><span id="l32.237" class="difflineminus">-</span>
<a href="#l32.238"></a><span id="l32.238" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l32.239"></a><span id="l32.239" class="difflineminus">-RDFContainerUtilsImpl::IsBag(nsIRDFDataSource *aDataSource, nsIRDFResource *aResource, bool *_retval)</span>
<a href="#l32.240"></a><span id="l32.240" class="difflineminus">-{</span>
<a href="#l32.241"></a><span id="l32.241" class="difflineminus">-    NS_ASSERTION(aDataSource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l32.242"></a><span id="l32.242" class="difflineminus">-    if (! aDataSource)</span>
<a href="#l32.243"></a><span id="l32.243" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l32.244"></a><span id="l32.244" class="difflineminus">-</span>
<a href="#l32.245"></a><span id="l32.245" class="difflineminus">-    NS_ASSERTION(aResource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l32.246"></a><span id="l32.246" class="difflineminus">-    if (! aResource)</span>
<a href="#l32.247"></a><span id="l32.247" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l32.248"></a><span id="l32.248" class="difflineminus">-</span>
<a href="#l32.249"></a><span id="l32.249" class="difflineminus">-    NS_ASSERTION(_retval != nullptr, &quot;null ptr&quot;);</span>
<a href="#l32.250"></a><span id="l32.250" class="difflineminus">-    if (! _retval)</span>
<a href="#l32.251"></a><span id="l32.251" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l32.252"></a><span id="l32.252" class="difflineminus">-</span>
<a href="#l32.253"></a><span id="l32.253" class="difflineminus">-    *_retval = IsA(aDataSource, aResource, kRDF_Bag);</span>
<a href="#l32.254"></a><span id="l32.254" class="difflineminus">-    return NS_OK;</span>
<a href="#l32.255"></a><span id="l32.255" class="difflineminus">-}</span>
<a href="#l32.256"></a><span id="l32.256" class="difflineminus">-</span>
<a href="#l32.257"></a><span id="l32.257" class="difflineminus">-</span>
<a href="#l32.258"></a><span id="l32.258" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l32.259"></a><span id="l32.259" class="difflineminus">-RDFContainerUtilsImpl::IsSeq(nsIRDFDataSource *aDataSource, nsIRDFResource *aResource, bool *_retval)</span>
<a href="#l32.260"></a><span id="l32.260" class="difflineminus">-{</span>
<a href="#l32.261"></a><span id="l32.261" class="difflineminus">-    NS_ASSERTION(aDataSource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l32.262"></a><span id="l32.262" class="difflineminus">-    if (! aDataSource)</span>
<a href="#l32.263"></a><span id="l32.263" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l32.264"></a><span id="l32.264" class="difflineminus">-</span>
<a href="#l32.265"></a><span id="l32.265" class="difflineminus">-    NS_ASSERTION(aResource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l32.266"></a><span id="l32.266" class="difflineminus">-    if (! aResource)</span>
<a href="#l32.267"></a><span id="l32.267" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l32.268"></a><span id="l32.268" class="difflineminus">-</span>
<a href="#l32.269"></a><span id="l32.269" class="difflineminus">-    NS_ASSERTION(_retval != nullptr, &quot;null ptr&quot;);</span>
<a href="#l32.270"></a><span id="l32.270" class="difflineminus">-    if (! _retval)</span>
<a href="#l32.271"></a><span id="l32.271" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l32.272"></a><span id="l32.272" class="difflineminus">-</span>
<a href="#l32.273"></a><span id="l32.273" class="difflineminus">-    *_retval = IsA(aDataSource, aResource, kRDF_Seq);</span>
<a href="#l32.274"></a><span id="l32.274" class="difflineminus">-    return NS_OK;</span>
<a href="#l32.275"></a><span id="l32.275" class="difflineminus">-}</span>
<a href="#l32.276"></a><span id="l32.276" class="difflineminus">-</span>
<a href="#l32.277"></a><span id="l32.277" class="difflineminus">-</span>
<a href="#l32.278"></a><span id="l32.278" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l32.279"></a><span id="l32.279" class="difflineminus">-RDFContainerUtilsImpl::IsAlt(nsIRDFDataSource *aDataSource, nsIRDFResource *aResource, bool *_retval)</span>
<a href="#l32.280"></a><span id="l32.280" class="difflineminus">-{</span>
<a href="#l32.281"></a><span id="l32.281" class="difflineminus">-    NS_ASSERTION(aDataSource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l32.282"></a><span id="l32.282" class="difflineminus">-    if (! aDataSource)</span>
<a href="#l32.283"></a><span id="l32.283" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l32.284"></a><span id="l32.284" class="difflineminus">-</span>
<a href="#l32.285"></a><span id="l32.285" class="difflineminus">-    NS_ASSERTION(aResource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l32.286"></a><span id="l32.286" class="difflineminus">-    if (! aResource)</span>
<a href="#l32.287"></a><span id="l32.287" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l32.288"></a><span id="l32.288" class="difflineminus">-</span>
<a href="#l32.289"></a><span id="l32.289" class="difflineminus">-    NS_ASSERTION(_retval != nullptr, &quot;null ptr&quot;);</span>
<a href="#l32.290"></a><span id="l32.290" class="difflineminus">-    if (! _retval)</span>
<a href="#l32.291"></a><span id="l32.291" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l32.292"></a><span id="l32.292" class="difflineminus">-</span>
<a href="#l32.293"></a><span id="l32.293" class="difflineminus">-    *_retval = IsA(aDataSource, aResource, kRDF_Alt);</span>
<a href="#l32.294"></a><span id="l32.294" class="difflineminus">-    return NS_OK;</span>
<a href="#l32.295"></a><span id="l32.295" class="difflineminus">-}</span>
<a href="#l32.296"></a><span id="l32.296" class="difflineminus">-</span>
<a href="#l32.297"></a><span id="l32.297" class="difflineminus">-</span>
<a href="#l32.298"></a><span id="l32.298" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l32.299"></a><span id="l32.299" class="difflineminus">-RDFContainerUtilsImpl::MakeBag(nsIRDFDataSource *aDataSource, nsIRDFResource *aResource, nsIRDFContainer **_retval)</span>
<a href="#l32.300"></a><span id="l32.300" class="difflineminus">-{</span>
<a href="#l32.301"></a><span id="l32.301" class="difflineminus">-    return MakeContainer(aDataSource, aResource, kRDF_Bag, _retval);</span>
<a href="#l32.302"></a><span id="l32.302" class="difflineminus">-}</span>
<a href="#l32.303"></a><span id="l32.303" class="difflineminus">-</span>
<a href="#l32.304"></a><span id="l32.304" class="difflineminus">-</span>
<a href="#l32.305"></a><span id="l32.305" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l32.306"></a><span id="l32.306" class="difflineminus">-RDFContainerUtilsImpl::MakeSeq(nsIRDFDataSource *aDataSource, nsIRDFResource *aResource, nsIRDFContainer **_retval)</span>
<a href="#l32.307"></a><span id="l32.307" class="difflineminus">-{</span>
<a href="#l32.308"></a><span id="l32.308" class="difflineminus">-    return MakeContainer(aDataSource, aResource, kRDF_Seq, _retval);</span>
<a href="#l32.309"></a><span id="l32.309" class="difflineminus">-}</span>
<a href="#l32.310"></a><span id="l32.310" class="difflineminus">-</span>
<a href="#l32.311"></a><span id="l32.311" class="difflineminus">-</span>
<a href="#l32.312"></a><span id="l32.312" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l32.313"></a><span id="l32.313" class="difflineminus">-RDFContainerUtilsImpl::MakeAlt(nsIRDFDataSource *aDataSource, nsIRDFResource *aResource, nsIRDFContainer **_retval)</span>
<a href="#l32.314"></a><span id="l32.314" class="difflineminus">-{</span>
<a href="#l32.315"></a><span id="l32.315" class="difflineminus">-    return MakeContainer(aDataSource, aResource, kRDF_Alt, _retval);</span>
<a href="#l32.316"></a><span id="l32.316" class="difflineminus">-}</span>
<a href="#l32.317"></a><span id="l32.317" class="difflineminus">-</span>
<a href="#l32.318"></a><span id="l32.318" class="difflineminus">-</span>
<a href="#l32.319"></a><span id="l32.319" class="difflineminus">-</span>
<a href="#l32.320"></a><span id="l32.320" class="difflineminus">-////////////////////////////////////////////////////////////////////////</span>
<a href="#l32.321"></a><span id="l32.321" class="difflineminus">-</span>
<a href="#l32.322"></a><span id="l32.322" class="difflineminus">-</span>
<a href="#l32.323"></a><span id="l32.323" class="difflineminus">-RDFContainerUtilsImpl::RDFContainerUtilsImpl()</span>
<a href="#l32.324"></a><span id="l32.324" class="difflineminus">-{</span>
<a href="#l32.325"></a><span id="l32.325" class="difflineminus">-    if (gRefCnt++ == 0) {</span>
<a href="#l32.326"></a><span id="l32.326" class="difflineminus">-        nsresult rv;</span>
<a href="#l32.327"></a><span id="l32.327" class="difflineminus">-</span>
<a href="#l32.328"></a><span id="l32.328" class="difflineminus">-        NS_DEFINE_CID(kRDFServiceCID, NS_RDFSERVICE_CID);</span>
<a href="#l32.329"></a><span id="l32.329" class="difflineminus">-        rv = CallGetService(kRDFServiceCID, &amp;gRDFService);</span>
<a href="#l32.330"></a><span id="l32.330" class="difflineminus">-</span>
<a href="#l32.331"></a><span id="l32.331" class="difflineminus">-        NS_ASSERTION(NS_SUCCEEDED(rv), &quot;unable to get RDF service&quot;);</span>
<a href="#l32.332"></a><span id="l32.332" class="difflineminus">-        if (NS_SUCCEEDED(rv)) {</span>
<a href="#l32.333"></a><span id="l32.333" class="difflineminus">-            gRDFService-&gt;GetResource(NS_LITERAL_CSTRING(RDF_NAMESPACE_URI &quot;instanceOf&quot;),</span>
<a href="#l32.334"></a><span id="l32.334" class="difflineminus">-                                     &amp;kRDF_instanceOf);</span>
<a href="#l32.335"></a><span id="l32.335" class="difflineminus">-            gRDFService-&gt;GetResource(NS_LITERAL_CSTRING(RDF_NAMESPACE_URI &quot;nextVal&quot;),</span>
<a href="#l32.336"></a><span id="l32.336" class="difflineminus">-                                     &amp;kRDF_nextVal);</span>
<a href="#l32.337"></a><span id="l32.337" class="difflineminus">-            gRDFService-&gt;GetResource(NS_LITERAL_CSTRING(RDF_NAMESPACE_URI &quot;Bag&quot;),</span>
<a href="#l32.338"></a><span id="l32.338" class="difflineminus">-                                     &amp;kRDF_Bag);</span>
<a href="#l32.339"></a><span id="l32.339" class="difflineminus">-            gRDFService-&gt;GetResource(NS_LITERAL_CSTRING(RDF_NAMESPACE_URI &quot;Seq&quot;),</span>
<a href="#l32.340"></a><span id="l32.340" class="difflineminus">-                                     &amp;kRDF_Seq);</span>
<a href="#l32.341"></a><span id="l32.341" class="difflineminus">-            gRDFService-&gt;GetResource(NS_LITERAL_CSTRING(RDF_NAMESPACE_URI &quot;Alt&quot;),</span>
<a href="#l32.342"></a><span id="l32.342" class="difflineminus">-                                     &amp;kRDF_Alt);</span>
<a href="#l32.343"></a><span id="l32.343" class="difflineminus">-            gRDFService-&gt;GetLiteral(u&quot;1&quot;, &amp;kOne);</span>
<a href="#l32.344"></a><span id="l32.344" class="difflineminus">-        }</span>
<a href="#l32.345"></a><span id="l32.345" class="difflineminus">-    }</span>
<a href="#l32.346"></a><span id="l32.346" class="difflineminus">-}</span>
<a href="#l32.347"></a><span id="l32.347" class="difflineminus">-</span>
<a href="#l32.348"></a><span id="l32.348" class="difflineminus">-</span>
<a href="#l32.349"></a><span id="l32.349" class="difflineminus">-RDFContainerUtilsImpl::~RDFContainerUtilsImpl()</span>
<a href="#l32.350"></a><span id="l32.350" class="difflineminus">-{</span>
<a href="#l32.351"></a><span id="l32.351" class="difflineminus">-#ifdef DEBUG_REFS</span>
<a href="#l32.352"></a><span id="l32.352" class="difflineminus">-    --gInstanceCount;</span>
<a href="#l32.353"></a><span id="l32.353" class="difflineminus">-    fprintf(stdout, &quot;%d - RDF: RDFContainerUtilsImpl\n&quot;, gInstanceCount);</span>
<a href="#l32.354"></a><span id="l32.354" class="difflineminus">-#endif</span>
<a href="#l32.355"></a><span id="l32.355" class="difflineminus">-</span>
<a href="#l32.356"></a><span id="l32.356" class="difflineminus">-    if (--gRefCnt == 0) {</span>
<a href="#l32.357"></a><span id="l32.357" class="difflineminus">-        NS_IF_RELEASE(gRDFService);</span>
<a href="#l32.358"></a><span id="l32.358" class="difflineminus">-        NS_IF_RELEASE(kRDF_instanceOf);</span>
<a href="#l32.359"></a><span id="l32.359" class="difflineminus">-        NS_IF_RELEASE(kRDF_nextVal);</span>
<a href="#l32.360"></a><span id="l32.360" class="difflineminus">-        NS_IF_RELEASE(kRDF_Bag);</span>
<a href="#l32.361"></a><span id="l32.361" class="difflineminus">-        NS_IF_RELEASE(kRDF_Seq);</span>
<a href="#l32.362"></a><span id="l32.362" class="difflineminus">-        NS_IF_RELEASE(kRDF_Alt);</span>
<a href="#l32.363"></a><span id="l32.363" class="difflineminus">-        NS_IF_RELEASE(kOne);</span>
<a href="#l32.364"></a><span id="l32.364" class="difflineminus">-    }</span>
<a href="#l32.365"></a><span id="l32.365" class="difflineminus">-}</span>
<a href="#l32.366"></a><span id="l32.366" class="difflineminus">-</span>
<a href="#l32.367"></a><span id="l32.367" class="difflineminus">-</span>
<a href="#l32.368"></a><span id="l32.368" class="difflineminus">-</span>
<a href="#l32.369"></a><span id="l32.369" class="difflineminus">-nsresult</span>
<a href="#l32.370"></a><span id="l32.370" class="difflineminus">-NS_NewRDFContainerUtils(nsIRDFContainerUtils** aResult)</span>
<a href="#l32.371"></a><span id="l32.371" class="difflineminus">-{</span>
<a href="#l32.372"></a><span id="l32.372" class="difflineminus">-    NS_ASSERTION(aResult != nullptr, &quot;null ptr&quot;);</span>
<a href="#l32.373"></a><span id="l32.373" class="difflineminus">-    if (! aResult)</span>
<a href="#l32.374"></a><span id="l32.374" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l32.375"></a><span id="l32.375" class="difflineminus">-</span>
<a href="#l32.376"></a><span id="l32.376" class="difflineminus">-    RDFContainerUtilsImpl* result =</span>
<a href="#l32.377"></a><span id="l32.377" class="difflineminus">-        new RDFContainerUtilsImpl();</span>
<a href="#l32.378"></a><span id="l32.378" class="difflineminus">-</span>
<a href="#l32.379"></a><span id="l32.379" class="difflineminus">-    if (! result)</span>
<a href="#l32.380"></a><span id="l32.380" class="difflineminus">-        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l32.381"></a><span id="l32.381" class="difflineminus">-</span>
<a href="#l32.382"></a><span id="l32.382" class="difflineminus">-    NS_ADDREF(result);</span>
<a href="#l32.383"></a><span id="l32.383" class="difflineminus">-    *aResult = result;</span>
<a href="#l32.384"></a><span id="l32.384" class="difflineminus">-    return NS_OK;</span>
<a href="#l32.385"></a><span id="l32.385" class="difflineminus">-}</span>
<a href="#l32.386"></a><span id="l32.386" class="difflineminus">-</span>
<a href="#l32.387"></a><span id="l32.387" class="difflineminus">-</span>
<a href="#l32.388"></a><span id="l32.388" class="difflineminus">-nsresult</span>
<a href="#l32.389"></a><span id="l32.389" class="difflineminus">-RDFContainerUtilsImpl::MakeContainer(nsIRDFDataSource* aDataSource, nsIRDFResource* aResource, nsIRDFResource* aType, nsIRDFContainer** aResult)</span>
<a href="#l32.390"></a><span id="l32.390" class="difflineminus">-{</span>
<a href="#l32.391"></a><span id="l32.391" class="difflineminus">-    NS_ASSERTION(aDataSource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l32.392"></a><span id="l32.392" class="difflineminus">-    if (! aDataSource)	return NS_ERROR_NULL_POINTER;</span>
<a href="#l32.393"></a><span id="l32.393" class="difflineminus">-</span>
<a href="#l32.394"></a><span id="l32.394" class="difflineminus">-    NS_ASSERTION(aResource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l32.395"></a><span id="l32.395" class="difflineminus">-    if (! aResource)	return NS_ERROR_NULL_POINTER;</span>
<a href="#l32.396"></a><span id="l32.396" class="difflineminus">-</span>
<a href="#l32.397"></a><span id="l32.397" class="difflineminus">-    NS_ASSERTION(aType != nullptr, &quot;null ptr&quot;);</span>
<a href="#l32.398"></a><span id="l32.398" class="difflineminus">-    if (! aType)	return NS_ERROR_NULL_POINTER;</span>
<a href="#l32.399"></a><span id="l32.399" class="difflineminus">-</span>
<a href="#l32.400"></a><span id="l32.400" class="difflineminus">-    if (aResult)	*aResult = nullptr;</span>
<a href="#l32.401"></a><span id="l32.401" class="difflineminus">-</span>
<a href="#l32.402"></a><span id="l32.402" class="difflineminus">-    nsresult rv;</span>
<a href="#l32.403"></a><span id="l32.403" class="difflineminus">-</span>
<a href="#l32.404"></a><span id="l32.404" class="difflineminus">-    // Check to see if somebody has already turned it into a container; if so</span>
<a href="#l32.405"></a><span id="l32.405" class="difflineminus">-    // don't try to do it again.</span>
<a href="#l32.406"></a><span id="l32.406" class="difflineminus">-    bool isContainer;</span>
<a href="#l32.407"></a><span id="l32.407" class="difflineminus">-    rv = IsContainer(aDataSource, aResource, &amp;isContainer);</span>
<a href="#l32.408"></a><span id="l32.408" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l32.409"></a><span id="l32.409" class="difflineminus">-</span>
<a href="#l32.410"></a><span id="l32.410" class="difflineminus">-    if (!isContainer)</span>
<a href="#l32.411"></a><span id="l32.411" class="difflineminus">-    {</span>
<a href="#l32.412"></a><span id="l32.412" class="difflineminus">-	rv = aDataSource-&gt;Assert(aResource, kRDF_instanceOf, aType, true);</span>
<a href="#l32.413"></a><span id="l32.413" class="difflineminus">-	if (NS_FAILED(rv)) return rv;</span>
<a href="#l32.414"></a><span id="l32.414" class="difflineminus">-</span>
<a href="#l32.415"></a><span id="l32.415" class="difflineminus">-	rv = aDataSource-&gt;Assert(aResource, kRDF_nextVal, kOne, true);</span>
<a href="#l32.416"></a><span id="l32.416" class="difflineminus">-	if (NS_FAILED(rv)) return rv;</span>
<a href="#l32.417"></a><span id="l32.417" class="difflineminus">-    }</span>
<a href="#l32.418"></a><span id="l32.418" class="difflineminus">-</span>
<a href="#l32.419"></a><span id="l32.419" class="difflineminus">-    if (aResult) {</span>
<a href="#l32.420"></a><span id="l32.420" class="difflineminus">-        rv = NS_NewRDFContainer(aResult);</span>
<a href="#l32.421"></a><span id="l32.421" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l32.422"></a><span id="l32.422" class="difflineminus">-</span>
<a href="#l32.423"></a><span id="l32.423" class="difflineminus">-        rv = (*aResult)-&gt;Init(aDataSource, aResource);</span>
<a href="#l32.424"></a><span id="l32.424" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l32.425"></a><span id="l32.425" class="difflineminus">-    }</span>
<a href="#l32.426"></a><span id="l32.426" class="difflineminus">-</span>
<a href="#l32.427"></a><span id="l32.427" class="difflineminus">-    return NS_OK;</span>
<a href="#l32.428"></a><span id="l32.428" class="difflineminus">-}</span>
<a href="#l32.429"></a><span id="l32.429" class="difflineminus">-</span>
<a href="#l32.430"></a><span id="l32.430" class="difflineminus">-bool</span>
<a href="#l32.431"></a><span id="l32.431" class="difflineminus">-RDFContainerUtilsImpl::IsA(nsIRDFDataSource* aDataSource, nsIRDFResource* aResource, nsIRDFResource* aType)</span>
<a href="#l32.432"></a><span id="l32.432" class="difflineminus">-{</span>
<a href="#l32.433"></a><span id="l32.433" class="difflineminus">-    if (!aDataSource || !aResource || !aType) {</span>
<a href="#l32.434"></a><span id="l32.434" class="difflineminus">-        NS_WARNING(&quot;Unexpected null argument&quot;);</span>
<a href="#l32.435"></a><span id="l32.435" class="difflineminus">-        return false;</span>
<a href="#l32.436"></a><span id="l32.436" class="difflineminus">-    }</span>
<a href="#l32.437"></a><span id="l32.437" class="difflineminus">-</span>
<a href="#l32.438"></a><span id="l32.438" class="difflineminus">-    nsresult rv;</span>
<a href="#l32.439"></a><span id="l32.439" class="difflineminus">-</span>
<a href="#l32.440"></a><span id="l32.440" class="difflineminus">-    bool result;</span>
<a href="#l32.441"></a><span id="l32.441" class="difflineminus">-    rv = aDataSource-&gt;HasAssertion(aResource, kRDF_instanceOf, aType, true, &amp;result);</span>
<a href="#l32.442"></a><span id="l32.442" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l32.443"></a><span id="l32.443" class="difflineminus">-      return false;</span>
<a href="#l32.444"></a><span id="l32.444" class="difflineminus">-</span>
<a href="#l32.445"></a><span id="l32.445" class="difflineminus">-    return result;</span>
<a href="#l32.446"></a><span id="l32.446" class="difflineminus">-}</span>
<a href="#l32.447"></a><span id="l32.447" class="difflineminus">-</span>
<a href="#l32.448"></a><span id="l32.448" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l32.449"></a><span id="l32.449" class="difflineminus">-RDFContainerUtilsImpl::IndexOf(nsIRDFDataSource* aDataSource, nsIRDFResource* aContainer, nsIRDFNode* aElement, int32_t* aIndex)</span>
<a href="#l32.450"></a><span id="l32.450" class="difflineminus">-{</span>
<a href="#l32.451"></a><span id="l32.451" class="difflineminus">-    if (!aDataSource || !aContainer)</span>
<a href="#l32.452"></a><span id="l32.452" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l32.453"></a><span id="l32.453" class="difflineminus">-</span>
<a href="#l32.454"></a><span id="l32.454" class="difflineminus">-    // Assume we can't find it.</span>
<a href="#l32.455"></a><span id="l32.455" class="difflineminus">-    *aIndex = -1;</span>
<a href="#l32.456"></a><span id="l32.456" class="difflineminus">-</span>
<a href="#l32.457"></a><span id="l32.457" class="difflineminus">-    // If the resource is null, bail quietly</span>
<a href="#l32.458"></a><span id="l32.458" class="difflineminus">-    if (! aElement)</span>
<a href="#l32.459"></a><span id="l32.459" class="difflineminus">-      return NS_OK;</span>
<a href="#l32.460"></a><span id="l32.460" class="difflineminus">-</span>
<a href="#l32.461"></a><span id="l32.461" class="difflineminus">-    // We'll assume that fan-out is much higher than fan-in, so grovel</span>
<a href="#l32.462"></a><span id="l32.462" class="difflineminus">-    // through the inbound arcs, look for an ordinal resource, and</span>
<a href="#l32.463"></a><span id="l32.463" class="difflineminus">-    // decode it.</span>
<a href="#l32.464"></a><span id="l32.464" class="difflineminus">-    nsCOMPtr&lt;nsISimpleEnumerator&gt; arcsIn;</span>
<a href="#l32.465"></a><span id="l32.465" class="difflineminus">-    aDataSource-&gt;ArcLabelsIn(aElement, getter_AddRefs(arcsIn));</span>
<a href="#l32.466"></a><span id="l32.466" class="difflineminus">-    if (! arcsIn)</span>
<a href="#l32.467"></a><span id="l32.467" class="difflineminus">-        return NS_OK;</span>
<a href="#l32.468"></a><span id="l32.468" class="difflineminus">-</span>
<a href="#l32.469"></a><span id="l32.469" class="difflineminus">-    while (1) {</span>
<a href="#l32.470"></a><span id="l32.470" class="difflineminus">-        bool hasMoreArcs = false;</span>
<a href="#l32.471"></a><span id="l32.471" class="difflineminus">-        arcsIn-&gt;HasMoreElements(&amp;hasMoreArcs);</span>
<a href="#l32.472"></a><span id="l32.472" class="difflineminus">-        if (! hasMoreArcs)</span>
<a href="#l32.473"></a><span id="l32.473" class="difflineminus">-            break;</span>
<a href="#l32.474"></a><span id="l32.474" class="difflineminus">-</span>
<a href="#l32.475"></a><span id="l32.475" class="difflineminus">-        nsCOMPtr&lt;nsISupports&gt; isupports;</span>
<a href="#l32.476"></a><span id="l32.476" class="difflineminus">-        arcsIn-&gt;GetNext(getter_AddRefs(isupports));</span>
<a href="#l32.477"></a><span id="l32.477" class="difflineminus">-        if (! isupports)</span>
<a href="#l32.478"></a><span id="l32.478" class="difflineminus">-            break;</span>
<a href="#l32.479"></a><span id="l32.479" class="difflineminus">-</span>
<a href="#l32.480"></a><span id="l32.480" class="difflineminus">-        nsCOMPtr&lt;nsIRDFResource&gt; property =</span>
<a href="#l32.481"></a><span id="l32.481" class="difflineminus">-            do_QueryInterface(isupports);</span>
<a href="#l32.482"></a><span id="l32.482" class="difflineminus">-</span>
<a href="#l32.483"></a><span id="l32.483" class="difflineminus">-        if (! property)</span>
<a href="#l32.484"></a><span id="l32.484" class="difflineminus">-            continue;</span>
<a href="#l32.485"></a><span id="l32.485" class="difflineminus">-</span>
<a href="#l32.486"></a><span id="l32.486" class="difflineminus">-        bool isOrdinal;</span>
<a href="#l32.487"></a><span id="l32.487" class="difflineminus">-        IsOrdinalProperty(property, &amp;isOrdinal);</span>
<a href="#l32.488"></a><span id="l32.488" class="difflineminus">-        if (! isOrdinal)</span>
<a href="#l32.489"></a><span id="l32.489" class="difflineminus">-            continue;</span>
<a href="#l32.490"></a><span id="l32.490" class="difflineminus">-</span>
<a href="#l32.491"></a><span id="l32.491" class="difflineminus">-        nsCOMPtr&lt;nsISimpleEnumerator&gt; sources;</span>
<a href="#l32.492"></a><span id="l32.492" class="difflineminus">-        aDataSource-&gt;GetSources(property, aElement, true, getter_AddRefs(sources));</span>
<a href="#l32.493"></a><span id="l32.493" class="difflineminus">-        if (! sources)</span>
<a href="#l32.494"></a><span id="l32.494" class="difflineminus">-            continue;</span>
<a href="#l32.495"></a><span id="l32.495" class="difflineminus">-</span>
<a href="#l32.496"></a><span id="l32.496" class="difflineminus">-        while (1) {</span>
<a href="#l32.497"></a><span id="l32.497" class="difflineminus">-            bool hasMoreSources = false;</span>
<a href="#l32.498"></a><span id="l32.498" class="difflineminus">-            sources-&gt;HasMoreElements(&amp;hasMoreSources);</span>
<a href="#l32.499"></a><span id="l32.499" class="difflineminus">-            if (! hasMoreSources)</span>
<a href="#l32.500"></a><span id="l32.500" class="difflineminus">-                break;</span>
<a href="#l32.501"></a><span id="l32.501" class="difflineminus">-</span>
<a href="#l32.502"></a><span id="l32.502" class="difflineminus">-            nsCOMPtr&lt;nsISupports&gt; isupports2;</span>
<a href="#l32.503"></a><span id="l32.503" class="difflineminus">-            sources-&gt;GetNext(getter_AddRefs(isupports2));</span>
<a href="#l32.504"></a><span id="l32.504" class="difflineminus">-            if (! isupports2)</span>
<a href="#l32.505"></a><span id="l32.505" class="difflineminus">-                break;</span>
<a href="#l32.506"></a><span id="l32.506" class="difflineminus">-</span>
<a href="#l32.507"></a><span id="l32.507" class="difflineminus">-            nsCOMPtr&lt;nsIRDFResource&gt; source =</span>
<a href="#l32.508"></a><span id="l32.508" class="difflineminus">-                do_QueryInterface(isupports2);</span>
<a href="#l32.509"></a><span id="l32.509" class="difflineminus">-</span>
<a href="#l32.510"></a><span id="l32.510" class="difflineminus">-            if (source == aContainer)</span>
<a href="#l32.511"></a><span id="l32.511" class="difflineminus">-                // Found it.</span>
<a href="#l32.512"></a><span id="l32.512" class="difflineminus">-                return OrdinalResourceToIndex(property, aIndex);</span>
<a href="#l32.513"></a><span id="l32.513" class="difflineminus">-        }</span>
<a href="#l32.514"></a><span id="l32.514" class="difflineminus">-    }</span>
<a href="#l32.515"></a><span id="l32.515" class="difflineminus">-</span>
<a href="#l32.516"></a><span id="l32.516" class="difflineminus">-    return NS_OK;</span>
<a href="#l32.517"></a><span id="l32.517" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1">deleted file mode 100644</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineminus">--- a/rdf/base/nsRDFContentSink.cpp</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineplus">+++ /dev/null</span>
<a href="#l33.4"></a><span id="l33.4" class="difflineat">@@ -1,1445 +0,0 @@</span>
<a href="#l33.5"></a><span id="l33.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l33.6"></a><span id="l33.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l33.7"></a><span id="l33.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l33.8"></a><span id="l33.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l33.9"></a><span id="l33.9" class="difflineminus">-</span>
<a href="#l33.10"></a><span id="l33.10" class="difflineminus">-/*</span>
<a href="#l33.11"></a><span id="l33.11" class="difflineminus">-</span>
<a href="#l33.12"></a><span id="l33.12" class="difflineminus">-  An implementation for an NGLayout-style content sink that knows how</span>
<a href="#l33.13"></a><span id="l33.13" class="difflineminus">-  to build an RDF content model from XML-serialized RDF.</span>
<a href="#l33.14"></a><span id="l33.14" class="difflineminus">-</span>
<a href="#l33.15"></a><span id="l33.15" class="difflineminus">-  For more information on the RDF/XML syntax,</span>
<a href="#l33.16"></a><span id="l33.16" class="difflineminus">-  see http://www.w3.org/TR/REC-rdf-syntax/</span>
<a href="#l33.17"></a><span id="l33.17" class="difflineminus">-</span>
<a href="#l33.18"></a><span id="l33.18" class="difflineminus">-  This code is based on the final W3C Recommendation,</span>
<a href="#l33.19"></a><span id="l33.19" class="difflineminus">-  http://www.w3.org/TR/1999/REC-rdf-syntax-19990222.</span>
<a href="#l33.20"></a><span id="l33.20" class="difflineminus">-</span>
<a href="#l33.21"></a><span id="l33.21" class="difflineminus">-  Open Issues ------------------</span>
<a href="#l33.22"></a><span id="l33.22" class="difflineminus">-</span>
<a href="#l33.23"></a><span id="l33.23" class="difflineminus">-  1) factoring code with nsXMLContentSink - There's some amount of</span>
<a href="#l33.24"></a><span id="l33.24" class="difflineminus">-     common code between this and the HTML content sink. This will</span>
<a href="#l33.25"></a><span id="l33.25" class="difflineminus">-     increase as we support more and more HTML elements. How can code</span>
<a href="#l33.26"></a><span id="l33.26" class="difflineminus">-     from XML/HTML be factored?</span>
<a href="#l33.27"></a><span id="l33.27" class="difflineminus">-</span>
<a href="#l33.28"></a><span id="l33.28" class="difflineminus">-  2) We don't support the `parseType' attribute on the Description</span>
<a href="#l33.29"></a><span id="l33.29" class="difflineminus">-     tag; therefore, it is impossible to &quot;inline&quot; raw XML in this</span>
<a href="#l33.30"></a><span id="l33.30" class="difflineminus">-     implemenation.</span>
<a href="#l33.31"></a><span id="l33.31" class="difflineminus">-</span>
<a href="#l33.32"></a><span id="l33.32" class="difflineminus">-  3) We don't build the reifications at parse time due to the</span>
<a href="#l33.33"></a><span id="l33.33" class="difflineminus">-     footprint overhead it would incur for large RDF documents. (It</span>
<a href="#l33.34"></a><span id="l33.34" class="difflineminus">-     may be possible to attach a &quot;reification&quot; wrapper datasource that</span>
<a href="#l33.35"></a><span id="l33.35" class="difflineminus">-     would present this information at query-time.) Because of this,</span>
<a href="#l33.36"></a><span id="l33.36" class="difflineminus">-     the `bagID' attribute is not processed correctly.</span>
<a href="#l33.37"></a><span id="l33.37" class="difflineminus">-</span>
<a href="#l33.38"></a><span id="l33.38" class="difflineminus">-  4) No attempt is made to `resolve URIs' to a canonical form (the</span>
<a href="#l33.39"></a><span id="l33.39" class="difflineminus">-     specification hints that an implementation should do this). This</span>
<a href="#l33.40"></a><span id="l33.40" class="difflineminus">-     is omitted for the obvious reason that we can ill afford to</span>
<a href="#l33.41"></a><span id="l33.41" class="difflineminus">-     resolve each URI reference.</span>
<a href="#l33.42"></a><span id="l33.42" class="difflineminus">-</span>
<a href="#l33.43"></a><span id="l33.43" class="difflineminus">-*/</span>
<a href="#l33.44"></a><span id="l33.44" class="difflineminus">-</span>
<a href="#l33.45"></a><span id="l33.45" class="difflineminus">-#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l33.46"></a><span id="l33.46" class="difflineminus">-#include &quot;nsInterfaceHashtable.h&quot;</span>
<a href="#l33.47"></a><span id="l33.47" class="difflineminus">-#include &quot;nsIContentSink.h&quot;</span>
<a href="#l33.48"></a><span id="l33.48" class="difflineminus">-#include &quot;nsIRDFContainer.h&quot;</span>
<a href="#l33.49"></a><span id="l33.49" class="difflineminus">-#include &quot;nsIRDFContainerUtils.h&quot;</span>
<a href="#l33.50"></a><span id="l33.50" class="difflineminus">-#include &quot;nsIRDFContentSink.h&quot;</span>
<a href="#l33.51"></a><span id="l33.51" class="difflineminus">-#include &quot;nsIRDFNode.h&quot;</span>
<a href="#l33.52"></a><span id="l33.52" class="difflineminus">-#include &quot;nsIRDFService.h&quot;</span>
<a href="#l33.53"></a><span id="l33.53" class="difflineminus">-#include &quot;nsIRDFXMLSink.h&quot;</span>
<a href="#l33.54"></a><span id="l33.54" class="difflineminus">-#include &quot;nsIServiceManager.h&quot;</span>
<a href="#l33.55"></a><span id="l33.55" class="difflineminus">-#include &quot;nsIURL.h&quot;</span>
<a href="#l33.56"></a><span id="l33.56" class="difflineminus">-#include &quot;nsIXMLContentSink.h&quot;</span>
<a href="#l33.57"></a><span id="l33.57" class="difflineminus">-#include &quot;nsRDFCID.h&quot;</span>
<a href="#l33.58"></a><span id="l33.58" class="difflineminus">-#include &quot;nsTArray.h&quot;</span>
<a href="#l33.59"></a><span id="l33.59" class="difflineminus">-#include &quot;nsString.h&quot;</span>
<a href="#l33.60"></a><span id="l33.60" class="difflineminus">-#include &quot;mozilla/Logging.h&quot;</span>
<a href="#l33.61"></a><span id="l33.61" class="difflineminus">-#include &quot;rdf.h&quot;</span>
<a href="#l33.62"></a><span id="l33.62" class="difflineminus">-#include &quot;rdfutil.h&quot;</span>
<a href="#l33.63"></a><span id="l33.63" class="difflineminus">-#include &quot;nsReadableUtils.h&quot;</span>
<a href="#l33.64"></a><span id="l33.64" class="difflineminus">-#include &quot;nsIExpatSink.h&quot;</span>
<a href="#l33.65"></a><span id="l33.65" class="difflineminus">-#include &quot;nsCRT.h&quot;</span>
<a href="#l33.66"></a><span id="l33.66" class="difflineminus">-#include &quot;nsAtom.h&quot;</span>
<a href="#l33.67"></a><span id="l33.67" class="difflineminus">-#include &quot;nsGkAtoms.h&quot;</span>
<a href="#l33.68"></a><span id="l33.68" class="difflineminus">-#include &quot;nsIScriptError.h&quot;</span>
<a href="#l33.69"></a><span id="l33.69" class="difflineminus">-#include &quot;nsIDTD.h&quot;</span>
<a href="#l33.70"></a><span id="l33.70" class="difflineminus">-</span>
<a href="#l33.71"></a><span id="l33.71" class="difflineminus">-using namespace mozilla;</span>
<a href="#l33.72"></a><span id="l33.72" class="difflineminus">-</span>
<a href="#l33.73"></a><span id="l33.73" class="difflineminus">-///////////////////////////////////////////////////////////////////////</span>
<a href="#l33.74"></a><span id="l33.74" class="difflineminus">-</span>
<a href="#l33.75"></a><span id="l33.75" class="difflineminus">-enum RDFContentSinkState {</span>
<a href="#l33.76"></a><span id="l33.76" class="difflineminus">-    eRDFContentSinkState_InProlog,</span>
<a href="#l33.77"></a><span id="l33.77" class="difflineminus">-    eRDFContentSinkState_InDocumentElement,</span>
<a href="#l33.78"></a><span id="l33.78" class="difflineminus">-    eRDFContentSinkState_InDescriptionElement,</span>
<a href="#l33.79"></a><span id="l33.79" class="difflineminus">-    eRDFContentSinkState_InContainerElement,</span>
<a href="#l33.80"></a><span id="l33.80" class="difflineminus">-    eRDFContentSinkState_InPropertyElement,</span>
<a href="#l33.81"></a><span id="l33.81" class="difflineminus">-    eRDFContentSinkState_InMemberElement,</span>
<a href="#l33.82"></a><span id="l33.82" class="difflineminus">-    eRDFContentSinkState_InEpilog</span>
<a href="#l33.83"></a><span id="l33.83" class="difflineminus">-};</span>
<a href="#l33.84"></a><span id="l33.84" class="difflineminus">-</span>
<a href="#l33.85"></a><span id="l33.85" class="difflineminus">-enum RDFContentSinkParseMode {</span>
<a href="#l33.86"></a><span id="l33.86" class="difflineminus">-    eRDFContentSinkParseMode_Resource,</span>
<a href="#l33.87"></a><span id="l33.87" class="difflineminus">-    eRDFContentSinkParseMode_Literal,</span>
<a href="#l33.88"></a><span id="l33.88" class="difflineminus">-    eRDFContentSinkParseMode_Int,</span>
<a href="#l33.89"></a><span id="l33.89" class="difflineminus">-    eRDFContentSinkParseMode_Date</span>
<a href="#l33.90"></a><span id="l33.90" class="difflineminus">-};</span>
<a href="#l33.91"></a><span id="l33.91" class="difflineminus">-</span>
<a href="#l33.92"></a><span id="l33.92" class="difflineminus">-typedef decltype(&amp;nsIRDFContainerUtils::IsAlt) nsContainerTestFn;</span>
<a href="#l33.93"></a><span id="l33.93" class="difflineminus">-typedef decltype(&amp;nsIRDFContainerUtils::MakeAlt) nsMakeContainerFn;</span>
<a href="#l33.94"></a><span id="l33.94" class="difflineminus">-</span>
<a href="#l33.95"></a><span id="l33.95" class="difflineminus">-class RDFContentSinkImpl : public nsIRDFContentSink,</span>
<a href="#l33.96"></a><span id="l33.96" class="difflineminus">-                           public nsIExpatSink</span>
<a href="#l33.97"></a><span id="l33.97" class="difflineminus">-{</span>
<a href="#l33.98"></a><span id="l33.98" class="difflineminus">-public:</span>
<a href="#l33.99"></a><span id="l33.99" class="difflineminus">-    RDFContentSinkImpl();</span>
<a href="#l33.100"></a><span id="l33.100" class="difflineminus">-</span>
<a href="#l33.101"></a><span id="l33.101" class="difflineminus">-    // nsISupports</span>
<a href="#l33.102"></a><span id="l33.102" class="difflineminus">-    NS_DECL_ISUPPORTS</span>
<a href="#l33.103"></a><span id="l33.103" class="difflineminus">-    NS_DECL_NSIEXPATSINK</span>
<a href="#l33.104"></a><span id="l33.104" class="difflineminus">-</span>
<a href="#l33.105"></a><span id="l33.105" class="difflineminus">-    // nsIContentSink</span>
<a href="#l33.106"></a><span id="l33.106" class="difflineminus">-    NS_IMETHOD WillParse(void) override;</span>
<a href="#l33.107"></a><span id="l33.107" class="difflineminus">-    NS_IMETHOD WillBuildModel(nsDTDMode aDTDMode) override;</span>
<a href="#l33.108"></a><span id="l33.108" class="difflineminus">-    NS_IMETHOD DidBuildModel(bool aTerminated) override;</span>
<a href="#l33.109"></a><span id="l33.109" class="difflineminus">-    NS_IMETHOD WillInterrupt(void) override;</span>
<a href="#l33.110"></a><span id="l33.110" class="difflineminus">-    NS_IMETHOD WillResume(void) override;</span>
<a href="#l33.111"></a><span id="l33.111" class="difflineminus">-    NS_IMETHOD SetParser(nsParserBase* aParser) override;</span>
<a href="#l33.112"></a><span id="l33.112" class="difflineminus">-    virtual void FlushPendingNotifications(mozilla::FlushType aType) override { }</span>
<a href="#l33.113"></a><span id="l33.113" class="difflineminus">-    virtual void SetDocumentCharset(NotNull&lt;const Encoding*&gt; aEncoding)</span>
<a href="#l33.114"></a><span id="l33.114" class="difflineminus">-      override { }</span>
<a href="#l33.115"></a><span id="l33.115" class="difflineminus">-    virtual nsISupports *GetTarget() override { return nullptr; }</span>
<a href="#l33.116"></a><span id="l33.116" class="difflineminus">-</span>
<a href="#l33.117"></a><span id="l33.117" class="difflineminus">-    // nsIRDFContentSink</span>
<a href="#l33.118"></a><span id="l33.118" class="difflineminus">-    NS_IMETHOD Init(nsIURI* aURL) override;</span>
<a href="#l33.119"></a><span id="l33.119" class="difflineminus">-    NS_IMETHOD SetDataSource(nsIRDFDataSource* aDataSource) override;</span>
<a href="#l33.120"></a><span id="l33.120" class="difflineminus">-    NS_IMETHOD GetDataSource(nsIRDFDataSource*&amp; aDataSource) override;</span>
<a href="#l33.121"></a><span id="l33.121" class="difflineminus">-</span>
<a href="#l33.122"></a><span id="l33.122" class="difflineminus">-    // pseudo constants</span>
<a href="#l33.123"></a><span id="l33.123" class="difflineminus">-    static int32_t gRefCnt;</span>
<a href="#l33.124"></a><span id="l33.124" class="difflineminus">-    static nsIRDFService* gRDFService;</span>
<a href="#l33.125"></a><span id="l33.125" class="difflineminus">-    static nsIRDFContainerUtils* gRDFContainerUtils;</span>
<a href="#l33.126"></a><span id="l33.126" class="difflineminus">-    static nsIRDFResource* kRDF_type;</span>
<a href="#l33.127"></a><span id="l33.127" class="difflineminus">-    static nsIRDFResource* kRDF_instanceOf; // XXX should be RDF:type</span>
<a href="#l33.128"></a><span id="l33.128" class="difflineminus">-    static nsIRDFResource* kRDF_Alt;</span>
<a href="#l33.129"></a><span id="l33.129" class="difflineminus">-    static nsIRDFResource* kRDF_Bag;</span>
<a href="#l33.130"></a><span id="l33.130" class="difflineminus">-    static nsIRDFResource* kRDF_Seq;</span>
<a href="#l33.131"></a><span id="l33.131" class="difflineminus">-    static nsIRDFResource* kRDF_nextVal;</span>
<a href="#l33.132"></a><span id="l33.132" class="difflineminus">-</span>
<a href="#l33.133"></a><span id="l33.133" class="difflineminus">-    typedef struct ContainerInfo {</span>
<a href="#l33.134"></a><span id="l33.134" class="difflineminus">-        nsIRDFResource**  mType;</span>
<a href="#l33.135"></a><span id="l33.135" class="difflineminus">-        nsContainerTestFn mTestFn;</span>
<a href="#l33.136"></a><span id="l33.136" class="difflineminus">-        nsMakeContainerFn mMakeFn;</span>
<a href="#l33.137"></a><span id="l33.137" class="difflineminus">-    } ContainerInfo;</span>
<a href="#l33.138"></a><span id="l33.138" class="difflineminus">-</span>
<a href="#l33.139"></a><span id="l33.139" class="difflineminus">-protected:</span>
<a href="#l33.140"></a><span id="l33.140" class="difflineminus">-    virtual ~RDFContentSinkImpl();</span>
<a href="#l33.141"></a><span id="l33.141" class="difflineminus">-</span>
<a href="#l33.142"></a><span id="l33.142" class="difflineminus">-    // Text management</span>
<a href="#l33.143"></a><span id="l33.143" class="difflineminus">-    void ParseText(nsIRDFNode **aResult);</span>
<a href="#l33.144"></a><span id="l33.144" class="difflineminus">-</span>
<a href="#l33.145"></a><span id="l33.145" class="difflineminus">-    nsresult FlushText();</span>
<a href="#l33.146"></a><span id="l33.146" class="difflineminus">-    nsresult AddText(const char16_t* aText, int32_t aLength);</span>
<a href="#l33.147"></a><span id="l33.147" class="difflineminus">-</span>
<a href="#l33.148"></a><span id="l33.148" class="difflineminus">-    // RDF-specific parsing</span>
<a href="#l33.149"></a><span id="l33.149" class="difflineminus">-    nsresult OpenRDF(const char16_t* aName);</span>
<a href="#l33.150"></a><span id="l33.150" class="difflineminus">-    nsresult OpenObject(const char16_t* aName ,const char16_t** aAttributes);</span>
<a href="#l33.151"></a><span id="l33.151" class="difflineminus">-    nsresult OpenProperty(const char16_t* aName, const char16_t** aAttributes);</span>
<a href="#l33.152"></a><span id="l33.152" class="difflineminus">-    nsresult OpenMember(const char16_t* aName, const char16_t** aAttributes);</span>
<a href="#l33.153"></a><span id="l33.153" class="difflineminus">-    nsresult OpenValue(const char16_t* aName, const char16_t** aAttributes);</span>
<a href="#l33.154"></a><span id="l33.154" class="difflineminus">-</span>
<a href="#l33.155"></a><span id="l33.155" class="difflineminus">-    nsresult GetIdAboutAttribute(const char16_t** aAttributes, nsIRDFResource** aResource, bool* aIsAnonymous = nullptr);</span>
<a href="#l33.156"></a><span id="l33.156" class="difflineminus">-    nsresult GetResourceAttribute(const char16_t** aAttributes, nsIRDFResource** aResource);</span>
<a href="#l33.157"></a><span id="l33.157" class="difflineminus">-    nsresult AddProperties(const char16_t** aAttributes, nsIRDFResource* aSubject, int32_t* aCount = nullptr);</span>
<a href="#l33.158"></a><span id="l33.158" class="difflineminus">-    void SetParseMode(const char16_t **aAttributes);</span>
<a href="#l33.159"></a><span id="l33.159" class="difflineminus">-</span>
<a href="#l33.160"></a><span id="l33.160" class="difflineminus">-    char16_t* mText;</span>
<a href="#l33.161"></a><span id="l33.161" class="difflineminus">-    int32_t mTextLength;</span>
<a href="#l33.162"></a><span id="l33.162" class="difflineminus">-    int32_t mTextSize;</span>
<a href="#l33.163"></a><span id="l33.163" class="difflineminus">-</span>
<a href="#l33.164"></a><span id="l33.164" class="difflineminus">-    /**</span>
<a href="#l33.165"></a><span id="l33.165" class="difflineminus">-     * From the set of given attributes, this method extracts the</span>
<a href="#l33.166"></a><span id="l33.166" class="difflineminus">-     * namespace definitions and feeds them to the datasource.</span>
<a href="#l33.167"></a><span id="l33.167" class="difflineminus">-     * These can then be suggested to the serializer to be used again.</span>
<a href="#l33.168"></a><span id="l33.168" class="difflineminus">-     * Hopefully, this will keep namespace definitions intact in a</span>
<a href="#l33.169"></a><span id="l33.169" class="difflineminus">-     * parse - serialize cycle.</span>
<a href="#l33.170"></a><span id="l33.170" class="difflineminus">-     */</span>
<a href="#l33.171"></a><span id="l33.171" class="difflineminus">-    void RegisterNamespaces(const char16_t **aAttributes);</span>
<a href="#l33.172"></a><span id="l33.172" class="difflineminus">-</span>
<a href="#l33.173"></a><span id="l33.173" class="difflineminus">-    /**</span>
<a href="#l33.174"></a><span id="l33.174" class="difflineminus">-     * Extracts the localname from aExpatName, the name that the Expat parser</span>
<a href="#l33.175"></a><span id="l33.175" class="difflineminus">-     * passes us.</span>
<a href="#l33.176"></a><span id="l33.176" class="difflineminus">-     * aLocalName will contain the localname in aExpatName.</span>
<a href="#l33.177"></a><span id="l33.177" class="difflineminus">-     * The return value is a dependent string containing just the namespace.</span>
<a href="#l33.178"></a><span id="l33.178" class="difflineminus">-     */</span>
<a href="#l33.179"></a><span id="l33.179" class="difflineminus">-    const nsDependentSubstring SplitExpatName(const char16_t *aExpatName,</span>
<a href="#l33.180"></a><span id="l33.180" class="difflineminus">-                                              nsAtom **aLocalName);</span>
<a href="#l33.181"></a><span id="l33.181" class="difflineminus">-</span>
<a href="#l33.182"></a><span id="l33.182" class="difflineminus">-    enum eContainerType { eBag, eSeq, eAlt };</span>
<a href="#l33.183"></a><span id="l33.183" class="difflineminus">-    nsresult InitContainer(nsIRDFResource* aContainerType, nsIRDFResource* aContainer);</span>
<a href="#l33.184"></a><span id="l33.184" class="difflineminus">-    nsresult ReinitContainer(nsIRDFResource* aContainerType, nsIRDFResource* aContainer);</span>
<a href="#l33.185"></a><span id="l33.185" class="difflineminus">-</span>
<a href="#l33.186"></a><span id="l33.186" class="difflineminus">-    // The datasource in which we're assigning assertions</span>
<a href="#l33.187"></a><span id="l33.187" class="difflineminus">-    nsCOMPtr&lt;nsIRDFDataSource&gt; mDataSource;</span>
<a href="#l33.188"></a><span id="l33.188" class="difflineminus">-</span>
<a href="#l33.189"></a><span id="l33.189" class="difflineminus">-    // A hash of all the node IDs referred to</span>
<a href="#l33.190"></a><span id="l33.190" class="difflineminus">-    nsInterfaceHashtable&lt;nsStringHashKey, nsIRDFResource&gt; mNodeIDMap;</span>
<a href="#l33.191"></a><span id="l33.191" class="difflineminus">-</span>
<a href="#l33.192"></a><span id="l33.192" class="difflineminus">-    // The current state of the content sink</span>
<a href="#l33.193"></a><span id="l33.193" class="difflineminus">-    RDFContentSinkState mState;</span>
<a href="#l33.194"></a><span id="l33.194" class="difflineminus">-    RDFContentSinkParseMode mParseMode;</span>
<a href="#l33.195"></a><span id="l33.195" class="difflineminus">-</span>
<a href="#l33.196"></a><span id="l33.196" class="difflineminus">-    // content stack management</span>
<a href="#l33.197"></a><span id="l33.197" class="difflineminus">-    int32_t</span>
<a href="#l33.198"></a><span id="l33.198" class="difflineminus">-    PushContext(nsIRDFResource *aContext,</span>
<a href="#l33.199"></a><span id="l33.199" class="difflineminus">-                RDFContentSinkState aState,</span>
<a href="#l33.200"></a><span id="l33.200" class="difflineminus">-                RDFContentSinkParseMode aParseMode);</span>
<a href="#l33.201"></a><span id="l33.201" class="difflineminus">-</span>
<a href="#l33.202"></a><span id="l33.202" class="difflineminus">-    nsresult</span>
<a href="#l33.203"></a><span id="l33.203" class="difflineminus">-    PopContext(nsIRDFResource         *&amp;aContext,</span>
<a href="#l33.204"></a><span id="l33.204" class="difflineminus">-               RDFContentSinkState     &amp;aState,</span>
<a href="#l33.205"></a><span id="l33.205" class="difflineminus">-               RDFContentSinkParseMode &amp;aParseMode);</span>
<a href="#l33.206"></a><span id="l33.206" class="difflineminus">-</span>
<a href="#l33.207"></a><span id="l33.207" class="difflineminus">-    nsIRDFResource* GetContextElement(int32_t ancestor = 0);</span>
<a href="#l33.208"></a><span id="l33.208" class="difflineminus">-</span>
<a href="#l33.209"></a><span id="l33.209" class="difflineminus">-</span>
<a href="#l33.210"></a><span id="l33.210" class="difflineminus">-    struct RDFContextStackElement {</span>
<a href="#l33.211"></a><span id="l33.211" class="difflineminus">-        nsCOMPtr&lt;nsIRDFResource&gt; mResource;</span>
<a href="#l33.212"></a><span id="l33.212" class="difflineminus">-        RDFContentSinkState      mState;</span>
<a href="#l33.213"></a><span id="l33.213" class="difflineminus">-        RDFContentSinkParseMode  mParseMode;</span>
<a href="#l33.214"></a><span id="l33.214" class="difflineminus">-    };</span>
<a href="#l33.215"></a><span id="l33.215" class="difflineminus">-</span>
<a href="#l33.216"></a><span id="l33.216" class="difflineminus">-    AutoTArray&lt;RDFContextStackElement, 8&gt;* mContextStack;</span>
<a href="#l33.217"></a><span id="l33.217" class="difflineminus">-</span>
<a href="#l33.218"></a><span id="l33.218" class="difflineminus">-    nsCOMPtr&lt;nsIURI&gt; mDocumentURL;</span>
<a href="#l33.219"></a><span id="l33.219" class="difflineminus">-</span>
<a href="#l33.220"></a><span id="l33.220" class="difflineminus">-private:</span>
<a href="#l33.221"></a><span id="l33.221" class="difflineminus">-    static mozilla::LazyLogModule gLog;</span>
<a href="#l33.222"></a><span id="l33.222" class="difflineminus">-};</span>
<a href="#l33.223"></a><span id="l33.223" class="difflineminus">-</span>
<a href="#l33.224"></a><span id="l33.224" class="difflineminus">-int32_t         RDFContentSinkImpl::gRefCnt = 0;</span>
<a href="#l33.225"></a><span id="l33.225" class="difflineminus">-nsIRDFService*  RDFContentSinkImpl::gRDFService;</span>
<a href="#l33.226"></a><span id="l33.226" class="difflineminus">-nsIRDFContainerUtils* RDFContentSinkImpl::gRDFContainerUtils;</span>
<a href="#l33.227"></a><span id="l33.227" class="difflineminus">-nsIRDFResource* RDFContentSinkImpl::kRDF_type;</span>
<a href="#l33.228"></a><span id="l33.228" class="difflineminus">-nsIRDFResource* RDFContentSinkImpl::kRDF_instanceOf;</span>
<a href="#l33.229"></a><span id="l33.229" class="difflineminus">-nsIRDFResource* RDFContentSinkImpl::kRDF_Alt;</span>
<a href="#l33.230"></a><span id="l33.230" class="difflineminus">-nsIRDFResource* RDFContentSinkImpl::kRDF_Bag;</span>
<a href="#l33.231"></a><span id="l33.231" class="difflineminus">-nsIRDFResource* RDFContentSinkImpl::kRDF_Seq;</span>
<a href="#l33.232"></a><span id="l33.232" class="difflineminus">-nsIRDFResource* RDFContentSinkImpl::kRDF_nextVal;</span>
<a href="#l33.233"></a><span id="l33.233" class="difflineminus">-</span>
<a href="#l33.234"></a><span id="l33.234" class="difflineminus">-mozilla::LazyLogModule RDFContentSinkImpl::gLog(&quot;nsRDFContentSink&quot;);</span>
<a href="#l33.235"></a><span id="l33.235" class="difflineminus">-</span>
<a href="#l33.236"></a><span id="l33.236" class="difflineminus">-////////////////////////////////////////////////////////////////////////</span>
<a href="#l33.237"></a><span id="l33.237" class="difflineminus">-</span>
<a href="#l33.238"></a><span id="l33.238" class="difflineminus">-RDFContentSinkImpl::RDFContentSinkImpl()</span>
<a href="#l33.239"></a><span id="l33.239" class="difflineminus">-    : mText(nullptr),</span>
<a href="#l33.240"></a><span id="l33.240" class="difflineminus">-      mTextLength(0),</span>
<a href="#l33.241"></a><span id="l33.241" class="difflineminus">-      mTextSize(0),</span>
<a href="#l33.242"></a><span id="l33.242" class="difflineminus">-      mState(eRDFContentSinkState_InProlog),</span>
<a href="#l33.243"></a><span id="l33.243" class="difflineminus">-      mParseMode(eRDFContentSinkParseMode_Literal),</span>
<a href="#l33.244"></a><span id="l33.244" class="difflineminus">-      mContextStack(nullptr)</span>
<a href="#l33.245"></a><span id="l33.245" class="difflineminus">-{</span>
<a href="#l33.246"></a><span id="l33.246" class="difflineminus">-    if (gRefCnt++ == 0) {</span>
<a href="#l33.247"></a><span id="l33.247" class="difflineminus">-        NS_DEFINE_CID(kRDFServiceCID, NS_RDFSERVICE_CID);</span>
<a href="#l33.248"></a><span id="l33.248" class="difflineminus">-        nsresult rv = CallGetService(kRDFServiceCID, &amp;gRDFService);</span>
<a href="#l33.249"></a><span id="l33.249" class="difflineminus">-</span>
<a href="#l33.250"></a><span id="l33.250" class="difflineminus">-        NS_ASSERTION(NS_SUCCEEDED(rv), &quot;unable to get RDF service&quot;);</span>
<a href="#l33.251"></a><span id="l33.251" class="difflineminus">-        if (NS_SUCCEEDED(rv)) {</span>
<a href="#l33.252"></a><span id="l33.252" class="difflineminus">-            rv = gRDFService-&gt;GetResource(NS_LITERAL_CSTRING(RDF_NAMESPACE_URI &quot;type&quot;),</span>
<a href="#l33.253"></a><span id="l33.253" class="difflineminus">-                                          &amp;kRDF_type);</span>
<a href="#l33.254"></a><span id="l33.254" class="difflineminus">-            rv = gRDFService-&gt;GetResource(NS_LITERAL_CSTRING(RDF_NAMESPACE_URI &quot;instanceOf&quot;),</span>
<a href="#l33.255"></a><span id="l33.255" class="difflineminus">-                                          &amp;kRDF_instanceOf);</span>
<a href="#l33.256"></a><span id="l33.256" class="difflineminus">-            rv = gRDFService-&gt;GetResource(NS_LITERAL_CSTRING(RDF_NAMESPACE_URI &quot;Alt&quot;),</span>
<a href="#l33.257"></a><span id="l33.257" class="difflineminus">-                                          &amp;kRDF_Alt);</span>
<a href="#l33.258"></a><span id="l33.258" class="difflineminus">-            rv = gRDFService-&gt;GetResource(NS_LITERAL_CSTRING(RDF_NAMESPACE_URI &quot;Bag&quot;),</span>
<a href="#l33.259"></a><span id="l33.259" class="difflineminus">-                                          &amp;kRDF_Bag);</span>
<a href="#l33.260"></a><span id="l33.260" class="difflineminus">-            rv = gRDFService-&gt;GetResource(NS_LITERAL_CSTRING(RDF_NAMESPACE_URI &quot;Seq&quot;),</span>
<a href="#l33.261"></a><span id="l33.261" class="difflineminus">-                                          &amp;kRDF_Seq);</span>
<a href="#l33.262"></a><span id="l33.262" class="difflineminus">-            rv = gRDFService-&gt;GetResource(NS_LITERAL_CSTRING(RDF_NAMESPACE_URI &quot;nextVal&quot;),</span>
<a href="#l33.263"></a><span id="l33.263" class="difflineminus">-                                          &amp;kRDF_nextVal);</span>
<a href="#l33.264"></a><span id="l33.264" class="difflineminus">-        }</span>
<a href="#l33.265"></a><span id="l33.265" class="difflineminus">-</span>
<a href="#l33.266"></a><span id="l33.266" class="difflineminus">-        NS_DEFINE_CID(kRDFContainerUtilsCID, NS_RDFCONTAINERUTILS_CID);</span>
<a href="#l33.267"></a><span id="l33.267" class="difflineminus">-        rv = CallGetService(kRDFContainerUtilsCID, &amp;gRDFContainerUtils);</span>
<a href="#l33.268"></a><span id="l33.268" class="difflineminus">-    }</span>
<a href="#l33.269"></a><span id="l33.269" class="difflineminus">-}</span>
<a href="#l33.270"></a><span id="l33.270" class="difflineminus">-</span>
<a href="#l33.271"></a><span id="l33.271" class="difflineminus">-</span>
<a href="#l33.272"></a><span id="l33.272" class="difflineminus">-RDFContentSinkImpl::~RDFContentSinkImpl()</span>
<a href="#l33.273"></a><span id="l33.273" class="difflineminus">-{</span>
<a href="#l33.274"></a><span id="l33.274" class="difflineminus">-#ifdef DEBUG_REFS</span>
<a href="#l33.275"></a><span id="l33.275" class="difflineminus">-    --gInstanceCount;</span>
<a href="#l33.276"></a><span id="l33.276" class="difflineminus">-    fprintf(stdout, &quot;%d - RDF: RDFContentSinkImpl\n&quot;, gInstanceCount);</span>
<a href="#l33.277"></a><span id="l33.277" class="difflineminus">-#endif</span>
<a href="#l33.278"></a><span id="l33.278" class="difflineminus">-</span>
<a href="#l33.279"></a><span id="l33.279" class="difflineminus">-    if (mContextStack) {</span>
<a href="#l33.280"></a><span id="l33.280" class="difflineminus">-        MOZ_LOG(gLog, LogLevel::Warning,</span>
<a href="#l33.281"></a><span id="l33.281" class="difflineminus">-               (&quot;rdfxml: warning! unclosed tag&quot;));</span>
<a href="#l33.282"></a><span id="l33.282" class="difflineminus">-</span>
<a href="#l33.283"></a><span id="l33.283" class="difflineminus">-        // XXX we should never need to do this, but, we'll write the</span>
<a href="#l33.284"></a><span id="l33.284" class="difflineminus">-        // code all the same. If someone left the content stack dirty,</span>
<a href="#l33.285"></a><span id="l33.285" class="difflineminus">-        // pop all the elements off the stack and release them.</span>
<a href="#l33.286"></a><span id="l33.286" class="difflineminus">-        int32_t i = mContextStack-&gt;Length();</span>
<a href="#l33.287"></a><span id="l33.287" class="difflineminus">-        while (0 &lt; i--) {</span>
<a href="#l33.288"></a><span id="l33.288" class="difflineminus">-            nsIRDFResource* resource = nullptr;</span>
<a href="#l33.289"></a><span id="l33.289" class="difflineminus">-            RDFContentSinkState state;</span>
<a href="#l33.290"></a><span id="l33.290" class="difflineminus">-            RDFContentSinkParseMode parseMode;</span>
<a href="#l33.291"></a><span id="l33.291" class="difflineminus">-            PopContext(resource, state, parseMode);</span>
<a href="#l33.292"></a><span id="l33.292" class="difflineminus">-</span>
<a href="#l33.293"></a><span id="l33.293" class="difflineminus">-            // print some fairly useless debugging info</span>
<a href="#l33.294"></a><span id="l33.294" class="difflineminus">-            // XXX we should save line numbers on the context stack: this'd</span>
<a href="#l33.295"></a><span id="l33.295" class="difflineminus">-            // be about 1000x more helpful.</span>
<a href="#l33.296"></a><span id="l33.296" class="difflineminus">-            if (resource &amp;&amp; MOZ_LOG_TEST(gLog, LogLevel::Debug)) {</span>
<a href="#l33.297"></a><span id="l33.297" class="difflineminus">-                nsCString uri;</span>
<a href="#l33.298"></a><span id="l33.298" class="difflineminus">-                resource-&gt;GetValue(getter_Copies(uri));</span>
<a href="#l33.299"></a><span id="l33.299" class="difflineminus">-                MOZ_LOG(gLog, LogLevel::Debug,</span>
<a href="#l33.300"></a><span id="l33.300" class="difflineminus">-                       (&quot;rdfxml:   uri=%s&quot;, uri.get()));</span>
<a href="#l33.301"></a><span id="l33.301" class="difflineminus">-            }</span>
<a href="#l33.302"></a><span id="l33.302" class="difflineminus">-</span>
<a href="#l33.303"></a><span id="l33.303" class="difflineminus">-            NS_IF_RELEASE(resource);</span>
<a href="#l33.304"></a><span id="l33.304" class="difflineminus">-        }</span>
<a href="#l33.305"></a><span id="l33.305" class="difflineminus">-</span>
<a href="#l33.306"></a><span id="l33.306" class="difflineminus">-        delete mContextStack;</span>
<a href="#l33.307"></a><span id="l33.307" class="difflineminus">-    }</span>
<a href="#l33.308"></a><span id="l33.308" class="difflineminus">-    free(mText);</span>
<a href="#l33.309"></a><span id="l33.309" class="difflineminus">-</span>
<a href="#l33.310"></a><span id="l33.310" class="difflineminus">-</span>
<a href="#l33.311"></a><span id="l33.311" class="difflineminus">-    if (--gRefCnt == 0) {</span>
<a href="#l33.312"></a><span id="l33.312" class="difflineminus">-        NS_IF_RELEASE(gRDFService);</span>
<a href="#l33.313"></a><span id="l33.313" class="difflineminus">-        NS_IF_RELEASE(gRDFContainerUtils);</span>
<a href="#l33.314"></a><span id="l33.314" class="difflineminus">-        NS_IF_RELEASE(kRDF_type);</span>
<a href="#l33.315"></a><span id="l33.315" class="difflineminus">-        NS_IF_RELEASE(kRDF_instanceOf);</span>
<a href="#l33.316"></a><span id="l33.316" class="difflineminus">-        NS_IF_RELEASE(kRDF_Alt);</span>
<a href="#l33.317"></a><span id="l33.317" class="difflineminus">-        NS_IF_RELEASE(kRDF_Bag);</span>
<a href="#l33.318"></a><span id="l33.318" class="difflineminus">-        NS_IF_RELEASE(kRDF_Seq);</span>
<a href="#l33.319"></a><span id="l33.319" class="difflineminus">-        NS_IF_RELEASE(kRDF_nextVal);</span>
<a href="#l33.320"></a><span id="l33.320" class="difflineminus">-    }</span>
<a href="#l33.321"></a><span id="l33.321" class="difflineminus">-}</span>
<a href="#l33.322"></a><span id="l33.322" class="difflineminus">-</span>
<a href="#l33.323"></a><span id="l33.323" class="difflineminus">-////////////////////////////////////////////////////////////////////////</span>
<a href="#l33.324"></a><span id="l33.324" class="difflineminus">-// nsISupports interface</span>
<a href="#l33.325"></a><span id="l33.325" class="difflineminus">-</span>
<a href="#l33.326"></a><span id="l33.326" class="difflineminus">-NS_IMPL_ADDREF(RDFContentSinkImpl)</span>
<a href="#l33.327"></a><span id="l33.327" class="difflineminus">-NS_IMPL_RELEASE(RDFContentSinkImpl)</span>
<a href="#l33.328"></a><span id="l33.328" class="difflineminus">-</span>
<a href="#l33.329"></a><span id="l33.329" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l33.330"></a><span id="l33.330" class="difflineminus">-RDFContentSinkImpl::QueryInterface(REFNSIID iid, void** result)</span>
<a href="#l33.331"></a><span id="l33.331" class="difflineminus">-{</span>
<a href="#l33.332"></a><span id="l33.332" class="difflineminus">-    NS_ASSERTION(result, &quot;null ptr&quot;);</span>
<a href="#l33.333"></a><span id="l33.333" class="difflineminus">-    if (! result)</span>
<a href="#l33.334"></a><span id="l33.334" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l33.335"></a><span id="l33.335" class="difflineminus">-</span>
<a href="#l33.336"></a><span id="l33.336" class="difflineminus">-    NS_DEFINE_IID(kIContentSinkIID,    NS_ICONTENT_SINK_IID);</span>
<a href="#l33.337"></a><span id="l33.337" class="difflineminus">-    NS_DEFINE_IID(kIExpatSinkIID,      NS_IEXPATSINK_IID);</span>
<a href="#l33.338"></a><span id="l33.338" class="difflineminus">-    NS_DEFINE_IID(kISupportsIID,       NS_ISUPPORTS_IID);</span>
<a href="#l33.339"></a><span id="l33.339" class="difflineminus">-    NS_DEFINE_IID(kIXMLContentSinkIID, NS_IXMLCONTENT_SINK_IID);</span>
<a href="#l33.340"></a><span id="l33.340" class="difflineminus">-    NS_DEFINE_IID(kIRDFContentSinkIID, NS_IRDFCONTENTSINK_IID);</span>
<a href="#l33.341"></a><span id="l33.341" class="difflineminus">-</span>
<a href="#l33.342"></a><span id="l33.342" class="difflineminus">-    *result = nullptr;</span>
<a href="#l33.343"></a><span id="l33.343" class="difflineminus">-    if (iid.Equals(kIRDFContentSinkIID) ||</span>
<a href="#l33.344"></a><span id="l33.344" class="difflineminus">-        iid.Equals(kIXMLContentSinkIID) ||</span>
<a href="#l33.345"></a><span id="l33.345" class="difflineminus">-        iid.Equals(kIContentSinkIID) ||</span>
<a href="#l33.346"></a><span id="l33.346" class="difflineminus">-        iid.Equals(kISupportsIID)) {</span>
<a href="#l33.347"></a><span id="l33.347" class="difflineminus">-        *result = static_cast&lt;nsIXMLContentSink*&gt;(this);</span>
<a href="#l33.348"></a><span id="l33.348" class="difflineminus">-        AddRef();</span>
<a href="#l33.349"></a><span id="l33.349" class="difflineminus">-        return NS_OK;</span>
<a href="#l33.350"></a><span id="l33.350" class="difflineminus">-    }</span>
<a href="#l33.351"></a><span id="l33.351" class="difflineminus">-    else if (iid.Equals(kIExpatSinkIID)) {</span>
<a href="#l33.352"></a><span id="l33.352" class="difflineminus">-      *result = static_cast&lt;nsIExpatSink*&gt;(this);</span>
<a href="#l33.353"></a><span id="l33.353" class="difflineminus">-       AddRef();</span>
<a href="#l33.354"></a><span id="l33.354" class="difflineminus">-       return NS_OK;</span>
<a href="#l33.355"></a><span id="l33.355" class="difflineminus">-    }</span>
<a href="#l33.356"></a><span id="l33.356" class="difflineminus">-    return NS_NOINTERFACE;</span>
<a href="#l33.357"></a><span id="l33.357" class="difflineminus">-}</span>
<a href="#l33.358"></a><span id="l33.358" class="difflineminus">-</span>
<a href="#l33.359"></a><span id="l33.359" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l33.360"></a><span id="l33.360" class="difflineminus">-RDFContentSinkImpl::HandleStartElement(const char16_t *aName,</span>
<a href="#l33.361"></a><span id="l33.361" class="difflineminus">-                                       const char16_t **aAtts,</span>
<a href="#l33.362"></a><span id="l33.362" class="difflineminus">-                                       uint32_t aAttsCount,</span>
<a href="#l33.363"></a><span id="l33.363" class="difflineminus">-                                       uint32_t aLineNumber,</span>
<a href="#l33.364"></a><span id="l33.364" class="difflineminus">-                                       uint32_t aColNumber)</span>
<a href="#l33.365"></a><span id="l33.365" class="difflineminus">-{</span>
<a href="#l33.366"></a><span id="l33.366" class="difflineminus">-  FlushText();</span>
<a href="#l33.367"></a><span id="l33.367" class="difflineminus">-</span>
<a href="#l33.368"></a><span id="l33.368" class="difflineminus">-  nsresult rv = NS_ERROR_UNEXPECTED; // XXX</span>
<a href="#l33.369"></a><span id="l33.369" class="difflineminus">-</span>
<a href="#l33.370"></a><span id="l33.370" class="difflineminus">-  RegisterNamespaces(aAtts);</span>
<a href="#l33.371"></a><span id="l33.371" class="difflineminus">-</span>
<a href="#l33.372"></a><span id="l33.372" class="difflineminus">-  switch (mState) {</span>
<a href="#l33.373"></a><span id="l33.373" class="difflineminus">-  case eRDFContentSinkState_InProlog:</span>
<a href="#l33.374"></a><span id="l33.374" class="difflineminus">-      rv = OpenRDF(aName);</span>
<a href="#l33.375"></a><span id="l33.375" class="difflineminus">-      break;</span>
<a href="#l33.376"></a><span id="l33.376" class="difflineminus">-</span>
<a href="#l33.377"></a><span id="l33.377" class="difflineminus">-  case eRDFContentSinkState_InDocumentElement:</span>
<a href="#l33.378"></a><span id="l33.378" class="difflineminus">-      rv = OpenObject(aName,aAtts);</span>
<a href="#l33.379"></a><span id="l33.379" class="difflineminus">-      break;</span>
<a href="#l33.380"></a><span id="l33.380" class="difflineminus">-</span>
<a href="#l33.381"></a><span id="l33.381" class="difflineminus">-  case eRDFContentSinkState_InDescriptionElement:</span>
<a href="#l33.382"></a><span id="l33.382" class="difflineminus">-      rv = OpenProperty(aName,aAtts);</span>
<a href="#l33.383"></a><span id="l33.383" class="difflineminus">-      break;</span>
<a href="#l33.384"></a><span id="l33.384" class="difflineminus">-</span>
<a href="#l33.385"></a><span id="l33.385" class="difflineminus">-  case eRDFContentSinkState_InContainerElement:</span>
<a href="#l33.386"></a><span id="l33.386" class="difflineminus">-      rv = OpenMember(aName,aAtts);</span>
<a href="#l33.387"></a><span id="l33.387" class="difflineminus">-      break;</span>
<a href="#l33.388"></a><span id="l33.388" class="difflineminus">-</span>
<a href="#l33.389"></a><span id="l33.389" class="difflineminus">-  case eRDFContentSinkState_InPropertyElement:</span>
<a href="#l33.390"></a><span id="l33.390" class="difflineminus">-  case eRDFContentSinkState_InMemberElement:</span>
<a href="#l33.391"></a><span id="l33.391" class="difflineminus">-      rv = OpenValue(aName,aAtts);</span>
<a href="#l33.392"></a><span id="l33.392" class="difflineminus">-      break;</span>
<a href="#l33.393"></a><span id="l33.393" class="difflineminus">-</span>
<a href="#l33.394"></a><span id="l33.394" class="difflineminus">-  case eRDFContentSinkState_InEpilog:</span>
<a href="#l33.395"></a><span id="l33.395" class="difflineminus">-      MOZ_LOG(gLog, LogLevel::Warning,</span>
<a href="#l33.396"></a><span id="l33.396" class="difflineminus">-             (&quot;rdfxml: unexpected content in epilog at line %d, column %d&quot;,</span>
<a href="#l33.397"></a><span id="l33.397" class="difflineminus">-              aLineNumber, aColNumber));</span>
<a href="#l33.398"></a><span id="l33.398" class="difflineminus">-      break;</span>
<a href="#l33.399"></a><span id="l33.399" class="difflineminus">-  }</span>
<a href="#l33.400"></a><span id="l33.400" class="difflineminus">-</span>
<a href="#l33.401"></a><span id="l33.401" class="difflineminus">-  return rv;</span>
<a href="#l33.402"></a><span id="l33.402" class="difflineminus">-}</span>
<a href="#l33.403"></a><span id="l33.403" class="difflineminus">-</span>
<a href="#l33.404"></a><span id="l33.404" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l33.405"></a><span id="l33.405" class="difflineminus">-RDFContentSinkImpl::HandleEndElement(const char16_t *aName)</span>
<a href="#l33.406"></a><span id="l33.406" class="difflineminus">-{</span>
<a href="#l33.407"></a><span id="l33.407" class="difflineminus">-  FlushText();</span>
<a href="#l33.408"></a><span id="l33.408" class="difflineminus">-</span>
<a href="#l33.409"></a><span id="l33.409" class="difflineminus">-  nsIRDFResource* resource;</span>
<a href="#l33.410"></a><span id="l33.410" class="difflineminus">-  if (NS_FAILED(PopContext(resource, mState, mParseMode))) {</span>
<a href="#l33.411"></a><span id="l33.411" class="difflineminus">-      // XXX parser didn't catch unmatched tags?</span>
<a href="#l33.412"></a><span id="l33.412" class="difflineminus">-      if (MOZ_LOG_TEST(gLog, LogLevel::Warning)) {</span>
<a href="#l33.413"></a><span id="l33.413" class="difflineminus">-          nsAutoString tagStr(aName);</span>
<a href="#l33.414"></a><span id="l33.414" class="difflineminus">-          char* tagCStr = ToNewCString(tagStr);</span>
<a href="#l33.415"></a><span id="l33.415" class="difflineminus">-</span>
<a href="#l33.416"></a><span id="l33.416" class="difflineminus">-          MOZ_LOG(gLog, LogLevel::Warning,</span>
<a href="#l33.417"></a><span id="l33.417" class="difflineminus">-                 (&quot;rdfxml: extra close tag '%s' at line %d&quot;,</span>
<a href="#l33.418"></a><span id="l33.418" class="difflineminus">-                  tagCStr, 0/*XXX fix me */));</span>
<a href="#l33.419"></a><span id="l33.419" class="difflineminus">-</span>
<a href="#l33.420"></a><span id="l33.420" class="difflineminus">-          free(tagCStr);</span>
<a href="#l33.421"></a><span id="l33.421" class="difflineminus">-      }</span>
<a href="#l33.422"></a><span id="l33.422" class="difflineminus">-</span>
<a href="#l33.423"></a><span id="l33.423" class="difflineminus">-      return NS_ERROR_UNEXPECTED; // XXX</span>
<a href="#l33.424"></a><span id="l33.424" class="difflineminus">-  }</span>
<a href="#l33.425"></a><span id="l33.425" class="difflineminus">-</span>
<a href="#l33.426"></a><span id="l33.426" class="difflineminus">-  // If we've just popped a member or property element, _now_ is the</span>
<a href="#l33.427"></a><span id="l33.427" class="difflineminus">-  // time to add that element to the graph.</span>
<a href="#l33.428"></a><span id="l33.428" class="difflineminus">-  switch (mState) {</span>
<a href="#l33.429"></a><span id="l33.429" class="difflineminus">-    case eRDFContentSinkState_InMemberElement:</span>
<a href="#l33.430"></a><span id="l33.430" class="difflineminus">-      {</span>
<a href="#l33.431"></a><span id="l33.431" class="difflineminus">-        nsCOMPtr&lt;nsIRDFContainer&gt; container;</span>
<a href="#l33.432"></a><span id="l33.432" class="difflineminus">-        NS_NewRDFContainer(getter_AddRefs(container));</span>
<a href="#l33.433"></a><span id="l33.433" class="difflineminus">-        container-&gt;Init(mDataSource, GetContextElement(1));</span>
<a href="#l33.434"></a><span id="l33.434" class="difflineminus">-        container-&gt;AppendElement(resource);</span>
<a href="#l33.435"></a><span id="l33.435" class="difflineminus">-      }</span>
<a href="#l33.436"></a><span id="l33.436" class="difflineminus">-      break;</span>
<a href="#l33.437"></a><span id="l33.437" class="difflineminus">-</span>
<a href="#l33.438"></a><span id="l33.438" class="difflineminus">-    case eRDFContentSinkState_InPropertyElement:</span>
<a href="#l33.439"></a><span id="l33.439" class="difflineminus">-      {</span>
<a href="#l33.440"></a><span id="l33.440" class="difflineminus">-        mDataSource-&gt;Assert(GetContextElement(1), GetContextElement(0), resource, true);</span>
<a href="#l33.441"></a><span id="l33.441" class="difflineminus">-      } break;</span>
<a href="#l33.442"></a><span id="l33.442" class="difflineminus">-    default:</span>
<a href="#l33.443"></a><span id="l33.443" class="difflineminus">-      break;</span>
<a href="#l33.444"></a><span id="l33.444" class="difflineminus">-  }</span>
<a href="#l33.445"></a><span id="l33.445" class="difflineminus">-</span>
<a href="#l33.446"></a><span id="l33.446" class="difflineminus">-  if (mContextStack-&gt;IsEmpty())</span>
<a href="#l33.447"></a><span id="l33.447" class="difflineminus">-      mState = eRDFContentSinkState_InEpilog;</span>
<a href="#l33.448"></a><span id="l33.448" class="difflineminus">-</span>
<a href="#l33.449"></a><span id="l33.449" class="difflineminus">-  NS_IF_RELEASE(resource);</span>
<a href="#l33.450"></a><span id="l33.450" class="difflineminus">-  return NS_OK;</span>
<a href="#l33.451"></a><span id="l33.451" class="difflineminus">-}</span>
<a href="#l33.452"></a><span id="l33.452" class="difflineminus">-</span>
<a href="#l33.453"></a><span id="l33.453" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l33.454"></a><span id="l33.454" class="difflineminus">-RDFContentSinkImpl::HandleComment(const char16_t *aName)</span>
<a href="#l33.455"></a><span id="l33.455" class="difflineminus">-{</span>
<a href="#l33.456"></a><span id="l33.456" class="difflineminus">-    return NS_OK;</span>
<a href="#l33.457"></a><span id="l33.457" class="difflineminus">-}</span>
<a href="#l33.458"></a><span id="l33.458" class="difflineminus">-</span>
<a href="#l33.459"></a><span id="l33.459" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l33.460"></a><span id="l33.460" class="difflineminus">-RDFContentSinkImpl::HandleCDataSection(const char16_t *aData,</span>
<a href="#l33.461"></a><span id="l33.461" class="difflineminus">-                                       uint32_t aLength)</span>
<a href="#l33.462"></a><span id="l33.462" class="difflineminus">-{</span>
<a href="#l33.463"></a><span id="l33.463" class="difflineminus">-  return aData ?  AddText(aData, aLength) : NS_OK;</span>
<a href="#l33.464"></a><span id="l33.464" class="difflineminus">-}</span>
<a href="#l33.465"></a><span id="l33.465" class="difflineminus">-</span>
<a href="#l33.466"></a><span id="l33.466" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l33.467"></a><span id="l33.467" class="difflineminus">-RDFContentSinkImpl::HandleDoctypeDecl(const nsAString &amp; aSubset,</span>
<a href="#l33.468"></a><span id="l33.468" class="difflineminus">-                                      const nsAString &amp; aName,</span>
<a href="#l33.469"></a><span id="l33.469" class="difflineminus">-                                      const nsAString &amp; aSystemId,</span>
<a href="#l33.470"></a><span id="l33.470" class="difflineminus">-                                      const nsAString &amp; aPublicId,</span>
<a href="#l33.471"></a><span id="l33.471" class="difflineminus">-                                      nsISupports* aCatalogData)</span>
<a href="#l33.472"></a><span id="l33.472" class="difflineminus">-{</span>
<a href="#l33.473"></a><span id="l33.473" class="difflineminus">-    return NS_OK;</span>
<a href="#l33.474"></a><span id="l33.474" class="difflineminus">-}</span>
<a href="#l33.475"></a><span id="l33.475" class="difflineminus">-</span>
<a href="#l33.476"></a><span id="l33.476" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l33.477"></a><span id="l33.477" class="difflineminus">-RDFContentSinkImpl::HandleCharacterData(const char16_t *aData,</span>
<a href="#l33.478"></a><span id="l33.478" class="difflineminus">-                                        uint32_t aLength)</span>
<a href="#l33.479"></a><span id="l33.479" class="difflineminus">-{</span>
<a href="#l33.480"></a><span id="l33.480" class="difflineminus">-  return aData ?  AddText(aData, aLength) : NS_OK;</span>
<a href="#l33.481"></a><span id="l33.481" class="difflineminus">-}</span>
<a href="#l33.482"></a><span id="l33.482" class="difflineminus">-</span>
<a href="#l33.483"></a><span id="l33.483" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l33.484"></a><span id="l33.484" class="difflineminus">-RDFContentSinkImpl::HandleProcessingInstruction(const char16_t *aTarget,</span>
<a href="#l33.485"></a><span id="l33.485" class="difflineminus">-                                                const char16_t *aData)</span>
<a href="#l33.486"></a><span id="l33.486" class="difflineminus">-{</span>
<a href="#l33.487"></a><span id="l33.487" class="difflineminus">-    return NS_OK;</span>
<a href="#l33.488"></a><span id="l33.488" class="difflineminus">-}</span>
<a href="#l33.489"></a><span id="l33.489" class="difflineminus">-</span>
<a href="#l33.490"></a><span id="l33.490" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l33.491"></a><span id="l33.491" class="difflineminus">-RDFContentSinkImpl::HandleXMLDeclaration(const char16_t *aVersion,</span>
<a href="#l33.492"></a><span id="l33.492" class="difflineminus">-                                         const char16_t *aEncoding,</span>
<a href="#l33.493"></a><span id="l33.493" class="difflineminus">-                                         int32_t aStandalone)</span>
<a href="#l33.494"></a><span id="l33.494" class="difflineminus">-{</span>
<a href="#l33.495"></a><span id="l33.495" class="difflineminus">-    return NS_OK;</span>
<a href="#l33.496"></a><span id="l33.496" class="difflineminus">-}</span>
<a href="#l33.497"></a><span id="l33.497" class="difflineminus">-</span>
<a href="#l33.498"></a><span id="l33.498" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l33.499"></a><span id="l33.499" class="difflineminus">-RDFContentSinkImpl::ReportError(const char16_t* aErrorText,</span>
<a href="#l33.500"></a><span id="l33.500" class="difflineminus">-                                const char16_t* aSourceText,</span>
<a href="#l33.501"></a><span id="l33.501" class="difflineminus">-                                nsIScriptError *aError,</span>
<a href="#l33.502"></a><span id="l33.502" class="difflineminus">-                                bool *_retval)</span>
<a href="#l33.503"></a><span id="l33.503" class="difflineminus">-{</span>
<a href="#l33.504"></a><span id="l33.504" class="difflineminus">-  NS_ASSERTION(aError &amp;&amp; aSourceText &amp;&amp; aErrorText, &quot;Check arguments!!!&quot;);</span>
<a href="#l33.505"></a><span id="l33.505" class="difflineminus">-</span>
<a href="#l33.506"></a><span id="l33.506" class="difflineminus">-  // The expat driver should report the error.</span>
<a href="#l33.507"></a><span id="l33.507" class="difflineminus">-  *_retval = true;</span>
<a href="#l33.508"></a><span id="l33.508" class="difflineminus">-  return NS_OK;</span>
<a href="#l33.509"></a><span id="l33.509" class="difflineminus">-}</span>
<a href="#l33.510"></a><span id="l33.510" class="difflineminus">-</span>
<a href="#l33.511"></a><span id="l33.511" class="difflineminus">-////////////////////////////////////////////////////////////////////////</span>
<a href="#l33.512"></a><span id="l33.512" class="difflineminus">-// nsIContentSink interface</span>
<a href="#l33.513"></a><span id="l33.513" class="difflineminus">-</span>
<a href="#l33.514"></a><span id="l33.514" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l33.515"></a><span id="l33.515" class="difflineminus">-RDFContentSinkImpl::WillParse(void)</span>
<a href="#l33.516"></a><span id="l33.516" class="difflineminus">-{</span>
<a href="#l33.517"></a><span id="l33.517" class="difflineminus">-    return NS_OK;</span>
<a href="#l33.518"></a><span id="l33.518" class="difflineminus">-}</span>
<a href="#l33.519"></a><span id="l33.519" class="difflineminus">-</span>
<a href="#l33.520"></a><span id="l33.520" class="difflineminus">-</span>
<a href="#l33.521"></a><span id="l33.521" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l33.522"></a><span id="l33.522" class="difflineminus">-RDFContentSinkImpl::WillBuildModel(nsDTDMode)</span>
<a href="#l33.523"></a><span id="l33.523" class="difflineminus">-{</span>
<a href="#l33.524"></a><span id="l33.524" class="difflineminus">-    if (mDataSource) {</span>
<a href="#l33.525"></a><span id="l33.525" class="difflineminus">-        nsCOMPtr&lt;nsIRDFXMLSink&gt; sink = do_QueryInterface(mDataSource);</span>
<a href="#l33.526"></a><span id="l33.526" class="difflineminus">-        if (sink)</span>
<a href="#l33.527"></a><span id="l33.527" class="difflineminus">-            return sink-&gt;BeginLoad();</span>
<a href="#l33.528"></a><span id="l33.528" class="difflineminus">-    }</span>
<a href="#l33.529"></a><span id="l33.529" class="difflineminus">-    return NS_OK;</span>
<a href="#l33.530"></a><span id="l33.530" class="difflineminus">-}</span>
<a href="#l33.531"></a><span id="l33.531" class="difflineminus">-</span>
<a href="#l33.532"></a><span id="l33.532" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l33.533"></a><span id="l33.533" class="difflineminus">-RDFContentSinkImpl::DidBuildModel(bool aTerminated)</span>
<a href="#l33.534"></a><span id="l33.534" class="difflineminus">-{</span>
<a href="#l33.535"></a><span id="l33.535" class="difflineminus">-    if (mDataSource) {</span>
<a href="#l33.536"></a><span id="l33.536" class="difflineminus">-        nsCOMPtr&lt;nsIRDFXMLSink&gt; sink = do_QueryInterface(mDataSource);</span>
<a href="#l33.537"></a><span id="l33.537" class="difflineminus">-        if (sink)</span>
<a href="#l33.538"></a><span id="l33.538" class="difflineminus">-            return sink-&gt;EndLoad();</span>
<a href="#l33.539"></a><span id="l33.539" class="difflineminus">-    }</span>
<a href="#l33.540"></a><span id="l33.540" class="difflineminus">-    return NS_OK;</span>
<a href="#l33.541"></a><span id="l33.541" class="difflineminus">-}</span>
<a href="#l33.542"></a><span id="l33.542" class="difflineminus">-</span>
<a href="#l33.543"></a><span id="l33.543" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l33.544"></a><span id="l33.544" class="difflineminus">-RDFContentSinkImpl::WillInterrupt(void)</span>
<a href="#l33.545"></a><span id="l33.545" class="difflineminus">-{</span>
<a href="#l33.546"></a><span id="l33.546" class="difflineminus">-    if (mDataSource) {</span>
<a href="#l33.547"></a><span id="l33.547" class="difflineminus">-        nsCOMPtr&lt;nsIRDFXMLSink&gt; sink = do_QueryInterface(mDataSource);</span>
<a href="#l33.548"></a><span id="l33.548" class="difflineminus">-        if (sink)</span>
<a href="#l33.549"></a><span id="l33.549" class="difflineminus">-            return sink-&gt;Interrupt();</span>
<a href="#l33.550"></a><span id="l33.550" class="difflineminus">-    }</span>
<a href="#l33.551"></a><span id="l33.551" class="difflineminus">-    return NS_OK;</span>
<a href="#l33.552"></a><span id="l33.552" class="difflineminus">-}</span>
<a href="#l33.553"></a><span id="l33.553" class="difflineminus">-</span>
<a href="#l33.554"></a><span id="l33.554" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l33.555"></a><span id="l33.555" class="difflineminus">-RDFContentSinkImpl::WillResume(void)</span>
<a href="#l33.556"></a><span id="l33.556" class="difflineminus">-{</span>
<a href="#l33.557"></a><span id="l33.557" class="difflineminus">-    if (mDataSource) {</span>
<a href="#l33.558"></a><span id="l33.558" class="difflineminus">-        nsCOMPtr&lt;nsIRDFXMLSink&gt; sink = do_QueryInterface(mDataSource);</span>
<a href="#l33.559"></a><span id="l33.559" class="difflineminus">-        if (sink)</span>
<a href="#l33.560"></a><span id="l33.560" class="difflineminus">-            return sink-&gt;Resume();</span>
<a href="#l33.561"></a><span id="l33.561" class="difflineminus">-    }</span>
<a href="#l33.562"></a><span id="l33.562" class="difflineminus">-    return NS_OK;</span>
<a href="#l33.563"></a><span id="l33.563" class="difflineminus">-}</span>
<a href="#l33.564"></a><span id="l33.564" class="difflineminus">-</span>
<a href="#l33.565"></a><span id="l33.565" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l33.566"></a><span id="l33.566" class="difflineminus">-RDFContentSinkImpl::SetParser(nsParserBase* aParser)</span>
<a href="#l33.567"></a><span id="l33.567" class="difflineminus">-{</span>
<a href="#l33.568"></a><span id="l33.568" class="difflineminus">-    return NS_OK;</span>
<a href="#l33.569"></a><span id="l33.569" class="difflineminus">-}</span>
<a href="#l33.570"></a><span id="l33.570" class="difflineminus">-</span>
<a href="#l33.571"></a><span id="l33.571" class="difflineminus">-////////////////////////////////////////////////////////////////////////</span>
<a href="#l33.572"></a><span id="l33.572" class="difflineminus">-// nsIRDFContentSink interface</span>
<a href="#l33.573"></a><span id="l33.573" class="difflineminus">-</span>
<a href="#l33.574"></a><span id="l33.574" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l33.575"></a><span id="l33.575" class="difflineminus">-RDFContentSinkImpl::Init(nsIURI* aURL)</span>
<a href="#l33.576"></a><span id="l33.576" class="difflineminus">-{</span>
<a href="#l33.577"></a><span id="l33.577" class="difflineminus">-    NS_ASSERTION(aURL != nullptr, &quot;null ptr&quot;);</span>
<a href="#l33.578"></a><span id="l33.578" class="difflineminus">-    if (! aURL)</span>
<a href="#l33.579"></a><span id="l33.579" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l33.580"></a><span id="l33.580" class="difflineminus">-</span>
<a href="#l33.581"></a><span id="l33.581" class="difflineminus">-    mDocumentURL = aURL;</span>
<a href="#l33.582"></a><span id="l33.582" class="difflineminus">-    mState = eRDFContentSinkState_InProlog;</span>
<a href="#l33.583"></a><span id="l33.583" class="difflineminus">-    return NS_OK;</span>
<a href="#l33.584"></a><span id="l33.584" class="difflineminus">-}</span>
<a href="#l33.585"></a><span id="l33.585" class="difflineminus">-</span>
<a href="#l33.586"></a><span id="l33.586" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l33.587"></a><span id="l33.587" class="difflineminus">-RDFContentSinkImpl::SetDataSource(nsIRDFDataSource* aDataSource)</span>
<a href="#l33.588"></a><span id="l33.588" class="difflineminus">-{</span>
<a href="#l33.589"></a><span id="l33.589" class="difflineminus">-    NS_ASSERTION(aDataSource != nullptr, &quot;SetDataSource null ptr&quot;);</span>
<a href="#l33.590"></a><span id="l33.590" class="difflineminus">-    mDataSource = aDataSource;</span>
<a href="#l33.591"></a><span id="l33.591" class="difflineminus">-    NS_ASSERTION(mDataSource != nullptr,&quot;Couldn't QI RDF DataSource&quot;);</span>
<a href="#l33.592"></a><span id="l33.592" class="difflineminus">-    return NS_OK;</span>
<a href="#l33.593"></a><span id="l33.593" class="difflineminus">-}</span>
<a href="#l33.594"></a><span id="l33.594" class="difflineminus">-</span>
<a href="#l33.595"></a><span id="l33.595" class="difflineminus">-</span>
<a href="#l33.596"></a><span id="l33.596" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l33.597"></a><span id="l33.597" class="difflineminus">-RDFContentSinkImpl::GetDataSource(nsIRDFDataSource*&amp; aDataSource)</span>
<a href="#l33.598"></a><span id="l33.598" class="difflineminus">-{</span>
<a href="#l33.599"></a><span id="l33.599" class="difflineminus">-    aDataSource = mDataSource;</span>
<a href="#l33.600"></a><span id="l33.600" class="difflineminus">-    NS_IF_ADDREF(aDataSource);</span>
<a href="#l33.601"></a><span id="l33.601" class="difflineminus">-    return NS_OK;</span>
<a href="#l33.602"></a><span id="l33.602" class="difflineminus">-}</span>
<a href="#l33.603"></a><span id="l33.603" class="difflineminus">-</span>
<a href="#l33.604"></a><span id="l33.604" class="difflineminus">-////////////////////////////////////////////////////////////////////////</span>
<a href="#l33.605"></a><span id="l33.605" class="difflineminus">-// Text buffering</span>
<a href="#l33.606"></a><span id="l33.606" class="difflineminus">-</span>
<a href="#l33.607"></a><span id="l33.607" class="difflineminus">-static bool</span>
<a href="#l33.608"></a><span id="l33.608" class="difflineminus">-rdf_IsDataInBuffer(char16_t* buffer, int32_t length)</span>
<a href="#l33.609"></a><span id="l33.609" class="difflineminus">-{</span>
<a href="#l33.610"></a><span id="l33.610" class="difflineminus">-    for (int32_t i = 0; i &lt; length; ++i) {</span>
<a href="#l33.611"></a><span id="l33.611" class="difflineminus">-        if (buffer[i] == ' ' ||</span>
<a href="#l33.612"></a><span id="l33.612" class="difflineminus">-            buffer[i] == '\t' ||</span>
<a href="#l33.613"></a><span id="l33.613" class="difflineminus">-            buffer[i] == '\n' ||</span>
<a href="#l33.614"></a><span id="l33.614" class="difflineminus">-            buffer[i] == '\r')</span>
<a href="#l33.615"></a><span id="l33.615" class="difflineminus">-            continue;</span>
<a href="#l33.616"></a><span id="l33.616" class="difflineminus">-</span>
<a href="#l33.617"></a><span id="l33.617" class="difflineminus">-        return true;</span>
<a href="#l33.618"></a><span id="l33.618" class="difflineminus">-    }</span>
<a href="#l33.619"></a><span id="l33.619" class="difflineminus">-    return false;</span>
<a href="#l33.620"></a><span id="l33.620" class="difflineminus">-}</span>
<a href="#l33.621"></a><span id="l33.621" class="difflineminus">-</span>
<a href="#l33.622"></a><span id="l33.622" class="difflineminus">-void</span>
<a href="#l33.623"></a><span id="l33.623" class="difflineminus">-RDFContentSinkImpl::ParseText(nsIRDFNode **aResult)</span>
<a href="#l33.624"></a><span id="l33.624" class="difflineminus">-{</span>
<a href="#l33.625"></a><span id="l33.625" class="difflineminus">-    // XXXwaterson wasteful, but we'd need to make a copy anyway to be</span>
<a href="#l33.626"></a><span id="l33.626" class="difflineminus">-    // able to call nsIRDFService::Get[Resource|Literal|...]().</span>
<a href="#l33.627"></a><span id="l33.627" class="difflineminus">-    nsAutoString value;</span>
<a href="#l33.628"></a><span id="l33.628" class="difflineminus">-    value.Append(mText, mTextLength);</span>
<a href="#l33.629"></a><span id="l33.629" class="difflineminus">-    value.Trim(&quot; \t\n\r&quot;);</span>
<a href="#l33.630"></a><span id="l33.630" class="difflineminus">-</span>
<a href="#l33.631"></a><span id="l33.631" class="difflineminus">-    switch (mParseMode) {</span>
<a href="#l33.632"></a><span id="l33.632" class="difflineminus">-    case eRDFContentSinkParseMode_Literal:</span>
<a href="#l33.633"></a><span id="l33.633" class="difflineminus">-        {</span>
<a href="#l33.634"></a><span id="l33.634" class="difflineminus">-            nsIRDFLiteral *result;</span>
<a href="#l33.635"></a><span id="l33.635" class="difflineminus">-            gRDFService-&gt;GetLiteral(value.get(), &amp;result);</span>
<a href="#l33.636"></a><span id="l33.636" class="difflineminus">-            *aResult = result;</span>
<a href="#l33.637"></a><span id="l33.637" class="difflineminus">-        }</span>
<a href="#l33.638"></a><span id="l33.638" class="difflineminus">-        break;</span>
<a href="#l33.639"></a><span id="l33.639" class="difflineminus">-</span>
<a href="#l33.640"></a><span id="l33.640" class="difflineminus">-    case eRDFContentSinkParseMode_Resource:</span>
<a href="#l33.641"></a><span id="l33.641" class="difflineminus">-        {</span>
<a href="#l33.642"></a><span id="l33.642" class="difflineminus">-            nsIRDFResource *result;</span>
<a href="#l33.643"></a><span id="l33.643" class="difflineminus">-            gRDFService-&gt;GetUnicodeResource(value, &amp;result);</span>
<a href="#l33.644"></a><span id="l33.644" class="difflineminus">-            *aResult = result;</span>
<a href="#l33.645"></a><span id="l33.645" class="difflineminus">-        }</span>
<a href="#l33.646"></a><span id="l33.646" class="difflineminus">-        break;</span>
<a href="#l33.647"></a><span id="l33.647" class="difflineminus">-</span>
<a href="#l33.648"></a><span id="l33.648" class="difflineminus">-    case eRDFContentSinkParseMode_Int:</span>
<a href="#l33.649"></a><span id="l33.649" class="difflineminus">-        {</span>
<a href="#l33.650"></a><span id="l33.650" class="difflineminus">-            nsresult err;</span>
<a href="#l33.651"></a><span id="l33.651" class="difflineminus">-            int32_t i = value.ToInteger(&amp;err);</span>
<a href="#l33.652"></a><span id="l33.652" class="difflineminus">-            nsIRDFInt *result;</span>
<a href="#l33.653"></a><span id="l33.653" class="difflineminus">-            gRDFService-&gt;GetIntLiteral(i, &amp;result);</span>
<a href="#l33.654"></a><span id="l33.654" class="difflineminus">-            *aResult = result;</span>
<a href="#l33.655"></a><span id="l33.655" class="difflineminus">-        }</span>
<a href="#l33.656"></a><span id="l33.656" class="difflineminus">-        break;</span>
<a href="#l33.657"></a><span id="l33.657" class="difflineminus">-</span>
<a href="#l33.658"></a><span id="l33.658" class="difflineminus">-    case eRDFContentSinkParseMode_Date:</span>
<a href="#l33.659"></a><span id="l33.659" class="difflineminus">-        {</span>
<a href="#l33.660"></a><span id="l33.660" class="difflineminus">-            PRTime t = rdf_ParseDate(nsDependentCString(NS_LossyConvertUTF16toASCII(value).get(), value.Length()));</span>
<a href="#l33.661"></a><span id="l33.661" class="difflineminus">-            nsIRDFDate *result;</span>
<a href="#l33.662"></a><span id="l33.662" class="difflineminus">-            gRDFService-&gt;GetDateLiteral(t, &amp;result);</span>
<a href="#l33.663"></a><span id="l33.663" class="difflineminus">-            *aResult = result;</span>
<a href="#l33.664"></a><span id="l33.664" class="difflineminus">-        }</span>
<a href="#l33.665"></a><span id="l33.665" class="difflineminus">-        break;</span>
<a href="#l33.666"></a><span id="l33.666" class="difflineminus">-</span>
<a href="#l33.667"></a><span id="l33.667" class="difflineminus">-    default:</span>
<a href="#l33.668"></a><span id="l33.668" class="difflineminus">-        MOZ_ASSERT_UNREACHABLE(&quot;unknown parse type&quot;);</span>
<a href="#l33.669"></a><span id="l33.669" class="difflineminus">-        break;</span>
<a href="#l33.670"></a><span id="l33.670" class="difflineminus">-    }</span>
<a href="#l33.671"></a><span id="l33.671" class="difflineminus">-}</span>
<a href="#l33.672"></a><span id="l33.672" class="difflineminus">-</span>
<a href="#l33.673"></a><span id="l33.673" class="difflineminus">-nsresult</span>
<a href="#l33.674"></a><span id="l33.674" class="difflineminus">-RDFContentSinkImpl::FlushText()</span>
<a href="#l33.675"></a><span id="l33.675" class="difflineminus">-{</span>
<a href="#l33.676"></a><span id="l33.676" class="difflineminus">-    nsresult rv = NS_OK;</span>
<a href="#l33.677"></a><span id="l33.677" class="difflineminus">-    if (0 != mTextLength) {</span>
<a href="#l33.678"></a><span id="l33.678" class="difflineminus">-        if (rdf_IsDataInBuffer(mText, mTextLength)) {</span>
<a href="#l33.679"></a><span id="l33.679" class="difflineminus">-            // XXX if there's anything but whitespace, then we'll</span>
<a href="#l33.680"></a><span id="l33.680" class="difflineminus">-            // create a text node.</span>
<a href="#l33.681"></a><span id="l33.681" class="difflineminus">-</span>
<a href="#l33.682"></a><span id="l33.682" class="difflineminus">-            switch (mState) {</span>
<a href="#l33.683"></a><span id="l33.683" class="difflineminus">-            case eRDFContentSinkState_InMemberElement: {</span>
<a href="#l33.684"></a><span id="l33.684" class="difflineminus">-                nsCOMPtr&lt;nsIRDFNode&gt; node;</span>
<a href="#l33.685"></a><span id="l33.685" class="difflineminus">-                ParseText(getter_AddRefs(node));</span>
<a href="#l33.686"></a><span id="l33.686" class="difflineminus">-</span>
<a href="#l33.687"></a><span id="l33.687" class="difflineminus">-                nsCOMPtr&lt;nsIRDFContainer&gt; container;</span>
<a href="#l33.688"></a><span id="l33.688" class="difflineminus">-                NS_NewRDFContainer(getter_AddRefs(container));</span>
<a href="#l33.689"></a><span id="l33.689" class="difflineminus">-                container-&gt;Init(mDataSource, GetContextElement(1));</span>
<a href="#l33.690"></a><span id="l33.690" class="difflineminus">-</span>
<a href="#l33.691"></a><span id="l33.691" class="difflineminus">-                container-&gt;AppendElement(node);</span>
<a href="#l33.692"></a><span id="l33.692" class="difflineminus">-            } break;</span>
<a href="#l33.693"></a><span id="l33.693" class="difflineminus">-</span>
<a href="#l33.694"></a><span id="l33.694" class="difflineminus">-            case eRDFContentSinkState_InPropertyElement: {</span>
<a href="#l33.695"></a><span id="l33.695" class="difflineminus">-                nsCOMPtr&lt;nsIRDFNode&gt; node;</span>
<a href="#l33.696"></a><span id="l33.696" class="difflineminus">-                ParseText(getter_AddRefs(node));</span>
<a href="#l33.697"></a><span id="l33.697" class="difflineminus">-</span>
<a href="#l33.698"></a><span id="l33.698" class="difflineminus">-                mDataSource-&gt;Assert(GetContextElement(1), GetContextElement(0), node, true);</span>
<a href="#l33.699"></a><span id="l33.699" class="difflineminus">-            } break;</span>
<a href="#l33.700"></a><span id="l33.700" class="difflineminus">-</span>
<a href="#l33.701"></a><span id="l33.701" class="difflineminus">-            default:</span>
<a href="#l33.702"></a><span id="l33.702" class="difflineminus">-                // just ignore it</span>
<a href="#l33.703"></a><span id="l33.703" class="difflineminus">-                break;</span>
<a href="#l33.704"></a><span id="l33.704" class="difflineminus">-            }</span>
<a href="#l33.705"></a><span id="l33.705" class="difflineminus">-        }</span>
<a href="#l33.706"></a><span id="l33.706" class="difflineminus">-        mTextLength = 0;</span>
<a href="#l33.707"></a><span id="l33.707" class="difflineminus">-    }</span>
<a href="#l33.708"></a><span id="l33.708" class="difflineminus">-    return rv;</span>
<a href="#l33.709"></a><span id="l33.709" class="difflineminus">-}</span>
<a href="#l33.710"></a><span id="l33.710" class="difflineminus">-</span>
<a href="#l33.711"></a><span id="l33.711" class="difflineminus">-</span>
<a href="#l33.712"></a><span id="l33.712" class="difflineminus">-nsresult</span>
<a href="#l33.713"></a><span id="l33.713" class="difflineminus">-RDFContentSinkImpl::AddText(const char16_t* aText, int32_t aLength)</span>
<a href="#l33.714"></a><span id="l33.714" class="difflineminus">-{</span>
<a href="#l33.715"></a><span id="l33.715" class="difflineminus">-    // Create buffer when we first need it</span>
<a href="#l33.716"></a><span id="l33.716" class="difflineminus">-    if (0 == mTextSize) {</span>
<a href="#l33.717"></a><span id="l33.717" class="difflineminus">-        mText = (char16_t *) malloc(sizeof(char16_t) * 4096);</span>
<a href="#l33.718"></a><span id="l33.718" class="difflineminus">-        if (!mText) {</span>
<a href="#l33.719"></a><span id="l33.719" class="difflineminus">-            return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l33.720"></a><span id="l33.720" class="difflineminus">-        }</span>
<a href="#l33.721"></a><span id="l33.721" class="difflineminus">-        mTextSize = 4096;</span>
<a href="#l33.722"></a><span id="l33.722" class="difflineminus">-    }</span>
<a href="#l33.723"></a><span id="l33.723" class="difflineminus">-</span>
<a href="#l33.724"></a><span id="l33.724" class="difflineminus">-    // Copy data from string into our buffer; grow the buffer as needed.</span>
<a href="#l33.725"></a><span id="l33.725" class="difflineminus">-    // It never shrinks, but since the content sink doesn't stick around,</span>
<a href="#l33.726"></a><span id="l33.726" class="difflineminus">-    // this shouldn't be a bloat issue.</span>
<a href="#l33.727"></a><span id="l33.727" class="difflineminus">-    int32_t amount = mTextSize - mTextLength;</span>
<a href="#l33.728"></a><span id="l33.728" class="difflineminus">-    if (amount &lt; aLength) {</span>
<a href="#l33.729"></a><span id="l33.729" class="difflineminus">-        // Grow the buffer by at least a factor of two to prevent thrashing.</span>
<a href="#l33.730"></a><span id="l33.730" class="difflineminus">-        // Since realloc() will leave mText intact if the call fails,</span>
<a href="#l33.731"></a><span id="l33.731" class="difflineminus">-        // don't clobber mText or mTextSize until the new mem is allocated.</span>
<a href="#l33.732"></a><span id="l33.732" class="difflineminus">-        int32_t newSize = (2 * mTextSize &gt; (mTextSize + aLength)) ?</span>
<a href="#l33.733"></a><span id="l33.733" class="difflineminus">-                          (2 * mTextSize) : (mTextSize + aLength);</span>
<a href="#l33.734"></a><span id="l33.734" class="difflineminus">-        char16_t* newText =</span>
<a href="#l33.735"></a><span id="l33.735" class="difflineminus">-            (char16_t *) realloc(mText, sizeof(char16_t) * newSize);</span>
<a href="#l33.736"></a><span id="l33.736" class="difflineminus">-        if (!newText)</span>
<a href="#l33.737"></a><span id="l33.737" class="difflineminus">-            return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l33.738"></a><span id="l33.738" class="difflineminus">-        mTextSize = newSize;</span>
<a href="#l33.739"></a><span id="l33.739" class="difflineminus">-        mText = newText;</span>
<a href="#l33.740"></a><span id="l33.740" class="difflineminus">-    }</span>
<a href="#l33.741"></a><span id="l33.741" class="difflineminus">-    memcpy(&amp;mText[mTextLength], aText, sizeof(char16_t) * aLength);</span>
<a href="#l33.742"></a><span id="l33.742" class="difflineminus">-    mTextLength += aLength;</span>
<a href="#l33.743"></a><span id="l33.743" class="difflineminus">-</span>
<a href="#l33.744"></a><span id="l33.744" class="difflineminus">-    return NS_OK;</span>
<a href="#l33.745"></a><span id="l33.745" class="difflineminus">-}</span>
<a href="#l33.746"></a><span id="l33.746" class="difflineminus">-</span>
<a href="#l33.747"></a><span id="l33.747" class="difflineminus">-bool</span>
<a href="#l33.748"></a><span id="l33.748" class="difflineminus">-rdf_RequiresAbsoluteURI(const nsString&amp; uri)</span>
<a href="#l33.749"></a><span id="l33.749" class="difflineminus">-{</span>
<a href="#l33.750"></a><span id="l33.750" class="difflineminus">-    // cheap shot at figuring out if this requires an absolute url translation</span>
<a href="#l33.751"></a><span id="l33.751" class="difflineminus">-    return !(StringBeginsWith(uri, NS_LITERAL_STRING(&quot;urn:&quot;)) ||</span>
<a href="#l33.752"></a><span id="l33.752" class="difflineminus">-             StringBeginsWith(uri, NS_LITERAL_STRING(&quot;chrome:&quot;)));</span>
<a href="#l33.753"></a><span id="l33.753" class="difflineminus">-}</span>
<a href="#l33.754"></a><span id="l33.754" class="difflineminus">-</span>
<a href="#l33.755"></a><span id="l33.755" class="difflineminus">-nsresult</span>
<a href="#l33.756"></a><span id="l33.756" class="difflineminus">-RDFContentSinkImpl::GetIdAboutAttribute(const char16_t** aAttributes,</span>
<a href="#l33.757"></a><span id="l33.757" class="difflineminus">-                                        nsIRDFResource** aResource,</span>
<a href="#l33.758"></a><span id="l33.758" class="difflineminus">-                                        bool* aIsAnonymous)</span>
<a href="#l33.759"></a><span id="l33.759" class="difflineminus">-{</span>
<a href="#l33.760"></a><span id="l33.760" class="difflineminus">-    // This corresponds to the dirty work of production [6.5]</span>
<a href="#l33.761"></a><span id="l33.761" class="difflineminus">-    nsresult rv = NS_OK;</span>
<a href="#l33.762"></a><span id="l33.762" class="difflineminus">-</span>
<a href="#l33.763"></a><span id="l33.763" class="difflineminus">-    nsAutoString nodeID;</span>
<a href="#l33.764"></a><span id="l33.764" class="difflineminus">-</span>
<a href="#l33.765"></a><span id="l33.765" class="difflineminus">-    RefPtr&lt;nsAtom&gt; localName;</span>
<a href="#l33.766"></a><span id="l33.766" class="difflineminus">-    for (; *aAttributes; aAttributes += 2) {</span>
<a href="#l33.767"></a><span id="l33.767" class="difflineminus">-        const nsDependentSubstring&amp; nameSpaceURI =</span>
<a href="#l33.768"></a><span id="l33.768" class="difflineminus">-            SplitExpatName(aAttributes[0], getter_AddRefs(localName));</span>
<a href="#l33.769"></a><span id="l33.769" class="difflineminus">-</span>
<a href="#l33.770"></a><span id="l33.770" class="difflineminus">-        // We'll accept either `ID' or `rdf:ID' (ibid with `about' or</span>
<a href="#l33.771"></a><span id="l33.771" class="difflineminus">-        // `rdf:about') in the spirit of being liberal towards the</span>
<a href="#l33.772"></a><span id="l33.772" class="difflineminus">-        // input that we receive.</span>
<a href="#l33.773"></a><span id="l33.773" class="difflineminus">-        if (!nameSpaceURI.IsEmpty() &amp;&amp;</span>
<a href="#l33.774"></a><span id="l33.774" class="difflineminus">-            !nameSpaceURI.EqualsLiteral(RDF_NAMESPACE_URI)) {</span>
<a href="#l33.775"></a><span id="l33.775" class="difflineminus">-          continue;</span>
<a href="#l33.776"></a><span id="l33.776" class="difflineminus">-        }</span>
<a href="#l33.777"></a><span id="l33.777" class="difflineminus">-</span>
<a href="#l33.778"></a><span id="l33.778" class="difflineminus">-        // XXX you can't specify both, but we'll just pick up the</span>
<a href="#l33.779"></a><span id="l33.779" class="difflineminus">-        // first thing that was specified and ignore the other.</span>
<a href="#l33.780"></a><span id="l33.780" class="difflineminus">-</span>
<a href="#l33.781"></a><span id="l33.781" class="difflineminus">-        if (localName == nsGkAtoms::about) {</span>
<a href="#l33.782"></a><span id="l33.782" class="difflineminus">-            if (aIsAnonymous)</span>
<a href="#l33.783"></a><span id="l33.783" class="difflineminus">-                *aIsAnonymous = false;</span>
<a href="#l33.784"></a><span id="l33.784" class="difflineminus">-</span>
<a href="#l33.785"></a><span id="l33.785" class="difflineminus">-            nsAutoString relURI(aAttributes[1]);</span>
<a href="#l33.786"></a><span id="l33.786" class="difflineminus">-            if (rdf_RequiresAbsoluteURI(relURI)) {</span>
<a href="#l33.787"></a><span id="l33.787" class="difflineminus">-                nsAutoCString uri;</span>
<a href="#l33.788"></a><span id="l33.788" class="difflineminus">-                rv = mDocumentURL-&gt;Resolve(NS_ConvertUTF16toUTF8(aAttributes[1]), uri);</span>
<a href="#l33.789"></a><span id="l33.789" class="difflineminus">-                if (NS_FAILED(rv)) return rv;</span>
<a href="#l33.790"></a><span id="l33.790" class="difflineminus">-</span>
<a href="#l33.791"></a><span id="l33.791" class="difflineminus">-                return gRDFService-&gt;GetResource(uri,</span>
<a href="#l33.792"></a><span id="l33.792" class="difflineminus">-                                                aResource);</span>
<a href="#l33.793"></a><span id="l33.793" class="difflineminus">-            }</span>
<a href="#l33.794"></a><span id="l33.794" class="difflineminus">-            return gRDFService-&gt;GetResource(NS_ConvertUTF16toUTF8(aAttributes[1]),</span>
<a href="#l33.795"></a><span id="l33.795" class="difflineminus">-                                            aResource);</span>
<a href="#l33.796"></a><span id="l33.796" class="difflineminus">-        }</span>
<a href="#l33.797"></a><span id="l33.797" class="difflineminus">-        else if (localName == nsGkAtoms::ID) {</span>
<a href="#l33.798"></a><span id="l33.798" class="difflineminus">-            if (aIsAnonymous)</span>
<a href="#l33.799"></a><span id="l33.799" class="difflineminus">-                *aIsAnonymous = false;</span>
<a href="#l33.800"></a><span id="l33.800" class="difflineminus">-            // In the spirit of leniency, we do not bother trying to</span>
<a href="#l33.801"></a><span id="l33.801" class="difflineminus">-            // enforce that this be a valid &quot;XML Name&quot; (see</span>
<a href="#l33.802"></a><span id="l33.802" class="difflineminus">-            // http://www.w3.org/TR/REC-xml#NT-Nmtoken), as per</span>
<a href="#l33.803"></a><span id="l33.803" class="difflineminus">-            // 6.21. If we wanted to, this would be where to do it.</span>
<a href="#l33.804"></a><span id="l33.804" class="difflineminus">-</span>
<a href="#l33.805"></a><span id="l33.805" class="difflineminus">-            // Construct an in-line resource whose URI is the</span>
<a href="#l33.806"></a><span id="l33.806" class="difflineminus">-            // document's URI plus the XML name specified in the ID</span>
<a href="#l33.807"></a><span id="l33.807" class="difflineminus">-            // attribute.</span>
<a href="#l33.808"></a><span id="l33.808" class="difflineminus">-            nsAutoCString name;</span>
<a href="#l33.809"></a><span id="l33.809" class="difflineminus">-            nsAutoCString ref('#');</span>
<a href="#l33.810"></a><span id="l33.810" class="difflineminus">-            AppendUTF16toUTF8(mozilla::MakeStringSpan(aAttributes[1]), ref);</span>
<a href="#l33.811"></a><span id="l33.811" class="difflineminus">-</span>
<a href="#l33.812"></a><span id="l33.812" class="difflineminus">-            rv = mDocumentURL-&gt;Resolve(ref, name);</span>
<a href="#l33.813"></a><span id="l33.813" class="difflineminus">-            if (NS_FAILED(rv)) return rv;</span>
<a href="#l33.814"></a><span id="l33.814" class="difflineminus">-</span>
<a href="#l33.815"></a><span id="l33.815" class="difflineminus">-            return gRDFService-&gt;GetResource(name, aResource);</span>
<a href="#l33.816"></a><span id="l33.816" class="difflineminus">-        }</span>
<a href="#l33.817"></a><span id="l33.817" class="difflineminus">-        else if (localName == nsGkAtoms::nodeID) {</span>
<a href="#l33.818"></a><span id="l33.818" class="difflineminus">-            nodeID.Assign(aAttributes[1]);</span>
<a href="#l33.819"></a><span id="l33.819" class="difflineminus">-        }</span>
<a href="#l33.820"></a><span id="l33.820" class="difflineminus">-        else if (localName == nsGkAtoms::about) {</span>
<a href="#l33.821"></a><span id="l33.821" class="difflineminus">-            // XXX we don't deal with aboutEach...</span>
<a href="#l33.822"></a><span id="l33.822" class="difflineminus">-            //MOZ_LOG(gLog, LogLevel::Warning,</span>
<a href="#l33.823"></a><span id="l33.823" class="difflineminus">-            //       (&quot;rdfxml: ignoring aboutEach at line %d&quot;,</span>
<a href="#l33.824"></a><span id="l33.824" class="difflineminus">-            //        aNode.GetSourceLineNumber()));</span>
<a href="#l33.825"></a><span id="l33.825" class="difflineminus">-        }</span>
<a href="#l33.826"></a><span id="l33.826" class="difflineminus">-    }</span>
<a href="#l33.827"></a><span id="l33.827" class="difflineminus">-</span>
<a href="#l33.828"></a><span id="l33.828" class="difflineminus">-    // Otherwise, we couldn't find anything, so just gensym one...</span>
<a href="#l33.829"></a><span id="l33.829" class="difflineminus">-    if (aIsAnonymous)</span>
<a href="#l33.830"></a><span id="l33.830" class="difflineminus">-        *aIsAnonymous = true;</span>
<a href="#l33.831"></a><span id="l33.831" class="difflineminus">-</span>
<a href="#l33.832"></a><span id="l33.832" class="difflineminus">-    // If nodeID is present, check if we already know about it. If we've seen</span>
<a href="#l33.833"></a><span id="l33.833" class="difflineminus">-    // the nodeID before, use the same resource, otherwise generate a new one.</span>
<a href="#l33.834"></a><span id="l33.834" class="difflineminus">-    if (!nodeID.IsEmpty()) {</span>
<a href="#l33.835"></a><span id="l33.835" class="difflineminus">-        mNodeIDMap.Get(nodeID,aResource);</span>
<a href="#l33.836"></a><span id="l33.836" class="difflineminus">-</span>
<a href="#l33.837"></a><span id="l33.837" class="difflineminus">-        if (!*aResource) {</span>
<a href="#l33.838"></a><span id="l33.838" class="difflineminus">-            rv = gRDFService-&gt;GetAnonymousResource(aResource);</span>
<a href="#l33.839"></a><span id="l33.839" class="difflineminus">-            mNodeIDMap.Put(nodeID,*aResource);</span>
<a href="#l33.840"></a><span id="l33.840" class="difflineminus">-        }</span>
<a href="#l33.841"></a><span id="l33.841" class="difflineminus">-    }</span>
<a href="#l33.842"></a><span id="l33.842" class="difflineminus">-    else {</span>
<a href="#l33.843"></a><span id="l33.843" class="difflineminus">-        rv = gRDFService-&gt;GetAnonymousResource(aResource);</span>
<a href="#l33.844"></a><span id="l33.844" class="difflineminus">-    }</span>
<a href="#l33.845"></a><span id="l33.845" class="difflineminus">-</span>
<a href="#l33.846"></a><span id="l33.846" class="difflineminus">-    return rv;</span>
<a href="#l33.847"></a><span id="l33.847" class="difflineminus">-}</span>
<a href="#l33.848"></a><span id="l33.848" class="difflineminus">-</span>
<a href="#l33.849"></a><span id="l33.849" class="difflineminus">-nsresult</span>
<a href="#l33.850"></a><span id="l33.850" class="difflineminus">-RDFContentSinkImpl::GetResourceAttribute(const char16_t** aAttributes,</span>
<a href="#l33.851"></a><span id="l33.851" class="difflineminus">-                                         nsIRDFResource** aResource)</span>
<a href="#l33.852"></a><span id="l33.852" class="difflineminus">-{</span>
<a href="#l33.853"></a><span id="l33.853" class="difflineminus">-  RefPtr&lt;nsAtom&gt; localName;</span>
<a href="#l33.854"></a><span id="l33.854" class="difflineminus">-</span>
<a href="#l33.855"></a><span id="l33.855" class="difflineminus">-  nsAutoString nodeID;</span>
<a href="#l33.856"></a><span id="l33.856" class="difflineminus">-</span>
<a href="#l33.857"></a><span id="l33.857" class="difflineminus">-  for (; *aAttributes; aAttributes += 2) {</span>
<a href="#l33.858"></a><span id="l33.858" class="difflineminus">-      const nsDependentSubstring&amp; nameSpaceURI =</span>
<a href="#l33.859"></a><span id="l33.859" class="difflineminus">-          SplitExpatName(aAttributes[0], getter_AddRefs(localName));</span>
<a href="#l33.860"></a><span id="l33.860" class="difflineminus">-</span>
<a href="#l33.861"></a><span id="l33.861" class="difflineminus">-      // We'll accept `resource' or `rdf:resource', under the spirit</span>
<a href="#l33.862"></a><span id="l33.862" class="difflineminus">-      // that we should be liberal towards the input that we</span>
<a href="#l33.863"></a><span id="l33.863" class="difflineminus">-      // receive.</span>
<a href="#l33.864"></a><span id="l33.864" class="difflineminus">-      if (!nameSpaceURI.IsEmpty() &amp;&amp;</span>
<a href="#l33.865"></a><span id="l33.865" class="difflineminus">-          !nameSpaceURI.EqualsLiteral(RDF_NAMESPACE_URI)) {</span>
<a href="#l33.866"></a><span id="l33.866" class="difflineminus">-          continue;</span>
<a href="#l33.867"></a><span id="l33.867" class="difflineminus">-      }</span>
<a href="#l33.868"></a><span id="l33.868" class="difflineminus">-</span>
<a href="#l33.869"></a><span id="l33.869" class="difflineminus">-      // XXX you can't specify both, but we'll just pick up the</span>
<a href="#l33.870"></a><span id="l33.870" class="difflineminus">-      // first thing that was specified and ignore the other.</span>
<a href="#l33.871"></a><span id="l33.871" class="difflineminus">-</span>
<a href="#l33.872"></a><span id="l33.872" class="difflineminus">-      if (localName == nsGkAtoms::resource) {</span>
<a href="#l33.873"></a><span id="l33.873" class="difflineminus">-          // XXX Take the URI and make it fully qualified by</span>
<a href="#l33.874"></a><span id="l33.874" class="difflineminus">-          // sticking it into the document's URL. This may not be</span>
<a href="#l33.875"></a><span id="l33.875" class="difflineminus">-          // appropriate...</span>
<a href="#l33.876"></a><span id="l33.876" class="difflineminus">-          nsAutoString relURI(aAttributes[1]);</span>
<a href="#l33.877"></a><span id="l33.877" class="difflineminus">-          if (rdf_RequiresAbsoluteURI(relURI)) {</span>
<a href="#l33.878"></a><span id="l33.878" class="difflineminus">-              nsresult rv;</span>
<a href="#l33.879"></a><span id="l33.879" class="difflineminus">-              nsAutoCString uri;</span>
<a href="#l33.880"></a><span id="l33.880" class="difflineminus">-</span>
<a href="#l33.881"></a><span id="l33.881" class="difflineminus">-              rv = mDocumentURL-&gt;Resolve(NS_ConvertUTF16toUTF8(aAttributes[1]), uri);</span>
<a href="#l33.882"></a><span id="l33.882" class="difflineminus">-              if (NS_FAILED(rv)) return rv;</span>
<a href="#l33.883"></a><span id="l33.883" class="difflineminus">-</span>
<a href="#l33.884"></a><span id="l33.884" class="difflineminus">-              return gRDFService-&gt;GetResource(uri, aResource);</span>
<a href="#l33.885"></a><span id="l33.885" class="difflineminus">-          }</span>
<a href="#l33.886"></a><span id="l33.886" class="difflineminus">-          return gRDFService-&gt;GetResource(NS_ConvertUTF16toUTF8(aAttributes[1]),</span>
<a href="#l33.887"></a><span id="l33.887" class="difflineminus">-                                          aResource);</span>
<a href="#l33.888"></a><span id="l33.888" class="difflineminus">-      }</span>
<a href="#l33.889"></a><span id="l33.889" class="difflineminus">-      else if (localName == nsGkAtoms::nodeID) {</span>
<a href="#l33.890"></a><span id="l33.890" class="difflineminus">-          nodeID.Assign(aAttributes[1]);</span>
<a href="#l33.891"></a><span id="l33.891" class="difflineminus">-      }</span>
<a href="#l33.892"></a><span id="l33.892" class="difflineminus">-  }</span>
<a href="#l33.893"></a><span id="l33.893" class="difflineminus">-</span>
<a href="#l33.894"></a><span id="l33.894" class="difflineminus">-  // If nodeID is present, check if we already know about it. If we've seen</span>
<a href="#l33.895"></a><span id="l33.895" class="difflineminus">-  // the nodeID before, use the same resource, otherwise generate a new one.</span>
<a href="#l33.896"></a><span id="l33.896" class="difflineminus">-  if (!nodeID.IsEmpty()) {</span>
<a href="#l33.897"></a><span id="l33.897" class="difflineminus">-      mNodeIDMap.Get(nodeID,aResource);</span>
<a href="#l33.898"></a><span id="l33.898" class="difflineminus">-</span>
<a href="#l33.899"></a><span id="l33.899" class="difflineminus">-      if (!*aResource) {</span>
<a href="#l33.900"></a><span id="l33.900" class="difflineminus">-          nsresult rv;</span>
<a href="#l33.901"></a><span id="l33.901" class="difflineminus">-          rv = gRDFService-&gt;GetAnonymousResource(aResource);</span>
<a href="#l33.902"></a><span id="l33.902" class="difflineminus">-          if (NS_FAILED(rv)) {</span>
<a href="#l33.903"></a><span id="l33.903" class="difflineminus">-              return rv;</span>
<a href="#l33.904"></a><span id="l33.904" class="difflineminus">-          }</span>
<a href="#l33.905"></a><span id="l33.905" class="difflineminus">-          mNodeIDMap.Put(nodeID,*aResource);</span>
<a href="#l33.906"></a><span id="l33.906" class="difflineminus">-      }</span>
<a href="#l33.907"></a><span id="l33.907" class="difflineminus">-      return NS_OK;</span>
<a href="#l33.908"></a><span id="l33.908" class="difflineminus">-  }</span>
<a href="#l33.909"></a><span id="l33.909" class="difflineminus">-</span>
<a href="#l33.910"></a><span id="l33.910" class="difflineminus">-  return NS_ERROR_FAILURE;</span>
<a href="#l33.911"></a><span id="l33.911" class="difflineminus">-}</span>
<a href="#l33.912"></a><span id="l33.912" class="difflineminus">-</span>
<a href="#l33.913"></a><span id="l33.913" class="difflineminus">-nsresult</span>
<a href="#l33.914"></a><span id="l33.914" class="difflineminus">-RDFContentSinkImpl::AddProperties(const char16_t** aAttributes,</span>
<a href="#l33.915"></a><span id="l33.915" class="difflineminus">-                                  nsIRDFResource* aSubject,</span>
<a href="#l33.916"></a><span id="l33.916" class="difflineminus">-                                  int32_t* aCount)</span>
<a href="#l33.917"></a><span id="l33.917" class="difflineminus">-{</span>
<a href="#l33.918"></a><span id="l33.918" class="difflineminus">-  if (aCount)</span>
<a href="#l33.919"></a><span id="l33.919" class="difflineminus">-      *aCount = 0;</span>
<a href="#l33.920"></a><span id="l33.920" class="difflineminus">-</span>
<a href="#l33.921"></a><span id="l33.921" class="difflineminus">-  RefPtr&lt;nsAtom&gt; localName;</span>
<a href="#l33.922"></a><span id="l33.922" class="difflineminus">-  for (; *aAttributes; aAttributes += 2) {</span>
<a href="#l33.923"></a><span id="l33.923" class="difflineminus">-      const nsDependentSubstring&amp; nameSpaceURI =</span>
<a href="#l33.924"></a><span id="l33.924" class="difflineminus">-          SplitExpatName(aAttributes[0], getter_AddRefs(localName));</span>
<a href="#l33.925"></a><span id="l33.925" class="difflineminus">-</span>
<a href="#l33.926"></a><span id="l33.926" class="difflineminus">-      // skip 'xmlns' directives, these are &quot;meta&quot; information</span>
<a href="#l33.927"></a><span id="l33.927" class="difflineminus">-      if (nameSpaceURI.EqualsLiteral(&quot;http://www.w3.org/2000/xmlns/&quot;)) {</span>
<a href="#l33.928"></a><span id="l33.928" class="difflineminus">-        continue;</span>
<a href="#l33.929"></a><span id="l33.929" class="difflineminus">-      }</span>
<a href="#l33.930"></a><span id="l33.930" class="difflineminus">-</span>
<a href="#l33.931"></a><span id="l33.931" class="difflineminus">-      // skip `about', `ID', `resource', and 'nodeID' attributes (either with or</span>
<a href="#l33.932"></a><span id="l33.932" class="difflineminus">-      // without the `rdf:' prefix); these are all &quot;special&quot; and</span>
<a href="#l33.933"></a><span id="l33.933" class="difflineminus">-      // should've been dealt with by the caller.</span>
<a href="#l33.934"></a><span id="l33.934" class="difflineminus">-      if (localName == nsGkAtoms::about || localName == nsGkAtoms::ID ||</span>
<a href="#l33.935"></a><span id="l33.935" class="difflineminus">-          localName == nsGkAtoms::resource || localName == nsGkAtoms::nodeID) {</span>
<a href="#l33.936"></a><span id="l33.936" class="difflineminus">-          if (nameSpaceURI.IsEmpty() ||</span>
<a href="#l33.937"></a><span id="l33.937" class="difflineminus">-              nameSpaceURI.EqualsLiteral(RDF_NAMESPACE_URI))</span>
<a href="#l33.938"></a><span id="l33.938" class="difflineminus">-              continue;</span>
<a href="#l33.939"></a><span id="l33.939" class="difflineminus">-      }</span>
<a href="#l33.940"></a><span id="l33.940" class="difflineminus">-</span>
<a href="#l33.941"></a><span id="l33.941" class="difflineminus">-      // Skip `parseType', `RDF:parseType', and `NC:parseType'. This</span>
<a href="#l33.942"></a><span id="l33.942" class="difflineminus">-      // is meta-information that will be handled in SetParseMode.</span>
<a href="#l33.943"></a><span id="l33.943" class="difflineminus">-      if (localName == nsGkAtoms::parseType) {</span>
<a href="#l33.944"></a><span id="l33.944" class="difflineminus">-          if (nameSpaceURI.IsEmpty() ||</span>
<a href="#l33.945"></a><span id="l33.945" class="difflineminus">-              nameSpaceURI.EqualsLiteral(RDF_NAMESPACE_URI) ||</span>
<a href="#l33.946"></a><span id="l33.946" class="difflineminus">-              nameSpaceURI.EqualsLiteral(NC_NAMESPACE_URI)) {</span>
<a href="#l33.947"></a><span id="l33.947" class="difflineminus">-              continue;</span>
<a href="#l33.948"></a><span id="l33.948" class="difflineminus">-          }</span>
<a href="#l33.949"></a><span id="l33.949" class="difflineminus">-      }</span>
<a href="#l33.950"></a><span id="l33.950" class="difflineminus">-</span>
<a href="#l33.951"></a><span id="l33.951" class="difflineminus">-      NS_ConvertUTF16toUTF8 propertyStr(nameSpaceURI);</span>
<a href="#l33.952"></a><span id="l33.952" class="difflineminus">-      propertyStr.Append(nsAtomCString(localName));</span>
<a href="#l33.953"></a><span id="l33.953" class="difflineminus">-</span>
<a href="#l33.954"></a><span id="l33.954" class="difflineminus">-      // Add the assertion to RDF</span>
<a href="#l33.955"></a><span id="l33.955" class="difflineminus">-      nsCOMPtr&lt;nsIRDFResource&gt; property;</span>
<a href="#l33.956"></a><span id="l33.956" class="difflineminus">-      gRDFService-&gt;GetResource(propertyStr, getter_AddRefs(property));</span>
<a href="#l33.957"></a><span id="l33.957" class="difflineminus">-</span>
<a href="#l33.958"></a><span id="l33.958" class="difflineminus">-      nsCOMPtr&lt;nsIRDFLiteral&gt; target;</span>
<a href="#l33.959"></a><span id="l33.959" class="difflineminus">-      gRDFService-&gt;GetLiteral(aAttributes[1],</span>
<a href="#l33.960"></a><span id="l33.960" class="difflineminus">-                              getter_AddRefs(target));</span>
<a href="#l33.961"></a><span id="l33.961" class="difflineminus">-</span>
<a href="#l33.962"></a><span id="l33.962" class="difflineminus">-      mDataSource-&gt;Assert(aSubject, property, target, true);</span>
<a href="#l33.963"></a><span id="l33.963" class="difflineminus">-  }</span>
<a href="#l33.964"></a><span id="l33.964" class="difflineminus">-  return NS_OK;</span>
<a href="#l33.965"></a><span id="l33.965" class="difflineminus">-}</span>
<a href="#l33.966"></a><span id="l33.966" class="difflineminus">-</span>
<a href="#l33.967"></a><span id="l33.967" class="difflineminus">-void</span>
<a href="#l33.968"></a><span id="l33.968" class="difflineminus">-RDFContentSinkImpl::SetParseMode(const char16_t **aAttributes)</span>
<a href="#l33.969"></a><span id="l33.969" class="difflineminus">-{</span>
<a href="#l33.970"></a><span id="l33.970" class="difflineminus">-    RefPtr&lt;nsAtom&gt; localName;</span>
<a href="#l33.971"></a><span id="l33.971" class="difflineminus">-    for (; *aAttributes; aAttributes += 2) {</span>
<a href="#l33.972"></a><span id="l33.972" class="difflineminus">-        const nsDependentSubstring&amp; nameSpaceURI =</span>
<a href="#l33.973"></a><span id="l33.973" class="difflineminus">-            SplitExpatName(aAttributes[0], getter_AddRefs(localName));</span>
<a href="#l33.974"></a><span id="l33.974" class="difflineminus">-</span>
<a href="#l33.975"></a><span id="l33.975" class="difflineminus">-        if (localName == nsGkAtoms::parseType) {</span>
<a href="#l33.976"></a><span id="l33.976" class="difflineminus">-            nsDependentString v(aAttributes[1]);</span>
<a href="#l33.977"></a><span id="l33.977" class="difflineminus">-</span>
<a href="#l33.978"></a><span id="l33.978" class="difflineminus">-            if (nameSpaceURI.IsEmpty() ||</span>
<a href="#l33.979"></a><span id="l33.979" class="difflineminus">-                nameSpaceURI.EqualsLiteral(RDF_NAMESPACE_URI)) {</span>
<a href="#l33.980"></a><span id="l33.980" class="difflineminus">-                if (v.EqualsLiteral(&quot;Resource&quot;))</span>
<a href="#l33.981"></a><span id="l33.981" class="difflineminus">-                    mParseMode = eRDFContentSinkParseMode_Resource;</span>
<a href="#l33.982"></a><span id="l33.982" class="difflineminus">-</span>
<a href="#l33.983"></a><span id="l33.983" class="difflineminus">-                break;</span>
<a href="#l33.984"></a><span id="l33.984" class="difflineminus">-            }</span>
<a href="#l33.985"></a><span id="l33.985" class="difflineminus">-            else if (nameSpaceURI.EqualsLiteral(NC_NAMESPACE_URI)) {</span>
<a href="#l33.986"></a><span id="l33.986" class="difflineminus">-                if (v.EqualsLiteral(&quot;Date&quot;))</span>
<a href="#l33.987"></a><span id="l33.987" class="difflineminus">-                    mParseMode = eRDFContentSinkParseMode_Date;</span>
<a href="#l33.988"></a><span id="l33.988" class="difflineminus">-                else if (v.EqualsLiteral(&quot;Integer&quot;))</span>
<a href="#l33.989"></a><span id="l33.989" class="difflineminus">-                    mParseMode = eRDFContentSinkParseMode_Int;</span>
<a href="#l33.990"></a><span id="l33.990" class="difflineminus">-</span>
<a href="#l33.991"></a><span id="l33.991" class="difflineminus">-                break;</span>
<a href="#l33.992"></a><span id="l33.992" class="difflineminus">-            }</span>
<a href="#l33.993"></a><span id="l33.993" class="difflineminus">-        }</span>
<a href="#l33.994"></a><span id="l33.994" class="difflineminus">-    }</span>
<a href="#l33.995"></a><span id="l33.995" class="difflineminus">-}</span>
<a href="#l33.996"></a><span id="l33.996" class="difflineminus">-</span>
<a href="#l33.997"></a><span id="l33.997" class="difflineminus">-////////////////////////////////////////////////////////////////////////</span>
<a href="#l33.998"></a><span id="l33.998" class="difflineminus">-// RDF-specific routines used to build the model</span>
<a href="#l33.999"></a><span id="l33.999" class="difflineminus">-</span>
<a href="#l33.1000"></a><span id="l33.1000" class="difflineminus">-nsresult</span>
<a href="#l33.1001"></a><span id="l33.1001" class="difflineminus">-RDFContentSinkImpl::OpenRDF(const char16_t* aName)</span>
<a href="#l33.1002"></a><span id="l33.1002" class="difflineminus">-{</span>
<a href="#l33.1003"></a><span id="l33.1003" class="difflineminus">-    // ensure that we're actually reading RDF by making sure that the</span>
<a href="#l33.1004"></a><span id="l33.1004" class="difflineminus">-    // opening tag is &lt;rdf:RDF&gt;, where &quot;rdf:&quot; corresponds to whatever</span>
<a href="#l33.1005"></a><span id="l33.1005" class="difflineminus">-    // they've declared the standard RDF namespace to be.</span>
<a href="#l33.1006"></a><span id="l33.1006" class="difflineminus">-    RefPtr&lt;nsAtom&gt; localName;</span>
<a href="#l33.1007"></a><span id="l33.1007" class="difflineminus">-    const nsDependentSubstring&amp; nameSpaceURI =</span>
<a href="#l33.1008"></a><span id="l33.1008" class="difflineminus">-        SplitExpatName(aName, getter_AddRefs(localName));</span>
<a href="#l33.1009"></a><span id="l33.1009" class="difflineminus">-</span>
<a href="#l33.1010"></a><span id="l33.1010" class="difflineminus">-    if (!nameSpaceURI.EqualsLiteral(RDF_NAMESPACE_URI) ||</span>
<a href="#l33.1011"></a><span id="l33.1011" class="difflineminus">-        localName != nsGkAtoms::RDF) {</span>
<a href="#l33.1012"></a><span id="l33.1012" class="difflineminus">-       // MOZ_LOG(gLog, LogLevel::Info,</span>
<a href="#l33.1013"></a><span id="l33.1013" class="difflineminus">-       //        (&quot;rdfxml: expected RDF:RDF at line %d&quot;,</span>
<a href="#l33.1014"></a><span id="l33.1014" class="difflineminus">-       //         aNode.GetSourceLineNumber()));</span>
<a href="#l33.1015"></a><span id="l33.1015" class="difflineminus">-</span>
<a href="#l33.1016"></a><span id="l33.1016" class="difflineminus">-        return NS_ERROR_UNEXPECTED;</span>
<a href="#l33.1017"></a><span id="l33.1017" class="difflineminus">-    }</span>
<a href="#l33.1018"></a><span id="l33.1018" class="difflineminus">-</span>
<a href="#l33.1019"></a><span id="l33.1019" class="difflineminus">-    PushContext(nullptr, mState, mParseMode);</span>
<a href="#l33.1020"></a><span id="l33.1020" class="difflineminus">-    mState = eRDFContentSinkState_InDocumentElement;</span>
<a href="#l33.1021"></a><span id="l33.1021" class="difflineminus">-    return NS_OK;</span>
<a href="#l33.1022"></a><span id="l33.1022" class="difflineminus">-}</span>
<a href="#l33.1023"></a><span id="l33.1023" class="difflineminus">-</span>
<a href="#l33.1024"></a><span id="l33.1024" class="difflineminus">-nsresult</span>
<a href="#l33.1025"></a><span id="l33.1025" class="difflineminus">-RDFContentSinkImpl::OpenObject(const char16_t* aName,</span>
<a href="#l33.1026"></a><span id="l33.1026" class="difflineminus">-                               const char16_t** aAttributes)</span>
<a href="#l33.1027"></a><span id="l33.1027" class="difflineminus">-{</span>
<a href="#l33.1028"></a><span id="l33.1028" class="difflineminus">-    // an &quot;object&quot; non-terminal is either a &quot;description&quot;, a &quot;typed</span>
<a href="#l33.1029"></a><span id="l33.1029" class="difflineminus">-    // node&quot;, or a &quot;container&quot;, so this change the content sink's</span>
<a href="#l33.1030"></a><span id="l33.1030" class="difflineminus">-    // state appropriately.</span>
<a href="#l33.1031"></a><span id="l33.1031" class="difflineminus">-    RefPtr&lt;nsAtom&gt; localName;</span>
<a href="#l33.1032"></a><span id="l33.1032" class="difflineminus">-    const nsDependentSubstring&amp; nameSpaceURI =</span>
<a href="#l33.1033"></a><span id="l33.1033" class="difflineminus">-        SplitExpatName(aName, getter_AddRefs(localName));</span>
<a href="#l33.1034"></a><span id="l33.1034" class="difflineminus">-</span>
<a href="#l33.1035"></a><span id="l33.1035" class="difflineminus">-    // Figure out the URI of this object, and create an RDF node for it.</span>
<a href="#l33.1036"></a><span id="l33.1036" class="difflineminus">-    nsCOMPtr&lt;nsIRDFResource&gt; source;</span>
<a href="#l33.1037"></a><span id="l33.1037" class="difflineminus">-    GetIdAboutAttribute(aAttributes, getter_AddRefs(source));</span>
<a href="#l33.1038"></a><span id="l33.1038" class="difflineminus">-</span>
<a href="#l33.1039"></a><span id="l33.1039" class="difflineminus">-    // If there is no `ID' or `about', then there's not much we can do.</span>
<a href="#l33.1040"></a><span id="l33.1040" class="difflineminus">-    if (! source)</span>
<a href="#l33.1041"></a><span id="l33.1041" class="difflineminus">-        return NS_ERROR_FAILURE;</span>
<a href="#l33.1042"></a><span id="l33.1042" class="difflineminus">-</span>
<a href="#l33.1043"></a><span id="l33.1043" class="difflineminus">-    // Push the element onto the context stack</span>
<a href="#l33.1044"></a><span id="l33.1044" class="difflineminus">-    PushContext(source, mState, mParseMode);</span>
<a href="#l33.1045"></a><span id="l33.1045" class="difflineminus">-</span>
<a href="#l33.1046"></a><span id="l33.1046" class="difflineminus">-    // Now figure out what kind of state transition we need to</span>
<a href="#l33.1047"></a><span id="l33.1047" class="difflineminus">-    // make. We'll either be going into a mode where we parse a</span>
<a href="#l33.1048"></a><span id="l33.1048" class="difflineminus">-    // description or a container.</span>
<a href="#l33.1049"></a><span id="l33.1049" class="difflineminus">-    bool isaTypedNode = true;</span>
<a href="#l33.1050"></a><span id="l33.1050" class="difflineminus">-</span>
<a href="#l33.1051"></a><span id="l33.1051" class="difflineminus">-    if (nameSpaceURI.EqualsLiteral(RDF_NAMESPACE_URI)) {</span>
<a href="#l33.1052"></a><span id="l33.1052" class="difflineminus">-        isaTypedNode = false;</span>
<a href="#l33.1053"></a><span id="l33.1053" class="difflineminus">-</span>
<a href="#l33.1054"></a><span id="l33.1054" class="difflineminus">-        if (localName == nsGkAtoms::Description) {</span>
<a href="#l33.1055"></a><span id="l33.1055" class="difflineminus">-            // it's a description</span>
<a href="#l33.1056"></a><span id="l33.1056" class="difflineminus">-            mState = eRDFContentSinkState_InDescriptionElement;</span>
<a href="#l33.1057"></a><span id="l33.1057" class="difflineminus">-        }</span>
<a href="#l33.1058"></a><span id="l33.1058" class="difflineminus">-        else if (localName == nsGkAtoms::Bag) {</span>
<a href="#l33.1059"></a><span id="l33.1059" class="difflineminus">-            // it's a bag container</span>
<a href="#l33.1060"></a><span id="l33.1060" class="difflineminus">-            InitContainer(kRDF_Bag, source);</span>
<a href="#l33.1061"></a><span id="l33.1061" class="difflineminus">-            mState = eRDFContentSinkState_InContainerElement;</span>
<a href="#l33.1062"></a><span id="l33.1062" class="difflineminus">-        }</span>
<a href="#l33.1063"></a><span id="l33.1063" class="difflineminus">-        else if (localName == nsGkAtoms::Seq) {</span>
<a href="#l33.1064"></a><span id="l33.1064" class="difflineminus">-            // it's a seq container</span>
<a href="#l33.1065"></a><span id="l33.1065" class="difflineminus">-            InitContainer(kRDF_Seq, source);</span>
<a href="#l33.1066"></a><span id="l33.1066" class="difflineminus">-            mState = eRDFContentSinkState_InContainerElement;</span>
<a href="#l33.1067"></a><span id="l33.1067" class="difflineminus">-        }</span>
<a href="#l33.1068"></a><span id="l33.1068" class="difflineminus">-        else if (localName == nsGkAtoms::Alt) {</span>
<a href="#l33.1069"></a><span id="l33.1069" class="difflineminus">-            // it's an alt container</span>
<a href="#l33.1070"></a><span id="l33.1070" class="difflineminus">-            InitContainer(kRDF_Alt, source);</span>
<a href="#l33.1071"></a><span id="l33.1071" class="difflineminus">-            mState = eRDFContentSinkState_InContainerElement;</span>
<a href="#l33.1072"></a><span id="l33.1072" class="difflineminus">-        }</span>
<a href="#l33.1073"></a><span id="l33.1073" class="difflineminus">-        else {</span>
<a href="#l33.1074"></a><span id="l33.1074" class="difflineminus">-            // heh, that's not *in* the RDF namespace: just treat it</span>
<a href="#l33.1075"></a><span id="l33.1075" class="difflineminus">-            // like a typed node</span>
<a href="#l33.1076"></a><span id="l33.1076" class="difflineminus">-            isaTypedNode = true;</span>
<a href="#l33.1077"></a><span id="l33.1077" class="difflineminus">-        }</span>
<a href="#l33.1078"></a><span id="l33.1078" class="difflineminus">-    }</span>
<a href="#l33.1079"></a><span id="l33.1079" class="difflineminus">-</span>
<a href="#l33.1080"></a><span id="l33.1080" class="difflineminus">-    if (isaTypedNode) {</span>
<a href="#l33.1081"></a><span id="l33.1081" class="difflineminus">-        NS_ConvertUTF16toUTF8 typeStr(nameSpaceURI);</span>
<a href="#l33.1082"></a><span id="l33.1082" class="difflineminus">-        typeStr.Append(nsAtomCString(localName));</span>
<a href="#l33.1083"></a><span id="l33.1083" class="difflineminus">-</span>
<a href="#l33.1084"></a><span id="l33.1084" class="difflineminus">-        nsCOMPtr&lt;nsIRDFResource&gt; type;</span>
<a href="#l33.1085"></a><span id="l33.1085" class="difflineminus">-        nsresult rv = gRDFService-&gt;GetResource(typeStr, getter_AddRefs(type));</span>
<a href="#l33.1086"></a><span id="l33.1086" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l33.1087"></a><span id="l33.1087" class="difflineminus">-</span>
<a href="#l33.1088"></a><span id="l33.1088" class="difflineminus">-        rv = mDataSource-&gt;Assert(source, kRDF_type, type, true);</span>
<a href="#l33.1089"></a><span id="l33.1089" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l33.1090"></a><span id="l33.1090" class="difflineminus">-</span>
<a href="#l33.1091"></a><span id="l33.1091" class="difflineminus">-        mState = eRDFContentSinkState_InDescriptionElement;</span>
<a href="#l33.1092"></a><span id="l33.1092" class="difflineminus">-    }</span>
<a href="#l33.1093"></a><span id="l33.1093" class="difflineminus">-</span>
<a href="#l33.1094"></a><span id="l33.1094" class="difflineminus">-    AddProperties(aAttributes, source);</span>
<a href="#l33.1095"></a><span id="l33.1095" class="difflineminus">-    return NS_OK;</span>
<a href="#l33.1096"></a><span id="l33.1096" class="difflineminus">-}</span>
<a href="#l33.1097"></a><span id="l33.1097" class="difflineminus">-</span>
<a href="#l33.1098"></a><span id="l33.1098" class="difflineminus">-nsresult</span>
<a href="#l33.1099"></a><span id="l33.1099" class="difflineminus">-RDFContentSinkImpl::OpenProperty(const char16_t* aName, const char16_t** aAttributes)</span>
<a href="#l33.1100"></a><span id="l33.1100" class="difflineminus">-{</span>
<a href="#l33.1101"></a><span id="l33.1101" class="difflineminus">-    nsresult rv;</span>
<a href="#l33.1102"></a><span id="l33.1102" class="difflineminus">-</span>
<a href="#l33.1103"></a><span id="l33.1103" class="difflineminus">-    // an &quot;object&quot; non-terminal is either a &quot;description&quot;, a &quot;typed</span>
<a href="#l33.1104"></a><span id="l33.1104" class="difflineminus">-    // node&quot;, or a &quot;container&quot;, so this change the content sink's</span>
<a href="#l33.1105"></a><span id="l33.1105" class="difflineminus">-    // state appropriately.</span>
<a href="#l33.1106"></a><span id="l33.1106" class="difflineminus">-    RefPtr&lt;nsAtom&gt; localName;</span>
<a href="#l33.1107"></a><span id="l33.1107" class="difflineminus">-    const nsDependentSubstring&amp; nameSpaceURI =</span>
<a href="#l33.1108"></a><span id="l33.1108" class="difflineminus">-        SplitExpatName(aName, getter_AddRefs(localName));</span>
<a href="#l33.1109"></a><span id="l33.1109" class="difflineminus">-</span>
<a href="#l33.1110"></a><span id="l33.1110" class="difflineminus">-    NS_ConvertUTF16toUTF8 propertyStr(nameSpaceURI);</span>
<a href="#l33.1111"></a><span id="l33.1111" class="difflineminus">-    propertyStr.Append(nsAtomCString(localName));</span>
<a href="#l33.1112"></a><span id="l33.1112" class="difflineminus">-</span>
<a href="#l33.1113"></a><span id="l33.1113" class="difflineminus">-    nsCOMPtr&lt;nsIRDFResource&gt; property;</span>
<a href="#l33.1114"></a><span id="l33.1114" class="difflineminus">-    rv = gRDFService-&gt;GetResource(propertyStr, getter_AddRefs(property));</span>
<a href="#l33.1115"></a><span id="l33.1115" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l33.1116"></a><span id="l33.1116" class="difflineminus">-</span>
<a href="#l33.1117"></a><span id="l33.1117" class="difflineminus">-    // See if they've specified a 'resource' attribute, in which case</span>
<a href="#l33.1118"></a><span id="l33.1118" class="difflineminus">-    // they mean *that* to be the object of this property.</span>
<a href="#l33.1119"></a><span id="l33.1119" class="difflineminus">-    nsCOMPtr&lt;nsIRDFResource&gt; target;</span>
<a href="#l33.1120"></a><span id="l33.1120" class="difflineminus">-    GetResourceAttribute(aAttributes, getter_AddRefs(target));</span>
<a href="#l33.1121"></a><span id="l33.1121" class="difflineminus">-</span>
<a href="#l33.1122"></a><span id="l33.1122" class="difflineminus">-    bool isAnonymous = false;</span>
<a href="#l33.1123"></a><span id="l33.1123" class="difflineminus">-</span>
<a href="#l33.1124"></a><span id="l33.1124" class="difflineminus">-    if (! target) {</span>
<a href="#l33.1125"></a><span id="l33.1125" class="difflineminus">-        // See if an 'ID' attribute has been specified, in which case</span>
<a href="#l33.1126"></a><span id="l33.1126" class="difflineminus">-        // this corresponds to the fourth form of [6.12].</span>
<a href="#l33.1127"></a><span id="l33.1127" class="difflineminus">-</span>
<a href="#l33.1128"></a><span id="l33.1128" class="difflineminus">-        // XXX strictly speaking, we should reject the RDF/XML as</span>
<a href="#l33.1129"></a><span id="l33.1129" class="difflineminus">-        // invalid if they've specified both an 'ID' and a 'resource'</span>
<a href="#l33.1130"></a><span id="l33.1130" class="difflineminus">-        // attribute. Bah.</span>
<a href="#l33.1131"></a><span id="l33.1131" class="difflineminus">-</span>
<a href="#l33.1132"></a><span id="l33.1132" class="difflineminus">-        // XXX strictly speaking, 'about=' isn't allowed here, but</span>
<a href="#l33.1133"></a><span id="l33.1133" class="difflineminus">-        // what the hell.</span>
<a href="#l33.1134"></a><span id="l33.1134" class="difflineminus">-        GetIdAboutAttribute(aAttributes, getter_AddRefs(target), &amp;isAnonymous);</span>
<a href="#l33.1135"></a><span id="l33.1135" class="difflineminus">-    }</span>
<a href="#l33.1136"></a><span id="l33.1136" class="difflineminus">-</span>
<a href="#l33.1137"></a><span id="l33.1137" class="difflineminus">-    if (target) {</span>
<a href="#l33.1138"></a><span id="l33.1138" class="difflineminus">-        // They specified an inline resource for the value of this</span>
<a href="#l33.1139"></a><span id="l33.1139" class="difflineminus">-        // property. Create an RDF resource for the inline resource</span>
<a href="#l33.1140"></a><span id="l33.1140" class="difflineminus">-        // URI, add the properties to it, and attach the inline</span>
<a href="#l33.1141"></a><span id="l33.1141" class="difflineminus">-        // resource to its parent.</span>
<a href="#l33.1142"></a><span id="l33.1142" class="difflineminus">-        int32_t count;</span>
<a href="#l33.1143"></a><span id="l33.1143" class="difflineminus">-        rv = AddProperties(aAttributes, target, &amp;count);</span>
<a href="#l33.1144"></a><span id="l33.1144" class="difflineminus">-        NS_ASSERTION(NS_SUCCEEDED(rv), &quot;problem adding properties&quot;);</span>
<a href="#l33.1145"></a><span id="l33.1145" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l33.1146"></a><span id="l33.1146" class="difflineminus">-</span>
<a href="#l33.1147"></a><span id="l33.1147" class="difflineminus">-        if (count || !isAnonymous) {</span>
<a href="#l33.1148"></a><span id="l33.1148" class="difflineminus">-            // If the resource was &quot;anonymous&quot; (i.e., they hadn't</span>
<a href="#l33.1149"></a><span id="l33.1149" class="difflineminus">-            // explicitly set an ID or resource attribute), then we'll</span>
<a href="#l33.1150"></a><span id="l33.1150" class="difflineminus">-            // only assert this property from the context element *if*</span>
<a href="#l33.1151"></a><span id="l33.1151" class="difflineminus">-            // there were properties specified on the anonymous</span>
<a href="#l33.1152"></a><span id="l33.1152" class="difflineminus">-            // resource.</span>
<a href="#l33.1153"></a><span id="l33.1153" class="difflineminus">-            rv = mDataSource-&gt;Assert(GetContextElement(0), property, target, true);</span>
<a href="#l33.1154"></a><span id="l33.1154" class="difflineminus">-            if (NS_FAILED(rv)) return rv;</span>
<a href="#l33.1155"></a><span id="l33.1155" class="difflineminus">-        }</span>
<a href="#l33.1156"></a><span id="l33.1156" class="difflineminus">-</span>
<a href="#l33.1157"></a><span id="l33.1157" class="difflineminus">-        // XXX Technically, we should _not_ fall through here and push</span>
<a href="#l33.1158"></a><span id="l33.1158" class="difflineminus">-        // the element onto the stack: this is supposed to be a closed</span>
<a href="#l33.1159"></a><span id="l33.1159" class="difflineminus">-        // node. But right now I'm lazy and the code will just Do The</span>
<a href="#l33.1160"></a><span id="l33.1160" class="difflineminus">-        // Right Thing so long as the RDF is well-formed.</span>
<a href="#l33.1161"></a><span id="l33.1161" class="difflineminus">-    }</span>
<a href="#l33.1162"></a><span id="l33.1162" class="difflineminus">-</span>
<a href="#l33.1163"></a><span id="l33.1163" class="difflineminus">-    // Push the element onto the context stack and change state.</span>
<a href="#l33.1164"></a><span id="l33.1164" class="difflineminus">-    PushContext(property, mState, mParseMode);</span>
<a href="#l33.1165"></a><span id="l33.1165" class="difflineminus">-    mState = eRDFContentSinkState_InPropertyElement;</span>
<a href="#l33.1166"></a><span id="l33.1166" class="difflineminus">-    SetParseMode(aAttributes);</span>
<a href="#l33.1167"></a><span id="l33.1167" class="difflineminus">-</span>
<a href="#l33.1168"></a><span id="l33.1168" class="difflineminus">-    return NS_OK;</span>
<a href="#l33.1169"></a><span id="l33.1169" class="difflineminus">-}</span>
<a href="#l33.1170"></a><span id="l33.1170" class="difflineminus">-</span>
<a href="#l33.1171"></a><span id="l33.1171" class="difflineminus">-nsresult</span>
<a href="#l33.1172"></a><span id="l33.1172" class="difflineminus">-RDFContentSinkImpl::OpenMember(const char16_t* aName,</span>
<a href="#l33.1173"></a><span id="l33.1173" class="difflineminus">-                               const char16_t** aAttributes)</span>
<a href="#l33.1174"></a><span id="l33.1174" class="difflineminus">-{</span>
<a href="#l33.1175"></a><span id="l33.1175" class="difflineminus">-    // ensure that we're actually reading a member element by making</span>
<a href="#l33.1176"></a><span id="l33.1176" class="difflineminus">-    // sure that the opening tag is &lt;rdf:li&gt;, where &quot;rdf:&quot; corresponds</span>
<a href="#l33.1177"></a><span id="l33.1177" class="difflineminus">-    // to whatever they've declared the standard RDF namespace to be.</span>
<a href="#l33.1178"></a><span id="l33.1178" class="difflineminus">-    nsresult rv;</span>
<a href="#l33.1179"></a><span id="l33.1179" class="difflineminus">-</span>
<a href="#l33.1180"></a><span id="l33.1180" class="difflineminus">-    RefPtr&lt;nsAtom&gt; localName;</span>
<a href="#l33.1181"></a><span id="l33.1181" class="difflineminus">-    const nsDependentSubstring&amp; nameSpaceURI =</span>
<a href="#l33.1182"></a><span id="l33.1182" class="difflineminus">-        SplitExpatName(aName, getter_AddRefs(localName));</span>
<a href="#l33.1183"></a><span id="l33.1183" class="difflineminus">-</span>
<a href="#l33.1184"></a><span id="l33.1184" class="difflineminus">-    if (!nameSpaceURI.EqualsLiteral(RDF_NAMESPACE_URI) ||</span>
<a href="#l33.1185"></a><span id="l33.1185" class="difflineminus">-        localName != nsGkAtoms::li) {</span>
<a href="#l33.1186"></a><span id="l33.1186" class="difflineminus">-        MOZ_LOG(gLog, LogLevel::Error,</span>
<a href="#l33.1187"></a><span id="l33.1187" class="difflineminus">-               (&quot;rdfxml: expected RDF:li at line %d&quot;,</span>
<a href="#l33.1188"></a><span id="l33.1188" class="difflineminus">-                -1)); // XXX pass in line number</span>
<a href="#l33.1189"></a><span id="l33.1189" class="difflineminus">-</span>
<a href="#l33.1190"></a><span id="l33.1190" class="difflineminus">-        return NS_ERROR_UNEXPECTED;</span>
<a href="#l33.1191"></a><span id="l33.1191" class="difflineminus">-    }</span>
<a href="#l33.1192"></a><span id="l33.1192" class="difflineminus">-</span>
<a href="#l33.1193"></a><span id="l33.1193" class="difflineminus">-    // The parent element is the container.</span>
<a href="#l33.1194"></a><span id="l33.1194" class="difflineminus">-    nsIRDFResource* container = GetContextElement(0);</span>
<a href="#l33.1195"></a><span id="l33.1195" class="difflineminus">-    if (! container)</span>
<a href="#l33.1196"></a><span id="l33.1196" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l33.1197"></a><span id="l33.1197" class="difflineminus">-</span>
<a href="#l33.1198"></a><span id="l33.1198" class="difflineminus">-    nsIRDFResource* resource;</span>
<a href="#l33.1199"></a><span id="l33.1199" class="difflineminus">-    if (NS_SUCCEEDED(rv = GetResourceAttribute(aAttributes, &amp;resource))) {</span>
<a href="#l33.1200"></a><span id="l33.1200" class="difflineminus">-        // Okay, this node has an RDF:resource=&quot;...&quot; attribute. That</span>
<a href="#l33.1201"></a><span id="l33.1201" class="difflineminus">-        // means that it's a &quot;referenced item,&quot; as covered in [6.29].</span>
<a href="#l33.1202"></a><span id="l33.1202" class="difflineminus">-        nsCOMPtr&lt;nsIRDFContainer&gt; c;</span>
<a href="#l33.1203"></a><span id="l33.1203" class="difflineminus">-        NS_NewRDFContainer(getter_AddRefs(c));</span>
<a href="#l33.1204"></a><span id="l33.1204" class="difflineminus">-        c-&gt;Init(mDataSource, container);</span>
<a href="#l33.1205"></a><span id="l33.1205" class="difflineminus">-        c-&gt;AppendElement(resource);</span>
<a href="#l33.1206"></a><span id="l33.1206" class="difflineminus">-</span>
<a href="#l33.1207"></a><span id="l33.1207" class="difflineminus">-        // XXX Technically, we should _not_ fall through here and push</span>
<a href="#l33.1208"></a><span id="l33.1208" class="difflineminus">-        // the element onto the stack: this is supposed to be a closed</span>
<a href="#l33.1209"></a><span id="l33.1209" class="difflineminus">-        // node. But right now I'm lazy and the code will just Do The</span>
<a href="#l33.1210"></a><span id="l33.1210" class="difflineminus">-        // Right Thing so long as the RDF is well-formed.</span>
<a href="#l33.1211"></a><span id="l33.1211" class="difflineminus">-        NS_RELEASE(resource);</span>
<a href="#l33.1212"></a><span id="l33.1212" class="difflineminus">-    }</span>
<a href="#l33.1213"></a><span id="l33.1213" class="difflineminus">-</span>
<a href="#l33.1214"></a><span id="l33.1214" class="difflineminus">-    // Change state. Pushing a null context element is a bit weird,</span>
<a href="#l33.1215"></a><span id="l33.1215" class="difflineminus">-    // but the idea is that there really is _no_ context &quot;property&quot;.</span>
<a href="#l33.1216"></a><span id="l33.1216" class="difflineminus">-    // The contained element will use nsIRDFContainer::AppendElement() to add</span>
<a href="#l33.1217"></a><span id="l33.1217" class="difflineminus">-    // the element to the container, which requires only the container</span>
<a href="#l33.1218"></a><span id="l33.1218" class="difflineminus">-    // and the element to be added.</span>
<a href="#l33.1219"></a><span id="l33.1219" class="difflineminus">-    PushContext(nullptr, mState, mParseMode);</span>
<a href="#l33.1220"></a><span id="l33.1220" class="difflineminus">-    mState = eRDFContentSinkState_InMemberElement;</span>
<a href="#l33.1221"></a><span id="l33.1221" class="difflineminus">-    SetParseMode(aAttributes);</span>
<a href="#l33.1222"></a><span id="l33.1222" class="difflineminus">-</span>
<a href="#l33.1223"></a><span id="l33.1223" class="difflineminus">-    return NS_OK;</span>
<a href="#l33.1224"></a><span id="l33.1224" class="difflineminus">-}</span>
<a href="#l33.1225"></a><span id="l33.1225" class="difflineminus">-</span>
<a href="#l33.1226"></a><span id="l33.1226" class="difflineminus">-</span>
<a href="#l33.1227"></a><span id="l33.1227" class="difflineminus">-nsresult</span>
<a href="#l33.1228"></a><span id="l33.1228" class="difflineminus">-RDFContentSinkImpl::OpenValue(const char16_t* aName, const char16_t** aAttributes)</span>
<a href="#l33.1229"></a><span id="l33.1229" class="difflineminus">-{</span>
<a href="#l33.1230"></a><span id="l33.1230" class="difflineminus">-    // a &quot;value&quot; can either be an object or a string: we'll only get</span>
<a href="#l33.1231"></a><span id="l33.1231" class="difflineminus">-    // *here* if it's an object, as raw text is added as a leaf.</span>
<a href="#l33.1232"></a><span id="l33.1232" class="difflineminus">-    return OpenObject(aName,aAttributes);</span>
<a href="#l33.1233"></a><span id="l33.1233" class="difflineminus">-}</span>
<a href="#l33.1234"></a><span id="l33.1234" class="difflineminus">-</span>
<a href="#l33.1235"></a><span id="l33.1235" class="difflineminus">-////////////////////////////////////////////////////////////////////////</span>
<a href="#l33.1236"></a><span id="l33.1236" class="difflineminus">-// namespace resolution</span>
<a href="#l33.1237"></a><span id="l33.1237" class="difflineminus">-void</span>
<a href="#l33.1238"></a><span id="l33.1238" class="difflineminus">-RDFContentSinkImpl::RegisterNamespaces(const char16_t **aAttributes)</span>
<a href="#l33.1239"></a><span id="l33.1239" class="difflineminus">-{</span>
<a href="#l33.1240"></a><span id="l33.1240" class="difflineminus">-    nsCOMPtr&lt;nsIRDFXMLSink&gt; sink = do_QueryInterface(mDataSource);</span>
<a href="#l33.1241"></a><span id="l33.1241" class="difflineminus">-    if (!sink) {</span>
<a href="#l33.1242"></a><span id="l33.1242" class="difflineminus">-        return;</span>
<a href="#l33.1243"></a><span id="l33.1243" class="difflineminus">-    }</span>
<a href="#l33.1244"></a><span id="l33.1244" class="difflineminus">-    NS_NAMED_LITERAL_STRING(xmlns, &quot;http://www.w3.org/2000/xmlns/&quot;);</span>
<a href="#l33.1245"></a><span id="l33.1245" class="difflineminus">-    for (; *aAttributes; aAttributes += 2) {</span>
<a href="#l33.1246"></a><span id="l33.1246" class="difflineminus">-        // check the namespace</span>
<a href="#l33.1247"></a><span id="l33.1247" class="difflineminus">-        const char16_t* attr = aAttributes[0];</span>
<a href="#l33.1248"></a><span id="l33.1248" class="difflineminus">-        const char16_t* xmlnsP = xmlns.BeginReading();</span>
<a href="#l33.1249"></a><span id="l33.1249" class="difflineminus">-        while (*attr ==  *xmlnsP) {</span>
<a href="#l33.1250"></a><span id="l33.1250" class="difflineminus">-            ++attr;</span>
<a href="#l33.1251"></a><span id="l33.1251" class="difflineminus">-            ++xmlnsP;</span>
<a href="#l33.1252"></a><span id="l33.1252" class="difflineminus">-        }</span>
<a href="#l33.1253"></a><span id="l33.1253" class="difflineminus">-        if (*attr != 0xFFFF ||</span>
<a href="#l33.1254"></a><span id="l33.1254" class="difflineminus">-            xmlnsP != xmlns.EndReading()) {</span>
<a href="#l33.1255"></a><span id="l33.1255" class="difflineminus">-            continue;</span>
<a href="#l33.1256"></a><span id="l33.1256" class="difflineminus">-        }</span>
<a href="#l33.1257"></a><span id="l33.1257" class="difflineminus">-        // get the localname (or &quot;xmlns&quot; for the default namespace)</span>
<a href="#l33.1258"></a><span id="l33.1258" class="difflineminus">-        const char16_t* endLocal = ++attr;</span>
<a href="#l33.1259"></a><span id="l33.1259" class="difflineminus">-        while (*endLocal &amp;&amp; *endLocal != 0xFFFF) {</span>
<a href="#l33.1260"></a><span id="l33.1260" class="difflineminus">-            ++endLocal;</span>
<a href="#l33.1261"></a><span id="l33.1261" class="difflineminus">-        }</span>
<a href="#l33.1262"></a><span id="l33.1262" class="difflineminus">-        nsDependentSubstring lname(attr, endLocal);</span>
<a href="#l33.1263"></a><span id="l33.1263" class="difflineminus">-        RefPtr&lt;nsAtom&gt; preferred = NS_Atomize(lname);</span>
<a href="#l33.1264"></a><span id="l33.1264" class="difflineminus">-        if (preferred == nsGkAtoms::xmlns) {</span>
<a href="#l33.1265"></a><span id="l33.1265" class="difflineminus">-            preferred = nullptr;</span>
<a href="#l33.1266"></a><span id="l33.1266" class="difflineminus">-        }</span>
<a href="#l33.1267"></a><span id="l33.1267" class="difflineminus">-        sink-&gt;AddNameSpace(preferred, nsDependentString(aAttributes[1]));</span>
<a href="#l33.1268"></a><span id="l33.1268" class="difflineminus">-    }</span>
<a href="#l33.1269"></a><span id="l33.1269" class="difflineminus">-}</span>
<a href="#l33.1270"></a><span id="l33.1270" class="difflineminus">-</span>
<a href="#l33.1271"></a><span id="l33.1271" class="difflineminus">-////////////////////////////////////////////////////////////////////////</span>
<a href="#l33.1272"></a><span id="l33.1272" class="difflineminus">-// Qualified name resolution</span>
<a href="#l33.1273"></a><span id="l33.1273" class="difflineminus">-</span>
<a href="#l33.1274"></a><span id="l33.1274" class="difflineminus">-const nsDependentSubstring</span>
<a href="#l33.1275"></a><span id="l33.1275" class="difflineminus">-RDFContentSinkImpl::SplitExpatName(const char16_t *aExpatName,</span>
<a href="#l33.1276"></a><span id="l33.1276" class="difflineminus">-                                   nsAtom **aLocalName)</span>
<a href="#l33.1277"></a><span id="l33.1277" class="difflineminus">-{</span>
<a href="#l33.1278"></a><span id="l33.1278" class="difflineminus">-    /**</span>
<a href="#l33.1279"></a><span id="l33.1279" class="difflineminus">-     *  Expat can send the following:</span>
<a href="#l33.1280"></a><span id="l33.1280" class="difflineminus">-     *    localName</span>
<a href="#l33.1281"></a><span id="l33.1281" class="difflineminus">-     *    namespaceURI&lt;separator&gt;localName</span>
<a href="#l33.1282"></a><span id="l33.1282" class="difflineminus">-     *    namespaceURI&lt;separator&gt;localName&lt;separator&gt;prefix</span>
<a href="#l33.1283"></a><span id="l33.1283" class="difflineminus">-     *</span>
<a href="#l33.1284"></a><span id="l33.1284" class="difflineminus">-     *  and we use 0xFFFF for the &lt;separator&gt;.</span>
<a href="#l33.1285"></a><span id="l33.1285" class="difflineminus">-     *</span>
<a href="#l33.1286"></a><span id="l33.1286" class="difflineminus">-     */</span>
<a href="#l33.1287"></a><span id="l33.1287" class="difflineminus">-</span>
<a href="#l33.1288"></a><span id="l33.1288" class="difflineminus">-    const char16_t *uriEnd = aExpatName;</span>
<a href="#l33.1289"></a><span id="l33.1289" class="difflineminus">-    const char16_t *nameStart = aExpatName;</span>
<a href="#l33.1290"></a><span id="l33.1290" class="difflineminus">-    const char16_t *pos;</span>
<a href="#l33.1291"></a><span id="l33.1291" class="difflineminus">-    for (pos = aExpatName; *pos; ++pos) {</span>
<a href="#l33.1292"></a><span id="l33.1292" class="difflineminus">-        if (*pos == 0xFFFF) {</span>
<a href="#l33.1293"></a><span id="l33.1293" class="difflineminus">-            if (uriEnd != aExpatName) {</span>
<a href="#l33.1294"></a><span id="l33.1294" class="difflineminus">-                break;</span>
<a href="#l33.1295"></a><span id="l33.1295" class="difflineminus">-            }</span>
<a href="#l33.1296"></a><span id="l33.1296" class="difflineminus">-</span>
<a href="#l33.1297"></a><span id="l33.1297" class="difflineminus">-            uriEnd = pos;</span>
<a href="#l33.1298"></a><span id="l33.1298" class="difflineminus">-            nameStart = pos + 1;</span>
<a href="#l33.1299"></a><span id="l33.1299" class="difflineminus">-        }</span>
<a href="#l33.1300"></a><span id="l33.1300" class="difflineminus">-    }</span>
<a href="#l33.1301"></a><span id="l33.1301" class="difflineminus">-</span>
<a href="#l33.1302"></a><span id="l33.1302" class="difflineminus">-    const nsDependentSubstring&amp; nameSpaceURI = Substring(aExpatName, uriEnd);</span>
<a href="#l33.1303"></a><span id="l33.1303" class="difflineminus">-    *aLocalName = NS_Atomize(Substring(nameStart, pos)).take();</span>
<a href="#l33.1304"></a><span id="l33.1304" class="difflineminus">-    return nameSpaceURI;</span>
<a href="#l33.1305"></a><span id="l33.1305" class="difflineminus">-}</span>
<a href="#l33.1306"></a><span id="l33.1306" class="difflineminus">-</span>
<a href="#l33.1307"></a><span id="l33.1307" class="difflineminus">-nsresult</span>
<a href="#l33.1308"></a><span id="l33.1308" class="difflineminus">-RDFContentSinkImpl::InitContainer(nsIRDFResource* aContainerType, nsIRDFResource* aContainer)</span>
<a href="#l33.1309"></a><span id="l33.1309" class="difflineminus">-{</span>
<a href="#l33.1310"></a><span id="l33.1310" class="difflineminus">-    // Do the right kind of initialization based on the container</span>
<a href="#l33.1311"></a><span id="l33.1311" class="difflineminus">-    // 'type' resource, and the state of the container (i.e., 'make' a</span>
<a href="#l33.1312"></a><span id="l33.1312" class="difflineminus">-    // new container vs. 'reinitialize' the container).</span>
<a href="#l33.1313"></a><span id="l33.1313" class="difflineminus">-    nsresult rv;</span>
<a href="#l33.1314"></a><span id="l33.1314" class="difflineminus">-</span>
<a href="#l33.1315"></a><span id="l33.1315" class="difflineminus">-    static const ContainerInfo gContainerInfo[] = {</span>
<a href="#l33.1316"></a><span id="l33.1316" class="difflineminus">-        { &amp;RDFContentSinkImpl::kRDF_Alt, &amp;nsIRDFContainerUtils::IsAlt, &amp;nsIRDFContainerUtils::MakeAlt },</span>
<a href="#l33.1317"></a><span id="l33.1317" class="difflineminus">-        { &amp;RDFContentSinkImpl::kRDF_Bag, &amp;nsIRDFContainerUtils::IsBag, &amp;nsIRDFContainerUtils::MakeBag },</span>
<a href="#l33.1318"></a><span id="l33.1318" class="difflineminus">-        { &amp;RDFContentSinkImpl::kRDF_Seq, &amp;nsIRDFContainerUtils::IsSeq, &amp;nsIRDFContainerUtils::MakeSeq },</span>
<a href="#l33.1319"></a><span id="l33.1319" class="difflineminus">-        { 0, 0, 0 },</span>
<a href="#l33.1320"></a><span id="l33.1320" class="difflineminus">-    };</span>
<a href="#l33.1321"></a><span id="l33.1321" class="difflineminus">-</span>
<a href="#l33.1322"></a><span id="l33.1322" class="difflineminus">-    for (const ContainerInfo* info = gContainerInfo; info-&gt;mType != 0; ++info) {</span>
<a href="#l33.1323"></a><span id="l33.1323" class="difflineminus">-        if (*info-&gt;mType != aContainerType)</span>
<a href="#l33.1324"></a><span id="l33.1324" class="difflineminus">-            continue;</span>
<a href="#l33.1325"></a><span id="l33.1325" class="difflineminus">-</span>
<a href="#l33.1326"></a><span id="l33.1326" class="difflineminus">-        bool isContainer;</span>
<a href="#l33.1327"></a><span id="l33.1327" class="difflineminus">-        rv = (gRDFContainerUtils-&gt;*(info-&gt;mTestFn))(mDataSource, aContainer, &amp;isContainer);</span>
<a href="#l33.1328"></a><span id="l33.1328" class="difflineminus">-        if (isContainer) {</span>
<a href="#l33.1329"></a><span id="l33.1329" class="difflineminus">-            rv = ReinitContainer(aContainerType, aContainer);</span>
<a href="#l33.1330"></a><span id="l33.1330" class="difflineminus">-        }</span>
<a href="#l33.1331"></a><span id="l33.1331" class="difflineminus">-        else {</span>
<a href="#l33.1332"></a><span id="l33.1332" class="difflineminus">-            rv = (gRDFContainerUtils-&gt;*(info-&gt;mMakeFn))(mDataSource, aContainer, nullptr);</span>
<a href="#l33.1333"></a><span id="l33.1333" class="difflineminus">-        }</span>
<a href="#l33.1334"></a><span id="l33.1334" class="difflineminus">-        return rv;</span>
<a href="#l33.1335"></a><span id="l33.1335" class="difflineminus">-    }</span>
<a href="#l33.1336"></a><span id="l33.1336" class="difflineminus">-</span>
<a href="#l33.1337"></a><span id="l33.1337" class="difflineminus">-    MOZ_ASSERT_UNREACHABLE(&quot;not an RDF container type&quot;);</span>
<a href="#l33.1338"></a><span id="l33.1338" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l33.1339"></a><span id="l33.1339" class="difflineminus">-}</span>
<a href="#l33.1340"></a><span id="l33.1340" class="difflineminus">-</span>
<a href="#l33.1341"></a><span id="l33.1341" class="difflineminus">-</span>
<a href="#l33.1342"></a><span id="l33.1342" class="difflineminus">-</span>
<a href="#l33.1343"></a><span id="l33.1343" class="difflineminus">-nsresult</span>
<a href="#l33.1344"></a><span id="l33.1344" class="difflineminus">-RDFContentSinkImpl::ReinitContainer(nsIRDFResource* aContainerType, nsIRDFResource* aContainer)</span>
<a href="#l33.1345"></a><span id="l33.1345" class="difflineminus">-{</span>
<a href="#l33.1346"></a><span id="l33.1346" class="difflineminus">-    // Mega-kludge to deal with the fact that Make[Seq|Alt|Bag] is</span>
<a href="#l33.1347"></a><span id="l33.1347" class="difflineminus">-    // idempotent, and as such, containers will have state (e.g.,</span>
<a href="#l33.1348"></a><span id="l33.1348" class="difflineminus">-    // RDF:nextVal) maintained in the graph across loads. This</span>
<a href="#l33.1349"></a><span id="l33.1349" class="difflineminus">-    // re-initializes each container's RDF:nextVal to '1', and 'marks'</span>
<a href="#l33.1350"></a><span id="l33.1350" class="difflineminus">-    // the container as such.</span>
<a href="#l33.1351"></a><span id="l33.1351" class="difflineminus">-    nsresult rv;</span>
<a href="#l33.1352"></a><span id="l33.1352" class="difflineminus">-</span>
<a href="#l33.1353"></a><span id="l33.1353" class="difflineminus">-    nsCOMPtr&lt;nsIRDFLiteral&gt; one;</span>
<a href="#l33.1354"></a><span id="l33.1354" class="difflineminus">-    rv = gRDFService-&gt;GetLiteral(u&quot;1&quot;, getter_AddRefs(one));</span>
<a href="#l33.1355"></a><span id="l33.1355" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l33.1356"></a><span id="l33.1356" class="difflineminus">-</span>
<a href="#l33.1357"></a><span id="l33.1357" class="difflineminus">-    // Re-initialize the 'nextval' property</span>
<a href="#l33.1358"></a><span id="l33.1358" class="difflineminus">-    nsCOMPtr&lt;nsIRDFNode&gt; nextval;</span>
<a href="#l33.1359"></a><span id="l33.1359" class="difflineminus">-    rv = mDataSource-&gt;GetTarget(aContainer, kRDF_nextVal, true, getter_AddRefs(nextval));</span>
<a href="#l33.1360"></a><span id="l33.1360" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l33.1361"></a><span id="l33.1361" class="difflineminus">-</span>
<a href="#l33.1362"></a><span id="l33.1362" class="difflineminus">-    rv = mDataSource-&gt;Change(aContainer, kRDF_nextVal, nextval, one);</span>
<a href="#l33.1363"></a><span id="l33.1363" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l33.1364"></a><span id="l33.1364" class="difflineminus">-</span>
<a href="#l33.1365"></a><span id="l33.1365" class="difflineminus">-    // Re-mark as a container. XXX should be kRDF_type</span>
<a href="#l33.1366"></a><span id="l33.1366" class="difflineminus">-    rv = mDataSource-&gt;Assert(aContainer, kRDF_instanceOf, aContainerType, true);</span>
<a href="#l33.1367"></a><span id="l33.1367" class="difflineminus">-    NS_ASSERTION(NS_SUCCEEDED(rv), &quot;unable to mark container as such&quot;);</span>
<a href="#l33.1368"></a><span id="l33.1368" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l33.1369"></a><span id="l33.1369" class="difflineminus">-</span>
<a href="#l33.1370"></a><span id="l33.1370" class="difflineminus">-    return NS_OK;</span>
<a href="#l33.1371"></a><span id="l33.1371" class="difflineminus">-}</span>
<a href="#l33.1372"></a><span id="l33.1372" class="difflineminus">-</span>
<a href="#l33.1373"></a><span id="l33.1373" class="difflineminus">-////////////////////////////////////////////////////////////////////////</span>
<a href="#l33.1374"></a><span id="l33.1374" class="difflineminus">-// Content stack management</span>
<a href="#l33.1375"></a><span id="l33.1375" class="difflineminus">-</span>
<a href="#l33.1376"></a><span id="l33.1376" class="difflineminus">-nsIRDFResource*</span>
<a href="#l33.1377"></a><span id="l33.1377" class="difflineminus">-RDFContentSinkImpl::GetContextElement(int32_t ancestor /* = 0 */)</span>
<a href="#l33.1378"></a><span id="l33.1378" class="difflineminus">-{</span>
<a href="#l33.1379"></a><span id="l33.1379" class="difflineminus">-    if ((nullptr == mContextStack) ||</span>
<a href="#l33.1380"></a><span id="l33.1380" class="difflineminus">-        (uint32_t(ancestor) &gt;= mContextStack-&gt;Length())) {</span>
<a href="#l33.1381"></a><span id="l33.1381" class="difflineminus">-        return nullptr;</span>
<a href="#l33.1382"></a><span id="l33.1382" class="difflineminus">-    }</span>
<a href="#l33.1383"></a><span id="l33.1383" class="difflineminus">-</span>
<a href="#l33.1384"></a><span id="l33.1384" class="difflineminus">-    return mContextStack-&gt;ElementAt(</span>
<a href="#l33.1385"></a><span id="l33.1385" class="difflineminus">-           mContextStack-&gt;Length()-ancestor-1).mResource;</span>
<a href="#l33.1386"></a><span id="l33.1386" class="difflineminus">-}</span>
<a href="#l33.1387"></a><span id="l33.1387" class="difflineminus">-</span>
<a href="#l33.1388"></a><span id="l33.1388" class="difflineminus">-int32_t</span>
<a href="#l33.1389"></a><span id="l33.1389" class="difflineminus">-RDFContentSinkImpl::PushContext(nsIRDFResource         *aResource,</span>
<a href="#l33.1390"></a><span id="l33.1390" class="difflineminus">-                                RDFContentSinkState     aState,</span>
<a href="#l33.1391"></a><span id="l33.1391" class="difflineminus">-                                RDFContentSinkParseMode aParseMode)</span>
<a href="#l33.1392"></a><span id="l33.1392" class="difflineminus">-{</span>
<a href="#l33.1393"></a><span id="l33.1393" class="difflineminus">-    if (! mContextStack) {</span>
<a href="#l33.1394"></a><span id="l33.1394" class="difflineminus">-        mContextStack = new AutoTArray&lt;RDFContextStackElement, 8&gt;();</span>
<a href="#l33.1395"></a><span id="l33.1395" class="difflineminus">-        if (! mContextStack)</span>
<a href="#l33.1396"></a><span id="l33.1396" class="difflineminus">-            return 0;</span>
<a href="#l33.1397"></a><span id="l33.1397" class="difflineminus">-    }</span>
<a href="#l33.1398"></a><span id="l33.1398" class="difflineminus">-</span>
<a href="#l33.1399"></a><span id="l33.1399" class="difflineminus">-    RDFContextStackElement* e = mContextStack-&gt;AppendElement();</span>
<a href="#l33.1400"></a><span id="l33.1400" class="difflineminus">-    if (! e)</span>
<a href="#l33.1401"></a><span id="l33.1401" class="difflineminus">-        return mContextStack-&gt;Length();</span>
<a href="#l33.1402"></a><span id="l33.1402" class="difflineminus">-</span>
<a href="#l33.1403"></a><span id="l33.1403" class="difflineminus">-    e-&gt;mResource  = aResource;</span>
<a href="#l33.1404"></a><span id="l33.1404" class="difflineminus">-    e-&gt;mState     = aState;</span>
<a href="#l33.1405"></a><span id="l33.1405" class="difflineminus">-    e-&gt;mParseMode = aParseMode;</span>
<a href="#l33.1406"></a><span id="l33.1406" class="difflineminus">-</span>
<a href="#l33.1407"></a><span id="l33.1407" class="difflineminus">-    return mContextStack-&gt;Length();</span>
<a href="#l33.1408"></a><span id="l33.1408" class="difflineminus">-}</span>
<a href="#l33.1409"></a><span id="l33.1409" class="difflineminus">-</span>
<a href="#l33.1410"></a><span id="l33.1410" class="difflineminus">-nsresult</span>
<a href="#l33.1411"></a><span id="l33.1411" class="difflineminus">-RDFContentSinkImpl::PopContext(nsIRDFResource         *&amp;aResource,</span>
<a href="#l33.1412"></a><span id="l33.1412" class="difflineminus">-                               RDFContentSinkState     &amp;aState,</span>
<a href="#l33.1413"></a><span id="l33.1413" class="difflineminus">-                               RDFContentSinkParseMode &amp;aParseMode)</span>
<a href="#l33.1414"></a><span id="l33.1414" class="difflineminus">-{</span>
<a href="#l33.1415"></a><span id="l33.1415" class="difflineminus">-    if ((nullptr == mContextStack) ||</span>
<a href="#l33.1416"></a><span id="l33.1416" class="difflineminus">-        (mContextStack-&gt;IsEmpty())) {</span>
<a href="#l33.1417"></a><span id="l33.1417" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l33.1418"></a><span id="l33.1418" class="difflineminus">-    }</span>
<a href="#l33.1419"></a><span id="l33.1419" class="difflineminus">-</span>
<a href="#l33.1420"></a><span id="l33.1420" class="difflineminus">-    uint32_t i = mContextStack-&gt;Length() - 1;</span>
<a href="#l33.1421"></a><span id="l33.1421" class="difflineminus">-    RDFContextStackElement &amp;e = mContextStack-&gt;ElementAt(i);</span>
<a href="#l33.1422"></a><span id="l33.1422" class="difflineminus">-</span>
<a href="#l33.1423"></a><span id="l33.1423" class="difflineminus">-    aResource  = e.mResource;</span>
<a href="#l33.1424"></a><span id="l33.1424" class="difflineminus">-    NS_IF_ADDREF(aResource);</span>
<a href="#l33.1425"></a><span id="l33.1425" class="difflineminus">-    aState     = e.mState;</span>
<a href="#l33.1426"></a><span id="l33.1426" class="difflineminus">-    aParseMode = e.mParseMode;</span>
<a href="#l33.1427"></a><span id="l33.1427" class="difflineminus">-</span>
<a href="#l33.1428"></a><span id="l33.1428" class="difflineminus">-    mContextStack-&gt;RemoveElementAt(i);</span>
<a href="#l33.1429"></a><span id="l33.1429" class="difflineminus">-    return NS_OK;</span>
<a href="#l33.1430"></a><span id="l33.1430" class="difflineminus">-}</span>
<a href="#l33.1431"></a><span id="l33.1431" class="difflineminus">-</span>
<a href="#l33.1432"></a><span id="l33.1432" class="difflineminus">-</span>
<a href="#l33.1433"></a><span id="l33.1433" class="difflineminus">-////////////////////////////////////////////////////////////////////////</span>
<a href="#l33.1434"></a><span id="l33.1434" class="difflineminus">-</span>
<a href="#l33.1435"></a><span id="l33.1435" class="difflineminus">-nsresult</span>
<a href="#l33.1436"></a><span id="l33.1436" class="difflineminus">-NS_NewRDFContentSink(nsIRDFContentSink** aResult)</span>
<a href="#l33.1437"></a><span id="l33.1437" class="difflineminus">-{</span>
<a href="#l33.1438"></a><span id="l33.1438" class="difflineminus">-    NS_ASSERTION(aResult != nullptr, &quot;null ptr&quot;);</span>
<a href="#l33.1439"></a><span id="l33.1439" class="difflineminus">-    if (! aResult)</span>
<a href="#l33.1440"></a><span id="l33.1440" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l33.1441"></a><span id="l33.1441" class="difflineminus">-</span>
<a href="#l33.1442"></a><span id="l33.1442" class="difflineminus">-    RDFContentSinkImpl* sink = new RDFContentSinkImpl();</span>
<a href="#l33.1443"></a><span id="l33.1443" class="difflineminus">-    if (! sink)</span>
<a href="#l33.1444"></a><span id="l33.1444" class="difflineminus">-        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l33.1445"></a><span id="l33.1445" class="difflineminus">-</span>
<a href="#l33.1446"></a><span id="l33.1446" class="difflineminus">-    NS_ADDREF(sink);</span>
<a href="#l33.1447"></a><span id="l33.1447" class="difflineminus">-    *aResult = sink;</span>
<a href="#l33.1448"></a><span id="l33.1448" class="difflineminus">-    return NS_OK;</span>
<a href="#l33.1449"></a><span id="l33.1449" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1">deleted file mode 100644</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineminus">--- a/rdf/base/nsRDFResource.cpp</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineplus">+++ /dev/null</span>
<a href="#l34.4"></a><span id="l34.4" class="difflineat">@@ -1,220 +0,0 @@</span>
<a href="#l34.5"></a><span id="l34.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l34.6"></a><span id="l34.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l34.7"></a><span id="l34.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l34.8"></a><span id="l34.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l34.9"></a><span id="l34.9" class="difflineminus">-</span>
<a href="#l34.10"></a><span id="l34.10" class="difflineminus">-#include &quot;nsRDFResource.h&quot;</span>
<a href="#l34.11"></a><span id="l34.11" class="difflineminus">-#include &quot;nsIServiceManager.h&quot;</span>
<a href="#l34.12"></a><span id="l34.12" class="difflineminus">-#include &quot;nsIRDFDelegateFactory.h&quot;</span>
<a href="#l34.13"></a><span id="l34.13" class="difflineminus">-#include &quot;nsIRDFService.h&quot;</span>
<a href="#l34.14"></a><span id="l34.14" class="difflineminus">-#include &quot;nsRDFCID.h&quot;</span>
<a href="#l34.15"></a><span id="l34.15" class="difflineminus">-#include &quot;mozilla/Logging.h&quot;</span>
<a href="#l34.16"></a><span id="l34.16" class="difflineminus">-#include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l34.17"></a><span id="l34.17" class="difflineminus">-#include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l34.18"></a><span id="l34.18" class="difflineminus">-</span>
<a href="#l34.19"></a><span id="l34.19" class="difflineminus">-static NS_DEFINE_CID(kRDFServiceCID, NS_RDFSERVICE_CID);</span>
<a href="#l34.20"></a><span id="l34.20" class="difflineminus">-</span>
<a href="#l34.21"></a><span id="l34.21" class="difflineminus">-nsIRDFService* nsRDFResource::gRDFService = nullptr;</span>
<a href="#l34.22"></a><span id="l34.22" class="difflineminus">-nsrefcnt nsRDFResource::gRDFServiceRefCnt = 0;</span>
<a href="#l34.23"></a><span id="l34.23" class="difflineminus">-</span>
<a href="#l34.24"></a><span id="l34.24" class="difflineminus">-////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l34.25"></a><span id="l34.25" class="difflineminus">-</span>
<a href="#l34.26"></a><span id="l34.26" class="difflineminus">-nsRDFResource::nsRDFResource(void)</span>
<a href="#l34.27"></a><span id="l34.27" class="difflineminus">-    : mDelegates(nullptr)</span>
<a href="#l34.28"></a><span id="l34.28" class="difflineminus">-{</span>
<a href="#l34.29"></a><span id="l34.29" class="difflineminus">-}</span>
<a href="#l34.30"></a><span id="l34.30" class="difflineminus">-</span>
<a href="#l34.31"></a><span id="l34.31" class="difflineminus">-nsRDFResource::~nsRDFResource(void)</span>
<a href="#l34.32"></a><span id="l34.32" class="difflineminus">-{</span>
<a href="#l34.33"></a><span id="l34.33" class="difflineminus">-    // Release all of the delegate objects</span>
<a href="#l34.34"></a><span id="l34.34" class="difflineminus">-    while (mDelegates) {</span>
<a href="#l34.35"></a><span id="l34.35" class="difflineminus">-        DelegateEntry* doomed = mDelegates;</span>
<a href="#l34.36"></a><span id="l34.36" class="difflineminus">-        mDelegates = mDelegates-&gt;mNext;</span>
<a href="#l34.37"></a><span id="l34.37" class="difflineminus">-        delete doomed;</span>
<a href="#l34.38"></a><span id="l34.38" class="difflineminus">-    }</span>
<a href="#l34.39"></a><span id="l34.39" class="difflineminus">-</span>
<a href="#l34.40"></a><span id="l34.40" class="difflineminus">-    if (!gRDFService)</span>
<a href="#l34.41"></a><span id="l34.41" class="difflineminus">-        return;</span>
<a href="#l34.42"></a><span id="l34.42" class="difflineminus">-</span>
<a href="#l34.43"></a><span id="l34.43" class="difflineminus">-    gRDFService-&gt;UnregisterResource(this);</span>
<a href="#l34.44"></a><span id="l34.44" class="difflineminus">-</span>
<a href="#l34.45"></a><span id="l34.45" class="difflineminus">-    if (--gRDFServiceRefCnt == 0)</span>
<a href="#l34.46"></a><span id="l34.46" class="difflineminus">-        NS_RELEASE(gRDFService);</span>
<a href="#l34.47"></a><span id="l34.47" class="difflineminus">-}</span>
<a href="#l34.48"></a><span id="l34.48" class="difflineminus">-</span>
<a href="#l34.49"></a><span id="l34.49" class="difflineminus">-NS_IMPL_ISUPPORTS(nsRDFResource, nsIRDFResource, nsIRDFNode)</span>
<a href="#l34.50"></a><span id="l34.50" class="difflineminus">-</span>
<a href="#l34.51"></a><span id="l34.51" class="difflineminus">-////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l34.52"></a><span id="l34.52" class="difflineminus">-// nsIRDFNode methods:</span>
<a href="#l34.53"></a><span id="l34.53" class="difflineminus">-</span>
<a href="#l34.54"></a><span id="l34.54" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l34.55"></a><span id="l34.55" class="difflineminus">-nsRDFResource::EqualsNode(nsIRDFNode* aNode, bool* aResult)</span>
<a href="#l34.56"></a><span id="l34.56" class="difflineminus">-{</span>
<a href="#l34.57"></a><span id="l34.57" class="difflineminus">-    NS_ASSERTION(aNode != nullptr, &quot;null ptr&quot;);</span>
<a href="#l34.58"></a><span id="l34.58" class="difflineminus">-    if (! aNode)</span>
<a href="#l34.59"></a><span id="l34.59" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l34.60"></a><span id="l34.60" class="difflineminus">-</span>
<a href="#l34.61"></a><span id="l34.61" class="difflineminus">-    nsresult rv;</span>
<a href="#l34.62"></a><span id="l34.62" class="difflineminus">-    nsIRDFResource* resource;</span>
<a href="#l34.63"></a><span id="l34.63" class="difflineminus">-    rv = aNode-&gt;QueryInterface(NS_GET_IID(nsIRDFResource), (void**)&amp;resource);</span>
<a href="#l34.64"></a><span id="l34.64" class="difflineminus">-    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l34.65"></a><span id="l34.65" class="difflineminus">-        *aResult = (static_cast&lt;nsIRDFResource*&gt;(this) == resource);</span>
<a href="#l34.66"></a><span id="l34.66" class="difflineminus">-        NS_RELEASE(resource);</span>
<a href="#l34.67"></a><span id="l34.67" class="difflineminus">-        return NS_OK;</span>
<a href="#l34.68"></a><span id="l34.68" class="difflineminus">-    }</span>
<a href="#l34.69"></a><span id="l34.69" class="difflineminus">-    if (rv == NS_NOINTERFACE) {</span>
<a href="#l34.70"></a><span id="l34.70" class="difflineminus">-        *aResult = false;</span>
<a href="#l34.71"></a><span id="l34.71" class="difflineminus">-        return NS_OK;</span>
<a href="#l34.72"></a><span id="l34.72" class="difflineminus">-    }</span>
<a href="#l34.73"></a><span id="l34.73" class="difflineminus">-</span>
<a href="#l34.74"></a><span id="l34.74" class="difflineminus">-    return rv;</span>
<a href="#l34.75"></a><span id="l34.75" class="difflineminus">-}</span>
<a href="#l34.76"></a><span id="l34.76" class="difflineminus">-</span>
<a href="#l34.77"></a><span id="l34.77" class="difflineminus">-////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l34.78"></a><span id="l34.78" class="difflineminus">-// nsIRDFResource methods:</span>
<a href="#l34.79"></a><span id="l34.79" class="difflineminus">-</span>
<a href="#l34.80"></a><span id="l34.80" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l34.81"></a><span id="l34.81" class="difflineminus">-nsRDFResource::Init(const char* aURI)</span>
<a href="#l34.82"></a><span id="l34.82" class="difflineminus">-{</span>
<a href="#l34.83"></a><span id="l34.83" class="difflineminus">-    NS_ASSERTION(aURI != nullptr, &quot;null ptr&quot;);</span>
<a href="#l34.84"></a><span id="l34.84" class="difflineminus">-    if (! aURI)</span>
<a href="#l34.85"></a><span id="l34.85" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l34.86"></a><span id="l34.86" class="difflineminus">-</span>
<a href="#l34.87"></a><span id="l34.87" class="difflineminus">-    mURI = aURI;</span>
<a href="#l34.88"></a><span id="l34.88" class="difflineminus">-</span>
<a href="#l34.89"></a><span id="l34.89" class="difflineminus">-    if (gRDFServiceRefCnt++ == 0) {</span>
<a href="#l34.90"></a><span id="l34.90" class="difflineminus">-        nsresult rv = CallGetService(kRDFServiceCID, &amp;gRDFService);</span>
<a href="#l34.91"></a><span id="l34.91" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l34.92"></a><span id="l34.92" class="difflineminus">-    }</span>
<a href="#l34.93"></a><span id="l34.93" class="difflineminus">-</span>
<a href="#l34.94"></a><span id="l34.94" class="difflineminus">-    // don't replace an existing resource with the same URI automatically</span>
<a href="#l34.95"></a><span id="l34.95" class="difflineminus">-    return gRDFService-&gt;RegisterResource(this, true);</span>
<a href="#l34.96"></a><span id="l34.96" class="difflineminus">-}</span>
<a href="#l34.97"></a><span id="l34.97" class="difflineminus">-</span>
<a href="#l34.98"></a><span id="l34.98" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l34.99"></a><span id="l34.99" class="difflineminus">-nsRDFResource::GetValue(char* *aURI)</span>
<a href="#l34.100"></a><span id="l34.100" class="difflineminus">-{</span>
<a href="#l34.101"></a><span id="l34.101" class="difflineminus">-    NS_ASSERTION(aURI, &quot;Null out param.&quot;);</span>
<a href="#l34.102"></a><span id="l34.102" class="difflineminus">-</span>
<a href="#l34.103"></a><span id="l34.103" class="difflineminus">-    *aURI = ToNewCString(mURI);</span>
<a href="#l34.104"></a><span id="l34.104" class="difflineminus">-</span>
<a href="#l34.105"></a><span id="l34.105" class="difflineminus">-    if (!*aURI)</span>
<a href="#l34.106"></a><span id="l34.106" class="difflineminus">-        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l34.107"></a><span id="l34.107" class="difflineminus">-</span>
<a href="#l34.108"></a><span id="l34.108" class="difflineminus">-    return NS_OK;</span>
<a href="#l34.109"></a><span id="l34.109" class="difflineminus">-}</span>
<a href="#l34.110"></a><span id="l34.110" class="difflineminus">-</span>
<a href="#l34.111"></a><span id="l34.111" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l34.112"></a><span id="l34.112" class="difflineminus">-nsRDFResource::GetValueUTF8(nsACString&amp; aResult)</span>
<a href="#l34.113"></a><span id="l34.113" class="difflineminus">-{</span>
<a href="#l34.114"></a><span id="l34.114" class="difflineminus">-    aResult = mURI;</span>
<a href="#l34.115"></a><span id="l34.115" class="difflineminus">-    return NS_OK;</span>
<a href="#l34.116"></a><span id="l34.116" class="difflineminus">-}</span>
<a href="#l34.117"></a><span id="l34.117" class="difflineminus">-</span>
<a href="#l34.118"></a><span id="l34.118" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l34.119"></a><span id="l34.119" class="difflineminus">-nsRDFResource::GetValueConst(const char** aURI)</span>
<a href="#l34.120"></a><span id="l34.120" class="difflineminus">-{</span>
<a href="#l34.121"></a><span id="l34.121" class="difflineminus">-    *aURI = mURI.get();</span>
<a href="#l34.122"></a><span id="l34.122" class="difflineminus">-    return NS_OK;</span>
<a href="#l34.123"></a><span id="l34.123" class="difflineminus">-}</span>
<a href="#l34.124"></a><span id="l34.124" class="difflineminus">-</span>
<a href="#l34.125"></a><span id="l34.125" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l34.126"></a><span id="l34.126" class="difflineminus">-nsRDFResource::EqualsString(const char* aURI, bool* aResult)</span>
<a href="#l34.127"></a><span id="l34.127" class="difflineminus">-{</span>
<a href="#l34.128"></a><span id="l34.128" class="difflineminus">-    NS_ASSERTION(aURI != nullptr, &quot;null ptr&quot;);</span>
<a href="#l34.129"></a><span id="l34.129" class="difflineminus">-    if (! aURI)</span>
<a href="#l34.130"></a><span id="l34.130" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l34.131"></a><span id="l34.131" class="difflineminus">-</span>
<a href="#l34.132"></a><span id="l34.132" class="difflineminus">-    NS_ASSERTION(aResult, &quot;null ptr&quot;);</span>
<a href="#l34.133"></a><span id="l34.133" class="difflineminus">-</span>
<a href="#l34.134"></a><span id="l34.134" class="difflineminus">-    *aResult = mURI.Equals(aURI);</span>
<a href="#l34.135"></a><span id="l34.135" class="difflineminus">-    return NS_OK;</span>
<a href="#l34.136"></a><span id="l34.136" class="difflineminus">-}</span>
<a href="#l34.137"></a><span id="l34.137" class="difflineminus">-</span>
<a href="#l34.138"></a><span id="l34.138" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l34.139"></a><span id="l34.139" class="difflineminus">-nsRDFResource::GetDelegate(const char* aKey, REFNSIID aIID, void** aResult)</span>
<a href="#l34.140"></a><span id="l34.140" class="difflineminus">-{</span>
<a href="#l34.141"></a><span id="l34.141" class="difflineminus">-    NS_ASSERTION(aKey != nullptr, &quot;null ptr&quot;);</span>
<a href="#l34.142"></a><span id="l34.142" class="difflineminus">-    if (! aKey)</span>
<a href="#l34.143"></a><span id="l34.143" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l34.144"></a><span id="l34.144" class="difflineminus">-</span>
<a href="#l34.145"></a><span id="l34.145" class="difflineminus">-    nsresult rv;</span>
<a href="#l34.146"></a><span id="l34.146" class="difflineminus">-    *aResult = nullptr;</span>
<a href="#l34.147"></a><span id="l34.147" class="difflineminus">-</span>
<a href="#l34.148"></a><span id="l34.148" class="difflineminus">-    DelegateEntry* entry = mDelegates;</span>
<a href="#l34.149"></a><span id="l34.149" class="difflineminus">-    while (entry) {</span>
<a href="#l34.150"></a><span id="l34.150" class="difflineminus">-        if (entry-&gt;mKey.Equals(aKey)) {</span>
<a href="#l34.151"></a><span id="l34.151" class="difflineminus">-            rv = entry-&gt;mDelegate-&gt;QueryInterface(aIID, aResult);</span>
<a href="#l34.152"></a><span id="l34.152" class="difflineminus">-            return rv;</span>
<a href="#l34.153"></a><span id="l34.153" class="difflineminus">-        }</span>
<a href="#l34.154"></a><span id="l34.154" class="difflineminus">-</span>
<a href="#l34.155"></a><span id="l34.155" class="difflineminus">-        entry = entry-&gt;mNext;</span>
<a href="#l34.156"></a><span id="l34.156" class="difflineminus">-    }</span>
<a href="#l34.157"></a><span id="l34.157" class="difflineminus">-</span>
<a href="#l34.158"></a><span id="l34.158" class="difflineminus">-    // Construct a ContractID of the form &quot;@mozilla.org/rdf/delegate/[key]/[scheme];1</span>
<a href="#l34.159"></a><span id="l34.159" class="difflineminus">-    nsAutoCString contractID(NS_RDF_DELEGATEFACTORY_CONTRACTID_PREFIX);</span>
<a href="#l34.160"></a><span id="l34.160" class="difflineminus">-    contractID.Append(aKey);</span>
<a href="#l34.161"></a><span id="l34.161" class="difflineminus">-    contractID.AppendLiteral(&quot;&amp;scheme=&quot;);</span>
<a href="#l34.162"></a><span id="l34.162" class="difflineminus">-</span>
<a href="#l34.163"></a><span id="l34.163" class="difflineminus">-    int32_t i = mURI.FindChar(':');</span>
<a href="#l34.164"></a><span id="l34.164" class="difflineminus">-    contractID += StringHead(mURI, i);</span>
<a href="#l34.165"></a><span id="l34.165" class="difflineminus">-</span>
<a href="#l34.166"></a><span id="l34.166" class="difflineminus">-    nsCOMPtr&lt;nsIRDFDelegateFactory&gt; delegateFactory =</span>
<a href="#l34.167"></a><span id="l34.167" class="difflineminus">-             do_CreateInstance(contractID.get(), &amp;rv);</span>
<a href="#l34.168"></a><span id="l34.168" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l34.169"></a><span id="l34.169" class="difflineminus">-</span>
<a href="#l34.170"></a><span id="l34.170" class="difflineminus">-    rv = delegateFactory-&gt;CreateDelegate(this, aKey, aIID, aResult);</span>
<a href="#l34.171"></a><span id="l34.171" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l34.172"></a><span id="l34.172" class="difflineminus">-</span>
<a href="#l34.173"></a><span id="l34.173" class="difflineminus">-    // Okay, we've successfully created a delegate. Let's remember it.</span>
<a href="#l34.174"></a><span id="l34.174" class="difflineminus">-    entry = new DelegateEntry;</span>
<a href="#l34.175"></a><span id="l34.175" class="difflineminus">-    if (! entry) {</span>
<a href="#l34.176"></a><span id="l34.176" class="difflineminus">-        NS_RELEASE(*reinterpret_cast&lt;nsISupports**&gt;(aResult));</span>
<a href="#l34.177"></a><span id="l34.177" class="difflineminus">-        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l34.178"></a><span id="l34.178" class="difflineminus">-    }</span>
<a href="#l34.179"></a><span id="l34.179" class="difflineminus">-</span>
<a href="#l34.180"></a><span id="l34.180" class="difflineminus">-    entry-&gt;mKey      = aKey;</span>
<a href="#l34.181"></a><span id="l34.181" class="difflineminus">-    entry-&gt;mDelegate = do_QueryInterface(*reinterpret_cast&lt;nsISupports**&gt;(aResult), &amp;rv);</span>
<a href="#l34.182"></a><span id="l34.182" class="difflineminus">-    if (NS_FAILED(rv)) {</span>
<a href="#l34.183"></a><span id="l34.183" class="difflineminus">-        NS_ERROR(&quot;nsRDFResource::GetDelegate(): can't QI to nsISupports!&quot;);</span>
<a href="#l34.184"></a><span id="l34.184" class="difflineminus">-</span>
<a href="#l34.185"></a><span id="l34.185" class="difflineminus">-        delete entry;</span>
<a href="#l34.186"></a><span id="l34.186" class="difflineminus">-        NS_RELEASE(*reinterpret_cast&lt;nsISupports**&gt;(aResult));</span>
<a href="#l34.187"></a><span id="l34.187" class="difflineminus">-        return NS_ERROR_FAILURE;</span>
<a href="#l34.188"></a><span id="l34.188" class="difflineminus">-    }</span>
<a href="#l34.189"></a><span id="l34.189" class="difflineminus">-</span>
<a href="#l34.190"></a><span id="l34.190" class="difflineminus">-    entry-&gt;mNext     = mDelegates;</span>
<a href="#l34.191"></a><span id="l34.191" class="difflineminus">-</span>
<a href="#l34.192"></a><span id="l34.192" class="difflineminus">-    mDelegates = entry;</span>
<a href="#l34.193"></a><span id="l34.193" class="difflineminus">-</span>
<a href="#l34.194"></a><span id="l34.194" class="difflineminus">-    return NS_OK;</span>
<a href="#l34.195"></a><span id="l34.195" class="difflineminus">-}</span>
<a href="#l34.196"></a><span id="l34.196" class="difflineminus">-</span>
<a href="#l34.197"></a><span id="l34.197" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l34.198"></a><span id="l34.198" class="difflineminus">-nsRDFResource::ReleaseDelegate(const char* aKey)</span>
<a href="#l34.199"></a><span id="l34.199" class="difflineminus">-{</span>
<a href="#l34.200"></a><span id="l34.200" class="difflineminus">-    NS_ASSERTION(aKey != nullptr, &quot;null ptr&quot;);</span>
<a href="#l34.201"></a><span id="l34.201" class="difflineminus">-    if (! aKey)</span>
<a href="#l34.202"></a><span id="l34.202" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l34.203"></a><span id="l34.203" class="difflineminus">-</span>
<a href="#l34.204"></a><span id="l34.204" class="difflineminus">-    DelegateEntry* entry = mDelegates;</span>
<a href="#l34.205"></a><span id="l34.205" class="difflineminus">-    DelegateEntry** link = &amp;mDelegates;</span>
<a href="#l34.206"></a><span id="l34.206" class="difflineminus">-</span>
<a href="#l34.207"></a><span id="l34.207" class="difflineminus">-    while (entry) {</span>
<a href="#l34.208"></a><span id="l34.208" class="difflineminus">-        if (entry-&gt;mKey.Equals(aKey)) {</span>
<a href="#l34.209"></a><span id="l34.209" class="difflineminus">-            *link = entry-&gt;mNext;</span>
<a href="#l34.210"></a><span id="l34.210" class="difflineminus">-            delete entry;</span>
<a href="#l34.211"></a><span id="l34.211" class="difflineminus">-            return NS_OK;</span>
<a href="#l34.212"></a><span id="l34.212" class="difflineminus">-        }</span>
<a href="#l34.213"></a><span id="l34.213" class="difflineminus">-</span>
<a href="#l34.214"></a><span id="l34.214" class="difflineminus">-        link = &amp;(entry-&gt;mNext);</span>
<a href="#l34.215"></a><span id="l34.215" class="difflineminus">-        entry = entry-&gt;mNext;</span>
<a href="#l34.216"></a><span id="l34.216" class="difflineminus">-    }</span>
<a href="#l34.217"></a><span id="l34.217" class="difflineminus">-</span>
<a href="#l34.218"></a><span id="l34.218" class="difflineminus">-    NS_WARNING(&quot;nsRDFResource::ReleaseDelegate() no delegate found&quot;);</span>
<a href="#l34.219"></a><span id="l34.219" class="difflineminus">-    return NS_OK;</span>
<a href="#l34.220"></a><span id="l34.220" class="difflineminus">-}</span>
<a href="#l34.221"></a><span id="l34.221" class="difflineminus">-</span>
<a href="#l34.222"></a><span id="l34.222" class="difflineminus">-</span>
<a href="#l34.223"></a><span id="l34.223" class="difflineminus">-</span>
<a href="#l34.224"></a><span id="l34.224" class="difflineminus">-////////////////////////////////////////////////////////////////////////////////</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l35.1"></a><span id="l35.1">deleted file mode 100644</span>
<a href="#l35.2"></a><span id="l35.2" class="difflineminus">--- a/rdf/base/nsRDFResource.h</span>
<a href="#l35.3"></a><span id="l35.3" class="difflineplus">+++ /dev/null</span>
<a href="#l35.4"></a><span id="l35.4" class="difflineat">@@ -1,59 +0,0 @@</span>
<a href="#l35.5"></a><span id="l35.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l35.6"></a><span id="l35.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l35.7"></a><span id="l35.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l35.8"></a><span id="l35.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l35.9"></a><span id="l35.9" class="difflineminus">-</span>
<a href="#l35.10"></a><span id="l35.10" class="difflineminus">-#ifndef nsRDFResource_h__</span>
<a href="#l35.11"></a><span id="l35.11" class="difflineminus">-#define nsRDFResource_h__</span>
<a href="#l35.12"></a><span id="l35.12" class="difflineminus">-</span>
<a href="#l35.13"></a><span id="l35.13" class="difflineminus">-#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l35.14"></a><span id="l35.14" class="difflineminus">-#include &quot;nsIRDFNode.h&quot;</span>
<a href="#l35.15"></a><span id="l35.15" class="difflineminus">-#include &quot;nsIRDFResource.h&quot;</span>
<a href="#l35.16"></a><span id="l35.16" class="difflineminus">-#include &quot;nscore.h&quot;</span>
<a href="#l35.17"></a><span id="l35.17" class="difflineminus">-#include &quot;nsString.h&quot;</span>
<a href="#l35.18"></a><span id="l35.18" class="difflineminus">-#include &quot;rdf.h&quot;</span>
<a href="#l35.19"></a><span id="l35.19" class="difflineminus">-</span>
<a href="#l35.20"></a><span id="l35.20" class="difflineminus">-class nsIRDFService;</span>
<a href="#l35.21"></a><span id="l35.21" class="difflineminus">-</span>
<a href="#l35.22"></a><span id="l35.22" class="difflineminus">-/**</span>
<a href="#l35.23"></a><span id="l35.23" class="difflineminus">- * This simple base class implements nsIRDFResource, and can be used as a</span>
<a href="#l35.24"></a><span id="l35.24" class="difflineminus">- * superclass for more sophisticated resource implementations.</span>
<a href="#l35.25"></a><span id="l35.25" class="difflineminus">- */</span>
<a href="#l35.26"></a><span id="l35.26" class="difflineminus">-class nsRDFResource : public nsIRDFResource {</span>
<a href="#l35.27"></a><span id="l35.27" class="difflineminus">-public:</span>
<a href="#l35.28"></a><span id="l35.28" class="difflineminus">-</span>
<a href="#l35.29"></a><span id="l35.29" class="difflineminus">-    NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l35.30"></a><span id="l35.30" class="difflineminus">-</span>
<a href="#l35.31"></a><span id="l35.31" class="difflineminus">-    // nsIRDFNode methods:</span>
<a href="#l35.32"></a><span id="l35.32" class="difflineminus">-    NS_IMETHOD EqualsNode(nsIRDFNode* aNode, bool* aResult) override;</span>
<a href="#l35.33"></a><span id="l35.33" class="difflineminus">-</span>
<a href="#l35.34"></a><span id="l35.34" class="difflineminus">-    // nsIRDFResource methods:</span>
<a href="#l35.35"></a><span id="l35.35" class="difflineminus">-    NS_IMETHOD Init(const char* aURI) override;</span>
<a href="#l35.36"></a><span id="l35.36" class="difflineminus">-    NS_IMETHOD GetValue(char* *aURI) override;</span>
<a href="#l35.37"></a><span id="l35.37" class="difflineminus">-    NS_IMETHOD GetValueUTF8(nsACString&amp; aResult) override;</span>
<a href="#l35.38"></a><span id="l35.38" class="difflineminus">-    NS_IMETHOD GetValueConst(const char** aURI) override;</span>
<a href="#l35.39"></a><span id="l35.39" class="difflineminus">-    NS_IMETHOD EqualsString(const char* aURI, bool* aResult) override;</span>
<a href="#l35.40"></a><span id="l35.40" class="difflineminus">-    NS_IMETHOD GetDelegate(const char* aKey, REFNSIID aIID, void** aResult) override;</span>
<a href="#l35.41"></a><span id="l35.41" class="difflineminus">-    NS_IMETHOD ReleaseDelegate(const char* aKey) override;</span>
<a href="#l35.42"></a><span id="l35.42" class="difflineminus">-</span>
<a href="#l35.43"></a><span id="l35.43" class="difflineminus">-    // nsRDFResource methods:</span>
<a href="#l35.44"></a><span id="l35.44" class="difflineminus">-    nsRDFResource(void);</span>
<a href="#l35.45"></a><span id="l35.45" class="difflineminus">-</span>
<a href="#l35.46"></a><span id="l35.46" class="difflineminus">-protected:</span>
<a href="#l35.47"></a><span id="l35.47" class="difflineminus">-    virtual ~nsRDFResource(void);</span>
<a href="#l35.48"></a><span id="l35.48" class="difflineminus">-    static nsIRDFService* gRDFService;</span>
<a href="#l35.49"></a><span id="l35.49" class="difflineminus">-    static nsrefcnt gRDFServiceRefCnt;</span>
<a href="#l35.50"></a><span id="l35.50" class="difflineminus">-</span>
<a href="#l35.51"></a><span id="l35.51" class="difflineminus">-protected:</span>
<a href="#l35.52"></a><span id="l35.52" class="difflineminus">-    nsCString mURI;</span>
<a href="#l35.53"></a><span id="l35.53" class="difflineminus">-</span>
<a href="#l35.54"></a><span id="l35.54" class="difflineminus">-    struct DelegateEntry {</span>
<a href="#l35.55"></a><span id="l35.55" class="difflineminus">-        nsCString             mKey;</span>
<a href="#l35.56"></a><span id="l35.56" class="difflineminus">-        nsCOMPtr&lt;nsISupports&gt; mDelegate;</span>
<a href="#l35.57"></a><span id="l35.57" class="difflineminus">-        DelegateEntry*        mNext;</span>
<a href="#l35.58"></a><span id="l35.58" class="difflineminus">-    };</span>
<a href="#l35.59"></a><span id="l35.59" class="difflineminus">-</span>
<a href="#l35.60"></a><span id="l35.60" class="difflineminus">-    DelegateEntry* mDelegates;</span>
<a href="#l35.61"></a><span id="l35.61" class="difflineminus">-};</span>
<a href="#l35.62"></a><span id="l35.62" class="difflineminus">-</span>
<a href="#l35.63"></a><span id="l35.63" class="difflineminus">-#endif // nsRDFResource_h__</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l36.1"></a><span id="l36.1">deleted file mode 100644</span>
<a href="#l36.2"></a><span id="l36.2" class="difflineminus">--- a/rdf/base/nsRDFService.cpp</span>
<a href="#l36.3"></a><span id="l36.3" class="difflineplus">+++ /dev/null</span>
<a href="#l36.4"></a><span id="l36.4" class="difflineat">@@ -1,1540 +0,0 @@</span>
<a href="#l36.5"></a><span id="l36.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*-</span>
<a href="#l36.6"></a><span id="l36.6" class="difflineminus">- *</span>
<a href="#l36.7"></a><span id="l36.7" class="difflineminus">- * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l36.8"></a><span id="l36.8" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l36.9"></a><span id="l36.9" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/.  */</span>
<a href="#l36.10"></a><span id="l36.10" class="difflineminus">-</span>
<a href="#l36.11"></a><span id="l36.11" class="difflineminus">-/*</span>
<a href="#l36.12"></a><span id="l36.12" class="difflineminus">-</span>
<a href="#l36.13"></a><span id="l36.13" class="difflineminus">-  This file provides the implementation for the RDF service manager.</span>
<a href="#l36.14"></a><span id="l36.14" class="difflineminus">-</span>
<a href="#l36.15"></a><span id="l36.15" class="difflineminus">-  TO DO</span>
<a href="#l36.16"></a><span id="l36.16" class="difflineminus">-  -----</span>
<a href="#l36.17"></a><span id="l36.17" class="difflineminus">-</span>
<a href="#l36.18"></a><span id="l36.18" class="difflineminus">-  1) Implement the CreateDataBase() methods.</span>
<a href="#l36.19"></a><span id="l36.19" class="difflineminus">-</span>
<a href="#l36.20"></a><span id="l36.20" class="difflineminus">-  2) Cache date and int literals.</span>
<a href="#l36.21"></a><span id="l36.21" class="difflineminus">-</span>
<a href="#l36.22"></a><span id="l36.22" class="difflineminus">- */</span>
<a href="#l36.23"></a><span id="l36.23" class="difflineminus">-</span>
<a href="#l36.24"></a><span id="l36.24" class="difflineminus">-#include &quot;nsRDFService.h&quot;</span>
<a href="#l36.25"></a><span id="l36.25" class="difflineminus">-#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l36.26"></a><span id="l36.26" class="difflineminus">-#include &quot;nsAutoPtr.h&quot;</span>
<a href="#l36.27"></a><span id="l36.27" class="difflineminus">-#include &quot;nsMemory.h&quot;</span>
<a href="#l36.28"></a><span id="l36.28" class="difflineminus">-#include &quot;nsAtom.h&quot;</span>
<a href="#l36.29"></a><span id="l36.29" class="difflineminus">-#include &quot;nsIComponentManager.h&quot;</span>
<a href="#l36.30"></a><span id="l36.30" class="difflineminus">-#include &quot;nsIRDFDataSource.h&quot;</span>
<a href="#l36.31"></a><span id="l36.31" class="difflineminus">-#include &quot;nsIRDFNode.h&quot;</span>
<a href="#l36.32"></a><span id="l36.32" class="difflineminus">-#include &quot;nsIRDFRemoteDataSource.h&quot;</span>
<a href="#l36.33"></a><span id="l36.33" class="difflineminus">-#include &quot;nsIServiceManager.h&quot;</span>
<a href="#l36.34"></a><span id="l36.34" class="difflineminus">-#include &quot;nsIFactory.h&quot;</span>
<a href="#l36.35"></a><span id="l36.35" class="difflineminus">-#include &quot;nsRDFCID.h&quot;</span>
<a href="#l36.36"></a><span id="l36.36" class="difflineminus">-#include &quot;nsString.h&quot;</span>
<a href="#l36.37"></a><span id="l36.37" class="difflineminus">-#include &quot;nsNetUtil.h&quot;</span>
<a href="#l36.38"></a><span id="l36.38" class="difflineminus">-#include &quot;nsIURI.h&quot;</span>
<a href="#l36.39"></a><span id="l36.39" class="difflineminus">-#include &quot;PLDHashTable.h&quot;</span>
<a href="#l36.40"></a><span id="l36.40" class="difflineminus">-#include &quot;plhash.h&quot;</span>
<a href="#l36.41"></a><span id="l36.41" class="difflineminus">-#include &quot;plstr.h&quot;</span>
<a href="#l36.42"></a><span id="l36.42" class="difflineminus">-#include &quot;mozilla/Logging.h&quot;</span>
<a href="#l36.43"></a><span id="l36.43" class="difflineminus">-#include &quot;prprf.h&quot;</span>
<a href="#l36.44"></a><span id="l36.44" class="difflineminus">-#include &quot;rdf.h&quot;</span>
<a href="#l36.45"></a><span id="l36.45" class="difflineminus">-#include &quot;nsCRT.h&quot;</span>
<a href="#l36.46"></a><span id="l36.46" class="difflineminus">-#include &quot;nsCRTGlue.h&quot;</span>
<a href="#l36.47"></a><span id="l36.47" class="difflineminus">-#include &quot;mozilla/HashFunctions.h&quot;</span>
<a href="#l36.48"></a><span id="l36.48" class="difflineminus">-#include &quot;mozilla/IntegerPrintfMacros.h&quot;</span>
<a href="#l36.49"></a><span id="l36.49" class="difflineminus">-</span>
<a href="#l36.50"></a><span id="l36.50" class="difflineminus">-using namespace mozilla;</span>
<a href="#l36.51"></a><span id="l36.51" class="difflineminus">-</span>
<a href="#l36.52"></a><span id="l36.52" class="difflineminus">-////////////////////////////////////////////////////////////////////////</span>
<a href="#l36.53"></a><span id="l36.53" class="difflineminus">-</span>
<a href="#l36.54"></a><span id="l36.54" class="difflineminus">-static NS_DEFINE_CID(kRDFXMLDataSourceCID,    NS_RDFXMLDATASOURCE_CID);</span>
<a href="#l36.55"></a><span id="l36.55" class="difflineminus">-static NS_DEFINE_CID(kRDFDefaultResourceCID,  NS_RDFDEFAULTRESOURCE_CID);</span>
<a href="#l36.56"></a><span id="l36.56" class="difflineminus">-</span>
<a href="#l36.57"></a><span id="l36.57" class="difflineminus">-static NS_DEFINE_IID(kIRDFLiteralIID,         NS_IRDFLITERAL_IID);</span>
<a href="#l36.58"></a><span id="l36.58" class="difflineminus">-static NS_DEFINE_IID(kIRDFDateIID,         NS_IRDFDATE_IID);</span>
<a href="#l36.59"></a><span id="l36.59" class="difflineminus">-static NS_DEFINE_IID(kIRDFIntIID,         NS_IRDFINT_IID);</span>
<a href="#l36.60"></a><span id="l36.60" class="difflineminus">-static NS_DEFINE_IID(kIRDFNodeIID,            NS_IRDFNODE_IID);</span>
<a href="#l36.61"></a><span id="l36.61" class="difflineminus">-static NS_DEFINE_IID(kISupportsIID,           NS_ISUPPORTS_IID);</span>
<a href="#l36.62"></a><span id="l36.62" class="difflineminus">-</span>
<a href="#l36.63"></a><span id="l36.63" class="difflineminus">-static LazyLogModule gLog(&quot;nsRDFService&quot;);</span>
<a href="#l36.64"></a><span id="l36.64" class="difflineminus">-</span>
<a href="#l36.65"></a><span id="l36.65" class="difflineminus">-class BlobImpl;</span>
<a href="#l36.66"></a><span id="l36.66" class="difflineminus">-</span>
<a href="#l36.67"></a><span id="l36.67" class="difflineminus">-// These functions are copied from nsprpub/lib/ds/plhash.c, with one</span>
<a href="#l36.68"></a><span id="l36.68" class="difflineminus">-// change to free the key in DataSourceFreeEntry.</span>
<a href="#l36.69"></a><span id="l36.69" class="difflineminus">-// XXX sigh, why were DefaultAllocTable et. al. declared static, anyway?</span>
<a href="#l36.70"></a><span id="l36.70" class="difflineminus">-</span>
<a href="#l36.71"></a><span id="l36.71" class="difflineminus">-static void *</span>
<a href="#l36.72"></a><span id="l36.72" class="difflineminus">-DataSourceAllocTable(void *pool, size_t size)</span>
<a href="#l36.73"></a><span id="l36.73" class="difflineminus">-{</span>
<a href="#l36.74"></a><span id="l36.74" class="difflineminus">-    return malloc(size);</span>
<a href="#l36.75"></a><span id="l36.75" class="difflineminus">-}</span>
<a href="#l36.76"></a><span id="l36.76" class="difflineminus">-</span>
<a href="#l36.77"></a><span id="l36.77" class="difflineminus">-static void</span>
<a href="#l36.78"></a><span id="l36.78" class="difflineminus">-DataSourceFreeTable(void *pool, void *item)</span>
<a href="#l36.79"></a><span id="l36.79" class="difflineminus">-{</span>
<a href="#l36.80"></a><span id="l36.80" class="difflineminus">-    free(item);</span>
<a href="#l36.81"></a><span id="l36.81" class="difflineminus">-}</span>
<a href="#l36.82"></a><span id="l36.82" class="difflineminus">-</span>
<a href="#l36.83"></a><span id="l36.83" class="difflineminus">-static PLHashEntry *</span>
<a href="#l36.84"></a><span id="l36.84" class="difflineminus">-DataSourceAllocEntry(void *pool, const void *key)</span>
<a href="#l36.85"></a><span id="l36.85" class="difflineminus">-{</span>
<a href="#l36.86"></a><span id="l36.86" class="difflineminus">-    return (PLHashEntry*) malloc(sizeof(PLHashEntry));</span>
<a href="#l36.87"></a><span id="l36.87" class="difflineminus">-}</span>
<a href="#l36.88"></a><span id="l36.88" class="difflineminus">-</span>
<a href="#l36.89"></a><span id="l36.89" class="difflineminus">-static void</span>
<a href="#l36.90"></a><span id="l36.90" class="difflineminus">-DataSourceFreeEntry(void *pool, PLHashEntry *he, unsigned flag)</span>
<a href="#l36.91"></a><span id="l36.91" class="difflineminus">-{</span>
<a href="#l36.92"></a><span id="l36.92" class="difflineminus">-    if (flag == HT_FREE_ENTRY) {</span>
<a href="#l36.93"></a><span id="l36.93" class="difflineminus">-        PL_strfree((char*) he-&gt;key);</span>
<a href="#l36.94"></a><span id="l36.94" class="difflineminus">-        free(he);</span>
<a href="#l36.95"></a><span id="l36.95" class="difflineminus">-    }</span>
<a href="#l36.96"></a><span id="l36.96" class="difflineminus">-}</span>
<a href="#l36.97"></a><span id="l36.97" class="difflineminus">-</span>
<a href="#l36.98"></a><span id="l36.98" class="difflineminus">-static PLHashAllocOps dataSourceHashAllocOps = {</span>
<a href="#l36.99"></a><span id="l36.99" class="difflineminus">-    DataSourceAllocTable, DataSourceFreeTable,</span>
<a href="#l36.100"></a><span id="l36.100" class="difflineminus">-    DataSourceAllocEntry, DataSourceFreeEntry</span>
<a href="#l36.101"></a><span id="l36.101" class="difflineminus">-};</span>
<a href="#l36.102"></a><span id="l36.102" class="difflineminus">-</span>
<a href="#l36.103"></a><span id="l36.103" class="difflineminus">-//----------------------------------------------------------------------</span>
<a href="#l36.104"></a><span id="l36.104" class="difflineminus">-//</span>
<a href="#l36.105"></a><span id="l36.105" class="difflineminus">-// For the mResources hashtable.</span>
<a href="#l36.106"></a><span id="l36.106" class="difflineminus">-//</span>
<a href="#l36.107"></a><span id="l36.107" class="difflineminus">-</span>
<a href="#l36.108"></a><span id="l36.108" class="difflineminus">-struct ResourceHashEntry : public PLDHashEntryHdr {</span>
<a href="#l36.109"></a><span id="l36.109" class="difflineminus">-    const char *mKey;</span>
<a href="#l36.110"></a><span id="l36.110" class="difflineminus">-    nsIRDFResource *mResource;</span>
<a href="#l36.111"></a><span id="l36.111" class="difflineminus">-</span>
<a href="#l36.112"></a><span id="l36.112" class="difflineminus">-    static PLDHashNumber</span>
<a href="#l36.113"></a><span id="l36.113" class="difflineminus">-    HashKey(const void *key)</span>
<a href="#l36.114"></a><span id="l36.114" class="difflineminus">-    {</span>
<a href="#l36.115"></a><span id="l36.115" class="difflineminus">-        return HashString(static_cast&lt;const char *&gt;(key));</span>
<a href="#l36.116"></a><span id="l36.116" class="difflineminus">-    }</span>
<a href="#l36.117"></a><span id="l36.117" class="difflineminus">-</span>
<a href="#l36.118"></a><span id="l36.118" class="difflineminus">-    static bool</span>
<a href="#l36.119"></a><span id="l36.119" class="difflineminus">-    MatchEntry(const PLDHashEntryHdr *hdr, const void *key)</span>
<a href="#l36.120"></a><span id="l36.120" class="difflineminus">-    {</span>
<a href="#l36.121"></a><span id="l36.121" class="difflineminus">-        const ResourceHashEntry *entry =</span>
<a href="#l36.122"></a><span id="l36.122" class="difflineminus">-            static_cast&lt;const ResourceHashEntry *&gt;(hdr);</span>
<a href="#l36.123"></a><span id="l36.123" class="difflineminus">-</span>
<a href="#l36.124"></a><span id="l36.124" class="difflineminus">-        return 0 == nsCRT::strcmp(static_cast&lt;const char *&gt;(key),</span>
<a href="#l36.125"></a><span id="l36.125" class="difflineminus">-                                  entry-&gt;mKey);</span>
<a href="#l36.126"></a><span id="l36.126" class="difflineminus">-    }</span>
<a href="#l36.127"></a><span id="l36.127" class="difflineminus">-};</span>
<a href="#l36.128"></a><span id="l36.128" class="difflineminus">-</span>
<a href="#l36.129"></a><span id="l36.129" class="difflineminus">-static const PLDHashTableOps gResourceTableOps = {</span>
<a href="#l36.130"></a><span id="l36.130" class="difflineminus">-    ResourceHashEntry::HashKey,</span>
<a href="#l36.131"></a><span id="l36.131" class="difflineminus">-    ResourceHashEntry::MatchEntry,</span>
<a href="#l36.132"></a><span id="l36.132" class="difflineminus">-    PLDHashTable::MoveEntryStub,</span>
<a href="#l36.133"></a><span id="l36.133" class="difflineminus">-    PLDHashTable::ClearEntryStub,</span>
<a href="#l36.134"></a><span id="l36.134" class="difflineminus">-    nullptr</span>
<a href="#l36.135"></a><span id="l36.135" class="difflineminus">-};</span>
<a href="#l36.136"></a><span id="l36.136" class="difflineminus">-</span>
<a href="#l36.137"></a><span id="l36.137" class="difflineminus">-// ----------------------------------------------------------------------</span>
<a href="#l36.138"></a><span id="l36.138" class="difflineminus">-//</span>
<a href="#l36.139"></a><span id="l36.139" class="difflineminus">-// For the mLiterals hashtable.</span>
<a href="#l36.140"></a><span id="l36.140" class="difflineminus">-//</span>
<a href="#l36.141"></a><span id="l36.141" class="difflineminus">-</span>
<a href="#l36.142"></a><span id="l36.142" class="difflineminus">-struct LiteralHashEntry : public PLDHashEntryHdr {</span>
<a href="#l36.143"></a><span id="l36.143" class="difflineminus">-    nsIRDFLiteral *mLiteral;</span>
<a href="#l36.144"></a><span id="l36.144" class="difflineminus">-    const char16_t *mKey;</span>
<a href="#l36.145"></a><span id="l36.145" class="difflineminus">-</span>
<a href="#l36.146"></a><span id="l36.146" class="difflineminus">-    static PLDHashNumber</span>
<a href="#l36.147"></a><span id="l36.147" class="difflineminus">-    HashKey(const void *key)</span>
<a href="#l36.148"></a><span id="l36.148" class="difflineminus">-    {</span>
<a href="#l36.149"></a><span id="l36.149" class="difflineminus">-        return HashString(static_cast&lt;const char16_t *&gt;(key));</span>
<a href="#l36.150"></a><span id="l36.150" class="difflineminus">-    }</span>
<a href="#l36.151"></a><span id="l36.151" class="difflineminus">-</span>
<a href="#l36.152"></a><span id="l36.152" class="difflineminus">-    static bool</span>
<a href="#l36.153"></a><span id="l36.153" class="difflineminus">-    MatchEntry(const PLDHashEntryHdr *hdr, const void *key)</span>
<a href="#l36.154"></a><span id="l36.154" class="difflineminus">-    {</span>
<a href="#l36.155"></a><span id="l36.155" class="difflineminus">-        const LiteralHashEntry *entry =</span>
<a href="#l36.156"></a><span id="l36.156" class="difflineminus">-            static_cast&lt;const LiteralHashEntry *&gt;(hdr);</span>
<a href="#l36.157"></a><span id="l36.157" class="difflineminus">-</span>
<a href="#l36.158"></a><span id="l36.158" class="difflineminus">-        return 0 == nsCRT::strcmp(static_cast&lt;const char16_t *&gt;(key),</span>
<a href="#l36.159"></a><span id="l36.159" class="difflineminus">-                                  entry-&gt;mKey);</span>
<a href="#l36.160"></a><span id="l36.160" class="difflineminus">-    }</span>
<a href="#l36.161"></a><span id="l36.161" class="difflineminus">-};</span>
<a href="#l36.162"></a><span id="l36.162" class="difflineminus">-</span>
<a href="#l36.163"></a><span id="l36.163" class="difflineminus">-static const PLDHashTableOps gLiteralTableOps = {</span>
<a href="#l36.164"></a><span id="l36.164" class="difflineminus">-    LiteralHashEntry::HashKey,</span>
<a href="#l36.165"></a><span id="l36.165" class="difflineminus">-    LiteralHashEntry::MatchEntry,</span>
<a href="#l36.166"></a><span id="l36.166" class="difflineminus">-    PLDHashTable::MoveEntryStub,</span>
<a href="#l36.167"></a><span id="l36.167" class="difflineminus">-    PLDHashTable::ClearEntryStub,</span>
<a href="#l36.168"></a><span id="l36.168" class="difflineminus">-    nullptr</span>
<a href="#l36.169"></a><span id="l36.169" class="difflineminus">-};</span>
<a href="#l36.170"></a><span id="l36.170" class="difflineminus">-</span>
<a href="#l36.171"></a><span id="l36.171" class="difflineminus">-// ----------------------------------------------------------------------</span>
<a href="#l36.172"></a><span id="l36.172" class="difflineminus">-//</span>
<a href="#l36.173"></a><span id="l36.173" class="difflineminus">-// For the mInts hashtable.</span>
<a href="#l36.174"></a><span id="l36.174" class="difflineminus">-//</span>
<a href="#l36.175"></a><span id="l36.175" class="difflineminus">-</span>
<a href="#l36.176"></a><span id="l36.176" class="difflineminus">-struct IntHashEntry : public PLDHashEntryHdr {</span>
<a href="#l36.177"></a><span id="l36.177" class="difflineminus">-    nsIRDFInt *mInt;</span>
<a href="#l36.178"></a><span id="l36.178" class="difflineminus">-    int32_t    mKey;</span>
<a href="#l36.179"></a><span id="l36.179" class="difflineminus">-</span>
<a href="#l36.180"></a><span id="l36.180" class="difflineminus">-    static PLDHashNumber</span>
<a href="#l36.181"></a><span id="l36.181" class="difflineminus">-    HashKey(const void *key)</span>
<a href="#l36.182"></a><span id="l36.182" class="difflineminus">-    {</span>
<a href="#l36.183"></a><span id="l36.183" class="difflineminus">-        return PLDHashNumber(*static_cast&lt;const int32_t *&gt;(key));</span>
<a href="#l36.184"></a><span id="l36.184" class="difflineminus">-    }</span>
<a href="#l36.185"></a><span id="l36.185" class="difflineminus">-</span>
<a href="#l36.186"></a><span id="l36.186" class="difflineminus">-    static bool</span>
<a href="#l36.187"></a><span id="l36.187" class="difflineminus">-    MatchEntry(const PLDHashEntryHdr *hdr, const void *key)</span>
<a href="#l36.188"></a><span id="l36.188" class="difflineminus">-    {</span>
<a href="#l36.189"></a><span id="l36.189" class="difflineminus">-        const IntHashEntry *entry =</span>
<a href="#l36.190"></a><span id="l36.190" class="difflineminus">-            static_cast&lt;const IntHashEntry *&gt;(hdr);</span>
<a href="#l36.191"></a><span id="l36.191" class="difflineminus">-</span>
<a href="#l36.192"></a><span id="l36.192" class="difflineminus">-        return *static_cast&lt;const int32_t *&gt;(key) == entry-&gt;mKey;</span>
<a href="#l36.193"></a><span id="l36.193" class="difflineminus">-    }</span>
<a href="#l36.194"></a><span id="l36.194" class="difflineminus">-};</span>
<a href="#l36.195"></a><span id="l36.195" class="difflineminus">-</span>
<a href="#l36.196"></a><span id="l36.196" class="difflineminus">-static const PLDHashTableOps gIntTableOps = {</span>
<a href="#l36.197"></a><span id="l36.197" class="difflineminus">-    IntHashEntry::HashKey,</span>
<a href="#l36.198"></a><span id="l36.198" class="difflineminus">-    IntHashEntry::MatchEntry,</span>
<a href="#l36.199"></a><span id="l36.199" class="difflineminus">-    PLDHashTable::MoveEntryStub,</span>
<a href="#l36.200"></a><span id="l36.200" class="difflineminus">-    PLDHashTable::ClearEntryStub,</span>
<a href="#l36.201"></a><span id="l36.201" class="difflineminus">-    nullptr</span>
<a href="#l36.202"></a><span id="l36.202" class="difflineminus">-};</span>
<a href="#l36.203"></a><span id="l36.203" class="difflineminus">-</span>
<a href="#l36.204"></a><span id="l36.204" class="difflineminus">-// ----------------------------------------------------------------------</span>
<a href="#l36.205"></a><span id="l36.205" class="difflineminus">-//</span>
<a href="#l36.206"></a><span id="l36.206" class="difflineminus">-// For the mDates hashtable.</span>
<a href="#l36.207"></a><span id="l36.207" class="difflineminus">-//</span>
<a href="#l36.208"></a><span id="l36.208" class="difflineminus">-</span>
<a href="#l36.209"></a><span id="l36.209" class="difflineminus">-struct DateHashEntry : public PLDHashEntryHdr {</span>
<a href="#l36.210"></a><span id="l36.210" class="difflineminus">-    nsIRDFDate *mDate;</span>
<a href="#l36.211"></a><span id="l36.211" class="difflineminus">-    PRTime      mKey;</span>
<a href="#l36.212"></a><span id="l36.212" class="difflineminus">-</span>
<a href="#l36.213"></a><span id="l36.213" class="difflineminus">-    static PLDHashNumber</span>
<a href="#l36.214"></a><span id="l36.214" class="difflineminus">-    HashKey(const void *key)</span>
<a href="#l36.215"></a><span id="l36.215" class="difflineminus">-    {</span>
<a href="#l36.216"></a><span id="l36.216" class="difflineminus">-        // xor the low 32 bits with the high 32 bits.</span>
<a href="#l36.217"></a><span id="l36.217" class="difflineminus">-        PRTime t = *static_cast&lt;const PRTime *&gt;(key);</span>
<a href="#l36.218"></a><span id="l36.218" class="difflineminus">-        int32_t h32 = int32_t(t &gt;&gt; 32);</span>
<a href="#l36.219"></a><span id="l36.219" class="difflineminus">-        int32_t l32 = int32_t(0xffffffff &amp; t);</span>
<a href="#l36.220"></a><span id="l36.220" class="difflineminus">-        return PLDHashNumber(l32 ^ h32);</span>
<a href="#l36.221"></a><span id="l36.221" class="difflineminus">-    }</span>
<a href="#l36.222"></a><span id="l36.222" class="difflineminus">-</span>
<a href="#l36.223"></a><span id="l36.223" class="difflineminus">-    static bool</span>
<a href="#l36.224"></a><span id="l36.224" class="difflineminus">-    MatchEntry(const PLDHashEntryHdr *hdr, const void *key)</span>
<a href="#l36.225"></a><span id="l36.225" class="difflineminus">-    {</span>
<a href="#l36.226"></a><span id="l36.226" class="difflineminus">-        const DateHashEntry *entry =</span>
<a href="#l36.227"></a><span id="l36.227" class="difflineminus">-            static_cast&lt;const DateHashEntry *&gt;(hdr);</span>
<a href="#l36.228"></a><span id="l36.228" class="difflineminus">-</span>
<a href="#l36.229"></a><span id="l36.229" class="difflineminus">-        return *static_cast&lt;const PRTime *&gt;(key) == entry-&gt;mKey;</span>
<a href="#l36.230"></a><span id="l36.230" class="difflineminus">-    }</span>
<a href="#l36.231"></a><span id="l36.231" class="difflineminus">-};</span>
<a href="#l36.232"></a><span id="l36.232" class="difflineminus">-</span>
<a href="#l36.233"></a><span id="l36.233" class="difflineminus">-static const PLDHashTableOps gDateTableOps = {</span>
<a href="#l36.234"></a><span id="l36.234" class="difflineminus">-    DateHashEntry::HashKey,</span>
<a href="#l36.235"></a><span id="l36.235" class="difflineminus">-    DateHashEntry::MatchEntry,</span>
<a href="#l36.236"></a><span id="l36.236" class="difflineminus">-    PLDHashTable::MoveEntryStub,</span>
<a href="#l36.237"></a><span id="l36.237" class="difflineminus">-    PLDHashTable::ClearEntryStub,</span>
<a href="#l36.238"></a><span id="l36.238" class="difflineminus">-    nullptr</span>
<a href="#l36.239"></a><span id="l36.239" class="difflineminus">-};</span>
<a href="#l36.240"></a><span id="l36.240" class="difflineminus">-</span>
<a href="#l36.241"></a><span id="l36.241" class="difflineminus">-class BlobImpl : public nsIRDFBlob</span>
<a href="#l36.242"></a><span id="l36.242" class="difflineminus">-{</span>
<a href="#l36.243"></a><span id="l36.243" class="difflineminus">-public:</span>
<a href="#l36.244"></a><span id="l36.244" class="difflineminus">-    struct Data {</span>
<a href="#l36.245"></a><span id="l36.245" class="difflineminus">-        int32_t  mLength;</span>
<a href="#l36.246"></a><span id="l36.246" class="difflineminus">-        uint8_t *mBytes;</span>
<a href="#l36.247"></a><span id="l36.247" class="difflineminus">-    };</span>
<a href="#l36.248"></a><span id="l36.248" class="difflineminus">-</span>
<a href="#l36.249"></a><span id="l36.249" class="difflineminus">-    BlobImpl(const uint8_t *aBytes, int32_t aLength)</span>
<a href="#l36.250"></a><span id="l36.250" class="difflineminus">-    {</span>
<a href="#l36.251"></a><span id="l36.251" class="difflineminus">-        mData.mLength = aLength;</span>
<a href="#l36.252"></a><span id="l36.252" class="difflineminus">-        mData.mBytes = new uint8_t[aLength];</span>
<a href="#l36.253"></a><span id="l36.253" class="difflineminus">-        memcpy(mData.mBytes, aBytes, aLength);</span>
<a href="#l36.254"></a><span id="l36.254" class="difflineminus">-        NS_ADDREF(RDFServiceImpl::gRDFService);</span>
<a href="#l36.255"></a><span id="l36.255" class="difflineminus">-        RDFServiceImpl::gRDFService-&gt;RegisterBlob(this);</span>
<a href="#l36.256"></a><span id="l36.256" class="difflineminus">-    }</span>
<a href="#l36.257"></a><span id="l36.257" class="difflineminus">-</span>
<a href="#l36.258"></a><span id="l36.258" class="difflineminus">-protected:</span>
<a href="#l36.259"></a><span id="l36.259" class="difflineminus">-    virtual ~BlobImpl()</span>
<a href="#l36.260"></a><span id="l36.260" class="difflineminus">-    {</span>
<a href="#l36.261"></a><span id="l36.261" class="difflineminus">-        RDFServiceImpl::gRDFService-&gt;UnregisterBlob(this);</span>
<a href="#l36.262"></a><span id="l36.262" class="difflineminus">-        // Use NS_RELEASE2() here, because we want to decrease the</span>
<a href="#l36.263"></a><span id="l36.263" class="difflineminus">-        // refcount, but not null out the gRDFService pointer (which is</span>
<a href="#l36.264"></a><span id="l36.264" class="difflineminus">-        // what a vanilla NS_RELEASE() would do).</span>
<a href="#l36.265"></a><span id="l36.265" class="difflineminus">-        nsrefcnt refcnt;</span>
<a href="#l36.266"></a><span id="l36.266" class="difflineminus">-        NS_RELEASE2(RDFServiceImpl::gRDFService, refcnt);</span>
<a href="#l36.267"></a><span id="l36.267" class="difflineminus">-        delete[] mData.mBytes;</span>
<a href="#l36.268"></a><span id="l36.268" class="difflineminus">-    }</span>
<a href="#l36.269"></a><span id="l36.269" class="difflineminus">-</span>
<a href="#l36.270"></a><span id="l36.270" class="difflineminus">-public:</span>
<a href="#l36.271"></a><span id="l36.271" class="difflineminus">-    NS_DECL_ISUPPORTS</span>
<a href="#l36.272"></a><span id="l36.272" class="difflineminus">-    NS_DECL_NSIRDFNODE</span>
<a href="#l36.273"></a><span id="l36.273" class="difflineminus">-    NS_DECL_NSIRDFBLOB</span>
<a href="#l36.274"></a><span id="l36.274" class="difflineminus">-</span>
<a href="#l36.275"></a><span id="l36.275" class="difflineminus">-    Data mData;</span>
<a href="#l36.276"></a><span id="l36.276" class="difflineminus">-};</span>
<a href="#l36.277"></a><span id="l36.277" class="difflineminus">-</span>
<a href="#l36.278"></a><span id="l36.278" class="difflineminus">-NS_IMPL_ISUPPORTS(BlobImpl, nsIRDFNode, nsIRDFBlob)</span>
<a href="#l36.279"></a><span id="l36.279" class="difflineminus">-</span>
<a href="#l36.280"></a><span id="l36.280" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l36.281"></a><span id="l36.281" class="difflineminus">-BlobImpl::EqualsNode(nsIRDFNode *aNode, bool *aEquals)</span>
<a href="#l36.282"></a><span id="l36.282" class="difflineminus">-{</span>
<a href="#l36.283"></a><span id="l36.283" class="difflineminus">-    nsCOMPtr&lt;nsIRDFBlob&gt; blob = do_QueryInterface(aNode);</span>
<a href="#l36.284"></a><span id="l36.284" class="difflineminus">-    if (blob) {</span>
<a href="#l36.285"></a><span id="l36.285" class="difflineminus">-        int32_t length;</span>
<a href="#l36.286"></a><span id="l36.286" class="difflineminus">-        blob-&gt;GetLength(&amp;length);</span>
<a href="#l36.287"></a><span id="l36.287" class="difflineminus">-</span>
<a href="#l36.288"></a><span id="l36.288" class="difflineminus">-        if (length == mData.mLength) {</span>
<a href="#l36.289"></a><span id="l36.289" class="difflineminus">-            const uint8_t *bytes;</span>
<a href="#l36.290"></a><span id="l36.290" class="difflineminus">-            blob-&gt;GetValue(&amp;bytes);</span>
<a href="#l36.291"></a><span id="l36.291" class="difflineminus">-</span>
<a href="#l36.292"></a><span id="l36.292" class="difflineminus">-            if (0 == memcmp(bytes, mData.mBytes, length)) {</span>
<a href="#l36.293"></a><span id="l36.293" class="difflineminus">-                *aEquals = true;</span>
<a href="#l36.294"></a><span id="l36.294" class="difflineminus">-                return NS_OK;</span>
<a href="#l36.295"></a><span id="l36.295" class="difflineminus">-            }</span>
<a href="#l36.296"></a><span id="l36.296" class="difflineminus">-        }</span>
<a href="#l36.297"></a><span id="l36.297" class="difflineminus">-    }</span>
<a href="#l36.298"></a><span id="l36.298" class="difflineminus">-</span>
<a href="#l36.299"></a><span id="l36.299" class="difflineminus">-    *aEquals = false;</span>
<a href="#l36.300"></a><span id="l36.300" class="difflineminus">-    return NS_OK;</span>
<a href="#l36.301"></a><span id="l36.301" class="difflineminus">-}</span>
<a href="#l36.302"></a><span id="l36.302" class="difflineminus">-</span>
<a href="#l36.303"></a><span id="l36.303" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l36.304"></a><span id="l36.304" class="difflineminus">-BlobImpl::GetValue(const uint8_t **aResult)</span>
<a href="#l36.305"></a><span id="l36.305" class="difflineminus">-{</span>
<a href="#l36.306"></a><span id="l36.306" class="difflineminus">-    *aResult = mData.mBytes;</span>
<a href="#l36.307"></a><span id="l36.307" class="difflineminus">-    return NS_OK;</span>
<a href="#l36.308"></a><span id="l36.308" class="difflineminus">-}</span>
<a href="#l36.309"></a><span id="l36.309" class="difflineminus">-</span>
<a href="#l36.310"></a><span id="l36.310" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l36.311"></a><span id="l36.311" class="difflineminus">-BlobImpl::GetLength(int32_t *aResult)</span>
<a href="#l36.312"></a><span id="l36.312" class="difflineminus">-{</span>
<a href="#l36.313"></a><span id="l36.313" class="difflineminus">-    *aResult = mData.mLength;</span>
<a href="#l36.314"></a><span id="l36.314" class="difflineminus">-    return NS_OK;</span>
<a href="#l36.315"></a><span id="l36.315" class="difflineminus">-}</span>
<a href="#l36.316"></a><span id="l36.316" class="difflineminus">-</span>
<a href="#l36.317"></a><span id="l36.317" class="difflineminus">-// ----------------------------------------------------------------------</span>
<a href="#l36.318"></a><span id="l36.318" class="difflineminus">-//</span>
<a href="#l36.319"></a><span id="l36.319" class="difflineminus">-// For the mBlobs hashtable.</span>
<a href="#l36.320"></a><span id="l36.320" class="difflineminus">-//</span>
<a href="#l36.321"></a><span id="l36.321" class="difflineminus">-</span>
<a href="#l36.322"></a><span id="l36.322" class="difflineminus">-struct BlobHashEntry : public PLDHashEntryHdr {</span>
<a href="#l36.323"></a><span id="l36.323" class="difflineminus">-    BlobImpl *mBlob;</span>
<a href="#l36.324"></a><span id="l36.324" class="difflineminus">-</span>
<a href="#l36.325"></a><span id="l36.325" class="difflineminus">-    static PLDHashNumber</span>
<a href="#l36.326"></a><span id="l36.326" class="difflineminus">-    HashKey(const void *key)</span>
<a href="#l36.327"></a><span id="l36.327" class="difflineminus">-    {</span>
<a href="#l36.328"></a><span id="l36.328" class="difflineminus">-        const BlobImpl::Data *data =</span>
<a href="#l36.329"></a><span id="l36.329" class="difflineminus">-            static_cast&lt;const BlobImpl::Data *&gt;(key);</span>
<a href="#l36.330"></a><span id="l36.330" class="difflineminus">-        return HashBytes(data-&gt;mBytes, data-&gt;mLength);</span>
<a href="#l36.331"></a><span id="l36.331" class="difflineminus">-    }</span>
<a href="#l36.332"></a><span id="l36.332" class="difflineminus">-</span>
<a href="#l36.333"></a><span id="l36.333" class="difflineminus">-    static bool</span>
<a href="#l36.334"></a><span id="l36.334" class="difflineminus">-    MatchEntry(const PLDHashEntryHdr *hdr, const void *key)</span>
<a href="#l36.335"></a><span id="l36.335" class="difflineminus">-    {</span>
<a href="#l36.336"></a><span id="l36.336" class="difflineminus">-        const BlobHashEntry *entry =</span>
<a href="#l36.337"></a><span id="l36.337" class="difflineminus">-            static_cast&lt;const BlobHashEntry *&gt;(hdr);</span>
<a href="#l36.338"></a><span id="l36.338" class="difflineminus">-</span>
<a href="#l36.339"></a><span id="l36.339" class="difflineminus">-        const BlobImpl::Data *left = &amp;entry-&gt;mBlob-&gt;mData;</span>
<a href="#l36.340"></a><span id="l36.340" class="difflineminus">-</span>
<a href="#l36.341"></a><span id="l36.341" class="difflineminus">-        const BlobImpl::Data *right =</span>
<a href="#l36.342"></a><span id="l36.342" class="difflineminus">-            static_cast&lt;const BlobImpl::Data *&gt;(key);</span>
<a href="#l36.343"></a><span id="l36.343" class="difflineminus">-</span>
<a href="#l36.344"></a><span id="l36.344" class="difflineminus">-        return (left-&gt;mLength == right-&gt;mLength)</span>
<a href="#l36.345"></a><span id="l36.345" class="difflineminus">-            &amp;&amp; 0 == memcmp(left-&gt;mBytes, right-&gt;mBytes, right-&gt;mLength);</span>
<a href="#l36.346"></a><span id="l36.346" class="difflineminus">-    }</span>
<a href="#l36.347"></a><span id="l36.347" class="difflineminus">-};</span>
<a href="#l36.348"></a><span id="l36.348" class="difflineminus">-</span>
<a href="#l36.349"></a><span id="l36.349" class="difflineminus">-static const PLDHashTableOps gBlobTableOps = {</span>
<a href="#l36.350"></a><span id="l36.350" class="difflineminus">-    BlobHashEntry::HashKey,</span>
<a href="#l36.351"></a><span id="l36.351" class="difflineminus">-    BlobHashEntry::MatchEntry,</span>
<a href="#l36.352"></a><span id="l36.352" class="difflineminus">-    PLDHashTable::MoveEntryStub,</span>
<a href="#l36.353"></a><span id="l36.353" class="difflineminus">-    PLDHashTable::ClearEntryStub,</span>
<a href="#l36.354"></a><span id="l36.354" class="difflineminus">-    nullptr</span>
<a href="#l36.355"></a><span id="l36.355" class="difflineminus">-};</span>
<a href="#l36.356"></a><span id="l36.356" class="difflineminus">-</span>
<a href="#l36.357"></a><span id="l36.357" class="difflineminus">-////////////////////////////////////////////////////////////////////////</span>
<a href="#l36.358"></a><span id="l36.358" class="difflineminus">-// LiteralImpl</span>
<a href="#l36.359"></a><span id="l36.359" class="difflineminus">-//</span>
<a href="#l36.360"></a><span id="l36.360" class="difflineminus">-//   Currently, all literals are implemented exactly the same way;</span>
<a href="#l36.361"></a><span id="l36.361" class="difflineminus">-//   i.e., there is are no resource factories to allow you to generate</span>
<a href="#l36.362"></a><span id="l36.362" class="difflineminus">-//   customer resources. I doubt that makes sense, anyway.</span>
<a href="#l36.363"></a><span id="l36.363" class="difflineminus">-//</span>
<a href="#l36.364"></a><span id="l36.364" class="difflineminus">-class LiteralImpl : public nsIRDFLiteral {</span>
<a href="#l36.365"></a><span id="l36.365" class="difflineminus">-public:</span>
<a href="#l36.366"></a><span id="l36.366" class="difflineminus">-    static nsresult</span>
<a href="#l36.367"></a><span id="l36.367" class="difflineminus">-    Create(const char16_t* aValue, nsIRDFLiteral** aResult);</span>
<a href="#l36.368"></a><span id="l36.368" class="difflineminus">-</span>
<a href="#l36.369"></a><span id="l36.369" class="difflineminus">-    // nsISupports</span>
<a href="#l36.370"></a><span id="l36.370" class="difflineminus">-    NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l36.371"></a><span id="l36.371" class="difflineminus">-</span>
<a href="#l36.372"></a><span id="l36.372" class="difflineminus">-    // nsIRDFNode</span>
<a href="#l36.373"></a><span id="l36.373" class="difflineminus">-    NS_DECL_NSIRDFNODE</span>
<a href="#l36.374"></a><span id="l36.374" class="difflineminus">-</span>
<a href="#l36.375"></a><span id="l36.375" class="difflineminus">-    // nsIRDFLiteral</span>
<a href="#l36.376"></a><span id="l36.376" class="difflineminus">-    NS_DECL_NSIRDFLITERAL</span>
<a href="#l36.377"></a><span id="l36.377" class="difflineminus">-</span>
<a href="#l36.378"></a><span id="l36.378" class="difflineminus">-protected:</span>
<a href="#l36.379"></a><span id="l36.379" class="difflineminus">-    explicit LiteralImpl(const char16_t* s);</span>
<a href="#l36.380"></a><span id="l36.380" class="difflineminus">-    virtual ~LiteralImpl();</span>
<a href="#l36.381"></a><span id="l36.381" class="difflineminus">-</span>
<a href="#l36.382"></a><span id="l36.382" class="difflineminus">-    const char16_t* GetValue() const {</span>
<a href="#l36.383"></a><span id="l36.383" class="difflineminus">-        size_t objectSize = ((sizeof(LiteralImpl) + sizeof(char16_t) - 1) / sizeof(char16_t)) * sizeof(char16_t);</span>
<a href="#l36.384"></a><span id="l36.384" class="difflineminus">-        return reinterpret_cast&lt;const char16_t*&gt;(reinterpret_cast&lt;const unsigned char*&gt;(this) + objectSize);</span>
<a href="#l36.385"></a><span id="l36.385" class="difflineminus">-    }</span>
<a href="#l36.386"></a><span id="l36.386" class="difflineminus">-};</span>
<a href="#l36.387"></a><span id="l36.387" class="difflineminus">-</span>
<a href="#l36.388"></a><span id="l36.388" class="difflineminus">-</span>
<a href="#l36.389"></a><span id="l36.389" class="difflineminus">-nsresult</span>
<a href="#l36.390"></a><span id="l36.390" class="difflineminus">-LiteralImpl::Create(const char16_t* aValue, nsIRDFLiteral** aResult)</span>
<a href="#l36.391"></a><span id="l36.391" class="difflineminus">-{</span>
<a href="#l36.392"></a><span id="l36.392" class="difflineminus">-    // Goofy math to get alignment right. Copied from nsSharedString.h.</span>
<a href="#l36.393"></a><span id="l36.393" class="difflineminus">-    size_t objectSize = ((sizeof(LiteralImpl) + sizeof(char16_t) - 1) / sizeof(char16_t)) * sizeof(char16_t);</span>
<a href="#l36.394"></a><span id="l36.394" class="difflineminus">-    size_t stringLen = nsCharTraits&lt;char16_t&gt;::length(aValue);</span>
<a href="#l36.395"></a><span id="l36.395" class="difflineminus">-    size_t stringSize = (stringLen + 1) * sizeof(char16_t);</span>
<a href="#l36.396"></a><span id="l36.396" class="difflineminus">-</span>
<a href="#l36.397"></a><span id="l36.397" class="difflineminus">-    void* objectPtr = operator new(objectSize + stringSize);</span>
<a href="#l36.398"></a><span id="l36.398" class="difflineminus">-    if (! objectPtr)</span>
<a href="#l36.399"></a><span id="l36.399" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l36.400"></a><span id="l36.400" class="difflineminus">-</span>
<a href="#l36.401"></a><span id="l36.401" class="difflineminus">-    char16_t* buf = reinterpret_cast&lt;char16_t*&gt;(static_cast&lt;unsigned char*&gt;(objectPtr) + objectSize);</span>
<a href="#l36.402"></a><span id="l36.402" class="difflineminus">-    nsCharTraits&lt;char16_t&gt;::copy(buf, aValue, stringLen + 1);</span>
<a href="#l36.403"></a><span id="l36.403" class="difflineminus">-</span>
<a href="#l36.404"></a><span id="l36.404" class="difflineminus">-    NS_ADDREF(*aResult = new (objectPtr) LiteralImpl(buf));</span>
<a href="#l36.405"></a><span id="l36.405" class="difflineminus">-    return NS_OK;</span>
<a href="#l36.406"></a><span id="l36.406" class="difflineminus">-}</span>
<a href="#l36.407"></a><span id="l36.407" class="difflineminus">-</span>
<a href="#l36.408"></a><span id="l36.408" class="difflineminus">-</span>
<a href="#l36.409"></a><span id="l36.409" class="difflineminus">-LiteralImpl::LiteralImpl(const char16_t* s)</span>
<a href="#l36.410"></a><span id="l36.410" class="difflineminus">-{</span>
<a href="#l36.411"></a><span id="l36.411" class="difflineminus">-    RDFServiceImpl::gRDFService-&gt;RegisterLiteral(this);</span>
<a href="#l36.412"></a><span id="l36.412" class="difflineminus">-    NS_ADDREF(RDFServiceImpl::gRDFService);</span>
<a href="#l36.413"></a><span id="l36.413" class="difflineminus">-}</span>
<a href="#l36.414"></a><span id="l36.414" class="difflineminus">-</span>
<a href="#l36.415"></a><span id="l36.415" class="difflineminus">-LiteralImpl::~LiteralImpl()</span>
<a href="#l36.416"></a><span id="l36.416" class="difflineminus">-{</span>
<a href="#l36.417"></a><span id="l36.417" class="difflineminus">-    RDFServiceImpl::gRDFService-&gt;UnregisterLiteral(this);</span>
<a href="#l36.418"></a><span id="l36.418" class="difflineminus">-</span>
<a href="#l36.419"></a><span id="l36.419" class="difflineminus">-    // Use NS_RELEASE2() here, because we want to decrease the</span>
<a href="#l36.420"></a><span id="l36.420" class="difflineminus">-    // refcount, but not null out the gRDFService pointer (which is</span>
<a href="#l36.421"></a><span id="l36.421" class="difflineminus">-    // what a vanilla NS_RELEASE() would do).</span>
<a href="#l36.422"></a><span id="l36.422" class="difflineminus">-    nsrefcnt refcnt;</span>
<a href="#l36.423"></a><span id="l36.423" class="difflineminus">-    NS_RELEASE2(RDFServiceImpl::gRDFService, refcnt);</span>
<a href="#l36.424"></a><span id="l36.424" class="difflineminus">-}</span>
<a href="#l36.425"></a><span id="l36.425" class="difflineminus">-</span>
<a href="#l36.426"></a><span id="l36.426" class="difflineminus">-NS_IMPL_ADDREF(LiteralImpl)</span>
<a href="#l36.427"></a><span id="l36.427" class="difflineminus">-NS_IMPL_RELEASE(LiteralImpl)</span>
<a href="#l36.428"></a><span id="l36.428" class="difflineminus">-</span>
<a href="#l36.429"></a><span id="l36.429" class="difflineminus">-nsresult</span>
<a href="#l36.430"></a><span id="l36.430" class="difflineminus">-LiteralImpl::QueryInterface(REFNSIID iid, void** result)</span>
<a href="#l36.431"></a><span id="l36.431" class="difflineminus">-{</span>
<a href="#l36.432"></a><span id="l36.432" class="difflineminus">-    if (! result)</span>
<a href="#l36.433"></a><span id="l36.433" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l36.434"></a><span id="l36.434" class="difflineminus">-</span>
<a href="#l36.435"></a><span id="l36.435" class="difflineminus">-    *result = nullptr;</span>
<a href="#l36.436"></a><span id="l36.436" class="difflineminus">-    if (iid.Equals(kIRDFLiteralIID) ||</span>
<a href="#l36.437"></a><span id="l36.437" class="difflineminus">-        iid.Equals(kIRDFNodeIID) ||</span>
<a href="#l36.438"></a><span id="l36.438" class="difflineminus">-        iid.Equals(kISupportsIID)) {</span>
<a href="#l36.439"></a><span id="l36.439" class="difflineminus">-        *result = static_cast&lt;nsIRDFLiteral*&gt;(this);</span>
<a href="#l36.440"></a><span id="l36.440" class="difflineminus">-        AddRef();</span>
<a href="#l36.441"></a><span id="l36.441" class="difflineminus">-        return NS_OK;</span>
<a href="#l36.442"></a><span id="l36.442" class="difflineminus">-    }</span>
<a href="#l36.443"></a><span id="l36.443" class="difflineminus">-    return NS_NOINTERFACE;</span>
<a href="#l36.444"></a><span id="l36.444" class="difflineminus">-}</span>
<a href="#l36.445"></a><span id="l36.445" class="difflineminus">-</span>
<a href="#l36.446"></a><span id="l36.446" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l36.447"></a><span id="l36.447" class="difflineminus">-LiteralImpl::EqualsNode(nsIRDFNode* aNode, bool* aResult)</span>
<a href="#l36.448"></a><span id="l36.448" class="difflineminus">-{</span>
<a href="#l36.449"></a><span id="l36.449" class="difflineminus">-    nsresult rv;</span>
<a href="#l36.450"></a><span id="l36.450" class="difflineminus">-    nsIRDFLiteral* literal;</span>
<a href="#l36.451"></a><span id="l36.451" class="difflineminus">-    rv = aNode-&gt;QueryInterface(kIRDFLiteralIID, (void**) &amp;literal);</span>
<a href="#l36.452"></a><span id="l36.452" class="difflineminus">-    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l36.453"></a><span id="l36.453" class="difflineminus">-        *aResult = (static_cast&lt;nsIRDFLiteral*&gt;(this) == literal);</span>
<a href="#l36.454"></a><span id="l36.454" class="difflineminus">-        NS_RELEASE(literal);</span>
<a href="#l36.455"></a><span id="l36.455" class="difflineminus">-        return NS_OK;</span>
<a href="#l36.456"></a><span id="l36.456" class="difflineminus">-    }</span>
<a href="#l36.457"></a><span id="l36.457" class="difflineminus">-    else if (rv == NS_NOINTERFACE) {</span>
<a href="#l36.458"></a><span id="l36.458" class="difflineminus">-        *aResult = false;</span>
<a href="#l36.459"></a><span id="l36.459" class="difflineminus">-        return NS_OK;</span>
<a href="#l36.460"></a><span id="l36.460" class="difflineminus">-    }</span>
<a href="#l36.461"></a><span id="l36.461" class="difflineminus">-    else {</span>
<a href="#l36.462"></a><span id="l36.462" class="difflineminus">-        return rv;</span>
<a href="#l36.463"></a><span id="l36.463" class="difflineminus">-    }</span>
<a href="#l36.464"></a><span id="l36.464" class="difflineminus">-}</span>
<a href="#l36.465"></a><span id="l36.465" class="difflineminus">-</span>
<a href="#l36.466"></a><span id="l36.466" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l36.467"></a><span id="l36.467" class="difflineminus">-LiteralImpl::GetValue(char16_t* *value)</span>
<a href="#l36.468"></a><span id="l36.468" class="difflineminus">-{</span>
<a href="#l36.469"></a><span id="l36.469" class="difflineminus">-    NS_ASSERTION(value, &quot;null ptr&quot;);</span>
<a href="#l36.470"></a><span id="l36.470" class="difflineminus">-    if (! value)</span>
<a href="#l36.471"></a><span id="l36.471" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l36.472"></a><span id="l36.472" class="difflineminus">-</span>
<a href="#l36.473"></a><span id="l36.473" class="difflineminus">-    const char16_t *temp = GetValue();</span>
<a href="#l36.474"></a><span id="l36.474" class="difflineminus">-    *value = temp? NS_xstrdup(temp) : 0;</span>
<a href="#l36.475"></a><span id="l36.475" class="difflineminus">-    return NS_OK;</span>
<a href="#l36.476"></a><span id="l36.476" class="difflineminus">-}</span>
<a href="#l36.477"></a><span id="l36.477" class="difflineminus">-</span>
<a href="#l36.478"></a><span id="l36.478" class="difflineminus">-</span>
<a href="#l36.479"></a><span id="l36.479" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l36.480"></a><span id="l36.480" class="difflineminus">-LiteralImpl::GetValueConst(const char16_t** aValue)</span>
<a href="#l36.481"></a><span id="l36.481" class="difflineminus">-{</span>
<a href="#l36.482"></a><span id="l36.482" class="difflineminus">-    *aValue = GetValue();</span>
<a href="#l36.483"></a><span id="l36.483" class="difflineminus">-    return NS_OK;</span>
<a href="#l36.484"></a><span id="l36.484" class="difflineminus">-}</span>
<a href="#l36.485"></a><span id="l36.485" class="difflineminus">-</span>
<a href="#l36.486"></a><span id="l36.486" class="difflineminus">-////////////////////////////////////////////////////////////////////////</span>
<a href="#l36.487"></a><span id="l36.487" class="difflineminus">-// DateImpl</span>
<a href="#l36.488"></a><span id="l36.488" class="difflineminus">-//</span>
<a href="#l36.489"></a><span id="l36.489" class="difflineminus">-</span>
<a href="#l36.490"></a><span id="l36.490" class="difflineminus">-class DateImpl : public nsIRDFDate {</span>
<a href="#l36.491"></a><span id="l36.491" class="difflineminus">-public:</span>
<a href="#l36.492"></a><span id="l36.492" class="difflineminus">-    explicit DateImpl(const PRTime s);</span>
<a href="#l36.493"></a><span id="l36.493" class="difflineminus">-</span>
<a href="#l36.494"></a><span id="l36.494" class="difflineminus">-    // nsISupports</span>
<a href="#l36.495"></a><span id="l36.495" class="difflineminus">-    NS_DECL_ISUPPORTS</span>
<a href="#l36.496"></a><span id="l36.496" class="difflineminus">-</span>
<a href="#l36.497"></a><span id="l36.497" class="difflineminus">-    // nsIRDFNode</span>
<a href="#l36.498"></a><span id="l36.498" class="difflineminus">-    NS_DECL_NSIRDFNODE</span>
<a href="#l36.499"></a><span id="l36.499" class="difflineminus">-</span>
<a href="#l36.500"></a><span id="l36.500" class="difflineminus">-    // nsIRDFDate</span>
<a href="#l36.501"></a><span id="l36.501" class="difflineminus">-    NS_IMETHOD GetValue(PRTime *value) override;</span>
<a href="#l36.502"></a><span id="l36.502" class="difflineminus">-</span>
<a href="#l36.503"></a><span id="l36.503" class="difflineminus">-private:</span>
<a href="#l36.504"></a><span id="l36.504" class="difflineminus">-    virtual ~DateImpl();</span>
<a href="#l36.505"></a><span id="l36.505" class="difflineminus">-</span>
<a href="#l36.506"></a><span id="l36.506" class="difflineminus">-    nsresult EqualsDate(nsIRDFDate* date, bool* result);</span>
<a href="#l36.507"></a><span id="l36.507" class="difflineminus">-    PRTime mValue;</span>
<a href="#l36.508"></a><span id="l36.508" class="difflineminus">-};</span>
<a href="#l36.509"></a><span id="l36.509" class="difflineminus">-</span>
<a href="#l36.510"></a><span id="l36.510" class="difflineminus">-</span>
<a href="#l36.511"></a><span id="l36.511" class="difflineminus">-DateImpl::DateImpl(const PRTime s)</span>
<a href="#l36.512"></a><span id="l36.512" class="difflineminus">-    : mValue(s)</span>
<a href="#l36.513"></a><span id="l36.513" class="difflineminus">-{</span>
<a href="#l36.514"></a><span id="l36.514" class="difflineminus">-    RDFServiceImpl::gRDFService-&gt;RegisterDate(this);</span>
<a href="#l36.515"></a><span id="l36.515" class="difflineminus">-    NS_ADDREF(RDFServiceImpl::gRDFService);</span>
<a href="#l36.516"></a><span id="l36.516" class="difflineminus">-}</span>
<a href="#l36.517"></a><span id="l36.517" class="difflineminus">-</span>
<a href="#l36.518"></a><span id="l36.518" class="difflineminus">-DateImpl::~DateImpl()</span>
<a href="#l36.519"></a><span id="l36.519" class="difflineminus">-{</span>
<a href="#l36.520"></a><span id="l36.520" class="difflineminus">-    RDFServiceImpl::gRDFService-&gt;UnregisterDate(this);</span>
<a href="#l36.521"></a><span id="l36.521" class="difflineminus">-</span>
<a href="#l36.522"></a><span id="l36.522" class="difflineminus">-    // Use NS_RELEASE2() here, because we want to decrease the</span>
<a href="#l36.523"></a><span id="l36.523" class="difflineminus">-    // refcount, but not null out the gRDFService pointer (which is</span>
<a href="#l36.524"></a><span id="l36.524" class="difflineminus">-    // what a vanilla NS_RELEASE() would do).</span>
<a href="#l36.525"></a><span id="l36.525" class="difflineminus">-    nsrefcnt refcnt;</span>
<a href="#l36.526"></a><span id="l36.526" class="difflineminus">-    NS_RELEASE2(RDFServiceImpl::gRDFService, refcnt);</span>
<a href="#l36.527"></a><span id="l36.527" class="difflineminus">-}</span>
<a href="#l36.528"></a><span id="l36.528" class="difflineminus">-</span>
<a href="#l36.529"></a><span id="l36.529" class="difflineminus">-NS_IMPL_ADDREF(DateImpl)</span>
<a href="#l36.530"></a><span id="l36.530" class="difflineminus">-NS_IMPL_RELEASE(DateImpl)</span>
<a href="#l36.531"></a><span id="l36.531" class="difflineminus">-</span>
<a href="#l36.532"></a><span id="l36.532" class="difflineminus">-nsresult</span>
<a href="#l36.533"></a><span id="l36.533" class="difflineminus">-DateImpl::QueryInterface(REFNSIID iid, void** result)</span>
<a href="#l36.534"></a><span id="l36.534" class="difflineminus">-{</span>
<a href="#l36.535"></a><span id="l36.535" class="difflineminus">-    if (! result)</span>
<a href="#l36.536"></a><span id="l36.536" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l36.537"></a><span id="l36.537" class="difflineminus">-</span>
<a href="#l36.538"></a><span id="l36.538" class="difflineminus">-    *result = nullptr;</span>
<a href="#l36.539"></a><span id="l36.539" class="difflineminus">-    if (iid.Equals(kIRDFDateIID) ||</span>
<a href="#l36.540"></a><span id="l36.540" class="difflineminus">-        iid.Equals(kIRDFNodeIID) ||</span>
<a href="#l36.541"></a><span id="l36.541" class="difflineminus">-        iid.Equals(kISupportsIID)) {</span>
<a href="#l36.542"></a><span id="l36.542" class="difflineminus">-        *result = static_cast&lt;nsIRDFDate*&gt;(this);</span>
<a href="#l36.543"></a><span id="l36.543" class="difflineminus">-        AddRef();</span>
<a href="#l36.544"></a><span id="l36.544" class="difflineminus">-        return NS_OK;</span>
<a href="#l36.545"></a><span id="l36.545" class="difflineminus">-    }</span>
<a href="#l36.546"></a><span id="l36.546" class="difflineminus">-    return NS_NOINTERFACE;</span>
<a href="#l36.547"></a><span id="l36.547" class="difflineminus">-}</span>
<a href="#l36.548"></a><span id="l36.548" class="difflineminus">-</span>
<a href="#l36.549"></a><span id="l36.549" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l36.550"></a><span id="l36.550" class="difflineminus">-DateImpl::EqualsNode(nsIRDFNode* node, bool* result)</span>
<a href="#l36.551"></a><span id="l36.551" class="difflineminus">-{</span>
<a href="#l36.552"></a><span id="l36.552" class="difflineminus">-    nsresult rv;</span>
<a href="#l36.553"></a><span id="l36.553" class="difflineminus">-    nsIRDFDate* date;</span>
<a href="#l36.554"></a><span id="l36.554" class="difflineminus">-    if (NS_SUCCEEDED(node-&gt;QueryInterface(kIRDFDateIID, (void**) &amp;date))) {</span>
<a href="#l36.555"></a><span id="l36.555" class="difflineminus">-        rv = EqualsDate(date, result);</span>
<a href="#l36.556"></a><span id="l36.556" class="difflineminus">-        NS_RELEASE(date);</span>
<a href="#l36.557"></a><span id="l36.557" class="difflineminus">-    }</span>
<a href="#l36.558"></a><span id="l36.558" class="difflineminus">-    else {</span>
<a href="#l36.559"></a><span id="l36.559" class="difflineminus">-        *result = false;</span>
<a href="#l36.560"></a><span id="l36.560" class="difflineminus">-        rv = NS_OK;</span>
<a href="#l36.561"></a><span id="l36.561" class="difflineminus">-    }</span>
<a href="#l36.562"></a><span id="l36.562" class="difflineminus">-    return rv;</span>
<a href="#l36.563"></a><span id="l36.563" class="difflineminus">-}</span>
<a href="#l36.564"></a><span id="l36.564" class="difflineminus">-</span>
<a href="#l36.565"></a><span id="l36.565" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l36.566"></a><span id="l36.566" class="difflineminus">-DateImpl::GetValue(PRTime *value)</span>
<a href="#l36.567"></a><span id="l36.567" class="difflineminus">-{</span>
<a href="#l36.568"></a><span id="l36.568" class="difflineminus">-    NS_ASSERTION(value, &quot;null ptr&quot;);</span>
<a href="#l36.569"></a><span id="l36.569" class="difflineminus">-    if (! value)</span>
<a href="#l36.570"></a><span id="l36.570" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l36.571"></a><span id="l36.571" class="difflineminus">-</span>
<a href="#l36.572"></a><span id="l36.572" class="difflineminus">-    *value = mValue;</span>
<a href="#l36.573"></a><span id="l36.573" class="difflineminus">-    return NS_OK;</span>
<a href="#l36.574"></a><span id="l36.574" class="difflineminus">-}</span>
<a href="#l36.575"></a><span id="l36.575" class="difflineminus">-</span>
<a href="#l36.576"></a><span id="l36.576" class="difflineminus">-</span>
<a href="#l36.577"></a><span id="l36.577" class="difflineminus">-nsresult</span>
<a href="#l36.578"></a><span id="l36.578" class="difflineminus">-DateImpl::EqualsDate(nsIRDFDate* date, bool* result)</span>
<a href="#l36.579"></a><span id="l36.579" class="difflineminus">-{</span>
<a href="#l36.580"></a><span id="l36.580" class="difflineminus">-    NS_ASSERTION(date &amp;&amp; result, &quot;null ptr&quot;);</span>
<a href="#l36.581"></a><span id="l36.581" class="difflineminus">-    if (!date || !result)</span>
<a href="#l36.582"></a><span id="l36.582" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l36.583"></a><span id="l36.583" class="difflineminus">-</span>
<a href="#l36.584"></a><span id="l36.584" class="difflineminus">-    nsresult rv;</span>
<a href="#l36.585"></a><span id="l36.585" class="difflineminus">-    PRTime p;</span>
<a href="#l36.586"></a><span id="l36.586" class="difflineminus">-    if (NS_FAILED(rv = date-&gt;GetValue(&amp;p)))</span>
<a href="#l36.587"></a><span id="l36.587" class="difflineminus">-        return rv;</span>
<a href="#l36.588"></a><span id="l36.588" class="difflineminus">-</span>
<a href="#l36.589"></a><span id="l36.589" class="difflineminus">-    *result = p == mValue;</span>
<a href="#l36.590"></a><span id="l36.590" class="difflineminus">-    return NS_OK;</span>
<a href="#l36.591"></a><span id="l36.591" class="difflineminus">-}</span>
<a href="#l36.592"></a><span id="l36.592" class="difflineminus">-</span>
<a href="#l36.593"></a><span id="l36.593" class="difflineminus">-////////////////////////////////////////////////////////////////////////</span>
<a href="#l36.594"></a><span id="l36.594" class="difflineminus">-// IntImpl</span>
<a href="#l36.595"></a><span id="l36.595" class="difflineminus">-//</span>
<a href="#l36.596"></a><span id="l36.596" class="difflineminus">-</span>
<a href="#l36.597"></a><span id="l36.597" class="difflineminus">-class IntImpl : public nsIRDFInt {</span>
<a href="#l36.598"></a><span id="l36.598" class="difflineminus">-public:</span>
<a href="#l36.599"></a><span id="l36.599" class="difflineminus">-    explicit IntImpl(int32_t s);</span>
<a href="#l36.600"></a><span id="l36.600" class="difflineminus">-</span>
<a href="#l36.601"></a><span id="l36.601" class="difflineminus">-    // nsISupports</span>
<a href="#l36.602"></a><span id="l36.602" class="difflineminus">-    NS_DECL_ISUPPORTS</span>
<a href="#l36.603"></a><span id="l36.603" class="difflineminus">-</span>
<a href="#l36.604"></a><span id="l36.604" class="difflineminus">-    // nsIRDFNode</span>
<a href="#l36.605"></a><span id="l36.605" class="difflineminus">-    NS_DECL_NSIRDFNODE</span>
<a href="#l36.606"></a><span id="l36.606" class="difflineminus">-</span>
<a href="#l36.607"></a><span id="l36.607" class="difflineminus">-    // nsIRDFInt</span>
<a href="#l36.608"></a><span id="l36.608" class="difflineminus">-    NS_IMETHOD GetValue(int32_t *value) override;</span>
<a href="#l36.609"></a><span id="l36.609" class="difflineminus">-</span>
<a href="#l36.610"></a><span id="l36.610" class="difflineminus">-private:</span>
<a href="#l36.611"></a><span id="l36.611" class="difflineminus">-    virtual ~IntImpl();</span>
<a href="#l36.612"></a><span id="l36.612" class="difflineminus">-</span>
<a href="#l36.613"></a><span id="l36.613" class="difflineminus">-    nsresult EqualsInt(nsIRDFInt* value, bool* result);</span>
<a href="#l36.614"></a><span id="l36.614" class="difflineminus">-    int32_t mValue;</span>
<a href="#l36.615"></a><span id="l36.615" class="difflineminus">-};</span>
<a href="#l36.616"></a><span id="l36.616" class="difflineminus">-</span>
<a href="#l36.617"></a><span id="l36.617" class="difflineminus">-</span>
<a href="#l36.618"></a><span id="l36.618" class="difflineminus">-IntImpl::IntImpl(int32_t s)</span>
<a href="#l36.619"></a><span id="l36.619" class="difflineminus">-    : mValue(s)</span>
<a href="#l36.620"></a><span id="l36.620" class="difflineminus">-{</span>
<a href="#l36.621"></a><span id="l36.621" class="difflineminus">-    RDFServiceImpl::gRDFService-&gt;RegisterInt(this);</span>
<a href="#l36.622"></a><span id="l36.622" class="difflineminus">-    NS_ADDREF(RDFServiceImpl::gRDFService);</span>
<a href="#l36.623"></a><span id="l36.623" class="difflineminus">-}</span>
<a href="#l36.624"></a><span id="l36.624" class="difflineminus">-</span>
<a href="#l36.625"></a><span id="l36.625" class="difflineminus">-IntImpl::~IntImpl()</span>
<a href="#l36.626"></a><span id="l36.626" class="difflineminus">-{</span>
<a href="#l36.627"></a><span id="l36.627" class="difflineminus">-    RDFServiceImpl::gRDFService-&gt;UnregisterInt(this);</span>
<a href="#l36.628"></a><span id="l36.628" class="difflineminus">-</span>
<a href="#l36.629"></a><span id="l36.629" class="difflineminus">-    // Use NS_RELEASE2() here, because we want to decrease the</span>
<a href="#l36.630"></a><span id="l36.630" class="difflineminus">-    // refcount, but not null out the gRDFService pointer (which is</span>
<a href="#l36.631"></a><span id="l36.631" class="difflineminus">-    // what a vanilla NS_RELEASE() would do).</span>
<a href="#l36.632"></a><span id="l36.632" class="difflineminus">-    nsrefcnt refcnt;</span>
<a href="#l36.633"></a><span id="l36.633" class="difflineminus">-    NS_RELEASE2(RDFServiceImpl::gRDFService, refcnt);</span>
<a href="#l36.634"></a><span id="l36.634" class="difflineminus">-}</span>
<a href="#l36.635"></a><span id="l36.635" class="difflineminus">-</span>
<a href="#l36.636"></a><span id="l36.636" class="difflineminus">-NS_IMPL_ADDREF(IntImpl)</span>
<a href="#l36.637"></a><span id="l36.637" class="difflineminus">-NS_IMPL_RELEASE(IntImpl)</span>
<a href="#l36.638"></a><span id="l36.638" class="difflineminus">-</span>
<a href="#l36.639"></a><span id="l36.639" class="difflineminus">-nsresult</span>
<a href="#l36.640"></a><span id="l36.640" class="difflineminus">-IntImpl::QueryInterface(REFNSIID iid, void** result)</span>
<a href="#l36.641"></a><span id="l36.641" class="difflineminus">-{</span>
<a href="#l36.642"></a><span id="l36.642" class="difflineminus">-    if (! result)</span>
<a href="#l36.643"></a><span id="l36.643" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l36.644"></a><span id="l36.644" class="difflineminus">-</span>
<a href="#l36.645"></a><span id="l36.645" class="difflineminus">-    *result = nullptr;</span>
<a href="#l36.646"></a><span id="l36.646" class="difflineminus">-    if (iid.Equals(kIRDFIntIID) ||</span>
<a href="#l36.647"></a><span id="l36.647" class="difflineminus">-        iid.Equals(kIRDFNodeIID) ||</span>
<a href="#l36.648"></a><span id="l36.648" class="difflineminus">-        iid.Equals(kISupportsIID)) {</span>
<a href="#l36.649"></a><span id="l36.649" class="difflineminus">-        *result = static_cast&lt;nsIRDFInt*&gt;(this);</span>
<a href="#l36.650"></a><span id="l36.650" class="difflineminus">-        AddRef();</span>
<a href="#l36.651"></a><span id="l36.651" class="difflineminus">-        return NS_OK;</span>
<a href="#l36.652"></a><span id="l36.652" class="difflineminus">-    }</span>
<a href="#l36.653"></a><span id="l36.653" class="difflineminus">-    return NS_NOINTERFACE;</span>
<a href="#l36.654"></a><span id="l36.654" class="difflineminus">-}</span>
<a href="#l36.655"></a><span id="l36.655" class="difflineminus">-</span>
<a href="#l36.656"></a><span id="l36.656" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l36.657"></a><span id="l36.657" class="difflineminus">-IntImpl::EqualsNode(nsIRDFNode* node, bool* result)</span>
<a href="#l36.658"></a><span id="l36.658" class="difflineminus">-{</span>
<a href="#l36.659"></a><span id="l36.659" class="difflineminus">-    nsresult rv;</span>
<a href="#l36.660"></a><span id="l36.660" class="difflineminus">-    nsIRDFInt* intValue;</span>
<a href="#l36.661"></a><span id="l36.661" class="difflineminus">-    if (NS_SUCCEEDED(node-&gt;QueryInterface(kIRDFIntIID, (void**) &amp;intValue))) {</span>
<a href="#l36.662"></a><span id="l36.662" class="difflineminus">-        rv = EqualsInt(intValue, result);</span>
<a href="#l36.663"></a><span id="l36.663" class="difflineminus">-        NS_RELEASE(intValue);</span>
<a href="#l36.664"></a><span id="l36.664" class="difflineminus">-    }</span>
<a href="#l36.665"></a><span id="l36.665" class="difflineminus">-    else {</span>
<a href="#l36.666"></a><span id="l36.666" class="difflineminus">-        *result = false;</span>
<a href="#l36.667"></a><span id="l36.667" class="difflineminus">-        rv = NS_OK;</span>
<a href="#l36.668"></a><span id="l36.668" class="difflineminus">-    }</span>
<a href="#l36.669"></a><span id="l36.669" class="difflineminus">-    return rv;</span>
<a href="#l36.670"></a><span id="l36.670" class="difflineminus">-}</span>
<a href="#l36.671"></a><span id="l36.671" class="difflineminus">-</span>
<a href="#l36.672"></a><span id="l36.672" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l36.673"></a><span id="l36.673" class="difflineminus">-IntImpl::GetValue(int32_t *value)</span>
<a href="#l36.674"></a><span id="l36.674" class="difflineminus">-{</span>
<a href="#l36.675"></a><span id="l36.675" class="difflineminus">-    NS_ASSERTION(value, &quot;null ptr&quot;);</span>
<a href="#l36.676"></a><span id="l36.676" class="difflineminus">-    if (! value)</span>
<a href="#l36.677"></a><span id="l36.677" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l36.678"></a><span id="l36.678" class="difflineminus">-</span>
<a href="#l36.679"></a><span id="l36.679" class="difflineminus">-    *value = mValue;</span>
<a href="#l36.680"></a><span id="l36.680" class="difflineminus">-    return NS_OK;</span>
<a href="#l36.681"></a><span id="l36.681" class="difflineminus">-}</span>
<a href="#l36.682"></a><span id="l36.682" class="difflineminus">-</span>
<a href="#l36.683"></a><span id="l36.683" class="difflineminus">-</span>
<a href="#l36.684"></a><span id="l36.684" class="difflineminus">-nsresult</span>
<a href="#l36.685"></a><span id="l36.685" class="difflineminus">-IntImpl::EqualsInt(nsIRDFInt* intValue, bool* result)</span>
<a href="#l36.686"></a><span id="l36.686" class="difflineminus">-{</span>
<a href="#l36.687"></a><span id="l36.687" class="difflineminus">-    NS_ASSERTION(intValue &amp;&amp; result, &quot;null ptr&quot;);</span>
<a href="#l36.688"></a><span id="l36.688" class="difflineminus">-    if (!intValue || !result)</span>
<a href="#l36.689"></a><span id="l36.689" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l36.690"></a><span id="l36.690" class="difflineminus">-</span>
<a href="#l36.691"></a><span id="l36.691" class="difflineminus">-    nsresult rv;</span>
<a href="#l36.692"></a><span id="l36.692" class="difflineminus">-    int32_t p;</span>
<a href="#l36.693"></a><span id="l36.693" class="difflineminus">-    if (NS_FAILED(rv = intValue-&gt;GetValue(&amp;p)))</span>
<a href="#l36.694"></a><span id="l36.694" class="difflineminus">-        return rv;</span>
<a href="#l36.695"></a><span id="l36.695" class="difflineminus">-</span>
<a href="#l36.696"></a><span id="l36.696" class="difflineminus">-    *result = (p == mValue);</span>
<a href="#l36.697"></a><span id="l36.697" class="difflineminus">-    return NS_OK;</span>
<a href="#l36.698"></a><span id="l36.698" class="difflineminus">-}</span>
<a href="#l36.699"></a><span id="l36.699" class="difflineminus">-</span>
<a href="#l36.700"></a><span id="l36.700" class="difflineminus">-////////////////////////////////////////////////////////////////////////</span>
<a href="#l36.701"></a><span id="l36.701" class="difflineminus">-// RDFServiceImpl</span>
<a href="#l36.702"></a><span id="l36.702" class="difflineminus">-</span>
<a href="#l36.703"></a><span id="l36.703" class="difflineminus">-RDFServiceImpl*</span>
<a href="#l36.704"></a><span id="l36.704" class="difflineminus">-RDFServiceImpl::gRDFService;</span>
<a href="#l36.705"></a><span id="l36.705" class="difflineminus">-</span>
<a href="#l36.706"></a><span id="l36.706" class="difflineminus">-RDFServiceImpl::RDFServiceImpl()</span>
<a href="#l36.707"></a><span id="l36.707" class="difflineminus">-    : mNamedDataSources(nullptr)</span>
<a href="#l36.708"></a><span id="l36.708" class="difflineminus">-    , mResources(&amp;gResourceTableOps, sizeof(ResourceHashEntry))</span>
<a href="#l36.709"></a><span id="l36.709" class="difflineminus">-    , mLiterals(&amp;gLiteralTableOps, sizeof(LiteralHashEntry))</span>
<a href="#l36.710"></a><span id="l36.710" class="difflineminus">-    , mInts(&amp;gIntTableOps, sizeof(IntHashEntry))</span>
<a href="#l36.711"></a><span id="l36.711" class="difflineminus">-    , mDates(&amp;gDateTableOps, sizeof(DateHashEntry))</span>
<a href="#l36.712"></a><span id="l36.712" class="difflineminus">-    , mBlobs(&amp;gBlobTableOps, sizeof(BlobHashEntry))</span>
<a href="#l36.713"></a><span id="l36.713" class="difflineminus">-{</span>
<a href="#l36.714"></a><span id="l36.714" class="difflineminus">-    gRDFService = this;</span>
<a href="#l36.715"></a><span id="l36.715" class="difflineminus">-}</span>
<a href="#l36.716"></a><span id="l36.716" class="difflineminus">-</span>
<a href="#l36.717"></a><span id="l36.717" class="difflineminus">-nsresult</span>
<a href="#l36.718"></a><span id="l36.718" class="difflineminus">-RDFServiceImpl::Init()</span>
<a href="#l36.719"></a><span id="l36.719" class="difflineminus">-{</span>
<a href="#l36.720"></a><span id="l36.720" class="difflineminus">-    nsresult rv;</span>
<a href="#l36.721"></a><span id="l36.721" class="difflineminus">-</span>
<a href="#l36.722"></a><span id="l36.722" class="difflineminus">-    mNamedDataSources = PL_NewHashTable(23,</span>
<a href="#l36.723"></a><span id="l36.723" class="difflineminus">-                                        PL_HashString,</span>
<a href="#l36.724"></a><span id="l36.724" class="difflineminus">-                                        PL_CompareStrings,</span>
<a href="#l36.725"></a><span id="l36.725" class="difflineminus">-                                        PL_CompareValues,</span>
<a href="#l36.726"></a><span id="l36.726" class="difflineminus">-                                        &amp;dataSourceHashAllocOps, nullptr);</span>
<a href="#l36.727"></a><span id="l36.727" class="difflineminus">-</span>
<a href="#l36.728"></a><span id="l36.728" class="difflineminus">-    if (! mNamedDataSources)</span>
<a href="#l36.729"></a><span id="l36.729" class="difflineminus">-        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l36.730"></a><span id="l36.730" class="difflineminus">-</span>
<a href="#l36.731"></a><span id="l36.731" class="difflineminus">-    mDefaultResourceFactory = do_GetClassObject(kRDFDefaultResourceCID, &amp;rv);</span>
<a href="#l36.732"></a><span id="l36.732" class="difflineminus">-    NS_ASSERTION(NS_SUCCEEDED(rv), &quot;unable to get default resource factory&quot;);</span>
<a href="#l36.733"></a><span id="l36.733" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l36.734"></a><span id="l36.734" class="difflineminus">-</span>
<a href="#l36.735"></a><span id="l36.735" class="difflineminus">-    return NS_OK;</span>
<a href="#l36.736"></a><span id="l36.736" class="difflineminus">-}</span>
<a href="#l36.737"></a><span id="l36.737" class="difflineminus">-</span>
<a href="#l36.738"></a><span id="l36.738" class="difflineminus">-</span>
<a href="#l36.739"></a><span id="l36.739" class="difflineminus">-RDFServiceImpl::~RDFServiceImpl()</span>
<a href="#l36.740"></a><span id="l36.740" class="difflineminus">-{</span>
<a href="#l36.741"></a><span id="l36.741" class="difflineminus">-    if (mNamedDataSources) {</span>
<a href="#l36.742"></a><span id="l36.742" class="difflineminus">-        PL_HashTableDestroy(mNamedDataSources);</span>
<a href="#l36.743"></a><span id="l36.743" class="difflineminus">-        mNamedDataSources = nullptr;</span>
<a href="#l36.744"></a><span id="l36.744" class="difflineminus">-    }</span>
<a href="#l36.745"></a><span id="l36.745" class="difflineminus">-    gRDFService = nullptr;</span>
<a href="#l36.746"></a><span id="l36.746" class="difflineminus">-}</span>
<a href="#l36.747"></a><span id="l36.747" class="difflineminus">-</span>
<a href="#l36.748"></a><span id="l36.748" class="difflineminus">-</span>
<a href="#l36.749"></a><span id="l36.749" class="difflineminus">-// static</span>
<a href="#l36.750"></a><span id="l36.750" class="difflineminus">-nsresult</span>
<a href="#l36.751"></a><span id="l36.751" class="difflineminus">-RDFServiceImpl::CreateSingleton(nsISupports* aOuter,</span>
<a href="#l36.752"></a><span id="l36.752" class="difflineminus">-                                const nsIID&amp; aIID, void **aResult)</span>
<a href="#l36.753"></a><span id="l36.753" class="difflineminus">-{</span>
<a href="#l36.754"></a><span id="l36.754" class="difflineminus">-    NS_ENSURE_NO_AGGREGATION(aOuter);</span>
<a href="#l36.755"></a><span id="l36.755" class="difflineminus">-</span>
<a href="#l36.756"></a><span id="l36.756" class="difflineminus">-    if (gRDFService) {</span>
<a href="#l36.757"></a><span id="l36.757" class="difflineminus">-        NS_ERROR(&quot;Trying to create RDF serviec twice.&quot;);</span>
<a href="#l36.758"></a><span id="l36.758" class="difflineminus">-        return gRDFService-&gt;QueryInterface(aIID, aResult);</span>
<a href="#l36.759"></a><span id="l36.759" class="difflineminus">-    }</span>
<a href="#l36.760"></a><span id="l36.760" class="difflineminus">-</span>
<a href="#l36.761"></a><span id="l36.761" class="difflineminus">-    RefPtr&lt;RDFServiceImpl&gt; serv = new RDFServiceImpl();</span>
<a href="#l36.762"></a><span id="l36.762" class="difflineminus">-    nsresult rv = serv-&gt;Init();</span>
<a href="#l36.763"></a><span id="l36.763" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l36.764"></a><span id="l36.764" class="difflineminus">-        return rv;</span>
<a href="#l36.765"></a><span id="l36.765" class="difflineminus">-</span>
<a href="#l36.766"></a><span id="l36.766" class="difflineminus">-    return serv-&gt;QueryInterface(aIID, aResult);</span>
<a href="#l36.767"></a><span id="l36.767" class="difflineminus">-}</span>
<a href="#l36.768"></a><span id="l36.768" class="difflineminus">-</span>
<a href="#l36.769"></a><span id="l36.769" class="difflineminus">-NS_IMPL_ISUPPORTS(RDFServiceImpl, nsIRDFService, nsISupportsWeakReference)</span>
<a href="#l36.770"></a><span id="l36.770" class="difflineminus">-</span>
<a href="#l36.771"></a><span id="l36.771" class="difflineminus">-// Per RFC2396.</span>
<a href="#l36.772"></a><span id="l36.772" class="difflineminus">-static const uint8_t</span>
<a href="#l36.773"></a><span id="l36.773" class="difflineminus">-kLegalSchemeChars[] = {</span>
<a href="#l36.774"></a><span id="l36.774" class="difflineminus">-          //        ASCII    Bits     Ordered  Hex</span>
<a href="#l36.775"></a><span id="l36.775" class="difflineminus">-          //                 01234567 76543210</span>
<a href="#l36.776"></a><span id="l36.776" class="difflineminus">-    0x00, // 00-07</span>
<a href="#l36.777"></a><span id="l36.777" class="difflineminus">-    0x00, // 08-0F</span>
<a href="#l36.778"></a><span id="l36.778" class="difflineminus">-    0x00, // 10-17</span>
<a href="#l36.779"></a><span id="l36.779" class="difflineminus">-    0x00, // 18-1F</span>
<a href="#l36.780"></a><span id="l36.780" class="difflineminus">-    0x00, // 20-27   !&quot;#$%&amp;' 00000000 00000000</span>
<a href="#l36.781"></a><span id="l36.781" class="difflineminus">-    0x28, // 28-2F  ()*+,-./ 00010100 00101000 0x28</span>
<a href="#l36.782"></a><span id="l36.782" class="difflineminus">-    0xff, // 30-37  01234567 11111111 11111111 0xFF</span>
<a href="#l36.783"></a><span id="l36.783" class="difflineminus">-    0x03, // 38-3F  89:;&lt;=&gt;? 11000000 00000011 0x03</span>
<a href="#l36.784"></a><span id="l36.784" class="difflineminus">-    0xfe, // 40-47  @ABCDEFG 01111111 11111110 0xFE</span>
<a href="#l36.785"></a><span id="l36.785" class="difflineminus">-    0xff, // 48-4F  HIJKLMNO 11111111 11111111 0xFF</span>
<a href="#l36.786"></a><span id="l36.786" class="difflineminus">-    0xff, // 50-57  PQRSTUVW 11111111 11111111 0xFF</span>
<a href="#l36.787"></a><span id="l36.787" class="difflineminus">-    0x87, // 58-5F  XYZ[\]^_ 11100001 10000111 0x87</span>
<a href="#l36.788"></a><span id="l36.788" class="difflineminus">-    0xfe, // 60-67  `abcdefg 01111111 11111110 0xFE</span>
<a href="#l36.789"></a><span id="l36.789" class="difflineminus">-    0xff, // 68-6F  hijklmno 11111111 11111111 0xFF</span>
<a href="#l36.790"></a><span id="l36.790" class="difflineminus">-    0xff, // 70-77  pqrstuvw 11111111 11111111 0xFF</span>
<a href="#l36.791"></a><span id="l36.791" class="difflineminus">-    0x07, // 78-7F  xyz{|}~  11100000 00000111 0x07</span>
<a href="#l36.792"></a><span id="l36.792" class="difflineminus">-    0x00, 0x00, 0x00, 0x00, // &gt;= 80</span>
<a href="#l36.793"></a><span id="l36.793" class="difflineminus">-    0x00, 0x00, 0x00, 0x00,</span>
<a href="#l36.794"></a><span id="l36.794" class="difflineminus">-    0x00, 0x00, 0x00, 0x00,</span>
<a href="#l36.795"></a><span id="l36.795" class="difflineminus">-    0x00, 0x00, 0x00, 0x00</span>
<a href="#l36.796"></a><span id="l36.796" class="difflineminus">-};</span>
<a href="#l36.797"></a><span id="l36.797" class="difflineminus">-</span>
<a href="#l36.798"></a><span id="l36.798" class="difflineminus">-static inline bool</span>
<a href="#l36.799"></a><span id="l36.799" class="difflineminus">-IsLegalSchemeCharacter(const char aChar)</span>
<a href="#l36.800"></a><span id="l36.800" class="difflineminus">-{</span>
<a href="#l36.801"></a><span id="l36.801" class="difflineminus">-    uint8_t mask = kLegalSchemeChars[aChar &gt;&gt; 3];</span>
<a href="#l36.802"></a><span id="l36.802" class="difflineminus">-    uint8_t bit = 1u &lt;&lt; (aChar &amp; 0x7);</span>
<a href="#l36.803"></a><span id="l36.803" class="difflineminus">-    return bool((mask &amp; bit) != 0);</span>
<a href="#l36.804"></a><span id="l36.804" class="difflineminus">-}</span>
<a href="#l36.805"></a><span id="l36.805" class="difflineminus">-</span>
<a href="#l36.806"></a><span id="l36.806" class="difflineminus">-</span>
<a href="#l36.807"></a><span id="l36.807" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l36.808"></a><span id="l36.808" class="difflineminus">-RDFServiceImpl::GetResource(const nsACString&amp; aURI, nsIRDFResource** aResource)</span>
<a href="#l36.809"></a><span id="l36.809" class="difflineminus">-{</span>
<a href="#l36.810"></a><span id="l36.810" class="difflineminus">-    // Sanity checks</span>
<a href="#l36.811"></a><span id="l36.811" class="difflineminus">-    NS_ASSERTION(aResource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l36.812"></a><span id="l36.812" class="difflineminus">-    NS_ASSERTION(!aURI.IsEmpty(), &quot;URI is empty&quot;);</span>
<a href="#l36.813"></a><span id="l36.813" class="difflineminus">-    if (! aResource)</span>
<a href="#l36.814"></a><span id="l36.814" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l36.815"></a><span id="l36.815" class="difflineminus">-    if (aURI.IsEmpty())</span>
<a href="#l36.816"></a><span id="l36.816" class="difflineminus">-        return NS_ERROR_INVALID_ARG;</span>
<a href="#l36.817"></a><span id="l36.817" class="difflineminus">-</span>
<a href="#l36.818"></a><span id="l36.818" class="difflineminus">-    const nsCString&amp; flatURI = PromiseFlatCString(aURI);</span>
<a href="#l36.819"></a><span id="l36.819" class="difflineminus">-    MOZ_LOG(gLog, LogLevel::Debug, (&quot;rdfserv get-resource %s&quot;, flatURI.get()));</span>
<a href="#l36.820"></a><span id="l36.820" class="difflineminus">-</span>
<a href="#l36.821"></a><span id="l36.821" class="difflineminus">-    // First, check the cache to see if we've already created and</span>
<a href="#l36.822"></a><span id="l36.822" class="difflineminus">-    // registered this thing.</span>
<a href="#l36.823"></a><span id="l36.823" class="difflineminus">-    PLDHashEntryHdr *hdr = mResources.Search(flatURI.get());</span>
<a href="#l36.824"></a><span id="l36.824" class="difflineminus">-    if (hdr) {</span>
<a href="#l36.825"></a><span id="l36.825" class="difflineminus">-        ResourceHashEntry *entry = static_cast&lt;ResourceHashEntry *&gt;(hdr);</span>
<a href="#l36.826"></a><span id="l36.826" class="difflineminus">-        NS_ADDREF(*aResource = entry-&gt;mResource);</span>
<a href="#l36.827"></a><span id="l36.827" class="difflineminus">-        return NS_OK;</span>
<a href="#l36.828"></a><span id="l36.828" class="difflineminus">-    }</span>
<a href="#l36.829"></a><span id="l36.829" class="difflineminus">-</span>
<a href="#l36.830"></a><span id="l36.830" class="difflineminus">-    // Nope. So go to the repository to create it.</span>
<a href="#l36.831"></a><span id="l36.831" class="difflineminus">-</span>
<a href="#l36.832"></a><span id="l36.832" class="difflineminus">-    // Compute the scheme of the URI. Scan forward until we either:</span>
<a href="#l36.833"></a><span id="l36.833" class="difflineminus">-    //</span>
<a href="#l36.834"></a><span id="l36.834" class="difflineminus">-    // 1. Reach the end of the string</span>
<a href="#l36.835"></a><span id="l36.835" class="difflineminus">-    // 2. Encounter a non-alpha character</span>
<a href="#l36.836"></a><span id="l36.836" class="difflineminus">-    // 3. Encouter a colon.</span>
<a href="#l36.837"></a><span id="l36.837" class="difflineminus">-    //</span>
<a href="#l36.838"></a><span id="l36.838" class="difflineminus">-    // If we encounter a colon _before_ encountering a non-alpha</span>
<a href="#l36.839"></a><span id="l36.839" class="difflineminus">-    // character, then assume it's the scheme.</span>
<a href="#l36.840"></a><span id="l36.840" class="difflineminus">-    //</span>
<a href="#l36.841"></a><span id="l36.841" class="difflineminus">-    // XXX Although it's really not correct, we'll allow underscore</span>
<a href="#l36.842"></a><span id="l36.842" class="difflineminus">-    // characters ('_'), too.</span>
<a href="#l36.843"></a><span id="l36.843" class="difflineminus">-    nsACString::const_iterator p, end;</span>
<a href="#l36.844"></a><span id="l36.844" class="difflineminus">-    aURI.BeginReading(p);</span>
<a href="#l36.845"></a><span id="l36.845" class="difflineminus">-    aURI.EndReading(end);</span>
<a href="#l36.846"></a><span id="l36.846" class="difflineminus">-    while (p != end &amp;&amp; IsLegalSchemeCharacter(*p))</span>
<a href="#l36.847"></a><span id="l36.847" class="difflineminus">-        ++p;</span>
<a href="#l36.848"></a><span id="l36.848" class="difflineminus">-</span>
<a href="#l36.849"></a><span id="l36.849" class="difflineminus">-    nsresult rv;</span>
<a href="#l36.850"></a><span id="l36.850" class="difflineminus">-    nsCOMPtr&lt;nsIFactory&gt; factory;</span>
<a href="#l36.851"></a><span id="l36.851" class="difflineminus">-</span>
<a href="#l36.852"></a><span id="l36.852" class="difflineminus">-    nsACString::const_iterator begin;</span>
<a href="#l36.853"></a><span id="l36.853" class="difflineminus">-    aURI.BeginReading(begin);</span>
<a href="#l36.854"></a><span id="l36.854" class="difflineminus">-    if (*p == ':') {</span>
<a href="#l36.855"></a><span id="l36.855" class="difflineminus">-        // There _was_ a scheme. First see if it's the same scheme</span>
<a href="#l36.856"></a><span id="l36.856" class="difflineminus">-        // that we just tried to use...</span>
<a href="#l36.857"></a><span id="l36.857" class="difflineminus">-        if (mLastFactory &amp;&amp; mLastURIPrefix.Equals(Substring(begin, p)))</span>
<a href="#l36.858"></a><span id="l36.858" class="difflineminus">-            factory = mLastFactory;</span>
<a href="#l36.859"></a><span id="l36.859" class="difflineminus">-        else {</span>
<a href="#l36.860"></a><span id="l36.860" class="difflineminus">-            // Try to find a factory using the component manager.</span>
<a href="#l36.861"></a><span id="l36.861" class="difflineminus">-            nsACString::const_iterator begin;</span>
<a href="#l36.862"></a><span id="l36.862" class="difflineminus">-            aURI.BeginReading(begin);</span>
<a href="#l36.863"></a><span id="l36.863" class="difflineminus">-            nsAutoCString contractID;</span>
<a href="#l36.864"></a><span id="l36.864" class="difflineminus">-            contractID = NS_LITERAL_CSTRING(NS_RDF_RESOURCE_FACTORY_CONTRACTID_PREFIX) +</span>
<a href="#l36.865"></a><span id="l36.865" class="difflineminus">-                         Substring(begin, p);</span>
<a href="#l36.866"></a><span id="l36.866" class="difflineminus">-</span>
<a href="#l36.867"></a><span id="l36.867" class="difflineminus">-            factory = do_GetClassObject(contractID.get());</span>
<a href="#l36.868"></a><span id="l36.868" class="difflineminus">-            if (factory) {</span>
<a href="#l36.869"></a><span id="l36.869" class="difflineminus">-                // Store the factory in our one-element cache.</span>
<a href="#l36.870"></a><span id="l36.870" class="difflineminus">-                if (p != begin) {</span>
<a href="#l36.871"></a><span id="l36.871" class="difflineminus">-                    mLastFactory = factory;</span>
<a href="#l36.872"></a><span id="l36.872" class="difflineminus">-                    mLastURIPrefix = Substring(begin, p);</span>
<a href="#l36.873"></a><span id="l36.873" class="difflineminus">-                }</span>
<a href="#l36.874"></a><span id="l36.874" class="difflineminus">-            }</span>
<a href="#l36.875"></a><span id="l36.875" class="difflineminus">-        }</span>
<a href="#l36.876"></a><span id="l36.876" class="difflineminus">-    }</span>
<a href="#l36.877"></a><span id="l36.877" class="difflineminus">-</span>
<a href="#l36.878"></a><span id="l36.878" class="difflineminus">-    if (! factory) {</span>
<a href="#l36.879"></a><span id="l36.879" class="difflineminus">-        // fall through to using the &quot;default&quot; resource factory if either:</span>
<a href="#l36.880"></a><span id="l36.880" class="difflineminus">-        //</span>
<a href="#l36.881"></a><span id="l36.881" class="difflineminus">-        // 1. The URI didn't have a scheme, or</span>
<a href="#l36.882"></a><span id="l36.882" class="difflineminus">-        // 2. There was no resource factory registered for the scheme.</span>
<a href="#l36.883"></a><span id="l36.883" class="difflineminus">-        factory = mDefaultResourceFactory;</span>
<a href="#l36.884"></a><span id="l36.884" class="difflineminus">-</span>
<a href="#l36.885"></a><span id="l36.885" class="difflineminus">-        // Store the factory in our one-element cache.</span>
<a href="#l36.886"></a><span id="l36.886" class="difflineminus">-        if (p != begin) {</span>
<a href="#l36.887"></a><span id="l36.887" class="difflineminus">-            mLastFactory = factory;</span>
<a href="#l36.888"></a><span id="l36.888" class="difflineminus">-            mLastURIPrefix = Substring(begin, p);</span>
<a href="#l36.889"></a><span id="l36.889" class="difflineminus">-        }</span>
<a href="#l36.890"></a><span id="l36.890" class="difflineminus">-    }</span>
<a href="#l36.891"></a><span id="l36.891" class="difflineminus">-</span>
<a href="#l36.892"></a><span id="l36.892" class="difflineminus">-    nsIRDFResource *result;</span>
<a href="#l36.893"></a><span id="l36.893" class="difflineminus">-    rv = factory-&gt;CreateInstance(nullptr, NS_GET_IID(nsIRDFResource), (void**) &amp;result);</span>
<a href="#l36.894"></a><span id="l36.894" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l36.895"></a><span id="l36.895" class="difflineminus">-</span>
<a href="#l36.896"></a><span id="l36.896" class="difflineminus">-    // Now initialize it with its URI. At this point, the resource</span>
<a href="#l36.897"></a><span id="l36.897" class="difflineminus">-    // implementation should register itself with the RDF service.</span>
<a href="#l36.898"></a><span id="l36.898" class="difflineminus">-    rv = result-&gt;Init(flatURI.get());</span>
<a href="#l36.899"></a><span id="l36.899" class="difflineminus">-    if (NS_FAILED(rv)) {</span>
<a href="#l36.900"></a><span id="l36.900" class="difflineminus">-        NS_ERROR(&quot;unable to initialize resource&quot;);</span>
<a href="#l36.901"></a><span id="l36.901" class="difflineminus">-        NS_RELEASE(result);</span>
<a href="#l36.902"></a><span id="l36.902" class="difflineminus">-        return rv;</span>
<a href="#l36.903"></a><span id="l36.903" class="difflineminus">-    }</span>
<a href="#l36.904"></a><span id="l36.904" class="difflineminus">-</span>
<a href="#l36.905"></a><span id="l36.905" class="difflineminus">-    *aResource = result; // already refcounted from repository</span>
<a href="#l36.906"></a><span id="l36.906" class="difflineminus">-    return rv;</span>
<a href="#l36.907"></a><span id="l36.907" class="difflineminus">-}</span>
<a href="#l36.908"></a><span id="l36.908" class="difflineminus">-</span>
<a href="#l36.909"></a><span id="l36.909" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l36.910"></a><span id="l36.910" class="difflineminus">-RDFServiceImpl::GetUnicodeResource(const nsAString&amp; aURI, nsIRDFResource** aResource)</span>
<a href="#l36.911"></a><span id="l36.911" class="difflineminus">-{</span>
<a href="#l36.912"></a><span id="l36.912" class="difflineminus">-    return GetResource(NS_ConvertUTF16toUTF8(aURI), aResource);</span>
<a href="#l36.913"></a><span id="l36.913" class="difflineminus">-}</span>
<a href="#l36.914"></a><span id="l36.914" class="difflineminus">-</span>
<a href="#l36.915"></a><span id="l36.915" class="difflineminus">-</span>
<a href="#l36.916"></a><span id="l36.916" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l36.917"></a><span id="l36.917" class="difflineminus">-RDFServiceImpl::GetAnonymousResource(nsIRDFResource** aResult)</span>
<a href="#l36.918"></a><span id="l36.918" class="difflineminus">-{</span>
<a href="#l36.919"></a><span id="l36.919" class="difflineminus">-static uint32_t gCounter = 0;</span>
<a href="#l36.920"></a><span id="l36.920" class="difflineminus">-static char gChars[] = &quot;0123456789abcdef&quot;</span>
<a href="#l36.921"></a><span id="l36.921" class="difflineminus">-                       &quot;ghijklmnopqrstuv&quot;</span>
<a href="#l36.922"></a><span id="l36.922" class="difflineminus">-                       &quot;wxyzABCDEFGHIJKL&quot;</span>
<a href="#l36.923"></a><span id="l36.923" class="difflineminus">-                       &quot;MNOPQRSTUVWXYZ.+&quot;;</span>
<a href="#l36.924"></a><span id="l36.924" class="difflineminus">-</span>
<a href="#l36.925"></a><span id="l36.925" class="difflineminus">-static int32_t kMask  = 0x003f;</span>
<a href="#l36.926"></a><span id="l36.926" class="difflineminus">-static int32_t kShift = 6;</span>
<a href="#l36.927"></a><span id="l36.927" class="difflineminus">-</span>
<a href="#l36.928"></a><span id="l36.928" class="difflineminus">-    if (! gCounter) {</span>
<a href="#l36.929"></a><span id="l36.929" class="difflineminus">-        // Start it at a semi-unique value, just to minimize the</span>
<a href="#l36.930"></a><span id="l36.930" class="difflineminus">-        // chance that we get into a situation where</span>
<a href="#l36.931"></a><span id="l36.931" class="difflineminus">-        //</span>
<a href="#l36.932"></a><span id="l36.932" class="difflineminus">-        // 1. An anonymous resource gets serialized out in a graph</span>
<a href="#l36.933"></a><span id="l36.933" class="difflineminus">-        // 2. Reboot</span>
<a href="#l36.934"></a><span id="l36.934" class="difflineminus">-        // 3. The same anonymous resource gets requested, and refers</span>
<a href="#l36.935"></a><span id="l36.935" class="difflineminus">-        //    to something completely different.</span>
<a href="#l36.936"></a><span id="l36.936" class="difflineminus">-        // 4. The serialization is read back in.</span>
<a href="#l36.937"></a><span id="l36.937" class="difflineminus">-        gCounter = uint32_t(PR_Now());</span>
<a href="#l36.938"></a><span id="l36.938" class="difflineminus">-    }</span>
<a href="#l36.939"></a><span id="l36.939" class="difflineminus">-</span>
<a href="#l36.940"></a><span id="l36.940" class="difflineminus">-    nsresult rv;</span>
<a href="#l36.941"></a><span id="l36.941" class="difflineminus">-    nsAutoCString s;</span>
<a href="#l36.942"></a><span id="l36.942" class="difflineminus">-</span>
<a href="#l36.943"></a><span id="l36.943" class="difflineminus">-    do {</span>
<a href="#l36.944"></a><span id="l36.944" class="difflineminus">-        // Ugh, this is a really sloppy way to do this; I copied the</span>
<a href="#l36.945"></a><span id="l36.945" class="difflineminus">-        // implementation from the days when it lived outside the RDF</span>
<a href="#l36.946"></a><span id="l36.946" class="difflineminus">-        // service. Now that it's a member we can be more cleverer.</span>
<a href="#l36.947"></a><span id="l36.947" class="difflineminus">-</span>
<a href="#l36.948"></a><span id="l36.948" class="difflineminus">-        s.Truncate();</span>
<a href="#l36.949"></a><span id="l36.949" class="difflineminus">-        s.AppendLiteral(&quot;rdf:#$&quot;);</span>
<a href="#l36.950"></a><span id="l36.950" class="difflineminus">-</span>
<a href="#l36.951"></a><span id="l36.951" class="difflineminus">-        uint32_t id = ++gCounter;</span>
<a href="#l36.952"></a><span id="l36.952" class="difflineminus">-        while (id) {</span>
<a href="#l36.953"></a><span id="l36.953" class="difflineminus">-            char ch = gChars[(id &amp; kMask)];</span>
<a href="#l36.954"></a><span id="l36.954" class="difflineminus">-            s.Append(ch);</span>
<a href="#l36.955"></a><span id="l36.955" class="difflineminus">-            id &gt;&gt;= kShift;</span>
<a href="#l36.956"></a><span id="l36.956" class="difflineminus">-        }</span>
<a href="#l36.957"></a><span id="l36.957" class="difflineminus">-</span>
<a href="#l36.958"></a><span id="l36.958" class="difflineminus">-        nsIRDFResource* resource;</span>
<a href="#l36.959"></a><span id="l36.959" class="difflineminus">-        rv = GetResource(s, &amp;resource);</span>
<a href="#l36.960"></a><span id="l36.960" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l36.961"></a><span id="l36.961" class="difflineminus">-</span>
<a href="#l36.962"></a><span id="l36.962" class="difflineminus">-        // XXX an ugly but effective way to make sure that this</span>
<a href="#l36.963"></a><span id="l36.963" class="difflineminus">-        // resource is really unique in the world.</span>
<a href="#l36.964"></a><span id="l36.964" class="difflineminus">-        resource-&gt;AddRef();</span>
<a href="#l36.965"></a><span id="l36.965" class="difflineminus">-        nsrefcnt refcnt = resource-&gt;Release();</span>
<a href="#l36.966"></a><span id="l36.966" class="difflineminus">-</span>
<a href="#l36.967"></a><span id="l36.967" class="difflineminus">-        if (refcnt == 1) {</span>
<a href="#l36.968"></a><span id="l36.968" class="difflineminus">-            *aResult = resource;</span>
<a href="#l36.969"></a><span id="l36.969" class="difflineminus">-            break;</span>
<a href="#l36.970"></a><span id="l36.970" class="difflineminus">-        }</span>
<a href="#l36.971"></a><span id="l36.971" class="difflineminus">-</span>
<a href="#l36.972"></a><span id="l36.972" class="difflineminus">-        NS_RELEASE(resource);</span>
<a href="#l36.973"></a><span id="l36.973" class="difflineminus">-    } while (1);</span>
<a href="#l36.974"></a><span id="l36.974" class="difflineminus">-</span>
<a href="#l36.975"></a><span id="l36.975" class="difflineminus">-    return NS_OK;</span>
<a href="#l36.976"></a><span id="l36.976" class="difflineminus">-}</span>
<a href="#l36.977"></a><span id="l36.977" class="difflineminus">-</span>
<a href="#l36.978"></a><span id="l36.978" class="difflineminus">-</span>
<a href="#l36.979"></a><span id="l36.979" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l36.980"></a><span id="l36.980" class="difflineminus">-RDFServiceImpl::GetLiteral(const char16_t* aValue, nsIRDFLiteral** aLiteral)</span>
<a href="#l36.981"></a><span id="l36.981" class="difflineminus">-{</span>
<a href="#l36.982"></a><span id="l36.982" class="difflineminus">-    NS_ASSERTION(aValue != nullptr, &quot;null ptr&quot;);</span>
<a href="#l36.983"></a><span id="l36.983" class="difflineminus">-    if (! aValue)</span>
<a href="#l36.984"></a><span id="l36.984" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l36.985"></a><span id="l36.985" class="difflineminus">-</span>
<a href="#l36.986"></a><span id="l36.986" class="difflineminus">-    NS_ASSERTION(aLiteral != nullptr, &quot;null ptr&quot;);</span>
<a href="#l36.987"></a><span id="l36.987" class="difflineminus">-    if (! aLiteral)</span>
<a href="#l36.988"></a><span id="l36.988" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l36.989"></a><span id="l36.989" class="difflineminus">-</span>
<a href="#l36.990"></a><span id="l36.990" class="difflineminus">-    // See if we have one already cached</span>
<a href="#l36.991"></a><span id="l36.991" class="difflineminus">-    PLDHashEntryHdr *hdr = mLiterals.Search(aValue);</span>
<a href="#l36.992"></a><span id="l36.992" class="difflineminus">-    if (hdr) {</span>
<a href="#l36.993"></a><span id="l36.993" class="difflineminus">-        LiteralHashEntry *entry = static_cast&lt;LiteralHashEntry *&gt;(hdr);</span>
<a href="#l36.994"></a><span id="l36.994" class="difflineminus">-        NS_ADDREF(*aLiteral = entry-&gt;mLiteral);</span>
<a href="#l36.995"></a><span id="l36.995" class="difflineminus">-        return NS_OK;</span>
<a href="#l36.996"></a><span id="l36.996" class="difflineminus">-    }</span>
<a href="#l36.997"></a><span id="l36.997" class="difflineminus">-</span>
<a href="#l36.998"></a><span id="l36.998" class="difflineminus">-    // Nope. Create a new one</span>
<a href="#l36.999"></a><span id="l36.999" class="difflineminus">-    return LiteralImpl::Create(aValue, aLiteral);</span>
<a href="#l36.1000"></a><span id="l36.1000" class="difflineminus">-}</span>
<a href="#l36.1001"></a><span id="l36.1001" class="difflineminus">-</span>
<a href="#l36.1002"></a><span id="l36.1002" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l36.1003"></a><span id="l36.1003" class="difflineminus">-RDFServiceImpl::GetDateLiteral(PRTime aTime, nsIRDFDate** aResult)</span>
<a href="#l36.1004"></a><span id="l36.1004" class="difflineminus">-{</span>
<a href="#l36.1005"></a><span id="l36.1005" class="difflineminus">-    // See if we have one already cached</span>
<a href="#l36.1006"></a><span id="l36.1006" class="difflineminus">-    PLDHashEntryHdr *hdr = mDates.Search(&amp;aTime);</span>
<a href="#l36.1007"></a><span id="l36.1007" class="difflineminus">-    if (hdr) {</span>
<a href="#l36.1008"></a><span id="l36.1008" class="difflineminus">-        DateHashEntry *entry = static_cast&lt;DateHashEntry *&gt;(hdr);</span>
<a href="#l36.1009"></a><span id="l36.1009" class="difflineminus">-        NS_ADDREF(*aResult = entry-&gt;mDate);</span>
<a href="#l36.1010"></a><span id="l36.1010" class="difflineminus">-        return NS_OK;</span>
<a href="#l36.1011"></a><span id="l36.1011" class="difflineminus">-    }</span>
<a href="#l36.1012"></a><span id="l36.1012" class="difflineminus">-</span>
<a href="#l36.1013"></a><span id="l36.1013" class="difflineminus">-    DateImpl* result = new DateImpl(aTime);</span>
<a href="#l36.1014"></a><span id="l36.1014" class="difflineminus">-    if (! result)</span>
<a href="#l36.1015"></a><span id="l36.1015" class="difflineminus">-        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l36.1016"></a><span id="l36.1016" class="difflineminus">-</span>
<a href="#l36.1017"></a><span id="l36.1017" class="difflineminus">-    NS_ADDREF(*aResult = result);</span>
<a href="#l36.1018"></a><span id="l36.1018" class="difflineminus">-    return NS_OK;</span>
<a href="#l36.1019"></a><span id="l36.1019" class="difflineminus">-}</span>
<a href="#l36.1020"></a><span id="l36.1020" class="difflineminus">-</span>
<a href="#l36.1021"></a><span id="l36.1021" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l36.1022"></a><span id="l36.1022" class="difflineminus">-RDFServiceImpl::GetIntLiteral(int32_t aInt, nsIRDFInt** aResult)</span>
<a href="#l36.1023"></a><span id="l36.1023" class="difflineminus">-{</span>
<a href="#l36.1024"></a><span id="l36.1024" class="difflineminus">-    // See if we have one already cached</span>
<a href="#l36.1025"></a><span id="l36.1025" class="difflineminus">-    PLDHashEntryHdr *hdr = mInts.Search(&amp;aInt);</span>
<a href="#l36.1026"></a><span id="l36.1026" class="difflineminus">-    if (hdr) {</span>
<a href="#l36.1027"></a><span id="l36.1027" class="difflineminus">-        IntHashEntry *entry = static_cast&lt;IntHashEntry *&gt;(hdr);</span>
<a href="#l36.1028"></a><span id="l36.1028" class="difflineminus">-        NS_ADDREF(*aResult = entry-&gt;mInt);</span>
<a href="#l36.1029"></a><span id="l36.1029" class="difflineminus">-        return NS_OK;</span>
<a href="#l36.1030"></a><span id="l36.1030" class="difflineminus">-    }</span>
<a href="#l36.1031"></a><span id="l36.1031" class="difflineminus">-</span>
<a href="#l36.1032"></a><span id="l36.1032" class="difflineminus">-    IntImpl* result = new IntImpl(aInt);</span>
<a href="#l36.1033"></a><span id="l36.1033" class="difflineminus">-    if (! result)</span>
<a href="#l36.1034"></a><span id="l36.1034" class="difflineminus">-        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l36.1035"></a><span id="l36.1035" class="difflineminus">-</span>
<a href="#l36.1036"></a><span id="l36.1036" class="difflineminus">-    NS_ADDREF(*aResult = result);</span>
<a href="#l36.1037"></a><span id="l36.1037" class="difflineminus">-    return NS_OK;</span>
<a href="#l36.1038"></a><span id="l36.1038" class="difflineminus">-}</span>
<a href="#l36.1039"></a><span id="l36.1039" class="difflineminus">-</span>
<a href="#l36.1040"></a><span id="l36.1040" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l36.1041"></a><span id="l36.1041" class="difflineminus">-RDFServiceImpl::GetBlobLiteral(const uint8_t *aBytes, int32_t aLength,</span>
<a href="#l36.1042"></a><span id="l36.1042" class="difflineminus">-                               nsIRDFBlob **aResult)</span>
<a href="#l36.1043"></a><span id="l36.1043" class="difflineminus">-{</span>
<a href="#l36.1044"></a><span id="l36.1044" class="difflineminus">-    BlobImpl::Data key = { aLength, const_cast&lt;uint8_t *&gt;(aBytes) };</span>
<a href="#l36.1045"></a><span id="l36.1045" class="difflineminus">-</span>
<a href="#l36.1046"></a><span id="l36.1046" class="difflineminus">-    PLDHashEntryHdr *hdr = mBlobs.Search(&amp;key);</span>
<a href="#l36.1047"></a><span id="l36.1047" class="difflineminus">-    if (hdr) {</span>
<a href="#l36.1048"></a><span id="l36.1048" class="difflineminus">-        BlobHashEntry *entry = static_cast&lt;BlobHashEntry *&gt;(hdr);</span>
<a href="#l36.1049"></a><span id="l36.1049" class="difflineminus">-        NS_ADDREF(*aResult = entry-&gt;mBlob);</span>
<a href="#l36.1050"></a><span id="l36.1050" class="difflineminus">-        return NS_OK;</span>
<a href="#l36.1051"></a><span id="l36.1051" class="difflineminus">-    }</span>
<a href="#l36.1052"></a><span id="l36.1052" class="difflineminus">-</span>
<a href="#l36.1053"></a><span id="l36.1053" class="difflineminus">-    BlobImpl *result = new BlobImpl(aBytes, aLength);</span>
<a href="#l36.1054"></a><span id="l36.1054" class="difflineminus">-    if (! result)</span>
<a href="#l36.1055"></a><span id="l36.1055" class="difflineminus">-        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l36.1056"></a><span id="l36.1056" class="difflineminus">-</span>
<a href="#l36.1057"></a><span id="l36.1057" class="difflineminus">-    NS_ADDREF(*aResult = result);</span>
<a href="#l36.1058"></a><span id="l36.1058" class="difflineminus">-    return NS_OK;</span>
<a href="#l36.1059"></a><span id="l36.1059" class="difflineminus">-}</span>
<a href="#l36.1060"></a><span id="l36.1060" class="difflineminus">-</span>
<a href="#l36.1061"></a><span id="l36.1061" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l36.1062"></a><span id="l36.1062" class="difflineminus">-RDFServiceImpl::IsAnonymousResource(nsIRDFResource* aResource, bool* _result)</span>
<a href="#l36.1063"></a><span id="l36.1063" class="difflineminus">-{</span>
<a href="#l36.1064"></a><span id="l36.1064" class="difflineminus">-    NS_ASSERTION(aResource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l36.1065"></a><span id="l36.1065" class="difflineminus">-    if (! aResource)</span>
<a href="#l36.1066"></a><span id="l36.1066" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l36.1067"></a><span id="l36.1067" class="difflineminus">-</span>
<a href="#l36.1068"></a><span id="l36.1068" class="difflineminus">-    nsresult rv;</span>
<a href="#l36.1069"></a><span id="l36.1069" class="difflineminus">-</span>
<a href="#l36.1070"></a><span id="l36.1070" class="difflineminus">-    const char* uri;</span>
<a href="#l36.1071"></a><span id="l36.1071" class="difflineminus">-    rv = aResource-&gt;GetValueConst(&amp;uri);</span>
<a href="#l36.1072"></a><span id="l36.1072" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l36.1073"></a><span id="l36.1073" class="difflineminus">-</span>
<a href="#l36.1074"></a><span id="l36.1074" class="difflineminus">-    if ((uri[0] == 'r') &amp;&amp;</span>
<a href="#l36.1075"></a><span id="l36.1075" class="difflineminus">-        (uri[1] == 'd') &amp;&amp;</span>
<a href="#l36.1076"></a><span id="l36.1076" class="difflineminus">-        (uri[2] == 'f') &amp;&amp;</span>
<a href="#l36.1077"></a><span id="l36.1077" class="difflineminus">-        (uri[3] == ':') &amp;&amp;</span>
<a href="#l36.1078"></a><span id="l36.1078" class="difflineminus">-        (uri[4] == '#') &amp;&amp;</span>
<a href="#l36.1079"></a><span id="l36.1079" class="difflineminus">-        (uri[5] == '$')) {</span>
<a href="#l36.1080"></a><span id="l36.1080" class="difflineminus">-        *_result = true;</span>
<a href="#l36.1081"></a><span id="l36.1081" class="difflineminus">-    }</span>
<a href="#l36.1082"></a><span id="l36.1082" class="difflineminus">-    else {</span>
<a href="#l36.1083"></a><span id="l36.1083" class="difflineminus">-        *_result = false;</span>
<a href="#l36.1084"></a><span id="l36.1084" class="difflineminus">-    }</span>
<a href="#l36.1085"></a><span id="l36.1085" class="difflineminus">-</span>
<a href="#l36.1086"></a><span id="l36.1086" class="difflineminus">-    return NS_OK;</span>
<a href="#l36.1087"></a><span id="l36.1087" class="difflineminus">-}</span>
<a href="#l36.1088"></a><span id="l36.1088" class="difflineminus">-</span>
<a href="#l36.1089"></a><span id="l36.1089" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l36.1090"></a><span id="l36.1090" class="difflineminus">-RDFServiceImpl::RegisterResource(nsIRDFResource* aResource, bool aReplace)</span>
<a href="#l36.1091"></a><span id="l36.1091" class="difflineminus">-{</span>
<a href="#l36.1092"></a><span id="l36.1092" class="difflineminus">-    NS_ASSERTION(aResource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l36.1093"></a><span id="l36.1093" class="difflineminus">-    if (! aResource)</span>
<a href="#l36.1094"></a><span id="l36.1094" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l36.1095"></a><span id="l36.1095" class="difflineminus">-</span>
<a href="#l36.1096"></a><span id="l36.1096" class="difflineminus">-    nsresult rv;</span>
<a href="#l36.1097"></a><span id="l36.1097" class="difflineminus">-</span>
<a href="#l36.1098"></a><span id="l36.1098" class="difflineminus">-    const char* uri;</span>
<a href="#l36.1099"></a><span id="l36.1099" class="difflineminus">-    rv = aResource-&gt;GetValueConst(&amp;uri);</span>
<a href="#l36.1100"></a><span id="l36.1100" class="difflineminus">-    NS_ASSERTION(NS_SUCCEEDED(rv), &quot;unable to get URI from resource&quot;);</span>
<a href="#l36.1101"></a><span id="l36.1101" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l36.1102"></a><span id="l36.1102" class="difflineminus">-</span>
<a href="#l36.1103"></a><span id="l36.1103" class="difflineminus">-    NS_ASSERTION(uri != nullptr, &quot;resource has no URI&quot;);</span>
<a href="#l36.1104"></a><span id="l36.1104" class="difflineminus">-    if (! uri)</span>
<a href="#l36.1105"></a><span id="l36.1105" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l36.1106"></a><span id="l36.1106" class="difflineminus">-</span>
<a href="#l36.1107"></a><span id="l36.1107" class="difflineminus">-    PLDHashEntryHdr *hdr = mResources.Search(uri);</span>
<a href="#l36.1108"></a><span id="l36.1108" class="difflineminus">-    if (hdr) {</span>
<a href="#l36.1109"></a><span id="l36.1109" class="difflineminus">-        if (!aReplace) {</span>
<a href="#l36.1110"></a><span id="l36.1110" class="difflineminus">-            NS_WARNING(&quot;resource already registered, and replace not specified&quot;);</span>
<a href="#l36.1111"></a><span id="l36.1111" class="difflineminus">-            return NS_ERROR_FAILURE;    // already registered</span>
<a href="#l36.1112"></a><span id="l36.1112" class="difflineminus">-        }</span>
<a href="#l36.1113"></a><span id="l36.1113" class="difflineminus">-</span>
<a href="#l36.1114"></a><span id="l36.1114" class="difflineminus">-        // N.B., we do _not_ release the original resource because we</span>
<a href="#l36.1115"></a><span id="l36.1115" class="difflineminus">-        // only ever held a weak reference to it. We simply replace</span>
<a href="#l36.1116"></a><span id="l36.1116" class="difflineminus">-        // it.</span>
<a href="#l36.1117"></a><span id="l36.1117" class="difflineminus">-</span>
<a href="#l36.1118"></a><span id="l36.1118" class="difflineminus">-        MOZ_LOG(gLog, LogLevel::Debug,</span>
<a href="#l36.1119"></a><span id="l36.1119" class="difflineminus">-               (&quot;rdfserv   replace-resource [%p] &lt;-- [%p] %s&quot;,</span>
<a href="#l36.1120"></a><span id="l36.1120" class="difflineminus">-                static_cast&lt;ResourceHashEntry *&gt;(hdr)-&gt;mResource,</span>
<a href="#l36.1121"></a><span id="l36.1121" class="difflineminus">-                aResource, (const char*) uri));</span>
<a href="#l36.1122"></a><span id="l36.1122" class="difflineminus">-    }</span>
<a href="#l36.1123"></a><span id="l36.1123" class="difflineminus">-    else {</span>
<a href="#l36.1124"></a><span id="l36.1124" class="difflineminus">-        hdr = mResources.Add(uri, fallible);</span>
<a href="#l36.1125"></a><span id="l36.1125" class="difflineminus">-        if (! hdr)</span>
<a href="#l36.1126"></a><span id="l36.1126" class="difflineminus">-            return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l36.1127"></a><span id="l36.1127" class="difflineminus">-</span>
<a href="#l36.1128"></a><span id="l36.1128" class="difflineminus">-        MOZ_LOG(gLog, LogLevel::Debug,</span>
<a href="#l36.1129"></a><span id="l36.1129" class="difflineminus">-               (&quot;rdfserv   register-resource [%p] %s&quot;,</span>
<a href="#l36.1130"></a><span id="l36.1130" class="difflineminus">-                aResource, (const char*) uri));</span>
<a href="#l36.1131"></a><span id="l36.1131" class="difflineminus">-    }</span>
<a href="#l36.1132"></a><span id="l36.1132" class="difflineminus">-</span>
<a href="#l36.1133"></a><span id="l36.1133" class="difflineminus">-    // N.B., we only hold a weak reference to the resource: that way,</span>
<a href="#l36.1134"></a><span id="l36.1134" class="difflineminus">-    // the resource can be destroyed when the last refcount goes</span>
<a href="#l36.1135"></a><span id="l36.1135" class="difflineminus">-    // away. The single addref that the CreateResource() call made</span>
<a href="#l36.1136"></a><span id="l36.1136" class="difflineminus">-    // will be owned by the callee.</span>
<a href="#l36.1137"></a><span id="l36.1137" class="difflineminus">-    ResourceHashEntry *entry = static_cast&lt;ResourceHashEntry *&gt;(hdr);</span>
<a href="#l36.1138"></a><span id="l36.1138" class="difflineminus">-    entry-&gt;mResource = aResource;</span>
<a href="#l36.1139"></a><span id="l36.1139" class="difflineminus">-    entry-&gt;mKey = uri;</span>
<a href="#l36.1140"></a><span id="l36.1140" class="difflineminus">-</span>
<a href="#l36.1141"></a><span id="l36.1141" class="difflineminus">-    return NS_OK;</span>
<a href="#l36.1142"></a><span id="l36.1142" class="difflineminus">-}</span>
<a href="#l36.1143"></a><span id="l36.1143" class="difflineminus">-</span>
<a href="#l36.1144"></a><span id="l36.1144" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l36.1145"></a><span id="l36.1145" class="difflineminus">-RDFServiceImpl::UnregisterResource(nsIRDFResource* aResource)</span>
<a href="#l36.1146"></a><span id="l36.1146" class="difflineminus">-{</span>
<a href="#l36.1147"></a><span id="l36.1147" class="difflineminus">-    NS_ASSERTION(aResource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l36.1148"></a><span id="l36.1148" class="difflineminus">-    if (! aResource)</span>
<a href="#l36.1149"></a><span id="l36.1149" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l36.1150"></a><span id="l36.1150" class="difflineminus">-</span>
<a href="#l36.1151"></a><span id="l36.1151" class="difflineminus">-    nsresult rv;</span>
<a href="#l36.1152"></a><span id="l36.1152" class="difflineminus">-</span>
<a href="#l36.1153"></a><span id="l36.1153" class="difflineminus">-    const char* uri;</span>
<a href="#l36.1154"></a><span id="l36.1154" class="difflineminus">-    rv = aResource-&gt;GetValueConst(&amp;uri);</span>
<a href="#l36.1155"></a><span id="l36.1155" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l36.1156"></a><span id="l36.1156" class="difflineminus">-</span>
<a href="#l36.1157"></a><span id="l36.1157" class="difflineminus">-    NS_ASSERTION(uri != nullptr, &quot;resource has no URI&quot;);</span>
<a href="#l36.1158"></a><span id="l36.1158" class="difflineminus">-    if (! uri)</span>
<a href="#l36.1159"></a><span id="l36.1159" class="difflineminus">-        return NS_ERROR_UNEXPECTED;</span>
<a href="#l36.1160"></a><span id="l36.1160" class="difflineminus">-</span>
<a href="#l36.1161"></a><span id="l36.1161" class="difflineminus">-    MOZ_LOG(gLog, LogLevel::Debug,</span>
<a href="#l36.1162"></a><span id="l36.1162" class="difflineminus">-           (&quot;rdfserv unregister-resource [%p] %s&quot;,</span>
<a href="#l36.1163"></a><span id="l36.1163" class="difflineminus">-            aResource, (const char*) uri));</span>
<a href="#l36.1164"></a><span id="l36.1164" class="difflineminus">-</span>
<a href="#l36.1165"></a><span id="l36.1165" class="difflineminus">-#ifdef DEBUG</span>
<a href="#l36.1166"></a><span id="l36.1166" class="difflineminus">-    if (!mResources.Search(uri))</span>
<a href="#l36.1167"></a><span id="l36.1167" class="difflineminus">-        NS_WARNING(&quot;resource was never registered&quot;);</span>
<a href="#l36.1168"></a><span id="l36.1168" class="difflineminus">-#endif</span>
<a href="#l36.1169"></a><span id="l36.1169" class="difflineminus">-</span>
<a href="#l36.1170"></a><span id="l36.1170" class="difflineminus">-    mResources.Remove(uri);</span>
<a href="#l36.1171"></a><span id="l36.1171" class="difflineminus">-    return NS_OK;</span>
<a href="#l36.1172"></a><span id="l36.1172" class="difflineminus">-}</span>
<a href="#l36.1173"></a><span id="l36.1173" class="difflineminus">-</span>
<a href="#l36.1174"></a><span id="l36.1174" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l36.1175"></a><span id="l36.1175" class="difflineminus">-RDFServiceImpl::RegisterDataSource(nsIRDFDataSource* aDataSource, bool aReplace)</span>
<a href="#l36.1176"></a><span id="l36.1176" class="difflineminus">-{</span>
<a href="#l36.1177"></a><span id="l36.1177" class="difflineminus">-    NS_ASSERTION(aDataSource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l36.1178"></a><span id="l36.1178" class="difflineminus">-    if (! aDataSource)</span>
<a href="#l36.1179"></a><span id="l36.1179" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l36.1180"></a><span id="l36.1180" class="difflineminus">-</span>
<a href="#l36.1181"></a><span id="l36.1181" class="difflineminus">-    nsresult rv;</span>
<a href="#l36.1182"></a><span id="l36.1182" class="difflineminus">-</span>
<a href="#l36.1183"></a><span id="l36.1183" class="difflineminus">-    nsAutoCString uri;</span>
<a href="#l36.1184"></a><span id="l36.1184" class="difflineminus">-    rv = aDataSource-&gt;GetURI(uri);</span>
<a href="#l36.1185"></a><span id="l36.1185" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l36.1186"></a><span id="l36.1186" class="difflineminus">-</span>
<a href="#l36.1187"></a><span id="l36.1187" class="difflineminus">-    PLHashEntry** hep =</span>
<a href="#l36.1188"></a><span id="l36.1188" class="difflineminus">-      PL_HashTableRawLookup(mNamedDataSources,</span>
<a href="#l36.1189"></a><span id="l36.1189" class="difflineminus">-                            (*mNamedDataSources-&gt;keyHash)(uri.get()),</span>
<a href="#l36.1190"></a><span id="l36.1190" class="difflineminus">-                            uri.get());</span>
<a href="#l36.1191"></a><span id="l36.1191" class="difflineminus">-</span>
<a href="#l36.1192"></a><span id="l36.1192" class="difflineminus">-    if (*hep) {</span>
<a href="#l36.1193"></a><span id="l36.1193" class="difflineminus">-        if (! aReplace)</span>
<a href="#l36.1194"></a><span id="l36.1194" class="difflineminus">-            return NS_ERROR_FAILURE; // already registered</span>
<a href="#l36.1195"></a><span id="l36.1195" class="difflineminus">-</span>
<a href="#l36.1196"></a><span id="l36.1196" class="difflineminus">-        // N.B., we only hold a weak reference to the datasource, so</span>
<a href="#l36.1197"></a><span id="l36.1197" class="difflineminus">-        // just replace the old with the new and don't touch any</span>
<a href="#l36.1198"></a><span id="l36.1198" class="difflineminus">-        // refcounts.</span>
<a href="#l36.1199"></a><span id="l36.1199" class="difflineminus">-        MOZ_LOG(gLog, LogLevel::Debug,</span>
<a href="#l36.1200"></a><span id="l36.1200" class="difflineminus">-               (&quot;rdfserv    replace-datasource [%p] &lt;-- [%p] %s&quot;,</span>
<a href="#l36.1201"></a><span id="l36.1201" class="difflineminus">-                (*hep)-&gt;value, aDataSource, uri.get()));</span>
<a href="#l36.1202"></a><span id="l36.1202" class="difflineminus">-</span>
<a href="#l36.1203"></a><span id="l36.1203" class="difflineminus">-        (*hep)-&gt;value = aDataSource;</span>
<a href="#l36.1204"></a><span id="l36.1204" class="difflineminus">-    }</span>
<a href="#l36.1205"></a><span id="l36.1205" class="difflineminus">-    else {</span>
<a href="#l36.1206"></a><span id="l36.1206" class="difflineminus">-        const char* key = PL_strdup(uri.get());</span>
<a href="#l36.1207"></a><span id="l36.1207" class="difflineminus">-        if (! key)</span>
<a href="#l36.1208"></a><span id="l36.1208" class="difflineminus">-            return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l36.1209"></a><span id="l36.1209" class="difflineminus">-</span>
<a href="#l36.1210"></a><span id="l36.1210" class="difflineminus">-        PL_HashTableAdd(mNamedDataSources, key, aDataSource);</span>
<a href="#l36.1211"></a><span id="l36.1211" class="difflineminus">-</span>
<a href="#l36.1212"></a><span id="l36.1212" class="difflineminus">-        MOZ_LOG(gLog, LogLevel::Debug,</span>
<a href="#l36.1213"></a><span id="l36.1213" class="difflineminus">-               (&quot;rdfserv   register-datasource [%p] %s&quot;,</span>
<a href="#l36.1214"></a><span id="l36.1214" class="difflineminus">-                aDataSource, uri.get()));</span>
<a href="#l36.1215"></a><span id="l36.1215" class="difflineminus">-</span>
<a href="#l36.1216"></a><span id="l36.1216" class="difflineminus">-        // N.B., we only hold a weak reference to the datasource, so don't</span>
<a href="#l36.1217"></a><span id="l36.1217" class="difflineminus">-        // addref.</span>
<a href="#l36.1218"></a><span id="l36.1218" class="difflineminus">-    }</span>
<a href="#l36.1219"></a><span id="l36.1219" class="difflineminus">-</span>
<a href="#l36.1220"></a><span id="l36.1220" class="difflineminus">-    return NS_OK;</span>
<a href="#l36.1221"></a><span id="l36.1221" class="difflineminus">-}</span>
<a href="#l36.1222"></a><span id="l36.1222" class="difflineminus">-</span>
<a href="#l36.1223"></a><span id="l36.1223" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l36.1224"></a><span id="l36.1224" class="difflineminus">-RDFServiceImpl::UnregisterDataSource(nsIRDFDataSource* aDataSource)</span>
<a href="#l36.1225"></a><span id="l36.1225" class="difflineminus">-{</span>
<a href="#l36.1226"></a><span id="l36.1226" class="difflineminus">-    NS_ASSERTION(aDataSource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l36.1227"></a><span id="l36.1227" class="difflineminus">-    if (! aDataSource)</span>
<a href="#l36.1228"></a><span id="l36.1228" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l36.1229"></a><span id="l36.1229" class="difflineminus">-</span>
<a href="#l36.1230"></a><span id="l36.1230" class="difflineminus">-    nsresult rv;</span>
<a href="#l36.1231"></a><span id="l36.1231" class="difflineminus">-</span>
<a href="#l36.1232"></a><span id="l36.1232" class="difflineminus">-    nsAutoCString uri;</span>
<a href="#l36.1233"></a><span id="l36.1233" class="difflineminus">-    rv = aDataSource-&gt;GetURI(uri);</span>
<a href="#l36.1234"></a><span id="l36.1234" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l36.1235"></a><span id="l36.1235" class="difflineminus">-</span>
<a href="#l36.1236"></a><span id="l36.1236" class="difflineminus">-    //NS_ASSERTION(uri != nullptr, &quot;datasource has no URI&quot;);</span>
<a href="#l36.1237"></a><span id="l36.1237" class="difflineminus">-    if (uri.IsVoid())</span>
<a href="#l36.1238"></a><span id="l36.1238" class="difflineminus">-        return NS_ERROR_UNEXPECTED;</span>
<a href="#l36.1239"></a><span id="l36.1239" class="difflineminus">-</span>
<a href="#l36.1240"></a><span id="l36.1240" class="difflineminus">-    PLHashEntry** hep =</span>
<a href="#l36.1241"></a><span id="l36.1241" class="difflineminus">-        PL_HashTableRawLookup(mNamedDataSources,</span>
<a href="#l36.1242"></a><span id="l36.1242" class="difflineminus">-                              (*mNamedDataSources-&gt;keyHash)(uri.get()),</span>
<a href="#l36.1243"></a><span id="l36.1243" class="difflineminus">-                              uri.get());</span>
<a href="#l36.1244"></a><span id="l36.1244" class="difflineminus">-</span>
<a href="#l36.1245"></a><span id="l36.1245" class="difflineminus">-    // It may well be that this datasource was never registered. If</span>
<a href="#l36.1246"></a><span id="l36.1246" class="difflineminus">-    // so, don't unregister it.</span>
<a href="#l36.1247"></a><span id="l36.1247" class="difflineminus">-    if (! *hep || ((*hep)-&gt;value != aDataSource))</span>
<a href="#l36.1248"></a><span id="l36.1248" class="difflineminus">-        return NS_OK;</span>
<a href="#l36.1249"></a><span id="l36.1249" class="difflineminus">-</span>
<a href="#l36.1250"></a><span id="l36.1250" class="difflineminus">-    // N.B., we only held a weak reference to the datasource, so we</span>
<a href="#l36.1251"></a><span id="l36.1251" class="difflineminus">-    // don't release here.</span>
<a href="#l36.1252"></a><span id="l36.1252" class="difflineminus">-    PL_HashTableRawRemove(mNamedDataSources, hep, *hep);</span>
<a href="#l36.1253"></a><span id="l36.1253" class="difflineminus">-</span>
<a href="#l36.1254"></a><span id="l36.1254" class="difflineminus">-    MOZ_LOG(gLog, LogLevel::Debug,</span>
<a href="#l36.1255"></a><span id="l36.1255" class="difflineminus">-           (&quot;rdfserv unregister-datasource [%p] %s&quot;,</span>
<a href="#l36.1256"></a><span id="l36.1256" class="difflineminus">-            aDataSource, uri.get()));</span>
<a href="#l36.1257"></a><span id="l36.1257" class="difflineminus">-</span>
<a href="#l36.1258"></a><span id="l36.1258" class="difflineminus">-    return NS_OK;</span>
<a href="#l36.1259"></a><span id="l36.1259" class="difflineminus">-}</span>
<a href="#l36.1260"></a><span id="l36.1260" class="difflineminus">-</span>
<a href="#l36.1261"></a><span id="l36.1261" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l36.1262"></a><span id="l36.1262" class="difflineminus">-RDFServiceImpl::GetDataSource(const char* aURI, nsIRDFDataSource** aDataSource)</span>
<a href="#l36.1263"></a><span id="l36.1263" class="difflineminus">-{</span>
<a href="#l36.1264"></a><span id="l36.1264" class="difflineminus">-    // Use the other GetDataSource and ask for a non-blocking Refresh.</span>
<a href="#l36.1265"></a><span id="l36.1265" class="difflineminus">-    // If you wanted it loaded synchronously, then you should've tried to do it</span>
<a href="#l36.1266"></a><span id="l36.1266" class="difflineminus">-    // yourself, or used GetDataSourceBlocking.</span>
<a href="#l36.1267"></a><span id="l36.1267" class="difflineminus">-    return GetDataSource( aURI, false, aDataSource );</span>
<a href="#l36.1268"></a><span id="l36.1268" class="difflineminus">-}</span>
<a href="#l36.1269"></a><span id="l36.1269" class="difflineminus">-</span>
<a href="#l36.1270"></a><span id="l36.1270" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l36.1271"></a><span id="l36.1271" class="difflineminus">-RDFServiceImpl::GetDataSourceBlocking(const char* aURI, nsIRDFDataSource** aDataSource)</span>
<a href="#l36.1272"></a><span id="l36.1272" class="difflineminus">-{</span>
<a href="#l36.1273"></a><span id="l36.1273" class="difflineminus">-    // Use GetDataSource and ask for a blocking Refresh.</span>
<a href="#l36.1274"></a><span id="l36.1274" class="difflineminus">-    return GetDataSource( aURI, true, aDataSource );</span>
<a href="#l36.1275"></a><span id="l36.1275" class="difflineminus">-}</span>
<a href="#l36.1276"></a><span id="l36.1276" class="difflineminus">-</span>
<a href="#l36.1277"></a><span id="l36.1277" class="difflineminus">-nsresult</span>
<a href="#l36.1278"></a><span id="l36.1278" class="difflineminus">-RDFServiceImpl::GetDataSource(const char* aURI, bool aBlock, nsIRDFDataSource** aDataSource)</span>
<a href="#l36.1279"></a><span id="l36.1279" class="difflineminus">-{</span>
<a href="#l36.1280"></a><span id="l36.1280" class="difflineminus">-    NS_ASSERTION(aURI != nullptr, &quot;null ptr&quot;);</span>
<a href="#l36.1281"></a><span id="l36.1281" class="difflineminus">-    if (! aURI)</span>
<a href="#l36.1282"></a><span id="l36.1282" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l36.1283"></a><span id="l36.1283" class="difflineminus">-</span>
<a href="#l36.1284"></a><span id="l36.1284" class="difflineminus">-    nsresult rv;</span>
<a href="#l36.1285"></a><span id="l36.1285" class="difflineminus">-</span>
<a href="#l36.1286"></a><span id="l36.1286" class="difflineminus">-    // Attempt to canonify the URI before we look for it in the</span>
<a href="#l36.1287"></a><span id="l36.1287" class="difflineminus">-    // cache. We won't bother doing this on `rdf:' URIs to avoid</span>
<a href="#l36.1288"></a><span id="l36.1288" class="difflineminus">-    // useless (and expensive) protocol handler lookups.</span>
<a href="#l36.1289"></a><span id="l36.1289" class="difflineminus">-    nsAutoCString spec(aURI);</span>
<a href="#l36.1290"></a><span id="l36.1290" class="difflineminus">-</span>
<a href="#l36.1291"></a><span id="l36.1291" class="difflineminus">-    if (!StringBeginsWith(spec, NS_LITERAL_CSTRING(&quot;rdf:&quot;))) {</span>
<a href="#l36.1292"></a><span id="l36.1292" class="difflineminus">-        nsCOMPtr&lt;nsIURI&gt; uri;</span>
<a href="#l36.1293"></a><span id="l36.1293" class="difflineminus">-        NS_NewURI(getter_AddRefs(uri), spec);</span>
<a href="#l36.1294"></a><span id="l36.1294" class="difflineminus">-        if (uri) {</span>
<a href="#l36.1295"></a><span id="l36.1295" class="difflineminus">-            rv = uri-&gt;GetSpec(spec);</span>
<a href="#l36.1296"></a><span id="l36.1296" class="difflineminus">-            if (NS_FAILED(rv)) return rv;</span>
<a href="#l36.1297"></a><span id="l36.1297" class="difflineminus">-        }</span>
<a href="#l36.1298"></a><span id="l36.1298" class="difflineminus">-    }</span>
<a href="#l36.1299"></a><span id="l36.1299" class="difflineminus">-</span>
<a href="#l36.1300"></a><span id="l36.1300" class="difflineminus">-    // First, check the cache to see if we already have this</span>
<a href="#l36.1301"></a><span id="l36.1301" class="difflineminus">-    // datasource loaded and initialized.</span>
<a href="#l36.1302"></a><span id="l36.1302" class="difflineminus">-    {</span>
<a href="#l36.1303"></a><span id="l36.1303" class="difflineminus">-        nsIRDFDataSource* cached =</span>
<a href="#l36.1304"></a><span id="l36.1304" class="difflineminus">-            static_cast&lt;nsIRDFDataSource*&gt;(PL_HashTableLookup(mNamedDataSources, spec.get()));</span>
<a href="#l36.1305"></a><span id="l36.1305" class="difflineminus">-</span>
<a href="#l36.1306"></a><span id="l36.1306" class="difflineminus">-        if (cached) {</span>
<a href="#l36.1307"></a><span id="l36.1307" class="difflineminus">-            NS_ADDREF(cached);</span>
<a href="#l36.1308"></a><span id="l36.1308" class="difflineminus">-            *aDataSource = cached;</span>
<a href="#l36.1309"></a><span id="l36.1309" class="difflineminus">-            return NS_OK;</span>
<a href="#l36.1310"></a><span id="l36.1310" class="difflineminus">-        }</span>
<a href="#l36.1311"></a><span id="l36.1311" class="difflineminus">-    }</span>
<a href="#l36.1312"></a><span id="l36.1312" class="difflineminus">-</span>
<a href="#l36.1313"></a><span id="l36.1313" class="difflineminus">-    // Nope. So go to the repository to try to create it.</span>
<a href="#l36.1314"></a><span id="l36.1314" class="difflineminus">-    nsCOMPtr&lt;nsIRDFDataSource&gt; ds;</span>
<a href="#l36.1315"></a><span id="l36.1315" class="difflineminus">-    if (StringBeginsWith(spec, NS_LITERAL_CSTRING(&quot;rdf:&quot;))) {</span>
<a href="#l36.1316"></a><span id="l36.1316" class="difflineminus">-        // It's a built-in data source. Convert it to a contract ID.</span>
<a href="#l36.1317"></a><span id="l36.1317" class="difflineminus">-        nsAutoCString contractID(</span>
<a href="#l36.1318"></a><span id="l36.1318" class="difflineminus">-                NS_LITERAL_CSTRING(NS_RDF_DATASOURCE_CONTRACTID_PREFIX) +</span>
<a href="#l36.1319"></a><span id="l36.1319" class="difflineminus">-                Substring(spec, 4, spec.Length() - 4));</span>
<a href="#l36.1320"></a><span id="l36.1320" class="difflineminus">-</span>
<a href="#l36.1321"></a><span id="l36.1321" class="difflineminus">-        // Strip params to get ``base'' contractID for data source.</span>
<a href="#l36.1322"></a><span id="l36.1322" class="difflineminus">-        int32_t p = contractID.FindChar(char16_t('&amp;'));</span>
<a href="#l36.1323"></a><span id="l36.1323" class="difflineminus">-        if (p &gt;= 0)</span>
<a href="#l36.1324"></a><span id="l36.1324" class="difflineminus">-            contractID.Truncate(p);</span>
<a href="#l36.1325"></a><span id="l36.1325" class="difflineminus">-</span>
<a href="#l36.1326"></a><span id="l36.1326" class="difflineminus">-        ds = do_GetService(contractID.get(), &amp;rv);</span>
<a href="#l36.1327"></a><span id="l36.1327" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l36.1328"></a><span id="l36.1328" class="difflineminus">-</span>
<a href="#l36.1329"></a><span id="l36.1329" class="difflineminus">-        nsCOMPtr&lt;nsIRDFRemoteDataSource&gt; remote = do_QueryInterface(ds);</span>
<a href="#l36.1330"></a><span id="l36.1330" class="difflineminus">-        if (remote) {</span>
<a href="#l36.1331"></a><span id="l36.1331" class="difflineminus">-            rv = remote-&gt;Init(spec.get());</span>
<a href="#l36.1332"></a><span id="l36.1332" class="difflineminus">-            if (NS_FAILED(rv)) return rv;</span>
<a href="#l36.1333"></a><span id="l36.1333" class="difflineminus">-        }</span>
<a href="#l36.1334"></a><span id="l36.1334" class="difflineminus">-    }</span>
<a href="#l36.1335"></a><span id="l36.1335" class="difflineminus">-    else {</span>
<a href="#l36.1336"></a><span id="l36.1336" class="difflineminus">-        // Try to load this as an RDF/XML data source</span>
<a href="#l36.1337"></a><span id="l36.1337" class="difflineminus">-        ds = do_CreateInstance(kRDFXMLDataSourceCID, &amp;rv);</span>
<a href="#l36.1338"></a><span id="l36.1338" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l36.1339"></a><span id="l36.1339" class="difflineminus">-</span>
<a href="#l36.1340"></a><span id="l36.1340" class="difflineminus">-        nsCOMPtr&lt;nsIRDFRemoteDataSource&gt; remote(do_QueryInterface(ds));</span>
<a href="#l36.1341"></a><span id="l36.1341" class="difflineminus">-        NS_ASSERTION(remote, &quot;not a remote RDF/XML data source!&quot;);</span>
<a href="#l36.1342"></a><span id="l36.1342" class="difflineminus">-        if (! remote) return NS_ERROR_UNEXPECTED;</span>
<a href="#l36.1343"></a><span id="l36.1343" class="difflineminus">-</span>
<a href="#l36.1344"></a><span id="l36.1344" class="difflineminus">-        rv = remote-&gt;Init(spec.get());</span>
<a href="#l36.1345"></a><span id="l36.1345" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l36.1346"></a><span id="l36.1346" class="difflineminus">-</span>
<a href="#l36.1347"></a><span id="l36.1347" class="difflineminus">-        rv = remote-&gt;Refresh(aBlock);</span>
<a href="#l36.1348"></a><span id="l36.1348" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l36.1349"></a><span id="l36.1349" class="difflineminus">-    }</span>
<a href="#l36.1350"></a><span id="l36.1350" class="difflineminus">-</span>
<a href="#l36.1351"></a><span id="l36.1351" class="difflineminus">-    *aDataSource = ds;</span>
<a href="#l36.1352"></a><span id="l36.1352" class="difflineminus">-    NS_ADDREF(*aDataSource);</span>
<a href="#l36.1353"></a><span id="l36.1353" class="difflineminus">-    return NS_OK;</span>
<a href="#l36.1354"></a><span id="l36.1354" class="difflineminus">-}</span>
<a href="#l36.1355"></a><span id="l36.1355" class="difflineminus">-</span>
<a href="#l36.1356"></a><span id="l36.1356" class="difflineminus">-////////////////////////////////////////////////////////////////////////</span>
<a href="#l36.1357"></a><span id="l36.1357" class="difflineminus">-</span>
<a href="#l36.1358"></a><span id="l36.1358" class="difflineminus">-nsresult</span>
<a href="#l36.1359"></a><span id="l36.1359" class="difflineminus">-RDFServiceImpl::RegisterLiteral(nsIRDFLiteral* aLiteral)</span>
<a href="#l36.1360"></a><span id="l36.1360" class="difflineminus">-{</span>
<a href="#l36.1361"></a><span id="l36.1361" class="difflineminus">-    const char16_t* value;</span>
<a href="#l36.1362"></a><span id="l36.1362" class="difflineminus">-    aLiteral-&gt;GetValueConst(&amp;value);</span>
<a href="#l36.1363"></a><span id="l36.1363" class="difflineminus">-</span>
<a href="#l36.1364"></a><span id="l36.1364" class="difflineminus">-    NS_ASSERTION(!mLiterals.Search(value), &quot;literal already registered&quot;);</span>
<a href="#l36.1365"></a><span id="l36.1365" class="difflineminus">-</span>
<a href="#l36.1366"></a><span id="l36.1366" class="difflineminus">-    PLDHashEntryHdr *hdr = mLiterals.Add(value, fallible);</span>
<a href="#l36.1367"></a><span id="l36.1367" class="difflineminus">-    if (! hdr)</span>
<a href="#l36.1368"></a><span id="l36.1368" class="difflineminus">-        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l36.1369"></a><span id="l36.1369" class="difflineminus">-</span>
<a href="#l36.1370"></a><span id="l36.1370" class="difflineminus">-    LiteralHashEntry *entry = static_cast&lt;LiteralHashEntry *&gt;(hdr);</span>
<a href="#l36.1371"></a><span id="l36.1371" class="difflineminus">-</span>
<a href="#l36.1372"></a><span id="l36.1372" class="difflineminus">-    // N.B., we only hold a weak reference to the literal: that</span>
<a href="#l36.1373"></a><span id="l36.1373" class="difflineminus">-    // way, the literal can be destroyed when the last refcount</span>
<a href="#l36.1374"></a><span id="l36.1374" class="difflineminus">-    // goes away. The single addref that the CreateLiteral() call</span>
<a href="#l36.1375"></a><span id="l36.1375" class="difflineminus">-    // made will be owned by the callee.</span>
<a href="#l36.1376"></a><span id="l36.1376" class="difflineminus">-    entry-&gt;mLiteral = aLiteral;</span>
<a href="#l36.1377"></a><span id="l36.1377" class="difflineminus">-    entry-&gt;mKey = value;</span>
<a href="#l36.1378"></a><span id="l36.1378" class="difflineminus">-</span>
<a href="#l36.1379"></a><span id="l36.1379" class="difflineminus">-    MOZ_LOG(gLog, LogLevel::Debug,</span>
<a href="#l36.1380"></a><span id="l36.1380" class="difflineminus">-           (&quot;rdfserv   register-literal [%p] %s&quot;,</span>
<a href="#l36.1381"></a><span id="l36.1381" class="difflineminus">-            aLiteral, NS_ConvertUTF16toUTF8(value).get()));</span>
<a href="#l36.1382"></a><span id="l36.1382" class="difflineminus">-</span>
<a href="#l36.1383"></a><span id="l36.1383" class="difflineminus">-    return NS_OK;</span>
<a href="#l36.1384"></a><span id="l36.1384" class="difflineminus">-}</span>
<a href="#l36.1385"></a><span id="l36.1385" class="difflineminus">-</span>
<a href="#l36.1386"></a><span id="l36.1386" class="difflineminus">-</span>
<a href="#l36.1387"></a><span id="l36.1387" class="difflineminus">-nsresult</span>
<a href="#l36.1388"></a><span id="l36.1388" class="difflineminus">-RDFServiceImpl::UnregisterLiteral(nsIRDFLiteral* aLiteral)</span>
<a href="#l36.1389"></a><span id="l36.1389" class="difflineminus">-{</span>
<a href="#l36.1390"></a><span id="l36.1390" class="difflineminus">-    const char16_t* value;</span>
<a href="#l36.1391"></a><span id="l36.1391" class="difflineminus">-    aLiteral-&gt;GetValueConst(&amp;value);</span>
<a href="#l36.1392"></a><span id="l36.1392" class="difflineminus">-</span>
<a href="#l36.1393"></a><span id="l36.1393" class="difflineminus">-    NS_ASSERTION(mLiterals.Search(value), &quot;literal was never registered&quot;);</span>
<a href="#l36.1394"></a><span id="l36.1394" class="difflineminus">-</span>
<a href="#l36.1395"></a><span id="l36.1395" class="difflineminus">-    mLiterals.Remove(value);</span>
<a href="#l36.1396"></a><span id="l36.1396" class="difflineminus">-</span>
<a href="#l36.1397"></a><span id="l36.1397" class="difflineminus">-    // N.B. that we _don't_ release the literal: we only held a weak</span>
<a href="#l36.1398"></a><span id="l36.1398" class="difflineminus">-    // reference to it in the hashtable.</span>
<a href="#l36.1399"></a><span id="l36.1399" class="difflineminus">-    MOZ_LOG(gLog, LogLevel::Debug,</span>
<a href="#l36.1400"></a><span id="l36.1400" class="difflineminus">-           (&quot;rdfserv unregister-literal [%p] %s&quot;,</span>
<a href="#l36.1401"></a><span id="l36.1401" class="difflineminus">-            aLiteral, NS_ConvertUTF16toUTF8(value).get()));</span>
<a href="#l36.1402"></a><span id="l36.1402" class="difflineminus">-</span>
<a href="#l36.1403"></a><span id="l36.1403" class="difflineminus">-    return NS_OK;</span>
<a href="#l36.1404"></a><span id="l36.1404" class="difflineminus">-}</span>
<a href="#l36.1405"></a><span id="l36.1405" class="difflineminus">-</span>
<a href="#l36.1406"></a><span id="l36.1406" class="difflineminus">-//----------------------------------------------------------------------</span>
<a href="#l36.1407"></a><span id="l36.1407" class="difflineminus">-</span>
<a href="#l36.1408"></a><span id="l36.1408" class="difflineminus">-nsresult</span>
<a href="#l36.1409"></a><span id="l36.1409" class="difflineminus">-RDFServiceImpl::RegisterInt(nsIRDFInt* aInt)</span>
<a href="#l36.1410"></a><span id="l36.1410" class="difflineminus">-{</span>
<a href="#l36.1411"></a><span id="l36.1411" class="difflineminus">-    int32_t value;</span>
<a href="#l36.1412"></a><span id="l36.1412" class="difflineminus">-    aInt-&gt;GetValue(&amp;value);</span>
<a href="#l36.1413"></a><span id="l36.1413" class="difflineminus">-</span>
<a href="#l36.1414"></a><span id="l36.1414" class="difflineminus">-    NS_ASSERTION(!mInts.Search(&amp;value), &quot;int already registered&quot;);</span>
<a href="#l36.1415"></a><span id="l36.1415" class="difflineminus">-</span>
<a href="#l36.1416"></a><span id="l36.1416" class="difflineminus">-    PLDHashEntryHdr *hdr = mInts.Add(&amp;value, fallible);</span>
<a href="#l36.1417"></a><span id="l36.1417" class="difflineminus">-    if (! hdr)</span>
<a href="#l36.1418"></a><span id="l36.1418" class="difflineminus">-        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l36.1419"></a><span id="l36.1419" class="difflineminus">-</span>
<a href="#l36.1420"></a><span id="l36.1420" class="difflineminus">-    IntHashEntry *entry = static_cast&lt;IntHashEntry *&gt;(hdr);</span>
<a href="#l36.1421"></a><span id="l36.1421" class="difflineminus">-</span>
<a href="#l36.1422"></a><span id="l36.1422" class="difflineminus">-    // N.B., we only hold a weak reference to the literal: that</span>
<a href="#l36.1423"></a><span id="l36.1423" class="difflineminus">-    // way, the literal can be destroyed when the last refcount</span>
<a href="#l36.1424"></a><span id="l36.1424" class="difflineminus">-    // goes away. The single addref that the CreateInt() call</span>
<a href="#l36.1425"></a><span id="l36.1425" class="difflineminus">-    // made will be owned by the callee.</span>
<a href="#l36.1426"></a><span id="l36.1426" class="difflineminus">-    entry-&gt;mInt = aInt;</span>
<a href="#l36.1427"></a><span id="l36.1427" class="difflineminus">-    entry-&gt;mKey = value;</span>
<a href="#l36.1428"></a><span id="l36.1428" class="difflineminus">-</span>
<a href="#l36.1429"></a><span id="l36.1429" class="difflineminus">-    MOZ_LOG(gLog, LogLevel::Debug,</span>
<a href="#l36.1430"></a><span id="l36.1430" class="difflineminus">-           (&quot;rdfserv   register-int [%p] %d&quot;,</span>
<a href="#l36.1431"></a><span id="l36.1431" class="difflineminus">-            aInt, value));</span>
<a href="#l36.1432"></a><span id="l36.1432" class="difflineminus">-</span>
<a href="#l36.1433"></a><span id="l36.1433" class="difflineminus">-    return NS_OK;</span>
<a href="#l36.1434"></a><span id="l36.1434" class="difflineminus">-}</span>
<a href="#l36.1435"></a><span id="l36.1435" class="difflineminus">-</span>
<a href="#l36.1436"></a><span id="l36.1436" class="difflineminus">-</span>
<a href="#l36.1437"></a><span id="l36.1437" class="difflineminus">-nsresult</span>
<a href="#l36.1438"></a><span id="l36.1438" class="difflineminus">-RDFServiceImpl::UnregisterInt(nsIRDFInt* aInt)</span>
<a href="#l36.1439"></a><span id="l36.1439" class="difflineminus">-{</span>
<a href="#l36.1440"></a><span id="l36.1440" class="difflineminus">-    int32_t value;</span>
<a href="#l36.1441"></a><span id="l36.1441" class="difflineminus">-    aInt-&gt;GetValue(&amp;value);</span>
<a href="#l36.1442"></a><span id="l36.1442" class="difflineminus">-</span>
<a href="#l36.1443"></a><span id="l36.1443" class="difflineminus">-    NS_ASSERTION(mInts.Search(&amp;value), &quot;int was never registered&quot;);</span>
<a href="#l36.1444"></a><span id="l36.1444" class="difflineminus">-</span>
<a href="#l36.1445"></a><span id="l36.1445" class="difflineminus">-    mInts.Remove(&amp;value);</span>
<a href="#l36.1446"></a><span id="l36.1446" class="difflineminus">-</span>
<a href="#l36.1447"></a><span id="l36.1447" class="difflineminus">-    // N.B. that we _don't_ release the literal: we only held a weak</span>
<a href="#l36.1448"></a><span id="l36.1448" class="difflineminus">-    // reference to it in the hashtable.</span>
<a href="#l36.1449"></a><span id="l36.1449" class="difflineminus">-    MOZ_LOG(gLog, LogLevel::Debug,</span>
<a href="#l36.1450"></a><span id="l36.1450" class="difflineminus">-           (&quot;rdfserv unregister-int [%p] %d&quot;,</span>
<a href="#l36.1451"></a><span id="l36.1451" class="difflineminus">-            aInt, value));</span>
<a href="#l36.1452"></a><span id="l36.1452" class="difflineminus">-</span>
<a href="#l36.1453"></a><span id="l36.1453" class="difflineminus">-    return NS_OK;</span>
<a href="#l36.1454"></a><span id="l36.1454" class="difflineminus">-}</span>
<a href="#l36.1455"></a><span id="l36.1455" class="difflineminus">-</span>
<a href="#l36.1456"></a><span id="l36.1456" class="difflineminus">-//----------------------------------------------------------------------</span>
<a href="#l36.1457"></a><span id="l36.1457" class="difflineminus">-</span>
<a href="#l36.1458"></a><span id="l36.1458" class="difflineminus">-nsresult</span>
<a href="#l36.1459"></a><span id="l36.1459" class="difflineminus">-RDFServiceImpl::RegisterDate(nsIRDFDate* aDate)</span>
<a href="#l36.1460"></a><span id="l36.1460" class="difflineminus">-{</span>
<a href="#l36.1461"></a><span id="l36.1461" class="difflineminus">-    PRTime value;</span>
<a href="#l36.1462"></a><span id="l36.1462" class="difflineminus">-    aDate-&gt;GetValue(&amp;value);</span>
<a href="#l36.1463"></a><span id="l36.1463" class="difflineminus">-</span>
<a href="#l36.1464"></a><span id="l36.1464" class="difflineminus">-    NS_ASSERTION(!mDates.Search(&amp;value), &quot;date already registered&quot;);</span>
<a href="#l36.1465"></a><span id="l36.1465" class="difflineminus">-</span>
<a href="#l36.1466"></a><span id="l36.1466" class="difflineminus">-    PLDHashEntryHdr *hdr = mDates.Add(&amp;value, fallible);</span>
<a href="#l36.1467"></a><span id="l36.1467" class="difflineminus">-    if (! hdr)</span>
<a href="#l36.1468"></a><span id="l36.1468" class="difflineminus">-        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l36.1469"></a><span id="l36.1469" class="difflineminus">-</span>
<a href="#l36.1470"></a><span id="l36.1470" class="difflineminus">-    DateHashEntry *entry = static_cast&lt;DateHashEntry *&gt;(hdr);</span>
<a href="#l36.1471"></a><span id="l36.1471" class="difflineminus">-</span>
<a href="#l36.1472"></a><span id="l36.1472" class="difflineminus">-    // N.B., we only hold a weak reference to the literal: that</span>
<a href="#l36.1473"></a><span id="l36.1473" class="difflineminus">-    // way, the literal can be destroyed when the last refcount</span>
<a href="#l36.1474"></a><span id="l36.1474" class="difflineminus">-    // goes away. The single addref that the CreateDate() call</span>
<a href="#l36.1475"></a><span id="l36.1475" class="difflineminus">-    // made will be owned by the callee.</span>
<a href="#l36.1476"></a><span id="l36.1476" class="difflineminus">-    entry-&gt;mDate = aDate;</span>
<a href="#l36.1477"></a><span id="l36.1477" class="difflineminus">-    entry-&gt;mKey = value;</span>
<a href="#l36.1478"></a><span id="l36.1478" class="difflineminus">-</span>
<a href="#l36.1479"></a><span id="l36.1479" class="difflineminus">-    MOZ_LOG(gLog, LogLevel::Debug,</span>
<a href="#l36.1480"></a><span id="l36.1480" class="difflineminus">-           (&quot;rdfserv   register-date [%p] %&quot; PRId64,</span>
<a href="#l36.1481"></a><span id="l36.1481" class="difflineminus">-            aDate, value));</span>
<a href="#l36.1482"></a><span id="l36.1482" class="difflineminus">-</span>
<a href="#l36.1483"></a><span id="l36.1483" class="difflineminus">-    return NS_OK;</span>
<a href="#l36.1484"></a><span id="l36.1484" class="difflineminus">-}</span>
<a href="#l36.1485"></a><span id="l36.1485" class="difflineminus">-</span>
<a href="#l36.1486"></a><span id="l36.1486" class="difflineminus">-</span>
<a href="#l36.1487"></a><span id="l36.1487" class="difflineminus">-nsresult</span>
<a href="#l36.1488"></a><span id="l36.1488" class="difflineminus">-RDFServiceImpl::UnregisterDate(nsIRDFDate* aDate)</span>
<a href="#l36.1489"></a><span id="l36.1489" class="difflineminus">-{</span>
<a href="#l36.1490"></a><span id="l36.1490" class="difflineminus">-    PRTime value;</span>
<a href="#l36.1491"></a><span id="l36.1491" class="difflineminus">-    aDate-&gt;GetValue(&amp;value);</span>
<a href="#l36.1492"></a><span id="l36.1492" class="difflineminus">-</span>
<a href="#l36.1493"></a><span id="l36.1493" class="difflineminus">-    NS_ASSERTION(mDates.Search(&amp;value), &quot;date was never registered&quot;);</span>
<a href="#l36.1494"></a><span id="l36.1494" class="difflineminus">-</span>
<a href="#l36.1495"></a><span id="l36.1495" class="difflineminus">-    mDates.Remove(&amp;value);</span>
<a href="#l36.1496"></a><span id="l36.1496" class="difflineminus">-</span>
<a href="#l36.1497"></a><span id="l36.1497" class="difflineminus">-    // N.B. that we _don't_ release the literal: we only held a weak</span>
<a href="#l36.1498"></a><span id="l36.1498" class="difflineminus">-    // reference to it in the hashtable.</span>
<a href="#l36.1499"></a><span id="l36.1499" class="difflineminus">-    MOZ_LOG(gLog, LogLevel::Debug,</span>
<a href="#l36.1500"></a><span id="l36.1500" class="difflineminus">-           (&quot;rdfserv unregister-date [%p] %&quot; PRId64,</span>
<a href="#l36.1501"></a><span id="l36.1501" class="difflineminus">-            aDate, value));</span>
<a href="#l36.1502"></a><span id="l36.1502" class="difflineminus">-</span>
<a href="#l36.1503"></a><span id="l36.1503" class="difflineminus">-    return NS_OK;</span>
<a href="#l36.1504"></a><span id="l36.1504" class="difflineminus">-}</span>
<a href="#l36.1505"></a><span id="l36.1505" class="difflineminus">-</span>
<a href="#l36.1506"></a><span id="l36.1506" class="difflineminus">-nsresult</span>
<a href="#l36.1507"></a><span id="l36.1507" class="difflineminus">-RDFServiceImpl::RegisterBlob(BlobImpl *aBlob)</span>
<a href="#l36.1508"></a><span id="l36.1508" class="difflineminus">-{</span>
<a href="#l36.1509"></a><span id="l36.1509" class="difflineminus">-    NS_ASSERTION(!mBlobs.Search(&amp;aBlob-&gt;mData), &quot;blob already registered&quot;);</span>
<a href="#l36.1510"></a><span id="l36.1510" class="difflineminus">-</span>
<a href="#l36.1511"></a><span id="l36.1511" class="difflineminus">-    PLDHashEntryHdr *hdr = mBlobs.Add(&amp;aBlob-&gt;mData, fallible);</span>
<a href="#l36.1512"></a><span id="l36.1512" class="difflineminus">-    if (! hdr)</span>
<a href="#l36.1513"></a><span id="l36.1513" class="difflineminus">-        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l36.1514"></a><span id="l36.1514" class="difflineminus">-</span>
<a href="#l36.1515"></a><span id="l36.1515" class="difflineminus">-    BlobHashEntry *entry = static_cast&lt;BlobHashEntry *&gt;(hdr);</span>
<a href="#l36.1516"></a><span id="l36.1516" class="difflineminus">-</span>
<a href="#l36.1517"></a><span id="l36.1517" class="difflineminus">-    // N.B., we only hold a weak reference to the literal: that</span>
<a href="#l36.1518"></a><span id="l36.1518" class="difflineminus">-    // way, the literal can be destroyed when the last refcount</span>
<a href="#l36.1519"></a><span id="l36.1519" class="difflineminus">-    // goes away. The single addref that the CreateInt() call</span>
<a href="#l36.1520"></a><span id="l36.1520" class="difflineminus">-    // made will be owned by the callee.</span>
<a href="#l36.1521"></a><span id="l36.1521" class="difflineminus">-    entry-&gt;mBlob = aBlob;</span>
<a href="#l36.1522"></a><span id="l36.1522" class="difflineminus">-</span>
<a href="#l36.1523"></a><span id="l36.1523" class="difflineminus">-    MOZ_LOG(gLog, LogLevel::Debug,</span>
<a href="#l36.1524"></a><span id="l36.1524" class="difflineminus">-           (&quot;rdfserv   register-blob [%p] %s&quot;,</span>
<a href="#l36.1525"></a><span id="l36.1525" class="difflineminus">-            aBlob, aBlob-&gt;mData.mBytes));</span>
<a href="#l36.1526"></a><span id="l36.1526" class="difflineminus">-</span>
<a href="#l36.1527"></a><span id="l36.1527" class="difflineminus">-    return NS_OK;</span>
<a href="#l36.1528"></a><span id="l36.1528" class="difflineminus">-}</span>
<a href="#l36.1529"></a><span id="l36.1529" class="difflineminus">-</span>
<a href="#l36.1530"></a><span id="l36.1530" class="difflineminus">-nsresult</span>
<a href="#l36.1531"></a><span id="l36.1531" class="difflineminus">-RDFServiceImpl::UnregisterBlob(BlobImpl *aBlob)</span>
<a href="#l36.1532"></a><span id="l36.1532" class="difflineminus">-{</span>
<a href="#l36.1533"></a><span id="l36.1533" class="difflineminus">-    NS_ASSERTION(mBlobs.Search(&amp;aBlob-&gt;mData), &quot;blob was never registered&quot;);</span>
<a href="#l36.1534"></a><span id="l36.1534" class="difflineminus">-</span>
<a href="#l36.1535"></a><span id="l36.1535" class="difflineminus">-    mBlobs.Remove(&amp;aBlob-&gt;mData);</span>
<a href="#l36.1536"></a><span id="l36.1536" class="difflineminus">-</span>
<a href="#l36.1537"></a><span id="l36.1537" class="difflineminus">-     // N.B. that we _don't_ release the literal: we only held a weak</span>
<a href="#l36.1538"></a><span id="l36.1538" class="difflineminus">-     // reference to it in the hashtable.</span>
<a href="#l36.1539"></a><span id="l36.1539" class="difflineminus">-    MOZ_LOG(gLog, LogLevel::Debug,</span>
<a href="#l36.1540"></a><span id="l36.1540" class="difflineminus">-           (&quot;rdfserv unregister-blob [%p] %s&quot;,</span>
<a href="#l36.1541"></a><span id="l36.1541" class="difflineminus">-            aBlob, aBlob-&gt;mData.mBytes));</span>
<a href="#l36.1542"></a><span id="l36.1542" class="difflineminus">-</span>
<a href="#l36.1543"></a><span id="l36.1543" class="difflineminus">-    return NS_OK;</span>
<a href="#l36.1544"></a><span id="l36.1544" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l37.1"></a><span id="l37.1">deleted file mode 100644</span>
<a href="#l37.2"></a><span id="l37.2" class="difflineminus">--- a/rdf/base/nsRDFService.h</span>
<a href="#l37.3"></a><span id="l37.3" class="difflineplus">+++ /dev/null</span>
<a href="#l37.4"></a><span id="l37.4" class="difflineat">@@ -1,66 +0,0 @@</span>
<a href="#l37.5"></a><span id="l37.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*-</span>
<a href="#l37.6"></a><span id="l37.6" class="difflineminus">- *</span>
<a href="#l37.7"></a><span id="l37.7" class="difflineminus">- * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l37.8"></a><span id="l37.8" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l37.9"></a><span id="l37.9" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l37.10"></a><span id="l37.10" class="difflineminus">-</span>
<a href="#l37.11"></a><span id="l37.11" class="difflineminus">-#ifndef nsRDFService_h__</span>
<a href="#l37.12"></a><span id="l37.12" class="difflineminus">-#define nsRDFService_h__</span>
<a href="#l37.13"></a><span id="l37.13" class="difflineminus">-</span>
<a href="#l37.14"></a><span id="l37.14" class="difflineminus">-#include &quot;nsIRDFService.h&quot;</span>
<a href="#l37.15"></a><span id="l37.15" class="difflineminus">-#include &quot;nsWeakReference.h&quot;</span>
<a href="#l37.16"></a><span id="l37.16" class="difflineminus">-#include &quot;nsIFactory.h&quot;</span>
<a href="#l37.17"></a><span id="l37.17" class="difflineminus">-#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l37.18"></a><span id="l37.18" class="difflineminus">-#include &quot;PLDHashTable.h&quot;</span>
<a href="#l37.19"></a><span id="l37.19" class="difflineminus">-#include &quot;nsString.h&quot;</span>
<a href="#l37.20"></a><span id="l37.20" class="difflineminus">-</span>
<a href="#l37.21"></a><span id="l37.21" class="difflineminus">-struct PLHashTable;</span>
<a href="#l37.22"></a><span id="l37.22" class="difflineminus">-class nsIRDFLiteral;</span>
<a href="#l37.23"></a><span id="l37.23" class="difflineminus">-class nsIRDFInt;</span>
<a href="#l37.24"></a><span id="l37.24" class="difflineminus">-class nsIRDFDate;</span>
<a href="#l37.25"></a><span id="l37.25" class="difflineminus">-class BlobImpl;</span>
<a href="#l37.26"></a><span id="l37.26" class="difflineminus">-</span>
<a href="#l37.27"></a><span id="l37.27" class="difflineminus">-class RDFServiceImpl final : public nsIRDFService,</span>
<a href="#l37.28"></a><span id="l37.28" class="difflineminus">-                             public nsSupportsWeakReference</span>
<a href="#l37.29"></a><span id="l37.29" class="difflineminus">-{</span>
<a href="#l37.30"></a><span id="l37.30" class="difflineminus">-protected:</span>
<a href="#l37.31"></a><span id="l37.31" class="difflineminus">-    PLHashTable* mNamedDataSources;</span>
<a href="#l37.32"></a><span id="l37.32" class="difflineminus">-    PLDHashTable mResources;</span>
<a href="#l37.33"></a><span id="l37.33" class="difflineminus">-    PLDHashTable mLiterals;</span>
<a href="#l37.34"></a><span id="l37.34" class="difflineminus">-    PLDHashTable mInts;</span>
<a href="#l37.35"></a><span id="l37.35" class="difflineminus">-    PLDHashTable mDates;</span>
<a href="#l37.36"></a><span id="l37.36" class="difflineminus">-    PLDHashTable mBlobs;</span>
<a href="#l37.37"></a><span id="l37.37" class="difflineminus">-</span>
<a href="#l37.38"></a><span id="l37.38" class="difflineminus">-    nsCString mLastURIPrefix;</span>
<a href="#l37.39"></a><span id="l37.39" class="difflineminus">-    nsCOMPtr&lt;nsIFactory&gt; mLastFactory;</span>
<a href="#l37.40"></a><span id="l37.40" class="difflineminus">-    nsCOMPtr&lt;nsIFactory&gt; mDefaultResourceFactory;</span>
<a href="#l37.41"></a><span id="l37.41" class="difflineminus">-</span>
<a href="#l37.42"></a><span id="l37.42" class="difflineminus">-    RDFServiceImpl();</span>
<a href="#l37.43"></a><span id="l37.43" class="difflineminus">-    nsresult Init();</span>
<a href="#l37.44"></a><span id="l37.44" class="difflineminus">-    virtual ~RDFServiceImpl();</span>
<a href="#l37.45"></a><span id="l37.45" class="difflineminus">-</span>
<a href="#l37.46"></a><span id="l37.46" class="difflineminus">-public:</span>
<a href="#l37.47"></a><span id="l37.47" class="difflineminus">-    static RDFServiceImpl *gRDFService NS_VISIBILITY_HIDDEN;</span>
<a href="#l37.48"></a><span id="l37.48" class="difflineminus">-    static nsresult CreateSingleton(nsISupports* aOuter,</span>
<a href="#l37.49"></a><span id="l37.49" class="difflineminus">-                                    const nsIID&amp; aIID, void **aResult);</span>
<a href="#l37.50"></a><span id="l37.50" class="difflineminus">-</span>
<a href="#l37.51"></a><span id="l37.51" class="difflineminus">-    // nsISupports</span>
<a href="#l37.52"></a><span id="l37.52" class="difflineminus">-    NS_DECL_ISUPPORTS</span>
<a href="#l37.53"></a><span id="l37.53" class="difflineminus">-</span>
<a href="#l37.54"></a><span id="l37.54" class="difflineminus">-    // nsIRDFService</span>
<a href="#l37.55"></a><span id="l37.55" class="difflineminus">-    NS_DECL_NSIRDFSERVICE</span>
<a href="#l37.56"></a><span id="l37.56" class="difflineminus">-</span>
<a href="#l37.57"></a><span id="l37.57" class="difflineminus">-    // Implementation methods</span>
<a href="#l37.58"></a><span id="l37.58" class="difflineminus">-    nsresult RegisterLiteral(nsIRDFLiteral* aLiteral);</span>
<a href="#l37.59"></a><span id="l37.59" class="difflineminus">-    nsresult UnregisterLiteral(nsIRDFLiteral* aLiteral);</span>
<a href="#l37.60"></a><span id="l37.60" class="difflineminus">-    nsresult RegisterInt(nsIRDFInt* aInt);</span>
<a href="#l37.61"></a><span id="l37.61" class="difflineminus">-    nsresult UnregisterInt(nsIRDFInt* aInt);</span>
<a href="#l37.62"></a><span id="l37.62" class="difflineminus">-    nsresult RegisterDate(nsIRDFDate* aDate);</span>
<a href="#l37.63"></a><span id="l37.63" class="difflineminus">-    nsresult UnregisterDate(nsIRDFDate* aDate);</span>
<a href="#l37.64"></a><span id="l37.64" class="difflineminus">-    nsresult RegisterBlob(BlobImpl* aBlob);</span>
<a href="#l37.65"></a><span id="l37.65" class="difflineminus">-    nsresult UnregisterBlob(BlobImpl* aBlob);</span>
<a href="#l37.66"></a><span id="l37.66" class="difflineminus">-</span>
<a href="#l37.67"></a><span id="l37.67" class="difflineminus">-    nsresult GetDataSource(const char *aURI, bool aBlock, nsIRDFDataSource **aDataSource );</span>
<a href="#l37.68"></a><span id="l37.68" class="difflineminus">-};</span>
<a href="#l37.69"></a><span id="l37.69" class="difflineminus">-</span>
<a href="#l37.70"></a><span id="l37.70" class="difflineminus">-#endif // nsRDFService_h__</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l38.1"></a><span id="l38.1">deleted file mode 100644</span>
<a href="#l38.2"></a><span id="l38.2" class="difflineminus">--- a/rdf/base/nsRDFXMLDataSource.cpp</span>
<a href="#l38.3"></a><span id="l38.3" class="difflineplus">+++ /dev/null</span>
<a href="#l38.4"></a><span id="l38.4" class="difflineat">@@ -1,1172 +0,0 @@</span>
<a href="#l38.5"></a><span id="l38.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l38.6"></a><span id="l38.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l38.7"></a><span id="l38.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l38.8"></a><span id="l38.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l38.9"></a><span id="l38.9" class="difflineminus">-</span>
<a href="#l38.10"></a><span id="l38.10" class="difflineminus">-/*</span>
<a href="#l38.11"></a><span id="l38.11" class="difflineminus">-</span>
<a href="#l38.12"></a><span id="l38.12" class="difflineminus">-  A data source that can read itself from and write itself to an</span>
<a href="#l38.13"></a><span id="l38.13" class="difflineminus">-  RDF/XML stream.</span>
<a href="#l38.14"></a><span id="l38.14" class="difflineminus">-</span>
<a href="#l38.15"></a><span id="l38.15" class="difflineminus">-  For more information on the RDF/XML syntax,</span>
<a href="#l38.16"></a><span id="l38.16" class="difflineminus">-  see http://www.w3.org/TR/REC-rdf-syntax/.</span>
<a href="#l38.17"></a><span id="l38.17" class="difflineminus">-</span>
<a href="#l38.18"></a><span id="l38.18" class="difflineminus">-  This code is based on the final W3C Recommendation,</span>
<a href="#l38.19"></a><span id="l38.19" class="difflineminus">-  http://www.w3.org/TR/1999/REC-rdf-syntax-19990222.</span>
<a href="#l38.20"></a><span id="l38.20" class="difflineminus">-</span>
<a href="#l38.21"></a><span id="l38.21" class="difflineminus">-</span>
<a href="#l38.22"></a><span id="l38.22" class="difflineminus">-  TO DO</span>
<a href="#l38.23"></a><span id="l38.23" class="difflineminus">-  -----</span>
<a href="#l38.24"></a><span id="l38.24" class="difflineminus">-</span>
<a href="#l38.25"></a><span id="l38.25" class="difflineminus">-  1) Right now, the only kind of stream data sources that are _really_</span>
<a href="#l38.26"></a><span id="l38.26" class="difflineminus">-     writable are &quot;file:&quot; URIs. (In fact, _all_ &quot;file:&quot; URIs are</span>
<a href="#l38.27"></a><span id="l38.27" class="difflineminus">-     writable, modulo file system permissions; this may lead to some</span>
<a href="#l38.28"></a><span id="l38.28" class="difflineminus">-     surprising behavior.) Eventually, it'd be great if we could open</span>
<a href="#l38.29"></a><span id="l38.29" class="difflineminus">-     an arbitrary nsIOutputStream on *any* URL, and Netlib could just</span>
<a href="#l38.30"></a><span id="l38.30" class="difflineminus">-     do the magic.</span>
<a href="#l38.31"></a><span id="l38.31" class="difflineminus">-</span>
<a href="#l38.32"></a><span id="l38.32" class="difflineminus">-  2) Implement a more terse output for &quot;typed&quot; nodes; that is, instead</span>
<a href="#l38.33"></a><span id="l38.33" class="difflineminus">-     of &quot;RDF:Description type='ns:foo'&quot;, just output &quot;ns:foo&quot;.</span>
<a href="#l38.34"></a><span id="l38.34" class="difflineminus">-</span>
<a href="#l38.35"></a><span id="l38.35" class="difflineminus">-  3) When re-serializing, we &quot;cheat&quot; for Descriptions that talk about</span>
<a href="#l38.36"></a><span id="l38.36" class="difflineminus">-     inline resources (i.e.., using the `ID' attribute specified in</span>
<a href="#l38.37"></a><span id="l38.37" class="difflineminus">-     [6.21]). Instead of writing an `ID=&quot;foo&quot;' for the first instance,</span>
<a href="#l38.38"></a><span id="l38.38" class="difflineminus">-     and then `about=&quot;#foo&quot;' for each subsequent instance, we just</span>
<a href="#l38.39"></a><span id="l38.39" class="difflineminus">-     _always_ write `about=&quot;#foo&quot;'.</span>
<a href="#l38.40"></a><span id="l38.40" class="difflineminus">-</span>
<a href="#l38.41"></a><span id="l38.41" class="difflineminus">-     We do this so that we can handle the case where an RDF container</span>
<a href="#l38.42"></a><span id="l38.42" class="difflineminus">-     has been assigned arbitrary properties: the spec says we can't</span>
<a href="#l38.43"></a><span id="l38.43" class="difflineminus">-     dangle the attributes directly off the container, so we need to</span>
<a href="#l38.44"></a><span id="l38.44" class="difflineminus">-     refer to it. Of course, with a little cleverness, we could fix</span>
<a href="#l38.45"></a><span id="l38.45" class="difflineminus">-     this. But who cares?</span>
<a href="#l38.46"></a><span id="l38.46" class="difflineminus">-</span>
<a href="#l38.47"></a><span id="l38.47" class="difflineminus">-  4) When re-serializing containers. We have to cheat on some</span>
<a href="#l38.48"></a><span id="l38.48" class="difflineminus">-     containers, and use an illegal &quot;about=&quot; construct. We do this to</span>
<a href="#l38.49"></a><span id="l38.49" class="difflineminus">-     handle containers that have been assigned URIs outside of the</span>
<a href="#l38.50"></a><span id="l38.50" class="difflineminus">-     local document.</span>
<a href="#l38.51"></a><span id="l38.51" class="difflineminus">-</span>
<a href="#l38.52"></a><span id="l38.52" class="difflineminus">-</span>
<a href="#l38.53"></a><span id="l38.53" class="difflineminus">-  Logging</span>
<a href="#l38.54"></a><span id="l38.54" class="difflineminus">-  -------</span>
<a href="#l38.55"></a><span id="l38.55" class="difflineminus">-</span>
<a href="#l38.56"></a><span id="l38.56" class="difflineminus">-  To turn on logging for this module, set</span>
<a href="#l38.57"></a><span id="l38.57" class="difflineminus">-</span>
<a href="#l38.58"></a><span id="l38.58" class="difflineminus">-    MOZ_LOG=nsRDFXMLDataSource:5</span>
<a href="#l38.59"></a><span id="l38.59" class="difflineminus">-</span>
<a href="#l38.60"></a><span id="l38.60" class="difflineminus">- */</span>
<a href="#l38.61"></a><span id="l38.61" class="difflineminus">-</span>
<a href="#l38.62"></a><span id="l38.62" class="difflineminus">-#include &quot;nsIFileStreams.h&quot;</span>
<a href="#l38.63"></a><span id="l38.63" class="difflineminus">-#include &quot;nsIOutputStream.h&quot;</span>
<a href="#l38.64"></a><span id="l38.64" class="difflineminus">-#include &quot;nsIFile.h&quot;</span>
<a href="#l38.65"></a><span id="l38.65" class="difflineminus">-#include &quot;nsIFileChannel.h&quot;</span>
<a href="#l38.66"></a><span id="l38.66" class="difflineminus">-#include &quot;nsIDTD.h&quot;</span>
<a href="#l38.67"></a><span id="l38.67" class="difflineminus">-#include &quot;nsIRDFPurgeableDataSource.h&quot;</span>
<a href="#l38.68"></a><span id="l38.68" class="difflineminus">-#include &quot;nsIInputStream.h&quot;</span>
<a href="#l38.69"></a><span id="l38.69" class="difflineminus">-#include &quot;nsIOutputStream.h&quot;</span>
<a href="#l38.70"></a><span id="l38.70" class="difflineminus">-#include &quot;nsIRDFContainerUtils.h&quot;</span>
<a href="#l38.71"></a><span id="l38.71" class="difflineminus">-#include &quot;nsIRDFNode.h&quot;</span>
<a href="#l38.72"></a><span id="l38.72" class="difflineminus">-#include &quot;nsIRDFRemoteDataSource.h&quot;</span>
<a href="#l38.73"></a><span id="l38.73" class="difflineminus">-#include &quot;nsIRDFService.h&quot;</span>
<a href="#l38.74"></a><span id="l38.74" class="difflineminus">-#include &quot;nsIRDFXMLParser.h&quot;</span>
<a href="#l38.75"></a><span id="l38.75" class="difflineminus">-#include &quot;nsIRDFXMLSerializer.h&quot;</span>
<a href="#l38.76"></a><span id="l38.76" class="difflineminus">-#include &quot;nsIRDFXMLSink.h&quot;</span>
<a href="#l38.77"></a><span id="l38.77" class="difflineminus">-#include &quot;nsIRDFXMLSource.h&quot;</span>
<a href="#l38.78"></a><span id="l38.78" class="difflineminus">-#include &quot;nsISafeOutputStream.h&quot;</span>
<a href="#l38.79"></a><span id="l38.79" class="difflineminus">-#include &quot;nsIServiceManager.h&quot;</span>
<a href="#l38.80"></a><span id="l38.80" class="difflineminus">-#include &quot;nsIStreamListener.h&quot;</span>
<a href="#l38.81"></a><span id="l38.81" class="difflineminus">-#include &quot;nsIURL.h&quot;</span>
<a href="#l38.82"></a><span id="l38.82" class="difflineminus">-#include &quot;nsIFileURL.h&quot;</span>
<a href="#l38.83"></a><span id="l38.83" class="difflineminus">-#include &quot;nsISafeOutputStream.h&quot;</span>
<a href="#l38.84"></a><span id="l38.84" class="difflineminus">-#include &quot;nsIChannel.h&quot;</span>
<a href="#l38.85"></a><span id="l38.85" class="difflineminus">-#include &quot;nsRDFCID.h&quot;</span>
<a href="#l38.86"></a><span id="l38.86" class="difflineminus">-#include &quot;nsRDFBaseDataSources.h&quot;</span>
<a href="#l38.87"></a><span id="l38.87" class="difflineminus">-#include &quot;nsCOMArray.h&quot;</span>
<a href="#l38.88"></a><span id="l38.88" class="difflineminus">-#include &quot;nsString.h&quot;</span>
<a href="#l38.89"></a><span id="l38.89" class="difflineminus">-#include &quot;plstr.h&quot;</span>
<a href="#l38.90"></a><span id="l38.90" class="difflineminus">-#include &quot;prio.h&quot;</span>
<a href="#l38.91"></a><span id="l38.91" class="difflineminus">-#include &quot;prthread.h&quot;</span>
<a href="#l38.92"></a><span id="l38.92" class="difflineminus">-#include &quot;rdf.h&quot;</span>
<a href="#l38.93"></a><span id="l38.93" class="difflineminus">-#include &quot;rdfutil.h&quot;</span>
<a href="#l38.94"></a><span id="l38.94" class="difflineminus">-#include &quot;mozilla/Logging.h&quot;</span>
<a href="#l38.95"></a><span id="l38.95" class="difflineminus">-#include &quot;nsNameSpaceMap.h&quot;</span>
<a href="#l38.96"></a><span id="l38.96" class="difflineminus">-#include &quot;nsCRT.h&quot;</span>
<a href="#l38.97"></a><span id="l38.97" class="difflineminus">-#include &quot;nsCycleCollectionParticipant.h&quot;</span>
<a href="#l38.98"></a><span id="l38.98" class="difflineminus">-#include &quot;nsIScriptSecurityManager.h&quot;</span>
<a href="#l38.99"></a><span id="l38.99" class="difflineminus">-#include &quot;nsIChannelEventSink.h&quot;</span>
<a href="#l38.100"></a><span id="l38.100" class="difflineminus">-#include &quot;nsIAsyncVerifyRedirectCallback.h&quot;</span>
<a href="#l38.101"></a><span id="l38.101" class="difflineminus">-#include &quot;nsNetUtil.h&quot;</span>
<a href="#l38.102"></a><span id="l38.102" class="difflineminus">-#include &quot;nsIContentPolicy.h&quot;</span>
<a href="#l38.103"></a><span id="l38.103" class="difflineminus">-#include &quot;nsContentUtils.h&quot;</span>
<a href="#l38.104"></a><span id="l38.104" class="difflineminus">-</span>
<a href="#l38.105"></a><span id="l38.105" class="difflineminus">-#include &quot;rdfIDataSource.h&quot;</span>
<a href="#l38.106"></a><span id="l38.106" class="difflineminus">-</span>
<a href="#l38.107"></a><span id="l38.107" class="difflineminus">-//----------------------------------------------------------------------</span>
<a href="#l38.108"></a><span id="l38.108" class="difflineminus">-//</span>
<a href="#l38.109"></a><span id="l38.109" class="difflineminus">-// RDFXMLDataSourceImpl</span>
<a href="#l38.110"></a><span id="l38.110" class="difflineminus">-//</span>
<a href="#l38.111"></a><span id="l38.111" class="difflineminus">-</span>
<a href="#l38.112"></a><span id="l38.112" class="difflineminus">-class RDFXMLDataSourceImpl : public nsIRDFDataSource,</span>
<a href="#l38.113"></a><span id="l38.113" class="difflineminus">-                             public nsIRDFRemoteDataSource,</span>
<a href="#l38.114"></a><span id="l38.114" class="difflineminus">-                             public nsIRDFXMLSink,</span>
<a href="#l38.115"></a><span id="l38.115" class="difflineminus">-                             public nsIRDFXMLSource,</span>
<a href="#l38.116"></a><span id="l38.116" class="difflineminus">-                             public nsIStreamListener,</span>
<a href="#l38.117"></a><span id="l38.117" class="difflineminus">-                             public rdfIDataSource,</span>
<a href="#l38.118"></a><span id="l38.118" class="difflineminus">-                             public nsIInterfaceRequestor,</span>
<a href="#l38.119"></a><span id="l38.119" class="difflineminus">-                             public nsIChannelEventSink</span>
<a href="#l38.120"></a><span id="l38.120" class="difflineminus">-{</span>
<a href="#l38.121"></a><span id="l38.121" class="difflineminus">-protected:</span>
<a href="#l38.122"></a><span id="l38.122" class="difflineminus">-    enum LoadState {</span>
<a href="#l38.123"></a><span id="l38.123" class="difflineminus">-        eLoadState_Unloaded,</span>
<a href="#l38.124"></a><span id="l38.124" class="difflineminus">-        eLoadState_Pending,</span>
<a href="#l38.125"></a><span id="l38.125" class="difflineminus">-        eLoadState_Loading,</span>
<a href="#l38.126"></a><span id="l38.126" class="difflineminus">-        eLoadState_Loaded</span>
<a href="#l38.127"></a><span id="l38.127" class="difflineminus">-    };</span>
<a href="#l38.128"></a><span id="l38.128" class="difflineminus">-</span>
<a href="#l38.129"></a><span id="l38.129" class="difflineminus">-    nsCOMPtr&lt;nsIRDFDataSource&gt; mInner;</span>
<a href="#l38.130"></a><span id="l38.130" class="difflineminus">-    bool                mIsWritable;    // true if the document can be written back</span>
<a href="#l38.131"></a><span id="l38.131" class="difflineminus">-    bool                mIsDirty;       // true if the document should be written back</span>
<a href="#l38.132"></a><span id="l38.132" class="difflineminus">-    LoadState           mLoadState;     // what we're doing now</span>
<a href="#l38.133"></a><span id="l38.133" class="difflineminus">-    nsCOMArray&lt;nsIRDFXMLSinkObserver&gt; mObservers;</span>
<a href="#l38.134"></a><span id="l38.134" class="difflineminus">-    nsCOMPtr&lt;nsIURI&gt;    mURL;</span>
<a href="#l38.135"></a><span id="l38.135" class="difflineminus">-    nsCOMPtr&lt;nsIStreamListener&gt; mListener;</span>
<a href="#l38.136"></a><span id="l38.136" class="difflineminus">-    nsNameSpaceMap      mNameSpaces;</span>
<a href="#l38.137"></a><span id="l38.137" class="difflineminus">-</span>
<a href="#l38.138"></a><span id="l38.138" class="difflineminus">-    // pseudo-constants</span>
<a href="#l38.139"></a><span id="l38.139" class="difflineminus">-    static int32_t gRefCnt;</span>
<a href="#l38.140"></a><span id="l38.140" class="difflineminus">-    static nsIRDFService* gRDFService;</span>
<a href="#l38.141"></a><span id="l38.141" class="difflineminus">-</span>
<a href="#l38.142"></a><span id="l38.142" class="difflineminus">-    static mozilla::LazyLogModule gLog;</span>
<a href="#l38.143"></a><span id="l38.143" class="difflineminus">-</span>
<a href="#l38.144"></a><span id="l38.144" class="difflineminus">-    nsresult Init();</span>
<a href="#l38.145"></a><span id="l38.145" class="difflineminus">-    RDFXMLDataSourceImpl(void);</span>
<a href="#l38.146"></a><span id="l38.146" class="difflineminus">-    virtual ~RDFXMLDataSourceImpl(void);</span>
<a href="#l38.147"></a><span id="l38.147" class="difflineminus">-    nsresult rdfXMLFlush(nsIURI *aURI);</span>
<a href="#l38.148"></a><span id="l38.148" class="difflineminus">-</span>
<a href="#l38.149"></a><span id="l38.149" class="difflineminus">-    friend nsresult</span>
<a href="#l38.150"></a><span id="l38.150" class="difflineminus">-    NS_NewRDFXMLDataSource(nsIRDFDataSource** aResult);</span>
<a href="#l38.151"></a><span id="l38.151" class="difflineminus">-</span>
<a href="#l38.152"></a><span id="l38.152" class="difflineminus">-    inline bool IsLoading() {</span>
<a href="#l38.153"></a><span id="l38.153" class="difflineminus">-        return (mLoadState == eLoadState_Pending) ||</span>
<a href="#l38.154"></a><span id="l38.154" class="difflineminus">-               (mLoadState == eLoadState_Loading);</span>
<a href="#l38.155"></a><span id="l38.155" class="difflineminus">-    }</span>
<a href="#l38.156"></a><span id="l38.156" class="difflineminus">-</span>
<a href="#l38.157"></a><span id="l38.157" class="difflineminus">-public:</span>
<a href="#l38.158"></a><span id="l38.158" class="difflineminus">-    // nsISupports</span>
<a href="#l38.159"></a><span id="l38.159" class="difflineminus">-    NS_DECL_CYCLE_COLLECTING_ISUPPORTS</span>
<a href="#l38.160"></a><span id="l38.160" class="difflineminus">-    NS_DECL_CYCLE_COLLECTION_CLASS_AMBIGUOUS(RDFXMLDataSourceImpl,</span>
<a href="#l38.161"></a><span id="l38.161" class="difflineminus">-                                             nsIRDFDataSource)</span>
<a href="#l38.162"></a><span id="l38.162" class="difflineminus">-</span>
<a href="#l38.163"></a><span id="l38.163" class="difflineminus">-    // nsIRDFDataSource</span>
<a href="#l38.164"></a><span id="l38.164" class="difflineminus">-    NS_IMETHOD GetURI(nsACString&amp; aURI) override;</span>
<a href="#l38.165"></a><span id="l38.165" class="difflineminus">-</span>
<a href="#l38.166"></a><span id="l38.166" class="difflineminus">-    NS_IMETHOD GetSource(nsIRDFResource* property,</span>
<a href="#l38.167"></a><span id="l38.167" class="difflineminus">-                         nsIRDFNode* target,</span>
<a href="#l38.168"></a><span id="l38.168" class="difflineminus">-                         bool tv,</span>
<a href="#l38.169"></a><span id="l38.169" class="difflineminus">-                         nsIRDFResource** source) override {</span>
<a href="#l38.170"></a><span id="l38.170" class="difflineminus">-        return mInner-&gt;GetSource(property, target, tv, source);</span>
<a href="#l38.171"></a><span id="l38.171" class="difflineminus">-    }</span>
<a href="#l38.172"></a><span id="l38.172" class="difflineminus">-</span>
<a href="#l38.173"></a><span id="l38.173" class="difflineminus">-    NS_IMETHOD GetSources(nsIRDFResource* property,</span>
<a href="#l38.174"></a><span id="l38.174" class="difflineminus">-                          nsIRDFNode* target,</span>
<a href="#l38.175"></a><span id="l38.175" class="difflineminus">-                          bool tv,</span>
<a href="#l38.176"></a><span id="l38.176" class="difflineminus">-                          nsISimpleEnumerator** sources) override {</span>
<a href="#l38.177"></a><span id="l38.177" class="difflineminus">-        return mInner-&gt;GetSources(property, target, tv, sources);</span>
<a href="#l38.178"></a><span id="l38.178" class="difflineminus">-    }</span>
<a href="#l38.179"></a><span id="l38.179" class="difflineminus">-</span>
<a href="#l38.180"></a><span id="l38.180" class="difflineminus">-    NS_IMETHOD GetTarget(nsIRDFResource* source,</span>
<a href="#l38.181"></a><span id="l38.181" class="difflineminus">-                         nsIRDFResource* property,</span>
<a href="#l38.182"></a><span id="l38.182" class="difflineminus">-                         bool tv,</span>
<a href="#l38.183"></a><span id="l38.183" class="difflineminus">-                         nsIRDFNode** target) override {</span>
<a href="#l38.184"></a><span id="l38.184" class="difflineminus">-        return mInner-&gt;GetTarget(source, property, tv, target);</span>
<a href="#l38.185"></a><span id="l38.185" class="difflineminus">-    }</span>
<a href="#l38.186"></a><span id="l38.186" class="difflineminus">-</span>
<a href="#l38.187"></a><span id="l38.187" class="difflineminus">-    NS_IMETHOD GetTargets(nsIRDFResource* source,</span>
<a href="#l38.188"></a><span id="l38.188" class="difflineminus">-                          nsIRDFResource* property,</span>
<a href="#l38.189"></a><span id="l38.189" class="difflineminus">-                          bool tv,</span>
<a href="#l38.190"></a><span id="l38.190" class="difflineminus">-                          nsISimpleEnumerator** targets) override {</span>
<a href="#l38.191"></a><span id="l38.191" class="difflineminus">-        return mInner-&gt;GetTargets(source, property, tv, targets);</span>
<a href="#l38.192"></a><span id="l38.192" class="difflineminus">-    }</span>
<a href="#l38.193"></a><span id="l38.193" class="difflineminus">-</span>
<a href="#l38.194"></a><span id="l38.194" class="difflineminus">-    NS_IMETHOD Assert(nsIRDFResource* aSource,</span>
<a href="#l38.195"></a><span id="l38.195" class="difflineminus">-                      nsIRDFResource* aProperty,</span>
<a href="#l38.196"></a><span id="l38.196" class="difflineminus">-                      nsIRDFNode* aTarget,</span>
<a href="#l38.197"></a><span id="l38.197" class="difflineminus">-                      bool tv) override;</span>
<a href="#l38.198"></a><span id="l38.198" class="difflineminus">-</span>
<a href="#l38.199"></a><span id="l38.199" class="difflineminus">-    NS_IMETHOD Unassert(nsIRDFResource* source,</span>
<a href="#l38.200"></a><span id="l38.200" class="difflineminus">-                        nsIRDFResource* property,</span>
<a href="#l38.201"></a><span id="l38.201" class="difflineminus">-                        nsIRDFNode* target) override;</span>
<a href="#l38.202"></a><span id="l38.202" class="difflineminus">-</span>
<a href="#l38.203"></a><span id="l38.203" class="difflineminus">-    NS_IMETHOD Change(nsIRDFResource* aSource,</span>
<a href="#l38.204"></a><span id="l38.204" class="difflineminus">-                      nsIRDFResource* aProperty,</span>
<a href="#l38.205"></a><span id="l38.205" class="difflineminus">-                      nsIRDFNode* aOldTarget,</span>
<a href="#l38.206"></a><span id="l38.206" class="difflineminus">-                      nsIRDFNode* aNewTarget) override;</span>
<a href="#l38.207"></a><span id="l38.207" class="difflineminus">-</span>
<a href="#l38.208"></a><span id="l38.208" class="difflineminus">-    NS_IMETHOD Move(nsIRDFResource* aOldSource,</span>
<a href="#l38.209"></a><span id="l38.209" class="difflineminus">-                    nsIRDFResource* aNewSource,</span>
<a href="#l38.210"></a><span id="l38.210" class="difflineminus">-                    nsIRDFResource* aProperty,</span>
<a href="#l38.211"></a><span id="l38.211" class="difflineminus">-                    nsIRDFNode* aTarget) override;</span>
<a href="#l38.212"></a><span id="l38.212" class="difflineminus">-</span>
<a href="#l38.213"></a><span id="l38.213" class="difflineminus">-    NS_IMETHOD HasAssertion(nsIRDFResource* source,</span>
<a href="#l38.214"></a><span id="l38.214" class="difflineminus">-                            nsIRDFResource* property,</span>
<a href="#l38.215"></a><span id="l38.215" class="difflineminus">-                            nsIRDFNode* target,</span>
<a href="#l38.216"></a><span id="l38.216" class="difflineminus">-                            bool tv,</span>
<a href="#l38.217"></a><span id="l38.217" class="difflineminus">-                            bool* hasAssertion) override {</span>
<a href="#l38.218"></a><span id="l38.218" class="difflineminus">-        return mInner-&gt;HasAssertion(source, property, target, tv, hasAssertion);</span>
<a href="#l38.219"></a><span id="l38.219" class="difflineminus">-    }</span>
<a href="#l38.220"></a><span id="l38.220" class="difflineminus">-</span>
<a href="#l38.221"></a><span id="l38.221" class="difflineminus">-    NS_IMETHOD AddObserver(nsIRDFObserver* aObserver) override {</span>
<a href="#l38.222"></a><span id="l38.222" class="difflineminus">-        return mInner-&gt;AddObserver(aObserver);</span>
<a href="#l38.223"></a><span id="l38.223" class="difflineminus">-    }</span>
<a href="#l38.224"></a><span id="l38.224" class="difflineminus">-</span>
<a href="#l38.225"></a><span id="l38.225" class="difflineminus">-    NS_IMETHOD RemoveObserver(nsIRDFObserver* aObserver) override {</span>
<a href="#l38.226"></a><span id="l38.226" class="difflineminus">-        return mInner-&gt;RemoveObserver(aObserver);</span>
<a href="#l38.227"></a><span id="l38.227" class="difflineminus">-    }</span>
<a href="#l38.228"></a><span id="l38.228" class="difflineminus">-</span>
<a href="#l38.229"></a><span id="l38.229" class="difflineminus">-    NS_IMETHOD HasArcIn(nsIRDFNode *aNode, nsIRDFResource *aArc, bool *_retval) override {</span>
<a href="#l38.230"></a><span id="l38.230" class="difflineminus">-        return mInner-&gt;HasArcIn(aNode, aArc, _retval);</span>
<a href="#l38.231"></a><span id="l38.231" class="difflineminus">-    }</span>
<a href="#l38.232"></a><span id="l38.232" class="difflineminus">-</span>
<a href="#l38.233"></a><span id="l38.233" class="difflineminus">-    NS_IMETHOD HasArcOut(nsIRDFResource *aSource, nsIRDFResource *aArc, bool *_retval) override {</span>
<a href="#l38.234"></a><span id="l38.234" class="difflineminus">-        return mInner-&gt;HasArcOut(aSource, aArc, _retval);</span>
<a href="#l38.235"></a><span id="l38.235" class="difflineminus">-    }</span>
<a href="#l38.236"></a><span id="l38.236" class="difflineminus">-</span>
<a href="#l38.237"></a><span id="l38.237" class="difflineminus">-    NS_IMETHOD ArcLabelsIn(nsIRDFNode* node,</span>
<a href="#l38.238"></a><span id="l38.238" class="difflineminus">-                           nsISimpleEnumerator** labels) override {</span>
<a href="#l38.239"></a><span id="l38.239" class="difflineminus">-        return mInner-&gt;ArcLabelsIn(node, labels);</span>
<a href="#l38.240"></a><span id="l38.240" class="difflineminus">-    }</span>
<a href="#l38.241"></a><span id="l38.241" class="difflineminus">-</span>
<a href="#l38.242"></a><span id="l38.242" class="difflineminus">-    NS_IMETHOD ArcLabelsOut(nsIRDFResource* source,</span>
<a href="#l38.243"></a><span id="l38.243" class="difflineminus">-                            nsISimpleEnumerator** labels) override {</span>
<a href="#l38.244"></a><span id="l38.244" class="difflineminus">-        return mInner-&gt;ArcLabelsOut(source, labels);</span>
<a href="#l38.245"></a><span id="l38.245" class="difflineminus">-    }</span>
<a href="#l38.246"></a><span id="l38.246" class="difflineminus">-</span>
<a href="#l38.247"></a><span id="l38.247" class="difflineminus">-    NS_IMETHOD GetAllResources(nsISimpleEnumerator** aResult) override {</span>
<a href="#l38.248"></a><span id="l38.248" class="difflineminus">-        return mInner-&gt;GetAllResources(aResult);</span>
<a href="#l38.249"></a><span id="l38.249" class="difflineminus">-    }</span>
<a href="#l38.250"></a><span id="l38.250" class="difflineminus">-</span>
<a href="#l38.251"></a><span id="l38.251" class="difflineminus">-    NS_IMETHOD GetAllCmds(nsIRDFResource* source,</span>
<a href="#l38.252"></a><span id="l38.252" class="difflineminus">-                              nsISimpleEnumerator/*&lt;nsIRDFResource&gt;*/** commands) override {</span>
<a href="#l38.253"></a><span id="l38.253" class="difflineminus">-        return mInner-&gt;GetAllCmds(source, commands);</span>
<a href="#l38.254"></a><span id="l38.254" class="difflineminus">-    }</span>
<a href="#l38.255"></a><span id="l38.255" class="difflineminus">-</span>
<a href="#l38.256"></a><span id="l38.256" class="difflineminus">-    NS_IMETHOD IsCommandEnabled(nsISupports* aSources,</span>
<a href="#l38.257"></a><span id="l38.257" class="difflineminus">-                                nsIRDFResource*   aCommand,</span>
<a href="#l38.258"></a><span id="l38.258" class="difflineminus">-                                nsISupports* aArguments,</span>
<a href="#l38.259"></a><span id="l38.259" class="difflineminus">-                                bool* aResult) override {</span>
<a href="#l38.260"></a><span id="l38.260" class="difflineminus">-        return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l38.261"></a><span id="l38.261" class="difflineminus">-    }</span>
<a href="#l38.262"></a><span id="l38.262" class="difflineminus">-</span>
<a href="#l38.263"></a><span id="l38.263" class="difflineminus">-    NS_IMETHOD DoCommand(nsISupports* aSources,</span>
<a href="#l38.264"></a><span id="l38.264" class="difflineminus">-                         nsIRDFResource*   aCommand,</span>
<a href="#l38.265"></a><span id="l38.265" class="difflineminus">-                         nsISupports* aArguments) override {</span>
<a href="#l38.266"></a><span id="l38.266" class="difflineminus">-        return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l38.267"></a><span id="l38.267" class="difflineminus">-    }</span>
<a href="#l38.268"></a><span id="l38.268" class="difflineminus">-</span>
<a href="#l38.269"></a><span id="l38.269" class="difflineminus">-    NS_IMETHOD BeginUpdateBatch() override {</span>
<a href="#l38.270"></a><span id="l38.270" class="difflineminus">-        return mInner-&gt;BeginUpdateBatch();</span>
<a href="#l38.271"></a><span id="l38.271" class="difflineminus">-    }</span>
<a href="#l38.272"></a><span id="l38.272" class="difflineminus">-</span>
<a href="#l38.273"></a><span id="l38.273" class="difflineminus">-    NS_IMETHOD EndUpdateBatch() override {</span>
<a href="#l38.274"></a><span id="l38.274" class="difflineminus">-        return mInner-&gt;EndUpdateBatch();</span>
<a href="#l38.275"></a><span id="l38.275" class="difflineminus">-    }</span>
<a href="#l38.276"></a><span id="l38.276" class="difflineminus">-</span>
<a href="#l38.277"></a><span id="l38.277" class="difflineminus">-    // nsIRDFRemoteDataSource interface</span>
<a href="#l38.278"></a><span id="l38.278" class="difflineminus">-    NS_DECL_NSIRDFREMOTEDATASOURCE</span>
<a href="#l38.279"></a><span id="l38.279" class="difflineminus">-</span>
<a href="#l38.280"></a><span id="l38.280" class="difflineminus">-    // nsIRDFXMLSink interface</span>
<a href="#l38.281"></a><span id="l38.281" class="difflineminus">-    NS_DECL_NSIRDFXMLSINK</span>
<a href="#l38.282"></a><span id="l38.282" class="difflineminus">-</span>
<a href="#l38.283"></a><span id="l38.283" class="difflineminus">-    // nsIRDFXMLSource interface</span>
<a href="#l38.284"></a><span id="l38.284" class="difflineminus">-    NS_DECL_NSIRDFXMLSOURCE</span>
<a href="#l38.285"></a><span id="l38.285" class="difflineminus">-</span>
<a href="#l38.286"></a><span id="l38.286" class="difflineminus">-    // nsIRequestObserver</span>
<a href="#l38.287"></a><span id="l38.287" class="difflineminus">-    NS_DECL_NSIREQUESTOBSERVER</span>
<a href="#l38.288"></a><span id="l38.288" class="difflineminus">-</span>
<a href="#l38.289"></a><span id="l38.289" class="difflineminus">-    // nsIStreamListener</span>
<a href="#l38.290"></a><span id="l38.290" class="difflineminus">-    NS_DECL_NSISTREAMLISTENER</span>
<a href="#l38.291"></a><span id="l38.291" class="difflineminus">-</span>
<a href="#l38.292"></a><span id="l38.292" class="difflineminus">-    // nsIInterfaceRequestor</span>
<a href="#l38.293"></a><span id="l38.293" class="difflineminus">-    NS_DECL_NSIINTERFACEREQUESTOR</span>
<a href="#l38.294"></a><span id="l38.294" class="difflineminus">-</span>
<a href="#l38.295"></a><span id="l38.295" class="difflineminus">-    // nsIChannelEventSink</span>
<a href="#l38.296"></a><span id="l38.296" class="difflineminus">-    NS_DECL_NSICHANNELEVENTSINK</span>
<a href="#l38.297"></a><span id="l38.297" class="difflineminus">-</span>
<a href="#l38.298"></a><span id="l38.298" class="difflineminus">-    // rdfIDataSource</span>
<a href="#l38.299"></a><span id="l38.299" class="difflineminus">-    NS_IMETHOD VisitAllSubjects(rdfITripleVisitor *aVisitor) override {</span>
<a href="#l38.300"></a><span id="l38.300" class="difflineminus">-        nsresult rv;</span>
<a href="#l38.301"></a><span id="l38.301" class="difflineminus">-        nsCOMPtr&lt;rdfIDataSource&gt; rdfds = do_QueryInterface(mInner, &amp;rv);</span>
<a href="#l38.302"></a><span id="l38.302" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l38.303"></a><span id="l38.303" class="difflineminus">-        return rdfds-&gt;VisitAllSubjects(aVisitor);</span>
<a href="#l38.304"></a><span id="l38.304" class="difflineminus">-    }</span>
<a href="#l38.305"></a><span id="l38.305" class="difflineminus">-</span>
<a href="#l38.306"></a><span id="l38.306" class="difflineminus">-    NS_IMETHOD VisitAllTriples(rdfITripleVisitor *aVisitor) override {</span>
<a href="#l38.307"></a><span id="l38.307" class="difflineminus">-        nsresult rv;</span>
<a href="#l38.308"></a><span id="l38.308" class="difflineminus">-        nsCOMPtr&lt;rdfIDataSource&gt; rdfds = do_QueryInterface(mInner, &amp;rv);</span>
<a href="#l38.309"></a><span id="l38.309" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l38.310"></a><span id="l38.310" class="difflineminus">-        return rdfds-&gt;VisitAllTriples(aVisitor);</span>
<a href="#l38.311"></a><span id="l38.311" class="difflineminus">-    }</span>
<a href="#l38.312"></a><span id="l38.312" class="difflineminus">-</span>
<a href="#l38.313"></a><span id="l38.313" class="difflineminus">-    // Implementation methods</span>
<a href="#l38.314"></a><span id="l38.314" class="difflineminus">-    bool</span>
<a href="#l38.315"></a><span id="l38.315" class="difflineminus">-    MakeQName(nsIRDFResource* aResource,</span>
<a href="#l38.316"></a><span id="l38.316" class="difflineminus">-              nsString&amp; property,</span>
<a href="#l38.317"></a><span id="l38.317" class="difflineminus">-              nsString&amp; nameSpacePrefix,</span>
<a href="#l38.318"></a><span id="l38.318" class="difflineminus">-              nsString&amp; nameSpaceURI);</span>
<a href="#l38.319"></a><span id="l38.319" class="difflineminus">-</span>
<a href="#l38.320"></a><span id="l38.320" class="difflineminus">-    nsresult</span>
<a href="#l38.321"></a><span id="l38.321" class="difflineminus">-    SerializeAssertion(nsIOutputStream* aStream,</span>
<a href="#l38.322"></a><span id="l38.322" class="difflineminus">-                       nsIRDFResource* aResource,</span>
<a href="#l38.323"></a><span id="l38.323" class="difflineminus">-                       nsIRDFResource* aProperty,</span>
<a href="#l38.324"></a><span id="l38.324" class="difflineminus">-                       nsIRDFNode* aValue);</span>
<a href="#l38.325"></a><span id="l38.325" class="difflineminus">-</span>
<a href="#l38.326"></a><span id="l38.326" class="difflineminus">-    nsresult</span>
<a href="#l38.327"></a><span id="l38.327" class="difflineminus">-    SerializeProperty(nsIOutputStream* aStream,</span>
<a href="#l38.328"></a><span id="l38.328" class="difflineminus">-                      nsIRDFResource* aResource,</span>
<a href="#l38.329"></a><span id="l38.329" class="difflineminus">-                      nsIRDFResource* aProperty);</span>
<a href="#l38.330"></a><span id="l38.330" class="difflineminus">-</span>
<a href="#l38.331"></a><span id="l38.331" class="difflineminus">-    bool</span>
<a href="#l38.332"></a><span id="l38.332" class="difflineminus">-    IsContainerProperty(nsIRDFResource* aProperty);</span>
<a href="#l38.333"></a><span id="l38.333" class="difflineminus">-</span>
<a href="#l38.334"></a><span id="l38.334" class="difflineminus">-    nsresult</span>
<a href="#l38.335"></a><span id="l38.335" class="difflineminus">-    SerializeDescription(nsIOutputStream* aStream,</span>
<a href="#l38.336"></a><span id="l38.336" class="difflineminus">-                         nsIRDFResource* aResource);</span>
<a href="#l38.337"></a><span id="l38.337" class="difflineminus">-</span>
<a href="#l38.338"></a><span id="l38.338" class="difflineminus">-    nsresult</span>
<a href="#l38.339"></a><span id="l38.339" class="difflineminus">-    SerializeMember(nsIOutputStream* aStream,</span>
<a href="#l38.340"></a><span id="l38.340" class="difflineminus">-                    nsIRDFResource* aContainer,</span>
<a href="#l38.341"></a><span id="l38.341" class="difflineminus">-                    nsIRDFNode* aMember);</span>
<a href="#l38.342"></a><span id="l38.342" class="difflineminus">-</span>
<a href="#l38.343"></a><span id="l38.343" class="difflineminus">-    nsresult</span>
<a href="#l38.344"></a><span id="l38.344" class="difflineminus">-    SerializeContainer(nsIOutputStream* aStream,</span>
<a href="#l38.345"></a><span id="l38.345" class="difflineminus">-                       nsIRDFResource* aContainer);</span>
<a href="#l38.346"></a><span id="l38.346" class="difflineminus">-</span>
<a href="#l38.347"></a><span id="l38.347" class="difflineminus">-    nsresult</span>
<a href="#l38.348"></a><span id="l38.348" class="difflineminus">-    SerializePrologue(nsIOutputStream* aStream);</span>
<a href="#l38.349"></a><span id="l38.349" class="difflineminus">-</span>
<a href="#l38.350"></a><span id="l38.350" class="difflineminus">-    nsresult</span>
<a href="#l38.351"></a><span id="l38.351" class="difflineminus">-    SerializeEpilogue(nsIOutputStream* aStream);</span>
<a href="#l38.352"></a><span id="l38.352" class="difflineminus">-</span>
<a href="#l38.353"></a><span id="l38.353" class="difflineminus">-    bool</span>
<a href="#l38.354"></a><span id="l38.354" class="difflineminus">-    IsA(nsIRDFDataSource* aDataSource, nsIRDFResource* aResource, nsIRDFResource* aType);</span>
<a href="#l38.355"></a><span id="l38.355" class="difflineminus">-</span>
<a href="#l38.356"></a><span id="l38.356" class="difflineminus">-protected:</span>
<a href="#l38.357"></a><span id="l38.357" class="difflineminus">-    nsresult</span>
<a href="#l38.358"></a><span id="l38.358" class="difflineminus">-    BlockingParse(nsIURI* aURL, nsIStreamListener* aConsumer);</span>
<a href="#l38.359"></a><span id="l38.359" class="difflineminus">-};</span>
<a href="#l38.360"></a><span id="l38.360" class="difflineminus">-</span>
<a href="#l38.361"></a><span id="l38.361" class="difflineminus">-int32_t         RDFXMLDataSourceImpl::gRefCnt = 0;</span>
<a href="#l38.362"></a><span id="l38.362" class="difflineminus">-nsIRDFService*  RDFXMLDataSourceImpl::gRDFService;</span>
<a href="#l38.363"></a><span id="l38.363" class="difflineminus">-</span>
<a href="#l38.364"></a><span id="l38.364" class="difflineminus">-mozilla::LazyLogModule RDFXMLDataSourceImpl::gLog(&quot;nsRDFXMLDataSource&quot;);</span>
<a href="#l38.365"></a><span id="l38.365" class="difflineminus">-</span>
<a href="#l38.366"></a><span id="l38.366" class="difflineminus">-static const char kFileURIPrefix[] = &quot;file:&quot;;</span>
<a href="#l38.367"></a><span id="l38.367" class="difflineminus">-static const char kResourceURIPrefix[] = &quot;resource:&quot;;</span>
<a href="#l38.368"></a><span id="l38.368" class="difflineminus">-</span>
<a href="#l38.369"></a><span id="l38.369" class="difflineminus">-</span>
<a href="#l38.370"></a><span id="l38.370" class="difflineminus">-//----------------------------------------------------------------------</span>
<a href="#l38.371"></a><span id="l38.371" class="difflineminus">-</span>
<a href="#l38.372"></a><span id="l38.372" class="difflineminus">-nsresult</span>
<a href="#l38.373"></a><span id="l38.373" class="difflineminus">-NS_NewRDFXMLDataSource(nsIRDFDataSource** aResult)</span>
<a href="#l38.374"></a><span id="l38.374" class="difflineminus">-{</span>
<a href="#l38.375"></a><span id="l38.375" class="difflineminus">-    NS_ASSERTION(aResult != nullptr, &quot;null ptr&quot;);</span>
<a href="#l38.376"></a><span id="l38.376" class="difflineminus">-    if (! aResult)</span>
<a href="#l38.377"></a><span id="l38.377" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l38.378"></a><span id="l38.378" class="difflineminus">-</span>
<a href="#l38.379"></a><span id="l38.379" class="difflineminus">-    RDFXMLDataSourceImpl* datasource = new RDFXMLDataSourceImpl();</span>
<a href="#l38.380"></a><span id="l38.380" class="difflineminus">-    if (! datasource)</span>
<a href="#l38.381"></a><span id="l38.381" class="difflineminus">-        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l38.382"></a><span id="l38.382" class="difflineminus">-</span>
<a href="#l38.383"></a><span id="l38.383" class="difflineminus">-    nsresult rv;</span>
<a href="#l38.384"></a><span id="l38.384" class="difflineminus">-    rv = datasource-&gt;Init();</span>
<a href="#l38.385"></a><span id="l38.385" class="difflineminus">-</span>
<a href="#l38.386"></a><span id="l38.386" class="difflineminus">-    if (NS_FAILED(rv)) {</span>
<a href="#l38.387"></a><span id="l38.387" class="difflineminus">-        delete datasource;</span>
<a href="#l38.388"></a><span id="l38.388" class="difflineminus">-        return rv;</span>
<a href="#l38.389"></a><span id="l38.389" class="difflineminus">-    }</span>
<a href="#l38.390"></a><span id="l38.390" class="difflineminus">-</span>
<a href="#l38.391"></a><span id="l38.391" class="difflineminus">-    NS_ADDREF(datasource);</span>
<a href="#l38.392"></a><span id="l38.392" class="difflineminus">-    *aResult = datasource;</span>
<a href="#l38.393"></a><span id="l38.393" class="difflineminus">-    return NS_OK;</span>
<a href="#l38.394"></a><span id="l38.394" class="difflineminus">-}</span>
<a href="#l38.395"></a><span id="l38.395" class="difflineminus">-</span>
<a href="#l38.396"></a><span id="l38.396" class="difflineminus">-</span>
<a href="#l38.397"></a><span id="l38.397" class="difflineminus">-RDFXMLDataSourceImpl::RDFXMLDataSourceImpl(void)</span>
<a href="#l38.398"></a><span id="l38.398" class="difflineminus">-    : mIsWritable(true),</span>
<a href="#l38.399"></a><span id="l38.399" class="difflineminus">-      mIsDirty(false),</span>
<a href="#l38.400"></a><span id="l38.400" class="difflineminus">-      mLoadState(eLoadState_Unloaded)</span>
<a href="#l38.401"></a><span id="l38.401" class="difflineminus">-{</span>
<a href="#l38.402"></a><span id="l38.402" class="difflineminus">-}</span>
<a href="#l38.403"></a><span id="l38.403" class="difflineminus">-</span>
<a href="#l38.404"></a><span id="l38.404" class="difflineminus">-</span>
<a href="#l38.405"></a><span id="l38.405" class="difflineminus">-nsresult</span>
<a href="#l38.406"></a><span id="l38.406" class="difflineminus">-RDFXMLDataSourceImpl::Init()</span>
<a href="#l38.407"></a><span id="l38.407" class="difflineminus">-{</span>
<a href="#l38.408"></a><span id="l38.408" class="difflineminus">-    nsresult rv;</span>
<a href="#l38.409"></a><span id="l38.409" class="difflineminus">-    NS_DEFINE_CID(kRDFInMemoryDataSourceCID, NS_RDFINMEMORYDATASOURCE_CID);</span>
<a href="#l38.410"></a><span id="l38.410" class="difflineminus">-    mInner = do_CreateInstance(kRDFInMemoryDataSourceCID, &amp;rv);</span>
<a href="#l38.411"></a><span id="l38.411" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l38.412"></a><span id="l38.412" class="difflineminus">-</span>
<a href="#l38.413"></a><span id="l38.413" class="difflineminus">-    if (gRefCnt++ == 0) {</span>
<a href="#l38.414"></a><span id="l38.414" class="difflineminus">-        NS_DEFINE_CID(kRDFServiceCID, NS_RDFSERVICE_CID);</span>
<a href="#l38.415"></a><span id="l38.415" class="difflineminus">-        rv = CallGetService(kRDFServiceCID, &amp;gRDFService);</span>
<a href="#l38.416"></a><span id="l38.416" class="difflineminus">-</span>
<a href="#l38.417"></a><span id="l38.417" class="difflineminus">-        NS_ASSERTION(NS_SUCCEEDED(rv), &quot;unable to get RDF service&quot;);</span>
<a href="#l38.418"></a><span id="l38.418" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l38.419"></a><span id="l38.419" class="difflineminus">-    }</span>
<a href="#l38.420"></a><span id="l38.420" class="difflineminus">-</span>
<a href="#l38.421"></a><span id="l38.421" class="difflineminus">-    return NS_OK;</span>
<a href="#l38.422"></a><span id="l38.422" class="difflineminus">-}</span>
<a href="#l38.423"></a><span id="l38.423" class="difflineminus">-</span>
<a href="#l38.424"></a><span id="l38.424" class="difflineminus">-</span>
<a href="#l38.425"></a><span id="l38.425" class="difflineminus">-RDFXMLDataSourceImpl::~RDFXMLDataSourceImpl(void)</span>
<a href="#l38.426"></a><span id="l38.426" class="difflineminus">-{</span>
<a href="#l38.427"></a><span id="l38.427" class="difflineminus">-    // Unregister first so that nobody else tries to get us.</span>
<a href="#l38.428"></a><span id="l38.428" class="difflineminus">-    (void) gRDFService-&gt;UnregisterDataSource(this);</span>
<a href="#l38.429"></a><span id="l38.429" class="difflineminus">-</span>
<a href="#l38.430"></a><span id="l38.430" class="difflineminus">-    // Now flush contents</span>
<a href="#l38.431"></a><span id="l38.431" class="difflineminus">-    (void) Flush();</span>
<a href="#l38.432"></a><span id="l38.432" class="difflineminus">-</span>
<a href="#l38.433"></a><span id="l38.433" class="difflineminus">-    // Release RDF/XML sink observers</span>
<a href="#l38.434"></a><span id="l38.434" class="difflineminus">-    mObservers.Clear();</span>
<a href="#l38.435"></a><span id="l38.435" class="difflineminus">-</span>
<a href="#l38.436"></a><span id="l38.436" class="difflineminus">-    if (--gRefCnt == 0)</span>
<a href="#l38.437"></a><span id="l38.437" class="difflineminus">-        NS_IF_RELEASE(gRDFService);</span>
<a href="#l38.438"></a><span id="l38.438" class="difflineminus">-}</span>
<a href="#l38.439"></a><span id="l38.439" class="difflineminus">-</span>
<a href="#l38.440"></a><span id="l38.440" class="difflineminus">-NS_IMPL_CYCLE_COLLECTION_CLASS(RDFXMLDataSourceImpl)</span>
<a href="#l38.441"></a><span id="l38.441" class="difflineminus">-</span>
<a href="#l38.442"></a><span id="l38.442" class="difflineminus">-NS_IMPL_CYCLE_COLLECTION_UNLINK_0(RDFXMLDataSourceImpl)</span>
<a href="#l38.443"></a><span id="l38.443" class="difflineminus">-NS_IMPL_CYCLE_COLLECTION_TRAVERSE_BEGIN(RDFXMLDataSourceImpl)</span>
<a href="#l38.444"></a><span id="l38.444" class="difflineminus">-    NS_IMPL_CYCLE_COLLECTION_TRAVERSE(mInner)</span>
<a href="#l38.445"></a><span id="l38.445" class="difflineminus">-NS_IMPL_CYCLE_COLLECTION_TRAVERSE_END</span>
<a href="#l38.446"></a><span id="l38.446" class="difflineminus">-</span>
<a href="#l38.447"></a><span id="l38.447" class="difflineminus">-NS_IMPL_CYCLE_COLLECTING_ADDREF(RDFXMLDataSourceImpl)</span>
<a href="#l38.448"></a><span id="l38.448" class="difflineminus">-NS_IMPL_CYCLE_COLLECTING_RELEASE(RDFXMLDataSourceImpl)</span>
<a href="#l38.449"></a><span id="l38.449" class="difflineminus">-</span>
<a href="#l38.450"></a><span id="l38.450" class="difflineminus">-NS_INTERFACE_MAP_BEGIN_CYCLE_COLLECTION(RDFXMLDataSourceImpl)</span>
<a href="#l38.451"></a><span id="l38.451" class="difflineminus">-    NS_INTERFACE_MAP_ENTRY(nsIRDFDataSource)</span>
<a href="#l38.452"></a><span id="l38.452" class="difflineminus">-    NS_INTERFACE_MAP_ENTRY(nsIRDFRemoteDataSource)</span>
<a href="#l38.453"></a><span id="l38.453" class="difflineminus">-    NS_INTERFACE_MAP_ENTRY(nsIRDFXMLSink)</span>
<a href="#l38.454"></a><span id="l38.454" class="difflineminus">-    NS_INTERFACE_MAP_ENTRY(nsIRDFXMLSource)</span>
<a href="#l38.455"></a><span id="l38.455" class="difflineminus">-    NS_INTERFACE_MAP_ENTRY(nsIRequestObserver)</span>
<a href="#l38.456"></a><span id="l38.456" class="difflineminus">-    NS_INTERFACE_MAP_ENTRY(nsIStreamListener)</span>
<a href="#l38.457"></a><span id="l38.457" class="difflineminus">-    NS_INTERFACE_MAP_ENTRY(rdfIDataSource)</span>
<a href="#l38.458"></a><span id="l38.458" class="difflineminus">-    NS_INTERFACE_MAP_ENTRY(nsIInterfaceRequestor)</span>
<a href="#l38.459"></a><span id="l38.459" class="difflineminus">-    NS_INTERFACE_MAP_ENTRY(nsIChannelEventSink)</span>
<a href="#l38.460"></a><span id="l38.460" class="difflineminus">-    NS_INTERFACE_MAP_ENTRY_AMBIGUOUS(nsISupports, nsIRDFDataSource)</span>
<a href="#l38.461"></a><span id="l38.461" class="difflineminus">-NS_INTERFACE_MAP_END</span>
<a href="#l38.462"></a><span id="l38.462" class="difflineminus">-</span>
<a href="#l38.463"></a><span id="l38.463" class="difflineminus">-// nsIInterfaceRequestor</span>
<a href="#l38.464"></a><span id="l38.464" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l38.465"></a><span id="l38.465" class="difflineminus">-RDFXMLDataSourceImpl::GetInterface(const nsIID&amp; aIID, void** aSink)</span>
<a href="#l38.466"></a><span id="l38.466" class="difflineminus">-{</span>
<a href="#l38.467"></a><span id="l38.467" class="difflineminus">-  return QueryInterface(aIID, aSink);</span>
<a href="#l38.468"></a><span id="l38.468" class="difflineminus">-}</span>
<a href="#l38.469"></a><span id="l38.469" class="difflineminus">-</span>
<a href="#l38.470"></a><span id="l38.470" class="difflineminus">-nsresult</span>
<a href="#l38.471"></a><span id="l38.471" class="difflineminus">-RDFXMLDataSourceImpl::BlockingParse(nsIURI* aURL, nsIStreamListener* aConsumer)</span>
<a href="#l38.472"></a><span id="l38.472" class="difflineminus">-{</span>
<a href="#l38.473"></a><span id="l38.473" class="difflineminus">-    nsresult rv;</span>
<a href="#l38.474"></a><span id="l38.474" class="difflineminus">-</span>
<a href="#l38.475"></a><span id="l38.475" class="difflineminus">-    // XXX I really hate the way that we're spoon-feeding this stuff</span>
<a href="#l38.476"></a><span id="l38.476" class="difflineminus">-    // to the parser: it seems like this is something that netlib</span>
<a href="#l38.477"></a><span id="l38.477" class="difflineminus">-    // should be able to do by itself.</span>
<a href="#l38.478"></a><span id="l38.478" class="difflineminus">-</span>
<a href="#l38.479"></a><span id="l38.479" class="difflineminus">-    nsCOMPtr&lt;nsIChannel&gt; channel;</span>
<a href="#l38.480"></a><span id="l38.480" class="difflineminus">-</span>
<a href="#l38.481"></a><span id="l38.481" class="difflineminus">-    // Null LoadGroup ?</span>
<a href="#l38.482"></a><span id="l38.482" class="difflineminus">-    rv = NS_NewChannel(getter_AddRefs(channel),</span>
<a href="#l38.483"></a><span id="l38.483" class="difflineminus">-                       aURL,</span>
<a href="#l38.484"></a><span id="l38.484" class="difflineminus">-                       nsContentUtils::GetSystemPrincipal(),</span>
<a href="#l38.485"></a><span id="l38.485" class="difflineminus">-                       nsILoadInfo::SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l38.486"></a><span id="l38.486" class="difflineminus">-                       nsIContentPolicy::TYPE_OTHER);</span>
<a href="#l38.487"></a><span id="l38.487" class="difflineminus">-</span>
<a href="#l38.488"></a><span id="l38.488" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l38.489"></a><span id="l38.489" class="difflineminus">-    nsCOMPtr&lt;nsIInputStream&gt; in;</span>
<a href="#l38.490"></a><span id="l38.490" class="difflineminus">-    rv = channel-&gt;Open(getter_AddRefs(in));</span>
<a href="#l38.491"></a><span id="l38.491" class="difflineminus">-</span>
<a href="#l38.492"></a><span id="l38.492" class="difflineminus">-    // Report success if the file doesn't exist, but propagate other errors.</span>
<a href="#l38.493"></a><span id="l38.493" class="difflineminus">-    if (rv == NS_ERROR_FILE_NOT_FOUND) return NS_OK;</span>
<a href="#l38.494"></a><span id="l38.494" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l38.495"></a><span id="l38.495" class="difflineminus">-</span>
<a href="#l38.496"></a><span id="l38.496" class="difflineminus">-    if (! in) {</span>
<a href="#l38.497"></a><span id="l38.497" class="difflineminus">-        NS_ERROR(&quot;no input stream&quot;);</span>
<a href="#l38.498"></a><span id="l38.498" class="difflineminus">-        return NS_ERROR_FAILURE;</span>
<a href="#l38.499"></a><span id="l38.499" class="difflineminus">-    }</span>
<a href="#l38.500"></a><span id="l38.500" class="difflineminus">-</span>
<a href="#l38.501"></a><span id="l38.501" class="difflineminus">-    // Wrap the channel's input stream in a buffered stream to ensure that</span>
<a href="#l38.502"></a><span id="l38.502" class="difflineminus">-    // ReadSegments is implemented (which OnDataAvailable expects).</span>
<a href="#l38.503"></a><span id="l38.503" class="difflineminus">-    nsCOMPtr&lt;nsIInputStream&gt; bufStream;</span>
<a href="#l38.504"></a><span id="l38.504" class="difflineminus">-    rv = NS_NewBufferedInputStream(getter_AddRefs(bufStream), in.forget(),</span>
<a href="#l38.505"></a><span id="l38.505" class="difflineminus">-                                   4096 /* buffer size */);</span>
<a href="#l38.506"></a><span id="l38.506" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l38.507"></a><span id="l38.507" class="difflineminus">-</span>
<a href="#l38.508"></a><span id="l38.508" class="difflineminus">-    // Notify load observers</span>
<a href="#l38.509"></a><span id="l38.509" class="difflineminus">-    int32_t i;</span>
<a href="#l38.510"></a><span id="l38.510" class="difflineminus">-    for (i = mObservers.Count() - 1; i &gt;= 0; --i) {</span>
<a href="#l38.511"></a><span id="l38.511" class="difflineminus">-        // Make sure to hold a strong reference to the observer so</span>
<a href="#l38.512"></a><span id="l38.512" class="difflineminus">-        // that it doesn't go away in this call if it removes itself</span>
<a href="#l38.513"></a><span id="l38.513" class="difflineminus">-        // as an observer</span>
<a href="#l38.514"></a><span id="l38.514" class="difflineminus">-        nsCOMPtr&lt;nsIRDFXMLSinkObserver&gt; obs = mObservers[i];</span>
<a href="#l38.515"></a><span id="l38.515" class="difflineminus">-</span>
<a href="#l38.516"></a><span id="l38.516" class="difflineminus">-        if (obs) {</span>
<a href="#l38.517"></a><span id="l38.517" class="difflineminus">-            obs-&gt;OnBeginLoad(this);</span>
<a href="#l38.518"></a><span id="l38.518" class="difflineminus">-        }</span>
<a href="#l38.519"></a><span id="l38.519" class="difflineminus">-    }</span>
<a href="#l38.520"></a><span id="l38.520" class="difflineminus">-</span>
<a href="#l38.521"></a><span id="l38.521" class="difflineminus">-    rv = aConsumer-&gt;OnStartRequest(channel);</span>
<a href="#l38.522"></a><span id="l38.522" class="difflineminus">-</span>
<a href="#l38.523"></a><span id="l38.523" class="difflineminus">-    uint64_t offset = 0;</span>
<a href="#l38.524"></a><span id="l38.524" class="difflineminus">-    while (NS_SUCCEEDED(rv)) {</span>
<a href="#l38.525"></a><span id="l38.525" class="difflineminus">-        // Skip ODA if the channel is canceled</span>
<a href="#l38.526"></a><span id="l38.526" class="difflineminus">-        channel-&gt;GetStatus(&amp;rv);</span>
<a href="#l38.527"></a><span id="l38.527" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l38.528"></a><span id="l38.528" class="difflineminus">-            break;</span>
<a href="#l38.529"></a><span id="l38.529" class="difflineminus">-</span>
<a href="#l38.530"></a><span id="l38.530" class="difflineminus">-        uint64_t avail;</span>
<a href="#l38.531"></a><span id="l38.531" class="difflineminus">-        if (NS_FAILED(rv = bufStream-&gt;Available(&amp;avail)))</span>
<a href="#l38.532"></a><span id="l38.532" class="difflineminus">-            break; // error</span>
<a href="#l38.533"></a><span id="l38.533" class="difflineminus">-</span>
<a href="#l38.534"></a><span id="l38.534" class="difflineminus">-        if (avail == 0)</span>
<a href="#l38.535"></a><span id="l38.535" class="difflineminus">-            break; // eof</span>
<a href="#l38.536"></a><span id="l38.536" class="difflineminus">-</span>
<a href="#l38.537"></a><span id="l38.537" class="difflineminus">-        if (avail &gt; UINT32_MAX)</span>
<a href="#l38.538"></a><span id="l38.538" class="difflineminus">-            avail = UINT32_MAX;</span>
<a href="#l38.539"></a><span id="l38.539" class="difflineminus">-</span>
<a href="#l38.540"></a><span id="l38.540" class="difflineminus">-        rv = aConsumer-&gt;OnDataAvailable(channel, bufStream, offset, (uint32_t)avail);</span>
<a href="#l38.541"></a><span id="l38.541" class="difflineminus">-        if (NS_SUCCEEDED(rv))</span>
<a href="#l38.542"></a><span id="l38.542" class="difflineminus">-            offset += avail;</span>
<a href="#l38.543"></a><span id="l38.543" class="difflineminus">-    }</span>
<a href="#l38.544"></a><span id="l38.544" class="difflineminus">-</span>
<a href="#l38.545"></a><span id="l38.545" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l38.546"></a><span id="l38.546" class="difflineminus">-        channel-&gt;Cancel(rv);</span>
<a href="#l38.547"></a><span id="l38.547" class="difflineminus">-</span>
<a href="#l38.548"></a><span id="l38.548" class="difflineminus">-    channel-&gt;GetStatus(&amp;rv);</span>
<a href="#l38.549"></a><span id="l38.549" class="difflineminus">-    aConsumer-&gt;OnStopRequest(channel, rv);</span>
<a href="#l38.550"></a><span id="l38.550" class="difflineminus">-</span>
<a href="#l38.551"></a><span id="l38.551" class="difflineminus">-    // Notify load observers</span>
<a href="#l38.552"></a><span id="l38.552" class="difflineminus">-    for (i = mObservers.Count() - 1; i &gt;= 0; --i) {</span>
<a href="#l38.553"></a><span id="l38.553" class="difflineminus">-        // Make sure to hold a strong reference to the observer so</span>
<a href="#l38.554"></a><span id="l38.554" class="difflineminus">-        // that it doesn't go away in this call if it removes itself</span>
<a href="#l38.555"></a><span id="l38.555" class="difflineminus">-        // as an observer</span>
<a href="#l38.556"></a><span id="l38.556" class="difflineminus">-        nsCOMPtr&lt;nsIRDFXMLSinkObserver&gt; obs = mObservers[i];</span>
<a href="#l38.557"></a><span id="l38.557" class="difflineminus">-</span>
<a href="#l38.558"></a><span id="l38.558" class="difflineminus">-        if (obs) {</span>
<a href="#l38.559"></a><span id="l38.559" class="difflineminus">-            if (NS_FAILED(rv))</span>
<a href="#l38.560"></a><span id="l38.560" class="difflineminus">-                obs-&gt;OnError(this, rv, nullptr);</span>
<a href="#l38.561"></a><span id="l38.561" class="difflineminus">-</span>
<a href="#l38.562"></a><span id="l38.562" class="difflineminus">-            obs-&gt;OnEndLoad(this);</span>
<a href="#l38.563"></a><span id="l38.563" class="difflineminus">-        }</span>
<a href="#l38.564"></a><span id="l38.564" class="difflineminus">-    }</span>
<a href="#l38.565"></a><span id="l38.565" class="difflineminus">-</span>
<a href="#l38.566"></a><span id="l38.566" class="difflineminus">-    return rv;</span>
<a href="#l38.567"></a><span id="l38.567" class="difflineminus">-}</span>
<a href="#l38.568"></a><span id="l38.568" class="difflineminus">-</span>
<a href="#l38.569"></a><span id="l38.569" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l38.570"></a><span id="l38.570" class="difflineminus">-RDFXMLDataSourceImpl::GetLoaded(bool* _result)</span>
<a href="#l38.571"></a><span id="l38.571" class="difflineminus">-{</span>
<a href="#l38.572"></a><span id="l38.572" class="difflineminus">-    *_result = (mLoadState == eLoadState_Loaded);</span>
<a href="#l38.573"></a><span id="l38.573" class="difflineminus">-    return NS_OK;</span>
<a href="#l38.574"></a><span id="l38.574" class="difflineminus">-}</span>
<a href="#l38.575"></a><span id="l38.575" class="difflineminus">-</span>
<a href="#l38.576"></a><span id="l38.576" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l38.577"></a><span id="l38.577" class="difflineminus">-RDFXMLDataSourceImpl::Init(const char* uri)</span>
<a href="#l38.578"></a><span id="l38.578" class="difflineminus">-{</span>
<a href="#l38.579"></a><span id="l38.579" class="difflineminus">-    NS_ASSERTION(mInner != nullptr, &quot;not initialized&quot;);</span>
<a href="#l38.580"></a><span id="l38.580" class="difflineminus">-    if (! mInner)</span>
<a href="#l38.581"></a><span id="l38.581" class="difflineminus">-        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l38.582"></a><span id="l38.582" class="difflineminus">-</span>
<a href="#l38.583"></a><span id="l38.583" class="difflineminus">-    nsresult rv;</span>
<a href="#l38.584"></a><span id="l38.584" class="difflineminus">-</span>
<a href="#l38.585"></a><span id="l38.585" class="difflineminus">-    rv = NS_NewURI(getter_AddRefs(mURL), nsDependentCString(uri));</span>
<a href="#l38.586"></a><span id="l38.586" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l38.587"></a><span id="l38.587" class="difflineminus">-</span>
<a href="#l38.588"></a><span id="l38.588" class="difflineminus">-    // XXX this is a hack: any &quot;file:&quot; URI is considered writable. All</span>
<a href="#l38.589"></a><span id="l38.589" class="difflineminus">-    // others are considered read-only.</span>
<a href="#l38.590"></a><span id="l38.590" class="difflineminus">-    if ((PL_strncmp(uri, kFileURIPrefix, sizeof(kFileURIPrefix) - 1) != 0) &amp;&amp;</span>
<a href="#l38.591"></a><span id="l38.591" class="difflineminus">-        (PL_strncmp(uri, kResourceURIPrefix, sizeof(kResourceURIPrefix) - 1) != 0)) {</span>
<a href="#l38.592"></a><span id="l38.592" class="difflineminus">-        mIsWritable = false;</span>
<a href="#l38.593"></a><span id="l38.593" class="difflineminus">-    }</span>
<a href="#l38.594"></a><span id="l38.594" class="difflineminus">-</span>
<a href="#l38.595"></a><span id="l38.595" class="difflineminus">-    rv = gRDFService-&gt;RegisterDataSource(this, false);</span>
<a href="#l38.596"></a><span id="l38.596" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l38.597"></a><span id="l38.597" class="difflineminus">-</span>
<a href="#l38.598"></a><span id="l38.598" class="difflineminus">-    return NS_OK;</span>
<a href="#l38.599"></a><span id="l38.599" class="difflineminus">-}</span>
<a href="#l38.600"></a><span id="l38.600" class="difflineminus">-</span>
<a href="#l38.601"></a><span id="l38.601" class="difflineminus">-</span>
<a href="#l38.602"></a><span id="l38.602" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l38.603"></a><span id="l38.603" class="difflineminus">-RDFXMLDataSourceImpl::GetURI(nsACString&amp; aURI)</span>
<a href="#l38.604"></a><span id="l38.604" class="difflineminus">-{</span>
<a href="#l38.605"></a><span id="l38.605" class="difflineminus">-    if (!mURL) {</span>
<a href="#l38.606"></a><span id="l38.606" class="difflineminus">-        aURI.SetIsVoid(true);</span>
<a href="#l38.607"></a><span id="l38.607" class="difflineminus">-        return NS_OK;</span>
<a href="#l38.608"></a><span id="l38.608" class="difflineminus">-    }</span>
<a href="#l38.609"></a><span id="l38.609" class="difflineminus">-</span>
<a href="#l38.610"></a><span id="l38.610" class="difflineminus">-    return mURL-&gt;GetSpec(aURI);</span>
<a href="#l38.611"></a><span id="l38.611" class="difflineminus">-}</span>
<a href="#l38.612"></a><span id="l38.612" class="difflineminus">-</span>
<a href="#l38.613"></a><span id="l38.613" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l38.614"></a><span id="l38.614" class="difflineminus">-RDFXMLDataSourceImpl::Assert(nsIRDFResource* aSource,</span>
<a href="#l38.615"></a><span id="l38.615" class="difflineminus">-                             nsIRDFResource* aProperty,</span>
<a href="#l38.616"></a><span id="l38.616" class="difflineminus">-                             nsIRDFNode* aTarget,</span>
<a href="#l38.617"></a><span id="l38.617" class="difflineminus">-                             bool aTruthValue)</span>
<a href="#l38.618"></a><span id="l38.618" class="difflineminus">-{</span>
<a href="#l38.619"></a><span id="l38.619" class="difflineminus">-    // We don't accept assertions unless we're writable (except in the</span>
<a href="#l38.620"></a><span id="l38.620" class="difflineminus">-    // case that we're actually _reading_ the datasource in).</span>
<a href="#l38.621"></a><span id="l38.621" class="difflineminus">-    nsresult rv;</span>
<a href="#l38.622"></a><span id="l38.622" class="difflineminus">-</span>
<a href="#l38.623"></a><span id="l38.623" class="difflineminus">-    if (IsLoading()) {</span>
<a href="#l38.624"></a><span id="l38.624" class="difflineminus">-        bool hasAssertion = false;</span>
<a href="#l38.625"></a><span id="l38.625" class="difflineminus">-</span>
<a href="#l38.626"></a><span id="l38.626" class="difflineminus">-        nsCOMPtr&lt;nsIRDFPurgeableDataSource&gt; gcable = do_QueryInterface(mInner);</span>
<a href="#l38.627"></a><span id="l38.627" class="difflineminus">-        if (gcable) {</span>
<a href="#l38.628"></a><span id="l38.628" class="difflineminus">-            rv = gcable-&gt;Mark(aSource, aProperty, aTarget, aTruthValue, &amp;hasAssertion);</span>
<a href="#l38.629"></a><span id="l38.629" class="difflineminus">-            if (NS_FAILED(rv)) return rv;</span>
<a href="#l38.630"></a><span id="l38.630" class="difflineminus">-        }</span>
<a href="#l38.631"></a><span id="l38.631" class="difflineminus">-</span>
<a href="#l38.632"></a><span id="l38.632" class="difflineminus">-        rv = NS_RDF_ASSERTION_ACCEPTED;</span>
<a href="#l38.633"></a><span id="l38.633" class="difflineminus">-</span>
<a href="#l38.634"></a><span id="l38.634" class="difflineminus">-        if (! hasAssertion) {</span>
<a href="#l38.635"></a><span id="l38.635" class="difflineminus">-            rv = mInner-&gt;Assert(aSource, aProperty, aTarget, aTruthValue);</span>
<a href="#l38.636"></a><span id="l38.636" class="difflineminus">-</span>
<a href="#l38.637"></a><span id="l38.637" class="difflineminus">-            if (NS_SUCCEEDED(rv) &amp;&amp; gcable) {</span>
<a href="#l38.638"></a><span id="l38.638" class="difflineminus">-                // Now mark the new assertion, so it doesn't get</span>
<a href="#l38.639"></a><span id="l38.639" class="difflineminus">-                // removed when we sweep. Ignore rv, because we want</span>
<a href="#l38.640"></a><span id="l38.640" class="difflineminus">-                // to return what mInner-&gt;Assert() gave us.</span>
<a href="#l38.641"></a><span id="l38.641" class="difflineminus">-                bool didMark;</span>
<a href="#l38.642"></a><span id="l38.642" class="difflineminus">-                (void) gcable-&gt;Mark(aSource, aProperty, aTarget, aTruthValue, &amp;didMark);</span>
<a href="#l38.643"></a><span id="l38.643" class="difflineminus">-            }</span>
<a href="#l38.644"></a><span id="l38.644" class="difflineminus">-</span>
<a href="#l38.645"></a><span id="l38.645" class="difflineminus">-            if (NS_FAILED(rv)) return rv;</span>
<a href="#l38.646"></a><span id="l38.646" class="difflineminus">-        }</span>
<a href="#l38.647"></a><span id="l38.647" class="difflineminus">-</span>
<a href="#l38.648"></a><span id="l38.648" class="difflineminus">-        return rv;</span>
<a href="#l38.649"></a><span id="l38.649" class="difflineminus">-    }</span>
<a href="#l38.650"></a><span id="l38.650" class="difflineminus">-    else if (mIsWritable) {</span>
<a href="#l38.651"></a><span id="l38.651" class="difflineminus">-        rv = mInner-&gt;Assert(aSource, aProperty, aTarget, aTruthValue);</span>
<a href="#l38.652"></a><span id="l38.652" class="difflineminus">-</span>
<a href="#l38.653"></a><span id="l38.653" class="difflineminus">-        if (rv == NS_RDF_ASSERTION_ACCEPTED)</span>
<a href="#l38.654"></a><span id="l38.654" class="difflineminus">-            mIsDirty = true;</span>
<a href="#l38.655"></a><span id="l38.655" class="difflineminus">-</span>
<a href="#l38.656"></a><span id="l38.656" class="difflineminus">-        return rv;</span>
<a href="#l38.657"></a><span id="l38.657" class="difflineminus">-    }</span>
<a href="#l38.658"></a><span id="l38.658" class="difflineminus">-    else {</span>
<a href="#l38.659"></a><span id="l38.659" class="difflineminus">-        return NS_RDF_ASSERTION_REJECTED;</span>
<a href="#l38.660"></a><span id="l38.660" class="difflineminus">-    }</span>
<a href="#l38.661"></a><span id="l38.661" class="difflineminus">-}</span>
<a href="#l38.662"></a><span id="l38.662" class="difflineminus">-</span>
<a href="#l38.663"></a><span id="l38.663" class="difflineminus">-</span>
<a href="#l38.664"></a><span id="l38.664" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l38.665"></a><span id="l38.665" class="difflineminus">-RDFXMLDataSourceImpl::Unassert(nsIRDFResource* source,</span>
<a href="#l38.666"></a><span id="l38.666" class="difflineminus">-                               nsIRDFResource* property,</span>
<a href="#l38.667"></a><span id="l38.667" class="difflineminus">-                               nsIRDFNode* target)</span>
<a href="#l38.668"></a><span id="l38.668" class="difflineminus">-{</span>
<a href="#l38.669"></a><span id="l38.669" class="difflineminus">-    // We don't accept assertions unless we're writable (except in the</span>
<a href="#l38.670"></a><span id="l38.670" class="difflineminus">-    // case that we're actually _reading_ the datasource in).</span>
<a href="#l38.671"></a><span id="l38.671" class="difflineminus">-    nsresult rv;</span>
<a href="#l38.672"></a><span id="l38.672" class="difflineminus">-</span>
<a href="#l38.673"></a><span id="l38.673" class="difflineminus">-    if (IsLoading() || mIsWritable) {</span>
<a href="#l38.674"></a><span id="l38.674" class="difflineminus">-        rv = mInner-&gt;Unassert(source, property, target);</span>
<a href="#l38.675"></a><span id="l38.675" class="difflineminus">-        if (!IsLoading() &amp;&amp; rv == NS_RDF_ASSERTION_ACCEPTED)</span>
<a href="#l38.676"></a><span id="l38.676" class="difflineminus">-            mIsDirty = true;</span>
<a href="#l38.677"></a><span id="l38.677" class="difflineminus">-    }</span>
<a href="#l38.678"></a><span id="l38.678" class="difflineminus">-    else {</span>
<a href="#l38.679"></a><span id="l38.679" class="difflineminus">-        rv = NS_RDF_ASSERTION_REJECTED;</span>
<a href="#l38.680"></a><span id="l38.680" class="difflineminus">-    }</span>
<a href="#l38.681"></a><span id="l38.681" class="difflineminus">-</span>
<a href="#l38.682"></a><span id="l38.682" class="difflineminus">-    return rv;</span>
<a href="#l38.683"></a><span id="l38.683" class="difflineminus">-}</span>
<a href="#l38.684"></a><span id="l38.684" class="difflineminus">-</span>
<a href="#l38.685"></a><span id="l38.685" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l38.686"></a><span id="l38.686" class="difflineminus">-RDFXMLDataSourceImpl::Change(nsIRDFResource* aSource,</span>
<a href="#l38.687"></a><span id="l38.687" class="difflineminus">-                             nsIRDFResource* aProperty,</span>
<a href="#l38.688"></a><span id="l38.688" class="difflineminus">-                             nsIRDFNode* aOldTarget,</span>
<a href="#l38.689"></a><span id="l38.689" class="difflineminus">-                             nsIRDFNode* aNewTarget)</span>
<a href="#l38.690"></a><span id="l38.690" class="difflineminus">-{</span>
<a href="#l38.691"></a><span id="l38.691" class="difflineminus">-    nsresult rv;</span>
<a href="#l38.692"></a><span id="l38.692" class="difflineminus">-</span>
<a href="#l38.693"></a><span id="l38.693" class="difflineminus">-    if (IsLoading() || mIsWritable) {</span>
<a href="#l38.694"></a><span id="l38.694" class="difflineminus">-        rv = mInner-&gt;Change(aSource, aProperty, aOldTarget, aNewTarget);</span>
<a href="#l38.695"></a><span id="l38.695" class="difflineminus">-</span>
<a href="#l38.696"></a><span id="l38.696" class="difflineminus">-        if (!IsLoading() &amp;&amp; rv == NS_RDF_ASSERTION_ACCEPTED)</span>
<a href="#l38.697"></a><span id="l38.697" class="difflineminus">-            mIsDirty = true;</span>
<a href="#l38.698"></a><span id="l38.698" class="difflineminus">-    }</span>
<a href="#l38.699"></a><span id="l38.699" class="difflineminus">-    else {</span>
<a href="#l38.700"></a><span id="l38.700" class="difflineminus">-        rv = NS_RDF_ASSERTION_REJECTED;</span>
<a href="#l38.701"></a><span id="l38.701" class="difflineminus">-    }</span>
<a href="#l38.702"></a><span id="l38.702" class="difflineminus">-</span>
<a href="#l38.703"></a><span id="l38.703" class="difflineminus">-    return rv;</span>
<a href="#l38.704"></a><span id="l38.704" class="difflineminus">-}</span>
<a href="#l38.705"></a><span id="l38.705" class="difflineminus">-</span>
<a href="#l38.706"></a><span id="l38.706" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l38.707"></a><span id="l38.707" class="difflineminus">-RDFXMLDataSourceImpl::Move(nsIRDFResource* aOldSource,</span>
<a href="#l38.708"></a><span id="l38.708" class="difflineminus">-                           nsIRDFResource* aNewSource,</span>
<a href="#l38.709"></a><span id="l38.709" class="difflineminus">-                           nsIRDFResource* aProperty,</span>
<a href="#l38.710"></a><span id="l38.710" class="difflineminus">-                           nsIRDFNode* aTarget)</span>
<a href="#l38.711"></a><span id="l38.711" class="difflineminus">-{</span>
<a href="#l38.712"></a><span id="l38.712" class="difflineminus">-    nsresult rv;</span>
<a href="#l38.713"></a><span id="l38.713" class="difflineminus">-</span>
<a href="#l38.714"></a><span id="l38.714" class="difflineminus">-    if (IsLoading() || mIsWritable) {</span>
<a href="#l38.715"></a><span id="l38.715" class="difflineminus">-        rv = mInner-&gt;Move(aOldSource, aNewSource, aProperty, aTarget);</span>
<a href="#l38.716"></a><span id="l38.716" class="difflineminus">-        if (!IsLoading() &amp;&amp; rv == NS_RDF_ASSERTION_ACCEPTED)</span>
<a href="#l38.717"></a><span id="l38.717" class="difflineminus">-            mIsDirty = true;</span>
<a href="#l38.718"></a><span id="l38.718" class="difflineminus">-    }</span>
<a href="#l38.719"></a><span id="l38.719" class="difflineminus">-    else {</span>
<a href="#l38.720"></a><span id="l38.720" class="difflineminus">-        rv = NS_RDF_ASSERTION_REJECTED;</span>
<a href="#l38.721"></a><span id="l38.721" class="difflineminus">-    }</span>
<a href="#l38.722"></a><span id="l38.722" class="difflineminus">-</span>
<a href="#l38.723"></a><span id="l38.723" class="difflineminus">-    return rv;</span>
<a href="#l38.724"></a><span id="l38.724" class="difflineminus">-}</span>
<a href="#l38.725"></a><span id="l38.725" class="difflineminus">-</span>
<a href="#l38.726"></a><span id="l38.726" class="difflineminus">-</span>
<a href="#l38.727"></a><span id="l38.727" class="difflineminus">-nsresult</span>
<a href="#l38.728"></a><span id="l38.728" class="difflineminus">-RDFXMLDataSourceImpl::rdfXMLFlush(nsIURI *aURI)</span>
<a href="#l38.729"></a><span id="l38.729" class="difflineminus">-{</span>
<a href="#l38.730"></a><span id="l38.730" class="difflineminus">-</span>
<a href="#l38.731"></a><span id="l38.731" class="difflineminus">-    nsresult rv;</span>
<a href="#l38.732"></a><span id="l38.732" class="difflineminus">-</span>
<a href="#l38.733"></a><span id="l38.733" class="difflineminus">-    {</span>
<a href="#l38.734"></a><span id="l38.734" class="difflineminus">-        // Quick and dirty check to see if we're in XPCOM shutdown. If</span>
<a href="#l38.735"></a><span id="l38.735" class="difflineminus">-        // we are, we're screwed: it's too late to serialize because</span>
<a href="#l38.736"></a><span id="l38.736" class="difflineminus">-        // many of the services that we'll need to acquire to properly</span>
<a href="#l38.737"></a><span id="l38.737" class="difflineminus">-        // write the file will be unaquirable.</span>
<a href="#l38.738"></a><span id="l38.738" class="difflineminus">-        NS_DEFINE_CID(kRDFServiceCID, NS_RDFSERVICE_CID);</span>
<a href="#l38.739"></a><span id="l38.739" class="difflineminus">-        nsCOMPtr&lt;nsIRDFService&gt; dummy = do_GetService(kRDFServiceCID, &amp;rv);</span>
<a href="#l38.740"></a><span id="l38.740" class="difflineminus">-        if (NS_FAILED(rv)) {</span>
<a href="#l38.741"></a><span id="l38.741" class="difflineminus">-            NS_WARNING(&quot;unable to Flush() dirty datasource during XPCOM shutdown&quot;);</span>
<a href="#l38.742"></a><span id="l38.742" class="difflineminus">-            return rv;</span>
<a href="#l38.743"></a><span id="l38.743" class="difflineminus">-        }</span>
<a href="#l38.744"></a><span id="l38.744" class="difflineminus">-    }</span>
<a href="#l38.745"></a><span id="l38.745" class="difflineminus">-</span>
<a href="#l38.746"></a><span id="l38.746" class="difflineminus">-    // Is it a file? If so, we can write to it. Some day, it'd be nice</span>
<a href="#l38.747"></a><span id="l38.747" class="difflineminus">-    // if we didn't care what kind of stream this was...</span>
<a href="#l38.748"></a><span id="l38.748" class="difflineminus">-    nsCOMPtr&lt;nsIFileURL&gt; fileURL = do_QueryInterface(aURI);</span>
<a href="#l38.749"></a><span id="l38.749" class="difflineminus">-</span>
<a href="#l38.750"></a><span id="l38.750" class="difflineminus">-    if (fileURL) {</span>
<a href="#l38.751"></a><span id="l38.751" class="difflineminus">-        nsCOMPtr&lt;nsIFile&gt; file;</span>
<a href="#l38.752"></a><span id="l38.752" class="difflineminus">-        fileURL-&gt;GetFile(getter_AddRefs(file));</span>
<a href="#l38.753"></a><span id="l38.753" class="difflineminus">-        if (file) {</span>
<a href="#l38.754"></a><span id="l38.754" class="difflineminus">-            // get a safe output stream, so we don't clobber the datasource file unless</span>
<a href="#l38.755"></a><span id="l38.755" class="difflineminus">-            // all the writes succeeded.</span>
<a href="#l38.756"></a><span id="l38.756" class="difflineminus">-            nsCOMPtr&lt;nsIOutputStream&gt; out;</span>
<a href="#l38.757"></a><span id="l38.757" class="difflineminus">-            rv = NS_NewSafeLocalFileOutputStream(getter_AddRefs(out),</span>
<a href="#l38.758"></a><span id="l38.758" class="difflineminus">-                                                 file,</span>
<a href="#l38.759"></a><span id="l38.759" class="difflineminus">-                                                 PR_WRONLY | PR_CREATE_FILE,</span>
<a href="#l38.760"></a><span id="l38.760" class="difflineminus">-                                                 /*octal*/ 0666,</span>
<a href="#l38.761"></a><span id="l38.761" class="difflineminus">-                                                 0);</span>
<a href="#l38.762"></a><span id="l38.762" class="difflineminus">-            if (NS_FAILED(rv)) return rv;</span>
<a href="#l38.763"></a><span id="l38.763" class="difflineminus">-</span>
<a href="#l38.764"></a><span id="l38.764" class="difflineminus">-            nsCOMPtr&lt;nsIOutputStream&gt; bufferedOut;</span>
<a href="#l38.765"></a><span id="l38.765" class="difflineminus">-            rv = NS_NewBufferedOutputStream(getter_AddRefs(bufferedOut),</span>
<a href="#l38.766"></a><span id="l38.766" class="difflineminus">-                                            out.forget(), 4096);</span>
<a href="#l38.767"></a><span id="l38.767" class="difflineminus">-            if (NS_FAILED(rv)) return rv;</span>
<a href="#l38.768"></a><span id="l38.768" class="difflineminus">-</span>
<a href="#l38.769"></a><span id="l38.769" class="difflineminus">-            rv = Serialize(bufferedOut);</span>
<a href="#l38.770"></a><span id="l38.770" class="difflineminus">-            if (NS_FAILED(rv)) return rv;</span>
<a href="#l38.771"></a><span id="l38.771" class="difflineminus">-</span>
<a href="#l38.772"></a><span id="l38.772" class="difflineminus">-            // All went ok. Maybe except for problems in Write(), but the stream detects</span>
<a href="#l38.773"></a><span id="l38.773" class="difflineminus">-            // that for us</span>
<a href="#l38.774"></a><span id="l38.774" class="difflineminus">-            nsCOMPtr&lt;nsISafeOutputStream&gt; safeStream = do_QueryInterface(bufferedOut, &amp;rv);</span>
<a href="#l38.775"></a><span id="l38.775" class="difflineminus">-            if (NS_FAILED(rv)) return rv;</span>
<a href="#l38.776"></a><span id="l38.776" class="difflineminus">-</span>
<a href="#l38.777"></a><span id="l38.777" class="difflineminus">-            rv = safeStream-&gt;Finish();</span>
<a href="#l38.778"></a><span id="l38.778" class="difflineminus">-            if (NS_FAILED(rv)) {</span>
<a href="#l38.779"></a><span id="l38.779" class="difflineminus">-                NS_WARNING(&quot;failed to save datasource file! possible dataloss&quot;);</span>
<a href="#l38.780"></a><span id="l38.780" class="difflineminus">-                return rv;</span>
<a href="#l38.781"></a><span id="l38.781" class="difflineminus">-            }</span>
<a href="#l38.782"></a><span id="l38.782" class="difflineminus">-        }</span>
<a href="#l38.783"></a><span id="l38.783" class="difflineminus">-    }</span>
<a href="#l38.784"></a><span id="l38.784" class="difflineminus">-</span>
<a href="#l38.785"></a><span id="l38.785" class="difflineminus">-    return NS_OK;</span>
<a href="#l38.786"></a><span id="l38.786" class="difflineminus">-}</span>
<a href="#l38.787"></a><span id="l38.787" class="difflineminus">-</span>
<a href="#l38.788"></a><span id="l38.788" class="difflineminus">-</span>
<a href="#l38.789"></a><span id="l38.789" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l38.790"></a><span id="l38.790" class="difflineminus">-RDFXMLDataSourceImpl::FlushTo(const char *aURI)</span>
<a href="#l38.791"></a><span id="l38.791" class="difflineminus">-{</span>
<a href="#l38.792"></a><span id="l38.792" class="difflineminus">-    NS_ASSERTION(aURI != nullptr, &quot;not initialized&quot;);</span>
<a href="#l38.793"></a><span id="l38.793" class="difflineminus">-    if (!aURI)</span>
<a href="#l38.794"></a><span id="l38.794" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l38.795"></a><span id="l38.795" class="difflineminus">-</span>
<a href="#l38.796"></a><span id="l38.796" class="difflineminus">-    // XXX this is a hack: any &quot;file:&quot; URI is considered writable. All</span>
<a href="#l38.797"></a><span id="l38.797" class="difflineminus">-    // others are considered read-only.</span>
<a href="#l38.798"></a><span id="l38.798" class="difflineminus">-    if ((PL_strncmp(aURI, kFileURIPrefix, sizeof(kFileURIPrefix) - 1) != 0) &amp;&amp;</span>
<a href="#l38.799"></a><span id="l38.799" class="difflineminus">-        (PL_strncmp(aURI, kResourceURIPrefix, sizeof(kResourceURIPrefix) - 1) != 0))</span>
<a href="#l38.800"></a><span id="l38.800" class="difflineminus">-    {</span>
<a href="#l38.801"></a><span id="l38.801" class="difflineminus">-        return NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l38.802"></a><span id="l38.802" class="difflineminus">-    }</span>
<a href="#l38.803"></a><span id="l38.803" class="difflineminus">-</span>
<a href="#l38.804"></a><span id="l38.804" class="difflineminus">-    nsCOMPtr&lt;nsIURI&gt;  url;</span>
<a href="#l38.805"></a><span id="l38.805" class="difflineminus">-    nsresult rv = NS_NewURI(getter_AddRefs(url), aURI);</span>
<a href="#l38.806"></a><span id="l38.806" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l38.807"></a><span id="l38.807" class="difflineminus">-      return rv;</span>
<a href="#l38.808"></a><span id="l38.808" class="difflineminus">-    rv = rdfXMLFlush(url);</span>
<a href="#l38.809"></a><span id="l38.809" class="difflineminus">-    return rv;</span>
<a href="#l38.810"></a><span id="l38.810" class="difflineminus">-}</span>
<a href="#l38.811"></a><span id="l38.811" class="difflineminus">-</span>
<a href="#l38.812"></a><span id="l38.812" class="difflineminus">-</span>
<a href="#l38.813"></a><span id="l38.813" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l38.814"></a><span id="l38.814" class="difflineminus">-RDFXMLDataSourceImpl::Flush(void)</span>
<a href="#l38.815"></a><span id="l38.815" class="difflineminus">-{</span>
<a href="#l38.816"></a><span id="l38.816" class="difflineminus">-    if (!mIsWritable || !mIsDirty)</span>
<a href="#l38.817"></a><span id="l38.817" class="difflineminus">-        return NS_OK;</span>
<a href="#l38.818"></a><span id="l38.818" class="difflineminus">-</span>
<a href="#l38.819"></a><span id="l38.819" class="difflineminus">-    // while it is not fatal if mURL is not set,</span>
<a href="#l38.820"></a><span id="l38.820" class="difflineminus">-    // indicate failure since we can't flush back to an unknown origin</span>
<a href="#l38.821"></a><span id="l38.821" class="difflineminus">-    if (! mURL)</span>
<a href="#l38.822"></a><span id="l38.822" class="difflineminus">-        return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l38.823"></a><span id="l38.823" class="difflineminus">-</span>
<a href="#l38.824"></a><span id="l38.824" class="difflineminus">-    if (MOZ_LOG_TEST(gLog, LogLevel::Debug)) {</span>
<a href="#l38.825"></a><span id="l38.825" class="difflineminus">-      MOZ_LOG(gLog, LogLevel::Debug,</span>
<a href="#l38.826"></a><span id="l38.826" class="difflineminus">-              (&quot;rdfxml[%p] flush(%s)&quot;, this, mURL-&gt;GetSpecOrDefault().get()));</span>
<a href="#l38.827"></a><span id="l38.827" class="difflineminus">-    }</span>
<a href="#l38.828"></a><span id="l38.828" class="difflineminus">-</span>
<a href="#l38.829"></a><span id="l38.829" class="difflineminus">-    nsresult rv;</span>
<a href="#l38.830"></a><span id="l38.830" class="difflineminus">-    if (NS_SUCCEEDED(rv = rdfXMLFlush(mURL)))</span>
<a href="#l38.831"></a><span id="l38.831" class="difflineminus">-    {</span>
<a href="#l38.832"></a><span id="l38.832" class="difflineminus">-      mIsDirty = false;</span>
<a href="#l38.833"></a><span id="l38.833" class="difflineminus">-    }</span>
<a href="#l38.834"></a><span id="l38.834" class="difflineminus">-    return rv;</span>
<a href="#l38.835"></a><span id="l38.835" class="difflineminus">-}</span>
<a href="#l38.836"></a><span id="l38.836" class="difflineminus">-</span>
<a href="#l38.837"></a><span id="l38.837" class="difflineminus">-</span>
<a href="#l38.838"></a><span id="l38.838" class="difflineminus">-//----------------------------------------------------------------------</span>
<a href="#l38.839"></a><span id="l38.839" class="difflineminus">-//</span>
<a href="#l38.840"></a><span id="l38.840" class="difflineminus">-// nsIRDFXMLDataSource methods</span>
<a href="#l38.841"></a><span id="l38.841" class="difflineminus">-//</span>
<a href="#l38.842"></a><span id="l38.842" class="difflineminus">-</span>
<a href="#l38.843"></a><span id="l38.843" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l38.844"></a><span id="l38.844" class="difflineminus">-RDFXMLDataSourceImpl::GetReadOnly(bool* aIsReadOnly)</span>
<a href="#l38.845"></a><span id="l38.845" class="difflineminus">-{</span>
<a href="#l38.846"></a><span id="l38.846" class="difflineminus">-    *aIsReadOnly = !mIsWritable;</span>
<a href="#l38.847"></a><span id="l38.847" class="difflineminus">-    return NS_OK;</span>
<a href="#l38.848"></a><span id="l38.848" class="difflineminus">-}</span>
<a href="#l38.849"></a><span id="l38.849" class="difflineminus">-</span>
<a href="#l38.850"></a><span id="l38.850" class="difflineminus">-</span>
<a href="#l38.851"></a><span id="l38.851" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l38.852"></a><span id="l38.852" class="difflineminus">-RDFXMLDataSourceImpl::SetReadOnly(bool aIsReadOnly)</span>
<a href="#l38.853"></a><span id="l38.853" class="difflineminus">-{</span>
<a href="#l38.854"></a><span id="l38.854" class="difflineminus">-    if (mIsWritable &amp;&amp; aIsReadOnly)</span>
<a href="#l38.855"></a><span id="l38.855" class="difflineminus">-        mIsWritable = false;</span>
<a href="#l38.856"></a><span id="l38.856" class="difflineminus">-</span>
<a href="#l38.857"></a><span id="l38.857" class="difflineminus">-    return NS_OK;</span>
<a href="#l38.858"></a><span id="l38.858" class="difflineminus">-}</span>
<a href="#l38.859"></a><span id="l38.859" class="difflineminus">-</span>
<a href="#l38.860"></a><span id="l38.860" class="difflineminus">-// nsIChannelEventSink</span>
<a href="#l38.861"></a><span id="l38.861" class="difflineminus">-</span>
<a href="#l38.862"></a><span id="l38.862" class="difflineminus">-// This code is copied from nsSameOriginChecker::OnChannelRedirect. See</span>
<a href="#l38.863"></a><span id="l38.863" class="difflineminus">-// bug 475940 on providing this code in a shared location.</span>
<a href="#l38.864"></a><span id="l38.864" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l38.865"></a><span id="l38.865" class="difflineminus">-RDFXMLDataSourceImpl::AsyncOnChannelRedirect(nsIChannel *aOldChannel,</span>
<a href="#l38.866"></a><span id="l38.866" class="difflineminus">-                                             nsIChannel *aNewChannel,</span>
<a href="#l38.867"></a><span id="l38.867" class="difflineminus">-                                             uint32_t aFlags,</span>
<a href="#l38.868"></a><span id="l38.868" class="difflineminus">-                                             nsIAsyncVerifyRedirectCallback *cb)</span>
<a href="#l38.869"></a><span id="l38.869" class="difflineminus">-{</span>
<a href="#l38.870"></a><span id="l38.870" class="difflineminus">-    NS_ASSERTION(aNewChannel, &quot;Redirecting to null channel?&quot;);</span>
<a href="#l38.871"></a><span id="l38.871" class="difflineminus">-</span>
<a href="#l38.872"></a><span id="l38.872" class="difflineminus">-    nsresult rv;</span>
<a href="#l38.873"></a><span id="l38.873" class="difflineminus">-    nsCOMPtr&lt;nsIScriptSecurityManager&gt; secMan =</span>
<a href="#l38.874"></a><span id="l38.874" class="difflineminus">-        do_GetService(NS_SCRIPTSECURITYMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l38.875"></a><span id="l38.875" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l38.876"></a><span id="l38.876" class="difflineminus">-</span>
<a href="#l38.877"></a><span id="l38.877" class="difflineminus">-    nsCOMPtr&lt;nsIPrincipal&gt; oldPrincipal;</span>
<a href="#l38.878"></a><span id="l38.878" class="difflineminus">-    secMan-&gt;GetChannelResultPrincipal(aOldChannel, getter_AddRefs(oldPrincipal));</span>
<a href="#l38.879"></a><span id="l38.879" class="difflineminus">-</span>
<a href="#l38.880"></a><span id="l38.880" class="difflineminus">-    nsCOMPtr&lt;nsIURI&gt; newURI;</span>
<a href="#l38.881"></a><span id="l38.881" class="difflineminus">-    aNewChannel-&gt;GetURI(getter_AddRefs(newURI));</span>
<a href="#l38.882"></a><span id="l38.882" class="difflineminus">-    nsCOMPtr&lt;nsIURI&gt; newOriginalURI;</span>
<a href="#l38.883"></a><span id="l38.883" class="difflineminus">-    aNewChannel-&gt;GetOriginalURI(getter_AddRefs(newOriginalURI));</span>
<a href="#l38.884"></a><span id="l38.884" class="difflineminus">-</span>
<a href="#l38.885"></a><span id="l38.885" class="difflineminus">-    NS_ENSURE_STATE(oldPrincipal &amp;&amp; newURI &amp;&amp; newOriginalURI);</span>
<a href="#l38.886"></a><span id="l38.886" class="difflineminus">-</span>
<a href="#l38.887"></a><span id="l38.887" class="difflineminus">-    rv = oldPrincipal-&gt;CheckMayLoad(newURI, false, false);</span>
<a href="#l38.888"></a><span id="l38.888" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; newOriginalURI != newURI) {</span>
<a href="#l38.889"></a><span id="l38.889" class="difflineminus">-        rv = oldPrincipal-&gt;CheckMayLoad(newOriginalURI, false, false);</span>
<a href="#l38.890"></a><span id="l38.890" class="difflineminus">-    }</span>
<a href="#l38.891"></a><span id="l38.891" class="difflineminus">-</span>
<a href="#l38.892"></a><span id="l38.892" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l38.893"></a><span id="l38.893" class="difflineminus">-        return rv;</span>
<a href="#l38.894"></a><span id="l38.894" class="difflineminus">-</span>
<a href="#l38.895"></a><span id="l38.895" class="difflineminus">-    cb-&gt;OnRedirectVerifyCallback(NS_OK);</span>
<a href="#l38.896"></a><span id="l38.896" class="difflineminus">-    return NS_OK;</span>
<a href="#l38.897"></a><span id="l38.897" class="difflineminus">-}</span>
<a href="#l38.898"></a><span id="l38.898" class="difflineminus">-</span>
<a href="#l38.899"></a><span id="l38.899" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l38.900"></a><span id="l38.900" class="difflineminus">-RDFXMLDataSourceImpl::Refresh(bool aBlocking)</span>
<a href="#l38.901"></a><span id="l38.901" class="difflineminus">-{</span>
<a href="#l38.902"></a><span id="l38.902" class="difflineminus">-    nsAutoCString spec;</span>
<a href="#l38.903"></a><span id="l38.903" class="difflineminus">-    if (mURL) {</span>
<a href="#l38.904"></a><span id="l38.904" class="difflineminus">-        spec = mURL-&gt;GetSpecOrDefault();</span>
<a href="#l38.905"></a><span id="l38.905" class="difflineminus">-    }</span>
<a href="#l38.906"></a><span id="l38.906" class="difflineminus">-    MOZ_LOG(gLog, LogLevel::Debug,</span>
<a href="#l38.907"></a><span id="l38.907" class="difflineminus">-           (&quot;rdfxml[%p] refresh(%s) %sblocking&quot;, this, spec.get(), (aBlocking ? &quot;&quot; : &quot;non&quot;)));</span>
<a href="#l38.908"></a><span id="l38.908" class="difflineminus">-</span>
<a href="#l38.909"></a><span id="l38.909" class="difflineminus">-    // If an asynchronous load is already pending, then just let it do</span>
<a href="#l38.910"></a><span id="l38.910" class="difflineminus">-    // the honors.</span>
<a href="#l38.911"></a><span id="l38.911" class="difflineminus">-    if (IsLoading()) {</span>
<a href="#l38.912"></a><span id="l38.912" class="difflineminus">-        MOZ_LOG(gLog, LogLevel::Debug,</span>
<a href="#l38.913"></a><span id="l38.913" class="difflineminus">-               (&quot;rdfxml[%p] refresh(%s) a load was pending&quot;, this, spec.get()));</span>
<a href="#l38.914"></a><span id="l38.914" class="difflineminus">-</span>
<a href="#l38.915"></a><span id="l38.915" class="difflineminus">-        if (aBlocking) {</span>
<a href="#l38.916"></a><span id="l38.916" class="difflineminus">-            NS_WARNING(&quot;blocking load requested when async load pending&quot;);</span>
<a href="#l38.917"></a><span id="l38.917" class="difflineminus">-            return NS_ERROR_FAILURE;</span>
<a href="#l38.918"></a><span id="l38.918" class="difflineminus">-        }</span>
<a href="#l38.919"></a><span id="l38.919" class="difflineminus">-        else {</span>
<a href="#l38.920"></a><span id="l38.920" class="difflineminus">-            return NS_OK;</span>
<a href="#l38.921"></a><span id="l38.921" class="difflineminus">-        }</span>
<a href="#l38.922"></a><span id="l38.922" class="difflineminus">-    }</span>
<a href="#l38.923"></a><span id="l38.923" class="difflineminus">-</span>
<a href="#l38.924"></a><span id="l38.924" class="difflineminus">-    if (! mURL)</span>
<a href="#l38.925"></a><span id="l38.925" class="difflineminus">-        return NS_ERROR_FAILURE;</span>
<a href="#l38.926"></a><span id="l38.926" class="difflineminus">-    nsCOMPtr&lt;nsIRDFXMLParser&gt; parser = do_CreateInstance(&quot;@mozilla.org/rdf/xml-parser;1&quot;);</span>
<a href="#l38.927"></a><span id="l38.927" class="difflineminus">-    if (! parser)</span>
<a href="#l38.928"></a><span id="l38.928" class="difflineminus">-        return NS_ERROR_FAILURE;</span>
<a href="#l38.929"></a><span id="l38.929" class="difflineminus">-</span>
<a href="#l38.930"></a><span id="l38.930" class="difflineminus">-    nsresult rv = parser-&gt;ParseAsync(this, mURL, getter_AddRefs(mListener));</span>
<a href="#l38.931"></a><span id="l38.931" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l38.932"></a><span id="l38.932" class="difflineminus">-</span>
<a href="#l38.933"></a><span id="l38.933" class="difflineminus">-    if (aBlocking) {</span>
<a href="#l38.934"></a><span id="l38.934" class="difflineminus">-        rv = BlockingParse(mURL, this);</span>
<a href="#l38.935"></a><span id="l38.935" class="difflineminus">-</span>
<a href="#l38.936"></a><span id="l38.936" class="difflineminus">-        mListener = nullptr; // release the parser</span>
<a href="#l38.937"></a><span id="l38.937" class="difflineminus">-</span>
<a href="#l38.938"></a><span id="l38.938" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l38.939"></a><span id="l38.939" class="difflineminus">-    }</span>
<a href="#l38.940"></a><span id="l38.940" class="difflineminus">-    else {</span>
<a href="#l38.941"></a><span id="l38.941" class="difflineminus">-        // Null LoadGroup ?</span>
<a href="#l38.942"></a><span id="l38.942" class="difflineminus">-        nsCOMPtr&lt;nsIChannel&gt; channel;</span>
<a href="#l38.943"></a><span id="l38.943" class="difflineminus">-        rv = NS_NewChannel(getter_AddRefs(channel),</span>
<a href="#l38.944"></a><span id="l38.944" class="difflineminus">-                           mURL,</span>
<a href="#l38.945"></a><span id="l38.945" class="difflineminus">-                           nsContentUtils::GetSystemPrincipal(),</span>
<a href="#l38.946"></a><span id="l38.946" class="difflineminus">-                           nsILoadInfo::SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l38.947"></a><span id="l38.947" class="difflineminus">-                           nsIContentPolicy::TYPE_OTHER,</span>
<a href="#l38.948"></a><span id="l38.948" class="difflineminus">-                           nullptr, // aCookieSettings</span>
<a href="#l38.949"></a><span id="l38.949" class="difflineminus">-                           nullptr, // aPerformanceStorage</span>
<a href="#l38.950"></a><span id="l38.950" class="difflineminus">-                           nullptr, // aLoadGroup</span>
<a href="#l38.951"></a><span id="l38.951" class="difflineminus">-                           this);   // aCallbacks</span>
<a href="#l38.952"></a><span id="l38.952" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l38.953"></a><span id="l38.953" class="difflineminus">-        rv = channel-&gt;AsyncOpen(this);</span>
<a href="#l38.954"></a><span id="l38.954" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l38.955"></a><span id="l38.955" class="difflineminus">-</span>
<a href="#l38.956"></a><span id="l38.956" class="difflineminus">-        // So we don't try to issue two asynchronous loads at once.</span>
<a href="#l38.957"></a><span id="l38.957" class="difflineminus">-        mLoadState = eLoadState_Pending;</span>
<a href="#l38.958"></a><span id="l38.958" class="difflineminus">-    }</span>
<a href="#l38.959"></a><span id="l38.959" class="difflineminus">-</span>
<a href="#l38.960"></a><span id="l38.960" class="difflineminus">-    return NS_OK;</span>
<a href="#l38.961"></a><span id="l38.961" class="difflineminus">-}</span>
<a href="#l38.962"></a><span id="l38.962" class="difflineminus">-</span>
<a href="#l38.963"></a><span id="l38.963" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l38.964"></a><span id="l38.964" class="difflineminus">-RDFXMLDataSourceImpl::BeginLoad(void)</span>
<a href="#l38.965"></a><span id="l38.965" class="difflineminus">-{</span>
<a href="#l38.966"></a><span id="l38.966" class="difflineminus">-    if (MOZ_LOG_TEST(gLog, LogLevel::Debug)) {</span>
<a href="#l38.967"></a><span id="l38.967" class="difflineminus">-      MOZ_LOG(gLog, LogLevel::Debug,</span>
<a href="#l38.968"></a><span id="l38.968" class="difflineminus">-              (&quot;rdfxml[%p] begin-load(%s)&quot;, this,</span>
<a href="#l38.969"></a><span id="l38.969" class="difflineminus">-               mURL ? mURL-&gt;GetSpecOrDefault().get() : &quot;&quot;));</span>
<a href="#l38.970"></a><span id="l38.970" class="difflineminus">-    }</span>
<a href="#l38.971"></a><span id="l38.971" class="difflineminus">-</span>
<a href="#l38.972"></a><span id="l38.972" class="difflineminus">-    mLoadState = eLoadState_Loading;</span>
<a href="#l38.973"></a><span id="l38.973" class="difflineminus">-    for (int32_t i = mObservers.Count() - 1; i &gt;= 0; --i) {</span>
<a href="#l38.974"></a><span id="l38.974" class="difflineminus">-        // Make sure to hold a strong reference to the observer so</span>
<a href="#l38.975"></a><span id="l38.975" class="difflineminus">-        // that it doesn't go away in this call if it removes itself</span>
<a href="#l38.976"></a><span id="l38.976" class="difflineminus">-        // as an observer</span>
<a href="#l38.977"></a><span id="l38.977" class="difflineminus">-        nsCOMPtr&lt;nsIRDFXMLSinkObserver&gt; obs = mObservers[i];</span>
<a href="#l38.978"></a><span id="l38.978" class="difflineminus">-</span>
<a href="#l38.979"></a><span id="l38.979" class="difflineminus">-        if (obs) {</span>
<a href="#l38.980"></a><span id="l38.980" class="difflineminus">-            obs-&gt;OnBeginLoad(this);</span>
<a href="#l38.981"></a><span id="l38.981" class="difflineminus">-        }</span>
<a href="#l38.982"></a><span id="l38.982" class="difflineminus">-    }</span>
<a href="#l38.983"></a><span id="l38.983" class="difflineminus">-    return NS_OK;</span>
<a href="#l38.984"></a><span id="l38.984" class="difflineminus">-}</span>
<a href="#l38.985"></a><span id="l38.985" class="difflineminus">-</span>
<a href="#l38.986"></a><span id="l38.986" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l38.987"></a><span id="l38.987" class="difflineminus">-RDFXMLDataSourceImpl::Interrupt(void)</span>
<a href="#l38.988"></a><span id="l38.988" class="difflineminus">-{</span>
<a href="#l38.989"></a><span id="l38.989" class="difflineminus">-    if (MOZ_LOG_TEST(gLog, LogLevel::Debug)) {</span>
<a href="#l38.990"></a><span id="l38.990" class="difflineminus">-      MOZ_LOG(gLog, LogLevel::Debug,</span>
<a href="#l38.991"></a><span id="l38.991" class="difflineminus">-              (&quot;rdfxml[%p] interrupt(%s)&quot;, this,</span>
<a href="#l38.992"></a><span id="l38.992" class="difflineminus">-               mURL ? mURL-&gt;GetSpecOrDefault().get() : &quot;&quot;));</span>
<a href="#l38.993"></a><span id="l38.993" class="difflineminus">-    }</span>
<a href="#l38.994"></a><span id="l38.994" class="difflineminus">-</span>
<a href="#l38.995"></a><span id="l38.995" class="difflineminus">-    for (int32_t i = mObservers.Count() - 1; i &gt;= 0; --i) {</span>
<a href="#l38.996"></a><span id="l38.996" class="difflineminus">-        // Make sure to hold a strong reference to the observer so</span>
<a href="#l38.997"></a><span id="l38.997" class="difflineminus">-        // that it doesn't go away in this call if it removes itself</span>
<a href="#l38.998"></a><span id="l38.998" class="difflineminus">-        // as an observer</span>
<a href="#l38.999"></a><span id="l38.999" class="difflineminus">-        nsCOMPtr&lt;nsIRDFXMLSinkObserver&gt; obs = mObservers[i];</span>
<a href="#l38.1000"></a><span id="l38.1000" class="difflineminus">-</span>
<a href="#l38.1001"></a><span id="l38.1001" class="difflineminus">-        if (obs) {</span>
<a href="#l38.1002"></a><span id="l38.1002" class="difflineminus">-            obs-&gt;OnInterrupt(this);</span>
<a href="#l38.1003"></a><span id="l38.1003" class="difflineminus">-        }</span>
<a href="#l38.1004"></a><span id="l38.1004" class="difflineminus">-    }</span>
<a href="#l38.1005"></a><span id="l38.1005" class="difflineminus">-    return NS_OK;</span>
<a href="#l38.1006"></a><span id="l38.1006" class="difflineminus">-}</span>
<a href="#l38.1007"></a><span id="l38.1007" class="difflineminus">-</span>
<a href="#l38.1008"></a><span id="l38.1008" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l38.1009"></a><span id="l38.1009" class="difflineminus">-RDFXMLDataSourceImpl::Resume(void)</span>
<a href="#l38.1010"></a><span id="l38.1010" class="difflineminus">-{</span>
<a href="#l38.1011"></a><span id="l38.1011" class="difflineminus">-    if (MOZ_LOG_TEST(gLog, LogLevel::Debug)) {</span>
<a href="#l38.1012"></a><span id="l38.1012" class="difflineminus">-      MOZ_LOG(gLog, LogLevel::Debug,</span>
<a href="#l38.1013"></a><span id="l38.1013" class="difflineminus">-             (&quot;rdfxml[%p] resume(%s)&quot;, this,</span>
<a href="#l38.1014"></a><span id="l38.1014" class="difflineminus">-              mURL ? mURL-&gt;GetSpecOrDefault().get() : &quot;&quot;));</span>
<a href="#l38.1015"></a><span id="l38.1015" class="difflineminus">-    }</span>
<a href="#l38.1016"></a><span id="l38.1016" class="difflineminus">-</span>
<a href="#l38.1017"></a><span id="l38.1017" class="difflineminus">-    for (int32_t i = mObservers.Count() - 1; i &gt;= 0; --i) {</span>
<a href="#l38.1018"></a><span id="l38.1018" class="difflineminus">-        // Make sure to hold a strong reference to the observer so</span>
<a href="#l38.1019"></a><span id="l38.1019" class="difflineminus">-        // that it doesn't go away in this call if it removes itself</span>
<a href="#l38.1020"></a><span id="l38.1020" class="difflineminus">-        // as an observer</span>
<a href="#l38.1021"></a><span id="l38.1021" class="difflineminus">-        nsCOMPtr&lt;nsIRDFXMLSinkObserver&gt; obs = mObservers[i];</span>
<a href="#l38.1022"></a><span id="l38.1022" class="difflineminus">-</span>
<a href="#l38.1023"></a><span id="l38.1023" class="difflineminus">-        if (obs) {</span>
<a href="#l38.1024"></a><span id="l38.1024" class="difflineminus">-            obs-&gt;OnResume(this);</span>
<a href="#l38.1025"></a><span id="l38.1025" class="difflineminus">-        }</span>
<a href="#l38.1026"></a><span id="l38.1026" class="difflineminus">-    }</span>
<a href="#l38.1027"></a><span id="l38.1027" class="difflineminus">-    return NS_OK;</span>
<a href="#l38.1028"></a><span id="l38.1028" class="difflineminus">-}</span>
<a href="#l38.1029"></a><span id="l38.1029" class="difflineminus">-</span>
<a href="#l38.1030"></a><span id="l38.1030" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l38.1031"></a><span id="l38.1031" class="difflineminus">-RDFXMLDataSourceImpl::EndLoad(void)</span>
<a href="#l38.1032"></a><span id="l38.1032" class="difflineminus">-{</span>
<a href="#l38.1033"></a><span id="l38.1033" class="difflineminus">-    if (MOZ_LOG_TEST(gLog, LogLevel::Debug)) {</span>
<a href="#l38.1034"></a><span id="l38.1034" class="difflineminus">-      MOZ_LOG(gLog, LogLevel::Debug,</span>
<a href="#l38.1035"></a><span id="l38.1035" class="difflineminus">-              (&quot;rdfxml[%p] end-load(%s)&quot;, this,</span>
<a href="#l38.1036"></a><span id="l38.1036" class="difflineminus">-               mURL ? mURL-&gt;GetSpecOrDefault().get() : &quot;&quot;));</span>
<a href="#l38.1037"></a><span id="l38.1037" class="difflineminus">-    }</span>
<a href="#l38.1038"></a><span id="l38.1038" class="difflineminus">-</span>
<a href="#l38.1039"></a><span id="l38.1039" class="difflineminus">-    mLoadState = eLoadState_Loaded;</span>
<a href="#l38.1040"></a><span id="l38.1040" class="difflineminus">-</span>
<a href="#l38.1041"></a><span id="l38.1041" class="difflineminus">-    // Clear out any unmarked assertions from the datasource.</span>
<a href="#l38.1042"></a><span id="l38.1042" class="difflineminus">-    nsCOMPtr&lt;nsIRDFPurgeableDataSource&gt; gcable = do_QueryInterface(mInner);</span>
<a href="#l38.1043"></a><span id="l38.1043" class="difflineminus">-    if (gcable) {</span>
<a href="#l38.1044"></a><span id="l38.1044" class="difflineminus">-        gcable-&gt;Sweep();</span>
<a href="#l38.1045"></a><span id="l38.1045" class="difflineminus">-    }</span>
<a href="#l38.1046"></a><span id="l38.1046" class="difflineminus">-</span>
<a href="#l38.1047"></a><span id="l38.1047" class="difflineminus">-    // Notify load observers</span>
<a href="#l38.1048"></a><span id="l38.1048" class="difflineminus">-    for (int32_t i = mObservers.Count() - 1; i &gt;= 0; --i) {</span>
<a href="#l38.1049"></a><span id="l38.1049" class="difflineminus">-        // Make sure to hold a strong reference to the observer so</span>
<a href="#l38.1050"></a><span id="l38.1050" class="difflineminus">-        // that it doesn't go away in this call if it removes itself</span>
<a href="#l38.1051"></a><span id="l38.1051" class="difflineminus">-        // as an observer</span>
<a href="#l38.1052"></a><span id="l38.1052" class="difflineminus">-        nsCOMPtr&lt;nsIRDFXMLSinkObserver&gt; obs = mObservers[i];</span>
<a href="#l38.1053"></a><span id="l38.1053" class="difflineminus">-</span>
<a href="#l38.1054"></a><span id="l38.1054" class="difflineminus">-        if (obs) {</span>
<a href="#l38.1055"></a><span id="l38.1055" class="difflineminus">-            obs-&gt;OnEndLoad(this);</span>
<a href="#l38.1056"></a><span id="l38.1056" class="difflineminus">-        }</span>
<a href="#l38.1057"></a><span id="l38.1057" class="difflineminus">-    }</span>
<a href="#l38.1058"></a><span id="l38.1058" class="difflineminus">-    return NS_OK;</span>
<a href="#l38.1059"></a><span id="l38.1059" class="difflineminus">-}</span>
<a href="#l38.1060"></a><span id="l38.1060" class="difflineminus">-</span>
<a href="#l38.1061"></a><span id="l38.1061" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l38.1062"></a><span id="l38.1062" class="difflineminus">-RDFXMLDataSourceImpl::AddNameSpace(nsAtom* aPrefix, const nsString&amp; aURI)</span>
<a href="#l38.1063"></a><span id="l38.1063" class="difflineminus">-{</span>
<a href="#l38.1064"></a><span id="l38.1064" class="difflineminus">-    mNameSpaces.Put(aURI, aPrefix);</span>
<a href="#l38.1065"></a><span id="l38.1065" class="difflineminus">-    return NS_OK;</span>
<a href="#l38.1066"></a><span id="l38.1066" class="difflineminus">-}</span>
<a href="#l38.1067"></a><span id="l38.1067" class="difflineminus">-</span>
<a href="#l38.1068"></a><span id="l38.1068" class="difflineminus">-</span>
<a href="#l38.1069"></a><span id="l38.1069" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l38.1070"></a><span id="l38.1070" class="difflineminus">-RDFXMLDataSourceImpl::AddXMLSinkObserver(nsIRDFXMLSinkObserver* aObserver)</span>
<a href="#l38.1071"></a><span id="l38.1071" class="difflineminus">-{</span>
<a href="#l38.1072"></a><span id="l38.1072" class="difflineminus">-    if (! aObserver)</span>
<a href="#l38.1073"></a><span id="l38.1073" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l38.1074"></a><span id="l38.1074" class="difflineminus">-</span>
<a href="#l38.1075"></a><span id="l38.1075" class="difflineminus">-    mObservers.AppendObject(aObserver);</span>
<a href="#l38.1076"></a><span id="l38.1076" class="difflineminus">-    return NS_OK;</span>
<a href="#l38.1077"></a><span id="l38.1077" class="difflineminus">-}</span>
<a href="#l38.1078"></a><span id="l38.1078" class="difflineminus">-</span>
<a href="#l38.1079"></a><span id="l38.1079" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l38.1080"></a><span id="l38.1080" class="difflineminus">-RDFXMLDataSourceImpl::RemoveXMLSinkObserver(nsIRDFXMLSinkObserver* aObserver)</span>
<a href="#l38.1081"></a><span id="l38.1081" class="difflineminus">-{</span>
<a href="#l38.1082"></a><span id="l38.1082" class="difflineminus">-    if (! aObserver)</span>
<a href="#l38.1083"></a><span id="l38.1083" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l38.1084"></a><span id="l38.1084" class="difflineminus">-</span>
<a href="#l38.1085"></a><span id="l38.1085" class="difflineminus">-    mObservers.RemoveObject(aObserver);</span>
<a href="#l38.1086"></a><span id="l38.1086" class="difflineminus">-</span>
<a href="#l38.1087"></a><span id="l38.1087" class="difflineminus">-    return NS_OK;</span>
<a href="#l38.1088"></a><span id="l38.1088" class="difflineminus">-}</span>
<a href="#l38.1089"></a><span id="l38.1089" class="difflineminus">-</span>
<a href="#l38.1090"></a><span id="l38.1090" class="difflineminus">-</span>
<a href="#l38.1091"></a><span id="l38.1091" class="difflineminus">-//----------------------------------------------------------------------</span>
<a href="#l38.1092"></a><span id="l38.1092" class="difflineminus">-//</span>
<a href="#l38.1093"></a><span id="l38.1093" class="difflineminus">-// nsIRequestObserver</span>
<a href="#l38.1094"></a><span id="l38.1094" class="difflineminus">-//</span>
<a href="#l38.1095"></a><span id="l38.1095" class="difflineminus">-</span>
<a href="#l38.1096"></a><span id="l38.1096" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l38.1097"></a><span id="l38.1097" class="difflineminus">-RDFXMLDataSourceImpl::OnStartRequest(nsIRequest *request)</span>
<a href="#l38.1098"></a><span id="l38.1098" class="difflineminus">-{</span>
<a href="#l38.1099"></a><span id="l38.1099" class="difflineminus">-    return mListener-&gt;OnStartRequest(request);</span>
<a href="#l38.1100"></a><span id="l38.1100" class="difflineminus">-}</span>
<a href="#l38.1101"></a><span id="l38.1101" class="difflineminus">-</span>
<a href="#l38.1102"></a><span id="l38.1102" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l38.1103"></a><span id="l38.1103" class="difflineminus">-RDFXMLDataSourceImpl::OnStopRequest(nsIRequest *request,</span>
<a href="#l38.1104"></a><span id="l38.1104" class="difflineminus">-                                    nsresult status)</span>
<a href="#l38.1105"></a><span id="l38.1105" class="difflineminus">-{</span>
<a href="#l38.1106"></a><span id="l38.1106" class="difflineminus">-    if (NS_FAILED(status)) {</span>
<a href="#l38.1107"></a><span id="l38.1107" class="difflineminus">-        for (int32_t i = mObservers.Count() - 1; i &gt;= 0; --i) {</span>
<a href="#l38.1108"></a><span id="l38.1108" class="difflineminus">-            // Make sure to hold a strong reference to the observer so</span>
<a href="#l38.1109"></a><span id="l38.1109" class="difflineminus">-            // that it doesn't go away in this call if it removes</span>
<a href="#l38.1110"></a><span id="l38.1110" class="difflineminus">-            // itself as an observer</span>
<a href="#l38.1111"></a><span id="l38.1111" class="difflineminus">-            nsCOMPtr&lt;nsIRDFXMLSinkObserver&gt; obs = mObservers[i];</span>
<a href="#l38.1112"></a><span id="l38.1112" class="difflineminus">-</span>
<a href="#l38.1113"></a><span id="l38.1113" class="difflineminus">-            if (obs) {</span>
<a href="#l38.1114"></a><span id="l38.1114" class="difflineminus">-                obs-&gt;OnError(this, status, nullptr);</span>
<a href="#l38.1115"></a><span id="l38.1115" class="difflineminus">-            }</span>
<a href="#l38.1116"></a><span id="l38.1116" class="difflineminus">-        }</span>
<a href="#l38.1117"></a><span id="l38.1117" class="difflineminus">-    }</span>
<a href="#l38.1118"></a><span id="l38.1118" class="difflineminus">-</span>
<a href="#l38.1119"></a><span id="l38.1119" class="difflineminus">-    nsresult rv;</span>
<a href="#l38.1120"></a><span id="l38.1120" class="difflineminus">-    rv = mListener-&gt;OnStopRequest(request, status);</span>
<a href="#l38.1121"></a><span id="l38.1121" class="difflineminus">-</span>
<a href="#l38.1122"></a><span id="l38.1122" class="difflineminus">-    mListener = nullptr; // release the parser</span>
<a href="#l38.1123"></a><span id="l38.1123" class="difflineminus">-</span>
<a href="#l38.1124"></a><span id="l38.1124" class="difflineminus">-    return rv;</span>
<a href="#l38.1125"></a><span id="l38.1125" class="difflineminus">-}</span>
<a href="#l38.1126"></a><span id="l38.1126" class="difflineminus">-</span>
<a href="#l38.1127"></a><span id="l38.1127" class="difflineminus">-//----------------------------------------------------------------------</span>
<a href="#l38.1128"></a><span id="l38.1128" class="difflineminus">-//</span>
<a href="#l38.1129"></a><span id="l38.1129" class="difflineminus">-// nsIStreamListener</span>
<a href="#l38.1130"></a><span id="l38.1130" class="difflineminus">-//</span>
<a href="#l38.1131"></a><span id="l38.1131" class="difflineminus">-</span>
<a href="#l38.1132"></a><span id="l38.1132" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l38.1133"></a><span id="l38.1133" class="difflineminus">-RDFXMLDataSourceImpl::OnDataAvailable(nsIRequest *request,</span>
<a href="#l38.1134"></a><span id="l38.1134" class="difflineminus">-                                      nsIInputStream *inStr,</span>
<a href="#l38.1135"></a><span id="l38.1135" class="difflineminus">-                                      uint64_t sourceOffset,</span>
<a href="#l38.1136"></a><span id="l38.1136" class="difflineminus">-                                      uint32_t count)</span>
<a href="#l38.1137"></a><span id="l38.1137" class="difflineminus">-{</span>
<a href="#l38.1138"></a><span id="l38.1138" class="difflineminus">-    return mListener-&gt;OnDataAvailable(request, inStr, sourceOffset, count);</span>
<a href="#l38.1139"></a><span id="l38.1139" class="difflineminus">-}</span>
<a href="#l38.1140"></a><span id="l38.1140" class="difflineminus">-</span>
<a href="#l38.1141"></a><span id="l38.1141" class="difflineminus">-//----------------------------------------------------------------------</span>
<a href="#l38.1142"></a><span id="l38.1142" class="difflineminus">-//</span>
<a href="#l38.1143"></a><span id="l38.1143" class="difflineminus">-// nsIRDFXMLSource</span>
<a href="#l38.1144"></a><span id="l38.1144" class="difflineminus">-//</span>
<a href="#l38.1145"></a><span id="l38.1145" class="difflineminus">-</span>
<a href="#l38.1146"></a><span id="l38.1146" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l38.1147"></a><span id="l38.1147" class="difflineminus">-RDFXMLDataSourceImpl::Serialize(nsIOutputStream* aStream)</span>
<a href="#l38.1148"></a><span id="l38.1148" class="difflineminus">-{</span>
<a href="#l38.1149"></a><span id="l38.1149" class="difflineminus">-    nsresult rv;</span>
<a href="#l38.1150"></a><span id="l38.1150" class="difflineminus">-    nsCOMPtr&lt;nsIRDFXMLSerializer&gt; serializer</span>
<a href="#l38.1151"></a><span id="l38.1151" class="difflineminus">-        = do_CreateInstance(&quot;@mozilla.org/rdf/xml-serializer;1&quot;, &amp;rv);</span>
<a href="#l38.1152"></a><span id="l38.1152" class="difflineminus">-</span>
<a href="#l38.1153"></a><span id="l38.1153" class="difflineminus">-    if (! serializer)</span>
<a href="#l38.1154"></a><span id="l38.1154" class="difflineminus">-        return rv;</span>
<a href="#l38.1155"></a><span id="l38.1155" class="difflineminus">-</span>
<a href="#l38.1156"></a><span id="l38.1156" class="difflineminus">-    rv = serializer-&gt;Init(this);</span>
<a href="#l38.1157"></a><span id="l38.1157" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l38.1158"></a><span id="l38.1158" class="difflineminus">-</span>
<a href="#l38.1159"></a><span id="l38.1159" class="difflineminus">-    // Add any namespace information that we picked up when reading</span>
<a href="#l38.1160"></a><span id="l38.1160" class="difflineminus">-    // the RDF/XML</span>
<a href="#l38.1161"></a><span id="l38.1161" class="difflineminus">-    nsNameSpaceMap::const_iterator last = mNameSpaces.last();</span>
<a href="#l38.1162"></a><span id="l38.1162" class="difflineminus">-    for (nsNameSpaceMap::const_iterator iter = mNameSpaces.first();</span>
<a href="#l38.1163"></a><span id="l38.1163" class="difflineminus">-         iter != last; ++iter) {</span>
<a href="#l38.1164"></a><span id="l38.1164" class="difflineminus">-        // We might wanna change nsIRDFXMLSerializer to nsACString and</span>
<a href="#l38.1165"></a><span id="l38.1165" class="difflineminus">-        // use a heap allocated buffer here in the future.</span>
<a href="#l38.1166"></a><span id="l38.1166" class="difflineminus">-        NS_ConvertUTF8toUTF16 uri(iter-&gt;mURI);</span>
<a href="#l38.1167"></a><span id="l38.1167" class="difflineminus">-        serializer-&gt;AddNameSpace(iter-&gt;mPrefix, uri);</span>
<a href="#l38.1168"></a><span id="l38.1168" class="difflineminus">-    }</span>
<a href="#l38.1169"></a><span id="l38.1169" class="difflineminus">-</span>
<a href="#l38.1170"></a><span id="l38.1170" class="difflineminus">-    // Serialize!</span>
<a href="#l38.1171"></a><span id="l38.1171" class="difflineminus">-    nsCOMPtr&lt;nsIRDFXMLSource&gt; source = do_QueryInterface(serializer);</span>
<a href="#l38.1172"></a><span id="l38.1172" class="difflineminus">-    if (! source)</span>
<a href="#l38.1173"></a><span id="l38.1173" class="difflineminus">-        return NS_ERROR_FAILURE;</span>
<a href="#l38.1174"></a><span id="l38.1174" class="difflineminus">-</span>
<a href="#l38.1175"></a><span id="l38.1175" class="difflineminus">-    return source-&gt;Serialize(aStream);</span>
<a href="#l38.1176"></a><span id="l38.1176" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l39.1"></a><span id="l39.1">deleted file mode 100644</span>
<a href="#l39.2"></a><span id="l39.2" class="difflineminus">--- a/rdf/base/nsRDFXMLParser.cpp</span>
<a href="#l39.3"></a><span id="l39.3" class="difflineplus">+++ /dev/null</span>
<a href="#l39.4"></a><span id="l39.4" class="difflineat">@@ -1,137 +0,0 @@</span>
<a href="#l39.5"></a><span id="l39.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*-</span>
<a href="#l39.6"></a><span id="l39.6" class="difflineminus">- *</span>
<a href="#l39.7"></a><span id="l39.7" class="difflineminus">- * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l39.8"></a><span id="l39.8" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l39.9"></a><span id="l39.9" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l39.10"></a><span id="l39.10" class="difflineminus">-</span>
<a href="#l39.11"></a><span id="l39.11" class="difflineminus">-#include &quot;nsRDFXMLParser.h&quot;</span>
<a href="#l39.12"></a><span id="l39.12" class="difflineminus">-</span>
<a href="#l39.13"></a><span id="l39.13" class="difflineminus">-#include &quot;mozilla/Encoding.h&quot;</span>
<a href="#l39.14"></a><span id="l39.14" class="difflineminus">-#include &quot;nsIComponentManager.h&quot;</span>
<a href="#l39.15"></a><span id="l39.15" class="difflineminus">-#include &quot;nsIParser.h&quot;</span>
<a href="#l39.16"></a><span id="l39.16" class="difflineminus">-#include &quot;nsCharsetSource.h&quot;</span>
<a href="#l39.17"></a><span id="l39.17" class="difflineminus">-#include &quot;nsIRDFContentSink.h&quot;</span>
<a href="#l39.18"></a><span id="l39.18" class="difflineminus">-#include &quot;nsParserCIID.h&quot;</span>
<a href="#l39.19"></a><span id="l39.19" class="difflineminus">-#include &quot;nsStringStream.h&quot;</span>
<a href="#l39.20"></a><span id="l39.20" class="difflineminus">-#include &quot;nsNetUtil.h&quot;</span>
<a href="#l39.21"></a><span id="l39.21" class="difflineminus">-#include &quot;mozilla/NullPrincipal.h&quot;</span>
<a href="#l39.22"></a><span id="l39.22" class="difflineminus">-</span>
<a href="#l39.23"></a><span id="l39.23" class="difflineminus">-static NS_DEFINE_CID(kParserCID, NS_PARSER_CID);</span>
<a href="#l39.24"></a><span id="l39.24" class="difflineminus">-</span>
<a href="#l39.25"></a><span id="l39.25" class="difflineminus">-NS_IMPL_ISUPPORTS(nsRDFXMLParser, nsIRDFXMLParser)</span>
<a href="#l39.26"></a><span id="l39.26" class="difflineminus">-</span>
<a href="#l39.27"></a><span id="l39.27" class="difflineminus">-nsresult</span>
<a href="#l39.28"></a><span id="l39.28" class="difflineminus">-nsRDFXMLParser::Create(nsISupports* aOuter, REFNSIID aIID, void** aResult)</span>
<a href="#l39.29"></a><span id="l39.29" class="difflineminus">-{</span>
<a href="#l39.30"></a><span id="l39.30" class="difflineminus">-    if (aOuter)</span>
<a href="#l39.31"></a><span id="l39.31" class="difflineminus">-        return NS_ERROR_NO_AGGREGATION;</span>
<a href="#l39.32"></a><span id="l39.32" class="difflineminus">-</span>
<a href="#l39.33"></a><span id="l39.33" class="difflineminus">-    nsRDFXMLParser* result = new nsRDFXMLParser();</span>
<a href="#l39.34"></a><span id="l39.34" class="difflineminus">-    if (! result)</span>
<a href="#l39.35"></a><span id="l39.35" class="difflineminus">-        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l39.36"></a><span id="l39.36" class="difflineminus">-</span>
<a href="#l39.37"></a><span id="l39.37" class="difflineminus">-    nsresult rv;</span>
<a href="#l39.38"></a><span id="l39.38" class="difflineminus">-    NS_ADDREF(result);</span>
<a href="#l39.39"></a><span id="l39.39" class="difflineminus">-    rv = result-&gt;QueryInterface(aIID, aResult);</span>
<a href="#l39.40"></a><span id="l39.40" class="difflineminus">-    NS_RELEASE(result);</span>
<a href="#l39.41"></a><span id="l39.41" class="difflineminus">-    return rv;</span>
<a href="#l39.42"></a><span id="l39.42" class="difflineminus">-}</span>
<a href="#l39.43"></a><span id="l39.43" class="difflineminus">-</span>
<a href="#l39.44"></a><span id="l39.44" class="difflineminus">-nsRDFXMLParser::nsRDFXMLParser()</span>
<a href="#l39.45"></a><span id="l39.45" class="difflineminus">-{</span>
<a href="#l39.46"></a><span id="l39.46" class="difflineminus">-}</span>
<a href="#l39.47"></a><span id="l39.47" class="difflineminus">-</span>
<a href="#l39.48"></a><span id="l39.48" class="difflineminus">-nsRDFXMLParser::~nsRDFXMLParser()</span>
<a href="#l39.49"></a><span id="l39.49" class="difflineminus">-{</span>
<a href="#l39.50"></a><span id="l39.50" class="difflineminus">-}</span>
<a href="#l39.51"></a><span id="l39.51" class="difflineminus">-</span>
<a href="#l39.52"></a><span id="l39.52" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l39.53"></a><span id="l39.53" class="difflineminus">-nsRDFXMLParser::ParseAsync(nsIRDFDataSource* aSink, nsIURI* aBaseURI, nsIStreamListener** aResult)</span>
<a href="#l39.54"></a><span id="l39.54" class="difflineminus">-{</span>
<a href="#l39.55"></a><span id="l39.55" class="difflineminus">-    nsresult rv;</span>
<a href="#l39.56"></a><span id="l39.56" class="difflineminus">-</span>
<a href="#l39.57"></a><span id="l39.57" class="difflineminus">-    nsCOMPtr&lt;nsIRDFContentSink&gt; sink =</span>
<a href="#l39.58"></a><span id="l39.58" class="difflineminus">-        do_CreateInstance(&quot;@mozilla.org/rdf/content-sink;1&quot;, &amp;rv);</span>
<a href="#l39.59"></a><span id="l39.59" class="difflineminus">-</span>
<a href="#l39.60"></a><span id="l39.60" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l39.61"></a><span id="l39.61" class="difflineminus">-</span>
<a href="#l39.62"></a><span id="l39.62" class="difflineminus">-    rv = sink-&gt;Init(aBaseURI);</span>
<a href="#l39.63"></a><span id="l39.63" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l39.64"></a><span id="l39.64" class="difflineminus">-</span>
<a href="#l39.65"></a><span id="l39.65" class="difflineminus">-    // We set the content sink's data source directly to our in-memory</span>
<a href="#l39.66"></a><span id="l39.66" class="difflineminus">-    // store. This allows the initial content to be generated &quot;directly&quot;.</span>
<a href="#l39.67"></a><span id="l39.67" class="difflineminus">-    rv = sink-&gt;SetDataSource(aSink);</span>
<a href="#l39.68"></a><span id="l39.68" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l39.69"></a><span id="l39.69" class="difflineminus">-</span>
<a href="#l39.70"></a><span id="l39.70" class="difflineminus">-    nsCOMPtr&lt;nsIParser&gt; parser = do_CreateInstance(kParserCID, &amp;rv);</span>
<a href="#l39.71"></a><span id="l39.71" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l39.72"></a><span id="l39.72" class="difflineminus">-</span>
<a href="#l39.73"></a><span id="l39.73" class="difflineminus">-    parser-&gt;SetDocumentCharset(UTF_8_ENCODING,</span>
<a href="#l39.74"></a><span id="l39.74" class="difflineminus">-                               kCharsetFromDocTypeDefault);</span>
<a href="#l39.75"></a><span id="l39.75" class="difflineminus">-    parser-&gt;SetContentSink(sink);</span>
<a href="#l39.76"></a><span id="l39.76" class="difflineminus">-</span>
<a href="#l39.77"></a><span id="l39.77" class="difflineminus">-    rv = parser-&gt;Parse(aBaseURI);</span>
<a href="#l39.78"></a><span id="l39.78" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l39.79"></a><span id="l39.79" class="difflineminus">-</span>
<a href="#l39.80"></a><span id="l39.80" class="difflineminus">-    return CallQueryInterface(parser, aResult);</span>
<a href="#l39.81"></a><span id="l39.81" class="difflineminus">-}</span>
<a href="#l39.82"></a><span id="l39.82" class="difflineminus">-</span>
<a href="#l39.83"></a><span id="l39.83" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l39.84"></a><span id="l39.84" class="difflineminus">-nsRDFXMLParser::ParseString(nsIRDFDataSource* aSink, nsIURI* aBaseURI, const nsACString&amp; aString)</span>
<a href="#l39.85"></a><span id="l39.85" class="difflineminus">-{</span>
<a href="#l39.86"></a><span id="l39.86" class="difflineminus">-    nsresult rv;</span>
<a href="#l39.87"></a><span id="l39.87" class="difflineminus">-</span>
<a href="#l39.88"></a><span id="l39.88" class="difflineminus">-    nsCOMPtr&lt;nsIRDFContentSink&gt; sink =</span>
<a href="#l39.89"></a><span id="l39.89" class="difflineminus">-        do_CreateInstance(&quot;@mozilla.org/rdf/content-sink;1&quot;, &amp;rv);</span>
<a href="#l39.90"></a><span id="l39.90" class="difflineminus">-</span>
<a href="#l39.91"></a><span id="l39.91" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l39.92"></a><span id="l39.92" class="difflineminus">-</span>
<a href="#l39.93"></a><span id="l39.93" class="difflineminus">-    rv = sink-&gt;Init(aBaseURI);</span>
<a href="#l39.94"></a><span id="l39.94" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l39.95"></a><span id="l39.95" class="difflineminus">-</span>
<a href="#l39.96"></a><span id="l39.96" class="difflineminus">-    // We set the content sink's data source directly to our in-memory</span>
<a href="#l39.97"></a><span id="l39.97" class="difflineminus">-    // store. This allows the initial content to be generated &quot;directly&quot;.</span>
<a href="#l39.98"></a><span id="l39.98" class="difflineminus">-    rv = sink-&gt;SetDataSource(aSink);</span>
<a href="#l39.99"></a><span id="l39.99" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l39.100"></a><span id="l39.100" class="difflineminus">-</span>
<a href="#l39.101"></a><span id="l39.101" class="difflineminus">-    nsCOMPtr&lt;nsIParser&gt; parser = do_CreateInstance(kParserCID, &amp;rv);</span>
<a href="#l39.102"></a><span id="l39.102" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l39.103"></a><span id="l39.103" class="difflineminus">-</span>
<a href="#l39.104"></a><span id="l39.104" class="difflineminus">-    parser-&gt;SetDocumentCharset(UTF_8_ENCODING,</span>
<a href="#l39.105"></a><span id="l39.105" class="difflineminus">-                               kCharsetFromOtherComponent);</span>
<a href="#l39.106"></a><span id="l39.106" class="difflineminus">-    parser-&gt;SetContentSink(sink);</span>
<a href="#l39.107"></a><span id="l39.107" class="difflineminus">-</span>
<a href="#l39.108"></a><span id="l39.108" class="difflineminus">-    rv = parser-&gt;Parse(aBaseURI);</span>
<a href="#l39.109"></a><span id="l39.109" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l39.110"></a><span id="l39.110" class="difflineminus">-</span>
<a href="#l39.111"></a><span id="l39.111" class="difflineminus">-    nsCOMPtr&lt;nsIStreamListener&gt; listener =</span>
<a href="#l39.112"></a><span id="l39.112" class="difflineminus">-        do_QueryInterface(parser);</span>
<a href="#l39.113"></a><span id="l39.113" class="difflineminus">-</span>
<a href="#l39.114"></a><span id="l39.114" class="difflineminus">-    if (! listener)</span>
<a href="#l39.115"></a><span id="l39.115" class="difflineminus">-        return NS_ERROR_FAILURE;</span>
<a href="#l39.116"></a><span id="l39.116" class="difflineminus">-</span>
<a href="#l39.117"></a><span id="l39.117" class="difflineminus">-    nsCOMPtr&lt;nsIInputStream&gt; stream;</span>
<a href="#l39.118"></a><span id="l39.118" class="difflineminus">-    rv = NS_NewCStringInputStream(getter_AddRefs(stream), aString);</span>
<a href="#l39.119"></a><span id="l39.119" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l39.120"></a><span id="l39.120" class="difflineminus">-</span>
<a href="#l39.121"></a><span id="l39.121" class="difflineminus">-    nsCOMPtr&lt;nsIPrincipal&gt; nullPrincipal = NullPrincipal::CreateWithoutOriginAttributes();</span>
<a href="#l39.122"></a><span id="l39.122" class="difflineminus">-</span>
<a href="#l39.123"></a><span id="l39.123" class="difflineminus">-    // The following channel is never openend, so it does not matter what</span>
<a href="#l39.124"></a><span id="l39.124" class="difflineminus">-    // securityFlags we pass; let's follow the principle of least privilege.</span>
<a href="#l39.125"></a><span id="l39.125" class="difflineminus">-    nsCOMPtr&lt;nsIChannel&gt; channel;</span>
<a href="#l39.126"></a><span id="l39.126" class="difflineminus">-    nsCOMPtr&lt;nsIInputStream&gt; tmpStream = stream;</span>
<a href="#l39.127"></a><span id="l39.127" class="difflineminus">-    rv = NS_NewInputStreamChannel(getter_AddRefs(channel),</span>
<a href="#l39.128"></a><span id="l39.128" class="difflineminus">-                                  aBaseURI,</span>
<a href="#l39.129"></a><span id="l39.129" class="difflineminus">-                                  tmpStream.forget(),</span>
<a href="#l39.130"></a><span id="l39.130" class="difflineminus">-                                  nullPrincipal,</span>
<a href="#l39.131"></a><span id="l39.131" class="difflineminus">-                                  nsILoadInfo::SEC_REQUIRE_SAME_ORIGIN_DATA_IS_BLOCKED,</span>
<a href="#l39.132"></a><span id="l39.132" class="difflineminus">-                                  nsIContentPolicy::TYPE_OTHER,</span>
<a href="#l39.133"></a><span id="l39.133" class="difflineminus">-                                  NS_LITERAL_CSTRING(&quot;text/xml&quot;));</span>
<a href="#l39.134"></a><span id="l39.134" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l39.135"></a><span id="l39.135" class="difflineminus">-</span>
<a href="#l39.136"></a><span id="l39.136" class="difflineminus">-    listener-&gt;OnStartRequest(channel);</span>
<a href="#l39.137"></a><span id="l39.137" class="difflineminus">-    listener-&gt;OnDataAvailable(channel, stream, 0, aString.Length());</span>
<a href="#l39.138"></a><span id="l39.138" class="difflineminus">-    listener-&gt;OnStopRequest(channel, NS_OK);</span>
<a href="#l39.139"></a><span id="l39.139" class="difflineminus">-</span>
<a href="#l39.140"></a><span id="l39.140" class="difflineminus">-    return NS_OK;</span>
<a href="#l39.141"></a><span id="l39.141" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l40.1"></a><span id="l40.1">deleted file mode 100644</span>
<a href="#l40.2"></a><span id="l40.2" class="difflineminus">--- a/rdf/base/nsRDFXMLParser.h</span>
<a href="#l40.3"></a><span id="l40.3" class="difflineplus">+++ /dev/null</span>
<a href="#l40.4"></a><span id="l40.4" class="difflineat">@@ -1,31 +0,0 @@</span>
<a href="#l40.5"></a><span id="l40.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*-</span>
<a href="#l40.6"></a><span id="l40.6" class="difflineminus">- *</span>
<a href="#l40.7"></a><span id="l40.7" class="difflineminus">- * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l40.8"></a><span id="l40.8" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l40.9"></a><span id="l40.9" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l40.10"></a><span id="l40.10" class="difflineminus">-</span>
<a href="#l40.11"></a><span id="l40.11" class="difflineminus">-#ifndef nsRDFParser_h__</span>
<a href="#l40.12"></a><span id="l40.12" class="difflineminus">-#define nsRDFParser_h__</span>
<a href="#l40.13"></a><span id="l40.13" class="difflineminus">-</span>
<a href="#l40.14"></a><span id="l40.14" class="difflineminus">-#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l40.15"></a><span id="l40.15" class="difflineminus">-#include &quot;nsString.h&quot;</span>
<a href="#l40.16"></a><span id="l40.16" class="difflineminus">-#include &quot;nsIRDFXMLParser.h&quot;</span>
<a href="#l40.17"></a><span id="l40.17" class="difflineminus">-#include &quot;nsIRDFDataSource.h&quot;</span>
<a href="#l40.18"></a><span id="l40.18" class="difflineminus">-</span>
<a href="#l40.19"></a><span id="l40.19" class="difflineminus">-/**</span>
<a href="#l40.20"></a><span id="l40.20" class="difflineminus">- * A helper class that is used to parse RDF/XML.</span>
<a href="#l40.21"></a><span id="l40.21" class="difflineminus">- */</span>
<a href="#l40.22"></a><span id="l40.22" class="difflineminus">-class nsRDFXMLParser : public nsIRDFXMLParser {</span>
<a href="#l40.23"></a><span id="l40.23" class="difflineminus">-public:</span>
<a href="#l40.24"></a><span id="l40.24" class="difflineminus">-    static nsresult</span>
<a href="#l40.25"></a><span id="l40.25" class="difflineminus">-    Create(nsISupports* aOuter, REFNSIID aIID, void** aResult);</span>
<a href="#l40.26"></a><span id="l40.26" class="difflineminus">-</span>
<a href="#l40.27"></a><span id="l40.27" class="difflineminus">-    NS_DECL_ISUPPORTS</span>
<a href="#l40.28"></a><span id="l40.28" class="difflineminus">-    NS_DECL_NSIRDFXMLPARSER</span>
<a href="#l40.29"></a><span id="l40.29" class="difflineminus">-</span>
<a href="#l40.30"></a><span id="l40.30" class="difflineminus">-protected:</span>
<a href="#l40.31"></a><span id="l40.31" class="difflineminus">-    nsRDFXMLParser();</span>
<a href="#l40.32"></a><span id="l40.32" class="difflineminus">-    virtual ~nsRDFXMLParser();</span>
<a href="#l40.33"></a><span id="l40.33" class="difflineminus">-};</span>
<a href="#l40.34"></a><span id="l40.34" class="difflineminus">-</span>
<a href="#l40.35"></a><span id="l40.35" class="difflineminus">-#endif // nsRDFParser_h__</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l41.1"></a><span id="l41.1">deleted file mode 100644</span>
<a href="#l41.2"></a><span id="l41.2" class="difflineminus">--- a/rdf/base/nsRDFXMLSerializer.cpp</span>
<a href="#l41.3"></a><span id="l41.3" class="difflineplus">+++ /dev/null</span>
<a href="#l41.4"></a><span id="l41.4" class="difflineat">@@ -1,1123 +0,0 @@</span>
<a href="#l41.5"></a><span id="l41.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*-</span>
<a href="#l41.6"></a><span id="l41.6" class="difflineminus">- * vim: set ts=4 sw=4 et tw=80:</span>
<a href="#l41.7"></a><span id="l41.7" class="difflineminus">- *</span>
<a href="#l41.8"></a><span id="l41.8" class="difflineminus">- * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l41.9"></a><span id="l41.9" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l41.10"></a><span id="l41.10" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l41.11"></a><span id="l41.11" class="difflineminus">-</span>
<a href="#l41.12"></a><span id="l41.12" class="difflineminus">-#include &quot;nsRDFXMLSerializer.h&quot;</span>
<a href="#l41.13"></a><span id="l41.13" class="difflineminus">-</span>
<a href="#l41.14"></a><span id="l41.14" class="difflineminus">-#include &quot;nsAtom.h&quot;</span>
<a href="#l41.15"></a><span id="l41.15" class="difflineminus">-#include &quot;nsIOutputStream.h&quot;</span>
<a href="#l41.16"></a><span id="l41.16" class="difflineminus">-#include &quot;nsIRDFService.h&quot;</span>
<a href="#l41.17"></a><span id="l41.17" class="difflineminus">-#include &quot;nsIRDFContainerUtils.h&quot;</span>
<a href="#l41.18"></a><span id="l41.18" class="difflineminus">-#include &quot;nsIServiceManager.h&quot;</span>
<a href="#l41.19"></a><span id="l41.19" class="difflineminus">-#include &quot;nsString.h&quot;</span>
<a href="#l41.20"></a><span id="l41.20" class="difflineminus">-#include &quot;nsTArray.h&quot;</span>
<a href="#l41.21"></a><span id="l41.21" class="difflineminus">-#include &quot;rdf.h&quot;</span>
<a href="#l41.22"></a><span id="l41.22" class="difflineminus">-#include &quot;rdfutil.h&quot;</span>
<a href="#l41.23"></a><span id="l41.23" class="difflineminus">-#include &quot;mozilla/Attributes.h&quot;</span>
<a href="#l41.24"></a><span id="l41.24" class="difflineminus">-</span>
<a href="#l41.25"></a><span id="l41.25" class="difflineminus">-#include &quot;rdfIDataSource.h&quot;</span>
<a href="#l41.26"></a><span id="l41.26" class="difflineminus">-</span>
<a href="#l41.27"></a><span id="l41.27" class="difflineminus">-int32_t nsRDFXMLSerializer::gRefCnt = 0;</span>
<a href="#l41.28"></a><span id="l41.28" class="difflineminus">-nsIRDFContainerUtils* nsRDFXMLSerializer::gRDFC;</span>
<a href="#l41.29"></a><span id="l41.29" class="difflineminus">-nsIRDFResource* nsRDFXMLSerializer::kRDF_instanceOf;</span>
<a href="#l41.30"></a><span id="l41.30" class="difflineminus">-nsIRDFResource* nsRDFXMLSerializer::kRDF_type;</span>
<a href="#l41.31"></a><span id="l41.31" class="difflineminus">-nsIRDFResource* nsRDFXMLSerializer::kRDF_nextVal;</span>
<a href="#l41.32"></a><span id="l41.32" class="difflineminus">-nsIRDFResource* nsRDFXMLSerializer::kRDF_Bag;</span>
<a href="#l41.33"></a><span id="l41.33" class="difflineminus">-nsIRDFResource* nsRDFXMLSerializer::kRDF_Seq;</span>
<a href="#l41.34"></a><span id="l41.34" class="difflineminus">-nsIRDFResource* nsRDFXMLSerializer::kRDF_Alt;</span>
<a href="#l41.35"></a><span id="l41.35" class="difflineminus">-</span>
<a href="#l41.36"></a><span id="l41.36" class="difflineminus">-static const char kRDFDescriptionOpen[]      = &quot;  &lt;RDF:Description&quot;;</span>
<a href="#l41.37"></a><span id="l41.37" class="difflineminus">-static const char kIDAttr[]                  = &quot; RDF:ID=\&quot;&quot;;</span>
<a href="#l41.38"></a><span id="l41.38" class="difflineminus">-static const char kAboutAttr[]               = &quot; RDF:about=\&quot;&quot;;</span>
<a href="#l41.39"></a><span id="l41.39" class="difflineminus">-static const char kRDFDescriptionClose[]     = &quot;  &lt;/RDF:Description&gt;\n&quot;;</span>
<a href="#l41.40"></a><span id="l41.40" class="difflineminus">-static const char kRDFResource1[] = &quot; RDF:resource=\&quot;&quot;;</span>
<a href="#l41.41"></a><span id="l41.41" class="difflineminus">-static const char kRDFResource2[] = &quot;\&quot;/&gt;\n&quot;;</span>
<a href="#l41.42"></a><span id="l41.42" class="difflineminus">-static const char kRDFParseTypeInteger[] = &quot; NC:parseType=\&quot;Integer\&quot;&gt;&quot;;</span>
<a href="#l41.43"></a><span id="l41.43" class="difflineminus">-static const char kRDFParseTypeDate[] = &quot; NC:parseType=\&quot;Date\&quot;&gt;&quot;;</span>
<a href="#l41.44"></a><span id="l41.44" class="difflineminus">-static const char kRDFUnknown[] = &quot;&gt;&lt;!-- unknown node type --&gt;&quot;;</span>
<a href="#l41.45"></a><span id="l41.45" class="difflineminus">-</span>
<a href="#l41.46"></a><span id="l41.46" class="difflineminus">-nsresult</span>
<a href="#l41.47"></a><span id="l41.47" class="difflineminus">-nsRDFXMLSerializer::Create(nsISupports* aOuter, REFNSIID aIID, void** aResult)</span>
<a href="#l41.48"></a><span id="l41.48" class="difflineminus">-{</span>
<a href="#l41.49"></a><span id="l41.49" class="difflineminus">-    if (aOuter)</span>
<a href="#l41.50"></a><span id="l41.50" class="difflineminus">-        return NS_ERROR_NO_AGGREGATION;</span>
<a href="#l41.51"></a><span id="l41.51" class="difflineminus">-</span>
<a href="#l41.52"></a><span id="l41.52" class="difflineminus">-    nsCOMPtr&lt;nsIRDFXMLSerializer&gt; result = new nsRDFXMLSerializer();</span>
<a href="#l41.53"></a><span id="l41.53" class="difflineminus">-    if (! result)</span>
<a href="#l41.54"></a><span id="l41.54" class="difflineminus">-        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l41.55"></a><span id="l41.55" class="difflineminus">-    // The serializer object is here, addref gRefCnt so that the</span>
<a href="#l41.56"></a><span id="l41.56" class="difflineminus">-    // destructor can safely release it.</span>
<a href="#l41.57"></a><span id="l41.57" class="difflineminus">-    gRefCnt++;</span>
<a href="#l41.58"></a><span id="l41.58" class="difflineminus">-</span>
<a href="#l41.59"></a><span id="l41.59" class="difflineminus">-    nsresult rv;</span>
<a href="#l41.60"></a><span id="l41.60" class="difflineminus">-    rv = result-&gt;QueryInterface(aIID, aResult);</span>
<a href="#l41.61"></a><span id="l41.61" class="difflineminus">-</span>
<a href="#l41.62"></a><span id="l41.62" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l41.63"></a><span id="l41.63" class="difflineminus">-</span>
<a href="#l41.64"></a><span id="l41.64" class="difflineminus">-    if (gRefCnt == 1) do {</span>
<a href="#l41.65"></a><span id="l41.65" class="difflineminus">-        nsCOMPtr&lt;nsIRDFService&gt; rdf = do_GetService(&quot;@mozilla.org/rdf/rdf-service;1&quot;, &amp;rv);</span>
<a href="#l41.66"></a><span id="l41.66" class="difflineminus">-        if (NS_FAILED(rv)) break;</span>
<a href="#l41.67"></a><span id="l41.67" class="difflineminus">-</span>
<a href="#l41.68"></a><span id="l41.68" class="difflineminus">-        rv = rdf-&gt;GetResource(NS_LITERAL_CSTRING(RDF_NAMESPACE_URI &quot;instanceOf&quot;),</span>
<a href="#l41.69"></a><span id="l41.69" class="difflineminus">-                              &amp;kRDF_instanceOf);</span>
<a href="#l41.70"></a><span id="l41.70" class="difflineminus">-        if (NS_FAILED(rv)) break;</span>
<a href="#l41.71"></a><span id="l41.71" class="difflineminus">-</span>
<a href="#l41.72"></a><span id="l41.72" class="difflineminus">-        rv = rdf-&gt;GetResource(NS_LITERAL_CSTRING(RDF_NAMESPACE_URI &quot;type&quot;),</span>
<a href="#l41.73"></a><span id="l41.73" class="difflineminus">-                              &amp;kRDF_type);</span>
<a href="#l41.74"></a><span id="l41.74" class="difflineminus">-        if (NS_FAILED(rv)) break;</span>
<a href="#l41.75"></a><span id="l41.75" class="difflineminus">-</span>
<a href="#l41.76"></a><span id="l41.76" class="difflineminus">-        rv = rdf-&gt;GetResource(NS_LITERAL_CSTRING(RDF_NAMESPACE_URI &quot;nextVal&quot;),</span>
<a href="#l41.77"></a><span id="l41.77" class="difflineminus">-                              &amp;kRDF_nextVal);</span>
<a href="#l41.78"></a><span id="l41.78" class="difflineminus">-        if (NS_FAILED(rv)) break;</span>
<a href="#l41.79"></a><span id="l41.79" class="difflineminus">-</span>
<a href="#l41.80"></a><span id="l41.80" class="difflineminus">-        rv = rdf-&gt;GetResource(NS_LITERAL_CSTRING(RDF_NAMESPACE_URI &quot;Bag&quot;),</span>
<a href="#l41.81"></a><span id="l41.81" class="difflineminus">-                              &amp;kRDF_Bag);</span>
<a href="#l41.82"></a><span id="l41.82" class="difflineminus">-        if (NS_FAILED(rv)) break;</span>
<a href="#l41.83"></a><span id="l41.83" class="difflineminus">-</span>
<a href="#l41.84"></a><span id="l41.84" class="difflineminus">-        rv = rdf-&gt;GetResource(NS_LITERAL_CSTRING(RDF_NAMESPACE_URI &quot;Seq&quot;),</span>
<a href="#l41.85"></a><span id="l41.85" class="difflineminus">-                              &amp;kRDF_Seq);</span>
<a href="#l41.86"></a><span id="l41.86" class="difflineminus">-        if (NS_FAILED(rv)) break;</span>
<a href="#l41.87"></a><span id="l41.87" class="difflineminus">-</span>
<a href="#l41.88"></a><span id="l41.88" class="difflineminus">-        rv = rdf-&gt;GetResource(NS_LITERAL_CSTRING(RDF_NAMESPACE_URI &quot;Alt&quot;),</span>
<a href="#l41.89"></a><span id="l41.89" class="difflineminus">-                              &amp;kRDF_Alt);</span>
<a href="#l41.90"></a><span id="l41.90" class="difflineminus">-        if (NS_FAILED(rv)) break;</span>
<a href="#l41.91"></a><span id="l41.91" class="difflineminus">-</span>
<a href="#l41.92"></a><span id="l41.92" class="difflineminus">-        rv = CallGetService(&quot;@mozilla.org/rdf/container-utils;1&quot;, &amp;gRDFC);</span>
<a href="#l41.93"></a><span id="l41.93" class="difflineminus">-        if (NS_FAILED(rv)) break;</span>
<a href="#l41.94"></a><span id="l41.94" class="difflineminus">-    } while (0);</span>
<a href="#l41.95"></a><span id="l41.95" class="difflineminus">-</span>
<a href="#l41.96"></a><span id="l41.96" class="difflineminus">-    return rv;</span>
<a href="#l41.97"></a><span id="l41.97" class="difflineminus">-}</span>
<a href="#l41.98"></a><span id="l41.98" class="difflineminus">-</span>
<a href="#l41.99"></a><span id="l41.99" class="difflineminus">-nsRDFXMLSerializer::nsRDFXMLSerializer()</span>
<a href="#l41.100"></a><span id="l41.100" class="difflineminus">-{</span>
<a href="#l41.101"></a><span id="l41.101" class="difflineminus">-}</span>
<a href="#l41.102"></a><span id="l41.102" class="difflineminus">-</span>
<a href="#l41.103"></a><span id="l41.103" class="difflineminus">-nsRDFXMLSerializer::~nsRDFXMLSerializer()</span>
<a href="#l41.104"></a><span id="l41.104" class="difflineminus">-{</span>
<a href="#l41.105"></a><span id="l41.105" class="difflineminus">-    if (--gRefCnt == 0) {</span>
<a href="#l41.106"></a><span id="l41.106" class="difflineminus">-        NS_IF_RELEASE(kRDF_Bag);</span>
<a href="#l41.107"></a><span id="l41.107" class="difflineminus">-        NS_IF_RELEASE(kRDF_Seq);</span>
<a href="#l41.108"></a><span id="l41.108" class="difflineminus">-        NS_IF_RELEASE(kRDF_Alt);</span>
<a href="#l41.109"></a><span id="l41.109" class="difflineminus">-        NS_IF_RELEASE(kRDF_instanceOf);</span>
<a href="#l41.110"></a><span id="l41.110" class="difflineminus">-        NS_IF_RELEASE(kRDF_type);</span>
<a href="#l41.111"></a><span id="l41.111" class="difflineminus">-        NS_IF_RELEASE(kRDF_nextVal);</span>
<a href="#l41.112"></a><span id="l41.112" class="difflineminus">-        NS_IF_RELEASE(gRDFC);</span>
<a href="#l41.113"></a><span id="l41.113" class="difflineminus">-    }</span>
<a href="#l41.114"></a><span id="l41.114" class="difflineminus">-}</span>
<a href="#l41.115"></a><span id="l41.115" class="difflineminus">-</span>
<a href="#l41.116"></a><span id="l41.116" class="difflineminus">-NS_IMPL_ISUPPORTS(nsRDFXMLSerializer, nsIRDFXMLSerializer, nsIRDFXMLSource)</span>
<a href="#l41.117"></a><span id="l41.117" class="difflineminus">-</span>
<a href="#l41.118"></a><span id="l41.118" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l41.119"></a><span id="l41.119" class="difflineminus">-nsRDFXMLSerializer::Init(nsIRDFDataSource* aDataSource)</span>
<a href="#l41.120"></a><span id="l41.120" class="difflineminus">-{</span>
<a href="#l41.121"></a><span id="l41.121" class="difflineminus">-    if (! aDataSource)</span>
<a href="#l41.122"></a><span id="l41.122" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l41.123"></a><span id="l41.123" class="difflineminus">-</span>
<a href="#l41.124"></a><span id="l41.124" class="difflineminus">-    mDataSource = aDataSource;</span>
<a href="#l41.125"></a><span id="l41.125" class="difflineminus">-    mDataSource-&gt;GetURI(mBaseURLSpec);</span>
<a href="#l41.126"></a><span id="l41.126" class="difflineminus">-</span>
<a href="#l41.127"></a><span id="l41.127" class="difflineminus">-    // Add the ``RDF'' prefix, by default.</span>
<a href="#l41.128"></a><span id="l41.128" class="difflineminus">-    RefPtr&lt;nsAtom&gt; prefix;</span>
<a href="#l41.129"></a><span id="l41.129" class="difflineminus">-</span>
<a href="#l41.130"></a><span id="l41.130" class="difflineminus">-    prefix = NS_Atomize(&quot;RDF&quot;);</span>
<a href="#l41.131"></a><span id="l41.131" class="difflineminus">-    AddNameSpace(prefix, NS_LITERAL_STRING(&quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#&quot;));</span>
<a href="#l41.132"></a><span id="l41.132" class="difflineminus">-</span>
<a href="#l41.133"></a><span id="l41.133" class="difflineminus">-    prefix = NS_Atomize(&quot;NC&quot;);</span>
<a href="#l41.134"></a><span id="l41.134" class="difflineminus">-    AddNameSpace(prefix, NS_LITERAL_STRING(&quot;http://home.netscape.com/NC-rdf#&quot;));</span>
<a href="#l41.135"></a><span id="l41.135" class="difflineminus">-</span>
<a href="#l41.136"></a><span id="l41.136" class="difflineminus">-    mPrefixID = 0;</span>
<a href="#l41.137"></a><span id="l41.137" class="difflineminus">-</span>
<a href="#l41.138"></a><span id="l41.138" class="difflineminus">-    return NS_OK;</span>
<a href="#l41.139"></a><span id="l41.139" class="difflineminus">-}</span>
<a href="#l41.140"></a><span id="l41.140" class="difflineminus">-</span>
<a href="#l41.141"></a><span id="l41.141" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l41.142"></a><span id="l41.142" class="difflineminus">-nsRDFXMLSerializer::AddNameSpace(nsAtom* aPrefix, const nsAString&amp; aURI)</span>
<a href="#l41.143"></a><span id="l41.143" class="difflineminus">-{</span>
<a href="#l41.144"></a><span id="l41.144" class="difflineminus">-    RefPtr&lt;nsAtom&gt; prefix = aPrefix;</span>
<a href="#l41.145"></a><span id="l41.145" class="difflineminus">-    if (!prefix) {</span>
<a href="#l41.146"></a><span id="l41.146" class="difflineminus">-        // Make up a prefix, we don't want default namespaces, so</span>
<a href="#l41.147"></a><span id="l41.147" class="difflineminus">-        // that we can use QNames for elements and attributes alike.</span>
<a href="#l41.148"></a><span id="l41.148" class="difflineminus">-        prefix = EnsureNewPrefix();</span>
<a href="#l41.149"></a><span id="l41.149" class="difflineminus">-    }</span>
<a href="#l41.150"></a><span id="l41.150" class="difflineminus">-    mNameSpaces.Put(aURI, prefix);</span>
<a href="#l41.151"></a><span id="l41.151" class="difflineminus">-    return NS_OK;</span>
<a href="#l41.152"></a><span id="l41.152" class="difflineminus">-}</span>
<a href="#l41.153"></a><span id="l41.153" class="difflineminus">-</span>
<a href="#l41.154"></a><span id="l41.154" class="difflineminus">-static nsresult</span>
<a href="#l41.155"></a><span id="l41.155" class="difflineminus">-rdf_BlockingWrite(nsIOutputStream* stream, const char* buf, uint32_t size)</span>
<a href="#l41.156"></a><span id="l41.156" class="difflineminus">-{</span>
<a href="#l41.157"></a><span id="l41.157" class="difflineminus">-    uint32_t written = 0;</span>
<a href="#l41.158"></a><span id="l41.158" class="difflineminus">-    uint32_t remaining = size;</span>
<a href="#l41.159"></a><span id="l41.159" class="difflineminus">-    while (remaining &gt; 0) {</span>
<a href="#l41.160"></a><span id="l41.160" class="difflineminus">-        nsresult rv;</span>
<a href="#l41.161"></a><span id="l41.161" class="difflineminus">-        uint32_t cb;</span>
<a href="#l41.162"></a><span id="l41.162" class="difflineminus">-</span>
<a href="#l41.163"></a><span id="l41.163" class="difflineminus">-        if (NS_FAILED(rv = stream-&gt;Write(buf + written, remaining, &amp;cb)))</span>
<a href="#l41.164"></a><span id="l41.164" class="difflineminus">-            return rv;</span>
<a href="#l41.165"></a><span id="l41.165" class="difflineminus">-</span>
<a href="#l41.166"></a><span id="l41.166" class="difflineminus">-        written += cb;</span>
<a href="#l41.167"></a><span id="l41.167" class="difflineminus">-        remaining -= cb;</span>
<a href="#l41.168"></a><span id="l41.168" class="difflineminus">-    }</span>
<a href="#l41.169"></a><span id="l41.169" class="difflineminus">-    return NS_OK;</span>
<a href="#l41.170"></a><span id="l41.170" class="difflineminus">-}</span>
<a href="#l41.171"></a><span id="l41.171" class="difflineminus">-</span>
<a href="#l41.172"></a><span id="l41.172" class="difflineminus">-static nsresult</span>
<a href="#l41.173"></a><span id="l41.173" class="difflineminus">-rdf_BlockingWrite(nsIOutputStream* stream, const nsACString&amp; s)</span>
<a href="#l41.174"></a><span id="l41.174" class="difflineminus">-{</span>
<a href="#l41.175"></a><span id="l41.175" class="difflineminus">-    return rdf_BlockingWrite(stream, s.BeginReading(), s.Length());</span>
<a href="#l41.176"></a><span id="l41.176" class="difflineminus">-}</span>
<a href="#l41.177"></a><span id="l41.177" class="difflineminus">-</span>
<a href="#l41.178"></a><span id="l41.178" class="difflineminus">-static nsresult</span>
<a href="#l41.179"></a><span id="l41.179" class="difflineminus">-rdf_BlockingWrite(nsIOutputStream* stream, const nsAString&amp; s)</span>
<a href="#l41.180"></a><span id="l41.180" class="difflineminus">-{</span>
<a href="#l41.181"></a><span id="l41.181" class="difflineminus">-    NS_ConvertUTF16toUTF8 utf8(s);</span>
<a href="#l41.182"></a><span id="l41.182" class="difflineminus">-    return rdf_BlockingWrite(stream, utf8.get(), utf8.Length());</span>
<a href="#l41.183"></a><span id="l41.183" class="difflineminus">-}</span>
<a href="#l41.184"></a><span id="l41.184" class="difflineminus">-</span>
<a href="#l41.185"></a><span id="l41.185" class="difflineminus">-already_AddRefed&lt;nsAtom&gt;</span>
<a href="#l41.186"></a><span id="l41.186" class="difflineminus">-nsRDFXMLSerializer::EnsureNewPrefix()</span>
<a href="#l41.187"></a><span id="l41.187" class="difflineminus">-{</span>
<a href="#l41.188"></a><span id="l41.188" class="difflineminus">-    nsAutoString qname;</span>
<a href="#l41.189"></a><span id="l41.189" class="difflineminus">-    RefPtr&lt;nsAtom&gt; prefix;</span>
<a href="#l41.190"></a><span id="l41.190" class="difflineminus">-    bool isNewPrefix;</span>
<a href="#l41.191"></a><span id="l41.191" class="difflineminus">-    do {</span>
<a href="#l41.192"></a><span id="l41.192" class="difflineminus">-        isNewPrefix = true;</span>
<a href="#l41.193"></a><span id="l41.193" class="difflineminus">-        qname.AssignLiteral(&quot;NS&quot;);</span>
<a href="#l41.194"></a><span id="l41.194" class="difflineminus">-        qname.AppendInt(++mPrefixID, 10);</span>
<a href="#l41.195"></a><span id="l41.195" class="difflineminus">-        prefix = NS_Atomize(qname);</span>
<a href="#l41.196"></a><span id="l41.196" class="difflineminus">-        nsNameSpaceMap::const_iterator iter = mNameSpaces.first();</span>
<a href="#l41.197"></a><span id="l41.197" class="difflineminus">-        while (iter != mNameSpaces.last() &amp;&amp; isNewPrefix) {</span>
<a href="#l41.198"></a><span id="l41.198" class="difflineminus">-            isNewPrefix = (iter-&gt;mPrefix != prefix);</span>
<a href="#l41.199"></a><span id="l41.199" class="difflineminus">-            ++iter;</span>
<a href="#l41.200"></a><span id="l41.200" class="difflineminus">-        }</span>
<a href="#l41.201"></a><span id="l41.201" class="difflineminus">-    } while (!isNewPrefix);</span>
<a href="#l41.202"></a><span id="l41.202" class="difflineminus">-    return prefix.forget();</span>
<a href="#l41.203"></a><span id="l41.203" class="difflineminus">-}</span>
<a href="#l41.204"></a><span id="l41.204" class="difflineminus">-</span>
<a href="#l41.205"></a><span id="l41.205" class="difflineminus">-// This converts a property resource (like</span>
<a href="#l41.206"></a><span id="l41.206" class="difflineminus">-// &quot;http://www.w3.org/TR/WD-rdf-syntax#Description&quot;) into a QName</span>
<a href="#l41.207"></a><span id="l41.207" class="difflineminus">-// (&quot;RDF:Description&quot;), and registers the namespace, if it's made up.</span>
<a href="#l41.208"></a><span id="l41.208" class="difflineminus">-</span>
<a href="#l41.209"></a><span id="l41.209" class="difflineminus">-nsresult</span>
<a href="#l41.210"></a><span id="l41.210" class="difflineminus">-nsRDFXMLSerializer::RegisterQName(nsIRDFResource* aResource)</span>
<a href="#l41.211"></a><span id="l41.211" class="difflineminus">-{</span>
<a href="#l41.212"></a><span id="l41.212" class="difflineminus">-    nsAutoCString uri, qname;</span>
<a href="#l41.213"></a><span id="l41.213" class="difflineminus">-    aResource-&gt;GetValueUTF8(uri);</span>
<a href="#l41.214"></a><span id="l41.214" class="difflineminus">-</span>
<a href="#l41.215"></a><span id="l41.215" class="difflineminus">-    nsNameSpaceMap::const_iterator iter = mNameSpaces.GetNameSpaceOf(uri);</span>
<a href="#l41.216"></a><span id="l41.216" class="difflineminus">-    if (iter != mNameSpaces.last()) {</span>
<a href="#l41.217"></a><span id="l41.217" class="difflineminus">-        NS_ENSURE_TRUE(iter-&gt;mPrefix, NS_ERROR_UNEXPECTED);</span>
<a href="#l41.218"></a><span id="l41.218" class="difflineminus">-        iter-&gt;mPrefix-&gt;ToUTF8String(qname);</span>
<a href="#l41.219"></a><span id="l41.219" class="difflineminus">-        qname.Append(':');</span>
<a href="#l41.220"></a><span id="l41.220" class="difflineminus">-        qname += StringTail(uri, uri.Length() - iter-&gt;mURI.Length());</span>
<a href="#l41.221"></a><span id="l41.221" class="difflineminus">-        mQNames.Put(aResource, qname);</span>
<a href="#l41.222"></a><span id="l41.222" class="difflineminus">-        return NS_OK;</span>
<a href="#l41.223"></a><span id="l41.223" class="difflineminus">-    }</span>
<a href="#l41.224"></a><span id="l41.224" class="difflineminus">-</span>
<a href="#l41.225"></a><span id="l41.225" class="difflineminus">-    // Okay, so we don't have it in our map. Try to make one up. This</span>
<a href="#l41.226"></a><span id="l41.226" class="difflineminus">-    // is very bogus.</span>
<a href="#l41.227"></a><span id="l41.227" class="difflineminus">-    int32_t i = uri.RFindChar('#'); // first try a '#'</span>
<a href="#l41.228"></a><span id="l41.228" class="difflineminus">-    if (i == -1) {</span>
<a href="#l41.229"></a><span id="l41.229" class="difflineminus">-        i = uri.RFindChar('/');</span>
<a href="#l41.230"></a><span id="l41.230" class="difflineminus">-        if (i == -1) {</span>
<a href="#l41.231"></a><span id="l41.231" class="difflineminus">-            // Okay, just punt and assume there is _no_ namespace on</span>
<a href="#l41.232"></a><span id="l41.232" class="difflineminus">-            // this thing...</span>
<a href="#l41.233"></a><span id="l41.233" class="difflineminus">-            mQNames.Put(aResource, uri);</span>
<a href="#l41.234"></a><span id="l41.234" class="difflineminus">-            return NS_OK;</span>
<a href="#l41.235"></a><span id="l41.235" class="difflineminus">-        }</span>
<a href="#l41.236"></a><span id="l41.236" class="difflineminus">-    }</span>
<a href="#l41.237"></a><span id="l41.237" class="difflineminus">-</span>
<a href="#l41.238"></a><span id="l41.238" class="difflineminus">-    // Take whatever is to the right of the '#' or '/' and call it the</span>
<a href="#l41.239"></a><span id="l41.239" class="difflineminus">-    // local name, make up a prefix.</span>
<a href="#l41.240"></a><span id="l41.240" class="difflineminus">-    RefPtr&lt;nsAtom&gt; prefix = EnsureNewPrefix();</span>
<a href="#l41.241"></a><span id="l41.241" class="difflineminus">-    mNameSpaces.Put(StringHead(uri, i+1), prefix);</span>
<a href="#l41.242"></a><span id="l41.242" class="difflineminus">-    prefix-&gt;ToUTF8String(qname);</span>
<a href="#l41.243"></a><span id="l41.243" class="difflineminus">-    qname.Append(':');</span>
<a href="#l41.244"></a><span id="l41.244" class="difflineminus">-    qname += StringTail(uri, uri.Length() - (i + 1));</span>
<a href="#l41.245"></a><span id="l41.245" class="difflineminus">-</span>
<a href="#l41.246"></a><span id="l41.246" class="difflineminus">-    mQNames.Put(aResource, qname);</span>
<a href="#l41.247"></a><span id="l41.247" class="difflineminus">-    return NS_OK;</span>
<a href="#l41.248"></a><span id="l41.248" class="difflineminus">-}</span>
<a href="#l41.249"></a><span id="l41.249" class="difflineminus">-</span>
<a href="#l41.250"></a><span id="l41.250" class="difflineminus">-nsresult</span>
<a href="#l41.251"></a><span id="l41.251" class="difflineminus">-nsRDFXMLSerializer::GetQName(nsIRDFResource* aResource, nsCString&amp; aQName)</span>
<a href="#l41.252"></a><span id="l41.252" class="difflineminus">-{</span>
<a href="#l41.253"></a><span id="l41.253" class="difflineminus">-    return mQNames.Get(aResource, &amp;aQName) ? NS_OK : NS_ERROR_UNEXPECTED;</span>
<a href="#l41.254"></a><span id="l41.254" class="difflineminus">-}</span>
<a href="#l41.255"></a><span id="l41.255" class="difflineminus">-</span>
<a href="#l41.256"></a><span id="l41.256" class="difflineminus">-bool</span>
<a href="#l41.257"></a><span id="l41.257" class="difflineminus">-nsRDFXMLSerializer::IsContainerProperty(nsIRDFResource* aProperty)</span>
<a href="#l41.258"></a><span id="l41.258" class="difflineminus">-{</span>
<a href="#l41.259"></a><span id="l41.259" class="difflineminus">-    // Return `true' if the property is an internal property related</span>
<a href="#l41.260"></a><span id="l41.260" class="difflineminus">-    // to being a container.</span>
<a href="#l41.261"></a><span id="l41.261" class="difflineminus">-    if (aProperty == kRDF_instanceOf)</span>
<a href="#l41.262"></a><span id="l41.262" class="difflineminus">-        return true;</span>
<a href="#l41.263"></a><span id="l41.263" class="difflineminus">-</span>
<a href="#l41.264"></a><span id="l41.264" class="difflineminus">-    if (aProperty == kRDF_nextVal)</span>
<a href="#l41.265"></a><span id="l41.265" class="difflineminus">-        return true;</span>
<a href="#l41.266"></a><span id="l41.266" class="difflineminus">-</span>
<a href="#l41.267"></a><span id="l41.267" class="difflineminus">-    bool isOrdinal = false;</span>
<a href="#l41.268"></a><span id="l41.268" class="difflineminus">-    gRDFC-&gt;IsOrdinalProperty(aProperty, &amp;isOrdinal);</span>
<a href="#l41.269"></a><span id="l41.269" class="difflineminus">-    if (isOrdinal)</span>
<a href="#l41.270"></a><span id="l41.270" class="difflineminus">-        return true;</span>
<a href="#l41.271"></a><span id="l41.271" class="difflineminus">-</span>
<a href="#l41.272"></a><span id="l41.272" class="difflineminus">-    return false;</span>
<a href="#l41.273"></a><span id="l41.273" class="difflineminus">-}</span>
<a href="#l41.274"></a><span id="l41.274" class="difflineminus">-</span>
<a href="#l41.275"></a><span id="l41.275" class="difflineminus">-</span>
<a href="#l41.276"></a><span id="l41.276" class="difflineminus">-// convert '&amp;', '&lt;', and '&gt;' into &quot;&amp;amp;&quot;, &quot;&amp;lt;&quot;, and &quot;&amp;gt&quot;, respectively.</span>
<a href="#l41.277"></a><span id="l41.277" class="difflineminus">-static const char amp[] = &quot;&amp;amp;&quot;;</span>
<a href="#l41.278"></a><span id="l41.278" class="difflineminus">-static const char lt[] = &quot;&amp;lt;&quot;;</span>
<a href="#l41.279"></a><span id="l41.279" class="difflineminus">-static const char gt[] = &quot;&amp;gt;&quot;;</span>
<a href="#l41.280"></a><span id="l41.280" class="difflineminus">-static const char quot[] = &quot;&amp;quot;&quot;;</span>
<a href="#l41.281"></a><span id="l41.281" class="difflineminus">-</span>
<a href="#l41.282"></a><span id="l41.282" class="difflineminus">-static void</span>
<a href="#l41.283"></a><span id="l41.283" class="difflineminus">-rdf_EscapeAmpersandsAndAngleBrackets(nsCString&amp; s)</span>
<a href="#l41.284"></a><span id="l41.284" class="difflineminus">-{</span>
<a href="#l41.285"></a><span id="l41.285" class="difflineminus">-    uint32_t newLength, origLength;</span>
<a href="#l41.286"></a><span id="l41.286" class="difflineminus">-    newLength = origLength = s.Length();</span>
<a href="#l41.287"></a><span id="l41.287" class="difflineminus">-</span>
<a href="#l41.288"></a><span id="l41.288" class="difflineminus">-    // Compute the length of the result string.</span>
<a href="#l41.289"></a><span id="l41.289" class="difflineminus">-    const char* start = s.BeginReading();</span>
<a href="#l41.290"></a><span id="l41.290" class="difflineminus">-    const char* end = s.EndReading();</span>
<a href="#l41.291"></a><span id="l41.291" class="difflineminus">-    const char* c = start;</span>
<a href="#l41.292"></a><span id="l41.292" class="difflineminus">-    while (c != end) {</span>
<a href="#l41.293"></a><span id="l41.293" class="difflineminus">-        switch (*c) {</span>
<a href="#l41.294"></a><span id="l41.294" class="difflineminus">-        case '&amp;' :</span>
<a href="#l41.295"></a><span id="l41.295" class="difflineminus">-            newLength += sizeof(amp) - 2;</span>
<a href="#l41.296"></a><span id="l41.296" class="difflineminus">-            break;</span>
<a href="#l41.297"></a><span id="l41.297" class="difflineminus">-        case '&lt;':</span>
<a href="#l41.298"></a><span id="l41.298" class="difflineminus">-        case '&gt;':</span>
<a href="#l41.299"></a><span id="l41.299" class="difflineminus">-            newLength += sizeof(gt) - 2;</span>
<a href="#l41.300"></a><span id="l41.300" class="difflineminus">-            break;</span>
<a href="#l41.301"></a><span id="l41.301" class="difflineminus">-        default:</span>
<a href="#l41.302"></a><span id="l41.302" class="difflineminus">-            break;</span>
<a href="#l41.303"></a><span id="l41.303" class="difflineminus">-        }</span>
<a href="#l41.304"></a><span id="l41.304" class="difflineminus">-        ++c;</span>
<a href="#l41.305"></a><span id="l41.305" class="difflineminus">-    }</span>
<a href="#l41.306"></a><span id="l41.306" class="difflineminus">-    if (newLength == origLength) {</span>
<a href="#l41.307"></a><span id="l41.307" class="difflineminus">-        // nothing to escape</span>
<a href="#l41.308"></a><span id="l41.308" class="difflineminus">-        return;</span>
<a href="#l41.309"></a><span id="l41.309" class="difflineminus">-    }</span>
<a href="#l41.310"></a><span id="l41.310" class="difflineminus">-</span>
<a href="#l41.311"></a><span id="l41.311" class="difflineminus">-    // escape the chars from the end back to the front.</span>
<a href="#l41.312"></a><span id="l41.312" class="difflineminus">-    s.SetLength(newLength);</span>
<a href="#l41.313"></a><span id="l41.313" class="difflineminus">-</span>
<a href="#l41.314"></a><span id="l41.314" class="difflineminus">-    // Buffer might have changed, get the pointers again</span>
<a href="#l41.315"></a><span id="l41.315" class="difflineminus">-    start = s.BeginReading(); // begin of string</span>
<a href="#l41.316"></a><span id="l41.316" class="difflineminus">-    c = start + origLength - 1; // last char in original string</span>
<a href="#l41.317"></a><span id="l41.317" class="difflineminus">-    char* w = s.EndWriting() - 1; // last char in grown buffer</span>
<a href="#l41.318"></a><span id="l41.318" class="difflineminus">-    while (c &gt;= start) {</span>
<a href="#l41.319"></a><span id="l41.319" class="difflineminus">-        switch (*c) {</span>
<a href="#l41.320"></a><span id="l41.320" class="difflineminus">-        case '&amp;' :</span>
<a href="#l41.321"></a><span id="l41.321" class="difflineminus">-            w -= 4;</span>
<a href="#l41.322"></a><span id="l41.322" class="difflineminus">-            nsCharTraits&lt;char&gt;::copy(w, amp, sizeof(amp) - 1);</span>
<a href="#l41.323"></a><span id="l41.323" class="difflineminus">-            break;</span>
<a href="#l41.324"></a><span id="l41.324" class="difflineminus">-        case '&lt;':</span>
<a href="#l41.325"></a><span id="l41.325" class="difflineminus">-            w -= 3;</span>
<a href="#l41.326"></a><span id="l41.326" class="difflineminus">-            nsCharTraits&lt;char&gt;::copy(w, lt, sizeof(lt) - 1);</span>
<a href="#l41.327"></a><span id="l41.327" class="difflineminus">-            break;</span>
<a href="#l41.328"></a><span id="l41.328" class="difflineminus">-        case '&gt;':</span>
<a href="#l41.329"></a><span id="l41.329" class="difflineminus">-            w -= 3;</span>
<a href="#l41.330"></a><span id="l41.330" class="difflineminus">-            nsCharTraits&lt;char&gt;::copy(w, gt, sizeof(gt) - 1);</span>
<a href="#l41.331"></a><span id="l41.331" class="difflineminus">-            break;</span>
<a href="#l41.332"></a><span id="l41.332" class="difflineminus">-        default:</span>
<a href="#l41.333"></a><span id="l41.333" class="difflineminus">-            *w = *c;</span>
<a href="#l41.334"></a><span id="l41.334" class="difflineminus">-        }</span>
<a href="#l41.335"></a><span id="l41.335" class="difflineminus">-        --w;</span>
<a href="#l41.336"></a><span id="l41.336" class="difflineminus">-        --c;</span>
<a href="#l41.337"></a><span id="l41.337" class="difflineminus">-    }</span>
<a href="#l41.338"></a><span id="l41.338" class="difflineminus">-}</span>
<a href="#l41.339"></a><span id="l41.339" class="difflineminus">-</span>
<a href="#l41.340"></a><span id="l41.340" class="difflineminus">-// convert '&quot;' to &quot;&amp;quot;&quot;</span>
<a href="#l41.341"></a><span id="l41.341" class="difflineminus">-static void</span>
<a href="#l41.342"></a><span id="l41.342" class="difflineminus">-rdf_EscapeQuotes(nsCString&amp; s)</span>
<a href="#l41.343"></a><span id="l41.343" class="difflineminus">-{</span>
<a href="#l41.344"></a><span id="l41.344" class="difflineminus">-    int32_t i = 0;</span>
<a href="#l41.345"></a><span id="l41.345" class="difflineminus">-    while ((i = s.FindChar('&quot;', i)) != -1) {</span>
<a href="#l41.346"></a><span id="l41.346" class="difflineminus">-        s.Replace(i, 1, quot, sizeof(quot) - 1);</span>
<a href="#l41.347"></a><span id="l41.347" class="difflineminus">-        i += sizeof(quot) - 2;</span>
<a href="#l41.348"></a><span id="l41.348" class="difflineminus">-    }</span>
<a href="#l41.349"></a><span id="l41.349" class="difflineminus">-}</span>
<a href="#l41.350"></a><span id="l41.350" class="difflineminus">-</span>
<a href="#l41.351"></a><span id="l41.351" class="difflineminus">-static void</span>
<a href="#l41.352"></a><span id="l41.352" class="difflineminus">-rdf_EscapeAttributeValue(nsCString&amp; s)</span>
<a href="#l41.353"></a><span id="l41.353" class="difflineminus">-{</span>
<a href="#l41.354"></a><span id="l41.354" class="difflineminus">-    rdf_EscapeAmpersandsAndAngleBrackets(s);</span>
<a href="#l41.355"></a><span id="l41.355" class="difflineminus">-    rdf_EscapeQuotes(s);</span>
<a href="#l41.356"></a><span id="l41.356" class="difflineminus">-}</span>
<a href="#l41.357"></a><span id="l41.357" class="difflineminus">-</span>
<a href="#l41.358"></a><span id="l41.358" class="difflineminus">-</span>
<a href="#l41.359"></a><span id="l41.359" class="difflineminus">-nsresult</span>
<a href="#l41.360"></a><span id="l41.360" class="difflineminus">-nsRDFXMLSerializer::SerializeInlineAssertion(nsIOutputStream* aStream,</span>
<a href="#l41.361"></a><span id="l41.361" class="difflineminus">-                                             nsIRDFResource* aResource,</span>
<a href="#l41.362"></a><span id="l41.362" class="difflineminus">-                                             nsIRDFResource* aProperty,</span>
<a href="#l41.363"></a><span id="l41.363" class="difflineminus">-                                             nsIRDFLiteral* aValue)</span>
<a href="#l41.364"></a><span id="l41.364" class="difflineminus">-{</span>
<a href="#l41.365"></a><span id="l41.365" class="difflineminus">-    nsresult rv;</span>
<a href="#l41.366"></a><span id="l41.366" class="difflineminus">-    nsCString qname;</span>
<a href="#l41.367"></a><span id="l41.367" class="difflineminus">-    rv = GetQName(aProperty, qname);</span>
<a href="#l41.368"></a><span id="l41.368" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l41.369"></a><span id="l41.369" class="difflineminus">-</span>
<a href="#l41.370"></a><span id="l41.370" class="difflineminus">-    rv = rdf_BlockingWrite(aStream,</span>
<a href="#l41.371"></a><span id="l41.371" class="difflineminus">-                           NS_LITERAL_CSTRING(&quot;\n                   &quot;));</span>
<a href="#l41.372"></a><span id="l41.372" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l41.373"></a><span id="l41.373" class="difflineminus">-</span>
<a href="#l41.374"></a><span id="l41.374" class="difflineminus">-    const char16_t* value;</span>
<a href="#l41.375"></a><span id="l41.375" class="difflineminus">-    aValue-&gt;GetValueConst(&amp;value);</span>
<a href="#l41.376"></a><span id="l41.376" class="difflineminus">-    NS_ConvertUTF16toUTF8 s(value);</span>
<a href="#l41.377"></a><span id="l41.377" class="difflineminus">-</span>
<a href="#l41.378"></a><span id="l41.378" class="difflineminus">-    rdf_EscapeAttributeValue(s);</span>
<a href="#l41.379"></a><span id="l41.379" class="difflineminus">-</span>
<a href="#l41.380"></a><span id="l41.380" class="difflineminus">-    rv = rdf_BlockingWrite(aStream, qname);</span>
<a href="#l41.381"></a><span id="l41.381" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l41.382"></a><span id="l41.382" class="difflineminus">-    rv = rdf_BlockingWrite(aStream, &quot;=\&quot;&quot;, 2);</span>
<a href="#l41.383"></a><span id="l41.383" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l41.384"></a><span id="l41.384" class="difflineminus">-    s.Append('&quot;');</span>
<a href="#l41.385"></a><span id="l41.385" class="difflineminus">-    return rdf_BlockingWrite(aStream, s);</span>
<a href="#l41.386"></a><span id="l41.386" class="difflineminus">-}</span>
<a href="#l41.387"></a><span id="l41.387" class="difflineminus">-</span>
<a href="#l41.388"></a><span id="l41.388" class="difflineminus">-nsresult</span>
<a href="#l41.389"></a><span id="l41.389" class="difflineminus">-nsRDFXMLSerializer::SerializeChildAssertion(nsIOutputStream* aStream,</span>
<a href="#l41.390"></a><span id="l41.390" class="difflineminus">-                                            nsIRDFResource* aResource,</span>
<a href="#l41.391"></a><span id="l41.391" class="difflineminus">-                                            nsIRDFResource* aProperty,</span>
<a href="#l41.392"></a><span id="l41.392" class="difflineminus">-                                            nsIRDFNode* aValue)</span>
<a href="#l41.393"></a><span id="l41.393" class="difflineminus">-{</span>
<a href="#l41.394"></a><span id="l41.394" class="difflineminus">-    nsCString qname;</span>
<a href="#l41.395"></a><span id="l41.395" class="difflineminus">-    nsresult rv = GetQName(aProperty, qname);</span>
<a href="#l41.396"></a><span id="l41.396" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l41.397"></a><span id="l41.397" class="difflineminus">-</span>
<a href="#l41.398"></a><span id="l41.398" class="difflineminus">-    rv = rdf_BlockingWrite(aStream, &quot;    &lt;&quot;, 5);</span>
<a href="#l41.399"></a><span id="l41.399" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l41.400"></a><span id="l41.400" class="difflineminus">-    rv = rdf_BlockingWrite(aStream, qname);</span>
<a href="#l41.401"></a><span id="l41.401" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l41.402"></a><span id="l41.402" class="difflineminus">-</span>
<a href="#l41.403"></a><span id="l41.403" class="difflineminus">-    nsCOMPtr&lt;nsIRDFResource&gt; resource;</span>
<a href="#l41.404"></a><span id="l41.404" class="difflineminus">-    nsCOMPtr&lt;nsIRDFLiteral&gt; literal;</span>
<a href="#l41.405"></a><span id="l41.405" class="difflineminus">-    nsCOMPtr&lt;nsIRDFInt&gt; number;</span>
<a href="#l41.406"></a><span id="l41.406" class="difflineminus">-    nsCOMPtr&lt;nsIRDFDate&gt; date;</span>
<a href="#l41.407"></a><span id="l41.407" class="difflineminus">-</span>
<a href="#l41.408"></a><span id="l41.408" class="difflineminus">-    if ((resource = do_QueryInterface(aValue)) != nullptr) {</span>
<a href="#l41.409"></a><span id="l41.409" class="difflineminus">-        nsAutoCString uri;</span>
<a href="#l41.410"></a><span id="l41.410" class="difflineminus">-        resource-&gt;GetValueUTF8(uri);</span>
<a href="#l41.411"></a><span id="l41.411" class="difflineminus">-</span>
<a href="#l41.412"></a><span id="l41.412" class="difflineminus">-        rdf_MakeRelativeRef(mBaseURLSpec, uri);</span>
<a href="#l41.413"></a><span id="l41.413" class="difflineminus">-        rdf_EscapeAttributeValue(uri);</span>
<a href="#l41.414"></a><span id="l41.414" class="difflineminus">-</span>
<a href="#l41.415"></a><span id="l41.415" class="difflineminus">-        rv = rdf_BlockingWrite(aStream, kRDFResource1,</span>
<a href="#l41.416"></a><span id="l41.416" class="difflineminus">-                               sizeof(kRDFResource1) - 1);</span>
<a href="#l41.417"></a><span id="l41.417" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l41.418"></a><span id="l41.418" class="difflineminus">-        rv = rdf_BlockingWrite(aStream, uri);</span>
<a href="#l41.419"></a><span id="l41.419" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l41.420"></a><span id="l41.420" class="difflineminus">-        rv = rdf_BlockingWrite(aStream, kRDFResource2,</span>
<a href="#l41.421"></a><span id="l41.421" class="difflineminus">-                               sizeof(kRDFResource2) - 1);</span>
<a href="#l41.422"></a><span id="l41.422" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l41.423"></a><span id="l41.423" class="difflineminus">-</span>
<a href="#l41.424"></a><span id="l41.424" class="difflineminus">-        goto no_close_tag;</span>
<a href="#l41.425"></a><span id="l41.425" class="difflineminus">-    }</span>
<a href="#l41.426"></a><span id="l41.426" class="difflineminus">-    else if ((literal = do_QueryInterface(aValue)) != nullptr) {</span>
<a href="#l41.427"></a><span id="l41.427" class="difflineminus">-        const char16_t *value;</span>
<a href="#l41.428"></a><span id="l41.428" class="difflineminus">-        literal-&gt;GetValueConst(&amp;value);</span>
<a href="#l41.429"></a><span id="l41.429" class="difflineminus">-        NS_ConvertUTF16toUTF8 s(value);</span>
<a href="#l41.430"></a><span id="l41.430" class="difflineminus">-</span>
<a href="#l41.431"></a><span id="l41.431" class="difflineminus">-        rdf_EscapeAmpersandsAndAngleBrackets(s);</span>
<a href="#l41.432"></a><span id="l41.432" class="difflineminus">-</span>
<a href="#l41.433"></a><span id="l41.433" class="difflineminus">-        rv = rdf_BlockingWrite(aStream, &quot;&gt;&quot;, 1);</span>
<a href="#l41.434"></a><span id="l41.434" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l41.435"></a><span id="l41.435" class="difflineminus">-        rv = rdf_BlockingWrite(aStream, s);</span>
<a href="#l41.436"></a><span id="l41.436" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l41.437"></a><span id="l41.437" class="difflineminus">-    }</span>
<a href="#l41.438"></a><span id="l41.438" class="difflineminus">-    else if ((number = do_QueryInterface(aValue)) != nullptr) {</span>
<a href="#l41.439"></a><span id="l41.439" class="difflineminus">-        int32_t value;</span>
<a href="#l41.440"></a><span id="l41.440" class="difflineminus">-        number-&gt;GetValue(&amp;value);</span>
<a href="#l41.441"></a><span id="l41.441" class="difflineminus">-</span>
<a href="#l41.442"></a><span id="l41.442" class="difflineminus">-        nsAutoCString n;</span>
<a href="#l41.443"></a><span id="l41.443" class="difflineminus">-        n.AppendInt(value);</span>
<a href="#l41.444"></a><span id="l41.444" class="difflineminus">-</span>
<a href="#l41.445"></a><span id="l41.445" class="difflineminus">-        rv = rdf_BlockingWrite(aStream, kRDFParseTypeInteger,</span>
<a href="#l41.446"></a><span id="l41.446" class="difflineminus">-                               sizeof(kRDFParseTypeInteger) - 1);</span>
<a href="#l41.447"></a><span id="l41.447" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l41.448"></a><span id="l41.448" class="difflineminus">-        rv = rdf_BlockingWrite(aStream, n);</span>
<a href="#l41.449"></a><span id="l41.449" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l41.450"></a><span id="l41.450" class="difflineminus">-    }</span>
<a href="#l41.451"></a><span id="l41.451" class="difflineminus">-    else if ((date = do_QueryInterface(aValue)) != nullptr) {</span>
<a href="#l41.452"></a><span id="l41.452" class="difflineminus">-        PRTime value;</span>
<a href="#l41.453"></a><span id="l41.453" class="difflineminus">-        date-&gt;GetValue(&amp;value);</span>
<a href="#l41.454"></a><span id="l41.454" class="difflineminus">-</span>
<a href="#l41.455"></a><span id="l41.455" class="difflineminus">-        nsAutoCString s;</span>
<a href="#l41.456"></a><span id="l41.456" class="difflineminus">-        rdf_FormatDate(value, s);</span>
<a href="#l41.457"></a><span id="l41.457" class="difflineminus">-</span>
<a href="#l41.458"></a><span id="l41.458" class="difflineminus">-        rv = rdf_BlockingWrite(aStream, kRDFParseTypeDate,</span>
<a href="#l41.459"></a><span id="l41.459" class="difflineminus">-                               sizeof(kRDFParseTypeDate) - 1);</span>
<a href="#l41.460"></a><span id="l41.460" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l41.461"></a><span id="l41.461" class="difflineminus">-        rv = rdf_BlockingWrite(aStream, s);</span>
<a href="#l41.462"></a><span id="l41.462" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l41.463"></a><span id="l41.463" class="difflineminus">-    }</span>
<a href="#l41.464"></a><span id="l41.464" class="difflineminus">-    else {</span>
<a href="#l41.465"></a><span id="l41.465" class="difflineminus">-        // XXX it doesn't support nsIRDFResource _or_ nsIRDFLiteral???</span>
<a href="#l41.466"></a><span id="l41.466" class="difflineminus">-        // We should serialize nsIRDFInt, nsIRDFDate, etc...</span>
<a href="#l41.467"></a><span id="l41.467" class="difflineminus">-        NS_WARNING(&quot;unknown RDF node type&quot;);</span>
<a href="#l41.468"></a><span id="l41.468" class="difflineminus">-</span>
<a href="#l41.469"></a><span id="l41.469" class="difflineminus">-        rv = rdf_BlockingWrite(aStream, kRDFUnknown, sizeof(kRDFUnknown) - 1);</span>
<a href="#l41.470"></a><span id="l41.470" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l41.471"></a><span id="l41.471" class="difflineminus">-    }</span>
<a href="#l41.472"></a><span id="l41.472" class="difflineminus">-</span>
<a href="#l41.473"></a><span id="l41.473" class="difflineminus">-    rv = rdf_BlockingWrite(aStream, &quot;&lt;/&quot;, 2);</span>
<a href="#l41.474"></a><span id="l41.474" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l41.475"></a><span id="l41.475" class="difflineminus">-    rv = rdf_BlockingWrite(aStream, qname);</span>
<a href="#l41.476"></a><span id="l41.476" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l41.477"></a><span id="l41.477" class="difflineminus">-    return rdf_BlockingWrite(aStream, &quot;&gt;\n&quot;, 2);</span>
<a href="#l41.478"></a><span id="l41.478" class="difflineminus">-</span>
<a href="#l41.479"></a><span id="l41.479" class="difflineminus">- no_close_tag:</span>
<a href="#l41.480"></a><span id="l41.480" class="difflineminus">-    return NS_OK;</span>
<a href="#l41.481"></a><span id="l41.481" class="difflineminus">-}</span>
<a href="#l41.482"></a><span id="l41.482" class="difflineminus">-</span>
<a href="#l41.483"></a><span id="l41.483" class="difflineminus">-nsresult</span>
<a href="#l41.484"></a><span id="l41.484" class="difflineminus">-nsRDFXMLSerializer::SerializeProperty(nsIOutputStream* aStream,</span>
<a href="#l41.485"></a><span id="l41.485" class="difflineminus">-                                      nsIRDFResource* aResource,</span>
<a href="#l41.486"></a><span id="l41.486" class="difflineminus">-                                      nsIRDFResource* aProperty,</span>
<a href="#l41.487"></a><span id="l41.487" class="difflineminus">-                                      bool aInline,</span>
<a href="#l41.488"></a><span id="l41.488" class="difflineminus">-                                      int32_t* aSkipped)</span>
<a href="#l41.489"></a><span id="l41.489" class="difflineminus">-{</span>
<a href="#l41.490"></a><span id="l41.490" class="difflineminus">-    nsresult rv = NS_OK;</span>
<a href="#l41.491"></a><span id="l41.491" class="difflineminus">-</span>
<a href="#l41.492"></a><span id="l41.492" class="difflineminus">-    int32_t skipped = 0;</span>
<a href="#l41.493"></a><span id="l41.493" class="difflineminus">-</span>
<a href="#l41.494"></a><span id="l41.494" class="difflineminus">-    nsCOMPtr&lt;nsISimpleEnumerator&gt; assertions;</span>
<a href="#l41.495"></a><span id="l41.495" class="difflineminus">-    mDataSource-&gt;GetTargets(aResource, aProperty, true, getter_AddRefs(assertions));</span>
<a href="#l41.496"></a><span id="l41.496" class="difflineminus">-    if (! assertions)</span>
<a href="#l41.497"></a><span id="l41.497" class="difflineminus">-        return NS_ERROR_FAILURE;</span>
<a href="#l41.498"></a><span id="l41.498" class="difflineminus">-</span>
<a href="#l41.499"></a><span id="l41.499" class="difflineminus">-    // Serializing the assertion inline is ok as long as the property has</span>
<a href="#l41.500"></a><span id="l41.500" class="difflineminus">-    // only one target value, and it is a literal that doesn't include line</span>
<a href="#l41.501"></a><span id="l41.501" class="difflineminus">-    // breaks.</span>
<a href="#l41.502"></a><span id="l41.502" class="difflineminus">-    bool needsChild = false;</span>
<a href="#l41.503"></a><span id="l41.503" class="difflineminus">-</span>
<a href="#l41.504"></a><span id="l41.504" class="difflineminus">-    while (1) {</span>
<a href="#l41.505"></a><span id="l41.505" class="difflineminus">-        bool hasMore = false;</span>
<a href="#l41.506"></a><span id="l41.506" class="difflineminus">-        assertions-&gt;HasMoreElements(&amp;hasMore);</span>
<a href="#l41.507"></a><span id="l41.507" class="difflineminus">-        if (! hasMore)</span>
<a href="#l41.508"></a><span id="l41.508" class="difflineminus">-            break;</span>
<a href="#l41.509"></a><span id="l41.509" class="difflineminus">-</span>
<a href="#l41.510"></a><span id="l41.510" class="difflineminus">-        nsCOMPtr&lt;nsISupports&gt; isupports;</span>
<a href="#l41.511"></a><span id="l41.511" class="difflineminus">-        assertions-&gt;GetNext(getter_AddRefs(isupports));</span>
<a href="#l41.512"></a><span id="l41.512" class="difflineminus">-        nsCOMPtr&lt;nsIRDFLiteral&gt; literal = do_QueryInterface(isupports);</span>
<a href="#l41.513"></a><span id="l41.513" class="difflineminus">-        needsChild |= (!literal);</span>
<a href="#l41.514"></a><span id="l41.514" class="difflineminus">-</span>
<a href="#l41.515"></a><span id="l41.515" class="difflineminus">-        if (!needsChild) {</span>
<a href="#l41.516"></a><span id="l41.516" class="difflineminus">-            assertions-&gt;HasMoreElements(&amp;needsChild);</span>
<a href="#l41.517"></a><span id="l41.517" class="difflineminus">-            if (!needsChild) {</span>
<a href="#l41.518"></a><span id="l41.518" class="difflineminus">-                const char16_t* literalVal = nullptr;</span>
<a href="#l41.519"></a><span id="l41.519" class="difflineminus">-                literal-&gt;GetValueConst(&amp;literalVal);</span>
<a href="#l41.520"></a><span id="l41.520" class="difflineminus">-                if (literalVal) {</span>
<a href="#l41.521"></a><span id="l41.521" class="difflineminus">-                    for (; *literalVal; literalVal++) {</span>
<a href="#l41.522"></a><span id="l41.522" class="difflineminus">-                        if (*literalVal == char16_t('\n') ||</span>
<a href="#l41.523"></a><span id="l41.523" class="difflineminus">-                            *literalVal == char16_t('\r')) {</span>
<a href="#l41.524"></a><span id="l41.524" class="difflineminus">-                            needsChild = true;</span>
<a href="#l41.525"></a><span id="l41.525" class="difflineminus">-                            break;</span>
<a href="#l41.526"></a><span id="l41.526" class="difflineminus">-                        }</span>
<a href="#l41.527"></a><span id="l41.527" class="difflineminus">-                    }</span>
<a href="#l41.528"></a><span id="l41.528" class="difflineminus">-                }</span>
<a href="#l41.529"></a><span id="l41.529" class="difflineminus">-            }</span>
<a href="#l41.530"></a><span id="l41.530" class="difflineminus">-        }</span>
<a href="#l41.531"></a><span id="l41.531" class="difflineminus">-</span>
<a href="#l41.532"></a><span id="l41.532" class="difflineminus">-        if (aInline &amp;&amp; !needsChild) {</span>
<a href="#l41.533"></a><span id="l41.533" class="difflineminus">-            rv = SerializeInlineAssertion(aStream, aResource, aProperty, literal);</span>
<a href="#l41.534"></a><span id="l41.534" class="difflineminus">-        }</span>
<a href="#l41.535"></a><span id="l41.535" class="difflineminus">-        else if (!aInline &amp;&amp; needsChild) {</span>
<a href="#l41.536"></a><span id="l41.536" class="difflineminus">-            nsCOMPtr&lt;nsIRDFNode&gt; value = do_QueryInterface(isupports);</span>
<a href="#l41.537"></a><span id="l41.537" class="difflineminus">-            rv = SerializeChildAssertion(aStream, aResource, aProperty, value);</span>
<a href="#l41.538"></a><span id="l41.538" class="difflineminus">-        }</span>
<a href="#l41.539"></a><span id="l41.539" class="difflineminus">-        else {</span>
<a href="#l41.540"></a><span id="l41.540" class="difflineminus">-            ++skipped;</span>
<a href="#l41.541"></a><span id="l41.541" class="difflineminus">-            rv = NS_OK;</span>
<a href="#l41.542"></a><span id="l41.542" class="difflineminus">-        }</span>
<a href="#l41.543"></a><span id="l41.543" class="difflineminus">-</span>
<a href="#l41.544"></a><span id="l41.544" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l41.545"></a><span id="l41.545" class="difflineminus">-            break;</span>
<a href="#l41.546"></a><span id="l41.546" class="difflineminus">-    }</span>
<a href="#l41.547"></a><span id="l41.547" class="difflineminus">-</span>
<a href="#l41.548"></a><span id="l41.548" class="difflineminus">-    *aSkipped += skipped;</span>
<a href="#l41.549"></a><span id="l41.549" class="difflineminus">-    return rv;</span>
<a href="#l41.550"></a><span id="l41.550" class="difflineminus">-}</span>
<a href="#l41.551"></a><span id="l41.551" class="difflineminus">-</span>
<a href="#l41.552"></a><span id="l41.552" class="difflineminus">-</span>
<a href="#l41.553"></a><span id="l41.553" class="difflineminus">-nsresult</span>
<a href="#l41.554"></a><span id="l41.554" class="difflineminus">-nsRDFXMLSerializer::SerializeDescription(nsIOutputStream* aStream,</span>
<a href="#l41.555"></a><span id="l41.555" class="difflineminus">-                                         nsIRDFResource* aResource)</span>
<a href="#l41.556"></a><span id="l41.556" class="difflineminus">-{</span>
<a href="#l41.557"></a><span id="l41.557" class="difflineminus">-    nsresult rv;</span>
<a href="#l41.558"></a><span id="l41.558" class="difflineminus">-</span>
<a href="#l41.559"></a><span id="l41.559" class="difflineminus">-    bool isTypedNode = false;</span>
<a href="#l41.560"></a><span id="l41.560" class="difflineminus">-    nsCString typeQName;</span>
<a href="#l41.561"></a><span id="l41.561" class="difflineminus">-</span>
<a href="#l41.562"></a><span id="l41.562" class="difflineminus">-    nsCOMPtr&lt;nsIRDFNode&gt; typeNode;</span>
<a href="#l41.563"></a><span id="l41.563" class="difflineminus">-    mDataSource-&gt;GetTarget(aResource, kRDF_type, true, getter_AddRefs(typeNode));</span>
<a href="#l41.564"></a><span id="l41.564" class="difflineminus">-    if (typeNode) {</span>
<a href="#l41.565"></a><span id="l41.565" class="difflineminus">-        nsCOMPtr&lt;nsIRDFResource&gt; type = do_QueryInterface(typeNode, &amp;rv);</span>
<a href="#l41.566"></a><span id="l41.566" class="difflineminus">-        if (type) {</span>
<a href="#l41.567"></a><span id="l41.567" class="difflineminus">-            // Try to get a namespace prefix.  If none is available,</span>
<a href="#l41.568"></a><span id="l41.568" class="difflineminus">-            // just treat the description as if it weren't a typed node</span>
<a href="#l41.569"></a><span id="l41.569" class="difflineminus">-            // after all and emit rdf:type as a normal property.  This</span>
<a href="#l41.570"></a><span id="l41.570" class="difflineminus">-            // seems preferable to using a bogus (invented) prefix.</span>
<a href="#l41.571"></a><span id="l41.571" class="difflineminus">-            isTypedNode = NS_SUCCEEDED(GetQName(type, typeQName));</span>
<a href="#l41.572"></a><span id="l41.572" class="difflineminus">-        }</span>
<a href="#l41.573"></a><span id="l41.573" class="difflineminus">-    }</span>
<a href="#l41.574"></a><span id="l41.574" class="difflineminus">-</span>
<a href="#l41.575"></a><span id="l41.575" class="difflineminus">-    nsAutoCString uri;</span>
<a href="#l41.576"></a><span id="l41.576" class="difflineminus">-    rv = aResource-&gt;GetValueUTF8(uri);</span>
<a href="#l41.577"></a><span id="l41.577" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l41.578"></a><span id="l41.578" class="difflineminus">-</span>
<a href="#l41.579"></a><span id="l41.579" class="difflineminus">-    rdf_MakeRelativeRef(mBaseURLSpec, uri);</span>
<a href="#l41.580"></a><span id="l41.580" class="difflineminus">-    rdf_EscapeAttributeValue(uri);</span>
<a href="#l41.581"></a><span id="l41.581" class="difflineminus">-</span>
<a href="#l41.582"></a><span id="l41.582" class="difflineminus">-    // Emit an open tag and the subject</span>
<a href="#l41.583"></a><span id="l41.583" class="difflineminus">-    if (isTypedNode) {</span>
<a href="#l41.584"></a><span id="l41.584" class="difflineminus">-        rv = rdf_BlockingWrite(aStream, NS_LITERAL_STRING(&quot;  &lt;&quot;));</span>
<a href="#l41.585"></a><span id="l41.585" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l41.586"></a><span id="l41.586" class="difflineminus">-        // Watch out for the default namespace!</span>
<a href="#l41.587"></a><span id="l41.587" class="difflineminus">-        rv = rdf_BlockingWrite(aStream, typeQName);</span>
<a href="#l41.588"></a><span id="l41.588" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l41.589"></a><span id="l41.589" class="difflineminus">-    }</span>
<a href="#l41.590"></a><span id="l41.590" class="difflineminus">-    else {</span>
<a href="#l41.591"></a><span id="l41.591" class="difflineminus">-        rv = rdf_BlockingWrite(aStream, kRDFDescriptionOpen,</span>
<a href="#l41.592"></a><span id="l41.592" class="difflineminus">-                               sizeof(kRDFDescriptionOpen) - 1);</span>
<a href="#l41.593"></a><span id="l41.593" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l41.594"></a><span id="l41.594" class="difflineminus">-    }</span>
<a href="#l41.595"></a><span id="l41.595" class="difflineminus">-    if (uri[0] == char16_t('#')) {</span>
<a href="#l41.596"></a><span id="l41.596" class="difflineminus">-        uri.Cut(0, 1);</span>
<a href="#l41.597"></a><span id="l41.597" class="difflineminus">-        rv = rdf_BlockingWrite(aStream, kIDAttr, sizeof(kIDAttr) - 1);</span>
<a href="#l41.598"></a><span id="l41.598" class="difflineminus">-    }</span>
<a href="#l41.599"></a><span id="l41.599" class="difflineminus">-    else {</span>
<a href="#l41.600"></a><span id="l41.600" class="difflineminus">-        rv = rdf_BlockingWrite(aStream, kAboutAttr, sizeof(kAboutAttr) - 1);</span>
<a href="#l41.601"></a><span id="l41.601" class="difflineminus">-    }</span>
<a href="#l41.602"></a><span id="l41.602" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l41.603"></a><span id="l41.603" class="difflineminus">-</span>
<a href="#l41.604"></a><span id="l41.604" class="difflineminus">-    uri.Append('&quot;');</span>
<a href="#l41.605"></a><span id="l41.605" class="difflineminus">-    rv = rdf_BlockingWrite(aStream, uri);</span>
<a href="#l41.606"></a><span id="l41.606" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l41.607"></a><span id="l41.607" class="difflineminus">-</span>
<a href="#l41.608"></a><span id="l41.608" class="difflineminus">-    // Any value that's a literal we can write out as an inline</span>
<a href="#l41.609"></a><span id="l41.609" class="difflineminus">-    // attribute on the RDF:Description</span>
<a href="#l41.610"></a><span id="l41.610" class="difflineminus">-    AutoTArray&lt;nsIRDFResource*, 8&gt; visited;</span>
<a href="#l41.611"></a><span id="l41.611" class="difflineminus">-    int32_t skipped = 0;</span>
<a href="#l41.612"></a><span id="l41.612" class="difflineminus">-</span>
<a href="#l41.613"></a><span id="l41.613" class="difflineminus">-    nsCOMPtr&lt;nsISimpleEnumerator&gt; arcs;</span>
<a href="#l41.614"></a><span id="l41.614" class="difflineminus">-    mDataSource-&gt;ArcLabelsOut(aResource, getter_AddRefs(arcs));</span>
<a href="#l41.615"></a><span id="l41.615" class="difflineminus">-</span>
<a href="#l41.616"></a><span id="l41.616" class="difflineminus">-    if (arcs) {</span>
<a href="#l41.617"></a><span id="l41.617" class="difflineminus">-        // Don't re-serialize rdf:type later on</span>
<a href="#l41.618"></a><span id="l41.618" class="difflineminus">-        if (isTypedNode)</span>
<a href="#l41.619"></a><span id="l41.619" class="difflineminus">-            visited.AppendElement(kRDF_type);</span>
<a href="#l41.620"></a><span id="l41.620" class="difflineminus">-</span>
<a href="#l41.621"></a><span id="l41.621" class="difflineminus">-        while (1) {</span>
<a href="#l41.622"></a><span id="l41.622" class="difflineminus">-            bool hasMore = false;</span>
<a href="#l41.623"></a><span id="l41.623" class="difflineminus">-            arcs-&gt;HasMoreElements(&amp;hasMore);</span>
<a href="#l41.624"></a><span id="l41.624" class="difflineminus">-            if (! hasMore)</span>
<a href="#l41.625"></a><span id="l41.625" class="difflineminus">-                break;</span>
<a href="#l41.626"></a><span id="l41.626" class="difflineminus">-</span>
<a href="#l41.627"></a><span id="l41.627" class="difflineminus">-            nsCOMPtr&lt;nsISupports&gt; isupports;</span>
<a href="#l41.628"></a><span id="l41.628" class="difflineminus">-            arcs-&gt;GetNext(getter_AddRefs(isupports));</span>
<a href="#l41.629"></a><span id="l41.629" class="difflineminus">-</span>
<a href="#l41.630"></a><span id="l41.630" class="difflineminus">-            nsCOMPtr&lt;nsIRDFResource&gt; property = do_QueryInterface(isupports);</span>
<a href="#l41.631"></a><span id="l41.631" class="difflineminus">-            if (! property)</span>
<a href="#l41.632"></a><span id="l41.632" class="difflineminus">-                continue;</span>
<a href="#l41.633"></a><span id="l41.633" class="difflineminus">-</span>
<a href="#l41.634"></a><span id="l41.634" class="difflineminus">-            // Ignore properties that pertain to containers; we may be</span>
<a href="#l41.635"></a><span id="l41.635" class="difflineminus">-            // called from SerializeContainer() if the container resource</span>
<a href="#l41.636"></a><span id="l41.636" class="difflineminus">-            // has been assigned non-container properties.</span>
<a href="#l41.637"></a><span id="l41.637" class="difflineminus">-            if (IsContainerProperty(property))</span>
<a href="#l41.638"></a><span id="l41.638" class="difflineminus">-                continue;</span>
<a href="#l41.639"></a><span id="l41.639" class="difflineminus">-</span>
<a href="#l41.640"></a><span id="l41.640" class="difflineminus">-            // Only serialize values for the property once.</span>
<a href="#l41.641"></a><span id="l41.641" class="difflineminus">-            if (visited.Contains(property.get()))</span>
<a href="#l41.642"></a><span id="l41.642" class="difflineminus">-                continue;</span>
<a href="#l41.643"></a><span id="l41.643" class="difflineminus">-</span>
<a href="#l41.644"></a><span id="l41.644" class="difflineminus">-            visited.AppendElement(property.get());</span>
<a href="#l41.645"></a><span id="l41.645" class="difflineminus">-</span>
<a href="#l41.646"></a><span id="l41.646" class="difflineminus">-            SerializeProperty(aStream, aResource, property, true, &amp;skipped);</span>
<a href="#l41.647"></a><span id="l41.647" class="difflineminus">-        }</span>
<a href="#l41.648"></a><span id="l41.648" class="difflineminus">-    }</span>
<a href="#l41.649"></a><span id="l41.649" class="difflineminus">-</span>
<a href="#l41.650"></a><span id="l41.650" class="difflineminus">-    if (skipped) {</span>
<a href="#l41.651"></a><span id="l41.651" class="difflineminus">-        // Close the RDF:Description tag.</span>
<a href="#l41.652"></a><span id="l41.652" class="difflineminus">-        rv = rdf_BlockingWrite(aStream, NS_LITERAL_CSTRING(&quot;&gt;\n&quot;));</span>
<a href="#l41.653"></a><span id="l41.653" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l41.654"></a><span id="l41.654" class="difflineminus">-</span>
<a href="#l41.655"></a><span id="l41.655" class="difflineminus">-        // Now write out resources (which might have their own</span>
<a href="#l41.656"></a><span id="l41.656" class="difflineminus">-        // substructure) as children.</span>
<a href="#l41.657"></a><span id="l41.657" class="difflineminus">-        mDataSource-&gt;ArcLabelsOut(aResource, getter_AddRefs(arcs));</span>
<a href="#l41.658"></a><span id="l41.658" class="difflineminus">-</span>
<a href="#l41.659"></a><span id="l41.659" class="difflineminus">-        if (arcs) {</span>
<a href="#l41.660"></a><span id="l41.660" class="difflineminus">-            // Forget that we've visited anything</span>
<a href="#l41.661"></a><span id="l41.661" class="difflineminus">-            visited.Clear();</span>
<a href="#l41.662"></a><span id="l41.662" class="difflineminus">-            // ... except for rdf:type</span>
<a href="#l41.663"></a><span id="l41.663" class="difflineminus">-            if (isTypedNode)</span>
<a href="#l41.664"></a><span id="l41.664" class="difflineminus">-                visited.AppendElement(kRDF_type);</span>
<a href="#l41.665"></a><span id="l41.665" class="difflineminus">-</span>
<a href="#l41.666"></a><span id="l41.666" class="difflineminus">-            while (1) {</span>
<a href="#l41.667"></a><span id="l41.667" class="difflineminus">-                bool hasMore = false;</span>
<a href="#l41.668"></a><span id="l41.668" class="difflineminus">-                arcs-&gt;HasMoreElements(&amp;hasMore);</span>
<a href="#l41.669"></a><span id="l41.669" class="difflineminus">-                if (! hasMore)</span>
<a href="#l41.670"></a><span id="l41.670" class="difflineminus">-                    break;</span>
<a href="#l41.671"></a><span id="l41.671" class="difflineminus">-</span>
<a href="#l41.672"></a><span id="l41.672" class="difflineminus">-                nsCOMPtr&lt;nsISupports&gt; isupports;</span>
<a href="#l41.673"></a><span id="l41.673" class="difflineminus">-                arcs-&gt;GetNext(getter_AddRefs(isupports));</span>
<a href="#l41.674"></a><span id="l41.674" class="difflineminus">-</span>
<a href="#l41.675"></a><span id="l41.675" class="difflineminus">-                nsCOMPtr&lt;nsIRDFResource&gt; property = do_QueryInterface(isupports);</span>
<a href="#l41.676"></a><span id="l41.676" class="difflineminus">-                if (! property)</span>
<a href="#l41.677"></a><span id="l41.677" class="difflineminus">-                    continue;</span>
<a href="#l41.678"></a><span id="l41.678" class="difflineminus">-</span>
<a href="#l41.679"></a><span id="l41.679" class="difflineminus">-                // Ignore properties that pertain to containers; we may be</span>
<a href="#l41.680"></a><span id="l41.680" class="difflineminus">-                // called from SerializeContainer() if the container</span>
<a href="#l41.681"></a><span id="l41.681" class="difflineminus">-                // resource has been assigned non-container properties.</span>
<a href="#l41.682"></a><span id="l41.682" class="difflineminus">-                if (IsContainerProperty(property))</span>
<a href="#l41.683"></a><span id="l41.683" class="difflineminus">-                    continue;</span>
<a href="#l41.684"></a><span id="l41.684" class="difflineminus">-</span>
<a href="#l41.685"></a><span id="l41.685" class="difflineminus">-                // have we already seen this property?  If so, don't write it</span>
<a href="#l41.686"></a><span id="l41.686" class="difflineminus">-                // out again; serialize property will write each instance.</span>
<a href="#l41.687"></a><span id="l41.687" class="difflineminus">-                if (visited.Contains(property.get()))</span>
<a href="#l41.688"></a><span id="l41.688" class="difflineminus">-                    continue;</span>
<a href="#l41.689"></a><span id="l41.689" class="difflineminus">-</span>
<a href="#l41.690"></a><span id="l41.690" class="difflineminus">-                visited.AppendElement(property.get());</span>
<a href="#l41.691"></a><span id="l41.691" class="difflineminus">-</span>
<a href="#l41.692"></a><span id="l41.692" class="difflineminus">-                SerializeProperty(aStream, aResource, property, false, &amp;skipped);</span>
<a href="#l41.693"></a><span id="l41.693" class="difflineminus">-            }</span>
<a href="#l41.694"></a><span id="l41.694" class="difflineminus">-        }</span>
<a href="#l41.695"></a><span id="l41.695" class="difflineminus">-</span>
<a href="#l41.696"></a><span id="l41.696" class="difflineminus">-        // Emit a proper close-tag.</span>
<a href="#l41.697"></a><span id="l41.697" class="difflineminus">-        if (isTypedNode) {</span>
<a href="#l41.698"></a><span id="l41.698" class="difflineminus">-            rv = rdf_BlockingWrite(aStream,  NS_LITERAL_CSTRING(&quot;  &lt;/&quot;));</span>
<a href="#l41.699"></a><span id="l41.699" class="difflineminus">-            if (NS_FAILED(rv)) return rv;</span>
<a href="#l41.700"></a><span id="l41.700" class="difflineminus">-            // Watch out for the default namespace!</span>
<a href="#l41.701"></a><span id="l41.701" class="difflineminus">-            rdf_BlockingWrite(aStream, typeQName);</span>
<a href="#l41.702"></a><span id="l41.702" class="difflineminus">-            if (NS_FAILED(rv)) return rv;</span>
<a href="#l41.703"></a><span id="l41.703" class="difflineminus">-            rdf_BlockingWrite(aStream, &quot;&gt;\n&quot;, 2);</span>
<a href="#l41.704"></a><span id="l41.704" class="difflineminus">-            if (NS_FAILED(rv)) return rv;</span>
<a href="#l41.705"></a><span id="l41.705" class="difflineminus">-        }</span>
<a href="#l41.706"></a><span id="l41.706" class="difflineminus">-        else {</span>
<a href="#l41.707"></a><span id="l41.707" class="difflineminus">-            rv = rdf_BlockingWrite(aStream, kRDFDescriptionClose,</span>
<a href="#l41.708"></a><span id="l41.708" class="difflineminus">-                                   sizeof(kRDFDescriptionClose) - 1);</span>
<a href="#l41.709"></a><span id="l41.709" class="difflineminus">-            if (NS_FAILED(rv)) return rv;</span>
<a href="#l41.710"></a><span id="l41.710" class="difflineminus">-        }</span>
<a href="#l41.711"></a><span id="l41.711" class="difflineminus">-    }</span>
<a href="#l41.712"></a><span id="l41.712" class="difflineminus">-    else {</span>
<a href="#l41.713"></a><span id="l41.713" class="difflineminus">-        // If we saw _no_ child properties, then we can don't need a</span>
<a href="#l41.714"></a><span id="l41.714" class="difflineminus">-        // close-tag.</span>
<a href="#l41.715"></a><span id="l41.715" class="difflineminus">-        rv = rdf_BlockingWrite(aStream, NS_LITERAL_CSTRING(&quot; /&gt;\n&quot;));</span>
<a href="#l41.716"></a><span id="l41.716" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l41.717"></a><span id="l41.717" class="difflineminus">-    }</span>
<a href="#l41.718"></a><span id="l41.718" class="difflineminus">-</span>
<a href="#l41.719"></a><span id="l41.719" class="difflineminus">-    return NS_OK;</span>
<a href="#l41.720"></a><span id="l41.720" class="difflineminus">-}</span>
<a href="#l41.721"></a><span id="l41.721" class="difflineminus">-</span>
<a href="#l41.722"></a><span id="l41.722" class="difflineminus">-nsresult</span>
<a href="#l41.723"></a><span id="l41.723" class="difflineminus">-nsRDFXMLSerializer::SerializeMember(nsIOutputStream* aStream,</span>
<a href="#l41.724"></a><span id="l41.724" class="difflineminus">-                                      nsIRDFResource* aContainer,</span>
<a href="#l41.725"></a><span id="l41.725" class="difflineminus">-                                      nsIRDFNode* aMember)</span>
<a href="#l41.726"></a><span id="l41.726" class="difflineminus">-{</span>
<a href="#l41.727"></a><span id="l41.727" class="difflineminus">-    // If it's a resource, then output a &quot;&lt;RDF:li RDF:resource=... /&gt;&quot;</span>
<a href="#l41.728"></a><span id="l41.728" class="difflineminus">-    // tag, because we'll be dumping the resource separately. (We</span>
<a href="#l41.729"></a><span id="l41.729" class="difflineminus">-    // iterate thru all the resources in the datasource,</span>
<a href="#l41.730"></a><span id="l41.730" class="difflineminus">-    // remember?) Otherwise, output the literal value.</span>
<a href="#l41.731"></a><span id="l41.731" class="difflineminus">-</span>
<a href="#l41.732"></a><span id="l41.732" class="difflineminus">-    nsCOMPtr&lt;nsIRDFResource&gt; resource;</span>
<a href="#l41.733"></a><span id="l41.733" class="difflineminus">-    nsCOMPtr&lt;nsIRDFLiteral&gt; literal;</span>
<a href="#l41.734"></a><span id="l41.734" class="difflineminus">-    nsCOMPtr&lt;nsIRDFInt&gt; number;</span>
<a href="#l41.735"></a><span id="l41.735" class="difflineminus">-    nsCOMPtr&lt;nsIRDFDate&gt; date;</span>
<a href="#l41.736"></a><span id="l41.736" class="difflineminus">-</span>
<a href="#l41.737"></a><span id="l41.737" class="difflineminus">-static const char kRDFLIOpen[] = &quot;    &lt;RDF:li&quot;;</span>
<a href="#l41.738"></a><span id="l41.738" class="difflineminus">-    nsresult rv = rdf_BlockingWrite(aStream, kRDFLIOpen,</span>
<a href="#l41.739"></a><span id="l41.739" class="difflineminus">-                                    sizeof(kRDFLIOpen) - 1);</span>
<a href="#l41.740"></a><span id="l41.740" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l41.741"></a><span id="l41.741" class="difflineminus">-</span>
<a href="#l41.742"></a><span id="l41.742" class="difflineminus">-    if ((resource = do_QueryInterface(aMember)) != nullptr) {</span>
<a href="#l41.743"></a><span id="l41.743" class="difflineminus">-        nsAutoCString uri;</span>
<a href="#l41.744"></a><span id="l41.744" class="difflineminus">-        resource-&gt;GetValueUTF8(uri);</span>
<a href="#l41.745"></a><span id="l41.745" class="difflineminus">-</span>
<a href="#l41.746"></a><span id="l41.746" class="difflineminus">-        rdf_MakeRelativeRef(mBaseURLSpec, uri);</span>
<a href="#l41.747"></a><span id="l41.747" class="difflineminus">-        rdf_EscapeAttributeValue(uri);</span>
<a href="#l41.748"></a><span id="l41.748" class="difflineminus">-</span>
<a href="#l41.749"></a><span id="l41.749" class="difflineminus">-        rv = rdf_BlockingWrite(aStream, kRDFResource1,</span>
<a href="#l41.750"></a><span id="l41.750" class="difflineminus">-                               sizeof(kRDFResource1) - 1);</span>
<a href="#l41.751"></a><span id="l41.751" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l41.752"></a><span id="l41.752" class="difflineminus">-        rv = rdf_BlockingWrite(aStream, uri);</span>
<a href="#l41.753"></a><span id="l41.753" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l41.754"></a><span id="l41.754" class="difflineminus">-        rv = rdf_BlockingWrite(aStream, kRDFResource2,</span>
<a href="#l41.755"></a><span id="l41.755" class="difflineminus">-                               sizeof(kRDFResource2) - 1);</span>
<a href="#l41.756"></a><span id="l41.756" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l41.757"></a><span id="l41.757" class="difflineminus">-</span>
<a href="#l41.758"></a><span id="l41.758" class="difflineminus">-        goto no_close_tag;</span>
<a href="#l41.759"></a><span id="l41.759" class="difflineminus">-    }</span>
<a href="#l41.760"></a><span id="l41.760" class="difflineminus">-    else if ((literal = do_QueryInterface(aMember)) != nullptr) {</span>
<a href="#l41.761"></a><span id="l41.761" class="difflineminus">-        const char16_t *value;</span>
<a href="#l41.762"></a><span id="l41.762" class="difflineminus">-        literal-&gt;GetValueConst(&amp;value);</span>
<a href="#l41.763"></a><span id="l41.763" class="difflineminus">-static const char kRDFLIOpenGT[] = &quot;&gt;&quot;;</span>
<a href="#l41.764"></a><span id="l41.764" class="difflineminus">-        // close the '&lt;RDF:LI' before adding the literal</span>
<a href="#l41.765"></a><span id="l41.765" class="difflineminus">-        rv = rdf_BlockingWrite(aStream, kRDFLIOpenGT,</span>
<a href="#l41.766"></a><span id="l41.766" class="difflineminus">-                               sizeof(kRDFLIOpenGT) - 1);</span>
<a href="#l41.767"></a><span id="l41.767" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l41.768"></a><span id="l41.768" class="difflineminus">-</span>
<a href="#l41.769"></a><span id="l41.769" class="difflineminus">-        NS_ConvertUTF16toUTF8 s(value);</span>
<a href="#l41.770"></a><span id="l41.770" class="difflineminus">-        rdf_EscapeAmpersandsAndAngleBrackets(s);</span>
<a href="#l41.771"></a><span id="l41.771" class="difflineminus">-</span>
<a href="#l41.772"></a><span id="l41.772" class="difflineminus">-        rv = rdf_BlockingWrite(aStream, s);</span>
<a href="#l41.773"></a><span id="l41.773" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l41.774"></a><span id="l41.774" class="difflineminus">-    }</span>
<a href="#l41.775"></a><span id="l41.775" class="difflineminus">-    else if ((number = do_QueryInterface(aMember)) != nullptr) {</span>
<a href="#l41.776"></a><span id="l41.776" class="difflineminus">-        int32_t value;</span>
<a href="#l41.777"></a><span id="l41.777" class="difflineminus">-        number-&gt;GetValue(&amp;value);</span>
<a href="#l41.778"></a><span id="l41.778" class="difflineminus">-</span>
<a href="#l41.779"></a><span id="l41.779" class="difflineminus">-        nsAutoCString n;</span>
<a href="#l41.780"></a><span id="l41.780" class="difflineminus">-        n.AppendInt(value);</span>
<a href="#l41.781"></a><span id="l41.781" class="difflineminus">-</span>
<a href="#l41.782"></a><span id="l41.782" class="difflineminus">-        rv = rdf_BlockingWrite(aStream, kRDFParseTypeInteger,</span>
<a href="#l41.783"></a><span id="l41.783" class="difflineminus">-                               sizeof(kRDFParseTypeInteger) - 1);</span>
<a href="#l41.784"></a><span id="l41.784" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l41.785"></a><span id="l41.785" class="difflineminus">-        rv = rdf_BlockingWrite(aStream, n);</span>
<a href="#l41.786"></a><span id="l41.786" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l41.787"></a><span id="l41.787" class="difflineminus">-    }</span>
<a href="#l41.788"></a><span id="l41.788" class="difflineminus">-    else if ((date = do_QueryInterface(aMember)) != nullptr) {</span>
<a href="#l41.789"></a><span id="l41.789" class="difflineminus">-        PRTime value;</span>
<a href="#l41.790"></a><span id="l41.790" class="difflineminus">-        date-&gt;GetValue(&amp;value);</span>
<a href="#l41.791"></a><span id="l41.791" class="difflineminus">-</span>
<a href="#l41.792"></a><span id="l41.792" class="difflineminus">-        nsAutoCString s;</span>
<a href="#l41.793"></a><span id="l41.793" class="difflineminus">-        rdf_FormatDate(value, s);</span>
<a href="#l41.794"></a><span id="l41.794" class="difflineminus">-</span>
<a href="#l41.795"></a><span id="l41.795" class="difflineminus">-        rv = rdf_BlockingWrite(aStream, kRDFParseTypeDate,</span>
<a href="#l41.796"></a><span id="l41.796" class="difflineminus">-                               sizeof(kRDFParseTypeDate) - 1);</span>
<a href="#l41.797"></a><span id="l41.797" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l41.798"></a><span id="l41.798" class="difflineminus">-        rv = rdf_BlockingWrite(aStream, s);</span>
<a href="#l41.799"></a><span id="l41.799" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l41.800"></a><span id="l41.800" class="difflineminus">-    }</span>
<a href="#l41.801"></a><span id="l41.801" class="difflineminus">-    else {</span>
<a href="#l41.802"></a><span id="l41.802" class="difflineminus">-        // XXX it doesn't support nsIRDFResource _or_ nsIRDFLiteral???</span>
<a href="#l41.803"></a><span id="l41.803" class="difflineminus">-        // We should serialize nsIRDFInt, nsIRDFDate, etc...</span>
<a href="#l41.804"></a><span id="l41.804" class="difflineminus">-        NS_WARNING(&quot;unknown RDF node type&quot;);</span>
<a href="#l41.805"></a><span id="l41.805" class="difflineminus">-</span>
<a href="#l41.806"></a><span id="l41.806" class="difflineminus">-        rv = rdf_BlockingWrite(aStream, kRDFUnknown, sizeof(kRDFUnknown) - 1);</span>
<a href="#l41.807"></a><span id="l41.807" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l41.808"></a><span id="l41.808" class="difflineminus">-    }</span>
<a href="#l41.809"></a><span id="l41.809" class="difflineminus">-</span>
<a href="#l41.810"></a><span id="l41.810" class="difflineminus">-    {</span>
<a href="#l41.811"></a><span id="l41.811" class="difflineminus">-static const char kRDFLIClose[] = &quot;&lt;/RDF:li&gt;\n&quot;;</span>
<a href="#l41.812"></a><span id="l41.812" class="difflineminus">-        rv = rdf_BlockingWrite(aStream, kRDFLIClose, sizeof(kRDFLIClose) - 1);</span>
<a href="#l41.813"></a><span id="l41.813" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l41.814"></a><span id="l41.814" class="difflineminus">-    }</span>
<a href="#l41.815"></a><span id="l41.815" class="difflineminus">-</span>
<a href="#l41.816"></a><span id="l41.816" class="difflineminus">- no_close_tag:</span>
<a href="#l41.817"></a><span id="l41.817" class="difflineminus">-    return NS_OK;</span>
<a href="#l41.818"></a><span id="l41.818" class="difflineminus">-}</span>
<a href="#l41.819"></a><span id="l41.819" class="difflineminus">-</span>
<a href="#l41.820"></a><span id="l41.820" class="difflineminus">-</span>
<a href="#l41.821"></a><span id="l41.821" class="difflineminus">-nsresult</span>
<a href="#l41.822"></a><span id="l41.822" class="difflineminus">-nsRDFXMLSerializer::SerializeContainer(nsIOutputStream* aStream,</span>
<a href="#l41.823"></a><span id="l41.823" class="difflineminus">-                                         nsIRDFResource* aContainer)</span>
<a href="#l41.824"></a><span id="l41.824" class="difflineminus">-{</span>
<a href="#l41.825"></a><span id="l41.825" class="difflineminus">-    nsresult rv;</span>
<a href="#l41.826"></a><span id="l41.826" class="difflineminus">-    nsAutoCString tag;</span>
<a href="#l41.827"></a><span id="l41.827" class="difflineminus">-</span>
<a href="#l41.828"></a><span id="l41.828" class="difflineminus">-    // Decide if it's a sequence, bag, or alternation, and print the</span>
<a href="#l41.829"></a><span id="l41.829" class="difflineminus">-    // appropriate tag-open sequence</span>
<a href="#l41.830"></a><span id="l41.830" class="difflineminus">-</span>
<a href="#l41.831"></a><span id="l41.831" class="difflineminus">-    if (IsA(mDataSource, aContainer, kRDF_Bag)) {</span>
<a href="#l41.832"></a><span id="l41.832" class="difflineminus">-        tag.AssignLiteral(&quot;RDF:Bag&quot;);</span>
<a href="#l41.833"></a><span id="l41.833" class="difflineminus">-    }</span>
<a href="#l41.834"></a><span id="l41.834" class="difflineminus">-    else if (IsA(mDataSource, aContainer, kRDF_Seq)) {</span>
<a href="#l41.835"></a><span id="l41.835" class="difflineminus">-        tag.AssignLiteral(&quot;RDF:Seq&quot;);</span>
<a href="#l41.836"></a><span id="l41.836" class="difflineminus">-    }</span>
<a href="#l41.837"></a><span id="l41.837" class="difflineminus">-    else if (IsA(mDataSource, aContainer, kRDF_Alt)) {</span>
<a href="#l41.838"></a><span id="l41.838" class="difflineminus">-        tag.AssignLiteral(&quot;RDF:Alt&quot;);</span>
<a href="#l41.839"></a><span id="l41.839" class="difflineminus">-    }</span>
<a href="#l41.840"></a><span id="l41.840" class="difflineminus">-    else {</span>
<a href="#l41.841"></a><span id="l41.841" class="difflineminus">-        NS_ASSERTION(false, &quot;huh? this is _not_ a container.&quot;);</span>
<a href="#l41.842"></a><span id="l41.842" class="difflineminus">-        return NS_ERROR_UNEXPECTED;</span>
<a href="#l41.843"></a><span id="l41.843" class="difflineminus">-    }</span>
<a href="#l41.844"></a><span id="l41.844" class="difflineminus">-</span>
<a href="#l41.845"></a><span id="l41.845" class="difflineminus">-    rv = rdf_BlockingWrite(aStream, &quot;  &lt;&quot;, 3);</span>
<a href="#l41.846"></a><span id="l41.846" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l41.847"></a><span id="l41.847" class="difflineminus">-    rv = rdf_BlockingWrite(aStream, tag);</span>
<a href="#l41.848"></a><span id="l41.848" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l41.849"></a><span id="l41.849" class="difflineminus">-</span>
<a href="#l41.850"></a><span id="l41.850" class="difflineminus">-</span>
<a href="#l41.851"></a><span id="l41.851" class="difflineminus">-    // Unfortunately, we always need to print out the identity of the</span>
<a href="#l41.852"></a><span id="l41.852" class="difflineminus">-    // resource, even if was constructed &quot;anonymously&quot;. We need to do</span>
<a href="#l41.853"></a><span id="l41.853" class="difflineminus">-    // this because we never really know who else might be referring</span>
<a href="#l41.854"></a><span id="l41.854" class="difflineminus">-    // to it...</span>
<a href="#l41.855"></a><span id="l41.855" class="difflineminus">-</span>
<a href="#l41.856"></a><span id="l41.856" class="difflineminus">-    nsAutoCString uri;</span>
<a href="#l41.857"></a><span id="l41.857" class="difflineminus">-    if (NS_SUCCEEDED(aContainer-&gt;GetValueUTF8(uri))) {</span>
<a href="#l41.858"></a><span id="l41.858" class="difflineminus">-        rdf_MakeRelativeRef(mBaseURLSpec, uri);</span>
<a href="#l41.859"></a><span id="l41.859" class="difflineminus">-</span>
<a href="#l41.860"></a><span id="l41.860" class="difflineminus">-        rdf_EscapeAttributeValue(uri);</span>
<a href="#l41.861"></a><span id="l41.861" class="difflineminus">-</span>
<a href="#l41.862"></a><span id="l41.862" class="difflineminus">-        if (uri.First() == '#') {</span>
<a href="#l41.863"></a><span id="l41.863" class="difflineminus">-            // Okay, it's actually identified as an element in the</span>
<a href="#l41.864"></a><span id="l41.864" class="difflineminus">-            // current document, not trying to decorate some absolute</span>
<a href="#l41.865"></a><span id="l41.865" class="difflineminus">-            // URI. We can use the 'ID=' attribute...</span>
<a href="#l41.866"></a><span id="l41.866" class="difflineminus">-</span>
<a href="#l41.867"></a><span id="l41.867" class="difflineminus">-            uri.Cut(0, 1); // chop the '#'</span>
<a href="#l41.868"></a><span id="l41.868" class="difflineminus">-            rv = rdf_BlockingWrite(aStream, kIDAttr, sizeof(kIDAttr) - 1);</span>
<a href="#l41.869"></a><span id="l41.869" class="difflineminus">-            if (NS_FAILED(rv)) return rv;</span>
<a href="#l41.870"></a><span id="l41.870" class="difflineminus">-        }</span>
<a href="#l41.871"></a><span id="l41.871" class="difflineminus">-        else {</span>
<a href="#l41.872"></a><span id="l41.872" class="difflineminus">-            // We need to cheat and spit out an illegal 'about=' on</span>
<a href="#l41.873"></a><span id="l41.873" class="difflineminus">-            // the sequence.</span>
<a href="#l41.874"></a><span id="l41.874" class="difflineminus">-            rv = rdf_BlockingWrite(aStream, kAboutAttr,</span>
<a href="#l41.875"></a><span id="l41.875" class="difflineminus">-                                   sizeof(kAboutAttr) - 1);</span>
<a href="#l41.876"></a><span id="l41.876" class="difflineminus">-            if (NS_FAILED(rv)) return rv;</span>
<a href="#l41.877"></a><span id="l41.877" class="difflineminus">-        }</span>
<a href="#l41.878"></a><span id="l41.878" class="difflineminus">-</span>
<a href="#l41.879"></a><span id="l41.879" class="difflineminus">-        rv = rdf_BlockingWrite(aStream, uri);</span>
<a href="#l41.880"></a><span id="l41.880" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l41.881"></a><span id="l41.881" class="difflineminus">-        rv = rdf_BlockingWrite(aStream, &quot;\&quot;&quot;, 1);</span>
<a href="#l41.882"></a><span id="l41.882" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l41.883"></a><span id="l41.883" class="difflineminus">-    }</span>
<a href="#l41.884"></a><span id="l41.884" class="difflineminus">-</span>
<a href="#l41.885"></a><span id="l41.885" class="difflineminus">-    rv = rdf_BlockingWrite(aStream, &quot;&gt;\n&quot;, 2);</span>
<a href="#l41.886"></a><span id="l41.886" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l41.887"></a><span id="l41.887" class="difflineminus">-</span>
<a href="#l41.888"></a><span id="l41.888" class="difflineminus">-    // First iterate through each of the ordinal elements (the RDF/XML</span>
<a href="#l41.889"></a><span id="l41.889" class="difflineminus">-    // syntax doesn't allow us to place properties on RDF container</span>
<a href="#l41.890"></a><span id="l41.890" class="difflineminus">-    // elements).</span>
<a href="#l41.891"></a><span id="l41.891" class="difflineminus">-    nsCOMPtr&lt;nsISimpleEnumerator&gt; elements;</span>
<a href="#l41.892"></a><span id="l41.892" class="difflineminus">-    rv = NS_NewContainerEnumerator(mDataSource, aContainer, getter_AddRefs(elements));</span>
<a href="#l41.893"></a><span id="l41.893" class="difflineminus">-</span>
<a href="#l41.894"></a><span id="l41.894" class="difflineminus">-    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l41.895"></a><span id="l41.895" class="difflineminus">-        while (1) {</span>
<a href="#l41.896"></a><span id="l41.896" class="difflineminus">-            bool hasMore;</span>
<a href="#l41.897"></a><span id="l41.897" class="difflineminus">-            rv = elements-&gt;HasMoreElements(&amp;hasMore);</span>
<a href="#l41.898"></a><span id="l41.898" class="difflineminus">-            if (NS_FAILED(rv)) break;</span>
<a href="#l41.899"></a><span id="l41.899" class="difflineminus">-</span>
<a href="#l41.900"></a><span id="l41.900" class="difflineminus">-            if (! hasMore)</span>
<a href="#l41.901"></a><span id="l41.901" class="difflineminus">-                break;</span>
<a href="#l41.902"></a><span id="l41.902" class="difflineminus">-</span>
<a href="#l41.903"></a><span id="l41.903" class="difflineminus">-            nsCOMPtr&lt;nsISupports&gt; isupports;</span>
<a href="#l41.904"></a><span id="l41.904" class="difflineminus">-            elements-&gt;GetNext(getter_AddRefs(isupports));</span>
<a href="#l41.905"></a><span id="l41.905" class="difflineminus">-</span>
<a href="#l41.906"></a><span id="l41.906" class="difflineminus">-            nsCOMPtr&lt;nsIRDFNode&gt; element = do_QueryInterface(isupports);</span>
<a href="#l41.907"></a><span id="l41.907" class="difflineminus">-            NS_ASSERTION(element != nullptr, &quot;not an nsIRDFNode&quot;);</span>
<a href="#l41.908"></a><span id="l41.908" class="difflineminus">-            if (! element)</span>
<a href="#l41.909"></a><span id="l41.909" class="difflineminus">-                continue;</span>
<a href="#l41.910"></a><span id="l41.910" class="difflineminus">-</span>
<a href="#l41.911"></a><span id="l41.911" class="difflineminus">-            SerializeMember(aStream, aContainer, element);</span>
<a href="#l41.912"></a><span id="l41.912" class="difflineminus">-        }</span>
<a href="#l41.913"></a><span id="l41.913" class="difflineminus">-    }</span>
<a href="#l41.914"></a><span id="l41.914" class="difflineminus">-</span>
<a href="#l41.915"></a><span id="l41.915" class="difflineminus">-    // close the container tag</span>
<a href="#l41.916"></a><span id="l41.916" class="difflineminus">-    rv = rdf_BlockingWrite(aStream, &quot;  &lt;/&quot;, 4);</span>
<a href="#l41.917"></a><span id="l41.917" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l41.918"></a><span id="l41.918" class="difflineminus">-    tag.Append(&quot;&gt;\n&quot;, 2);</span>
<a href="#l41.919"></a><span id="l41.919" class="difflineminus">-    rv = rdf_BlockingWrite(aStream, tag);</span>
<a href="#l41.920"></a><span id="l41.920" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l41.921"></a><span id="l41.921" class="difflineminus">-</span>
<a href="#l41.922"></a><span id="l41.922" class="difflineminus">-    // Now, we iterate through _all_ of the arcs, in case someone has</span>
<a href="#l41.923"></a><span id="l41.923" class="difflineminus">-    // applied properties to the bag itself. These'll be placed in a</span>
<a href="#l41.924"></a><span id="l41.924" class="difflineminus">-    // separate RDF:Description element.</span>
<a href="#l41.925"></a><span id="l41.925" class="difflineminus">-    nsCOMPtr&lt;nsISimpleEnumerator&gt; arcs;</span>
<a href="#l41.926"></a><span id="l41.926" class="difflineminus">-    mDataSource-&gt;ArcLabelsOut(aContainer, getter_AddRefs(arcs));</span>
<a href="#l41.927"></a><span id="l41.927" class="difflineminus">-</span>
<a href="#l41.928"></a><span id="l41.928" class="difflineminus">-    bool wroteDescription = false;</span>
<a href="#l41.929"></a><span id="l41.929" class="difflineminus">-    while (! wroteDescription) {</span>
<a href="#l41.930"></a><span id="l41.930" class="difflineminus">-        bool hasMore = false;</span>
<a href="#l41.931"></a><span id="l41.931" class="difflineminus">-        rv = arcs-&gt;HasMoreElements(&amp;hasMore);</span>
<a href="#l41.932"></a><span id="l41.932" class="difflineminus">-        if (NS_FAILED(rv)) break;</span>
<a href="#l41.933"></a><span id="l41.933" class="difflineminus">-</span>
<a href="#l41.934"></a><span id="l41.934" class="difflineminus">-        if (! hasMore)</span>
<a href="#l41.935"></a><span id="l41.935" class="difflineminus">-            break;</span>
<a href="#l41.936"></a><span id="l41.936" class="difflineminus">-</span>
<a href="#l41.937"></a><span id="l41.937" class="difflineminus">-        nsIRDFResource* property;</span>
<a href="#l41.938"></a><span id="l41.938" class="difflineminus">-        rv = arcs-&gt;GetNext((nsISupports**) &amp;property);</span>
<a href="#l41.939"></a><span id="l41.939" class="difflineminus">-        if (NS_FAILED(rv)) break;</span>
<a href="#l41.940"></a><span id="l41.940" class="difflineminus">-</span>
<a href="#l41.941"></a><span id="l41.941" class="difflineminus">-        // If it's a membership property, then output a &quot;LI&quot;</span>
<a href="#l41.942"></a><span id="l41.942" class="difflineminus">-        // tag. Otherwise, output a property.</span>
<a href="#l41.943"></a><span id="l41.943" class="difflineminus">-        if (! IsContainerProperty(property)) {</span>
<a href="#l41.944"></a><span id="l41.944" class="difflineminus">-            rv = SerializeDescription(aStream, aContainer);</span>
<a href="#l41.945"></a><span id="l41.945" class="difflineminus">-            wroteDescription = true;</span>
<a href="#l41.946"></a><span id="l41.946" class="difflineminus">-        }</span>
<a href="#l41.947"></a><span id="l41.947" class="difflineminus">-</span>
<a href="#l41.948"></a><span id="l41.948" class="difflineminus">-        NS_RELEASE(property);</span>
<a href="#l41.949"></a><span id="l41.949" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l41.950"></a><span id="l41.950" class="difflineminus">-            break;</span>
<a href="#l41.951"></a><span id="l41.951" class="difflineminus">-    }</span>
<a href="#l41.952"></a><span id="l41.952" class="difflineminus">-</span>
<a href="#l41.953"></a><span id="l41.953" class="difflineminus">-    return NS_OK;</span>
<a href="#l41.954"></a><span id="l41.954" class="difflineminus">-}</span>
<a href="#l41.955"></a><span id="l41.955" class="difflineminus">-</span>
<a href="#l41.956"></a><span id="l41.956" class="difflineminus">-</span>
<a href="#l41.957"></a><span id="l41.957" class="difflineminus">-nsresult</span>
<a href="#l41.958"></a><span id="l41.958" class="difflineminus">-nsRDFXMLSerializer::SerializePrologue(nsIOutputStream* aStream)</span>
<a href="#l41.959"></a><span id="l41.959" class="difflineminus">-{</span>
<a href="#l41.960"></a><span id="l41.960" class="difflineminus">-static const char kXMLVersion[] = &quot;&lt;?xml version=\&quot;1.0\&quot;?&gt;\n&quot;;</span>
<a href="#l41.961"></a><span id="l41.961" class="difflineminus">-</span>
<a href="#l41.962"></a><span id="l41.962" class="difflineminus">-    nsresult rv;</span>
<a href="#l41.963"></a><span id="l41.963" class="difflineminus">-    rv = rdf_BlockingWrite(aStream, kXMLVersion, sizeof(kXMLVersion) - 1);</span>
<a href="#l41.964"></a><span id="l41.964" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l41.965"></a><span id="l41.965" class="difflineminus">-</span>
<a href="#l41.966"></a><span id="l41.966" class="difflineminus">-    // global name space declarations</span>
<a href="#l41.967"></a><span id="l41.967" class="difflineminus">-    rv = rdf_BlockingWrite(aStream, NS_LITERAL_CSTRING(&quot;&lt;RDF:RDF &quot;));</span>
<a href="#l41.968"></a><span id="l41.968" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l41.969"></a><span id="l41.969" class="difflineminus">-</span>
<a href="#l41.970"></a><span id="l41.970" class="difflineminus">-    nsNameSpaceMap::const_iterator first = mNameSpaces.first();</span>
<a href="#l41.971"></a><span id="l41.971" class="difflineminus">-    nsNameSpaceMap::const_iterator last = mNameSpaces.last();</span>
<a href="#l41.972"></a><span id="l41.972" class="difflineminus">-    for (nsNameSpaceMap::const_iterator entry = first; entry != last; ++entry) {</span>
<a href="#l41.973"></a><span id="l41.973" class="difflineminus">-        if (entry != first) {</span>
<a href="#l41.974"></a><span id="l41.974" class="difflineminus">-            rv = rdf_BlockingWrite(aStream, NS_LITERAL_CSTRING(&quot;\n         &quot;));</span>
<a href="#l41.975"></a><span id="l41.975" class="difflineminus">-            if (NS_FAILED(rv)) return rv;</span>
<a href="#l41.976"></a><span id="l41.976" class="difflineminus">-        }</span>
<a href="#l41.977"></a><span id="l41.977" class="difflineminus">-        rv = rdf_BlockingWrite(aStream, NS_LITERAL_CSTRING(&quot;xmlns&quot;));</span>
<a href="#l41.978"></a><span id="l41.978" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l41.979"></a><span id="l41.979" class="difflineminus">-</span>
<a href="#l41.980"></a><span id="l41.980" class="difflineminus">-        if (entry-&gt;mPrefix) {</span>
<a href="#l41.981"></a><span id="l41.981" class="difflineminus">-            rv = rdf_BlockingWrite(aStream, NS_LITERAL_CSTRING(&quot;:&quot;));</span>
<a href="#l41.982"></a><span id="l41.982" class="difflineminus">-            if (NS_FAILED(rv)) return rv;</span>
<a href="#l41.983"></a><span id="l41.983" class="difflineminus">-            nsAutoCString prefix;</span>
<a href="#l41.984"></a><span id="l41.984" class="difflineminus">-            entry-&gt;mPrefix-&gt;ToUTF8String(prefix);</span>
<a href="#l41.985"></a><span id="l41.985" class="difflineminus">-            rv = rdf_BlockingWrite(aStream, prefix);</span>
<a href="#l41.986"></a><span id="l41.986" class="difflineminus">-            if (NS_FAILED(rv)) return rv;</span>
<a href="#l41.987"></a><span id="l41.987" class="difflineminus">-        }</span>
<a href="#l41.988"></a><span id="l41.988" class="difflineminus">-</span>
<a href="#l41.989"></a><span id="l41.989" class="difflineminus">-        rv = rdf_BlockingWrite(aStream, NS_LITERAL_CSTRING(&quot;=\&quot;&quot;));</span>
<a href="#l41.990"></a><span id="l41.990" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l41.991"></a><span id="l41.991" class="difflineminus">-        nsAutoCString uri(entry-&gt;mURI);</span>
<a href="#l41.992"></a><span id="l41.992" class="difflineminus">-        rdf_EscapeAttributeValue(uri);</span>
<a href="#l41.993"></a><span id="l41.993" class="difflineminus">-        rv = rdf_BlockingWrite(aStream, uri);</span>
<a href="#l41.994"></a><span id="l41.994" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l41.995"></a><span id="l41.995" class="difflineminus">-        rv = rdf_BlockingWrite(aStream, NS_LITERAL_CSTRING(&quot;\&quot;&quot;));</span>
<a href="#l41.996"></a><span id="l41.996" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l41.997"></a><span id="l41.997" class="difflineminus">-    }</span>
<a href="#l41.998"></a><span id="l41.998" class="difflineminus">-</span>
<a href="#l41.999"></a><span id="l41.999" class="difflineminus">-    return rdf_BlockingWrite(aStream, NS_LITERAL_CSTRING(&quot;&gt;\n&quot;));</span>
<a href="#l41.1000"></a><span id="l41.1000" class="difflineminus">-}</span>
<a href="#l41.1001"></a><span id="l41.1001" class="difflineminus">-</span>
<a href="#l41.1002"></a><span id="l41.1002" class="difflineminus">-</span>
<a href="#l41.1003"></a><span id="l41.1003" class="difflineminus">-nsresult</span>
<a href="#l41.1004"></a><span id="l41.1004" class="difflineminus">-nsRDFXMLSerializer::SerializeEpilogue(nsIOutputStream* aStream)</span>
<a href="#l41.1005"></a><span id="l41.1005" class="difflineminus">-{</span>
<a href="#l41.1006"></a><span id="l41.1006" class="difflineminus">-    return rdf_BlockingWrite(aStream, NS_LITERAL_CSTRING(&quot;&lt;/RDF:RDF&gt;\n&quot;));</span>
<a href="#l41.1007"></a><span id="l41.1007" class="difflineminus">-}</span>
<a href="#l41.1008"></a><span id="l41.1008" class="difflineminus">-</span>
<a href="#l41.1009"></a><span id="l41.1009" class="difflineminus">-class QNameCollector final : public rdfITripleVisitor {</span>
<a href="#l41.1010"></a><span id="l41.1010" class="difflineminus">-public:</span>
<a href="#l41.1011"></a><span id="l41.1011" class="difflineminus">-    NS_DECL_ISUPPORTS</span>
<a href="#l41.1012"></a><span id="l41.1012" class="difflineminus">-    NS_DECL_RDFITRIPLEVISITOR</span>
<a href="#l41.1013"></a><span id="l41.1013" class="difflineminus">-    explicit QNameCollector(nsRDFXMLSerializer* aParent)</span>
<a href="#l41.1014"></a><span id="l41.1014" class="difflineminus">-        : mParent(aParent){}</span>
<a href="#l41.1015"></a><span id="l41.1015" class="difflineminus">-private:</span>
<a href="#l41.1016"></a><span id="l41.1016" class="difflineminus">-    ~QNameCollector() {}</span>
<a href="#l41.1017"></a><span id="l41.1017" class="difflineminus">-    nsRDFXMLSerializer* mParent;</span>
<a href="#l41.1018"></a><span id="l41.1018" class="difflineminus">-};</span>
<a href="#l41.1019"></a><span id="l41.1019" class="difflineminus">-</span>
<a href="#l41.1020"></a><span id="l41.1020" class="difflineminus">-NS_IMPL_ISUPPORTS(QNameCollector, rdfITripleVisitor)</span>
<a href="#l41.1021"></a><span id="l41.1021" class="difflineminus">-nsresult</span>
<a href="#l41.1022"></a><span id="l41.1022" class="difflineminus">-QNameCollector::Visit(nsIRDFNode* aSubject, nsIRDFResource* aPredicate,</span>
<a href="#l41.1023"></a><span id="l41.1023" class="difflineminus">-                      nsIRDFNode* aObject, bool aTruthValue)</span>
<a href="#l41.1024"></a><span id="l41.1024" class="difflineminus">-{</span>
<a href="#l41.1025"></a><span id="l41.1025" class="difflineminus">-    if (aPredicate == nsRDFXMLSerializer::kRDF_type) {</span>
<a href="#l41.1026"></a><span id="l41.1026" class="difflineminus">-        // try to get a type QName for aObject, should be a resource</span>
<a href="#l41.1027"></a><span id="l41.1027" class="difflineminus">-        nsCOMPtr&lt;nsIRDFResource&gt; resType = do_QueryInterface(aObject);</span>
<a href="#l41.1028"></a><span id="l41.1028" class="difflineminus">-        if (!resType) {</span>
<a href="#l41.1029"></a><span id="l41.1029" class="difflineminus">-            // ignore error</span>
<a href="#l41.1030"></a><span id="l41.1030" class="difflineminus">-            return NS_OK;</span>
<a href="#l41.1031"></a><span id="l41.1031" class="difflineminus">-        }</span>
<a href="#l41.1032"></a><span id="l41.1032" class="difflineminus">-        if (mParent-&gt;mQNames.Get(resType, nullptr)) {</span>
<a href="#l41.1033"></a><span id="l41.1033" class="difflineminus">-            return NS_OK;</span>
<a href="#l41.1034"></a><span id="l41.1034" class="difflineminus">-        }</span>
<a href="#l41.1035"></a><span id="l41.1035" class="difflineminus">-        mParent-&gt;RegisterQName(resType);</span>
<a href="#l41.1036"></a><span id="l41.1036" class="difflineminus">-        return NS_OK;</span>
<a href="#l41.1037"></a><span id="l41.1037" class="difflineminus">-    }</span>
<a href="#l41.1038"></a><span id="l41.1038" class="difflineminus">-</span>
<a href="#l41.1039"></a><span id="l41.1039" class="difflineminus">-    if (mParent-&gt;mQNames.Get(aPredicate, nullptr)) {</span>
<a href="#l41.1040"></a><span id="l41.1040" class="difflineminus">-        return NS_OK;</span>
<a href="#l41.1041"></a><span id="l41.1041" class="difflineminus">-    }</span>
<a href="#l41.1042"></a><span id="l41.1042" class="difflineminus">-    if (aPredicate == nsRDFXMLSerializer::kRDF_instanceOf ||</span>
<a href="#l41.1043"></a><span id="l41.1043" class="difflineminus">-        aPredicate == nsRDFXMLSerializer::kRDF_nextVal)</span>
<a href="#l41.1044"></a><span id="l41.1044" class="difflineminus">-        return NS_OK;</span>
<a href="#l41.1045"></a><span id="l41.1045" class="difflineminus">-    bool isOrdinal = false;</span>
<a href="#l41.1046"></a><span id="l41.1046" class="difflineminus">-    nsRDFXMLSerializer::gRDFC-&gt;IsOrdinalProperty(aPredicate, &amp;isOrdinal);</span>
<a href="#l41.1047"></a><span id="l41.1047" class="difflineminus">-    if (isOrdinal)</span>
<a href="#l41.1048"></a><span id="l41.1048" class="difflineminus">-        return NS_OK;</span>
<a href="#l41.1049"></a><span id="l41.1049" class="difflineminus">-</span>
<a href="#l41.1050"></a><span id="l41.1050" class="difflineminus">-    mParent-&gt;RegisterQName(aPredicate);</span>
<a href="#l41.1051"></a><span id="l41.1051" class="difflineminus">-</span>
<a href="#l41.1052"></a><span id="l41.1052" class="difflineminus">-    return NS_OK;</span>
<a href="#l41.1053"></a><span id="l41.1053" class="difflineminus">-}</span>
<a href="#l41.1054"></a><span id="l41.1054" class="difflineminus">-</span>
<a href="#l41.1055"></a><span id="l41.1055" class="difflineminus">-nsresult</span>
<a href="#l41.1056"></a><span id="l41.1056" class="difflineminus">-nsRDFXMLSerializer::CollectNamespaces()</span>
<a href="#l41.1057"></a><span id="l41.1057" class="difflineminus">-{</span>
<a href="#l41.1058"></a><span id="l41.1058" class="difflineminus">-    // Iterate over all Triples to get namespaces for subject resource types</span>
<a href="#l41.1059"></a><span id="l41.1059" class="difflineminus">-    // and Predicates and cache all the QNames we want to use.</span>
<a href="#l41.1060"></a><span id="l41.1060" class="difflineminus">-    nsCOMPtr&lt;rdfITripleVisitor&gt; collector =</span>
<a href="#l41.1061"></a><span id="l41.1061" class="difflineminus">-        new QNameCollector(this);</span>
<a href="#l41.1062"></a><span id="l41.1062" class="difflineminus">-    nsCOMPtr&lt;rdfIDataSource&gt; ds = do_QueryInterface(mDataSource); // XXX API</span>
<a href="#l41.1063"></a><span id="l41.1063" class="difflineminus">-    NS_ENSURE_TRUE(collector &amp;&amp; ds, NS_ERROR_FAILURE);</span>
<a href="#l41.1064"></a><span id="l41.1064" class="difflineminus">-    return ds-&gt;VisitAllTriples(collector);</span>
<a href="#l41.1065"></a><span id="l41.1065" class="difflineminus">-}</span>
<a href="#l41.1066"></a><span id="l41.1066" class="difflineminus">-</span>
<a href="#l41.1067"></a><span id="l41.1067" class="difflineminus">-//----------------------------------------------------------------------</span>
<a href="#l41.1068"></a><span id="l41.1068" class="difflineminus">-</span>
<a href="#l41.1069"></a><span id="l41.1069" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l41.1070"></a><span id="l41.1070" class="difflineminus">-nsRDFXMLSerializer::Serialize(nsIOutputStream* aStream)</span>
<a href="#l41.1071"></a><span id="l41.1071" class="difflineminus">-{</span>
<a href="#l41.1072"></a><span id="l41.1072" class="difflineminus">-    nsresult rv;</span>
<a href="#l41.1073"></a><span id="l41.1073" class="difflineminus">-</span>
<a href="#l41.1074"></a><span id="l41.1074" class="difflineminus">-    rv = CollectNamespaces();</span>
<a href="#l41.1075"></a><span id="l41.1075" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l41.1076"></a><span id="l41.1076" class="difflineminus">-</span>
<a href="#l41.1077"></a><span id="l41.1077" class="difflineminus">-    nsCOMPtr&lt;nsISimpleEnumerator&gt; resources;</span>
<a href="#l41.1078"></a><span id="l41.1078" class="difflineminus">-    rv = mDataSource-&gt;GetAllResources(getter_AddRefs(resources));</span>
<a href="#l41.1079"></a><span id="l41.1079" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l41.1080"></a><span id="l41.1080" class="difflineminus">-</span>
<a href="#l41.1081"></a><span id="l41.1081" class="difflineminus">-    rv = SerializePrologue(aStream);</span>
<a href="#l41.1082"></a><span id="l41.1082" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l41.1083"></a><span id="l41.1083" class="difflineminus">-        return rv;</span>
<a href="#l41.1084"></a><span id="l41.1084" class="difflineminus">-</span>
<a href="#l41.1085"></a><span id="l41.1085" class="difflineminus">-    while (1) {</span>
<a href="#l41.1086"></a><span id="l41.1086" class="difflineminus">-        bool hasMore = false;</span>
<a href="#l41.1087"></a><span id="l41.1087" class="difflineminus">-        resources-&gt;HasMoreElements(&amp;hasMore);</span>
<a href="#l41.1088"></a><span id="l41.1088" class="difflineminus">-        if (! hasMore)</span>
<a href="#l41.1089"></a><span id="l41.1089" class="difflineminus">-            break;</span>
<a href="#l41.1090"></a><span id="l41.1090" class="difflineminus">-</span>
<a href="#l41.1091"></a><span id="l41.1091" class="difflineminus">-        nsCOMPtr&lt;nsISupports&gt; isupports;</span>
<a href="#l41.1092"></a><span id="l41.1092" class="difflineminus">-        resources-&gt;GetNext(getter_AddRefs(isupports));</span>
<a href="#l41.1093"></a><span id="l41.1093" class="difflineminus">-</span>
<a href="#l41.1094"></a><span id="l41.1094" class="difflineminus">-        nsCOMPtr&lt;nsIRDFResource&gt; resource = do_QueryInterface(isupports);</span>
<a href="#l41.1095"></a><span id="l41.1095" class="difflineminus">-        if (! resource)</span>
<a href="#l41.1096"></a><span id="l41.1096" class="difflineminus">-            continue;</span>
<a href="#l41.1097"></a><span id="l41.1097" class="difflineminus">-</span>
<a href="#l41.1098"></a><span id="l41.1098" class="difflineminus">-        if (IsA(mDataSource, resource, kRDF_Bag) ||</span>
<a href="#l41.1099"></a><span id="l41.1099" class="difflineminus">-            IsA(mDataSource, resource, kRDF_Seq) ||</span>
<a href="#l41.1100"></a><span id="l41.1100" class="difflineminus">-            IsA(mDataSource, resource, kRDF_Alt)) {</span>
<a href="#l41.1101"></a><span id="l41.1101" class="difflineminus">-            rv = SerializeContainer(aStream, resource);</span>
<a href="#l41.1102"></a><span id="l41.1102" class="difflineminus">-        }</span>
<a href="#l41.1103"></a><span id="l41.1103" class="difflineminus">-        else {</span>
<a href="#l41.1104"></a><span id="l41.1104" class="difflineminus">-            rv = SerializeDescription(aStream, resource);</span>
<a href="#l41.1105"></a><span id="l41.1105" class="difflineminus">-        }</span>
<a href="#l41.1106"></a><span id="l41.1106" class="difflineminus">-</span>
<a href="#l41.1107"></a><span id="l41.1107" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l41.1108"></a><span id="l41.1108" class="difflineminus">-            break;</span>
<a href="#l41.1109"></a><span id="l41.1109" class="difflineminus">-    }</span>
<a href="#l41.1110"></a><span id="l41.1110" class="difflineminus">-</span>
<a href="#l41.1111"></a><span id="l41.1111" class="difflineminus">-    rv = SerializeEpilogue(aStream);</span>
<a href="#l41.1112"></a><span id="l41.1112" class="difflineminus">-</span>
<a href="#l41.1113"></a><span id="l41.1113" class="difflineminus">-    return rv;</span>
<a href="#l41.1114"></a><span id="l41.1114" class="difflineminus">-}</span>
<a href="#l41.1115"></a><span id="l41.1115" class="difflineminus">-</span>
<a href="#l41.1116"></a><span id="l41.1116" class="difflineminus">-</span>
<a href="#l41.1117"></a><span id="l41.1117" class="difflineminus">-bool</span>
<a href="#l41.1118"></a><span id="l41.1118" class="difflineminus">-nsRDFXMLSerializer::IsA(nsIRDFDataSource* aDataSource, nsIRDFResource* aResource, nsIRDFResource* aType)</span>
<a href="#l41.1119"></a><span id="l41.1119" class="difflineminus">-{</span>
<a href="#l41.1120"></a><span id="l41.1120" class="difflineminus">-    nsresult rv;</span>
<a href="#l41.1121"></a><span id="l41.1121" class="difflineminus">-</span>
<a href="#l41.1122"></a><span id="l41.1122" class="difflineminus">-    bool result;</span>
<a href="#l41.1123"></a><span id="l41.1123" class="difflineminus">-    rv = aDataSource-&gt;HasAssertion(aResource, kRDF_instanceOf, aType, true, &amp;result);</span>
<a href="#l41.1124"></a><span id="l41.1124" class="difflineminus">-    if (NS_FAILED(rv)) return false;</span>
<a href="#l41.1125"></a><span id="l41.1125" class="difflineminus">-</span>
<a href="#l41.1126"></a><span id="l41.1126" class="difflineminus">-    return result;</span>
<a href="#l41.1127"></a><span id="l41.1127" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l42.1"></a><span id="l42.1">deleted file mode 100644</span>
<a href="#l42.2"></a><span id="l42.2" class="difflineminus">--- a/rdf/base/nsRDFXMLSerializer.h</span>
<a href="#l42.3"></a><span id="l42.3" class="difflineplus">+++ /dev/null</span>
<a href="#l42.4"></a><span id="l42.4" class="difflineat">@@ -1,117 +0,0 @@</span>
<a href="#l42.5"></a><span id="l42.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*-</span>
<a href="#l42.6"></a><span id="l42.6" class="difflineminus">- *</span>
<a href="#l42.7"></a><span id="l42.7" class="difflineminus">- * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l42.8"></a><span id="l42.8" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l42.9"></a><span id="l42.9" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l42.10"></a><span id="l42.10" class="difflineminus">-</span>
<a href="#l42.11"></a><span id="l42.11" class="difflineminus">-#ifndef nsRDFXMLSerializer_h__</span>
<a href="#l42.12"></a><span id="l42.12" class="difflineminus">-#define nsRDFXMLSerializer_h__</span>
<a href="#l42.13"></a><span id="l42.13" class="difflineminus">-</span>
<a href="#l42.14"></a><span id="l42.14" class="difflineminus">-#include &quot;nsIRDFLiteral.h&quot;</span>
<a href="#l42.15"></a><span id="l42.15" class="difflineminus">-#include &quot;nsIRDFXMLSerializer.h&quot;</span>
<a href="#l42.16"></a><span id="l42.16" class="difflineminus">-#include &quot;nsIRDFXMLSource.h&quot;</span>
<a href="#l42.17"></a><span id="l42.17" class="difflineminus">-#include &quot;nsNameSpaceMap.h&quot;</span>
<a href="#l42.18"></a><span id="l42.18" class="difflineminus">-#include &quot;nsString.h&quot;</span>
<a href="#l42.19"></a><span id="l42.19" class="difflineminus">-</span>
<a href="#l42.20"></a><span id="l42.20" class="difflineminus">-#include &quot;nsDataHashtable.h&quot;</span>
<a href="#l42.21"></a><span id="l42.21" class="difflineminus">-#include &quot;rdfITripleVisitor.h&quot;</span>
<a href="#l42.22"></a><span id="l42.22" class="difflineminus">-</span>
<a href="#l42.23"></a><span id="l42.23" class="difflineminus">-class nsIOutputStream;</span>
<a href="#l42.24"></a><span id="l42.24" class="difflineminus">-class nsIRDFContainerUtils;</span>
<a href="#l42.25"></a><span id="l42.25" class="difflineminus">-</span>
<a href="#l42.26"></a><span id="l42.26" class="difflineminus">-/**</span>
<a href="#l42.27"></a><span id="l42.27" class="difflineminus">- * A helper class that can serialize RDF/XML from a</span>
<a href="#l42.28"></a><span id="l42.28" class="difflineminus">- * datasource. Implements both nsIRDFXMLSerializer and</span>
<a href="#l42.29"></a><span id="l42.29" class="difflineminus">- * nsIRDFXMLSource.</span>
<a href="#l42.30"></a><span id="l42.30" class="difflineminus">- */</span>
<a href="#l42.31"></a><span id="l42.31" class="difflineminus">-class nsRDFXMLSerializer : public nsIRDFXMLSerializer,</span>
<a href="#l42.32"></a><span id="l42.32" class="difflineminus">-                           public nsIRDFXMLSource</span>
<a href="#l42.33"></a><span id="l42.33" class="difflineminus">-{</span>
<a href="#l42.34"></a><span id="l42.34" class="difflineminus">-public:</span>
<a href="#l42.35"></a><span id="l42.35" class="difflineminus">-    static nsresult</span>
<a href="#l42.36"></a><span id="l42.36" class="difflineminus">-    Create(nsISupports* aOuter, REFNSIID aIID, void** aResult);</span>
<a href="#l42.37"></a><span id="l42.37" class="difflineminus">-</span>
<a href="#l42.38"></a><span id="l42.38" class="difflineminus">-    NS_DECL_ISUPPORTS</span>
<a href="#l42.39"></a><span id="l42.39" class="difflineminus">-    NS_DECL_NSIRDFXMLSERIALIZER</span>
<a href="#l42.40"></a><span id="l42.40" class="difflineminus">-    NS_DECL_NSIRDFXMLSOURCE</span>
<a href="#l42.41"></a><span id="l42.41" class="difflineminus">-</span>
<a href="#l42.42"></a><span id="l42.42" class="difflineminus">-protected:</span>
<a href="#l42.43"></a><span id="l42.43" class="difflineminus">-    nsRDFXMLSerializer();</span>
<a href="#l42.44"></a><span id="l42.44" class="difflineminus">-    virtual ~nsRDFXMLSerializer();</span>
<a href="#l42.45"></a><span id="l42.45" class="difflineminus">-</span>
<a href="#l42.46"></a><span id="l42.46" class="difflineminus">-    // Implementation methods</span>
<a href="#l42.47"></a><span id="l42.47" class="difflineminus">-    nsresult</span>
<a href="#l42.48"></a><span id="l42.48" class="difflineminus">-    RegisterQName(nsIRDFResource* aResource);</span>
<a href="#l42.49"></a><span id="l42.49" class="difflineminus">-    nsresult</span>
<a href="#l42.50"></a><span id="l42.50" class="difflineminus">-    GetQName(nsIRDFResource* aResource, nsCString&amp; aQName);</span>
<a href="#l42.51"></a><span id="l42.51" class="difflineminus">-    already_AddRefed&lt;nsAtom&gt;</span>
<a href="#l42.52"></a><span id="l42.52" class="difflineminus">-    EnsureNewPrefix();</span>
<a href="#l42.53"></a><span id="l42.53" class="difflineminus">-</span>
<a href="#l42.54"></a><span id="l42.54" class="difflineminus">-    nsresult</span>
<a href="#l42.55"></a><span id="l42.55" class="difflineminus">-    SerializeInlineAssertion(nsIOutputStream* aStream,</span>
<a href="#l42.56"></a><span id="l42.56" class="difflineminus">-                             nsIRDFResource* aResource,</span>
<a href="#l42.57"></a><span id="l42.57" class="difflineminus">-                             nsIRDFResource* aProperty,</span>
<a href="#l42.58"></a><span id="l42.58" class="difflineminus">-                             nsIRDFLiteral* aValue);</span>
<a href="#l42.59"></a><span id="l42.59" class="difflineminus">-</span>
<a href="#l42.60"></a><span id="l42.60" class="difflineminus">-    nsresult</span>
<a href="#l42.61"></a><span id="l42.61" class="difflineminus">-    SerializeChildAssertion(nsIOutputStream* aStream,</span>
<a href="#l42.62"></a><span id="l42.62" class="difflineminus">-                            nsIRDFResource* aResource,</span>
<a href="#l42.63"></a><span id="l42.63" class="difflineminus">-                            nsIRDFResource* aProperty,</span>
<a href="#l42.64"></a><span id="l42.64" class="difflineminus">-                            nsIRDFNode* aValue);</span>
<a href="#l42.65"></a><span id="l42.65" class="difflineminus">-</span>
<a href="#l42.66"></a><span id="l42.66" class="difflineminus">-    nsresult</span>
<a href="#l42.67"></a><span id="l42.67" class="difflineminus">-    SerializeProperty(nsIOutputStream* aStream,</span>
<a href="#l42.68"></a><span id="l42.68" class="difflineminus">-                      nsIRDFResource* aResource,</span>
<a href="#l42.69"></a><span id="l42.69" class="difflineminus">-                      nsIRDFResource* aProperty,</span>
<a href="#l42.70"></a><span id="l42.70" class="difflineminus">-                      bool aInline,</span>
<a href="#l42.71"></a><span id="l42.71" class="difflineminus">-                      int32_t* aSkipped);</span>
<a href="#l42.72"></a><span id="l42.72" class="difflineminus">-</span>
<a href="#l42.73"></a><span id="l42.73" class="difflineminus">-    bool</span>
<a href="#l42.74"></a><span id="l42.74" class="difflineminus">-    IsContainerProperty(nsIRDFResource* aProperty);</span>
<a href="#l42.75"></a><span id="l42.75" class="difflineminus">-</span>
<a href="#l42.76"></a><span id="l42.76" class="difflineminus">-    nsresult</span>
<a href="#l42.77"></a><span id="l42.77" class="difflineminus">-    SerializeDescription(nsIOutputStream* aStream,</span>
<a href="#l42.78"></a><span id="l42.78" class="difflineminus">-                         nsIRDFResource* aResource);</span>
<a href="#l42.79"></a><span id="l42.79" class="difflineminus">-</span>
<a href="#l42.80"></a><span id="l42.80" class="difflineminus">-    nsresult</span>
<a href="#l42.81"></a><span id="l42.81" class="difflineminus">-    SerializeMember(nsIOutputStream* aStream,</span>
<a href="#l42.82"></a><span id="l42.82" class="difflineminus">-                    nsIRDFResource* aContainer,</span>
<a href="#l42.83"></a><span id="l42.83" class="difflineminus">-                    nsIRDFNode* aMember);</span>
<a href="#l42.84"></a><span id="l42.84" class="difflineminus">-</span>
<a href="#l42.85"></a><span id="l42.85" class="difflineminus">-    nsresult</span>
<a href="#l42.86"></a><span id="l42.86" class="difflineminus">-    SerializeContainer(nsIOutputStream* aStream,</span>
<a href="#l42.87"></a><span id="l42.87" class="difflineminus">-                       nsIRDFResource* aContainer);</span>
<a href="#l42.88"></a><span id="l42.88" class="difflineminus">-</span>
<a href="#l42.89"></a><span id="l42.89" class="difflineminus">-    nsresult</span>
<a href="#l42.90"></a><span id="l42.90" class="difflineminus">-    SerializePrologue(nsIOutputStream* aStream);</span>
<a href="#l42.91"></a><span id="l42.91" class="difflineminus">-</span>
<a href="#l42.92"></a><span id="l42.92" class="difflineminus">-    nsresult</span>
<a href="#l42.93"></a><span id="l42.93" class="difflineminus">-    SerializeEpilogue(nsIOutputStream* aStream);</span>
<a href="#l42.94"></a><span id="l42.94" class="difflineminus">-</span>
<a href="#l42.95"></a><span id="l42.95" class="difflineminus">-    nsresult</span>
<a href="#l42.96"></a><span id="l42.96" class="difflineminus">-    CollectNamespaces();</span>
<a href="#l42.97"></a><span id="l42.97" class="difflineminus">-</span>
<a href="#l42.98"></a><span id="l42.98" class="difflineminus">-    bool</span>
<a href="#l42.99"></a><span id="l42.99" class="difflineminus">-    IsA(nsIRDFDataSource* aDataSource, nsIRDFResource* aResource, nsIRDFResource* aType);</span>
<a href="#l42.100"></a><span id="l42.100" class="difflineminus">-</span>
<a href="#l42.101"></a><span id="l42.101" class="difflineminus">-    nsCOMPtr&lt;nsIRDFDataSource&gt; mDataSource;</span>
<a href="#l42.102"></a><span id="l42.102" class="difflineminus">-    nsNameSpaceMap mNameSpaces;</span>
<a href="#l42.103"></a><span id="l42.103" class="difflineminus">-    nsCString mBaseURLSpec;</span>
<a href="#l42.104"></a><span id="l42.104" class="difflineminus">-</span>
<a href="#l42.105"></a><span id="l42.105" class="difflineminus">-    // hash mapping resources to utf8-encoded QNames</span>
<a href="#l42.106"></a><span id="l42.106" class="difflineminus">-    nsDataHashtable&lt;nsISupportsHashKey, nsCString&gt; mQNames;</span>
<a href="#l42.107"></a><span id="l42.107" class="difflineminus">-    friend class QNameCollector;</span>
<a href="#l42.108"></a><span id="l42.108" class="difflineminus">-</span>
<a href="#l42.109"></a><span id="l42.109" class="difflineminus">-    uint32_t mPrefixID;</span>
<a href="#l42.110"></a><span id="l42.110" class="difflineminus">-</span>
<a href="#l42.111"></a><span id="l42.111" class="difflineminus">-    static int32_t gRefCnt;</span>
<a href="#l42.112"></a><span id="l42.112" class="difflineminus">-    static nsIRDFResource* kRDF_instanceOf;</span>
<a href="#l42.113"></a><span id="l42.113" class="difflineminus">-    static nsIRDFResource* kRDF_type;</span>
<a href="#l42.114"></a><span id="l42.114" class="difflineminus">-    static nsIRDFResource* kRDF_nextVal;</span>
<a href="#l42.115"></a><span id="l42.115" class="difflineminus">-    static nsIRDFResource* kRDF_Bag;</span>
<a href="#l42.116"></a><span id="l42.116" class="difflineminus">-    static nsIRDFResource* kRDF_Seq;</span>
<a href="#l42.117"></a><span id="l42.117" class="difflineminus">-    static nsIRDFResource* kRDF_Alt;</span>
<a href="#l42.118"></a><span id="l42.118" class="difflineminus">-    static nsIRDFContainerUtils* gRDFC;</span>
<a href="#l42.119"></a><span id="l42.119" class="difflineminus">-};</span>
<a href="#l42.120"></a><span id="l42.120" class="difflineminus">-</span>
<a href="#l42.121"></a><span id="l42.121" class="difflineminus">-#endif // nsRDFXMLSerializer_h__</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l43.1"></a><span id="l43.1">deleted file mode 100644</span>
<a href="#l43.2"></a><span id="l43.2" class="difflineminus">--- a/rdf/base/rdf.h</span>
<a href="#l43.3"></a><span id="l43.3" class="difflineplus">+++ /dev/null</span>
<a href="#l43.4"></a><span id="l43.4" class="difflineat">@@ -1,57 +0,0 @@</span>
<a href="#l43.5"></a><span id="l43.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l43.6"></a><span id="l43.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l43.7"></a><span id="l43.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l43.8"></a><span id="l43.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l43.9"></a><span id="l43.9" class="difflineminus">-</span>
<a href="#l43.10"></a><span id="l43.10" class="difflineminus">-/*</span>
<a href="#l43.11"></a><span id="l43.11" class="difflineminus">-</span>
<a href="#l43.12"></a><span id="l43.12" class="difflineminus">-  A catch-all header file for miscellaneous RDF stuff. Currently</span>
<a href="#l43.13"></a><span id="l43.13" class="difflineminus">-  contains error codes and vocabulary macros.</span>
<a href="#l43.14"></a><span id="l43.14" class="difflineminus">-</span>
<a href="#l43.15"></a><span id="l43.15" class="difflineminus">- */</span>
<a href="#l43.16"></a><span id="l43.16" class="difflineminus">-</span>
<a href="#l43.17"></a><span id="l43.17" class="difflineminus">-#ifndef rdf_h___</span>
<a href="#l43.18"></a><span id="l43.18" class="difflineminus">-#define rdf_h___</span>
<a href="#l43.19"></a><span id="l43.19" class="difflineminus">-</span>
<a href="#l43.20"></a><span id="l43.20" class="difflineminus">-#include &quot;nsError.h&quot;</span>
<a href="#l43.21"></a><span id="l43.21" class="difflineminus">-</span>
<a href="#l43.22"></a><span id="l43.22" class="difflineminus">-/**</span>
<a href="#l43.23"></a><span id="l43.23" class="difflineminus">- * The following macros are to aid in vocabulary definition.  They</span>
<a href="#l43.24"></a><span id="l43.24" class="difflineminus">- * creates const char*'s for &quot;kURI[prefix]_[name]&quot;, appropriate</span>
<a href="#l43.25"></a><span id="l43.25" class="difflineminus">- * complete namespace qualification on the URI, e.g.,</span>
<a href="#l43.26"></a><span id="l43.26" class="difflineminus">- *</span>
<a href="#l43.27"></a><span id="l43.27" class="difflineminus">- * #define RDF_NAMESPACE_URI &quot;http://www.w3.org/TR/WD-rdf-syntax#&quot;</span>
<a href="#l43.28"></a><span id="l43.28" class="difflineminus">- * DEFINE_RDF_ELEMENT(RDF_NAMESPACE_URI, RDF, ID);</span>
<a href="#l43.29"></a><span id="l43.29" class="difflineminus">- *</span>
<a href="#l43.30"></a><span id="l43.30" class="difflineminus">- * will define:</span>
<a href="#l43.31"></a><span id="l43.31" class="difflineminus">- *</span>
<a href="#l43.32"></a><span id="l43.32" class="difflineminus">- * kURIRDF_ID to be &quot;http://www.w3.org/TR/WD-rdf-syntax#ID&quot;</span>
<a href="#l43.33"></a><span id="l43.33" class="difflineminus">- */</span>
<a href="#l43.34"></a><span id="l43.34" class="difflineminus">-</span>
<a href="#l43.35"></a><span id="l43.35" class="difflineminus">-#define DEFINE_RDF_VOCAB(ns, prefix, name) \</span>
<a href="#l43.36"></a><span id="l43.36" class="difflineminus">-static const char kURI##prefix##_##name[] = ns #name</span>
<a href="#l43.37"></a><span id="l43.37" class="difflineminus">-</span>
<a href="#l43.38"></a><span id="l43.38" class="difflineminus">-/**</span>
<a href="#l43.39"></a><span id="l43.39" class="difflineminus">- * Core RDF vocabularies that we use to define semantics</span>
<a href="#l43.40"></a><span id="l43.40" class="difflineminus">- */</span>
<a href="#l43.41"></a><span id="l43.41" class="difflineminus">-</span>
<a href="#l43.42"></a><span id="l43.42" class="difflineminus">-#define RDF_NAMESPACE_URI  &quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#&quot;</span>
<a href="#l43.43"></a><span id="l43.43" class="difflineminus">-#define WEB_NAMESPACE_URI  &quot;http://home.netscape.com/WEB-rdf#&quot;</span>
<a href="#l43.44"></a><span id="l43.44" class="difflineminus">-#define NC_NAMESPACE_URI   &quot;http://home.netscape.com/NC-rdf#&quot;</span>
<a href="#l43.45"></a><span id="l43.45" class="difflineminus">-</span>
<a href="#l43.46"></a><span id="l43.46" class="difflineminus">-/* ContractID prefixes for RDF DLL registration. */</span>
<a href="#l43.47"></a><span id="l43.47" class="difflineminus">-#define NS_RDF_CONTRACTID                           &quot;@mozilla.org/rdf&quot;</span>
<a href="#l43.48"></a><span id="l43.48" class="difflineminus">-#define NS_RDF_DATASOURCE_CONTRACTID                NS_RDF_CONTRACTID &quot;/datasource;1&quot;</span>
<a href="#l43.49"></a><span id="l43.49" class="difflineminus">-#define NS_RDF_DATASOURCE_CONTRACTID_PREFIX         NS_RDF_DATASOURCE_CONTRACTID &quot;?name=&quot;</span>
<a href="#l43.50"></a><span id="l43.50" class="difflineminus">-#define NS_RDF_RESOURCE_FACTORY_CONTRACTID          &quot;@mozilla.org/rdf/resource-factory;1&quot;</span>
<a href="#l43.51"></a><span id="l43.51" class="difflineminus">-#define NS_RDF_RESOURCE_FACTORY_CONTRACTID_PREFIX   NS_RDF_RESOURCE_FACTORY_CONTRACTID &quot;?name=&quot;</span>
<a href="#l43.52"></a><span id="l43.52" class="difflineminus">-#define NS_RDF_INFER_DATASOURCE_CONTRACTID_PREFIX   NS_RDF_CONTRACTID &quot;/infer-datasource;1?engine=&quot;</span>
<a href="#l43.53"></a><span id="l43.53" class="difflineminus">-</span>
<a href="#l43.54"></a><span id="l43.54" class="difflineminus">-// contract ID is in the form</span>
<a href="#l43.55"></a><span id="l43.55" class="difflineminus">-// @mozilla.org/rdf/delegate-factory;1?key=&lt;key&gt;&amp;scheme=&lt;scheme&gt;</span>
<a href="#l43.56"></a><span id="l43.56" class="difflineminus">-#define NS_RDF_DELEGATEFACTORY_CONTRACTID    &quot;@mozilla.org/rdf/delegate-factory;1&quot;</span>
<a href="#l43.57"></a><span id="l43.57" class="difflineminus">-#define NS_RDF_DELEGATEFACTORY_CONTRACTID_PREFIX    NS_RDF_DELEGATEFACTORY_CONTRACTID &quot;?key=&quot;</span>
<a href="#l43.58"></a><span id="l43.58" class="difflineminus">-</span>
<a href="#l43.59"></a><span id="l43.59" class="difflineminus">-/*@}*/</span>
<a href="#l43.60"></a><span id="l43.60" class="difflineminus">-</span>
<a href="#l43.61"></a><span id="l43.61" class="difflineminus">-#endif /* rdf_h___ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l44.1"></a><span id="l44.1">deleted file mode 100644</span>
<a href="#l44.2"></a><span id="l44.2" class="difflineminus">--- a/rdf/base/rdfIDataSource.idl</span>
<a href="#l44.3"></a><span id="l44.3" class="difflineplus">+++ /dev/null</span>
<a href="#l44.4"></a><span id="l44.4" class="difflineat">@@ -1,38 +0,0 @@</span>
<a href="#l44.5"></a><span id="l44.5" class="difflineminus">-/* -*- Mode: IDL; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l44.6"></a><span id="l44.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l44.7"></a><span id="l44.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l44.8"></a><span id="l44.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l44.9"></a><span id="l44.9" class="difflineminus">-</span>
<a href="#l44.10"></a><span id="l44.10" class="difflineminus">-#include &quot;nsISupports.idl&quot;</span>
<a href="#l44.11"></a><span id="l44.11" class="difflineminus">-</span>
<a href="#l44.12"></a><span id="l44.12" class="difflineminus">-interface rdfITripleVisitor;</span>
<a href="#l44.13"></a><span id="l44.13" class="difflineminus">-</span>
<a href="#l44.14"></a><span id="l44.14" class="difflineminus">-/**</span>
<a href="#l44.15"></a><span id="l44.15" class="difflineminus">- * Interface used in RDF to describe data sources.</span>
<a href="#l44.16"></a><span id="l44.16" class="difflineminus">- *</span>
<a href="#l44.17"></a><span id="l44.17" class="difflineminus">- * @status PLASMA</span>
<a href="#l44.18"></a><span id="l44.18" class="difflineminus">- */</span>
<a href="#l44.19"></a><span id="l44.19" class="difflineminus">-</span>
<a href="#l44.20"></a><span id="l44.20" class="difflineminus">-[scriptable, uuid(ebce86bd-1568-4a34-a808-9ccf9cde8087)]</span>
<a href="#l44.21"></a><span id="l44.21" class="difflineminus">-interface rdfIDataSource : nsISupports</span>
<a href="#l44.22"></a><span id="l44.22" class="difflineminus">-{</span>
<a href="#l44.23"></a><span id="l44.23" class="difflineminus">-    /**</span>
<a href="#l44.24"></a><span id="l44.24" class="difflineminus">-     * Visit all the subject resources in the datasource. The order is</span>
<a href="#l44.25"></a><span id="l44.25" class="difflineminus">-     * intederminate and may change from one invocation to the next.</span>
<a href="#l44.26"></a><span id="l44.26" class="difflineminus">-     * The subjects will be in the aSubject argument in calls into</span>
<a href="#l44.27"></a><span id="l44.27" class="difflineminus">-     * aVisitor, aPredicate and aObject will be null.</span>
<a href="#l44.28"></a><span id="l44.28" class="difflineminus">-     * @note Implementations may throw NS_ERROR_NOT_IMPLEMENTED for</span>
<a href="#l44.29"></a><span id="l44.29" class="difflineminus">-     * this method, but in this case RDF serializations of this</span>
<a href="#l44.30"></a><span id="l44.30" class="difflineminus">-     * datasource will not be possible.</span>
<a href="#l44.31"></a><span id="l44.31" class="difflineminus">-     */</span>
<a href="#l44.32"></a><span id="l44.32" class="difflineminus">-    void visitAllSubjects(in rdfITripleVisitor aVisitor);</span>
<a href="#l44.33"></a><span id="l44.33" class="difflineminus">-</span>
<a href="#l44.34"></a><span id="l44.34" class="difflineminus">-    /**</span>
<a href="#l44.35"></a><span id="l44.35" class="difflineminus">-     * Visit all the triples in the datasource. The order is</span>
<a href="#l44.36"></a><span id="l44.36" class="difflineminus">-     * intederminate and may change from one invocation to the next.</span>
<a href="#l44.37"></a><span id="l44.37" class="difflineminus">-     * @note Implementations may throw NS_ERROR_NOT_IMPLEMENTED for</span>
<a href="#l44.38"></a><span id="l44.38" class="difflineminus">-     * this method, but in this case RDF serializations of this</span>
<a href="#l44.39"></a><span id="l44.39" class="difflineminus">-     * datasource will not be possible.</span>
<a href="#l44.40"></a><span id="l44.40" class="difflineminus">-     */</span>
<a href="#l44.41"></a><span id="l44.41" class="difflineminus">-    void visitAllTriples(in rdfITripleVisitor aVisitor);</span>
<a href="#l44.42"></a><span id="l44.42" class="difflineminus">-};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l45.1"></a><span id="l45.1">deleted file mode 100644</span>
<a href="#l45.2"></a><span id="l45.2" class="difflineminus">--- a/rdf/base/rdfITripleVisitor.idl</span>
<a href="#l45.3"></a><span id="l45.3" class="difflineplus">+++ /dev/null</span>
<a href="#l45.4"></a><span id="l45.4" class="difflineat">@@ -1,31 +0,0 @@</span>
<a href="#l45.5"></a><span id="l45.5" class="difflineminus">-/* -*- Mode: IDL; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l45.6"></a><span id="l45.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l45.7"></a><span id="l45.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l45.8"></a><span id="l45.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l45.9"></a><span id="l45.9" class="difflineminus">-</span>
<a href="#l45.10"></a><span id="l45.10" class="difflineminus">-#include &quot;nsISupports.idl&quot;</span>
<a href="#l45.11"></a><span id="l45.11" class="difflineminus">-</span>
<a href="#l45.12"></a><span id="l45.12" class="difflineminus">-interface nsIRDFResource;</span>
<a href="#l45.13"></a><span id="l45.13" class="difflineminus">-interface nsIRDFNode;</span>
<a href="#l45.14"></a><span id="l45.14" class="difflineminus">-</span>
<a href="#l45.15"></a><span id="l45.15" class="difflineminus">-/**</span>
<a href="#l45.16"></a><span id="l45.16" class="difflineminus">- * Interface used in RDF to enumerate triples.</span>
<a href="#l45.17"></a><span id="l45.17" class="difflineminus">- * Also used by rdfIDataSource::getAllSubjects, then aPredicate,</span>
<a href="#l45.18"></a><span id="l45.18" class="difflineminus">- * aObject and aTruthValue are ignored.</span>
<a href="#l45.19"></a><span id="l45.19" class="difflineminus">- *</span>
<a href="#l45.20"></a><span id="l45.20" class="difflineminus">- * @status PLASMA</span>
<a href="#l45.21"></a><span id="l45.21" class="difflineminus">- */</span>
<a href="#l45.22"></a><span id="l45.22" class="difflineminus">-</span>
<a href="#l45.23"></a><span id="l45.23" class="difflineminus">-[scriptable, function, uuid(aafea151-c271-4505-9978-a100d292800c)]</span>
<a href="#l45.24"></a><span id="l45.24" class="difflineminus">-interface rdfITripleVisitor : nsISupports</span>
<a href="#l45.25"></a><span id="l45.25" class="difflineminus">-{</span>
<a href="#l45.26"></a><span id="l45.26" class="difflineminus">-    /**</span>
<a href="#l45.27"></a><span id="l45.27" class="difflineminus">-     * Callback function for returning query results.</span>
<a href="#l45.28"></a><span id="l45.28" class="difflineminus">-     *</span>
<a href="#l45.29"></a><span id="l45.29" class="difflineminus">-     * @param aSubject, aPredicate, aObject describe the (sub-)arc</span>
<a href="#l45.30"></a><span id="l45.30" class="difflineminus">-     * @returnCode NS_RDF_STOP_VISIT to stop iterating over the query result.</span>
<a href="#l45.31"></a><span id="l45.31" class="difflineminus">-     *             Any error code will stop the iteration as well.</span>
<a href="#l45.32"></a><span id="l45.32" class="difflineminus">-     */</span>
<a href="#l45.33"></a><span id="l45.33" class="difflineminus">-    void visit(in nsIRDFNode aSubject, in nsIRDFResource aPredicate,</span>
<a href="#l45.34"></a><span id="l45.34" class="difflineminus">-               in nsIRDFNode aObject, in boolean aTruthValue);</span>
<a href="#l45.35"></a><span id="l45.35" class="difflineminus">-};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l46.1"></a><span id="l46.1">deleted file mode 100644</span>
<a href="#l46.2"></a><span id="l46.2" class="difflineminus">--- a/rdf/base/rdfutil.cpp</span>
<a href="#l46.3"></a><span id="l46.3" class="difflineplus">+++ /dev/null</span>
<a href="#l46.4"></a><span id="l46.4" class="difflineat">@@ -1,110 +0,0 @@</span>
<a href="#l46.5"></a><span id="l46.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l46.6"></a><span id="l46.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l46.7"></a><span id="l46.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l46.8"></a><span id="l46.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l46.9"></a><span id="l46.9" class="difflineminus">-</span>
<a href="#l46.10"></a><span id="l46.10" class="difflineminus">-/*</span>
<a href="#l46.11"></a><span id="l46.11" class="difflineminus">-</span>
<a href="#l46.12"></a><span id="l46.12" class="difflineminus">-  Implementations for a bunch of useful RDF utility routines.  Many of</span>
<a href="#l46.13"></a><span id="l46.13" class="difflineminus">-  these will eventually be exported outside of RDF.DLL via the</span>
<a href="#l46.14"></a><span id="l46.14" class="difflineminus">-  nsIRDFService interface.</span>
<a href="#l46.15"></a><span id="l46.15" class="difflineminus">-</span>
<a href="#l46.16"></a><span id="l46.16" class="difflineminus">-  TO DO</span>
<a href="#l46.17"></a><span id="l46.17" class="difflineminus">-</span>
<a href="#l46.18"></a><span id="l46.18" class="difflineminus">-  1) Make this so that it doesn't permanently leak the RDF service</span>
<a href="#l46.19"></a><span id="l46.19" class="difflineminus">-     object.</span>
<a href="#l46.20"></a><span id="l46.20" class="difflineminus">-</span>
<a href="#l46.21"></a><span id="l46.21" class="difflineminus">-  2) Make container functions thread-safe. They currently don't ensure</span>
<a href="#l46.22"></a><span id="l46.22" class="difflineminus">-     that the RDF:nextVal property is maintained safely.</span>
<a href="#l46.23"></a><span id="l46.23" class="difflineminus">-</span>
<a href="#l46.24"></a><span id="l46.24" class="difflineminus">- */</span>
<a href="#l46.25"></a><span id="l46.25" class="difflineminus">-</span>
<a href="#l46.26"></a><span id="l46.26" class="difflineminus">-#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l46.27"></a><span id="l46.27" class="difflineminus">-#include &quot;nsIRDFDataSource.h&quot;</span>
<a href="#l46.28"></a><span id="l46.28" class="difflineminus">-#include &quot;nsIRDFNode.h&quot;</span>
<a href="#l46.29"></a><span id="l46.29" class="difflineminus">-#include &quot;nsIRDFService.h&quot;</span>
<a href="#l46.30"></a><span id="l46.30" class="difflineminus">-#include &quot;nsIServiceManager.h&quot;</span>
<a href="#l46.31"></a><span id="l46.31" class="difflineminus">-#include &quot;nsIURL.h&quot;</span>
<a href="#l46.32"></a><span id="l46.32" class="difflineminus">-#include &quot;nsIIOService.h&quot;</span>
<a href="#l46.33"></a><span id="l46.33" class="difflineminus">-#include &quot;nsIURL.h&quot;</span>
<a href="#l46.34"></a><span id="l46.34" class="difflineminus">-#include &quot;nsRDFCID.h&quot;</span>
<a href="#l46.35"></a><span id="l46.35" class="difflineminus">-#include &quot;nsString.h&quot;</span>
<a href="#l46.36"></a><span id="l46.36" class="difflineminus">-#include &quot;nsUnicharUtils.h&quot;</span>
<a href="#l46.37"></a><span id="l46.37" class="difflineminus">-#include &quot;rdfutil.h&quot;</span>
<a href="#l46.38"></a><span id="l46.38" class="difflineminus">-#include &quot;prtime.h&quot;</span>
<a href="#l46.39"></a><span id="l46.39" class="difflineminus">-</span>
<a href="#l46.40"></a><span id="l46.40" class="difflineminus">-////////////////////////////////////////////////////////////////////////</span>
<a href="#l46.41"></a><span id="l46.41" class="difflineminus">-</span>
<a href="#l46.42"></a><span id="l46.42" class="difflineminus">-nsresult</span>
<a href="#l46.43"></a><span id="l46.43" class="difflineminus">-rdf_MakeRelativeRef(const nsACString&amp; aBaseURI, nsCString&amp; aURI)</span>
<a href="#l46.44"></a><span id="l46.44" class="difflineminus">-{</span>
<a href="#l46.45"></a><span id="l46.45" class="difflineminus">-    // This implementation is extremely simple: e.g., it can't compute</span>
<a href="#l46.46"></a><span id="l46.46" class="difflineminus">-    // relative paths, or anything fancy like that. If the context URI</span>
<a href="#l46.47"></a><span id="l46.47" class="difflineminus">-    // is not a prefix of the URI in question, we'll just bail.</span>
<a href="#l46.48"></a><span id="l46.48" class="difflineminus">-    uint32_t prefixLen = aBaseURI.Length();</span>
<a href="#l46.49"></a><span id="l46.49" class="difflineminus">-    if (prefixLen != 0 &amp;&amp; StringBeginsWith(aURI, aBaseURI)) {</span>
<a href="#l46.50"></a><span id="l46.50" class="difflineminus">-        if (prefixLen &lt; aURI.Length() &amp;&amp; aURI.CharAt(prefixLen) == '/')</span>
<a href="#l46.51"></a><span id="l46.51" class="difflineminus">-            ++prefixLen; // chop the leading slash so it's not `absolute'</span>
<a href="#l46.52"></a><span id="l46.52" class="difflineminus">-</span>
<a href="#l46.53"></a><span id="l46.53" class="difflineminus">-        aURI.Cut(0, prefixLen);</span>
<a href="#l46.54"></a><span id="l46.54" class="difflineminus">-    }</span>
<a href="#l46.55"></a><span id="l46.55" class="difflineminus">-</span>
<a href="#l46.56"></a><span id="l46.56" class="difflineminus">-    return NS_OK;</span>
<a href="#l46.57"></a><span id="l46.57" class="difflineminus">-}</span>
<a href="#l46.58"></a><span id="l46.58" class="difflineminus">-</span>
<a href="#l46.59"></a><span id="l46.59" class="difflineminus">-void</span>
<a href="#l46.60"></a><span id="l46.60" class="difflineminus">-rdf_FormatDate(PRTime aTime, nsACString &amp;aResult)</span>
<a href="#l46.61"></a><span id="l46.61" class="difflineminus">-{</span>
<a href="#l46.62"></a><span id="l46.62" class="difflineminus">-    // Outputs Unixish date in GMT plus usecs; e.g.,</span>
<a href="#l46.63"></a><span id="l46.63" class="difflineminus">-    //   Wed Jan  9 19:15:13 2002 +002441</span>
<a href="#l46.64"></a><span id="l46.64" class="difflineminus">-    //</span>
<a href="#l46.65"></a><span id="l46.65" class="difflineminus">-    PRExplodedTime t;</span>
<a href="#l46.66"></a><span id="l46.66" class="difflineminus">-    PR_ExplodeTime(aTime, PR_GMTParameters, &amp;t);</span>
<a href="#l46.67"></a><span id="l46.67" class="difflineminus">-</span>
<a href="#l46.68"></a><span id="l46.68" class="difflineminus">-    char buf[256];</span>
<a href="#l46.69"></a><span id="l46.69" class="difflineminus">-    PR_FormatTimeUSEnglish(buf, sizeof buf, &quot;%a %b %d %H:%M:%S %Y&quot;, &amp;t);</span>
<a href="#l46.70"></a><span id="l46.70" class="difflineminus">-    aResult.Append(buf);</span>
<a href="#l46.71"></a><span id="l46.71" class="difflineminus">-</span>
<a href="#l46.72"></a><span id="l46.72" class="difflineminus">-    // usecs</span>
<a href="#l46.73"></a><span id="l46.73" class="difflineminus">-    aResult.AppendLiteral(&quot; +&quot;);</span>
<a href="#l46.74"></a><span id="l46.74" class="difflineminus">-    int32_t usec = t.tm_usec;</span>
<a href="#l46.75"></a><span id="l46.75" class="difflineminus">-    for (int32_t digit = 100000; digit &gt; 1; digit /= 10) {</span>
<a href="#l46.76"></a><span id="l46.76" class="difflineminus">-        aResult.Append(char('0' + (usec / digit)));</span>
<a href="#l46.77"></a><span id="l46.77" class="difflineminus">-        usec %= digit;</span>
<a href="#l46.78"></a><span id="l46.78" class="difflineminus">-    }</span>
<a href="#l46.79"></a><span id="l46.79" class="difflineminus">-    aResult.Append(char('0' + usec));</span>
<a href="#l46.80"></a><span id="l46.80" class="difflineminus">-}</span>
<a href="#l46.81"></a><span id="l46.81" class="difflineminus">-</span>
<a href="#l46.82"></a><span id="l46.82" class="difflineminus">-PRTime</span>
<a href="#l46.83"></a><span id="l46.83" class="difflineminus">-rdf_ParseDate(const nsACString &amp;aTime)</span>
<a href="#l46.84"></a><span id="l46.84" class="difflineminus">-{</span>
<a href="#l46.85"></a><span id="l46.85" class="difflineminus">-    PRTime t;</span>
<a href="#l46.86"></a><span id="l46.86" class="difflineminus">-    PR_ParseTimeString(PromiseFlatCString(aTime).get(), true, &amp;t);</span>
<a href="#l46.87"></a><span id="l46.87" class="difflineminus">-</span>
<a href="#l46.88"></a><span id="l46.88" class="difflineminus">-    int32_t usec = 0;</span>
<a href="#l46.89"></a><span id="l46.89" class="difflineminus">-</span>
<a href="#l46.90"></a><span id="l46.90" class="difflineminus">-    nsACString::const_iterator begin, digit, end;</span>
<a href="#l46.91"></a><span id="l46.91" class="difflineminus">-    aTime.BeginReading(begin);</span>
<a href="#l46.92"></a><span id="l46.92" class="difflineminus">-    aTime.EndReading(end);</span>
<a href="#l46.93"></a><span id="l46.93" class="difflineminus">-</span>
<a href="#l46.94"></a><span id="l46.94" class="difflineminus">-    // Walk backwards until we find a `+', run out of string, or a</span>
<a href="#l46.95"></a><span id="l46.95" class="difflineminus">-    // non-numeric character.</span>
<a href="#l46.96"></a><span id="l46.96" class="difflineminus">-    digit = end;</span>
<a href="#l46.97"></a><span id="l46.97" class="difflineminus">-    while (--digit != begin &amp;&amp; *digit != '+') {</span>
<a href="#l46.98"></a><span id="l46.98" class="difflineminus">-        if (*digit &lt; '0' || *digit &gt; '9')</span>
<a href="#l46.99"></a><span id="l46.99" class="difflineminus">-            break;</span>
<a href="#l46.100"></a><span id="l46.100" class="difflineminus">-    }</span>
<a href="#l46.101"></a><span id="l46.101" class="difflineminus">-</span>
<a href="#l46.102"></a><span id="l46.102" class="difflineminus">-    if (digit != begin &amp;&amp; *digit == '+') {</span>
<a href="#l46.103"></a><span id="l46.103" class="difflineminus">-        // There's a usec field specified (or, at least, something</span>
<a href="#l46.104"></a><span id="l46.104" class="difflineminus">-        // that looks close enough. Parse it, and add it to the time.</span>
<a href="#l46.105"></a><span id="l46.105" class="difflineminus">-        while (++digit != end) {</span>
<a href="#l46.106"></a><span id="l46.106" class="difflineminus">-            usec *= 10;</span>
<a href="#l46.107"></a><span id="l46.107" class="difflineminus">-            usec += *digit - '0';</span>
<a href="#l46.108"></a><span id="l46.108" class="difflineminus">-        }</span>
<a href="#l46.109"></a><span id="l46.109" class="difflineminus">-</span>
<a href="#l46.110"></a><span id="l46.110" class="difflineminus">-        t += usec;</span>
<a href="#l46.111"></a><span id="l46.111" class="difflineminus">-    }</span>
<a href="#l46.112"></a><span id="l46.112" class="difflineminus">-</span>
<a href="#l46.113"></a><span id="l46.113" class="difflineminus">-    return t;</span>
<a href="#l46.114"></a><span id="l46.114" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l47.1"></a><span id="l47.1">deleted file mode 100644</span>
<a href="#l47.2"></a><span id="l47.2" class="difflineminus">--- a/rdf/base/rdfutil.h</span>
<a href="#l47.3"></a><span id="l47.3" class="difflineplus">+++ /dev/null</span>
<a href="#l47.4"></a><span id="l47.4" class="difflineat">@@ -1,38 +0,0 @@</span>
<a href="#l47.5"></a><span id="l47.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l47.6"></a><span id="l47.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l47.7"></a><span id="l47.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l47.8"></a><span id="l47.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l47.9"></a><span id="l47.9" class="difflineminus">-</span>
<a href="#l47.10"></a><span id="l47.10" class="difflineminus">-</span>
<a href="#l47.11"></a><span id="l47.11" class="difflineminus">-/*</span>
<a href="#l47.12"></a><span id="l47.12" class="difflineminus">-</span>
<a href="#l47.13"></a><span id="l47.13" class="difflineminus">-  A bunch of useful RDF utility routines.  Many of these will</span>
<a href="#l47.14"></a><span id="l47.14" class="difflineminus">-  eventually be exported outside of RDF.DLL via the nsIRDFService</span>
<a href="#l47.15"></a><span id="l47.15" class="difflineminus">-  interface.</span>
<a href="#l47.16"></a><span id="l47.16" class="difflineminus">-</span>
<a href="#l47.17"></a><span id="l47.17" class="difflineminus">-  TO DO</span>
<a href="#l47.18"></a><span id="l47.18" class="difflineminus">-</span>
<a href="#l47.19"></a><span id="l47.19" class="difflineminus">-  1) Move the anonymous resource stuff to nsIRDFService?</span>
<a href="#l47.20"></a><span id="l47.20" class="difflineminus">-</span>
<a href="#l47.21"></a><span id="l47.21" class="difflineminus">-  2) All that's left is rdf_PossiblyMakeRelative() and</span>
<a href="#l47.22"></a><span id="l47.22" class="difflineminus">-     -Absolute(). Maybe those go on nsIRDFService, too.</span>
<a href="#l47.23"></a><span id="l47.23" class="difflineminus">-</span>
<a href="#l47.24"></a><span id="l47.24" class="difflineminus">- */</span>
<a href="#l47.25"></a><span id="l47.25" class="difflineminus">-</span>
<a href="#l47.26"></a><span id="l47.26" class="difflineminus">-#ifndef rdfutil_h__</span>
<a href="#l47.27"></a><span id="l47.27" class="difflineminus">-#define rdfutil_h__</span>
<a href="#l47.28"></a><span id="l47.28" class="difflineminus">-</span>
<a href="#l47.29"></a><span id="l47.29" class="difflineminus">-#include &quot;nsStringFwd.h&quot;</span>
<a href="#l47.30"></a><span id="l47.30" class="difflineminus">-</span>
<a href="#l47.31"></a><span id="l47.31" class="difflineminus">-nsresult</span>
<a href="#l47.32"></a><span id="l47.32" class="difflineminus">-rdf_MakeRelativeRef(const nsACString&amp; aBaseURI, nsCString&amp; aURI);</span>
<a href="#l47.33"></a><span id="l47.33" class="difflineminus">-</span>
<a href="#l47.34"></a><span id="l47.34" class="difflineminus">-void</span>
<a href="#l47.35"></a><span id="l47.35" class="difflineminus">-rdf_FormatDate(PRTime aTime, nsACString &amp;aResult);</span>
<a href="#l47.36"></a><span id="l47.36" class="difflineminus">-</span>
<a href="#l47.37"></a><span id="l47.37" class="difflineminus">-PRTime</span>
<a href="#l47.38"></a><span id="l47.38" class="difflineminus">-rdf_ParseDate(const nsACString &amp;aTime);</span>
<a href="#l47.39"></a><span id="l47.39" class="difflineminus">-</span>
<a href="#l47.40"></a><span id="l47.40" class="difflineminus">-#endif // rdfutil_h__</span>
<a href="#l47.41"></a><span id="l47.41" class="difflineminus">-</span>
<a href="#l47.42"></a><span id="l47.42" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l48.1"></a><span id="l48.1">deleted file mode 100644</span>
<a href="#l48.2"></a><span id="l48.2" class="difflineminus">--- a/rdf/build/moz.build</span>
<a href="#l48.3"></a><span id="l48.3" class="difflineplus">+++ /dev/null</span>
<a href="#l48.4"></a><span id="l48.4" class="difflineat">@@ -1,20 +0,0 @@</span>
<a href="#l48.5"></a><span id="l48.5" class="difflineminus">-# -*- Mode: python; indent-tabs-mode: nil; tab-width: 40 -*-</span>
<a href="#l48.6"></a><span id="l48.6" class="difflineminus">-# vim: set filetype=python:</span>
<a href="#l48.7"></a><span id="l48.7" class="difflineminus">-# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l48.8"></a><span id="l48.8" class="difflineminus">-# License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l48.9"></a><span id="l48.9" class="difflineminus">-# file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l48.10"></a><span id="l48.10" class="difflineminus">-</span>
<a href="#l48.11"></a><span id="l48.11" class="difflineminus">-EXPORTS += [</span>
<a href="#l48.12"></a><span id="l48.12" class="difflineminus">-    'nsRDFCID.h',</span>
<a href="#l48.13"></a><span id="l48.13" class="difflineminus">-]</span>
<a href="#l48.14"></a><span id="l48.14" class="difflineminus">-</span>
<a href="#l48.15"></a><span id="l48.15" class="difflineminus">-SOURCES += [</span>
<a href="#l48.16"></a><span id="l48.16" class="difflineminus">-    'nsRDFModule.cpp',</span>
<a href="#l48.17"></a><span id="l48.17" class="difflineminus">-]</span>
<a href="#l48.18"></a><span id="l48.18" class="difflineminus">-</span>
<a href="#l48.19"></a><span id="l48.19" class="difflineminus">-FINAL_LIBRARY = 'xul'</span>
<a href="#l48.20"></a><span id="l48.20" class="difflineminus">-</span>
<a href="#l48.21"></a><span id="l48.21" class="difflineminus">-LOCAL_INCLUDES += [</span>
<a href="#l48.22"></a><span id="l48.22" class="difflineminus">-    '../base',</span>
<a href="#l48.23"></a><span id="l48.23" class="difflineminus">-    '../datasource',</span>
<a href="#l48.24"></a><span id="l48.24" class="difflineminus">-]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l49.1"></a><span id="l49.1">deleted file mode 100644</span>
<a href="#l49.2"></a><span id="l49.2" class="difflineminus">--- a/rdf/build/nsRDFCID.h</span>
<a href="#l49.3"></a><span id="l49.3" class="difflineplus">+++ /dev/null</span>
<a href="#l49.4"></a><span id="l49.4" class="difflineat">@@ -1,76 +0,0 @@</span>
<a href="#l49.5"></a><span id="l49.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l49.6"></a><span id="l49.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l49.7"></a><span id="l49.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l49.8"></a><span id="l49.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l49.9"></a><span id="l49.9" class="difflineminus">-</span>
<a href="#l49.10"></a><span id="l49.10" class="difflineminus">-/*</span>
<a href="#l49.11"></a><span id="l49.11" class="difflineminus">-</span>
<a href="#l49.12"></a><span id="l49.12" class="difflineminus">-  XPCOM Class IDs for RDF objects that can be constructed via the RDF</span>
<a href="#l49.13"></a><span id="l49.13" class="difflineminus">-  factory.</span>
<a href="#l49.14"></a><span id="l49.14" class="difflineminus">-</span>
<a href="#l49.15"></a><span id="l49.15" class="difflineminus">- */</span>
<a href="#l49.16"></a><span id="l49.16" class="difflineminus">-</span>
<a href="#l49.17"></a><span id="l49.17" class="difflineminus">-#ifndef nsRDFCID_h__</span>
<a href="#l49.18"></a><span id="l49.18" class="difflineminus">-#define nsRDFCID_h__</span>
<a href="#l49.19"></a><span id="l49.19" class="difflineminus">-</span>
<a href="#l49.20"></a><span id="l49.20" class="difflineminus">-// {0F78DA56-8321-11d2-8EAC-00805F29F370}</span>
<a href="#l49.21"></a><span id="l49.21" class="difflineminus">-#define NS_RDFDEFAULTRESOURCE_CID \</span>
<a href="#l49.22"></a><span id="l49.22" class="difflineminus">-{ 0xf78da56, 0x8321, 0x11d2, { 0x8e, 0xac, 0x0, 0x80, 0x5f, 0x29, 0xf3, 0x70 } }</span>
<a href="#l49.23"></a><span id="l49.23" class="difflineminus">-</span>
<a href="#l49.24"></a><span id="l49.24" class="difflineminus">-// {BFD05264-834C-11d2-8EAC-00805F29F370}</span>
<a href="#l49.25"></a><span id="l49.25" class="difflineminus">-#define NS_RDFSERVICE_CID \</span>
<a href="#l49.26"></a><span id="l49.26" class="difflineminus">-{ 0xbfd05264, 0x834c, 0x11d2, { 0x8e, 0xac, 0x0, 0x80, 0x5f, 0x29, 0xf3, 0x70 } }</span>
<a href="#l49.27"></a><span id="l49.27" class="difflineminus">-</span>
<a href="#l49.28"></a><span id="l49.28" class="difflineminus">-// {BFD0526D-834C-11d2-8EAC-00805F29F370}</span>
<a href="#l49.29"></a><span id="l49.29" class="difflineminus">-#define NS_RDFINMEMORYDATASOURCE_CID \</span>
<a href="#l49.30"></a><span id="l49.30" class="difflineminus">-{ 0xbfd0526d, 0x834c, 0x11d2, { 0x8e, 0xac, 0x0, 0x80, 0x5f, 0x29, 0xf3, 0x70 } }</span>
<a href="#l49.31"></a><span id="l49.31" class="difflineminus">-</span>
<a href="#l49.32"></a><span id="l49.32" class="difflineminus">-// {E638D760-8687-11d2-B530-000000000001}</span>
<a href="#l49.33"></a><span id="l49.33" class="difflineminus">-#define NS_RDFFILESYSTEMDATASOURCE_CID \</span>
<a href="#l49.34"></a><span id="l49.34" class="difflineminus">-{ 0xe638d760, 0x8687, 0x11d2, { 0xb5, 0x30, 0x0, 0x0, 0x0, 0x0, 0x0, 0x01 } }</span>
<a href="#l49.35"></a><span id="l49.35" class="difflineminus">-</span>
<a href="#l49.36"></a><span id="l49.36" class="difflineminus">-// {6bd1d807-1c67-11d3-9820-ed1b357eb3c4}</span>
<a href="#l49.37"></a><span id="l49.37" class="difflineminus">-#define NS_RDFSEARCHDATASOURCE_CID \</span>
<a href="#l49.38"></a><span id="l49.38" class="difflineminus">-{ 0x6bd1d807, 0x1c67, 0x11d3, { 0x98, 0x20, 0xed, 0x1b, 0x35, 0x7e, 0xb3, 0xc4 } }</span>
<a href="#l49.39"></a><span id="l49.39" class="difflineminus">-</span>
<a href="#l49.40"></a><span id="l49.40" class="difflineminus">-// {E638D760-8687-11d2-B530-000000000002}</span>
<a href="#l49.41"></a><span id="l49.41" class="difflineminus">-#define NS_RDFFINDDATASOURCE_CID \</span>
<a href="#l49.42"></a><span id="l49.42" class="difflineminus">-{ 0xe638d760, 0x8687, 0x11d2, { 0xb5, 0x30, 0x0, 0x0, 0x0, 0x0, 0x0, 0x02 } }</span>
<a href="#l49.43"></a><span id="l49.43" class="difflineminus">-</span>
<a href="#l49.44"></a><span id="l49.44" class="difflineminus">-// {E638D761-8687-11d2-B530-000000000000}</span>
<a href="#l49.45"></a><span id="l49.45" class="difflineminus">-#define NS_RDFCOMPOSITEDATASOURCE_CID \</span>
<a href="#l49.46"></a><span id="l49.46" class="difflineminus">-{ 0xe638d761, 0x8687, 0x11d2, { 0xb5, 0x30, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0 } }</span>
<a href="#l49.47"></a><span id="l49.47" class="difflineminus">-</span>
<a href="#l49.48"></a><span id="l49.48" class="difflineminus">-// {7BAF62E0-8E61-11d2-8EB1-00805F29F370}</span>
<a href="#l49.49"></a><span id="l49.49" class="difflineminus">-#define NS_RDFXMLDATASOURCE_CID \</span>
<a href="#l49.50"></a><span id="l49.50" class="difflineminus">-{ 0x7baf62e0, 0x8e61, 0x11d2, { 0x8e, 0xb1, 0x0, 0x80, 0x5f, 0x29, 0xf3, 0x70 } }</span>
<a href="#l49.51"></a><span id="l49.51" class="difflineminus">-</span>
<a href="#l49.52"></a><span id="l49.52" class="difflineminus">-// {0958B101-9ADA-11d2-8EBC-00805F29F370}</span>
<a href="#l49.53"></a><span id="l49.53" class="difflineminus">-#define NS_RDFCONTENTSINK_CID \</span>
<a href="#l49.54"></a><span id="l49.54" class="difflineminus">-{ 0x958b101, 0x9ada, 0x11d2, { 0x8e, 0xbc, 0x0, 0x80, 0x5f, 0x29, 0xf3, 0x70 } }</span>
<a href="#l49.55"></a><span id="l49.55" class="difflineminus">-</span>
<a href="#l49.56"></a><span id="l49.56" class="difflineminus">-// {1EAAFD60-D596-11d2-80BE-006097B76B8E}</span>
<a href="#l49.57"></a><span id="l49.57" class="difflineminus">-#define NS_RDFHISTORYDATASOURCE_CID \</span>
<a href="#l49.58"></a><span id="l49.58" class="difflineminus">-{ 0x1eaafd60, 0xd596, 0x11d2, { 0x80, 0xbe, 0x0, 0x60, 0x97, 0xb7, 0x6b, 0x8e } }</span>
<a href="#l49.59"></a><span id="l49.59" class="difflineminus">-</span>
<a href="#l49.60"></a><span id="l49.60" class="difflineminus">-// {D4214E92-FB94-11d2-BDD8-00104BDE6048}</span>
<a href="#l49.61"></a><span id="l49.61" class="difflineminus">-#define NS_RDFCONTAINERUTILS_CID \</span>
<a href="#l49.62"></a><span id="l49.62" class="difflineminus">-{ 0xd4214e92, 0xfb94, 0x11d2, { 0xbd, 0xd8, 0x0, 0x10, 0x4b, 0xde, 0x60, 0x48 } }</span>
<a href="#l49.63"></a><span id="l49.63" class="difflineminus">-</span>
<a href="#l49.64"></a><span id="l49.64" class="difflineminus">-// {D4214E93-FB94-11d2-BDD8-00104BDE6048}</span>
<a href="#l49.65"></a><span id="l49.65" class="difflineminus">-#define NS_RDFCONTAINER_CID \</span>
<a href="#l49.66"></a><span id="l49.66" class="difflineminus">-{ 0xd4214e93, 0xfb94, 0x11d2, { 0xbd, 0xd8, 0x0, 0x10, 0x4b, 0xde, 0x60, 0x48 } }</span>
<a href="#l49.67"></a><span id="l49.67" class="difflineminus">-</span>
<a href="#l49.68"></a><span id="l49.68" class="difflineminus">-// {0032d852-1dd2-11b2-95f7-e0a1910ed2da}</span>
<a href="#l49.69"></a><span id="l49.69" class="difflineminus">-#define NS_RDFXMLSERIALIZER_CID \</span>
<a href="#l49.70"></a><span id="l49.70" class="difflineminus">-{ 0x0032d852, 0x1dd2, 0x11b2, { 0x95, 0xf7, 0xe0, 0xa1, 0x91, 0x0e, 0xd2, 0xda } }</span>
<a href="#l49.71"></a><span id="l49.71" class="difflineminus">-</span>
<a href="#l49.72"></a><span id="l49.72" class="difflineminus">-// {a4048e94-1dd1-11b2-a676-8a06c086cc7d}</span>
<a href="#l49.73"></a><span id="l49.73" class="difflineminus">-#define NS_RDFXMLPARSER_CID \</span>
<a href="#l49.74"></a><span id="l49.74" class="difflineminus">-{ 0xa4048e94, 0x1dd1, 0x11b2, { 0xa6, 0x76, 0x8a, 0x06, 0xc0, 0x86, 0xcc, 0x7d } }</span>
<a href="#l49.75"></a><span id="l49.75" class="difflineminus">-</span>
<a href="#l49.76"></a><span id="l49.76" class="difflineminus">-// {0a5cd734-eb65-4d14-88a0-9f0bb2aba206}</span>
<a href="#l49.77"></a><span id="l49.77" class="difflineminus">-#define NS_RDFNTRIPLES_SERIALIZER_CID \</span>
<a href="#l49.78"></a><span id="l49.78" class="difflineminus">-{ 0x0a5cd734, 0xeb65, 0x4d14, { 0x88, 0xa0, 0x9f, 0x0b, 0xb2, 0xab, 0xa2, 0x06 } }</span>
<a href="#l49.79"></a><span id="l49.79" class="difflineminus">-</span>
<a href="#l49.80"></a><span id="l49.80" class="difflineminus">-#endif // nsRDFCID_h__</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l50.1"></a><span id="l50.1">deleted file mode 100644</span>
<a href="#l50.2"></a><span id="l50.2" class="difflineminus">--- a/rdf/build/nsRDFModule.cpp</span>
<a href="#l50.3"></a><span id="l50.3" class="difflineplus">+++ /dev/null</span>
<a href="#l50.4"></a><span id="l50.4" class="difflineat">@@ -1,118 +0,0 @@</span>
<a href="#l50.5"></a><span id="l50.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l50.6"></a><span id="l50.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l50.7"></a><span id="l50.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l50.8"></a><span id="l50.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l50.9"></a><span id="l50.9" class="difflineminus">-#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l50.10"></a><span id="l50.10" class="difflineminus">-#include &quot;mozilla/ModuleUtils.h&quot;</span>
<a href="#l50.11"></a><span id="l50.11" class="difflineminus">-</span>
<a href="#l50.12"></a><span id="l50.12" class="difflineminus">-#include &quot;nsIFactory.h&quot;</span>
<a href="#l50.13"></a><span id="l50.13" class="difflineminus">-#include &quot;nsRDFService.h&quot;</span>
<a href="#l50.14"></a><span id="l50.14" class="difflineminus">-#include &quot;nsIRDFContainer.h&quot;</span>
<a href="#l50.15"></a><span id="l50.15" class="difflineminus">-#include &quot;nsIRDFContainerUtils.h&quot;</span>
<a href="#l50.16"></a><span id="l50.16" class="difflineminus">-#include &quot;nsIRDFCompositeDataSource.h&quot;</span>
<a href="#l50.17"></a><span id="l50.17" class="difflineminus">-#include &quot;nsIRDFContentSink.h&quot;</span>
<a href="#l50.18"></a><span id="l50.18" class="difflineminus">-#include &quot;nsISupports.h&quot;</span>
<a href="#l50.19"></a><span id="l50.19" class="difflineminus">-#include &quot;nsRDFBaseDataSources.h&quot;</span>
<a href="#l50.20"></a><span id="l50.20" class="difflineminus">-#include &quot;nsRDFBuiltInDataSources.h&quot;</span>
<a href="#l50.21"></a><span id="l50.21" class="difflineminus">-#include &quot;nsRDFCID.h&quot;</span>
<a href="#l50.22"></a><span id="l50.22" class="difflineminus">-#include &quot;nsIComponentManager.h&quot;</span>
<a href="#l50.23"></a><span id="l50.23" class="difflineminus">-#include &quot;rdf.h&quot;</span>
<a href="#l50.24"></a><span id="l50.24" class="difflineminus">-#include &quot;nsIServiceManager.h&quot;</span>
<a href="#l50.25"></a><span id="l50.25" class="difflineminus">-#include &quot;nsILocalStore.h&quot;</span>
<a href="#l50.26"></a><span id="l50.26" class="difflineminus">-#include &quot;nsRDFXMLParser.h&quot;</span>
<a href="#l50.27"></a><span id="l50.27" class="difflineminus">-#include &quot;nsRDFXMLSerializer.h&quot;</span>
<a href="#l50.28"></a><span id="l50.28" class="difflineminus">-</span>
<a href="#l50.29"></a><span id="l50.29" class="difflineminus">-//----------------------------------------------------------------------</span>
<a href="#l50.30"></a><span id="l50.30" class="difflineminus">-</span>
<a href="#l50.31"></a><span id="l50.31" class="difflineminus">-// Functions used to create new instances of a given object by the</span>
<a href="#l50.32"></a><span id="l50.32" class="difflineminus">-// generic factory.</span>
<a href="#l50.33"></a><span id="l50.33" class="difflineminus">-</span>
<a href="#l50.34"></a><span id="l50.34" class="difflineminus">-#define MAKE_CTOR(_func,_new,_ifname)                                \</span>
<a href="#l50.35"></a><span id="l50.35" class="difflineminus">-static nsresult                                                      \</span>
<a href="#l50.36"></a><span id="l50.36" class="difflineminus">-CreateNew##_func(nsISupports* aOuter, REFNSIID aIID, void **aResult) \</span>
<a href="#l50.37"></a><span id="l50.37" class="difflineminus">-{                                                                    \</span>
<a href="#l50.38"></a><span id="l50.38" class="difflineminus">-    if (!aResult) {                                                  \</span>
<a href="#l50.39"></a><span id="l50.39" class="difflineminus">-        return NS_ERROR_INVALID_POINTER;                             \</span>
<a href="#l50.40"></a><span id="l50.40" class="difflineminus">-    }                                                                \</span>
<a href="#l50.41"></a><span id="l50.41" class="difflineminus">-    if (aOuter) {                                                    \</span>
<a href="#l50.42"></a><span id="l50.42" class="difflineminus">-        *aResult = nullptr;                                           \</span>
<a href="#l50.43"></a><span id="l50.43" class="difflineminus">-        return NS_ERROR_NO_AGGREGATION;                              \</span>
<a href="#l50.44"></a><span id="l50.44" class="difflineminus">-    }                                                                \</span>
<a href="#l50.45"></a><span id="l50.45" class="difflineminus">-    nsI##_ifname* inst;                                              \</span>
<a href="#l50.46"></a><span id="l50.46" class="difflineminus">-    nsresult rv = NS_New##_new(&amp;inst);                               \</span>
<a href="#l50.47"></a><span id="l50.47" class="difflineminus">-    if (NS_FAILED(rv)) {                                             \</span>
<a href="#l50.48"></a><span id="l50.48" class="difflineminus">-        *aResult = nullptr;                                           \</span>
<a href="#l50.49"></a><span id="l50.49" class="difflineminus">-        return rv;                                                   \</span>
<a href="#l50.50"></a><span id="l50.50" class="difflineminus">-    }                                                                \</span>
<a href="#l50.51"></a><span id="l50.51" class="difflineminus">-    rv = inst-&gt;QueryInterface(aIID, aResult);                        \</span>
<a href="#l50.52"></a><span id="l50.52" class="difflineminus">-    if (NS_FAILED(rv)) {                                             \</span>
<a href="#l50.53"></a><span id="l50.53" class="difflineminus">-        *aResult = nullptr;                                           \</span>
<a href="#l50.54"></a><span id="l50.54" class="difflineminus">-    }                                                                \</span>
<a href="#l50.55"></a><span id="l50.55" class="difflineminus">-    NS_RELEASE(inst);             /* get rid of extra refcnt */      \</span>
<a href="#l50.56"></a><span id="l50.56" class="difflineminus">-    return rv;                                                       \</span>
<a href="#l50.57"></a><span id="l50.57" class="difflineminus">-}</span>
<a href="#l50.58"></a><span id="l50.58" class="difflineminus">-</span>
<a href="#l50.59"></a><span id="l50.59" class="difflineminus">-extern nsresult</span>
<a href="#l50.60"></a><span id="l50.60" class="difflineminus">-NS_NewDefaultResource(nsIRDFResource** aResult);</span>
<a href="#l50.61"></a><span id="l50.61" class="difflineminus">-</span>
<a href="#l50.62"></a><span id="l50.62" class="difflineminus">-MAKE_CTOR(RDFXMLDataSource,RDFXMLDataSource,RDFDataSource)</span>
<a href="#l50.63"></a><span id="l50.63" class="difflineminus">-MAKE_CTOR(RDFCompositeDataSource,RDFCompositeDataSource,RDFCompositeDataSource)</span>
<a href="#l50.64"></a><span id="l50.64" class="difflineminus">-MAKE_CTOR(RDFContainer,RDFContainer,RDFContainer)</span>
<a href="#l50.65"></a><span id="l50.65" class="difflineminus">-</span>
<a href="#l50.66"></a><span id="l50.66" class="difflineminus">-MAKE_CTOR(RDFContainerUtils,RDFContainerUtils,RDFContainerUtils)</span>
<a href="#l50.67"></a><span id="l50.67" class="difflineminus">-</span>
<a href="#l50.68"></a><span id="l50.68" class="difflineminus">-MAKE_CTOR(RDFContentSink,RDFContentSink,RDFContentSink)</span>
<a href="#l50.69"></a><span id="l50.69" class="difflineminus">-MAKE_CTOR(RDFDefaultResource,DefaultResource,RDFResource)</span>
<a href="#l50.70"></a><span id="l50.70" class="difflineminus">-</span>
<a href="#l50.71"></a><span id="l50.71" class="difflineminus">-NS_DEFINE_NAMED_CID(NS_RDFCOMPOSITEDATASOURCE_CID);</span>
<a href="#l50.72"></a><span id="l50.72" class="difflineminus">-NS_DEFINE_NAMED_CID(NS_RDFINMEMORYDATASOURCE_CID);</span>
<a href="#l50.73"></a><span id="l50.73" class="difflineminus">-NS_DEFINE_NAMED_CID(NS_RDFXMLDATASOURCE_CID);</span>
<a href="#l50.74"></a><span id="l50.74" class="difflineminus">-NS_DEFINE_NAMED_CID(NS_RDFDEFAULTRESOURCE_CID);</span>
<a href="#l50.75"></a><span id="l50.75" class="difflineminus">-NS_DEFINE_NAMED_CID(NS_RDFCONTENTSINK_CID);</span>
<a href="#l50.76"></a><span id="l50.76" class="difflineminus">-NS_DEFINE_NAMED_CID(NS_RDFCONTAINER_CID);</span>
<a href="#l50.77"></a><span id="l50.77" class="difflineminus">-NS_DEFINE_NAMED_CID(NS_RDFCONTAINERUTILS_CID);</span>
<a href="#l50.78"></a><span id="l50.78" class="difflineminus">-NS_DEFINE_NAMED_CID(NS_RDFSERVICE_CID);</span>
<a href="#l50.79"></a><span id="l50.79" class="difflineminus">-NS_DEFINE_NAMED_CID(NS_RDFXMLPARSER_CID);</span>
<a href="#l50.80"></a><span id="l50.80" class="difflineminus">-NS_DEFINE_NAMED_CID(NS_RDFXMLSERIALIZER_CID);</span>
<a href="#l50.81"></a><span id="l50.81" class="difflineminus">-NS_DEFINE_NAMED_CID(NS_LOCALSTORE_CID);</span>
<a href="#l50.82"></a><span id="l50.82" class="difflineminus">-</span>
<a href="#l50.83"></a><span id="l50.83" class="difflineminus">-</span>
<a href="#l50.84"></a><span id="l50.84" class="difflineminus">-static const mozilla::Module::CIDEntry kRDFCIDs[] = {</span>
<a href="#l50.85"></a><span id="l50.85" class="difflineminus">-    { &amp;kNS_RDFCOMPOSITEDATASOURCE_CID, false, nullptr, CreateNewRDFCompositeDataSource },</span>
<a href="#l50.86"></a><span id="l50.86" class="difflineminus">-    { &amp;kNS_RDFINMEMORYDATASOURCE_CID, false, nullptr, NS_NewRDFInMemoryDataSource },</span>
<a href="#l50.87"></a><span id="l50.87" class="difflineminus">-    { &amp;kNS_RDFXMLDATASOURCE_CID, false, nullptr, CreateNewRDFXMLDataSource },</span>
<a href="#l50.88"></a><span id="l50.88" class="difflineminus">-    { &amp;kNS_RDFDEFAULTRESOURCE_CID, false, nullptr, CreateNewRDFDefaultResource },</span>
<a href="#l50.89"></a><span id="l50.89" class="difflineminus">-    { &amp;kNS_RDFCONTENTSINK_CID, false, nullptr, CreateNewRDFContentSink },</span>
<a href="#l50.90"></a><span id="l50.90" class="difflineminus">-    { &amp;kNS_RDFCONTAINER_CID, false, nullptr, CreateNewRDFContainer },</span>
<a href="#l50.91"></a><span id="l50.91" class="difflineminus">-    { &amp;kNS_RDFCONTAINERUTILS_CID, false, nullptr, CreateNewRDFContainerUtils },</span>
<a href="#l50.92"></a><span id="l50.92" class="difflineminus">-    { &amp;kNS_RDFSERVICE_CID, false, nullptr, RDFServiceImpl::CreateSingleton },</span>
<a href="#l50.93"></a><span id="l50.93" class="difflineminus">-    { &amp;kNS_RDFXMLPARSER_CID, false, nullptr, nsRDFXMLParser::Create },</span>
<a href="#l50.94"></a><span id="l50.94" class="difflineminus">-    { &amp;kNS_RDFXMLSERIALIZER_CID, false, nullptr, nsRDFXMLSerializer::Create },</span>
<a href="#l50.95"></a><span id="l50.95" class="difflineminus">-    { &amp;kNS_LOCALSTORE_CID, false, nullptr, NS_NewLocalStore },</span>
<a href="#l50.96"></a><span id="l50.96" class="difflineminus">-    { nullptr }</span>
<a href="#l50.97"></a><span id="l50.97" class="difflineminus">-};</span>
<a href="#l50.98"></a><span id="l50.98" class="difflineminus">-</span>
<a href="#l50.99"></a><span id="l50.99" class="difflineminus">-static const mozilla::Module::ContractIDEntry kRDFContracts[] = {</span>
<a href="#l50.100"></a><span id="l50.100" class="difflineminus">-    { NS_RDF_DATASOURCE_CONTRACTID_PREFIX &quot;composite-datasource&quot;, &amp;kNS_RDFCOMPOSITEDATASOURCE_CID },</span>
<a href="#l50.101"></a><span id="l50.101" class="difflineminus">-    { NS_RDF_DATASOURCE_CONTRACTID_PREFIX &quot;in-memory-datasource&quot;, &amp;kNS_RDFINMEMORYDATASOURCE_CID },</span>
<a href="#l50.102"></a><span id="l50.102" class="difflineminus">-    { NS_RDF_DATASOURCE_CONTRACTID_PREFIX &quot;xml-datasource&quot;, &amp;kNS_RDFXMLDATASOURCE_CID },</span>
<a href="#l50.103"></a><span id="l50.103" class="difflineminus">-    { NS_RDF_RESOURCE_FACTORY_CONTRACTID, &amp;kNS_RDFDEFAULTRESOURCE_CID },</span>
<a href="#l50.104"></a><span id="l50.104" class="difflineminus">-    { NS_RDF_CONTRACTID &quot;/content-sink;1&quot;, &amp;kNS_RDFCONTENTSINK_CID },</span>
<a href="#l50.105"></a><span id="l50.105" class="difflineminus">-    { NS_RDF_CONTRACTID &quot;/container;1&quot;, &amp;kNS_RDFCONTAINER_CID },</span>
<a href="#l50.106"></a><span id="l50.106" class="difflineminus">-    { NS_RDF_CONTRACTID &quot;/container-utils;1&quot;, &amp;kNS_RDFCONTAINERUTILS_CID },</span>
<a href="#l50.107"></a><span id="l50.107" class="difflineminus">-    { NS_RDF_CONTRACTID &quot;/rdf-service;1&quot;, &amp;kNS_RDFSERVICE_CID },</span>
<a href="#l50.108"></a><span id="l50.108" class="difflineminus">-    { NS_RDF_CONTRACTID &quot;/xml-parser;1&quot;, &amp;kNS_RDFXMLPARSER_CID },</span>
<a href="#l50.109"></a><span id="l50.109" class="difflineminus">-    { NS_RDF_CONTRACTID &quot;/xml-serializer;1&quot;, &amp;kNS_RDFXMLSERIALIZER_CID },</span>
<a href="#l50.110"></a><span id="l50.110" class="difflineminus">-    { NS_LOCALSTORE_CONTRACTID, &amp;kNS_LOCALSTORE_CID },</span>
<a href="#l50.111"></a><span id="l50.111" class="difflineminus">-    { nullptr }</span>
<a href="#l50.112"></a><span id="l50.112" class="difflineminus">-};</span>
<a href="#l50.113"></a><span id="l50.113" class="difflineminus">-</span>
<a href="#l50.114"></a><span id="l50.114" class="difflineminus">-extern const mozilla::Module kRDFModule = {</span>
<a href="#l50.115"></a><span id="l50.115" class="difflineminus">-    mozilla::Module::kVersion,</span>
<a href="#l50.116"></a><span id="l50.116" class="difflineminus">-    kRDFCIDs,</span>
<a href="#l50.117"></a><span id="l50.117" class="difflineminus">-    kRDFContracts,</span>
<a href="#l50.118"></a><span id="l50.118" class="difflineminus">-    nullptr,</span>
<a href="#l50.119"></a><span id="l50.119" class="difflineminus">-    nullptr,</span>
<a href="#l50.120"></a><span id="l50.120" class="difflineminus">-    nullptr,</span>
<a href="#l50.121"></a><span id="l50.121" class="difflineminus">-    nullptr</span>
<a href="#l50.122"></a><span id="l50.122" class="difflineminus">-};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l51.1"></a><span id="l51.1">deleted file mode 100644</span>
<a href="#l51.2"></a><span id="l51.2" class="difflineminus">--- a/rdf/datasource/moz.build</span>
<a href="#l51.3"></a><span id="l51.3" class="difflineplus">+++ /dev/null</span>
<a href="#l51.4"></a><span id="l51.4" class="difflineat">@@ -1,21 +0,0 @@</span>
<a href="#l51.5"></a><span id="l51.5" class="difflineminus">-# -*- Mode: python; indent-tabs-mode: nil; tab-width: 40 -*-</span>
<a href="#l51.6"></a><span id="l51.6" class="difflineminus">-# vim: set filetype=python:</span>
<a href="#l51.7"></a><span id="l51.7" class="difflineminus">-# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l51.8"></a><span id="l51.8" class="difflineminus">-# License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l51.9"></a><span id="l51.9" class="difflineminus">-# file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l51.10"></a><span id="l51.10" class="difflineminus">-</span>
<a href="#l51.11"></a><span id="l51.11" class="difflineminus">-EXPORTS += [</span>
<a href="#l51.12"></a><span id="l51.12" class="difflineminus">-    'nsILocalStore.h',</span>
<a href="#l51.13"></a><span id="l51.13" class="difflineminus">-]</span>
<a href="#l51.14"></a><span id="l51.14" class="difflineminus">-</span>
<a href="#l51.15"></a><span id="l51.15" class="difflineminus">-UNIFIED_SOURCES += [</span>
<a href="#l51.16"></a><span id="l51.16" class="difflineminus">-    'nsLocalStore.cpp',</span>
<a href="#l51.17"></a><span id="l51.17" class="difflineminus">-]</span>
<a href="#l51.18"></a><span id="l51.18" class="difflineminus">-</span>
<a href="#l51.19"></a><span id="l51.19" class="difflineminus">-FINAL_LIBRARY = 'xul'</span>
<a href="#l51.20"></a><span id="l51.20" class="difflineminus">-</span>
<a href="#l51.21"></a><span id="l51.21" class="difflineminus">-# &quot;This is a dependency on rdfutil.h: it'll go away once that becomes</span>
<a href="#l51.22"></a><span id="l51.22" class="difflineminus">-# a first-class XPCOM interface.&quot;</span>
<a href="#l51.23"></a><span id="l51.23" class="difflineminus">-LOCAL_INCLUDES += [</span>
<a href="#l51.24"></a><span id="l51.24" class="difflineminus">-    '../base',</span>
<a href="#l51.25"></a><span id="l51.25" class="difflineminus">-]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l52.1"></a><span id="l52.1">deleted file mode 100644</span>
<a href="#l52.2"></a><span id="l52.2" class="difflineminus">--- a/rdf/datasource/nsILocalStore.h</span>
<a href="#l52.3"></a><span id="l52.3" class="difflineplus">+++ /dev/null</span>
<a href="#l52.4"></a><span id="l52.4" class="difflineat">@@ -1,34 +0,0 @@</span>
<a href="#l52.5"></a><span id="l52.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l52.6"></a><span id="l52.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l52.7"></a><span id="l52.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l52.8"></a><span id="l52.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l52.9"></a><span id="l52.9" class="difflineminus">-</span>
<a href="#l52.10"></a><span id="l52.10" class="difflineminus">-#ifndef nsILocalStore_h__</span>
<a href="#l52.11"></a><span id="l52.11" class="difflineminus">-#define nsILocalStore_h__</span>
<a href="#l52.12"></a><span id="l52.12" class="difflineminus">-</span>
<a href="#l52.13"></a><span id="l52.13" class="difflineminus">-#include &quot;rdf.h&quot;</span>
<a href="#l52.14"></a><span id="l52.14" class="difflineminus">-#include &quot;nsISupports.h&quot;</span>
<a href="#l52.15"></a><span id="l52.15" class="difflineminus">-</span>
<a href="#l52.16"></a><span id="l52.16" class="difflineminus">-// {DF71C6F1-EC53-11d2-BDCA-000064657374}</span>
<a href="#l52.17"></a><span id="l52.17" class="difflineminus">-#define NS_ILOCALSTORE_IID \</span>
<a href="#l52.18"></a><span id="l52.18" class="difflineminus">-{ 0xdf71c6f1, 0xec53, 0x11d2, { 0xbd, 0xca, 0x0, 0x0, 0x64, 0x65, 0x73, 0x74 } }</span>
<a href="#l52.19"></a><span id="l52.19" class="difflineminus">-</span>
<a href="#l52.20"></a><span id="l52.20" class="difflineminus">-// {DF71C6F0-EC53-11d2-BDCA-000064657374}</span>
<a href="#l52.21"></a><span id="l52.21" class="difflineminus">-#define NS_LOCALSTORE_CID \</span>
<a href="#l52.22"></a><span id="l52.22" class="difflineminus">-{ 0xdf71c6f0, 0xec53, 0x11d2, { 0xbd, 0xca, 0x0, 0x0, 0x64, 0x65, 0x73, 0x74 } }</span>
<a href="#l52.23"></a><span id="l52.23" class="difflineminus">-</span>
<a href="#l52.24"></a><span id="l52.24" class="difflineminus">-#define NS_LOCALSTORE_CONTRACTID NS_RDF_DATASOURCE_CONTRACTID_PREFIX &quot;local-store&quot;</span>
<a href="#l52.25"></a><span id="l52.25" class="difflineminus">-</span>
<a href="#l52.26"></a><span id="l52.26" class="difflineminus">-class nsILocalStore : public nsISupports</span>
<a href="#l52.27"></a><span id="l52.27" class="difflineminus">-{</span>
<a href="#l52.28"></a><span id="l52.28" class="difflineminus">-public:</span>
<a href="#l52.29"></a><span id="l52.29" class="difflineminus">-    NS_DECLARE_STATIC_IID_ACCESSOR(NS_ILOCALSTORE_IID)</span>
<a href="#l52.30"></a><span id="l52.30" class="difflineminus">-};</span>
<a href="#l52.31"></a><span id="l52.31" class="difflineminus">-</span>
<a href="#l52.32"></a><span id="l52.32" class="difflineminus">-NS_DEFINE_STATIC_IID_ACCESSOR(nsILocalStore, NS_ILOCALSTORE_IID)</span>
<a href="#l52.33"></a><span id="l52.33" class="difflineminus">-</span>
<a href="#l52.34"></a><span id="l52.34" class="difflineminus">-extern nsresult</span>
<a href="#l52.35"></a><span id="l52.35" class="difflineminus">-NS_NewLocalStore(nsISupports* aOuter, REFNSIID aIID, void** aResult);</span>
<a href="#l52.36"></a><span id="l52.36" class="difflineminus">-</span>
<a href="#l52.37"></a><span id="l52.37" class="difflineminus">-</span>
<a href="#l52.38"></a><span id="l52.38" class="difflineminus">-#endif // nsILocalStore_h__</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l53.1"></a><span id="l53.1">deleted file mode 100644</span>
<a href="#l53.2"></a><span id="l53.2" class="difflineminus">--- a/rdf/datasource/nsIRDFFTP.h</span>
<a href="#l53.3"></a><span id="l53.3" class="difflineplus">+++ /dev/null</span>
<a href="#l53.4"></a><span id="l53.4" class="difflineat">@@ -1,33 +0,0 @@</span>
<a href="#l53.5"></a><span id="l53.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l53.6"></a><span id="l53.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l53.7"></a><span id="l53.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l53.8"></a><span id="l53.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l53.9"></a><span id="l53.9" class="difflineminus">-</span>
<a href="#l53.10"></a><span id="l53.10" class="difflineminus">-#ifndef	nsIRDFFTP_h__</span>
<a href="#l53.11"></a><span id="l53.11" class="difflineminus">-#define	nsIRDFFTP_h__</span>
<a href="#l53.12"></a><span id="l53.12" class="difflineminus">-</span>
<a href="#l53.13"></a><span id="l53.13" class="difflineminus">-#include &quot;nscore.h&quot;</span>
<a href="#l53.14"></a><span id="l53.14" class="difflineminus">-#include &quot;nsISupports.h&quot;</span>
<a href="#l53.15"></a><span id="l53.15" class="difflineminus">-#include &quot;nsIRDFNode.h&quot;</span>
<a href="#l53.16"></a><span id="l53.16" class="difflineminus">-</span>
<a href="#l53.17"></a><span id="l53.17" class="difflineminus">-</span>
<a href="#l53.18"></a><span id="l53.18" class="difflineminus">-</span>
<a href="#l53.19"></a><span id="l53.19" class="difflineminus">-#define NS_IRDFFTPDATAOURCE_IID \</span>
<a href="#l53.20"></a><span id="l53.20" class="difflineminus">-{ 0x1222e6f0, 0xa5e3, 0x11d2, { 0x8b, 0x7c, 0x00, 0x80, 0x5f, 0x8a, 0x7d, 0xb7 } }</span>
<a href="#l53.21"></a><span id="l53.21" class="difflineminus">-</span>
<a href="#l53.22"></a><span id="l53.22" class="difflineminus">-class nsIRDFFTPDataSource : public nsIRDFDataSource</span>
<a href="#l53.23"></a><span id="l53.23" class="difflineminus">-{</span>
<a href="#l53.24"></a><span id="l53.24" class="difflineminus">-public:</span>
<a href="#l53.25"></a><span id="l53.25" class="difflineminus">-};</span>
<a href="#l53.26"></a><span id="l53.26" class="difflineminus">-</span>
<a href="#l53.27"></a><span id="l53.27" class="difflineminus">-</span>
<a href="#l53.28"></a><span id="l53.28" class="difflineminus">-#define NS_IRDFFTPDATASOURCECALLBACK_IID \</span>
<a href="#l53.29"></a><span id="l53.29" class="difflineminus">-{ 0x204a1a00, 0xa5e4, 0x11d2, { 0x8b, 0x7c, 0x00, 0x80, 0x5f, 0x8a, 0x7d, 0xb8 } }</span>
<a href="#l53.30"></a><span id="l53.30" class="difflineminus">-</span>
<a href="#l53.31"></a><span id="l53.31" class="difflineminus">-class nsIRDFFTPDataSourceCallback : public nsIStreamListener</span>
<a href="#l53.32"></a><span id="l53.32" class="difflineminus">-{</span>
<a href="#l53.33"></a><span id="l53.33" class="difflineminus">-public:</span>
<a href="#l53.34"></a><span id="l53.34" class="difflineminus">-};</span>
<a href="#l53.35"></a><span id="l53.35" class="difflineminus">-</span>
<a href="#l53.36"></a><span id="l53.36" class="difflineminus">-</span>
<a href="#l53.37"></a><span id="l53.37" class="difflineminus">-#endif // nsIRDFFTP_h__</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l54.1"></a><span id="l54.1">deleted file mode 100644</span>
<a href="#l54.2"></a><span id="l54.2" class="difflineminus">--- a/rdf/datasource/nsLocalStore.cpp</span>
<a href="#l54.3"></a><span id="l54.3" class="difflineplus">+++ /dev/null</span>
<a href="#l54.4"></a><span id="l54.4" class="difflineat">@@ -1,477 +0,0 @@</span>
<a href="#l54.5"></a><span id="l54.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l54.6"></a><span id="l54.6" class="difflineminus">-/* vim: set cindent tabstop=4 expandtab shiftwidth=4: */</span>
<a href="#l54.7"></a><span id="l54.7" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l54.8"></a><span id="l54.8" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l54.9"></a><span id="l54.9" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l54.10"></a><span id="l54.10" class="difflineminus">-</span>
<a href="#l54.11"></a><span id="l54.11" class="difflineminus">-/*</span>
<a href="#l54.12"></a><span id="l54.12" class="difflineminus">-</span>
<a href="#l54.13"></a><span id="l54.13" class="difflineminus">-  Implementation for the local store</span>
<a href="#l54.14"></a><span id="l54.14" class="difflineminus">-</span>
<a href="#l54.15"></a><span id="l54.15" class="difflineminus">- */</span>
<a href="#l54.16"></a><span id="l54.16" class="difflineminus">-</span>
<a href="#l54.17"></a><span id="l54.17" class="difflineminus">-#include &quot;nsNetUtil.h&quot;</span>
<a href="#l54.18"></a><span id="l54.18" class="difflineminus">-#include &quot;nsIFile.h&quot;</span>
<a href="#l54.19"></a><span id="l54.19" class="difflineminus">-#include &quot;nsIURI.h&quot;</span>
<a href="#l54.20"></a><span id="l54.20" class="difflineminus">-#include &quot;nsIIOService.h&quot;</span>
<a href="#l54.21"></a><span id="l54.21" class="difflineminus">-#include &quot;nsIOutputStream.h&quot;</span>
<a href="#l54.22"></a><span id="l54.22" class="difflineminus">-#include &quot;nsIComponentManager.h&quot;</span>
<a href="#l54.23"></a><span id="l54.23" class="difflineminus">-#include &quot;nsILocalStore.h&quot;</span>
<a href="#l54.24"></a><span id="l54.24" class="difflineminus">-#include &quot;nsIRDFDataSource.h&quot;</span>
<a href="#l54.25"></a><span id="l54.25" class="difflineminus">-#include &quot;nsIRDFRemoteDataSource.h&quot;</span>
<a href="#l54.26"></a><span id="l54.26" class="difflineminus">-#include &quot;nsIRDFService.h&quot;</span>
<a href="#l54.27"></a><span id="l54.27" class="difflineminus">-#include &quot;nsIServiceManager.h&quot;</span>
<a href="#l54.28"></a><span id="l54.28" class="difflineminus">-#include &quot;nsRDFCID.h&quot;</span>
<a href="#l54.29"></a><span id="l54.29" class="difflineminus">-#include &quot;nsString.h&quot;</span>
<a href="#l54.30"></a><span id="l54.30" class="difflineminus">-#include &quot;plstr.h&quot;</span>
<a href="#l54.31"></a><span id="l54.31" class="difflineminus">-#include &quot;rdf.h&quot;</span>
<a href="#l54.32"></a><span id="l54.32" class="difflineminus">-#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l54.33"></a><span id="l54.33" class="difflineminus">-#include &quot;nsAppDirectoryServiceDefs.h&quot;</span>
<a href="#l54.34"></a><span id="l54.34" class="difflineminus">-#include &quot;nsIObserver.h&quot;</span>
<a href="#l54.35"></a><span id="l54.35" class="difflineminus">-#include &quot;nsIObserverService.h&quot;</span>
<a href="#l54.36"></a><span id="l54.36" class="difflineminus">-#include &quot;nsWeakReference.h&quot;</span>
<a href="#l54.37"></a><span id="l54.37" class="difflineminus">-#include &quot;nsCRTGlue.h&quot;</span>
<a href="#l54.38"></a><span id="l54.38" class="difflineminus">-#include &quot;nsCRT.h&quot;</span>
<a href="#l54.39"></a><span id="l54.39" class="difflineminus">-#include &quot;nsEnumeratorUtils.h&quot;</span>
<a href="#l54.40"></a><span id="l54.40" class="difflineminus">-#include &quot;nsCycleCollectionParticipant.h&quot;</span>
<a href="#l54.41"></a><span id="l54.41" class="difflineminus">-</span>
<a href="#l54.42"></a><span id="l54.42" class="difflineminus">-////////////////////////////////////////////////////////////////////////</span>
<a href="#l54.43"></a><span id="l54.43" class="difflineminus">-</span>
<a href="#l54.44"></a><span id="l54.44" class="difflineminus">-class LocalStoreImpl : public nsILocalStore,</span>
<a href="#l54.45"></a><span id="l54.45" class="difflineminus">-                       public nsIRDFDataSource,</span>
<a href="#l54.46"></a><span id="l54.46" class="difflineminus">-                       public nsIRDFRemoteDataSource,</span>
<a href="#l54.47"></a><span id="l54.47" class="difflineminus">-                       public nsIObserver,</span>
<a href="#l54.48"></a><span id="l54.48" class="difflineminus">-                       public nsSupportsWeakReference</span>
<a href="#l54.49"></a><span id="l54.49" class="difflineminus">-{</span>
<a href="#l54.50"></a><span id="l54.50" class="difflineminus">-protected:</span>
<a href="#l54.51"></a><span id="l54.51" class="difflineminus">-    nsCOMPtr&lt;nsIRDFDataSource&gt; mInner;</span>
<a href="#l54.52"></a><span id="l54.52" class="difflineminus">-</span>
<a href="#l54.53"></a><span id="l54.53" class="difflineminus">-    LocalStoreImpl();</span>
<a href="#l54.54"></a><span id="l54.54" class="difflineminus">-    virtual ~LocalStoreImpl();</span>
<a href="#l54.55"></a><span id="l54.55" class="difflineminus">-    nsresult Init();</span>
<a href="#l54.56"></a><span id="l54.56" class="difflineminus">-    nsresult CreateLocalStore(nsIFile* aFile);</span>
<a href="#l54.57"></a><span id="l54.57" class="difflineminus">-    nsresult LoadData();</span>
<a href="#l54.58"></a><span id="l54.58" class="difflineminus">-</span>
<a href="#l54.59"></a><span id="l54.59" class="difflineminus">-    friend nsresult</span>
<a href="#l54.60"></a><span id="l54.60" class="difflineminus">-    NS_NewLocalStore(nsISupports* aOuter, REFNSIID aIID, void** aResult);</span>
<a href="#l54.61"></a><span id="l54.61" class="difflineminus">-</span>
<a href="#l54.62"></a><span id="l54.62" class="difflineminus">-    nsCOMPtr&lt;nsIRDFService&gt;    mRDFService;</span>
<a href="#l54.63"></a><span id="l54.63" class="difflineminus">-</span>
<a href="#l54.64"></a><span id="l54.64" class="difflineminus">-public:</span>
<a href="#l54.65"></a><span id="l54.65" class="difflineminus">-    // nsISupports interface</span>
<a href="#l54.66"></a><span id="l54.66" class="difflineminus">-    NS_DECL_CYCLE_COLLECTING_ISUPPORTS</span>
<a href="#l54.67"></a><span id="l54.67" class="difflineminus">-    NS_DECL_CYCLE_COLLECTION_CLASS_AMBIGUOUS(LocalStoreImpl, nsILocalStore)</span>
<a href="#l54.68"></a><span id="l54.68" class="difflineminus">-</span>
<a href="#l54.69"></a><span id="l54.69" class="difflineminus">-    // nsILocalStore interface</span>
<a href="#l54.70"></a><span id="l54.70" class="difflineminus">-</span>
<a href="#l54.71"></a><span id="l54.71" class="difflineminus">-    // nsIRDFDataSource interface. Most of these are just delegated to</span>
<a href="#l54.72"></a><span id="l54.72" class="difflineminus">-    // the inner, in-memory datasource.</span>
<a href="#l54.73"></a><span id="l54.73" class="difflineminus">-    NS_IMETHOD GetURI(nsACString&amp; aURI) override;</span>
<a href="#l54.74"></a><span id="l54.74" class="difflineminus">-</span>
<a href="#l54.75"></a><span id="l54.75" class="difflineminus">-    NS_IMETHOD GetSource(nsIRDFResource* aProperty,</span>
<a href="#l54.76"></a><span id="l54.76" class="difflineminus">-                         nsIRDFNode* aTarget,</span>
<a href="#l54.77"></a><span id="l54.77" class="difflineminus">-                         bool aTruthValue,</span>
<a href="#l54.78"></a><span id="l54.78" class="difflineminus">-                         nsIRDFResource** aSource) override {</span>
<a href="#l54.79"></a><span id="l54.79" class="difflineminus">-        return mInner-&gt;GetSource(aProperty, aTarget, aTruthValue, aSource);</span>
<a href="#l54.80"></a><span id="l54.80" class="difflineminus">-    }</span>
<a href="#l54.81"></a><span id="l54.81" class="difflineminus">-</span>
<a href="#l54.82"></a><span id="l54.82" class="difflineminus">-    NS_IMETHOD GetSources(nsIRDFResource* aProperty,</span>
<a href="#l54.83"></a><span id="l54.83" class="difflineminus">-                          nsIRDFNode* aTarget,</span>
<a href="#l54.84"></a><span id="l54.84" class="difflineminus">-                          bool aTruthValue,</span>
<a href="#l54.85"></a><span id="l54.85" class="difflineminus">-                          nsISimpleEnumerator** aSources) override {</span>
<a href="#l54.86"></a><span id="l54.86" class="difflineminus">-        return mInner-&gt;GetSources(aProperty, aTarget, aTruthValue, aSources);</span>
<a href="#l54.87"></a><span id="l54.87" class="difflineminus">-    }</span>
<a href="#l54.88"></a><span id="l54.88" class="difflineminus">-</span>
<a href="#l54.89"></a><span id="l54.89" class="difflineminus">-    NS_IMETHOD GetTarget(nsIRDFResource* aSource,</span>
<a href="#l54.90"></a><span id="l54.90" class="difflineminus">-                         nsIRDFResource* aProperty,</span>
<a href="#l54.91"></a><span id="l54.91" class="difflineminus">-                         bool aTruthValue,</span>
<a href="#l54.92"></a><span id="l54.92" class="difflineminus">-                         nsIRDFNode** aTarget) override {</span>
<a href="#l54.93"></a><span id="l54.93" class="difflineminus">-        return mInner-&gt;GetTarget(aSource, aProperty, aTruthValue, aTarget);</span>
<a href="#l54.94"></a><span id="l54.94" class="difflineminus">-    }</span>
<a href="#l54.95"></a><span id="l54.95" class="difflineminus">-</span>
<a href="#l54.96"></a><span id="l54.96" class="difflineminus">-    NS_IMETHOD GetTargets(nsIRDFResource* aSource,</span>
<a href="#l54.97"></a><span id="l54.97" class="difflineminus">-                          nsIRDFResource* aProperty,</span>
<a href="#l54.98"></a><span id="l54.98" class="difflineminus">-                          bool aTruthValue,</span>
<a href="#l54.99"></a><span id="l54.99" class="difflineminus">-                          nsISimpleEnumerator** aTargets) override {</span>
<a href="#l54.100"></a><span id="l54.100" class="difflineminus">-        return mInner-&gt;GetTargets(aSource, aProperty, aTruthValue, aTargets);</span>
<a href="#l54.101"></a><span id="l54.101" class="difflineminus">-    }</span>
<a href="#l54.102"></a><span id="l54.102" class="difflineminus">-</span>
<a href="#l54.103"></a><span id="l54.103" class="difflineminus">-    NS_IMETHOD Assert(nsIRDFResource* aSource,</span>
<a href="#l54.104"></a><span id="l54.104" class="difflineminus">-                      nsIRDFResource* aProperty,</span>
<a href="#l54.105"></a><span id="l54.105" class="difflineminus">-                      nsIRDFNode* aTarget,</span>
<a href="#l54.106"></a><span id="l54.106" class="difflineminus">-                      bool aTruthValue) override {</span>
<a href="#l54.107"></a><span id="l54.107" class="difflineminus">-        return mInner-&gt;Assert(aSource, aProperty, aTarget, aTruthValue);</span>
<a href="#l54.108"></a><span id="l54.108" class="difflineminus">-    }</span>
<a href="#l54.109"></a><span id="l54.109" class="difflineminus">-</span>
<a href="#l54.110"></a><span id="l54.110" class="difflineminus">-    NS_IMETHOD Unassert(nsIRDFResource* aSource,</span>
<a href="#l54.111"></a><span id="l54.111" class="difflineminus">-                        nsIRDFResource* aProperty,</span>
<a href="#l54.112"></a><span id="l54.112" class="difflineminus">-                        nsIRDFNode* aTarget) override {</span>
<a href="#l54.113"></a><span id="l54.113" class="difflineminus">-        return mInner-&gt;Unassert(aSource, aProperty, aTarget);</span>
<a href="#l54.114"></a><span id="l54.114" class="difflineminus">-    }</span>
<a href="#l54.115"></a><span id="l54.115" class="difflineminus">-</span>
<a href="#l54.116"></a><span id="l54.116" class="difflineminus">-    NS_IMETHOD Change(nsIRDFResource* aSource,</span>
<a href="#l54.117"></a><span id="l54.117" class="difflineminus">-                      nsIRDFResource* aProperty,</span>
<a href="#l54.118"></a><span id="l54.118" class="difflineminus">-                      nsIRDFNode* aOldTarget,</span>
<a href="#l54.119"></a><span id="l54.119" class="difflineminus">-                      nsIRDFNode* aNewTarget) override {</span>
<a href="#l54.120"></a><span id="l54.120" class="difflineminus">-        return mInner-&gt;Change(aSource, aProperty, aOldTarget, aNewTarget);</span>
<a href="#l54.121"></a><span id="l54.121" class="difflineminus">-    }</span>
<a href="#l54.122"></a><span id="l54.122" class="difflineminus">-</span>
<a href="#l54.123"></a><span id="l54.123" class="difflineminus">-    NS_IMETHOD Move(nsIRDFResource* aOldSource,</span>
<a href="#l54.124"></a><span id="l54.124" class="difflineminus">-                    nsIRDFResource* aNewSource,</span>
<a href="#l54.125"></a><span id="l54.125" class="difflineminus">-                    nsIRDFResource* aProperty,</span>
<a href="#l54.126"></a><span id="l54.126" class="difflineminus">-                    nsIRDFNode* aTarget) override {</span>
<a href="#l54.127"></a><span id="l54.127" class="difflineminus">-        return mInner-&gt;Move(aOldSource, aNewSource, aProperty, aTarget);</span>
<a href="#l54.128"></a><span id="l54.128" class="difflineminus">-    }</span>
<a href="#l54.129"></a><span id="l54.129" class="difflineminus">-</span>
<a href="#l54.130"></a><span id="l54.130" class="difflineminus">-    NS_IMETHOD HasAssertion(nsIRDFResource* aSource,</span>
<a href="#l54.131"></a><span id="l54.131" class="difflineminus">-                            nsIRDFResource* aProperty,</span>
<a href="#l54.132"></a><span id="l54.132" class="difflineminus">-                            nsIRDFNode* aTarget,</span>
<a href="#l54.133"></a><span id="l54.133" class="difflineminus">-                            bool aTruthValue,</span>
<a href="#l54.134"></a><span id="l54.134" class="difflineminus">-                            bool* hasAssertion) override {</span>
<a href="#l54.135"></a><span id="l54.135" class="difflineminus">-        return mInner-&gt;HasAssertion(aSource, aProperty, aTarget, aTruthValue, hasAssertion);</span>
<a href="#l54.136"></a><span id="l54.136" class="difflineminus">-    }</span>
<a href="#l54.137"></a><span id="l54.137" class="difflineminus">-</span>
<a href="#l54.138"></a><span id="l54.138" class="difflineminus">-    NS_IMETHOD AddObserver(nsIRDFObserver* aObserver) override {</span>
<a href="#l54.139"></a><span id="l54.139" class="difflineminus">-        return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l54.140"></a><span id="l54.140" class="difflineminus">-    }</span>
<a href="#l54.141"></a><span id="l54.141" class="difflineminus">-</span>
<a href="#l54.142"></a><span id="l54.142" class="difflineminus">-    NS_IMETHOD RemoveObserver(nsIRDFObserver* aObserver) override {</span>
<a href="#l54.143"></a><span id="l54.143" class="difflineminus">-        return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l54.144"></a><span id="l54.144" class="difflineminus">-    }</span>
<a href="#l54.145"></a><span id="l54.145" class="difflineminus">-</span>
<a href="#l54.146"></a><span id="l54.146" class="difflineminus">-    NS_IMETHOD HasArcIn(nsIRDFNode *aNode, nsIRDFResource *aArc, bool *_retval) override {</span>
<a href="#l54.147"></a><span id="l54.147" class="difflineminus">-        return mInner-&gt;HasArcIn(aNode, aArc, _retval);</span>
<a href="#l54.148"></a><span id="l54.148" class="difflineminus">-    }</span>
<a href="#l54.149"></a><span id="l54.149" class="difflineminus">-</span>
<a href="#l54.150"></a><span id="l54.150" class="difflineminus">-    NS_IMETHOD HasArcOut(nsIRDFResource *aSource, nsIRDFResource *aArc, bool *_retval) override {</span>
<a href="#l54.151"></a><span id="l54.151" class="difflineminus">-        return mInner-&gt;HasArcOut(aSource, aArc, _retval);</span>
<a href="#l54.152"></a><span id="l54.152" class="difflineminus">-    }</span>
<a href="#l54.153"></a><span id="l54.153" class="difflineminus">-</span>
<a href="#l54.154"></a><span id="l54.154" class="difflineminus">-    NS_IMETHOD ArcLabelsIn(nsIRDFNode* aNode,</span>
<a href="#l54.155"></a><span id="l54.155" class="difflineminus">-                           nsISimpleEnumerator** aLabels) override {</span>
<a href="#l54.156"></a><span id="l54.156" class="difflineminus">-        return mInner-&gt;ArcLabelsIn(aNode, aLabels);</span>
<a href="#l54.157"></a><span id="l54.157" class="difflineminus">-    }</span>
<a href="#l54.158"></a><span id="l54.158" class="difflineminus">-</span>
<a href="#l54.159"></a><span id="l54.159" class="difflineminus">-    NS_IMETHOD ArcLabelsOut(nsIRDFResource* aSource,</span>
<a href="#l54.160"></a><span id="l54.160" class="difflineminus">-                            nsISimpleEnumerator** aLabels) override {</span>
<a href="#l54.161"></a><span id="l54.161" class="difflineminus">-        return mInner-&gt;ArcLabelsOut(aSource, aLabels);</span>
<a href="#l54.162"></a><span id="l54.162" class="difflineminus">-    }</span>
<a href="#l54.163"></a><span id="l54.163" class="difflineminus">-</span>
<a href="#l54.164"></a><span id="l54.164" class="difflineminus">-    NS_IMETHOD GetAllResources(nsISimpleEnumerator** aResult) override {</span>
<a href="#l54.165"></a><span id="l54.165" class="difflineminus">-        return mInner-&gt;GetAllResources(aResult);</span>
<a href="#l54.166"></a><span id="l54.166" class="difflineminus">-    }</span>
<a href="#l54.167"></a><span id="l54.167" class="difflineminus">-</span>
<a href="#l54.168"></a><span id="l54.168" class="difflineminus">-    NS_IMETHOD GetAllCmds(nsIRDFResource* aSource,</span>
<a href="#l54.169"></a><span id="l54.169" class="difflineminus">-                              nsISimpleEnumerator/*&lt;nsIRDFResource&gt;*/** aCommands) override;</span>
<a href="#l54.170"></a><span id="l54.170" class="difflineminus">-</span>
<a href="#l54.171"></a><span id="l54.171" class="difflineminus">-    NS_IMETHOD IsCommandEnabled(nsISupports* aSources,</span>
<a href="#l54.172"></a><span id="l54.172" class="difflineminus">-                                nsIRDFResource*   aCommand,</span>
<a href="#l54.173"></a><span id="l54.173" class="difflineminus">-                                nsISupports* aArguments,</span>
<a href="#l54.174"></a><span id="l54.174" class="difflineminus">-                                bool* aResult) override;</span>
<a href="#l54.175"></a><span id="l54.175" class="difflineminus">-</span>
<a href="#l54.176"></a><span id="l54.176" class="difflineminus">-    NS_IMETHOD DoCommand(nsISupports* aSources,</span>
<a href="#l54.177"></a><span id="l54.177" class="difflineminus">-                         nsIRDFResource*   aCommand,</span>
<a href="#l54.178"></a><span id="l54.178" class="difflineminus">-                         nsISupports* aArguments) override;</span>
<a href="#l54.179"></a><span id="l54.179" class="difflineminus">-</span>
<a href="#l54.180"></a><span id="l54.180" class="difflineminus">-    NS_IMETHOD BeginUpdateBatch() override {</span>
<a href="#l54.181"></a><span id="l54.181" class="difflineminus">-        return mInner-&gt;BeginUpdateBatch();</span>
<a href="#l54.182"></a><span id="l54.182" class="difflineminus">-    }</span>
<a href="#l54.183"></a><span id="l54.183" class="difflineminus">-</span>
<a href="#l54.184"></a><span id="l54.184" class="difflineminus">-    NS_IMETHOD EndUpdateBatch() override {</span>
<a href="#l54.185"></a><span id="l54.185" class="difflineminus">-        return mInner-&gt;EndUpdateBatch();</span>
<a href="#l54.186"></a><span id="l54.186" class="difflineminus">-    }</span>
<a href="#l54.187"></a><span id="l54.187" class="difflineminus">-</span>
<a href="#l54.188"></a><span id="l54.188" class="difflineminus">-    NS_IMETHOD GetLoaded(bool* _result) override;</span>
<a href="#l54.189"></a><span id="l54.189" class="difflineminus">-    NS_IMETHOD Init(const char *uri) override;</span>
<a href="#l54.190"></a><span id="l54.190" class="difflineminus">-    NS_IMETHOD Flush() override;</span>
<a href="#l54.191"></a><span id="l54.191" class="difflineminus">-    NS_IMETHOD FlushTo(const char *aURI) override;</span>
<a href="#l54.192"></a><span id="l54.192" class="difflineminus">-    NS_IMETHOD Refresh(bool sync) override;</span>
<a href="#l54.193"></a><span id="l54.193" class="difflineminus">-</span>
<a href="#l54.194"></a><span id="l54.194" class="difflineminus">-    // nsIObserver</span>
<a href="#l54.195"></a><span id="l54.195" class="difflineminus">-    NS_DECL_NSIOBSERVER</span>
<a href="#l54.196"></a><span id="l54.196" class="difflineminus">-};</span>
<a href="#l54.197"></a><span id="l54.197" class="difflineminus">-</span>
<a href="#l54.198"></a><span id="l54.198" class="difflineminus">-////////////////////////////////////////////////////////////////////////</span>
<a href="#l54.199"></a><span id="l54.199" class="difflineminus">-</span>
<a href="#l54.200"></a><span id="l54.200" class="difflineminus">-</span>
<a href="#l54.201"></a><span id="l54.201" class="difflineminus">-LocalStoreImpl::LocalStoreImpl(void)</span>
<a href="#l54.202"></a><span id="l54.202" class="difflineminus">-{</span>
<a href="#l54.203"></a><span id="l54.203" class="difflineminus">-}</span>
<a href="#l54.204"></a><span id="l54.204" class="difflineminus">-</span>
<a href="#l54.205"></a><span id="l54.205" class="difflineminus">-LocalStoreImpl::~LocalStoreImpl(void)</span>
<a href="#l54.206"></a><span id="l54.206" class="difflineminus">-{</span>
<a href="#l54.207"></a><span id="l54.207" class="difflineminus">-    if (mRDFService)</span>
<a href="#l54.208"></a><span id="l54.208" class="difflineminus">-        mRDFService-&gt;UnregisterDataSource(this);</span>
<a href="#l54.209"></a><span id="l54.209" class="difflineminus">-}</span>
<a href="#l54.210"></a><span id="l54.210" class="difflineminus">-</span>
<a href="#l54.211"></a><span id="l54.211" class="difflineminus">-</span>
<a href="#l54.212"></a><span id="l54.212" class="difflineminus">-nsresult</span>
<a href="#l54.213"></a><span id="l54.213" class="difflineminus">-NS_NewLocalStore(nsISupports* aOuter, REFNSIID aIID, void** aResult)</span>
<a href="#l54.214"></a><span id="l54.214" class="difflineminus">-{</span>
<a href="#l54.215"></a><span id="l54.215" class="difflineminus">-    NS_ASSERTION(aOuter == nullptr, &quot;no aggregation&quot;);</span>
<a href="#l54.216"></a><span id="l54.216" class="difflineminus">-    if (aOuter)</span>
<a href="#l54.217"></a><span id="l54.217" class="difflineminus">-        return NS_ERROR_NO_AGGREGATION;</span>
<a href="#l54.218"></a><span id="l54.218" class="difflineminus">-</span>
<a href="#l54.219"></a><span id="l54.219" class="difflineminus">-    NS_ASSERTION(aResult != nullptr, &quot;null ptr&quot;);</span>
<a href="#l54.220"></a><span id="l54.220" class="difflineminus">-    if (! aResult)</span>
<a href="#l54.221"></a><span id="l54.221" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l54.222"></a><span id="l54.222" class="difflineminus">-</span>
<a href="#l54.223"></a><span id="l54.223" class="difflineminus">-    LocalStoreImpl* impl = new LocalStoreImpl();</span>
<a href="#l54.224"></a><span id="l54.224" class="difflineminus">-    if (! impl)</span>
<a href="#l54.225"></a><span id="l54.225" class="difflineminus">-        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l54.226"></a><span id="l54.226" class="difflineminus">-</span>
<a href="#l54.227"></a><span id="l54.227" class="difflineminus">-    NS_ADDREF(impl);</span>
<a href="#l54.228"></a><span id="l54.228" class="difflineminus">-</span>
<a href="#l54.229"></a><span id="l54.229" class="difflineminus">-    nsresult rv;</span>
<a href="#l54.230"></a><span id="l54.230" class="difflineminus">-    rv = impl-&gt;Init();</span>
<a href="#l54.231"></a><span id="l54.231" class="difflineminus">-    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l54.232"></a><span id="l54.232" class="difflineminus">-        // Set up the result pointer</span>
<a href="#l54.233"></a><span id="l54.233" class="difflineminus">-        rv = impl-&gt;QueryInterface(aIID, aResult);</span>
<a href="#l54.234"></a><span id="l54.234" class="difflineminus">-    }</span>
<a href="#l54.235"></a><span id="l54.235" class="difflineminus">-</span>
<a href="#l54.236"></a><span id="l54.236" class="difflineminus">-    NS_RELEASE(impl);</span>
<a href="#l54.237"></a><span id="l54.237" class="difflineminus">-    return rv;</span>
<a href="#l54.238"></a><span id="l54.238" class="difflineminus">-}</span>
<a href="#l54.239"></a><span id="l54.239" class="difflineminus">-</span>
<a href="#l54.240"></a><span id="l54.240" class="difflineminus">-NS_IMPL_CYCLE_COLLECTION(LocalStoreImpl, mInner)</span>
<a href="#l54.241"></a><span id="l54.241" class="difflineminus">-NS_IMPL_CYCLE_COLLECTING_ADDREF(LocalStoreImpl)</span>
<a href="#l54.242"></a><span id="l54.242" class="difflineminus">-NS_IMPL_CYCLE_COLLECTING_RELEASE(LocalStoreImpl)</span>
<a href="#l54.243"></a><span id="l54.243" class="difflineminus">-</span>
<a href="#l54.244"></a><span id="l54.244" class="difflineminus">-NS_INTERFACE_MAP_BEGIN_CYCLE_COLLECTION(LocalStoreImpl)</span>
<a href="#l54.245"></a><span id="l54.245" class="difflineminus">-    NS_INTERFACE_MAP_ENTRY(nsILocalStore)</span>
<a href="#l54.246"></a><span id="l54.246" class="difflineminus">-    NS_INTERFACE_MAP_ENTRY(nsIRDFDataSource)</span>
<a href="#l54.247"></a><span id="l54.247" class="difflineminus">-    NS_INTERFACE_MAP_ENTRY(nsIRDFRemoteDataSource)</span>
<a href="#l54.248"></a><span id="l54.248" class="difflineminus">-    NS_INTERFACE_MAP_ENTRY(nsIObserver)</span>
<a href="#l54.249"></a><span id="l54.249" class="difflineminus">-    NS_INTERFACE_MAP_ENTRY(nsISupportsWeakReference)</span>
<a href="#l54.250"></a><span id="l54.250" class="difflineminus">-    NS_INTERFACE_MAP_ENTRY_AMBIGUOUS(nsISupports, nsILocalStore)</span>
<a href="#l54.251"></a><span id="l54.251" class="difflineminus">-NS_INTERFACE_MAP_END</span>
<a href="#l54.252"></a><span id="l54.252" class="difflineminus">-</span>
<a href="#l54.253"></a><span id="l54.253" class="difflineminus">-// nsILocalStore interface</span>
<a href="#l54.254"></a><span id="l54.254" class="difflineminus">-</span>
<a href="#l54.255"></a><span id="l54.255" class="difflineminus">-// nsIRDFDataSource interface</span>
<a href="#l54.256"></a><span id="l54.256" class="difflineminus">-</span>
<a href="#l54.257"></a><span id="l54.257" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l54.258"></a><span id="l54.258" class="difflineminus">-LocalStoreImpl::GetLoaded(bool* _result)</span>
<a href="#l54.259"></a><span id="l54.259" class="difflineminus">-{</span>
<a href="#l54.260"></a><span id="l54.260" class="difflineminus">-	nsCOMPtr&lt;nsIRDFRemoteDataSource&gt; remote = do_QueryInterface(mInner);</span>
<a href="#l54.261"></a><span id="l54.261" class="difflineminus">-    NS_ASSERTION(remote != nullptr, &quot;not an nsIRDFRemoteDataSource&quot;);</span>
<a href="#l54.262"></a><span id="l54.262" class="difflineminus">-	if (! remote)</span>
<a href="#l54.263"></a><span id="l54.263" class="difflineminus">-        return NS_ERROR_UNEXPECTED;</span>
<a href="#l54.264"></a><span id="l54.264" class="difflineminus">-</span>
<a href="#l54.265"></a><span id="l54.265" class="difflineminus">-    return remote-&gt;GetLoaded(_result);</span>
<a href="#l54.266"></a><span id="l54.266" class="difflineminus">-}</span>
<a href="#l54.267"></a><span id="l54.267" class="difflineminus">-</span>
<a href="#l54.268"></a><span id="l54.268" class="difflineminus">-</span>
<a href="#l54.269"></a><span id="l54.269" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l54.270"></a><span id="l54.270" class="difflineminus">-LocalStoreImpl::Init(const char *uri)</span>
<a href="#l54.271"></a><span id="l54.271" class="difflineminus">-{</span>
<a href="#l54.272"></a><span id="l54.272" class="difflineminus">-	return(NS_OK);</span>
<a href="#l54.273"></a><span id="l54.273" class="difflineminus">-}</span>
<a href="#l54.274"></a><span id="l54.274" class="difflineminus">-</span>
<a href="#l54.275"></a><span id="l54.275" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l54.276"></a><span id="l54.276" class="difflineminus">-LocalStoreImpl::Flush()</span>
<a href="#l54.277"></a><span id="l54.277" class="difflineminus">-{</span>
<a href="#l54.278"></a><span id="l54.278" class="difflineminus">-	nsCOMPtr&lt;nsIRDFRemoteDataSource&gt; remote = do_QueryInterface(mInner);</span>
<a href="#l54.279"></a><span id="l54.279" class="difflineminus">-    // FIXME Bug 340242: Temporarily make this a warning rather than an</span>
<a href="#l54.280"></a><span id="l54.280" class="difflineminus">-    // assertion until we sort out the ordering of how we write</span>
<a href="#l54.281"></a><span id="l54.281" class="difflineminus">-    // everything to the localstore, flush it, and disconnect it when</span>
<a href="#l54.282"></a><span id="l54.282" class="difflineminus">-    // we're getting profile-change notifications.</span>
<a href="#l54.283"></a><span id="l54.283" class="difflineminus">-    NS_WARNING_ASSERTION(remote != nullptr, &quot;not an nsIRDFRemoteDataSource&quot;);</span>
<a href="#l54.284"></a><span id="l54.284" class="difflineminus">-	if (! remote)</span>
<a href="#l54.285"></a><span id="l54.285" class="difflineminus">-        return NS_ERROR_UNEXPECTED;</span>
<a href="#l54.286"></a><span id="l54.286" class="difflineminus">-</span>
<a href="#l54.287"></a><span id="l54.287" class="difflineminus">-    return remote-&gt;Flush();</span>
<a href="#l54.288"></a><span id="l54.288" class="difflineminus">-}</span>
<a href="#l54.289"></a><span id="l54.289" class="difflineminus">-</span>
<a href="#l54.290"></a><span id="l54.290" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l54.291"></a><span id="l54.291" class="difflineminus">-LocalStoreImpl::FlushTo(const char *aURI)</span>
<a href="#l54.292"></a><span id="l54.292" class="difflineminus">-{</span>
<a href="#l54.293"></a><span id="l54.293" class="difflineminus">-  // Do not ever implement this (security)</span>
<a href="#l54.294"></a><span id="l54.294" class="difflineminus">-  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l54.295"></a><span id="l54.295" class="difflineminus">-}</span>
<a href="#l54.296"></a><span id="l54.296" class="difflineminus">-</span>
<a href="#l54.297"></a><span id="l54.297" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l54.298"></a><span id="l54.298" class="difflineminus">-LocalStoreImpl::Refresh(bool sync)</span>
<a href="#l54.299"></a><span id="l54.299" class="difflineminus">-{</span>
<a href="#l54.300"></a><span id="l54.300" class="difflineminus">-	nsCOMPtr&lt;nsIRDFRemoteDataSource&gt; remote = do_QueryInterface(mInner);</span>
<a href="#l54.301"></a><span id="l54.301" class="difflineminus">-    NS_ASSERTION(remote != nullptr, &quot;not an nsIRDFRemoteDataSource&quot;);</span>
<a href="#l54.302"></a><span id="l54.302" class="difflineminus">-	if (! remote)</span>
<a href="#l54.303"></a><span id="l54.303" class="difflineminus">-        return NS_ERROR_UNEXPECTED;</span>
<a href="#l54.304"></a><span id="l54.304" class="difflineminus">-</span>
<a href="#l54.305"></a><span id="l54.305" class="difflineminus">-    return remote-&gt;Refresh(sync);</span>
<a href="#l54.306"></a><span id="l54.306" class="difflineminus">-}</span>
<a href="#l54.307"></a><span id="l54.307" class="difflineminus">-</span>
<a href="#l54.308"></a><span id="l54.308" class="difflineminus">-nsresult</span>
<a href="#l54.309"></a><span id="l54.309" class="difflineminus">-LocalStoreImpl::Init()</span>
<a href="#l54.310"></a><span id="l54.310" class="difflineminus">-{</span>
<a href="#l54.311"></a><span id="l54.311" class="difflineminus">-    nsresult rv;</span>
<a href="#l54.312"></a><span id="l54.312" class="difflineminus">-</span>
<a href="#l54.313"></a><span id="l54.313" class="difflineminus">-    rv = LoadData();</span>
<a href="#l54.314"></a><span id="l54.314" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l54.315"></a><span id="l54.315" class="difflineminus">-</span>
<a href="#l54.316"></a><span id="l54.316" class="difflineminus">-    // register this as a named data source with the RDF service</span>
<a href="#l54.317"></a><span id="l54.317" class="difflineminus">-    mRDFService = do_GetService(NS_RDF_CONTRACTID &quot;/rdf-service;1&quot;, &amp;rv);</span>
<a href="#l54.318"></a><span id="l54.318" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l54.319"></a><span id="l54.319" class="difflineminus">-</span>
<a href="#l54.320"></a><span id="l54.320" class="difflineminus">-    mRDFService-&gt;RegisterDataSource(this, false);</span>
<a href="#l54.321"></a><span id="l54.321" class="difflineminus">-</span>
<a href="#l54.322"></a><span id="l54.322" class="difflineminus">-    // Register as an observer of profile changes</span>
<a href="#l54.323"></a><span id="l54.323" class="difflineminus">-    nsCOMPtr&lt;nsIObserverService&gt; obs =</span>
<a href="#l54.324"></a><span id="l54.324" class="difflineminus">-        do_GetService(&quot;@mozilla.org/observer-service;1&quot;);</span>
<a href="#l54.325"></a><span id="l54.325" class="difflineminus">-</span>
<a href="#l54.326"></a><span id="l54.326" class="difflineminus">-    if (obs) {</span>
<a href="#l54.327"></a><span id="l54.327" class="difflineminus">-        obs-&gt;AddObserver(this, &quot;profile-before-change&quot;, true);</span>
<a href="#l54.328"></a><span id="l54.328" class="difflineminus">-        obs-&gt;AddObserver(this, &quot;profile-do-change&quot;, true);</span>
<a href="#l54.329"></a><span id="l54.329" class="difflineminus">-    }</span>
<a href="#l54.330"></a><span id="l54.330" class="difflineminus">-</span>
<a href="#l54.331"></a><span id="l54.331" class="difflineminus">-    return NS_OK;</span>
<a href="#l54.332"></a><span id="l54.332" class="difflineminus">-}</span>
<a href="#l54.333"></a><span id="l54.333" class="difflineminus">-</span>
<a href="#l54.334"></a><span id="l54.334" class="difflineminus">-nsresult</span>
<a href="#l54.335"></a><span id="l54.335" class="difflineminus">-LocalStoreImpl::CreateLocalStore(nsIFile* aFile)</span>
<a href="#l54.336"></a><span id="l54.336" class="difflineminus">-{</span>
<a href="#l54.337"></a><span id="l54.337" class="difflineminus">-    nsresult rv;</span>
<a href="#l54.338"></a><span id="l54.338" class="difflineminus">-</span>
<a href="#l54.339"></a><span id="l54.339" class="difflineminus">-    rv = aFile-&gt;Create(nsIFile::NORMAL_FILE_TYPE, 0666);</span>
<a href="#l54.340"></a><span id="l54.340" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l54.341"></a><span id="l54.341" class="difflineminus">-</span>
<a href="#l54.342"></a><span id="l54.342" class="difflineminus">-    nsCOMPtr&lt;nsIOutputStream&gt; outStream;</span>
<a href="#l54.343"></a><span id="l54.343" class="difflineminus">-    rv = NS_NewLocalFileOutputStream(getter_AddRefs(outStream), aFile);</span>
<a href="#l54.344"></a><span id="l54.344" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l54.345"></a><span id="l54.345" class="difflineminus">-</span>
<a href="#l54.346"></a><span id="l54.346" class="difflineminus">-    const char defaultRDF[] =</span>
<a href="#l54.347"></a><span id="l54.347" class="difflineminus">-        &quot;&lt;?xml version=\&quot;1.0\&quot;?&gt;\n&quot; \</span>
<a href="#l54.348"></a><span id="l54.348" class="difflineminus">-        &quot;&lt;RDF:RDF xmlns:RDF=\&quot;&quot; RDF_NAMESPACE_URI &quot;\&quot;\n&quot; \</span>
<a href="#l54.349"></a><span id="l54.349" class="difflineminus">-        &quot;         xmlns:NC=\&quot;&quot;  NC_NAMESPACE_URI &quot;\&quot;&gt;\n&quot; \</span>
<a href="#l54.350"></a><span id="l54.350" class="difflineminus">-        &quot;  &lt;!-- Empty --&gt;\n&quot; \</span>
<a href="#l54.351"></a><span id="l54.351" class="difflineminus">-        &quot;&lt;/RDF:RDF&gt;\n&quot;;</span>
<a href="#l54.352"></a><span id="l54.352" class="difflineminus">-</span>
<a href="#l54.353"></a><span id="l54.353" class="difflineminus">-    uint32_t count;</span>
<a href="#l54.354"></a><span id="l54.354" class="difflineminus">-    rv = outStream-&gt;Write(defaultRDF, sizeof(defaultRDF)-1, &amp;count);</span>
<a href="#l54.355"></a><span id="l54.355" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l54.356"></a><span id="l54.356" class="difflineminus">-</span>
<a href="#l54.357"></a><span id="l54.357" class="difflineminus">-    if (count != sizeof(defaultRDF)-1)</span>
<a href="#l54.358"></a><span id="l54.358" class="difflineminus">-        return NS_ERROR_UNEXPECTED;</span>
<a href="#l54.359"></a><span id="l54.359" class="difflineminus">-</span>
<a href="#l54.360"></a><span id="l54.360" class="difflineminus">-    // Okay, now see if the file exists _for real_. If it's still</span>
<a href="#l54.361"></a><span id="l54.361" class="difflineminus">-    // not there, it could be that the profile service gave us</span>
<a href="#l54.362"></a><span id="l54.362" class="difflineminus">-    // back a read-only directory. Whatever.</span>
<a href="#l54.363"></a><span id="l54.363" class="difflineminus">-    bool fileExistsFlag = false;</span>
<a href="#l54.364"></a><span id="l54.364" class="difflineminus">-    aFile-&gt;Exists(&amp;fileExistsFlag);</span>
<a href="#l54.365"></a><span id="l54.365" class="difflineminus">-    if (!fileExistsFlag)</span>
<a href="#l54.366"></a><span id="l54.366" class="difflineminus">-        return NS_ERROR_UNEXPECTED;</span>
<a href="#l54.367"></a><span id="l54.367" class="difflineminus">-</span>
<a href="#l54.368"></a><span id="l54.368" class="difflineminus">-    return NS_OK;</span>
<a href="#l54.369"></a><span id="l54.369" class="difflineminus">-}</span>
<a href="#l54.370"></a><span id="l54.370" class="difflineminus">-</span>
<a href="#l54.371"></a><span id="l54.371" class="difflineminus">-nsresult</span>
<a href="#l54.372"></a><span id="l54.372" class="difflineminus">-LocalStoreImpl::LoadData()</span>
<a href="#l54.373"></a><span id="l54.373" class="difflineminus">-{</span>
<a href="#l54.374"></a><span id="l54.374" class="difflineminus">-    nsresult rv;</span>
<a href="#l54.375"></a><span id="l54.375" class="difflineminus">-</span>
<a href="#l54.376"></a><span id="l54.376" class="difflineminus">-    // Look for localstore.rdf in the current profile</span>
<a href="#l54.377"></a><span id="l54.377" class="difflineminus">-    // directory. Bomb if we can't find it.</span>
<a href="#l54.378"></a><span id="l54.378" class="difflineminus">-</span>
<a href="#l54.379"></a><span id="l54.379" class="difflineminus">-    nsCOMPtr&lt;nsIFile&gt; aFile;</span>
<a href="#l54.380"></a><span id="l54.380" class="difflineminus">-    // NS_APP_LOCALSTORE_50_FILE was removed in bug 1430023, see bug 1462004.</span>
<a href="#l54.381"></a><span id="l54.381" class="difflineminus">-    // rv = NS_GetSpecialDirectory(NS_APP_LOCALSTORE_50_FILE, getter_AddRefs(aFile));</span>
<a href="#l54.382"></a><span id="l54.382" class="difflineminus">-    // It's questionable whether this function works at all now. This needs</span>
<a href="#l54.383"></a><span id="l54.383" class="difflineminus">-    // investigation as to whether it can be removed. Let's hack the string for now.</span>
<a href="#l54.384"></a><span id="l54.384" class="difflineminus">-    rv = NS_GetSpecialDirectory(&quot;LclSt&quot;, getter_AddRefs(aFile));</span>
<a href="#l54.385"></a><span id="l54.385" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l54.386"></a><span id="l54.386" class="difflineminus">-</span>
<a href="#l54.387"></a><span id="l54.387" class="difflineminus">-    bool fileExistsFlag = false;</span>
<a href="#l54.388"></a><span id="l54.388" class="difflineminus">-    (void)aFile-&gt;Exists(&amp;fileExistsFlag);</span>
<a href="#l54.389"></a><span id="l54.389" class="difflineminus">-    if (!fileExistsFlag) {</span>
<a href="#l54.390"></a><span id="l54.390" class="difflineminus">-        // if file doesn't exist, create it</span>
<a href="#l54.391"></a><span id="l54.391" class="difflineminus">-        rv = CreateLocalStore(aFile);</span>
<a href="#l54.392"></a><span id="l54.392" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l54.393"></a><span id="l54.393" class="difflineminus">-    }</span>
<a href="#l54.394"></a><span id="l54.394" class="difflineminus">-</span>
<a href="#l54.395"></a><span id="l54.395" class="difflineminus">-    mInner = do_CreateInstance(NS_RDF_DATASOURCE_CONTRACTID_PREFIX &quot;xml-datasource&quot;, &amp;rv);</span>
<a href="#l54.396"></a><span id="l54.396" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l54.397"></a><span id="l54.397" class="difflineminus">-</span>
<a href="#l54.398"></a><span id="l54.398" class="difflineminus">-    nsCOMPtr&lt;nsIRDFRemoteDataSource&gt; remote = do_QueryInterface(mInner, &amp;rv);</span>
<a href="#l54.399"></a><span id="l54.399" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l54.400"></a><span id="l54.400" class="difflineminus">-</span>
<a href="#l54.401"></a><span id="l54.401" class="difflineminus">-    nsCOMPtr&lt;nsIURI&gt; aURI;</span>
<a href="#l54.402"></a><span id="l54.402" class="difflineminus">-    rv = NS_NewFileURI(getter_AddRefs(aURI), aFile);</span>
<a href="#l54.403"></a><span id="l54.403" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l54.404"></a><span id="l54.404" class="difflineminus">-</span>
<a href="#l54.405"></a><span id="l54.405" class="difflineminus">-    nsAutoCString spec;</span>
<a href="#l54.406"></a><span id="l54.406" class="difflineminus">-    rv = aURI-&gt;GetSpec(spec);</span>
<a href="#l54.407"></a><span id="l54.407" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l54.408"></a><span id="l54.408" class="difflineminus">-</span>
<a href="#l54.409"></a><span id="l54.409" class="difflineminus">-    rv = remote-&gt;Init(spec.get());</span>
<a href="#l54.410"></a><span id="l54.410" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l54.411"></a><span id="l54.411" class="difflineminus">-</span>
<a href="#l54.412"></a><span id="l54.412" class="difflineminus">-    // Read the datasource synchronously.</span>
<a href="#l54.413"></a><span id="l54.413" class="difflineminus">-    rv = remote-&gt;Refresh(true);</span>
<a href="#l54.414"></a><span id="l54.414" class="difflineminus">-</span>
<a href="#l54.415"></a><span id="l54.415" class="difflineminus">-    if (NS_FAILED(rv)) {</span>
<a href="#l54.416"></a><span id="l54.416" class="difflineminus">-        // Load failed, delete and recreate a fresh localstore</span>
<a href="#l54.417"></a><span id="l54.417" class="difflineminus">-        aFile-&gt;Remove(true);</span>
<a href="#l54.418"></a><span id="l54.418" class="difflineminus">-        rv = CreateLocalStore(aFile);</span>
<a href="#l54.419"></a><span id="l54.419" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l54.420"></a><span id="l54.420" class="difflineminus">-</span>
<a href="#l54.421"></a><span id="l54.421" class="difflineminus">-        rv = remote-&gt;Refresh(true);</span>
<a href="#l54.422"></a><span id="l54.422" class="difflineminus">-    }</span>
<a href="#l54.423"></a><span id="l54.423" class="difflineminus">-</span>
<a href="#l54.424"></a><span id="l54.424" class="difflineminus">-    return rv;</span>
<a href="#l54.425"></a><span id="l54.425" class="difflineminus">-}</span>
<a href="#l54.426"></a><span id="l54.426" class="difflineminus">-</span>
<a href="#l54.427"></a><span id="l54.427" class="difflineminus">-</span>
<a href="#l54.428"></a><span id="l54.428" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l54.429"></a><span id="l54.429" class="difflineminus">-LocalStoreImpl::GetURI(nsACString&amp; aURI)</span>
<a href="#l54.430"></a><span id="l54.430" class="difflineminus">-{</span>
<a href="#l54.431"></a><span id="l54.431" class="difflineminus">-    aURI.AssignLiteral(&quot;rdf:local-store&quot;);</span>
<a href="#l54.432"></a><span id="l54.432" class="difflineminus">-    return NS_OK;</span>
<a href="#l54.433"></a><span id="l54.433" class="difflineminus">-}</span>
<a href="#l54.434"></a><span id="l54.434" class="difflineminus">-</span>
<a href="#l54.435"></a><span id="l54.435" class="difflineminus">-</span>
<a href="#l54.436"></a><span id="l54.436" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l54.437"></a><span id="l54.437" class="difflineminus">-LocalStoreImpl::GetAllCmds(nsIRDFResource* aSource,</span>
<a href="#l54.438"></a><span id="l54.438" class="difflineminus">-                               nsISimpleEnumerator/*&lt;nsIRDFResource&gt;*/** aCommands)</span>
<a href="#l54.439"></a><span id="l54.439" class="difflineminus">-{</span>
<a href="#l54.440"></a><span id="l54.440" class="difflineminus">-	return(NS_NewEmptyEnumerator(aCommands));</span>
<a href="#l54.441"></a><span id="l54.441" class="difflineminus">-}</span>
<a href="#l54.442"></a><span id="l54.442" class="difflineminus">-</span>
<a href="#l54.443"></a><span id="l54.443" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l54.444"></a><span id="l54.444" class="difflineminus">-LocalStoreImpl::IsCommandEnabled(nsISupports* aSources,</span>
<a href="#l54.445"></a><span id="l54.445" class="difflineminus">-                                 nsIRDFResource*   aCommand,</span>
<a href="#l54.446"></a><span id="l54.446" class="difflineminus">-                                 nsISupports* aArguments,</span>
<a href="#l54.447"></a><span id="l54.447" class="difflineminus">-                                 bool* aResult)</span>
<a href="#l54.448"></a><span id="l54.448" class="difflineminus">-{</span>
<a href="#l54.449"></a><span id="l54.449" class="difflineminus">-    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l54.450"></a><span id="l54.450" class="difflineminus">-}</span>
<a href="#l54.451"></a><span id="l54.451" class="difflineminus">-</span>
<a href="#l54.452"></a><span id="l54.452" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l54.453"></a><span id="l54.453" class="difflineminus">-LocalStoreImpl::DoCommand(nsISupports* aSources,</span>
<a href="#l54.454"></a><span id="l54.454" class="difflineminus">-                          nsIRDFResource*   aCommand,</span>
<a href="#l54.455"></a><span id="l54.455" class="difflineminus">-                          nsISupports* aArguments)</span>
<a href="#l54.456"></a><span id="l54.456" class="difflineminus">-{</span>
<a href="#l54.457"></a><span id="l54.457" class="difflineminus">-    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l54.458"></a><span id="l54.458" class="difflineminus">-}</span>
<a href="#l54.459"></a><span id="l54.459" class="difflineminus">-</span>
<a href="#l54.460"></a><span id="l54.460" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l54.461"></a><span id="l54.461" class="difflineminus">-LocalStoreImpl::Observe(nsISupports *aSubject, const char *aTopic, const char16_t *someData)</span>
<a href="#l54.462"></a><span id="l54.462" class="difflineminus">-{</span>
<a href="#l54.463"></a><span id="l54.463" class="difflineminus">-    nsresult rv = NS_OK;</span>
<a href="#l54.464"></a><span id="l54.464" class="difflineminus">-</span>
<a href="#l54.465"></a><span id="l54.465" class="difflineminus">-    if (!nsCRT::strcmp(aTopic, &quot;profile-before-change&quot;)) {</span>
<a href="#l54.466"></a><span id="l54.466" class="difflineminus">-        // Write out the old datasource's contents.</span>
<a href="#l54.467"></a><span id="l54.467" class="difflineminus">-        if (mInner) {</span>
<a href="#l54.468"></a><span id="l54.468" class="difflineminus">-            nsCOMPtr&lt;nsIRDFRemoteDataSource&gt; remote = do_QueryInterface(mInner);</span>
<a href="#l54.469"></a><span id="l54.469" class="difflineminus">-            if (remote)</span>
<a href="#l54.470"></a><span id="l54.470" class="difflineminus">-                remote-&gt;Flush();</span>
<a href="#l54.471"></a><span id="l54.471" class="difflineminus">-        }</span>
<a href="#l54.472"></a><span id="l54.472" class="difflineminus">-</span>
<a href="#l54.473"></a><span id="l54.473" class="difflineminus">-        // Create an in-memory datasource for use while we're</span>
<a href="#l54.474"></a><span id="l54.474" class="difflineminus">-        // profile-less.</span>
<a href="#l54.475"></a><span id="l54.475" class="difflineminus">-        mInner = do_CreateInstance(NS_RDF_DATASOURCE_CONTRACTID_PREFIX &quot;in-memory-datasource&quot;);</span>
<a href="#l54.476"></a><span id="l54.476" class="difflineminus">-    }</span>
<a href="#l54.477"></a><span id="l54.477" class="difflineminus">-    else if (!nsCRT::strcmp(aTopic, &quot;profile-do-change&quot;)) {</span>
<a href="#l54.478"></a><span id="l54.478" class="difflineminus">-        rv = LoadData();</span>
<a href="#l54.479"></a><span id="l54.479" class="difflineminus">-    }</span>
<a href="#l54.480"></a><span id="l54.480" class="difflineminus">-    return rv;</span>
<a href="#l54.481"></a><span id="l54.481" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l55.1"></a><span id="l55.1">deleted file mode 100644</span>
<a href="#l55.2"></a><span id="l55.2" class="difflineminus">--- a/rdf/datasource/nsRDFBuiltInDataSources.h</span>
<a href="#l55.3"></a><span id="l55.3" class="difflineplus">+++ /dev/null</span>
<a href="#l55.4"></a><span id="l55.4" class="difflineat">@@ -1,27 +0,0 @@</span>
<a href="#l55.5"></a><span id="l55.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l55.6"></a><span id="l55.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l55.7"></a><span id="l55.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l55.8"></a><span id="l55.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l55.9"></a><span id="l55.9" class="difflineminus">-</span>
<a href="#l55.10"></a><span id="l55.10" class="difflineminus">-/*</span>
<a href="#l55.11"></a><span id="l55.11" class="difflineminus">-</span>
<a href="#l55.12"></a><span id="l55.12" class="difflineminus">-  This header file just contains prototypes for the factory methods</span>
<a href="#l55.13"></a><span id="l55.13" class="difflineminus">-  for &quot;builtin&quot; data sources that are included in rdf.dll.</span>
<a href="#l55.14"></a><span id="l55.14" class="difflineminus">-</span>
<a href="#l55.15"></a><span id="l55.15" class="difflineminus">-  Each of these data sources is exposed to the external world via its</span>
<a href="#l55.16"></a><span id="l55.16" class="difflineminus">-  CID in ../include/nsRDFCID.h.</span>
<a href="#l55.17"></a><span id="l55.17" class="difflineminus">-</span>
<a href="#l55.18"></a><span id="l55.18" class="difflineminus">- */</span>
<a href="#l55.19"></a><span id="l55.19" class="difflineminus">-</span>
<a href="#l55.20"></a><span id="l55.20" class="difflineminus">-#ifndef nsBuiltinDataSources_h__</span>
<a href="#l55.21"></a><span id="l55.21" class="difflineminus">-#define nsBuiltinDataSources_h__</span>
<a href="#l55.22"></a><span id="l55.22" class="difflineminus">-</span>
<a href="#l55.23"></a><span id="l55.23" class="difflineminus">-#include &quot;nsError.h&quot;</span>
<a href="#l55.24"></a><span id="l55.24" class="difflineminus">-</span>
<a href="#l55.25"></a><span id="l55.25" class="difflineminus">-class nsIRDFDataSource;</span>
<a href="#l55.26"></a><span id="l55.26" class="difflineminus">-</span>
<a href="#l55.27"></a><span id="l55.27" class="difflineminus">-// in nsFileSystemDataSource.cpp</span>
<a href="#l55.28"></a><span id="l55.28" class="difflineminus">-nsresult NS_NewRDFFileSystemDataSource(nsIRDFDataSource** result);</span>
<a href="#l55.29"></a><span id="l55.29" class="difflineminus">-</span>
<a href="#l55.30"></a><span id="l55.30" class="difflineminus">-#endif // nsBuiltinDataSources_h__</span>
<a href="#l55.31"></a><span id="l55.31" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l56.1"></a><span id="l56.1">deleted file mode 100644</span>
<a href="#l56.2"></a><span id="l56.2" class="difflineminus">--- a/rdf/moz.build</span>
<a href="#l56.3"></a><span id="l56.3" class="difflineplus">+++ /dev/null</span>
<a href="#l56.4"></a><span id="l56.4" class="difflineat">@@ -1,11 +0,0 @@</span>
<a href="#l56.5"></a><span id="l56.5" class="difflineminus">-# -*- Mode: python; indent-tabs-mode: nil; tab-width: 40 -*-</span>
<a href="#l56.6"></a><span id="l56.6" class="difflineminus">-# vim: set filetype=python:</span>
<a href="#l56.7"></a><span id="l56.7" class="difflineminus">-# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l56.8"></a><span id="l56.8" class="difflineminus">-# License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l56.9"></a><span id="l56.9" class="difflineminus">-# file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l56.10"></a><span id="l56.10" class="difflineminus">-</span>
<a href="#l56.11"></a><span id="l56.11" class="difflineminus">-with Files('**'):</span>
<a href="#l56.12"></a><span id="l56.12" class="difflineminus">-    BUG_COMPONENT = ('MailNews Core', 'General')</span>
<a href="#l56.13"></a><span id="l56.13" class="difflineminus">-</span>
<a href="#l56.14"></a><span id="l56.14" class="difflineminus">-DIRS += ['base', 'datasource', 'build']</span>
<a href="#l56.15"></a><span id="l56.15" class="difflineminus">-</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:32Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

