<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 25915:60f70f12c179dc19995491c377d5339dfb1d93fe</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 60f70f12c179dc19995491c377d5339dfb1d93fe" />
<meta property="og:url" content="/comm-central/rev/60f70f12c179dc19995491c377d5339dfb1d93fe" />
<meta property="og:description" content="Bug 1525190 - Run eslint --fix over XMPP code. r=florian" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 60f70f12c179dc19995491c377d5339dfb1d93fe 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/60f70f12c179dc19995491c377d5339dfb1d93fe">shortlog</a> |
<a href="/comm-central/log/60f70f12c179dc19995491c377d5339dfb1d93fe">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/60f70f12c179dc19995491c377d5339dfb1d93fe">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/60f70f12c179dc19995491c377d5339dfb1d93fe">files</a> |
changeset |
<a href="/comm-central/raw-rev/60f70f12c179dc19995491c377d5339dfb1d93fe">raw</a>  | <a href="/comm-central/archive/60f70f12c179dc19995491c377d5339dfb1d93fe.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1525190">Bug 1525190</a> - Run eslint --fix over XMPP code. r=florian
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#80;&#97;&#116;&#114;&#105;&#99;&#107;&#32;&#67;&#108;&#111;&#107;&#101;&#32;&#60;&#99;&#108;&#111;&#107;&#101;&#112;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 21 Feb 2019 12:10:43 -0500</td></tr>

<tr>
 <td>changeset 25915</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/60f70f12c179dc19995491c377d5339dfb1d93fe">60f70f12c179dc19995491c377d5339dfb1d93fe</a></td>
</tr>



<tr>
<td>parent 25914</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/430756146f2c9a7517623335799e2bdbf320487e">430756146f2c9a7517623335799e2bdbf320487e</a>
</td>
</tr>

<tr>
<td>child 25916</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/f9fa8017bac2b962c453186e2e6308a4783b04cd">f9fa8017bac2b962c453186e2e6308a4783b04cd</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=60f70f12c179dc19995491c377d5339dfb1d93fe">15548</a></td></tr>
<tr><td>push user</td><td>clokep@gmail.com</td></tr>
<tr><td>push date</td><td class="date age">Thu, 21 Feb 2019 17:12:10 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@60f70f12c179 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=60f70f12c179dc19995491c377d5339dfb1d93fe">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=60f70f12c179dc19995491c377d5339dfb1d93fe&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=60f70f12c179dc19995491c377d5339dfb1d93fe&newProject=comm-central&newRevision=60f70f12c179dc19995491c377d5339dfb1d93fe&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=60f70f12c179dc19995491c377d5339dfb1d93fe&newProject=comm-central&newRevision=60f70f12c179dc19995491c377d5339dfb1d93fe&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=60f70f12c179dc19995491c377d5339dfb1d93fe&newProject=comm-central&newRevision=60f70f12c179dc19995491c377d5339dfb1d93fe&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28florian%29&revcount=50">florian</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1525190">1525190</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1525190">Bug 1525190</a> - Run eslint --fix over XMPP code. r=florian</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/gtalk/gtalk.js">chat/protocols/gtalk/gtalk.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/gtalk/gtalk.js">file</a> |
<a href="/comm-central/annotate/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/gtalk/gtalk.js">annotate</a> |
<a href="/comm-central/diff/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/gtalk/gtalk.js">diff</a> |
<a href="/comm-central/comparison/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/gtalk/gtalk.js">comparison</a> |
<a href="/comm-central/log/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/gtalk/gtalk.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/odnoklassniki/odnoklassniki.js">chat/protocols/odnoklassniki/odnoklassniki.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/odnoklassniki/odnoklassniki.js">file</a> |
<a href="/comm-central/annotate/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/odnoklassniki/odnoklassniki.js">annotate</a> |
<a href="/comm-central/diff/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/odnoklassniki/odnoklassniki.js">diff</a> |
<a href="/comm-central/comparison/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/odnoklassniki/odnoklassniki.js">comparison</a> |
<a href="/comm-central/log/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/odnoklassniki/odnoklassniki.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/xmpp/test/test_authmechs.js">chat/protocols/xmpp/test/test_authmechs.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/xmpp/test/test_authmechs.js">file</a> |
<a href="/comm-central/annotate/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/xmpp/test/test_authmechs.js">annotate</a> |
<a href="/comm-central/diff/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/xmpp/test/test_authmechs.js">diff</a> |
<a href="/comm-central/comparison/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/xmpp/test/test_authmechs.js">comparison</a> |
<a href="/comm-central/log/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/xmpp/test/test_authmechs.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/xmpp/test/test_dnsSrv.js">chat/protocols/xmpp/test/test_dnsSrv.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/xmpp/test/test_dnsSrv.js">file</a> |
<a href="/comm-central/annotate/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/xmpp/test/test_dnsSrv.js">annotate</a> |
<a href="/comm-central/diff/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/xmpp/test/test_dnsSrv.js">diff</a> |
<a href="/comm-central/comparison/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/xmpp/test/test_dnsSrv.js">comparison</a> |
<a href="/comm-central/log/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/xmpp/test/test_dnsSrv.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/xmpp/test/test_parseJidAndNormalization.js">chat/protocols/xmpp/test/test_parseJidAndNormalization.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/xmpp/test/test_parseJidAndNormalization.js">file</a> |
<a href="/comm-central/annotate/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/xmpp/test/test_parseJidAndNormalization.js">annotate</a> |
<a href="/comm-central/diff/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/xmpp/test/test_parseJidAndNormalization.js">diff</a> |
<a href="/comm-central/comparison/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/xmpp/test/test_parseJidAndNormalization.js">comparison</a> |
<a href="/comm-central/log/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/xmpp/test/test_parseJidAndNormalization.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/xmpp/test/test_saslPrep.js">chat/protocols/xmpp/test/test_saslPrep.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/xmpp/test/test_saslPrep.js">file</a> |
<a href="/comm-central/annotate/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/xmpp/test/test_saslPrep.js">annotate</a> |
<a href="/comm-central/diff/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/xmpp/test/test_saslPrep.js">diff</a> |
<a href="/comm-central/comparison/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/xmpp/test/test_saslPrep.js">comparison</a> |
<a href="/comm-central/log/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/xmpp/test/test_saslPrep.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/xmpp/test/test_xmppParser.js">chat/protocols/xmpp/test/test_xmppParser.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/xmpp/test/test_xmppParser.js">file</a> |
<a href="/comm-central/annotate/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/xmpp/test/test_xmppParser.js">annotate</a> |
<a href="/comm-central/diff/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/xmpp/test/test_xmppParser.js">diff</a> |
<a href="/comm-central/comparison/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/xmpp/test/test_xmppParser.js">comparison</a> |
<a href="/comm-central/log/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/xmpp/test/test_xmppParser.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/xmpp/test/test_xmppXml.js">chat/protocols/xmpp/test/test_xmppXml.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/xmpp/test/test_xmppXml.js">file</a> |
<a href="/comm-central/annotate/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/xmpp/test/test_xmppXml.js">annotate</a> |
<a href="/comm-central/diff/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/xmpp/test/test_xmppXml.js">diff</a> |
<a href="/comm-central/comparison/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/xmpp/test/test_xmppXml.js">comparison</a> |
<a href="/comm-central/log/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/xmpp/test/test_xmppXml.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/xmpp/xmpp-authmechs.jsm">chat/protocols/xmpp/xmpp-authmechs.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/xmpp/xmpp-authmechs.jsm">file</a> |
<a href="/comm-central/annotate/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/xmpp/xmpp-authmechs.jsm">annotate</a> |
<a href="/comm-central/diff/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/xmpp/xmpp-authmechs.jsm">diff</a> |
<a href="/comm-central/comparison/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/xmpp/xmpp-authmechs.jsm">comparison</a> |
<a href="/comm-central/log/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/xmpp/xmpp-authmechs.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/xmpp/xmpp-commands.jsm">chat/protocols/xmpp/xmpp-commands.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/xmpp/xmpp-commands.jsm">file</a> |
<a href="/comm-central/annotate/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/xmpp/xmpp-commands.jsm">annotate</a> |
<a href="/comm-central/diff/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/xmpp/xmpp-commands.jsm">diff</a> |
<a href="/comm-central/comparison/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/xmpp/xmpp-commands.jsm">comparison</a> |
<a href="/comm-central/log/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/xmpp/xmpp-commands.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/xmpp/xmpp-session.jsm">chat/protocols/xmpp/xmpp-session.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/xmpp/xmpp-session.jsm">file</a> |
<a href="/comm-central/annotate/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/xmpp/xmpp-session.jsm">annotate</a> |
<a href="/comm-central/diff/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/xmpp/xmpp-session.jsm">diff</a> |
<a href="/comm-central/comparison/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/xmpp/xmpp-session.jsm">comparison</a> |
<a href="/comm-central/log/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/xmpp/xmpp-session.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/xmpp/xmpp-xml.jsm">chat/protocols/xmpp/xmpp-xml.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/xmpp/xmpp-xml.jsm">file</a> |
<a href="/comm-central/annotate/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/xmpp/xmpp-xml.jsm">annotate</a> |
<a href="/comm-central/diff/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/xmpp/xmpp-xml.jsm">diff</a> |
<a href="/comm-central/comparison/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/xmpp/xmpp-xml.jsm">comparison</a> |
<a href="/comm-central/log/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/xmpp/xmpp-xml.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/xmpp/xmpp.js">chat/protocols/xmpp/xmpp.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/xmpp/xmpp.js">file</a> |
<a href="/comm-central/annotate/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/xmpp/xmpp.js">annotate</a> |
<a href="/comm-central/diff/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/xmpp/xmpp.js">diff</a> |
<a href="/comm-central/comparison/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/xmpp/xmpp.js">comparison</a> |
<a href="/comm-central/log/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/xmpp/xmpp.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/xmpp/xmpp.jsm">chat/protocols/xmpp/xmpp.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/xmpp/xmpp.jsm">file</a> |
<a href="/comm-central/annotate/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/xmpp/xmpp.jsm">annotate</a> |
<a href="/comm-central/diff/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/xmpp/xmpp.jsm">diff</a> |
<a href="/comm-central/comparison/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/xmpp/xmpp.jsm">comparison</a> |
<a href="/comm-central/log/60f70f12c179dc19995491c377d5339dfb1d93fe/chat/protocols/xmpp/xmpp.jsm">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/chat/protocols/gtalk/gtalk.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/chat/protocols/gtalk/gtalk.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -27,17 +27,18 @@ var {</span>
<a href="#l1.4"></a><span id="l1.4"> } = ChromeUtils.import(&quot;resource:///modules/jsProtoHelper.jsm&quot;);</span>
<a href="#l1.5"></a><span id="l1.5"> var {</span>
<a href="#l1.6"></a><span id="l1.6">   XMPPConversationPrototype,</span>
<a href="#l1.7"></a><span id="l1.7">   XMPPMUCConversationPrototype,</span>
<a href="#l1.8"></a><span id="l1.8">   XMPPAccountBuddyPrototype,</span>
<a href="#l1.9"></a><span id="l1.9">   XMPPAccountPrototype,</span>
<a href="#l1.10"></a><span id="l1.10"> } = ChromeUtils.import(&quot;resource:///modules/xmpp.jsm&quot;);</span>
<a href="#l1.11"></a><span id="l1.11"> var {</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-  XMPPSession, XMPPDefaultResource</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+  XMPPSession,</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+  XMPPDefaultResource,</span>
<a href="#l1.15"></a><span id="l1.15"> } = ChromeUtils.import(&quot;resource:///modules/xmpp-session.jsm&quot;);</span>
<a href="#l1.16"></a><span id="l1.16"> var {</span>
<a href="#l1.17"></a><span id="l1.17">   Stanza,</span>
<a href="#l1.18"></a><span id="l1.18">   XMPPParser,</span>
<a href="#l1.19"></a><span id="l1.19">   SupportedFeatures,</span>
<a href="#l1.20"></a><span id="l1.20"> } = ChromeUtils.import(&quot;resource:///modules/xmpp-xml.jsm&quot;);</span>
<a href="#l1.21"></a><span id="l1.21"> </span>
<a href="#l1.22"></a><span id="l1.22"> XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineat">@@ -45,37 +46,37 @@ XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, (</span>
<a href="#l1.24"></a><span id="l1.24"> );</span>
<a href="#l1.25"></a><span id="l1.25"> </span>
<a href="#l1.26"></a><span id="l1.26"> // PlainFullBindAuth is an authentication mechanism that works like</span>
<a href="#l1.27"></a><span id="l1.27"> // the standard PLAIN mechanism but adds a client-uses-full-bind-result</span>
<a href="#l1.28"></a><span id="l1.28"> // attribute to the auth stanza to tell the Google Talk servers that we</span>
<a href="#l1.29"></a><span id="l1.29"> // support their JID Domain Discovery extension.</span>
<a href="#l1.30"></a><span id="l1.30"> // See https://developers.google.com/talk/jep_extensions/jid_domain_change</span>
<a href="#l1.31"></a><span id="l1.31"> function* PlainFullBindAuth(aUsername, aPassword, aDomain) {</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineminus">-  let key = btoa(&quot;\0&quot;+ aUsername + &quot;\0&quot; + aPassword);</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+  let key = btoa(&quot;\0&quot; + aUsername + &quot;\0&quot; + aPassword);</span>
<a href="#l1.34"></a><span id="l1.34">   let attrs = {</span>
<a href="#l1.35"></a><span id="l1.35">     mechanism: &quot;PLAIN&quot;,</span>
<a href="#l1.36"></a><span id="l1.36">     &quot;xmlns:ga&quot;: &quot;http://www.google.com/talk/protocol/auth&quot;,</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineminus">-    &quot;ga:client-uses-full-bind-result&quot;: &quot;true&quot;</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineplus">+    &quot;ga:client-uses-full-bind-result&quot;: &quot;true&quot;,</span>
<a href="#l1.39"></a><span id="l1.39">   };</span>
<a href="#l1.40"></a><span id="l1.40">   let stanza = yield {</span>
<a href="#l1.41"></a><span id="l1.41">     send: Stanza.node(&quot;auth&quot;, Stanza.NS.sasl, attrs, key),</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineminus">-    log: '&lt;auth.../&gt; (PlainFullBindAuth base64 encoded username and password not logged)'</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineplus">+    log: &quot;&lt;auth.../&gt; (PlainFullBindAuth base64 encoded username and password not logged)&quot;,</span>
<a href="#l1.44"></a><span id="l1.44">   };</span>
<a href="#l1.45"></a><span id="l1.45"> </span>
<a href="#l1.46"></a><span id="l1.46">   if (stanza.localName != &quot;success&quot;)</span>
<a href="#l1.47"></a><span id="l1.47">     throw &quot;Didn't receive the expected auth success stanza.&quot;;</span>
<a href="#l1.48"></a><span id="l1.48"> }</span>
<a href="#l1.49"></a><span id="l1.49"> </span>
<a href="#l1.50"></a><span id="l1.50"> function GTalkAccount(aProtoInstance, aImAccount) {</span>
<a href="#l1.51"></a><span id="l1.51">   this._init(aProtoInstance, aImAccount);</span>
<a href="#l1.52"></a><span id="l1.52"> }</span>
<a href="#l1.53"></a><span id="l1.53"> GTalkAccount.prototype = {</span>
<a href="#l1.54"></a><span id="l1.54">   __proto__: XMPPAccountPrototype,</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineminus">-  connect: function() {</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineplus">+  connect() {</span>
<a href="#l1.57"></a><span id="l1.57">     this._jid = this._parseJID(this.name);</span>
<a href="#l1.58"></a><span id="l1.58">     // The XMPP spec says that the node part of a JID is optional, but</span>
<a href="#l1.59"></a><span id="l1.59">     // in the case of Google Talk if the username typed by the user</span>
<a href="#l1.60"></a><span id="l1.60">     // doesn't contain an @, we prefer assuming that it's the domain</span>
<a href="#l1.61"></a><span id="l1.61">     // part that's been omitted.</span>
<a href="#l1.62"></a><span id="l1.62">     if (!this._jid.node) {</span>
<a href="#l1.63"></a><span id="l1.63">       // If the domain part was omitted, swap the node and domain parts,</span>
<a href="#l1.64"></a><span id="l1.64">       // use 'gmail.com' as the default domain, and tell the Google</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineat">@@ -90,30 +91,30 @@ GTalkAccount.prototype = {</span>
<a href="#l1.66"></a><span id="l1.66">       let resource = this.getString(&quot;resource&quot;);</span>
<a href="#l1.67"></a><span id="l1.67">       this._jid = this._setJID(this._jid.domain, this._jid.node, resource);</span>
<a href="#l1.68"></a><span id="l1.68">     }</span>
<a href="#l1.69"></a><span id="l1.69"> </span>
<a href="#l1.70"></a><span id="l1.70">     this._connection =</span>
<a href="#l1.71"></a><span id="l1.71">       new XMPPSession(&quot;talk.google.com&quot;, 443,</span>
<a href="#l1.72"></a><span id="l1.72">                       &quot;require_tls&quot;, this._jid,</span>
<a href="#l1.73"></a><span id="l1.73">                       this.imAccount.password, this);</span>
<a href="#l1.74"></a><span id="l1.74" class="difflineminus">-  }</span>
<a href="#l1.75"></a><span id="l1.75" class="difflineplus">+  },</span>
<a href="#l1.76"></a><span id="l1.76"> };</span>
<a href="#l1.77"></a><span id="l1.77"> </span>
<a href="#l1.78"></a><span id="l1.78"> function GTalkProtocol() {</span>
<a href="#l1.79"></a><span id="l1.79">   ChromeUtils.import(&quot;resource:///modules/xmpp-commands.jsm&quot;, this);</span>
<a href="#l1.80"></a><span id="l1.80">   this.registerCommands();</span>
<a href="#l1.81"></a><span id="l1.81"> }</span>
<a href="#l1.82"></a><span id="l1.82"> GTalkProtocol.prototype = {</span>
<a href="#l1.83"></a><span id="l1.83">   __proto__: GenericProtocolPrototype,</span>
<a href="#l1.84"></a><span id="l1.84">   get normalizedName() { return &quot;gtalk&quot;; },</span>
<a href="#l1.85"></a><span id="l1.85">   get name() { return _(&quot;gtalk.protocolName&quot;); },</span>
<a href="#l1.86"></a><span id="l1.86">   get iconBaseURI() { return &quot;chrome://prpl-gtalk/skin/&quot;; },</span>
<a href="#l1.87"></a><span id="l1.87">   get usernameEmptyText() { return _(&quot;gtalk.usernameHint&quot;); },</span>
<a href="#l1.88"></a><span id="l1.88" class="difflineminus">-  getAccount: function(aImAccount) { return new GTalkAccount(this, aImAccount); },</span>
<a href="#l1.89"></a><span id="l1.89" class="difflineplus">+  getAccount(aImAccount) { return new GTalkAccount(this, aImAccount); },</span>
<a href="#l1.90"></a><span id="l1.90">   options: {</span>
<a href="#l1.91"></a><span id="l1.91" class="difflineminus">-    resource: {get label() { return _(&quot;options.resource&quot;); }, default: &quot;&quot;}</span>
<a href="#l1.92"></a><span id="l1.92" class="difflineplus">+    resource: {get label() { return _(&quot;options.resource&quot;); }, default: &quot;&quot;},</span>
<a href="#l1.93"></a><span id="l1.93">   },</span>
<a href="#l1.94"></a><span id="l1.94">   get chatHasTopic() { return true; },</span>
<a href="#l1.95"></a><span id="l1.95" class="difflineminus">-  classID: Components.ID(&quot;{38a224c1-6748-49a9-8ab2-efc362b1000d}&quot;)</span>
<a href="#l1.96"></a><span id="l1.96" class="difflineplus">+  classID: Components.ID(&quot;{38a224c1-6748-49a9-8ab2-efc362b1000d}&quot;),</span>
<a href="#l1.97"></a><span id="l1.97"> };</span>
<a href="#l1.98"></a><span id="l1.98"> </span>
<a href="#l1.99"></a><span id="l1.99"> var NSGetFactory = XPCOMUtils.generateNSGetFactory([GTalkProtocol]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/chat/protocols/odnoklassniki/odnoklassniki.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/chat/protocols/odnoklassniki/odnoklassniki.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -27,30 +27,31 @@ var {</span>
<a href="#l2.4"></a><span id="l2.4"> } = ChromeUtils.import(&quot;resource:///modules/jsProtoHelper.jsm&quot;);</span>
<a href="#l2.5"></a><span id="l2.5"> var {</span>
<a href="#l2.6"></a><span id="l2.6">   XMPPConversationPrototype,</span>
<a href="#l2.7"></a><span id="l2.7">   XMPPMUCConversationPrototype,</span>
<a href="#l2.8"></a><span id="l2.8">   XMPPAccountBuddyPrototype,</span>
<a href="#l2.9"></a><span id="l2.9">   XMPPAccountPrototype,</span>
<a href="#l2.10"></a><span id="l2.10"> } = ChromeUtils.import(&quot;resource:///modules/xmpp.jsm&quot;);</span>
<a href="#l2.11"></a><span id="l2.11"> var {</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-  XMPPSession, XMPPDefaultResource</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+  XMPPSession,</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+  XMPPDefaultResource,</span>
<a href="#l2.15"></a><span id="l2.15"> } = ChromeUtils.import(&quot;resource:///modules/xmpp-session.jsm&quot;);</span>
<a href="#l2.16"></a><span id="l2.16"> </span>
<a href="#l2.17"></a><span id="l2.17"> XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l2.18"></a><span id="l2.18">   l10nHelper(&quot;chrome://chat/locale/xmpp.properties&quot;)</span>
<a href="#l2.19"></a><span id="l2.19"> );</span>
<a href="#l2.20"></a><span id="l2.20"> </span>
<a href="#l2.21"></a><span id="l2.21"> function OdnoklassnikiAccount(aProtoInstance, aImAccount) {</span>
<a href="#l2.22"></a><span id="l2.22">   this._init(aProtoInstance, aImAccount);</span>
<a href="#l2.23"></a><span id="l2.23"> }</span>
<a href="#l2.24"></a><span id="l2.24"> OdnoklassnikiAccount.prototype = {</span>
<a href="#l2.25"></a><span id="l2.25">   __proto__: XMPPAccountPrototype,</span>
<a href="#l2.26"></a><span id="l2.26">   get canJoinChat() { return false; },</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineminus">-  connect: function() {</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineplus">+  connect() {</span>
<a href="#l2.29"></a><span id="l2.29">     if (!this.name.includes(&quot;@&quot;)) {</span>
<a href="#l2.30"></a><span id="l2.30">       // TODO: Do not use the default resource value if the user has not</span>
<a href="#l2.31"></a><span id="l2.31">       // specified it and let the service generate it.</span>
<a href="#l2.32"></a><span id="l2.32">       let jid = this.name + &quot;@odnoklassniki.ru/&quot; + XMPPDefaultResource;</span>
<a href="#l2.33"></a><span id="l2.33">       this._jid = this._parseJID(jid);</span>
<a href="#l2.34"></a><span id="l2.34">     }</span>
<a href="#l2.35"></a><span id="l2.35">     else {</span>
<a href="#l2.36"></a><span id="l2.36">       this._jid = this._parseJID(this.name);</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineat">@@ -61,24 +62,24 @@ OdnoklassnikiAccount.prototype = {</span>
<a href="#l2.38"></a><span id="l2.38">         this.reportDisconnected();</span>
<a href="#l2.39"></a><span id="l2.39">         return;</span>
<a href="#l2.40"></a><span id="l2.40">       }</span>
<a href="#l2.41"></a><span id="l2.41">     }</span>
<a href="#l2.42"></a><span id="l2.42"> </span>
<a href="#l2.43"></a><span id="l2.43">     this._connection = new XMPPSession(&quot;xmpp.odnoklassniki.ru&quot;, 5222,</span>
<a href="#l2.44"></a><span id="l2.44">                                        &quot;require_tls&quot;, this._jid,</span>
<a href="#l2.45"></a><span id="l2.45">                                        this.imAccount.password, this);</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineminus">-  }</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineplus">+  },</span>
<a href="#l2.48"></a><span id="l2.48"> };</span>
<a href="#l2.49"></a><span id="l2.49"> </span>
<a href="#l2.50"></a><span id="l2.50"> function OdnoklassnikiProtocol() {</span>
<a href="#l2.51"></a><span id="l2.51"> }</span>
<a href="#l2.52"></a><span id="l2.52"> OdnoklassnikiProtocol.prototype = {</span>
<a href="#l2.53"></a><span id="l2.53">   __proto__: GenericProtocolPrototype,</span>
<a href="#l2.54"></a><span id="l2.54">   get normalizedName() { return &quot;odnoklassniki&quot;; },</span>
<a href="#l2.55"></a><span id="l2.55">   get name() { return _(&quot;odnoklassniki.protocolName&quot;); },</span>
<a href="#l2.56"></a><span id="l2.56">   get iconBaseURI() { return &quot;chrome://prpl-odnoklassniki/skin/&quot;; },</span>
<a href="#l2.57"></a><span id="l2.57">   get usernameEmptyText() { return _(&quot;odnoklassniki.usernameHint&quot;); },</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineminus">-  getAccount: function(aImAccount) { return new OdnoklassnikiAccount(this, aImAccount); },</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineminus">-  classID: Components.ID(&quot;{29b09a83-81c1-2032-11e2-6d9bc4f8e969}&quot;)</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineplus">+  getAccount(aImAccount) { return new OdnoklassnikiAccount(this, aImAccount); },</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineplus">+  classID: Components.ID(&quot;{29b09a83-81c1-2032-11e2-6d9bc4f8e969}&quot;),</span>
<a href="#l2.62"></a><span id="l2.62"> };</span>
<a href="#l2.63"></a><span id="l2.63"> </span>
<a href="#l2.64"></a><span id="l2.64"> var NSGetFactory = XPCOMUtils.generateNSGetFactory([OdnoklassnikiProtocol]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/chat/protocols/xmpp/test/test_authmechs.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/chat/protocols/xmpp/test/test_authmechs.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -6,17 +6,17 @@ var {Stanza} = ChromeUtils.import(&quot;resou</span>
<a href="#l3.4"></a><span id="l3.4"> </span>
<a href="#l3.5"></a><span id="l3.5"> /*</span>
<a href="#l3.6"></a><span id="l3.6">  * Test PLAIN using the examples given in section 6 of RFC 6120.</span>
<a href="#l3.7"></a><span id="l3.7">  */</span>
<a href="#l3.8"></a><span id="l3.8"> add_task(async function testPlain() {</span>
<a href="#l3.9"></a><span id="l3.9">   const username = &quot;juliet&quot;;</span>
<a href="#l3.10"></a><span id="l3.10">   const password = &quot;r0m30myr0m30&quot;;</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-  let mech = XMPPAuthMechanisms[&quot;PLAIN&quot;](username, password, undefined);</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+  let mech = XMPPAuthMechanisms.PLAIN(username, password, undefined);</span>
<a href="#l3.14"></a><span id="l3.14"> </span>
<a href="#l3.15"></a><span id="l3.15">   // Send the initiation message.</span>
<a href="#l3.16"></a><span id="l3.16">   let result = mech.next();</span>
<a href="#l3.17"></a><span id="l3.17">   ok(!result.done);</span>
<a href="#l3.18"></a><span id="l3.18">   let value = await Promise.resolve(result.value);</span>
<a href="#l3.19"></a><span id="l3.19"> </span>
<a href="#l3.20"></a><span id="l3.20">   // Check the PLAIN content.</span>
<a href="#l3.21"></a><span id="l3.21">   equal(value.send.children[0].text, &quot;AGp1bGlldAByMG0zMG15cjBtMzA=&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/chat/protocols/xmpp/test/test_dnsSrv.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/chat/protocols/xmpp/test/test_dnsSrv.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -14,97 +14,97 @@ Services.scriptloader.loadSubScript(&quot;res</span>
<a href="#l4.4"></a><span id="l4.4">                                     xmppSession);</span>
<a href="#l4.5"></a><span id="l4.5"> </span>
<a href="#l4.6"></a><span id="l4.6"> function FakeXMPPSession() {}</span>
<a href="#l4.7"></a><span id="l4.7"> FakeXMPPSession.prototype = {</span>
<a href="#l4.8"></a><span id="l4.8">   __proto__: xmppSession.XMPPSession.prototype,</span>
<a href="#l4.9"></a><span id="l4.9">   _account: { __proto__: xmpp.XMPPAccount.prototype },</span>
<a href="#l4.10"></a><span id="l4.10">   _host: null,</span>
<a href="#l4.11"></a><span id="l4.11">   _port: 0,</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-  connect: function(aHostOrigin, aPortOrigin, aSecurity, aProxy,</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-                    aHost = aHostOrigin, aPort = aPortOrigin) {},</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">-  _connectNextRecord: function() { this.isConnectNextRecord = true; },</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+  connect(aHostOrigin, aPortOrigin, aSecurity, aProxy,</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+          aHost = aHostOrigin, aPort = aPortOrigin) {},</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+  _connectNextRecord() { this.isConnectNextRecord = true; },</span>
<a href="#l4.18"></a><span id="l4.18"> </span>
<a href="#l4.19"></a><span id="l4.19">   // Used to indicate that method _connectNextRecord is called or not.</span>
<a href="#l4.20"></a><span id="l4.20">   isConnectNextRecord: false,</span>
<a href="#l4.21"></a><span id="l4.21"> </span>
<a href="#l4.22"></a><span id="l4.22" class="difflineminus">-  LOG: function(aMsg) {},</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineminus">-  WARN: function(aMsg) {},</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineplus">+  LOG(aMsg) {},</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineplus">+  WARN(aMsg) {},</span>
<a href="#l4.26"></a><span id="l4.26"> };</span>
<a href="#l4.27"></a><span id="l4.27"> </span>
<a href="#l4.28"></a><span id="l4.28"> var TEST_DATA = [</span>
<a href="#l4.29"></a><span id="l4.29">   {</span>
<a href="#l4.30"></a><span id="l4.30">     // Test sorting based on priority and weight.</span>
<a href="#l4.31"></a><span id="l4.31">     input: [</span>
<a href="#l4.32"></a><span id="l4.32">       new dns.SRVRecord(20, 0, &quot;xmpp.instantbird.com&quot;, 5222),</span>
<a href="#l4.33"></a><span id="l4.33">       new dns.SRVRecord(5, 0, &quot;xmpp1.instantbird.com&quot;, 5222),</span>
<a href="#l4.34"></a><span id="l4.34">       new dns.SRVRecord(10, 0, &quot;xmpp2.instantbird.com&quot;, 5222),</span>
<a href="#l4.35"></a><span id="l4.35">       new dns.SRVRecord(0, 0, &quot;xmpp3.instantbird.com&quot;, 5222),</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineminus">-      new dns.SRVRecord(15, 0, &quot;xmpp4.instantbird.com&quot;, 5222)</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+      new dns.SRVRecord(15, 0, &quot;xmpp4.instantbird.com&quot;, 5222),</span>
<a href="#l4.38"></a><span id="l4.38">     ],</span>
<a href="#l4.39"></a><span id="l4.39">     output: [</span>
<a href="#l4.40"></a><span id="l4.40">       new dns.SRVRecord(0, 0, &quot;xmpp3.instantbird.com&quot;, 5222),</span>
<a href="#l4.41"></a><span id="l4.41">       new dns.SRVRecord(5, 0, &quot;xmpp1.instantbird.com&quot;, 5222),</span>
<a href="#l4.42"></a><span id="l4.42">       new dns.SRVRecord(10, 0, &quot;xmpp2.instantbird.com&quot;, 5222),</span>
<a href="#l4.43"></a><span id="l4.43">       new dns.SRVRecord(15, 0, &quot;xmpp4.instantbird.com&quot;, 5222),</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineminus">-      new dns.SRVRecord(20, 0, &quot;xmpp.instantbird.com&quot;, 5222)</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineplus">+      new dns.SRVRecord(20, 0, &quot;xmpp.instantbird.com&quot;, 5222),</span>
<a href="#l4.46"></a><span id="l4.46">     ],</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineminus">-    isConnectNextRecord: true</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineplus">+    isConnectNextRecord: true,</span>
<a href="#l4.49"></a><span id="l4.49">   },</span>
<a href="#l4.50"></a><span id="l4.50">   {</span>
<a href="#l4.51"></a><span id="l4.51">     input: [</span>
<a href="#l4.52"></a><span id="l4.52">       new dns.SRVRecord(5, 30, &quot;xmpp5.instantbird.com&quot;, 5222),</span>
<a href="#l4.53"></a><span id="l4.53">       new dns.SRVRecord(5, 0, &quot;xmpp1.instantbird.com&quot;, 5222),</span>
<a href="#l4.54"></a><span id="l4.54">       new dns.SRVRecord(10, 60, &quot;xmpp2.instantbird.com&quot;, 5222),</span>
<a href="#l4.55"></a><span id="l4.55">       new dns.SRVRecord(5, 10, &quot;xmpp3.instantbird.com&quot;, 5222),</span>
<a href="#l4.56"></a><span id="l4.56">       new dns.SRVRecord(20, 10, &quot;xmpp.instantbird.com&quot;, 5222),</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineminus">-      new dns.SRVRecord(15, 0, &quot;xmpp4.instantbird.com&quot;, 5222)</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineplus">+      new dns.SRVRecord(15, 0, &quot;xmpp4.instantbird.com&quot;, 5222),</span>
<a href="#l4.59"></a><span id="l4.59">     ],</span>
<a href="#l4.60"></a><span id="l4.60">     output: [</span>
<a href="#l4.61"></a><span id="l4.61">       new dns.SRVRecord(5, 30, &quot;xmpp5.instantbird.com&quot;, 5222),</span>
<a href="#l4.62"></a><span id="l4.62">       new dns.SRVRecord(5, 10, &quot;xmpp3.instantbird.com&quot;, 5222),</span>
<a href="#l4.63"></a><span id="l4.63">       new dns.SRVRecord(5, 0, &quot;xmpp1.instantbird.com&quot;, 5222),</span>
<a href="#l4.64"></a><span id="l4.64">       new dns.SRVRecord(10, 60, &quot;xmpp2.instantbird.com&quot;, 5222),</span>
<a href="#l4.65"></a><span id="l4.65">       new dns.SRVRecord(15, 0, &quot;xmpp4.instantbird.com&quot;, 5222),</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineminus">-      new dns.SRVRecord(20,10, &quot;xmpp.instantbird.com&quot;, 5222)</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineplus">+      new dns.SRVRecord(20, 10, &quot;xmpp.instantbird.com&quot;, 5222),</span>
<a href="#l4.68"></a><span id="l4.68">     ],</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineminus">-    isConnectNextRecord: true</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineplus">+    isConnectNextRecord: true,</span>
<a href="#l4.71"></a><span id="l4.71">   },</span>
<a href="#l4.72"></a><span id="l4.72"> </span>
<a href="#l4.73"></a><span id="l4.73">   // Tests no SRV records are found.</span>
<a href="#l4.74"></a><span id="l4.74">   {</span>
<a href="#l4.75"></a><span id="l4.75">     input: [],</span>
<a href="#l4.76"></a><span id="l4.76">     output: [],</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineminus">-    isConnectNextRecord: false</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineplus">+    isConnectNextRecord: false,</span>
<a href="#l4.79"></a><span id="l4.79">   },</span>
<a href="#l4.80"></a><span id="l4.80"> </span>
<a href="#l4.81"></a><span id="l4.81">   // Tests XMPP is not supported if the result is one record with target &quot;.&quot;.</span>
<a href="#l4.82"></a><span id="l4.82">   {</span>
<a href="#l4.83"></a><span id="l4.83">     input: [</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineminus">-      new dns.SRVRecord(5, 30, &quot;.&quot;, 5222)</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineplus">+      new dns.SRVRecord(5, 30, &quot;.&quot;, 5222),</span>
<a href="#l4.86"></a><span id="l4.86">     ],</span>
<a href="#l4.87"></a><span id="l4.87">     output: xmppSession.XMPPSession.prototype.SRV_ERROR_XMPP_NOT_SUPPORTED,</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineminus">-    isConnectNextRecord: false</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineplus">+    isConnectNextRecord: false,</span>
<a href="#l4.90"></a><span id="l4.90">   },</span>
<a href="#l4.91"></a><span id="l4.91">   {</span>
<a href="#l4.92"></a><span id="l4.92">     input: [</span>
<a href="#l4.93"></a><span id="l4.93" class="difflineminus">-      new dns.SRVRecord(5, 30, &quot;xmpp.instantbird.com&quot;, 5222)</span>
<a href="#l4.94"></a><span id="l4.94" class="difflineplus">+      new dns.SRVRecord(5, 30, &quot;xmpp.instantbird.com&quot;, 5222),</span>
<a href="#l4.95"></a><span id="l4.95">     ],</span>
<a href="#l4.96"></a><span id="l4.96">     output: [</span>
<a href="#l4.97"></a><span id="l4.97" class="difflineminus">-      new dns.SRVRecord(5, 30, &quot;xmpp.instantbird.com&quot;, 5222)</span>
<a href="#l4.98"></a><span id="l4.98" class="difflineplus">+      new dns.SRVRecord(5, 30, &quot;xmpp.instantbird.com&quot;, 5222),</span>
<a href="#l4.99"></a><span id="l4.99">     ],</span>
<a href="#l4.100"></a><span id="l4.100" class="difflineminus">-    isConnectNextRecord: true</span>
<a href="#l4.101"></a><span id="l4.101" class="difflineplus">+    isConnectNextRecord: true,</span>
<a href="#l4.102"></a><span id="l4.102">   },</span>
<a href="#l4.103"></a><span id="l4.103"> </span>
<a href="#l4.104"></a><span id="l4.104">   // Tests error happened during SRV lookup.</span>
<a href="#l4.105"></a><span id="l4.105">   {</span>
<a href="#l4.106"></a><span id="l4.106">     input: -1,</span>
<a href="#l4.107"></a><span id="l4.107">     output: xmppSession.XMPPSession.prototype.SRV_ERROR_LOOKUP_FAILED,</span>
<a href="#l4.108"></a><span id="l4.108" class="difflineminus">-    isConnectNextRecord: false</span>
<a href="#l4.109"></a><span id="l4.109" class="difflineminus">-  }</span>
<a href="#l4.110"></a><span id="l4.110" class="difflineplus">+    isConnectNextRecord: false,</span>
<a href="#l4.111"></a><span id="l4.111" class="difflineplus">+  },</span>
<a href="#l4.112"></a><span id="l4.112"> ];</span>
<a href="#l4.113"></a><span id="l4.113"> </span>
<a href="#l4.114"></a><span id="l4.114"> function run_test() {</span>
<a href="#l4.115"></a><span id="l4.115">   for (let currentQuery of TEST_DATA) {</span>
<a href="#l4.116"></a><span id="l4.116">     let session = new FakeXMPPSession();</span>
<a href="#l4.117"></a><span id="l4.117">     try {</span>
<a href="#l4.118"></a><span id="l4.118">       session._handleSrvQuery(currentQuery.input);</span>
<a href="#l4.119"></a><span id="l4.119">       equal(session._srvRecords.length, currentQuery.output.length);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/chat/protocols/xmpp/test/test_parseJidAndNormalization.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/chat/protocols/xmpp/test/test_parseJidAndNormalization.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -6,65 +6,65 @@ var {Services} = ChromeUtils.import(&quot;res</span>
<a href="#l5.4"></a><span id="l5.4"> var xmpp = {};</span>
<a href="#l5.5"></a><span id="l5.5"> Services.scriptloader.loadSubScript(&quot;resource:///components/xmpp.js&quot;, xmpp);</span>
<a href="#l5.6"></a><span id="l5.6"> </span>
<a href="#l5.7"></a><span id="l5.7"> var TEST_DATA = {</span>
<a href="#l5.8"></a><span id="l5.8">   &quot;abdelrhman@instantbird&quot;: {</span>
<a href="#l5.9"></a><span id="l5.9">     node: &quot;abdelrhman&quot;,</span>
<a href="#l5.10"></a><span id="l5.10">     domain: &quot;instantbird&quot;,</span>
<a href="#l5.11"></a><span id="l5.11">     jid: &quot;abdelrhman@instantbird&quot;,</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-    normalized: &quot;abdelrhman@instantbird&quot;</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+    normalized: &quot;abdelrhman@instantbird&quot;,</span>
<a href="#l5.14"></a><span id="l5.14">   },</span>
<a href="#l5.15"></a><span id="l5.15">   &quot; room@instantbird/abdelrhman &quot;: {</span>
<a href="#l5.16"></a><span id="l5.16">     node: &quot;room&quot;,</span>
<a href="#l5.17"></a><span id="l5.17">     domain: &quot;instantbird&quot;,</span>
<a href="#l5.18"></a><span id="l5.18">     resource: &quot;abdelrhman&quot;,</span>
<a href="#l5.19"></a><span id="l5.19">     jid: &quot;room@instantbird/abdelrhman&quot;,</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineminus">-    normalized: &quot;room@instantbird&quot;</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineplus">+    normalized: &quot;room@instantbird&quot;,</span>
<a href="#l5.22"></a><span id="l5.22">   },</span>
<a href="#l5.23"></a><span id="l5.23">   &quot;room@instantbird/@bdelrhman&quot;: {</span>
<a href="#l5.24"></a><span id="l5.24">     node: &quot;room&quot;,</span>
<a href="#l5.25"></a><span id="l5.25">     domain: &quot;instantbird&quot;,</span>
<a href="#l5.26"></a><span id="l5.26">     resource: &quot;@bdelrhman&quot;,</span>
<a href="#l5.27"></a><span id="l5.27">     jid: &quot;room@instantbird/@bdelrhman&quot;,</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineminus">-    normalized: &quot;room@instantbird&quot;</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineplus">+    normalized: &quot;room@instantbird&quot;,</span>
<a href="#l5.30"></a><span id="l5.30">   },</span>
<a href="#l5.31"></a><span id="l5.31">   &quot;room@instantbird/abdelrhm\u0061\u0308n&quot;: {</span>
<a href="#l5.32"></a><span id="l5.32">     node: &quot;room&quot;,</span>
<a href="#l5.33"></a><span id="l5.33">     domain: &quot;instantbird&quot;,</span>
<a href="#l5.34"></a><span id="l5.34">     resource: &quot;abdelrhm\u0061\u0308n&quot;,</span>
<a href="#l5.35"></a><span id="l5.35">     jid: &quot;room@instantbird/abdelrhm\u0061\u0308n&quot;,</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineminus">-    normalized: &quot;room@instantbird&quot;</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineplus">+    normalized: &quot;room@instantbird&quot;,</span>
<a href="#l5.38"></a><span id="l5.38">   },</span>
<a href="#l5.39"></a><span id="l5.39">   &quot;Room@Instantbird/Abdelrhman&quot;: {</span>
<a href="#l5.40"></a><span id="l5.40">     node: &quot;room&quot;,</span>
<a href="#l5.41"></a><span id="l5.41">     domain: &quot;instantbird&quot;,</span>
<a href="#l5.42"></a><span id="l5.42">     resource: &quot;Abdelrhman&quot;,</span>
<a href="#l5.43"></a><span id="l5.43">     jid: &quot;room@instantbird/Abdelrhman&quot;,</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineminus">-    normalized: &quot;room@instantbird&quot;</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineplus">+    normalized: &quot;room@instantbird&quot;,</span>
<a href="#l5.46"></a><span id="l5.46">   },</span>
<a href="#l5.47"></a><span id="l5.47">   &quot;Abdelrhman@instantbird/Instant bird&quot;: {</span>
<a href="#l5.48"></a><span id="l5.48">     node: &quot;abdelrhman&quot;,</span>
<a href="#l5.49"></a><span id="l5.49">     domain: &quot;instantbird&quot;,</span>
<a href="#l5.50"></a><span id="l5.50">     resource: &quot;Instant bird&quot;,</span>
<a href="#l5.51"></a><span id="l5.51">     jid: &quot;abdelrhman@instantbird/Instant bird&quot;,</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineminus">-    normalized: &quot;abdelrhman@instantbird&quot;</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineplus">+    normalized: &quot;abdelrhman@instantbird&quot;,</span>
<a href="#l5.54"></a><span id="l5.54">   },</span>
<a href="#l5.55"></a><span id="l5.55">   &quot;abdelrhman@host/instant/Bird&quot;: {</span>
<a href="#l5.56"></a><span id="l5.56">     node: &quot;abdelrhman&quot;,</span>
<a href="#l5.57"></a><span id="l5.57">     domain: &quot;host&quot;,</span>
<a href="#l5.58"></a><span id="l5.58">     resource: &quot;instant/Bird&quot;,</span>
<a href="#l5.59"></a><span id="l5.59">     jid: &quot;abdelrhman@host/instant/Bird&quot;,</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineminus">-    normalized: &quot;abdelrhman@host&quot;</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineplus">+    normalized: &quot;abdelrhman@host&quot;,</span>
<a href="#l5.62"></a><span id="l5.62">   },</span>
<a href="#l5.63"></a><span id="l5.63">   &quot;instantbird&quot;: {</span>
<a href="#l5.64"></a><span id="l5.64">     domain: &quot;instantbird&quot;,</span>
<a href="#l5.65"></a><span id="l5.65">     jid: &quot;instantbird&quot;,</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineminus">-    normalized: &quot;instantbird&quot;</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineminus">-  }</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineplus">+    normalized: &quot;instantbird&quot;,</span>
<a href="#l5.69"></a><span id="l5.69" class="difflineplus">+  },</span>
<a href="#l5.70"></a><span id="l5.70"> };</span>
<a href="#l5.71"></a><span id="l5.71"> </span>
<a href="#l5.72"></a><span id="l5.72"> function testParseJID() {</span>
<a href="#l5.73"></a><span id="l5.73">   for (let currentJID in TEST_DATA) {</span>
<a href="#l5.74"></a><span id="l5.74">     let jid = xmpp.XMPPAccount.prototype._parseJID(currentJID);</span>
<a href="#l5.75"></a><span id="l5.75">     equal(jid.node, TEST_DATA[currentJID].node);</span>
<a href="#l5.76"></a><span id="l5.76">     equal(jid.domain, TEST_DATA[currentJID].domain);</span>
<a href="#l5.77"></a><span id="l5.77">     equal(jid.resource, TEST_DATA[currentJID].resource);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/chat/protocols/xmpp/test/test_saslPrep.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/chat/protocols/xmpp/test/test_saslPrep.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -8,59 +8,59 @@ Services.scriptloader.loadSubScript(&quot;res</span>
<a href="#l6.4"></a><span id="l6.4">                                     xmppAuth);</span>
<a href="#l6.5"></a><span id="l6.5"> </span>
<a href="#l6.6"></a><span id="l6.6"> // RFC 4013 3.Examples</span>
<a href="#l6.7"></a><span id="l6.7"> var TEST_DATA = [</span>
<a href="#l6.8"></a><span id="l6.8">   {</span>
<a href="#l6.9"></a><span id="l6.9">     // SOFT HYPHEN mapped to nothing.</span>
<a href="#l6.10"></a><span id="l6.10">     input: &quot;I\u00adX&quot;,</span>
<a href="#l6.11"></a><span id="l6.11">     output: &quot;IX&quot;,</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-    isError: false</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+    isError: false,</span>
<a href="#l6.14"></a><span id="l6.14">   },</span>
<a href="#l6.15"></a><span id="l6.15">   {</span>
<a href="#l6.16"></a><span id="l6.16">     // No transformation.</span>
<a href="#l6.17"></a><span id="l6.17">     input: &quot;user&quot;,</span>
<a href="#l6.18"></a><span id="l6.18">     output: &quot;user&quot;,</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineminus">-    isError: false</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineplus">+    isError: false,</span>
<a href="#l6.21"></a><span id="l6.21">   },</span>
<a href="#l6.22"></a><span id="l6.22">   {</span>
<a href="#l6.23"></a><span id="l6.23">     // Case preserved, will not match #2.</span>
<a href="#l6.24"></a><span id="l6.24">     input: &quot;USER&quot;,</span>
<a href="#l6.25"></a><span id="l6.25">     output: &quot;USER&quot;,</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineminus">-    isError: false</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineplus">+    isError: false,</span>
<a href="#l6.28"></a><span id="l6.28">   },</span>
<a href="#l6.29"></a><span id="l6.29">   {</span>
<a href="#l6.30"></a><span id="l6.30">     // Output is NFKC, input in ISO 8859-1.</span>
<a href="#l6.31"></a><span id="l6.31">     input: &quot;\u00aa&quot;,</span>
<a href="#l6.32"></a><span id="l6.32">     output: &quot;a&quot;,</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineminus">-    isError: false</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineplus">+    isError: false,</span>
<a href="#l6.35"></a><span id="l6.35">   },</span>
<a href="#l6.36"></a><span id="l6.36">   {</span>
<a href="#l6.37"></a><span id="l6.37">     // Output is NFKC, will match #1.</span>
<a href="#l6.38"></a><span id="l6.38">     input: &quot;\u2168&quot;,</span>
<a href="#l6.39"></a><span id="l6.39">     output: &quot;IX&quot;,</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineminus">-    isError: false</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineplus">+    isError: false,</span>
<a href="#l6.42"></a><span id="l6.42">   },</span>
<a href="#l6.43"></a><span id="l6.43">   {</span>
<a href="#l6.44"></a><span id="l6.44">     // Error - prohibited character.</span>
<a href="#l6.45"></a><span id="l6.45">     input: &quot;\u0007&quot;,</span>
<a href="#l6.46"></a><span id="l6.46">     output: &quot;&quot;,</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineminus">-    isError: true</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineplus">+    isError: true,</span>
<a href="#l6.49"></a><span id="l6.49">   },</span>
<a href="#l6.50"></a><span id="l6.50">   {</span>
<a href="#l6.51"></a><span id="l6.51">     // Error - bidirectional check.</span>
<a href="#l6.52"></a><span id="l6.52">     input: &quot;\u0627\u0031&quot;,</span>
<a href="#l6.53"></a><span id="l6.53">     output: &quot;&quot;,</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineminus">-    isError: true</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineminus">-  }</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineplus">+    isError: true,</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineplus">+  },</span>
<a href="#l6.58"></a><span id="l6.58"> ];</span>
<a href="#l6.59"></a><span id="l6.59"> </span>
<a href="#l6.60"></a><span id="l6.60"> function run_test() {</span>
<a href="#l6.61"></a><span id="l6.61">   for (let current of TEST_DATA) {</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineminus">-    try{</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineplus">+    try {</span>
<a href="#l6.64"></a><span id="l6.64">       let result = xmppAuth.saslPrep(current.input);</span>
<a href="#l6.65"></a><span id="l6.65">       equal(current.isError, false);</span>
<a href="#l6.66"></a><span id="l6.66">       equal(result, current.output);</span>
<a href="#l6.67"></a><span id="l6.67">     } catch (e) {</span>
<a href="#l6.68"></a><span id="l6.68">       equal(current.isError, true);</span>
<a href="#l6.69"></a><span id="l6.69">     }</span>
<a href="#l6.70"></a><span id="l6.70">   }</span>
<a href="#l6.71"></a><span id="l6.71"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/chat/protocols/xmpp/test/test_xmppParser.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/chat/protocols/xmpp/test/test_xmppParser.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -14,17 +14,17 @@ to=&quot;romeo@montague.example/garden&quot; type=</span>
<a href="#l7.4"></a><span id="l7.4"> counsel?&lt;/body&gt;\</span>
<a href="#l7.5"></a><span id="l7.5"> &lt;/message&gt;',</span>
<a href="#l7.6"></a><span id="l7.6">     output: '&lt;message xmlns=&quot;jabber:client&quot; \</span>
<a href="#l7.7"></a><span id="l7.7"> from=&quot;juliet@capulet.example/balcony&quot; to=&quot;romeo@montague.example/garden&quot; \</span>
<a href="#l7.8"></a><span id="l7.8"> type=&quot;chat&quot;&gt;&lt;body xmlns=&quot;jabber:client&quot;&gt;What man art thou that, thus \</span>
<a href="#l7.9"></a><span id="l7.9"> bescreen&quot;d in night, so stumblest on my counsel?&lt;/body&gt;\</span>
<a href="#l7.10"></a><span id="l7.10"> &lt;/message&gt;',</span>
<a href="#l7.11"></a><span id="l7.11">     isError: false,</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-    description: &quot;Message stanza with body element&quot;</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+    description: &quot;Message stanza with body element&quot;,</span>
<a href="#l7.14"></a><span id="l7.14">   },</span>
<a href="#l7.15"></a><span id="l7.15">   {</span>
<a href="#l7.16"></a><span id="l7.16">     input: '&lt;message xmlns=&quot;jabber:client&quot; from=&quot;romeo@montague.example&quot; \</span>
<a href="#l7.17"></a><span id="l7.17"> to=&quot;romeo@montague.example/home&quot; type=&quot;chat&quot;&gt;\</span>
<a href="#l7.18"></a><span id="l7.18"> &lt;received xmlns=&quot;urn:xmpp:carbons:2&quot;&gt;\</span>
<a href="#l7.19"></a><span id="l7.19"> &lt;forwarded xmlns=&quot;urn:xmpp:forward:0&quot;&gt;\</span>
<a href="#l7.20"></a><span id="l7.20"> &lt;message xmlns=&quot;jabber:client&quot; from=&quot;juliet@capulet.example/balcony&quot; \</span>
<a href="#l7.21"></a><span id="l7.21"> to=&quot;romeo@montague.example/garden&quot; type=&quot;chat&quot;&gt;\</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineat">@@ -43,64 +43,64 @@ to=&quot;romeo@montague.example/garden&quot; type=</span>
<a href="#l7.23"></a><span id="l7.23"> &lt;body xmlns=&quot;jabber:client&quot;&gt;What man art thou that, thus bescreen&quot;d in night, \</span>
<a href="#l7.24"></a><span id="l7.24"> so stumblest on my counsel?&lt;/body&gt;\</span>
<a href="#l7.25"></a><span id="l7.25"> &lt;thread xmlns=&quot;jabber:client&quot;&gt;0e3141cd80894871a68e6fe6b1ec56fa&lt;/thread&gt;\</span>
<a href="#l7.26"></a><span id="l7.26"> &lt;/message&gt;\</span>
<a href="#l7.27"></a><span id="l7.27"> &lt;/forwarded&gt;\</span>
<a href="#l7.28"></a><span id="l7.28"> &lt;/received&gt;\</span>
<a href="#l7.29"></a><span id="l7.29"> &lt;/message&gt;',</span>
<a href="#l7.30"></a><span id="l7.30">     isError: false,</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">-    description: &quot;Forwarded copy of message carbons&quot;</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+    description: &quot;Forwarded copy of message carbons&quot;,</span>
<a href="#l7.33"></a><span id="l7.33">   },</span>
<a href="#l7.34"></a><span id="l7.34">   {</span>
<a href="#l7.35"></a><span id="l7.35">     input: '&lt;message xmlns=&quot;jabber:client&quot; from=&quot;juliet@capulet.example/balcony&quot; \</span>
<a href="#l7.36"></a><span id="l7.36"> to=&quot;romeo@montague.example/garden&quot; type=&quot;chat&quot;&gt;\</span>
<a href="#l7.37"></a><span id="l7.37"> &lt;body&gt;What man art thou that, thus bescreen&quot;d in night, so stumblest on my \</span>
<a href="#l7.38"></a><span id="l7.38"> counsel?\</span>
<a href="#l7.39"></a><span id="l7.39"> &lt;/message&gt;',</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineminus">-    output: '',</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineplus">+    output: &quot;&quot;,</span>
<a href="#l7.42"></a><span id="l7.42">     isError: true,</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineminus">-    description: &quot;No closing of body tag&quot;</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineplus">+    description: &quot;No closing of body tag&quot;,</span>
<a href="#l7.45"></a><span id="l7.45">   },</span>
<a href="#l7.46"></a><span id="l7.46">   {</span>
<a href="#l7.47"></a><span id="l7.47">     input: '&lt;message xmlns=&quot;http://etherx.jabber.org/streams&quot; from=&quot;juliet@capulet.example/balcony&quot; \</span>
<a href="#l7.48"></a><span id="l7.48"> to=&quot;romeo@montague.example/garden&quot; type=&quot;chat&quot;&gt;\</span>
<a href="#l7.49"></a><span id="l7.49"> &lt;body&gt;What man art thou that, thus bescreen&quot;d in night, so stumblest on my \</span>
<a href="#l7.50"></a><span id="l7.50"> counsel?&lt;/body&gt;\</span>
<a href="#l7.51"></a><span id="l7.51"> &lt;/message&gt;',</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineminus">-    output: '',</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineplus">+    output: &quot;&quot;,</span>
<a href="#l7.54"></a><span id="l7.54">     isError: true,</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineminus">-    description: &quot;Invalid namespace of top-level element&quot;</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineplus">+    description: &quot;Invalid namespace of top-level element&quot;,</span>
<a href="#l7.57"></a><span id="l7.57">   },</span>
<a href="#l7.58"></a><span id="l7.58">   {</span>
<a href="#l7.59"></a><span id="l7.59">     input: '&lt;field xmlns=&quot;jabber:x:data&quot; type=&quot;fixed&quot;&gt;\</span>
<a href="#l7.60"></a><span id="l7.60"> &lt;value&gt;What man art thou that, thus bescreen&quot;d in night, so stumblest on my \</span>
<a href="#l7.61"></a><span id="l7.61"> counsel?&lt;/value&gt;\</span>
<a href="#l7.62"></a><span id="l7.62"> &lt;/field&gt;',</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineminus">-    output: '',</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineplus">+    output: &quot;&quot;,</span>
<a href="#l7.65"></a><span id="l7.65">     isError: true,</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineminus">-    description: &quot;Invalid top-level element&quot;</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineminus">-  }</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineplus">+    description: &quot;Invalid top-level element&quot;,</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineplus">+  },</span>
<a href="#l7.70"></a><span id="l7.70"> ];</span>
<a href="#l7.71"></a><span id="l7.71"> </span>
<a href="#l7.72"></a><span id="l7.72"> function testXMPPParser() {</span>
<a href="#l7.73"></a><span id="l7.73">   for (let current of TEST_DATA) {</span>
<a href="#l7.74"></a><span id="l7.74">     let listener = {</span>
<a href="#l7.75"></a><span id="l7.75">       output: current.output,</span>
<a href="#l7.76"></a><span id="l7.76">       description: current.description,</span>
<a href="#l7.77"></a><span id="l7.77">       isError: current.isError,</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineminus">-      onXMLError: function(aString) {</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineplus">+      onXMLError(aString) {</span>
<a href="#l7.80"></a><span id="l7.80">         ok(this.isError, aString + &quot; - &quot; + this.description);</span>
<a href="#l7.81"></a><span id="l7.81">       },</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineminus">-      LOG: function(aString) {},</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineminus">-      startLegacyAuth: function() {},</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineminus">-      onXmppStanza: function(aStanza) {</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineplus">+      LOG(aString) {},</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineplus">+      startLegacyAuth() {},</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineplus">+      onXmppStanza(aStanza) {</span>
<a href="#l7.88"></a><span id="l7.88">         equal(this.output, aStanza.getXML(), this.description);</span>
<a href="#l7.89"></a><span id="l7.89">         ok(!this.isError, this.description);</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineminus">-      }</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineplus">+      },</span>
<a href="#l7.92"></a><span id="l7.92">     };</span>
<a href="#l7.93"></a><span id="l7.93">     let parser = new xmppXml.XMPPParser(listener);</span>
<a href="#l7.94"></a><span id="l7.94">     let istream = Cc[&quot;@mozilla.org/io/string-input-stream;1&quot;]</span>
<a href="#l7.95"></a><span id="l7.95">                     .createInstance(Ci.nsIStringInputStream);</span>
<a href="#l7.96"></a><span id="l7.96">     istream.setData(current.input, current.input.length);</span>
<a href="#l7.97"></a><span id="l7.97">     parser.onDataAvailable(istream, 0, current.input.length);</span>
<a href="#l7.98"></a><span id="l7.98">     parser.destroy();</span>
<a href="#l7.99"></a><span id="l7.99">   }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/chat/protocols/xmpp/test/test_xmppXml.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/chat/protocols/xmpp/test/test_xmppXml.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -8,74 +8,74 @@ Services.scriptloader.loadSubScript(&quot;res</span>
<a href="#l8.4"></a><span id="l8.4"> </span>
<a href="#l8.5"></a><span id="l8.5"> var TEST_DATA = [</span>
<a href="#l8.6"></a><span id="l8.6">   {</span>
<a href="#l8.7"></a><span id="l8.7">     input: {</span>
<a href="#l8.8"></a><span id="l8.8">       name: &quot;message&quot;,</span>
<a href="#l8.9"></a><span id="l8.9">       namespace: xmppXml.NS.client,</span>
<a href="#l8.10"></a><span id="l8.10">       attributes: {</span>
<a href="#l8.11"></a><span id="l8.11">         jid: &quot;user@domain&quot;,</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-        type: null</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+        type: null,</span>
<a href="#l8.14"></a><span id="l8.14">       },</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineminus">-      data: []</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+      data: [],</span>
<a href="#l8.17"></a><span id="l8.17">     },</span>
<a href="#l8.18"></a><span id="l8.18">     XmlOutput: '&lt;message xmlns=&quot;jabber:client&quot; jid=&quot;user@domain&quot;/&gt;',</span>
<a href="#l8.19"></a><span id="l8.19">     stringOutput: '&lt;message xmlns=&quot;jabber:client&quot; jid=&quot;user@domain&quot;/&gt;\n',</span>
<a href="#l8.20"></a><span id="l8.20">     isError: false,</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineminus">-    description: &quot;Ignore attribute with null value&quot;</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineplus">+    description: &quot;Ignore attribute with null value&quot;,</span>
<a href="#l8.23"></a><span id="l8.23">   },</span>
<a href="#l8.24"></a><span id="l8.24">   {</span>
<a href="#l8.25"></a><span id="l8.25">     input: {</span>
<a href="#l8.26"></a><span id="l8.26">       name: &quot;message&quot;,</span>
<a href="#l8.27"></a><span id="l8.27">       namespace: xmppXml.NS.client,</span>
<a href="#l8.28"></a><span id="l8.28">       attributes: {</span>
<a href="#l8.29"></a><span id="l8.29">         jid: &quot;user@domain&quot;,</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineminus">-        type: undefined</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineplus">+        type: undefined,</span>
<a href="#l8.32"></a><span id="l8.32">       },</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineminus">-      data: []</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineplus">+      data: [],</span>
<a href="#l8.35"></a><span id="l8.35">     },</span>
<a href="#l8.36"></a><span id="l8.36">     XmlOutput: '&lt;message xmlns=&quot;jabber:client&quot; jid=&quot;user@domain&quot;/&gt;',</span>
<a href="#l8.37"></a><span id="l8.37">     stringOutput: '&lt;message xmlns=&quot;jabber:client&quot; jid=&quot;user@domain&quot;/&gt;\n',</span>
<a href="#l8.38"></a><span id="l8.38">     isError: false,</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineminus">-    description: &quot;Ignore attribute with undefined value&quot;</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineplus">+    description: &quot;Ignore attribute with undefined value&quot;,</span>
<a href="#l8.41"></a><span id="l8.41">   },</span>
<a href="#l8.42"></a><span id="l8.42">   {</span>
<a href="#l8.43"></a><span id="l8.43">     input: {</span>
<a href="#l8.44"></a><span id="l8.44">       name: &quot;message&quot;,</span>
<a href="#l8.45"></a><span id="l8.45">       namespace: undefined,</span>
<a href="#l8.46"></a><span id="l8.46">       attributes: {},</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineminus">-      data: []</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineplus">+      data: [],</span>
<a href="#l8.49"></a><span id="l8.49">     },</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineminus">-    XmlOutput: '&lt;message/&gt;',</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineminus">-    stringOutput: '&lt;message/&gt;\n',</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineplus">+    XmlOutput: &quot;&lt;message/&gt;&quot;,</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineplus">+    stringOutput: &quot;&lt;message/&gt;\n&quot;,</span>
<a href="#l8.54"></a><span id="l8.54">     isError: false,</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineminus">-    description: &quot;Ignore namespace with undefined value&quot;</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineplus">+    description: &quot;Ignore namespace with undefined value&quot;,</span>
<a href="#l8.57"></a><span id="l8.57">   },</span>
<a href="#l8.58"></a><span id="l8.58">   {</span>
<a href="#l8.59"></a><span id="l8.59">     input: {</span>
<a href="#l8.60"></a><span id="l8.60">       name: undefined,</span>
<a href="#l8.61"></a><span id="l8.61">       attributes: {},</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineminus">-      data: []</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineplus">+      data: [],</span>
<a href="#l8.64"></a><span id="l8.64">     },</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineminus">-    XmlOutput: '',</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineminus">-    stringOutput: '',</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineplus">+    XmlOutput: &quot;&quot;,</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineplus">+    stringOutput: &quot;&quot;,</span>
<a href="#l8.69"></a><span id="l8.69">     isError: true,</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineminus">-    description: &quot;Node must have a name&quot;</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineplus">+    description: &quot;Node must have a name&quot;,</span>
<a href="#l8.72"></a><span id="l8.72">   },</span>
<a href="#l8.73"></a><span id="l8.73">   {</span>
<a href="#l8.74"></a><span id="l8.74">     input: {</span>
<a href="#l8.75"></a><span id="l8.75">       name: &quot;message&quot;,</span>
<a href="#l8.76"></a><span id="l8.76">       attributes: {},</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineminus">-      data: &quot;test message&quot;</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineplus">+      data: &quot;test message&quot;,</span>
<a href="#l8.79"></a><span id="l8.79">     },</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineminus">-    XmlOutput: '&lt;message&gt;test message&lt;/message&gt;',</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineminus">-    stringOutput: '&lt;message&gt;\n test message\n&lt;/message&gt;\n',</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineplus">+    XmlOutput: &quot;&lt;message&gt;test message&lt;/message&gt;&quot;,</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineplus">+    stringOutput: &quot;&lt;message&gt;\n test message\n&lt;/message&gt;\n&quot;,</span>
<a href="#l8.84"></a><span id="l8.84">     isError: false,</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineminus">-    description: &quot;Node with text content&quot;</span>
<a href="#l8.86"></a><span id="l8.86" class="difflineminus">-  }</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineplus">+    description: &quot;Node with text content&quot;,</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineplus">+  },</span>
<a href="#l8.89"></a><span id="l8.89"> ];</span>
<a href="#l8.90"></a><span id="l8.90"> </span>
<a href="#l8.91"></a><span id="l8.91"> function testXMLNode() {</span>
<a href="#l8.92"></a><span id="l8.92">   for (let current of TEST_DATA) {</span>
<a href="#l8.93"></a><span id="l8.93">     try {</span>
<a href="#l8.94"></a><span id="l8.94">       let result =</span>
<a href="#l8.95"></a><span id="l8.95">         xmppXml.Stanza.node(current.input.name, current.input.namespace,</span>
<a href="#l8.96"></a><span id="l8.96">                             current.input.attributes, current.input.data);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/chat/protocols/xmpp/xmpp-authmechs.jsm</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/chat/protocols/xmpp/xmpp-authmechs.jsm</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -19,25 +19,25 @@ var {</span>
<a href="#l9.4"></a><span id="l9.4">   Stanza,</span>
<a href="#l9.5"></a><span id="l9.5">   XMPPParser,</span>
<a href="#l9.6"></a><span id="l9.6">   SupportedFeatures,</span>
<a href="#l9.7"></a><span id="l9.7"> } = ChromeUtils.import(&quot;resource:///modules/xmpp-xml.jsm&quot;);</span>
<a href="#l9.8"></a><span id="l9.8"> XPCOMUtils.defineLazyGlobalGetters(this, [&quot;crypto&quot;]);</span>
<a href="#l9.9"></a><span id="l9.9"> </span>
<a href="#l9.10"></a><span id="l9.10"> // Handle PLAIN authorization mechanism.</span>
<a href="#l9.11"></a><span id="l9.11"> function* PlainAuth(aUsername, aPassword, aDomain) {</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-  let data = &quot;\0&quot;+ aUsername + &quot;\0&quot; + aPassword;</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+  let data = &quot;\0&quot; + aUsername + &quot;\0&quot; + aPassword;</span>
<a href="#l9.14"></a><span id="l9.14"> </span>
<a href="#l9.15"></a><span id="l9.15">   // btoa for Unicode, see https://developer.mozilla.org/en-US/docs/DOM/window.btoa</span>
<a href="#l9.16"></a><span id="l9.16">   let base64Data = btoa(unescape(encodeURIComponent(data)));</span>
<a href="#l9.17"></a><span id="l9.17"> </span>
<a href="#l9.18"></a><span id="l9.18">   let stanza = yield {</span>
<a href="#l9.19"></a><span id="l9.19">     send: Stanza.node(&quot;auth&quot;, Stanza.NS.sasl, {mechanism: &quot;PLAIN&quot;},</span>
<a href="#l9.20"></a><span id="l9.20">                       base64Data),</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineminus">-    log: '&lt;auth mechanism:=&quot;PLAIN&quot;/&gt; (base64 encoded username and password not logged)'</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineplus">+    log: '&lt;auth mechanism:=&quot;PLAIN&quot;/&gt; (base64 encoded username and password not logged)',</span>
<a href="#l9.23"></a><span id="l9.23">   };</span>
<a href="#l9.24"></a><span id="l9.24"> </span>
<a href="#l9.25"></a><span id="l9.25">   if (stanza.localName != &quot;success&quot;)</span>
<a href="#l9.26"></a><span id="l9.26">     throw &quot;Didn't receive the expected auth success stanza.&quot;;</span>
<a href="#l9.27"></a><span id="l9.27"> }</span>
<a href="#l9.28"></a><span id="l9.28"> </span>
<a href="#l9.29"></a><span id="l9.29"> // Handle SCRAM-SHA-1 authorization mechanism.</span>
<a href="#l9.30"></a><span id="l9.30"> const RFC3454 = {</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineat">@@ -230,17 +230,17 @@ const RFC3454 = {</span>
<a href="#l9.32"></a><span id="l9.32"> [\u{1d18c}-\u{1d1a9}]|[\u{1d1ae}-\u{1d1dd}]|[\u{1d400}-\u{1d454}]|\</span>
<a href="#l9.33"></a><span id="l9.33"> [\u{1d456}-\u{1d49c}]|[\u{1d49e}-\u{1d49f}]|\u{1d4a2}|\</span>
<a href="#l9.34"></a><span id="l9.34"> [\u{1d4a5}-\u{1d4a6}]|[\u{1d4a9}-\u{1d4ac}]|[\u{1d4ae}-\u{1d4b9}]|\</span>
<a href="#l9.35"></a><span id="l9.35"> \u{1d4bb}|[\u{1d4bd}-\u{1d4c0}]|[\u{1d4c2}-\u{1d4c3}]|\</span>
<a href="#l9.36"></a><span id="l9.36"> [\u{1d4c5}-\u{1d505}]|[\u{1d507}-\u{1d50a}]|[\u{1d50d}-\u{1d514}]|\</span>
<a href="#l9.37"></a><span id="l9.37"> [\u{1d516}-\u{1d51c}]|[\u{1d51e}-\u{1d539}]|[\u{1d53b}-\u{1d53e}]|\</span>
<a href="#l9.38"></a><span id="l9.38"> [\u{1d540}-\u{1d544}]|\u{1d546}|[\u{1d54a}-\u{1d550}]|\</span>
<a href="#l9.39"></a><span id="l9.39"> [\u{1d552}-\u{1d6a3}]|[\u{1d6a8}-\u{1d7c9}]|[\u{20000}-\u{2a6d6}]|\</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineminus">-[\u{2f800}-\u{2fa1d}]|[\u{f0000}-\u{ffffd}]|[\u{100000}-\u{10fffd}]&quot;</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineplus">+[\u{2f800}-\u{2fa1d}]|[\u{f0000}-\u{ffffd}]|[\u{100000}-\u{10fffd}]&quot;,</span>
<a href="#l9.42"></a><span id="l9.42"> };</span>
<a href="#l9.43"></a><span id="l9.43"> </span>
<a href="#l9.44"></a><span id="l9.44"> // Generates a random nonce and returns a base64 encoded string.</span>
<a href="#l9.45"></a><span id="l9.45"> // aLength in bytes.</span>
<a href="#l9.46"></a><span id="l9.46"> function createNonce(aLength) {</span>
<a href="#l9.47"></a><span id="l9.47">   // RFC 5802 (5.1): Printable ASCII except &quot;,&quot;.</span>
<a href="#l9.48"></a><span id="l9.48">   // We guarantee a valid nonce value using base64 encoding.</span>
<a href="#l9.49"></a><span id="l9.49">   return btoa(CryptoUtils.generateRandomBytes(aLength));</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineat">@@ -293,17 +293,17 @@ function saslPrep(aString) {</span>
<a href="#l9.51"></a><span id="l9.51">   return retVal;</span>
<a href="#l9.52"></a><span id="l9.52"> }</span>
<a href="#l9.53"></a><span id="l9.53"> </span>
<a href="#l9.54"></a><span id="l9.54"> // Converts aName to saslname.</span>
<a href="#l9.55"></a><span id="l9.55"> function saslName(aName) {</span>
<a href="#l9.56"></a><span id="l9.56">   // RFC 5802 (5.1): the client SHOULD prepare the username using the &quot;SASLprep&quot;.</span>
<a href="#l9.57"></a><span id="l9.57">   // The characters , or = in usernames are sent as =2C and</span>
<a href="#l9.58"></a><span id="l9.58">   // =3D respectively.</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineminus">-  let saslName = saslPrep(aName).replace(/=/g,&quot;=3D&quot;).replace(/,/g, &quot;=2C&quot;);</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineplus">+  let saslName = saslPrep(aName).replace(/=/g, &quot;=3D&quot;).replace(/,/g, &quot;=2C&quot;);</span>
<a href="#l9.61"></a><span id="l9.61">   if (!saslName)</span>
<a href="#l9.62"></a><span id="l9.62">     throw &quot;Name is not valid&quot;;</span>
<a href="#l9.63"></a><span id="l9.63"> </span>
<a href="#l9.64"></a><span id="l9.64">   return saslName;</span>
<a href="#l9.65"></a><span id="l9.65"> }</span>
<a href="#l9.66"></a><span id="l9.66"> </span>
<a href="#l9.67"></a><span id="l9.67"> // Converts aMessage to array of bytes then apply SHA-1 hashing.</span>
<a href="#l9.68"></a><span id="l9.68"> function bytesAndSHA1(aMessage) {</span>
<a href="#l9.69"></a><span id="l9.69" class="difflineat">@@ -345,17 +345,17 @@ function* scramSHA1Auth(aUsername, aPass</span>
<a href="#l9.70"></a><span id="l9.70">   let cNonce = aNonce ? aNonce : createNonce(32);</span>
<a href="#l9.71"></a><span id="l9.71"> </span>
<a href="#l9.72"></a><span id="l9.72">   let clientFirstMessageBare =</span>
<a href="#l9.73"></a><span id="l9.73">     &quot;n=&quot; + saslName(aUsername) + &quot;,r=&quot; + cNonce;</span>
<a href="#l9.74"></a><span id="l9.74">   let clientFirstMessage = gs2Header + clientFirstMessageBare;</span>
<a href="#l9.75"></a><span id="l9.75"> </span>
<a href="#l9.76"></a><span id="l9.76">   let receivedStanza = yield {</span>
<a href="#l9.77"></a><span id="l9.77">     send: Stanza.node(&quot;auth&quot;, Stanza.NS.sasl, {mechanism: &quot;SCRAM-SHA-1&quot;},</span>
<a href="#l9.78"></a><span id="l9.78" class="difflineminus">-                      btoa(clientFirstMessage))</span>
<a href="#l9.79"></a><span id="l9.79" class="difflineplus">+                      btoa(clientFirstMessage)),</span>
<a href="#l9.80"></a><span id="l9.80">   };</span>
<a href="#l9.81"></a><span id="l9.81"> </span>
<a href="#l9.82"></a><span id="l9.82">   if (receivedStanza.localName != &quot;challenge&quot;)</span>
<a href="#l9.83"></a><span id="l9.83">     throw &quot;Not authorized&quot;;</span>
<a href="#l9.84"></a><span id="l9.84"> </span>
<a href="#l9.85"></a><span id="l9.85">   // RFC 5802 (3): SCRAM Algorithm Overview.</span>
<a href="#l9.86"></a><span id="l9.86">   let decodedChallenge = atob(receivedStanza.innerText);</span>
<a href="#l9.87"></a><span id="l9.87"> </span>
<a href="#l9.88"></a><span id="l9.88" class="difflineat">@@ -422,17 +422,17 @@ function* scramSHA1Auth(aUsername, aPass</span>
<a href="#l9.89"></a><span id="l9.89">                                  CryptoUtils.makeHMACKey(serverKey));</span>
<a href="#l9.90"></a><span id="l9.90">     serverSignature = CryptoUtils.digestBytes(authMessage, serverKeyHasher);</span>
<a href="#l9.91"></a><span id="l9.91"> </span>
<a href="#l9.92"></a><span id="l9.92">     let clientFinalMessage =</span>
<a href="#l9.93"></a><span id="l9.93">       clientFinalMessageWithoutProof + &quot;,p=&quot; + btoa(clientProof);</span>
<a href="#l9.94"></a><span id="l9.94"> </span>
<a href="#l9.95"></a><span id="l9.95">     return {</span>
<a href="#l9.96"></a><span id="l9.96">       send: Stanza.node(&quot;response&quot;, Stanza.NS.sasl, null, btoa(clientFinalMessage)),</span>
<a href="#l9.97"></a><span id="l9.97" class="difflineminus">-      log: '&lt;response/&gt; (base64 encoded SCRAM response containing password not logged)'</span>
<a href="#l9.98"></a><span id="l9.98" class="difflineplus">+      log: &quot;&lt;response/&gt; (base64 encoded SCRAM response containing password not logged)&quot;,</span>
<a href="#l9.99"></a><span id="l9.99">     };</span>
<a href="#l9.100"></a><span id="l9.100">   });</span>
<a href="#l9.101"></a><span id="l9.101"> </span>
<a href="#l9.102"></a><span id="l9.102">   // Only check server signature if we succeed to authenticate.</span>
<a href="#l9.103"></a><span id="l9.103">   if (receivedStanza.localName != &quot;success&quot;)</span>
<a href="#l9.104"></a><span id="l9.104">     throw &quot;Didn't receive the expected auth success stanza.&quot;;</span>
<a href="#l9.105"></a><span id="l9.105"> </span>
<a href="#l9.106"></a><span id="l9.106">   let decodedResponse = atob(receivedStanza.innerText);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/chat/protocols/xmpp/xmpp-commands.jsm</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/chat/protocols/xmpp/xmpp-commands.jsm</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -113,17 +113,17 @@ function invite(aMsg, aConv) {</span>
<a href="#l10.4"></a><span id="l10.4">   aConv.invite(...params);</span>
<a href="#l10.5"></a><span id="l10.5">   return true;</span>
<a href="#l10.6"></a><span id="l10.6"> }</span>
<a href="#l10.7"></a><span id="l10.7"> </span>
<a href="#l10.8"></a><span id="l10.8"> var commands = [</span>
<a href="#l10.9"></a><span id="l10.9">   {</span>
<a href="#l10.10"></a><span id="l10.10">     name: &quot;join&quot;,</span>
<a href="#l10.11"></a><span id="l10.11">     get helpString() { return _(&quot;command.join3&quot;, &quot;join&quot;); },</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-    run: function(aMsg, aConv, aReturnedConv) {</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+    run(aMsg, aConv, aReturnedConv) {</span>
<a href="#l10.14"></a><span id="l10.14">       let account = getAccount(aConv);</span>
<a href="#l10.15"></a><span id="l10.15">       let params = aMsg.trim();</span>
<a href="#l10.16"></a><span id="l10.16">       let conv;</span>
<a href="#l10.17"></a><span id="l10.17"> </span>
<a href="#l10.18"></a><span id="l10.18">       if (!params) {</span>
<a href="#l10.19"></a><span id="l10.19">         conv = getConv(aConv);</span>
<a href="#l10.20"></a><span id="l10.20">         if (!conv.isChat)</span>
<a href="#l10.21"></a><span id="l10.21">           return false;</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineat">@@ -141,128 +141,128 @@ var commands = [</span>
<a href="#l10.23"></a><span id="l10.23">         params = conv.name;</span>
<a href="#l10.24"></a><span id="l10.24">       }</span>
<a href="#l10.25"></a><span id="l10.25">       let chatRoomFields = account.getChatRoomDefaultFieldValues(params);</span>
<a href="#l10.26"></a><span id="l10.26">       conv = account.joinChat(chatRoomFields);</span>
<a href="#l10.27"></a><span id="l10.27"> </span>
<a href="#l10.28"></a><span id="l10.28">       if (aReturnedConv)</span>
<a href="#l10.29"></a><span id="l10.29">         aReturnedConv.value = conv;</span>
<a href="#l10.30"></a><span id="l10.30">       return true;</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineminus">-    }</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineplus">+    },</span>
<a href="#l10.33"></a><span id="l10.33">   },</span>
<a href="#l10.34"></a><span id="l10.34">   {</span>
<a href="#l10.35"></a><span id="l10.35">     name: &quot;part&quot;,</span>
<a href="#l10.36"></a><span id="l10.36">     get helpString() { return _(&quot;command.part2&quot;, &quot;part&quot;); },</span>
<a href="#l10.37"></a><span id="l10.37">     usageContext: Ci.imICommand.CMD_CONTEXT_CHAT,</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineminus">-    run: function(aMsg, aConv) {</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineplus">+    run(aMsg, aConv) {</span>
<a href="#l10.40"></a><span id="l10.40">       let conv = getConv(aConv);</span>
<a href="#l10.41"></a><span id="l10.41">       if (!conv.left)</span>
<a href="#l10.42"></a><span id="l10.42">         conv.part(aMsg);</span>
<a href="#l10.43"></a><span id="l10.43">       return true;</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineminus">-    }</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineplus">+    },</span>
<a href="#l10.46"></a><span id="l10.46">   },</span>
<a href="#l10.47"></a><span id="l10.47">   {</span>
<a href="#l10.48"></a><span id="l10.48">     name: &quot;topic&quot;,</span>
<a href="#l10.49"></a><span id="l10.49">     get helpString() { return _(&quot;command.topic&quot;, &quot;topic&quot;); },</span>
<a href="#l10.50"></a><span id="l10.50">     usageContext: Ci.imICommand.CMD_CONTEXT_CHAT,</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineminus">-    run: function(aMsg, aConv) {</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineplus">+    run(aMsg, aConv) {</span>
<a href="#l10.53"></a><span id="l10.53">       let conv = getMUC(aConv);</span>
<a href="#l10.54"></a><span id="l10.54">       if (!conv)</span>
<a href="#l10.55"></a><span id="l10.55">         return true;</span>
<a href="#l10.56"></a><span id="l10.56">       conv.topic = aMsg;</span>
<a href="#l10.57"></a><span id="l10.57">       return true;</span>
<a href="#l10.58"></a><span id="l10.58" class="difflineminus">-    }</span>
<a href="#l10.59"></a><span id="l10.59" class="difflineplus">+    },</span>
<a href="#l10.60"></a><span id="l10.60">   },</span>
<a href="#l10.61"></a><span id="l10.61">   {</span>
<a href="#l10.62"></a><span id="l10.62">     name: &quot;ban&quot;,</span>
<a href="#l10.63"></a><span id="l10.63">     get helpString() { return _(&quot;command.ban&quot;, &quot;ban&quot;); },</span>
<a href="#l10.64"></a><span id="l10.64">     usageContext: Ci.imICommand.CMD_CONTEXT_CHAT,</span>
<a href="#l10.65"></a><span id="l10.65" class="difflineminus">-    run: function(aMsg, aConv) {</span>
<a href="#l10.66"></a><span id="l10.66" class="difflineplus">+    run(aMsg, aConv) {</span>
<a href="#l10.67"></a><span id="l10.67">       let params = splitInput(aMsg);</span>
<a href="#l10.68"></a><span id="l10.68">       if (!params.length)</span>
<a href="#l10.69"></a><span id="l10.69">         return false;</span>
<a href="#l10.70"></a><span id="l10.70"> </span>
<a href="#l10.71"></a><span id="l10.71">       let conv = getMUC(aConv);</span>
<a href="#l10.72"></a><span id="l10.72">       if (conv)</span>
<a href="#l10.73"></a><span id="l10.73">         conv.ban(...params);</span>
<a href="#l10.74"></a><span id="l10.74">       return true;</span>
<a href="#l10.75"></a><span id="l10.75" class="difflineminus">-    }</span>
<a href="#l10.76"></a><span id="l10.76" class="difflineplus">+    },</span>
<a href="#l10.77"></a><span id="l10.77">   },</span>
<a href="#l10.78"></a><span id="l10.78">   {</span>
<a href="#l10.79"></a><span id="l10.79">     name: &quot;kick&quot;,</span>
<a href="#l10.80"></a><span id="l10.80">     get helpString() { return _(&quot;command.kick&quot;, &quot;kick&quot;); },</span>
<a href="#l10.81"></a><span id="l10.81">     usageContext: Ci.imICommand.CMD_CONTEXT_CHAT,</span>
<a href="#l10.82"></a><span id="l10.82" class="difflineminus">-    run: function(aMsg, aConv) {</span>
<a href="#l10.83"></a><span id="l10.83" class="difflineplus">+    run(aMsg, aConv) {</span>
<a href="#l10.84"></a><span id="l10.84">       let conv = getMUC(aConv);</span>
<a href="#l10.85"></a><span id="l10.85">       if (!conv)</span>
<a href="#l10.86"></a><span id="l10.86">         return true;</span>
<a href="#l10.87"></a><span id="l10.87"> </span>
<a href="#l10.88"></a><span id="l10.88">       let params = splitByNick(aMsg, conv);</span>
<a href="#l10.89"></a><span id="l10.89">       if (!params.length)</span>
<a href="#l10.90"></a><span id="l10.90">         return false;</span>
<a href="#l10.91"></a><span id="l10.91">       conv.kick(...params);</span>
<a href="#l10.92"></a><span id="l10.92">       return true;</span>
<a href="#l10.93"></a><span id="l10.93" class="difflineminus">-    }</span>
<a href="#l10.94"></a><span id="l10.94" class="difflineplus">+    },</span>
<a href="#l10.95"></a><span id="l10.95">   },</span>
<a href="#l10.96"></a><span id="l10.96">   {</span>
<a href="#l10.97"></a><span id="l10.97">     name: &quot;invite&quot;,</span>
<a href="#l10.98"></a><span id="l10.98">     get helpString() { return _(&quot;command.invite&quot;, &quot;invite&quot;); },</span>
<a href="#l10.99"></a><span id="l10.99">     usageContext: Ci.imICommand.CMD_CONTEXT_CHAT,</span>
<a href="#l10.100"></a><span id="l10.100" class="difflineminus">-    run: function(aMsg, aConv) {</span>
<a href="#l10.101"></a><span id="l10.101" class="difflineplus">+    run(aMsg, aConv) {</span>
<a href="#l10.102"></a><span id="l10.102">       let conv = getMUC(aConv);</span>
<a href="#l10.103"></a><span id="l10.103">       if (!conv)</span>
<a href="#l10.104"></a><span id="l10.104">         return true;</span>
<a href="#l10.105"></a><span id="l10.105"> </span>
<a href="#l10.106"></a><span id="l10.106">       return invite(aMsg, conv);</span>
<a href="#l10.107"></a><span id="l10.107" class="difflineminus">-    }</span>
<a href="#l10.108"></a><span id="l10.108" class="difflineplus">+    },</span>
<a href="#l10.109"></a><span id="l10.109">   },</span>
<a href="#l10.110"></a><span id="l10.110">   {</span>
<a href="#l10.111"></a><span id="l10.111">     name: &quot;inviteto&quot;,</span>
<a href="#l10.112"></a><span id="l10.112">     get helpString() { return _(&quot;command.inviteto&quot;, &quot;inviteto&quot;); },</span>
<a href="#l10.113"></a><span id="l10.113">     usageContext: Ci.imICommand.CMD_CONTEXT_IM,</span>
<a href="#l10.114"></a><span id="l10.114" class="difflineminus">-    run: (aMsg, aConv) =&gt; invite(aMsg, getConv(aConv))</span>
<a href="#l10.115"></a><span id="l10.115" class="difflineplus">+    run: (aMsg, aConv) =&gt; invite(aMsg, getConv(aConv)),</span>
<a href="#l10.116"></a><span id="l10.116">   },</span>
<a href="#l10.117"></a><span id="l10.117">   {</span>
<a href="#l10.118"></a><span id="l10.118">     name: &quot;me&quot;,</span>
<a href="#l10.119"></a><span id="l10.119">     get helpString() { return _(&quot;command.me&quot;, &quot;me&quot;); },</span>
<a href="#l10.120"></a><span id="l10.120">     usageContext: Ci.imICommand.CMD_CONTEXT_CHAT,</span>
<a href="#l10.121"></a><span id="l10.121" class="difflineminus">-    run: function(aMsg, aConv) {</span>
<a href="#l10.122"></a><span id="l10.122" class="difflineplus">+    run(aMsg, aConv) {</span>
<a href="#l10.123"></a><span id="l10.123">       let params = aMsg.trim();</span>
<a href="#l10.124"></a><span id="l10.124">       if (!params)</span>
<a href="#l10.125"></a><span id="l10.125">         return false;</span>
<a href="#l10.126"></a><span id="l10.126"> </span>
<a href="#l10.127"></a><span id="l10.127">       // XEP-0245: The /me Command.</span>
<a href="#l10.128"></a><span id="l10.128">       // We need to append &quot;/me &quot; in the first four characters of the message</span>
<a href="#l10.129"></a><span id="l10.129">       // body.</span>
<a href="#l10.130"></a><span id="l10.130">       let conv = getConv(aConv);</span>
<a href="#l10.131"></a><span id="l10.131">       conv.sendMsg(&quot;/me &quot; + params);</span>
<a href="#l10.132"></a><span id="l10.132"> </span>
<a href="#l10.133"></a><span id="l10.133">       return true;</span>
<a href="#l10.134"></a><span id="l10.134" class="difflineminus">-    }</span>
<a href="#l10.135"></a><span id="l10.135" class="difflineplus">+    },</span>
<a href="#l10.136"></a><span id="l10.136">   },</span>
<a href="#l10.137"></a><span id="l10.137">   {</span>
<a href="#l10.138"></a><span id="l10.138">     name: &quot;nick&quot;,</span>
<a href="#l10.139"></a><span id="l10.139">     get helpString() { return _(&quot;command.nick&quot;, &quot;nick&quot;); },</span>
<a href="#l10.140"></a><span id="l10.140">     usageContext: Ci.imICommand.CMD_CONTEXT_CHAT,</span>
<a href="#l10.141"></a><span id="l10.141" class="difflineminus">-    run: function(aMsg, aConv) {</span>
<a href="#l10.142"></a><span id="l10.142" class="difflineplus">+    run(aMsg, aConv) {</span>
<a href="#l10.143"></a><span id="l10.143">       let params = aMsg.trim().split(/\s+/);</span>
<a href="#l10.144"></a><span id="l10.144">       if (!params[0])</span>
<a href="#l10.145"></a><span id="l10.145">         return false;</span>
<a href="#l10.146"></a><span id="l10.146"> </span>
<a href="#l10.147"></a><span id="l10.147">       let conv = getMUC(aConv);</span>
<a href="#l10.148"></a><span id="l10.148">       if (conv)</span>
<a href="#l10.149"></a><span id="l10.149">         conv.setNick(params[0]);</span>
<a href="#l10.150"></a><span id="l10.150">       return true;</span>
<a href="#l10.151"></a><span id="l10.151" class="difflineminus">-    }</span>
<a href="#l10.152"></a><span id="l10.152" class="difflineplus">+    },</span>
<a href="#l10.153"></a><span id="l10.153">   },</span>
<a href="#l10.154"></a><span id="l10.154">   {</span>
<a href="#l10.155"></a><span id="l10.155">     name: &quot;msg&quot;,</span>
<a href="#l10.156"></a><span id="l10.156">     get helpString() { return _(&quot;command.msg&quot;, &quot;msg&quot;); },</span>
<a href="#l10.157"></a><span id="l10.157">     usageContext: Ci.imICommand.CMD_CONTEXT_CHAT,</span>
<a href="#l10.158"></a><span id="l10.158" class="difflineminus">-    run: function(aMsg, aConv, aReturnedConv) {</span>
<a href="#l10.159"></a><span id="l10.159" class="difflineplus">+    run(aMsg, aConv, aReturnedConv) {</span>
<a href="#l10.160"></a><span id="l10.160">       let conv = getMUC(aConv);</span>
<a href="#l10.161"></a><span id="l10.161">       if (!conv)</span>
<a href="#l10.162"></a><span id="l10.162">         return true;</span>
<a href="#l10.163"></a><span id="l10.163"> </span>
<a href="#l10.164"></a><span id="l10.164">       let params = splitByNick(aMsg, conv);</span>
<a href="#l10.165"></a><span id="l10.165">       if (params.length != 2)</span>
<a href="#l10.166"></a><span id="l10.166">         return false;</span>
<a href="#l10.167"></a><span id="l10.167">       let [nickName, msg] = params;</span>
<a href="#l10.168"></a><span id="l10.168" class="difflineat">@@ -271,32 +271,32 @@ var commands = [</span>
<a href="#l10.169"></a><span id="l10.169">       let privateConv = account.createConversation(conv.name + &quot;/&quot; + nickName);</span>
<a href="#l10.170"></a><span id="l10.170">       if (!privateConv)</span>
<a href="#l10.171"></a><span id="l10.171">         return true;</span>
<a href="#l10.172"></a><span id="l10.172">       privateConv.sendMsg(msg.trim());</span>
<a href="#l10.173"></a><span id="l10.173"> </span>
<a href="#l10.174"></a><span id="l10.174">       if (aReturnedConv)</span>
<a href="#l10.175"></a><span id="l10.175">         aReturnedConv.value = privateConv;</span>
<a href="#l10.176"></a><span id="l10.176">       return true;</span>
<a href="#l10.177"></a><span id="l10.177" class="difflineminus">-    }</span>
<a href="#l10.178"></a><span id="l10.178" class="difflineplus">+    },</span>
<a href="#l10.179"></a><span id="l10.179">   },</span>
<a href="#l10.180"></a><span id="l10.180">   {</span>
<a href="#l10.181"></a><span id="l10.181">     name: &quot;version&quot;,</span>
<a href="#l10.182"></a><span id="l10.182">     get helpString() { return _(&quot;command.version&quot;, &quot;version&quot;); },</span>
<a href="#l10.183"></a><span id="l10.183">     usageContext: Ci.imICommand.CMD_CONTEXT_IM,</span>
<a href="#l10.184"></a><span id="l10.184" class="difflineminus">-    run: function(aMsg, aConv, aReturnedConv) {</span>
<a href="#l10.185"></a><span id="l10.185" class="difflineplus">+    run(aMsg, aConv, aReturnedConv) {</span>
<a href="#l10.186"></a><span id="l10.186">       let conv = getConv(aConv);</span>
<a href="#l10.187"></a><span id="l10.187">       if (conv.left)</span>
<a href="#l10.188"></a><span id="l10.188">         return true;</span>
<a href="#l10.189"></a><span id="l10.189"> </span>
<a href="#l10.190"></a><span id="l10.190">       // We do not have user's resource.</span>
<a href="#l10.191"></a><span id="l10.191">       if (!conv._targetResource) {</span>
<a href="#l10.192"></a><span id="l10.192">         conv.writeMessage(conv.name,</span>
<a href="#l10.193"></a><span id="l10.193">                           _(&quot;conversation.error.resourceNotAvailable&quot;, conv.shortName),</span>
<a href="#l10.194"></a><span id="l10.194">                           {system: true});</span>
<a href="#l10.195"></a><span id="l10.195">         return true;</span>
<a href="#l10.196"></a><span id="l10.196">       }</span>
<a href="#l10.197"></a><span id="l10.197"> </span>
<a href="#l10.198"></a><span id="l10.198">       conv.getVersion();</span>
<a href="#l10.199"></a><span id="l10.199">       return true;</span>
<a href="#l10.200"></a><span id="l10.200" class="difflineminus">-    }</span>
<a href="#l10.201"></a><span id="l10.201" class="difflineminus">-  }</span>
<a href="#l10.202"></a><span id="l10.202" class="difflineplus">+    },</span>
<a href="#l10.203"></a><span id="l10.203" class="difflineplus">+  },</span>
<a href="#l10.204"></a><span id="l10.204"> ];</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/chat/protocols/xmpp/xmpp-session.jsm</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/chat/protocols/xmpp/xmpp-session.jsm</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -33,17 +33,17 @@ XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, (</span>
<a href="#l11.4"></a><span id="l11.4"> XPCOMUtils.defineLazyGetter(this, &quot;_defaultResource&quot;, () =&gt;</span>
<a href="#l11.5"></a><span id="l11.5">   l10nHelper(&quot;chrome://branding/locale/brand.properties&quot;)(&quot;brandShortName&quot;)</span>
<a href="#l11.6"></a><span id="l11.6"> );</span>
<a href="#l11.7"></a><span id="l11.7"> Object.defineProperty(this, &quot;XMPPDefaultResource&quot;, {</span>
<a href="#l11.8"></a><span id="l11.8">   configurable: true,</span>
<a href="#l11.9"></a><span id="l11.9">   enumerable: true,</span>
<a href="#l11.10"></a><span id="l11.10">   get() {</span>
<a href="#l11.11"></a><span id="l11.11">     return _defaultResource;</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-  }</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+  },</span>
<a href="#l11.14"></a><span id="l11.14"> });</span>
<a href="#l11.15"></a><span id="l11.15"> </span>
<a href="#l11.16"></a><span id="l11.16"> function XMPPSession(aHost, aPort, aSecurity, aJID, aPassword, aAccount) {</span>
<a href="#l11.17"></a><span id="l11.17">   this._host = aHost;</span>
<a href="#l11.18"></a><span id="l11.18">   this._port = aPort;</span>
<a href="#l11.19"></a><span id="l11.19"> </span>
<a href="#l11.20"></a><span id="l11.20">   this._connectionSecurity = aSecurity;</span>
<a href="#l11.21"></a><span id="l11.21">   if (this._connectionSecurity == &quot;old_ssl&quot;)</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineat">@@ -109,17 +109,17 @@ XMPPSession.prototype = {</span>
<a href="#l11.23"></a><span id="l11.23">   /* for the socket.jsm helper */</span>
<a href="#l11.24"></a><span id="l11.24">   __proto__: Socket,</span>
<a href="#l11.25"></a><span id="l11.25">   connectTimeout: 60,</span>
<a href="#l11.26"></a><span id="l11.26">   readWriteTimeout: 300,</span>
<a href="#l11.27"></a><span id="l11.27"> </span>
<a href="#l11.28"></a><span id="l11.28">   // Contains the remaining SRV records if we failed to connect the current one.</span>
<a href="#l11.29"></a><span id="l11.29">   _srvRecords: [],</span>
<a href="#l11.30"></a><span id="l11.30"> </span>
<a href="#l11.31"></a><span id="l11.31" class="difflineminus">-  sendPing: function() {</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineplus">+  sendPing() {</span>
<a href="#l11.33"></a><span id="l11.33">     this.sendStanza(Stanza.iq(&quot;get&quot;, null, null,</span>
<a href="#l11.34"></a><span id="l11.34">                               Stanza.node(&quot;ping&quot;, Stanza.NS.ping)),</span>
<a href="#l11.35"></a><span id="l11.35">                     this.cancelDisconnectTimer, this);</span>
<a href="#l11.36"></a><span id="l11.36">   },</span>
<a href="#l11.37"></a><span id="l11.37">   _lastReceiveTime: 0,</span>
<a href="#l11.38"></a><span id="l11.38">   _lastSendTime: 0,</span>
<a href="#l11.39"></a><span id="l11.39">   checkPingTimer(aJustSentSomething = false) {</span>
<a href="#l11.40"></a><span id="l11.40">     // Don't start a ping timer if we're not fully connected yet.</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineat">@@ -148,17 +148,17 @@ XMPPSession.prototype = {</span>
<a href="#l11.42"></a><span id="l11.42">   _encrypted: false,</span>
<a href="#l11.43"></a><span id="l11.43"> </span>
<a href="#l11.44"></a><span id="l11.44">   // DNS SRV errors in XMPP.</span>
<a href="#l11.45"></a><span id="l11.45">   SRV_ERROR_LOOKUP_FAILED: -1,</span>
<a href="#l11.46"></a><span id="l11.46">   SRV_ERROR_XMPP_NOT_SUPPORTED: -2,</span>
<a href="#l11.47"></a><span id="l11.47"> </span>
<a href="#l11.48"></a><span id="l11.48">   // Handles result of DNS SRV query and saves sorted results if it's OK in _srvRecords,</span>
<a href="#l11.49"></a><span id="l11.49">   // otherwise throws error.</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineminus">-  _handleSrvQuery: function(aResult) {</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineplus">+  _handleSrvQuery(aResult) {</span>
<a href="#l11.52"></a><span id="l11.52">     if (typeof aResult == &quot;number&quot; &amp;&amp; aResult == -1)</span>
<a href="#l11.53"></a><span id="l11.53">       throw this.SRV_ERROR_LOOKUP_FAILED;</span>
<a href="#l11.54"></a><span id="l11.54"> </span>
<a href="#l11.55"></a><span id="l11.55">     this.LOG(&quot;SRV lookup: &quot; + JSON.stringify(aResult));</span>
<a href="#l11.56"></a><span id="l11.56">     if (aResult.length == 0) {</span>
<a href="#l11.57"></a><span id="l11.57">       // RFC 6120 (Section 3.2.1) and RFC 2782 (Usage rules): No SRV records,</span>
<a href="#l11.58"></a><span id="l11.58">       // try to login with the given domain name.</span>
<a href="#l11.59"></a><span id="l11.59">       this.connect(this._host, this._port, this._security);</span>
<a href="#l11.60"></a><span id="l11.60" class="difflineat">@@ -172,198 +172,198 @@ XMPPSession.prototype = {</span>
<a href="#l11.61"></a><span id="l11.61">     aResult.sort(function(a, b) {</span>
<a href="#l11.62"></a><span id="l11.62">       return a.prio - b.prio || b.weight - a.weight;</span>
<a href="#l11.63"></a><span id="l11.63">     });</span>
<a href="#l11.64"></a><span id="l11.64"> </span>
<a href="#l11.65"></a><span id="l11.65">     this._srvRecords = aResult;</span>
<a href="#l11.66"></a><span id="l11.66">     this._connectNextRecord();</span>
<a href="#l11.67"></a><span id="l11.67">   },</span>
<a href="#l11.68"></a><span id="l11.68"> </span>
<a href="#l11.69"></a><span id="l11.69" class="difflineminus">-  _connectNextRecord: function() {</span>
<a href="#l11.70"></a><span id="l11.70" class="difflineplus">+  _connectNextRecord() {</span>
<a href="#l11.71"></a><span id="l11.71">     if (!this._srvRecords.length) {</span>
<a href="#l11.72"></a><span id="l11.72">       this.ERROR(&quot;_connectNextRecord is called and there are no more records &quot; +</span>
<a href="#l11.73"></a><span id="l11.73">                  &quot;to connect.&quot;);</span>
<a href="#l11.74"></a><span id="l11.74">       return;</span>
<a href="#l11.75"></a><span id="l11.75">     }</span>
<a href="#l11.76"></a><span id="l11.76"> </span>
<a href="#l11.77"></a><span id="l11.77">     let record = this._srvRecords.shift();</span>
<a href="#l11.78"></a><span id="l11.78"> </span>
<a href="#l11.79"></a><span id="l11.79">     // RFC 3920 (Section 5.1): Certificates MUST be checked against the</span>
<a href="#l11.80"></a><span id="l11.80">     // hostname as provided by the initiating entity (e.g. user).</span>
<a href="#l11.81"></a><span id="l11.81">     this.connect(this._domain, this._port, this._security, null, record.host,</span>
<a href="#l11.82"></a><span id="l11.82">                  record.port);</span>
<a href="#l11.83"></a><span id="l11.83">   },</span>
<a href="#l11.84"></a><span id="l11.84"> </span>
<a href="#l11.85"></a><span id="l11.85">   /* Disconnect from the server */</span>
<a href="#l11.86"></a><span id="l11.86" class="difflineminus">-  disconnect: function() {</span>
<a href="#l11.87"></a><span id="l11.87" class="difflineplus">+  disconnect() {</span>
<a href="#l11.88"></a><span id="l11.88">     if (this.onXmppStanza == this.stanzaListeners.accountListening)</span>
<a href="#l11.89"></a><span id="l11.89">       this.send(&quot;&lt;/stream:stream&gt;&quot;);</span>
<a href="#l11.90"></a><span id="l11.90">     delete this.onXmppStanza;</span>
<a href="#l11.91"></a><span id="l11.91">     Socket.disconnect.call(this);</span>
<a href="#l11.92"></a><span id="l11.92">     if (this._parser) {</span>
<a href="#l11.93"></a><span id="l11.93">       this._parser.destroy();</span>
<a href="#l11.94"></a><span id="l11.94">       delete this._parser;</span>
<a href="#l11.95"></a><span id="l11.95">     }</span>
<a href="#l11.96"></a><span id="l11.96">     this.cancelDisconnectTimer();</span>
<a href="#l11.97"></a><span id="l11.97">   },</span>
<a href="#l11.98"></a><span id="l11.98"> </span>
<a href="#l11.99"></a><span id="l11.99">   /* Report errors to the account */</span>
<a href="#l11.100"></a><span id="l11.100" class="difflineminus">-  onError: function(aError, aException) {</span>
<a href="#l11.101"></a><span id="l11.101" class="difflineplus">+  onError(aError, aException) {</span>
<a href="#l11.102"></a><span id="l11.102">     // If we're trying to connect to SRV entries, then keep trying until a</span>
<a href="#l11.103"></a><span id="l11.103">     // successful connection occurs or we run out of SRV entries to try.</span>
<a href="#l11.104"></a><span id="l11.104" class="difflineminus">-    if (!!this._srvRecords.length) {</span>
<a href="#l11.105"></a><span id="l11.105" class="difflineplus">+    if (this._srvRecords.length) {</span>
<a href="#l11.106"></a><span id="l11.106">       this._connectNextRecord();</span>
<a href="#l11.107"></a><span id="l11.107">       return;</span>
<a href="#l11.108"></a><span id="l11.108">     }</span>
<a href="#l11.109"></a><span id="l11.109"> </span>
<a href="#l11.110"></a><span id="l11.110">     this._account.onError(aError, aException);</span>
<a href="#l11.111"></a><span id="l11.111">   },</span>
<a href="#l11.112"></a><span id="l11.112"> </span>
<a href="#l11.113"></a><span id="l11.113">   /* Send a text message to the server */</span>
<a href="#l11.114"></a><span id="l11.114" class="difflineminus">-  send: function(aMsg, aLogString) {</span>
<a href="#l11.115"></a><span id="l11.115" class="difflineplus">+  send(aMsg, aLogString) {</span>
<a href="#l11.116"></a><span id="l11.116">     this.sendString(aMsg, &quot;UTF-8&quot;, aLogString);</span>
<a href="#l11.117"></a><span id="l11.117">   },</span>
<a href="#l11.118"></a><span id="l11.118"> </span>
<a href="#l11.119"></a><span id="l11.119">   /* Send a stanza to the server.</span>
<a href="#l11.120"></a><span id="l11.120">    * Can set a callback if required, which will be called when the server</span>
<a href="#l11.121"></a><span id="l11.121">    * responds to the stanza with a stanza of the same id. The callback should</span>
<a href="#l11.122"></a><span id="l11.122">    * return true if the stanza was handled, false if not. Note that an</span>
<a href="#l11.123"></a><span id="l11.123">    * undefined return value is treated as true.</span>
<a href="#l11.124"></a><span id="l11.124">    */</span>
<a href="#l11.125"></a><span id="l11.125" class="difflineminus">-  sendStanza: function(aStanza, aCallback, aThis, aLogString) {</span>
<a href="#l11.126"></a><span id="l11.126" class="difflineplus">+  sendStanza(aStanza, aCallback, aThis, aLogString) {</span>
<a href="#l11.127"></a><span id="l11.127">     if (!aStanza.attributes.hasOwnProperty(&quot;id&quot;))</span>
<a href="#l11.128"></a><span id="l11.128" class="difflineminus">-      aStanza.attributes[&quot;id&quot;] = this._account.generateId();</span>
<a href="#l11.129"></a><span id="l11.129" class="difflineplus">+      aStanza.attributes.id = this._account.generateId();</span>
<a href="#l11.130"></a><span id="l11.130">     if (aCallback)</span>
<a href="#l11.131"></a><span id="l11.131">       this._handlers.set(aStanza.attributes.id, aCallback.bind(aThis));</span>
<a href="#l11.132"></a><span id="l11.132">     this.send(aStanza.getXML(), aLogString);</span>
<a href="#l11.133"></a><span id="l11.133">     this.checkPingTimer(true);</span>
<a href="#l11.134"></a><span id="l11.134">     return aStanza.attributes.id;</span>
<a href="#l11.135"></a><span id="l11.135">   },</span>
<a href="#l11.136"></a><span id="l11.136"> </span>
<a href="#l11.137"></a><span id="l11.137">   /* This method handles callbacks for specific ids. */</span>
<a href="#l11.138"></a><span id="l11.138" class="difflineminus">-  execHandler: function(aId, aStanza) {</span>
<a href="#l11.139"></a><span id="l11.139" class="difflineplus">+  execHandler(aId, aStanza) {</span>
<a href="#l11.140"></a><span id="l11.140">     let handler = this._handlers.get(aId);</span>
<a href="#l11.141"></a><span id="l11.141">     if (!handler)</span>
<a href="#l11.142"></a><span id="l11.142">       return false;</span>
<a href="#l11.143"></a><span id="l11.143">     let isHandled = handler(aStanza);</span>
<a href="#l11.144"></a><span id="l11.144">     // Treat undefined return values as handled.</span>
<a href="#l11.145"></a><span id="l11.145">     if (isHandled === undefined)</span>
<a href="#l11.146"></a><span id="l11.146">       isHandled = true;</span>
<a href="#l11.147"></a><span id="l11.147">     this._handlers.delete(aId);</span>
<a href="#l11.148"></a><span id="l11.148">     return isHandled;</span>
<a href="#l11.149"></a><span id="l11.149">   },</span>
<a href="#l11.150"></a><span id="l11.150"> </span>
<a href="#l11.151"></a><span id="l11.151">   /* Start the XMPP stream */</span>
<a href="#l11.152"></a><span id="l11.152" class="difflineminus">-  startStream: function() {</span>
<a href="#l11.153"></a><span id="l11.153" class="difflineplus">+  startStream() {</span>
<a href="#l11.154"></a><span id="l11.154">     if (this._parser)</span>
<a href="#l11.155"></a><span id="l11.155">       this._parser.destroy();</span>
<a href="#l11.156"></a><span id="l11.156">     this._parser = new XMPPParser(this);</span>
<a href="#l11.157"></a><span id="l11.157">     this.send('&lt;?xml version=&quot;1.0&quot;?&gt;&lt;stream:stream to=&quot;' + this._domain +</span>
<a href="#l11.158"></a><span id="l11.158">               '&quot; xmlns=&quot;jabber:client&quot; xmlns:stream=&quot;http://etherx.jabber.org/streams&quot; version=&quot;1.0&quot;&gt;');</span>
<a href="#l11.159"></a><span id="l11.159">   },</span>
<a href="#l11.160"></a><span id="l11.160"> </span>
<a href="#l11.161"></a><span id="l11.161" class="difflineminus">-  startSession: function() {</span>
<a href="#l11.162"></a><span id="l11.162" class="difflineplus">+  startSession() {</span>
<a href="#l11.163"></a><span id="l11.163">     this.sendStanza(Stanza.iq(&quot;set&quot;, null, null,</span>
<a href="#l11.164"></a><span id="l11.164">                               Stanza.node(&quot;session&quot;, Stanza.NS.session)),</span>
<a href="#l11.165"></a><span id="l11.165" class="difflineminus">-                    (aStanza) =&gt; aStanza.attributes[&quot;type&quot;] == &quot;result&quot;);</span>
<a href="#l11.166"></a><span id="l11.166" class="difflineplus">+                    (aStanza) =&gt; aStanza.attributes.type == &quot;result&quot;);</span>
<a href="#l11.167"></a><span id="l11.167">     this.onXmppStanza = this.stanzaListeners.sessionStarted;</span>
<a href="#l11.168"></a><span id="l11.168">   },</span>
<a href="#l11.169"></a><span id="l11.169"> </span>
<a href="#l11.170"></a><span id="l11.170">   /* XEP-0078: Non-SASL Authentication */</span>
<a href="#l11.171"></a><span id="l11.171" class="difflineminus">-  startLegacyAuth: function() {</span>
<a href="#l11.172"></a><span id="l11.172" class="difflineplus">+  startLegacyAuth() {</span>
<a href="#l11.173"></a><span id="l11.173">     if (!this._encrypted &amp;&amp; this._connectionSecurity == &quot;require_tls&quot;) {</span>
<a href="#l11.174"></a><span id="l11.174">       this.onError(Ci.prplIAccount.ERROR_ENCRYPTION_ERROR,</span>
<a href="#l11.175"></a><span id="l11.175">                    _(&quot;connection.error.startTLSNotSupported&quot;));</span>
<a href="#l11.176"></a><span id="l11.176">       return;</span>
<a href="#l11.177"></a><span id="l11.177">     }</span>
<a href="#l11.178"></a><span id="l11.178"> </span>
<a href="#l11.179"></a><span id="l11.179">     this.onXmppStanza = this.stanzaListeners.legacyAuth;</span>
<a href="#l11.180"></a><span id="l11.180">     let s = Stanza.iq(&quot;get&quot;, null, this._domain,</span>
<a href="#l11.181"></a><span id="l11.181">                       Stanza.node(&quot;query&quot;, Stanza.NS.auth, null,</span>
<a href="#l11.182"></a><span id="l11.182">                                   Stanza.node(&quot;username&quot;, null, null,</span>
<a href="#l11.183"></a><span id="l11.183">                                               this._jid.node)));</span>
<a href="#l11.184"></a><span id="l11.184">     this.sendStanza(s);</span>
<a href="#l11.185"></a><span id="l11.185">   },</span>
<a href="#l11.186"></a><span id="l11.186"> </span>
<a href="#l11.187"></a><span id="l11.187">   // If aResource is null, it will request to bind a server-generated</span>
<a href="#l11.188"></a><span id="l11.188">   // resourcepart, otherwise request to bind a client-submitted resourcepart.</span>
<a href="#l11.189"></a><span id="l11.189" class="difflineminus">-  _requestBind: function(aResource) {</span>
<a href="#l11.190"></a><span id="l11.190" class="difflineplus">+  _requestBind(aResource) {</span>
<a href="#l11.191"></a><span id="l11.191">     let resourceNode =</span>
<a href="#l11.192"></a><span id="l11.192">       aResource ? Stanza.node(&quot;resource&quot;, null, null, aResource) : null;</span>
<a href="#l11.193"></a><span id="l11.193">     this.sendStanza(Stanza.iq(&quot;set&quot;, null, null,</span>
<a href="#l11.194"></a><span id="l11.194">                               Stanza.node(&quot;bind&quot;, Stanza.NS.bind, null,</span>
<a href="#l11.195"></a><span id="l11.195">                                           resourceNode)));</span>
<a href="#l11.196"></a><span id="l11.196">   },</span>
<a href="#l11.197"></a><span id="l11.197"> </span>
<a href="#l11.198"></a><span id="l11.198">   /* Socket events */</span>
<a href="#l11.199"></a><span id="l11.199">   /* The connection is established */</span>
<a href="#l11.200"></a><span id="l11.200" class="difflineminus">-  onConnection: function() {</span>
<a href="#l11.201"></a><span id="l11.201" class="difflineplus">+  onConnection() {</span>
<a href="#l11.202"></a><span id="l11.202">     if (this._security.includes(&quot;ssl&quot;)) {</span>
<a href="#l11.203"></a><span id="l11.203">       this.onXmppStanza = this.stanzaListeners.startAuth;</span>
<a href="#l11.204"></a><span id="l11.204">       this._encrypted = true;</span>
<a href="#l11.205"></a><span id="l11.205">     }</span>
<a href="#l11.206"></a><span id="l11.206">     else</span>
<a href="#l11.207"></a><span id="l11.207">       this.onXmppStanza = this.stanzaListeners.initStream;</span>
<a href="#l11.208"></a><span id="l11.208"> </span>
<a href="#l11.209"></a><span id="l11.209">     // Clear SRV results since we have connected.</span>
<a href="#l11.210"></a><span id="l11.210">     this._srvRecords = [];</span>
<a href="#l11.211"></a><span id="l11.211"> </span>
<a href="#l11.212"></a><span id="l11.212">     this._account.reportConnecting(_(&quot;connection.initializingStream&quot;));</span>
<a href="#l11.213"></a><span id="l11.213">     this.startStream();</span>
<a href="#l11.214"></a><span id="l11.214">   },</span>
<a href="#l11.215"></a><span id="l11.215"> </span>
<a href="#l11.216"></a><span id="l11.216">   /* When incoming data is available to be parsed */</span>
<a href="#l11.217"></a><span id="l11.217" class="difflineminus">-  onDataReceived: function(aData) {</span>
<a href="#l11.218"></a><span id="l11.218" class="difflineplus">+  onDataReceived(aData) {</span>
<a href="#l11.219"></a><span id="l11.219">     this.checkPingTimer();</span>
<a href="#l11.220"></a><span id="l11.220">     let istream = Cc[&quot;@mozilla.org/io/string-input-stream;1&quot;]</span>
<a href="#l11.221"></a><span id="l11.221">                     .createInstance(Ci.nsIStringInputStream);</span>
<a href="#l11.222"></a><span id="l11.222">     istream.setData(aData, aData.length);</span>
<a href="#l11.223"></a><span id="l11.223">     this._lastReceivedData = aData;</span>
<a href="#l11.224"></a><span id="l11.224">     try {</span>
<a href="#l11.225"></a><span id="l11.225">       this._parser.onDataAvailable(istream, 0, aData.length);</span>
<a href="#l11.226"></a><span id="l11.226" class="difflineminus">-    } catch(e) {</span>
<a href="#l11.227"></a><span id="l11.227" class="difflineplus">+    } catch (e) {</span>
<a href="#l11.228"></a><span id="l11.228">       Cu.reportError(e);</span>
<a href="#l11.229"></a><span id="l11.229">       this.onXMLError(&quot;parser-exception&quot;, e);</span>
<a href="#l11.230"></a><span id="l11.230">     }</span>
<a href="#l11.231"></a><span id="l11.231">     delete this._lastReceivedData;</span>
<a href="#l11.232"></a><span id="l11.232">   },</span>
<a href="#l11.233"></a><span id="l11.233"> </span>
<a href="#l11.234"></a><span id="l11.234">   /* The connection got disconnected without us closing it. */</span>
<a href="#l11.235"></a><span id="l11.235" class="difflineminus">-  onConnectionClosed: function() {</span>
<a href="#l11.236"></a><span id="l11.236" class="difflineplus">+  onConnectionClosed() {</span>
<a href="#l11.237"></a><span id="l11.237">     this._networkError(_(&quot;connection.error.serverClosedConnection&quot;));</span>
<a href="#l11.238"></a><span id="l11.238">   },</span>
<a href="#l11.239"></a><span id="l11.239" class="difflineminus">-  onBadCertificate: function(aIsSslError, aNSSErrorMessage) {</span>
<a href="#l11.240"></a><span id="l11.240" class="difflineplus">+  onBadCertificate(aIsSslError, aNSSErrorMessage) {</span>
<a href="#l11.241"></a><span id="l11.241">     let error = this._account.handleBadCertificate(this, aIsSslError);</span>
<a href="#l11.242"></a><span id="l11.242">     this.onError(error, aNSSErrorMessage);</span>
<a href="#l11.243"></a><span id="l11.243">   },</span>
<a href="#l11.244"></a><span id="l11.244" class="difflineminus">-  onConnectionReset: function() {</span>
<a href="#l11.245"></a><span id="l11.245" class="difflineplus">+  onConnectionReset() {</span>
<a href="#l11.246"></a><span id="l11.246">     this._networkError(_(&quot;connection.error.resetByPeer&quot;));</span>
<a href="#l11.247"></a><span id="l11.247">   },</span>
<a href="#l11.248"></a><span id="l11.248" class="difflineminus">-  onConnectionTimedOut: function() {</span>
<a href="#l11.249"></a><span id="l11.249" class="difflineplus">+  onConnectionTimedOut() {</span>
<a href="#l11.250"></a><span id="l11.250">     this._networkError(_(&quot;connection.error.timedOut&quot;));</span>
<a href="#l11.251"></a><span id="l11.251">   },</span>
<a href="#l11.252"></a><span id="l11.252" class="difflineminus">-  _networkError: function(aMessage) {</span>
<a href="#l11.253"></a><span id="l11.253" class="difflineplus">+  _networkError(aMessage) {</span>
<a href="#l11.254"></a><span id="l11.254">     this.onError(Ci.prplIAccount.ERROR_NETWORK_ERROR, aMessage);</span>
<a href="#l11.255"></a><span id="l11.255">   },</span>
<a href="#l11.256"></a><span id="l11.256"> </span>
<a href="#l11.257"></a><span id="l11.257"> </span>
<a href="#l11.258"></a><span id="l11.258">   /* Methods called by the XMPPParser instance */</span>
<a href="#l11.259"></a><span id="l11.259" class="difflineminus">-  onXMLError: function(aError, aException) {</span>
<a href="#l11.260"></a><span id="l11.260" class="difflineplus">+  onXMLError(aError, aException) {</span>
<a href="#l11.261"></a><span id="l11.261">     if (aError == &quot;parsing-characters&quot;)</span>
<a href="#l11.262"></a><span id="l11.262">       this.WARN(aError + &quot;: &quot; + aException + &quot;\n&quot; + this._lastReceivedData);</span>
<a href="#l11.263"></a><span id="l11.263">     else</span>
<a href="#l11.264"></a><span id="l11.264">       this.ERROR(aError + &quot;: &quot; + aException + &quot;\n&quot; + this._lastReceivedData);</span>
<a href="#l11.265"></a><span id="l11.265">     if (aError != &quot;parse-warning&quot; &amp;&amp; aError != &quot;parsing-characters&quot;)</span>
<a href="#l11.266"></a><span id="l11.266">       this._networkError(_(&quot;connection.error.receivedUnexpectedData&quot;));</span>
<a href="#l11.267"></a><span id="l11.267">   },</span>
<a href="#l11.268"></a><span id="l11.268"> </span>
<a href="#l11.269"></a><span id="l11.269">   // All the functions in stanzaListeners are used as onXmppStanza</span>
<a href="#l11.270"></a><span id="l11.270">   // implementations at various steps of establishing the session.</span>
<a href="#l11.271"></a><span id="l11.271">   stanzaListeners: {</span>
<a href="#l11.272"></a><span id="l11.272" class="difflineminus">-    initStream: function(aStanza) {</span>
<a href="#l11.273"></a><span id="l11.273" class="difflineplus">+    initStream(aStanza) {</span>
<a href="#l11.274"></a><span id="l11.274">       if (aStanza.localName != &quot;features&quot;) {</span>
<a href="#l11.275"></a><span id="l11.275">         this.ERROR(&quot;Unexpected stanza &quot; + aStanza.localName + &quot;, expected 'features'&quot;);</span>
<a href="#l11.276"></a><span id="l11.276">         this._networkError(_(&quot;connection.error.incorrectResponse&quot;));</span>
<a href="#l11.277"></a><span id="l11.277">         return;</span>
<a href="#l11.278"></a><span id="l11.278">       }</span>
<a href="#l11.279"></a><span id="l11.279"> </span>
<a href="#l11.280"></a><span id="l11.280">       let starttls = aStanza.getElement([&quot;starttls&quot;]);</span>
<a href="#l11.281"></a><span id="l11.281">       if (starttls &amp;&amp; this._security.includes(&quot;starttls&quot;)) {</span>
<a href="#l11.282"></a><span id="l11.282" class="difflineat">@@ -383,28 +383,28 @@ XMPPSession.prototype = {</span>
<a href="#l11.283"></a><span id="l11.283">                      _(&quot;connection.error.startTLSNotSupported&quot;));</span>
<a href="#l11.284"></a><span id="l11.284">         return;</span>
<a href="#l11.285"></a><span id="l11.285">       }</span>
<a href="#l11.286"></a><span id="l11.286"> </span>
<a href="#l11.287"></a><span id="l11.287">       // If we aren't starting TLS, jump to the auth step.</span>
<a href="#l11.288"></a><span id="l11.288">       this.onXmppStanza = this.stanzaListeners.startAuth;</span>
<a href="#l11.289"></a><span id="l11.289">       this.onXmppStanza(aStanza);</span>
<a href="#l11.290"></a><span id="l11.290">     },</span>
<a href="#l11.291"></a><span id="l11.291" class="difflineminus">-    startTLS: function(aStanza) {</span>
<a href="#l11.292"></a><span id="l11.292" class="difflineplus">+    startTLS(aStanza) {</span>
<a href="#l11.293"></a><span id="l11.293">       if (aStanza.localName != &quot;proceed&quot;) {</span>
<a href="#l11.294"></a><span id="l11.294">         this._networkError(_(&quot;connection.error.failedToStartTLS&quot;));</span>
<a href="#l11.295"></a><span id="l11.295">         return;</span>
<a href="#l11.296"></a><span id="l11.296">       }</span>
<a href="#l11.297"></a><span id="l11.297"> </span>
<a href="#l11.298"></a><span id="l11.298">       this.startTLS();</span>
<a href="#l11.299"></a><span id="l11.299">       this._encrypted = true;</span>
<a href="#l11.300"></a><span id="l11.300">       this.startStream();</span>
<a href="#l11.301"></a><span id="l11.301">       this.onXmppStanza = this.stanzaListeners.startAuth;</span>
<a href="#l11.302"></a><span id="l11.302">     },</span>
<a href="#l11.303"></a><span id="l11.303" class="difflineminus">-    startAuth: function(aStanza) {</span>
<a href="#l11.304"></a><span id="l11.304" class="difflineplus">+    startAuth(aStanza) {</span>
<a href="#l11.305"></a><span id="l11.305">       if (aStanza.localName != &quot;features&quot;) {</span>
<a href="#l11.306"></a><span id="l11.306">         this.ERROR(&quot;Unexpected stanza &quot; + aStanza.localName + &quot;, expected 'features'&quot;);</span>
<a href="#l11.307"></a><span id="l11.307">         this._networkError(_(&quot;connection.error.incorrectResponse&quot;));</span>
<a href="#l11.308"></a><span id="l11.308">         return;</span>
<a href="#l11.309"></a><span id="l11.309">       }</span>
<a href="#l11.310"></a><span id="l11.310"> </span>
<a href="#l11.311"></a><span id="l11.311">       let mechs = aStanza.getElement([&quot;mechanisms&quot;]);</span>
<a href="#l11.312"></a><span id="l11.312">       if (!mechs) {</span>
<a href="#l11.313"></a><span id="l11.313" class="difflineat">@@ -456,32 +456,32 @@ XMPPSession.prototype = {</span>
<a href="#l11.314"></a><span id="l11.314">                                                  this._password,</span>
<a href="#l11.315"></a><span id="l11.315">                                                  this._domain);</span>
<a href="#l11.316"></a><span id="l11.316">       this._password = null;</span>
<a href="#l11.317"></a><span id="l11.317"> </span>
<a href="#l11.318"></a><span id="l11.318">       this._account.reportConnecting(_(&quot;connection.authenticating&quot;));</span>
<a href="#l11.319"></a><span id="l11.319">       this.onXmppStanza = this.stanzaListeners.authDialog.bind(this, authMec);</span>
<a href="#l11.320"></a><span id="l11.320">       this.onXmppStanza(null); // the first auth step doesn't read anything</span>
<a href="#l11.321"></a><span id="l11.321">     },</span>
<a href="#l11.322"></a><span id="l11.322" class="difflineminus">-    authDialog: function(aAuthMec, aStanza) {</span>
<a href="#l11.323"></a><span id="l11.323" class="difflineplus">+    authDialog(aAuthMec, aStanza) {</span>
<a href="#l11.324"></a><span id="l11.324">       if (aStanza &amp;&amp; aStanza.localName == &quot;failure&quot;) {</span>
<a href="#l11.325"></a><span id="l11.325">         let errorMsg = &quot;authenticationFailure&quot;;</span>
<a href="#l11.326"></a><span id="l11.326">         if (aStanza.getElement([&quot;not-authorized&quot;]) ||</span>
<a href="#l11.327"></a><span id="l11.327">             aStanza.getElement([&quot;bad-auth&quot;])) {</span>
<a href="#l11.328"></a><span id="l11.328">           errorMsg = &quot;notAuthorized&quot;;</span>
<a href="#l11.329"></a><span id="l11.329">         }</span>
<a href="#l11.330"></a><span id="l11.330">         this.onError(Ci.prplIAccount.ERROR_AUTHENTICATION_FAILED,</span>
<a href="#l11.331"></a><span id="l11.331">                      _(&quot;connection.error.&quot; + errorMsg));</span>
<a href="#l11.332"></a><span id="l11.332">         return;</span>
<a href="#l11.333"></a><span id="l11.333">       }</span>
<a href="#l11.334"></a><span id="l11.334"> </span>
<a href="#l11.335"></a><span id="l11.335">       let result;</span>
<a href="#l11.336"></a><span id="l11.336">       try {</span>
<a href="#l11.337"></a><span id="l11.337">         result = aAuthMec.next(aStanza);</span>
<a href="#l11.338"></a><span id="l11.338" class="difflineminus">-      } catch(e) {</span>
<a href="#l11.339"></a><span id="l11.339" class="difflineplus">+      } catch (e) {</span>
<a href="#l11.340"></a><span id="l11.340">         this.ERROR(e);</span>
<a href="#l11.341"></a><span id="l11.341">         this.onError(Ci.prplIAccount.ERROR_AUTHENTICATION_FAILED,</span>
<a href="#l11.342"></a><span id="l11.342">                      _(&quot;connection.error.authenticationFailure&quot;));</span>
<a href="#l11.343"></a><span id="l11.343">         return;</span>
<a href="#l11.344"></a><span id="l11.344">       }</span>
<a href="#l11.345"></a><span id="l11.345"> </span>
<a href="#l11.346"></a><span id="l11.346">       // The authentication mechanism can yield a promise which must resolve</span>
<a href="#l11.347"></a><span id="l11.347">       // before sending data.</span>
<a href="#l11.348"></a><span id="l11.348" class="difflineat">@@ -491,29 +491,29 @@ XMPPSession.prototype = {</span>
<a href="#l11.349"></a><span id="l11.349">             this.send(value.send.getXML(), value.log);</span>
<a href="#l11.350"></a><span id="l11.350">         });</span>
<a href="#l11.351"></a><span id="l11.351">       }</span>
<a href="#l11.352"></a><span id="l11.352">       if (result.done) {</span>
<a href="#l11.353"></a><span id="l11.353">         this.startStream();</span>
<a href="#l11.354"></a><span id="l11.354">         this.onXmppStanza = this.stanzaListeners.startBind;</span>
<a href="#l11.355"></a><span id="l11.355">       }</span>
<a href="#l11.356"></a><span id="l11.356">     },</span>
<a href="#l11.357"></a><span id="l11.357" class="difflineminus">-    startBind: function(aStanza) {</span>
<a href="#l11.358"></a><span id="l11.358" class="difflineplus">+    startBind(aStanza) {</span>
<a href="#l11.359"></a><span id="l11.359">       if (!aStanza.getElement([&quot;bind&quot;])) {</span>
<a href="#l11.360"></a><span id="l11.360">         this.ERROR(&quot;Unexpected lack of the bind feature&quot;);</span>
<a href="#l11.361"></a><span id="l11.361">         this._networkError(_(&quot;connection.error.incorrectResponse&quot;));</span>
<a href="#l11.362"></a><span id="l11.362">         return;</span>
<a href="#l11.363"></a><span id="l11.363">       }</span>
<a href="#l11.364"></a><span id="l11.364"> </span>
<a href="#l11.365"></a><span id="l11.365">       this._account.reportConnecting(_(&quot;connection.gettingResource&quot;));</span>
<a href="#l11.366"></a><span id="l11.366">       this._requestBind(this._resource);</span>
<a href="#l11.367"></a><span id="l11.367">       this.onXmppStanza = this.stanzaListeners.bindResult;</span>
<a href="#l11.368"></a><span id="l11.368">     },</span>
<a href="#l11.369"></a><span id="l11.369" class="difflineminus">-    bindResult: function(aStanza) {</span>
<a href="#l11.370"></a><span id="l11.370" class="difflineminus">-      if (aStanza.attributes[&quot;type&quot;] == &quot;error&quot;) {</span>
<a href="#l11.371"></a><span id="l11.371" class="difflineplus">+    bindResult(aStanza) {</span>
<a href="#l11.372"></a><span id="l11.372" class="difflineplus">+      if (aStanza.attributes.type == &quot;error&quot;) {</span>
<a href="#l11.373"></a><span id="l11.373">         let error = this._account.parseError(aStanza);</span>
<a href="#l11.374"></a><span id="l11.374">         let message;</span>
<a href="#l11.375"></a><span id="l11.375">         switch (error.condition) {</span>
<a href="#l11.376"></a><span id="l11.376">           case &quot;resource-constraint&quot;:</span>
<a href="#l11.377"></a><span id="l11.377">             // RFC 6120 (7.6.2.1): Resource Constraint.</span>
<a href="#l11.378"></a><span id="l11.378">             // The account has reached a limit on the number of simultaneous</span>
<a href="#l11.379"></a><span id="l11.379">             // connected resources allowed.</span>
<a href="#l11.380"></a><span id="l11.380">             message = &quot;connection.error.failedMaxResourceLimit&quot;;</span>
<a href="#l11.381"></a><span id="l11.381" class="difflineat">@@ -543,25 +543,25 @@ XMPPSession.prototype = {</span>
<a href="#l11.382"></a><span id="l11.382">         return;</span>
<a href="#l11.383"></a><span id="l11.383">       }</span>
<a href="#l11.384"></a><span id="l11.384">       jid = jid.innerText;</span>
<a href="#l11.385"></a><span id="l11.385">       this.DEBUG(&quot;jid = &quot; + jid);</span>
<a href="#l11.386"></a><span id="l11.386">       this._jid = this._account._parseJID(jid);</span>
<a href="#l11.387"></a><span id="l11.387">       this._resource = this._jid.resource;</span>
<a href="#l11.388"></a><span id="l11.388">       this.startSession();</span>
<a href="#l11.389"></a><span id="l11.389">     },</span>
<a href="#l11.390"></a><span id="l11.390" class="difflineminus">-    legacyAuth: function(aStanza) {</span>
<a href="#l11.391"></a><span id="l11.391" class="difflineminus">-      if (aStanza.attributes[&quot;type&quot;] == &quot;error&quot;) {</span>
<a href="#l11.392"></a><span id="l11.392" class="difflineplus">+    legacyAuth(aStanza) {</span>
<a href="#l11.393"></a><span id="l11.393" class="difflineplus">+      if (aStanza.attributes.type == &quot;error&quot;) {</span>
<a href="#l11.394"></a><span id="l11.394">         let error = aStanza.getElement([&quot;error&quot;]);</span>
<a href="#l11.395"></a><span id="l11.395">         if (!error) {</span>
<a href="#l11.396"></a><span id="l11.396">           this._networkError(_(&quot;connection.error.incorrectResponse&quot;));</span>
<a href="#l11.397"></a><span id="l11.397">           return;</span>
<a href="#l11.398"></a><span id="l11.398">         }</span>
<a href="#l11.399"></a><span id="l11.399"> </span>
<a href="#l11.400"></a><span id="l11.400" class="difflineminus">-        let code = parseInt(error.attributes[&quot;code&quot;], 10);</span>
<a href="#l11.401"></a><span id="l11.401" class="difflineplus">+        let code = parseInt(error.attributes.code, 10);</span>
<a href="#l11.402"></a><span id="l11.402">         if (code == 401) {</span>
<a href="#l11.403"></a><span id="l11.403">           // Failed Authentication (Incorrect Credentials)</span>
<a href="#l11.404"></a><span id="l11.404">           this.onError(Ci.prplIAccount.ERROR_AUTHENTICATION_FAILED,</span>
<a href="#l11.405"></a><span id="l11.405">                        _(&quot;connection.error.notAuthorized&quot;));</span>
<a href="#l11.406"></a><span id="l11.406">           return;</span>
<a href="#l11.407"></a><span id="l11.407">         }</span>
<a href="#l11.408"></a><span id="l11.408">         else if (code == 406) {</span>
<a href="#l11.409"></a><span id="l11.409">           // Failed Authentication (Required Information Not Provided)</span>
<a href="#l11.410"></a><span id="l11.410" class="difflineat">@@ -574,17 +574,17 @@ XMPPSession.prototype = {</span>
<a href="#l11.411"></a><span id="l11.411">           // XXX Flo The spec in XEP-0078 defines this error code, but</span>
<a href="#l11.412"></a><span id="l11.412">           // I've yet to find a server sending it. The server I tested</span>
<a href="#l11.413"></a><span id="l11.413">           // with just closed the first connection when a second</span>
<a href="#l11.414"></a><span id="l11.414">           // connection was attempted with the same resource.</span>
<a href="#l11.415"></a><span id="l11.415">           // libpurple's jabber prpl doesn't support this code either.</span>
<a href="#l11.416"></a><span id="l11.416">         // }</span>
<a href="#l11.417"></a><span id="l11.417">       }</span>
<a href="#l11.418"></a><span id="l11.418"> </span>
<a href="#l11.419"></a><span id="l11.419" class="difflineminus">-      if (aStanza.attributes[&quot;type&quot;] != &quot;result&quot;) {</span>
<a href="#l11.420"></a><span id="l11.420" class="difflineplus">+      if (aStanza.attributes.type != &quot;result&quot;) {</span>
<a href="#l11.421"></a><span id="l11.421">         this._networkError(_(&quot;connection.error.incorrectResponse&quot;));</span>
<a href="#l11.422"></a><span id="l11.422">         return;</span>
<a href="#l11.423"></a><span id="l11.423">       }</span>
<a href="#l11.424"></a><span id="l11.424"> </span>
<a href="#l11.425"></a><span id="l11.425">       if (aStanza.children.length == 0) {</span>
<a href="#l11.426"></a><span id="l11.426">         // Success!</span>
<a href="#l11.427"></a><span id="l11.427">         this._password = null;</span>
<a href="#l11.428"></a><span id="l11.428">         this.startSession();</span>
<a href="#l11.429"></a><span id="l11.429" class="difflineat">@@ -607,17 +607,17 @@ XMPPSession.prototype = {</span>
<a href="#l11.430"></a><span id="l11.430">       if (!this._resource) {</span>
<a href="#l11.431"></a><span id="l11.431">         this._resource = XMPPDefaultResource;</span>
<a href="#l11.432"></a><span id="l11.432">         this._jid =</span>
<a href="#l11.433"></a><span id="l11.433">           this._setJID(this._jid.domain, this._jid.node, this._resource);</span>
<a href="#l11.434"></a><span id="l11.434">       }</span>
<a href="#l11.435"></a><span id="l11.435"> </span>
<a href="#l11.436"></a><span id="l11.436">       let children = [</span>
<a href="#l11.437"></a><span id="l11.437">         Stanza.node(&quot;username&quot;, null, null, this._jid.node),</span>
<a href="#l11.438"></a><span id="l11.438" class="difflineminus">-        Stanza.node(&quot;resource&quot;, null, null, this._resource)</span>
<a href="#l11.439"></a><span id="l11.439" class="difflineplus">+        Stanza.node(&quot;resource&quot;, null, null, this._resource),</span>
<a href="#l11.440"></a><span id="l11.440">       ];</span>
<a href="#l11.441"></a><span id="l11.441"> </span>
<a href="#l11.442"></a><span id="l11.442">       let logString;</span>
<a href="#l11.443"></a><span id="l11.443">       if ((&quot;digest&quot; in values) &amp;&amp; this._streamId) {</span>
<a href="#l11.444"></a><span id="l11.444">         let hashBase = this._streamId + this._password;</span>
<a href="#l11.445"></a><span id="l11.445"> </span>
<a href="#l11.446"></a><span id="l11.446">         let ch =</span>
<a href="#l11.447"></a><span id="l11.447">           Cc[&quot;@mozilla.org/security/hash;1&quot;].createInstance(Ci.nsICryptoHash);</span>
<a href="#l11.448"></a><span id="l11.448" class="difflineat">@@ -651,36 +651,35 @@ XMPPSession.prototype = {</span>
<a href="#l11.449"></a><span id="l11.449">       else {</span>
<a href="#l11.450"></a><span id="l11.450">         this.onError(Ci.prplIAccount.ERROR_AUTHENTICATION_IMPOSSIBLE,</span>
<a href="#l11.451"></a><span id="l11.451">                      _(&quot;connection.error.noCompatibleAuthMec&quot;));</span>
<a href="#l11.452"></a><span id="l11.452">         return;</span>
<a href="#l11.453"></a><span id="l11.453">       }</span>
<a href="#l11.454"></a><span id="l11.454"> </span>
<a href="#l11.455"></a><span id="l11.455">       let s = Stanza.iq(&quot;set&quot;, null, this._domain,</span>
<a href="#l11.456"></a><span id="l11.456">                         Stanza.node(&quot;query&quot;, Stanza.NS.auth, null, children));</span>
<a href="#l11.457"></a><span id="l11.457" class="difflineminus">-      this.sendStanza(s, undefined, undefined,</span>
<a href="#l11.458"></a><span id="l11.458" class="difflineminus">-        '&lt;iq type=&quot;set&quot;.../&gt; (' + logString + ')');</span>
<a href="#l11.459"></a><span id="l11.459" class="difflineplus">+      this.sendStanza(s, undefined, undefined, `&lt;iq type=&quot;set&quot;.../&gt; (${logString})`);</span>
<a href="#l11.460"></a><span id="l11.460">     },</span>
<a href="#l11.461"></a><span id="l11.461" class="difflineminus">-    sessionStarted: function(aStanza) {</span>
<a href="#l11.462"></a><span id="l11.462" class="difflineplus">+    sessionStarted(aStanza) {</span>
<a href="#l11.463"></a><span id="l11.463">       this.resetPingTimer();</span>
<a href="#l11.464"></a><span id="l11.464">       this._account.onConnection();</span>
<a href="#l11.465"></a><span id="l11.465">       this.LOG(&quot;Account successfully connected.&quot;);</span>
<a href="#l11.466"></a><span id="l11.466">       this.onXmppStanza = this.stanzaListeners.accountListening;</span>
<a href="#l11.467"></a><span id="l11.467">     },</span>
<a href="#l11.468"></a><span id="l11.468" class="difflineminus">-    accountListening: function(aStanza) {</span>
<a href="#l11.469"></a><span id="l11.469" class="difflineplus">+    accountListening(aStanza) {</span>
<a href="#l11.470"></a><span id="l11.470">       let id = aStanza.attributes.id;</span>
<a href="#l11.471"></a><span id="l11.471">       if (id &amp;&amp; this.execHandler(id, aStanza))</span>
<a href="#l11.472"></a><span id="l11.472">         return;</span>
<a href="#l11.473"></a><span id="l11.473"> </span>
<a href="#l11.474"></a><span id="l11.474">       this._account.onXmppStanza(aStanza);</span>
<a href="#l11.475"></a><span id="l11.475">       let name = aStanza.qName;</span>
<a href="#l11.476"></a><span id="l11.476">       if (name == &quot;presence&quot;)</span>
<a href="#l11.477"></a><span id="l11.477">         this._account.onPresenceStanza(aStanza);</span>
<a href="#l11.478"></a><span id="l11.478">       else if (name == &quot;message&quot;)</span>
<a href="#l11.479"></a><span id="l11.479">         this._account.onMessageStanza(aStanza);</span>
<a href="#l11.480"></a><span id="l11.480">       else if (name == &quot;iq&quot;)</span>
<a href="#l11.481"></a><span id="l11.481">         this._account.onIQStanza(aStanza);</span>
<a href="#l11.482"></a><span id="l11.482" class="difflineminus">-    }</span>
<a href="#l11.483"></a><span id="l11.483" class="difflineplus">+    },</span>
<a href="#l11.484"></a><span id="l11.484">   },</span>
<a href="#l11.485"></a><span id="l11.485" class="difflineminus">-  onXmppStanza: function(aStanza) {</span>
<a href="#l11.486"></a><span id="l11.486" class="difflineplus">+  onXmppStanza(aStanza) {</span>
<a href="#l11.487"></a><span id="l11.487">     this.ERROR(&quot;should not be reached\n&quot;);</span>
<a href="#l11.488"></a><span id="l11.488" class="difflineminus">-  }</span>
<a href="#l11.489"></a><span id="l11.489" class="difflineplus">+  },</span>
<a href="#l11.490"></a><span id="l11.490"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/chat/protocols/xmpp/xmpp-xml.jsm</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/chat/protocols/xmpp/xmpp-xml.jsm</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -1,50 +1,51 @@</span>
<a href="#l12.4"></a><span id="l12.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l12.5"></a><span id="l12.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l12.6"></a><span id="l12.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l12.7"></a><span id="l12.7"> </span>
<a href="#l12.8"></a><span id="l12.8"> this.EXPORTED_SYMBOLS = [&quot;Stanza&quot;, &quot;XMPPParser&quot;, &quot;SupportedFeatures&quot;];</span>
<a href="#l12.9"></a><span id="l12.9"> </span>
<a href="#l12.10"></a><span id="l12.10" class="difflineplus">+/* eslint-disable key-spacing */</span>
<a href="#l12.11"></a><span id="l12.11"> var NS = {</span>
<a href="#l12.12"></a><span id="l12.12">   xml                       : &quot;http://www.w3.org/XML/1998/namespace&quot;,</span>
<a href="#l12.13"></a><span id="l12.13">   xhtml                     : &quot;http://www.w3.org/1999/xhtml&quot;,</span>
<a href="#l12.14"></a><span id="l12.14">   xhtml_im                  : &quot;http://jabber.org/protocol/xhtml-im&quot;,</span>
<a href="#l12.15"></a><span id="l12.15"> </span>
<a href="#l12.16"></a><span id="l12.16" class="difflineminus">-  //auth</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineplus">+  // auth</span>
<a href="#l12.18"></a><span id="l12.18">   client                    : &quot;jabber:client&quot;,</span>
<a href="#l12.19"></a><span id="l12.19">   streams                   : &quot;http://etherx.jabber.org/streams&quot;,</span>
<a href="#l12.20"></a><span id="l12.20">   stream                    : &quot;urn:ietf:params:xml:ns:xmpp-streams&quot;,</span>
<a href="#l12.21"></a><span id="l12.21">   sasl                      : &quot;urn:ietf:params:xml:ns:xmpp-sasl&quot;,</span>
<a href="#l12.22"></a><span id="l12.22">   tls                       : &quot;urn:ietf:params:xml:ns:xmpp-tls&quot;,</span>
<a href="#l12.23"></a><span id="l12.23">   bind                      : &quot;urn:ietf:params:xml:ns:xmpp-bind&quot;,</span>
<a href="#l12.24"></a><span id="l12.24">   session                   : &quot;urn:ietf:params:xml:ns:xmpp-session&quot;,</span>
<a href="#l12.25"></a><span id="l12.25">   auth                      : &quot;jabber:iq:auth&quot;,</span>
<a href="#l12.26"></a><span id="l12.26">   auth_feature              : &quot;http://jabber.org/features/iq-auth&quot;,</span>
<a href="#l12.27"></a><span id="l12.27">   http_bind                 : &quot;http://jabber.org/protocol/httpbind&quot;,</span>
<a href="#l12.28"></a><span id="l12.28">   http_auth                 : &quot;http://jabber.org/protocol/http-auth&quot;,</span>
<a href="#l12.29"></a><span id="l12.29">   xbosh                     : &quot;urn:xmpp:xbosh&quot;,</span>
<a href="#l12.30"></a><span id="l12.30"> </span>
<a href="#l12.31"></a><span id="l12.31">   &quot;private&quot;                 : &quot;jabber:iq:private&quot;,</span>
<a href="#l12.32"></a><span id="l12.32">   xdata                     : &quot;jabber:x:data&quot;,</span>
<a href="#l12.33"></a><span id="l12.33"> </span>
<a href="#l12.34"></a><span id="l12.34" class="difflineminus">-  //roster</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineplus">+  // roster</span>
<a href="#l12.36"></a><span id="l12.36">   roster                    : &quot;jabber:iq:roster&quot;,</span>
<a href="#l12.37"></a><span id="l12.37">   roster_versioning         : &quot;urn:xmpp:features:rosterver&quot;,</span>
<a href="#l12.38"></a><span id="l12.38">   roster_delimiter          : &quot;roster:delimiter&quot;,</span>
<a href="#l12.39"></a><span id="l12.39"> </span>
<a href="#l12.40"></a><span id="l12.40" class="difflineminus">-  //privacy lists</span>
<a href="#l12.41"></a><span id="l12.41" class="difflineplus">+  // privacy lists</span>
<a href="#l12.42"></a><span id="l12.42">   privacy                   : &quot;jabber:iq:privacy&quot;,</span>
<a href="#l12.43"></a><span id="l12.43"> </span>
<a href="#l12.44"></a><span id="l12.44" class="difflineminus">-  //discovering</span>
<a href="#l12.45"></a><span id="l12.45" class="difflineplus">+  // discovering</span>
<a href="#l12.46"></a><span id="l12.46">   disco_info                : &quot;http://jabber.org/protocol/disco#info&quot;,</span>
<a href="#l12.47"></a><span id="l12.47">   disco_items               : &quot;http://jabber.org/protocol/disco#items&quot;,</span>
<a href="#l12.48"></a><span id="l12.48">   caps                      : &quot;http://jabber.org/protocol/caps&quot;,</span>
<a href="#l12.49"></a><span id="l12.49"> </span>
<a href="#l12.50"></a><span id="l12.50" class="difflineminus">-  //addressing</span>
<a href="#l12.51"></a><span id="l12.51" class="difflineplus">+  // addressing</span>
<a href="#l12.52"></a><span id="l12.52">   address                   : &quot;http://jabber.org/protocol/address&quot;,</span>
<a href="#l12.53"></a><span id="l12.53"> </span>
<a href="#l12.54"></a><span id="l12.54">   muc_user                  : &quot;http://jabber.org/protocol/muc#user&quot;,</span>
<a href="#l12.55"></a><span id="l12.55">   muc_owner                 : &quot;http://jabber.org/protocol/muc#owner&quot;,</span>
<a href="#l12.56"></a><span id="l12.56">   muc_admin                 : &quot;http://jabber.org/protocol/muc#admin&quot;,</span>
<a href="#l12.57"></a><span id="l12.57">   muc_rooms                 : &quot;http://jabber.org/protocol/muc#rooms&quot;,</span>
<a href="#l12.58"></a><span id="l12.58">   conference                : &quot;jabber:x:conference&quot;,</span>
<a href="#l12.59"></a><span id="l12.59">   muc                       : &quot;http://jabber.org/protocol/muc&quot;,</span>
<a href="#l12.60"></a><span id="l12.60" class="difflineat">@@ -70,115 +71,116 @@ var NS = {</span>
<a href="#l12.61"></a><span id="l12.61">   rsm                       : &quot;http://jabber.org/protocol/rsm&quot;,</span>
<a href="#l12.62"></a><span id="l12.62">   last                      : &quot;jabber:iq:last&quot;,</span>
<a href="#l12.63"></a><span id="l12.63">   version                   : &quot;jabber:iq:version&quot;,</span>
<a href="#l12.64"></a><span id="l12.64">   avatar_data               : &quot;urn:xmpp:avatar:data&quot;,</span>
<a href="#l12.65"></a><span id="l12.65">   avatar_data_notify        : &quot;urn:xmpp:avatar:data+notify&quot;,</span>
<a href="#l12.66"></a><span id="l12.66">   avatar_metadata           : &quot;urn:xmpp:avatar:metadata&quot;,</span>
<a href="#l12.67"></a><span id="l12.67">   avatar_metadata_notify    : &quot;urn:xmpp:avatar:metadata+notify&quot;,</span>
<a href="#l12.68"></a><span id="l12.68">   pubsub                    : &quot;http://jabber.org/protocol/pubsub&quot;,</span>
<a href="#l12.69"></a><span id="l12.69" class="difflineminus">-  pubsub_event              : &quot;http://jabber.org/protocol/pubsub#event&quot;</span>
<a href="#l12.70"></a><span id="l12.70" class="difflineplus">+  pubsub_event              : &quot;http://jabber.org/protocol/pubsub#event&quot;,</span>
<a href="#l12.71"></a><span id="l12.71"> };</span>
<a href="#l12.72"></a><span id="l12.72"> </span>
<a href="#l12.73"></a><span id="l12.73"> var TOP_LEVEL_ELEMENTS = {</span>
<a href="#l12.74"></a><span id="l12.74">   &quot;message&quot;             : &quot;jabber:client&quot;,</span>
<a href="#l12.75"></a><span id="l12.75">   &quot;presence&quot;            : &quot;jabber:client&quot;,</span>
<a href="#l12.76"></a><span id="l12.76">   &quot;iq&quot;                  : &quot;jabber:client&quot;,</span>
<a href="#l12.77"></a><span id="l12.77">   &quot;stream:features&quot;     : &quot;http://etherx.jabber.org/streams&quot;,</span>
<a href="#l12.78"></a><span id="l12.78">   &quot;proceed&quot;             : &quot;urn:ietf:params:xml:ns:xmpp-tls&quot;,</span>
<a href="#l12.79"></a><span id="l12.79">   &quot;failure&quot;             : [&quot;urn:ietf:params:xml:ns:xmpp-tls&quot;,</span>
<a href="#l12.80"></a><span id="l12.80">                            &quot;urn:ietf:params:xml:ns:xmpp-sasl&quot;],</span>
<a href="#l12.81"></a><span id="l12.81">   &quot;success&quot;             : &quot;urn:ietf:params:xml:ns:xmpp-sasl&quot;,</span>
<a href="#l12.82"></a><span id="l12.82">   &quot;challenge&quot;           : &quot;urn:ietf:params:xml:ns:xmpp-sasl&quot;,</span>
<a href="#l12.83"></a><span id="l12.83" class="difflineminus">-  &quot;error&quot;               : &quot;urn:ietf:params:xml:ns:xmpp-streams&quot;</span>
<a href="#l12.84"></a><span id="l12.84" class="difflineplus">+  &quot;error&quot;               : &quot;urn:ietf:params:xml:ns:xmpp-streams&quot;,</span>
<a href="#l12.85"></a><span id="l12.85"> };</span>
<a href="#l12.86"></a><span id="l12.86" class="difflineplus">+/* eslint-enable key-spacing */</span>
<a href="#l12.87"></a><span id="l12.87"> </span>
<a href="#l12.88"></a><span id="l12.88"> // Features that we support in XMPP.</span>
<a href="#l12.89"></a><span id="l12.89"> // Don't forget to add your new features here.</span>
<a href="#l12.90"></a><span id="l12.90"> var SupportedFeatures = [</span>
<a href="#l12.91"></a><span id="l12.91">   NS.chatstates,</span>
<a href="#l12.92"></a><span id="l12.92">   NS.conference,</span>
<a href="#l12.93"></a><span id="l12.93">   NS.disco_info,</span>
<a href="#l12.94"></a><span id="l12.94">   NS.last,</span>
<a href="#l12.95"></a><span id="l12.95">   NS.muc,</span>
<a href="#l12.96"></a><span id="l12.96">   NS.ping,</span>
<a href="#l12.97"></a><span id="l12.97">   NS.vcard,</span>
<a href="#l12.98"></a><span id="l12.98" class="difflineminus">-  NS.version</span>
<a href="#l12.99"></a><span id="l12.99" class="difflineplus">+  NS.version,</span>
<a href="#l12.100"></a><span id="l12.100"> ];</span>
<a href="#l12.101"></a><span id="l12.101"> </span>
<a href="#l12.102"></a><span id="l12.102"> /* Stanza Builder */</span>
<a href="#l12.103"></a><span id="l12.103"> var Stanza = {</span>
<a href="#l12.104"></a><span id="l12.104" class="difflineminus">-  NS: NS,</span>
<a href="#l12.105"></a><span id="l12.105" class="difflineplus">+  NS,</span>
<a href="#l12.106"></a><span id="l12.106"> </span>
<a href="#l12.107"></a><span id="l12.107">   /* Create a presence stanza */</span>
<a href="#l12.108"></a><span id="l12.108">   presence: (aAttr, aData) =&gt; Stanza.node(&quot;presence&quot;, null, aAttr, aData),</span>
<a href="#l12.109"></a><span id="l12.109"> </span>
<a href="#l12.110"></a><span id="l12.110">   /* Create a message stanza */</span>
<a href="#l12.111"></a><span id="l12.111" class="difflineminus">-  message: function(aTo, aMsg, aState, aAttr = {}, aData = []) {</span>
<a href="#l12.112"></a><span id="l12.112" class="difflineplus">+  message(aTo, aMsg, aState, aAttr = {}, aData = []) {</span>
<a href="#l12.113"></a><span id="l12.113">     aAttr.to = aTo;</span>
<a href="#l12.114"></a><span id="l12.114">     if (!(&quot;type&quot; in aAttr))</span>
<a href="#l12.115"></a><span id="l12.115">       aAttr.type = &quot;chat&quot;;</span>
<a href="#l12.116"></a><span id="l12.116"> </span>
<a href="#l12.117"></a><span id="l12.117">     if (aMsg)</span>
<a href="#l12.118"></a><span id="l12.118">       aData.push(Stanza.node(&quot;body&quot;, null, null, aMsg));</span>
<a href="#l12.119"></a><span id="l12.119"> </span>
<a href="#l12.120"></a><span id="l12.120">     if (aState)</span>
<a href="#l12.121"></a><span id="l12.121">       aData.push(Stanza.node(aState, Stanza.NS.chatstates));</span>
<a href="#l12.122"></a><span id="l12.122"> </span>
<a href="#l12.123"></a><span id="l12.123">     return Stanza.node(&quot;message&quot;, null, aAttr, aData);</span>
<a href="#l12.124"></a><span id="l12.124">   },</span>
<a href="#l12.125"></a><span id="l12.125"> </span>
<a href="#l12.126"></a><span id="l12.126">   /* Create a iq stanza */</span>
<a href="#l12.127"></a><span id="l12.127" class="difflineminus">-  iq: function(aType, aId, aTo, aData) {</span>
<a href="#l12.128"></a><span id="l12.128" class="difflineplus">+  iq(aType, aId, aTo, aData) {</span>
<a href="#l12.129"></a><span id="l12.129">     let attrs = {type: aType};</span>
<a href="#l12.130"></a><span id="l12.130">     if (aId)</span>
<a href="#l12.131"></a><span id="l12.131">       attrs.id = aId;</span>
<a href="#l12.132"></a><span id="l12.132">     if (aTo)</span>
<a href="#l12.133"></a><span id="l12.133">       attrs.to = aTo;</span>
<a href="#l12.134"></a><span id="l12.134">     return this.node(&quot;iq&quot;, null, attrs, aData);</span>
<a href="#l12.135"></a><span id="l12.135">   },</span>
<a href="#l12.136"></a><span id="l12.136"> </span>
<a href="#l12.137"></a><span id="l12.137">   /* Create a XML node */</span>
<a href="#l12.138"></a><span id="l12.138" class="difflineminus">-  node: function(aName, aNs, aAttr, aData) {</span>
<a href="#l12.139"></a><span id="l12.139" class="difflineplus">+  node(aName, aNs, aAttr, aData) {</span>
<a href="#l12.140"></a><span id="l12.140">     let node = new XMLNode(null, aNs, aName, aName, aAttr);</span>
<a href="#l12.141"></a><span id="l12.141">     if (aData) {</span>
<a href="#l12.142"></a><span id="l12.142">       if (!Array.isArray(aData))</span>
<a href="#l12.143"></a><span id="l12.143">         aData = [aData];</span>
<a href="#l12.144"></a><span id="l12.144">       for (let child of aData)</span>
<a href="#l12.145"></a><span id="l12.145">         node[typeof(child) == &quot;string&quot; ? &quot;addText&quot; : &quot;addChild&quot;](child);</span>
<a href="#l12.146"></a><span id="l12.146">     }</span>
<a href="#l12.147"></a><span id="l12.147"> </span>
<a href="#l12.148"></a><span id="l12.148">     return node;</span>
<a href="#l12.149"></a><span id="l12.149" class="difflineminus">-  }</span>
<a href="#l12.150"></a><span id="l12.150" class="difflineplus">+  },</span>
<a href="#l12.151"></a><span id="l12.151"> };</span>
<a href="#l12.152"></a><span id="l12.152"> </span>
<a href="#l12.153"></a><span id="l12.153"> /* Text node</span>
<a href="#l12.154"></a><span id="l12.154">  * Contains a text */</span>
<a href="#l12.155"></a><span id="l12.155"> function TextNode(aText) {</span>
<a href="#l12.156"></a><span id="l12.156">   this.text = aText;</span>
<a href="#l12.157"></a><span id="l12.157"> }</span>
<a href="#l12.158"></a><span id="l12.158"> TextNode.prototype = {</span>
<a href="#l12.159"></a><span id="l12.159">   get type() { return &quot;text&quot;; },</span>
<a href="#l12.160"></a><span id="l12.160"> </span>
<a href="#l12.161"></a><span id="l12.161" class="difflineminus">-  append: function(aText) {</span>
<a href="#l12.162"></a><span id="l12.162" class="difflineplus">+  append(aText) {</span>
<a href="#l12.163"></a><span id="l12.163">     this.text += aText;</span>
<a href="#l12.164"></a><span id="l12.164">   },</span>
<a href="#l12.165"></a><span id="l12.165"> </span>
<a href="#l12.166"></a><span id="l12.166">   /* For debug purposes, returns an indented (unencoded) string */</span>
<a href="#l12.167"></a><span id="l12.167" class="difflineminus">-  convertToString: function(aIndent) { return aIndent + this.text + &quot;\n&quot;; },</span>
<a href="#l12.168"></a><span id="l12.168" class="difflineplus">+  convertToString(aIndent) { return aIndent + this.text + &quot;\n&quot;; },</span>
<a href="#l12.169"></a><span id="l12.169"> </span>
<a href="#l12.170"></a><span id="l12.170">   /* Returns the encoded XML */</span>
<a href="#l12.171"></a><span id="l12.171" class="difflineminus">-  getXML: function() {</span>
<a href="#l12.172"></a><span id="l12.172" class="difflineplus">+  getXML() {</span>
<a href="#l12.173"></a><span id="l12.173">     return Cc[&quot;@mozilla.org/txttohtmlconv;1&quot;]</span>
<a href="#l12.174"></a><span id="l12.174">            .getService(Ci.mozITXTToHTMLConv)</span>
<a href="#l12.175"></a><span id="l12.175">            .scanTXT(this.text, Ci.mozITXTToHTMLConv.kEntities);</span>
<a href="#l12.176"></a><span id="l12.176">   },</span>
<a href="#l12.177"></a><span id="l12.177"> </span>
<a href="#l12.178"></a><span id="l12.178">   /* To read the unencoded data. */</span>
<a href="#l12.179"></a><span id="l12.179" class="difflineminus">-  get innerText() { return this.text; }</span>
<a href="#l12.180"></a><span id="l12.180" class="difflineplus">+  get innerText() { return this.text; },</span>
<a href="#l12.181"></a><span id="l12.181"> };</span>
<a href="#l12.182"></a><span id="l12.182"> </span>
<a href="#l12.183"></a><span id="l12.183"> /* XML node */</span>
<a href="#l12.184"></a><span id="l12.184"> /* https://www.w3.org/TR/2008/REC-xml-20081126 */</span>
<a href="#l12.185"></a><span id="l12.185"> /* aUri is the namespace. */</span>
<a href="#l12.186"></a><span id="l12.186"> /* aLocalName must have value, otherwise throws. */</span>
<a href="#l12.187"></a><span id="l12.187"> /* aAttr can be instance of nsISAXAttributes or object */</span>
<a href="#l12.188"></a><span id="l12.188"> /* Example: &lt;f:a xmlns:f='g' d='1'&gt; is parsed to</span>
<a href="#l12.189"></a><span id="l12.189" class="difflineat">@@ -206,38 +208,38 @@ function XMLNode(aParentNode, aUri, aLoc</span>
<a href="#l12.190"></a><span id="l12.190">         this.attributes[attributeName] = aAttr[attributeName];</span>
<a href="#l12.191"></a><span id="l12.191">     }</span>
<a href="#l12.192"></a><span id="l12.192">   }</span>
<a href="#l12.193"></a><span id="l12.193"> }</span>
<a href="#l12.194"></a><span id="l12.194"> XMLNode.prototype = {</span>
<a href="#l12.195"></a><span id="l12.195">   get type() { return &quot;node&quot;; },</span>
<a href="#l12.196"></a><span id="l12.196"> </span>
<a href="#l12.197"></a><span id="l12.197">   /* Add a new child node */</span>
<a href="#l12.198"></a><span id="l12.198" class="difflineminus">-  addChild: function(aNode) {</span>
<a href="#l12.199"></a><span id="l12.199" class="difflineplus">+  addChild(aNode) {</span>
<a href="#l12.200"></a><span id="l12.200">     this.children.push(aNode);</span>
<a href="#l12.201"></a><span id="l12.201">   },</span>
<a href="#l12.202"></a><span id="l12.202"> </span>
<a href="#l12.203"></a><span id="l12.203">   /* Add text node */</span>
<a href="#l12.204"></a><span id="l12.204" class="difflineminus">-  addText: function(aText) {</span>
<a href="#l12.205"></a><span id="l12.205" class="difflineplus">+  addText(aText) {</span>
<a href="#l12.206"></a><span id="l12.206">     let lastIndex = this.children.length - 1;</span>
<a href="#l12.207"></a><span id="l12.207">     if (lastIndex &gt;= 0 &amp;&amp; this.children[lastIndex] instanceof TextNode)</span>
<a href="#l12.208"></a><span id="l12.208">       this.children[lastIndex].append(aText);</span>
<a href="#l12.209"></a><span id="l12.209">     else</span>
<a href="#l12.210"></a><span id="l12.210">       this.children.push(new TextNode(aText));</span>
<a href="#l12.211"></a><span id="l12.211">   },</span>
<a href="#l12.212"></a><span id="l12.212"> </span>
<a href="#l12.213"></a><span id="l12.213">   /* Get child elements by namespace */</span>
<a href="#l12.214"></a><span id="l12.214" class="difflineminus">-  getChildrenByNS: function(aNS) {</span>
<a href="#l12.215"></a><span id="l12.215" class="difflineplus">+  getChildrenByNS(aNS) {</span>
<a href="#l12.216"></a><span id="l12.216">     return this.children.filter(c =&gt; c.uri == aNS);</span>
<a href="#l12.217"></a><span id="l12.217">   },</span>
<a href="#l12.218"></a><span id="l12.218"> </span>
<a href="#l12.219"></a><span id="l12.219">   /* Get the first element anywhere inside the node (including child nodes)</span>
<a href="#l12.220"></a><span id="l12.220">      that matches the query.</span>
<a href="#l12.221"></a><span id="l12.221">      A query consists of an array of localNames. */</span>
<a href="#l12.222"></a><span id="l12.222" class="difflineminus">-  getElement: function(aQuery) {</span>
<a href="#l12.223"></a><span id="l12.223" class="difflineplus">+  getElement(aQuery) {</span>
<a href="#l12.224"></a><span id="l12.224">     if (aQuery.length == 0)</span>
<a href="#l12.225"></a><span id="l12.225">       return this;</span>
<a href="#l12.226"></a><span id="l12.226"> </span>
<a href="#l12.227"></a><span id="l12.227">     let nq = aQuery.slice(1);</span>
<a href="#l12.228"></a><span id="l12.228">     for (let child of this.children) {</span>
<a href="#l12.229"></a><span id="l12.229">       if (child.type == &quot;text&quot; || child.localName != aQuery[0])</span>
<a href="#l12.230"></a><span id="l12.230">         continue;</span>
<a href="#l12.231"></a><span id="l12.231">       let n = child.getElement(nq);</span>
<a href="#l12.232"></a><span id="l12.232" class="difflineat">@@ -245,86 +247,86 @@ XMLNode.prototype = {</span>
<a href="#l12.233"></a><span id="l12.233">         return n;</span>
<a href="#l12.234"></a><span id="l12.234">     }</span>
<a href="#l12.235"></a><span id="l12.235"> </span>
<a href="#l12.236"></a><span id="l12.236">     return null;</span>
<a href="#l12.237"></a><span id="l12.237">   },</span>
<a href="#l12.238"></a><span id="l12.238"> </span>
<a href="#l12.239"></a><span id="l12.239">   /* Get all elements of the node (including child nodes) that match the query.</span>
<a href="#l12.240"></a><span id="l12.240">      A query consists of an array of localNames. */</span>
<a href="#l12.241"></a><span id="l12.241" class="difflineminus">-  getElements: function(aQuery) {</span>
<a href="#l12.242"></a><span id="l12.242" class="difflineplus">+  getElements(aQuery) {</span>
<a href="#l12.243"></a><span id="l12.243">     if (aQuery.length == 0)</span>
<a href="#l12.244"></a><span id="l12.244">       return [this];</span>
<a href="#l12.245"></a><span id="l12.245"> </span>
<a href="#l12.246"></a><span id="l12.246">     let c = this.getChildren(aQuery[0]);</span>
<a href="#l12.247"></a><span id="l12.247">     let nq = aQuery.slice(1);</span>
<a href="#l12.248"></a><span id="l12.248">     let res = [];</span>
<a href="#l12.249"></a><span id="l12.249">     for (let child of c) {</span>
<a href="#l12.250"></a><span id="l12.250">       let n = child.getElements(nq);</span>
<a href="#l12.251"></a><span id="l12.251">       res = res.concat(n);</span>
<a href="#l12.252"></a><span id="l12.252">     }</span>
<a href="#l12.253"></a><span id="l12.253"> </span>
<a href="#l12.254"></a><span id="l12.254">     return res;</span>
<a href="#l12.255"></a><span id="l12.255">   },</span>
<a href="#l12.256"></a><span id="l12.256"> </span>
<a href="#l12.257"></a><span id="l12.257">   /* Get immediate children by the node name */</span>
<a href="#l12.258"></a><span id="l12.258" class="difflineminus">-  getChildren: function(aName) {</span>
<a href="#l12.259"></a><span id="l12.259" class="difflineplus">+  getChildren(aName) {</span>
<a href="#l12.260"></a><span id="l12.260">     return this.children.filter((c) =&gt; (c.type != &quot;text&quot; &amp;&amp; c.localName == aName));</span>
<a href="#l12.261"></a><span id="l12.261">   },</span>
<a href="#l12.262"></a><span id="l12.262"> </span>
<a href="#l12.263"></a><span id="l12.263">   // Test if the node is a stanza and its namespace is valid.</span>
<a href="#l12.264"></a><span id="l12.264" class="difflineminus">-  isXmppStanza: function() {</span>
<a href="#l12.265"></a><span id="l12.265" class="difflineplus">+  isXmppStanza() {</span>
<a href="#l12.266"></a><span id="l12.266">     if (!TOP_LEVEL_ELEMENTS.hasOwnProperty(this.qName))</span>
<a href="#l12.267"></a><span id="l12.267">       return false;</span>
<a href="#l12.268"></a><span id="l12.268">     let ns = TOP_LEVEL_ELEMENTS[this.qName];</span>
<a href="#l12.269"></a><span id="l12.269">     return ns == this.uri || (Array.isArray(ns) &amp;&amp; ns.includes(this.uri));</span>
<a href="#l12.270"></a><span id="l12.270">   },</span>
<a href="#l12.271"></a><span id="l12.271"> </span>
<a href="#l12.272"></a><span id="l12.272">   /* Returns indented XML */</span>
<a href="#l12.273"></a><span id="l12.273" class="difflineminus">-  convertToString: function(aIndent = &quot;&quot;) {</span>
<a href="#l12.274"></a><span id="l12.274" class="difflineplus">+  convertToString(aIndent = &quot;&quot;) {</span>
<a href="#l12.275"></a><span id="l12.275">     let s =</span>
<a href="#l12.276"></a><span id="l12.276">       aIndent + &quot;&lt;&quot; + this.qName + this._getXmlns() + this._getAttributeText();</span>
<a href="#l12.277"></a><span id="l12.277">     let content = &quot;&quot;;</span>
<a href="#l12.278"></a><span id="l12.278">     for (let child of this.children)</span>
<a href="#l12.279"></a><span id="l12.279">       content += child.convertToString(aIndent + &quot; &quot;);</span>
<a href="#l12.280"></a><span id="l12.280">     return s + (content ? &quot;&gt;\n&quot; + content + aIndent + &quot;&lt;/&quot; + this.qName : &quot;/&quot;) + &quot;&gt;\n&quot;;</span>
<a href="#l12.281"></a><span id="l12.281">   },</span>
<a href="#l12.282"></a><span id="l12.282"> </span>
<a href="#l12.283"></a><span id="l12.283">   /* Returns the XML */</span>
<a href="#l12.284"></a><span id="l12.284" class="difflineminus">-  getXML: function() {</span>
<a href="#l12.285"></a><span id="l12.285" class="difflineplus">+  getXML() {</span>
<a href="#l12.286"></a><span id="l12.286">     let s = &quot;&lt;&quot; + this.qName + this._getXmlns() + this._getAttributeText();</span>
<a href="#l12.287"></a><span id="l12.287">     let innerXML = this.innerXML;</span>
<a href="#l12.288"></a><span id="l12.288">     return s + (innerXML ? &quot;&gt;&quot; + innerXML + &quot;&lt;/&quot; + this.qName : &quot;/&quot;) + &quot;&gt;&quot;;</span>
<a href="#l12.289"></a><span id="l12.289">   },</span>
<a href="#l12.290"></a><span id="l12.290"> </span>
<a href="#l12.291"></a><span id="l12.291">   get innerXML() { return this.children.map(c =&gt; c.getXML()).join(&quot;&quot;); },</span>
<a href="#l12.292"></a><span id="l12.292">   get innerText() { return this.children.map(c =&gt; c.innerText).join(&quot;&quot;); },</span>
<a href="#l12.293"></a><span id="l12.293"> </span>
<a href="#l12.294"></a><span id="l12.294">   /* Private methods */</span>
<a href="#l12.295"></a><span id="l12.295" class="difflineminus">-  _getXmlns: function() { return this.uri ? &quot; xmlns=\&quot;&quot; + this.uri + &quot;\&quot;&quot; : &quot;&quot;; },</span>
<a href="#l12.296"></a><span id="l12.296" class="difflineminus">-  _getAttributeText: function() {</span>
<a href="#l12.297"></a><span id="l12.297" class="difflineplus">+  _getXmlns() { return this.uri ? &quot; xmlns=\&quot;&quot; + this.uri + &quot;\&quot;&quot; : &quot;&quot;; },</span>
<a href="#l12.298"></a><span id="l12.298" class="difflineplus">+  _getAttributeText() {</span>
<a href="#l12.299"></a><span id="l12.299">     let s = &quot;&quot;;</span>
<a href="#l12.300"></a><span id="l12.300">     for (let name in this.attributes)</span>
<a href="#l12.301"></a><span id="l12.301" class="difflineminus">-      s += &quot; &quot; +name + &quot;=\&quot;&quot; + this.attributes[name] + &quot;\&quot;&quot;;</span>
<a href="#l12.302"></a><span id="l12.302" class="difflineplus">+      s += &quot; &quot; + name + &quot;=\&quot;&quot; + this.attributes[name] + &quot;\&quot;&quot;;</span>
<a href="#l12.303"></a><span id="l12.303">     return s;</span>
<a href="#l12.304"></a><span id="l12.304" class="difflineminus">-  }</span>
<a href="#l12.305"></a><span id="l12.305" class="difflineplus">+  },</span>
<a href="#l12.306"></a><span id="l12.306"> };</span>
<a href="#l12.307"></a><span id="l12.307"> </span>
<a href="#l12.308"></a><span id="l12.308"> function XMPPParser(aListener) {</span>
<a href="#l12.309"></a><span id="l12.309">   this._parser = Cc[&quot;@mozilla.org/saxparser/xmlreader;1&quot;]</span>
<a href="#l12.310"></a><span id="l12.310">                    .createInstance(Ci.nsISAXXMLReader);</span>
<a href="#l12.311"></a><span id="l12.311">   this._parser.contentHandler = this;</span>
<a href="#l12.312"></a><span id="l12.312">   this._parser.errorHandler = this;</span>
<a href="#l12.313"></a><span id="l12.313">   this._parser.parseAsync(null);</span>
<a href="#l12.314"></a><span id="l12.314">   this._listener = aListener;</span>
<a href="#l12.315"></a><span id="l12.315">   this._parser.onStartRequest(this._dummyRequest, null);</span>
<a href="#l12.316"></a><span id="l12.316"> }</span>
<a href="#l12.317"></a><span id="l12.317"> XMPPParser.prototype = {</span>
<a href="#l12.318"></a><span id="l12.318">   _destroyPending: false,</span>
<a href="#l12.319"></a><span id="l12.319" class="difflineminus">-  destroy: function() {</span>
<a href="#l12.320"></a><span id="l12.320" class="difflineplus">+  destroy() {</span>
<a href="#l12.321"></a><span id="l12.321">     // Avoid reference cycles</span>
<a href="#l12.322"></a><span id="l12.322">     this._parser.contentHandler = null;</span>
<a href="#l12.323"></a><span id="l12.323">     delete this._listener;</span>
<a href="#l12.324"></a><span id="l12.324">     // Calling onStopRequest while we are in an onDataAvailable</span>
<a href="#l12.325"></a><span id="l12.325">     // callback crashes, don't do it.</span>
<a href="#l12.326"></a><span id="l12.326">     if (this._inOnDataAvailable) {</span>
<a href="#l12.327"></a><span id="l12.327">       this._destroyPending = true;</span>
<a href="#l12.328"></a><span id="l12.328">       return;</span>
<a href="#l12.329"></a><span id="l12.329" class="difflineat">@@ -332,81 +334,81 @@ XMPPParser.prototype = {</span>
<a href="#l12.330"></a><span id="l12.330">     this._parser.onStopRequest(this._dummyRequest, null, Cr.NS_OK);</span>
<a href="#l12.331"></a><span id="l12.331">     // Stopping the request causes parse errors (because we parsed</span>
<a href="#l12.332"></a><span id="l12.332">     // only partial XML documents?), so the error handler is still</span>
<a href="#l12.333"></a><span id="l12.333">     // needed to avoid the errors being reported to the error console.</span>
<a href="#l12.334"></a><span id="l12.334">     this._parser.errorHandler = null;</span>
<a href="#l12.335"></a><span id="l12.335">     delete this._parser;</span>
<a href="#l12.336"></a><span id="l12.336">   },</span>
<a href="#l12.337"></a><span id="l12.337">   _dummyRequest: {</span>
<a href="#l12.338"></a><span id="l12.338" class="difflineminus">-    cancel: function() { },</span>
<a href="#l12.339"></a><span id="l12.339" class="difflineminus">-    isPending: function() { },</span>
<a href="#l12.340"></a><span id="l12.340" class="difflineminus">-    resume: function() { },</span>
<a href="#l12.341"></a><span id="l12.341" class="difflineminus">-    suspend: function() { }</span>
<a href="#l12.342"></a><span id="l12.342" class="difflineplus">+    cancel() { },</span>
<a href="#l12.343"></a><span id="l12.343" class="difflineplus">+    isPending() { },</span>
<a href="#l12.344"></a><span id="l12.344" class="difflineplus">+    resume() { },</span>
<a href="#l12.345"></a><span id="l12.345" class="difflineplus">+    suspend() { },</span>
<a href="#l12.346"></a><span id="l12.346">   },</span>
<a href="#l12.347"></a><span id="l12.347"> </span>
<a href="#l12.348"></a><span id="l12.348" class="difflineminus">-  _logReceivedData: function(aData) {</span>
<a href="#l12.349"></a><span id="l12.349" class="difflineplus">+  _logReceivedData(aData) {</span>
<a href="#l12.350"></a><span id="l12.350">     this._listener.LOG(&quot;received:\n&quot; + aData);</span>
<a href="#l12.351"></a><span id="l12.351">   },</span>
<a href="#l12.352"></a><span id="l12.352">   _inOnDataAvailable: false,</span>
<a href="#l12.353"></a><span id="l12.353" class="difflineminus">-  onDataAvailable: function(aInputStream, aOffset, aCount) {</span>
<a href="#l12.354"></a><span id="l12.354" class="difflineplus">+  onDataAvailable(aInputStream, aOffset, aCount) {</span>
<a href="#l12.355"></a><span id="l12.355">     this._inOnDataAvailable = true;</span>
<a href="#l12.356"></a><span id="l12.356">     this._parser.onDataAvailable(this._dummyRequest, null,</span>
<a href="#l12.357"></a><span id="l12.357">                                  aInputStream, aOffset, aCount);</span>
<a href="#l12.358"></a><span id="l12.358">     delete this._inOnDataAvailable;</span>
<a href="#l12.359"></a><span id="l12.359">     if (this._destroyPending)</span>
<a href="#l12.360"></a><span id="l12.360">       this.destroy();</span>
<a href="#l12.361"></a><span id="l12.361">   },</span>
<a href="#l12.362"></a><span id="l12.362"> </span>
<a href="#l12.363"></a><span id="l12.363">   /* nsISAXContentHandler implementation */</span>
<a href="#l12.364"></a><span id="l12.364" class="difflineminus">-  startDocument: function() { },</span>
<a href="#l12.365"></a><span id="l12.365" class="difflineminus">-  endDocument: function() { },</span>
<a href="#l12.366"></a><span id="l12.366" class="difflineplus">+  startDocument() { },</span>
<a href="#l12.367"></a><span id="l12.367" class="difflineplus">+  endDocument() { },</span>
<a href="#l12.368"></a><span id="l12.368"> </span>
<a href="#l12.369"></a><span id="l12.369" class="difflineminus">-  startElement: function(aUri, aLocalName, aQName, aAttributes) {</span>
<a href="#l12.370"></a><span id="l12.370" class="difflineplus">+  startElement(aUri, aLocalName, aQName, aAttributes) {</span>
<a href="#l12.371"></a><span id="l12.371">     if (aQName == &quot;stream:stream&quot;) {</span>
<a href="#l12.372"></a><span id="l12.372">       let node = new XMLNode(null, aUri, aLocalName, aQName, aAttributes);</span>
<a href="#l12.373"></a><span id="l12.373">       // The node we created doesn't have children, but</span>
<a href="#l12.374"></a><span id="l12.374">       // &lt;stream:stream&gt; isn't closed, so avoid displaying /&gt; at the end.</span>
<a href="#l12.375"></a><span id="l12.375">       this._logReceivedData(node.convertToString().slice(0, -3) + &quot;&gt;\n&quot;);</span>
<a href="#l12.376"></a><span id="l12.376"> </span>
<a href="#l12.377"></a><span id="l12.377">       if (&quot;_node&quot; in this) {</span>
<a href="#l12.378"></a><span id="l12.378">         this._listener.onXMLError(&quot;unexpected-stream-start&quot;,</span>
<a href="#l12.379"></a><span id="l12.379">                                   &quot;stream:stream inside an already started stream&quot;);</span>
<a href="#l12.380"></a><span id="l12.380">         return;</span>
<a href="#l12.381"></a><span id="l12.381">       }</span>
<a href="#l12.382"></a><span id="l12.382"> </span>
<a href="#l12.383"></a><span id="l12.383" class="difflineminus">-      this._listener._streamId = node.attributes[&quot;id&quot;];</span>
<a href="#l12.384"></a><span id="l12.384" class="difflineplus">+      this._listener._streamId = node.attributes.id;</span>
<a href="#l12.385"></a><span id="l12.385">       if (!(&quot;version&quot; in node.attributes))</span>
<a href="#l12.386"></a><span id="l12.386">         this._listener.startLegacyAuth();</span>
<a href="#l12.387"></a><span id="l12.387"> </span>
<a href="#l12.388"></a><span id="l12.388">       this._node = null;</span>
<a href="#l12.389"></a><span id="l12.389">       return;</span>
<a href="#l12.390"></a><span id="l12.390">     }</span>
<a href="#l12.391"></a><span id="l12.391"> </span>
<a href="#l12.392"></a><span id="l12.392">     let node = new XMLNode(this._node, aUri, aLocalName, aQName, aAttributes);</span>
<a href="#l12.393"></a><span id="l12.393">     if (this._node)</span>
<a href="#l12.394"></a><span id="l12.394">       this._node.addChild(node);</span>
<a href="#l12.395"></a><span id="l12.395"> </span>
<a href="#l12.396"></a><span id="l12.396">     this._node = node;</span>
<a href="#l12.397"></a><span id="l12.397">   },</span>
<a href="#l12.398"></a><span id="l12.398"> </span>
<a href="#l12.399"></a><span id="l12.399" class="difflineminus">-  characters: function(aCharacters) {</span>
<a href="#l12.400"></a><span id="l12.400" class="difflineplus">+  characters(aCharacters) {</span>
<a href="#l12.401"></a><span id="l12.401">     if (!this._node) {</span>
<a href="#l12.402"></a><span id="l12.402">       // Ignore whitespace received on the stream to keep the connection alive.</span>
<a href="#l12.403"></a><span id="l12.403">       if (aCharacters.trim()) {</span>
<a href="#l12.404"></a><span id="l12.404">         this._listener.onXMLError(&quot;parsing-characters&quot;,</span>
<a href="#l12.405"></a><span id="l12.405">                                   &quot;No parent for characters: &quot; + aCharacters);</span>
<a href="#l12.406"></a><span id="l12.406">       }</span>
<a href="#l12.407"></a><span id="l12.407">       return;</span>
<a href="#l12.408"></a><span id="l12.408">     }</span>
<a href="#l12.409"></a><span id="l12.409"> </span>
<a href="#l12.410"></a><span id="l12.410">     this._node.addText(aCharacters);</span>
<a href="#l12.411"></a><span id="l12.411">   },</span>
<a href="#l12.412"></a><span id="l12.412"> </span>
<a href="#l12.413"></a><span id="l12.413" class="difflineminus">-  endElement: function(aUri, aLocalName, aQName) {</span>
<a href="#l12.414"></a><span id="l12.414" class="difflineplus">+  endElement(aUri, aLocalName, aQName) {</span>
<a href="#l12.415"></a><span id="l12.415">     if (aQName == &quot;stream:stream&quot;) {</span>
<a href="#l12.416"></a><span id="l12.416">       this._logReceivedData(&quot;&lt;/stream:stream&gt;&quot;);</span>
<a href="#l12.417"></a><span id="l12.417">       delete this._node;</span>
<a href="#l12.418"></a><span id="l12.418">       return;</span>
<a href="#l12.419"></a><span id="l12.419">     }</span>
<a href="#l12.420"></a><span id="l12.420"> </span>
<a href="#l12.421"></a><span id="l12.421">     if (!this._node) {</span>
<a href="#l12.422"></a><span id="l12.422">       this._listener.onXMLError(&quot;parsing-node&quot;,</span>
<a href="#l12.423"></a><span id="l12.423" class="difflineat">@@ -430,27 +432,27 @@ XMPPParser.prototype = {</span>
<a href="#l12.424"></a><span id="l12.424">         this._listener.onXMLError(&quot;parsing-node&quot;,</span>
<a href="#l12.425"></a><span id="l12.425">                                   &quot;Root node &quot; + aLocalName + &quot; is not valid.&quot;);</span>
<a href="#l12.426"></a><span id="l12.426">       }</span>
<a href="#l12.427"></a><span id="l12.427">     }</span>
<a href="#l12.428"></a><span id="l12.428"> </span>
<a href="#l12.429"></a><span id="l12.429">     this._node = this._node._parentNode;</span>
<a href="#l12.430"></a><span id="l12.430">   },</span>
<a href="#l12.431"></a><span id="l12.431"> </span>
<a href="#l12.432"></a><span id="l12.432" class="difflineminus">-  processingInstruction: function(aTarget, aData) { },</span>
<a href="#l12.433"></a><span id="l12.433" class="difflineplus">+  processingInstruction(aTarget, aData) { },</span>
<a href="#l12.434"></a><span id="l12.434"> </span>
<a href="#l12.435"></a><span id="l12.435">   /* nsISAXErrorHandler implementation */</span>
<a href="#l12.436"></a><span id="l12.436" class="difflineminus">-  error: function(aError) {</span>
<a href="#l12.437"></a><span id="l12.437" class="difflineplus">+  error(aError) {</span>
<a href="#l12.438"></a><span id="l12.438">     if (this._listener)</span>
<a href="#l12.439"></a><span id="l12.439">       this._listener.onXMLError(&quot;parse-error&quot;, aError);</span>
<a href="#l12.440"></a><span id="l12.440">   },</span>
<a href="#l12.441"></a><span id="l12.441" class="difflineminus">-  fatalError: function(aError) {</span>
<a href="#l12.442"></a><span id="l12.442" class="difflineplus">+  fatalError(aError) {</span>
<a href="#l12.443"></a><span id="l12.443">     if (this._listener)</span>
<a href="#l12.444"></a><span id="l12.444">       this._listener.onXMLError(&quot;parse-fatal-error&quot;, aError);</span>
<a href="#l12.445"></a><span id="l12.445">   },</span>
<a href="#l12.446"></a><span id="l12.446" class="difflineminus">-  ignorableWarning: function(aError) {</span>
<a href="#l12.447"></a><span id="l12.447" class="difflineplus">+  ignorableWarning(aError) {</span>
<a href="#l12.448"></a><span id="l12.448">     if (this._listener)</span>
<a href="#l12.449"></a><span id="l12.449">       this._listener.onXMLError(&quot;parse-warning&quot;, aError);</span>
<a href="#l12.450"></a><span id="l12.450">   },</span>
<a href="#l12.451"></a><span id="l12.451"> </span>
<a href="#l12.452"></a><span id="l12.452">   QueryInterface: ChromeUtils.generateQI([&quot;nsISAXContentHandler&quot;,</span>
<a href="#l12.453"></a><span id="l12.453">                                           &quot;nsISAXErrorHandler&quot;]),</span>
<a href="#l12.454"></a><span id="l12.454"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/chat/protocols/xmpp/xmpp.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/chat/protocols/xmpp/xmpp.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -27,17 +27,18 @@ var {</span>
<a href="#l13.4"></a><span id="l13.4"> } = ChromeUtils.import(&quot;resource:///modules/jsProtoHelper.jsm&quot;);</span>
<a href="#l13.5"></a><span id="l13.5"> var {</span>
<a href="#l13.6"></a><span id="l13.6">   XMPPConversationPrototype,</span>
<a href="#l13.7"></a><span id="l13.7">   XMPPMUCConversationPrototype,</span>
<a href="#l13.8"></a><span id="l13.8">   XMPPAccountBuddyPrototype,</span>
<a href="#l13.9"></a><span id="l13.9">   XMPPAccountPrototype,</span>
<a href="#l13.10"></a><span id="l13.10"> } = ChromeUtils.import(&quot;resource:///modules/xmpp.jsm&quot;);</span>
<a href="#l13.11"></a><span id="l13.11"> var {</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-  XMPPSession, XMPPDefaultResource</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+  XMPPSession,</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineplus">+  XMPPDefaultResource,</span>
<a href="#l13.15"></a><span id="l13.15"> } = ChromeUtils.import(&quot;resource:///modules/xmpp-session.jsm&quot;);</span>
<a href="#l13.16"></a><span id="l13.16"> </span>
<a href="#l13.17"></a><span id="l13.17"> XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l13.18"></a><span id="l13.18">   l10nHelper(&quot;chrome://chat/locale/xmpp.properties&quot;)</span>
<a href="#l13.19"></a><span id="l13.19"> );</span>
<a href="#l13.20"></a><span id="l13.20"> </span>
<a href="#l13.21"></a><span id="l13.21"> function XMPPAccount(aProtoInstance, aImAccount) {</span>
<a href="#l13.22"></a><span id="l13.22">   this._init(aProtoInstance, aImAccount);</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineat">@@ -48,38 +49,38 @@ function XMPPProtocol() {</span>
<a href="#l13.24"></a><span id="l13.24">   ChromeUtils.import(&quot;resource:///modules/xmpp-commands.jsm&quot;, this);</span>
<a href="#l13.25"></a><span id="l13.25">   this.registerCommands();</span>
<a href="#l13.26"></a><span id="l13.26"> }</span>
<a href="#l13.27"></a><span id="l13.27"> XMPPProtocol.prototype = {</span>
<a href="#l13.28"></a><span id="l13.28">   __proto__: GenericProtocolPrototype,</span>
<a href="#l13.29"></a><span id="l13.29">   get normalizedName() { return &quot;jabber&quot;; },</span>
<a href="#l13.30"></a><span id="l13.30">   get name() { return &quot;XMPP&quot;; },</span>
<a href="#l13.31"></a><span id="l13.31">   get iconBaseURI() { return &quot;chrome://prpl-jabber/skin/&quot;; },</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineminus">-  getAccount: function(aImAccount) { return new XMPPAccount(this, aImAccount); },</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineplus">+  getAccount(aImAccount) { return new XMPPAccount(this, aImAccount); },</span>
<a href="#l13.34"></a><span id="l13.34"> </span>
<a href="#l13.35"></a><span id="l13.35">   usernameSplits: [</span>
<a href="#l13.36"></a><span id="l13.36">     {get label() { return _(&quot;options.domain&quot;); }, separator: &quot;@&quot;,</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineminus">-     defaultValue: &quot;jabber.org&quot;, reverse: true}</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineplus">+     defaultValue: &quot;jabber.org&quot;, reverse: true},</span>
<a href="#l13.39"></a><span id="l13.39">   ],</span>
<a href="#l13.40"></a><span id="l13.40"> </span>
<a href="#l13.41"></a><span id="l13.41">   options: {</span>
<a href="#l13.42"></a><span id="l13.42">     resource: {get label() { return _(&quot;options.resource&quot;); }, default: &quot;&quot;},</span>
<a href="#l13.43"></a><span id="l13.43">     priority: {get label() { return _(&quot;options.priority&quot;); }, default: 0},</span>
<a href="#l13.44"></a><span id="l13.44">     connection_security: {</span>
<a href="#l13.45"></a><span id="l13.45">       get label() { return _(&quot;options.connectionSecurity&quot;); },</span>
<a href="#l13.46"></a><span id="l13.46">       listValues: {</span>
<a href="#l13.47"></a><span id="l13.47">         get require_tls() { return _(&quot;options.connectionSecurity.requireEncryption&quot;); },</span>
<a href="#l13.48"></a><span id="l13.48">         get opportunistic_tls() { return _(&quot;options.connectionSecurity.opportunisticTLS&quot;); },</span>
<a href="#l13.49"></a><span id="l13.49">         get allow_unencrypted_plain_auth() { return _(&quot;options.connectionSecurity.allowUnencryptedAuth&quot;); },</span>
<a href="#l13.50"></a><span id="l13.50">         // &quot;old_ssl&quot; and &quot;none&quot; are also supported, but not exposed in the UI.</span>
<a href="#l13.51"></a><span id="l13.51">         // Any unknown value will fallback to the opportunistic_tls behavior.</span>
<a href="#l13.52"></a><span id="l13.52">       },</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineminus">-      default: &quot;require_tls&quot;</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineplus">+      default: &quot;require_tls&quot;,</span>
<a href="#l13.55"></a><span id="l13.55">     },</span>
<a href="#l13.56"></a><span id="l13.56">     server: {get label() { return _(&quot;options.connectServer&quot;); }, default: &quot;&quot;},</span>
<a href="#l13.57"></a><span id="l13.57" class="difflineminus">-    port: {get label() { return _(&quot;options.connectPort&quot;); }, default: 5222}</span>
<a href="#l13.58"></a><span id="l13.58" class="difflineplus">+    port: {get label() { return _(&quot;options.connectPort&quot;); }, default: 5222},</span>
<a href="#l13.59"></a><span id="l13.59">   },</span>
<a href="#l13.60"></a><span id="l13.60">   get chatHasTopic() { return true; },</span>
<a href="#l13.61"></a><span id="l13.61"> </span>
<a href="#l13.62"></a><span id="l13.62" class="difflineminus">-  classID: Components.ID(&quot;{dde786d1-6f59-43d0-9bc8-b505a757fb30}&quot;)</span>
<a href="#l13.63"></a><span id="l13.63" class="difflineplus">+  classID: Components.ID(&quot;{dde786d1-6f59-43d0-9bc8-b505a757fb30}&quot;),</span>
<a href="#l13.64"></a><span id="l13.64"> };</span>
<a href="#l13.65"></a><span id="l13.65"> </span>
<a href="#l13.66"></a><span id="l13.66"> var NSGetFactory = XPCOMUtils.generateNSGetFactory([XMPPProtocol]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/chat/protocols/xmpp/xmpp.jsm</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/chat/protocols/xmpp/xmpp.jsm</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -1,17 +1,17 @@</span>
<a href="#l14.4"></a><span id="l14.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l14.5"></a><span id="l14.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l14.6"></a><span id="l14.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l14.7"></a><span id="l14.7"> </span>
<a href="#l14.8"></a><span id="l14.8"> this.EXPORTED_SYMBOLS = [</span>
<a href="#l14.9"></a><span id="l14.9">   &quot;XMPPConversationPrototype&quot;,</span>
<a href="#l14.10"></a><span id="l14.10">   &quot;XMPPMUCConversationPrototype&quot;,</span>
<a href="#l14.11"></a><span id="l14.11">   &quot;XMPPAccountBuddyPrototype&quot;,</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-  &quot;XMPPAccountPrototype&quot;</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+  &quot;XMPPAccountPrototype&quot;,</span>
<a href="#l14.14"></a><span id="l14.14"> ];</span>
<a href="#l14.15"></a><span id="l14.15"> </span>
<a href="#l14.16"></a><span id="l14.16"> const {Services} = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l14.17"></a><span id="l14.17"> const {Status} = ChromeUtils.import(&quot;resource:///modules/imStatusUtils.jsm&quot;);</span>
<a href="#l14.18"></a><span id="l14.18"> const {</span>
<a href="#l14.19"></a><span id="l14.19">   XPCOMUtils,</span>
<a href="#l14.20"></a><span id="l14.20">   setTimeout,</span>
<a href="#l14.21"></a><span id="l14.21">   clearTimeout,</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineat">@@ -65,57 +65,57 @@ XPCOMUtils.defineLazyGetter(this, &quot;TXTTo</span>
<a href="#l14.23"></a><span id="l14.23"> function parseStatus(aStanza) {</span>
<a href="#l14.24"></a><span id="l14.24">   let statusType = Ci.imIStatusInfo.STATUS_AVAILABLE;</span>
<a href="#l14.25"></a><span id="l14.25">   let show = aStanza.getElement([&quot;show&quot;]);</span>
<a href="#l14.26"></a><span id="l14.26">   if (show) {</span>
<a href="#l14.27"></a><span id="l14.27">     show = show.innerText;</span>
<a href="#l14.28"></a><span id="l14.28">     if (show == &quot;away&quot;)</span>
<a href="#l14.29"></a><span id="l14.29">       statusType = Ci.imIStatusInfo.STATUS_AWAY;</span>
<a href="#l14.30"></a><span id="l14.30">     else if (show == &quot;chat&quot;)</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineminus">-      statusType = Ci.imIStatusInfo.STATUS_AVAILABLE; //FIXME</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineplus">+      statusType = Ci.imIStatusInfo.STATUS_AVAILABLE; // FIXME</span>
<a href="#l14.33"></a><span id="l14.33">     else if (show == &quot;dnd&quot;)</span>
<a href="#l14.34"></a><span id="l14.34">       statusType = Ci.imIStatusInfo.STATUS_UNAVAILABLE;</span>
<a href="#l14.35"></a><span id="l14.35">     else if (show == &quot;xa&quot;)</span>
<a href="#l14.36"></a><span id="l14.36">       statusType = Ci.imIStatusInfo.STATUS_IDLE;</span>
<a href="#l14.37"></a><span id="l14.37">   }</span>
<a href="#l14.38"></a><span id="l14.38"> </span>
<a href="#l14.39"></a><span id="l14.39">   let idleSince = 0;</span>
<a href="#l14.40"></a><span id="l14.40">   let date = _getDelay(aStanza);</span>
<a href="#l14.41"></a><span id="l14.41">   if (date)</span>
<a href="#l14.42"></a><span id="l14.42">     idleSince = date.getTime();</span>
<a href="#l14.43"></a><span id="l14.43"> </span>
<a href="#l14.44"></a><span id="l14.44">   let query = aStanza.getElement([&quot;query&quot;]);</span>
<a href="#l14.45"></a><span id="l14.45">   if (query &amp;&amp; query.uri == Stanza.NS.last) {</span>
<a href="#l14.46"></a><span id="l14.46">     let now = Math.floor(Date.now() / 1000);</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineminus">-    idleSince = now - parseInt(query.attributes[&quot;seconds&quot;], 10);</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineplus">+    idleSince = now - parseInt(query.attributes.seconds, 10);</span>
<a href="#l14.49"></a><span id="l14.49">     statusType = Ci.imIStatusInfo.STATUS_IDLE;</span>
<a href="#l14.50"></a><span id="l14.50">   }</span>
<a href="#l14.51"></a><span id="l14.51"> </span>
<a href="#l14.52"></a><span id="l14.52">   // Mark official Android clients as mobile.</span>
<a href="#l14.53"></a><span id="l14.53">   const kAndroidNodeURI = &quot;http://www.android.com/gtalk/client/caps&quot;;</span>
<a href="#l14.54"></a><span id="l14.54">   if (aStanza.getChildrenByNS(Stanza.NS.caps)</span>
<a href="#l14.55"></a><span id="l14.55">              .some(s =&gt; s.localName == &quot;c&quot; &amp;&amp;</span>
<a href="#l14.56"></a><span id="l14.56" class="difflineminus">-                        s.attributes[&quot;node&quot;] == kAndroidNodeURI))</span>
<a href="#l14.57"></a><span id="l14.57" class="difflineplus">+                        s.attributes.node == kAndroidNodeURI))</span>
<a href="#l14.58"></a><span id="l14.58">     statusType = Ci.imIStatusInfo.STATUS_MOBILE;</span>
<a href="#l14.59"></a><span id="l14.59"> </span>
<a href="#l14.60"></a><span id="l14.60">   let status = aStanza.getElement([&quot;status&quot;]);</span>
<a href="#l14.61"></a><span id="l14.61">   status = status ? status.innerText : &quot;&quot;;</span>
<a href="#l14.62"></a><span id="l14.62"> </span>
<a href="#l14.63"></a><span id="l14.63" class="difflineminus">-  return {statusType: statusType, statusText: status, idleSince: idleSince};</span>
<a href="#l14.64"></a><span id="l14.64" class="difflineminus">-};</span>
<a href="#l14.65"></a><span id="l14.65" class="difflineplus">+  return {statusType, statusText: status, idleSince};</span>
<a href="#l14.66"></a><span id="l14.66" class="difflineplus">+}</span>
<a href="#l14.67"></a><span id="l14.67"> </span>
<a href="#l14.68"></a><span id="l14.68"> // Returns a Date object for the delay value (stamp) in aStanza if it exists,</span>
<a href="#l14.69"></a><span id="l14.69"> // otherwise returns undefined.</span>
<a href="#l14.70"></a><span id="l14.70"> function _getDelay(aStanza) {</span>
<a href="#l14.71"></a><span id="l14.71">   // XEP-0203: Delayed Delivery.</span>
<a href="#l14.72"></a><span id="l14.72">   let date;</span>
<a href="#l14.73"></a><span id="l14.73">   let delay = aStanza.getElement([&quot;delay&quot;]);</span>
<a href="#l14.74"></a><span id="l14.74">   if (delay &amp;&amp; delay.uri == Stanza.NS.delay) {</span>
<a href="#l14.75"></a><span id="l14.75" class="difflineminus">-    if (delay.attributes[&quot;stamp&quot;])</span>
<a href="#l14.76"></a><span id="l14.76" class="difflineminus">-      date = new Date(delay.attributes[&quot;stamp&quot;]);</span>
<a href="#l14.77"></a><span id="l14.77" class="difflineplus">+    if (delay.attributes.stamp)</span>
<a href="#l14.78"></a><span id="l14.78" class="difflineplus">+      date = new Date(delay.attributes.stamp);</span>
<a href="#l14.79"></a><span id="l14.79">   }</span>
<a href="#l14.80"></a><span id="l14.80">   if (date &amp;&amp; isNaN(date.getTime()))</span>
<a href="#l14.81"></a><span id="l14.81">     return undefined;</span>
<a href="#l14.82"></a><span id="l14.82"> </span>
<a href="#l14.83"></a><span id="l14.83">   return date;</span>
<a href="#l14.84"></a><span id="l14.84"> }</span>
<a href="#l14.85"></a><span id="l14.85"> </span>
<a href="#l14.86"></a><span id="l14.86"> // Writes aMsg in aConv as an outgoing message with optional date as the</span>
<a href="#l14.87"></a><span id="l14.87" class="difflineat">@@ -169,17 +169,17 @@ MUCParticipant.prototype = {</span>
<a href="#l14.88"></a><span id="l14.88"> </span>
<a href="#l14.89"></a><span id="l14.89">   statusType: null,</span>
<a href="#l14.90"></a><span id="l14.90">   statusText: null,</span>
<a href="#l14.91"></a><span id="l14.91">   get alias() { return this.name; },</span>
<a href="#l14.92"></a><span id="l14.92"> </span>
<a href="#l14.93"></a><span id="l14.93">   role: 2, // &quot;participant&quot; by default</span>
<a href="#l14.94"></a><span id="l14.94"> </span>
<a href="#l14.95"></a><span id="l14.95">   // Called when a presence stanza is received for this participant.</span>
<a href="#l14.96"></a><span id="l14.96" class="difflineminus">-  onPresenceStanza: function(aStanza) {</span>
<a href="#l14.97"></a><span id="l14.97" class="difflineplus">+  onPresenceStanza(aStanza) {</span>
<a href="#l14.98"></a><span id="l14.98">     let statusInfo = parseStatus(aStanza);</span>
<a href="#l14.99"></a><span id="l14.99">     this.statusType = statusInfo.statusType;</span>
<a href="#l14.100"></a><span id="l14.100">     this.statusText = statusInfo.statusText;</span>
<a href="#l14.101"></a><span id="l14.101"> </span>
<a href="#l14.102"></a><span id="l14.102">     let x = aStanza.children.filter(child =&gt; child.localName == &quot;x&quot; &amp;&amp;</span>
<a href="#l14.103"></a><span id="l14.103">                                              child.uri == Stanza.NS.muc_user);</span>
<a href="#l14.104"></a><span id="l14.104">     if (x.length == 0)</span>
<a href="#l14.105"></a><span id="l14.105">       return;</span>
<a href="#l14.106"></a><span id="l14.106" class="difflineat">@@ -187,87 +187,87 @@ MUCParticipant.prototype = {</span>
<a href="#l14.107"></a><span id="l14.107">     // XEP-0045 (7.2.3): We only expect a single &lt;x/&gt; element of this namespace,</span>
<a href="#l14.108"></a><span id="l14.108">     // so we ignore any others.</span>
<a href="#l14.109"></a><span id="l14.109">     x = x[0];</span>
<a href="#l14.110"></a><span id="l14.110"> </span>
<a href="#l14.111"></a><span id="l14.111">     let item = x.getElement([&quot;item&quot;]);</span>
<a href="#l14.112"></a><span id="l14.112">     if (!item)</span>
<a href="#l14.113"></a><span id="l14.113">       return;</span>
<a href="#l14.114"></a><span id="l14.114"> </span>
<a href="#l14.115"></a><span id="l14.115" class="difflineminus">-    this.role = Math.max(kRoles.indexOf(item.attributes[&quot;role&quot;]),</span>
<a href="#l14.116"></a><span id="l14.116" class="difflineminus">-                         kRoles.indexOf(item.attributes[&quot;affiliation&quot;]));</span>
<a href="#l14.117"></a><span id="l14.117" class="difflineplus">+    this.role = Math.max(kRoles.indexOf(item.attributes.role),</span>
<a href="#l14.118"></a><span id="l14.118" class="difflineplus">+                         kRoles.indexOf(item.attributes.affiliation));</span>
<a href="#l14.119"></a><span id="l14.119"> </span>
<a href="#l14.120"></a><span id="l14.120" class="difflineminus">-    let accountJid = item.attributes[&quot;jid&quot;];</span>
<a href="#l14.121"></a><span id="l14.121" class="difflineplus">+    let accountJid = item.attributes.jid;</span>
<a href="#l14.122"></a><span id="l14.122">     if (accountJid)</span>
<a href="#l14.123"></a><span id="l14.123">       this.accountJid = accountJid;</span>
<a href="#l14.124"></a><span id="l14.124">   },</span>
<a href="#l14.125"></a><span id="l14.125"> </span>
<a href="#l14.126"></a><span id="l14.126">   get noFlags() { return this.role &lt; kRoles.indexOf(&quot;member&quot;); },</span>
<a href="#l14.127"></a><span id="l14.127">   get voiced() { return this.role == kRoles.indexOf(&quot;member&quot;); },</span>
<a href="#l14.128"></a><span id="l14.128">   get halfOp() { return this.role == kRoles.indexOf(&quot;moderator&quot;); },</span>
<a href="#l14.129"></a><span id="l14.129">   get op() { return this.role == kRoles.indexOf(&quot;admin&quot;); },</span>
<a href="#l14.130"></a><span id="l14.130">   get founder() { return this.role == kRoles.indexOf(&quot;owner&quot;); },</span>
<a href="#l14.131"></a><span id="l14.131" class="difflineminus">-  typing: false</span>
<a href="#l14.132"></a><span id="l14.132" class="difflineplus">+  typing: false,</span>
<a href="#l14.133"></a><span id="l14.133"> };</span>
<a href="#l14.134"></a><span id="l14.134"> </span>
<a href="#l14.135"></a><span id="l14.135"> // MUC (Multi-User Chat)</span>
<a href="#l14.136"></a><span id="l14.136"> var XMPPMUCConversationPrototype = {</span>
<a href="#l14.137"></a><span id="l14.137">   __proto__: GenericConvChatPrototype,</span>
<a href="#l14.138"></a><span id="l14.138">   // By default users are not in a MUC.</span>
<a href="#l14.139"></a><span id="l14.139">   _left: true,</span>
<a href="#l14.140"></a><span id="l14.140"> </span>
<a href="#l14.141"></a><span id="l14.141">   // Tracks all received messages to avoid possible duplication if the server</span>
<a href="#l14.142"></a><span id="l14.142">   // sends us the last few messages again when we rejoin a room.</span>
<a href="#l14.143"></a><span id="l14.143">   _messageIds: new Set(),</span>
<a href="#l14.144"></a><span id="l14.144"> </span>
<a href="#l14.145"></a><span id="l14.145" class="difflineminus">-  _init: function(aAccount, aJID, aNick) {</span>
<a href="#l14.146"></a><span id="l14.146" class="difflineplus">+  _init(aAccount, aJID, aNick) {</span>
<a href="#l14.147"></a><span id="l14.147">     this._messageIds = new Set();</span>
<a href="#l14.148"></a><span id="l14.148">     GenericConvChatPrototype._init.call(this, aAccount, aJID, aNick);</span>
<a href="#l14.149"></a><span id="l14.149">   },</span>
<a href="#l14.150"></a><span id="l14.150"> </span>
<a href="#l14.151"></a><span id="l14.151">   _targetResource: &quot;&quot;,</span>
<a href="#l14.152"></a><span id="l14.152"> </span>
<a href="#l14.153"></a><span id="l14.153">   // True while we are rejoining a room previously parted by the user.</span>
<a href="#l14.154"></a><span id="l14.154">   _rejoined: false,</span>
<a href="#l14.155"></a><span id="l14.155"> </span>
<a href="#l14.156"></a><span id="l14.156">   get topic() { return this._topic; },</span>
<a href="#l14.157"></a><span id="l14.157">   set topic(aTopic) {</span>
<a href="#l14.158"></a><span id="l14.158">     // XEP-0045 (8.1): Modifying the room subject.</span>
<a href="#l14.159"></a><span id="l14.159">     let subject = Stanza.node(&quot;subject&quot;, null, null, aTopic.trim());</span>
<a href="#l14.160"></a><span id="l14.160" class="difflineminus">-    let s = Stanza.message(this.name, null, null,{type: &quot;groupchat&quot;}, subject);</span>
<a href="#l14.161"></a><span id="l14.161" class="difflineplus">+    let s = Stanza.message(this.name, null, null, {type: &quot;groupchat&quot;}, subject);</span>
<a href="#l14.162"></a><span id="l14.162">     let notAuthorized = _(&quot;conversation.error.changeTopicFailedNotAuthorized&quot;);</span>
<a href="#l14.163"></a><span id="l14.163">     this._account.sendStanza(s, this._account.handleErrors({</span>
<a href="#l14.164"></a><span id="l14.164">       forbidden: notAuthorized,</span>
<a href="#l14.165"></a><span id="l14.165">       notAcceptable: notAuthorized,</span>
<a href="#l14.166"></a><span id="l14.166" class="difflineminus">-      itemNotFound: notAuthorized</span>
<a href="#l14.167"></a><span id="l14.167" class="difflineplus">+      itemNotFound: notAuthorized,</span>
<a href="#l14.168"></a><span id="l14.168">     }, this));</span>
<a href="#l14.169"></a><span id="l14.169">   },</span>
<a href="#l14.170"></a><span id="l14.170">   get topicSettable() { return true; },</span>
<a href="#l14.171"></a><span id="l14.171"> </span>
<a href="#l14.172"></a><span id="l14.172">   /* Called when the user enters a chat message */</span>
<a href="#l14.173"></a><span id="l14.173" class="difflineminus">-  sendMsg: function (aMsg) {</span>
<a href="#l14.174"></a><span id="l14.174" class="difflineplus">+  sendMsg(aMsg) {</span>
<a href="#l14.175"></a><span id="l14.175">     // XEP-0045 (7.4): Sending a message to all occupants in a room.</span>
<a href="#l14.176"></a><span id="l14.176">     let s = Stanza.message(this.name, aMsg, null, {type: &quot;groupchat&quot;});</span>
<a href="#l14.177"></a><span id="l14.177">     let notInRoom = _(&quot;conversation.error.sendFailedAsNotInRoom&quot;,</span>
<a href="#l14.178"></a><span id="l14.178">                       this.name, aMsg);</span>
<a href="#l14.179"></a><span id="l14.179">     this._account.sendStanza(s, this._account.handleErrors({</span>
<a href="#l14.180"></a><span id="l14.180">       itemNotFound: notInRoom,</span>
<a href="#l14.181"></a><span id="l14.181" class="difflineminus">-      notAcceptable: notInRoom</span>
<a href="#l14.182"></a><span id="l14.182" class="difflineplus">+      notAcceptable: notInRoom,</span>
<a href="#l14.183"></a><span id="l14.183">     }, this));</span>
<a href="#l14.184"></a><span id="l14.184">   },</span>
<a href="#l14.185"></a><span id="l14.185"> </span>
<a href="#l14.186"></a><span id="l14.186">   /* Called by the account when a presence stanza is received for this muc */</span>
<a href="#l14.187"></a><span id="l14.187" class="difflineminus">-  onPresenceStanza: function(aStanza) {</span>
<a href="#l14.188"></a><span id="l14.188" class="difflineminus">-    let from = aStanza.attributes[&quot;from&quot;];</span>
<a href="#l14.189"></a><span id="l14.189" class="difflineplus">+  onPresenceStanza(aStanza) {</span>
<a href="#l14.190"></a><span id="l14.190" class="difflineplus">+    let from = aStanza.attributes.from;</span>
<a href="#l14.191"></a><span id="l14.191">     let nick = this._account._parseJID(from).resource;</span>
<a href="#l14.192"></a><span id="l14.192">     let jid = this._account.normalize(from);</span>
<a href="#l14.193"></a><span id="l14.193">     let x = aStanza.getElements([&quot;x&quot;]).find(e =&gt; e.uri == Stanza.NS.muc_user);</span>
<a href="#l14.194"></a><span id="l14.194"> </span>
<a href="#l14.195"></a><span id="l14.195">     // Check if the join failed.</span>
<a href="#l14.196"></a><span id="l14.196" class="difflineminus">-    if (this.left &amp;&amp; aStanza.attributes[&quot;type&quot;] == &quot;error&quot;) {</span>
<a href="#l14.197"></a><span id="l14.197" class="difflineplus">+    if (this.left &amp;&amp; aStanza.attributes.type == &quot;error&quot;) {</span>
<a href="#l14.198"></a><span id="l14.198">       let error = this._account.parseError(aStanza);</span>
<a href="#l14.199"></a><span id="l14.199">       let message;</span>
<a href="#l14.200"></a><span id="l14.200">       switch (error.condition) {</span>
<a href="#l14.201"></a><span id="l14.201">         case &quot;not-authorized&quot;:</span>
<a href="#l14.202"></a><span id="l14.202">         case &quot;registration-required&quot;:</span>
<a href="#l14.203"></a><span id="l14.203">           // XEP-0045 (7.2.7): Members-Only Rooms.</span>
<a href="#l14.204"></a><span id="l14.204">           message = _(&quot;conversation.error.joinFailedNotAuthorized&quot;);</span>
<a href="#l14.205"></a><span id="l14.205">           break;</span>
<a href="#l14.206"></a><span id="l14.206" class="difflineat">@@ -292,49 +292,49 @@ var XMPPMUCConversationPrototype = {</span>
<a href="#l14.207"></a><span id="l14.207">       return;</span>
<a href="#l14.208"></a><span id="l14.208">     }</span>
<a href="#l14.209"></a><span id="l14.209"> </span>
<a href="#l14.210"></a><span id="l14.210">     if (!x) {</span>
<a href="#l14.211"></a><span id="l14.211">       this.WARN(&quot;Received a MUC presence stanza without an x element or &quot; +</span>
<a href="#l14.212"></a><span id="l14.212">                 &quot;with a namespace we don't handle.&quot;);</span>
<a href="#l14.213"></a><span id="l14.213">       return;</span>
<a href="#l14.214"></a><span id="l14.214">     }</span>
<a href="#l14.215"></a><span id="l14.215" class="difflineminus">-    let codes = x.getElements([&quot;status&quot;]).map(elt =&gt; elt.attributes[&quot;code&quot;]);</span>
<a href="#l14.216"></a><span id="l14.216" class="difflineplus">+    let codes = x.getElements([&quot;status&quot;]).map(elt =&gt; elt.attributes.code);</span>
<a href="#l14.217"></a><span id="l14.217">     let item = x.getElement([&quot;item&quot;]);</span>
<a href="#l14.218"></a><span id="l14.218"> </span>
<a href="#l14.219"></a><span id="l14.219">     // Changes the nickname of a participant for this muc.</span>
<a href="#l14.220"></a><span id="l14.220">     let changeNick = () =&gt; {</span>
<a href="#l14.221"></a><span id="l14.221" class="difflineminus">-      if (!item  || !item.attributes[&quot;nick&quot;]) {</span>
<a href="#l14.222"></a><span id="l14.222" class="difflineplus">+      if (!item || !item.attributes.nick) {</span>
<a href="#l14.223"></a><span id="l14.223">         this.WARN(&quot;Received a MUC presence code 303 or 210 stanza without an &quot; +</span>
<a href="#l14.224"></a><span id="l14.224">                   &quot;item element or a nick attribute.&quot;);</span>
<a href="#l14.225"></a><span id="l14.225">         return;</span>
<a href="#l14.226"></a><span id="l14.226">       }</span>
<a href="#l14.227"></a><span id="l14.227" class="difflineminus">-      let newNick = item.attributes[&quot;nick&quot;];</span>
<a href="#l14.228"></a><span id="l14.228" class="difflineplus">+      let newNick = item.attributes.nick;</span>
<a href="#l14.229"></a><span id="l14.229">       this.updateNick(nick, newNick, nick == this.nick);</span>
<a href="#l14.230"></a><span id="l14.230">     };</span>
<a href="#l14.231"></a><span id="l14.231"> </span>
<a href="#l14.232"></a><span id="l14.232" class="difflineminus">-    if (aStanza.attributes[&quot;type&quot;] == &quot;unavailable&quot;) {</span>
<a href="#l14.233"></a><span id="l14.233" class="difflineplus">+    if (aStanza.attributes.type == &quot;unavailable&quot;) {</span>
<a href="#l14.234"></a><span id="l14.234">       if (!this._participants.has(nick)) {</span>
<a href="#l14.235"></a><span id="l14.235">         this.WARN(&quot;received unavailable presence for an unknown MUC participant: &quot; +</span>
<a href="#l14.236"></a><span id="l14.236">                   from);</span>
<a href="#l14.237"></a><span id="l14.237">         return;</span>
<a href="#l14.238"></a><span id="l14.238">       }</span>
<a href="#l14.239"></a><span id="l14.239">       if (codes.includes(&quot;303&quot;)) {</span>
<a href="#l14.240"></a><span id="l14.240">         // XEP-0045 (7.6): Changing Nickname.</span>
<a href="#l14.241"></a><span id="l14.241">         // Service Updates Nick for user.</span>
<a href="#l14.242"></a><span id="l14.242">         changeNick();</span>
<a href="#l14.243"></a><span id="l14.243">         return;</span>
<a href="#l14.244"></a><span id="l14.244">       }</span>
<a href="#l14.245"></a><span id="l14.245" class="difflineminus">-      if (item &amp;&amp; item.attributes[&quot;role&quot;] == &quot;none&quot;) {</span>
<a href="#l14.246"></a><span id="l14.246" class="difflineplus">+      if (item &amp;&amp; item.attributes.role == &quot;none&quot;) {</span>
<a href="#l14.247"></a><span id="l14.247">         // XEP-0045: an occupant has left the room.</span>
<a href="#l14.248"></a><span id="l14.248">         this.removeParticipant(nick);</span>
<a href="#l14.249"></a><span id="l14.249"> </span>
<a href="#l14.250"></a><span id="l14.250">         // Who caused the participant to leave the room.</span>
<a href="#l14.251"></a><span id="l14.251">         let actor = item.getElement([&quot;actor&quot;]);</span>
<a href="#l14.252"></a><span id="l14.252" class="difflineminus">-        let actorNick = actor ? actor.attributes[&quot;nick&quot;] : &quot;&quot;;</span>
<a href="#l14.253"></a><span id="l14.253" class="difflineplus">+        let actorNick = actor ? actor.attributes.nick : &quot;&quot;;</span>
<a href="#l14.254"></a><span id="l14.254">         let isActor = actorNick ? &quot;.actor&quot; : &quot;&quot;;</span>
<a href="#l14.255"></a><span id="l14.255"> </span>
<a href="#l14.256"></a><span id="l14.256">         // Why the participant left.</span>
<a href="#l14.257"></a><span id="l14.257">         let reasonNode = item.getElement([&quot;reason&quot;]);</span>
<a href="#l14.258"></a><span id="l14.258">         let reason = reasonNode ? reasonNode.innerText : &quot;&quot;;</span>
<a href="#l14.259"></a><span id="l14.259">         let isReason = reason ? &quot;.reason&quot; : &quot;&quot;;</span>
<a href="#l14.260"></a><span id="l14.260"> </span>
<a href="#l14.261"></a><span id="l14.261">         let isYou = nick == this.nick ? &quot;.you&quot; : &quot;&quot;;</span>
<a href="#l14.262"></a><span id="l14.262" class="difflineat">@@ -391,17 +391,17 @@ var XMPPMUCConversationPrototype = {</span>
<a href="#l14.263"></a><span id="l14.263">       // Service Acknowledges Room Creation</span>
<a href="#l14.264"></a><span id="l14.264">       // and Room is awaiting configuration.</span>
<a href="#l14.265"></a><span id="l14.265">       // XEP-0045 (10.1.2): Instant room.</span>
<a href="#l14.266"></a><span id="l14.266">       let query = Stanza.node(&quot;query&quot;, Stanza.NS.muc_owner, null,</span>
<a href="#l14.267"></a><span id="l14.267">                               Stanza.node(&quot;x&quot;, Stanza.NS.xdata,</span>
<a href="#l14.268"></a><span id="l14.268">                                           {type: &quot;submit&quot;}));</span>
<a href="#l14.269"></a><span id="l14.269">       let s = Stanza.iq(&quot;set&quot;, null, jid, query);</span>
<a href="#l14.270"></a><span id="l14.270">       this._account.sendStanza(s, aStanzaReceived =&gt; {</span>
<a href="#l14.271"></a><span id="l14.271" class="difflineminus">-        if (aStanzaReceived.attributes[&quot;type&quot;] != &quot;result&quot;)</span>
<a href="#l14.272"></a><span id="l14.272" class="difflineplus">+        if (aStanzaReceived.attributes.type != &quot;result&quot;)</span>
<a href="#l14.273"></a><span id="l14.273">           return false;</span>
<a href="#l14.274"></a><span id="l14.274"> </span>
<a href="#l14.275"></a><span id="l14.275">         // XEP-0045: Service Informs New Room Owner of Success</span>
<a href="#l14.276"></a><span id="l14.276">         // for instant and reserved rooms.</span>
<a href="#l14.277"></a><span id="l14.277">         this.left = false;</span>
<a href="#l14.278"></a><span id="l14.278">         this.joining = false;</span>
<a href="#l14.279"></a><span id="l14.279">         return true;</span>
<a href="#l14.280"></a><span id="l14.280">       });</span>
<a href="#l14.281"></a><span id="l14.281" class="difflineat">@@ -438,25 +438,25 @@ var XMPPMUCConversationPrototype = {</span>
<a href="#l14.282"></a><span id="l14.282">     }</span>
<a href="#l14.283"></a><span id="l14.283">     else {</span>
<a href="#l14.284"></a><span id="l14.284">       this._participants.get(nick).onPresenceStanza(aStanza);</span>
<a href="#l14.285"></a><span id="l14.285">       this.notifyObservers(this._participants.get(nick), &quot;chat-buddy-update&quot;);</span>
<a href="#l14.286"></a><span id="l14.286">     }</span>
<a href="#l14.287"></a><span id="l14.287">   },</span>
<a href="#l14.288"></a><span id="l14.288"> </span>
<a href="#l14.289"></a><span id="l14.289">   /* Called by the account when a message is received for this muc */</span>
<a href="#l14.290"></a><span id="l14.290" class="difflineminus">-  incomingMessage: function(aMsg, aStanza, aDate) {</span>
<a href="#l14.291"></a><span id="l14.291" class="difflineminus">-    let from = this._account._parseJID(aStanza.attributes[&quot;from&quot;]).resource;</span>
<a href="#l14.292"></a><span id="l14.292" class="difflineminus">-    let id = aStanza.attributes[&quot;id&quot;];</span>
<a href="#l14.293"></a><span id="l14.293" class="difflineplus">+  incomingMessage(aMsg, aStanza, aDate) {</span>
<a href="#l14.294"></a><span id="l14.294" class="difflineplus">+    let from = this._account._parseJID(aStanza.attributes.from).resource;</span>
<a href="#l14.295"></a><span id="l14.295" class="difflineplus">+    let id = aStanza.attributes.id;</span>
<a href="#l14.296"></a><span id="l14.296">     let flags = {};</span>
<a href="#l14.297"></a><span id="l14.297">     if (!from) {</span>
<a href="#l14.298"></a><span id="l14.298">       flags.system = true;</span>
<a href="#l14.299"></a><span id="l14.299">       from = this.name;</span>
<a href="#l14.300"></a><span id="l14.300">     }</span>
<a href="#l14.301"></a><span id="l14.301" class="difflineminus">-    else if (aStanza.attributes[&quot;type&quot;] == &quot;error&quot;) {</span>
<a href="#l14.302"></a><span id="l14.302" class="difflineplus">+    else if (aStanza.attributes.type == &quot;error&quot;) {</span>
<a href="#l14.303"></a><span id="l14.303">       aMsg = _(&quot;conversation.error.notDelivered&quot;, aMsg);</span>
<a href="#l14.304"></a><span id="l14.304">       flags.system = true;</span>
<a href="#l14.305"></a><span id="l14.305">       flags.error = true;</span>
<a href="#l14.306"></a><span id="l14.306">     }</span>
<a href="#l14.307"></a><span id="l14.307">     else if (from == this._nick)</span>
<a href="#l14.308"></a><span id="l14.308">       flags.outgoing = true;</span>
<a href="#l14.309"></a><span id="l14.309">     else</span>
<a href="#l14.310"></a><span id="l14.310">       flags.incoming = true;</span>
<a href="#l14.311"></a><span id="l14.311" class="difflineat">@@ -468,48 +468,48 @@ var XMPPMUCConversationPrototype = {</span>
<a href="#l14.312"></a><span id="l14.312">       // Checks if a message exists in conversation to avoid duplication.</span>
<a href="#l14.313"></a><span id="l14.313">       if (this._messageIds.has(id))</span>
<a href="#l14.314"></a><span id="l14.314">         return;</span>
<a href="#l14.315"></a><span id="l14.315">       this._messageIds.add(id);</span>
<a href="#l14.316"></a><span id="l14.316">     }</span>
<a href="#l14.317"></a><span id="l14.317">     this.writeMessage(from, aMsg, flags);</span>
<a href="#l14.318"></a><span id="l14.318">   },</span>
<a href="#l14.319"></a><span id="l14.319"> </span>
<a href="#l14.320"></a><span id="l14.320" class="difflineminus">-  getNormalizedChatBuddyName: function(aNick) {</span>
<a href="#l14.321"></a><span id="l14.321" class="difflineplus">+  getNormalizedChatBuddyName(aNick) {</span>
<a href="#l14.322"></a><span id="l14.322">     return this._account.normalizeFullJid(this.name + &quot;/&quot; + aNick);</span>
<a href="#l14.323"></a><span id="l14.323">   },</span>
<a href="#l14.324"></a><span id="l14.324"> </span>
<a href="#l14.325"></a><span id="l14.325">   // Leaves MUC conversation.</span>
<a href="#l14.326"></a><span id="l14.326" class="difflineminus">-  part: function(aMsg = null) {</span>
<a href="#l14.327"></a><span id="l14.327" class="difflineplus">+  part(aMsg = null) {</span>
<a href="#l14.328"></a><span id="l14.328">     let s = Stanza.presence({to: this.name + &quot;/&quot; + this._nick, type: &quot;unavailable&quot;},</span>
<a href="#l14.329"></a><span id="l14.329">                             aMsg ? Stanza.node(&quot;status&quot;, null, null, aMsg.trim()) : null);</span>
<a href="#l14.330"></a><span id="l14.330">     this._account.sendStanza(s);</span>
<a href="#l14.331"></a><span id="l14.331">     delete this.chatRoomFields;</span>
<a href="#l14.332"></a><span id="l14.332">   },</span>
<a href="#l14.333"></a><span id="l14.333"> </span>
<a href="#l14.334"></a><span id="l14.334">   // Invites a user to MUC conversation.</span>
<a href="#l14.335"></a><span id="l14.335" class="difflineminus">-  invite: function(aJID, aMsg = null) {</span>
<a href="#l14.336"></a><span id="l14.336" class="difflineplus">+  invite(aJID, aMsg = null) {</span>
<a href="#l14.337"></a><span id="l14.337">     // XEP-0045 (7.8): Inviting Another User to a Room.</span>
<a href="#l14.338"></a><span id="l14.338">     // XEP-0045 (7.8.2): Mediated Invitation.</span>
<a href="#l14.339"></a><span id="l14.339">     let invite = Stanza.node(&quot;invite&quot;, null, {to: aJID},</span>
<a href="#l14.340"></a><span id="l14.340">       aMsg ? Stanza.node(&quot;reason&quot;, null, null, aMsg) : null);</span>
<a href="#l14.341"></a><span id="l14.341">     let x = Stanza.node(&quot;x&quot;, Stanza.NS.muc_user, null, invite);</span>
<a href="#l14.342"></a><span id="l14.342">     let s = Stanza.node(&quot;message&quot;, null, {to: this.name}, x);</span>
<a href="#l14.343"></a><span id="l14.343">     this._account.sendStanza(s, this._account.handleErrors({</span>
<a href="#l14.344"></a><span id="l14.344">       forbidden: _(&quot;conversation.error.inviteFailedForbidden&quot;),</span>
<a href="#l14.345"></a><span id="l14.345">       // ejabberd uses error not-allowed to indicate that this account does not</span>
<a href="#l14.346"></a><span id="l14.346">       // have the required privileges to invite users instead of forbidden error,</span>
<a href="#l14.347"></a><span id="l14.347">       // and this is not mentioned in the spec (XEP-0045).</span>
<a href="#l14.348"></a><span id="l14.348">       notAllowed: _(&quot;conversation.error.inviteFailedForbidden&quot;),</span>
<a href="#l14.349"></a><span id="l14.349" class="difflineminus">-      itemNotFound: _(&quot;conversation.error.failedJIDNotFound&quot;, aJID)</span>
<a href="#l14.350"></a><span id="l14.350" class="difflineplus">+      itemNotFound: _(&quot;conversation.error.failedJIDNotFound&quot;, aJID),</span>
<a href="#l14.351"></a><span id="l14.351">     }, this));</span>
<a href="#l14.352"></a><span id="l14.352">   },</span>
<a href="#l14.353"></a><span id="l14.353"> </span>
<a href="#l14.354"></a><span id="l14.354">   // Bans a participant from MUC conversation.</span>
<a href="#l14.355"></a><span id="l14.355" class="difflineminus">-  ban: function(aNickName, aMsg = null) {</span>
<a href="#l14.356"></a><span id="l14.356" class="difflineplus">+  ban(aNickName, aMsg = null) {</span>
<a href="#l14.357"></a><span id="l14.357">     // XEP-0045 (9.1): Banning a User.</span>
<a href="#l14.358"></a><span id="l14.358">     let participant = this._participants.get(aNickName);</span>
<a href="#l14.359"></a><span id="l14.359">     if (!participant) {</span>
<a href="#l14.360"></a><span id="l14.360">       this.writeMessage(this.name,</span>
<a href="#l14.361"></a><span id="l14.361">                         _(&quot;conversation.error.nickNotInRoom&quot;, aNickName),</span>
<a href="#l14.362"></a><span id="l14.362">                         {system: true});</span>
<a href="#l14.363"></a><span id="l14.363">       return;</span>
<a href="#l14.364"></a><span id="l14.364">     }</span>
<a href="#l14.365"></a><span id="l14.365" class="difflineat">@@ -524,82 +524,82 @@ var XMPPMUCConversationPrototype = {</span>
<a href="#l14.366"></a><span id="l14.366">     let item = Stanza.node(&quot;item&quot;, null, attributes,</span>
<a href="#l14.367"></a><span id="l14.367">       aMsg ? Stanza.node(&quot;reason&quot;, null, null, aMsg) : null);</span>
<a href="#l14.368"></a><span id="l14.368">     let s = Stanza.iq(&quot;set&quot;, null, this.name,</span>
<a href="#l14.369"></a><span id="l14.369">                       Stanza.node(&quot;query&quot;, Stanza.NS.muc_admin, null, item));</span>
<a href="#l14.370"></a><span id="l14.370">     this._account.sendStanza(s, this._banKickHandler, this);</span>
<a href="#l14.371"></a><span id="l14.371">   },</span>
<a href="#l14.372"></a><span id="l14.372"> </span>
<a href="#l14.373"></a><span id="l14.373">   // Kicks a participant from MUC conversation.</span>
<a href="#l14.374"></a><span id="l14.374" class="difflineminus">-  kick: function(aNickName, aMsg = null) {</span>
<a href="#l14.375"></a><span id="l14.375" class="difflineplus">+  kick(aNickName, aMsg = null) {</span>
<a href="#l14.376"></a><span id="l14.376">     // XEP-0045 (8.2): Kicking an Occupant.</span>
<a href="#l14.377"></a><span id="l14.377">     let attributes = {role: &quot;none&quot;, nick: aNickName};</span>
<a href="#l14.378"></a><span id="l14.378">     let item = Stanza.node(&quot;item&quot;, null, attributes,</span>
<a href="#l14.379"></a><span id="l14.379">       aMsg ? Stanza.node(&quot;reason&quot;, null, null, aMsg) : null);</span>
<a href="#l14.380"></a><span id="l14.380">     let s = Stanza.iq(&quot;set&quot;, null, this.name,</span>
<a href="#l14.381"></a><span id="l14.381">                       Stanza.node(&quot;query&quot;, Stanza.NS.muc_admin, null, item));</span>
<a href="#l14.382"></a><span id="l14.382">     this._account.sendStanza(s, this._banKickHandler, this);</span>
<a href="#l14.383"></a><span id="l14.383">   },</span>
<a href="#l14.384"></a><span id="l14.384"> </span>
<a href="#l14.385"></a><span id="l14.385">   // Callback for ban and kick commands.</span>
<a href="#l14.386"></a><span id="l14.386" class="difflineminus">-  _banKickHandler: function(aStanza) {</span>
<a href="#l14.387"></a><span id="l14.387" class="difflineplus">+  _banKickHandler(aStanza) {</span>
<a href="#l14.388"></a><span id="l14.388">     return this._account._handleResult({</span>
<a href="#l14.389"></a><span id="l14.389">       notAllowed: _(&quot;conversation.error.banKickCommandNotAllowed&quot;),</span>
<a href="#l14.390"></a><span id="l14.390" class="difflineminus">-      conflict: _(&quot;conversation.error.banKickCommandConflict&quot;)</span>
<a href="#l14.391"></a><span id="l14.391" class="difflineplus">+      conflict: _(&quot;conversation.error.banKickCommandConflict&quot;),</span>
<a href="#l14.392"></a><span id="l14.392">     }, this)(aStanza);</span>
<a href="#l14.393"></a><span id="l14.393">   },</span>
<a href="#l14.394"></a><span id="l14.394"> </span>
<a href="#l14.395"></a><span id="l14.395">   // Changes nick in MUC conversation to a new one.</span>
<a href="#l14.396"></a><span id="l14.396" class="difflineminus">-  setNick: function(aNewNick) {</span>
<a href="#l14.397"></a><span id="l14.397" class="difflineplus">+  setNick(aNewNick) {</span>
<a href="#l14.398"></a><span id="l14.398">     // XEP-0045 (7.6): Changing Nickname.</span>
<a href="#l14.399"></a><span id="l14.399">     let s = Stanza.presence({to: this.name + &quot;/&quot; + aNewNick}, null);</span>
<a href="#l14.400"></a><span id="l14.400">     this._account.sendStanza(s, this._account.handleErrors({</span>
<a href="#l14.401"></a><span id="l14.401">       // XEP-0045 (7.6): Changing Nickname (example 53).</span>
<a href="#l14.402"></a><span id="l14.402">       // TODO: We should discover if the user has a reserved nickname (maybe</span>
<a href="#l14.403"></a><span id="l14.403">       // before joining a room), cf. XEP-0045 (7.12).</span>
<a href="#l14.404"></a><span id="l14.404">       notAcceptable: _(&quot;conversation.error.changeNickFailedNotAcceptable&quot;,</span>
<a href="#l14.405"></a><span id="l14.405">                        aNewNick),</span>
<a href="#l14.406"></a><span id="l14.406">       // XEP-0045 (7.2.9): Nickname Conflict.</span>
<a href="#l14.407"></a><span id="l14.407" class="difflineminus">-      conflict: _(&quot;conversation.error.changeNickFailedConflict&quot;, aNewNick)</span>
<a href="#l14.408"></a><span id="l14.408" class="difflineplus">+      conflict: _(&quot;conversation.error.changeNickFailedConflict&quot;, aNewNick),</span>
<a href="#l14.409"></a><span id="l14.409">     }, this));</span>
<a href="#l14.410"></a><span id="l14.410">   },</span>
<a href="#l14.411"></a><span id="l14.411"> </span>
<a href="#l14.412"></a><span id="l14.412">   // Called by the account when a message stanza is received for this muc and</span>
<a href="#l14.413"></a><span id="l14.413">   // needs to be handled.</span>
<a href="#l14.414"></a><span id="l14.414" class="difflineminus">-  onMessageStanza: function(aStanza) {</span>
<a href="#l14.415"></a><span id="l14.415" class="difflineplus">+  onMessageStanza(aStanza) {</span>
<a href="#l14.416"></a><span id="l14.416">     let x = aStanza.getElement([&quot;x&quot;]);</span>
<a href="#l14.417"></a><span id="l14.417">     let decline = x.getElement([&quot;decline&quot;]);</span>
<a href="#l14.418"></a><span id="l14.418">     if (decline) {</span>
<a href="#l14.419"></a><span id="l14.419">       // XEP-0045 (7.8): Inviting Another User to a Room.</span>
<a href="#l14.420"></a><span id="l14.420">       // XEP-0045 (7.8.2): Mediated Invitation.</span>
<a href="#l14.421"></a><span id="l14.421" class="difflineminus">-      let invitee = decline.attributes[&quot;jid&quot;];</span>
<a href="#l14.422"></a><span id="l14.422" class="difflineplus">+      let invitee = decline.attributes.jid;</span>
<a href="#l14.423"></a><span id="l14.423">       let reasonNode = decline.getElement([&quot;reason&quot;]);</span>
<a href="#l14.424"></a><span id="l14.424">       let reason = reasonNode ? reasonNode.innerText : &quot;&quot;;</span>
<a href="#l14.425"></a><span id="l14.425">       let msg;</span>
<a href="#l14.426"></a><span id="l14.426">       if (reason)</span>
<a href="#l14.427"></a><span id="l14.427">         msg = _(&quot;conversation.message.invitationDeclined.reason&quot;, invitee, reason);</span>
<a href="#l14.428"></a><span id="l14.428">       else</span>
<a href="#l14.429"></a><span id="l14.429">         msg = _(&quot;conversation.message.invitationDeclined&quot;, invitee);</span>
<a href="#l14.430"></a><span id="l14.430"> </span>
<a href="#l14.431"></a><span id="l14.431">       this.writeMessage(this.name, msg, {system: true});</span>
<a href="#l14.432"></a><span id="l14.432">     }</span>
<a href="#l14.433"></a><span id="l14.433">     else</span>
<a href="#l14.434"></a><span id="l14.434">       this.WARN(&quot;Unhandled message stanza.&quot;);</span>
<a href="#l14.435"></a><span id="l14.435">   },</span>
<a href="#l14.436"></a><span id="l14.436"> </span>
<a href="#l14.437"></a><span id="l14.437">   /* Called when the user closed the conversation */</span>
<a href="#l14.438"></a><span id="l14.438" class="difflineminus">-  close: function() {</span>
<a href="#l14.439"></a><span id="l14.439" class="difflineplus">+  close() {</span>
<a href="#l14.440"></a><span id="l14.440">     if (!this.left)</span>
<a href="#l14.441"></a><span id="l14.441">       this.part();</span>
<a href="#l14.442"></a><span id="l14.442">     GenericConvChatPrototype.close.call(this);</span>
<a href="#l14.443"></a><span id="l14.443">   },</span>
<a href="#l14.444"></a><span id="l14.444" class="difflineminus">-  unInit: function() {</span>
<a href="#l14.445"></a><span id="l14.445" class="difflineplus">+  unInit() {</span>
<a href="#l14.446"></a><span id="l14.446">     this._account.removeConversation(this.name);</span>
<a href="#l14.447"></a><span id="l14.447">     GenericConvChatPrototype.unInit.call(this);</span>
<a href="#l14.448"></a><span id="l14.448" class="difflineminus">-  }</span>
<a href="#l14.449"></a><span id="l14.449" class="difflineplus">+  },</span>
<a href="#l14.450"></a><span id="l14.450"> };</span>
<a href="#l14.451"></a><span id="l14.451"> function XMPPMUCConversation(aAccount, aJID, aNick)</span>
<a href="#l14.452"></a><span id="l14.452"> {</span>
<a href="#l14.453"></a><span id="l14.453">   this._init(aAccount, aJID, aNick);</span>
<a href="#l14.454"></a><span id="l14.454"> }</span>
<a href="#l14.455"></a><span id="l14.455"> XMPPMUCConversation.prototype = XMPPMUCConversationPrototype;</span>
<a href="#l14.456"></a><span id="l14.456"> </span>
<a href="#l14.457"></a><span id="l14.457"> /* Helper class for buddy conversations */</span>
<a href="#l14.458"></a><span id="l14.458" class="difflineat">@@ -647,50 +647,50 @@ var XMPPConversationPrototype = {</span>
<a href="#l14.459"></a><span id="l14.459">   get shouldSendTypingNotifications() {</span>
<a href="#l14.460"></a><span id="l14.460">     return this.supportChatStateNotifications &amp;&amp;</span>
<a href="#l14.461"></a><span id="l14.461">            Services.prefs.getBoolPref(&quot;purple.conversations.im.send_typing&quot;);</span>
<a href="#l14.462"></a><span id="l14.462">   },</span>
<a href="#l14.463"></a><span id="l14.463"> </span>
<a href="#l14.464"></a><span id="l14.464">   /* Called when the user is typing a message</span>
<a href="#l14.465"></a><span id="l14.465">    * aString - the currently typed message</span>
<a href="#l14.466"></a><span id="l14.466">    * Returns the number of characters that can still be typed */</span>
<a href="#l14.467"></a><span id="l14.467" class="difflineminus">-  sendTyping: function(aString) {</span>
<a href="#l14.468"></a><span id="l14.468" class="difflineplus">+  sendTyping(aString) {</span>
<a href="#l14.469"></a><span id="l14.469">     if (!this.shouldSendTypingNotifications)</span>
<a href="#l14.470"></a><span id="l14.470">       return Ci.prplIConversation.NO_TYPING_LIMIT;</span>
<a href="#l14.471"></a><span id="l14.471"> </span>
<a href="#l14.472"></a><span id="l14.472">     this._cancelTypingTimer();</span>
<a href="#l14.473"></a><span id="l14.473">     if (aString.length)</span>
<a href="#l14.474"></a><span id="l14.474">       this._typingTimer = setTimeout(this.finishedComposing.bind(this), 10000);</span>
<a href="#l14.475"></a><span id="l14.475"> </span>
<a href="#l14.476"></a><span id="l14.476">     this._setTypingState(aString.length ? &quot;composing&quot; : &quot;active&quot;);</span>
<a href="#l14.477"></a><span id="l14.477"> </span>
<a href="#l14.478"></a><span id="l14.478">     return Ci.prplIConversation.NO_TYPING_LIMIT;</span>
<a href="#l14.479"></a><span id="l14.479">   },</span>
<a href="#l14.480"></a><span id="l14.480"> </span>
<a href="#l14.481"></a><span id="l14.481" class="difflineminus">-  finishedComposing: function() {</span>
<a href="#l14.482"></a><span id="l14.482" class="difflineplus">+  finishedComposing() {</span>
<a href="#l14.483"></a><span id="l14.483">     if (!this.shouldSendTypingNotifications)</span>
<a href="#l14.484"></a><span id="l14.484">       return;</span>
<a href="#l14.485"></a><span id="l14.485"> </span>
<a href="#l14.486"></a><span id="l14.486">     this._setTypingState(&quot;paused&quot;);</span>
<a href="#l14.487"></a><span id="l14.487">   },</span>
<a href="#l14.488"></a><span id="l14.488"> </span>
<a href="#l14.489"></a><span id="l14.489" class="difflineminus">-  _setTypingState: function(aNewState) {</span>
<a href="#l14.490"></a><span id="l14.490" class="difflineplus">+  _setTypingState(aNewState) {</span>
<a href="#l14.491"></a><span id="l14.491">     if (this._typingState == aNewState)</span>
<a href="#l14.492"></a><span id="l14.492">       return;</span>
<a href="#l14.493"></a><span id="l14.493"> </span>
<a href="#l14.494"></a><span id="l14.494">     let s = Stanza.message(this.to, null, aNewState);</span>
<a href="#l14.495"></a><span id="l14.495"> </span>
<a href="#l14.496"></a><span id="l14.496">     // We don't care about errors in response to typing notifications</span>
<a href="#l14.497"></a><span id="l14.497">     // (e.g. because the user has left the room when talking to a MUC</span>
<a href="#l14.498"></a><span id="l14.498">     // participant).</span>
<a href="#l14.499"></a><span id="l14.499">     this._account.sendStanza(s, () =&gt; true);</span>
<a href="#l14.500"></a><span id="l14.500"> </span>
<a href="#l14.501"></a><span id="l14.501">     this._typingState = aNewState;</span>
<a href="#l14.502"></a><span id="l14.502">   },</span>
<a href="#l14.503"></a><span id="l14.503" class="difflineminus">-  _cancelTypingTimer: function() {</span>
<a href="#l14.504"></a><span id="l14.504" class="difflineplus">+  _cancelTypingTimer() {</span>
<a href="#l14.505"></a><span id="l14.505">     if (this._typingTimer) {</span>
<a href="#l14.506"></a><span id="l14.506">       clearTimeout(this._typingTimer);</span>
<a href="#l14.507"></a><span id="l14.507">       delete this._typingTimer;</span>
<a href="#l14.508"></a><span id="l14.508">     }</span>
<a href="#l14.509"></a><span id="l14.509">   },</span>
<a href="#l14.510"></a><span id="l14.510"> </span>
<a href="#l14.511"></a><span id="l14.511">   // Holds the resource of user that you are currenty talking to, but if the</span>
<a href="#l14.512"></a><span id="l14.512">   // user is a participant of a MUC we are in, holds the nick of user you are</span>
<a href="#l14.513"></a><span id="l14.513" class="difflineat">@@ -699,47 +699,47 @@ var XMPPConversationPrototype = {</span>
<a href="#l14.514"></a><span id="l14.514"> </span>
<a href="#l14.515"></a><span id="l14.515">   get to() {</span>
<a href="#l14.516"></a><span id="l14.516">     if (!this._targetResource || this._isMucParticipant)</span>
<a href="#l14.517"></a><span id="l14.517">       return this.userName;</span>
<a href="#l14.518"></a><span id="l14.518">     return this.userName + &quot;/&quot; + this._targetResource;</span>
<a href="#l14.519"></a><span id="l14.519">   },</span>
<a href="#l14.520"></a><span id="l14.520"> </span>
<a href="#l14.521"></a><span id="l14.521">   /* Called when the user enters a chat message */</span>
<a href="#l14.522"></a><span id="l14.522" class="difflineminus">-  sendMsg: function(aMsg) {</span>
<a href="#l14.523"></a><span id="l14.523" class="difflineplus">+  sendMsg(aMsg) {</span>
<a href="#l14.524"></a><span id="l14.524">     this._cancelTypingTimer();</span>
<a href="#l14.525"></a><span id="l14.525">     let cs = this.shouldSendTypingNotifications ? &quot;active&quot; : null;</span>
<a href="#l14.526"></a><span id="l14.526">     let s = Stanza.message(this.to, aMsg, cs);</span>
<a href="#l14.527"></a><span id="l14.527">     this._account.sendStanza(s);</span>
<a href="#l14.528"></a><span id="l14.528">     _displaySentMsg(this, aMsg);</span>
<a href="#l14.529"></a><span id="l14.529">     delete this._typingState;</span>
<a href="#l14.530"></a><span id="l14.530">   },</span>
<a href="#l14.531"></a><span id="l14.531"> </span>
<a href="#l14.532"></a><span id="l14.532">   // Invites the contact to a MUC room.</span>
<a href="#l14.533"></a><span id="l14.533" class="difflineminus">-  invite: function(aRoomJid, aPassword = null) {</span>
<a href="#l14.534"></a><span id="l14.534" class="difflineplus">+  invite(aRoomJid, aPassword = null) {</span>
<a href="#l14.535"></a><span id="l14.535">     // XEP-0045 (7.8): Inviting Another User to a Room.</span>
<a href="#l14.536"></a><span id="l14.536">     // XEP-0045 (7.8.1) and XEP-0249: Direct Invitation.</span>
<a href="#l14.537"></a><span id="l14.537">     let x = Stanza.node(&quot;x&quot;, Stanza.NS.conference, {jid: aRoomJid,</span>
<a href="#l14.538"></a><span id="l14.538">                                                     password: aPassword});</span>
<a href="#l14.539"></a><span id="l14.539">     this._account.sendStanza(Stanza.node(&quot;message&quot;, null, {to: this.to}, x));</span>
<a href="#l14.540"></a><span id="l14.540">   },</span>
<a href="#l14.541"></a><span id="l14.541"> </span>
<a href="#l14.542"></a><span id="l14.542">   // Query the user for its Software Version.</span>
<a href="#l14.543"></a><span id="l14.543">   // XEP-0092: Software Version.</span>
<a href="#l14.544"></a><span id="l14.544" class="difflineminus">-  getVersion: function() {</span>
<a href="#l14.545"></a><span id="l14.545" class="difflineplus">+  getVersion() {</span>
<a href="#l14.546"></a><span id="l14.546">     // TODO: Use Service Discovery to determine if the user's client supports</span>
<a href="#l14.547"></a><span id="l14.547">     // jabber:iq:version protocol.</span>
<a href="#l14.548"></a><span id="l14.548"> </span>
<a href="#l14.549"></a><span id="l14.549">     let s = Stanza.iq(&quot;get&quot;, null, this.to,</span>
<a href="#l14.550"></a><span id="l14.550">                       Stanza.node(&quot;query&quot;, Stanza.NS.version));</span>
<a href="#l14.551"></a><span id="l14.551">     this._account.sendStanza(s, aStanza =&gt; {</span>
<a href="#l14.552"></a><span id="l14.552">       // TODO: handle other errors that can result from querying</span>
<a href="#l14.553"></a><span id="l14.553">       // user for its software version.</span>
<a href="#l14.554"></a><span id="l14.554">       if (this._account.handleErrors({</span>
<a href="#l14.555"></a><span id="l14.555" class="difflineminus">-            default: _(&quot;conversation.error.version.unknown&quot;)</span>
<a href="#l14.556"></a><span id="l14.556" class="difflineplus">+            default: _(&quot;conversation.error.version.unknown&quot;),</span>
<a href="#l14.557"></a><span id="l14.557">           }, this)(aStanza)) {</span>
<a href="#l14.558"></a><span id="l14.558">         return;</span>
<a href="#l14.559"></a><span id="l14.559">       }</span>
<a href="#l14.560"></a><span id="l14.560"> </span>
<a href="#l14.561"></a><span id="l14.561">       let query = aStanza.getElement([&quot;query&quot;]);</span>
<a href="#l14.562"></a><span id="l14.562">       if (!query || query.uri != Stanza.NS.version) {</span>
<a href="#l14.563"></a><span id="l14.563">         this.WARN(&quot;Received a response to version query which does not &quot; +</span>
<a href="#l14.564"></a><span id="l14.564">                   &quot;contain query element or 'jabber:iq:version' namespace.&quot;);</span>
<a href="#l14.565"></a><span id="l14.565" class="difflineat">@@ -766,25 +766,25 @@ var XMPPConversationPrototype = {</span>
<a href="#l14.566"></a><span id="l14.566">       }</span>
<a href="#l14.567"></a><span id="l14.567"> </span>
<a href="#l14.568"></a><span id="l14.568">       this.writeMessage(this.name, _(messageID, ...params), {system: true});</span>
<a href="#l14.569"></a><span id="l14.569">     });</span>
<a href="#l14.570"></a><span id="l14.570">   },</span>
<a href="#l14.571"></a><span id="l14.571"> </span>
<a href="#l14.572"></a><span id="l14.572">   /* Perform entity escaping before displaying the message. We assume incoming</span>
<a href="#l14.573"></a><span id="l14.573">      messages have already been escaped, and will otherwise be filtered. */</span>
<a href="#l14.574"></a><span id="l14.574" class="difflineminus">-  prepareForDisplaying: function(aMsg) {</span>
<a href="#l14.575"></a><span id="l14.575" class="difflineplus">+  prepareForDisplaying(aMsg) {</span>
<a href="#l14.576"></a><span id="l14.576">     if (aMsg.outgoing &amp;&amp; !aMsg.system)</span>
<a href="#l14.577"></a><span id="l14.577">       aMsg.displayMessage = TXTToHTML(aMsg.displayMessage);</span>
<a href="#l14.578"></a><span id="l14.578">     GenericConversationPrototype.prepareForDisplaying.apply(this, arguments);</span>
<a href="#l14.579"></a><span id="l14.579">   },</span>
<a href="#l14.580"></a><span id="l14.580"> </span>
<a href="#l14.581"></a><span id="l14.581">   /* Called by the account when a message is received from the buddy */</span>
<a href="#l14.582"></a><span id="l14.582" class="difflineminus">-  incomingMessage: function(aMsg, aStanza, aDate) {</span>
<a href="#l14.583"></a><span id="l14.583" class="difflineminus">-    let from = aStanza.attributes[&quot;from&quot;];</span>
<a href="#l14.584"></a><span id="l14.584" class="difflineplus">+  incomingMessage(aMsg, aStanza, aDate) {</span>
<a href="#l14.585"></a><span id="l14.585" class="difflineplus">+    let from = aStanza.attributes.from;</span>
<a href="#l14.586"></a><span id="l14.586">     this._targetResource = this._account._parseJID(from).resource;</span>
<a href="#l14.587"></a><span id="l14.587">     let flags = {};</span>
<a href="#l14.588"></a><span id="l14.588">     let error = this._account.parseError(aStanza);</span>
<a href="#l14.589"></a><span id="l14.589">     if (error) {</span>
<a href="#l14.590"></a><span id="l14.590">       let norm = this._account.normalize(from);</span>
<a href="#l14.591"></a><span id="l14.591">       let muc = this._account._mucs.get(norm);</span>
<a href="#l14.592"></a><span id="l14.592"> </span>
<a href="#l14.593"></a><span id="l14.593">       if (!aMsg) {</span>
<a href="#l14.594"></a><span id="l14.594" class="difflineat">@@ -826,24 +826,24 @@ var XMPPConversationPrototype = {</span>
<a href="#l14.595"></a><span id="l14.595">     if (aDate) {</span>
<a href="#l14.596"></a><span id="l14.596">       flags.time = aDate / 1000;</span>
<a href="#l14.597"></a><span id="l14.597">       flags.delayed = true;</span>
<a href="#l14.598"></a><span id="l14.598">     }</span>
<a href="#l14.599"></a><span id="l14.599">     this.writeMessage(from, aMsg, flags);</span>
<a href="#l14.600"></a><span id="l14.600">   },</span>
<a href="#l14.601"></a><span id="l14.601"> </span>
<a href="#l14.602"></a><span id="l14.602">   /* Called when the user closed the conversation */</span>
<a href="#l14.603"></a><span id="l14.603" class="difflineminus">-  close: function() {</span>
<a href="#l14.604"></a><span id="l14.604" class="difflineplus">+  close() {</span>
<a href="#l14.605"></a><span id="l14.605">     // TODO send the stanza indicating we have left the conversation?</span>
<a href="#l14.606"></a><span id="l14.606">     GenericConvIMPrototype.close.call(this);</span>
<a href="#l14.607"></a><span id="l14.607">   },</span>
<a href="#l14.608"></a><span id="l14.608" class="difflineminus">-  unInit: function() {</span>
<a href="#l14.609"></a><span id="l14.609" class="difflineplus">+  unInit() {</span>
<a href="#l14.610"></a><span id="l14.610">     this._account.removeConversation(this.normalizedName);</span>
<a href="#l14.611"></a><span id="l14.611">     GenericConvIMPrototype.unInit.call(this);</span>
<a href="#l14.612"></a><span id="l14.612" class="difflineminus">-  }</span>
<a href="#l14.613"></a><span id="l14.613" class="difflineplus">+  },</span>
<a href="#l14.614"></a><span id="l14.614"> };</span>
<a href="#l14.615"></a><span id="l14.615"> </span>
<a href="#l14.616"></a><span id="l14.616"> // Creates XMPP conversation.</span>
<a href="#l14.617"></a><span id="l14.617"> function XMPPConversation(aAccount, aNormalizedName, aMucParticipant)</span>
<a href="#l14.618"></a><span id="l14.618"> {</span>
<a href="#l14.619"></a><span id="l14.619">   this._init(aAccount, aNormalizedName);</span>
<a href="#l14.620"></a><span id="l14.620">   if (aMucParticipant)</span>
<a href="#l14.621"></a><span id="l14.621">     this._isMucParticipant = true;</span>
<a href="#l14.622"></a><span id="l14.622" class="difflineat">@@ -852,17 +852,17 @@ XMPPConversation.prototype = XMPPConvers</span>
<a href="#l14.623"></a><span id="l14.623"> </span>
<a href="#l14.624"></a><span id="l14.624"> /* Helper class for buddies */</span>
<a href="#l14.625"></a><span id="l14.625"> var XMPPAccountBuddyPrototype = {</span>
<a href="#l14.626"></a><span id="l14.626">   __proto__: GenericAccountBuddyPrototype,</span>
<a href="#l14.627"></a><span id="l14.627"> </span>
<a href="#l14.628"></a><span id="l14.628">   subscription: &quot;none&quot;,</span>
<a href="#l14.629"></a><span id="l14.629">   // Returns a list of TooltipInfo objects to be displayed when the user</span>
<a href="#l14.630"></a><span id="l14.630">   // hovers over the buddy.</span>
<a href="#l14.631"></a><span id="l14.631" class="difflineminus">-  getTooltipInfo: function() {</span>
<a href="#l14.632"></a><span id="l14.632" class="difflineplus">+  getTooltipInfo() {</span>
<a href="#l14.633"></a><span id="l14.633">     if (!this._account.connected)</span>
<a href="#l14.634"></a><span id="l14.634">       return null;</span>
<a href="#l14.635"></a><span id="l14.635"> </span>
<a href="#l14.636"></a><span id="l14.636">     let tooltipInfo = [];</span>
<a href="#l14.637"></a><span id="l14.637">     if (this._resources) {</span>
<a href="#l14.638"></a><span id="l14.638">       for (let r in this._resources) {</span>
<a href="#l14.639"></a><span id="l14.639">         let status = this._resources[r];</span>
<a href="#l14.640"></a><span id="l14.640">         let statusString = Status.toLabel(status.statusType);</span>
<a href="#l14.641"></a><span id="l14.641" class="difflineat">@@ -919,19 +919,19 @@ var XMPPAccountBuddyPrototype = {</span>
<a href="#l14.642"></a><span id="l14.642">     if (!this._rosterItem) {</span>
<a href="#l14.643"></a><span id="l14.643">       this.ERROR(&quot;attempting to update the server alias of an account buddy &quot; +</span>
<a href="#l14.644"></a><span id="l14.644">                  &quot;for which we haven't received a roster item.&quot;);</span>
<a href="#l14.645"></a><span id="l14.645">       return;</span>
<a href="#l14.646"></a><span id="l14.646">     }</span>
<a href="#l14.647"></a><span id="l14.647"> </span>
<a href="#l14.648"></a><span id="l14.648">     let item = this._rosterItem;</span>
<a href="#l14.649"></a><span id="l14.649">     if (aNewAlias)</span>
<a href="#l14.650"></a><span id="l14.650" class="difflineminus">-      item.attributes[&quot;name&quot;] = aNewAlias;</span>
<a href="#l14.651"></a><span id="l14.651" class="difflineplus">+      item.attributes.name = aNewAlias;</span>
<a href="#l14.652"></a><span id="l14.652">     else if (&quot;name&quot; in item.attributes)</span>
<a href="#l14.653"></a><span id="l14.653" class="difflineminus">-      delete item.attributes[&quot;name&quot;];</span>
<a href="#l14.654"></a><span id="l14.654" class="difflineplus">+      delete item.attributes.name;</span>
<a href="#l14.655"></a><span id="l14.655"> </span>
<a href="#l14.656"></a><span id="l14.656">     let s = Stanza.iq(&quot;set&quot;, null, null,</span>
<a href="#l14.657"></a><span id="l14.657">                       Stanza.node(&quot;query&quot;, Stanza.NS.roster, null, item));</span>
<a href="#l14.658"></a><span id="l14.658">     this._account.sendStanza(s);</span>
<a href="#l14.659"></a><span id="l14.659"> </span>
<a href="#l14.660"></a><span id="l14.660">     // If we are going to change the alias on the server, discard the cached</span>
<a href="#l14.661"></a><span id="l14.661">     // value that we got from our local sqlite storage at startup.</span>
<a href="#l14.662"></a><span id="l14.662">     delete this._serverAlias;</span>
<a href="#l14.663"></a><span id="l14.663" class="difflineat">@@ -973,30 +973,30 @@ var XMPPAccountBuddyPrototype = {</span>
<a href="#l14.664"></a><span id="l14.664">     if (item.getXML() == oldXML)</span>
<a href="#l14.665"></a><span id="l14.665">       return;</span>
<a href="#l14.666"></a><span id="l14.666"> </span>
<a href="#l14.667"></a><span id="l14.667">     let s = Stanza.iq(&quot;set&quot;, null, null,</span>
<a href="#l14.668"></a><span id="l14.668">                       Stanza.node(&quot;query&quot;, Stanza.NS.roster, null, item));</span>
<a href="#l14.669"></a><span id="l14.669">     this._account.sendStanza(s);</span>
<a href="#l14.670"></a><span id="l14.670">   },</span>
<a href="#l14.671"></a><span id="l14.671"> </span>
<a href="#l14.672"></a><span id="l14.672" class="difflineminus">-  remove: function() {</span>
<a href="#l14.673"></a><span id="l14.673" class="difflineplus">+  remove() {</span>
<a href="#l14.674"></a><span id="l14.674">     if (!this._account.connected)</span>
<a href="#l14.675"></a><span id="l14.675">       return;</span>
<a href="#l14.676"></a><span id="l14.676"> </span>
<a href="#l14.677"></a><span id="l14.677">     let s = Stanza.iq(&quot;set&quot;, null, null,</span>
<a href="#l14.678"></a><span id="l14.678">                       Stanza.node(&quot;query&quot;, Stanza.NS.roster, null,</span>
<a href="#l14.679"></a><span id="l14.679">                                   Stanza.node(&quot;item&quot;, null,</span>
<a href="#l14.680"></a><span id="l14.680">                                               {jid: this.normalizedName,</span>
<a href="#l14.681"></a><span id="l14.681">                                                subscription: &quot;remove&quot;})));</span>
<a href="#l14.682"></a><span id="l14.682">     this._account.sendStanza(s);</span>
<a href="#l14.683"></a><span id="l14.683">   },</span>
<a href="#l14.684"></a><span id="l14.684"> </span>
<a href="#l14.685"></a><span id="l14.685">   _photoHash: null,</span>
<a href="#l14.686"></a><span id="l14.686" class="difflineminus">-  _saveIcon: function(aPhotoNode) {</span>
<a href="#l14.687"></a><span id="l14.687" class="difflineplus">+  _saveIcon(aPhotoNode) {</span>
<a href="#l14.688"></a><span id="l14.688">     // Some servers seem to send a photo node without a type declared.</span>
<a href="#l14.689"></a><span id="l14.689">     let type = aPhotoNode.getElement([&quot;TYPE&quot;]);</span>
<a href="#l14.690"></a><span id="l14.690">     if (!type)</span>
<a href="#l14.691"></a><span id="l14.691">       return;</span>
<a href="#l14.692"></a><span id="l14.692">     type = type.innerText;</span>
<a href="#l14.693"></a><span id="l14.693">     const kExt = {&quot;image/gif&quot;: &quot;gif&quot;, &quot;image/jpeg&quot;: &quot;jpg&quot;, &quot;image/png&quot;: &quot;png&quot;};</span>
<a href="#l14.694"></a><span id="l14.694">     if (!kExt.hasOwnProperty(type))</span>
<a href="#l14.695"></a><span id="l14.695">       return;</span>
<a href="#l14.696"></a><span id="l14.696" class="difflineat">@@ -1039,30 +1039,30 @@ var XMPPAccountBuddyPrototype = {</span>
<a href="#l14.697"></a><span id="l14.697">     NetUtil.asyncCopy(istream, ostream, function(rc) {</span>
<a href="#l14.698"></a><span id="l14.698">       if (Components.isSuccessCode(rc))</span>
<a href="#l14.699"></a><span id="l14.699">         buddy.buddyIconFilename = Services.io.newFileURI(file).spec;</span>
<a href="#l14.700"></a><span id="l14.700">     });</span>
<a href="#l14.701"></a><span id="l14.701">   },</span>
<a href="#l14.702"></a><span id="l14.702"> </span>
<a href="#l14.703"></a><span id="l14.703">   _preferredResource: undefined,</span>
<a href="#l14.704"></a><span id="l14.704">   _resources: null,</span>
<a href="#l14.705"></a><span id="l14.705" class="difflineminus">-  onAccountDisconnected: function() {</span>
<a href="#l14.706"></a><span id="l14.706" class="difflineplus">+  onAccountDisconnected() {</span>
<a href="#l14.707"></a><span id="l14.707">     delete this._preferredResource;</span>
<a href="#l14.708"></a><span id="l14.708">     delete this._resources;</span>
<a href="#l14.709"></a><span id="l14.709">   },</span>
<a href="#l14.710"></a><span id="l14.710">   // Called by the account when a presence stanza is received for this buddy.</span>
<a href="#l14.711"></a><span id="l14.711" class="difflineminus">-  onPresenceStanza: function(aStanza) {</span>
<a href="#l14.712"></a><span id="l14.712" class="difflineplus">+  onPresenceStanza(aStanza) {</span>
<a href="#l14.713"></a><span id="l14.713">     let preferred = this._preferredResource;</span>
<a href="#l14.714"></a><span id="l14.714"> </span>
<a href="#l14.715"></a><span id="l14.715">     // Facebook chat's XMPP server doesn't send resources, let's</span>
<a href="#l14.716"></a><span id="l14.716">     // replace undefined resources with empty resources.</span>
<a href="#l14.717"></a><span id="l14.717">     let resource =</span>
<a href="#l14.718"></a><span id="l14.718" class="difflineminus">-      this._account._parseJID(aStanza.attributes[&quot;from&quot;]).resource || &quot;&quot;;</span>
<a href="#l14.719"></a><span id="l14.719" class="difflineplus">+      this._account._parseJID(aStanza.attributes.from).resource || &quot;&quot;;</span>
<a href="#l14.720"></a><span id="l14.720"> </span>
<a href="#l14.721"></a><span id="l14.721" class="difflineminus">-    let type = aStanza.attributes[&quot;type&quot;];</span>
<a href="#l14.722"></a><span id="l14.722" class="difflineplus">+    let type = aStanza.attributes.type;</span>
<a href="#l14.723"></a><span id="l14.723"> </span>
<a href="#l14.724"></a><span id="l14.724">     // Reset typing status if the buddy is in a conversation and becomes unavailable.</span>
<a href="#l14.725"></a><span id="l14.725">     let conv = this._account._conv.get(this.normalizedName);</span>
<a href="#l14.726"></a><span id="l14.726">     if (type == &quot;unavailable&quot; &amp;&amp; conv)</span>
<a href="#l14.727"></a><span id="l14.727">       conv.updateTyping(Ci.prplIConvIM.NOT_TYPING, this.contactDisplayName);</span>
<a href="#l14.728"></a><span id="l14.728"> </span>
<a href="#l14.729"></a><span id="l14.729">     if (type == &quot;unavailable&quot; || type == &quot;error&quot;) {</span>
<a href="#l14.730"></a><span id="l14.730">       if (!this._resources || !(resource in this._resources))</span>
<a href="#l14.731"></a><span id="l14.731" class="difflineat">@@ -1077,18 +1077,18 @@ var XMPPAccountBuddyPrototype = {</span>
<a href="#l14.732"></a><span id="l14.732">       priority = priority ? parseInt(priority.innerText, 10) : 0;</span>
<a href="#l14.733"></a><span id="l14.733"> </span>
<a href="#l14.734"></a><span id="l14.734">       if (!this._resources)</span>
<a href="#l14.735"></a><span id="l14.735">         this._resources = {};</span>
<a href="#l14.736"></a><span id="l14.736">       this._resources[resource] = {</span>
<a href="#l14.737"></a><span id="l14.737">         statusType: statusInfo.statusType,</span>
<a href="#l14.738"></a><span id="l14.738">         statusText: statusInfo.statusText,</span>
<a href="#l14.739"></a><span id="l14.739">         idleSince: statusInfo.idleSince,</span>
<a href="#l14.740"></a><span id="l14.740" class="difflineminus">-        priority: priority,</span>
<a href="#l14.741"></a><span id="l14.741" class="difflineminus">-        stanza: aStanza</span>
<a href="#l14.742"></a><span id="l14.742" class="difflineplus">+        priority,</span>
<a href="#l14.743"></a><span id="l14.743" class="difflineplus">+        stanza: aStanza,</span>
<a href="#l14.744"></a><span id="l14.744">       };</span>
<a href="#l14.745"></a><span id="l14.745">     }</span>
<a href="#l14.746"></a><span id="l14.746"> </span>
<a href="#l14.747"></a><span id="l14.747">     let photo = aStanza.getElement([&quot;x&quot;, &quot;photo&quot;]);</span>
<a href="#l14.748"></a><span id="l14.748">     if (photo &amp;&amp; photo.uri == Stanza.NS.vcard_update) {</span>
<a href="#l14.749"></a><span id="l14.749">       let hash = photo.innerText;</span>
<a href="#l14.750"></a><span id="l14.750">       if (hash &amp;&amp; hash != this._photoHash)</span>
<a href="#l14.751"></a><span id="l14.751">         this._account._addVCardRequest(this.normalizedName);</span>
<a href="#l14.752"></a><span id="l14.752" class="difflineat">@@ -1132,19 +1132,19 @@ var XMPPAccountBuddyPrototype = {</span>
<a href="#l14.753"></a><span id="l14.753">       this.setStatus(preferred.statusType, preferred.statusText);</span>
<a href="#l14.754"></a><span id="l14.754">     }</span>
<a href="#l14.755"></a><span id="l14.755">   },</span>
<a href="#l14.756"></a><span id="l14.756"> </span>
<a href="#l14.757"></a><span id="l14.757">   /* Can send messages to buddies who appear offline */</span>
<a href="#l14.758"></a><span id="l14.758">   get canSendMessage() { return this.account.connected; },</span>
<a href="#l14.759"></a><span id="l14.759"> </span>
<a href="#l14.760"></a><span id="l14.760">   /* Called when the user wants to chat with the buddy */</span>
<a href="#l14.761"></a><span id="l14.761" class="difflineminus">-  createConversation: function() {</span>
<a href="#l14.762"></a><span id="l14.762" class="difflineplus">+  createConversation() {</span>
<a href="#l14.763"></a><span id="l14.763">     return this._account.createConversation(this.normalizedName);</span>
<a href="#l14.764"></a><span id="l14.764" class="difflineminus">-  }</span>
<a href="#l14.765"></a><span id="l14.765" class="difflineplus">+  },</span>
<a href="#l14.766"></a><span id="l14.766"> };</span>
<a href="#l14.767"></a><span id="l14.767"> function XMPPAccountBuddy(aAccount, aBuddy, aTag, aUserName)</span>
<a href="#l14.768"></a><span id="l14.768"> {</span>
<a href="#l14.769"></a><span id="l14.769">   this._init(aAccount, aBuddy, aTag, aUserName);</span>
<a href="#l14.770"></a><span id="l14.770"> }</span>
<a href="#l14.771"></a><span id="l14.771"> XMPPAccountBuddy.prototype = XMPPAccountBuddyPrototype;</span>
<a href="#l14.772"></a><span id="l14.772"> </span>
<a href="#l14.773"></a><span id="l14.773"> var XMPPRoomInfoPrototype = {</span>
<a href="#l14.774"></a><span id="l14.774" class="difflineat">@@ -1153,17 +1153,17 @@ var XMPPRoomInfoPrototype = {</span>
<a href="#l14.775"></a><span id="l14.775">     return &quot;&quot;;</span>
<a href="#l14.776"></a><span id="l14.776">   },</span>
<a href="#l14.777"></a><span id="l14.777">   get participantCount() {</span>
<a href="#l14.778"></a><span id="l14.778">     return Ci.prplIRoomInfo.NO_PARTICIPANT_COUNT;</span>
<a href="#l14.779"></a><span id="l14.779">   },</span>
<a href="#l14.780"></a><span id="l14.780">   get chatRoomFieldValues() {</span>
<a href="#l14.781"></a><span id="l14.781">     let roomJid = this._account._roomList.get(this.name);</span>
<a href="#l14.782"></a><span id="l14.782">     return this._account.getChatRoomDefaultFieldValues(roomJid);</span>
<a href="#l14.783"></a><span id="l14.783" class="difflineminus">-  }</span>
<a href="#l14.784"></a><span id="l14.784" class="difflineplus">+  },</span>
<a href="#l14.785"></a><span id="l14.785"> };</span>
<a href="#l14.786"></a><span id="l14.786"> function XMPPRoomInfo(aName, aAccount) {</span>
<a href="#l14.787"></a><span id="l14.787">   this.name = aName;</span>
<a href="#l14.788"></a><span id="l14.788">   this._account = aAccount;</span>
<a href="#l14.789"></a><span id="l14.789"> }</span>
<a href="#l14.790"></a><span id="l14.790"> XMPPRoomInfo.prototype = XMPPRoomInfoPrototype;</span>
<a href="#l14.791"></a><span id="l14.791"> </span>
<a href="#l14.792"></a><span id="l14.792"> /* Helper class for account */</span>
<a href="#l14.793"></a><span id="l14.793" class="difflineat">@@ -1198,17 +1198,17 @@ var XMPPAccountPrototype = {</span>
<a href="#l14.794"></a><span id="l14.794">   // If true, message carbons are currently enabled.</span>
<a href="#l14.795"></a><span id="l14.795">   _isCarbonsEnabled: false,</span>
<a href="#l14.796"></a><span id="l14.796"> </span>
<a href="#l14.797"></a><span id="l14.797">   /* Generate unique id for a stanza. Using id and unique sid is defined in</span>
<a href="#l14.798"></a><span id="l14.798">    * RFC 6120 (Section 8.2.3, 4.7.3).</span>
<a href="#l14.799"></a><span id="l14.799">    */</span>
<a href="#l14.800"></a><span id="l14.800">   generateId: () =&gt; UuidGenerator.generateUUID().toString().slice(1, -1),</span>
<a href="#l14.801"></a><span id="l14.801"> </span>
<a href="#l14.802"></a><span id="l14.802" class="difflineminus">-  _init: function(aProtoInstance, aImAccount) {</span>
<a href="#l14.803"></a><span id="l14.803" class="difflineplus">+  _init(aProtoInstance, aImAccount) {</span>
<a href="#l14.804"></a><span id="l14.804">     GenericAccountPrototype._init.call(this, aProtoInstance, aImAccount);</span>
<a href="#l14.805"></a><span id="l14.805"> </span>
<a href="#l14.806"></a><span id="l14.806">     // Ongoing conversations.</span>
<a href="#l14.807"></a><span id="l14.807">     // The keys of this._conv are assumed to be normalized like account@domain</span>
<a href="#l14.808"></a><span id="l14.808">     // for normal conversations and like room@domain/nick for MUC participant</span>
<a href="#l14.809"></a><span id="l14.809">     // convs.</span>
<a href="#l14.810"></a><span id="l14.810">     this._conv = new NormalizedMap(this.normalizeFullJid.bind(this));</span>
<a href="#l14.811"></a><span id="l14.811"> </span>
<a href="#l14.812"></a><span id="l14.812" class="difflineat">@@ -1216,55 +1216,55 @@ var XMPPAccountPrototype = {</span>
<a href="#l14.813"></a><span id="l14.813">     this._mucs = new NormalizedMap(this.normalize.bind(this));</span>
<a href="#l14.814"></a><span id="l14.814">   },</span>
<a href="#l14.815"></a><span id="l14.815"> </span>
<a href="#l14.816"></a><span id="l14.816">   get canJoinChat() { return true; },</span>
<a href="#l14.817"></a><span id="l14.817">   chatRoomFields: {</span>
<a href="#l14.818"></a><span id="l14.818">     room: {get label() { return _(&quot;chatRoomField.room&quot;); }, required: true},</span>
<a href="#l14.819"></a><span id="l14.819">     server: {get label() { return _(&quot;chatRoomField.server&quot;); }, required: true},</span>
<a href="#l14.820"></a><span id="l14.820">     nick: {get label() { return _(&quot;chatRoomField.nick&quot;); }, required: true},</span>
<a href="#l14.821"></a><span id="l14.821" class="difflineminus">-    password: {get label() { return _(&quot;chatRoomField.password&quot;); }, isPassword: true}</span>
<a href="#l14.822"></a><span id="l14.822" class="difflineplus">+    password: {get label() { return _(&quot;chatRoomField.password&quot;); }, isPassword: true},</span>
<a href="#l14.823"></a><span id="l14.823">   },</span>
<a href="#l14.824"></a><span id="l14.824" class="difflineminus">-  parseDefaultChatName: function(aDefaultChatName) {</span>
<a href="#l14.825"></a><span id="l14.825" class="difflineplus">+  parseDefaultChatName(aDefaultChatName) {</span>
<a href="#l14.826"></a><span id="l14.826">     if (!aDefaultChatName)</span>
<a href="#l14.827"></a><span id="l14.827">       return {nick: this._jid.node};</span>
<a href="#l14.828"></a><span id="l14.828"> </span>
<a href="#l14.829"></a><span id="l14.829">     let params = aDefaultChatName.trim().split(/\s+/);</span>
<a href="#l14.830"></a><span id="l14.830">     let jid = this._parseJID(params[0]);</span>
<a href="#l14.831"></a><span id="l14.831"> </span>
<a href="#l14.832"></a><span id="l14.832">     // We swap node and domain as domain is required for parseJID, but node and</span>
<a href="#l14.833"></a><span id="l14.833">     // resource are optional. In MUC join command, Node is required as it</span>
<a href="#l14.834"></a><span id="l14.834">     // represents a room, but domain and resource are optional as we get muc</span>
<a href="#l14.835"></a><span id="l14.835">     // domain from service discovery.</span>
<a href="#l14.836"></a><span id="l14.836">     if (!jid.node &amp;&amp; jid.domain)</span>
<a href="#l14.837"></a><span id="l14.837">       [jid.node, jid.domain] = [jid.domain, jid.node];</span>
<a href="#l14.838"></a><span id="l14.838"> </span>
<a href="#l14.839"></a><span id="l14.839">     let chatFields = {</span>
<a href="#l14.840"></a><span id="l14.840">       room: jid.node,</span>
<a href="#l14.841"></a><span id="l14.841">       server: jid.domain || this._mucService,</span>
<a href="#l14.842"></a><span id="l14.842" class="difflineminus">-      nick: jid.resource || this._jid.node</span>
<a href="#l14.843"></a><span id="l14.843" class="difflineplus">+      nick: jid.resource || this._jid.node,</span>
<a href="#l14.844"></a><span id="l14.844">     };</span>
<a href="#l14.845"></a><span id="l14.845">     if (params.length &gt; 1)</span>
<a href="#l14.846"></a><span id="l14.846">       chatFields.password = params[1];</span>
<a href="#l14.847"></a><span id="l14.847">     return chatFields;</span>
<a href="#l14.848"></a><span id="l14.848">   },</span>
<a href="#l14.849"></a><span id="l14.849" class="difflineminus">-  getChatRoomDefaultFieldValues: function(aDefaultChatName) {</span>
<a href="#l14.850"></a><span id="l14.850" class="difflineplus">+  getChatRoomDefaultFieldValues(aDefaultChatName) {</span>
<a href="#l14.851"></a><span id="l14.851">     let rv = GenericAccountPrototype.getChatRoomDefaultFieldValues</span>
<a href="#l14.852"></a><span id="l14.852">                                     .call(this, aDefaultChatName);</span>
<a href="#l14.853"></a><span id="l14.853">     if (!rv.values.nick)</span>
<a href="#l14.854"></a><span id="l14.854">       rv.values.nick = this._jid.node;</span>
<a href="#l14.855"></a><span id="l14.855">     if (!rv.values.server &amp;&amp; this._mucService)</span>
<a href="#l14.856"></a><span id="l14.856">       rv.values.server = this._mucService;</span>
<a href="#l14.857"></a><span id="l14.857"> </span>
<a href="#l14.858"></a><span id="l14.858">     return rv;</span>
<a href="#l14.859"></a><span id="l14.859">   },</span>
<a href="#l14.860"></a><span id="l14.860"> </span>
<a href="#l14.861"></a><span id="l14.861">   // XEP-0045: Requests joining room if it exists or</span>
<a href="#l14.862"></a><span id="l14.862">   // creating room if it does not exist.</span>
<a href="#l14.863"></a><span id="l14.863" class="difflineminus">-  joinChat: function(aComponents) {</span>
<a href="#l14.864"></a><span id="l14.864" class="difflineplus">+  joinChat(aComponents) {</span>
<a href="#l14.865"></a><span id="l14.865">     let jid =</span>
<a href="#l14.866"></a><span id="l14.866">       aComponents.getValue(&quot;room&quot;) + &quot;@&quot; + aComponents.getValue(&quot;server&quot;);</span>
<a href="#l14.867"></a><span id="l14.867">     let nick = aComponents.getValue(&quot;nick&quot;);</span>
<a href="#l14.868"></a><span id="l14.868"> </span>
<a href="#l14.869"></a><span id="l14.869">     let muc = this._mucs.get(jid);</span>
<a href="#l14.870"></a><span id="l14.870">     if (muc) {</span>
<a href="#l14.871"></a><span id="l14.871">       if (!muc.left)</span>
<a href="#l14.872"></a><span id="l14.872">         return muc; // We are already in this conversation.</span>
<a href="#l14.873"></a><span id="l14.873" class="difflineat">@@ -1292,17 +1292,17 @@ var XMPPAccountPrototype = {</span>
<a href="#l14.874"></a><span id="l14.874">         jid + &quot;/&quot; + nick + &quot; not logged)&quot;;</span>
<a href="#l14.875"></a><span id="l14.875">     }</span>
<a href="#l14.876"></a><span id="l14.876">     this.sendStanza(Stanza.presence({to: jid + &quot;/&quot; + nick}, x),</span>
<a href="#l14.877"></a><span id="l14.877">       undefined, undefined, logString);</span>
<a href="#l14.878"></a><span id="l14.878">     return muc;</span>
<a href="#l14.879"></a><span id="l14.879">   },</span>
<a href="#l14.880"></a><span id="l14.880"> </span>
<a href="#l14.881"></a><span id="l14.881">   _idleSince: 0,</span>
<a href="#l14.882"></a><span id="l14.882" class="difflineminus">-  observe: function(aSubject, aTopic, aData) {</span>
<a href="#l14.883"></a><span id="l14.883" class="difflineplus">+  observe(aSubject, aTopic, aData) {</span>
<a href="#l14.884"></a><span id="l14.884">     if (aTopic == &quot;idle-time-changed&quot;) {</span>
<a href="#l14.885"></a><span id="l14.885">       let idleTime = parseInt(aData, 10);</span>
<a href="#l14.886"></a><span id="l14.886">       if (idleTime)</span>
<a href="#l14.887"></a><span id="l14.887">         this._idleSince = Math.floor(Date.now() / 1000) - idleTime;</span>
<a href="#l14.888"></a><span id="l14.888">       else</span>
<a href="#l14.889"></a><span id="l14.889">         delete this._idleSince;</span>
<a href="#l14.890"></a><span id="l14.890">       this._shouldSendPresenceForIdlenessChange = true;</span>
<a href="#l14.891"></a><span id="l14.891">       executeSoon((function() {</span>
<a href="#l14.892"></a><span id="l14.892" class="difflineat">@@ -1319,17 +1319,17 @@ var XMPPAccountPrototype = {</span>
<a href="#l14.893"></a><span id="l14.893">     }</span>
<a href="#l14.894"></a><span id="l14.894">     else if (aTopic == &quot;user-display-name-changed&quot;)</span>
<a href="#l14.895"></a><span id="l14.895">       this._forceUserDisplayNameUpdate = true;</span>
<a href="#l14.896"></a><span id="l14.896">       this._sendVCard();</span>
<a href="#l14.897"></a><span id="l14.897">   },</span>
<a href="#l14.898"></a><span id="l14.898"> </span>
<a href="#l14.899"></a><span id="l14.899">   /* GenericAccountPrototype events */</span>
<a href="#l14.900"></a><span id="l14.900">   /* Connect to the server */</span>
<a href="#l14.901"></a><span id="l14.901" class="difflineminus">-  connect: function() {</span>
<a href="#l14.902"></a><span id="l14.902" class="difflineplus">+  connect() {</span>
<a href="#l14.903"></a><span id="l14.903">     this._jid = this._parseJID(this.name);</span>
<a href="#l14.904"></a><span id="l14.904"> </span>
<a href="#l14.905"></a><span id="l14.905">     // For the resource, if the user has edited the option, always use that.</span>
<a href="#l14.906"></a><span id="l14.906">     if (this.prefs.prefHasUserValue(&quot;resource&quot;)) {</span>
<a href="#l14.907"></a><span id="l14.907">       let resource = this.getString(&quot;resource&quot;);</span>
<a href="#l14.908"></a><span id="l14.908"> </span>
<a href="#l14.909"></a><span id="l14.909">       // this._jid needs to be updated. This value is however never used</span>
<a href="#l14.910"></a><span id="l14.910">       // because while connected it's the jid of the session that's</span>
<a href="#l14.911"></a><span id="l14.911" class="difflineat">@@ -1345,37 +1345,37 @@ var XMPPAccountPrototype = {</span>
<a href="#l14.912"></a><span id="l14.912"> </span>
<a href="#l14.913"></a><span id="l14.913">     this._connection =</span>
<a href="#l14.914"></a><span id="l14.914">       new XMPPSession(this.getString(&quot;server&quot;) || this._jid.domain,</span>
<a href="#l14.915"></a><span id="l14.915">                       this.getInt(&quot;port&quot;) || 5222,</span>
<a href="#l14.916"></a><span id="l14.916">                       this.getString(&quot;connection_security&quot;), this._jid,</span>
<a href="#l14.917"></a><span id="l14.917">                       this.imAccount.password, this);</span>
<a href="#l14.918"></a><span id="l14.918">   },</span>
<a href="#l14.919"></a><span id="l14.919"> </span>
<a href="#l14.920"></a><span id="l14.920" class="difflineminus">-  remove: function() {</span>
<a href="#l14.921"></a><span id="l14.921" class="difflineplus">+  remove() {</span>
<a href="#l14.922"></a><span id="l14.922">     this._conv.forEach(conv =&gt; conv.close());</span>
<a href="#l14.923"></a><span id="l14.923">     this._mucs.forEach(muc =&gt; muc.close());</span>
<a href="#l14.924"></a><span id="l14.924">     this._buddies.forEach((buddy, jid) =&gt; this._forgetRosterItem(jid));</span>
<a href="#l14.925"></a><span id="l14.925">   },</span>
<a href="#l14.926"></a><span id="l14.926"> </span>
<a href="#l14.927"></a><span id="l14.927" class="difflineminus">-  unInit: function() {</span>
<a href="#l14.928"></a><span id="l14.928" class="difflineplus">+  unInit() {</span>
<a href="#l14.929"></a><span id="l14.929">     if (this._connection)</span>
<a href="#l14.930"></a><span id="l14.930">       this._disconnect(undefined, undefined, true);</span>
<a href="#l14.931"></a><span id="l14.931">     delete this._jid;</span>
<a href="#l14.932"></a><span id="l14.932">     delete this._conv;</span>
<a href="#l14.933"></a><span id="l14.933">     delete this._buddies;</span>
<a href="#l14.934"></a><span id="l14.934">     delete this._mucs;</span>
<a href="#l14.935"></a><span id="l14.935">   },</span>
<a href="#l14.936"></a><span id="l14.936"> </span>
<a href="#l14.937"></a><span id="l14.937">   /* Disconnect from the server */</span>
<a href="#l14.938"></a><span id="l14.938" class="difflineminus">-  disconnect: function() {</span>
<a href="#l14.939"></a><span id="l14.939" class="difflineplus">+  disconnect() {</span>
<a href="#l14.940"></a><span id="l14.940">     this._disconnect();</span>
<a href="#l14.941"></a><span id="l14.941">   },</span>
<a href="#l14.942"></a><span id="l14.942"> </span>
<a href="#l14.943"></a><span id="l14.943" class="difflineminus">-  addBuddy: function(aTag, aName) {</span>
<a href="#l14.944"></a><span id="l14.944" class="difflineplus">+  addBuddy(aTag, aName) {</span>
<a href="#l14.945"></a><span id="l14.945">     if (!this._connection)</span>
<a href="#l14.946"></a><span id="l14.946">       throw &quot;The account isn't connected&quot;;</span>
<a href="#l14.947"></a><span id="l14.947"> </span>
<a href="#l14.948"></a><span id="l14.948">     let jid = this.normalize(aName);</span>
<a href="#l14.949"></a><span id="l14.949">     if (!jid || !jid.includes(&quot;@&quot;))</span>
<a href="#l14.950"></a><span id="l14.950">       throw &quot;Invalid username&quot;;</span>
<a href="#l14.951"></a><span id="l14.951"> </span>
<a href="#l14.952"></a><span id="l14.952">     if (this._buddies.has(jid)) {</span>
<a href="#l14.953"></a><span id="l14.953" class="difflineat">@@ -1383,48 +1383,48 @@ var XMPPAccountPrototype = {</span>
<a href="#l14.954"></a><span id="l14.954">       if (subscription &amp;&amp; (subscription == &quot;both&quot; || subscription == &quot;to&quot;)) {</span>
<a href="#l14.955"></a><span id="l14.955">         this.DEBUG(&quot;not re-adding an existing buddy&quot;);</span>
<a href="#l14.956"></a><span id="l14.956">         return;</span>
<a href="#l14.957"></a><span id="l14.957">       }</span>
<a href="#l14.958"></a><span id="l14.958">     }</span>
<a href="#l14.959"></a><span id="l14.959">     else {</span>
<a href="#l14.960"></a><span id="l14.960">       let s = Stanza.iq(&quot;set&quot;, null, null,</span>
<a href="#l14.961"></a><span id="l14.961">                         Stanza.node(&quot;query&quot;, Stanza.NS.roster, null,</span>
<a href="#l14.962"></a><span id="l14.962" class="difflineminus">-                                    Stanza.node(&quot;item&quot;, null, {jid: jid},</span>
<a href="#l14.963"></a><span id="l14.963" class="difflineplus">+                                    Stanza.node(&quot;item&quot;, null, {jid},</span>
<a href="#l14.964"></a><span id="l14.964">                                                 Stanza.node(&quot;group&quot;, null, null,</span>
<a href="#l14.965"></a><span id="l14.965">                                                             aTag.name))));</span>
<a href="#l14.966"></a><span id="l14.966">       this.sendStanza(s, this._handleResult({</span>
<a href="#l14.967"></a><span id="l14.967">         default: (aError) =&gt; {</span>
<a href="#l14.968"></a><span id="l14.968">           this.WARN(&quot;Unable to add a roster item due to &quot; + aError +</span>
<a href="#l14.969"></a><span id="l14.969">                     &quot; error.&quot;);</span>
<a href="#l14.970"></a><span id="l14.970" class="difflineminus">-        }</span>
<a href="#l14.971"></a><span id="l14.971" class="difflineplus">+        },</span>
<a href="#l14.972"></a><span id="l14.972">       }));</span>
<a href="#l14.973"></a><span id="l14.973">     }</span>
<a href="#l14.974"></a><span id="l14.974">     this.sendStanza(Stanza.presence({to: jid, type: &quot;subscribe&quot;}));</span>
<a href="#l14.975"></a><span id="l14.975">   },</span>
<a href="#l14.976"></a><span id="l14.976"> </span>
<a href="#l14.977"></a><span id="l14.977">   /* Loads a buddy from the local storage.</span>
<a href="#l14.978"></a><span id="l14.978">    * Called for each buddy locally stored before connecting</span>
<a href="#l14.979"></a><span id="l14.979">    * to the server. */</span>
<a href="#l14.980"></a><span id="l14.980" class="difflineminus">-  loadBuddy: function(aBuddy, aTag) {</span>
<a href="#l14.981"></a><span id="l14.981" class="difflineplus">+  loadBuddy(aBuddy, aTag) {</span>
<a href="#l14.982"></a><span id="l14.982">     let buddy = new this._accountBuddyConstructor(this, aBuddy, aTag);</span>
<a href="#l14.983"></a><span id="l14.983">     this._buddies.set(buddy.normalizedName, buddy);</span>
<a href="#l14.984"></a><span id="l14.984">     return buddy;</span>
<a href="#l14.985"></a><span id="l14.985">   },</span>
<a href="#l14.986"></a><span id="l14.986"> </span>
<a href="#l14.987"></a><span id="l14.987">   /* Replies to a buddy request in order to accept it or deny it. */</span>
<a href="#l14.988"></a><span id="l14.988" class="difflineminus">-  replyToBuddyRequest: function(aReply, aRequest) {</span>
<a href="#l14.989"></a><span id="l14.989" class="difflineplus">+  replyToBuddyRequest(aReply, aRequest) {</span>
<a href="#l14.990"></a><span id="l14.990">     if (!this._connection)</span>
<a href="#l14.991"></a><span id="l14.991">       return;</span>
<a href="#l14.992"></a><span id="l14.992" class="difflineminus">-    let s = Stanza.presence({to: aRequest.userName, type: aReply})</span>
<a href="#l14.993"></a><span id="l14.993" class="difflineplus">+    let s = Stanza.presence({to: aRequest.userName, type: aReply});</span>
<a href="#l14.994"></a><span id="l14.994">     this.sendStanza(s);</span>
<a href="#l14.995"></a><span id="l14.995">     this.removeBuddyRequest(aRequest);</span>
<a href="#l14.996"></a><span id="l14.996">   },</span>
<a href="#l14.997"></a><span id="l14.997"> </span>
<a href="#l14.998"></a><span id="l14.998" class="difflineminus">-  requestBuddyInfo: function(aJid) {</span>
<a href="#l14.999"></a><span id="l14.999" class="difflineplus">+  requestBuddyInfo(aJid) {</span>
<a href="#l14.1000"></a><span id="l14.1000">     if (!this.connected) {</span>
<a href="#l14.1001"></a><span id="l14.1001">       Services.obs.notifyObservers(EmptyEnumerator, &quot;user-info-received&quot;, aJid);</span>
<a href="#l14.1002"></a><span id="l14.1002">       return;</span>
<a href="#l14.1003"></a><span id="l14.1003">     }</span>
<a href="#l14.1004"></a><span id="l14.1004"> </span>
<a href="#l14.1005"></a><span id="l14.1005">     let userName;</span>
<a href="#l14.1006"></a><span id="l14.1006">     let tooltipInfo = [];</span>
<a href="#l14.1007"></a><span id="l14.1007">     let jid = this._parseJID(aJid);</span>
<a href="#l14.1008"></a><span id="l14.1008" class="difflineat">@@ -1453,17 +1453,17 @@ var XMPPAccountPrototype = {</span>
<a href="#l14.1009"></a><span id="l14.1009"> </span>
<a href="#l14.1010"></a><span id="l14.1010">     let iq = Stanza.iq(&quot;get&quot;, null, aJid, Stanza.node(&quot;vCard&quot;, Stanza.NS.vcard));</span>
<a href="#l14.1011"></a><span id="l14.1011">     this.sendStanza(iq, aStanza =&gt; {</span>
<a href="#l14.1012"></a><span id="l14.1012">       let vCardInfo = {};</span>
<a href="#l14.1013"></a><span id="l14.1013">       let vCardNode = aStanza.getElement([&quot;vCard&quot;]);</span>
<a href="#l14.1014"></a><span id="l14.1014"> </span>
<a href="#l14.1015"></a><span id="l14.1015">       // In the case of an error response, we just notify the observers with</span>
<a href="#l14.1016"></a><span id="l14.1016">       // what info we already have.</span>
<a href="#l14.1017"></a><span id="l14.1017" class="difflineminus">-      if (aStanza.attributes[&quot;type&quot;] == &quot;result&quot; &amp;&amp; vCardNode)</span>
<a href="#l14.1018"></a><span id="l14.1018" class="difflineplus">+      if (aStanza.attributes.type == &quot;result&quot; &amp;&amp; vCardNode)</span>
<a href="#l14.1019"></a><span id="l14.1019">         vCardInfo = this.parseVCard(vCardNode);</span>
<a href="#l14.1020"></a><span id="l14.1020"> </span>
<a href="#l14.1021"></a><span id="l14.1021">       // The real jid of participant which is of the form local@domain/resource.</span>
<a href="#l14.1022"></a><span id="l14.1022">       // We consider the jid is provided by server is more correct than jid is</span>
<a href="#l14.1023"></a><span id="l14.1023">       // set by the user.</span>
<a href="#l14.1024"></a><span id="l14.1024">       if (userName)</span>
<a href="#l14.1025"></a><span id="l14.1025">         vCardInfo.userName = userName;</span>
<a href="#l14.1026"></a><span id="l14.1026"> </span>
<a href="#l14.1027"></a><span id="l14.1027" class="difflineat">@@ -1488,30 +1488,30 @@ var XMPPAccountPrototype = {</span>
<a href="#l14.1028"></a><span id="l14.1028">       }</span>
<a href="#l14.1029"></a><span id="l14.1029">       Services.obs.notifyObservers(new nsSimpleEnumerator(tooltipInfo),</span>
<a href="#l14.1030"></a><span id="l14.1030">                                    &quot;user-info-received&quot;, aJid);</span>
<a href="#l14.1031"></a><span id="l14.1031">     });</span>
<a href="#l14.1032"></a><span id="l14.1032">   },</span>
<a href="#l14.1033"></a><span id="l14.1033"> </span>
<a href="#l14.1034"></a><span id="l14.1034">   // Parses the photo node of a received vCard if exists and returns string of</span>
<a href="#l14.1035"></a><span id="l14.1035">   // data URI, otherwise returns null.</span>
<a href="#l14.1036"></a><span id="l14.1036" class="difflineminus">-  _getPhotoURI: function(aPhotoNode) {</span>
<a href="#l14.1037"></a><span id="l14.1037" class="difflineplus">+  _getPhotoURI(aPhotoNode) {</span>
<a href="#l14.1038"></a><span id="l14.1038">     if (!aPhotoNode)</span>
<a href="#l14.1039"></a><span id="l14.1039">       return null;</span>
<a href="#l14.1040"></a><span id="l14.1040"> </span>
<a href="#l14.1041"></a><span id="l14.1041">     let type = aPhotoNode.getElement([&quot;TYPE&quot;]);</span>
<a href="#l14.1042"></a><span id="l14.1042">     let value = aPhotoNode.getElement([&quot;BINVAL&quot;]);</span>
<a href="#l14.1043"></a><span id="l14.1043">     if (!type || !value)</span>
<a href="#l14.1044"></a><span id="l14.1044">       return null;</span>
<a href="#l14.1045"></a><span id="l14.1045"> </span>
<a href="#l14.1046"></a><span id="l14.1046">     return &quot;data:&quot; + type.innerText + &quot;;base64,&quot; + value.innerText;</span>
<a href="#l14.1047"></a><span id="l14.1047">   },</span>
<a href="#l14.1048"></a><span id="l14.1048"> </span>
<a href="#l14.1049"></a><span id="l14.1049">   // Parses the vCard into the properties of the returned object.</span>
<a href="#l14.1050"></a><span id="l14.1050" class="difflineminus">-  parseVCard: function(aVCardNode) {</span>
<a href="#l14.1051"></a><span id="l14.1051" class="difflineplus">+  parseVCard(aVCardNode) {</span>
<a href="#l14.1052"></a><span id="l14.1052">     // XEP-0054: vcard-temp.</span>
<a href="#l14.1053"></a><span id="l14.1053">     let aResult = {};</span>
<a href="#l14.1054"></a><span id="l14.1054">     for (let node of aVCardNode.children.filter(child =&gt; child.type == &quot;node&quot;)) {</span>
<a href="#l14.1055"></a><span id="l14.1055">       let localName = node.localName;</span>
<a href="#l14.1056"></a><span id="l14.1056">       let innerText = node.innerText;</span>
<a href="#l14.1057"></a><span id="l14.1057">       if (innerText) {</span>
<a href="#l14.1058"></a><span id="l14.1058">         if (localName == &quot;FN&quot;)</span>
<a href="#l14.1059"></a><span id="l14.1059">           aResult.fullName = innerText;</span>
<a href="#l14.1060"></a><span id="l14.1060" class="difflineat">@@ -1549,29 +1549,29 @@ var XMPPAccountPrototype = {</span>
<a href="#l14.1061"></a><span id="l14.1061">       // in response to /whois.</span>
<a href="#l14.1062"></a><span id="l14.1062">     }</span>
<a href="#l14.1063"></a><span id="l14.1063">     return aResult;</span>
<a href="#l14.1064"></a><span id="l14.1064">   },</span>
<a href="#l14.1065"></a><span id="l14.1065"> </span>
<a href="#l14.1066"></a><span id="l14.1066">   // Returns undefined if not an error stanza, and an object</span>
<a href="#l14.1067"></a><span id="l14.1067">   // describing the error otherwise:</span>
<a href="#l14.1068"></a><span id="l14.1068">   parseError(aStanza) {</span>
<a href="#l14.1069"></a><span id="l14.1069" class="difflineminus">-    if (aStanza.attributes[&quot;type&quot;] != &quot;error&quot;)</span>
<a href="#l14.1070"></a><span id="l14.1070" class="difflineplus">+    if (aStanza.attributes.type != &quot;error&quot;)</span>
<a href="#l14.1071"></a><span id="l14.1071">       return undefined;</span>
<a href="#l14.1072"></a><span id="l14.1072"> </span>
<a href="#l14.1073"></a><span id="l14.1073">     let retval = {stanza: aStanza};</span>
<a href="#l14.1074"></a><span id="l14.1074">     let error = aStanza.getElement([&quot;error&quot;]);</span>
<a href="#l14.1075"></a><span id="l14.1075"> </span>
<a href="#l14.1076"></a><span id="l14.1076">     // RFC 6120 Section 8.3.2: Type must be one of</span>
<a href="#l14.1077"></a><span id="l14.1077">     // auth -- retry after providing credentials</span>
<a href="#l14.1078"></a><span id="l14.1078">     // cancel -- do not retry (the error cannot be remedied)</span>
<a href="#l14.1079"></a><span id="l14.1079">     // continue -- proceed (the condition was only a warning)</span>
<a href="#l14.1080"></a><span id="l14.1080">     // modify -- retry after changing the data sent</span>
<a href="#l14.1081"></a><span id="l14.1081">     // wait -- retry after waiting (the error is temporary).</span>
<a href="#l14.1082"></a><span id="l14.1082" class="difflineminus">-    retval.type = error.attributes[&quot;type&quot;];</span>
<a href="#l14.1083"></a><span id="l14.1083" class="difflineplus">+    retval.type = error.attributes.type;</span>
<a href="#l14.1084"></a><span id="l14.1084"> </span>
<a href="#l14.1085"></a><span id="l14.1085">     // RFC 6120 Section 8.3.3.</span>
<a href="#l14.1086"></a><span id="l14.1086">     const kDefinedConditions = [</span>
<a href="#l14.1087"></a><span id="l14.1087">       &quot;bad-request&quot;,</span>
<a href="#l14.1088"></a><span id="l14.1088">       &quot;conflict&quot;,</span>
<a href="#l14.1089"></a><span id="l14.1089">       &quot;feature-not-implemented&quot;,</span>
<a href="#l14.1090"></a><span id="l14.1090">       &quot;forbidden&quot;,</span>
<a href="#l14.1091"></a><span id="l14.1091">       &quot;gone&quot;,</span>
<a href="#l14.1092"></a><span id="l14.1092" class="difflineat">@@ -1586,17 +1586,17 @@ var XMPPAccountPrototype = {</span>
<a href="#l14.1093"></a><span id="l14.1093">       &quot;redirect&quot;,</span>
<a href="#l14.1094"></a><span id="l14.1094">       &quot;registration-required&quot;,</span>
<a href="#l14.1095"></a><span id="l14.1095">       &quot;remote-server-not-found&quot;,</span>
<a href="#l14.1096"></a><span id="l14.1096">       &quot;remote-server-timeout&quot;,</span>
<a href="#l14.1097"></a><span id="l14.1097">       &quot;resource-constraint&quot;,</span>
<a href="#l14.1098"></a><span id="l14.1098">       &quot;service-unavailable&quot;,</span>
<a href="#l14.1099"></a><span id="l14.1099">       &quot;subscription-required&quot;,</span>
<a href="#l14.1100"></a><span id="l14.1100">       &quot;undefined-condition&quot;,</span>
<a href="#l14.1101"></a><span id="l14.1101" class="difflineminus">-      &quot;unexpected-request&quot;</span>
<a href="#l14.1102"></a><span id="l14.1102" class="difflineplus">+      &quot;unexpected-request&quot;,</span>
<a href="#l14.1103"></a><span id="l14.1103">     ];</span>
<a href="#l14.1104"></a><span id="l14.1104">     let condition = kDefinedConditions.find(c =&gt; error.getElement([c]));</span>
<a href="#l14.1105"></a><span id="l14.1105">     if (!condition) {</span>
<a href="#l14.1106"></a><span id="l14.1106">       // RFC 6120 Section 8.3.2.</span>
<a href="#l14.1107"></a><span id="l14.1107">       this.WARN(&quot;Nonstandard or missing defined-condition element in &quot; +</span>
<a href="#l14.1108"></a><span id="l14.1108">         &quot;error stanza.&quot;);</span>
<a href="#l14.1109"></a><span id="l14.1109">       condition = &quot;undefined-condition&quot;;</span>
<a href="#l14.1110"></a><span id="l14.1110">     }</span>
<a href="#l14.1111"></a><span id="l14.1111" class="difflineat">@@ -1629,49 +1629,48 @@ var XMPPAccountPrototype = {</span>
<a href="#l14.1112"></a><span id="l14.1112">         return false;</span>
<a href="#l14.1113"></a><span id="l14.1113"> </span>
<a href="#l14.1114"></a><span id="l14.1114">       let toCamelCase = aStr =&gt; {</span>
<a href="#l14.1115"></a><span id="l14.1115">         // Turn defined condition string into a valid camelcase</span>
<a href="#l14.1116"></a><span id="l14.1116">         // JS property name.</span>
<a href="#l14.1117"></a><span id="l14.1117">         let capitalize = s =&gt; (s[0].toUpperCase() + s.slice(1));</span>
<a href="#l14.1118"></a><span id="l14.1118">         let uncapitalize = s =&gt; (s[0].toLowerCase() + s.slice(1));</span>
<a href="#l14.1119"></a><span id="l14.1119">         return uncapitalize(aStr.split(&quot;-&quot;).map(capitalize).join(&quot;&quot;));</span>
<a href="#l14.1120"></a><span id="l14.1120" class="difflineminus">-      }</span>
<a href="#l14.1121"></a><span id="l14.1121" class="difflineplus">+      };</span>
<a href="#l14.1122"></a><span id="l14.1122">       let condition = toCamelCase(error.condition);</span>
<a href="#l14.1123"></a><span id="l14.1123">       // Check if we have a handler property for this kind of error or a</span>
<a href="#l14.1124"></a><span id="l14.1124">       // default handler.</span>
<a href="#l14.1125"></a><span id="l14.1125">       if (!(condition in aHandlers) &amp;&amp; !(&quot;default&quot; in aHandlers))</span>
<a href="#l14.1126"></a><span id="l14.1126">         return false;</span>
<a href="#l14.1127"></a><span id="l14.1127"> </span>
<a href="#l14.1128"></a><span id="l14.1128">       // Try to get the handler for condition, if we cannot get it, try to get</span>
<a href="#l14.1129"></a><span id="l14.1129">       // the default handler.</span>
<a href="#l14.1130"></a><span id="l14.1130">       let handler = aHandlers[condition];</span>
<a href="#l14.1131"></a><span id="l14.1131">       if (!handler)</span>
<a href="#l14.1132"></a><span id="l14.1132" class="difflineminus">-        handler = aHandlers[&quot;default&quot;];</span>
<a href="#l14.1133"></a><span id="l14.1133" class="difflineplus">+        handler = aHandlers.default;</span>
<a href="#l14.1134"></a><span id="l14.1134"> </span>
<a href="#l14.1135"></a><span id="l14.1135">       if (typeof handler == &quot;string&quot;) {</span>
<a href="#l14.1136"></a><span id="l14.1136">         // The string is an error message to be displayed in the conversation.</span>
<a href="#l14.1137"></a><span id="l14.1137">         if (!aThis || !aThis.writeMessage) {</span>
<a href="#l14.1138"></a><span id="l14.1138">           this.ERROR(&quot;HandleErrors was passed an error message string, but &quot; +</span>
<a href="#l14.1139"></a><span id="l14.1139">             &quot;no conversation to display it in:\n&quot; + handler);</span>
<a href="#l14.1140"></a><span id="l14.1140">           return true;</span>
<a href="#l14.1141"></a><span id="l14.1141">         }</span>
<a href="#l14.1142"></a><span id="l14.1142">         aThis.writeMessage(aThis.name, handler, {system: true, error: true});</span>
<a href="#l14.1143"></a><span id="l14.1143">         return true;</span>
<a href="#l14.1144"></a><span id="l14.1144">       }</span>
<a href="#l14.1145"></a><span id="l14.1145">       else if (typeof handler == &quot;function&quot;) {</span>
<a href="#l14.1146"></a><span id="l14.1146">         // If we're given a function, call this error handler.</span>
<a href="#l14.1147"></a><span id="l14.1147">         return handler.call(aThis, error);</span>
<a href="#l14.1148"></a><span id="l14.1148">       }</span>
<a href="#l14.1149"></a><span id="l14.1149" class="difflineminus">-      else {</span>
<a href="#l14.1150"></a><span id="l14.1150" class="difflineminus">-        // If this happens, there's a bug somewhere.</span>
<a href="#l14.1151"></a><span id="l14.1151" class="difflineminus">-        this.ERROR(&quot;HandleErrors was passed a handler for '&quot; + condition +</span>
<a href="#l14.1152"></a><span id="l14.1152" class="difflineminus">-          &quot;'' which is neither a function nor a string.&quot;);</span>
<a href="#l14.1153"></a><span id="l14.1153" class="difflineminus">-        return false;</span>
<a href="#l14.1154"></a><span id="l14.1154" class="difflineminus">-      }</span>
<a href="#l14.1155"></a><span id="l14.1155" class="difflineplus">+</span>
<a href="#l14.1156"></a><span id="l14.1156" class="difflineplus">+      // If this happens, there's a bug somewhere.</span>
<a href="#l14.1157"></a><span id="l14.1157" class="difflineplus">+      this.ERROR(&quot;HandleErrors was passed a handler for '&quot; + condition +</span>
<a href="#l14.1158"></a><span id="l14.1158" class="difflineplus">+        &quot;'' which is neither a function nor a string.&quot;);</span>
<a href="#l14.1159"></a><span id="l14.1159" class="difflineplus">+      return false;</span>
<a href="#l14.1160"></a><span id="l14.1160">     };</span>
<a href="#l14.1161"></a><span id="l14.1161">   },</span>
<a href="#l14.1162"></a><span id="l14.1162"> </span>
<a href="#l14.1163"></a><span id="l14.1163">   // Send an error stanza in response to the given stanza (rfc6120#8.3).</span>
<a href="#l14.1164"></a><span id="l14.1164">   // aCondition is the name of the defined-condition child, aText an</span>
<a href="#l14.1165"></a><span id="l14.1165">   // optional plain-text description.</span>
<a href="#l14.1166"></a><span id="l14.1166">   sendErrorStanza(aStanza, aCondition, aType, aText) {</span>
<a href="#l14.1167"></a><span id="l14.1167">     // TODO: Support the other stanza types (message, presence).</span>
<a href="#l14.1168"></a><span id="l14.1168" class="difflineat">@@ -1688,28 +1687,28 @@ var XMPPAccountPrototype = {</span>
<a href="#l14.1169"></a><span id="l14.1169">       error.addChild(Stanza.node(&quot;text&quot;, Stanza.NS.stanzas, null, aText));</span>
<a href="#l14.1170"></a><span id="l14.1170">     return this.sendStanza(Stanza.iq(&quot;error&quot;, aStanza.attributes.id,</span>
<a href="#l14.1171"></a><span id="l14.1171">       aStanza.attributes.from, error));</span>
<a href="#l14.1172"></a><span id="l14.1172">   },</span>
<a href="#l14.1173"></a><span id="l14.1173"> </span>
<a href="#l14.1174"></a><span id="l14.1174">   // Returns a callback suitable for use in sendStanza, to handle type==result</span>
<a href="#l14.1175"></a><span id="l14.1175">   // responses. aHandlers and aThis are passed on to handleErrors for error</span>
<a href="#l14.1176"></a><span id="l14.1176">   // handling.</span>
<a href="#l14.1177"></a><span id="l14.1177" class="difflineminus">-  _handleResult: function(aHandlers, aThis) {</span>
<a href="#l14.1178"></a><span id="l14.1178" class="difflineplus">+  _handleResult(aHandlers, aThis) {</span>
<a href="#l14.1179"></a><span id="l14.1179">     return aStanza =&gt; {</span>
<a href="#l14.1180"></a><span id="l14.1180" class="difflineminus">-      if (aStanza.attributes[&quot;type&quot;] == &quot;result&quot;)</span>
<a href="#l14.1181"></a><span id="l14.1181" class="difflineplus">+      if (aStanza.attributes.type == &quot;result&quot;)</span>
<a href="#l14.1182"></a><span id="l14.1182">         return true;</span>
<a href="#l14.1183"></a><span id="l14.1183">       return this.handleErrors(aHandlers, aThis)(aStanza);</span>
<a href="#l14.1184"></a><span id="l14.1184" class="difflineminus">-    }</span>
<a href="#l14.1185"></a><span id="l14.1185" class="difflineplus">+    };</span>
<a href="#l14.1186"></a><span id="l14.1186">   },</span>
<a href="#l14.1187"></a><span id="l14.1187"> </span>
<a href="#l14.1188"></a><span id="l14.1188">   /* XMPPSession events */</span>
<a href="#l14.1189"></a><span id="l14.1189"> </span>
<a href="#l14.1190"></a><span id="l14.1190">   /* Called when the XMPP session is started */</span>
<a href="#l14.1191"></a><span id="l14.1191" class="difflineminus">-  onConnection: function() {</span>
<a href="#l14.1192"></a><span id="l14.1192" class="difflineplus">+  onConnection() {</span>
<a href="#l14.1193"></a><span id="l14.1193">     // Request the roster. The account will be marked as connected when this is</span>
<a href="#l14.1194"></a><span id="l14.1194">     // complete.</span>
<a href="#l14.1195"></a><span id="l14.1195">     this.reportConnecting(_(&quot;connection.downloadingRoster&quot;));</span>
<a href="#l14.1196"></a><span id="l14.1196">     let s = Stanza.iq(&quot;get&quot;, null, null, Stanza.node(&quot;query&quot;, Stanza.NS.roster));</span>
<a href="#l14.1197"></a><span id="l14.1197">     this.sendStanza(s, this.onRoster, this);</span>
<a href="#l14.1198"></a><span id="l14.1198"> </span>
<a href="#l14.1199"></a><span id="l14.1199">     // XEP-0030 and XEP-0045 (6): Service Discovery.</span>
<a href="#l14.1200"></a><span id="l14.1200">     // Queries Server for Associated Services.</span>
<a href="#l14.1201"></a><span id="l14.1201" class="difflineat">@@ -1719,46 +1718,46 @@ var XMPPAccountPrototype = {</span>
<a href="#l14.1202"></a><span id="l14.1202"> </span>
<a href="#l14.1203"></a><span id="l14.1203">     // XEP-0030: Service Discovery Information Features.</span>
<a href="#l14.1204"></a><span id="l14.1204">     iq = Stanza.iq(&quot;get&quot;, null, this._jid.domain,</span>
<a href="#l14.1205"></a><span id="l14.1205">                        Stanza.node(&quot;query&quot;, Stanza.NS.disco_info));</span>
<a href="#l14.1206"></a><span id="l14.1206">     this.sendStanza(iq, this.onServiceDiscoveryInfo, this);</span>
<a href="#l14.1207"></a><span id="l14.1207">   },</span>
<a href="#l14.1208"></a><span id="l14.1208"> </span>
<a href="#l14.1209"></a><span id="l14.1209">   /* Called whenever a stanza is received */</span>
<a href="#l14.1210"></a><span id="l14.1210" class="difflineminus">-  onXmppStanza: function(aStanza) {</span>
<a href="#l14.1211"></a><span id="l14.1211" class="difflineplus">+  onXmppStanza(aStanza) {</span>
<a href="#l14.1212"></a><span id="l14.1212">   },</span>
<a href="#l14.1213"></a><span id="l14.1213"> </span>
<a href="#l14.1214"></a><span id="l14.1214">   /* Called when a iq stanza is received */</span>
<a href="#l14.1215"></a><span id="l14.1215" class="difflineminus">-  onIQStanza: function(aStanza) {</span>
<a href="#l14.1216"></a><span id="l14.1216" class="difflineminus">-    let type = aStanza.attributes[&quot;type&quot;];</span>
<a href="#l14.1217"></a><span id="l14.1217" class="difflineplus">+  onIQStanza(aStanza) {</span>
<a href="#l14.1218"></a><span id="l14.1218" class="difflineplus">+    let type = aStanza.attributes.type;</span>
<a href="#l14.1219"></a><span id="l14.1219">     if (type == &quot;set&quot;) {</span>
<a href="#l14.1220"></a><span id="l14.1220">       for (let query of aStanza.getChildren(&quot;query&quot;)) {</span>
<a href="#l14.1221"></a><span id="l14.1221">         if (query.uri != Stanza.NS.roster)</span>
<a href="#l14.1222"></a><span id="l14.1222">           continue;</span>
<a href="#l14.1223"></a><span id="l14.1223"> </span>
<a href="#l14.1224"></a><span id="l14.1224">         // RFC 6121 2.1.6 (Roster push):</span>
<a href="#l14.1225"></a><span id="l14.1225">         // A receiving client MUST ignore the stanza unless it has no 'from'</span>
<a href="#l14.1226"></a><span id="l14.1226">         // attribute (i.e., implicitly from the bare JID of the user's</span>
<a href="#l14.1227"></a><span id="l14.1227">         // account) or it has a 'from' attribute whose value matches the</span>
<a href="#l14.1228"></a><span id="l14.1228">         // user's bare JID &lt;user@domainpart&gt;.</span>
<a href="#l14.1229"></a><span id="l14.1229" class="difflineminus">-        let from = aStanza.attributes[&quot;from&quot;];</span>
<a href="#l14.1230"></a><span id="l14.1230" class="difflineplus">+        let from = aStanza.attributes.from;</span>
<a href="#l14.1231"></a><span id="l14.1231">         if (from &amp;&amp; from != this._jid.node + &quot;@&quot; + this._jid.domain) {</span>
<a href="#l14.1232"></a><span id="l14.1232">           this.WARN(&quot;Ignoring potentially spoofed roster push.&quot;);</span>
<a href="#l14.1233"></a><span id="l14.1233">           return;</span>
<a href="#l14.1234"></a><span id="l14.1234">         }</span>
<a href="#l14.1235"></a><span id="l14.1235"> </span>
<a href="#l14.1236"></a><span id="l14.1236">         for (let item of query.getChildren(&quot;item&quot;))</span>
<a href="#l14.1237"></a><span id="l14.1237">           this._onRosterItem(item, true);</span>
<a href="#l14.1238"></a><span id="l14.1238">         return;</span>
<a href="#l14.1239"></a><span id="l14.1239">       }</span>
<a href="#l14.1240"></a><span id="l14.1240">     }</span>
<a href="#l14.1241"></a><span id="l14.1241">     else if (type == &quot;get&quot;) {</span>
<a href="#l14.1242"></a><span id="l14.1242" class="difflineminus">-      let id = aStanza.attributes[&quot;id&quot;];</span>
<a href="#l14.1243"></a><span id="l14.1243" class="difflineminus">-      let from = aStanza.attributes[&quot;from&quot;];</span>
<a href="#l14.1244"></a><span id="l14.1244" class="difflineplus">+      let id = aStanza.attributes.id;</span>
<a href="#l14.1245"></a><span id="l14.1245" class="difflineplus">+      let from = aStanza.attributes.from;</span>
<a href="#l14.1246"></a><span id="l14.1246"> </span>
<a href="#l14.1247"></a><span id="l14.1247">       // XEP-0199: XMPP server-to-client ping (XEP-0199)</span>
<a href="#l14.1248"></a><span id="l14.1248">       let ping = aStanza.getElement([&quot;ping&quot;]);</span>
<a href="#l14.1249"></a><span id="l14.1249">       if (ping &amp;&amp; ping.uri == Stanza.NS.ping) {</span>
<a href="#l14.1250"></a><span id="l14.1250">         if (from == this._jid.domain)</span>
<a href="#l14.1251"></a><span id="l14.1251">           this.sendStanza(Stanza.iq(&quot;result&quot;, id, this._jid.domain));</span>
<a href="#l14.1252"></a><span id="l14.1252">         return;</span>
<a href="#l14.1253"></a><span id="l14.1253">       }</span>
<a href="#l14.1254"></a><span id="l14.1254" class="difflineat">@@ -1773,17 +1772,17 @@ var XMPPAccountPrototype = {</span>
<a href="#l14.1255"></a><span id="l14.1255">         let versionQuery = Stanza.node(&quot;query&quot;, Stanza.NS.version, null,</span>
<a href="#l14.1256"></a><span id="l14.1256">                                        children);</span>
<a href="#l14.1257"></a><span id="l14.1257">         this.sendStanza(Stanza.iq(&quot;result&quot;, id, from, versionQuery));</span>
<a href="#l14.1258"></a><span id="l14.1258">         return;</span>
<a href="#l14.1259"></a><span id="l14.1259">       }</span>
<a href="#l14.1260"></a><span id="l14.1260">       if (query &amp;&amp; query.uri == Stanza.NS.disco_info) {</span>
<a href="#l14.1261"></a><span id="l14.1261">         // XEP-0030: Service Discovery.</span>
<a href="#l14.1262"></a><span id="l14.1262">         let children = [];</span>
<a href="#l14.1263"></a><span id="l14.1263" class="difflineminus">-        if (aStanza.attributes[&quot;node&quot;] == Stanza.NS.muc_rooms) {</span>
<a href="#l14.1264"></a><span id="l14.1264" class="difflineplus">+        if (aStanza.attributes.node == Stanza.NS.muc_rooms) {</span>
<a href="#l14.1265"></a><span id="l14.1265">           // XEP-0045 (6.7): Room query.</span>
<a href="#l14.1266"></a><span id="l14.1266">           // TODO: Currently, we return an empty &lt;query/&gt; element, but we</span>
<a href="#l14.1267"></a><span id="l14.1267">           // should return non-private rooms.</span>
<a href="#l14.1268"></a><span id="l14.1268">         }</span>
<a href="#l14.1269"></a><span id="l14.1269">         else {</span>
<a href="#l14.1270"></a><span id="l14.1270">           children = SupportedFeatures.map(feature =&gt;</span>
<a href="#l14.1271"></a><span id="l14.1271">             Stanza.node(&quot;feature&quot;, null, {var: feature})</span>
<a href="#l14.1272"></a><span id="l14.1272">           );</span>
<a href="#l14.1273"></a><span id="l14.1273" class="difflineat">@@ -1796,136 +1795,136 @@ var XMPPAccountPrototype = {</span>
<a href="#l14.1274"></a><span id="l14.1274">         this.sendStanza(Stanza.iq(&quot;result&quot;, id, from, discoveryQuery));</span>
<a href="#l14.1275"></a><span id="l14.1275">         return;</span>
<a href="#l14.1276"></a><span id="l14.1276">       }</span>
<a href="#l14.1277"></a><span id="l14.1277">     }</span>
<a href="#l14.1278"></a><span id="l14.1278">     this.WARN(`Unhandled IQ ${type} stanza.`);</span>
<a href="#l14.1279"></a><span id="l14.1279">   },</span>
<a href="#l14.1280"></a><span id="l14.1280"> </span>
<a href="#l14.1281"></a><span id="l14.1281">   /* Called when a presence stanza is received */</span>
<a href="#l14.1282"></a><span id="l14.1282" class="difflineminus">-  onPresenceStanza: function(aStanza) {</span>
<a href="#l14.1283"></a><span id="l14.1283" class="difflineminus">-    let from = aStanza.attributes[&quot;from&quot;];</span>
<a href="#l14.1284"></a><span id="l14.1284" class="difflineplus">+  onPresenceStanza(aStanza) {</span>
<a href="#l14.1285"></a><span id="l14.1285" class="difflineplus">+    let from = aStanza.attributes.from;</span>
<a href="#l14.1286"></a><span id="l14.1286">     this.DEBUG(&quot;Received presence stanza for &quot; + from);</span>
<a href="#l14.1287"></a><span id="l14.1287"> </span>
<a href="#l14.1288"></a><span id="l14.1288">     let jid = this.normalize(from);</span>
<a href="#l14.1289"></a><span id="l14.1289" class="difflineminus">-    let type = aStanza.attributes[&quot;type&quot;];</span>
<a href="#l14.1290"></a><span id="l14.1290" class="difflineplus">+    let type = aStanza.attributes.type;</span>
<a href="#l14.1291"></a><span id="l14.1291">     if (type == &quot;subscribe&quot;) {</span>
<a href="#l14.1292"></a><span id="l14.1292">       this.addBuddyRequest(jid,</span>
<a href="#l14.1293"></a><span id="l14.1293">                            this.replyToBuddyRequest.bind(this, &quot;subscribed&quot;),</span>
<a href="#l14.1294"></a><span id="l14.1294">                            this.replyToBuddyRequest.bind(this, &quot;unsubscribed&quot;));</span>
<a href="#l14.1295"></a><span id="l14.1295">     }</span>
<a href="#l14.1296"></a><span id="l14.1296">     else if (type == &quot;unsubscribe&quot; || type == &quot;unsubscribed&quot; ||</span>
<a href="#l14.1297"></a><span id="l14.1297">              type == &quot;subscribed&quot;) {</span>
<a href="#l14.1298"></a><span id="l14.1298">       // Nothing useful to do for these presence stanzas, as we will also</span>
<a href="#l14.1299"></a><span id="l14.1299">       // receive a roster push containing more or less the same information</span>
<a href="#l14.1300"></a><span id="l14.1300" class="difflineminus">-      return;</span>
<a href="#l14.1301"></a><span id="l14.1301" class="difflineplus">+</span>
<a href="#l14.1302"></a><span id="l14.1302">     }</span>
<a href="#l14.1303"></a><span id="l14.1303">     else if (this._buddies.has(jid))</span>
<a href="#l14.1304"></a><span id="l14.1304">       this._buddies.get(jid).onPresenceStanza(aStanza);</span>
<a href="#l14.1305"></a><span id="l14.1305">     else if (this._mucs.has(jid))</span>
<a href="#l14.1306"></a><span id="l14.1306">       this._mucs.get(jid).onPresenceStanza(aStanza);</span>
<a href="#l14.1307"></a><span id="l14.1307">     else if (jid != this.normalize(this._connection._jid.jid))</span>
<a href="#l14.1308"></a><span id="l14.1308">       this.WARN(&quot;received presence stanza for unknown buddy &quot; + from);</span>
<a href="#l14.1309"></a><span id="l14.1309">     else if (jid == this._jid.node + &quot;@&quot; + this._jid.domain &amp;&amp;</span>
<a href="#l14.1310"></a><span id="l14.1310">              this._connection._resource != this._parseJID(from).resource) {</span>
<a href="#l14.1311"></a><span id="l14.1311">       // Ignore presence stanzas for another resource.</span>
<a href="#l14.1312"></a><span id="l14.1312" class="difflineminus">-      return;</span>
<a href="#l14.1313"></a><span id="l14.1313" class="difflineplus">+</span>
<a href="#l14.1314"></a><span id="l14.1314">     }</span>
<a href="#l14.1315"></a><span id="l14.1315">     else</span>
<a href="#l14.1316"></a><span id="l14.1316">       this.WARN(&quot;Unhandled presence stanza.&quot;);</span>
<a href="#l14.1317"></a><span id="l14.1317">   },</span>
<a href="#l14.1318"></a><span id="l14.1318"> </span>
<a href="#l14.1319"></a><span id="l14.1319">   // XEP-0030: Discovering services and their features that are supported by</span>
<a href="#l14.1320"></a><span id="l14.1320">   // the server.</span>
<a href="#l14.1321"></a><span id="l14.1321" class="difflineminus">-  onServiceDiscovery: function(aStanza) {</span>
<a href="#l14.1322"></a><span id="l14.1322" class="difflineplus">+  onServiceDiscovery(aStanza) {</span>
<a href="#l14.1323"></a><span id="l14.1323">     let query = aStanza.getElement([&quot;query&quot;]);</span>
<a href="#l14.1324"></a><span id="l14.1324" class="difflineminus">-    if (aStanza.attributes[&quot;type&quot;] != &quot;result&quot; || !query ||</span>
<a href="#l14.1325"></a><span id="l14.1325" class="difflineplus">+    if (aStanza.attributes.type != &quot;result&quot; || !query ||</span>
<a href="#l14.1326"></a><span id="l14.1326">         query.uri != Stanza.NS.disco_items) {</span>
<a href="#l14.1327"></a><span id="l14.1327">       this.LOG(&quot;Could not get services for this server: &quot; + this._jid.domain);</span>
<a href="#l14.1328"></a><span id="l14.1328">       return true;</span>
<a href="#l14.1329"></a><span id="l14.1329">     }</span>
<a href="#l14.1330"></a><span id="l14.1330"> </span>
<a href="#l14.1331"></a><span id="l14.1331">     // Discovering the Features that are Supported by each service.</span>
<a href="#l14.1332"></a><span id="l14.1332">     query.getElements([&quot;item&quot;]).forEach(item =&gt; {</span>
<a href="#l14.1333"></a><span id="l14.1333" class="difflineminus">-      let jid = item.attributes[&quot;jid&quot;];</span>
<a href="#l14.1334"></a><span id="l14.1334" class="difflineplus">+      let jid = item.attributes.jid;</span>
<a href="#l14.1335"></a><span id="l14.1335">       if (!jid)</span>
<a href="#l14.1336"></a><span id="l14.1336">         return;</span>
<a href="#l14.1337"></a><span id="l14.1337">       let iq = Stanza.iq(&quot;get&quot;, null, jid,</span>
<a href="#l14.1338"></a><span id="l14.1338">                          Stanza.node(&quot;query&quot;, Stanza.NS.disco_info));</span>
<a href="#l14.1339"></a><span id="l14.1339">       this.sendStanza(iq, receivedStanza =&gt; {</span>
<a href="#l14.1340"></a><span id="l14.1340">         let query = receivedStanza.getElement([&quot;query&quot;]);</span>
<a href="#l14.1341"></a><span id="l14.1341" class="difflineminus">-        let from = receivedStanza.attributes[&quot;from&quot;];</span>
<a href="#l14.1342"></a><span id="l14.1342" class="difflineminus">-        if (aStanza.attributes[&quot;type&quot;] != &quot;result&quot; || !query ||</span>
<a href="#l14.1343"></a><span id="l14.1343" class="difflineplus">+        let from = receivedStanza.attributes.from;</span>
<a href="#l14.1344"></a><span id="l14.1344" class="difflineplus">+        if (aStanza.attributes.type != &quot;result&quot; || !query ||</span>
<a href="#l14.1345"></a><span id="l14.1345">             query.uri != Stanza.NS.disco_info) {</span>
<a href="#l14.1346"></a><span id="l14.1346">           this.LOG(&quot;Could not get features for this service: &quot; + from);</span>
<a href="#l14.1347"></a><span id="l14.1347">           return true;</span>
<a href="#l14.1348"></a><span id="l14.1348">         }</span>
<a href="#l14.1349"></a><span id="l14.1349">         let features = query.getElements([&quot;feature&quot;])</span>
<a href="#l14.1350"></a><span id="l14.1350" class="difflineminus">-                            .map(elt =&gt; elt.attributes[&quot;var&quot;]);</span>
<a href="#l14.1351"></a><span id="l14.1351" class="difflineplus">+                            .map(elt =&gt; elt.attributes.var);</span>
<a href="#l14.1352"></a><span id="l14.1352">         let identity = query.getElement([&quot;identity&quot;]);</span>
<a href="#l14.1353"></a><span id="l14.1353" class="difflineminus">-        if (identity &amp;&amp; identity.attributes[&quot;category&quot;] == &quot;conference&quot; &amp;&amp;</span>
<a href="#l14.1354"></a><span id="l14.1354" class="difflineminus">-            identity.attributes[&quot;type&quot;] == &quot;text&quot; &amp;&amp;</span>
<a href="#l14.1355"></a><span id="l14.1355" class="difflineplus">+        if (identity &amp;&amp; identity.attributes.category == &quot;conference&quot; &amp;&amp;</span>
<a href="#l14.1356"></a><span id="l14.1356" class="difflineplus">+            identity.attributes.type == &quot;text&quot; &amp;&amp;</span>
<a href="#l14.1357"></a><span id="l14.1357">             features.includes(Stanza.NS.muc)) {</span>
<a href="#l14.1358"></a><span id="l14.1358">           // XEP-0045 (6.2): this feature is for a MUC Service.</span>
<a href="#l14.1359"></a><span id="l14.1359">           // XEP-0045 (15.2): Service Discovery Category/Type.</span>
<a href="#l14.1360"></a><span id="l14.1360">           this._mucService = from;</span>
<a href="#l14.1361"></a><span id="l14.1361">         }</span>
<a href="#l14.1362"></a><span id="l14.1362">         // TODO: Handle other services that are supported by XMPP through</span>
<a href="#l14.1363"></a><span id="l14.1363">         // their features.</span>
<a href="#l14.1364"></a><span id="l14.1364"> </span>
<a href="#l14.1365"></a><span id="l14.1365">         return true;</span>
<a href="#l14.1366"></a><span id="l14.1366">       });</span>
<a href="#l14.1367"></a><span id="l14.1367">     });</span>
<a href="#l14.1368"></a><span id="l14.1368">     return true;</span>
<a href="#l14.1369"></a><span id="l14.1369">   },</span>
<a href="#l14.1370"></a><span id="l14.1370"> </span>
<a href="#l14.1371"></a><span id="l14.1371">   // XEP-0030: Discovering Service Information and its features that are</span>
<a href="#l14.1372"></a><span id="l14.1372">   // supported by the server.</span>
<a href="#l14.1373"></a><span id="l14.1373" class="difflineminus">-  onServiceDiscoveryInfo: function(aStanza) {</span>
<a href="#l14.1374"></a><span id="l14.1374" class="difflineplus">+  onServiceDiscoveryInfo(aStanza) {</span>
<a href="#l14.1375"></a><span id="l14.1375">     let query = aStanza.getElement([&quot;query&quot;]);</span>
<a href="#l14.1376"></a><span id="l14.1376" class="difflineminus">-    if (aStanza.attributes[&quot;type&quot;] != &quot;result&quot; || !query ||</span>
<a href="#l14.1377"></a><span id="l14.1377" class="difflineplus">+    if (aStanza.attributes.type != &quot;result&quot; || !query ||</span>
<a href="#l14.1378"></a><span id="l14.1378">         query.uri != Stanza.NS.disco_info) {</span>
<a href="#l14.1379"></a><span id="l14.1379">       this.LOG(&quot;Could not get features for this server: &quot; + this._jid.domain);</span>
<a href="#l14.1380"></a><span id="l14.1380">       return true;</span>
<a href="#l14.1381"></a><span id="l14.1381">     }</span>
<a href="#l14.1382"></a><span id="l14.1382"> </span>
<a href="#l14.1383"></a><span id="l14.1383">     let features = query.getElements([&quot;feature&quot;])</span>
<a href="#l14.1384"></a><span id="l14.1384" class="difflineminus">-                        .map(elt =&gt; elt.attributes[&quot;var&quot;]);</span>
<a href="#l14.1385"></a><span id="l14.1385" class="difflineplus">+                        .map(elt =&gt; elt.attributes.var);</span>
<a href="#l14.1386"></a><span id="l14.1386">     if (features.includes(Stanza.NS.carbons)) {</span>
<a href="#l14.1387"></a><span id="l14.1387">       // XEP-0280: Message Carbons.</span>
<a href="#l14.1388"></a><span id="l14.1388">       // Enabling Carbons on server, as it's disabled by default on server.</span>
<a href="#l14.1389"></a><span id="l14.1389">       if (Services.prefs.getBoolPref(&quot;chat.xmpp.messageCarbons&quot;)) {</span>
<a href="#l14.1390"></a><span id="l14.1390">         let iqStanza = Stanza.iq(&quot;set&quot;, null, null,</span>
<a href="#l14.1391"></a><span id="l14.1391">                                  Stanza.node(&quot;enable&quot;, Stanza.NS.carbons));</span>
<a href="#l14.1392"></a><span id="l14.1392">         this.sendStanza(iqStanza, aStanza =&gt; {</span>
<a href="#l14.1393"></a><span id="l14.1393">           let error = this.parseError(aStanza);</span>
<a href="#l14.1394"></a><span id="l14.1394">           if (error) {</span>
<a href="#l14.1395"></a><span id="l14.1395">             this.WARN(&quot;Unable to enable message carbons due to &quot; +</span>
<a href="#l14.1396"></a><span id="l14.1396">                       error.condition + &quot; error.&quot;);</span>
<a href="#l14.1397"></a><span id="l14.1397">             return true;</span>
<a href="#l14.1398"></a><span id="l14.1398">           }</span>
<a href="#l14.1399"></a><span id="l14.1399"> </span>
<a href="#l14.1400"></a><span id="l14.1400" class="difflineminus">-          let type = aStanza.attributes[&quot;type&quot;];</span>
<a href="#l14.1401"></a><span id="l14.1401" class="difflineplus">+          let type = aStanza.attributes.type;</span>
<a href="#l14.1402"></a><span id="l14.1402">           if (type != &quot;result&quot;) {</span>
<a href="#l14.1403"></a><span id="l14.1403">             this.WARN(&quot;Received unexpected stanza with &quot; + type + &quot; type &quot; +</span>
<a href="#l14.1404"></a><span id="l14.1404">                       &quot;while enabling message carbons.&quot;);</span>
<a href="#l14.1405"></a><span id="l14.1405">             return true;</span>
<a href="#l14.1406"></a><span id="l14.1406">           }</span>
<a href="#l14.1407"></a><span id="l14.1407"> </span>
<a href="#l14.1408"></a><span id="l14.1408">           this.LOG(&quot;Message carbons enabled.&quot;);</span>
<a href="#l14.1409"></a><span id="l14.1409">           this._isCarbonsEnabled = true;</span>
<a href="#l14.1410"></a><span id="l14.1410">           return true;</span>
<a href="#l14.1411"></a><span id="l14.1411">         });</span>
<a href="#l14.1412"></a><span id="l14.1412">       }</span>
<a href="#l14.1413"></a><span id="l14.1413">     }</span>
<a href="#l14.1414"></a><span id="l14.1414">     // TODO: Handle other features that are supported by the server.</span>
<a href="#l14.1415"></a><span id="l14.1415">     return true;</span>
<a href="#l14.1416"></a><span id="l14.1416">   },</span>
<a href="#l14.1417"></a><span id="l14.1417"> </span>
<a href="#l14.1418"></a><span id="l14.1418" class="difflineminus">-  requestRoomInfo: function(aCallback) {</span>
<a href="#l14.1419"></a><span id="l14.1419" class="difflineplus">+  requestRoomInfo(aCallback) {</span>
<a href="#l14.1420"></a><span id="l14.1420">     if (this._roomInfoCallbacks.has(aCallback))</span>
<a href="#l14.1421"></a><span id="l14.1421">       return;</span>
<a href="#l14.1422"></a><span id="l14.1422"> </span>
<a href="#l14.1423"></a><span id="l14.1423">     if (this.isRoomInfoStale &amp;&amp; !this._pendingList) {</span>
<a href="#l14.1424"></a><span id="l14.1424">       this._roomList = new Map();</span>
<a href="#l14.1425"></a><span id="l14.1425">       this._lastListTime = Date.now();</span>
<a href="#l14.1426"></a><span id="l14.1426">       this._roomInfoCallback = aCallback;</span>
<a href="#l14.1427"></a><span id="l14.1427">       this._pendingList = true;</span>
<a href="#l14.1428"></a><span id="l14.1428" class="difflineat">@@ -1939,17 +1938,17 @@ var XMPPAccountPrototype = {</span>
<a href="#l14.1429"></a><span id="l14.1429">       let rooms = [...this._roomList.keys()];</span>
<a href="#l14.1430"></a><span id="l14.1430">       aCallback.onRoomInfoAvailable(rooms, !this._pendingList, rooms.length);</span>
<a href="#l14.1431"></a><span id="l14.1431">     }</span>
<a href="#l14.1432"></a><span id="l14.1432"> </span>
<a href="#l14.1433"></a><span id="l14.1433">     if (this._pendingList)</span>
<a href="#l14.1434"></a><span id="l14.1434">       this._roomInfoCallbacks.add(aCallback);</span>
<a href="#l14.1435"></a><span id="l14.1435">   },</span>
<a href="#l14.1436"></a><span id="l14.1436"> </span>
<a href="#l14.1437"></a><span id="l14.1437" class="difflineminus">-  onRoomDiscovery: function(aStanza) {</span>
<a href="#l14.1438"></a><span id="l14.1438" class="difflineplus">+  onRoomDiscovery(aStanza) {</span>
<a href="#l14.1439"></a><span id="l14.1439">     let query = aStanza.getElement([&quot;query&quot;]);</span>
<a href="#l14.1440"></a><span id="l14.1440">     if (!query || query.uri != Stanza.NS.disco_items) {</span>
<a href="#l14.1441"></a><span id="l14.1441">       this.LOG(&quot;Could not get rooms for this server: &quot; + this._jid.domain);</span>
<a href="#l14.1442"></a><span id="l14.1442">       return true;</span>
<a href="#l14.1443"></a><span id="l14.1443">     }</span>
<a href="#l14.1444"></a><span id="l14.1444"> </span>
<a href="#l14.1445"></a><span id="l14.1445">     // XEP-0059: Result Set Management.</span>
<a href="#l14.1446"></a><span id="l14.1446">     let set = query.getElement([&quot;set&quot;]);</span>
<a href="#l14.1447"></a><span id="l14.1447" class="difflineat">@@ -1961,90 +1960,90 @@ var XMPPAccountPrototype = {</span>
<a href="#l14.1448"></a><span id="l14.1448">                          Stanza.node(&quot;query&quot;, Stanza.NS.disco_items));</span>
<a href="#l14.1449"></a><span id="l14.1449">       this.sendStanza(iq, this.onRoomDiscovery, this);</span>
<a href="#l14.1450"></a><span id="l14.1450">     }</span>
<a href="#l14.1451"></a><span id="l14.1451">     else</span>
<a href="#l14.1452"></a><span id="l14.1452">       this._pendingList = false;</span>
<a href="#l14.1453"></a><span id="l14.1453"> </span>
<a href="#l14.1454"></a><span id="l14.1454">     let rooms = [];</span>
<a href="#l14.1455"></a><span id="l14.1455">     query.getElements([&quot;item&quot;]).forEach(item =&gt; {</span>
<a href="#l14.1456"></a><span id="l14.1456" class="difflineminus">-      let jid = this._parseJID(item.attributes[&quot;jid&quot;]);</span>
<a href="#l14.1457"></a><span id="l14.1457" class="difflineplus">+      let jid = this._parseJID(item.attributes.jid);</span>
<a href="#l14.1458"></a><span id="l14.1458">       if (!jid)</span>
<a href="#l14.1459"></a><span id="l14.1459">         return;</span>
<a href="#l14.1460"></a><span id="l14.1460"> </span>
<a href="#l14.1461"></a><span id="l14.1461" class="difflineminus">-      let name = item.attributes[&quot;name&quot;];</span>
<a href="#l14.1462"></a><span id="l14.1462" class="difflineplus">+      let name = item.attributes.name;</span>
<a href="#l14.1463"></a><span id="l14.1463">       if (!name)</span>
<a href="#l14.1464"></a><span id="l14.1464">         name = jid.node ? jid.node : jid.jid;</span>
<a href="#l14.1465"></a><span id="l14.1465"> </span>
<a href="#l14.1466"></a><span id="l14.1466">       this._roomList.set(name, jid.jid);</span>
<a href="#l14.1467"></a><span id="l14.1467">       rooms.push(name);</span>
<a href="#l14.1468"></a><span id="l14.1468">     });</span>
<a href="#l14.1469"></a><span id="l14.1469"> </span>
<a href="#l14.1470"></a><span id="l14.1470">     this._roomInfoCallback.onRoomInfoAvailable(rooms, !this._pendingList,</span>
<a href="#l14.1471"></a><span id="l14.1471">                                                rooms.length);</span>
<a href="#l14.1472"></a><span id="l14.1472">   },</span>
<a href="#l14.1473"></a><span id="l14.1473"> </span>
<a href="#l14.1474"></a><span id="l14.1474" class="difflineminus">-  getRoomInfo: function(aName) {</span>
<a href="#l14.1475"></a><span id="l14.1475" class="difflineplus">+  getRoomInfo(aName) {</span>
<a href="#l14.1476"></a><span id="l14.1476">     return new XMPPRoomInfo(aName, this);</span>
<a href="#l14.1477"></a><span id="l14.1477">   },</span>
<a href="#l14.1478"></a><span id="l14.1478"> </span>
<a href="#l14.1479"></a><span id="l14.1479">   // Returns null if not an invitation stanza, and an object</span>
<a href="#l14.1480"></a><span id="l14.1480">   // describing the invitation otherwise.</span>
<a href="#l14.1481"></a><span id="l14.1481" class="difflineminus">-  parseInvitation: function(aStanza) {</span>
<a href="#l14.1482"></a><span id="l14.1482" class="difflineplus">+  parseInvitation(aStanza) {</span>
<a href="#l14.1483"></a><span id="l14.1483">       let x = aStanza.getElement([&quot;x&quot;]);</span>
<a href="#l14.1484"></a><span id="l14.1484">       if (!x)</span>
<a href="#l14.1485"></a><span id="l14.1485">         return null;</span>
<a href="#l14.1486"></a><span id="l14.1486">       let retVal = {};</span>
<a href="#l14.1487"></a><span id="l14.1487"> </span>
<a href="#l14.1488"></a><span id="l14.1488">       // XEP-0045. Direct Invitation (7.8.1)</span>
<a href="#l14.1489"></a><span id="l14.1489">       // Described in XEP-0249.</span>
<a href="#l14.1490"></a><span id="l14.1490">       // jid (chatroom) is required.</span>
<a href="#l14.1491"></a><span id="l14.1491">       // Password, reason, continue and thread are optional.</span>
<a href="#l14.1492"></a><span id="l14.1492">       if (x.uri == Stanza.NS.conference) {</span>
<a href="#l14.1493"></a><span id="l14.1493" class="difflineminus">-        if (!x.attributes[&quot;jid&quot;]) {</span>
<a href="#l14.1494"></a><span id="l14.1494" class="difflineplus">+        if (!x.attributes.jid) {</span>
<a href="#l14.1495"></a><span id="l14.1495">           this.WARN(&quot;Received an invitation with missing MUC jid.&quot;);</span>
<a href="#l14.1496"></a><span id="l14.1496">           return null;</span>
<a href="#l14.1497"></a><span id="l14.1497">         }</span>
<a href="#l14.1498"></a><span id="l14.1498" class="difflineminus">-        retVal.mucJid = this.normalize(x.attributes[&quot;jid&quot;]);</span>
<a href="#l14.1499"></a><span id="l14.1499" class="difflineminus">-        retVal.from = this.normalize(aStanza.attributes[&quot;from&quot;]);</span>
<a href="#l14.1500"></a><span id="l14.1500" class="difflineminus">-        retVal.password = x.attributes[&quot;password&quot;];</span>
<a href="#l14.1501"></a><span id="l14.1501" class="difflineminus">-        retVal.reason = x.attributes[&quot;reason&quot;];</span>
<a href="#l14.1502"></a><span id="l14.1502" class="difflineminus">-        retVal.continue = x.attributes[&quot;continue&quot;];</span>
<a href="#l14.1503"></a><span id="l14.1503" class="difflineminus">-        retVal.thread = x.attributes[&quot;thread&quot;];</span>
<a href="#l14.1504"></a><span id="l14.1504" class="difflineplus">+        retVal.mucJid = this.normalize(x.attributes.jid);</span>
<a href="#l14.1505"></a><span id="l14.1505" class="difflineplus">+        retVal.from = this.normalize(aStanza.attributes.from);</span>
<a href="#l14.1506"></a><span id="l14.1506" class="difflineplus">+        retVal.password = x.attributes.password;</span>
<a href="#l14.1507"></a><span id="l14.1507" class="difflineplus">+        retVal.reason = x.attributes.reason;</span>
<a href="#l14.1508"></a><span id="l14.1508" class="difflineplus">+        retVal.continue = x.attributes.continue;</span>
<a href="#l14.1509"></a><span id="l14.1509" class="difflineplus">+        retVal.thread = x.attributes.thread;</span>
<a href="#l14.1510"></a><span id="l14.1510">         return retVal;</span>
<a href="#l14.1511"></a><span id="l14.1511">       }</span>
<a href="#l14.1512"></a><span id="l14.1512"> </span>
<a href="#l14.1513"></a><span id="l14.1513">       // XEP-0045. Mediated Invitation (7.8.2)</span>
<a href="#l14.1514"></a><span id="l14.1514">       // Sent by the chatroom on behalf of someone in the chatroom.</span>
<a href="#l14.1515"></a><span id="l14.1515">       // jid (chatroom) and from (inviter) are required.</span>
<a href="#l14.1516"></a><span id="l14.1516">       // password and reason are optional.</span>
<a href="#l14.1517"></a><span id="l14.1517">       if (x.uri == Stanza.NS.muc_user) {</span>
<a href="#l14.1518"></a><span id="l14.1518">         let invite = x.getElement([&quot;invite&quot;]);</span>
<a href="#l14.1519"></a><span id="l14.1519" class="difflineminus">-        if (!invite || !invite.attributes[&quot;from&quot;]) {</span>
<a href="#l14.1520"></a><span id="l14.1520" class="difflineplus">+        if (!invite || !invite.attributes.from) {</span>
<a href="#l14.1521"></a><span id="l14.1521">           this.WARN(&quot;Received an invitation with missing MUC invite or from.&quot;);</span>
<a href="#l14.1522"></a><span id="l14.1522">           return null;</span>
<a href="#l14.1523"></a><span id="l14.1523">         }</span>
<a href="#l14.1524"></a><span id="l14.1524" class="difflineminus">-        retVal.mucJid = this.normalize(aStanza.attributes[&quot;from&quot;]);</span>
<a href="#l14.1525"></a><span id="l14.1525" class="difflineminus">-        retVal.from = this.normalize(invite.attributes[&quot;from&quot;]);</span>
<a href="#l14.1526"></a><span id="l14.1526" class="difflineplus">+        retVal.mucJid = this.normalize(aStanza.attributes.from);</span>
<a href="#l14.1527"></a><span id="l14.1527" class="difflineplus">+        retVal.from = this.normalize(invite.attributes.from);</span>
<a href="#l14.1528"></a><span id="l14.1528">         let continueElement = invite.getElement([&quot;continue&quot;]);</span>
<a href="#l14.1529"></a><span id="l14.1529">         retVal.continue = !!continueElement;</span>
<a href="#l14.1530"></a><span id="l14.1530">         if (continueElement)</span>
<a href="#l14.1531"></a><span id="l14.1531" class="difflineminus">-          retVal.thread = continueElement.attributes[&quot;thread&quot;];</span>
<a href="#l14.1532"></a><span id="l14.1532" class="difflineplus">+          retVal.thread = continueElement.attributes.thread;</span>
<a href="#l14.1533"></a><span id="l14.1533">         if (x.getElement([&quot;password&quot;]))</span>
<a href="#l14.1534"></a><span id="l14.1534">           retVal.password = x.getElement([&quot;password&quot;]).innerText;</span>
<a href="#l14.1535"></a><span id="l14.1535">         if (invite.getElement([&quot;reason&quot;]))</span>
<a href="#l14.1536"></a><span id="l14.1536">           retVal.reason = invite.getElement([&quot;reason&quot;]).innerText;</span>
<a href="#l14.1537"></a><span id="l14.1537">         return retVal;</span>
<a href="#l14.1538"></a><span id="l14.1538">       }</span>
<a href="#l14.1539"></a><span id="l14.1539"> </span>
<a href="#l14.1540"></a><span id="l14.1540">       return null;</span>
<a href="#l14.1541"></a><span id="l14.1541">   },</span>
<a href="#l14.1542"></a><span id="l14.1542"> </span>
<a href="#l14.1543"></a><span id="l14.1543">   /* Called when a message stanza is received */</span>
<a href="#l14.1544"></a><span id="l14.1544" class="difflineminus">-  onMessageStanza: function(aStanza) {</span>
<a href="#l14.1545"></a><span id="l14.1545" class="difflineplus">+  onMessageStanza(aStanza) {</span>
<a href="#l14.1546"></a><span id="l14.1546">     // XEP-0280: Message Carbons.</span>
<a href="#l14.1547"></a><span id="l14.1547">     // Sending and Receiving Messages.</span>
<a href="#l14.1548"></a><span id="l14.1548">     // Indicates that the forwarded message was sent or received.</span>
<a href="#l14.1549"></a><span id="l14.1549">     let isSent = false;</span>
<a href="#l14.1550"></a><span id="l14.1550">     let carbonStanza =</span>
<a href="#l14.1551"></a><span id="l14.1551">       aStanza.getElement([&quot;sent&quot;]) || aStanza.getElement([&quot;received&quot;]);</span>
<a href="#l14.1552"></a><span id="l14.1552">     if (carbonStanza) {</span>
<a href="#l14.1553"></a><span id="l14.1553">       if (carbonStanza.uri != Stanza.NS.carbons) {</span>
<a href="#l14.1554"></a><span id="l14.1554" class="difflineat">@@ -2061,22 +2060,22 @@ var XMPPAccountPrototype = {</span>
<a href="#l14.1555"></a><span id="l14.1555">         this.WARN(&quot;Received an unexpected forwarded message while message &quot; +</span>
<a href="#l14.1556"></a><span id="l14.1556">                   &quot;carbons are not enabled.&quot;);</span>
<a href="#l14.1557"></a><span id="l14.1557">         return;</span>
<a href="#l14.1558"></a><span id="l14.1558">       }</span>
<a href="#l14.1559"></a><span id="l14.1559">     }</span>
<a href="#l14.1560"></a><span id="l14.1560"> </span>
<a href="#l14.1561"></a><span id="l14.1561">     // For forwarded sent messages, we need to use &quot;to&quot; attribute to</span>
<a href="#l14.1562"></a><span id="l14.1562">     // get the right conversation as from in this case is this account.</span>
<a href="#l14.1563"></a><span id="l14.1563" class="difflineminus">-    let convJid = isSent ? aStanza.attributes[&quot;to&quot;] : aStanza.attributes[&quot;from&quot;];</span>
<a href="#l14.1564"></a><span id="l14.1564" class="difflineplus">+    let convJid = isSent ? aStanza.attributes.to : aStanza.attributes.from;</span>
<a href="#l14.1565"></a><span id="l14.1565"> </span>
<a href="#l14.1566"></a><span id="l14.1566">     let normConvJid = this.normalize(convJid);</span>
<a href="#l14.1567"></a><span id="l14.1567">     let isMuc = this._mucs.has(normConvJid);</span>
<a href="#l14.1568"></a><span id="l14.1568"> </span>
<a href="#l14.1569"></a><span id="l14.1569" class="difflineminus">-    let type = aStanza.attributes[&quot;type&quot;];</span>
<a href="#l14.1570"></a><span id="l14.1570" class="difflineplus">+    let type = aStanza.attributes.type;</span>
<a href="#l14.1571"></a><span id="l14.1571">     let x = aStanza.getElement([&quot;x&quot;]);</span>
<a href="#l14.1572"></a><span id="l14.1572">     let body;</span>
<a href="#l14.1573"></a><span id="l14.1573">     let b = aStanza.getElement([&quot;body&quot;]);</span>
<a href="#l14.1574"></a><span id="l14.1574">     if (b) {</span>
<a href="#l14.1575"></a><span id="l14.1575">       // If there's a &lt;body&gt; child we have more than just typing notifications.</span>
<a href="#l14.1576"></a><span id="l14.1576">       // Prefer HTML (in &lt;html&gt;&lt;body&gt;) and use plain text (&lt;body&gt;) as fallback.</span>
<a href="#l14.1577"></a><span id="l14.1577">       let htmlBody = aStanza.getElement([&quot;html&quot;, &quot;body&quot;]);</span>
<a href="#l14.1578"></a><span id="l14.1578">       if (htmlBody)</span>
<a href="#l14.1579"></a><span id="l14.1579" class="difflineat">@@ -2211,23 +2210,23 @@ var XMPPAccountPrototype = {</span>
<a href="#l14.1580"></a><span id="l14.1580">     let conv = this._conv.get(convName);</span>
<a href="#l14.1581"></a><span id="l14.1581">     if (!conv)</span>
<a href="#l14.1582"></a><span id="l14.1582">       return;</span>
<a href="#l14.1583"></a><span id="l14.1583">     conv.updateTyping(typingState, conv.shortName);</span>
<a href="#l14.1584"></a><span id="l14.1584">     conv.supportChatStateNotifications = !!state;</span>
<a href="#l14.1585"></a><span id="l14.1585">   },</span>
<a href="#l14.1586"></a><span id="l14.1586"> </span>
<a href="#l14.1587"></a><span id="l14.1587">   /* Called when there is an error in the xmpp session */</span>
<a href="#l14.1588"></a><span id="l14.1588" class="difflineminus">-  onError: function(aError, aException) {</span>
<a href="#l14.1589"></a><span id="l14.1589" class="difflineplus">+  onError(aError, aException) {</span>
<a href="#l14.1590"></a><span id="l14.1590">     if (aError === null || aError === undefined)</span>
<a href="#l14.1591"></a><span id="l14.1591">       aError = Ci.prplIAccount.ERROR_OTHER_ERROR;</span>
<a href="#l14.1592"></a><span id="l14.1592">     this._disconnect(aError, aException.toString());</span>
<a href="#l14.1593"></a><span id="l14.1593">   },</span>
<a href="#l14.1594"></a><span id="l14.1594"> </span>
<a href="#l14.1595"></a><span id="l14.1595" class="difflineminus">-  onVCard: function(aStanza) {</span>
<a href="#l14.1596"></a><span id="l14.1596" class="difflineplus">+  onVCard(aStanza) {</span>
<a href="#l14.1597"></a><span id="l14.1597">     let jid = this._pendingVCardRequests.shift();</span>
<a href="#l14.1598"></a><span id="l14.1598">     this._requestNextVCard();</span>
<a href="#l14.1599"></a><span id="l14.1599">     if (!this._buddies.has(jid)) {</span>
<a href="#l14.1600"></a><span id="l14.1600">       this.WARN(&quot;Received a vCard for unknown buddy &quot; + jid);</span>
<a href="#l14.1601"></a><span id="l14.1601">       return;</span>
<a href="#l14.1602"></a><span id="l14.1602">     }</span>
<a href="#l14.1603"></a><span id="l14.1603"> </span>
<a href="#l14.1604"></a><span id="l14.1604">     let vCard = aStanza.getElement([&quot;vCard&quot;]);</span>
<a href="#l14.1605"></a><span id="l14.1605" class="difflineat">@@ -2239,17 +2238,17 @@ var XMPPAccountPrototype = {</span>
<a href="#l14.1606"></a><span id="l14.1606">       return;</span>
<a href="#l14.1607"></a><span id="l14.1607">     }</span>
<a href="#l14.1608"></a><span id="l14.1608">     else if (error) {</span>
<a href="#l14.1609"></a><span id="l14.1609">       this.WARN(&quot;Received unexpected vCard error &quot; + error.condition);</span>
<a href="#l14.1610"></a><span id="l14.1610">       return;</span>
<a href="#l14.1611"></a><span id="l14.1611">     }</span>
<a href="#l14.1612"></a><span id="l14.1612"> </span>
<a href="#l14.1613"></a><span id="l14.1613">     let buddy = this._buddies.get(jid);</span>
<a href="#l14.1614"></a><span id="l14.1614" class="difflineminus">-    let stanzaJid = this.normalize(aStanza.attributes[&quot;from&quot;]);</span>
<a href="#l14.1615"></a><span id="l14.1615" class="difflineplus">+    let stanzaJid = this.normalize(aStanza.attributes.from);</span>
<a href="#l14.1616"></a><span id="l14.1616">     if (jid &amp;&amp; jid != stanzaJid) {</span>
<a href="#l14.1617"></a><span id="l14.1617">       this.ERROR(&quot;Received vCard for a different jid (&quot; + stanzaJid + &quot;) &quot; +</span>
<a href="#l14.1618"></a><span id="l14.1618">                  &quot;than the requested &quot; + jid);</span>
<a href="#l14.1619"></a><span id="l14.1619">     }</span>
<a href="#l14.1620"></a><span id="l14.1620"> </span>
<a href="#l14.1621"></a><span id="l14.1621">     let foundFormattedName = false;</span>
<a href="#l14.1622"></a><span id="l14.1622">     let vCardInfo = this.parseVCard(vCard);</span>
<a href="#l14.1623"></a><span id="l14.1623">     if (vCardInfo.fullName) {</span>
<a href="#l14.1624"></a><span id="l14.1624" class="difflineat">@@ -2258,97 +2257,97 @@ var XMPPAccountPrototype = {</span>
<a href="#l14.1625"></a><span id="l14.1625">     }</span>
<a href="#l14.1626"></a><span id="l14.1626">     if (vCardInfo.photo)</span>
<a href="#l14.1627"></a><span id="l14.1627">       buddy._saveIcon(vCardInfo.photo);</span>
<a href="#l14.1628"></a><span id="l14.1628">     if (!foundFormattedName &amp;&amp; buddy._vCardFormattedName)</span>
<a href="#l14.1629"></a><span id="l14.1629">       buddy.vCardFormattedName = &quot;&quot;;</span>
<a href="#l14.1630"></a><span id="l14.1630">     buddy._vCardReceived = true;</span>
<a href="#l14.1631"></a><span id="l14.1631">   },</span>
<a href="#l14.1632"></a><span id="l14.1632"> </span>
<a href="#l14.1633"></a><span id="l14.1633" class="difflineminus">-  _requestNextVCard: function() {</span>
<a href="#l14.1634"></a><span id="l14.1634" class="difflineplus">+  _requestNextVCard() {</span>
<a href="#l14.1635"></a><span id="l14.1635">     if (!this._pendingVCardRequests.length)</span>
<a href="#l14.1636"></a><span id="l14.1636">       return;</span>
<a href="#l14.1637"></a><span id="l14.1637">     let s = Stanza.iq(&quot;get&quot;, null, this._pendingVCardRequests[0],</span>
<a href="#l14.1638"></a><span id="l14.1638">                       Stanza.node(&quot;vCard&quot;, Stanza.NS.vcard));</span>
<a href="#l14.1639"></a><span id="l14.1639">     this.sendStanza(s, this.onVCard, this);</span>
<a href="#l14.1640"></a><span id="l14.1640">   },</span>
<a href="#l14.1641"></a><span id="l14.1641"> </span>
<a href="#l14.1642"></a><span id="l14.1642" class="difflineminus">-  _addVCardRequest: function(aJID) {</span>
<a href="#l14.1643"></a><span id="l14.1643" class="difflineplus">+  _addVCardRequest(aJID) {</span>
<a href="#l14.1644"></a><span id="l14.1644">     let requestPending = !!this._pendingVCardRequests.length;</span>
<a href="#l14.1645"></a><span id="l14.1645">     this._pendingVCardRequests.push(aJID);</span>
<a href="#l14.1646"></a><span id="l14.1646">     if (!requestPending)</span>
<a href="#l14.1647"></a><span id="l14.1647">       this._requestNextVCard();</span>
<a href="#l14.1648"></a><span id="l14.1648">   },</span>
<a href="#l14.1649"></a><span id="l14.1649"> </span>
<a href="#l14.1650"></a><span id="l14.1650">   // XEP-0029 (Section 2) and RFC 6122 (Section 2): The node and domain are</span>
<a href="#l14.1651"></a><span id="l14.1651">   // lowercase, while resources are case sensitive and can contain spaces.</span>
<a href="#l14.1652"></a><span id="l14.1652" class="difflineminus">-  normalizeFullJid: function(aJID) {</span>
<a href="#l14.1653"></a><span id="l14.1653" class="difflineplus">+  normalizeFullJid(aJID) {</span>
<a href="#l14.1654"></a><span id="l14.1654">     return this._parseJID(aJID.trim()).jid;</span>
<a href="#l14.1655"></a><span id="l14.1655">   },</span>
<a href="#l14.1656"></a><span id="l14.1656"> </span>
<a href="#l14.1657"></a><span id="l14.1657">   // Standard normalization for XMPP removes the resource part of jids.</span>
<a href="#l14.1658"></a><span id="l14.1658" class="difflineminus">-  normalize: function(aJID) {</span>
<a href="#l14.1659"></a><span id="l14.1659" class="difflineplus">+  normalize(aJID) {</span>
<a href="#l14.1660"></a><span id="l14.1660">     return aJID.trim()</span>
<a href="#l14.1661"></a><span id="l14.1661">                .split(&quot;/&quot;, 1)[0] // up to first slash</span>
<a href="#l14.1662"></a><span id="l14.1662">                .toLowerCase();</span>
<a href="#l14.1663"></a><span id="l14.1663">   },</span>
<a href="#l14.1664"></a><span id="l14.1664"> </span>
<a href="#l14.1665"></a><span id="l14.1665">   // RFC 6122 (Section 2): [ localpart &quot;@&quot; ] domainpart [ &quot;/&quot; resourcepart ] is</span>
<a href="#l14.1666"></a><span id="l14.1666">   // the form of jid.</span>
<a href="#l14.1667"></a><span id="l14.1667">   // Localpart is parsed as node and optional.</span>
<a href="#l14.1668"></a><span id="l14.1668">   // Domainpart is parsed as domain and required.</span>
<a href="#l14.1669"></a><span id="l14.1669">   // resourcepart is parsed as resource and optional.</span>
<a href="#l14.1670"></a><span id="l14.1670" class="difflineminus">-  _parseJID: function(aJid) {</span>
<a href="#l14.1671"></a><span id="l14.1671" class="difflineplus">+  _parseJID(aJid) {</span>
<a href="#l14.1672"></a><span id="l14.1672">     let match =</span>
<a href="#l14.1673"></a><span id="l14.1673">       /^(?:([^&quot;&amp;'/:&lt;&gt;@]+)@)?([^@/&lt;&gt;'\&quot;]+)(?:\/(.*))?$/.exec(aJid.trim());</span>
<a href="#l14.1674"></a><span id="l14.1674">     if (!match)</span>
<a href="#l14.1675"></a><span id="l14.1675">       return null;</span>
<a href="#l14.1676"></a><span id="l14.1676"> </span>
<a href="#l14.1677"></a><span id="l14.1677">     let result = {</span>
<a href="#l14.1678"></a><span id="l14.1678">       node: match[1],</span>
<a href="#l14.1679"></a><span id="l14.1679">       domain: match[2].toLowerCase(),</span>
<a href="#l14.1680"></a><span id="l14.1680" class="difflineminus">-      resource: match[3]</span>
<a href="#l14.1681"></a><span id="l14.1681" class="difflineplus">+      resource: match[3],</span>
<a href="#l14.1682"></a><span id="l14.1682">     };</span>
<a href="#l14.1683"></a><span id="l14.1683">     return this._setJID(result.domain, result.node, result.resource);</span>
<a href="#l14.1684"></a><span id="l14.1684">   },</span>
<a href="#l14.1685"></a><span id="l14.1685"> </span>
<a href="#l14.1686"></a><span id="l14.1686">   // Constructs jid as an object from domain, node and resource parts.</span>
<a href="#l14.1687"></a><span id="l14.1687">   // The object has properties (node, domain, resource and jid).</span>
<a href="#l14.1688"></a><span id="l14.1688">   // aDomain is required, but aNode and aResource are optional.</span>
<a href="#l14.1689"></a><span id="l14.1689" class="difflineminus">-  _setJID: function(aDomain, aNode = null, aResource = null) {</span>
<a href="#l14.1690"></a><span id="l14.1690" class="difflineplus">+  _setJID(aDomain, aNode = null, aResource = null) {</span>
<a href="#l14.1691"></a><span id="l14.1691">     if (!aDomain)</span>
<a href="#l14.1692"></a><span id="l14.1692">       throw &quot;aDomain must have a value&quot;;</span>
<a href="#l14.1693"></a><span id="l14.1693"> </span>
<a href="#l14.1694"></a><span id="l14.1694">     let result = {</span>
<a href="#l14.1695"></a><span id="l14.1695">       node: aNode,</span>
<a href="#l14.1696"></a><span id="l14.1696">       domain: aDomain.toLowerCase(),</span>
<a href="#l14.1697"></a><span id="l14.1697" class="difflineminus">-      resource: aResource</span>
<a href="#l14.1698"></a><span id="l14.1698" class="difflineplus">+      resource: aResource,</span>
<a href="#l14.1699"></a><span id="l14.1699">     };</span>
<a href="#l14.1700"></a><span id="l14.1700">     let jid = result.domain;</span>
<a href="#l14.1701"></a><span id="l14.1701">     if (result.node) {</span>
<a href="#l14.1702"></a><span id="l14.1702">       result.node = result.node.toLowerCase();</span>
<a href="#l14.1703"></a><span id="l14.1703">       jid = result.node + &quot;@&quot; + jid;</span>
<a href="#l14.1704"></a><span id="l14.1704">     }</span>
<a href="#l14.1705"></a><span id="l14.1705">     if (result.resource)</span>
<a href="#l14.1706"></a><span id="l14.1706">       jid += &quot;/&quot; + result.resource;</span>
<a href="#l14.1707"></a><span id="l14.1707">     result.jid = jid;</span>
<a href="#l14.1708"></a><span id="l14.1708">     return result;</span>
<a href="#l14.1709"></a><span id="l14.1709">   },</span>
<a href="#l14.1710"></a><span id="l14.1710"> </span>
<a href="#l14.1711"></a><span id="l14.1711" class="difflineminus">-  _onRosterItem: function(aItem, aNotifyOfUpdates) {</span>
<a href="#l14.1712"></a><span id="l14.1712" class="difflineminus">-    let jid = aItem.attributes[&quot;jid&quot;];</span>
<a href="#l14.1713"></a><span id="l14.1713" class="difflineplus">+  _onRosterItem(aItem, aNotifyOfUpdates) {</span>
<a href="#l14.1714"></a><span id="l14.1714" class="difflineplus">+    let jid = aItem.attributes.jid;</span>
<a href="#l14.1715"></a><span id="l14.1715">     if (!jid) {</span>
<a href="#l14.1716"></a><span id="l14.1716">       this.WARN(&quot;Received a roster item without jid: &quot; + aItem.getXML());</span>
<a href="#l14.1717"></a><span id="l14.1717">       return &quot;&quot;;</span>
<a href="#l14.1718"></a><span id="l14.1718">     }</span>
<a href="#l14.1719"></a><span id="l14.1719">     jid = this.normalize(jid);</span>
<a href="#l14.1720"></a><span id="l14.1720"> </span>
<a href="#l14.1721"></a><span id="l14.1721">     let subscription =  &quot;&quot;;</span>
<a href="#l14.1722"></a><span id="l14.1722">     if (&quot;subscription&quot; in aItem.attributes)</span>
<a href="#l14.1723"></a><span id="l14.1723" class="difflineminus">-      subscription = aItem.attributes[&quot;subscription&quot;];</span>
<a href="#l14.1724"></a><span id="l14.1724" class="difflineplus">+      subscription = aItem.attributes.subscription;</span>
<a href="#l14.1725"></a><span id="l14.1725">     if (subscription == &quot;remove&quot;) {</span>
<a href="#l14.1726"></a><span id="l14.1726">       this._forgetRosterItem(jid);</span>
<a href="#l14.1727"></a><span id="l14.1727">       return &quot;&quot;;</span>
<a href="#l14.1728"></a><span id="l14.1728">     }</span>
<a href="#l14.1729"></a><span id="l14.1729"> </span>
<a href="#l14.1730"></a><span id="l14.1730">     let buddy;</span>
<a href="#l14.1731"></a><span id="l14.1731">     if (this._buddies.has(jid)) {</span>
<a href="#l14.1732"></a><span id="l14.1732">       buddy = this._buddies.get(jid);</span>
<a href="#l14.1733"></a><span id="l14.1733" class="difflineat">@@ -2383,17 +2382,17 @@ var XMPPAccountPrototype = {</span>
<a href="#l14.1734"></a><span id="l14.1734">                                                 jid);</span>
<a href="#l14.1735"></a><span id="l14.1735">     }</span>
<a href="#l14.1736"></a><span id="l14.1736"> </span>
<a href="#l14.1737"></a><span id="l14.1737">     // We request the vCard only if we haven't received it yet and are</span>
<a href="#l14.1738"></a><span id="l14.1738">     // subscribed to presence for that contact.</span>
<a href="#l14.1739"></a><span id="l14.1739">     if ((subscription == &quot;both&quot; || subscription == &quot;to&quot;) &amp;&amp; !buddy._vCardReceived)</span>
<a href="#l14.1740"></a><span id="l14.1740">       this._addVCardRequest(jid);</span>
<a href="#l14.1741"></a><span id="l14.1741"> </span>
<a href="#l14.1742"></a><span id="l14.1742" class="difflineminus">-    let alias = &quot;name&quot; in aItem.attributes ? aItem.attributes[&quot;name&quot;] : &quot;&quot;;</span>
<a href="#l14.1743"></a><span id="l14.1743" class="difflineplus">+    let alias = &quot;name&quot; in aItem.attributes ? aItem.attributes.name : &quot;&quot;;</span>
<a href="#l14.1744"></a><span id="l14.1744">     if (alias) {</span>
<a href="#l14.1745"></a><span id="l14.1745">       if (aNotifyOfUpdates &amp;&amp; this._buddies.has(jid))</span>
<a href="#l14.1746"></a><span id="l14.1746">         buddy.rosterAlias = alias;</span>
<a href="#l14.1747"></a><span id="l14.1747">       else</span>
<a href="#l14.1748"></a><span id="l14.1748">         buddy._rosterAlias = alias;</span>
<a href="#l14.1749"></a><span id="l14.1749">     }</span>
<a href="#l14.1750"></a><span id="l14.1750">     else if (buddy._rosterAlias)</span>
<a href="#l14.1751"></a><span id="l14.1751">       buddy.rosterAlias = &quot;&quot;;</span>
<a href="#l14.1752"></a><span id="l14.1752" class="difflineat">@@ -2408,23 +2407,23 @@ var XMPPAccountPrototype = {</span>
<a href="#l14.1753"></a><span id="l14.1753">       buddy._notifyObservers(&quot;status-detail-changed&quot;);</span>
<a href="#l14.1754"></a><span id="l14.1754"> </span>
<a href="#l14.1755"></a><span id="l14.1755">     // Keep the xml nodes of the item so that we don't have to</span>
<a href="#l14.1756"></a><span id="l14.1756">     // recreate them when changing something (eg. the alias) in it.</span>
<a href="#l14.1757"></a><span id="l14.1757">     buddy._rosterItem = aItem;</span>
<a href="#l14.1758"></a><span id="l14.1758"> </span>
<a href="#l14.1759"></a><span id="l14.1759">     return jid;</span>
<a href="#l14.1760"></a><span id="l14.1760">   },</span>
<a href="#l14.1761"></a><span id="l14.1761" class="difflineminus">-  _forgetRosterItem: function(aJID) {</span>
<a href="#l14.1762"></a><span id="l14.1762" class="difflineplus">+  _forgetRosterItem(aJID) {</span>
<a href="#l14.1763"></a><span id="l14.1763">     Services.contacts.accountBuddyRemoved(this._buddies.get(aJID));</span>
<a href="#l14.1764"></a><span id="l14.1764">     this._buddies.delete(aJID);</span>
<a href="#l14.1765"></a><span id="l14.1765">   },</span>
<a href="#l14.1766"></a><span id="l14.1766"> </span>
<a href="#l14.1767"></a><span id="l14.1767">   /* When the roster is received */</span>
<a href="#l14.1768"></a><span id="l14.1768" class="difflineminus">-  onRoster: function(aStanza) {</span>
<a href="#l14.1769"></a><span id="l14.1769" class="difflineplus">+  onRoster(aStanza) {</span>
<a href="#l14.1770"></a><span id="l14.1770">     // For the first element that is a roster stanza.</span>
<a href="#l14.1771"></a><span id="l14.1771">     for (let qe of aStanza.getChildren(&quot;query&quot;)) {</span>
<a href="#l14.1772"></a><span id="l14.1772">       if (qe.uri != Stanza.NS.roster)</span>
<a href="#l14.1773"></a><span id="l14.1773">         continue;</span>
<a href="#l14.1774"></a><span id="l14.1774"> </span>
<a href="#l14.1775"></a><span id="l14.1775">       // Find all the roster items in the new message.</span>
<a href="#l14.1776"></a><span id="l14.1776">       let newRoster = new Set();</span>
<a href="#l14.1777"></a><span id="l14.1777">       for (let item of qe.getChildren(&quot;item&quot;)) {</span>
<a href="#l14.1778"></a><span id="l14.1778" class="difflineat">@@ -2456,17 +2455,17 @@ var XMPPAccountPrototype = {</span>
<a href="#l14.1779"></a><span id="l14.1779">   },</span>
<a href="#l14.1780"></a><span id="l14.1780"> </span>
<a href="#l14.1781"></a><span id="l14.1781">   // Variations of the XMPP protocol can change these default constructors:</span>
<a href="#l14.1782"></a><span id="l14.1782">   _conversationConstructor: XMPPConversation,</span>
<a href="#l14.1783"></a><span id="l14.1783">   _MUCConversationConstructor: XMPPMUCConversation,</span>
<a href="#l14.1784"></a><span id="l14.1784">   _accountBuddyConstructor: XMPPAccountBuddy,</span>
<a href="#l14.1785"></a><span id="l14.1785"> </span>
<a href="#l14.1786"></a><span id="l14.1786">   /* Create a new conversation */</span>
<a href="#l14.1787"></a><span id="l14.1787" class="difflineminus">-  createConversation: function(aName) {</span>
<a href="#l14.1788"></a><span id="l14.1788" class="difflineplus">+  createConversation(aName) {</span>
<a href="#l14.1789"></a><span id="l14.1789">     let convName = this.normalize(aName);</span>
<a href="#l14.1790"></a><span id="l14.1790"> </span>
<a href="#l14.1791"></a><span id="l14.1791">     // Checks if conversation is with a participant of a MUC we are in. We do</span>
<a href="#l14.1792"></a><span id="l14.1792">     // not want to strip the resource as it is of the form room@domain/nick.</span>
<a href="#l14.1793"></a><span id="l14.1793">     let isMucParticipant = this._mucs.has(convName);</span>
<a href="#l14.1794"></a><span id="l14.1794">     if (isMucParticipant)</span>
<a href="#l14.1795"></a><span id="l14.1795">       convName = this.normalizeFullJid(aName);</span>
<a href="#l14.1796"></a><span id="l14.1796"> </span>
<a href="#l14.1797"></a><span id="l14.1797" class="difflineat">@@ -2482,32 +2481,31 @@ var XMPPAccountPrototype = {</span>
<a href="#l14.1798"></a><span id="l14.1798">                      new this._conversationConstructor(this, convName,</span>
<a href="#l14.1799"></a><span id="l14.1799">                                                        isMucParticipant));</span>
<a href="#l14.1800"></a><span id="l14.1800">     }</span>
<a href="#l14.1801"></a><span id="l14.1801"> </span>
<a href="#l14.1802"></a><span id="l14.1802">     return this._conv.get(convName);</span>
<a href="#l14.1803"></a><span id="l14.1803">   },</span>
<a href="#l14.1804"></a><span id="l14.1804"> </span>
<a href="#l14.1805"></a><span id="l14.1805">   /* Remove an existing conversation */</span>
<a href="#l14.1806"></a><span id="l14.1806" class="difflineminus">-  removeConversation: function(aNormalizedName) {</span>
<a href="#l14.1807"></a><span id="l14.1807" class="difflineplus">+  removeConversation(aNormalizedName) {</span>
<a href="#l14.1808"></a><span id="l14.1808">     if (this._conv.has(aNormalizedName))</span>
<a href="#l14.1809"></a><span id="l14.1809">       this._conv.delete(aNormalizedName);</span>
<a href="#l14.1810"></a><span id="l14.1810">     else if (this._mucs.has(aNormalizedName))</span>
<a href="#l14.1811"></a><span id="l14.1811">       this._mucs.delete(aNormalizedName);</span>
<a href="#l14.1812"></a><span id="l14.1812">   },</span>
<a href="#l14.1813"></a><span id="l14.1813"> </span>
<a href="#l14.1814"></a><span id="l14.1814">   /* Private methods */</span>
<a href="#l14.1815"></a><span id="l14.1815"> </span>
<a href="#l14.1816"></a><span id="l14.1816">   /* Disconnect from the server */</span>
<a href="#l14.1817"></a><span id="l14.1817">   /* The aError and aErrorMessage parameters are passed to reportDisconnecting</span>
<a href="#l14.1818"></a><span id="l14.1818">    * and used by the account manager.</span>
<a href="#l14.1819"></a><span id="l14.1819">    * The aQuiet parameter is to avoid sending status change notifications</span>
<a href="#l14.1820"></a><span id="l14.1820">    * during the uninitialization of the account. */</span>
<a href="#l14.1821"></a><span id="l14.1821" class="difflineminus">-  _disconnect: function(aError = Ci.prplIAccount.NO_ERROR, aErrorMessage = &quot;&quot;,</span>
<a href="#l14.1822"></a><span id="l14.1822" class="difflineminus">-                        aQuiet = false) {</span>
<a href="#l14.1823"></a><span id="l14.1823" class="difflineplus">+  _disconnect(aError = Ci.prplIAccount.NO_ERROR, aErrorMessage = &quot;&quot;, aQuiet = false) {</span>
<a href="#l14.1824"></a><span id="l14.1824">     if (!this._connection)</span>
<a href="#l14.1825"></a><span id="l14.1825">       return;</span>
<a href="#l14.1826"></a><span id="l14.1826"> </span>
<a href="#l14.1827"></a><span id="l14.1827">     this.reportDisconnecting(aError, aErrorMessage);</span>
<a href="#l14.1828"></a><span id="l14.1828"> </span>
<a href="#l14.1829"></a><span id="l14.1829">     this._buddies.forEach(b =&gt; {</span>
<a href="#l14.1830"></a><span id="l14.1830">       if (!aQuiet)</span>
<a href="#l14.1831"></a><span id="l14.1831">         b.setStatus(Ci.imIStatusInfo.STATUS_UNKNOWN, &quot;&quot;);</span>
<a href="#l14.1832"></a><span id="l14.1832" class="difflineat">@@ -2532,17 +2530,17 @@ var XMPPAccountPrototype = {</span>
<a href="#l14.1833"></a><span id="l14.1833"> </span>
<a href="#l14.1834"></a><span id="l14.1834">     // Clear vCard requests.</span>
<a href="#l14.1835"></a><span id="l14.1835">     this._pendingVCardRequests = [];</span>
<a href="#l14.1836"></a><span id="l14.1836"> </span>
<a href="#l14.1837"></a><span id="l14.1837">     this.reportDisconnected();</span>
<a href="#l14.1838"></a><span id="l14.1838">   },</span>
<a href="#l14.1839"></a><span id="l14.1839"> </span>
<a href="#l14.1840"></a><span id="l14.1840">   /* Set the user status on the server */</span>
<a href="#l14.1841"></a><span id="l14.1841" class="difflineminus">-  _sendPresence: function() {</span>
<a href="#l14.1842"></a><span id="l14.1842" class="difflineplus">+  _sendPresence() {</span>
<a href="#l14.1843"></a><span id="l14.1843">     delete this._shouldSendPresenceForIdlenessChange;</span>
<a href="#l14.1844"></a><span id="l14.1844"> </span>
<a href="#l14.1845"></a><span id="l14.1845">     if (!this._connection)</span>
<a href="#l14.1846"></a><span id="l14.1846">       return;</span>
<a href="#l14.1847"></a><span id="l14.1847"> </span>
<a href="#l14.1848"></a><span id="l14.1848">     let si = this.imAccount.statusInfo;</span>
<a href="#l14.1849"></a><span id="l14.1849">     let statusType = si.statusType;</span>
<a href="#l14.1850"></a><span id="l14.1850">     let show = &quot;&quot;;</span>
<a href="#l14.1851"></a><span id="l14.1851" class="difflineat">@@ -2570,27 +2568,27 @@ var XMPPAccountPrototype = {</span>
<a href="#l14.1852"></a><span id="l14.1852">       // As we are implicitly subscribed to our own presence (rfc6121#4), we</span>
<a href="#l14.1853"></a><span id="l14.1853">       // will receive the presence stanza mirrored back to us. We don't need</span>
<a href="#l14.1854"></a><span id="l14.1854">       // to do anything with this response.</span>
<a href="#l14.1855"></a><span id="l14.1855">       return true;</span>
<a href="#l14.1856"></a><span id="l14.1856">     });</span>
<a href="#l14.1857"></a><span id="l14.1857">   },</span>
<a href="#l14.1858"></a><span id="l14.1858"> </span>
<a href="#l14.1859"></a><span id="l14.1859">   _downloadingUserVCard: false,</span>
<a href="#l14.1860"></a><span id="l14.1860" class="difflineminus">-  _downloadUserVCard: function() {</span>
<a href="#l14.1861"></a><span id="l14.1861" class="difflineplus">+  _downloadUserVCard() {</span>
<a href="#l14.1862"></a><span id="l14.1862">     // If a download is already in progress, don't start another one.</span>
<a href="#l14.1863"></a><span id="l14.1863">     if (this._downloadingUserVCard)</span>
<a href="#l14.1864"></a><span id="l14.1864">       return;</span>
<a href="#l14.1865"></a><span id="l14.1865">     this._downloadingUserVCard = true;</span>
<a href="#l14.1866"></a><span id="l14.1866">     let s = Stanza.iq(&quot;get&quot;, null, null,</span>
<a href="#l14.1867"></a><span id="l14.1867">                       Stanza.node(&quot;vCard&quot;, Stanza.NS.vcard));</span>
<a href="#l14.1868"></a><span id="l14.1868">     this.sendStanza(s, this.onUserVCard, this);</span>
<a href="#l14.1869"></a><span id="l14.1869">   },</span>
<a href="#l14.1870"></a><span id="l14.1870"> </span>
<a href="#l14.1871"></a><span id="l14.1871" class="difflineminus">-  onUserVCard: function(aStanza) {</span>
<a href="#l14.1872"></a><span id="l14.1872" class="difflineplus">+  onUserVCard(aStanza) {</span>
<a href="#l14.1873"></a><span id="l14.1873">     delete this._downloadingUserVCard;</span>
<a href="#l14.1874"></a><span id="l14.1874">     let userVCard = aStanza.getElement([&quot;vCard&quot;]) || null;</span>
<a href="#l14.1875"></a><span id="l14.1875">     if (userVCard) {</span>
<a href="#l14.1876"></a><span id="l14.1876">       // Strip any server-specific namespace off the incoming vcard</span>
<a href="#l14.1877"></a><span id="l14.1877">       // before storing it.</span>
<a href="#l14.1878"></a><span id="l14.1878">       this._userVCard =</span>
<a href="#l14.1879"></a><span id="l14.1879">         Stanza.node(&quot;vCard&quot;, Stanza.NS.vcard, null, userVCard.children);</span>
<a href="#l14.1880"></a><span id="l14.1880">     }</span>
<a href="#l14.1881"></a><span id="l14.1881" class="difflineat">@@ -2606,47 +2604,47 @@ var XMPPAccountPrototype = {</span>
<a href="#l14.1882"></a><span id="l14.1882">         binval.text = binval.text.replace(/[^A-Za-z0-9\+\/\=]/g, &quot;&quot;)</span>
<a href="#l14.1883"></a><span id="l14.1883">                                  .replace(/.{74}/g, &quot;$&amp;\n&quot;);</span>
<a href="#l14.1884"></a><span id="l14.1884">       }</span>
<a href="#l14.1885"></a><span id="l14.1885">     }</span>
<a href="#l14.1886"></a><span id="l14.1886">     else {</span>
<a href="#l14.1887"></a><span id="l14.1887">       // Downloading the vCard failed.</span>
<a href="#l14.1888"></a><span id="l14.1888">       if (this.handleErrors({</span>
<a href="#l14.1889"></a><span id="l14.1889">           itemNotFound: () =&gt; false,  // OK, no vCard exists yet.</span>
<a href="#l14.1890"></a><span id="l14.1890" class="difflineminus">-          default: () =&gt; true</span>
<a href="#l14.1891"></a><span id="l14.1891" class="difflineplus">+          default: () =&gt; true,</span>
<a href="#l14.1892"></a><span id="l14.1892">         })(aStanza)) {</span>
<a href="#l14.1893"></a><span id="l14.1893">         this.WARN(&quot;Unexpected error retrieving the user's vcard, &quot; +</span>
<a href="#l14.1894"></a><span id="l14.1894">           &quot;so we won't attempt to set it either.&quot;);</span>
<a href="#l14.1895"></a><span id="l14.1895">         return;</span>
<a href="#l14.1896"></a><span id="l14.1896">       }</span>
<a href="#l14.1897"></a><span id="l14.1897">       // Set this so that we don't get into an infinite loop trying to download</span>
<a href="#l14.1898"></a><span id="l14.1898">       // the vcard again. The check in sendVCard is for hasOwnProperty.</span>
<a href="#l14.1899"></a><span id="l14.1899">       this._userVCard = null;</span>
<a href="#l14.1900"></a><span id="l14.1900">     }</span>
<a href="#l14.1901"></a><span id="l14.1901">     this._sendVCard();</span>
<a href="#l14.1902"></a><span id="l14.1902">   },</span>
<a href="#l14.1903"></a><span id="l14.1903"> </span>
<a href="#l14.1904"></a><span id="l14.1904">   _cachingUserIcon: false,</span>
<a href="#l14.1905"></a><span id="l14.1905" class="difflineminus">-  _cacheUserIcon: function() {</span>
<a href="#l14.1906"></a><span id="l14.1906" class="difflineplus">+  _cacheUserIcon() {</span>
<a href="#l14.1907"></a><span id="l14.1907">     if (this._cachingUserIcon)</span>
<a href="#l14.1908"></a><span id="l14.1908">       return;</span>
<a href="#l14.1909"></a><span id="l14.1909"> </span>
<a href="#l14.1910"></a><span id="l14.1910">     let userIcon = this.imAccount.statusInfo.getUserIcon();</span>
<a href="#l14.1911"></a><span id="l14.1911">     if (!userIcon) {</span>
<a href="#l14.1912"></a><span id="l14.1912">       this._cachedUserIcon = null;</span>
<a href="#l14.1913"></a><span id="l14.1913">       this._sendVCard();</span>
<a href="#l14.1914"></a><span id="l14.1914">       return;</span>
<a href="#l14.1915"></a><span id="l14.1915">     }</span>
<a href="#l14.1916"></a><span id="l14.1916"> </span>
<a href="#l14.1917"></a><span id="l14.1917">     this._cachingUserIcon = true;</span>
<a href="#l14.1918"></a><span id="l14.1918">     let channel = NetUtil.newChannel({</span>
<a href="#l14.1919"></a><span id="l14.1919">       uri: userIcon,</span>
<a href="#l14.1920"></a><span id="l14.1920">       loadingPrincipal: Services.scriptSecurityManager.getSystemPrincipal(),</span>
<a href="#l14.1921"></a><span id="l14.1921">       securityFlags: Ci.nsILoadInfo.SEC_REQUIRE_SAME_ORIGIN_DATA_INHERITS,</span>
<a href="#l14.1922"></a><span id="l14.1922" class="difflineminus">-      contentPolicyType: Ci.nsIContentPolicy.TYPE_IMAGE</span>
<a href="#l14.1923"></a><span id="l14.1923" class="difflineplus">+      contentPolicyType: Ci.nsIContentPolicy.TYPE_IMAGE,</span>
<a href="#l14.1924"></a><span id="l14.1924">     });</span>
<a href="#l14.1925"></a><span id="l14.1925">     NetUtil.asyncFetch(channel, (inputStream, resultCode) =&gt; {</span>
<a href="#l14.1926"></a><span id="l14.1926">       if (!Components.isSuccessCode(resultCode))</span>
<a href="#l14.1927"></a><span id="l14.1927">         return;</span>
<a href="#l14.1928"></a><span id="l14.1928">       try {</span>
<a href="#l14.1929"></a><span id="l14.1929">         let type = channel.contentType;</span>
<a href="#l14.1930"></a><span id="l14.1930">         let buffer = NetUtil.readInputStreamToString(inputStream, inputStream.available());</span>
<a href="#l14.1931"></a><span id="l14.1931">         let readImage = imgTools.decodeImageFromBuffer(buffer, buffer.length, type);</span>
<a href="#l14.1932"></a><span id="l14.1932" class="difflineat">@@ -2660,28 +2658,28 @@ var XMPPAccountPrototype = {</span>
<a href="#l14.1933"></a><span id="l14.1933">         }</span>
<a href="#l14.1934"></a><span id="l14.1934"> </span>
<a href="#l14.1935"></a><span id="l14.1935">         let bstream = Cc[&quot;@mozilla.org/binaryinputstream;1&quot;]</span>
<a href="#l14.1936"></a><span id="l14.1936">                         .createInstance(Ci.nsIBinaryInputStream);</span>
<a href="#l14.1937"></a><span id="l14.1937">         bstream.setInputStream(scaledImage);</span>
<a href="#l14.1938"></a><span id="l14.1938"> </span>
<a href="#l14.1939"></a><span id="l14.1939">         let data = bstream.readBytes(bstream.available());</span>
<a href="#l14.1940"></a><span id="l14.1940">         this._cachedUserIcon = {</span>
<a href="#l14.1941"></a><span id="l14.1941" class="difflineminus">-          type: type,</span>
<a href="#l14.1942"></a><span id="l14.1942" class="difflineminus">-          binval: btoa(data).replace(/.{74}/g, &quot;$&amp;\n&quot;)</span>
<a href="#l14.1943"></a><span id="l14.1943" class="difflineplus">+          type,</span>
<a href="#l14.1944"></a><span id="l14.1944" class="difflineplus">+          binval: btoa(data).replace(/.{74}/g, &quot;$&amp;\n&quot;),</span>
<a href="#l14.1945"></a><span id="l14.1945">         };</span>
<a href="#l14.1946"></a><span id="l14.1946">       } catch (e) {</span>
<a href="#l14.1947"></a><span id="l14.1947">         Cu.reportError(e);</span>
<a href="#l14.1948"></a><span id="l14.1948">         this._cachedUserIcon = null;</span>
<a href="#l14.1949"></a><span id="l14.1949">       }</span>
<a href="#l14.1950"></a><span id="l14.1950">       delete this._cachingUserIcon;</span>
<a href="#l14.1951"></a><span id="l14.1951">       this._sendVCard();</span>
<a href="#l14.1952"></a><span id="l14.1952">     });</span>
<a href="#l14.1953"></a><span id="l14.1953">   },</span>
<a href="#l14.1954"></a><span id="l14.1954" class="difflineminus">-  _sendVCard: function() {</span>
<a href="#l14.1955"></a><span id="l14.1955" class="difflineplus">+  _sendVCard() {</span>
<a href="#l14.1956"></a><span id="l14.1956">     if (!this._connection)</span>
<a href="#l14.1957"></a><span id="l14.1957">       return;</span>
<a href="#l14.1958"></a><span id="l14.1958"> </span>
<a href="#l14.1959"></a><span id="l14.1959">     // We have to download the user's existing vCard before updating it.</span>
<a href="#l14.1960"></a><span id="l14.1960">     // This lets us preserve the fields that we don't change or don't know.</span>
<a href="#l14.1961"></a><span id="l14.1961">     // Some servers may reject a new vCard if we don't do this first.</span>
<a href="#l14.1962"></a><span id="l14.1962">     if (!this.hasOwnProperty(&quot;_userVCard&quot;)) {</span>
<a href="#l14.1963"></a><span id="l14.1963">       // The download of the vCard is asynchronous and will call _sendVCard back</span>
<a href="#l14.1964"></a><span id="l14.1964" class="difflineat">@@ -2707,38 +2705,36 @@ var XMPPAccountPrototype = {</span>
<a href="#l14.1965"></a><span id="l14.1965">     let existingVCard = this._userVCard.getXML();</span>
<a href="#l14.1966"></a><span id="l14.1966"> </span>
<a href="#l14.1967"></a><span id="l14.1967">     let fn = this._userVCard.getElement([&quot;FN&quot;]);</span>
<a href="#l14.1968"></a><span id="l14.1968">     let displayName = this.imAccount.statusInfo.displayName;</span>
<a href="#l14.1969"></a><span id="l14.1969">     if (displayName) {</span>
<a href="#l14.1970"></a><span id="l14.1970">       // If a display name is set locally, update or add an FN field to the vCard.</span>
<a href="#l14.1971"></a><span id="l14.1971">       if (!fn)</span>
<a href="#l14.1972"></a><span id="l14.1972">         this._userVCard.addChild(Stanza.node(&quot;FN&quot;, Stanza.NS.vcard, null, displayName));</span>
<a href="#l14.1973"></a><span id="l14.1973" class="difflineminus">-      else {</span>
<a href="#l14.1974"></a><span id="l14.1974" class="difflineminus">-        if (fn.children.length)</span>
<a href="#l14.1975"></a><span id="l14.1975" class="difflineminus">-          fn.children[0].text = displayName;</span>
<a href="#l14.1976"></a><span id="l14.1976" class="difflineminus">-        else</span>
<a href="#l14.1977"></a><span id="l14.1977" class="difflineminus">-          fn.addText(displayName);</span>
<a href="#l14.1978"></a><span id="l14.1978" class="difflineminus">-      }</span>
<a href="#l14.1979"></a><span id="l14.1979" class="difflineplus">+      else if (fn.children.length)</span>
<a href="#l14.1980"></a><span id="l14.1980" class="difflineplus">+        fn.children[0].text = displayName;</span>
<a href="#l14.1981"></a><span id="l14.1981" class="difflineplus">+      else</span>
<a href="#l14.1982"></a><span id="l14.1982" class="difflineplus">+        fn.addText(displayName);</span>
<a href="#l14.1983"></a><span id="l14.1983">     }</span>
<a href="#l14.1984"></a><span id="l14.1984">     else if (&quot;_forceUserDisplayNameUpdate&quot; in this) {</span>
<a href="#l14.1985"></a><span id="l14.1985">       // We remove a display name stored on the server without replacing</span>
<a href="#l14.1986"></a><span id="l14.1986">       // it with a new value only if this _sendVCard call is the result of</span>
<a href="#l14.1987"></a><span id="l14.1987">       // a user action. This is to avoid removing data from the server each</span>
<a href="#l14.1988"></a><span id="l14.1988">       // time the user connects from a new profile.</span>
<a href="#l14.1989"></a><span id="l14.1989">       this._userVCard.children =</span>
<a href="#l14.1990"></a><span id="l14.1990">         this._userVCard.children.filter(n =&gt; n.qName != &quot;FN&quot;);</span>
<a href="#l14.1991"></a><span id="l14.1991">     }</span>
<a href="#l14.1992"></a><span id="l14.1992">     delete this._forceUserDisplayNameUpdate;</span>
<a href="#l14.1993"></a><span id="l14.1993"> </span>
<a href="#l14.1994"></a><span id="l14.1994">     if (this._cachedUserIcon) {</span>
<a href="#l14.1995"></a><span id="l14.1995">       // If we have a local user icon, update or add it in the PHOTO field.</span>
<a href="#l14.1996"></a><span id="l14.1996">       let photoChildren = [</span>
<a href="#l14.1997"></a><span id="l14.1997">         Stanza.node(&quot;TYPE&quot;, Stanza.NS.vcard, null, this._cachedUserIcon.type),</span>
<a href="#l14.1998"></a><span id="l14.1998" class="difflineminus">-        Stanza.node(&quot;BINVAL&quot;, Stanza.NS.vcard, null, this._cachedUserIcon.binval)</span>
<a href="#l14.1999"></a><span id="l14.1999" class="difflineplus">+        Stanza.node(&quot;BINVAL&quot;, Stanza.NS.vcard, null, this._cachedUserIcon.binval),</span>
<a href="#l14.2000"></a><span id="l14.2000">       ];</span>
<a href="#l14.2001"></a><span id="l14.2001">       let photo = this._userVCard.getElement([&quot;PHOTO&quot;]);</span>
<a href="#l14.2002"></a><span id="l14.2002">       if (photo)</span>
<a href="#l14.2003"></a><span id="l14.2003">         photo.children = photoChildren;</span>
<a href="#l14.2004"></a><span id="l14.2004">       else</span>
<a href="#l14.2005"></a><span id="l14.2005">         this._userVCard.addChild(Stanza.node(&quot;PHOTO&quot;, Stanza.NS.vcard, null,</span>
<a href="#l14.2006"></a><span id="l14.2006">                                              photoChildren));</span>
<a href="#l14.2007"></a><span id="l14.2007">     }</span>
<a href="#l14.2008"></a><span id="l14.2008" class="difflineat">@@ -2754,16 +2750,16 @@ var XMPPAccountPrototype = {</span>
<a href="#l14.2009"></a><span id="l14.2009">     // We handle the result response from the server (it does not require</span>
<a href="#l14.2010"></a><span id="l14.2010">     // any further action).</span>
<a href="#l14.2011"></a><span id="l14.2011">     if (this._userVCard.getXML() != existingVCard) {</span>
<a href="#l14.2012"></a><span id="l14.2012">       this.sendStanza(Stanza.iq(&quot;set&quot;, null, null, this._userVCard),</span>
<a href="#l14.2013"></a><span id="l14.2013">                       this._handleResult());</span>
<a href="#l14.2014"></a><span id="l14.2014">     }</span>
<a href="#l14.2015"></a><span id="l14.2015">     else</span>
<a href="#l14.2016"></a><span id="l14.2016">       this.LOG(&quot;Not sending the vCard because the server stored vCard is identical.&quot;);</span>
<a href="#l14.2017"></a><span id="l14.2017" class="difflineminus">-  }</span>
<a href="#l14.2018"></a><span id="l14.2018" class="difflineplus">+  },</span>
<a href="#l14.2019"></a><span id="l14.2019"> };</span>
<a href="#l14.2020"></a><span id="l14.2020"> function XMPPAccount(aProtocol, aImAccount)</span>
<a href="#l14.2021"></a><span id="l14.2021"> {</span>
<a href="#l14.2022"></a><span id="l14.2022">   this._pendingVCardRequests = [];</span>
<a href="#l14.2023"></a><span id="l14.2023">   this._init(aProtocol, aImAccount);</span>
<a href="#l14.2024"></a><span id="l14.2024"> }</span>
<a href="#l14.2025"></a><span id="l14.2025"> XMPPAccount.prototype = XMPPAccountPrototype;</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:31Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

