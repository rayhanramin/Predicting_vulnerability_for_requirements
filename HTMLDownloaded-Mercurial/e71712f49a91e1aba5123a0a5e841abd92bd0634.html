<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 28462:e71712f49a91e1aba5123a0a5e841abd92bd0634</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ e71712f49a91e1aba5123a0a5e841abd92bd0634" />
<meta property="og:url" content="/comm-central/rev/e71712f49a91e1aba5123a0a5e841abd92bd0634" />
<meta property="og:description" content="Bug 1602425 - Remove xpidl [array] use in calIRecurrenceRule. r=darktrojan" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / e71712f49a91e1aba5123a0a5e841abd92bd0634 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/e71712f49a91e1aba5123a0a5e841abd92bd0634">shortlog</a> |
<a href="/comm-central/log/e71712f49a91e1aba5123a0a5e841abd92bd0634">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/e71712f49a91e1aba5123a0a5e841abd92bd0634">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/e71712f49a91e1aba5123a0a5e841abd92bd0634">files</a> |
changeset |
<a href="/comm-central/raw-rev/e71712f49a91e1aba5123a0a5e841abd92bd0634">raw</a>  | <a href="/comm-central/archive/e71712f49a91e1aba5123a0a5e841abd92bd0634.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1602425">Bug 1602425</a> - Remove xpidl [array] use in calIRecurrenceRule. r=darktrojan
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#66;&#101;&#110;&#32;&#67;&#97;&#109;&#112;&#98;&#101;&#108;&#108;&#32;&#60;&#98;&#101;&#110;&#99;&#64;&#116;&#104;&#117;&#110;&#100;&#101;&#114;&#98;&#105;&#114;&#100;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 23 Dec 2019 12:18:20 +1300</td></tr>

<tr>
 <td>changeset 28462</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/e71712f49a91e1aba5123a0a5e841abd92bd0634">e71712f49a91e1aba5123a0a5e841abd92bd0634</a></td>
</tr>



<tr>
<td>parent 28461</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/5ba4422e867f7f2b922673b2b8bb58dac0a788e3">5ba4422e867f7f2b922673b2b8bb58dac0a788e3</a>
</td>
</tr>

<tr>
<td>child 28463</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/97cfef598a7607d3c722d91f46ec5d1db924f84b">97cfef598a7607d3c722d91f46ec5d1db924f84b</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=e71712f49a91e1aba5123a0a5e841abd92bd0634">16857</a></td></tr>
<tr><td>push user</td><td>geoff@darktrojan.net</td></tr>
<tr><td>push date</td><td class="date age">Tue, 31 Dec 2019 00:25:03 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@e71712f49a91 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=e71712f49a91e1aba5123a0a5e841abd92bd0634">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=e71712f49a91e1aba5123a0a5e841abd92bd0634&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=e71712f49a91e1aba5123a0a5e841abd92bd0634&newProject=comm-central&newRevision=047a04a5198d3e0d1862279a25b19e549c67782d&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=e71712f49a91e1aba5123a0a5e841abd92bd0634&newProject=comm-central&newRevision=047a04a5198d3e0d1862279a25b19e549c67782d&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=e71712f49a91e1aba5123a0a5e841abd92bd0634&newProject=comm-central&newRevision=047a04a5198d3e0d1862279a25b19e549c67782d&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28darktrojan%29&revcount=50">darktrojan</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1602425">1602425</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1602425">Bug 1602425</a> - Remove xpidl [array] use in calIRecurrenceRule. r=darktrojan</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e71712f49a91e1aba5123a0a5e841abd92bd0634/calendar/base/backend/icaljs/calRecurrenceRule.js">calendar/base/backend/icaljs/calRecurrenceRule.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e71712f49a91e1aba5123a0a5e841abd92bd0634/calendar/base/backend/icaljs/calRecurrenceRule.js">file</a> |
<a href="/comm-central/annotate/e71712f49a91e1aba5123a0a5e841abd92bd0634/calendar/base/backend/icaljs/calRecurrenceRule.js">annotate</a> |
<a href="/comm-central/diff/e71712f49a91e1aba5123a0a5e841abd92bd0634/calendar/base/backend/icaljs/calRecurrenceRule.js">diff</a> |
<a href="/comm-central/comparison/e71712f49a91e1aba5123a0a5e841abd92bd0634/calendar/base/backend/icaljs/calRecurrenceRule.js">comparison</a> |
<a href="/comm-central/log/e71712f49a91e1aba5123a0a5e841abd92bd0634/calendar/base/backend/icaljs/calRecurrenceRule.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e71712f49a91e1aba5123a0a5e841abd92bd0634/calendar/base/backend/libical/calRecurrenceRule.cpp">calendar/base/backend/libical/calRecurrenceRule.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e71712f49a91e1aba5123a0a5e841abd92bd0634/calendar/base/backend/libical/calRecurrenceRule.cpp">file</a> |
<a href="/comm-central/annotate/e71712f49a91e1aba5123a0a5e841abd92bd0634/calendar/base/backend/libical/calRecurrenceRule.cpp">annotate</a> |
<a href="/comm-central/diff/e71712f49a91e1aba5123a0a5e841abd92bd0634/calendar/base/backend/libical/calRecurrenceRule.cpp">diff</a> |
<a href="/comm-central/comparison/e71712f49a91e1aba5123a0a5e841abd92bd0634/calendar/base/backend/libical/calRecurrenceRule.cpp">comparison</a> |
<a href="/comm-central/log/e71712f49a91e1aba5123a0a5e841abd92bd0634/calendar/base/backend/libical/calRecurrenceRule.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e71712f49a91e1aba5123a0a5e841abd92bd0634/calendar/base/content/dialogs/calendar-event-dialog-recurrence.js">calendar/base/content/dialogs/calendar-event-dialog-recurrence.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e71712f49a91e1aba5123a0a5e841abd92bd0634/calendar/base/content/dialogs/calendar-event-dialog-recurrence.js">file</a> |
<a href="/comm-central/annotate/e71712f49a91e1aba5123a0a5e841abd92bd0634/calendar/base/content/dialogs/calendar-event-dialog-recurrence.js">annotate</a> |
<a href="/comm-central/diff/e71712f49a91e1aba5123a0a5e841abd92bd0634/calendar/base/content/dialogs/calendar-event-dialog-recurrence.js">diff</a> |
<a href="/comm-central/comparison/e71712f49a91e1aba5123a0a5e841abd92bd0634/calendar/base/content/dialogs/calendar-event-dialog-recurrence.js">comparison</a> |
<a href="/comm-central/log/e71712f49a91e1aba5123a0a5e841abd92bd0634/calendar/base/content/dialogs/calendar-event-dialog-recurrence.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e71712f49a91e1aba5123a0a5e841abd92bd0634/calendar/base/modules/calRecurrenceUtils.jsm">calendar/base/modules/calRecurrenceUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e71712f49a91e1aba5123a0a5e841abd92bd0634/calendar/base/modules/calRecurrenceUtils.jsm">file</a> |
<a href="/comm-central/annotate/e71712f49a91e1aba5123a0a5e841abd92bd0634/calendar/base/modules/calRecurrenceUtils.jsm">annotate</a> |
<a href="/comm-central/diff/e71712f49a91e1aba5123a0a5e841abd92bd0634/calendar/base/modules/calRecurrenceUtils.jsm">diff</a> |
<a href="/comm-central/comparison/e71712f49a91e1aba5123a0a5e841abd92bd0634/calendar/base/modules/calRecurrenceUtils.jsm">comparison</a> |
<a href="/comm-central/log/e71712f49a91e1aba5123a0a5e841abd92bd0634/calendar/base/modules/calRecurrenceUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e71712f49a91e1aba5123a0a5e841abd92bd0634/calendar/base/public/calIRecurrenceRule.idl">calendar/base/public/calIRecurrenceRule.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e71712f49a91e1aba5123a0a5e841abd92bd0634/calendar/base/public/calIRecurrenceRule.idl">file</a> |
<a href="/comm-central/annotate/e71712f49a91e1aba5123a0a5e841abd92bd0634/calendar/base/public/calIRecurrenceRule.idl">annotate</a> |
<a href="/comm-central/diff/e71712f49a91e1aba5123a0a5e841abd92bd0634/calendar/base/public/calIRecurrenceRule.idl">diff</a> |
<a href="/comm-central/comparison/e71712f49a91e1aba5123a0a5e841abd92bd0634/calendar/base/public/calIRecurrenceRule.idl">comparison</a> |
<a href="/comm-central/log/e71712f49a91e1aba5123a0a5e841abd92bd0634/calendar/base/public/calIRecurrenceRule.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e71712f49a91e1aba5123a0a5e841abd92bd0634/calendar/lightning/content/lightning-item-iframe.js">calendar/lightning/content/lightning-item-iframe.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e71712f49a91e1aba5123a0a5e841abd92bd0634/calendar/lightning/content/lightning-item-iframe.js">file</a> |
<a href="/comm-central/annotate/e71712f49a91e1aba5123a0a5e841abd92bd0634/calendar/lightning/content/lightning-item-iframe.js">annotate</a> |
<a href="/comm-central/diff/e71712f49a91e1aba5123a0a5e841abd92bd0634/calendar/lightning/content/lightning-item-iframe.js">diff</a> |
<a href="/comm-central/comparison/e71712f49a91e1aba5123a0a5e841abd92bd0634/calendar/lightning/content/lightning-item-iframe.js">comparison</a> |
<a href="/comm-central/log/e71712f49a91e1aba5123a0a5e841abd92bd0634/calendar/lightning/content/lightning-item-iframe.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e71712f49a91e1aba5123a0a5e841abd92bd0634/calendar/providers/storage/calStorageUpgrade.jsm">calendar/providers/storage/calStorageUpgrade.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e71712f49a91e1aba5123a0a5e841abd92bd0634/calendar/providers/storage/calStorageUpgrade.jsm">file</a> |
<a href="/comm-central/annotate/e71712f49a91e1aba5123a0a5e841abd92bd0634/calendar/providers/storage/calStorageUpgrade.jsm">annotate</a> |
<a href="/comm-central/diff/e71712f49a91e1aba5123a0a5e841abd92bd0634/calendar/providers/storage/calStorageUpgrade.jsm">diff</a> |
<a href="/comm-central/comparison/e71712f49a91e1aba5123a0a5e841abd92bd0634/calendar/providers/storage/calStorageUpgrade.jsm">comparison</a> |
<a href="/comm-central/log/e71712f49a91e1aba5123a0a5e841abd92bd0634/calendar/providers/storage/calStorageUpgrade.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e71712f49a91e1aba5123a0a5e841abd92bd0634/calendar/test/unit/test_ics_service.js">calendar/test/unit/test_ics_service.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e71712f49a91e1aba5123a0a5e841abd92bd0634/calendar/test/unit/test_ics_service.js">file</a> |
<a href="/comm-central/annotate/e71712f49a91e1aba5123a0a5e841abd92bd0634/calendar/test/unit/test_ics_service.js">annotate</a> |
<a href="/comm-central/diff/e71712f49a91e1aba5123a0a5e841abd92bd0634/calendar/test/unit/test_ics_service.js">diff</a> |
<a href="/comm-central/comparison/e71712f49a91e1aba5123a0a5e841abd92bd0634/calendar/test/unit/test_ics_service.js">comparison</a> |
<a href="/comm-central/log/e71712f49a91e1aba5123a0a5e841abd92bd0634/calendar/test/unit/test_ics_service.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e71712f49a91e1aba5123a0a5e841abd92bd0634/calendar/test/unit/test_recur.js">calendar/test/unit/test_recur.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e71712f49a91e1aba5123a0a5e841abd92bd0634/calendar/test/unit/test_recur.js">file</a> |
<a href="/comm-central/annotate/e71712f49a91e1aba5123a0a5e841abd92bd0634/calendar/test/unit/test_recur.js">annotate</a> |
<a href="/comm-central/diff/e71712f49a91e1aba5123a0a5e841abd92bd0634/calendar/test/unit/test_recur.js">diff</a> |
<a href="/comm-central/comparison/e71712f49a91e1aba5123a0a5e841abd92bd0634/calendar/test/unit/test_recur.js">comparison</a> |
<a href="/comm-central/log/e71712f49a91e1aba5123a0a5e841abd92bd0634/calendar/test/unit/test_recur.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e71712f49a91e1aba5123a0a5e841abd92bd0634/calendar/test/unit/test_storage.js">calendar/test/unit/test_storage.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e71712f49a91e1aba5123a0a5e841abd92bd0634/calendar/test/unit/test_storage.js">file</a> |
<a href="/comm-central/annotate/e71712f49a91e1aba5123a0a5e841abd92bd0634/calendar/test/unit/test_storage.js">annotate</a> |
<a href="/comm-central/diff/e71712f49a91e1aba5123a0a5e841abd92bd0634/calendar/test/unit/test_storage.js">diff</a> |
<a href="/comm-central/comparison/e71712f49a91e1aba5123a0a5e841abd92bd0634/calendar/test/unit/test_storage.js">comparison</a> |
<a href="/comm-central/log/e71712f49a91e1aba5123a0a5e841abd92bd0634/calendar/test/unit/test_storage.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/calendar/base/backend/icaljs/calRecurrenceRule.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/calendar/base/backend/icaljs/calRecurrenceRule.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -192,17 +192,17 @@ calRecurrenceRule.prototype = {</span>
<a href="#l1.4"></a><span id="l1.4">   get weekStart() {</span>
<a href="#l1.5"></a><span id="l1.5">     return this.innerObject.wkst - 1;</span>
<a href="#l1.6"></a><span id="l1.6">   },</span>
<a href="#l1.7"></a><span id="l1.7">   set weekStart(val) {</span>
<a href="#l1.8"></a><span id="l1.8">     this.ensureMutable();</span>
<a href="#l1.9"></a><span id="l1.9">     this.innerObject.wkst = val + 1;</span>
<a href="#l1.10"></a><span id="l1.10">   },</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-  getComponent: function(aType, aCount) {</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+  getComponent: function(aType) {</span>
<a href="#l1.14"></a><span id="l1.14">     let values = this.innerObject.getComponent(aType);</span>
<a href="#l1.15"></a><span id="l1.15">     if (aType == &quot;BYDAY&quot;) {</span>
<a href="#l1.16"></a><span id="l1.16">       // BYDAY values are alphanumeric: SU, MO, TU, etc..</span>
<a href="#l1.17"></a><span id="l1.17">       for (let i = 0; i &lt; values.length; i++) {</span>
<a href="#l1.18"></a><span id="l1.18">         let match = /^([+-])?(5[0-3]|[1-4][0-9]|[1-9])?(SU|MO|TU|WE|TH|FR|SA)$/.exec(values[i]);</span>
<a href="#l1.19"></a><span id="l1.19">         if (!match) {</span>
<a href="#l1.20"></a><span id="l1.20">           cal.ERROR(&quot;Malformed BYDAY rule\n&quot; + cal.STACK(10));</span>
<a href="#l1.21"></a><span id="l1.21">           return [];</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineat">@@ -214,23 +214,20 @@ calRecurrenceRule.prototype = {</span>
<a href="#l1.23"></a><span id="l1.23">         }</span>
<a href="#l1.24"></a><span id="l1.24">         if (match[1] == &quot;-&quot;) {</span>
<a href="#l1.25"></a><span id="l1.25">           // Week numbers are counted back from the end of the period.</span>
<a href="#l1.26"></a><span id="l1.26">           values[i] *= -1;</span>
<a href="#l1.27"></a><span id="l1.27">         }</span>
<a href="#l1.28"></a><span id="l1.28">       }</span>
<a href="#l1.29"></a><span id="l1.29">     }</span>
<a href="#l1.30"></a><span id="l1.30"> </span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-    if (aCount) {</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineminus">-      aCount.value = values.length;</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineminus">-    }</span>
<a href="#l1.34"></a><span id="l1.34">     return values;</span>
<a href="#l1.35"></a><span id="l1.35">   },</span>
<a href="#l1.36"></a><span id="l1.36"> </span>
<a href="#l1.37"></a><span id="l1.37" class="difflineminus">-  setComponent: function(aType, aCount, aValues) {</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineplus">+  setComponent: function(aType, aValues) {</span>
<a href="#l1.39"></a><span id="l1.39">     let values = aValues;</span>
<a href="#l1.40"></a><span id="l1.40">     if (aType == &quot;BYDAY&quot;) {</span>
<a href="#l1.41"></a><span id="l1.41">       // BYDAY values are alphanumeric: SU, MO, TU, etc..</span>
<a href="#l1.42"></a><span id="l1.42">       for (let i = 0; i &lt; values.length; i++) {</span>
<a href="#l1.43"></a><span id="l1.43">         let absValue = Math.abs(values[i]);</span>
<a href="#l1.44"></a><span id="l1.44">         if (absValue &gt; 7) {</span>
<a href="#l1.45"></a><span id="l1.45">           let ordinal = Math.trunc(values[i] / 8);</span>
<a href="#l1.46"></a><span id="l1.46">           let day = ICAL.Recur.numericDayToIcalDay(absValue % 8);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/calendar/base/backend/libical/calRecurrenceRule.cpp</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/calendar/base/backend/libical/calRecurrenceRule.cpp</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -231,95 +231,80 @@ calRecurrenceRule::GetInterval(int32_t *</span>
<a href="#l2.4"></a><span id="l2.4"> NS_IMETHODIMP</span>
<a href="#l2.5"></a><span id="l2.5"> calRecurrenceRule::SetInterval(int32_t aInterval) {</span>
<a href="#l2.6"></a><span id="l2.6">   if (mImmutable) return NS_ERROR_OBJECT_IS_IMMUTABLE;</span>
<a href="#l2.7"></a><span id="l2.7">   if (aInterval &lt; 0 || aInterval &gt; SHRT_MAX) return NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l2.8"></a><span id="l2.8">   mIcalRecur.interval = static_cast&lt;short&gt;(aInterval);</span>
<a href="#l2.9"></a><span id="l2.9">   return NS_OK;</span>
<a href="#l2.10"></a><span id="l2.10"> }</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-/* void getComponent (in AUTF8String aComponentType, out unsigned long aCount,</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">- * [array, size_is (aCount), retval] out long aValues); */</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+// Helper table to encode the size/location of the various arrays in the</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+// icalrecurrencetype struct.</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+static const struct {</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+  const char *name;</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+  size_t offset;</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+  size_t maxCount;</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+} recurrenceTable[] = {</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineplus">+    {&quot;BYSECOND&quot;, offsetof(icalrecurrencetype, by_second), ICAL_BY_SECOND_SIZE},</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineplus">+    {&quot;BYMINUTE&quot;, offsetof(icalrecurrencetype, by_minute), ICAL_BY_MINUTE_SIZE},</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineplus">+    {&quot;BYHOUR&quot;, offsetof(icalrecurrencetype, by_hour), ICAL_BY_HOUR_SIZE},</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineplus">+    {&quot;BYDAY&quot;, offsetof(icalrecurrencetype, by_day), ICAL_BY_DAY_SIZE},</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineplus">+    {&quot;BYMONTHDAY&quot;, offsetof(icalrecurrencetype, by_month_day),</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineplus">+     ICAL_BY_MONTHDAY_SIZE},</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineplus">+    {&quot;BYYEARDAY&quot;, offsetof(icalrecurrencetype, by_year_day),</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineplus">+     ICAL_BY_YEARDAY_SIZE},</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineplus">+    {&quot;BYWEEKNO&quot;, offsetof(icalrecurrencetype, by_week_no), ICAL_BY_WEEKNO_SIZE},</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineplus">+    {&quot;BYMONTH&quot;, offsetof(icalrecurrencetype, by_month), ICAL_BY_MONTH_SIZE},</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+    {&quot;BYSETPOS&quot;, offsetof(icalrecurrencetype, by_set_pos), ICAL_BY_SETPOS_SIZE},</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+    {nullptr, 0, 0}};</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+</span>
<a href="#l2.34"></a><span id="l2.34"> NS_IMETHODIMP</span>
<a href="#l2.35"></a><span id="l2.35"> calRecurrenceRule::GetComponent(const nsACString &amp;aComponentType,</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineminus">-                                uint32_t *aCount, int16_t **aValues) {</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aCount);</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aValues);</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineminus">-</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineminus">-  // This little ugly macro counts the number of real entries</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineminus">-  // we have in the relevant array, and then clones it to the result.</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineminus">-#define HANDLE_COMPONENT(_comptype, _icalvar, _icalmax)                   \</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineminus">-  if (aComponentType.EqualsLiteral(#_comptype)) {                         \</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineminus">-    int count;                                                            \</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineminus">-    for (count = 0; count &lt; _icalmax; count++) {                          \</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineminus">-      if (mIcalRecur._icalvar[count] == ICAL_RECURRENCE_ARRAY_MAX) break; \</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineminus">-    }                                                                     \</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineminus">-    if (count) {                                                          \</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineminus">-      *aValues = (int16_t *)moz_xmemdup(mIcalRecur._icalvar,              \</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineminus">-                                        count * sizeof(int16_t));         \</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineminus">-      if (!*aValues) return NS_ERROR_OUT_OF_MEMORY;                       \</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineminus">-    } else {                                                              \</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineminus">-      *aValues = nullptr;                                                 \</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineminus">-    }                                                                     \</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineminus">-    *aCount = count;                                                      \</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineplus">+                                nsTArray&lt;int16_t&gt; &amp;aValues) {</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineplus">+  aValues.ClearAndRetainStorage();</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineplus">+  // Look up the array for this component type.</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineplus">+  for (int i = 0; recurrenceTable[i].name; ++i) {</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineplus">+    auto const &amp;row = recurrenceTable[i];</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineplus">+    if (aComponentType.EqualsASCII(row.name)) {</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineplus">+      // Found it.</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineplus">+      int16_t const *src = (int16_t *)((uint8_t *)&amp;mIcalRecur + row.offset);</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineplus">+      size_t count;</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineplus">+      for (count = 0; count &lt; row.maxCount; count++) {</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineplus">+        if (src[count] == ICAL_RECURRENCE_ARRAY_MAX) break;</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineplus">+      }</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineplus">+      aValues.ReplaceElementsAt(0, aValues.Length(), src, count);</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineplus">+      return NS_OK;</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineplus">+    }</span>
<a href="#l2.71"></a><span id="l2.71">   }</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineminus">-</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineminus">-  HANDLE_COMPONENT(BYSECOND, by_second, ICAL_BY_SECOND_SIZE)</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineminus">-  else HANDLE_COMPONENT(BYMINUTE, by_minute, ICAL_BY_MINUTE_SIZE) else HANDLE_COMPONENT(</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineminus">-      BYHOUR, by_hour,</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineminus">-      ICAL_BY_HOUR_SIZE) else HANDLE_COMPONENT(BYDAY, by_day,</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineminus">-                                               ICAL_BY_DAY_SIZE)  // special</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineminus">-      else HANDLE_COMPONENT(BYMONTHDAY, by_month_day, ICAL_BY_MONTHDAY_SIZE) else HANDLE_COMPONENT(BYYEARDAY, by_year_day, ICAL_BY_YEARDAY_SIZE) else HANDLE_COMPONENT(</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineminus">-          BYWEEKNO, by_week_no,</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineminus">-          ICAL_BY_WEEKNO_SIZE) else HANDLE_COMPONENT(BYMONTH, by_month,</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineminus">-                                                     ICAL_BY_MONTH_SIZE) else HANDLE_COMPONENT(BYSETPOS,</span>
<a href="#l2.82"></a><span id="l2.82" class="difflineminus">-                                                                                               by_set_pos,</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineminus">-                                                                                               ICAL_BY_SETPOS_SIZE) else {</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineminus">-    // invalid component; XXX - error code</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineminus">-  }</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineminus">-#undef HANDLE_COMPONENT</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineminus">-</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineminus">-  return NS_OK;</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineplus">+  return NS_ERROR_FAILURE;  // Invalid component.</span>
<a href="#l2.91"></a><span id="l2.91"> }</span>
<a href="#l2.92"></a><span id="l2.92"> </span>
<a href="#l2.93"></a><span id="l2.93" class="difflineminus">-/* void setComponent (in AUTF8String aComponentType, in unsigned long aCount,</span>
<a href="#l2.94"></a><span id="l2.94" class="difflineminus">- * [array, size_is (aCount)] in long aValues); */</span>
<a href="#l2.95"></a><span id="l2.95"> NS_IMETHODIMP</span>
<a href="#l2.96"></a><span id="l2.96"> calRecurrenceRule::SetComponent(const nsACString &amp;aComponentType,</span>
<a href="#l2.97"></a><span id="l2.97" class="difflineminus">-                                uint32_t aCount, int16_t *aValues) {</span>
<a href="#l2.98"></a><span id="l2.98" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aValues);</span>
<a href="#l2.99"></a><span id="l2.99" class="difflineplus">+                                nsTArray&lt;int16_t&gt; const &amp;aValues) {</span>
<a href="#l2.100"></a><span id="l2.100">   if (mImmutable) return NS_ERROR_OBJECT_IS_IMMUTABLE;</span>
<a href="#l2.101"></a><span id="l2.101"> </span>
<a href="#l2.102"></a><span id="l2.102" class="difflineminus">-  // Copy the passed-in array into the ical structure array</span>
<a href="#l2.103"></a><span id="l2.103" class="difflineminus">-#define HANDLE_COMPONENT(_comptype, _icalvar, _icalmax)             \</span>
<a href="#l2.104"></a><span id="l2.104" class="difflineminus">-  if (aComponentType.EqualsLiteral(#_comptype)) {                   \</span>
<a href="#l2.105"></a><span id="l2.105" class="difflineminus">-    if (aCount &gt; _icalmax) return NS_ERROR_FAILURE;                 \</span>
<a href="#l2.106"></a><span id="l2.106" class="difflineminus">-    memcpy(mIcalRecur._icalvar, aValues, aCount * sizeof(int16_t)); \</span>
<a href="#l2.107"></a><span id="l2.107" class="difflineminus">-    if (aCount &lt; _icalmax)                                          \</span>
<a href="#l2.108"></a><span id="l2.108" class="difflineminus">-      mIcalRecur._icalvar[aCount] = ICAL_RECURRENCE_ARRAY_MAX;      \</span>
<a href="#l2.109"></a><span id="l2.109" class="difflineplus">+  // Look up the array for this component type.</span>
<a href="#l2.110"></a><span id="l2.110" class="difflineplus">+  for (int i = 0; recurrenceTable[i].name; ++i) {</span>
<a href="#l2.111"></a><span id="l2.111" class="difflineplus">+    auto const &amp;row = recurrenceTable[i];</span>
<a href="#l2.112"></a><span id="l2.112" class="difflineplus">+    if (aComponentType.EqualsASCII(row.name)) {</span>
<a href="#l2.113"></a><span id="l2.113" class="difflineplus">+      // Found it.</span>
<a href="#l2.114"></a><span id="l2.114" class="difflineplus">+      int16_t *dest = (int16_t *)((uint8_t *)&amp;mIcalRecur + row.offset);</span>
<a href="#l2.115"></a><span id="l2.115" class="difflineplus">+      if (aValues.Length() &gt; row.maxCount) return NS_ERROR_FAILURE;</span>
<a href="#l2.116"></a><span id="l2.116" class="difflineplus">+      for (int16_t v : aValues) {</span>
<a href="#l2.117"></a><span id="l2.117" class="difflineplus">+        *dest++ = v;</span>
<a href="#l2.118"></a><span id="l2.118" class="difflineplus">+      }</span>
<a href="#l2.119"></a><span id="l2.119" class="difflineplus">+      // Terminate array unless full.</span>
<a href="#l2.120"></a><span id="l2.120" class="difflineplus">+      if (aValues.Length() &lt; row.maxCount) {</span>
<a href="#l2.121"></a><span id="l2.121" class="difflineplus">+        *dest++ = ICAL_RECURRENCE_ARRAY_MAX;</span>
<a href="#l2.122"></a><span id="l2.122" class="difflineplus">+      }</span>
<a href="#l2.123"></a><span id="l2.123" class="difflineplus">+      return NS_OK;</span>
<a href="#l2.124"></a><span id="l2.124" class="difflineplus">+    }</span>
<a href="#l2.125"></a><span id="l2.125">   }</span>
<a href="#l2.126"></a><span id="l2.126" class="difflineminus">-</span>
<a href="#l2.127"></a><span id="l2.127" class="difflineminus">-  HANDLE_COMPONENT(BYSECOND, by_second, ICAL_BY_SECOND_SIZE)</span>
<a href="#l2.128"></a><span id="l2.128" class="difflineminus">-  else HANDLE_COMPONENT(BYMINUTE, by_minute, ICAL_BY_MINUTE_SIZE) else HANDLE_COMPONENT(</span>
<a href="#l2.129"></a><span id="l2.129" class="difflineminus">-      BYHOUR, by_hour,</span>
<a href="#l2.130"></a><span id="l2.130" class="difflineminus">-      ICAL_BY_HOUR_SIZE) else HANDLE_COMPONENT(BYDAY, by_day,</span>
<a href="#l2.131"></a><span id="l2.131" class="difflineminus">-                                               ICAL_BY_DAY_SIZE)  // special</span>
<a href="#l2.132"></a><span id="l2.132" class="difflineminus">-      else HANDLE_COMPONENT(BYMONTHDAY, by_month_day, ICAL_BY_MONTHDAY_SIZE) else HANDLE_COMPONENT(BYYEARDAY, by_year_day, ICAL_BY_YEARDAY_SIZE) else HANDLE_COMPONENT(</span>
<a href="#l2.133"></a><span id="l2.133" class="difflineminus">-          BYWEEKNO, by_week_no,</span>
<a href="#l2.134"></a><span id="l2.134" class="difflineminus">-          ICAL_BY_WEEKNO_SIZE) else HANDLE_COMPONENT(BYMONTH, by_month,</span>
<a href="#l2.135"></a><span id="l2.135" class="difflineminus">-                                                     ICAL_BY_MONTH_SIZE) else HANDLE_COMPONENT(BYSETPOS,</span>
<a href="#l2.136"></a><span id="l2.136" class="difflineminus">-                                                                                               by_set_pos,</span>
<a href="#l2.137"></a><span id="l2.137" class="difflineminus">-                                                                                               ICAL_BY_SETPOS_SIZE) else {</span>
<a href="#l2.138"></a><span id="l2.138" class="difflineminus">-    // invalid component; XXX - error code</span>
<a href="#l2.139"></a><span id="l2.139" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l2.140"></a><span id="l2.140" class="difflineminus">-  }</span>
<a href="#l2.141"></a><span id="l2.141" class="difflineminus">-#undef HANDLE_COMPONENT</span>
<a href="#l2.142"></a><span id="l2.142" class="difflineminus">-</span>
<a href="#l2.143"></a><span id="l2.143" class="difflineminus">-  return NS_OK;</span>
<a href="#l2.144"></a><span id="l2.144" class="difflineplus">+  return NS_ERROR_FAILURE;  // Invalid component.</span>
<a href="#l2.145"></a><span id="l2.145"> }</span>
<a href="#l2.146"></a><span id="l2.146"> </span>
<a href="#l2.147"></a><span id="l2.147"> /* calIDateTime getNextOccurrence (in calIDateTime aStartTime, in calIDateTime</span>
<a href="#l2.148"></a><span id="l2.148">  * aOccurrenceTime); */</span>
<a href="#l2.149"></a><span id="l2.149"> NS_IMETHODIMP</span>
<a href="#l2.150"></a><span id="l2.150"> calRecurrenceRule::GetNextOccurrence(calIDateTime *aStartTime,</span>
<a href="#l2.151"></a><span id="l2.151">                                      calIDateTime *aOccurrenceTime,</span>
<a href="#l2.152"></a><span id="l2.152">                                      calIDateTime **_retval) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-event-dialog-recurrence.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-event-dialog-recurrence.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -474,19 +474,19 @@ function initializeControls(rule) {</span>
<a href="#l3.4"></a><span id="l3.4">       document.getElementById(&quot;period-list&quot;).selectedIndex = 3;</span>
<a href="#l3.5"></a><span id="l3.5">       break;</span>
<a href="#l3.6"></a><span id="l3.6">     default:</span>
<a href="#l3.7"></a><span id="l3.7">       document.getElementById(&quot;period-list&quot;).selectedIndex = 0;</span>
<a href="#l3.8"></a><span id="l3.8">       dump(&quot;unable to handle your rule type!\n&quot;);</span>
<a href="#l3.9"></a><span id="l3.9">       break;</span>
<a href="#l3.10"></a><span id="l3.10">   }</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-  let byDayRuleComponent = rule.getComponent(&quot;BYDAY&quot;, {});</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-  let byMonthDayRuleComponent = rule.getComponent(&quot;BYMONTHDAY&quot;, {});</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-  let byMonthRuleComponent = rule.getComponent(&quot;BYMONTH&quot;, {});</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+  let byDayRuleComponent = rule.getComponent(&quot;BYDAY&quot;);</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+  let byMonthDayRuleComponent = rule.getComponent(&quot;BYMONTHDAY&quot;);</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+  let byMonthRuleComponent = rule.getComponent(&quot;BYMONTH&quot;);</span>
<a href="#l3.18"></a><span id="l3.18">   let kDefaultTimezone = cal.dtz.defaultTimezone;</span>
<a href="#l3.19"></a><span id="l3.19">   let startDate = gStartTime.getInTimezone(kDefaultTimezone);</span>
<a href="#l3.20"></a><span id="l3.20"> </span>
<a href="#l3.21"></a><span id="l3.21">   // &quot;DAILY&quot; ruletype</span>
<a href="#l3.22"></a><span id="l3.22">   // byDayRuleComponents may have been set priorily by &quot;MONTHLY&quot;- ruletypes</span>
<a href="#l3.23"></a><span id="l3.23">   // where they have a different context-</span>
<a href="#l3.24"></a><span id="l3.24">   // that's why we also query the current rule-type</span>
<a href="#l3.25"></a><span id="l3.25">   if (byDayRuleComponent.length == 0 || rule.type != &quot;DAILY&quot;) {</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineat">@@ -635,86 +635,86 @@ function onSave(item) {</span>
<a href="#l3.27"></a><span id="l3.27">       recRule.type = &quot;DAILY&quot;;</span>
<a href="#l3.28"></a><span id="l3.28">       let dailyGroup = document.getElementById(&quot;daily-group&quot;);</span>
<a href="#l3.29"></a><span id="l3.29">       if (dailyGroup.selectedIndex == 0) {</span>
<a href="#l3.30"></a><span id="l3.30">         let ndays = Math.max(1, Number(getElementValue(&quot;daily-days&quot;)));</span>
<a href="#l3.31"></a><span id="l3.31">         recRule.interval = ndays;</span>
<a href="#l3.32"></a><span id="l3.32">       } else {</span>
<a href="#l3.33"></a><span id="l3.33">         recRule.interval = 1;</span>
<a href="#l3.34"></a><span id="l3.34">         let onDays = [2, 3, 4, 5, 6];</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineminus">-        recRule.setComponent(&quot;BYDAY&quot;, onDays.length, onDays);</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+        recRule.setComponent(&quot;BYDAY&quot;, onDays);</span>
<a href="#l3.37"></a><span id="l3.37">       }</span>
<a href="#l3.38"></a><span id="l3.38">       break;</span>
<a href="#l3.39"></a><span id="l3.39">     }</span>
<a href="#l3.40"></a><span id="l3.40">     case 1: {</span>
<a href="#l3.41"></a><span id="l3.41">       recRule.type = &quot;WEEKLY&quot;;</span>
<a href="#l3.42"></a><span id="l3.42">       let ndays = Number(getElementValue(&quot;weekly-weeks&quot;));</span>
<a href="#l3.43"></a><span id="l3.43">       recRule.interval = ndays;</span>
<a href="#l3.44"></a><span id="l3.44">       let onDays = DaypickerWeekday.days;</span>
<a href="#l3.45"></a><span id="l3.45">       if (onDays.length &gt; 0) {</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineminus">-        recRule.setComponent(&quot;BYDAY&quot;, onDays.length, onDays);</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineplus">+        recRule.setComponent(&quot;BYDAY&quot;, onDays);</span>
<a href="#l3.48"></a><span id="l3.48">       }</span>
<a href="#l3.49"></a><span id="l3.49">       break;</span>
<a href="#l3.50"></a><span id="l3.50">     }</span>
<a href="#l3.51"></a><span id="l3.51">     case 2: {</span>
<a href="#l3.52"></a><span id="l3.52">       recRule.type = &quot;MONTHLY&quot;;</span>
<a href="#l3.53"></a><span id="l3.53">       let monthInterval = Number(getElementValue(&quot;monthly-interval&quot;));</span>
<a href="#l3.54"></a><span id="l3.54">       recRule.interval = monthInterval;</span>
<a href="#l3.55"></a><span id="l3.55">       let monthlyGroup = document.getElementById(&quot;monthly-group&quot;);</span>
<a href="#l3.56"></a><span id="l3.56">       if (monthlyGroup.selectedIndex == 0) {</span>
<a href="#l3.57"></a><span id="l3.57">         let monthlyOrdinal = Number(getElementValue(&quot;monthly-ordinal&quot;));</span>
<a href="#l3.58"></a><span id="l3.58">         let monthlyDOW = Number(getElementValue(&quot;monthly-weekday&quot;));</span>
<a href="#l3.59"></a><span id="l3.59">         if (monthlyDOW &lt; 0) {</span>
<a href="#l3.60"></a><span id="l3.60">           if (monthlyOrdinal == 0) {</span>
<a href="#l3.61"></a><span id="l3.61">             // Monthly rule &quot;Every day of the month&quot;.</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineminus">-            recRule.setComponent(&quot;BYDAY&quot;, 7, ALL_WEEKDAYS);</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineplus">+            recRule.setComponent(&quot;BYDAY&quot;, ALL_WEEKDAYS);</span>
<a href="#l3.64"></a><span id="l3.64">           } else {</span>
<a href="#l3.65"></a><span id="l3.65">             // One of the first five days or the last day of the month.</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineminus">-            recRule.setComponent(&quot;BYMONTHDAY&quot;, 1, [monthlyOrdinal]);</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineplus">+            recRule.setComponent(&quot;BYMONTHDAY&quot;, [monthlyOrdinal]);</span>
<a href="#l3.68"></a><span id="l3.68">           }</span>
<a href="#l3.69"></a><span id="l3.69">         } else {</span>
<a href="#l3.70"></a><span id="l3.70">           let sign = monthlyOrdinal &lt; 0 ? -1 : 1;</span>
<a href="#l3.71"></a><span id="l3.71">           let onDays = [(Math.abs(monthlyOrdinal) * 8 + monthlyDOW) * sign];</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineminus">-          recRule.setComponent(&quot;BYDAY&quot;, onDays.length, onDays);</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineplus">+          recRule.setComponent(&quot;BYDAY&quot;, onDays);</span>
<a href="#l3.74"></a><span id="l3.74">         }</span>
<a href="#l3.75"></a><span id="l3.75">       } else {</span>
<a href="#l3.76"></a><span id="l3.76">         let monthlyDays = DaypickerMonthday.days;</span>
<a href="#l3.77"></a><span id="l3.77">         if (monthlyDays.length &gt; 0) {</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineminus">-          recRule.setComponent(&quot;BYMONTHDAY&quot;, monthlyDays.length, monthlyDays);</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineplus">+          recRule.setComponent(&quot;BYMONTHDAY&quot;, monthlyDays);</span>
<a href="#l3.80"></a><span id="l3.80">         }</span>
<a href="#l3.81"></a><span id="l3.81">       }</span>
<a href="#l3.82"></a><span id="l3.82">       break;</span>
<a href="#l3.83"></a><span id="l3.83">     }</span>
<a href="#l3.84"></a><span id="l3.84">     case 3: {</span>
<a href="#l3.85"></a><span id="l3.85">       recRule.type = &quot;YEARLY&quot;;</span>
<a href="#l3.86"></a><span id="l3.86">       let yearInterval = Number(getElementValue(&quot;yearly-interval&quot;));</span>
<a href="#l3.87"></a><span id="l3.87">       recRule.interval = yearInterval;</span>
<a href="#l3.88"></a><span id="l3.88">       let yearlyGroup = document.getElementById(&quot;yearly-group&quot;);</span>
<a href="#l3.89"></a><span id="l3.89">       if (yearlyGroup.selectedIndex == 0) {</span>
<a href="#l3.90"></a><span id="l3.90">         let yearlyByMonth = [Number(getElementValue(&quot;yearly-month-ordinal&quot;))];</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineminus">-        recRule.setComponent(&quot;BYMONTH&quot;, yearlyByMonth.length, yearlyByMonth);</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineplus">+        recRule.setComponent(&quot;BYMONTH&quot;, yearlyByMonth);</span>
<a href="#l3.93"></a><span id="l3.93">         let yearlyByDay = [Number(getElementValue(&quot;yearly-days&quot;))];</span>
<a href="#l3.94"></a><span id="l3.94" class="difflineminus">-        recRule.setComponent(&quot;BYMONTHDAY&quot;, yearlyByDay.length, yearlyByDay);</span>
<a href="#l3.95"></a><span id="l3.95" class="difflineplus">+        recRule.setComponent(&quot;BYMONTHDAY&quot;, yearlyByDay);</span>
<a href="#l3.96"></a><span id="l3.96">       } else {</span>
<a href="#l3.97"></a><span id="l3.97">         let yearlyByMonth = [Number(getElementValue(&quot;yearly-month-rule&quot;))];</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineminus">-        recRule.setComponent(&quot;BYMONTH&quot;, yearlyByMonth.length, yearlyByMonth);</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineplus">+        recRule.setComponent(&quot;BYMONTH&quot;, yearlyByMonth);</span>
<a href="#l3.100"></a><span id="l3.100">         let yearlyOrdinal = Number(getElementValue(&quot;yearly-ordinal&quot;));</span>
<a href="#l3.101"></a><span id="l3.101">         let yearlyDOW = Number(getElementValue(&quot;yearly-weekday&quot;));</span>
<a href="#l3.102"></a><span id="l3.102">         if (yearlyDOW &lt; 0) {</span>
<a href="#l3.103"></a><span id="l3.103">           if (yearlyOrdinal == 0) {</span>
<a href="#l3.104"></a><span id="l3.104">             // Yearly rule &quot;Every day of a month&quot;.</span>
<a href="#l3.105"></a><span id="l3.105" class="difflineminus">-            recRule.setComponent(&quot;BYDAY&quot;, 7, ALL_WEEKDAYS);</span>
<a href="#l3.106"></a><span id="l3.106" class="difflineplus">+            recRule.setComponent(&quot;BYDAY&quot;, ALL_WEEKDAYS);</span>
<a href="#l3.107"></a><span id="l3.107">           } else {</span>
<a href="#l3.108"></a><span id="l3.108">             // One of the first five days or the last of a month.</span>
<a href="#l3.109"></a><span id="l3.109" class="difflineminus">-            recRule.setComponent(&quot;BYMONTHDAY&quot;, 1, [yearlyOrdinal]);</span>
<a href="#l3.110"></a><span id="l3.110" class="difflineplus">+            recRule.setComponent(&quot;BYMONTHDAY&quot;, [yearlyOrdinal]);</span>
<a href="#l3.111"></a><span id="l3.111">           }</span>
<a href="#l3.112"></a><span id="l3.112">         } else {</span>
<a href="#l3.113"></a><span id="l3.113">           let sign = yearlyOrdinal &lt; 0 ? -1 : 1;</span>
<a href="#l3.114"></a><span id="l3.114">           let onDays = [(Math.abs(yearlyOrdinal) * 8 + yearlyDOW) * sign];</span>
<a href="#l3.115"></a><span id="l3.115" class="difflineminus">-          recRule.setComponent(&quot;BYDAY&quot;, onDays.length, onDays);</span>
<a href="#l3.116"></a><span id="l3.116" class="difflineplus">+          recRule.setComponent(&quot;BYDAY&quot;, onDays);</span>
<a href="#l3.117"></a><span id="l3.117">         }</span>
<a href="#l3.118"></a><span id="l3.118">       }</span>
<a href="#l3.119"></a><span id="l3.119">       break;</span>
<a href="#l3.120"></a><span id="l3.120">     }</span>
<a href="#l3.121"></a><span id="l3.121">   }</span>
<a href="#l3.122"></a><span id="l3.122"> </span>
<a href="#l3.123"></a><span id="l3.123">   // Figure out how long this event is supposed to last</span>
<a href="#l3.124"></a><span id="l3.124">   switch (document.getElementById(&quot;recurrence-duration&quot;).selectedItem.value) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/calendar/base/modules/calRecurrenceUtils.jsm</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/calendar/base/modules/calRecurrenceUtils.jsm</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -71,17 +71,17 @@ function recurrenceRule2String(recurrenc</span>
<a href="#l4.4"></a><span id="l4.4">       &quot;BYSETPOS&quot;,</span>
<a href="#l4.5"></a><span id="l4.5">     ];</span>
<a href="#l4.6"></a><span id="l4.6"> </span>
<a href="#l4.7"></a><span id="l4.7">     if (rule &amp;&amp; !checkRecurrenceRule(rule, byparts)) {</span>
<a href="#l4.8"></a><span id="l4.8">       let dateFormatter = cal.getDateFormatter();</span>
<a href="#l4.9"></a><span id="l4.9">       let ruleString;</span>
<a href="#l4.10"></a><span id="l4.10">       if (rule.type == &quot;DAILY&quot;) {</span>
<a href="#l4.11"></a><span id="l4.11">         if (checkRecurrenceRule(rule, [&quot;BYDAY&quot;])) {</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-          let days = rule.getComponent(&quot;BYDAY&quot;, {});</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+          let days = rule.getComponent(&quot;BYDAY&quot;);</span>
<a href="#l4.14"></a><span id="l4.14">           let weekdays = [2, 3, 4, 5, 6];</span>
<a href="#l4.15"></a><span id="l4.15">           if (weekdays.length == days.length) {</span>
<a href="#l4.16"></a><span id="l4.16">             let i;</span>
<a href="#l4.17"></a><span id="l4.17">             for (i = 0; i &lt; weekdays.length; i++) {</span>
<a href="#l4.18"></a><span id="l4.18">               if (weekdays[i] != days[i]) {</span>
<a href="#l4.19"></a><span id="l4.19">                 break;</span>
<a href="#l4.20"></a><span id="l4.20">               }</span>
<a href="#l4.21"></a><span id="l4.21">             }</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineat">@@ -95,17 +95,17 @@ function recurrenceRule2String(recurrenc</span>
<a href="#l4.23"></a><span id="l4.23">           let dailyString = getRString(&quot;dailyEveryNth&quot;);</span>
<a href="#l4.24"></a><span id="l4.24">           ruleString = PluralForm.get(rule.interval, dailyString).replace(&quot;#1&quot;, rule.interval);</span>
<a href="#l4.25"></a><span id="l4.25">         }</span>
<a href="#l4.26"></a><span id="l4.26">       } else if (rule.type == &quot;WEEKLY&quot;) {</span>
<a href="#l4.27"></a><span id="l4.27">         // weekly recurrence, currently we</span>
<a href="#l4.28"></a><span id="l4.28">         // support a single 'BYDAY'-rule only.</span>
<a href="#l4.29"></a><span id="l4.29">         if (checkRecurrenceRule(rule, [&quot;BYDAY&quot;])) {</span>
<a href="#l4.30"></a><span id="l4.30">           // create a string like 'Monday, Tuesday and Wednesday'</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineminus">-          let days = rule.getComponent(&quot;BYDAY&quot;, {});</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+          let days = rule.getComponent(&quot;BYDAY&quot;);</span>
<a href="#l4.33"></a><span id="l4.33">           let weekdays = &quot;&quot;;</span>
<a href="#l4.34"></a><span id="l4.34">           // select noun class (grammatical gender) according to the</span>
<a href="#l4.35"></a><span id="l4.35">           // first day of the list</span>
<a href="#l4.36"></a><span id="l4.36">           let weeklyString = nounClass(&quot;repeatDetailsDay&quot; + days[0], &quot;weeklyNthOn&quot;);</span>
<a href="#l4.37"></a><span id="l4.37">           for (let i = 0; i &lt; days.length; i++) {</span>
<a href="#l4.38"></a><span id="l4.38">             if (rule.interval == 1) {</span>
<a href="#l4.39"></a><span id="l4.39">               weekdays += getRString(pluralWeekday(&quot;repeatDetailsDay&quot; + days[i]));</span>
<a href="#l4.40"></a><span id="l4.40">             } else {</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineat">@@ -121,17 +121,17 @@ function recurrenceRule2String(recurrenc</span>
<a href="#l4.42"></a><span id="l4.42">           weeklyString = getRString(weeklyString, [weekdays]);</span>
<a href="#l4.43"></a><span id="l4.43">           ruleString = PluralForm.get(rule.interval, weeklyString).replace(&quot;#2&quot;, rule.interval);</span>
<a href="#l4.44"></a><span id="l4.44">         } else {</span>
<a href="#l4.45"></a><span id="l4.45">           let weeklyString = getRString(&quot;weeklyEveryNth&quot;);</span>
<a href="#l4.46"></a><span id="l4.46">           ruleString = PluralForm.get(rule.interval, weeklyString).replace(&quot;#1&quot;, rule.interval);</span>
<a href="#l4.47"></a><span id="l4.47">         }</span>
<a href="#l4.48"></a><span id="l4.48">       } else if (rule.type == &quot;MONTHLY&quot;) {</span>
<a href="#l4.49"></a><span id="l4.49">         if (checkRecurrenceRule(rule, [&quot;BYDAY&quot;])) {</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineminus">-          let byday = rule.getComponent(&quot;BYDAY&quot;, {});</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineplus">+          let byday = rule.getComponent(&quot;BYDAY&quot;);</span>
<a href="#l4.52"></a><span id="l4.52">           if (everyWeekDay(byday)) {</span>
<a href="#l4.53"></a><span id="l4.53">             // Rule every day of the month.</span>
<a href="#l4.54"></a><span id="l4.54">             ruleString = getRString(&quot;monthlyEveryDayOfNth&quot;);</span>
<a href="#l4.55"></a><span id="l4.55">             ruleString = PluralForm.get(rule.interval, ruleString).replace(&quot;#2&quot;, rule.interval);</span>
<a href="#l4.56"></a><span id="l4.56">           } else {</span>
<a href="#l4.57"></a><span id="l4.57">             // For rules with generic number of weekdays with and</span>
<a href="#l4.58"></a><span id="l4.58">             // without &quot;position&quot; prefix we build two separate</span>
<a href="#l4.59"></a><span id="l4.59">             // strings depending on the position and then join them.</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineat">@@ -185,17 +185,17 @@ function recurrenceRule2String(recurrenc</span>
<a href="#l4.61"></a><span id="l4.61">             let monthlyString = weekdaysString_every</span>
<a href="#l4.62"></a><span id="l4.62">               ? &quot;monthlyEveryOfEvery&quot;</span>
<a href="#l4.63"></a><span id="l4.63">               : &quot;monthlyRuleNthOfEvery&quot;;</span>
<a href="#l4.64"></a><span id="l4.64">             monthlyString = nounClass(&quot;repeatDetailsDay&quot; + day_of_week(firstDay), monthlyString);</span>
<a href="#l4.65"></a><span id="l4.65">             monthlyString = getRString(monthlyString, [weekdaysString]);</span>
<a href="#l4.66"></a><span id="l4.66">             ruleString = PluralForm.get(rule.interval, monthlyString).replace(&quot;#2&quot;, rule.interval);</span>
<a href="#l4.67"></a><span id="l4.67">           }</span>
<a href="#l4.68"></a><span id="l4.68">         } else if (checkRecurrenceRule(rule, [&quot;BYMONTHDAY&quot;])) {</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineminus">-          let component = rule.getComponent(&quot;BYMONTHDAY&quot;, {});</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineplus">+          let component = rule.getComponent(&quot;BYMONTHDAY&quot;);</span>
<a href="#l4.71"></a><span id="l4.71"> </span>
<a href="#l4.72"></a><span id="l4.72">           // First, find out if the 'BYMONTHDAY' component contains</span>
<a href="#l4.73"></a><span id="l4.73">           // any elements with a negative value lesser than -1 (&quot;the</span>
<a href="#l4.74"></a><span id="l4.74">           // last day&quot;). If so we currently don't support any rule</span>
<a href="#l4.75"></a><span id="l4.75">           if (component.some(element =&gt; element &lt; -1)) {</span>
<a href="#l4.76"></a><span id="l4.76">             // we don't support any other combination for now...</span>
<a href="#l4.77"></a><span id="l4.77">             return getRString(&quot;ruleTooComplex&quot;);</span>
<a href="#l4.78"></a><span id="l4.78">           } else if (component.length == 1 &amp;&amp; component[0] == -1) {</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineat">@@ -232,20 +232,20 @@ function recurrenceRule2String(recurrenc</span>
<a href="#l4.80"></a><span id="l4.80">         } else {</span>
<a href="#l4.81"></a><span id="l4.81">           let monthlyString = getRString(&quot;monthlyDaysOfNth&quot;, [startDate.day]);</span>
<a href="#l4.82"></a><span id="l4.82">           ruleString = PluralForm.get(rule.interval, monthlyString).replace(&quot;#2&quot;, rule.interval);</span>
<a href="#l4.83"></a><span id="l4.83">         }</span>
<a href="#l4.84"></a><span id="l4.84">       } else if (rule.type == &quot;YEARLY&quot;) {</span>
<a href="#l4.85"></a><span id="l4.85">         let bymonthday = null;</span>
<a href="#l4.86"></a><span id="l4.86">         let bymonth = null;</span>
<a href="#l4.87"></a><span id="l4.87">         if (checkRecurrenceRule(rule, [&quot;BYMONTHDAY&quot;])) {</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineminus">-          bymonthday = rule.getComponent(&quot;BYMONTHDAY&quot;, {});</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineplus">+          bymonthday = rule.getComponent(&quot;BYMONTHDAY&quot;);</span>
<a href="#l4.90"></a><span id="l4.90">         }</span>
<a href="#l4.91"></a><span id="l4.91">         if (checkRecurrenceRule(rule, [&quot;BYMONTH&quot;])) {</span>
<a href="#l4.92"></a><span id="l4.92" class="difflineminus">-          bymonth = rule.getComponent(&quot;BYMONTH&quot;, {});</span>
<a href="#l4.93"></a><span id="l4.93" class="difflineplus">+          bymonth = rule.getComponent(&quot;BYMONTH&quot;);</span>
<a href="#l4.94"></a><span id="l4.94">         }</span>
<a href="#l4.95"></a><span id="l4.95">         if (</span>
<a href="#l4.96"></a><span id="l4.96">           (bymonth &amp;&amp; bymonth.length &gt; 1) ||</span>
<a href="#l4.97"></a><span id="l4.97">           (bymonthday &amp;&amp; (bymonthday.length &gt; 1 || bymonthday[0] &lt; -1))</span>
<a href="#l4.98"></a><span id="l4.98">         ) {</span>
<a href="#l4.99"></a><span id="l4.99">           // Don't build a string for a recurrence rule that the UI</span>
<a href="#l4.100"></a><span id="l4.100">           // currently can't show completely (with more than one month</span>
<a href="#l4.101"></a><span id="l4.101">           // or than one monthday, or bymonthdays lesser than -1).</span>
<a href="#l4.102"></a><span id="l4.102" class="difflineat">@@ -263,17 +263,17 @@ function recurrenceRule2String(recurrenc</span>
<a href="#l4.103"></a><span id="l4.103">           let monthDay =</span>
<a href="#l4.104"></a><span id="l4.104">             bymonthday[0] == -1</span>
<a href="#l4.105"></a><span id="l4.105">               ? getRString(&quot;monthlyLastDay&quot;)</span>
<a href="#l4.106"></a><span id="l4.106">               : dateFormatter.formatDayWithOrdinal(bymonthday[0]);</span>
<a href="#l4.107"></a><span id="l4.107">           let yearlyString = getRString(&quot;yearlyNthOn&quot;, [month, monthDay]);</span>
<a href="#l4.108"></a><span id="l4.108">           ruleString = PluralForm.get(rule.interval, yearlyString).replace(&quot;#3&quot;, rule.interval);</span>
<a href="#l4.109"></a><span id="l4.109">         } else if (checkRecurrenceRule(rule, [&quot;BYMONTH&quot;]) &amp;&amp; checkRecurrenceRule(rule, [&quot;BYDAY&quot;])) {</span>
<a href="#l4.110"></a><span id="l4.110">           // RRULE:FREQ=YEARLY;BYMONTH=x;BYDAY=y1,y2,....</span>
<a href="#l4.111"></a><span id="l4.111" class="difflineminus">-          let byday = rule.getComponent(&quot;BYDAY&quot;, {});</span>
<a href="#l4.112"></a><span id="l4.112" class="difflineplus">+          let byday = rule.getComponent(&quot;BYDAY&quot;);</span>
<a href="#l4.113"></a><span id="l4.113">           let month = getRString(&quot;repeatDetailsMonth&quot; + bymonth[0]);</span>
<a href="#l4.114"></a><span id="l4.114">           if (everyWeekDay(byday)) {</span>
<a href="#l4.115"></a><span id="l4.115">             // Every day of the month.</span>
<a href="#l4.116"></a><span id="l4.116">             let yearlyString = &quot;yearlyEveryDayOf&quot;;</span>
<a href="#l4.117"></a><span id="l4.117">             yearlyString = getRString(yearlyString, [month]);</span>
<a href="#l4.118"></a><span id="l4.118">             ruleString = PluralForm.get(rule.interval, yearlyString).replace(&quot;#2&quot;, rule.interval);</span>
<a href="#l4.119"></a><span id="l4.119">           } else if (byday.length == 1) {</span>
<a href="#l4.120"></a><span id="l4.120">             let dayString = &quot;repeatDetailsDay&quot; + day_of_week(byday[0]);</span>
<a href="#l4.121"></a><span id="l4.121" class="difflineat">@@ -400,17 +400,17 @@ function splitRecurrenceRules(recurrence</span>
<a href="#l4.122"></a><span id="l4.122">  *</span>
<a href="#l4.123"></a><span id="l4.123">  * @see                     calIRecurrenceRule</span>
<a href="#l4.124"></a><span id="l4.124">  * @param aRule             The recurrence rule to check.</span>
<a href="#l4.125"></a><span id="l4.125">  * @param aArray            An array of component names to check.</span>
<a href="#l4.126"></a><span id="l4.126">  * @return                  Returns true if the rule is valid.</span>
<a href="#l4.127"></a><span id="l4.127">  */</span>
<a href="#l4.128"></a><span id="l4.128"> function checkRecurrenceRule(aRule, aArray) {</span>
<a href="#l4.129"></a><span id="l4.129">   for (let comp of aArray) {</span>
<a href="#l4.130"></a><span id="l4.130" class="difflineminus">-    let ruleComp = aRule.getComponent(comp, {});</span>
<a href="#l4.131"></a><span id="l4.131" class="difflineplus">+    let ruleComp = aRule.getComponent(comp);</span>
<a href="#l4.132"></a><span id="l4.132">     if (ruleComp &amp;&amp; ruleComp.length &gt; 0) {</span>
<a href="#l4.133"></a><span id="l4.133">       return true;</span>
<a href="#l4.134"></a><span id="l4.134">     }</span>
<a href="#l4.135"></a><span id="l4.135">   }</span>
<a href="#l4.136"></a><span id="l4.136">   return false;</span>
<a href="#l4.137"></a><span id="l4.137"> }</span>
<a href="#l4.138"></a><span id="l4.138"> </span>
<a href="#l4.139"></a><span id="l4.139"> /**</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/calendar/base/public/calIRecurrenceRule.idl</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/calendar/base/public/calIRecurrenceRule.idl</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -46,14 +46,12 @@ interface calIRecurrenceRule : calIRecur</span>
<a href="#l5.4"></a><span id="l5.4">   // The week start for this rule, used for certain calculations. This is a</span>
<a href="#l5.5"></a><span id="l5.5">   // value from 0=Sunday to 6=Saturday.</span>
<a href="#l5.6"></a><span id="l5.6">   attribute short weekStart;</span>
<a href="#l5.7"></a><span id="l5.7"> </span>
<a href="#l5.8"></a><span id="l5.8">   // the components defining the recurrence</span>
<a href="#l5.9"></a><span id="l5.9">   // &quot;BYSECOND&quot;, &quot;BYMINUTE&quot;, &quot;BYHOUR&quot;, &quot;BYDAY&quot;,</span>
<a href="#l5.10"></a><span id="l5.10">   // &quot;BYMONTHDAY&quot;, &quot;BYYEARDAY&quot;, &quot;BYWEEKNO&quot;, &quot;BYMONTH&quot;,</span>
<a href="#l5.11"></a><span id="l5.11">   // &quot;BYSETPOS&quot;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-  void getComponent (in AUTF8String aComponentType,</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-                     out unsigned long aCount, [array,size_is(aCount),retval] out short aValues);</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineminus">-  void setComponent (in AUTF8String aComponentType,</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineminus">-                     in unsigned long aCount, [array,size_is(aCount)] in short aValues);</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+  Array&lt;short&gt; getComponent (in AUTF8String aComponentType);</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+  void setComponent (in AUTF8String aComponentType, in Array&lt;short&gt; aValues);</span>
<a href="#l5.18"></a><span id="l5.18"> </span>
<a href="#l5.19"></a><span id="l5.19"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/calendar/lightning/content/lightning-item-iframe.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/calendar/lightning/content/lightning-item-iframe.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -1450,17 +1450,17 @@ function getRepeatTypeAndUntilDate(aItem</span>
<a href="#l6.4"></a><span id="l6.4">               &quot;BYHOUR&quot;,</span>
<a href="#l6.5"></a><span id="l6.5">               &quot;BYMONTHDAY&quot;,</span>
<a href="#l6.6"></a><span id="l6.6">               &quot;BYYEARDAY&quot;,</span>
<a href="#l6.7"></a><span id="l6.7">               &quot;BYWEEKNO&quot;,</span>
<a href="#l6.8"></a><span id="l6.8">               &quot;BYMONTH&quot;,</span>
<a href="#l6.9"></a><span id="l6.9">               &quot;BYSETPOS&quot;,</span>
<a href="#l6.10"></a><span id="l6.10">             ];</span>
<a href="#l6.11"></a><span id="l6.11">             if (!checkRecurrenceRule(rule, byparts)) {</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-              let ruleComp = rule.getComponent(&quot;BYDAY&quot;, {});</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+              let ruleComp = rule.getComponent(&quot;BYDAY&quot;);</span>
<a href="#l6.14"></a><span id="l6.14">               if (rule.interval == 1) {</span>
<a href="#l6.15"></a><span id="l6.15">                 if (ruleComp.length &gt; 0) {</span>
<a href="#l6.16"></a><span id="l6.16">                   if (ruleComp.length == 5) {</span>
<a href="#l6.17"></a><span id="l6.17">                     let found = false;</span>
<a href="#l6.18"></a><span id="l6.18">                     for (let i = 0; i &lt; 5; i++) {</span>
<a href="#l6.19"></a><span id="l6.19">                       if (ruleComp[i] != i + 2) {</span>
<a href="#l6.20"></a><span id="l6.20">                         found = true;</span>
<a href="#l6.21"></a><span id="l6.21">                         break;</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineat">@@ -2930,17 +2930,17 @@ function updateRepeat(aSuppressDialogs, </span>
<a href="#l6.23"></a><span id="l6.23">       case &quot;daily&quot;:</span>
<a href="#l6.24"></a><span id="l6.24">         recRule.type = &quot;DAILY&quot;;</span>
<a href="#l6.25"></a><span id="l6.25">         break;</span>
<a href="#l6.26"></a><span id="l6.26">       case &quot;weekly&quot;:</span>
<a href="#l6.27"></a><span id="l6.27">         recRule.type = &quot;WEEKLY&quot;;</span>
<a href="#l6.28"></a><span id="l6.28">         break;</span>
<a href="#l6.29"></a><span id="l6.29">       case &quot;every.weekday&quot;:</span>
<a href="#l6.30"></a><span id="l6.30">         recRule.type = &quot;DAILY&quot;;</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">-        recRule.setComponent(&quot;BYDAY&quot;, 5, [2, 3, 4, 5, 6]);</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+        recRule.setComponent(&quot;BYDAY&quot;, [2, 3, 4, 5, 6]);</span>
<a href="#l6.33"></a><span id="l6.33">         break;</span>
<a href="#l6.34"></a><span id="l6.34">       case &quot;bi.weekly&quot;:</span>
<a href="#l6.35"></a><span id="l6.35">         recRule.type = &quot;WEEKLY&quot;;</span>
<a href="#l6.36"></a><span id="l6.36">         recRule.interval = 2;</span>
<a href="#l6.37"></a><span id="l6.37">         break;</span>
<a href="#l6.38"></a><span id="l6.38">       case &quot;monthly&quot;:</span>
<a href="#l6.39"></a><span id="l6.39">         recRule.type = &quot;MONTHLY&quot;;</span>
<a href="#l6.40"></a><span id="l6.40">         break;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/calendar/providers/storage/calStorageUpgrade.jsm</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/calendar/providers/storage/calStorageUpgrade.jsm</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -1743,17 +1743,17 @@ upgrade.v22 = function(db, version) {</span>
<a href="#l7.4"></a><span id="l7.4">               SETPOS: aSetPos,</span>
<a href="#l7.5"></a><span id="l7.5">             };</span>
<a href="#l7.6"></a><span id="l7.6"> </span>
<a href="#l7.7"></a><span id="l7.7">             for (let rtype in rtypes) {</span>
<a href="#l7.8"></a><span id="l7.8">               if (rtypes[rtype]) {</span>
<a href="#l7.9"></a><span id="l7.9">                 let comp = &quot;BY&quot; + rtype;</span>
<a href="#l7.10"></a><span id="l7.10">                 let rstr = rtypes[rtype].toString();</span>
<a href="#l7.11"></a><span id="l7.11">                 let rarray = rstr.split(&quot;,&quot;).map(parseInt10);</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-                ritem.setComponent(comp, rarray.length, rarray);</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+                ritem.setComponent(comp, rarray);</span>
<a href="#l7.14"></a><span id="l7.14">               }</span>
<a href="#l7.15"></a><span id="l7.15">             }</span>
<a href="#l7.16"></a><span id="l7.16">           }</span>
<a href="#l7.17"></a><span id="l7.17"> </span>
<a href="#l7.18"></a><span id="l7.18">           return ritem.icalString;</span>
<a href="#l7.19"></a><span id="l7.19">         } catch (e) {</span>
<a href="#l7.20"></a><span id="l7.20">           cal.ERROR(&quot;Error converting recurrence: &quot; + e);</span>
<a href="#l7.21"></a><span id="l7.21">           throw e;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/calendar/test/unit/test_ics_service.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/calendar/test/unit/test_ics_service.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -72,17 +72,17 @@ function test_icalstring() {</span>
<a href="#l8.4"></a><span id="l8.4">     { FOO: &quot;BAR&quot; }</span>
<a href="#l8.5"></a><span id="l8.5">   );</span>
<a href="#l8.6"></a><span id="l8.6"> </span>
<a href="#l8.7"></a><span id="l8.7">   let rrule = checkComp(</span>
<a href="#l8.8"></a><span id="l8.8">     cal.createRecurrenceRule.bind(cal),</span>
<a href="#l8.9"></a><span id="l8.9">     &quot;RRULE:FREQ=WEEKLY;COUNT=5;INTERVAL=2;BYDAY=MO&quot;,</span>
<a href="#l8.10"></a><span id="l8.10">     { count: 5, isByCount: true, type: &quot;WEEKLY&quot;, interval: 2 }</span>
<a href="#l8.11"></a><span id="l8.11">   );</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-  equal(rrule.getComponent(&quot;BYDAY&quot;, {}).toString(), [2].toString());</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+  equal(rrule.getComponent(&quot;BYDAY&quot;).toString(), [2].toString());</span>
<a href="#l8.14"></a><span id="l8.14"> </span>
<a href="#l8.15"></a><span id="l8.15">   if (Services.prefs.getBoolPref(&quot;calendar.icaljs&quot;, false)) {</span>
<a href="#l8.16"></a><span id="l8.16">     let rdate = checkComp(cal.createRecurrenceDate.bind(cal), &quot;RDATE:20120101T000000&quot;, {</span>
<a href="#l8.17"></a><span id="l8.17">       isNegative: false,</span>
<a href="#l8.18"></a><span id="l8.18">     });</span>
<a href="#l8.19"></a><span id="l8.19">     equal(rdate.date.compare(cal.createDateTime(&quot;20120101T000000&quot;)), 0);</span>
<a href="#l8.20"></a><span id="l8.20">   } else {</span>
<a href="#l8.21"></a><span id="l8.21">     let rdate = checkComp(</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/calendar/test/unit/test_recur.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/calendar/test/unit/test_recur.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -970,20 +970,20 @@ function test_rrule_interface() {</span>
<a href="#l9.4"></a><span id="l9.4">   let rrule = item.recurrenceInfo.getRecurrenceItemAt(0);</span>
<a href="#l9.5"></a><span id="l9.5">   rrule.QueryInterface(Ci.calIRecurrenceRule);</span>
<a href="#l9.6"></a><span id="l9.6">   equal(rrule.type, &quot;WEEKLY&quot;);</span>
<a href="#l9.7"></a><span id="l9.7">   equal(rrule.interval, 2);</span>
<a href="#l9.8"></a><span id="l9.8">   equal(rrule.count, 6);</span>
<a href="#l9.9"></a><span id="l9.9">   ok(rrule.isByCount);</span>
<a href="#l9.10"></a><span id="l9.10">   ok(!rrule.isNegative);</span>
<a href="#l9.11"></a><span id="l9.11">   ok(rrule.isFinite);</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-  equal(rrule.getComponent(&quot;BYDAY&quot;, {}).toString(), [3, 4].toString());</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+  equal(rrule.getComponent(&quot;BYDAY&quot;).toString(), [3, 4].toString());</span>
<a href="#l9.14"></a><span id="l9.14"> </span>
<a href="#l9.15"></a><span id="l9.15">   // Now start changing things</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineminus">-  rrule.setComponent(&quot;BYDAY&quot;, 2, [4, 5]);</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+  rrule.setComponent(&quot;BYDAY&quot;, [4, 5]);</span>
<a href="#l9.18"></a><span id="l9.18">   equal(rrule.icalString.match(/BYDAY=WE,TH/), &quot;BYDAY=WE,TH&quot;);</span>
<a href="#l9.19"></a><span id="l9.19"> </span>
<a href="#l9.20"></a><span id="l9.20">   rrule.count = -1;</span>
<a href="#l9.21"></a><span id="l9.21">   ok(!rrule.isByCount);</span>
<a href="#l9.22"></a><span id="l9.22">   ok(!rrule.isFinite);</span>
<a href="#l9.23"></a><span id="l9.23">   equal(rrule.icalString.match(/COUNT=/), null);</span>
<a href="#l9.24"></a><span id="l9.24">   throws(() =&gt; rrule.count, /0x80004005/);</span>
<a href="#l9.25"></a><span id="l9.25"> </span>
<a href="#l9.26"></a><span id="l9.26" class="difflineat">@@ -1170,107 +1170,107 @@ function test_immutable() {</span>
<a href="#l9.27"></a><span id="l9.27"> function test_rrule_icalstring() {</span>
<a href="#l9.28"></a><span id="l9.28">   let recRule = cal.createRecurrenceRule();</span>
<a href="#l9.29"></a><span id="l9.29">   recRule.type = &quot;DAILY&quot;;</span>
<a href="#l9.30"></a><span id="l9.30">   recRule.interval = 4;</span>
<a href="#l9.31"></a><span id="l9.31">   equal(recRule.icalString, &quot;RRULE:FREQ=DAILY;INTERVAL=4\r\n&quot;);</span>
<a href="#l9.32"></a><span id="l9.32"> </span>
<a href="#l9.33"></a><span id="l9.33">   recRule = cal.createRecurrenceRule();</span>
<a href="#l9.34"></a><span id="l9.34">   recRule.type = &quot;DAILY&quot;;</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineminus">-  recRule.setComponent(&quot;BYDAY&quot;, 5, [2, 3, 4, 5, 6]);</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineplus">+  recRule.setComponent(&quot;BYDAY&quot;, [2, 3, 4, 5, 6]);</span>
<a href="#l9.37"></a><span id="l9.37">   equal(recRule.icalString, &quot;RRULE:FREQ=DAILY;BYDAY=MO,TU,WE,TH,FR\r\n&quot;);</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineminus">-  deepEqual(recRule.getComponent(&quot;BYDAY&quot;, {}), [2, 3, 4, 5, 6]);</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineplus">+  deepEqual(recRule.getComponent(&quot;BYDAY&quot;), [2, 3, 4, 5, 6]);</span>
<a href="#l9.40"></a><span id="l9.40"> </span>
<a href="#l9.41"></a><span id="l9.41">   recRule = cal.createRecurrenceRule();</span>
<a href="#l9.42"></a><span id="l9.42">   recRule.type = &quot;WEEKLY&quot;;</span>
<a href="#l9.43"></a><span id="l9.43">   recRule.interval = 3;</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineminus">-  recRule.setComponent(&quot;BYDAY&quot;, 3, [2, 4, 6]);</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineplus">+  recRule.setComponent(&quot;BYDAY&quot;, [2, 4, 6]);</span>
<a href="#l9.46"></a><span id="l9.46">   equal(recRule.icalString, &quot;RRULE:FREQ=WEEKLY;INTERVAL=3;BYDAY=MO,WE,FR\r\n&quot;);</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineminus">-  deepEqual(recRule.getComponent(&quot;BYDAY&quot;, {}), [2, 4, 6]);</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineplus">+  deepEqual(recRule.getComponent(&quot;BYDAY&quot;), [2, 4, 6]);</span>
<a href="#l9.49"></a><span id="l9.49"> </span>
<a href="#l9.50"></a><span id="l9.50">   recRule = cal.createRecurrenceRule();</span>
<a href="#l9.51"></a><span id="l9.51">   recRule.type = &quot;MONTHLY&quot;;</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineminus">-  recRule.setComponent(&quot;BYDAY&quot;, 7, [2, 3, 4, 5, 6, 7, 1]);</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineplus">+  recRule.setComponent(&quot;BYDAY&quot;, [2, 3, 4, 5, 6, 7, 1]);</span>
<a href="#l9.54"></a><span id="l9.54">   equal(recRule.icalString, &quot;RRULE:FREQ=MONTHLY;BYDAY=MO,TU,WE,TH,FR,SA,SU\r\n&quot;);</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineminus">-  deepEqual(recRule.getComponent(&quot;BYDAY&quot;, {}), [2, 3, 4, 5, 6, 7, 1]);</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineplus">+  deepEqual(recRule.getComponent(&quot;BYDAY&quot;), [2, 3, 4, 5, 6, 7, 1]);</span>
<a href="#l9.57"></a><span id="l9.57"> </span>
<a href="#l9.58"></a><span id="l9.58">   recRule = cal.createRecurrenceRule();</span>
<a href="#l9.59"></a><span id="l9.59">   recRule.type = &quot;MONTHLY&quot;;</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineminus">-  recRule.setComponent(&quot;BYDAY&quot;, 1, [10]);</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineplus">+  recRule.setComponent(&quot;BYDAY&quot;, [10]);</span>
<a href="#l9.62"></a><span id="l9.62">   equal(recRule.icalString, &quot;RRULE:FREQ=MONTHLY;BYDAY=1MO\r\n&quot;);</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineminus">-  deepEqual(recRule.getComponent(&quot;BYDAY&quot;, {}), [10]);</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineplus">+  deepEqual(recRule.getComponent(&quot;BYDAY&quot;), [10]);</span>
<a href="#l9.65"></a><span id="l9.65"> </span>
<a href="#l9.66"></a><span id="l9.66">   recRule = cal.createRecurrenceRule();</span>
<a href="#l9.67"></a><span id="l9.67">   recRule.type = &quot;MONTHLY&quot;;</span>
<a href="#l9.68"></a><span id="l9.68" class="difflineminus">-  recRule.setComponent(&quot;BYDAY&quot;, 1, [20]);</span>
<a href="#l9.69"></a><span id="l9.69" class="difflineplus">+  recRule.setComponent(&quot;BYDAY&quot;, [20]);</span>
<a href="#l9.70"></a><span id="l9.70">   equal(recRule.icalString, &quot;RRULE:FREQ=MONTHLY;BYDAY=2WE\r\n&quot;);</span>
<a href="#l9.71"></a><span id="l9.71" class="difflineminus">-  deepEqual(recRule.getComponent(&quot;BYDAY&quot;, {}), [20]);</span>
<a href="#l9.72"></a><span id="l9.72" class="difflineplus">+  deepEqual(recRule.getComponent(&quot;BYDAY&quot;), [20]);</span>
<a href="#l9.73"></a><span id="l9.73"> </span>
<a href="#l9.74"></a><span id="l9.74">   recRule = cal.createRecurrenceRule();</span>
<a href="#l9.75"></a><span id="l9.75">   recRule.type = &quot;MONTHLY&quot;;</span>
<a href="#l9.76"></a><span id="l9.76" class="difflineminus">-  recRule.setComponent(&quot;BYDAY&quot;, 1, [-22]);</span>
<a href="#l9.77"></a><span id="l9.77" class="difflineplus">+  recRule.setComponent(&quot;BYDAY&quot;, [-22]);</span>
<a href="#l9.78"></a><span id="l9.78">   equal(recRule.icalString, &quot;RRULE:FREQ=MONTHLY;BYDAY=-2FR\r\n&quot;);</span>
<a href="#l9.79"></a><span id="l9.79" class="difflineminus">-  deepEqual(recRule.getComponent(&quot;BYDAY&quot;, {}), [-22]);</span>
<a href="#l9.80"></a><span id="l9.80" class="difflineplus">+  deepEqual(recRule.getComponent(&quot;BYDAY&quot;), [-22]);</span>
<a href="#l9.81"></a><span id="l9.81"> </span>
<a href="#l9.82"></a><span id="l9.82">   recRule = cal.createRecurrenceRule();</span>
<a href="#l9.83"></a><span id="l9.83">   recRule.type = &quot;MONTHLY&quot;;</span>
<a href="#l9.84"></a><span id="l9.84" class="difflineminus">-  recRule.setComponent(&quot;BYMONTHDAY&quot;, 1, [5]);</span>
<a href="#l9.85"></a><span id="l9.85" class="difflineplus">+  recRule.setComponent(&quot;BYMONTHDAY&quot;, [5]);</span>
<a href="#l9.86"></a><span id="l9.86">   equal(recRule.icalString, &quot;RRULE:FREQ=MONTHLY;BYMONTHDAY=5\r\n&quot;);</span>
<a href="#l9.87"></a><span id="l9.87" class="difflineminus">-  deepEqual(recRule.getComponent(&quot;BYMONTHDAY&quot;, {}), [5]);</span>
<a href="#l9.88"></a><span id="l9.88" class="difflineplus">+  deepEqual(recRule.getComponent(&quot;BYMONTHDAY&quot;), [5]);</span>
<a href="#l9.89"></a><span id="l9.89"> </span>
<a href="#l9.90"></a><span id="l9.90">   recRule = cal.createRecurrenceRule();</span>
<a href="#l9.91"></a><span id="l9.91">   recRule.type = &quot;MONTHLY&quot;;</span>
<a href="#l9.92"></a><span id="l9.92" class="difflineminus">-  recRule.setComponent(&quot;BYMONTHDAY&quot;, 3, [1, 9, 17]);</span>
<a href="#l9.93"></a><span id="l9.93" class="difflineplus">+  recRule.setComponent(&quot;BYMONTHDAY&quot;, [1, 9, 17]);</span>
<a href="#l9.94"></a><span id="l9.94">   equal(recRule.icalString, &quot;RRULE:FREQ=MONTHLY;BYMONTHDAY=1,9,17\r\n&quot;);</span>
<a href="#l9.95"></a><span id="l9.95" class="difflineminus">-  deepEqual(recRule.getComponent(&quot;BYMONTHDAY&quot;, {}), [1, 9, 17]);</span>
<a href="#l9.96"></a><span id="l9.96" class="difflineplus">+  deepEqual(recRule.getComponent(&quot;BYMONTHDAY&quot;), [1, 9, 17]);</span>
<a href="#l9.97"></a><span id="l9.97"> </span>
<a href="#l9.98"></a><span id="l9.98">   recRule = cal.createRecurrenceRule();</span>
<a href="#l9.99"></a><span id="l9.99">   recRule.type = &quot;YEARLY&quot;;</span>
<a href="#l9.100"></a><span id="l9.100" class="difflineminus">-  recRule.setComponent(&quot;BYMONTH&quot;, 1, [1]);</span>
<a href="#l9.101"></a><span id="l9.101" class="difflineminus">-  recRule.setComponent(&quot;BYMONTHDAY&quot;, 1, [3]);</span>
<a href="#l9.102"></a><span id="l9.102" class="difflineplus">+  recRule.setComponent(&quot;BYMONTH&quot;, [1]);</span>
<a href="#l9.103"></a><span id="l9.103" class="difflineplus">+  recRule.setComponent(&quot;BYMONTHDAY&quot;, [3]);</span>
<a href="#l9.104"></a><span id="l9.104">   ok(</span>
<a href="#l9.105"></a><span id="l9.105">     [</span>
<a href="#l9.106"></a><span id="l9.106">       &quot;RRULE:FREQ=YEARLY;BYMONTHDAY=3;BYMONTH=1\r\n&quot;,</span>
<a href="#l9.107"></a><span id="l9.107">       &quot;RRULE:FREQ=YEARLY;BYMONTH=1;BYMONTHDAY=3\r\n&quot;,</span>
<a href="#l9.108"></a><span id="l9.108">     ].includes(recRule.icalString)</span>
<a href="#l9.109"></a><span id="l9.109">   );</span>
<a href="#l9.110"></a><span id="l9.110" class="difflineminus">-  deepEqual(recRule.getComponent(&quot;BYMONTH&quot;, {}), [1]);</span>
<a href="#l9.111"></a><span id="l9.111" class="difflineminus">-  deepEqual(recRule.getComponent(&quot;BYMONTHDAY&quot;, {}), [3]);</span>
<a href="#l9.112"></a><span id="l9.112" class="difflineplus">+  deepEqual(recRule.getComponent(&quot;BYMONTH&quot;), [1]);</span>
<a href="#l9.113"></a><span id="l9.113" class="difflineplus">+  deepEqual(recRule.getComponent(&quot;BYMONTHDAY&quot;), [3]);</span>
<a href="#l9.114"></a><span id="l9.114"> </span>
<a href="#l9.115"></a><span id="l9.115">   recRule = cal.createRecurrenceRule();</span>
<a href="#l9.116"></a><span id="l9.116">   recRule.type = &quot;YEARLY&quot;;</span>
<a href="#l9.117"></a><span id="l9.117" class="difflineminus">-  recRule.setComponent(&quot;BYMONTH&quot;, 1, [4]);</span>
<a href="#l9.118"></a><span id="l9.118" class="difflineminus">-  recRule.setComponent(&quot;BYDAY&quot;, 1, [3]);</span>
<a href="#l9.119"></a><span id="l9.119" class="difflineplus">+  recRule.setComponent(&quot;BYMONTH&quot;, [4]);</span>
<a href="#l9.120"></a><span id="l9.120" class="difflineplus">+  recRule.setComponent(&quot;BYDAY&quot;, [3]);</span>
<a href="#l9.121"></a><span id="l9.121">   ok(</span>
<a href="#l9.122"></a><span id="l9.122">     [</span>
<a href="#l9.123"></a><span id="l9.123">       &quot;RRULE:FREQ=YEARLY;BYDAY=TU;BYMONTH=4\r\n&quot;,</span>
<a href="#l9.124"></a><span id="l9.124">       &quot;RRULE:FREQ=YEARLY;BYMONTH=4;BYDAY=TU\r\n&quot;,</span>
<a href="#l9.125"></a><span id="l9.125">     ].includes(recRule.icalString)</span>
<a href="#l9.126"></a><span id="l9.126">   );</span>
<a href="#l9.127"></a><span id="l9.127" class="difflineminus">-  deepEqual(recRule.getComponent(&quot;BYMONTH&quot;, {}), [4]);</span>
<a href="#l9.128"></a><span id="l9.128" class="difflineminus">-  deepEqual(recRule.getComponent(&quot;BYDAY&quot;, {}), [3]);</span>
<a href="#l9.129"></a><span id="l9.129" class="difflineplus">+  deepEqual(recRule.getComponent(&quot;BYMONTH&quot;), [4]);</span>
<a href="#l9.130"></a><span id="l9.130" class="difflineplus">+  deepEqual(recRule.getComponent(&quot;BYDAY&quot;), [3]);</span>
<a href="#l9.131"></a><span id="l9.131"> </span>
<a href="#l9.132"></a><span id="l9.132">   recRule = cal.createRecurrenceRule();</span>
<a href="#l9.133"></a><span id="l9.133">   recRule.type = &quot;YEARLY&quot;;</span>
<a href="#l9.134"></a><span id="l9.134" class="difflineminus">-  recRule.setComponent(&quot;BYMONTH&quot;, 1, [4]);</span>
<a href="#l9.135"></a><span id="l9.135" class="difflineminus">-  recRule.setComponent(&quot;BYDAY&quot;, 1, [10]);</span>
<a href="#l9.136"></a><span id="l9.136" class="difflineplus">+  recRule.setComponent(&quot;BYMONTH&quot;, [4]);</span>
<a href="#l9.137"></a><span id="l9.137" class="difflineplus">+  recRule.setComponent(&quot;BYDAY&quot;, [10]);</span>
<a href="#l9.138"></a><span id="l9.138">   ok(</span>
<a href="#l9.139"></a><span id="l9.139">     [</span>
<a href="#l9.140"></a><span id="l9.140">       &quot;RRULE:FREQ=YEARLY;BYDAY=1MO;BYMONTH=4\r\n&quot;,</span>
<a href="#l9.141"></a><span id="l9.141">       &quot;RRULE:FREQ=YEARLY;BYMONTH=4;BYDAY=1MO\r\n&quot;,</span>
<a href="#l9.142"></a><span id="l9.142">     ].includes(recRule.icalString)</span>
<a href="#l9.143"></a><span id="l9.143">   );</span>
<a href="#l9.144"></a><span id="l9.144" class="difflineminus">-  deepEqual(recRule.getComponent(&quot;BYMONTH&quot;, {}), [4]);</span>
<a href="#l9.145"></a><span id="l9.145" class="difflineminus">-  deepEqual(recRule.getComponent(&quot;BYDAY&quot;, {}), [10]);</span>
<a href="#l9.146"></a><span id="l9.146" class="difflineplus">+  deepEqual(recRule.getComponent(&quot;BYMONTH&quot;), [4]);</span>
<a href="#l9.147"></a><span id="l9.147" class="difflineplus">+  deepEqual(recRule.getComponent(&quot;BYDAY&quot;), [10]);</span>
<a href="#l9.148"></a><span id="l9.148"> </span>
<a href="#l9.149"></a><span id="l9.149">   recRule = cal.createRecurrenceRule();</span>
<a href="#l9.150"></a><span id="l9.150">   recRule.type = &quot;YEARLY&quot;;</span>
<a href="#l9.151"></a><span id="l9.151" class="difflineminus">-  recRule.setComponent(&quot;BYMONTH&quot;, 1, [4]);</span>
<a href="#l9.152"></a><span id="l9.152" class="difflineminus">-  recRule.setComponent(&quot;BYDAY&quot;, 1, [-22]);</span>
<a href="#l9.153"></a><span id="l9.153" class="difflineplus">+  recRule.setComponent(&quot;BYMONTH&quot;, [4]);</span>
<a href="#l9.154"></a><span id="l9.154" class="difflineplus">+  recRule.setComponent(&quot;BYDAY&quot;, [-22]);</span>
<a href="#l9.155"></a><span id="l9.155">   ok(</span>
<a href="#l9.156"></a><span id="l9.156">     [</span>
<a href="#l9.157"></a><span id="l9.157">       &quot;RRULE:FREQ=YEARLY;BYDAY=-2FR;BYMONTH=4\r\n&quot;,</span>
<a href="#l9.158"></a><span id="l9.158">       &quot;RRULE:FREQ=YEARLY;BYMONTH=4;BYDAY=-2FR\r\n&quot;,</span>
<a href="#l9.159"></a><span id="l9.159">     ].includes(recRule.icalString)</span>
<a href="#l9.160"></a><span id="l9.160">   );</span>
<a href="#l9.161"></a><span id="l9.161" class="difflineminus">-  deepEqual(recRule.getComponent(&quot;BYMONTH&quot;, {}), [4]);</span>
<a href="#l9.162"></a><span id="l9.162" class="difflineminus">-  deepEqual(recRule.getComponent(&quot;BYDAY&quot;, {}), [-22]);</span>
<a href="#l9.163"></a><span id="l9.163" class="difflineplus">+  deepEqual(recRule.getComponent(&quot;BYMONTH&quot;), [4]);</span>
<a href="#l9.164"></a><span id="l9.164" class="difflineplus">+  deepEqual(recRule.getComponent(&quot;BYDAY&quot;), [-22]);</span>
<a href="#l9.165"></a><span id="l9.165"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/calendar/test/unit/test_storage.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/calendar/test/unit/test_storage.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -76,17 +76,17 @@ add_task(async () =&gt; {</span>
<a href="#l10.4"></a><span id="l10.4"> </span>
<a href="#l10.5"></a><span id="l10.5">         // Check recurrence item</span>
<a href="#l10.6"></a><span id="l10.6">         for (let ritem of item.recurrenceInfo.getRecurrenceItems({})) {</span>
<a href="#l10.7"></a><span id="l10.7">           if (ritem instanceof Ci.calIRecurrenceRule) {</span>
<a href="#l10.8"></a><span id="l10.8">             equal(ritem.type, &quot;MONTHLY&quot;);</span>
<a href="#l10.9"></a><span id="l10.9">             equal(ritem.interval, 2);</span>
<a href="#l10.10"></a><span id="l10.10">             equal(ritem.count, 5);</span>
<a href="#l10.11"></a><span id="l10.11">             equal(ritem.isByCount, true);</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-            equal(ritem.getComponent(&quot;BYDAY&quot;, {}).toString(), [2].toString());</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+            equal(ritem.getComponent(&quot;BYDAY&quot;).toString(), [2].toString());</span>
<a href="#l10.14"></a><span id="l10.14">             equal(ritem.isNegative, false);</span>
<a href="#l10.15"></a><span id="l10.15">           } else if (ritem instanceof Ci.calIRecurrenceDate) {</span>
<a href="#l10.16"></a><span id="l10.16">             if (ritem.isNegative) {</span>
<a href="#l10.17"></a><span id="l10.17">               equal(ritem.date.compare(cal.createDateTime(&quot;20120301T010101Z&quot;)), 0);</span>
<a href="#l10.18"></a><span id="l10.18">             } else {</span>
<a href="#l10.19"></a><span id="l10.19">               equal(ritem.date.compare(cal.createDateTime(&quot;20120201T010101Z&quot;)), 0);</span>
<a href="#l10.20"></a><span id="l10.20">             }</span>
<a href="#l10.21"></a><span id="l10.21">           } else {</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

