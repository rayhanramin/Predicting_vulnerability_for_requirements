<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 4733:809932c5db94d34ed37b7845b9d120f3f6c486ae</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 809932c5db94d34ed37b7845b9d120f3f6c486ae" />
<meta property="og:url" content="/comm-central/rev/809932c5db94d34ed37b7845b9d120f3f6c486ae" />
<meta property="og:description" content="allow offline stores &gt; 4GB, bug 532323, r=neil, sr=standard8" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 809932c5db94d34ed37b7845b9d120f3f6c486ae 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/809932c5db94d34ed37b7845b9d120f3f6c486ae">shortlog</a> |
<a href="/comm-central/log/809932c5db94d34ed37b7845b9d120f3f6c486ae">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/809932c5db94d34ed37b7845b9d120f3f6c486ae">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/809932c5db94d34ed37b7845b9d120f3f6c486ae">files</a> |
changeset |
<a href="/comm-central/raw-rev/809932c5db94d34ed37b7845b9d120f3f6c486ae">raw</a>  | <a href="/comm-central/archive/809932c5db94d34ed37b7845b9d120f3f6c486ae.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
allow offline stores &gt; 4GB, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=532323">bug 532323</a>, r=neil, sr=standard8
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#68;&#97;&#118;&#105;&#100;&#32;&#66;&#105;&#101;&#110;&#118;&#101;&#110;&#117;&#32;&#60;&#98;&#105;&#101;&#110;&#118;&#101;&#110;&#117;&#64;&#110;&#118;&#101;&#110;&#116;&#117;&#114;&#101;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Wed, 20 Jan 2010 15:43:50 -0800</td></tr>

<tr>
 <td>changeset 4733</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/809932c5db94d34ed37b7845b9d120f3f6c486ae">809932c5db94d34ed37b7845b9d120f3f6c486ae</a></td>
</tr>



<tr>
<td>parent 4732</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/28ce2a63f2077aa0e056561cd71ae516e9cf0af4">28ce2a63f2077aa0e056561cd71ae516e9cf0af4</a>
</td>
</tr>

<tr>
<td>child 4734</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/87aa8a73902d42876259612bd8fd4c9edef60cdd">87aa8a73902d42876259612bd8fd4c9edef60cdd</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=809932c5db94d34ed37b7845b9d120f3f6c486ae">3703</a></td></tr>
<tr><td>push user</td><td>bienvenu@nventure.com</td></tr>
<tr><td>push date</td><td class="date age">Wed, 20 Jan 2010 23:43:50 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@809932c5db94 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=809932c5db94d34ed37b7845b9d120f3f6c486ae">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=809932c5db94d34ed37b7845b9d120f3f6c486ae&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=809932c5db94d34ed37b7845b9d120f3f6c486ae&newProject=comm-central&newRevision=809932c5db94d34ed37b7845b9d120f3f6c486ae&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=809932c5db94d34ed37b7845b9d120f3f6c486ae&newProject=comm-central&newRevision=809932c5db94d34ed37b7845b9d120f3f6c486ae&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=809932c5db94d34ed37b7845b9d120f3f6c486ae&newProject=comm-central&newRevision=809932c5db94d34ed37b7845b9d120f3f6c486ae&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28neil%29&revcount=50">neil</a>, <a href="/comm-central/log?rev=reviewer%28standard8%29&revcount=50">standard8</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=532323">532323</a></td></tr>




</table></div>

<div class="page_body description">allow offline stores &gt; 4GB, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=532323">bug 532323</a>, r=neil, sr=standard8</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/base/public/nsIMsgFolder.idl">mailnews/base/public/nsIMsgFolder.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/base/public/nsIMsgFolder.idl">file</a> |
<a href="/comm-central/annotate/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/base/public/nsIMsgFolder.idl">annotate</a> |
<a href="/comm-central/diff/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/base/public/nsIMsgFolder.idl">diff</a> |
<a href="/comm-central/comparison/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/base/public/nsIMsgFolder.idl">comparison</a> |
<a href="/comm-central/log/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/base/public/nsIMsgFolder.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/base/public/nsIMsgHdr.idl">mailnews/base/public/nsIMsgHdr.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/base/public/nsIMsgHdr.idl">file</a> |
<a href="/comm-central/annotate/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/base/public/nsIMsgHdr.idl">annotate</a> |
<a href="/comm-central/diff/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/base/public/nsIMsgHdr.idl">diff</a> |
<a href="/comm-central/comparison/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/base/public/nsIMsgHdr.idl">comparison</a> |
<a href="/comm-central/log/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/base/public/nsIMsgHdr.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/base/search/public/nsIMsgSearchTerm.idl">mailnews/base/search/public/nsIMsgSearchTerm.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/base/search/public/nsIMsgSearchTerm.idl">file</a> |
<a href="/comm-central/annotate/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/base/search/public/nsIMsgSearchTerm.idl">annotate</a> |
<a href="/comm-central/diff/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/base/search/public/nsIMsgSearchTerm.idl">diff</a> |
<a href="/comm-central/comparison/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/base/search/public/nsIMsgSearchTerm.idl">comparison</a> |
<a href="/comm-central/log/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/base/search/public/nsIMsgSearchTerm.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/base/search/public/nsMsgBodyHandler.h">mailnews/base/search/public/nsMsgBodyHandler.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/base/search/public/nsMsgBodyHandler.h">file</a> |
<a href="/comm-central/annotate/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/base/search/public/nsMsgBodyHandler.h">annotate</a> |
<a href="/comm-central/diff/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/base/search/public/nsMsgBodyHandler.h">diff</a> |
<a href="/comm-central/comparison/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/base/search/public/nsMsgBodyHandler.h">comparison</a> |
<a href="/comm-central/log/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/base/search/public/nsMsgBodyHandler.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/base/search/public/nsMsgSearchTerm.h">mailnews/base/search/public/nsMsgSearchTerm.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/base/search/public/nsMsgSearchTerm.h">file</a> |
<a href="/comm-central/annotate/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/base/search/public/nsMsgSearchTerm.h">annotate</a> |
<a href="/comm-central/diff/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/base/search/public/nsMsgSearchTerm.h">diff</a> |
<a href="/comm-central/comparison/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/base/search/public/nsMsgSearchTerm.h">comparison</a> |
<a href="/comm-central/log/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/base/search/public/nsMsgSearchTerm.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/base/search/src/nsMsgBodyHandler.cpp">mailnews/base/search/src/nsMsgBodyHandler.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/base/search/src/nsMsgBodyHandler.cpp">file</a> |
<a href="/comm-central/annotate/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/base/search/src/nsMsgBodyHandler.cpp">annotate</a> |
<a href="/comm-central/diff/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/base/search/src/nsMsgBodyHandler.cpp">diff</a> |
<a href="/comm-central/comparison/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/base/search/src/nsMsgBodyHandler.cpp">comparison</a> |
<a href="/comm-central/log/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/base/search/src/nsMsgBodyHandler.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/base/search/src/nsMsgLocalSearch.cpp">mailnews/base/search/src/nsMsgLocalSearch.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/base/search/src/nsMsgLocalSearch.cpp">file</a> |
<a href="/comm-central/annotate/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/base/search/src/nsMsgLocalSearch.cpp">annotate</a> |
<a href="/comm-central/diff/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/base/search/src/nsMsgLocalSearch.cpp">diff</a> |
<a href="/comm-central/comparison/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/base/search/src/nsMsgLocalSearch.cpp">comparison</a> |
<a href="/comm-central/log/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/base/search/src/nsMsgLocalSearch.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/base/search/src/nsMsgSearchTerm.cpp">mailnews/base/search/src/nsMsgSearchTerm.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/base/search/src/nsMsgSearchTerm.cpp">file</a> |
<a href="/comm-central/annotate/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/base/search/src/nsMsgSearchTerm.cpp">annotate</a> |
<a href="/comm-central/diff/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/base/search/src/nsMsgSearchTerm.cpp">diff</a> |
<a href="/comm-central/comparison/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/base/search/src/nsMsgSearchTerm.cpp">comparison</a> |
<a href="/comm-central/log/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/base/search/src/nsMsgSearchTerm.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/base/src/nsMsgFolderCompactor.cpp">mailnews/base/src/nsMsgFolderCompactor.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/base/src/nsMsgFolderCompactor.cpp">file</a> |
<a href="/comm-central/annotate/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/base/src/nsMsgFolderCompactor.cpp">annotate</a> |
<a href="/comm-central/diff/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/base/src/nsMsgFolderCompactor.cpp">diff</a> |
<a href="/comm-central/comparison/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/base/src/nsMsgFolderCompactor.cpp">comparison</a> |
<a href="/comm-central/log/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/base/src/nsMsgFolderCompactor.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/base/src/nsMsgFolderCompactor.h">mailnews/base/src/nsMsgFolderCompactor.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/base/src/nsMsgFolderCompactor.h">file</a> |
<a href="/comm-central/annotate/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/base/src/nsMsgFolderCompactor.h">annotate</a> |
<a href="/comm-central/diff/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/base/src/nsMsgFolderCompactor.h">diff</a> |
<a href="/comm-central/comparison/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/base/src/nsMsgFolderCompactor.h">comparison</a> |
<a href="/comm-central/log/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/base/src/nsMsgFolderCompactor.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/base/util/nsMsgDBFolder.cpp">mailnews/base/util/nsMsgDBFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/base/util/nsMsgDBFolder.cpp">file</a> |
<a href="/comm-central/annotate/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/base/util/nsMsgDBFolder.cpp">annotate</a> |
<a href="/comm-central/diff/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/base/util/nsMsgDBFolder.cpp">diff</a> |
<a href="/comm-central/comparison/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/base/util/nsMsgDBFolder.cpp">comparison</a> |
<a href="/comm-central/log/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/base/util/nsMsgDBFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/base/util/nsMsgProtocol.cpp">mailnews/base/util/nsMsgProtocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/base/util/nsMsgProtocol.cpp">file</a> |
<a href="/comm-central/annotate/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/base/util/nsMsgProtocol.cpp">annotate</a> |
<a href="/comm-central/diff/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/base/util/nsMsgProtocol.cpp">diff</a> |
<a href="/comm-central/comparison/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/base/util/nsMsgProtocol.cpp">comparison</a> |
<a href="/comm-central/log/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/base/util/nsMsgProtocol.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/db/msgdb/public/nsIMsgDatabase.idl">mailnews/db/msgdb/public/nsIMsgDatabase.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/db/msgdb/public/nsIMsgDatabase.idl">file</a> |
<a href="/comm-central/annotate/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/db/msgdb/public/nsIMsgDatabase.idl">annotate</a> |
<a href="/comm-central/diff/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/db/msgdb/public/nsIMsgDatabase.idl">diff</a> |
<a href="/comm-central/comparison/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/db/msgdb/public/nsIMsgDatabase.idl">comparison</a> |
<a href="/comm-central/log/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/db/msgdb/public/nsIMsgDatabase.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/db/msgdb/public/nsImapMailDatabase.h">mailnews/db/msgdb/public/nsImapMailDatabase.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/db/msgdb/public/nsImapMailDatabase.h">file</a> |
<a href="/comm-central/annotate/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/db/msgdb/public/nsImapMailDatabase.h">annotate</a> |
<a href="/comm-central/diff/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/db/msgdb/public/nsImapMailDatabase.h">diff</a> |
<a href="/comm-central/comparison/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/db/msgdb/public/nsImapMailDatabase.h">comparison</a> |
<a href="/comm-central/log/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/db/msgdb/public/nsImapMailDatabase.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/db/msgdb/public/nsMsgDatabase.h">mailnews/db/msgdb/public/nsMsgDatabase.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/db/msgdb/public/nsMsgDatabase.h">file</a> |
<a href="/comm-central/annotate/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/db/msgdb/public/nsMsgDatabase.h">annotate</a> |
<a href="/comm-central/diff/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/db/msgdb/public/nsMsgDatabase.h">diff</a> |
<a href="/comm-central/comparison/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/db/msgdb/public/nsMsgDatabase.h">comparison</a> |
<a href="/comm-central/log/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/db/msgdb/public/nsMsgDatabase.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/db/msgdb/public/nsMsgHdr.h">mailnews/db/msgdb/public/nsMsgHdr.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/db/msgdb/public/nsMsgHdr.h">file</a> |
<a href="/comm-central/annotate/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/db/msgdb/public/nsMsgHdr.h">annotate</a> |
<a href="/comm-central/diff/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/db/msgdb/public/nsMsgHdr.h">diff</a> |
<a href="/comm-central/comparison/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/db/msgdb/public/nsMsgHdr.h">comparison</a> |
<a href="/comm-central/log/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/db/msgdb/public/nsMsgHdr.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/db/msgdb/src/nsImapMailDatabase.cpp">mailnews/db/msgdb/src/nsImapMailDatabase.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/db/msgdb/src/nsImapMailDatabase.cpp">file</a> |
<a href="/comm-central/annotate/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/db/msgdb/src/nsImapMailDatabase.cpp">annotate</a> |
<a href="/comm-central/diff/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/db/msgdb/src/nsImapMailDatabase.cpp">diff</a> |
<a href="/comm-central/comparison/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/db/msgdb/src/nsImapMailDatabase.cpp">comparison</a> |
<a href="/comm-central/log/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/db/msgdb/src/nsImapMailDatabase.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/db/msgdb/src/nsMailDatabase.cpp">mailnews/db/msgdb/src/nsMailDatabase.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/db/msgdb/src/nsMailDatabase.cpp">file</a> |
<a href="/comm-central/annotate/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/db/msgdb/src/nsMailDatabase.cpp">annotate</a> |
<a href="/comm-central/diff/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/db/msgdb/src/nsMailDatabase.cpp">diff</a> |
<a href="/comm-central/comparison/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/db/msgdb/src/nsMailDatabase.cpp">comparison</a> |
<a href="/comm-central/log/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/db/msgdb/src/nsMailDatabase.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/db/msgdb/src/nsMsgDatabase.cpp">mailnews/db/msgdb/src/nsMsgDatabase.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/db/msgdb/src/nsMsgDatabase.cpp">file</a> |
<a href="/comm-central/annotate/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/db/msgdb/src/nsMsgDatabase.cpp">annotate</a> |
<a href="/comm-central/diff/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/db/msgdb/src/nsMsgDatabase.cpp">diff</a> |
<a href="/comm-central/comparison/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/db/msgdb/src/nsMsgDatabase.cpp">comparison</a> |
<a href="/comm-central/log/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/db/msgdb/src/nsMsgDatabase.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/db/msgdb/src/nsMsgHdr.cpp">mailnews/db/msgdb/src/nsMsgHdr.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/db/msgdb/src/nsMsgHdr.cpp">file</a> |
<a href="/comm-central/annotate/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/db/msgdb/src/nsMsgHdr.cpp">annotate</a> |
<a href="/comm-central/diff/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/db/msgdb/src/nsMsgHdr.cpp">diff</a> |
<a href="/comm-central/comparison/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/db/msgdb/src/nsMsgHdr.cpp">comparison</a> |
<a href="/comm-central/log/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/db/msgdb/src/nsMsgHdr.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/imap/src/nsImapMailFolder.cpp">mailnews/imap/src/nsImapMailFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/imap/src/nsImapMailFolder.cpp">file</a> |
<a href="/comm-central/annotate/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/imap/src/nsImapMailFolder.cpp">annotate</a> |
<a href="/comm-central/diff/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/imap/src/nsImapMailFolder.cpp">diff</a> |
<a href="/comm-central/comparison/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/imap/src/nsImapMailFolder.cpp">comparison</a> |
<a href="/comm-central/log/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/imap/src/nsImapMailFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/imap/src/nsImapOfflineSync.cpp">mailnews/imap/src/nsImapOfflineSync.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/imap/src/nsImapOfflineSync.cpp">file</a> |
<a href="/comm-central/annotate/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/imap/src/nsImapOfflineSync.cpp">annotate</a> |
<a href="/comm-central/diff/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/imap/src/nsImapOfflineSync.cpp">diff</a> |
<a href="/comm-central/comparison/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/imap/src/nsImapOfflineSync.cpp">comparison</a> |
<a href="/comm-central/log/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/imap/src/nsImapOfflineSync.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/imap/src/nsImapProtocol.cpp">mailnews/imap/src/nsImapProtocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/imap/src/nsImapProtocol.cpp">file</a> |
<a href="/comm-central/annotate/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/imap/src/nsImapProtocol.cpp">annotate</a> |
<a href="/comm-central/diff/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/imap/src/nsImapProtocol.cpp">diff</a> |
<a href="/comm-central/comparison/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/imap/src/nsImapProtocol.cpp">comparison</a> |
<a href="/comm-central/log/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/imap/src/nsImapProtocol.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/imap/src/nsImapService.cpp">mailnews/imap/src/nsImapService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/imap/src/nsImapService.cpp">file</a> |
<a href="/comm-central/annotate/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/imap/src/nsImapService.cpp">annotate</a> |
<a href="/comm-central/diff/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/imap/src/nsImapService.cpp">diff</a> |
<a href="/comm-central/comparison/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/imap/src/nsImapService.cpp">comparison</a> |
<a href="/comm-central/log/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/imap/src/nsImapService.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/imap/test/unit/test_largeOfflineStore.js">mailnews/imap/test/unit/test_largeOfflineStore.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/imap/test/unit/test_largeOfflineStore.js">file</a> |
<a href="/comm-central/annotate/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/imap/test/unit/test_largeOfflineStore.js">annotate</a> |
<a href="/comm-central/diff/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/imap/test/unit/test_largeOfflineStore.js">diff</a> |
<a href="/comm-central/comparison/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/imap/test/unit/test_largeOfflineStore.js">comparison</a> |
<a href="/comm-central/log/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/imap/test/unit/test_largeOfflineStore.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/local/src/nsLocalMailFolder.cpp">mailnews/local/src/nsLocalMailFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/local/src/nsLocalMailFolder.cpp">file</a> |
<a href="/comm-central/annotate/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/local/src/nsLocalMailFolder.cpp">annotate</a> |
<a href="/comm-central/diff/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/local/src/nsLocalMailFolder.cpp">diff</a> |
<a href="/comm-central/comparison/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/local/src/nsLocalMailFolder.cpp">comparison</a> |
<a href="/comm-central/log/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/local/src/nsLocalMailFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/local/src/nsParseMailbox.cpp">mailnews/local/src/nsParseMailbox.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/local/src/nsParseMailbox.cpp">file</a> |
<a href="/comm-central/annotate/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/local/src/nsParseMailbox.cpp">annotate</a> |
<a href="/comm-central/diff/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/local/src/nsParseMailbox.cpp">diff</a> |
<a href="/comm-central/comparison/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/local/src/nsParseMailbox.cpp">comparison</a> |
<a href="/comm-central/log/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/local/src/nsParseMailbox.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/local/src/nsParseMailbox.h">mailnews/local/src/nsParseMailbox.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/local/src/nsParseMailbox.h">file</a> |
<a href="/comm-central/annotate/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/local/src/nsParseMailbox.h">annotate</a> |
<a href="/comm-central/diff/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/local/src/nsParseMailbox.h">diff</a> |
<a href="/comm-central/comparison/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/local/src/nsParseMailbox.h">comparison</a> |
<a href="/comm-central/log/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/local/src/nsParseMailbox.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/news/src/nsNNTPProtocol.cpp">mailnews/news/src/nsNNTPProtocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/news/src/nsNNTPProtocol.cpp">file</a> |
<a href="/comm-central/annotate/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/news/src/nsNNTPProtocol.cpp">annotate</a> |
<a href="/comm-central/diff/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/news/src/nsNNTPProtocol.cpp">diff</a> |
<a href="/comm-central/comparison/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/news/src/nsNNTPProtocol.cpp">comparison</a> |
<a href="/comm-central/log/809932c5db94d34ed37b7845b9d120f3f6c486ae/mailnews/news/src/nsNNTPProtocol.cpp">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/base/public/nsIMsgFolder.idl</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/base/public/nsIMsgFolder.idl</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -514,18 +514,29 @@ interface nsIMsgFolder : nsISupports {</span>
<a href="#l1.4"></a><span id="l1.4">   void openBackupMsgDatabase();</span>
<a href="#l1.5"></a><span id="l1.5">   nsIMsgDatabase getDBFolderInfoAndDB(out nsIDBFolderInfo folderInfo);</span>
<a href="#l1.6"></a><span id="l1.6">   nsIMsgDBHdr GetMessageHeader(in nsMsgKey msgKey);</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8">   readonly attribute boolean supportsOffline;</span>
<a href="#l1.9"></a><span id="l1.9">   boolean shouldStoreMsgOffline(in nsMsgKey msgKey);</span>
<a href="#l1.10"></a><span id="l1.10">   boolean hasMsgOffline(in nsMsgKey msgKey);</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-  nsIInputStream getOfflineFileStream(in nsMsgKey msgKey, out PRUint32 offset,</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-                                      out PRUint32 size);</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+  /**</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+   * Get an input stream to read the offline contents of an imap or news</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+   * message.</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+   *</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+   * @param aMsgKey key of message to get input stream for.</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+   * @param[out] aOffset filled in with the offset into the stream of the message.</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineplus">+   * @param[out] aSize filled in with the size of the message in the offline store.</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineplus">+   *</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineplus">+   * @returns input stream to read the message from.</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineplus">+   */</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineplus">+  nsIInputStream getOfflineFileStream(in nsMsgKey aMsgKey,</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineplus">+                                      out unsigned long long aOffset,</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineplus">+                                      out unsigned long aSize);</span>
<a href="#l1.27"></a><span id="l1.27">   readonly attribute nsIOutputStream offlineStoreOutputStream;</span>
<a href="#l1.28"></a><span id="l1.28">   readonly attribute nsIInputStream offlineStoreInputStream;</span>
<a href="#l1.29"></a><span id="l1.29">   void DownloadMessagesForOffline(in nsIArray messages,</span>
<a href="#l1.30"></a><span id="l1.30">                                   in nsIMsgWindow window);</span>
<a href="#l1.31"></a><span id="l1.31">   nsIMsgFolder getChildWithURI(in ACString uri, in boolean deep,</span>
<a href="#l1.32"></a><span id="l1.32">                                in boolean caseInsensitive);</span>
<a href="#l1.33"></a><span id="l1.33">   void downloadAllForOffline(in nsIUrlListener listener, in nsIMsgWindow window);</span>
<a href="#l1.34"></a><span id="l1.34">   /**</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/base/public/nsIMsgHdr.idl</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/base/public/nsIMsgHdr.idl</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -43,17 +43,17 @@</span>
<a href="#l2.4"></a><span id="l2.4"> </span>
<a href="#l2.5"></a><span id="l2.5"> #include &quot;MailNewsTypes2.idl&quot;</span>
<a href="#l2.6"></a><span id="l2.6"> </span>
<a href="#l2.7"></a><span id="l2.7"> [ptr] native octetPtr(PRUint8);</span>
<a href="#l2.8"></a><span id="l2.8"> </span>
<a href="#l2.9"></a><span id="l2.9"> interface nsIMsgFolder;</span>
<a href="#l2.10"></a><span id="l2.10"> interface nsIUTF8StringEnumerator;</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-[scriptable, uuid(1CE98909-F83C-4f88-B660-A279850D3112)]</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+[scriptable, uuid(574611fe-f170-4eb4-a30c-a26e2c62703a)]</span>
<a href="#l2.14"></a><span id="l2.14"> interface nsIMsgDBHdr : nsISupports</span>
<a href="#l2.15"></a><span id="l2.15"> {</span>
<a href="#l2.16"></a><span id="l2.16">     /* general property routines - I think this can retrieve any</span>
<a href="#l2.17"></a><span id="l2.17">        header in the db */</span>
<a href="#l2.18"></a><span id="l2.18">     AString getProperty(in string propertyName);</span>
<a href="#l2.19"></a><span id="l2.19">     void setProperty(in string propertyName, in AString propertyStr);</span>
<a href="#l2.20"></a><span id="l2.20">     void setStringProperty(in string propertyName, in string propertyValue);</span>
<a href="#l2.21"></a><span id="l2.21">     string getStringProperty(in string propertyName);</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineat">@@ -85,17 +85,18 @@ interface nsIMsgDBHdr : nsISupports</span>
<a href="#l2.23"></a><span id="l2.23">     attribute nsMsgKey threadId;</span>
<a href="#l2.24"></a><span id="l2.24">     attribute nsMsgKey messageKey;</span>
<a href="#l2.25"></a><span id="l2.25">     attribute nsMsgKey threadParent;</span>
<a href="#l2.26"></a><span id="l2.26"> </span>
<a href="#l2.27"></a><span id="l2.27">     /* meta information about the message, learned from reading the message */</span>
<a href="#l2.28"></a><span id="l2.28">     attribute unsigned long messageSize;</span>
<a href="#l2.29"></a><span id="l2.29">     attribute unsigned long lineCount;</span>
<a href="#l2.30"></a><span id="l2.30">     attribute unsigned long statusOffset;</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-    attribute unsigned long messageOffset;</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+    /// The offset into the local folder/offline store of the message.</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+    attribute unsigned long long messageOffset;</span>
<a href="#l2.34"></a><span id="l2.34">     attribute unsigned long offlineMessageSize;</span>
<a href="#l2.35"></a><span id="l2.35">     /* common headers */</span>
<a href="#l2.36"></a><span id="l2.36">     attribute PRTime date;</span>
<a href="#l2.37"></a><span id="l2.37">     readonly attribute unsigned long dateInSeconds;</span>
<a href="#l2.38"></a><span id="l2.38">     attribute string messageId;</span>
<a href="#l2.39"></a><span id="l2.39">     attribute string ccList;</span>
<a href="#l2.40"></a><span id="l2.40">     attribute string bccList;</span>
<a href="#l2.41"></a><span id="l2.41">     attribute string author;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/base/search/public/nsIMsgSearchTerm.idl</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/base/search/public/nsIMsgSearchTerm.idl</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -39,17 +39,17 @@</span>
<a href="#l3.4"></a><span id="l3.4"> #include &quot;nsISupports.idl&quot;</span>
<a href="#l3.5"></a><span id="l3.5"> #include &quot;nsMsgSearchCore.idl&quot;</span>
<a href="#l3.6"></a><span id="l3.6"> #include &quot;nsIMsgSearchValue.idl&quot;</span>
<a href="#l3.7"></a><span id="l3.7"> </span>
<a href="#l3.8"></a><span id="l3.8"> interface nsIMsgDBHdr;</span>
<a href="#l3.9"></a><span id="l3.9"> interface nsIMsgDatabase;</span>
<a href="#l3.10"></a><span id="l3.10"> interface nsIMsgSearchScopeTerm;</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-[scriptable, uuid(80BC6107-A61D-4469-B7D6-18C17D6DEC91)]</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+[scriptable, uuid(bb0e5261-c7da-44de-83b9-a39064ad707f)]</span>
<a href="#l3.14"></a><span id="l3.14"> interface nsIMsgSearchTerm : nsISupports {</span>
<a href="#l3.15"></a><span id="l3.15">     attribute nsMsgSearchAttribValue attrib;</span>
<a href="#l3.16"></a><span id="l3.16">     attribute nsMsgSearchOpValue op;</span>
<a href="#l3.17"></a><span id="l3.17">     attribute nsIMsgSearchValue value;</span>
<a href="#l3.18"></a><span id="l3.18"> </span>
<a href="#l3.19"></a><span id="l3.19">     attribute boolean booleanAnd;</span>
<a href="#l3.20"></a><span id="l3.20">     attribute ACString arbitraryHeader;</span>
<a href="#l3.21"></a><span id="l3.21">     /**</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineat">@@ -85,37 +85,58 @@ interface nsIMsgSearchTerm : nsISupports</span>
<a href="#l3.23"></a><span id="l3.23">     /*</span>
<a href="#l3.24"></a><span id="l3.24">      * Test search term match for junkscoreorigin</span>
<a href="#l3.25"></a><span id="l3.25">      * @param  aJunkScoreOrigin  Who set junk score? Possible values:</span>
<a href="#l3.26"></a><span id="l3.26">      *                           plugin filter imapflag user whitelist</span>
<a href="#l3.27"></a><span id="l3.27">      * @return                   true if matches</span>
<a href="#l3.28"></a><span id="l3.28">      */</span>
<a href="#l3.29"></a><span id="l3.29">     boolean matchJunkScoreOrigin(in string aJunkScoreOrigin);</span>
<a href="#l3.30"></a><span id="l3.30"> </span>
<a href="#l3.31"></a><span id="l3.31" class="difflineminus">-    boolean matchBody(in nsIMsgSearchScopeTerm scopeTerm,</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineminus">-                      in unsigned long offset,</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineminus">-                      in unsigned long length,</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineminus">-                      in string charset,</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineminus">-                      in nsIMsgDBHdr msg,</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineminus">-                      in nsIMsgDatabase db);</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+    /**</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+     * Test if the body of the passed in message matches &quot;this&quot; search term.</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+     * @param aScopeTerm scope of search</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+     * @param aOffset offset of message in message store.</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+     * @param aLength length of message.</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineplus">+     * @param aCharset folder charset.</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineplus">+     * @param aMsg db msg hdr of message to match.</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineplus">+     * @param aDB db containing msg header.</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineplus">+     */</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineplus">+    boolean matchBody(in nsIMsgSearchScopeTerm aScopeTerm,</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineplus">+                      in unsigned long long aOffset,</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineplus">+                      in unsigned long aLength,</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineplus">+                      in string aCharset,</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineplus">+                      in nsIMsgDBHdr aMsg,</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineplus">+                      in nsIMsgDatabase aDb);</span>
<a href="#l3.52"></a><span id="l3.52"> </span>
<a href="#l3.53"></a><span id="l3.53" class="difflineminus">-    // marking noscript because headers is a null-separated list of strings,</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineminus">-    // which is not scriptable</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineplus">+    /**</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineplus">+     * Test if the arbitrary header specified by this search term</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineplus">+     * matches the corresponding header in the passed in message.</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineplus">+     *</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineplus">+     * @param aScopeTerm scope of search</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineplus">+     * @param aOffset offset of message in message store</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineplus">+     * @param aLength length of message</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineplus">+     * @param aCharset The charset to apply to un-labeled non-UTF-8 data.</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineplus">+     * @param aCharsetOverride If true, aCharset is used instead of any</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineplus">+     *                         charset labeling other than UTF-8.</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineplus">+     *</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineplus">+     * N.B. This is noscript because headers is a null-separated list of</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineplus">+     * strings, which is not scriptable.</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineplus">+     */</span>
<a href="#l3.69"></a><span id="l3.69">     [noscript]</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineminus">-    boolean matchArbitraryHeader(in nsIMsgSearchScopeTerm scopeTerm,</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineminus">-                                 in unsigned long offset,</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineminus">-                                 in unsigned long length,</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineminus">-                                 in string charset,</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineminus">-                                 in boolean charsetOverride,</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineminus">-                                 in nsIMsgDBHdr msg,</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineminus">-                                 in nsIMsgDatabase db,</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineplus">+    boolean matchArbitraryHeader(in nsIMsgSearchScopeTerm aScopeTerm,</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineplus">+                                 in unsigned long long aOffset,</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineplus">+                                 in unsigned long aLength,</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineplus">+                                 in string aCharset,</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineplus">+                                 in boolean aCharsetOverride,</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineplus">+                                 in nsIMsgDBHdr aMsg,</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineplus">+                                 in nsIMsgDatabase aDb,</span>
<a href="#l3.84"></a><span id="l3.84">                                  //[array, size_is(headerLength)] in string headers,</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineminus">-                                 in string headers,</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineminus">-                                 in unsigned long headerLength,</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineminus">-                                 in boolean forFilters);</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineplus">+                                 in string aHeaders,</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineplus">+                                 in unsigned long aHeaderLength,</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineplus">+                                 in boolean aForFilters);</span>
<a href="#l3.91"></a><span id="l3.91"> </span>
<a href="#l3.92"></a><span id="l3.92">     /**</span>
<a href="#l3.93"></a><span id="l3.93">      * Compares value.str with nsIMsgHdr::GetProperty(hdrProperty).</span>
<a href="#l3.94"></a><span id="l3.94">      * @param msg   msg to match db hdr property of.</span>
<a href="#l3.95"></a><span id="l3.95">      *</span>
<a href="#l3.96"></a><span id="l3.96">      * @returns     true if msg matches property, false otherwise.</span>
<a href="#l3.97"></a><span id="l3.97">      */</span>
<a href="#l3.98"></a><span id="l3.98">     boolean matchHdrProperty(in nsIMsgDBHdr msg);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/base/search/public/nsMsgBodyHandler.h</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/base/search/public/nsMsgBodyHandler.h</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -16,17 +16,17 @@ public:</span>
<a href="#l4.4"></a><span id="l4.4">     PRUint32 length,</span>
<a href="#l4.5"></a><span id="l4.5">     nsIMsgDBHdr * msg,</span>
<a href="#l4.6"></a><span id="l4.6">     nsIMsgDatabase * db);</span>
<a href="#l4.7"></a><span id="l4.7"> </span>
<a href="#l4.8"></a><span id="l4.8">   // we can also create a body handler when doing arbitrary header</span>
<a href="#l4.9"></a><span id="l4.9">   // filtering...we need the list of headers and the header size as well</span>
<a href="#l4.10"></a><span id="l4.10">   // if we are doing filtering...if ForFilters is false, headers and</span>
<a href="#l4.11"></a><span id="l4.11">   // headersSize is ignored!!!</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-  nsMsgBodyHandler (nsIMsgSearchScopeTerm *, PRUint32 offset,</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+  nsMsgBodyHandler (nsIMsgSearchScopeTerm *, PRUint64 offset,</span>
<a href="#l4.14"></a><span id="l4.14">     PRUint32 length, nsIMsgDBHdr * msg, nsIMsgDatabase * db,</span>
<a href="#l4.15"></a><span id="l4.15">     const char * headers /* NULL terminated list of headers */,</span>
<a href="#l4.16"></a><span id="l4.16">     PRUint32 headersSize, PRBool ForFilters);</span>
<a href="#l4.17"></a><span id="l4.17"> </span>
<a href="#l4.18"></a><span id="l4.18">   virtual ~nsMsgBodyHandler();</span>
<a href="#l4.19"></a><span id="l4.19"> </span>
<a href="#l4.20"></a><span id="l4.20">   // returns next message line in buf</span>
<a href="#l4.21"></a><span id="l4.21">   PRInt32 GetNextLine(nsCString &amp;buf);</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineat">@@ -56,17 +56,17 @@ protected:</span>
<a href="#l4.23"></a><span id="l4.23">   nsIMsgSearchScopeTerm *m_scope;</span>
<a href="#l4.24"></a><span id="l4.24">   nsCOMPtr &lt;nsILineInputStream&gt; m_fileLineStream;</span>
<a href="#l4.25"></a><span id="l4.25">   nsCOMPtr &lt;nsILocalFile&gt; m_localFile;</span>
<a href="#l4.26"></a><span id="l4.26">   // local file state</span>
<a href="#l4.27"></a><span id="l4.27">   //  XP_File  *m_localFile;</span>
<a href="#l4.28"></a><span id="l4.28">   // need a file stream here, I bet</span>
<a href="#l4.29"></a><span id="l4.29"> </span>
<a href="#l4.30"></a><span id="l4.30">   // current offset into the mail folder file.</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineminus">-  PRInt32 m_localFileOffset;</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+  PRUint64 m_localFileOffset;</span>
<a href="#l4.33"></a><span id="l4.33">   /**</span>
<a href="#l4.34"></a><span id="l4.34">    * The number of lines in the message.  If |m_lineCountInBodyLines| then this</span>
<a href="#l4.35"></a><span id="l4.35">    * is the number of body lines, otherwise this is the entire number of lines</span>
<a href="#l4.36"></a><span id="l4.36">    * in the message.  This is important so we know when to stop reading the file</span>
<a href="#l4.37"></a><span id="l4.37">    * without accidentally reading part of the next message.</span>
<a href="#l4.38"></a><span id="l4.38">    */</span>
<a href="#l4.39"></a><span id="l4.39">   PRUint32 m_numLocalLines;</span>
<a href="#l4.40"></a><span id="l4.40">   /**</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/base/search/public/nsMsgSearchTerm.h</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/base/search/public/nsMsgSearchTerm.h</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -57,39 +57,16 @@ public:</span>
<a href="#l5.4"></a><span id="l5.4">   nsMsgSearchTerm();</span>
<a href="#l5.5"></a><span id="l5.5">   nsMsgSearchTerm (nsMsgSearchAttribValue, nsMsgSearchOpValue, nsIMsgSearchValue *, nsMsgSearchBooleanOperator, const char * arbitraryHeader);</span>
<a href="#l5.6"></a><span id="l5.6"> </span>
<a href="#l5.7"></a><span id="l5.7">   virtual ~nsMsgSearchTerm ();</span>
<a href="#l5.8"></a><span id="l5.8"> </span>
<a href="#l5.9"></a><span id="l5.9">     NS_DECL_ISUPPORTS</span>
<a href="#l5.10"></a><span id="l5.10">     NS_DECL_NSIMSGSEARCHTERM</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-  PRInt32 GetNextIMAPOfflineMsgLine (char * buf, int bufferSize, int msgOffset, nsIMsgDBHdr * msg, nsIMsgDatabase * db);</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineminus">-</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineminus">-</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineminus">-    //  nsresult MatchBody (nsIMsgSearchScopeTerm*, PRUint32 offset, PRUint32 length, const char *charset,</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineminus">-    //            nsIMsgDBHdr * msg, nsIMsgDatabase * db, PRBool *pResult);</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineminus">-    //  nsresult MatchArbitraryHeader (nsIMsgSearchScopeTerm *,</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineminus">-    //                                   PRUint32 offset,</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineminus">-    //                                   PRUint32 length,</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineminus">-    //                                   const char *charset,</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineminus">-    //                                   nsIMsgDBHdr * msg,</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineminus">-    //                                   nsIMsgDatabase *db,</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineminus">-    //                                   const char * headers, /* NULL terminated header list for msgs being filtered. Ignored unless ForFilters */</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineminus">-    //                                   PRUint32 headersSize, /* size of the NULL terminated list of headers */</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineminus">-    //                                   PRBool ForFilters /* true if we are filtering */,</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineminus">-    //                   PRBool *pResult);</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineminus">-  // nsresult MatchDate (PRTime, PRBool *result);</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineminus">-  // nsresult MatchStatus (PRUint32, PRBool *result);</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineminus">-  // nsresult MatchPriority (nsMsgPriorityValue, PRBool *result);</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineminus">-  // nsresult MatchSize (PRUint32, PRBool *result);</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineminus">-    //  nsresult MatchRfc822String(const char *, const char *charset, PRBool *pResult);</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineminus">-  // nsresult MatchAge (PRTime, PRBool *result);</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineminus">-</span>
<a href="#l5.35"></a><span id="l5.35">   nsresult DeStream (char *, PRInt16 length);</span>
<a href="#l5.36"></a><span id="l5.36">   nsresult DeStreamNew (char *, PRInt16 length);</span>
<a href="#l5.37"></a><span id="l5.37"> </span>
<a href="#l5.38"></a><span id="l5.38">   nsresult GetLocalTimes (PRTime, PRTime, PRExplodedTime &amp;, PRExplodedTime &amp;);</span>
<a href="#l5.39"></a><span id="l5.39"> </span>
<a href="#l5.40"></a><span id="l5.40">   PRBool IsBooleanOpAND() { return m_booleanOp == nsMsgSearchBooleanOp::BooleanAND ? PR_TRUE : PR_FALSE;}</span>
<a href="#l5.41"></a><span id="l5.41">   nsMsgSearchBooleanOperator GetBooleanOp() {return m_booleanOp;}</span>
<a href="#l5.42"></a><span id="l5.42">   // maybe should return nsString &amp;   ??</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgBodyHandler.cpp</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgBodyHandler.cpp</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -68,17 +68,17 @@ nsMsgBodyHandler::nsMsgBodyHandler (nsIM</span>
<a href="#l6.4"></a><span id="l6.4">   m_headersSize = 0;</span>
<a href="#l6.5"></a><span id="l6.5">   m_Filtering = PR_FALSE; // make sure we set this before we call initialize...</span>
<a href="#l6.6"></a><span id="l6.6">   </span>
<a href="#l6.7"></a><span id="l6.7">   Initialize();  // common initialization stuff</span>
<a href="#l6.8"></a><span id="l6.8">   OpenLocalFolder();      </span>
<a href="#l6.9"></a><span id="l6.9"> }</span>
<a href="#l6.10"></a><span id="l6.10"> </span>
<a href="#l6.11"></a><span id="l6.11"> nsMsgBodyHandler::nsMsgBodyHandler(nsIMsgSearchScopeTerm * scope,</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-                                   PRUint32 offset, PRUint32 numLines,</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+                                   PRUint64 offset, PRUint32 numLines,</span>
<a href="#l6.14"></a><span id="l6.14">                                    nsIMsgDBHdr* msg, nsIMsgDatabase* db,</span>
<a href="#l6.15"></a><span id="l6.15">                                    const char * headers, PRUint32 headersSize,</span>
<a href="#l6.16"></a><span id="l6.16">                                    PRBool Filtering)</span>
<a href="#l6.17"></a><span id="l6.17"> {</span>
<a href="#l6.18"></a><span id="l6.18">   m_scope = scope;</span>
<a href="#l6.19"></a><span id="l6.19">   m_localFileOffset = offset;</span>
<a href="#l6.20"></a><span id="l6.20">   m_numLocalLines = numLines;</span>
<a href="#l6.21"></a><span id="l6.21">   PRUint32 flags;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgLocalSearch.cpp</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgLocalSearch.cpp</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -515,17 +515,17 @@ nsresult nsMsgSearchOfflineMail::Process</span>
<a href="#l7.4"></a><span id="l7.4">           nsCString bccList;</span>
<a href="#l7.5"></a><span id="l7.5">           msgToMatch-&gt;GetBccList(getter_Copies(bccList));</span>
<a href="#l7.6"></a><span id="l7.6">           err = aTerm-&gt;MatchRfc822String(bccList.get(), charset, charsetOverride, &amp;result);</span>
<a href="#l7.7"></a><span id="l7.7">         }</span>
<a href="#l7.8"></a><span id="l7.8">         break;</span>
<a href="#l7.9"></a><span id="l7.9">       }</span>
<a href="#l7.10"></a><span id="l7.10">       case nsMsgSearchAttrib::Body:</span>
<a href="#l7.11"></a><span id="l7.11">        {</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-         nsMsgKey messageOffset;</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+         PRUint64 messageOffset;</span>
<a href="#l7.14"></a><span id="l7.14">          PRUint32 lineCount;</span>
<a href="#l7.15"></a><span id="l7.15">          msgToMatch-&gt;GetMessageOffset(&amp;messageOffset);</span>
<a href="#l7.16"></a><span id="l7.16">          msgToMatch-&gt;GetLineCount(&amp;lineCount);</span>
<a href="#l7.17"></a><span id="l7.17">          err = aTerm-&gt;MatchBody (scope, messageOffset, lineCount, charset, msgToMatch, db, &amp;result);</span>
<a href="#l7.18"></a><span id="l7.18">          break;</span>
<a href="#l7.19"></a><span id="l7.19">        }</span>
<a href="#l7.20"></a><span id="l7.20">       case nsMsgSearchAttrib::Date:</span>
<a href="#l7.21"></a><span id="l7.21">       {</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineat">@@ -670,19 +670,19 @@ nsresult nsMsgSearchOfflineMail::Process</span>
<a href="#l7.23"></a><span id="l7.23">           // Not sure if there is a better way to do this yet.  Maybe reserve the last</span>
<a href="#l7.24"></a><span id="l7.24">           // custom header for ::Content-Type?  But if we do, make sure that change</span>
<a href="#l7.25"></a><span id="l7.25">           // doesn't cause nsMsgFilter::GetTerm() to change, and start making us</span>
<a href="#l7.26"></a><span id="l7.26">           // ask IMAP servers for the Content-Type header on all messages.</span>
<a href="#l7.27"></a><span id="l7.27">           if ( attrib &gt;= nsMsgSearchAttrib::OtherHeader &amp;&amp; attrib &lt; nsMsgSearchAttrib::kNumMsgSearchAttributes)</span>
<a href="#l7.28"></a><span id="l7.28">           {</span>
<a href="#l7.29"></a><span id="l7.29">             PRUint32 lineCount;</span>
<a href="#l7.30"></a><span id="l7.30">             msgToMatch-&gt;GetLineCount(&amp;lineCount);</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">-            nsMsgKey messageKey;</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineminus">-            msgToMatch-&gt;GetMessageOffset(&amp;messageKey);</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineminus">-            err = aTerm-&gt;MatchArbitraryHeader (scope, messageKey, lineCount,charset, charsetOverride,</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineplus">+            PRUint64 messageOffset;</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineplus">+            msgToMatch-&gt;GetMessageOffset(&amp;messageOffset);</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+            err = aTerm-&gt;MatchArbitraryHeader (scope, messageOffset, lineCount,charset, charsetOverride,</span>
<a href="#l7.37"></a><span id="l7.37">                                                 msgToMatch, db, headers, headerSize, Filtering, &amp;result);</span>
<a href="#l7.38"></a><span id="l7.38">           }</span>
<a href="#l7.39"></a><span id="l7.39">           else</span>
<a href="#l7.40"></a><span id="l7.40">             err = NS_ERROR_INVALID_ARG; // ### was SearchError_InvalidAttribute</span>
<a href="#l7.41"></a><span id="l7.41">     }</span>
<a href="#l7.42"></a><span id="l7.42"> </span>
<a href="#l7.43"></a><span id="l7.43">     *pResult = result;</span>
<a href="#l7.44"></a><span id="l7.44">     return NS_OK;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgSearchTerm.cpp</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgSearchTerm.cpp</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -754,17 +754,17 @@ nsresult nsMsgSearchTerm::DeStreamNew (c</span>
<a href="#l8.4"></a><span id="l8.4">   }</span>
<a href="#l8.5"></a><span id="l8.5">   return NS_OK;</span>
<a href="#l8.6"></a><span id="l8.6"> }</span>
<a href="#l8.7"></a><span id="l8.7"> </span>
<a href="#l8.8"></a><span id="l8.8"> </span>
<a href="#l8.9"></a><span id="l8.9"> // Looks in the MessageDB for the user specified arbitrary header, if it finds the header, it then looks for a match against</span>
<a href="#l8.10"></a><span id="l8.10"> // the value for the header.</span>
<a href="#l8.11"></a><span id="l8.11"> nsresult nsMsgSearchTerm::MatchArbitraryHeader (nsIMsgSearchScopeTerm *scope,</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-                                                PRUint32 offset,</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+                                                PRUint64 offset,</span>
<a href="#l8.14"></a><span id="l8.14">                                                 PRUint32 length /* in lines*/,</span>
<a href="#l8.15"></a><span id="l8.15">                                                 const char *charset,</span>
<a href="#l8.16"></a><span id="l8.16">                                                 PRBool charsetOverride,</span>
<a href="#l8.17"></a><span id="l8.17">                                                 nsIMsgDBHdr *msg,</span>
<a href="#l8.18"></a><span id="l8.18">                                                 nsIMsgDatabase* db,</span>
<a href="#l8.19"></a><span id="l8.19">                                                 const char * headers,</span>
<a href="#l8.20"></a><span id="l8.20">                                                 PRUint32 headersSize,</span>
<a href="#l8.21"></a><span id="l8.21">                                                 PRBool ForFiltering,</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineat">@@ -907,17 +907,17 @@ NS_IMETHODIMP nsMsgSearchTerm::MatchUint</span>
<a href="#l8.23"></a><span id="l8.23">     break;</span>
<a href="#l8.24"></a><span id="l8.24">   default:</span>
<a href="#l8.25"></a><span id="l8.25">     break;</span>
<a href="#l8.26"></a><span id="l8.26">   }</span>
<a href="#l8.27"></a><span id="l8.27">   *aResult = result;</span>
<a href="#l8.28"></a><span id="l8.28">   return NS_OK;</span>
<a href="#l8.29"></a><span id="l8.29"> }</span>
<a href="#l8.30"></a><span id="l8.30"> </span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-nsresult nsMsgSearchTerm::MatchBody (nsIMsgSearchScopeTerm *scope, PRUint32 offset, PRUint32 length /*in lines*/, const char *folderCharset,</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+nsresult nsMsgSearchTerm::MatchBody (nsIMsgSearchScopeTerm *scope, PRUint64 offset, PRUint32 length /*in lines*/, const char *folderCharset,</span>
<a href="#l8.33"></a><span id="l8.33">                                       nsIMsgDBHdr *msg, nsIMsgDatabase* db, PRBool *pResult)</span>
<a href="#l8.34"></a><span id="l8.34"> {</span>
<a href="#l8.35"></a><span id="l8.35">   NS_ENSURE_ARG_POINTER(pResult);</span>
<a href="#l8.36"></a><span id="l8.36">   nsresult err = NS_OK;</span>
<a href="#l8.37"></a><span id="l8.37"> </span>
<a href="#l8.38"></a><span id="l8.38">   PRBool result = PR_FALSE;</span>
<a href="#l8.39"></a><span id="l8.39">   *pResult = PR_FALSE;</span>
<a href="#l8.40"></a><span id="l8.40"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/base/src/nsMsgFolderCompactor.cpp</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgFolderCompactor.cpp</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -1063,19 +1063,19 @@ nsFolderCompactState::StartMessage()</span>
<a href="#l9.4"></a><span id="l9.4">   if (m_fileStream)</span>
<a href="#l9.5"></a><span id="l9.5">   {</span>
<a href="#l9.6"></a><span id="l9.6">     nsCOMPtr &lt;nsISeekableStream&gt; seekableStream = do_QueryInterface(m_fileStream, &amp;rv);</span>
<a href="#l9.7"></a><span id="l9.7">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.8"></a><span id="l9.8">     // this will force an internal flush, but not a sync. Tell should really do an internal flush,</span>
<a href="#l9.9"></a><span id="l9.9">     // but it doesn't, and I'm afraid to change that nsIFileStream.cpp code anymore.</span>
<a href="#l9.10"></a><span id="l9.10">     seekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_CUR, 0);</span>
<a href="#l9.11"></a><span id="l9.11">     // record the new message key for the message</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-    PRInt64 filePos;</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">-    seekableStream-&gt;Tell(&amp;filePos);</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineminus">-    m_startOfNewMsg = (PRUint32) filePos;</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+    PRInt64 curStreamPos;</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+    seekableStream-&gt;Tell(&amp;curStreamPos);</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+    m_startOfNewMsg = curStreamPos;</span>
<a href="#l9.18"></a><span id="l9.18">     rv = NS_OK;</span>
<a href="#l9.19"></a><span id="l9.19">   }</span>
<a href="#l9.20"></a><span id="l9.20">   return rv;</span>
<a href="#l9.21"></a><span id="l9.21"> }</span>
<a href="#l9.22"></a><span id="l9.22"> </span>
<a href="#l9.23"></a><span id="l9.23"> NS_IMETHODIMP</span>
<a href="#l9.24"></a><span id="l9.24"> nsFolderCompactState::EndMessage(nsMsgKey key)</span>
<a href="#l9.25"></a><span id="l9.25"> {</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineat">@@ -1089,20 +1089,25 @@ nsFolderCompactState::EndCopy(nsISupport</span>
<a href="#l9.27"></a><span id="l9.27">   nsCOMPtr&lt;nsIMsgDBHdr&gt; newMsgHdr;</span>
<a href="#l9.28"></a><span id="l9.28"> </span>
<a href="#l9.29"></a><span id="l9.29">   if (m_curIndex &gt;= m_size)</span>
<a href="#l9.30"></a><span id="l9.30">   {</span>
<a href="#l9.31"></a><span id="l9.31">     NS_ASSERTION(PR_FALSE, &quot;m_curIndex out of bounds&quot;);</span>
<a href="#l9.32"></a><span id="l9.32">     return NS_OK;</span>
<a href="#l9.33"></a><span id="l9.33">   }</span>
<a href="#l9.34"></a><span id="l9.34"> </span>
<a href="#l9.35"></a><span id="l9.35" class="difflineminus">-    // okay done with the current message; copying the existing message header</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineminus">-    // to the new database</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineplus">+  /**</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineplus">+   * Done with the current message; copying the existing message header</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineplus">+   * to the new database.</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineplus">+   * XXX This will need to be changed when we support local mail folders</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineplus">+   * &gt; 4GB. We'll need to set the messageOffset attribute on the new header,</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineplus">+   * and assign the nsMsgKey some other way.</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineplus">+   */</span>
<a href="#l9.44"></a><span id="l9.44">   if (m_curSrcHdr)</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineminus">-    m_db-&gt;CopyHdrFromExistingHdr(m_startOfNewMsg, m_curSrcHdr, PR_TRUE,</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineplus">+    m_db-&gt;CopyHdrFromExistingHdr((nsMsgKey) m_startOfNewMsg, m_curSrcHdr, PR_TRUE,</span>
<a href="#l9.47"></a><span id="l9.47">                                getter_AddRefs(newMsgHdr));</span>
<a href="#l9.48"></a><span id="l9.48">   m_curSrcHdr = nsnull;</span>
<a href="#l9.49"></a><span id="l9.49">   if (newMsgHdr)</span>
<a href="#l9.50"></a><span id="l9.50">   {</span>
<a href="#l9.51"></a><span id="l9.51">     if ( m_statusOffset != 0)</span>
<a href="#l9.52"></a><span id="l9.52">       newMsgHdr-&gt;SetStatusOffset(m_statusOffset);</span>
<a href="#l9.53"></a><span id="l9.53">       </span>
<a href="#l9.54"></a><span id="l9.54">     PRUint32 msgSize;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/base/src/nsMsgFolderCompactor.h</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgFolderCompactor.h</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -90,17 +90,17 @@ protected:</span>
<a href="#l10.4"></a><span id="l10.4">   nsCOMPtr &lt;nsIOutputStream&gt; m_fileStream; // output file stream for writing</span>
<a href="#l10.5"></a><span id="l10.5">   nsTArray&lt;nsMsgKey&gt; m_keyArray; // all message keys need to be copied over</span>
<a href="#l10.6"></a><span id="l10.6">   PRInt32 m_size; // size of the message key array</span>
<a href="#l10.7"></a><span id="l10.7"> </span>
<a href="#l10.8"></a><span id="l10.8">    // sum of the sizes of the messages, accumulated as we visit each msg.</span>
<a href="#l10.9"></a><span id="l10.9">   PRUint32 m_totalMsgSize;</span>
<a href="#l10.10"></a><span id="l10.10"> </span>
<a href="#l10.11"></a><span id="l10.11">   PRInt32 m_curIndex; // index of the current copied message key in key array</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-  nsMsgKey m_startOfNewMsg; // offset in mailbox of new message</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+  PRUint64 m_startOfNewMsg; // offset in mailbox of new message</span>
<a href="#l10.14"></a><span id="l10.14">   char m_dataBuffer[COMPACTOR_READ_BUFF_SIZE + 1]; // temp data buffer for copying message</span>
<a href="#l10.15"></a><span id="l10.15">   nsresult m_status; // the status of the copying operation</span>
<a href="#l10.16"></a><span id="l10.16">   nsCOMPtr &lt;nsIMsgMessageService&gt; m_messageService; // message service for copying </span>
<a href="#l10.17"></a><span id="l10.17">   nsCOMPtr&lt;nsIArray&gt; m_folderArray; // folders we are compacting, if compacting multiple.</span>
<a href="#l10.18"></a><span id="l10.18">   nsCOMPtr &lt;nsIMsgWindow&gt; m_window;</span>
<a href="#l10.19"></a><span id="l10.19">   nsCOMPtr &lt;nsIMsgDBHdr&gt; m_curSrcHdr;</span>
<a href="#l10.20"></a><span id="l10.20">   PRUint32 m_folderIndex; // tells which folder to compact in case of compact all</span>
<a href="#l10.21"></a><span id="l10.21">   PRBool m_compactAll;  //flag for compact all</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/base/util/nsMsgDBFolder.cpp</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgDBFolder.cpp</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -770,34 +770,34 @@ NS_IMETHODIMP nsMsgDBFolder::GetOfflineS</span>
<a href="#l11.4"></a><span id="l11.4">   return NS_NewLocalFileInputStream(stream, localStore);</span>
<a href="#l11.5"></a><span id="l11.5"> }</span>
<a href="#l11.6"></a><span id="l11.6"> </span>
<a href="#l11.7"></a><span id="l11.7"> PRBool nsMsgDBFolder::VerifyOfflineMessage(nsIMsgDBHdr *msgHdr, nsIInputStream *fileStream)</span>
<a href="#l11.8"></a><span id="l11.8"> {</span>
<a href="#l11.9"></a><span id="l11.9">   nsCOMPtr &lt;nsISeekableStream&gt; seekableStream = do_QueryInterface(fileStream);</span>
<a href="#l11.10"></a><span id="l11.10">   if (seekableStream)</span>
<a href="#l11.11"></a><span id="l11.11">   {</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-    PRUint32 offset;</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+    PRUint64 offset;</span>
<a href="#l11.14"></a><span id="l11.14">     msgHdr-&gt;GetMessageOffset(&amp;offset);</span>
<a href="#l11.15"></a><span id="l11.15">     nsresult rv = seekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_CUR, offset);</span>
<a href="#l11.16"></a><span id="l11.16">     char startOfMsg[100];</span>
<a href="#l11.17"></a><span id="l11.17">     PRUint32 bytesRead = 0;</span>
<a href="#l11.18"></a><span id="l11.18">     PRUint32 bytesToRead = sizeof(startOfMsg) - 1;</span>
<a href="#l11.19"></a><span id="l11.19">     if (NS_SUCCEEDED(rv))</span>
<a href="#l11.20"></a><span id="l11.20">       rv = fileStream-&gt;Read(startOfMsg, bytesToRead, &amp;bytesRead);</span>
<a href="#l11.21"></a><span id="l11.21">     startOfMsg[bytesRead] = '\0';</span>
<a href="#l11.22"></a><span id="l11.22">     // check if message starts with From, or is a draft and starts with FCC</span>
<a href="#l11.23"></a><span id="l11.23">     if (NS_FAILED(rv) || bytesRead != bytesToRead ||</span>
<a href="#l11.24"></a><span id="l11.24">       (strncmp(startOfMsg, &quot;From &quot;, 5) &amp;&amp; (! (mFlags &amp; nsMsgFolderFlags::Drafts) || strncmp(startOfMsg, &quot;FCC&quot;, 3))))</span>
<a href="#l11.25"></a><span id="l11.25">       return PR_FALSE;</span>
<a href="#l11.26"></a><span id="l11.26">   }</span>
<a href="#l11.27"></a><span id="l11.27">   return PR_TRUE;</span>
<a href="#l11.28"></a><span id="l11.28"> }</span>
<a href="#l11.29"></a><span id="l11.29"> </span>
<a href="#l11.30"></a><span id="l11.30" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::GetOfflineFileStream(nsMsgKey msgKey, PRUint32 *offset, PRUint32 *size, nsIInputStream **aFileStream)</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::GetOfflineFileStream(nsMsgKey msgKey, PRUint64 *offset, PRUint32 *size, nsIInputStream **aFileStream)</span>
<a href="#l11.32"></a><span id="l11.32"> {</span>
<a href="#l11.33"></a><span id="l11.33">   NS_ENSURE_ARG(aFileStream);</span>
<a href="#l11.34"></a><span id="l11.34"> </span>
<a href="#l11.35"></a><span id="l11.35">   *offset = *size = 0;</span>
<a href="#l11.36"></a><span id="l11.36"> </span>
<a href="#l11.37"></a><span id="l11.37">   nsCOMPtr &lt;nsILocalFile&gt; localStore;</span>
<a href="#l11.38"></a><span id="l11.38">   nsresult rv = GetFilePath(getter_AddRefs(localStore));</span>
<a href="#l11.39"></a><span id="l11.39">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineat">@@ -1586,37 +1586,32 @@ nsresult nsMsgDBFolder::WriteStartOfNewL</span>
<a href="#l11.41"></a><span id="l11.41">   ct = ctime(&amp;now);</span>
<a href="#l11.42"></a><span id="l11.42">   ct[24] = 0;</span>
<a href="#l11.43"></a><span id="l11.43">   result = &quot;From - &quot;;</span>
<a href="#l11.44"></a><span id="l11.44">   result += ct;</span>
<a href="#l11.45"></a><span id="l11.45">   result += MSG_LINEBREAK;</span>
<a href="#l11.46"></a><span id="l11.46">   m_bytesAddedToLocalMsg = result.Length();</span>
<a href="#l11.47"></a><span id="l11.47"> </span>
<a href="#l11.48"></a><span id="l11.48">   nsCOMPtr &lt;nsISeekableStream&gt; seekable;</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineminus">-  nsInt64 curStorePos;</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineplus">+  PRInt64 curStorePos;</span>
<a href="#l11.51"></a><span id="l11.51"> </span>
<a href="#l11.52"></a><span id="l11.52">   if (m_offlineHeader)</span>
<a href="#l11.53"></a><span id="l11.53">     seekable = do_QueryInterface(m_tempMessageStream);</span>
<a href="#l11.54"></a><span id="l11.54"> </span>
<a href="#l11.55"></a><span id="l11.55">   if (seekable)</span>
<a href="#l11.56"></a><span id="l11.56">   {</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineminus">-    PRInt64 tellPos;</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineminus">-    seekable-&gt;Tell(&amp;tellPos);</span>
<a href="#l11.59"></a><span id="l11.59" class="difflineminus">-    curStorePos = tellPos;</span>
<a href="#l11.60"></a><span id="l11.60" class="difflineminus">-    // ### todo - need to convert this to 64 bits</span>
<a href="#l11.61"></a><span id="l11.61" class="difflineminus">-    m_offlineHeader-&gt;SetMessageOffset((PRUint32) curStorePos);</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineplus">+    seekable-&gt;Tell(&amp;curStorePos);</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineplus">+    m_offlineHeader-&gt;SetMessageOffset(curStorePos);</span>
<a href="#l11.64"></a><span id="l11.64">   }</span>
<a href="#l11.65"></a><span id="l11.65">   m_tempMessageStream-&gt;Write(result.get(), result.Length(),</span>
<a href="#l11.66"></a><span id="l11.66">                              &amp;writeCount);</span>
<a href="#l11.67"></a><span id="l11.67">   if (seekable)</span>
<a href="#l11.68"></a><span id="l11.68">   {</span>
<a href="#l11.69"></a><span id="l11.69" class="difflineminus">-    PRInt64 tellPos;</span>
<a href="#l11.70"></a><span id="l11.70">     seekable-&gt;Seek(PR_SEEK_CUR, 0); // seeking causes a flush, w/o syncing</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineminus">-    seekable-&gt;Tell(&amp;tellPos);</span>
<a href="#l11.72"></a><span id="l11.72" class="difflineminus">-    curStorePos = tellPos;</span>
<a href="#l11.73"></a><span id="l11.73" class="difflineplus">+    seekable-&gt;Tell(&amp;curStorePos);</span>
<a href="#l11.74"></a><span id="l11.74">     m_offlineHeader-&gt;SetStatusOffset((PRUint32) curStorePos);</span>
<a href="#l11.75"></a><span id="l11.75">   }</span>
<a href="#l11.76"></a><span id="l11.76"> </span>
<a href="#l11.77"></a><span id="l11.77">   NS_NAMED_LITERAL_CSTRING(MozillaStatus, &quot;X-Mozilla-Status: 0001&quot; MSG_LINEBREAK);</span>
<a href="#l11.78"></a><span id="l11.78">   m_tempMessageStream-&gt;Write(MozillaStatus.get(), MozillaStatus.Length(),</span>
<a href="#l11.79"></a><span id="l11.79">                              &amp;writeCount);</span>
<a href="#l11.80"></a><span id="l11.80">   m_bytesAddedToLocalMsg += writeCount;</span>
<a href="#l11.81"></a><span id="l11.81">   NS_NAMED_LITERAL_CSTRING(MozillaStatus2, &quot;X-Mozilla-Status2: 00000000&quot; MSG_LINEBREAK);</span>
<a href="#l11.82"></a><span id="l11.82" class="difflineat">@@ -1641,18 +1636,18 @@ nsresult nsMsgDBFolder::StartNewOfflineM</span>
<a href="#l11.83"></a><span id="l11.83">     WriteStartOfNewLocalMessage();</span>
<a href="#l11.84"></a><span id="l11.84">   m_numOfflineMsgLines = 0;</span>
<a href="#l11.85"></a><span id="l11.85">   return rv;</span>
<a href="#l11.86"></a><span id="l11.86"> }</span>
<a href="#l11.87"></a><span id="l11.87"> </span>
<a href="#l11.88"></a><span id="l11.88"> nsresult nsMsgDBFolder::EndNewOfflineMessage()</span>
<a href="#l11.89"></a><span id="l11.89"> {</span>
<a href="#l11.90"></a><span id="l11.90">   nsCOMPtr &lt;nsISeekableStream&gt; seekable;</span>
<a href="#l11.91"></a><span id="l11.91" class="difflineminus">-  nsInt64 curStorePos;</span>
<a href="#l11.92"></a><span id="l11.92" class="difflineminus">-  PRUint32 messageOffset;</span>
<a href="#l11.93"></a><span id="l11.93" class="difflineplus">+  PRInt64 curStorePos;</span>
<a href="#l11.94"></a><span id="l11.94" class="difflineplus">+  PRUint64 messageOffset;</span>
<a href="#l11.95"></a><span id="l11.95">   PRUint32 messageSize;</span>
<a href="#l11.96"></a><span id="l11.96"> </span>
<a href="#l11.97"></a><span id="l11.97">   nsMsgKey messageKey;</span>
<a href="#l11.98"></a><span id="l11.98"> </span>
<a href="#l11.99"></a><span id="l11.99">   nsresult rv = GetDatabase();</span>
<a href="#l11.100"></a><span id="l11.100">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.101"></a><span id="l11.101"> </span>
<a href="#l11.102"></a><span id="l11.102">   m_offlineHeader-&gt;GetMessageKey(&amp;messageKey);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/base/util/nsMsgProtocol.cpp</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgProtocol.cpp</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -515,17 +515,17 @@ nsresult nsMsgProtocol::LoadUrl(nsIURI *</span>
<a href="#l12.4"></a><span id="l12.4">         {</span>
<a href="#l12.5"></a><span id="l12.5">           // open buffered, asynchronous input stream</span>
<a href="#l12.6"></a><span id="l12.6">           rv = m_transport-&gt;OpenInputStream(0, 0, 0, getter_AddRefs(m_inputStream));</span>
<a href="#l12.7"></a><span id="l12.7">           if (NS_FAILED(rv)) return rv;</span>
<a href="#l12.8"></a><span id="l12.8">         }</span>
<a href="#l12.9"></a><span id="l12.9"> </span>
<a href="#l12.10"></a><span id="l12.10">         nsCOMPtr&lt;nsIInputStreamPump&gt; pump;</span>
<a href="#l12.11"></a><span id="l12.11">         rv = NS_NewInputStreamPump(getter_AddRefs(pump),</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-          m_inputStream, nsInt64(-1), m_readCount);</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+          m_inputStream, -1, m_readCount);</span>
<a href="#l12.14"></a><span id="l12.14">         if (NS_FAILED(rv)) return rv;</span>
<a href="#l12.15"></a><span id="l12.15"> </span>
<a href="#l12.16"></a><span id="l12.16">         m_request = pump; // keep a reference to the pump so we can cancel it</span>
<a href="#l12.17"></a><span id="l12.17"> </span>
<a href="#l12.18"></a><span id="l12.18">         // put us in a state where we are always notified of incoming data</span>
<a href="#l12.19"></a><span id="l12.19">         rv = pump-&gt;AsyncRead(this, urlSupports);</span>
<a href="#l12.20"></a><span id="l12.20">         NS_ASSERTION(NS_SUCCEEDED(rv), &quot;AsyncRead failed&quot;);</span>
<a href="#l12.21"></a><span id="l12.21">         m_socketIsOpen = PR_TRUE; // mark the channel as open</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/db/msgdb/public/nsIMsgDatabase.idl</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/db/msgdb/public/nsIMsgDatabase.idl</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -132,17 +132,17 @@ interface nsMsgDBCommitType</span>
<a href="#l13.4"></a><span id="l13.4"> [ptr] native nsMsgKeyArrayPtr(nsTArray&lt;nsMsgKey&gt;);</span>
<a href="#l13.5"></a><span id="l13.5"> </span>
<a href="#l13.6"></a><span id="l13.6"> /**</span>
<a href="#l13.7"></a><span id="l13.7">  * A service to open mail databases and manipulate listeners automatically.</span>
<a href="#l13.8"></a><span id="l13.8">  *</span>
<a href="#l13.9"></a><span id="l13.9">  * The contract ID for this component is</span>
<a href="#l13.10"></a><span id="l13.10">  * &lt;tt&gt;\@mozilla.org/msgDatabase/msgDBService;1&lt;/tt&gt;.</span>
<a href="#l13.11"></a><span id="l13.11">  */</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-[scriptable, uuid(959d0a27-9a00-4ce8-b01d-180ff2387b6a)]</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+[scriptable, uuid(e25d07fc-2a85-437f-9227-065c88a0b29f)]</span>
<a href="#l13.14"></a><span id="l13.14"> interface nsIMsgDBService : nsISupports</span>
<a href="#l13.15"></a><span id="l13.15"> {</span>
<a href="#l13.16"></a><span id="l13.16">   /**</span>
<a href="#l13.17"></a><span id="l13.17">    * Opens a database for a given folder.</span>
<a href="#l13.18"></a><span id="l13.18">    *</span>
<a href="#l13.19"></a><span id="l13.19">    * This method is preferred over nsIMsgDBService::openMailDBFromFile if the</span>
<a href="#l13.20"></a><span id="l13.20">    * caller has an actual nsIMsgFolder around. If the database detects that it</span>
<a href="#l13.21"></a><span id="l13.21">    * is unreadable or out of date (using nsIMsgDatabase::outOfDate) it will</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineat">@@ -475,16 +475,33 @@ interface nsIMsgDatabase : nsIDBChangeAn</span>
<a href="#l13.23"></a><span id="l13.23">   [noscript] void ListAllOfflineMsgs(in nsMsgKeyArrayPtr offlineMsgs);</span>
<a href="#l13.24"></a><span id="l13.24"> </span>
<a href="#l13.25"></a><span id="l13.25">   void setAttributeOnPendingHdr(in nsIMsgDBHdr pendingHdr, in string property,</span>
<a href="#l13.26"></a><span id="l13.26">                                   in string propertyVal);</span>
<a href="#l13.27"></a><span id="l13.27"> </span>
<a href="#l13.28"></a><span id="l13.28">   void setUint32AttributeOnPendingHdr(in nsIMsgDBHdr pendingHdr, in string property,</span>
<a href="#l13.29"></a><span id="l13.29">                                   in unsigned long propertyVal);</span>
<a href="#l13.30"></a><span id="l13.30"> </span>
<a href="#l13.31"></a><span id="l13.31" class="difflineplus">+  /**</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineplus">+   * Sets a pending 64 bit attribute, which tells the DB that when a message</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineplus">+   * which looks like the pendingHdr (e.g., same message-id) is added to the</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineplus">+   * db, set the passed in property and value on the new header. This is</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineplus">+   * usually because we've copied an imap message to a different folder, and</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineplus">+   * want to carry forward attributes from the original message to the copy,</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineplus">+   * but don't have the message hdr for the copy yet so we can't set</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineplus">+   * attributes directly.</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineplus">+   *</span>
<a href="#l13.40"></a><span id="l13.40" class="difflineplus">+   * @param aPendingHdr usually the source of the copy.</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineplus">+   * @param aProperty name of property to set.</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineplus">+   * @param aPropertyVal 64 bit value of property to set.</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineplus">+   */</span>
<a href="#l13.44"></a><span id="l13.44" class="difflineplus">+  void setUint64AttributeOnPendingHdr(in nsIMsgDBHdr aPendingHdr,</span>
<a href="#l13.45"></a><span id="l13.45" class="difflineplus">+                                      in string aProperty,</span>
<a href="#l13.46"></a><span id="l13.46" class="difflineplus">+                                      in unsigned long long aPropertyVal);</span>
<a href="#l13.47"></a><span id="l13.47" class="difflineplus">+</span>
<a href="#l13.48"></a><span id="l13.48">   readonly attribute nsMsgKey lowWaterArticleNum;</span>
<a href="#l13.49"></a><span id="l13.49">   readonly attribute nsMsgKey highWaterArticleNum;</span>
<a href="#l13.50"></a><span id="l13.50">   attribute nsMsgKey nextPseudoMsgKey;   //for undo-redo of move pop-&gt;imap</span>
<a href="#l13.51"></a><span id="l13.51">   readonly attribute nsMsgKey nextFakeOfflineMsgKey; // for saving &quot;fake&quot; offline msg hdrs</span>
<a href="#l13.52"></a><span id="l13.52">   // for sorting</span>
<a href="#l13.53"></a><span id="l13.53">   [noscript] void createCollationKey(in AString sourceString, out octetPtr key, out unsigned long len);</span>
<a href="#l13.54"></a><span id="l13.54">   [noscript] long compareCollationKeys(in octetPtr key1, in unsigned long len1, in octetPtr key2, in unsigned long len2);</span>
<a href="#l13.55"></a><span id="l13.55"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/db/msgdb/public/nsImapMailDatabase.h</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/db/msgdb/public/nsImapMailDatabase.h</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -57,16 +57,19 @@ public:</span>
<a href="#l14.4"></a><span id="l14.4">   NS_IMETHOD    ForceClosed();</span>
<a href="#l14.5"></a><span id="l14.5">   NS_IMETHOD    SetFolderStream(nsIOutputStream *aFileStream);</span>
<a href="#l14.6"></a><span id="l14.6">   NS_IMETHOD    GetFolderStream(nsIOutputStream **aFileStream);</span>
<a href="#l14.7"></a><span id="l14.7">   NS_IMETHOD    AddNewHdrToDB(nsIMsgDBHdr *newHdr, PRBool notify);</span>
<a href="#l14.8"></a><span id="l14.8">   NS_IMETHOD    SetAttributeOnPendingHdr(nsIMsgDBHdr *pendingHdr, const char *property,</span>
<a href="#l14.9"></a><span id="l14.9">                                   const char *propertyVal);</span>
<a href="#l14.10"></a><span id="l14.10">   NS_IMETHOD    SetUint32AttributeOnPendingHdr(nsIMsgDBHdr *pendingHdr, const char *property,</span>
<a href="#l14.11"></a><span id="l14.11">                                   PRUint32 propertyVal);</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineplus">+  NS_IMETHOD    SetUint64AttributeOnPendingHdr(nsIMsgDBHdr *aPendingHdr,</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+                                               const char *aProperty,</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+                                               PRUint64 aPropertyVal);</span>
<a href="#l14.15"></a><span id="l14.15">   NS_IMETHOD    DeleteMessages(PRUint32 aNumKeys, nsMsgKey* nsMsgKeys,</span>
<a href="#l14.16"></a><span id="l14.16">                                nsIDBChangeListener *instigator);</span>
<a href="#l14.17"></a><span id="l14.17"> </span>
<a href="#l14.18"></a><span id="l14.18"> protected:</span>
<a href="#l14.19"></a><span id="l14.19">   // IMAP does not set local file flags, override does nothing</span>
<a href="#l14.20"></a><span id="l14.20">   virtual void UpdateFolderFlag(nsIMsgDBHdr *msgHdr, PRBool bSet,</span>
<a href="#l14.21"></a><span id="l14.21">                                 nsMsgMessageFlagType flag, nsIOutputStream **ppFileStream);</span>
<a href="#l14.22"></a><span id="l14.22">   virtual PRBool SetHdrFlag(nsIMsgDBHdr *msgHdr, PRBool bSet, nsMsgMessageFlagType flag);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/db/msgdb/public/nsMsgDatabase.h</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/db/msgdb/public/nsMsgDatabase.h</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -170,49 +170,53 @@ public:</span>
<a href="#l15.4"></a><span id="l15.4"> </span>
<a href="#l15.5"></a><span id="l15.5">   static nsMsgDatabase* FindInCache(nsILocalFile *dbName);</span>
<a href="#l15.6"></a><span id="l15.6">   static nsIMsgDatabase* FindInCache(nsIMsgFolder *folder);</span>
<a href="#l15.7"></a><span id="l15.7"> </span>
<a href="#l15.8"></a><span id="l15.8">   //helper function to fill in nsStrings from hdr row cell contents.</span>
<a href="#l15.9"></a><span id="l15.9">   nsresult RowCellColumnTonsString(nsIMdbRow *row, mdb_token columnToken, nsAString &amp;resultStr);</span>
<a href="#l15.10"></a><span id="l15.10">   nsresult RowCellColumnToUInt32(nsIMdbRow *row, mdb_token columnToken, PRUint32 *uint32Result, PRUint32 defaultValue = 0);</span>
<a href="#l15.11"></a><span id="l15.11">   nsresult RowCellColumnToUInt32(nsIMdbRow *row, mdb_token columnToken, PRUint32 &amp;uint32Result, PRUint32 defaultValue = 0);</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineplus">+  nsresult RowCellColumnToUInt64(nsIMdbRow *row, mdb_token columnToken, PRUint64 *uint64Result, PRUint64 defaultValue = 0);</span>
<a href="#l15.13"></a><span id="l15.13">   nsresult RowCellColumnToMime2DecodedString(nsIMdbRow *row, mdb_token columnToken, nsAString &amp;resultStr);</span>
<a href="#l15.14"></a><span id="l15.14">   nsresult RowCellColumnToCollationKey(nsIMdbRow *row, mdb_token columnToken, PRUint8 **result, PRUint32 *len);</span>
<a href="#l15.15"></a><span id="l15.15">   nsresult RowCellColumnToConstCharPtr(nsIMdbRow *row, mdb_token columnToken, const char **ptr);</span>
<a href="#l15.16"></a><span id="l15.16">   nsresult RowCellColumnToAddressCollationKey(nsIMdbRow *row, mdb_token colToken, PRUint8 **result, PRUint32 *len);</span>
<a href="#l15.17"></a><span id="l15.17"> </span>
<a href="#l15.18"></a><span id="l15.18">   // these methods take the property name as a string, not a token.</span>
<a href="#l15.19"></a><span id="l15.19">   // they should be used when the properties aren't accessed a lot</span>
<a href="#l15.20"></a><span id="l15.20">   nsresult        GetProperty(nsIMdbRow *row, const char *propertyName, char **result);</span>
<a href="#l15.21"></a><span id="l15.21">   nsresult        SetProperty(nsIMdbRow *row, const char *propertyName, const char *propertyVal);</span>
<a href="#l15.22"></a><span id="l15.22">   nsresult        GetPropertyAsNSString(nsIMdbRow *row, const char *propertyName, nsAString &amp;result);</span>
<a href="#l15.23"></a><span id="l15.23">   nsresult        SetPropertyFromNSString(nsIMdbRow *row, const char *propertyName, const nsAString &amp;propertyVal);</span>
<a href="#l15.24"></a><span id="l15.24">   nsresult        GetUint32Property(nsIMdbRow *row, const char *propertyName, PRUint32 *result, PRUint32 defaultValue = 0);</span>
<a href="#l15.25"></a><span id="l15.25">   nsresult        SetUint32Property(nsIMdbRow *row, const char *propertyName, PRUint32 propertyVal);</span>
<a href="#l15.26"></a><span id="l15.26" class="difflineplus">+  nsresult        SetUint64Property(nsIMdbRow *row, const char *propertyName, PRUint64 propertyVal);</span>
<a href="#l15.27"></a><span id="l15.27">   nsresult        GetBooleanProperty(nsIMdbRow *row, const char *propertyName, </span>
<a href="#l15.28"></a><span id="l15.28">                                      PRBool *result, PRBool defaultValue = PR_FALSE);</span>
<a href="#l15.29"></a><span id="l15.29">   nsresult        SetBooleanProperty(nsIMdbRow *row, const char *propertyName, </span>
<a href="#l15.30"></a><span id="l15.30">                                     PRBool propertyVal);</span>
<a href="#l15.31"></a><span id="l15.31">   // helper function for once we have the token.</span>
<a href="#l15.32"></a><span id="l15.32">   nsresult        SetNSStringPropertyWithToken(nsIMdbRow *row, mdb_token aProperty, const nsAString &amp;propertyStr);</span>
<a href="#l15.33"></a><span id="l15.33">   </span>
<a href="#l15.34"></a><span id="l15.34">   // helper functions to put values in cells for the passed-in row</span>
<a href="#l15.35"></a><span id="l15.35">   nsresult        UInt32ToRowCellColumn(nsIMdbRow *row, mdb_token columnToken, PRUint32 value);</span>
<a href="#l15.36"></a><span id="l15.36">   nsresult        CharPtrToRowCellColumn(nsIMdbRow *row, mdb_token columnToken, const char *charPtr);</span>
<a href="#l15.37"></a><span id="l15.37">   nsresult        RowCellColumnToCharPtr(nsIMdbRow *row, mdb_token columnToken, char **result);</span>
<a href="#l15.38"></a><span id="l15.38" class="difflineminus">-  </span>
<a href="#l15.39"></a><span id="l15.39" class="difflineminus">-  </span>
<a href="#l15.40"></a><span id="l15.40" class="difflineplus">+  nsresult        UInt64ToRowCellColumn(nsIMdbRow *row, mdb_token columnToken, PRUint64 value);</span>
<a href="#l15.41"></a><span id="l15.41" class="difflineplus">+</span>
<a href="#l15.42"></a><span id="l15.42">   // helper functions to copy an nsString to a yarn, int32 to yarn, and vice versa.</span>
<a href="#l15.43"></a><span id="l15.43">   static struct mdbYarn *nsStringToYarn(struct mdbYarn *yarn, const nsAString &amp;str);</span>
<a href="#l15.44"></a><span id="l15.44">   static struct mdbYarn *UInt32ToYarn(struct mdbYarn *yarn, PRUint32 i);</span>
<a href="#l15.45"></a><span id="l15.45" class="difflineplus">+  static struct mdbYarn *UInt64ToYarn(struct mdbYarn *yarn, PRUint64 i);</span>
<a href="#l15.46"></a><span id="l15.46">   static void YarnTonsString(struct mdbYarn *yarn, nsAString &amp;str);</span>
<a href="#l15.47"></a><span id="l15.47">   static void YarnTonsCString(struct mdbYarn *yarn, nsACString &amp;str);</span>
<a href="#l15.48"></a><span id="l15.48">   static void YarnToUInt32(struct mdbYarn *yarn, PRUint32 *i);</span>
<a href="#l15.49"></a><span id="l15.49" class="difflineminus">-  </span>
<a href="#l15.50"></a><span id="l15.50" class="difflineplus">+  static void YarnToUInt64(struct mdbYarn *yarn, PRUint64 *i);</span>
<a href="#l15.51"></a><span id="l15.51" class="difflineplus">+</span>
<a href="#l15.52"></a><span id="l15.52">   static void   CleanupCache();</span>
<a href="#l15.53"></a><span id="l15.53">   static void   DumpCache();</span>
<a href="#l15.54"></a><span id="l15.54"> #ifdef DEBUG</span>
<a href="#l15.55"></a><span id="l15.55">   virtual nsresult DumpContents();</span>
<a href="#l15.56"></a><span id="l15.56">   nsresult DumpThread(nsMsgKey threadId);</span>
<a href="#l15.57"></a><span id="l15.57">   nsresult DumpMsgChildren(nsIMsgDBHdr *msgHdr);</span>
<a href="#l15.58"></a><span id="l15.58"> #endif</span>
<a href="#l15.59"></a><span id="l15.59">   </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/db/msgdb/public/nsMsgHdr.h</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/db/msgdb/public/nsMsgHdr.h</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -67,20 +67,22 @@ public:</span>
<a href="#l16.4"></a><span id="l16.4">     NS_DECL_ISUPPORTS</span>
<a href="#l16.5"></a><span id="l16.5"> </span>
<a href="#l16.6"></a><span id="l16.6">     nsIMdbRow   *GetMDBRow() {return m_mdbRow;}</span>
<a href="#l16.7"></a><span id="l16.7">     PRBool      IsParentOf(nsIMsgDBHdr *possibleChild);</span>
<a href="#l16.8"></a><span id="l16.8">     PRBool      IsAncestorOf(nsIMsgDBHdr *possibleChild);</span>
<a href="#l16.9"></a><span id="l16.9">     PRBool      IsAncestorKilled(PRUint32 ancestorsToCheck);</span>
<a href="#l16.10"></a><span id="l16.10">     void        ReparentInThread(nsIMsgThread *thread);</span>
<a href="#l16.11"></a><span id="l16.11"> protected:</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-    nsresult	SetStringColumn(const char *str, mdb_token token);</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineminus">-    nsresult	SetUInt32Column(PRUint32 value, mdb_token token);</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineminus">-    nsresult	GetUInt32Column(mdb_token token, PRUint32 *pvalue, PRUint32 defaultValue = 0);</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineminus">-    nsresult    BuildRecipientsFromArray(const char *names, const char *addresses, PRUint32 numAddresses, nsCAutoString&amp; allRecipients);</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineplus">+    nsresult SetStringColumn(const char *str, mdb_token token);</span>
<a href="#l16.17"></a><span id="l16.17" class="difflineplus">+    nsresult SetUInt32Column(PRUint32 value, mdb_token token);</span>
<a href="#l16.18"></a><span id="l16.18" class="difflineplus">+    nsresult GetUInt32Column(mdb_token token, PRUint32 *pvalue, PRUint32 defaultValue = 0);</span>
<a href="#l16.19"></a><span id="l16.19" class="difflineplus">+    nsresult SetUInt64Column(PRUint64 value, mdb_token token);</span>
<a href="#l16.20"></a><span id="l16.20" class="difflineplus">+    nsresult GetUInt64Column(mdb_token token, PRUint64 *pvalue, PRUint64 defaultValue = 0);</span>
<a href="#l16.21"></a><span id="l16.21" class="difflineplus">+    nsresult BuildRecipientsFromArray(const char *names, const char *addresses, PRUint32 numAddresses, nsCAutoString&amp; allRecipients);</span>
<a href="#l16.22"></a><span id="l16.22"> </span>
<a href="#l16.23"></a><span id="l16.23">     // reference and threading stuff.</span>
<a href="#l16.24"></a><span id="l16.24">     nsresult	ParseReferences(const char *references);</span>
<a href="#l16.25"></a><span id="l16.25">     const char* GetNextReference(const char *startNextRef, nsCString &amp;reference,</span>
<a href="#l16.26"></a><span id="l16.26">                                  PRBool acceptNonDelimitedReferences);</span>
<a href="#l16.27"></a><span id="l16.27"> </span>
<a href="#l16.28"></a><span id="l16.28">     nsMsgKey	m_threadId; </span>
<a href="#l16.29"></a><span id="l16.29">     nsMsgKey	m_messageKey; 	//news: article number, mail mbox offset, imap uid...</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/db/msgdb/src/nsImapMailDatabase.cpp</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/db/msgdb/src/nsImapMailDatabase.cpp</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -276,8 +276,20 @@ nsImapMailDatabase::SetUint32AttributeOn</span>
<a href="#l17.4"></a><span id="l17.4">                                                    PRUint32 propertyVal)</span>
<a href="#l17.5"></a><span id="l17.5"> {</span>
<a href="#l17.6"></a><span id="l17.6">   NS_ENSURE_ARG_POINTER(pendingHdr);</span>
<a href="#l17.7"></a><span id="l17.7">   nsCOMPtr&lt;nsIMdbRow&gt; pendingRow;</span>
<a href="#l17.8"></a><span id="l17.8">   nsresult rv = GetRowForPendingHdr(pendingHdr, getter_AddRefs(pendingRow));</span>
<a href="#l17.9"></a><span id="l17.9">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.10"></a><span id="l17.10">   return SetUint32Property(pendingRow, property, propertyVal);</span>
<a href="#l17.11"></a><span id="l17.11"> }</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineplus">+</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineplus">+nsImapMailDatabase::SetUint64AttributeOnPendingHdr(nsIMsgDBHdr *aPendingHdr,</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineplus">+                                                   const char *aProperty,</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineplus">+                                                   PRUint64 aPropertyVal)</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineplus">+{</span>
<a href="#l17.18"></a><span id="l17.18" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aPendingHdr);</span>
<a href="#l17.19"></a><span id="l17.19" class="difflineplus">+  nsCOMPtr&lt;nsIMdbRow&gt; pendingRow;</span>
<a href="#l17.20"></a><span id="l17.20" class="difflineplus">+  nsresult rv = GetRowForPendingHdr(aPendingHdr, getter_AddRefs(pendingRow));</span>
<a href="#l17.21"></a><span id="l17.21" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineplus">+  return SetUint64Property(pendingRow, aProperty, aPropertyVal);</span>
<a href="#l17.23"></a><span id="l17.23" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/db/msgdb/src/nsMailDatabase.cpp</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/db/msgdb/src/nsMailDatabase.cpp</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -272,20 +272,20 @@ void nsMailDatabase::UpdateFolderFlag(ns</span>
<a href="#l18.4"></a><span id="l18.4">       seekableStream = do_QueryInterface(fileStream);</span>
<a href="#l18.5"></a><span id="l18.5">       seekableStream-&gt;Tell(&amp;folderStreamPos);</span>
<a href="#l18.6"></a><span id="l18.6">     }</span>
<a href="#l18.7"></a><span id="l18.7">     else</span>
<a href="#l18.8"></a><span id="l18.8">       seekableStream = do_QueryInterface(m_folderStream);</span>
<a href="#l18.9"></a><span id="l18.9">       </span>
<a href="#l18.10"></a><span id="l18.10">     if (fileStream) </span>
<a href="#l18.11"></a><span id="l18.11">     {</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-      PRUint32 msgOffset;</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+      PRUint64 msgOffset;</span>
<a href="#l18.14"></a><span id="l18.14">       (void)mailHdr-&gt;GetMessageOffset(&amp;msgOffset);</span>
<a href="#l18.15"></a><span id="l18.15" class="difflineminus">-      PRUint32 statusPos = offset + msgOffset;</span>
<a href="#l18.16"></a><span id="l18.16" class="difflineminus">-      PR_ASSERT(offset &lt; 10000);</span>
<a href="#l18.17"></a><span id="l18.17" class="difflineplus">+      PRUint64 statusPos = msgOffset + offset;</span>
<a href="#l18.18"></a><span id="l18.18" class="difflineplus">+      NS_ASSERTION(offset &lt; 10000, &quot;extremely unlikely status offset&quot;);</span>
<a href="#l18.19"></a><span id="l18.19">       seekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET, statusPos);</span>
<a href="#l18.20"></a><span id="l18.20">       buf[0] = '\0';</span>
<a href="#l18.21"></a><span id="l18.21">       nsCOMPtr &lt;nsIInputStream&gt; inputStream = do_QueryInterface(fileStream);</span>
<a href="#l18.22"></a><span id="l18.22">       PRUint32 bytesRead;</span>
<a href="#l18.23"></a><span id="l18.23">       if (NS_SUCCEEDED(inputStream-&gt;Read(buf, X_MOZILLA_STATUS_LEN + 6, &amp;bytesRead)))</span>
<a href="#l18.24"></a><span id="l18.24">       {</span>
<a href="#l18.25"></a><span id="l18.25">         buf[bytesRead] = '\0';</span>
<a href="#l18.26"></a><span id="l18.26">         if (strncmp(buf, X_MOZILLA_STATUS, X_MOZILLA_STATUS_LEN) == 0 &amp;&amp;</span>
<a href="#l18.27"></a><span id="l18.27" class="difflineat">@@ -314,17 +314,17 @@ void nsMailDatabase::UpdateFolderFlag(ns</span>
<a href="#l18.28"></a><span id="l18.28">           {</span>
<a href="#l18.29"></a><span id="l18.29">             flags &amp;= ~nsMsgMessageFlags::RuntimeOnly;</span>
<a href="#l18.30"></a><span id="l18.30">           }</span>
<a href="#l18.31"></a><span id="l18.31">           seekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET, statusPos);</span>
<a href="#l18.32"></a><span id="l18.32">           // We are filing out x-mozilla-status flags here</span>
<a href="#l18.33"></a><span id="l18.33">           PR_snprintf(buf, sizeof(buf), X_MOZILLA_STATUS_FORMAT,</span>
<a href="#l18.34"></a><span id="l18.34">             flags &amp; 0x0000FFFF);</span>
<a href="#l18.35"></a><span id="l18.35">           PRInt32 lineLen = PL_strlen(buf);</span>
<a href="#l18.36"></a><span id="l18.36" class="difflineminus">-          PRUint32 status2Pos = statusPos + lineLen + MSG_LINEBREAK_LEN;</span>
<a href="#l18.37"></a><span id="l18.37" class="difflineplus">+          PRUint64 status2Pos = statusPos + lineLen + MSG_LINEBREAK_LEN;</span>
<a href="#l18.38"></a><span id="l18.38">           fileStream-&gt;Write(buf, lineLen, &amp;bytesWritten);</span>
<a href="#l18.39"></a><span id="l18.39">           </span>
<a href="#l18.40"></a><span id="l18.40">           // time to upate x-mozilla-status2</span>
<a href="#l18.41"></a><span id="l18.41">           seekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET, status2Pos);</span>
<a href="#l18.42"></a><span id="l18.42">           if (NS_SUCCEEDED(inputStream-&gt;Read(buf, X_MOZILLA_STATUS2_LEN + 10, &amp;bytesRead)))</span>
<a href="#l18.43"></a><span id="l18.43">           {</span>
<a href="#l18.44"></a><span id="l18.44">             if (strncmp(buf, X_MOZILLA_STATUS2, X_MOZILLA_STATUS2_LEN) == 0 &amp;&amp;</span>
<a href="#l18.45"></a><span id="l18.45">               strncmp(buf + X_MOZILLA_STATUS2_LEN, &quot;: &quot;, 2) == 0 &amp;&amp;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/db/msgdb/src/nsMsgDatabase.cpp</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/db/msgdb/src/nsMsgDatabase.cpp</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -3563,16 +3563,50 @@ nsresult nsMsgDatabase::UInt32ToRowCellC</span>
<a href="#l19.4"></a><span id="l19.4">   yarn.mYarn_Buf = (void *) yarnBuf;</span>
<a href="#l19.5"></a><span id="l19.5">   yarn.mYarn_Size = sizeof(yarnBuf);</span>
<a href="#l19.6"></a><span id="l19.6">   yarn.mYarn_Fill = yarn.mYarn_Size;</span>
<a href="#l19.7"></a><span id="l19.7">   yarn.mYarn_Form = 0;</span>
<a href="#l19.8"></a><span id="l19.8">   yarn.mYarn_Grow = NULL;</span>
<a href="#l19.9"></a><span id="l19.9">   return row-&gt;AddColumn(GetEnv(),  columnToken, UInt32ToYarn(&amp;yarn, value));</span>
<a href="#l19.10"></a><span id="l19.10"> }</span>
<a href="#l19.11"></a><span id="l19.11"> </span>
<a href="#l19.12"></a><span id="l19.12" class="difflineplus">+nsresult nsMsgDatabase::UInt64ToRowCellColumn(nsIMdbRow *row, mdb_token columnToken, PRUint64 value)</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+{</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineplus">+  NS_ENSURE_ARG_POINTER(row);</span>
<a href="#l19.15"></a><span id="l19.15" class="difflineplus">+  struct mdbYarn yarn;</span>
<a href="#l19.16"></a><span id="l19.16" class="difflineplus">+  char  yarnBuf[17]; // max string is 16 bytes, + 1 for null.</span>
<a href="#l19.17"></a><span id="l19.17" class="difflineplus">+</span>
<a href="#l19.18"></a><span id="l19.18" class="difflineplus">+  yarn.mYarn_Buf = (void *) yarnBuf;</span>
<a href="#l19.19"></a><span id="l19.19" class="difflineplus">+  yarn.mYarn_Size = sizeof(yarnBuf);</span>
<a href="#l19.20"></a><span id="l19.20" class="difflineplus">+  yarn.mYarn_Form = 0;</span>
<a href="#l19.21"></a><span id="l19.21" class="difflineplus">+  yarn.mYarn_Grow = NULL;</span>
<a href="#l19.22"></a><span id="l19.22" class="difflineplus">+  PR_snprintf((char *) yarn.mYarn_Buf, yarn.mYarn_Size, &quot;%llx&quot;, value);</span>
<a href="#l19.23"></a><span id="l19.23" class="difflineplus">+  yarn.mYarn_Fill = PL_strlen((const char *) yarn.mYarn_Buf);</span>
<a href="#l19.24"></a><span id="l19.24" class="difflineplus">+  return row-&gt;AddColumn(GetEnv(),  columnToken, &amp;yarn);</span>
<a href="#l19.25"></a><span id="l19.25" class="difflineplus">+}</span>
<a href="#l19.26"></a><span id="l19.26" class="difflineplus">+</span>
<a href="#l19.27"></a><span id="l19.27" class="difflineplus">+nsresult</span>
<a href="#l19.28"></a><span id="l19.28" class="difflineplus">+nsMsgDatabase::RowCellColumnToUInt64(nsIMdbRow *hdrRow, mdb_token columnToken,</span>
<a href="#l19.29"></a><span id="l19.29" class="difflineplus">+                                     PRUint64 *uint64Result,</span>
<a href="#l19.30"></a><span id="l19.30" class="difflineplus">+                                     PRUint64 defaultValue)</span>
<a href="#l19.31"></a><span id="l19.31" class="difflineplus">+{</span>
<a href="#l19.32"></a><span id="l19.32" class="difflineplus">+  nsresult  err = NS_OK;</span>
<a href="#l19.33"></a><span id="l19.33" class="difflineplus">+</span>
<a href="#l19.34"></a><span id="l19.34" class="difflineplus">+  if (uint64Result)</span>
<a href="#l19.35"></a><span id="l19.35" class="difflineplus">+    *uint64Result = defaultValue;</span>
<a href="#l19.36"></a><span id="l19.36" class="difflineplus">+  if (hdrRow)  // ### probably should be an error if hdrRow is NULL...</span>
<a href="#l19.37"></a><span id="l19.37" class="difflineplus">+  {</span>
<a href="#l19.38"></a><span id="l19.38" class="difflineplus">+    struct mdbYarn yarn;</span>
<a href="#l19.39"></a><span id="l19.39" class="difflineplus">+    err = hdrRow-&gt;AliasCellYarn(GetEnv(), columnToken, &amp;yarn);</span>
<a href="#l19.40"></a><span id="l19.40" class="difflineplus">+    if (NS_SUCCEEDED(err))</span>
<a href="#l19.41"></a><span id="l19.41" class="difflineplus">+      YarnToUInt64(&amp;yarn, uint64Result);</span>
<a href="#l19.42"></a><span id="l19.42" class="difflineplus">+  }</span>
<a href="#l19.43"></a><span id="l19.43" class="difflineplus">+  return err;</span>
<a href="#l19.44"></a><span id="l19.44" class="difflineplus">+}</span>
<a href="#l19.45"></a><span id="l19.45" class="difflineplus">+</span>
<a href="#l19.46"></a><span id="l19.46"> nsresult nsMsgDatabase::CharPtrToRowCellColumn(nsIMdbRow *row, mdb_token columnToken, const char *charPtr)</span>
<a href="#l19.47"></a><span id="l19.47"> {</span>
<a href="#l19.48"></a><span id="l19.48">   if (!row)</span>
<a href="#l19.49"></a><span id="l19.49">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l19.50"></a><span id="l19.50"> </span>
<a href="#l19.51"></a><span id="l19.51">   struct mdbYarn yarn;</span>
<a href="#l19.52"></a><span id="l19.52">   yarn.mYarn_Buf = (void *) charPtr;</span>
<a href="#l19.53"></a><span id="l19.53">   yarn.mYarn_Size = PL_strlen((const char *) yarn.mYarn_Buf) + 1;</span>
<a href="#l19.54"></a><span id="l19.54" class="difflineat">@@ -3622,16 +3656,24 @@ nsresult nsMsgDatabase::RowCellColumnToC</span>
<a href="#l19.55"></a><span id="l19.55"> /* static */struct mdbYarn *nsMsgDatabase::UInt32ToYarn(struct mdbYarn *yarn, PRUint32 i)</span>
<a href="#l19.56"></a><span id="l19.56"> {</span>
<a href="#l19.57"></a><span id="l19.57">   PR_snprintf((char *) yarn-&gt;mYarn_Buf, yarn-&gt;mYarn_Size, &quot;%lx&quot;, i);</span>
<a href="#l19.58"></a><span id="l19.58">   yarn-&gt;mYarn_Fill = PL_strlen((const char *) yarn-&gt;mYarn_Buf);</span>
<a href="#l19.59"></a><span id="l19.59">   yarn-&gt;mYarn_Form = 0;  // what to do with this? Should be parsed out of the mime2 header?</span>
<a href="#l19.60"></a><span id="l19.60">   return yarn;</span>
<a href="#l19.61"></a><span id="l19.61"> }</span>
<a href="#l19.62"></a><span id="l19.62"> </span>
<a href="#l19.63"></a><span id="l19.63" class="difflineplus">+/* static */struct mdbYarn *nsMsgDatabase::UInt64ToYarn(struct mdbYarn *yarn, PRUint64 i)</span>
<a href="#l19.64"></a><span id="l19.64" class="difflineplus">+{</span>
<a href="#l19.65"></a><span id="l19.65" class="difflineplus">+  PR_snprintf((char *) yarn-&gt;mYarn_Buf, yarn-&gt;mYarn_Size, &quot;%llx&quot;, i);</span>
<a href="#l19.66"></a><span id="l19.66" class="difflineplus">+  yarn-&gt;mYarn_Fill = PL_strlen((const char *) yarn-&gt;mYarn_Buf);</span>
<a href="#l19.67"></a><span id="l19.67" class="difflineplus">+  yarn-&gt;mYarn_Form = 0;</span>
<a href="#l19.68"></a><span id="l19.68" class="difflineplus">+  return yarn;</span>
<a href="#l19.69"></a><span id="l19.69" class="difflineplus">+}</span>
<a href="#l19.70"></a><span id="l19.70" class="difflineplus">+</span>
<a href="#l19.71"></a><span id="l19.71"> /* static */void nsMsgDatabase::YarnTonsString(struct mdbYarn *yarn, nsAString &amp;str)</span>
<a href="#l19.72"></a><span id="l19.72"> {</span>
<a href="#l19.73"></a><span id="l19.73">   const char* buf = (const char*)yarn-&gt;mYarn_Buf;</span>
<a href="#l19.74"></a><span id="l19.74">   if (buf)</span>
<a href="#l19.75"></a><span id="l19.75">     CopyASCIItoUTF16(Substring(buf, buf + yarn-&gt;mYarn_Fill), str);</span>
<a href="#l19.76"></a><span id="l19.76">   else</span>
<a href="#l19.77"></a><span id="l19.77">     str.Truncate();</span>
<a href="#l19.78"></a><span id="l19.78"> }</span>
<a href="#l19.79"></a><span id="l19.79" class="difflineat">@@ -3667,16 +3709,43 @@ nsresult nsMsgDatabase::RowCellColumnToC</span>
<a href="#l19.80"></a><span id="l19.80">          break;</span>
<a href="#l19.81"></a><span id="l19.81">        result = (result &lt;&lt; 4) | unhex;</span>
<a href="#l19.82"></a><span id="l19.82">     }</span>
<a href="#l19.83"></a><span id="l19.83"> </span>
<a href="#l19.84"></a><span id="l19.84">     *pResult = result;</span>
<a href="#l19.85"></a><span id="l19.85">   }</span>
<a href="#l19.86"></a><span id="l19.86"> }</span>
<a href="#l19.87"></a><span id="l19.87"> </span>
<a href="#l19.88"></a><span id="l19.88" class="difflineplus">+// WARNING - if yarn is empty, *pResult will not be changed!!!!</span>
<a href="#l19.89"></a><span id="l19.89" class="difflineplus">+// this is so we can leave default values as they were.</span>
<a href="#l19.90"></a><span id="l19.90" class="difflineplus">+/* static */void nsMsgDatabase::YarnToUInt64(struct mdbYarn *yarn, PRUint64 *pResult)</span>
<a href="#l19.91"></a><span id="l19.91" class="difflineplus">+{</span>
<a href="#l19.92"></a><span id="l19.92" class="difflineplus">+  PRUint64 result;</span>
<a href="#l19.93"></a><span id="l19.93" class="difflineplus">+  char *p = (char *) yarn-&gt;mYarn_Buf;</span>
<a href="#l19.94"></a><span id="l19.94" class="difflineplus">+  PRInt32 numChars = NS_MIN((mdb_fill)16, yarn-&gt;mYarn_Fill);</span>
<a href="#l19.95"></a><span id="l19.95" class="difflineplus">+  PRInt32 i;</span>
<a href="#l19.96"></a><span id="l19.96" class="difflineplus">+</span>
<a href="#l19.97"></a><span id="l19.97" class="difflineplus">+  if (numChars &gt; 0)</span>
<a href="#l19.98"></a><span id="l19.98" class="difflineplus">+  {</span>
<a href="#l19.99"></a><span id="l19.99" class="difflineplus">+    for (i = 0, result = 0; i &lt; numChars; i++, p++)</span>
<a href="#l19.100"></a><span id="l19.100" class="difflineplus">+    {</span>
<a href="#l19.101"></a><span id="l19.101" class="difflineplus">+      char C = *p;</span>
<a href="#l19.102"></a><span id="l19.102" class="difflineplus">+</span>
<a href="#l19.103"></a><span id="l19.103" class="difflineplus">+      PRInt8 unhex = ((C &gt;= '0' &amp;&amp; C &lt;= '9') ? C - '0' :</span>
<a href="#l19.104"></a><span id="l19.104" class="difflineplus">+      ((C &gt;= 'A' &amp;&amp; C &lt;= 'F') ? C - 'A' + 10 :</span>
<a href="#l19.105"></a><span id="l19.105" class="difflineplus">+         ((C &gt;= 'a' &amp;&amp; C &lt;= 'f') ? C - 'a' + 10 : -1)));</span>
<a href="#l19.106"></a><span id="l19.106" class="difflineplus">+       if (unhex &lt; 0)</span>
<a href="#l19.107"></a><span id="l19.107" class="difflineplus">+         break;</span>
<a href="#l19.108"></a><span id="l19.108" class="difflineplus">+       result = (result &lt;&lt; 4) | unhex;</span>
<a href="#l19.109"></a><span id="l19.109" class="difflineplus">+    }</span>
<a href="#l19.110"></a><span id="l19.110" class="difflineplus">+    *pResult = result;</span>
<a href="#l19.111"></a><span id="l19.111" class="difflineplus">+  }</span>
<a href="#l19.112"></a><span id="l19.112" class="difflineplus">+}</span>
<a href="#l19.113"></a><span id="l19.113" class="difflineplus">+</span>
<a href="#l19.114"></a><span id="l19.114" class="difflineplus">+</span>
<a href="#l19.115"></a><span id="l19.115"> nsresult nsMsgDatabase::GetProperty(nsIMdbRow *row, const char *propertyName, char **result)</span>
<a href="#l19.116"></a><span id="l19.116"> {</span>
<a href="#l19.117"></a><span id="l19.117">   nsresult err = NS_OK;</span>
<a href="#l19.118"></a><span id="l19.118">   mdb_token  property_token;</span>
<a href="#l19.119"></a><span id="l19.119"> </span>
<a href="#l19.120"></a><span id="l19.120">   if (m_mdbStore)</span>
<a href="#l19.121"></a><span id="l19.121">     err = m_mdbStore-&gt;StringToToken(GetEnv(),  propertyName, &amp;property_token);</span>
<a href="#l19.122"></a><span id="l19.122">   else</span>
<a href="#l19.123"></a><span id="l19.123" class="difflineat">@@ -3753,16 +3822,41 @@ nsresult nsMsgDatabase::SetUint32Propert</span>
<a href="#l19.124"></a><span id="l19.124">   if (err == NS_OK)</span>
<a href="#l19.125"></a><span id="l19.125">   {</span>
<a href="#l19.126"></a><span id="l19.126">     UInt32ToYarn(&amp;yarn, propertyVal);</span>
<a href="#l19.127"></a><span id="l19.127">     err = row-&gt;AddColumn(GetEnv(), property_token, &amp;yarn);</span>
<a href="#l19.128"></a><span id="l19.128">   }</span>
<a href="#l19.129"></a><span id="l19.129">   return err;</span>
<a href="#l19.130"></a><span id="l19.130"> }</span>
<a href="#l19.131"></a><span id="l19.131"> </span>
<a href="#l19.132"></a><span id="l19.132" class="difflineplus">+nsresult nsMsgDatabase::SetUint64Property(nsIMdbRow *row,</span>
<a href="#l19.133"></a><span id="l19.133" class="difflineplus">+                                          const char *propertyName,</span>
<a href="#l19.134"></a><span id="l19.134" class="difflineplus">+                                          PRUint64 propertyVal)</span>
<a href="#l19.135"></a><span id="l19.135" class="difflineplus">+{</span>
<a href="#l19.136"></a><span id="l19.136" class="difflineplus">+  struct mdbYarn yarn;</span>
<a href="#l19.137"></a><span id="l19.137" class="difflineplus">+  char  int64StrBuf[100];</span>
<a href="#l19.138"></a><span id="l19.138" class="difflineplus">+  yarn.mYarn_Buf = int64StrBuf;</span>
<a href="#l19.139"></a><span id="l19.139" class="difflineplus">+  yarn.mYarn_Size = sizeof(int64StrBuf);</span>
<a href="#l19.140"></a><span id="l19.140" class="difflineplus">+  yarn.mYarn_Fill = sizeof(int64StrBuf);</span>
<a href="#l19.141"></a><span id="l19.141" class="difflineplus">+</span>
<a href="#l19.142"></a><span id="l19.142" class="difflineplus">+  NS_ENSURE_STATE(m_mdbStore); // db might have been closed out from under us.</span>
<a href="#l19.143"></a><span id="l19.143" class="difflineplus">+  if (!row)</span>
<a href="#l19.144"></a><span id="l19.144" class="difflineplus">+    return NS_ERROR_NULL_POINTER;</span>
<a href="#l19.145"></a><span id="l19.145" class="difflineplus">+</span>
<a href="#l19.146"></a><span id="l19.146" class="difflineplus">+  mdb_token  property_token;</span>
<a href="#l19.147"></a><span id="l19.147" class="difflineplus">+</span>
<a href="#l19.148"></a><span id="l19.148" class="difflineplus">+  nsresult err = m_mdbStore-&gt;StringToToken(GetEnv(),  propertyName, &amp;property_token);</span>
<a href="#l19.149"></a><span id="l19.149" class="difflineplus">+  if (err == NS_OK)</span>
<a href="#l19.150"></a><span id="l19.150" class="difflineplus">+  {</span>
<a href="#l19.151"></a><span id="l19.151" class="difflineplus">+    UInt64ToYarn(&amp;yarn, propertyVal);</span>
<a href="#l19.152"></a><span id="l19.152" class="difflineplus">+    err = row-&gt;AddColumn(GetEnv(), property_token, &amp;yarn);</span>
<a href="#l19.153"></a><span id="l19.153" class="difflineplus">+  }</span>
<a href="#l19.154"></a><span id="l19.154" class="difflineplus">+  return err;</span>
<a href="#l19.155"></a><span id="l19.155" class="difflineplus">+}</span>
<a href="#l19.156"></a><span id="l19.156" class="difflineplus">+</span>
<a href="#l19.157"></a><span id="l19.157"> nsresult nsMsgDatabase::GetBooleanProperty(nsIMdbRow *row, const char *propertyName, </span>
<a href="#l19.158"></a><span id="l19.158">                                      PRBool *result, </span>
<a href="#l19.159"></a><span id="l19.159">                                      PRBool defaultValue /* = PR_FALSE */)</span>
<a href="#l19.160"></a><span id="l19.160"> {</span>
<a href="#l19.161"></a><span id="l19.161">   PRUint32 res;</span>
<a href="#l19.162"></a><span id="l19.162">   nsresult rv = GetUint32Property(row, propertyName, &amp;res, (PRUint32) defaultValue);</span>
<a href="#l19.163"></a><span id="l19.163">   *result = (PRBool) res;</span>
<a href="#l19.164"></a><span id="l19.164">   return rv;</span>
<a href="#l19.165"></a><span id="l19.165" class="difflineat">@@ -4534,16 +4628,24 @@ NS_IMETHODIMP nsMsgDatabase::SetAttribut</span>
<a href="#l19.166"></a><span id="l19.166"> }</span>
<a href="#l19.167"></a><span id="l19.167"> </span>
<a href="#l19.168"></a><span id="l19.168"> NS_IMETHODIMP nsMsgDatabase::SetUint32AttributeOnPendingHdr(nsIMsgDBHdr *pendingHdr, const char *property,</span>
<a href="#l19.169"></a><span id="l19.169">                                   PRUint32 propertyVal)</span>
<a href="#l19.170"></a><span id="l19.170"> {</span>
<a href="#l19.171"></a><span id="l19.171">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l19.172"></a><span id="l19.172"> }</span>
<a href="#l19.173"></a><span id="l19.173"> </span>
<a href="#l19.174"></a><span id="l19.174" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l19.175"></a><span id="l19.175" class="difflineplus">+nsMsgDatabase::SetUint64AttributeOnPendingHdr(nsIMsgDBHdr *aPendingHdr,</span>
<a href="#l19.176"></a><span id="l19.176" class="difflineplus">+                                              const char *aProperty,</span>
<a href="#l19.177"></a><span id="l19.177" class="difflineplus">+                                              PRUint64 aPropertyVal)</span>
<a href="#l19.178"></a><span id="l19.178" class="difflineplus">+{</span>
<a href="#l19.179"></a><span id="l19.179" class="difflineplus">+  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l19.180"></a><span id="l19.180" class="difflineplus">+}</span>
<a href="#l19.181"></a><span id="l19.181" class="difflineplus">+</span>
<a href="#l19.182"></a><span id="l19.182"> NS_IMETHODIMP nsMsgDatabase::GetOfflineOpForKey(nsMsgKey msgKey, PRBool create, nsIMsgOfflineImapOperation **offlineOp)</span>
<a href="#l19.183"></a><span id="l19.183"> {</span>
<a href="#l19.184"></a><span id="l19.184">   NS_ASSERTION(PR_FALSE, &quot;overridden by nsMailDatabase&quot;);</span>
<a href="#l19.185"></a><span id="l19.185">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l19.186"></a><span id="l19.186"> }</span>
<a href="#l19.187"></a><span id="l19.187"> </span>
<a href="#l19.188"></a><span id="l19.188"> NS_IMETHODIMP  nsMsgDatabase::RemoveOfflineOp(nsIMsgOfflineImapOperation *op)</span>
<a href="#l19.189"></a><span id="l19.189"> {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mailnews/db/msgdb/src/nsMsgHdr.cpp</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mailnews/db/msgdb/src/nsMsgHdr.cpp</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -628,38 +628,38 @@ NS_IMETHODIMP nsMsgHdr::SetAccountKey(co</span>
<a href="#l20.4"></a><span id="l20.4"> NS_IMETHODIMP nsMsgHdr::GetAccountKey(char **aResult)</span>
<a href="#l20.5"></a><span id="l20.5"> {</span>
<a href="#l20.6"></a><span id="l20.6">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l20.7"></a><span id="l20.7"> </span>
<a href="#l20.8"></a><span id="l20.8">   return GetStringProperty(&quot;account&quot;, aResult);</span>
<a href="#l20.9"></a><span id="l20.9"> }</span>
<a href="#l20.10"></a><span id="l20.10"> </span>
<a href="#l20.11"></a><span id="l20.11"> </span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-NS_IMETHODIMP nsMsgHdr::GetMessageOffset(PRUint32 *result)</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineplus">+NS_IMETHODIMP nsMsgHdr::GetMessageOffset(PRUint64 *result)</span>
<a href="#l20.14"></a><span id="l20.14"> {</span>
<a href="#l20.15"></a><span id="l20.15">   NS_ENSURE_ARG(result);</span>
<a href="#l20.16"></a><span id="l20.16"> </span>
<a href="#l20.17"></a><span id="l20.17">   // if we have the message body offline, then return the message offset column</span>
<a href="#l20.18"></a><span id="l20.18">   // (this will only be true for news and imap messages).</span>
<a href="#l20.19"></a><span id="l20.19">   PRUint32 rawFlags;</span>
<a href="#l20.20"></a><span id="l20.20">   GetRawFlags(&amp;rawFlags);</span>
<a href="#l20.21"></a><span id="l20.21">   if (rawFlags &amp; nsMsgMessageFlags::Offline)</span>
<a href="#l20.22"></a><span id="l20.22">   {</span>
<a href="#l20.23"></a><span id="l20.23" class="difflineminus">-    return GetUInt32Column(m_mdb-&gt;m_offlineMsgOffsetColumnToken, result);</span>
<a href="#l20.24"></a><span id="l20.24" class="difflineplus">+    return GetUInt64Column(m_mdb-&gt;m_offlineMsgOffsetColumnToken, result);</span>
<a href="#l20.25"></a><span id="l20.25">   }</span>
<a href="#l20.26"></a><span id="l20.26">   else</span>
<a href="#l20.27"></a><span id="l20.27">   {</span>
<a href="#l20.28"></a><span id="l20.28">     *result = m_messageKey;</span>
<a href="#l20.29"></a><span id="l20.29">     return NS_OK;</span>
<a href="#l20.30"></a><span id="l20.30">   }</span>
<a href="#l20.31"></a><span id="l20.31"> }</span>
<a href="#l20.32"></a><span id="l20.32"> </span>
<a href="#l20.33"></a><span id="l20.33" class="difflineminus">-NS_IMETHODIMP nsMsgHdr::SetMessageOffset(PRUint32 offset)</span>
<a href="#l20.34"></a><span id="l20.34" class="difflineplus">+NS_IMETHODIMP nsMsgHdr::SetMessageOffset(PRUint64 offset)</span>
<a href="#l20.35"></a><span id="l20.35"> {</span>
<a href="#l20.36"></a><span id="l20.36" class="difflineminus">-  SetUInt32Column(offset, m_mdb-&gt;m_offlineMsgOffsetColumnToken);</span>
<a href="#l20.37"></a><span id="l20.37" class="difflineplus">+  SetUInt64Column(offset, m_mdb-&gt;m_offlineMsgOffsetColumnToken);</span>
<a href="#l20.38"></a><span id="l20.38">   return NS_OK;</span>
<a href="#l20.39"></a><span id="l20.39"> }</span>
<a href="#l20.40"></a><span id="l20.40"> </span>
<a href="#l20.41"></a><span id="l20.41"> </span>
<a href="#l20.42"></a><span id="l20.42"> NS_IMETHODIMP nsMsgHdr::GetMessageSize(PRUint32 *result)</span>
<a href="#l20.43"></a><span id="l20.43"> {</span>
<a href="#l20.44"></a><span id="l20.44">   PRUint32 size;</span>
<a href="#l20.45"></a><span id="l20.45">   nsresult res = GetUInt32Column(m_mdb-&gt;m_messageSizeColumnToken, &amp;size);</span>
<a href="#l20.46"></a><span id="l20.46" class="difflineat">@@ -806,16 +806,26 @@ nsresult nsMsgHdr::SetUInt32Column(PRUin</span>
<a href="#l20.47"></a><span id="l20.47">   return m_mdb-&gt;UInt32ToRowCellColumn(m_mdbRow, token, value);</span>
<a href="#l20.48"></a><span id="l20.48"> }</span>
<a href="#l20.49"></a><span id="l20.49"> </span>
<a href="#l20.50"></a><span id="l20.50"> nsresult nsMsgHdr::GetUInt32Column(mdb_token token, PRUint32 *pvalue, PRUint32 defaultValue)</span>
<a href="#l20.51"></a><span id="l20.51"> {</span>
<a href="#l20.52"></a><span id="l20.52">   return m_mdb-&gt;RowCellColumnToUInt32(GetMDBRow(), token, pvalue, defaultValue);</span>
<a href="#l20.53"></a><span id="l20.53"> }</span>
<a href="#l20.54"></a><span id="l20.54"> </span>
<a href="#l20.55"></a><span id="l20.55" class="difflineplus">+nsresult nsMsgHdr::SetUInt64Column(PRUint64 value, mdb_token token)</span>
<a href="#l20.56"></a><span id="l20.56" class="difflineplus">+{</span>
<a href="#l20.57"></a><span id="l20.57" class="difflineplus">+  return m_mdb-&gt;UInt64ToRowCellColumn(m_mdbRow, token, value);</span>
<a href="#l20.58"></a><span id="l20.58" class="difflineplus">+}</span>
<a href="#l20.59"></a><span id="l20.59" class="difflineplus">+</span>
<a href="#l20.60"></a><span id="l20.60" class="difflineplus">+nsresult nsMsgHdr::GetUInt64Column(mdb_token token, PRUint64 *pvalue, PRUint64 defaultValue)</span>
<a href="#l20.61"></a><span id="l20.61" class="difflineplus">+{</span>
<a href="#l20.62"></a><span id="l20.62" class="difflineplus">+  return m_mdb-&gt;RowCellColumnToUInt64(GetMDBRow(), token, pvalue, defaultValue);</span>
<a href="#l20.63"></a><span id="l20.63" class="difflineplus">+}</span>
<a href="#l20.64"></a><span id="l20.64" class="difflineplus">+</span>
<a href="#l20.65"></a><span id="l20.65"> /**</span>
<a href="#l20.66"></a><span id="l20.66">  * Roughly speaking, get the next message-id (starts with a '&lt;' ends with a</span>
<a href="#l20.67"></a><span id="l20.67">  *  '&gt;').  Except, we also try to handle the case where your reference is of</span>
<a href="#l20.68"></a><span id="l20.68">  *  a prehistoric vintage that just stuck any old random junk in there.  Our</span>
<a href="#l20.69"></a><span id="l20.69">  *  old logic would (unintentionally?) just trim the whitespace off the front</span>
<a href="#l20.70"></a><span id="l20.70">  *  and hand you everything after that.  We change things at all because that</span>
<a href="#l20.71"></a><span id="l20.71">  *  same behaviour does not make sense if we have already seen a proper message</span>
<a href="#l20.72"></a><span id="l20.72">  *  id.  We keep the old behaviour at all because it would seem to have</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -6713,30 +6713,29 @@ nsresult nsImapMailFolder::CopyOfflineMs</span>
<a href="#l21.4"></a><span id="l21.4">                                               nsIMsgDBHdr *destHdr,</span>
<a href="#l21.5"></a><span id="l21.5">                                               nsIMsgDBHdr *origHdr,</span>
<a href="#l21.6"></a><span id="l21.6">                                               nsIInputStream *inputStream,</span>
<a href="#l21.7"></a><span id="l21.7">                                               nsIOutputStream *outputStream)</span>
<a href="#l21.8"></a><span id="l21.8"> {</span>
<a href="#l21.9"></a><span id="l21.9">   nsresult rv;</span>
<a href="#l21.10"></a><span id="l21.10">   nsCOMPtr &lt;nsISeekableStream&gt; seekable (do_QueryInterface(outputStream, &amp;rv));</span>
<a href="#l21.11"></a><span id="l21.11">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-  nsMsgKey messageOffset;</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineplus">+  PRUint64 messageOffset;</span>
<a href="#l21.14"></a><span id="l21.14">   PRUint32 messageSize;</span>
<a href="#l21.15"></a><span id="l21.15">   origHdr-&gt;GetMessageOffset(&amp;messageOffset);</span>
<a href="#l21.16"></a><span id="l21.16">   origHdr-&gt;GetOfflineMessageSize(&amp;messageSize);</span>
<a href="#l21.17"></a><span id="l21.17">   if (!messageSize)</span>
<a href="#l21.18"></a><span id="l21.18">   {</span>
<a href="#l21.19"></a><span id="l21.19">     nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; localFolder = do_QueryInterface(srcFolder);</span>
<a href="#l21.20"></a><span id="l21.20">     if (localFolder)   //can just use regular message size</span>
<a href="#l21.21"></a><span id="l21.21">       origHdr-&gt;GetMessageSize(&amp;messageSize);</span>
<a href="#l21.22"></a><span id="l21.22">   }</span>
<a href="#l21.23"></a><span id="l21.23">   PRInt64 tellPos;</span>
<a href="#l21.24"></a><span id="l21.24">   seekable-&gt;Tell(&amp;tellPos);</span>
<a href="#l21.25"></a><span id="l21.25" class="difflineminus">-  nsInt64 curStorePos = tellPos;</span>
<a href="#l21.26"></a><span id="l21.26" class="difflineminus">-  destHdr-&gt;SetMessageOffset((PRUint32) curStorePos);</span>
<a href="#l21.27"></a><span id="l21.27" class="difflineplus">+  destHdr-&gt;SetMessageOffset(tellPos);</span>
<a href="#l21.28"></a><span id="l21.28">   nsCOMPtr&lt;nsISeekableStream&gt; seekStream = do_QueryInterface(inputStream);</span>
<a href="#l21.29"></a><span id="l21.29">   NS_ASSERTION(seekStream, &quot;non seekable stream - can't read from offline msg&quot;);</span>
<a href="#l21.30"></a><span id="l21.30">   if (seekStream)</span>
<a href="#l21.31"></a><span id="l21.31">   {</span>
<a href="#l21.32"></a><span id="l21.32">     rv = seekStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET, messageOffset);</span>
<a href="#l21.33"></a><span id="l21.33">     if (NS_SUCCEEDED(rv))</span>
<a href="#l21.34"></a><span id="l21.34">     {</span>
<a href="#l21.35"></a><span id="l21.35">       // now, copy the dest folder offline store msg to the temp file</span>
<a href="#l21.36"></a><span id="l21.36" class="difflineat">@@ -7151,23 +7150,23 @@ void nsImapMailFolder::SetPendingAttribu</span>
<a href="#l21.37"></a><span id="l21.37">           continue;</span>
<a href="#l21.38"></a><span id="l21.38"> </span>
<a href="#l21.39"></a><span id="l21.39">         nsCString sourceString;</span>
<a href="#l21.40"></a><span id="l21.40">         msgDBHdr-&gt;GetStringProperty(property.get(), getter_Copies(sourceString));</span>
<a href="#l21.41"></a><span id="l21.41">         mDatabase-&gt;SetAttributeOnPendingHdr(msgDBHdr, property.get(), sourceString.get());</span>
<a href="#l21.42"></a><span id="l21.42">       }</span>
<a href="#l21.43"></a><span id="l21.43"> </span>
<a href="#l21.44"></a><span id="l21.44">       PRUint32 messageSize;</span>
<a href="#l21.45"></a><span id="l21.45" class="difflineminus">-      nsMsgKey messageOffset;</span>
<a href="#l21.46"></a><span id="l21.46" class="difflineplus">+      PRUint64 messageOffset;</span>
<a href="#l21.47"></a><span id="l21.47">       msgDBHdr-&gt;GetMessageOffset(&amp;messageOffset);</span>
<a href="#l21.48"></a><span id="l21.48">       msgDBHdr-&gt;GetOfflineMessageSize(&amp;messageSize);</span>
<a href="#l21.49"></a><span id="l21.49">       if (messageSize)</span>
<a href="#l21.50"></a><span id="l21.50">       {</span>
<a href="#l21.51"></a><span id="l21.51">         mDatabase-&gt;SetUint32AttributeOnPendingHdr(msgDBHdr, &quot;offlineMsgSize&quot;, messageSize);</span>
<a href="#l21.52"></a><span id="l21.52" class="difflineminus">-        mDatabase-&gt;SetUint32AttributeOnPendingHdr(msgDBHdr, &quot;msgOffset&quot;, messageOffset);</span>
<a href="#l21.53"></a><span id="l21.53" class="difflineplus">+        mDatabase-&gt;SetUint64AttributeOnPendingHdr(msgDBHdr, &quot;msgOffset&quot;, messageOffset);</span>
<a href="#l21.54"></a><span id="l21.54">         mDatabase-&gt;SetUint32AttributeOnPendingHdr(msgDBHdr, &quot;flags&quot;, nsMsgMessageFlags::Offline);</span>
<a href="#l21.55"></a><span id="l21.55">       }</span>
<a href="#l21.56"></a><span id="l21.56">       nsMsgPriorityValue priority;</span>
<a href="#l21.57"></a><span id="l21.57">       msgDBHdr-&gt;GetPriority(&amp;priority);</span>
<a href="#l21.58"></a><span id="l21.58">       if(priority != 0)</span>
<a href="#l21.59"></a><span id="l21.59">       {</span>
<a href="#l21.60"></a><span id="l21.60">         nsCAutoString priorityStr;</span>
<a href="#l21.61"></a><span id="l21.61">         priorityStr.AppendInt(priority);</span>
<a href="#l21.62"></a><span id="l21.62" class="difflineat">@@ -8809,17 +8808,17 @@ NS_IMETHODIMP nsImapMailFolder::FetchMsg</span>
<a href="#l21.63"></a><span id="l21.63">     else // lets look in the offline store</span>
<a href="#l21.64"></a><span id="l21.64">     {</span>
<a href="#l21.65"></a><span id="l21.65">       PRUint32 msgFlags;</span>
<a href="#l21.66"></a><span id="l21.66">       msgHdr-&gt;GetFlags(&amp;msgFlags);</span>
<a href="#l21.67"></a><span id="l21.67">       nsMsgKey msgKey;</span>
<a href="#l21.68"></a><span id="l21.68">       msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l21.69"></a><span id="l21.69">       if (msgFlags &amp; nsMsgMessageFlags::Offline)</span>
<a href="#l21.70"></a><span id="l21.70">       {</span>
<a href="#l21.71"></a><span id="l21.71" class="difflineminus">-        nsMsgKey messageOffset;</span>
<a href="#l21.72"></a><span id="l21.72" class="difflineplus">+        PRUint64 messageOffset;</span>
<a href="#l21.73"></a><span id="l21.73">         PRUint32 messageSize;</span>
<a href="#l21.74"></a><span id="l21.74">         GetOfflineFileStream(msgKey, &amp;messageOffset, &amp;messageSize, getter_AddRefs(inputStream));</span>
<a href="#l21.75"></a><span id="l21.75">         if (inputStream)</span>
<a href="#l21.76"></a><span id="l21.76">           rv = GetMsgPreviewTextFromStream(msgHdr, inputStream);</span>
<a href="#l21.77"></a><span id="l21.77">       }</span>
<a href="#l21.78"></a><span id="l21.78">       else if (!aLocalOnly)</span>
<a href="#l21.79"></a><span id="l21.79">         keysToFetchFromServer.AppendElement(msgKey);</span>
<a href="#l21.80"></a><span id="l21.80">     }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mailnews/imap/src/nsImapOfflineSync.cpp</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapOfflineSync.cpp</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -378,17 +378,17 @@ void</span>
<a href="#l22.4"></a><span id="l22.4"> nsImapOfflineSync::ProcessAppendMsgOperation(nsIMsgOfflineImapOperation *currentOp, PRInt32 opType)</span>
<a href="#l22.5"></a><span id="l22.5"> {</span>
<a href="#l22.6"></a><span id="l22.6">   nsCOMPtr &lt;nsIMsgDBHdr&gt; mailHdr;</span>
<a href="#l22.7"></a><span id="l22.7">   nsMsgKey msgKey;</span>
<a href="#l22.8"></a><span id="l22.8">   currentOp-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l22.9"></a><span id="l22.9">   nsresult rv = m_currentDB-&gt;GetMsgHdrForKey(msgKey, getter_AddRefs(mailHdr)); </span>
<a href="#l22.10"></a><span id="l22.10">   if (NS_SUCCEEDED(rv) &amp;&amp; mailHdr)</span>
<a href="#l22.11"></a><span id="l22.11">   {</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-    nsMsgKey messageOffset;</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineplus">+    PRUint64 messageOffset;</span>
<a href="#l22.14"></a><span id="l22.14">     PRUint32 messageSize;</span>
<a href="#l22.15"></a><span id="l22.15">     mailHdr-&gt;GetMessageOffset(&amp;messageOffset);</span>
<a href="#l22.16"></a><span id="l22.16">     mailHdr-&gt;GetOfflineMessageSize(&amp;messageSize);</span>
<a href="#l22.17"></a><span id="l22.17">     nsCOMPtr&lt;nsIFile&gt; tmpFile;</span>
<a href="#l22.18"></a><span id="l22.18"> </span>
<a href="#l22.19"></a><span id="l22.19">     if (NS_FAILED(GetSpecialDirectoryWithFileName(NS_OS_TEMP_DIR,</span>
<a href="#l22.20"></a><span id="l22.20">                                                   &quot;nscpmsg.txt&quot;,</span>
<a href="#l22.21"></a><span id="l22.21">                                                   getter_AddRefs(tmpFile))))</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mailnews/imap/src/nsImapProtocol.cpp</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapProtocol.cpp</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -8845,33 +8845,34 @@ PRBool nsImapMockChannel::ReadFromLocalC</span>
<a href="#l23.4"></a><span id="l23.4">     imapUrl-&gt;GetListOfMessageIds(messageIdString);</span>
<a href="#l23.5"></a><span id="l23.5">     nsCOMPtr &lt;nsIMsgFolder&gt; folder;</span>
<a href="#l23.6"></a><span id="l23.6">     rv = mailnewsUrl-&gt;GetFolder(getter_AddRefs(folder));</span>
<a href="#l23.7"></a><span id="l23.7">     if (folder &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l23.8"></a><span id="l23.8">     {</span>
<a href="#l23.9"></a><span id="l23.9">       // we want to create a file channel and read the msg from there.</span>
<a href="#l23.10"></a><span id="l23.10">       nsCOMPtr&lt;nsIInputStream&gt; fileStream;</span>
<a href="#l23.11"></a><span id="l23.11">       nsMsgKey msgKey = atoi(messageIdString.get());</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-      PRUint32 size, offset;</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineplus">+      PRUint32 size;</span>
<a href="#l23.14"></a><span id="l23.14" class="difflineplus">+      PRUint64 offset;</span>
<a href="#l23.15"></a><span id="l23.15">       rv = folder-&gt;GetOfflineFileStream(msgKey, &amp;offset, &amp;size, getter_AddRefs(fileStream));</span>
<a href="#l23.16"></a><span id="l23.16">       // get the file channel from the folder, somehow (through the message or</span>
<a href="#l23.17"></a><span id="l23.17">       // folder sink?) We also need to set the transfer offset to the message offset</span>
<a href="#l23.18"></a><span id="l23.18">       if (fileStream &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l23.19"></a><span id="l23.19">       {</span>
<a href="#l23.20"></a><span id="l23.20">         // dougt - This may break the ablity to &quot;cancel&quot; a read from offline mail reading.</span>
<a href="#l23.21"></a><span id="l23.21">         // fileChannel-&gt;SetLoadGroup(m_loadGroup);</span>
<a href="#l23.22"></a><span id="l23.22">         nsImapCacheStreamListener * cacheListener = new nsImapCacheStreamListener();</span>
<a href="#l23.23"></a><span id="l23.23">         NS_ADDREF(cacheListener);</span>
<a href="#l23.24"></a><span id="l23.24">         cacheListener-&gt;Init(m_channelListener, this);</span>
<a href="#l23.25"></a><span id="l23.25"> </span>
<a href="#l23.26"></a><span id="l23.26">         // create a stream pump that will async read the specified amount of data.</span>
<a href="#l23.27"></a><span id="l23.27">         // XXX make offset/size 64-bit ints</span>
<a href="#l23.28"></a><span id="l23.28">         nsCOMPtr&lt;nsIInputStreamPump&gt; pump;</span>
<a href="#l23.29"></a><span id="l23.29">         rv = NS_NewInputStreamPump(getter_AddRefs(pump), fileStream,</span>
<a href="#l23.30"></a><span id="l23.30" class="difflineminus">-                                   nsInt64(offset), nsInt64(size));</span>
<a href="#l23.31"></a><span id="l23.31" class="difflineplus">+                                   offset, (PRInt64) size);</span>
<a href="#l23.32"></a><span id="l23.32">         if (NS_SUCCEEDED(rv))</span>
<a href="#l23.33"></a><span id="l23.33">           rv = pump-&gt;AsyncRead(cacheListener, m_channelContext);</span>
<a href="#l23.34"></a><span id="l23.34"> </span>
<a href="#l23.35"></a><span id="l23.35">         NS_RELEASE(cacheListener);</span>
<a href="#l23.36"></a><span id="l23.36"> </span>
<a href="#l23.37"></a><span id="l23.37">         if (NS_SUCCEEDED(rv)) // ONLY if we succeeded in actually starting the read should we return</span>
<a href="#l23.38"></a><span id="l23.38">         {</span>
<a href="#l23.39"></a><span id="l23.39">           // if the msg is unread, we should mark it read on the server. This lets</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mailnews/imap/src/nsImapService.cpp</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapService.cpp</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -2046,18 +2046,17 @@ nsresult nsImapService::OfflineAppendFro</span>
<a href="#l24.4"></a><span id="l24.4">           nsCOMPtr&lt;nsIMsgDBHdr&gt; fakeHdr;</span>
<a href="#l24.5"></a><span id="l24.5">           msgParser-&gt;FinishHeader();</span>
<a href="#l24.6"></a><span id="l24.6">           msgParser-&gt;GetNewMsgHdr(getter_AddRefs(fakeHdr));</span>
<a href="#l24.7"></a><span id="l24.7">           if (fakeHdr)</span>
<a href="#l24.8"></a><span id="l24.8">           {</span>
<a href="#l24.9"></a><span id="l24.9">             if (NS_SUCCEEDED(rv) &amp;&amp; fakeHdr)</span>
<a href="#l24.10"></a><span id="l24.10">             {</span>
<a href="#l24.11"></a><span id="l24.11">               PRUint32 resultFlags;</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-              nsInt64 tellPos = curOfflineStorePos;</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineminus">-              fakeHdr-&gt;SetMessageOffset((PRUint32) tellPos);</span>
<a href="#l24.14"></a><span id="l24.14" class="difflineplus">+              fakeHdr-&gt;SetMessageOffset(curOfflineStorePos);</span>
<a href="#l24.15"></a><span id="l24.15">               fakeHdr-&gt;OrFlags(nsMsgMessageFlags::Offline | nsMsgMessageFlags::Read, &amp;resultFlags);</span>
<a href="#l24.16"></a><span id="l24.16">               fakeHdr-&gt;SetOfflineMessageSize(fileSize);</span>
<a href="#l24.17"></a><span id="l24.17">               destDB-&gt;AddNewHdrToDB(fakeHdr, PR_TRUE /* notify */);</span>
<a href="#l24.18"></a><span id="l24.18">               aDstFolder-&gt;SetFlag(nsMsgFolderFlags::OfflineEvents);</span>
<a href="#l24.19"></a><span id="l24.19">             }</span>
<a href="#l24.20"></a><span id="l24.20">           }</span>
<a href="#l24.21"></a><span id="l24.21">           // tell the listener we're done.</span>
<a href="#l24.22"></a><span id="l24.22">           inputStream-&gt;Close();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1">new file mode 100644</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineminus">--- /dev/null</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineplus">+++ b/mailnews/imap/test/unit/test_largeOfflineStore.js</span>
<a href="#l25.4"></a><span id="l25.4" class="difflineat">@@ -0,0 +1,140 @@</span>
<a href="#l25.5"></a><span id="l25.5" class="difflineplus">+/* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l25.6"></a><span id="l25.6" class="difflineplus">+/*</span>
<a href="#l25.7"></a><span id="l25.7" class="difflineplus">+ * Test to ensure that downloadAllForOffline works correctly for large imap</span>
<a href="#l25.8"></a><span id="l25.8" class="difflineplus">+ * stores, i.e., &gt; 4GB.</span>
<a href="#l25.9"></a><span id="l25.9" class="difflineplus">+ */</span>
<a href="#l25.10"></a><span id="l25.10" class="difflineplus">+</span>
<a href="#l25.11"></a><span id="l25.11" class="difflineplus">+var gIMAPDaemon, gServer, gIMAPIncomingServer;</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineplus">+</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineplus">+const gIMAPService = Cc[&quot;@mozilla.org/messenger/messageservice;1?type=imap&quot;]</span>
<a href="#l25.14"></a><span id="l25.14" class="difflineplus">+                       .getService(Ci.nsIMsgMessageService);</span>
<a href="#l25.15"></a><span id="l25.15" class="difflineplus">+</span>
<a href="#l25.16"></a><span id="l25.16" class="difflineplus">+load(&quot;../../mailnews/resources/messageGenerator.js&quot;);</span>
<a href="#l25.17"></a><span id="l25.17" class="difflineplus">+</span>
<a href="#l25.18"></a><span id="l25.18" class="difflineplus">+var gDownloadedOnce = false;</span>
<a href="#l25.19"></a><span id="l25.19" class="difflineplus">+var gIMAPInbox;</span>
<a href="#l25.20"></a><span id="l25.20" class="difflineplus">+var gOfflineStoreSize;</span>
<a href="#l25.21"></a><span id="l25.21" class="difflineplus">+</span>
<a href="#l25.22"></a><span id="l25.22" class="difflineplus">+function run_test()</span>
<a href="#l25.23"></a><span id="l25.23" class="difflineplus">+{</span>
<a href="#l25.24"></a><span id="l25.24" class="difflineplus">+  loadLocalMailAccount();</span>
<a href="#l25.25"></a><span id="l25.25" class="difflineplus">+</span>
<a href="#l25.26"></a><span id="l25.26" class="difflineplus">+  /*</span>
<a href="#l25.27"></a><span id="l25.27" class="difflineplus">+   * Set up an IMAP server.</span>
<a href="#l25.28"></a><span id="l25.28" class="difflineplus">+   */</span>
<a href="#l25.29"></a><span id="l25.29" class="difflineplus">+  gIMAPDaemon = new imapDaemon();</span>
<a href="#l25.30"></a><span id="l25.30" class="difflineplus">+  gServer = makeServer(gIMAPDaemon, &quot;&quot;);</span>
<a href="#l25.31"></a><span id="l25.31" class="difflineplus">+  gIMAPIncomingServer = createLocalIMAPServer();</span>
<a href="#l25.32"></a><span id="l25.32" class="difflineplus">+  gIMAPIncomingServer.maximumConnectionsNumber = 1;</span>
<a href="#l25.33"></a><span id="l25.33" class="difflineplus">+</span>
<a href="#l25.34"></a><span id="l25.34" class="difflineplus">+  // pref tuning: one connection only, turn off notifications</span>
<a href="#l25.35"></a><span id="l25.35" class="difflineplus">+  let prefBranch = Cc[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l25.36"></a><span id="l25.36" class="difflineplus">+                     .getService(Ci.nsIPrefBranch);</span>
<a href="#l25.37"></a><span id="l25.37" class="difflineplus">+  prefBranch.setBoolPref(&quot;mail.biff.play_sound&quot;, false);</span>
<a href="#l25.38"></a><span id="l25.38" class="difflineplus">+  prefBranch.setBoolPref(&quot;mail.biff.show_alert&quot;, false);</span>
<a href="#l25.39"></a><span id="l25.39" class="difflineplus">+  prefBranch.setBoolPref(&quot;mail.biff.show_tray_icon&quot;, false);</span>
<a href="#l25.40"></a><span id="l25.40" class="difflineplus">+  prefBranch.setBoolPref(&quot;mail.biff.animate_dock_icon&quot;, false);</span>
<a href="#l25.41"></a><span id="l25.41" class="difflineplus">+</span>
<a href="#l25.42"></a><span id="l25.42" class="difflineplus">+  let inbox = gIMAPDaemon.getMailbox(&quot;INBOX&quot;);</span>
<a href="#l25.43"></a><span id="l25.43" class="difflineplus">+</span>
<a href="#l25.44"></a><span id="l25.44" class="difflineplus">+  let ioService = Cc[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l25.45"></a><span id="l25.45" class="difflineplus">+      .getService(Ci.nsIIOService);</span>
<a href="#l25.46"></a><span id="l25.46" class="difflineplus">+</span>
<a href="#l25.47"></a><span id="l25.47" class="difflineplus">+  // &quot;Master&quot; do_test_pending(), paired with a do_test_finished() at the end of</span>
<a href="#l25.48"></a><span id="l25.48" class="difflineplus">+  // all the operations.</span>
<a href="#l25.49"></a><span id="l25.49" class="difflineplus">+  do_test_pending();</span>
<a href="#l25.50"></a><span id="l25.50" class="difflineplus">+</span>
<a href="#l25.51"></a><span id="l25.51" class="difflineplus">+  // Create a couple test messages.</span>
<a href="#l25.52"></a><span id="l25.52" class="difflineplus">+  let messages = [];</span>
<a href="#l25.53"></a><span id="l25.53" class="difflineplus">+  let messageGenerator = new MessageGenerator();</span>
<a href="#l25.54"></a><span id="l25.54" class="difflineplus">+  let scenarioFactory = new MessageScenarioFactory(messageGenerator);</span>
<a href="#l25.55"></a><span id="l25.55" class="difflineplus">+</span>
<a href="#l25.56"></a><span id="l25.56" class="difflineplus">+  messages = messages.concat(scenarioFactory.directReply(2));</span>
<a href="#l25.57"></a><span id="l25.57" class="difflineplus">+  let dataUri = ioService.newURI(&quot;data:text/plain;base64,&quot; +</span>
<a href="#l25.58"></a><span id="l25.58" class="difflineplus">+                   btoa(messages[0].toMessageString()),</span>
<a href="#l25.59"></a><span id="l25.59" class="difflineplus">+                   null, null);</span>
<a href="#l25.60"></a><span id="l25.60" class="difflineplus">+  let imapMsg = new imapMessage(dataUri.spec, inbox.uidnext++, []);</span>
<a href="#l25.61"></a><span id="l25.61" class="difflineplus">+  inbox.addMessage(imapMsg);</span>
<a href="#l25.62"></a><span id="l25.62" class="difflineplus">+</span>
<a href="#l25.63"></a><span id="l25.63" class="difflineplus">+  dataUri = ioService.newURI(&quot;data:text/plain;base64,&quot; +</span>
<a href="#l25.64"></a><span id="l25.64" class="difflineplus">+                   btoa(messages[1].toMessageString()),</span>
<a href="#l25.65"></a><span id="l25.65" class="difflineplus">+                   null, null);</span>
<a href="#l25.66"></a><span id="l25.66" class="difflineplus">+  imapMsg = new imapMessage(dataUri.spec, inbox.uidnext++, []);</span>
<a href="#l25.67"></a><span id="l25.67" class="difflineplus">+  inbox.addMessage(imapMsg);</span>
<a href="#l25.68"></a><span id="l25.68" class="difflineplus">+</span>
<a href="#l25.69"></a><span id="l25.69" class="difflineplus">+  // Get the IMAP inbox...</span>
<a href="#l25.70"></a><span id="l25.70" class="difflineplus">+  let rootFolder = gIMAPIncomingServer.rootFolder;</span>
<a href="#l25.71"></a><span id="l25.71" class="difflineplus">+  let freeDiskSpace = rootFolder.filePath.diskSpaceAvailable;</span>
<a href="#l25.72"></a><span id="l25.72" class="difflineplus">+  // check that there are at least 8GB free before consuming 4GB disk space.</span>
<a href="#l25.73"></a><span id="l25.73" class="difflineplus">+  if (freeDiskSpace &lt; 0x200000000) {</span>
<a href="#l25.74"></a><span id="l25.74" class="difflineplus">+    dump(&quot;not enough free disk space\n&quot;);</span>
<a href="#l25.75"></a><span id="l25.75" class="difflineplus">+    endTest();</span>
<a href="#l25.76"></a><span id="l25.76" class="difflineplus">+    return;</span>
<a href="#l25.77"></a><span id="l25.77" class="difflineplus">+  }</span>
<a href="#l25.78"></a><span id="l25.78" class="difflineplus">+</span>
<a href="#l25.79"></a><span id="l25.79" class="difflineplus">+  gIMAPInbox = rootFolder.getFolderWithFlags(Ci.nsMsgFolderFlags.Inbox);</span>
<a href="#l25.80"></a><span id="l25.80" class="difflineplus">+  let outputStream = gIMAPInbox.offlineStoreOutputStream</span>
<a href="#l25.81"></a><span id="l25.81" class="difflineplus">+                               .QueryInterface(Ci.nsISeekableStream);</span>
<a href="#l25.82"></a><span id="l25.82" class="difflineplus">+  // seek past 4GB.</span>
<a href="#l25.83"></a><span id="l25.83" class="difflineplus">+  outputStream.seek(0, 0x10000000f);</span>
<a href="#l25.84"></a><span id="l25.84" class="difflineplus">+  outputStream.write(&quot;from\r\n&quot;, 6);</span>
<a href="#l25.85"></a><span id="l25.85" class="difflineplus">+  outputStream.close();</span>
<a href="#l25.86"></a><span id="l25.86" class="difflineplus">+  gOfflineStoreSize = gIMAPInbox.filePath.fileSize;</span>
<a href="#l25.87"></a><span id="l25.87" class="difflineplus">+  // ...and download for offline use.</span>
<a href="#l25.88"></a><span id="l25.88" class="difflineplus">+  gIMAPInbox.downloadAllForOffline(UrlListener, null);</span>
<a href="#l25.89"></a><span id="l25.89" class="difflineplus">+}</span>
<a href="#l25.90"></a><span id="l25.90" class="difflineplus">+</span>
<a href="#l25.91"></a><span id="l25.91" class="difflineplus">+var UrlListener =</span>
<a href="#l25.92"></a><span id="l25.92" class="difflineplus">+{</span>
<a href="#l25.93"></a><span id="l25.93" class="difflineplus">+  OnStartRunningUrl: function(url) { },</span>
<a href="#l25.94"></a><span id="l25.94" class="difflineplus">+  OnStopRunningUrl: function(url, rc)</span>
<a href="#l25.95"></a><span id="l25.95" class="difflineplus">+  {</span>
<a href="#l25.96"></a><span id="l25.96" class="difflineplus">+    // Check for ok status.</span>
<a href="#l25.97"></a><span id="l25.97" class="difflineplus">+    do_check_eq(rc, 0);</span>
<a href="#l25.98"></a><span id="l25.98" class="difflineplus">+</span>
<a href="#l25.99"></a><span id="l25.99" class="difflineplus">+    if (!gDownloadedOnce) {</span>
<a href="#l25.100"></a><span id="l25.100" class="difflineplus">+      gDownloadedOnce = true;</span>
<a href="#l25.101"></a><span id="l25.101" class="difflineplus">+      gIMAPInbox.downloadAllForOffline(UrlListener, null);</span>
<a href="#l25.102"></a><span id="l25.102" class="difflineplus">+      return;</span>
<a href="#l25.103"></a><span id="l25.103" class="difflineplus">+    }</span>
<a href="#l25.104"></a><span id="l25.104" class="difflineplus">+    else {</span>
<a href="#l25.105"></a><span id="l25.105" class="difflineplus">+      // verify that the message headers have the offline flag set.</span>
<a href="#l25.106"></a><span id="l25.106" class="difflineplus">+      let msgEnumerator = gIMAPInbox.msgDatabase.EnumerateMessages();</span>
<a href="#l25.107"></a><span id="l25.107" class="difflineplus">+      let offset = new Object;</span>
<a href="#l25.108"></a><span id="l25.108" class="difflineplus">+      let size = new Object;</span>
<a href="#l25.109"></a><span id="l25.109" class="difflineplus">+      while (msgEnumerator.hasMoreElements())</span>
<a href="#l25.110"></a><span id="l25.110" class="difflineplus">+      {</span>
<a href="#l25.111"></a><span id="l25.111" class="difflineplus">+        let header = msgEnumerator.getNext();</span>
<a href="#l25.112"></a><span id="l25.112" class="difflineplus">+        // Verify that each message has been downloaded and looks OK.</span>
<a href="#l25.113"></a><span id="l25.113" class="difflineplus">+        if (header instanceof Components.interfaces.nsIMsgDBHdr &amp;&amp;</span>
<a href="#l25.114"></a><span id="l25.114" class="difflineplus">+            (header.flags &amp; Ci.nsMsgMessageFlags.Offline))</span>
<a href="#l25.115"></a><span id="l25.115" class="difflineplus">+          gIMAPInbox.getOfflineFileStream(header.messageKey, offset, size).close();</span>
<a href="#l25.116"></a><span id="l25.116" class="difflineplus">+        else</span>
<a href="#l25.117"></a><span id="l25.117" class="difflineplus">+          do_throw(&quot;Message not downloaded for offline use&quot;);</span>
<a href="#l25.118"></a><span id="l25.118" class="difflineplus">+        dump(&quot;msg hdr offset = &quot; + offset.value + &quot;\n&quot;);</span>
<a href="#l25.119"></a><span id="l25.119" class="difflineplus">+      }</span>
<a href="#l25.120"></a><span id="l25.120" class="difflineplus">+      let offlineStoreSize = gIMAPInbox.filePath.fileSize;</span>
<a href="#l25.121"></a><span id="l25.121" class="difflineplus">+      dump(&quot;offline store size = &quot; + offlineStoreSize + &quot;\n&quot;);</span>
<a href="#l25.122"></a><span id="l25.122" class="difflineplus">+      // Make sure offline store grew (i.e., we're not writing over data).</span>
<a href="#l25.123"></a><span id="l25.123" class="difflineplus">+      do_check_true(offlineStoreSize &gt; gOfflineStoreSize);</span>
<a href="#l25.124"></a><span id="l25.124" class="difflineplus">+      // free up disk space - if you want to look at the file after running</span>
<a href="#l25.125"></a><span id="l25.125" class="difflineplus">+      // this test, comment out this line.</span>
<a href="#l25.126"></a><span id="l25.126" class="difflineplus">+      gIMAPInbox.filePath.remove(false);</span>
<a href="#l25.127"></a><span id="l25.127" class="difflineplus">+    }</span>
<a href="#l25.128"></a><span id="l25.128" class="difflineplus">+    try {</span>
<a href="#l25.129"></a><span id="l25.129" class="difflineplus">+    do_timeout(1000, endTest);</span>
<a href="#l25.130"></a><span id="l25.130" class="difflineplus">+    } catch(ex) {dump(ex);}</span>
<a href="#l25.131"></a><span id="l25.131" class="difflineplus">+  }</span>
<a href="#l25.132"></a><span id="l25.132" class="difflineplus">+};</span>
<a href="#l25.133"></a><span id="l25.133" class="difflineplus">+</span>
<a href="#l25.134"></a><span id="l25.134" class="difflineplus">+function endTest()</span>
<a href="#l25.135"></a><span id="l25.135" class="difflineplus">+{</span>
<a href="#l25.136"></a><span id="l25.136" class="difflineplus">+  gIMAPIncomingServer.closeCachedConnections();</span>
<a href="#l25.137"></a><span id="l25.137" class="difflineplus">+  gServer.stop();</span>
<a href="#l25.138"></a><span id="l25.138" class="difflineplus">+</span>
<a href="#l25.139"></a><span id="l25.139" class="difflineplus">+  var thread = gThreadManager.currentThread;</span>
<a href="#l25.140"></a><span id="l25.140" class="difflineplus">+  while (thread.hasPendingEvents())</span>
<a href="#l25.141"></a><span id="l25.141" class="difflineplus">+    thread.processNextEvent(true);</span>
<a href="#l25.142"></a><span id="l25.142" class="difflineplus">+</span>
<a href="#l25.143"></a><span id="l25.143" class="difflineplus">+  do_test_finished();</span>
<a href="#l25.144"></a><span id="l25.144" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/mailnews/local/src/nsLocalMailFolder.cpp</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/mailnews/local/src/nsLocalMailFolder.cpp</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -3771,17 +3771,17 @@ nsMsgLocalMailFolder::GetFolderScanState</span>
<a href="#l26.4"></a><span id="l26.4">   }</span>
<a href="#l26.5"></a><span id="l26.5">   return rv;</span>
<a href="#l26.6"></a><span id="l26.6"> }</span>
<a href="#l26.7"></a><span id="l26.7"> </span>
<a href="#l26.8"></a><span id="l26.8"> NS_IMETHODIMP</span>
<a href="#l26.9"></a><span id="l26.9"> nsMsgLocalMailFolder::GetUidlFromFolder(nsLocalFolderScanState *aState, nsIMsgDBHdr *aMsgDBHdr)</span>
<a href="#l26.10"></a><span id="l26.10"> {</span>
<a href="#l26.11"></a><span id="l26.11">   nsresult rv;</span>
<a href="#l26.12"></a><span id="l26.12" class="difflineminus">-  PRUint32 messageOffset;</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineplus">+  PRUint64 messageOffset;</span>
<a href="#l26.14"></a><span id="l26.14">   PRBool more = PR_FALSE;</span>
<a href="#l26.15"></a><span id="l26.15">   PRUint32 size = 0, len = 0;</span>
<a href="#l26.16"></a><span id="l26.16">   const char *accountKey = nsnull;</span>
<a href="#l26.17"></a><span id="l26.17"> </span>
<a href="#l26.18"></a><span id="l26.18">   aMsgDBHdr-&gt;GetMessageOffset(&amp;messageOffset);</span>
<a href="#l26.19"></a><span id="l26.19">   rv = aState-&gt;m_seekableStream-&gt;Seek(PR_SEEK_SET, messageOffset);</span>
<a href="#l26.20"></a><span id="l26.20">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l26.21"></a><span id="l26.21"> </span>
<a href="#l26.22"></a><span id="l26.22" class="difflineat">@@ -3931,17 +3931,17 @@ NS_IMETHODIMP nsMsgLocalMailFolder::Fetc</span>
<a href="#l26.23"></a><span id="l26.23">     nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l26.24"></a><span id="l26.24">     nsCString prevBody;</span>
<a href="#l26.25"></a><span id="l26.25">     rv = GetMessageHeader(aKeysToFetch[i], getter_AddRefs(msgHdr));</span>
<a href="#l26.26"></a><span id="l26.26">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.27"></a><span id="l26.27">     // ignore messages that already have a preview body.</span>
<a href="#l26.28"></a><span id="l26.28">     msgHdr-&gt;GetStringProperty(&quot;preview&quot;, getter_Copies(prevBody));</span>
<a href="#l26.29"></a><span id="l26.29">     if (!prevBody.IsEmpty())</span>
<a href="#l26.30"></a><span id="l26.30">       continue;</span>
<a href="#l26.31"></a><span id="l26.31" class="difflineminus">-    PRUint32 messageOffset;</span>
<a href="#l26.32"></a><span id="l26.32" class="difflineplus">+    PRUint64 messageOffset;</span>
<a href="#l26.33"></a><span id="l26.33"> </span>
<a href="#l26.34"></a><span id="l26.34">     msgHdr-&gt;GetMessageOffset(&amp;messageOffset);</span>
<a href="#l26.35"></a><span id="l26.35">     nsCOMPtr &lt;nsISeekableStream&gt; seekableStream = do_QueryInterface(inputStream);</span>
<a href="#l26.36"></a><span id="l26.36">     if (seekableStream)</span>
<a href="#l26.37"></a><span id="l26.37">       rv = seekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_CUR, messageOffset);</span>
<a href="#l26.38"></a><span id="l26.38">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l26.39"></a><span id="l26.39">     rv = GetMsgPreviewTextFromStream(msgHdr, inputStream);</span>
<a href="#l26.40"></a><span id="l26.40"> </span>
<a href="#l26.41"></a><span id="l26.41" class="difflineat">@@ -3992,21 +3992,21 @@ nsresult nsMsgLocalMailFolder::ChangeKey</span>
<a href="#l26.42"></a><span id="l26.42">     // x-mozilla-keys header is added. In that case, we set a property</span>
<a href="#l26.43"></a><span id="l26.43">     // on the header, which the compaction code will check.</span>
<a href="#l26.44"></a><span id="l26.44"> </span>
<a href="#l26.45"></a><span id="l26.45">     // don't return out of the for loop - otherwise, we won't call EndBatch();</span>
<a href="#l26.46"></a><span id="l26.46">     for(PRUint32 i = 0; i &lt; count; i++) // for each message</span>
<a href="#l26.47"></a><span id="l26.47">     {</span>
<a href="#l26.48"></a><span id="l26.48">       nsCOMPtr&lt;nsIMsgDBHdr&gt; message = do_QueryElementAt(aMessages, i, &amp;rv);</span>
<a href="#l26.49"></a><span id="l26.49">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.50"></a><span id="l26.50" class="difflineminus">-      PRUint32 messageOffset;</span>
<a href="#l26.51"></a><span id="l26.51" class="difflineplus">+      PRUint64 messageOffset;</span>
<a href="#l26.52"></a><span id="l26.52">       message-&gt;GetMessageOffset(&amp;messageOffset);</span>
<a href="#l26.53"></a><span id="l26.53">       PRUint32 statusOffset = 0;</span>
<a href="#l26.54"></a><span id="l26.54">       (void)message-&gt;GetStatusOffset(&amp;statusOffset);</span>
<a href="#l26.55"></a><span id="l26.55" class="difflineminus">-      PRUint32 desiredOffset = messageOffset + statusOffset;</span>
<a href="#l26.56"></a><span id="l26.56" class="difflineplus">+      PRUint64 desiredOffset = messageOffset + statusOffset;</span>
<a href="#l26.57"></a><span id="l26.57"> </span>
<a href="#l26.58"></a><span id="l26.58">       nsTArray&lt;nsCString&gt; keywordArray;</span>
<a href="#l26.59"></a><span id="l26.59">       ParseString(aKeywords, ' ', keywordArray);</span>
<a href="#l26.60"></a><span id="l26.60">       for (PRUint32 j = 0; j &lt; keywordArray.Length(); j++)</span>
<a href="#l26.61"></a><span id="l26.61">       {</span>
<a href="#l26.62"></a><span id="l26.62">         nsCAutoString header;</span>
<a href="#l26.63"></a><span id="l26.63">         nsCAutoString keywords;</span>
<a href="#l26.64"></a><span id="l26.64">         PRBool done = PR_FALSE;</span>
<a href="#l26.65"></a><span id="l26.65" class="difflineat">@@ -4014,17 +4014,17 @@ nsresult nsMsgLocalMailFolder::ChangeKey</span>
<a href="#l26.66"></a><span id="l26.66">         nsCAutoString keywordToWrite(&quot; &quot;);</span>
<a href="#l26.67"></a><span id="l26.67"> </span>
<a href="#l26.68"></a><span id="l26.68">         keywordToWrite.Append(keywordArray[j]);</span>
<a href="#l26.69"></a><span id="l26.69">         seekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET, desiredOffset);</span>
<a href="#l26.70"></a><span id="l26.70">         // need to reset lineBuffer, which is cheaper than creating a new one.</span>
<a href="#l26.71"></a><span id="l26.71">         lineBuffer-&gt;start = lineBuffer-&gt;end = lineBuffer-&gt;buf;</span>
<a href="#l26.72"></a><span id="l26.72">         PRBool inKeywordHeader = PR_FALSE;</span>
<a href="#l26.73"></a><span id="l26.73">         PRBool foundKeyword = PR_FALSE;</span>
<a href="#l26.74"></a><span id="l26.74" class="difflineminus">-        PRUint32 offsetToAddKeyword = 0;</span>
<a href="#l26.75"></a><span id="l26.75" class="difflineplus">+        PRUint64 offsetToAddKeyword = 0;</span>
<a href="#l26.76"></a><span id="l26.76">         PRBool more;</span>
<a href="#l26.77"></a><span id="l26.77">         message-&gt;GetMessageSize(&amp;len);</span>
<a href="#l26.78"></a><span id="l26.78">         // loop through</span>
<a href="#l26.79"></a><span id="l26.79">         while (!done)</span>
<a href="#l26.80"></a><span id="l26.80">         {</span>
<a href="#l26.81"></a><span id="l26.81">           PRInt64 lineStartPos;</span>
<a href="#l26.82"></a><span id="l26.82">           seekableStream-&gt;Tell(&amp;lineStartPos);</span>
<a href="#l26.83"></a><span id="l26.83">           // we need to adjust the linestart pos by how much extra the line</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/mailnews/local/src/nsParseMailbox.cpp</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/mailnews/local/src/nsParseMailbox.cpp</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -1798,17 +1798,17 @@ PRInt32 nsParseNewMailState::PublishMsgH</span>
<a href="#l27.4"></a><span id="l27.4">       m_newMsgHdr-&gt;OrFlags(nsMsgMessageFlags::New, &amp;newFlags);</span>
<a href="#l27.5"></a><span id="l27.5"> </span>
<a href="#l27.6"></a><span id="l27.6">     if (!m_disableFilters)</span>
<a href="#l27.7"></a><span id="l27.7">     {</span>
<a href="#l27.8"></a><span id="l27.8">       // seems like the code that's writing to disk should do</span>
<a href="#l27.9"></a><span id="l27.9">       // the flushing...</span>
<a href="#l27.10"></a><span id="l27.10">       // flush the inbox because filters will read from disk</span>
<a href="#l27.11"></a><span id="l27.11">       // m_inboxFileStream-&gt;Flush();</span>
<a href="#l27.12"></a><span id="l27.12" class="difflineminus">-      PRUint32 msgOffset;</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineplus">+      PRUint64 msgOffset;</span>
<a href="#l27.14"></a><span id="l27.14">       (void) m_newMsgHdr-&gt;GetMessageOffset(&amp;msgOffset);</span>
<a href="#l27.15"></a><span id="l27.15">       m_curHdrOffset = msgOffset;</span>
<a href="#l27.16"></a><span id="l27.16"> </span>
<a href="#l27.17"></a><span id="l27.17">       nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l27.18"></a><span id="l27.18">       nsresult rv = m_rootFolder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l27.19"></a><span id="l27.19">       NS_ENSURE_SUCCESS(rv, 0);</span>
<a href="#l27.20"></a><span id="l27.20">       PRInt32 duplicateAction;</span>
<a href="#l27.21"></a><span id="l27.21">       server-&gt;GetIncomingDuplicateAction(&amp;duplicateAction);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/mailnews/local/src/nsParseMailbox.h</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/mailnews/local/src/nsParseMailbox.h</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -102,19 +102,19 @@ public:</span>
<a href="#l28.4"></a><span id="l28.4"> </span>
<a href="#l28.5"></a><span id="l28.5">   nsCOMPtr&lt;nsIMsgHeaderParser&gt; m_HeaderAddressParser;</span>
<a href="#l28.6"></a><span id="l28.6"> </span>
<a href="#l28.7"></a><span id="l28.7">   nsCOMPtr&lt;nsIMsgDBHdr&gt; m_newMsgHdr; /* current message header we're building */</span>
<a href="#l28.8"></a><span id="l28.8">   nsCOMPtr&lt;nsIMsgDatabase&gt;  m_mailDB;</span>
<a href="#l28.9"></a><span id="l28.9">   nsCOMPtr&lt;nsIMsgDatabase&gt; m_backupMailDB;</span>
<a href="#l28.10"></a><span id="l28.10"> </span>
<a href="#l28.11"></a><span id="l28.11">   nsMailboxParseState   m_state;</span>
<a href="#l28.12"></a><span id="l28.12" class="difflineminus">-  PRUint32              m_position;</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineminus">-  PRUint32              m_envelope_pos;</span>
<a href="#l28.14"></a><span id="l28.14" class="difflineminus">-  PRUint32              m_headerstartpos;</span>
<a href="#l28.15"></a><span id="l28.15" class="difflineplus">+  PRUint64              m_position;</span>
<a href="#l28.16"></a><span id="l28.16" class="difflineplus">+  PRUint64              m_envelope_pos;</span>
<a href="#l28.17"></a><span id="l28.17" class="difflineplus">+  PRUint64              m_headerstartpos;</span>
<a href="#l28.18"></a><span id="l28.18"> </span>
<a href="#l28.19"></a><span id="l28.19">   nsByteArray           m_headers;</span>
<a href="#l28.20"></a><span id="l28.20"> </span>
<a href="#l28.21"></a><span id="l28.21">   nsByteArray           m_envelope;</span>
<a href="#l28.22"></a><span id="l28.22"> </span>
<a href="#l28.23"></a><span id="l28.23">   struct message_header m_message_id;</span>
<a href="#l28.24"></a><span id="l28.24">   struct message_header m_references;</span>
<a href="#l28.25"></a><span id="l28.25">   struct message_header m_date;</span>
<a href="#l28.26"></a><span id="l28.26" class="difflineat">@@ -287,17 +287,17 @@ protected:</span>
<a href="#l28.27"></a><span id="l28.27">   nsCOMPtr &lt;nsILocalFile&gt;    m_inboxFile;</span>
<a href="#l28.28"></a><span id="l28.28">   PRBool        m_disableFilters;</span>
<a href="#l28.29"></a><span id="l28.29">   PRBool        m_downloadingToTempFile;</span>
<a href="#l28.30"></a><span id="l28.30">   PRUint32      m_ibuffer_fp;</span>
<a href="#l28.31"></a><span id="l28.31">   char          *m_ibuffer;</span>
<a href="#l28.32"></a><span id="l28.32">   PRUint32      m_ibuffer_size;</span>
<a href="#l28.33"></a><span id="l28.33">   // used for applying move filters, because in the case of using a temporary</span>
<a href="#l28.34"></a><span id="l28.34">   // download file, the offset/key in the msg hdr is not right.</span>
<a href="#l28.35"></a><span id="l28.35" class="difflineminus">-  PRUint32      m_curHdrOffset;</span>
<a href="#l28.36"></a><span id="l28.36" class="difflineplus">+  PRUint64      m_curHdrOffset;</span>
<a href="#l28.37"></a><span id="l28.37"> </span>
<a href="#l28.38"></a><span id="l28.38">   // we have to apply the reply/forward filters in a second pass, after</span>
<a href="#l28.39"></a><span id="l28.39">   // msg quarantining and moving to other local folders, so we remember the</span>
<a href="#l28.40"></a><span id="l28.40">   // info we'll need to apply them with these vars.</span>
<a href="#l28.41"></a><span id="l28.41">   // these need to be arrays in case we have multiple reply/forward filters.</span>
<a href="#l28.42"></a><span id="l28.42">   nsCStringArray     m_forwardTo;</span>
<a href="#l28.43"></a><span id="l28.43">   nsCStringArray     m_replyTemplateUri;</span>
<a href="#l28.44"></a><span id="l28.44">   nsCOMPtr &lt;nsIMsgDBHdr&gt; m_msgToForwardOrReply;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/mailnews/news/src/nsNNTPProtocol.cpp</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/mailnews/news/src/nsNNTPProtocol.cpp</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -845,17 +845,18 @@ PRBool nsNNTPProtocol::ReadFromLocalCach</span>
<a href="#l29.4"></a><span id="l29.4"> </span>
<a href="#l29.5"></a><span id="l29.5">   if (msgIsInLocalCache)</span>
<a href="#l29.6"></a><span id="l29.6">   {</span>
<a href="#l29.7"></a><span id="l29.7">     nsCOMPtr &lt;nsIMsgFolder&gt; folder = do_QueryInterface(m_newsFolder);</span>
<a href="#l29.8"></a><span id="l29.8">     if (folder &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l29.9"></a><span id="l29.9">     {</span>
<a href="#l29.10"></a><span id="l29.10">     // we want to create a file channel and read the msg from there.</span>
<a href="#l29.11"></a><span id="l29.11">       nsCOMPtr&lt;nsIInputStream&gt; fileStream;</span>
<a href="#l29.12"></a><span id="l29.12" class="difflineminus">-      PRUint32 offset=0, size=0;</span>
<a href="#l29.13"></a><span id="l29.13" class="difflineplus">+      PRUint64 offset=0;</span>
<a href="#l29.14"></a><span id="l29.14" class="difflineplus">+      PRUint32 size=0;</span>
<a href="#l29.15"></a><span id="l29.15">       rv = folder-&gt;GetOfflineFileStream(m_key, &amp;offset, &amp;size, getter_AddRefs(fileStream));</span>
<a href="#l29.16"></a><span id="l29.16"> </span>
<a href="#l29.17"></a><span id="l29.17">       // get the file stream from the folder, somehow (through the message or</span>
<a href="#l29.18"></a><span id="l29.18">       // folder sink?) We also need to set the transfer offset to the message offset</span>
<a href="#l29.19"></a><span id="l29.19">       if (fileStream &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l29.20"></a><span id="l29.20">       {</span>
<a href="#l29.21"></a><span id="l29.21">         // dougt - This may break the ablity to &quot;cancel&quot; a read from offline mail reading.</span>
<a href="#l29.22"></a><span id="l29.22">         // fileChannel-&gt;SetLoadGroup(m_loadGroup);</span>
<a href="#l29.23"></a><span id="l29.23" class="difflineat">@@ -865,20 +866,20 @@ PRBool nsNNTPProtocol::ReadFromLocalCach</span>
<a href="#l29.24"></a><span id="l29.24">         nsNntpCacheStreamListener * cacheListener = new nsNntpCacheStreamListener();</span>
<a href="#l29.25"></a><span id="l29.25">         if (!cacheListener)</span>
<a href="#l29.26"></a><span id="l29.26">           return PR_FALSE;</span>
<a href="#l29.27"></a><span id="l29.27"> </span>
<a href="#l29.28"></a><span id="l29.28">         NS_ADDREF(cacheListener);</span>
<a href="#l29.29"></a><span id="l29.29">         cacheListener-&gt;Init(m_channelListener, static_cast&lt;nsIChannel *&gt;(this), mailnewsUrl);</span>
<a href="#l29.30"></a><span id="l29.30"> </span>
<a href="#l29.31"></a><span id="l29.31">         // create a stream pump that will async read the specified amount of data.</span>
<a href="#l29.32"></a><span id="l29.32" class="difflineminus">-        // XXX make offset and size 64-bit ints</span>
<a href="#l29.33"></a><span id="l29.33" class="difflineplus">+        // XXX make size 64-bit int</span>
<a href="#l29.34"></a><span id="l29.34">         nsCOMPtr&lt;nsIInputStreamPump&gt; pump;</span>
<a href="#l29.35"></a><span id="l29.35">         rv = NS_NewInputStreamPump(getter_AddRefs(pump),</span>
<a href="#l29.36"></a><span id="l29.36" class="difflineminus">-                                   fileStream, nsInt64(offset), nsInt64(size));</span>
<a href="#l29.37"></a><span id="l29.37" class="difflineplus">+                                   fileStream, offset, (PRInt64) size);</span>
<a href="#l29.38"></a><span id="l29.38">         if (NS_SUCCEEDED(rv))</span>
<a href="#l29.39"></a><span id="l29.39">           rv = pump-&gt;AsyncRead(cacheListener, m_channelContext);</span>
<a href="#l29.40"></a><span id="l29.40"> </span>
<a href="#l29.41"></a><span id="l29.41">         NS_RELEASE(cacheListener);</span>
<a href="#l29.42"></a><span id="l29.42"> </span>
<a href="#l29.43"></a><span id="l29.43">         if (NS_SUCCEEDED(rv)) // ONLY if we succeeded in actually starting the read should we return</span>
<a href="#l29.44"></a><span id="l29.44">         {</span>
<a href="#l29.45"></a><span id="l29.45">           m_ContentType.Truncate();</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

