<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 25961:c0d2cf4f7d090db9f59dabd36beec99b3f898bb7</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ c0d2cf4f7d090db9f59dabd36beec99b3f898bb7" />
<meta property="og:url" content="/comm-central/rev/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7" />
<meta property="og:description" content="Bug 1525190 - Manual changes to abide by eslint in chat. r=florian" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / c0d2cf4f7d090db9f59dabd36beec99b3f898bb7 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7">shortlog</a> |
<a href="/comm-central/log/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7">files</a> |
changeset |
<a href="/comm-central/raw-rev/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7">raw</a>  | <a href="/comm-central/archive/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1525190">Bug 1525190</a> - Manual changes to abide by eslint in chat. r=florian
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#80;&#97;&#116;&#114;&#105;&#99;&#107;&#32;&#67;&#108;&#111;&#107;&#101;&#32;&#60;&#99;&#108;&#111;&#107;&#101;&#112;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 28 Feb 2019 09:49:44 -0500</td></tr>

<tr>
 <td>changeset 25961</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7">c0d2cf4f7d090db9f59dabd36beec99b3f898bb7</a></td>
</tr>



<tr>
<td>parent 25960</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/9ba93261c6b1a274d46121a7e5b8523bab728f78">9ba93261c6b1a274d46121a7e5b8523bab728f78</a>
</td>
</tr>

<tr>
<td>child 25962</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/276188d87e1bddeb98705e6f949802ed3591f65f">276188d87e1bddeb98705e6f949802ed3591f65f</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=c0d2cf4f7d090db9f59dabd36beec99b3f898bb7">15583</a></td></tr>
<tr><td>push user</td><td>clokep@gmail.com</td></tr>
<tr><td>push date</td><td class="date age">Thu, 28 Feb 2019 17:00:20 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@c0d2cf4f7d09 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=c0d2cf4f7d090db9f59dabd36beec99b3f898bb7">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=c0d2cf4f7d090db9f59dabd36beec99b3f898bb7&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=c0d2cf4f7d090db9f59dabd36beec99b3f898bb7&newProject=comm-central&newRevision=c0d2cf4f7d090db9f59dabd36beec99b3f898bb7&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=c0d2cf4f7d090db9f59dabd36beec99b3f898bb7&newProject=comm-central&newRevision=c0d2cf4f7d090db9f59dabd36beec99b3f898bb7&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=c0d2cf4f7d090db9f59dabd36beec99b3f898bb7&newProject=comm-central&newRevision=c0d2cf4f7d090db9f59dabd36beec99b3f898bb7&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28florian%29&revcount=50">florian</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1525190">1525190</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1525190">Bug 1525190</a> - Manual changes to abide by eslint in chat. r=florian</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/components/src/imAccounts.js">chat/components/src/imAccounts.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/components/src/imAccounts.js">file</a> |
<a href="/comm-central/annotate/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/components/src/imAccounts.js">annotate</a> |
<a href="/comm-central/diff/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/components/src/imAccounts.js">diff</a> |
<a href="/comm-central/comparison/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/components/src/imAccounts.js">comparison</a> |
<a href="/comm-central/log/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/components/src/imAccounts.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/components/src/imConversations.js">chat/components/src/imConversations.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/components/src/imConversations.js">file</a> |
<a href="/comm-central/annotate/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/components/src/imConversations.js">annotate</a> |
<a href="/comm-central/diff/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/components/src/imConversations.js">diff</a> |
<a href="/comm-central/comparison/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/components/src/imConversations.js">comparison</a> |
<a href="/comm-central/log/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/components/src/imConversations.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/components/src/logger.js">chat/components/src/logger.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/components/src/logger.js">file</a> |
<a href="/comm-central/annotate/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/components/src/logger.js">annotate</a> |
<a href="/comm-central/diff/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/components/src/logger.js">diff</a> |
<a href="/comm-central/comparison/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/components/src/logger.js">comparison</a> |
<a href="/comm-central/log/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/components/src/logger.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/components/src/smileProtocolHandler.js">chat/components/src/smileProtocolHandler.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/components/src/smileProtocolHandler.js">file</a> |
<a href="/comm-central/annotate/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/components/src/smileProtocolHandler.js">annotate</a> |
<a href="/comm-central/diff/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/components/src/smileProtocolHandler.js">diff</a> |
<a href="/comm-central/comparison/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/components/src/smileProtocolHandler.js">comparison</a> |
<a href="/comm-central/log/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/components/src/smileProtocolHandler.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/components/src/test/test_accounts.js">chat/components/src/test/test_accounts.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/components/src/test/test_accounts.js">file</a> |
<a href="/comm-central/annotate/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/components/src/test/test_accounts.js">annotate</a> |
<a href="/comm-central/diff/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/components/src/test/test_accounts.js">diff</a> |
<a href="/comm-central/comparison/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/components/src/test/test_accounts.js">comparison</a> |
<a href="/comm-central/log/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/components/src/test/test_accounts.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/components/src/test/test_conversations.js">chat/components/src/test/test_conversations.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/components/src/test/test_conversations.js">file</a> |
<a href="/comm-central/annotate/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/components/src/test/test_conversations.js">annotate</a> |
<a href="/comm-central/diff/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/components/src/test/test_conversations.js">diff</a> |
<a href="/comm-central/comparison/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/components/src/test/test_conversations.js">comparison</a> |
<a href="/comm-central/log/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/components/src/test/test_conversations.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/components/src/test/test_logger.js">chat/components/src/test/test_logger.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/components/src/test/test_logger.js">file</a> |
<a href="/comm-central/annotate/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/components/src/test/test_logger.js">annotate</a> |
<a href="/comm-central/diff/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/components/src/test/test_logger.js">diff</a> |
<a href="/comm-central/comparison/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/components/src/test/test_logger.js">comparison</a> |
<a href="/comm-central/log/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/components/src/test/test_logger.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/content/account.xml">chat/content/account.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/content/account.xml">file</a> |
<a href="/comm-central/annotate/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/content/account.xml">annotate</a> |
<a href="/comm-central/diff/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/content/account.xml">diff</a> |
<a href="/comm-central/comparison/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/content/account.xml">comparison</a> |
<a href="/comm-central/log/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/content/account.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/content/conversation-browser.js">chat/content/conversation-browser.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/content/conversation-browser.js">file</a> |
<a href="/comm-central/annotate/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/content/conversation-browser.js">annotate</a> |
<a href="/comm-central/diff/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/content/conversation-browser.js">diff</a> |
<a href="/comm-central/comparison/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/content/conversation-browser.js">comparison</a> |
<a href="/comm-central/log/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/content/conversation-browser.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/modules/DNS.jsm">chat/modules/DNS.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/modules/DNS.jsm">file</a> |
<a href="/comm-central/annotate/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/modules/DNS.jsm">annotate</a> |
<a href="/comm-central/diff/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/modules/DNS.jsm">diff</a> |
<a href="/comm-central/comparison/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/modules/DNS.jsm">comparison</a> |
<a href="/comm-central/log/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/modules/DNS.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/modules/ToLocaleFormat.jsm">chat/modules/ToLocaleFormat.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/modules/ToLocaleFormat.jsm">file</a> |
<a href="/comm-central/annotate/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/modules/ToLocaleFormat.jsm">annotate</a> |
<a href="/comm-central/diff/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/modules/ToLocaleFormat.jsm">diff</a> |
<a href="/comm-central/comparison/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/modules/ToLocaleFormat.jsm">comparison</a> |
<a href="/comm-central/log/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/modules/ToLocaleFormat.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/modules/imContentSink.jsm">chat/modules/imContentSink.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/modules/imContentSink.jsm">file</a> |
<a href="/comm-central/annotate/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/modules/imContentSink.jsm">annotate</a> |
<a href="/comm-central/diff/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/modules/imContentSink.jsm">diff</a> |
<a href="/comm-central/comparison/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/modules/imContentSink.jsm">comparison</a> |
<a href="/comm-central/log/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/modules/imContentSink.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/modules/imSmileys.jsm">chat/modules/imSmileys.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/modules/imSmileys.jsm">file</a> |
<a href="/comm-central/annotate/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/modules/imSmileys.jsm">annotate</a> |
<a href="/comm-central/diff/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/modules/imSmileys.jsm">diff</a> |
<a href="/comm-central/comparison/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/modules/imSmileys.jsm">comparison</a> |
<a href="/comm-central/log/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/modules/imSmileys.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/modules/imStatusUtils.jsm">chat/modules/imStatusUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/modules/imStatusUtils.jsm">file</a> |
<a href="/comm-central/annotate/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/modules/imStatusUtils.jsm">annotate</a> |
<a href="/comm-central/diff/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/modules/imStatusUtils.jsm">diff</a> |
<a href="/comm-central/comparison/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/modules/imStatusUtils.jsm">comparison</a> |
<a href="/comm-central/log/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/modules/imStatusUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/modules/imThemes.jsm">chat/modules/imThemes.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/modules/imThemes.jsm">file</a> |
<a href="/comm-central/annotate/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/modules/imThemes.jsm">annotate</a> |
<a href="/comm-central/diff/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/modules/imThemes.jsm">diff</a> |
<a href="/comm-central/comparison/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/modules/imThemes.jsm">comparison</a> |
<a href="/comm-central/log/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/modules/imThemes.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/modules/imXPCOMUtils.jsm">chat/modules/imXPCOMUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/modules/imXPCOMUtils.jsm">file</a> |
<a href="/comm-central/annotate/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/modules/imXPCOMUtils.jsm">annotate</a> |
<a href="/comm-central/diff/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/modules/imXPCOMUtils.jsm">diff</a> |
<a href="/comm-central/comparison/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/modules/imXPCOMUtils.jsm">comparison</a> |
<a href="/comm-central/log/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/modules/imXPCOMUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/modules/jsProtoHelper.jsm">chat/modules/jsProtoHelper.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/modules/jsProtoHelper.jsm">file</a> |
<a href="/comm-central/annotate/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/modules/jsProtoHelper.jsm">annotate</a> |
<a href="/comm-central/diff/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/modules/jsProtoHelper.jsm">diff</a> |
<a href="/comm-central/comparison/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/modules/jsProtoHelper.jsm">comparison</a> |
<a href="/comm-central/log/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/modules/jsProtoHelper.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/modules/socket.jsm">chat/modules/socket.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/modules/socket.jsm">file</a> |
<a href="/comm-central/annotate/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/modules/socket.jsm">annotate</a> |
<a href="/comm-central/diff/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/modules/socket.jsm">diff</a> |
<a href="/comm-central/comparison/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/modules/socket.jsm">comparison</a> |
<a href="/comm-central/log/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/modules/socket.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/modules/test/test_filtering.js">chat/modules/test/test_filtering.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/modules/test/test_filtering.js">file</a> |
<a href="/comm-central/annotate/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/modules/test/test_filtering.js">annotate</a> |
<a href="/comm-central/diff/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/modules/test/test_filtering.js">diff</a> |
<a href="/comm-central/comparison/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/modules/test/test_filtering.js">comparison</a> |
<a href="/comm-central/log/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/modules/test/test_filtering.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/protocols/irc/irc.js">chat/protocols/irc/irc.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/protocols/irc/irc.js">file</a> |
<a href="/comm-central/annotate/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/protocols/irc/irc.js">annotate</a> |
<a href="/comm-central/diff/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/protocols/irc/irc.js">diff</a> |
<a href="/comm-central/comparison/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/protocols/irc/irc.js">comparison</a> |
<a href="/comm-central/log/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/protocols/irc/irc.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/protocols/irc/ircCTCP.jsm">chat/protocols/irc/ircCTCP.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/protocols/irc/ircCTCP.jsm">file</a> |
<a href="/comm-central/annotate/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/protocols/irc/ircCTCP.jsm">annotate</a> |
<a href="/comm-central/diff/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/protocols/irc/ircCTCP.jsm">diff</a> |
<a href="/comm-central/comparison/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/protocols/irc/ircCTCP.jsm">comparison</a> |
<a href="/comm-central/log/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/protocols/irc/ircCTCP.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/protocols/irc/ircCommands.jsm">chat/protocols/irc/ircCommands.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/protocols/irc/ircCommands.jsm">file</a> |
<a href="/comm-central/annotate/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/protocols/irc/ircCommands.jsm">annotate</a> |
<a href="/comm-central/diff/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/protocols/irc/ircCommands.jsm">diff</a> |
<a href="/comm-central/comparison/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/protocols/irc/ircCommands.jsm">comparison</a> |
<a href="/comm-central/log/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/protocols/irc/ircCommands.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/protocols/irc/ircUtils.jsm">chat/protocols/irc/ircUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/protocols/irc/ircUtils.jsm">file</a> |
<a href="/comm-central/annotate/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/protocols/irc/ircUtils.jsm">annotate</a> |
<a href="/comm-central/diff/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/protocols/irc/ircUtils.jsm">diff</a> |
<a href="/comm-central/comparison/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/protocols/irc/ircUtils.jsm">comparison</a> |
<a href="/comm-central/log/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/protocols/irc/ircUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/protocols/irc/test/test_ircCommands.js">chat/protocols/irc/test/test_ircCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/protocols/irc/test/test_ircCommands.js">file</a> |
<a href="/comm-central/annotate/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/protocols/irc/test/test_ircCommands.js">annotate</a> |
<a href="/comm-central/diff/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/protocols/irc/test/test_ircCommands.js">diff</a> |
<a href="/comm-central/comparison/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/protocols/irc/test/test_ircCommands.js">comparison</a> |
<a href="/comm-central/log/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/protocols/irc/test/test_ircCommands.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/protocols/xmpp/xmpp.jsm">chat/protocols/xmpp/xmpp.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/protocols/xmpp/xmpp.jsm">file</a> |
<a href="/comm-central/annotate/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/protocols/xmpp/xmpp.jsm">annotate</a> |
<a href="/comm-central/diff/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/protocols/xmpp/xmpp.jsm">diff</a> |
<a href="/comm-central/comparison/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/protocols/xmpp/xmpp.jsm">comparison</a> |
<a href="/comm-central/log/c0d2cf4f7d090db9f59dabd36beec99b3f898bb7/chat/protocols/xmpp/xmpp.jsm">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/chat/components/src/imAccounts.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/chat/components/src/imAccounts.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -4,16 +4,17 @@</span>
<a href="#l1.4"></a><span id="l1.4"> var {</span>
<a href="#l1.5"></a><span id="l1.5">   ClassInfo,</span>
<a href="#l1.6"></a><span id="l1.6">   EmptyEnumerator,</span>
<a href="#l1.7"></a><span id="l1.7">   nsSimpleEnumerator,</span>
<a href="#l1.8"></a><span id="l1.8">   XPCOMUtils,</span>
<a href="#l1.9"></a><span id="l1.9">   setTimeout,</span>
<a href="#l1.10"></a><span id="l1.10">   clearTimeout,</span>
<a href="#l1.11"></a><span id="l1.11">   executeSoon,</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+  l10nHelper,</span>
<a href="#l1.13"></a><span id="l1.13"> } = ChromeUtils.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l1.14"></a><span id="l1.14"> var {Services} = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l1.15"></a><span id="l1.15"> var {GenericAccountPrototype, GenericAccountBuddyPrototype} = ChromeUtils.import(&quot;resource:///modules/jsProtoHelper.jsm&quot;);</span>
<a href="#l1.16"></a><span id="l1.16"> </span>
<a href="#l1.17"></a><span id="l1.17"> var kPrefAutologinPending = &quot;messenger.accounts.autoLoginPending&quot;;</span>
<a href="#l1.18"></a><span id="l1.18"> var kPrefMessengerAccounts = &quot;messenger.accounts&quot;;</span>
<a href="#l1.19"></a><span id="l1.19"> var kPrefAccountPrefix = &quot;messenger.account.&quot;;</span>
<a href="#l1.20"></a><span id="l1.20"> var kAccountKeyPrefix = &quot;account&quot;;</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineat">@@ -576,21 +577,17 @@ imAccount.prototype = {</span>
<a href="#l1.22"></a><span id="l1.22">     if (aException.result != Cr.NS_ERROR_ABORT)</span>
<a href="#l1.23"></a><span id="l1.23">       throw aException;</span>
<a href="#l1.24"></a><span id="l1.24"> </span>
<a href="#l1.25"></a><span id="l1.25">     gUserCanceledMasterPasswordPrompt = true;</span>
<a href="#l1.26"></a><span id="l1.26">     executeSoon(function() { gUserCanceledMasterPasswordPrompt = false; });</span>
<a href="#l1.27"></a><span id="l1.27">   },</span>
<a href="#l1.28"></a><span id="l1.28"> </span>
<a href="#l1.29"></a><span id="l1.29">   get autoLogin() {</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineminus">-    let autoLogin = true;</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-    try {</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineminus">-      autoLogin = this.prefBranch.getBoolPref(kPrefAccountAutoLogin);</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineminus">-    } catch (e) { }</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineminus">-    return autoLogin;</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineplus">+    return this.prefBranch.getBoolPref(kPrefAccountAutoLogin, true);</span>
<a href="#l1.36"></a><span id="l1.36">   },</span>
<a href="#l1.37"></a><span id="l1.37">   set autoLogin(val) {</span>
<a href="#l1.38"></a><span id="l1.38">     this.prefBranch.setBoolPref(kPrefAccountAutoLogin, val);</span>
<a href="#l1.39"></a><span id="l1.39">     SavePrefTimer.initTimer();</span>
<a href="#l1.40"></a><span id="l1.40">     this._sendUpdateNotification();</span>
<a href="#l1.41"></a><span id="l1.41">   },</span>
<a href="#l1.42"></a><span id="l1.42">   _autoLoginPending: false,</span>
<a href="#l1.43"></a><span id="l1.43">   checkAutoLogin() {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/chat/components/src/imConversations.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/chat/components/src/imConversations.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -665,17 +665,17 @@ ConversationsService.prototype = {</span>
<a href="#l2.4"></a><span id="l2.4">       if (conv.id == aId)</span>
<a href="#l2.5"></a><span id="l2.5">         return conv;</span>
<a href="#l2.6"></a><span id="l2.6">     return null;</span>
<a href="#l2.7"></a><span id="l2.7">   },</span>
<a href="#l2.8"></a><span id="l2.8">   getConversationByNameAndAccount(aName, aAccount, aIsChat) {</span>
<a href="#l2.9"></a><span id="l2.9">     let normalizedName = aAccount.normalize(aName);</span>
<a href="#l2.10"></a><span id="l2.10">     for (let conv of this._prplConversations) {</span>
<a href="#l2.11"></a><span id="l2.11">       if (aAccount.normalize(conv.name) == normalizedName &amp;&amp;</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-          aAccount.numericId == aAccount.numericId &amp;&amp;</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+          aAccount.numericId == conv.account.numericId &amp;&amp;</span>
<a href="#l2.14"></a><span id="l2.14">           conv.isChat == aIsChat)</span>
<a href="#l2.15"></a><span id="l2.15">         return conv;</span>
<a href="#l2.16"></a><span id="l2.16">     }</span>
<a href="#l2.17"></a><span id="l2.17">     return null;</span>
<a href="#l2.18"></a><span id="l2.18">   },</span>
<a href="#l2.19"></a><span id="l2.19"> </span>
<a href="#l2.20"></a><span id="l2.20">   QueryInterface: ChromeUtils.generateQI([Ci.imIConversationsService]),</span>
<a href="#l2.21"></a><span id="l2.21">   classDescription: &quot;Conversations&quot;,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/chat/components/src/logger.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/chat/components/src/logger.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -1,20 +1,25 @@</span>
<a href="#l3.4"></a><span id="l3.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l3.5"></a><span id="l3.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l3.6"></a><span id="l3.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l3.7"></a><span id="l3.7"> </span>
<a href="#l3.8"></a><span id="l3.8"> var CC = Components.Constructor;</span>
<a href="#l3.9"></a><span id="l3.9"> </span>
<a href="#l3.10"></a><span id="l3.10"> var {Services} = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l3.11"></a><span id="l3.11" class="difflineminus">-var {EmptyEnumerator, XPCOMUtils} = ChromeUtils.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+var {</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+  EmptyEnumerator,</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+  l10nHelper,</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+  XPCOMUtils,</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+} = ChromeUtils.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l3.17"></a><span id="l3.17"> var {GenericMessagePrototype} = ChromeUtils.import(&quot;resource:///modules/jsProtoHelper.jsm&quot;);</span>
<a href="#l3.18"></a><span id="l3.18"> var {ClassInfo} = ChromeUtils.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l3.19"></a><span id="l3.19"> var {ToLocaleFormat} = ChromeUtils.import(&quot;resource:///modules/ToLocaleFormat.jsm&quot;);</span>
<a href="#l3.20"></a><span id="l3.20"> var {OS} = ChromeUtils.import(&quot;resource://gre/modules/osfile.jsm&quot;);</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+var {getHiddenHTMLWindow} = ChromeUtils.import(&quot;resource:///modules/hiddenWindow.jsm&quot;);</span>
<a href="#l3.22"></a><span id="l3.22"> </span>
<a href="#l3.23"></a><span id="l3.23"> XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l3.24"></a><span id="l3.24">   l10nHelper(&quot;chrome://chat/locale/logger.properties&quot;)</span>
<a href="#l3.25"></a><span id="l3.25"> );</span>
<a href="#l3.26"></a><span id="l3.26"> </span>
<a href="#l3.27"></a><span id="l3.27"> var kLineBreak = &quot;@mozilla.org/windows-registry-key;1&quot; in Cc ? &quot;\r\n&quot; : &quot;\n&quot;;</span>
<a href="#l3.28"></a><span id="l3.28"> </span>
<a href="#l3.29"></a><span id="l3.29"> /*</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineat">@@ -132,17 +137,19 @@ function getNewLogFileName(aFormat, aSta</span>
<a href="#l3.31"></a><span id="l3.31">     dateTime += &quot;+&quot;;</span>
<a href="#l3.32"></a><span id="l3.32">     offset *= -1;</span>
<a href="#l3.33"></a><span id="l3.33">   }</span>
<a href="#l3.34"></a><span id="l3.34">   else</span>
<a href="#l3.35"></a><span id="l3.35">     dateTime += &quot;-&quot;;</span>
<a href="#l3.36"></a><span id="l3.36">   let minutes = offset % 60;</span>
<a href="#l3.37"></a><span id="l3.37">   offset = (offset - minutes) / 60;</span>
<a href="#l3.38"></a><span id="l3.38">   function twoDigits(aNumber) {</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineminus">-    return aNumber == 0 ? &quot;00&quot; : aNumber &lt; 10 ? &quot;0&quot; + aNumber : aNumber;</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+    if (aNumber == 0)</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+      return &quot;00&quot;;</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineplus">+    return aNumber &lt; 10 ? &quot;0&quot; + aNumber : aNumber;</span>
<a href="#l3.43"></a><span id="l3.43">   }</span>
<a href="#l3.44"></a><span id="l3.44">   if (!aFormat)</span>
<a href="#l3.45"></a><span id="l3.45">     aFormat = &quot;txt&quot;;</span>
<a href="#l3.46"></a><span id="l3.46">   return dateTime + twoDigits(offset) + twoDigits(minutes) + &quot;.&quot; + aFormat;</span>
<a href="#l3.47"></a><span id="l3.47"> }</span>
<a href="#l3.48"></a><span id="l3.48"> </span>
<a href="#l3.49"></a><span id="l3.49"> </span>
<a href="#l3.50"></a><span id="l3.50"> // One of these is maintained for every conversation being logged. It initializes</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineat">@@ -162,17 +169,17 @@ LogWriter.prototype = {</span>
<a href="#l3.52"></a><span id="l3.52">   // Constructor sets this to a promise that will resolve when the log header</span>
<a href="#l3.53"></a><span id="l3.53">   // has been written.</span>
<a href="#l3.54"></a><span id="l3.54">   _initialized: null,</span>
<a href="#l3.55"></a><span id="l3.55">   _startTime: null,</span>
<a href="#l3.56"></a><span id="l3.56">   _lastMessageTime: null,</span>
<a href="#l3.57"></a><span id="l3.57">   _messageCount: 0,</span>
<a href="#l3.58"></a><span id="l3.58">   format: &quot;txt&quot;,</span>
<a href="#l3.59"></a><span id="l3.59">   encoder: new TextEncoder(),</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineminus">-  startNewFile: function lw_startNewFile(aStartTime, aContinuedSession) {</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineplus">+  startNewFile(aStartTime, aContinuedSession) {</span>
<a href="#l3.62"></a><span id="l3.62">     // We start a new log file every 1000 messages. The start time of this new</span>
<a href="#l3.63"></a><span id="l3.63">     // log file is the time of the next message. Since message times are in seconds,</span>
<a href="#l3.64"></a><span id="l3.64">     // if we receive 1000 messages within a second after starting the new file,</span>
<a href="#l3.65"></a><span id="l3.65">     // we will create another file, using the same start time - and so the same</span>
<a href="#l3.66"></a><span id="l3.66">     // file name. To avoid this, ensure the new start time is at least one second</span>
<a href="#l3.67"></a><span id="l3.67">     // greater than the current one. This is ugly, but should rarely be needed.</span>
<a href="#l3.68"></a><span id="l3.68">     aStartTime = Math.max(aStartTime, this._startTime + 1000);</span>
<a href="#l3.69"></a><span id="l3.69">     this._startTime = this._lastMessageTime = aStartTime;</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineat">@@ -205,20 +212,21 @@ LogWriter.prototype = {</span>
<a href="#l3.71"></a><span id="l3.71">     }</span>
<a href="#l3.72"></a><span id="l3.72">     this._initialized =</span>
<a href="#l3.73"></a><span id="l3.73">       appendToFile(this.currentPath, this.encoder.encode(header), true);</span>
<a href="#l3.74"></a><span id="l3.74">     // Catch the error separately so that _initialized will stay rejected if</span>
<a href="#l3.75"></a><span id="l3.75">     // writing the header failed.</span>
<a href="#l3.76"></a><span id="l3.76">     this._initialized.catch(aError =&gt;</span>
<a href="#l3.77"></a><span id="l3.77">                             Cu.reportError(&quot;Failed to initialize log file:\n&quot; + aError));</span>
<a href="#l3.78"></a><span id="l3.78">   },</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineminus">-  _serialize: function cl_serialize(aString) {</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineplus">+  _serialize(aString) {</span>
<a href="#l3.81"></a><span id="l3.81">     // TODO cleanup once bug 102699 is fixed</span>
<a href="#l3.82"></a><span id="l3.82">     let doc = getHiddenHTMLWindow().document;</span>
<a href="#l3.83"></a><span id="l3.83">     let div = doc.createElementNS(&quot;http://www.w3.org/1999/xhtml&quot;, &quot;div&quot;);</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineplus">+    // eslint-disable-next-line no-unsanitized/property</span>
<a href="#l3.85"></a><span id="l3.85">     div.innerHTML = aString.replace(/\r?\n/g, &quot;&lt;br/&gt;&quot;).replace(/&lt;br&gt;/gi, &quot;&lt;br/&gt;&quot;);</span>
<a href="#l3.86"></a><span id="l3.86">     const type = &quot;text/plain&quot;;</span>
<a href="#l3.87"></a><span id="l3.87">     let encoder = Cu.createDocumentEncoder(type);</span>
<a href="#l3.88"></a><span id="l3.88">     encoder.init(doc, type, 0);</span>
<a href="#l3.89"></a><span id="l3.89">     encoder.setContainerNode(div);</span>
<a href="#l3.90"></a><span id="l3.90">     encoder.setNodeFixup({fixupNode(aNode, aSerializeKids) {</span>
<a href="#l3.91"></a><span id="l3.91">       if (aNode.localName == &quot;a&quot; &amp;&amp; aNode.hasAttribute(&quot;href&quot;)) {</span>
<a href="#l3.92"></a><span id="l3.92">         let url = aNode.getAttribute(&quot;href&quot;);</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineat">@@ -232,17 +240,17 @@ LogWriter.prototype = {</span>
<a href="#l3.94"></a><span id="l3.94">   },</span>
<a href="#l3.95"></a><span id="l3.95">   // We start a new log file in the following cases:</span>
<a href="#l3.96"></a><span id="l3.96">   // - If it has been 30 minutes since the last message.</span>
<a href="#l3.97"></a><span id="l3.97">   kInactivityLimit: 30 * 60 * 1000,</span>
<a href="#l3.98"></a><span id="l3.98">   // - If at midnight, it's been longer than 3 hours since we started the file.</span>
<a href="#l3.99"></a><span id="l3.99">   kDayOverlapLimit: 3 * 60 * 60 * 1000,</span>
<a href="#l3.100"></a><span id="l3.100">   // - After every 1000 messages.</span>
<a href="#l3.101"></a><span id="l3.101">   kMessageCountLimit: 1000,</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineminus">-  logMessage: function cl_logMessage(aMessage) {</span>
<a href="#l3.103"></a><span id="l3.103" class="difflineplus">+  logMessage(aMessage) {</span>
<a href="#l3.104"></a><span id="l3.104">     // aMessage.time is in seconds, we need it in milliseconds.</span>
<a href="#l3.105"></a><span id="l3.105">     let messageTime = aMessage.time * 1000;</span>
<a href="#l3.106"></a><span id="l3.106">     let messageMidnight = new Date(messageTime).setHours(0, 0, 0, 0);</span>
<a href="#l3.107"></a><span id="l3.107"> </span>
<a href="#l3.108"></a><span id="l3.108">     let inactivityLimitExceeded =</span>
<a href="#l3.109"></a><span id="l3.109">       !aMessage.delayed &amp;&amp; messageTime - this._lastMessageTime &gt; this.kInactivityLimit;</span>
<a href="#l3.110"></a><span id="l3.110">     let dayOverlapLimitExceeded =</span>
<a href="#l3.111"></a><span id="l3.111">       !aMessage.delayed &amp;&amp; messageMidnight - this._startTime &gt; this.kDayOverlapLimit;</span>
<a href="#l3.112"></a><span id="l3.112" class="difflineat">@@ -343,17 +351,17 @@ function SystemLogWriter(aAccount) {</span>
<a href="#l3.113"></a><span id="l3.113">                           Cu.reportError(&quot;Error initializing system log:\n&quot; + aError));</span>
<a href="#l3.114"></a><span id="l3.114"> }</span>
<a href="#l3.115"></a><span id="l3.115"> SystemLogWriter.prototype = {</span>
<a href="#l3.116"></a><span id="l3.116">   encoder: new TextEncoder(),</span>
<a href="#l3.117"></a><span id="l3.117">   // Constructor sets this to a promise that will resolve when the log header</span>
<a href="#l3.118"></a><span id="l3.118">   // has been written.</span>
<a href="#l3.119"></a><span id="l3.119">   _initialized: null,</span>
<a href="#l3.120"></a><span id="l3.120">   path: null,</span>
<a href="#l3.121"></a><span id="l3.121" class="difflineminus">-  logEvent: function sl_logEvent(aString) {</span>
<a href="#l3.122"></a><span id="l3.122" class="difflineplus">+  logEvent(aString) {</span>
<a href="#l3.123"></a><span id="l3.123">     let date = ToLocaleFormat(&quot;%x %X&quot;, new Date());</span>
<a href="#l3.124"></a><span id="l3.124">     let lineToWrite =</span>
<a href="#l3.125"></a><span id="l3.125">       this.encoder.encode(&quot;---- &quot; + aString + &quot; @ &quot; + date + &quot; ----&quot; + kLineBreak);</span>
<a href="#l3.126"></a><span id="l3.126">     this._initialized.then(() =&gt; {</span>
<a href="#l3.127"></a><span id="l3.127">       appendToFile(this.path, lineToWrite)</span>
<a href="#l3.128"></a><span id="l3.128">         .catch(aError =&gt; Cu.reportError(&quot;Failed to log event:\n&quot; + aError));</span>
<a href="#l3.129"></a><span id="l3.129">     });</span>
<a href="#l3.130"></a><span id="l3.130">   },</span>
<a href="#l3.131"></a><span id="l3.131" class="difflineat">@@ -707,17 +715,17 @@ Logger.prototype = {</span>
<a href="#l3.132"></a><span id="l3.132">     } catch (aError) {</span>
<a href="#l3.133"></a><span id="l3.133">       if (iterator)</span>
<a href="#l3.134"></a><span id="l3.134">         iterator.close();</span>
<a href="#l3.135"></a><span id="l3.135">       Cu.reportError(&quot;Error getting directory entries for \&quot;&quot; +</span>
<a href="#l3.136"></a><span id="l3.136">                      path + &quot;\&quot;:\n&quot; + aError);</span>
<a href="#l3.137"></a><span id="l3.137">     }</span>
<a href="#l3.138"></a><span id="l3.138">     return [];</span>
<a href="#l3.139"></a><span id="l3.139">   },</span>
<a href="#l3.140"></a><span id="l3.140" class="difflineminus">-  getLogFromFile: function logger_getLogFromFile(aFilePath, aGroupByDay) {</span>
<a href="#l3.141"></a><span id="l3.141" class="difflineplus">+  getLogFromFile(aFilePath, aGroupByDay) {</span>
<a href="#l3.142"></a><span id="l3.142">     if (!aGroupByDay)</span>
<a href="#l3.143"></a><span id="l3.143">       return Promise.resolve(new Log(aFilePath));</span>
<a href="#l3.144"></a><span id="l3.144">     let [targetDate] = getDateFromFilename(OS.Path.basename(aFilePath));</span>
<a href="#l3.145"></a><span id="l3.145">     if (!targetDate)</span>
<a href="#l3.146"></a><span id="l3.146">       return null;</span>
<a href="#l3.147"></a><span id="l3.147"> </span>
<a href="#l3.148"></a><span id="l3.148">     targetDate = targetDate.toDateString();</span>
<a href="#l3.149"></a><span id="l3.149"> </span>
<a href="#l3.150"></a><span id="l3.150" class="difflineat">@@ -742,40 +750,38 @@ Logger.prototype = {</span>
<a href="#l3.151"></a><span id="l3.151">       return new Log(relevantEntries);</span>
<a href="#l3.152"></a><span id="l3.152">     }, aError =&gt; {</span>
<a href="#l3.153"></a><span id="l3.153">       iterator.close();</span>
<a href="#l3.154"></a><span id="l3.154">       throw aError;</span>
<a href="#l3.155"></a><span id="l3.155">     });</span>
<a href="#l3.156"></a><span id="l3.156">   },</span>
<a href="#l3.157"></a><span id="l3.157">   // Creates and returns the appropriate LogEnumerator for the given log array</span>
<a href="#l3.158"></a><span id="l3.158">   // depending on aGroupByDay, or an EmptyEnumerator if the input array is empty.</span>
<a href="#l3.159"></a><span id="l3.159" class="difflineminus">-  _getEnumerator: function logger__getEnumerator(aLogArray, aGroupByDay) {</span>
<a href="#l3.160"></a><span id="l3.160" class="difflineplus">+  _getEnumerator(aLogArray, aGroupByDay) {</span>
<a href="#l3.161"></a><span id="l3.161">     let enumerator = aGroupByDay ? DailyLogEnumerator : LogEnumerator;</span>
<a href="#l3.162"></a><span id="l3.162">     return aLogArray.length ? new enumerator(aLogArray) : EmptyEnumerator;</span>
<a href="#l3.163"></a><span id="l3.163">   },</span>
<a href="#l3.164"></a><span id="l3.164">   async getLogPathsForConversation(aConversation) {</span>
<a href="#l3.165"></a><span id="l3.165">     let writer = gLogWritersById.get(aConversation.id);</span>
<a href="#l3.166"></a><span id="l3.166">     // Resolve to null if we haven't created a LogWriter yet for this conv, or</span>
<a href="#l3.167"></a><span id="l3.167">     // if logging is disabled (paths will be null).</span>
<a href="#l3.168"></a><span id="l3.168">     if (!writer || !writer.paths)</span>
<a href="#l3.169"></a><span id="l3.169">       return null;</span>
<a href="#l3.170"></a><span id="l3.170">     let paths = writer.paths;</span>
<a href="#l3.171"></a><span id="l3.171">     // Wait for any pending file operations to finish, then resolve to the paths</span>
<a href="#l3.172"></a><span id="l3.172">     // regardless of whether these operations succeeded.</span>
<a href="#l3.173"></a><span id="l3.173">     for (let path of paths)</span>
<a href="#l3.174"></a><span id="l3.174">       await gFilePromises.get(path);</span>
<a href="#l3.175"></a><span id="l3.175">     return paths;</span>
<a href="#l3.176"></a><span id="l3.176">   },</span>
<a href="#l3.177"></a><span id="l3.177" class="difflineminus">-  getLogsForAccountAndName: function logger_getLogsForAccountAndName(aAccount,</span>
<a href="#l3.178"></a><span id="l3.178" class="difflineminus">-                                       aNormalizedName, aGroupByDay) {</span>
<a href="#l3.179"></a><span id="l3.179" class="difflineplus">+  getLogsForAccountAndName(aAccount, aNormalizedName, aGroupByDay) {</span>
<a href="#l3.180"></a><span id="l3.180">     return this._getLogArray(aAccount, aNormalizedName)</span>
<a href="#l3.181"></a><span id="l3.181">                .then(aEntries =&gt; this._getEnumerator(aEntries, aGroupByDay));</span>
<a href="#l3.182"></a><span id="l3.182">   },</span>
<a href="#l3.183"></a><span id="l3.183" class="difflineminus">-  getLogsForAccountBuddy: function logger_getLogsForAccountBuddy(aAccountBuddy,</span>
<a href="#l3.184"></a><span id="l3.184" class="difflineminus">-                                                                 aGroupByDay) {</span>
<a href="#l3.185"></a><span id="l3.185" class="difflineplus">+  getLogsForAccountBuddy(aAccountBuddy, aGroupByDay) {</span>
<a href="#l3.186"></a><span id="l3.186">     return this.getLogsForAccountAndName(aAccountBuddy.account,</span>
<a href="#l3.187"></a><span id="l3.187">                                          aAccountBuddy.normalizedName, aGroupByDay);</span>
<a href="#l3.188"></a><span id="l3.188">   },</span>
<a href="#l3.189"></a><span id="l3.189">   async getLogsForBuddy(aBuddy, aGroupByDay) {</span>
<a href="#l3.190"></a><span id="l3.190">     let entries = [];</span>
<a href="#l3.191"></a><span id="l3.191">     for (let accountBuddy of aBuddy.getAccountBuddies()) {</span>
<a href="#l3.192"></a><span id="l3.192">       entries = entries.concat(await this._getLogArray(accountBuddy.account,</span>
<a href="#l3.193"></a><span id="l3.193">                                                        accountBuddy.normalizedName));</span>
<a href="#l3.194"></a><span id="l3.194" class="difflineat">@@ -787,24 +793,23 @@ Logger.prototype = {</span>
<a href="#l3.195"></a><span id="l3.195">     for (let buddy of aContact.getBuddies()) {</span>
<a href="#l3.196"></a><span id="l3.196">       for (let accountBuddy of buddy.getAccountBuddies()) {</span>
<a href="#l3.197"></a><span id="l3.197">         entries = entries.concat(await this._getLogArray(accountBuddy.account,</span>
<a href="#l3.198"></a><span id="l3.198">                                                          accountBuddy.normalizedName));</span>
<a href="#l3.199"></a><span id="l3.199">       }</span>
<a href="#l3.200"></a><span id="l3.200">     }</span>
<a href="#l3.201"></a><span id="l3.201">     return this._getEnumerator(entries, aGroupByDay);</span>
<a href="#l3.202"></a><span id="l3.202">   },</span>
<a href="#l3.203"></a><span id="l3.203" class="difflineminus">-  getLogsForConversation: function logger_getLogsForConversation(aConversation,</span>
<a href="#l3.204"></a><span id="l3.204" class="difflineminus">-                                                                 aGroupByDay) {</span>
<a href="#l3.205"></a><span id="l3.205" class="difflineplus">+  getLogsForConversation(aConversation, aGroupByDay) {</span>
<a href="#l3.206"></a><span id="l3.206">     let name = aConversation.normalizedName;</span>
<a href="#l3.207"></a><span id="l3.207">     if (convIsRealMUC(aConversation))</span>
<a href="#l3.208"></a><span id="l3.208">       name += &quot;.chat&quot;;</span>
<a href="#l3.209"></a><span id="l3.209">     return this.getLogsForAccountAndName(aConversation.account, name, aGroupByDay);</span>
<a href="#l3.210"></a><span id="l3.210">   },</span>
<a href="#l3.211"></a><span id="l3.211" class="difflineminus">-  getSystemLogsForAccount: function logger_getSystemLogsForAccount(aAccount) {</span>
<a href="#l3.212"></a><span id="l3.212" class="difflineplus">+  getSystemLogsForAccount(aAccount) {</span>
<a href="#l3.213"></a><span id="l3.213">     return this.getLogsForAccountAndName(aAccount, &quot;.system&quot;);</span>
<a href="#l3.214"></a><span id="l3.214">   },</span>
<a href="#l3.215"></a><span id="l3.215">   async getSimilarLogs(aLog, aGroupByDay) {</span>
<a href="#l3.216"></a><span id="l3.216">     let iterator = new OS.File.DirectoryIterator(OS.Path.dirname(aLog.path));</span>
<a href="#l3.217"></a><span id="l3.217">     let entries;</span>
<a href="#l3.218"></a><span id="l3.218">     try {</span>
<a href="#l3.219"></a><span id="l3.219">       entries = await iterator.nextBatch();</span>
<a href="#l3.220"></a><span id="l3.220">     } catch (aError) {</span>
<a href="#l3.221"></a><span id="l3.221" class="difflineat">@@ -879,17 +884,17 @@ Logger.prototype = {</span>
<a href="#l3.222"></a><span id="l3.222">           throw aError;</span>
<a href="#l3.223"></a><span id="l3.223">         Cu.reportError(&quot;Error sweeping log folder:\n&quot; + aError);</span>
<a href="#l3.224"></a><span id="l3.224">       } finally {</span>
<a href="#l3.225"></a><span id="l3.225">         iterator.close();</span>
<a href="#l3.226"></a><span id="l3.226">       }</span>
<a href="#l3.227"></a><span id="l3.227">     }</span>
<a href="#l3.228"></a><span id="l3.228">   },</span>
<a href="#l3.229"></a><span id="l3.229"> </span>
<a href="#l3.230"></a><span id="l3.230" class="difflineminus">-  observe: function logger_observe(aSubject, aTopic, aData) {</span>
<a href="#l3.231"></a><span id="l3.231" class="difflineplus">+  observe(aSubject, aTopic, aData) {</span>
<a href="#l3.232"></a><span id="l3.232">     switch (aTopic) {</span>
<a href="#l3.233"></a><span id="l3.233">     case &quot;profile-after-change&quot;:</span>
<a href="#l3.234"></a><span id="l3.234">       Services.obs.addObserver(this, &quot;final-ui-startup&quot;);</span>
<a href="#l3.235"></a><span id="l3.235">       break;</span>
<a href="#l3.236"></a><span id="l3.236">     case &quot;final-ui-startup&quot;:</span>
<a href="#l3.237"></a><span id="l3.237">       Services.obs.removeObserver(this, &quot;final-ui-startup&quot;);</span>
<a href="#l3.238"></a><span id="l3.238">       [&quot;new-text&quot;, &quot;conversation-closed&quot;, &quot;conversation-left-chat&quot;,</span>
<a href="#l3.239"></a><span id="l3.239">        &quot;account-connected&quot;, &quot;account-disconnected&quot;,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/chat/components/src/smileProtocolHandler.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/chat/components/src/smileProtocolHandler.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -18,29 +18,29 @@ function smileProtocolHandler() { }</span>
<a href="#l4.4"></a><span id="l4.4"> </span>
<a href="#l4.5"></a><span id="l4.5"> smileProtocolHandler.prototype = {</span>
<a href="#l4.6"></a><span id="l4.6">   scheme: &quot;smile&quot;,</span>
<a href="#l4.7"></a><span id="l4.7">   defaultPort: -1,</span>
<a href="#l4.8"></a><span id="l4.8">   protocolFlags: Ci.nsIProtocolHandler.URI_NORELATIVE |</span>
<a href="#l4.9"></a><span id="l4.9">                  Ci.nsIProtocolHandler.URI_NOAUTH |</span>
<a href="#l4.10"></a><span id="l4.10">                  Ci.nsIProtocolHandler.URI_IS_UI_RESOURCE |</span>
<a href="#l4.11"></a><span id="l4.11">                  Ci.nsIProtocolHandler.URI_IS_LOCAL_RESOURCE,</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-  newURI: function SPH_newURI(aSpec, aOriginCharset, aBaseURI) {</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+  newURI(aSpec, aOriginCharset, aBaseURI) {</span>
<a href="#l4.14"></a><span id="l4.14">     let mutator = Cc[&quot;@mozilla.org/network/simple-uri-mutator;1&quot;]</span>
<a href="#l4.15"></a><span id="l4.15">                     .createInstance(Ci.nsIURIMutator);</span>
<a href="#l4.16"></a><span id="l4.16">     return mutator.setSpec(aSpec).finalize();</span>
<a href="#l4.17"></a><span id="l4.17">   },</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineminus">-  newChannel: function SPH_newChannel2(aURI, aLoadInfo) {</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+  newChannel(aURI, aLoadInfo) {</span>
<a href="#l4.20"></a><span id="l4.20">     let smile = aURI.spec.replace(kSmileRegexp, &quot;&quot;);</span>
<a href="#l4.21"></a><span id="l4.21">     let uri = Services.io.newURI(getSmileRealURI(smile));</span>
<a href="#l4.22"></a><span id="l4.22">     let channel = Services.io.newChannelFromURIWithLoadInfo(uri, aLoadInfo);</span>
<a href="#l4.23"></a><span id="l4.23">     channel.originalURI = aURI;</span>
<a href="#l4.24"></a><span id="l4.24">     return channel;</span>
<a href="#l4.25"></a><span id="l4.25">   },</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineminus">-  allowPort: function SPH_allowPort(aPort, aScheme) { return false; },</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineplus">+  allowPort(aPort, aScheme) { return false; },</span>
<a href="#l4.28"></a><span id="l4.28"> </span>
<a href="#l4.29"></a><span id="l4.29">   classDescription: &quot;Smile Protocol Handler&quot;,</span>
<a href="#l4.30"></a><span id="l4.30">   classID: Components.ID(&quot;{04e58eae-dfbc-4c9e-8130-6d9ef19cbff4}&quot;),</span>
<a href="#l4.31"></a><span id="l4.31">   contractID: &quot;@mozilla.org/network/protocol;1?name=smile&quot;,</span>
<a href="#l4.32"></a><span id="l4.32">   QueryInterface: ChromeUtils.generateQI([Ci.nsIProtocolHandler]),</span>
<a href="#l4.33"></a><span id="l4.33"> };</span>
<a href="#l4.34"></a><span id="l4.34"> </span>
<a href="#l4.35"></a><span id="l4.35"> var NSGetFactory = XPCOMUtils.generateNSGetFactory([smileProtocolHandler]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/chat/components/src/test/test_accounts.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/chat/components/src/test/test_accounts.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -1,13 +1,12 @@</span>
<a href="#l5.4"></a><span id="l5.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l5.5"></a><span id="l5.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l5.6"></a><span id="l5.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l5.7"></a><span id="l5.7"> </span>
<a href="#l5.8"></a><span id="l5.8" class="difflineminus">-var {XPCOMUtils} = ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l5.9"></a><span id="l5.9"> var {Services} = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l5.10"></a><span id="l5.10"> const {updateAppInfo} = ChromeUtils.import(&quot;resource://testing-common/AppInfo.jsm&quot;);</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12"> function run_test() {</span>
<a href="#l5.13"></a><span id="l5.13">   do_get_profile();</span>
<a href="#l5.14"></a><span id="l5.14"> </span>
<a href="#l5.15"></a><span id="l5.15">   // Test the handling of accounts for unknown protocols.</span>
<a href="#l5.16"></a><span id="l5.16">   const kAccountName = &quot;Unknown&quot;;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/chat/components/src/test/test_conversations.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/chat/components/src/test/test_conversations.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -1,23 +1,15 @@</span>
<a href="#l6.4"></a><span id="l6.4"> /* Any copyright is dedicated to the Public Domain.</span>
<a href="#l6.5"></a><span id="l6.5">  * http://creativecommons.org/publicdomain/zero/1.0/ */</span>
<a href="#l6.6"></a><span id="l6.6"> </span>
<a href="#l6.7"></a><span id="l6.7"> var {Services} = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l6.8"></a><span id="l6.8"> var {</span>
<a href="#l6.9"></a><span id="l6.9" class="difflineminus">-  GenericAccountPrototype,</span>
<a href="#l6.10"></a><span id="l6.10" class="difflineminus">-  GenericAccountBuddyPrototype,</span>
<a href="#l6.11"></a><span id="l6.11">   GenericConvIMPrototype,</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-  GenericConvChatPrototype,</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-  GenericConvChatBuddyPrototype,</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-  GenericConversationPrototype,</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineminus">-  GenericMessagePrototype,</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineminus">-  GenericProtocolPrototype,</span>
<a href="#l6.17"></a><span id="l6.17">   Message,</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineminus">-  TooltipInfo,</span>
<a href="#l6.19"></a><span id="l6.19"> } = ChromeUtils.import(&quot;resource:///modules/jsProtoHelper.jsm&quot;);</span>
<a href="#l6.20"></a><span id="l6.20"> </span>
<a href="#l6.21"></a><span id="l6.21"> var imConversations = {};</span>
<a href="#l6.22"></a><span id="l6.22"> Services.scriptloader.loadSubScript(</span>
<a href="#l6.23"></a><span id="l6.23">   &quot;resource:///components/imConversations.js&quot;, imConversations</span>
<a href="#l6.24"></a><span id="l6.24"> );</span>
<a href="#l6.25"></a><span id="l6.25"> </span>
<a href="#l6.26"></a><span id="l6.26"> // Fake prplConversation</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/chat/components/src/test/test_logger.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/chat/components/src/test/test_logger.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -1,26 +1,15 @@</span>
<a href="#l7.4"></a><span id="l7.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l7.5"></a><span id="l7.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l7.6"></a><span id="l7.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l7.7"></a><span id="l7.7"> </span>
<a href="#l7.8"></a><span id="l7.8"> do_get_profile();</span>
<a href="#l7.9"></a><span id="l7.9"> </span>
<a href="#l7.10"></a><span id="l7.10"> var {Services} = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l7.11"></a><span id="l7.11" class="difflineminus">-var {</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-  XPCOMUtils,</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-  setTimeout,</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineminus">-  clearTimeout,</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineminus">-  executeSoon,</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineminus">-  nsSimpleEnumerator,</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineminus">-  EmptyEnumerator,</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineminus">-  ClassInfo,</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineminus">-  l10nHelper,</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineminus">-  initLogModule,</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineminus">-} = ChromeUtils.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l7.22"></a><span id="l7.22"> const {OS} = ChromeUtils.import(&quot;resource://gre/modules/osfile.jsm&quot;);</span>
<a href="#l7.23"></a><span id="l7.23"> </span>
<a href="#l7.24"></a><span id="l7.24"> var gLogger = {};</span>
<a href="#l7.25"></a><span id="l7.25"> Services.scriptloader.loadSubScript(&quot;resource:///components/logger.js&quot;, gLogger);</span>
<a href="#l7.26"></a><span id="l7.26"> </span>
<a href="#l7.27"></a><span id="l7.27"> var logDirPath = OS.Path.join(OS.Constants.Path.profileDir, &quot;logs&quot;);</span>
<a href="#l7.28"></a><span id="l7.28"> </span>
<a href="#l7.29"></a><span id="l7.29"> var dummyAccount = {</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineat">@@ -36,18 +25,16 @@ var dummyTwitterAccount = {</span>
<a href="#l7.31"></a><span id="l7.31">   name: &quot;dummy-twitter&quot;,</span>
<a href="#l7.32"></a><span id="l7.32">   normalizedName: &quot;dummytwitter&quot;,</span>
<a href="#l7.33"></a><span id="l7.33">   protocol: {</span>
<a href="#l7.34"></a><span id="l7.34">     normalizedName: &quot;twitter&quot;,</span>
<a href="#l7.35"></a><span id="l7.35">     id: &quot;prpl-twitter&quot;,</span>
<a href="#l7.36"></a><span id="l7.36">   },</span>
<a href="#l7.37"></a><span id="l7.37"> };</span>
<a href="#l7.38"></a><span id="l7.38"> </span>
<a href="#l7.39"></a><span id="l7.39" class="difflineminus">-var test_accounts = [dummyAccount, dummyTwitterAccount];</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineminus">-</span>
<a href="#l7.41"></a><span id="l7.41"> var dummyConv = {</span>
<a href="#l7.42"></a><span id="l7.42">   account: dummyAccount,</span>
<a href="#l7.43"></a><span id="l7.43">   id: 0,</span>
<a href="#l7.44"></a><span id="l7.44">   title: &quot;dummy conv&quot;,</span>
<a href="#l7.45"></a><span id="l7.45">   normalizedName: &quot;dummyconv&quot;,</span>
<a href="#l7.46"></a><span id="l7.46">   get name() { return this.normalizedName; },</span>
<a href="#l7.47"></a><span id="l7.47">   get startDate() { return new Date(2011, 5, 28).valueOf() * 1000; },</span>
<a href="#l7.48"></a><span id="l7.48">   isChat: false,</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineat">@@ -79,18 +66,16 @@ var dummyTwitterConv = {</span>
<a href="#l7.50"></a><span id="l7.50">   id: 2,</span>
<a href="#l7.51"></a><span id="l7.51">   title: &quot;Dummy Twitter Conv&quot;,</span>
<a href="#l7.52"></a><span id="l7.52">   normalizedName: &quot;dummytwitterconv&quot;,</span>
<a href="#l7.53"></a><span id="l7.53">   get name() { return this.normalizedName; },</span>
<a href="#l7.54"></a><span id="l7.54">   startDate: new Date(2011, 5, 28).valueOf() * 1000,</span>
<a href="#l7.55"></a><span id="l7.55">   isChat: true,</span>
<a href="#l7.56"></a><span id="l7.56"> };</span>
<a href="#l7.57"></a><span id="l7.57"> </span>
<a href="#l7.58"></a><span id="l7.58" class="difflineminus">-var test_convs = [dummyConv, dummyMUC, dummyTwitterConv];</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineminus">-</span>
<a href="#l7.60"></a><span id="l7.60"> var encodeName_input = [</span>
<a href="#l7.61"></a><span id="l7.61">   &quot;CON&quot;,</span>
<a href="#l7.62"></a><span id="l7.62">   &quot;PRN&quot;,</span>
<a href="#l7.63"></a><span id="l7.63">   &quot;AUX&quot;,</span>
<a href="#l7.64"></a><span id="l7.64">   &quot;NUL&quot;,</span>
<a href="#l7.65"></a><span id="l7.65">   &quot;COM3&quot;,</span>
<a href="#l7.66"></a><span id="l7.66">   &quot;LPT5&quot;,</span>
<a href="#l7.67"></a><span id="l7.67">   &quot;file&quot;,</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineat">@@ -172,22 +157,20 @@ var encodeName_output = [</span>
<a href="#l7.69"></a><span id="l7.69">   &quot;%22file&quot;,</span>
<a href="#l7.70"></a><span id="l7.70">   &quot;%2ffile&quot;,</span>
<a href="#l7.71"></a><span id="l7.71">   &quot;%5cfile&quot;,</span>
<a href="#l7.72"></a><span id="l7.72">   &quot;%7cfile&quot;,</span>
<a href="#l7.73"></a><span id="l7.73">   &quot;%3ffile&quot;,</span>
<a href="#l7.74"></a><span id="l7.74">   &quot;%2afile&quot;,</span>
<a href="#l7.75"></a><span id="l7.75">   &quot;%26file&quot;,</span>
<a href="#l7.76"></a><span id="l7.76">   &quot;%25file&quot;,</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineminus">-  &quot;%5c&quot; + &quot;fi&quot; + &quot;%3f%2a%26%25&quot; + &quot;le&quot; + &quot;%3c%3e&quot;,</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineplus">+  &quot;%5c&quot; + &quot;fi&quot; + &quot;%3f%2a%26%25&quot; + &quot;le&quot; + &quot;%3c%3e&quot;, // eslint-disable-line no-useless-concat</span>
<a href="#l7.79"></a><span id="l7.79"> ];</span>
<a href="#l7.80"></a><span id="l7.80"> </span>
<a href="#l7.81"></a><span id="l7.81"> var test_queueFileOperation = async function() {</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineminus">-  let dummyOperation = function() {};</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineminus">-</span>
<a href="#l7.84"></a><span id="l7.84">   let dummyRejectedOperation = () =&gt; Promise.reject(&quot;Rejected!&quot;);</span>
<a href="#l7.85"></a><span id="l7.85">   let dummyResolvedOperation = () =&gt; Promise.resolve(&quot;Resolved!&quot;);</span>
<a href="#l7.86"></a><span id="l7.86"> </span>
<a href="#l7.87"></a><span id="l7.87">   let gFP = gLogger.gFilePromises;</span>
<a href="#l7.88"></a><span id="l7.88">   let qFO = gLogger.queueFileOperation;</span>
<a href="#l7.89"></a><span id="l7.89"> </span>
<a href="#l7.90"></a><span id="l7.90">   // Immediately after calling qFO, &quot;path1&quot; should be mapped to p1.</span>
<a href="#l7.91"></a><span id="l7.91">   // After yielding, the reference should be cleared from the map.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/chat/content/account.xml</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/chat/content/account.xml</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -1,13 +1,14 @@</span>
<a href="#l8.4"></a><span id="l8.4"> &lt;?xml version=&quot;1.0&quot;?&gt;</span>
<a href="#l8.5"></a><span id="l8.5"> &lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l8.6"></a><span id="l8.6">    - License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l8.7"></a><span id="l8.7">    - file, You can obtain one at http://mozilla.org/MPL/2.0/. --&gt;</span>
<a href="#l8.8"></a><span id="l8.8"> </span>
<a href="#l8.9"></a><span id="l8.9" class="difflineplus">+&lt;!-- import-globals-from ../../mail/components/im/content/imAccounts.js --&gt;</span>
<a href="#l8.10"></a><span id="l8.10"> </span>
<a href="#l8.11"></a><span id="l8.11"> &lt;!DOCTYPE bindings [</span>
<a href="#l8.12"></a><span id="l8.12">   &lt;!ENTITY % accountsDTD SYSTEM &quot;chrome://chat/locale/accounts.dtd&quot;&gt;</span>
<a href="#l8.13"></a><span id="l8.13">   %accountsDTD;</span>
<a href="#l8.14"></a><span id="l8.14"> ]&gt;</span>
<a href="#l8.15"></a><span id="l8.15"> </span>
<a href="#l8.16"></a><span id="l8.16"> &lt;bindings id=&quot;accountBindings&quot;</span>
<a href="#l8.17"></a><span id="l8.17">           xmlns=&quot;http://www.mozilla.org/xbl&quot;</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineat">@@ -134,20 +135,20 @@</span>
<a href="#l8.19"></a><span id="l8.19"> </span>
<a href="#l8.20"></a><span id="l8.20">           var updateReconnect = (function() {</span>
<a href="#l8.21"></a><span id="l8.21">             var date = Math.round((account.timeOfNextReconnect - Date.now()) / 1000);</span>
<a href="#l8.22"></a><span id="l8.22">             let reconnect = &quot;&quot;;</span>
<a href="#l8.23"></a><span id="l8.23">             if (date &gt; 0) {</span>
<a href="#l8.24"></a><span id="l8.24">               let [val1, unit1, val2, unit2] = DownloadUtils.convertTimeUnits(date);</span>
<a href="#l8.25"></a><span id="l8.25">               if (!val2)</span>
<a href="#l8.26"></a><span id="l8.26">                 reconnect = bundle.getFormattedString(&quot;account.reconnectInSingle&quot;,</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineminus">-                                                      [val1, unit1])</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineplus">+                                                      [val1, unit1]);</span>
<a href="#l8.29"></a><span id="l8.29">               else</span>
<a href="#l8.30"></a><span id="l8.30">                 reconnect = bundle.getFormattedString(&quot;account.reconnectInDouble&quot;,</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-                                                      [val1, unit1, val2, unit2])</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+                                                      [val1, unit1, val2, unit2]);</span>
<a href="#l8.33"></a><span id="l8.33">             }</span>
<a href="#l8.34"></a><span id="l8.34">             document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;reconnect&quot;)</span>
<a href="#l8.35"></a><span id="l8.35">                     .textContent = reconnect;</span>
<a href="#l8.36"></a><span id="l8.36">             return reconnect;</span>
<a href="#l8.37"></a><span id="l8.37">           }).bind(this);</span>
<a href="#l8.38"></a><span id="l8.38">           if (updateReconnect() &amp;&amp; !this.reconnectUpdateInterval) {</span>
<a href="#l8.39"></a><span id="l8.39">             this.setAttribute(&quot;reconnectPending&quot;, &quot;true&quot;);</span>
<a href="#l8.40"></a><span id="l8.40">             this.reconnectUpdateInterval = setInterval(updateReconnect, 1000);</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineat">@@ -163,20 +164,20 @@</span>
<a href="#l8.42"></a><span id="l8.42">           var bundle = document.getElementById(&quot;accountsBundle&quot;);</span>
<a href="#l8.43"></a><span id="l8.43">           var date =</span>
<a href="#l8.44"></a><span id="l8.44">             60 * Math.floor((Date.now() - this._account.timeOfLastConnect) / 60000);</span>
<a href="#l8.45"></a><span id="l8.45">           let value;</span>
<a href="#l8.46"></a><span id="l8.46">           if (date &gt; 0) {</span>
<a href="#l8.47"></a><span id="l8.47">             let [val1, unit1, val2, unit2] = DownloadUtils.convertTimeUnits(date);</span>
<a href="#l8.48"></a><span id="l8.48">             if (!val2)</span>
<a href="#l8.49"></a><span id="l8.49">               value = bundle.getFormattedString(&quot;account.connectedForSingle&quot;,</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineminus">-                                                [val1, unit1])</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineplus">+                                                [val1, unit1]);</span>
<a href="#l8.52"></a><span id="l8.52">             else</span>
<a href="#l8.53"></a><span id="l8.53">               value = bundle.getFormattedString(&quot;account.connectedForDouble&quot;,</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineminus">-                                                [val1, unit1, val2, unit2])</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineplus">+                                                [val1, unit1, val2, unit2]);</span>
<a href="#l8.56"></a><span id="l8.56">           }</span>
<a href="#l8.57"></a><span id="l8.57">           else</span>
<a href="#l8.58"></a><span id="l8.58">             value = bundle.getString(&quot;account.connectedForSeconds&quot;);</span>
<a href="#l8.59"></a><span id="l8.59">           this.connectedLabel.value = value;</span>
<a href="#l8.60"></a><span id="l8.60">         ]]&gt;</span>
<a href="#l8.61"></a><span id="l8.61">         &lt;/body&gt;</span>
<a href="#l8.62"></a><span id="l8.62">       &lt;/method&gt;</span>
<a href="#l8.63"></a><span id="l8.63"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/chat/content/conversation-browser.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/chat/content/conversation-browser.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -1,19 +1,27 @@</span>
<a href="#l9.4"></a><span id="l9.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l9.5"></a><span id="l9.5">   * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l9.6"></a><span id="l9.6">   * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l9.7"></a><span id="l9.7"> </span>
<a href="#l9.8"></a><span id="l9.8"> &quot;use strict&quot;;</span>
<a href="#l9.9"></a><span id="l9.9"> </span>
<a href="#l9.10"></a><span id="l9.10"> /* global MozXULElement */</span>
<a href="#l9.11"></a><span id="l9.11"> </span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-var { initHTMLDocument, serializeSelection, getCurrentTheme, isNextMessage, getHTMLForMessage, insertHTMLForMessage } = ChromeUtils.import(&quot;resource:///modules/imThemes.jsm&quot;);</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">-var { smileTextNode } = ChromeUtils.import(&quot;resource:///modules/imSmileys.jsm&quot;);</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineminus">-var { cleanupImMarkup } = ChromeUtils.import(&quot;resource:///modules/imContentSink.jsm&quot;);</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+var {</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+  initHTMLDocument,</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineplus">+  serializeSelection,</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineplus">+  getCurrentTheme,</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineplus">+  isNextMessage,</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineplus">+  getHTMLForMessage,</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineplus">+  insertHTMLForMessage,</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineplus">+} = ChromeUtils.import(&quot;resource:///modules/imThemes.jsm&quot;);</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineplus">+var {smileTextNode} = ChromeUtils.import(&quot;resource:///modules/imSmileys.jsm&quot;);</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineplus">+var {cleanupImMarkup} = ChromeUtils.import(&quot;resource:///modules/imContentSink.jsm&quot;);</span>
<a href="#l9.26"></a><span id="l9.26"> </span>
<a href="#l9.27"></a><span id="l9.27"> (function() {</span>
<a href="#l9.28"></a><span id="l9.28">   // &lt;browser&gt; is lazily set up through setElementCreationCallback,</span>
<a href="#l9.29"></a><span id="l9.29">   // i.e. put into customElements the first time it's really seen.</span>
<a href="#l9.30"></a><span id="l9.30">   // Create a fake to ensure browser exists in customElements, since otherwise</span>
<a href="#l9.31"></a><span id="l9.31">   // we can't extend it. Then make sure this fake doesn't stay around.</span>
<a href="#l9.32"></a><span id="l9.32">   if (!customElements.get(&quot;browser&quot;)) {</span>
<a href="#l9.33"></a><span id="l9.33">     delete document.createElement(&quot;browser&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/chat/modules/DNS.jsm</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/chat/modules/DNS.jsm</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -286,32 +286,35 @@ function SRVRecord(aPrio, aWeight, aHost</span>
<a href="#l10.4"></a><span id="l10.4"> }</span>
<a href="#l10.5"></a><span id="l10.5"> </span>
<a href="#l10.6"></a><span id="l10.6"> // Used to make results of different libraries consistent for TXT queries.</span>
<a href="#l10.7"></a><span id="l10.7"> function TXTRecord(aData) {</span>
<a href="#l10.8"></a><span id="l10.8">   this.data = aData;</span>
<a href="#l10.9"></a><span id="l10.9"> }</span>
<a href="#l10.10"></a><span id="l10.10"> </span>
<a href="#l10.11"></a><span id="l10.11"> if (typeof Components === &quot;undefined&quot;) {</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+  /* eslint-env worker */</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+</span>
<a href="#l10.14"></a><span id="l10.14">   // We are in a worker, wait for our message then execute the wanted method.</span>
<a href="#l10.15"></a><span id="l10.15">   importScripts(&quot;resource://gre/modules/workers/require.js&quot;);</span>
<a href="#l10.16"></a><span id="l10.16">   let PromiseWorker = require(&quot;resource://gre/modules/workers/PromiseWorker.js&quot;);</span>
<a href="#l10.17"></a><span id="l10.17"> </span>
<a href="#l10.18"></a><span id="l10.18">   let worker = new PromiseWorker.AbstractWorker();</span>
<a href="#l10.19"></a><span id="l10.19">   worker.dispatch = function(aMethod, aArgs = []) {</span>
<a href="#l10.20"></a><span id="l10.20">     return self[aMethod](...aArgs);</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineminus">-  },</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineplus">+  };</span>
<a href="#l10.23"></a><span id="l10.23">   worker.postMessage = function(...aArgs) {</span>
<a href="#l10.24"></a><span id="l10.24">     self.postMessage(...aArgs);</span>
<a href="#l10.25"></a><span id="l10.25">   };</span>
<a href="#l10.26"></a><span id="l10.26">   worker.close = function() {</span>
<a href="#l10.27"></a><span id="l10.27">     self.close();</span>
<a href="#l10.28"></a><span id="l10.28">   };</span>
<a href="#l10.29"></a><span id="l10.29">   self.addEventListener(&quot;message&quot;, msg =&gt; worker.handleMessage(msg));</span>
<a href="#l10.30"></a><span id="l10.30"> </span>
<a href="#l10.31"></a><span id="l10.31" class="difflineplus">+  // eslint-disable-next-line no-unused-vars</span>
<a href="#l10.32"></a><span id="l10.32">   function execute(aOS, aMethod, aArgs) {</span>
<a href="#l10.33"></a><span id="l10.33">     let DNS = (aOS == &quot;WINNT&quot; ? new load_dnsapi() : new load_libresolv());</span>
<a href="#l10.34"></a><span id="l10.34">     return DNS[aMethod].apply(DNS, aArgs);</span>
<a href="#l10.35"></a><span id="l10.35">   }</span>
<a href="#l10.36"></a><span id="l10.36"> }</span>
<a href="#l10.37"></a><span id="l10.37"> else {</span>
<a href="#l10.38"></a><span id="l10.38">   // We are loaded as a JSM, provide the async front that will start the</span>
<a href="#l10.39"></a><span id="l10.39">   // worker.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/chat/modules/ToLocaleFormat.jsm</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/chat/modules/ToLocaleFormat.jsm</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -40,17 +40,17 @@ function dayPeriod(aDate) {</span>
<a href="#l11.4"></a><span id="l11.4">     dtf.formatToParts(aDate).find(part =&gt; part.type === &quot;dayPeriod&quot;);</span>
<a href="#l11.5"></a><span id="l11.5">   return dayPeriodPart ? dayPeriodPart.value : &quot;&quot;;</span>
<a href="#l11.6"></a><span id="l11.6"> }</span>
<a href="#l11.7"></a><span id="l11.7"> function weekNumber(aDate, weekStart) {</span>
<a href="#l11.8"></a><span id="l11.8">   let day = aDate.getDay();</span>
<a href="#l11.9"></a><span id="l11.9">   if (weekStart) {</span>
<a href="#l11.10"></a><span id="l11.10">     day = (day || 7) - weekStart;</span>
<a href="#l11.11"></a><span id="l11.11">   }</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-  return Math.max(Math.floor((DayWithinYear(t) + 7 - day) / 7), 0);</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+  return Math.max(Math.floor((DayWithinYear(aDate) + 7 - day) / 7), 0);</span>
<a href="#l11.14"></a><span id="l11.14"> }</span>
<a href="#l11.15"></a><span id="l11.15"> function weekNumberISO(t) {</span>
<a href="#l11.16"></a><span id="l11.16">   let thisWeek = weekNumber(1, t);</span>
<a href="#l11.17"></a><span id="l11.17">   let firstDayOfYear =</span>
<a href="#l11.18"></a><span id="l11.18">     (new Date(t.getFullYear(), 0, 1).getDay() || 7) - 1;</span>
<a href="#l11.19"></a><span id="l11.19">   if (thisWeek === 0 &amp;&amp; firstDayOfYear &gt;= 4)</span>
<a href="#l11.20"></a><span id="l11.20">     return weekNumberISO(new Date(t.getFullYear() - 1, 11, 31));</span>
<a href="#l11.21"></a><span id="l11.21">   if (t.getMonth() === 11 &amp;&amp;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/chat/modules/imContentSink.jsm</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/chat/modules/imContentSink.jsm</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -1,14 +1,13 @@</span>
<a href="#l12.4"></a><span id="l12.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l12.5"></a><span id="l12.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l12.6"></a><span id="l12.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l12.7"></a><span id="l12.7"> </span>
<a href="#l12.8"></a><span id="l12.8"> const {Services} = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l12.9"></a><span id="l12.9" class="difflineminus">-Cu.importGlobalProperties([&quot;DOMParser&quot;]);</span>
<a href="#l12.10"></a><span id="l12.10"> </span>
<a href="#l12.11"></a><span id="l12.11"> this.EXPORTED_SYMBOLS = [</span>
<a href="#l12.12"></a><span id="l12.12">   &quot;cleanupImMarkup&quot;, // used to clean up incoming IMs.</span>
<a href="#l12.13"></a><span id="l12.13">                      // This will use the global ruleset of acceptable stuff</span>
<a href="#l12.14"></a><span id="l12.14">                      // except if another (custom one) is provided</span>
<a href="#l12.15"></a><span id="l12.15">   &quot;createDerivedRuleset&quot;, // used to create a ruleset that inherits from the</span>
<a href="#l12.16"></a><span id="l12.16">                           // default one</span>
<a href="#l12.17"></a><span id="l12.17">                           // useful if you want to allow or forbid</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineat">@@ -170,17 +169,17 @@ var gGlobalRuleset = null;</span>
<a href="#l12.19"></a><span id="l12.19"> function initGlobalRuleset()</span>
<a href="#l12.20"></a><span id="l12.20"> {</span>
<a href="#l12.21"></a><span id="l12.21">   gGlobalRuleset = newRuleset();</span>
<a href="#l12.22"></a><span id="l12.22"> </span>
<a href="#l12.23"></a><span id="l12.23">   Services.prefs.addObserver(kModePref, styleObserver);</span>
<a href="#l12.24"></a><span id="l12.24"> }</span>
<a href="#l12.25"></a><span id="l12.25"> </span>
<a href="#l12.26"></a><span id="l12.26"> var styleObserver = {</span>
<a href="#l12.27"></a><span id="l12.27" class="difflineminus">-  observe: function so_observe(aObject, aTopic, aMsg) {</span>
<a href="#l12.28"></a><span id="l12.28" class="difflineplus">+  observe(aObject, aTopic, aMsg) {</span>
<a href="#l12.29"></a><span id="l12.29">     if (aTopic != &quot;nsPref:changed&quot; || aMsg != kModePref)</span>
<a href="#l12.30"></a><span id="l12.30">       throw &quot;bad notification&quot;;</span>
<a href="#l12.31"></a><span id="l12.31"> </span>
<a href="#l12.32"></a><span id="l12.32">     if (!gGlobalRuleset)</span>
<a href="#l12.33"></a><span id="l12.33">       throw &quot;gGlobalRuleset not initialized&quot;;</span>
<a href="#l12.34"></a><span id="l12.34"> </span>
<a href="#l12.35"></a><span id="l12.35">     setBaseRuleset(getModePref(), gGlobalRuleset);</span>
<a href="#l12.36"></a><span id="l12.36">   },</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineat">@@ -257,17 +256,17 @@ function cleanupNode(aNode, aRules, aTex</span>
<a href="#l12.38"></a><span id="l12.38">       if (!(nodeName in aRules.tags)) {</span>
<a href="#l12.39"></a><span id="l12.39">         if (nodeName in kForbiddenTags) {</span>
<a href="#l12.40"></a><span id="l12.40">           Cu.reportError(&quot;removing a &quot; + nodeName +</span>
<a href="#l12.41"></a><span id="l12.41">                          &quot; tag from a message before display&quot;);</span>
<a href="#l12.42"></a><span id="l12.42">         }</span>
<a href="#l12.43"></a><span id="l12.43">         else {</span>
<a href="#l12.44"></a><span id="l12.44">           // this node is not allowed, replace it with its children</span>
<a href="#l12.45"></a><span id="l12.45">           while (node.hasChildNodes())</span>
<a href="#l12.46"></a><span id="l12.46" class="difflineminus">-            aNode.insertBefore(node.removeChild(node.firstChild), node);</span>
<a href="#l12.47"></a><span id="l12.47" class="difflineplus">+            aNode.insertBefore(node.firstChild, node);</span>
<a href="#l12.48"></a><span id="l12.48">         }</span>
<a href="#l12.49"></a><span id="l12.49">         aNode.removeChild(node);</span>
<a href="#l12.50"></a><span id="l12.50">         // We want to process again the node at the index i which is</span>
<a href="#l12.51"></a><span id="l12.51">         // now the first child of the node we removed</span>
<a href="#l12.52"></a><span id="l12.52">         --i;</span>
<a href="#l12.53"></a><span id="l12.53">         continue;</span>
<a href="#l12.54"></a><span id="l12.54">       }</span>
<a href="#l12.55"></a><span id="l12.55"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/chat/modules/imSmileys.jsm</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/chat/modules/imSmileys.jsm</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -30,33 +30,31 @@ Object.defineProperty(this, &quot;gTheme&quot;, {</span>
<a href="#l13.4"></a><span id="l13.4">   get() {</span>
<a href="#l13.5"></a><span id="l13.5">     delete this.gTheme;</span>
<a href="#l13.6"></a><span id="l13.6">     gPrefObserver.init();</span>
<a href="#l13.7"></a><span id="l13.7">     return this.gTheme = getTheme();</span>
<a href="#l13.8"></a><span id="l13.8">   },</span>
<a href="#l13.9"></a><span id="l13.9"> });</span>
<a href="#l13.10"></a><span id="l13.10"> </span>
<a href="#l13.11"></a><span id="l13.11"> var gPrefObserver = {</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-  init: function po_init() {</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+  init() {</span>
<a href="#l13.14"></a><span id="l13.14">     Services.prefs.addObserver(kEmoticonsThemePref, gPrefObserver);</span>
<a href="#l13.15"></a><span id="l13.15">   },</span>
<a href="#l13.16"></a><span id="l13.16"> </span>
<a href="#l13.17"></a><span id="l13.17" class="difflineminus">-  observe: function so_observe(aObject, aTopic, aMsg) {</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineplus">+  observe(aObject, aTopic, aMsg) {</span>
<a href="#l13.19"></a><span id="l13.19">     if (aTopic != &quot;nsPref:changed&quot; || aMsg != kEmoticonsThemePref)</span>
<a href="#l13.20"></a><span id="l13.20">       throw &quot;bad notification&quot;;</span>
<a href="#l13.21"></a><span id="l13.21"> </span>
<a href="#l13.22"></a><span id="l13.22">     gTheme = getTheme();</span>
<a href="#l13.23"></a><span id="l13.23">   },</span>
<a href="#l13.24"></a><span id="l13.24"> };</span>
<a href="#l13.25"></a><span id="l13.25"> </span>
<a href="#l13.26"></a><span id="l13.26"> function getSmileRealURI(aSmile)</span>
<a href="#l13.27"></a><span id="l13.27"> {</span>
<a href="#l13.28"></a><span id="l13.28" class="difflineminus">-  aSmile = Cc[&quot;@mozilla.org/intl/texttosuburi;1&quot;]</span>
<a href="#l13.29"></a><span id="l13.29" class="difflineminus">-             .getService(Ci.nsITextToSubURI)</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineminus">-             .unEscapeURIForUI(&quot;UTF-8&quot;, aSmile);</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineplus">+  aSmile = Services.textToSubURI.unEscapeURIForUI(&quot;UTF-8&quot;, aSmile);</span>
<a href="#l13.32"></a><span id="l13.32">   if (aSmile in gTheme.iconsHash)</span>
<a href="#l13.33"></a><span id="l13.33">     return gTheme.baseUri + gTheme.iconsHash[aSmile].filename;</span>
<a href="#l13.34"></a><span id="l13.34"> </span>
<a href="#l13.35"></a><span id="l13.35">   throw &quot;Invalid smile!&quot;;</span>
<a href="#l13.36"></a><span id="l13.36"> }</span>
<a href="#l13.37"></a><span id="l13.37"> </span>
<a href="#l13.38"></a><span id="l13.38"> function getSmileyList(aThemeName)</span>
<a href="#l13.39"></a><span id="l13.39"> {</span>
<a href="#l13.40"></a><span id="l13.40" class="difflineat">@@ -223,12 +221,13 @@ function smileImMarkup(aDocument, aText)</span>
<a href="#l13.41"></a><span id="l13.41">   if (!aDocument)</span>
<a href="#l13.42"></a><span id="l13.42">     throw &quot;providing an HTML document is required&quot;;</span>
<a href="#l13.43"></a><span id="l13.43"> </span>
<a href="#l13.44"></a><span id="l13.44">   // return early if smileys are disabled</span>
<a href="#l13.45"></a><span id="l13.45">   if (!gTheme.iconsHash)</span>
<a href="#l13.46"></a><span id="l13.46">     return aText;</span>
<a href="#l13.47"></a><span id="l13.47"> </span>
<a href="#l13.48"></a><span id="l13.48">   let div = aDocument.createElement(&quot;div&quot;);</span>
<a href="#l13.49"></a><span id="l13.49" class="difflineplus">+  // eslint-disable-next-line no-unsanitized/property</span>
<a href="#l13.50"></a><span id="l13.50">   div.innerHTML = aText;</span>
<a href="#l13.51"></a><span id="l13.51">   smileNode(div);</span>
<a href="#l13.52"></a><span id="l13.52">   return div.innerHTML;</span>
<a href="#l13.53"></a><span id="l13.53"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/chat/modules/imStatusUtils.jsm</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/chat/modules/imStatusUtils.jsm</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -1,26 +1,18 @@</span>
<a href="#l14.4"></a><span id="l14.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l14.5"></a><span id="l14.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l14.6"></a><span id="l14.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l14.7"></a><span id="l14.7"> </span>
<a href="#l14.8"></a><span id="l14.8"> this.EXPORTED_SYMBOLS = [&quot;Status&quot;];</span>
<a href="#l14.9"></a><span id="l14.9"> </span>
<a href="#l14.10"></a><span id="l14.10"> var {</span>
<a href="#l14.11"></a><span id="l14.11">   XPCOMUtils,</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-  setTimeout,</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineminus">-  clearTimeout,</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineminus">-  executeSoon,</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineminus">-  nsSimpleEnumerator,</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineminus">-  EmptyEnumerator,</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineminus">-  ClassInfo,</span>
<a href="#l14.18"></a><span id="l14.18">   l10nHelper,</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineminus">-  initLogModule,</span>
<a href="#l14.20"></a><span id="l14.20"> } = ChromeUtils.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineminus">-var {Services} = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l14.22"></a><span id="l14.22"> </span>
<a href="#l14.23"></a><span id="l14.23"> XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l14.24"></a><span id="l14.24">   l10nHelper(&quot;chrome://chat/locale/status.properties&quot;)</span>
<a href="#l14.25"></a><span id="l14.25"> );</span>
<a href="#l14.26"></a><span id="l14.26"> </span>
<a href="#l14.27"></a><span id="l14.27"> var imIStatusInfo = Ci.imIStatusInfo;</span>
<a href="#l14.28"></a><span id="l14.28"> var statusAttributes = {};</span>
<a href="#l14.29"></a><span id="l14.29"> statusAttributes[imIStatusInfo.STATUS_UNKNOWN] = &quot;unknown&quot;;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/chat/modules/imThemes.jsm</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/chat/modules/imThemes.jsm</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -12,17 +12,16 @@ this.EXPORTED_SYMBOLS = [</span>
<a href="#l15.4"></a><span id="l15.4">   &quot;initHTMLDocument&quot;,</span>
<a href="#l15.5"></a><span id="l15.5">   &quot;getMessagesForRange&quot;,</span>
<a href="#l15.6"></a><span id="l15.6">   &quot;serializeSelection&quot;,</span>
<a href="#l15.7"></a><span id="l15.7"> ];</span>
<a href="#l15.8"></a><span id="l15.8"> </span>
<a href="#l15.9"></a><span id="l15.9"> const {Services} = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l15.10"></a><span id="l15.10"> const {DownloadUtils} = ChromeUtils.import(&quot;resource://gre/modules/DownloadUtils.jsm&quot;);</span>
<a href="#l15.11"></a><span id="l15.11"> const {XPCOMUtils} = ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-Cu.importGlobalProperties([&quot;DOMParser&quot;, &quot;Element&quot;]);</span>
<a href="#l15.13"></a><span id="l15.13"> </span>
<a href="#l15.14"></a><span id="l15.14"> var kMessagesStylePrefBranch = &quot;messenger.options.messagesStyle.&quot;;</span>
<a href="#l15.15"></a><span id="l15.15"> var kThemePref = &quot;theme&quot;;</span>
<a href="#l15.16"></a><span id="l15.16"> var kVariantPref = &quot;variant&quot;;</span>
<a href="#l15.17"></a><span id="l15.17"> var kShowHeaderPref = &quot;showHeader&quot;;</span>
<a href="#l15.18"></a><span id="l15.18"> var kCombineConsecutivePref = &quot;combineConsecutive&quot;;</span>
<a href="#l15.19"></a><span id="l15.19"> var kCombineConsecutiveIntervalPref = &quot;combineConsecutiveInterval&quot;;</span>
<a href="#l15.20"></a><span id="l15.20"> </span>
<a href="#l15.21"></a><span id="l15.21" class="difflineat">@@ -534,16 +533,17 @@ function insertHTMLForMessage(aMsg, aHTM</span>
<a href="#l15.22"></a><span id="l15.22">   if (insert &amp;&amp; !aIsNext) {</span>
<a href="#l15.23"></a><span id="l15.23">     insert.remove();</span>
<a href="#l15.24"></a><span id="l15.24">     insert = null;</span>
<a href="#l15.25"></a><span id="l15.25">   }</span>
<a href="#l15.26"></a><span id="l15.26"> </span>
<a href="#l15.27"></a><span id="l15.27">   let range = aDoc.createRange();</span>
<a href="#l15.28"></a><span id="l15.28">   let parent = insert ? insert.parentNode : aDoc.getElementById(&quot;Chat&quot;);</span>
<a href="#l15.29"></a><span id="l15.29">   range.selectNode(parent);</span>
<a href="#l15.30"></a><span id="l15.30" class="difflineplus">+  // eslint-disable-next-line no-unsanitized/method</span>
<a href="#l15.31"></a><span id="l15.31">   let documentFragment = range.createContextualFragment(aHTML);</span>
<a href="#l15.32"></a><span id="l15.32">   let result = documentFragment.firstChild;</span>
<a href="#l15.33"></a><span id="l15.33"> </span>
<a href="#l15.34"></a><span id="l15.34">   // store the prplIMessage object in each of the &quot;root&quot; node that</span>
<a href="#l15.35"></a><span id="l15.35">   // will be inserted into the document, so that selection code can</span>
<a href="#l15.36"></a><span id="l15.36">   // retrieve the message by just looking at the parent node until it</span>
<a href="#l15.37"></a><span id="l15.37">   // finds something.</span>
<a href="#l15.38"></a><span id="l15.38">   for (let root = result; root; root = root.nextSibling)</span>
<a href="#l15.39"></a><span id="l15.39" class="difflineat">@@ -889,16 +889,17 @@ SelectedMessage.prototype = {</span>
<a href="#l15.40"></a><span id="l15.40">     if (this._textSelected) {</span>
<a href="#l15.41"></a><span id="l15.41">       // Add ellipsis is needed</span>
<a href="#l15.42"></a><span id="l15.42">       text = (this._cutBegin ? getEllipsis() + &quot; &quot; : &quot;&quot;) +</span>
<a href="#l15.43"></a><span id="l15.43">              this._selectedText +</span>
<a href="#l15.44"></a><span id="l15.44">              (this._cutEnd ? &quot; &quot; + getEllipsis() : &quot;&quot;);</span>
<a href="#l15.45"></a><span id="l15.45">     }</span>
<a href="#l15.46"></a><span id="l15.46">     else {</span>
<a href="#l15.47"></a><span id="l15.47">       let div = this._rootNodes[0].ownerDocument.createElement(&quot;div&quot;);</span>
<a href="#l15.48"></a><span id="l15.48" class="difflineplus">+      // eslint-disable-next-line no-unsanitized/property</span>
<a href="#l15.49"></a><span id="l15.49">       div.innerHTML = msg.autoResponse ? formatAutoResponce(msg.message) : msg.message;</span>
<a href="#l15.50"></a><span id="l15.50">       text = serializeNode(div);</span>
<a href="#l15.51"></a><span id="l15.51">     }</span>
<a href="#l15.52"></a><span id="l15.52"> </span>
<a href="#l15.53"></a><span id="l15.53">     // then get the suitable replacements and templates for this message</span>
<a href="#l15.54"></a><span id="l15.54">     let getLocalizedPrefWithDefault = function(aName, aDefault) {</span>
<a href="#l15.55"></a><span id="l15.55">       try {</span>
<a href="#l15.56"></a><span id="l15.56">         let prefBranch =</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/chat/modules/imXPCOMUtils.jsm</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/chat/modules/imXPCOMUtils.jsm</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -89,17 +89,17 @@ function scriptError(aModule, aLevel, aM</span>
<a href="#l16.4"></a><span id="l16.4"> function initLogModule(aModule, aObj = {})</span>
<a href="#l16.5"></a><span id="l16.5"> {</span>
<a href="#l16.6"></a><span id="l16.6">   aObj.DEBUG = scriptError.bind(aObj, aModule, Ci.imIDebugMessage.LEVEL_DEBUG);</span>
<a href="#l16.7"></a><span id="l16.7">   aObj.LOG   = scriptError.bind(aObj, aModule, Ci.imIDebugMessage.LEVEL_LOG);</span>
<a href="#l16.8"></a><span id="l16.8">   aObj.WARN  = scriptError.bind(aObj, aModule, Ci.imIDebugMessage.LEVEL_WARNING);</span>
<a href="#l16.9"></a><span id="l16.9">   aObj.ERROR = scriptError.bind(aObj, aModule, Ci.imIDebugMessage.LEVEL_ERROR);</span>
<a href="#l16.10"></a><span id="l16.10">   return aObj;</span>
<a href="#l16.11"></a><span id="l16.11"> }</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-XPCOMUtils.defineLazyGetter(Cu.getGlobalForObject({}), &quot;gLogLevels&quot;, function() {</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+XPCOMUtils.defineLazyGetter(this, &quot;gLogLevels&quot;, function() {</span>
<a href="#l16.14"></a><span id="l16.14">   // This object functions both as an obsever as well as a dict keeping the</span>
<a href="#l16.15"></a><span id="l16.15">   // log levels with prefs; the log levels all start with &quot;level&quot; (i.e. &quot;level&quot;</span>
<a href="#l16.16"></a><span id="l16.16">   // for the global level, &quot;level.irc&quot; for the IRC module).  The dual-purpose</span>
<a href="#l16.17"></a><span id="l16.17">   // is necessary to make sure the observe is left alive while being a weak ref</span>
<a href="#l16.18"></a><span id="l16.18">   // to avoid cycles with the pref service.</span>
<a href="#l16.19"></a><span id="l16.19">   let logLevels = {</span>
<a href="#l16.20"></a><span id="l16.20">     observe(aSubject, aTopic, aData) {</span>
<a href="#l16.21"></a><span id="l16.21">       let module = &quot;level&quot; + aData.substr(kLogLevelPref.length);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/chat/modules/jsProtoHelper.jsm</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/chat/modules/jsProtoHelper.jsm</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -27,17 +27,17 @@ const {ClassInfo} = ChromeUtils.import(&quot;</span>
<a href="#l17.4"></a><span id="l17.4"> </span>
<a href="#l17.5"></a><span id="l17.5"> XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l17.6"></a><span id="l17.6">   l10nHelper(&quot;chrome://chat/locale/conversations.properties&quot;)</span>
<a href="#l17.7"></a><span id="l17.7"> );</span>
<a href="#l17.8"></a><span id="l17.8"> </span>
<a href="#l17.9"></a><span id="l17.9"> var GenericAccountPrototype = {</span>
<a href="#l17.10"></a><span id="l17.10">   __proto__: ClassInfo(&quot;prplIAccount&quot;, &quot;generic account object&quot;),</span>
<a href="#l17.11"></a><span id="l17.11">   get wrappedJSObject() { return this; },</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-  _init: function _init(aProtocol, aImAccount) {</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+  _init(aProtocol, aImAccount) {</span>
<a href="#l17.14"></a><span id="l17.14">     this.protocol = aProtocol;</span>
<a href="#l17.15"></a><span id="l17.15">     this.imAccount = aImAccount;</span>
<a href="#l17.16"></a><span id="l17.16">     initLogModule(aProtocol.id, this);</span>
<a href="#l17.17"></a><span id="l17.17">   },</span>
<a href="#l17.18"></a><span id="l17.18">   observe(aSubject, aTopic, aData) {},</span>
<a href="#l17.19"></a><span id="l17.19">   remove() { throw Cr.NS_ERROR_NOT_IMPLEMENTED; },</span>
<a href="#l17.20"></a><span id="l17.20">   unInit() { throw Cr.NS_ERROR_NOT_IMPLEMENTED; },</span>
<a href="#l17.21"></a><span id="l17.21">   connect() { throw Cr.NS_ERROR_NOT_IMPLEMENTED; },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/chat/modules/socket.jsm</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/chat/modules/socket.jsm</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -85,22 +85,18 @@ var {</span>
<a href="#l18.4"></a><span id="l18.4">   setTimeout,</span>
<a href="#l18.5"></a><span id="l18.5">   clearTimeout,</span>
<a href="#l18.6"></a><span id="l18.6">   executeSoon,</span>
<a href="#l18.7"></a><span id="l18.7"> } = ChromeUtils.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l18.8"></a><span id="l18.8"> var {getHiddenHTMLWindow} = ChromeUtils.import(&quot;resource:///modules/hiddenWindow.jsm&quot;);</span>
<a href="#l18.9"></a><span id="l18.9"> </span>
<a href="#l18.10"></a><span id="l18.10"> // Network errors see: xpcom/base/nsError.h</span>
<a href="#l18.11"></a><span id="l18.11"> var NS_ERROR_MODULE_NETWORK = 2152398848;</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-var NS_ERROR_CONNECTION_REFUSED = NS_ERROR_MODULE_NETWORK + 13;</span>
<a href="#l18.13"></a><span id="l18.13"> var NS_ERROR_NET_TIMEOUT = NS_ERROR_MODULE_NETWORK + 14;</span>
<a href="#l18.14"></a><span id="l18.14"> var NS_ERROR_NET_RESET = NS_ERROR_MODULE_NETWORK + 20;</span>
<a href="#l18.15"></a><span id="l18.15" class="difflineminus">-var NS_ERROR_UNKNOWN_HOST = NS_ERROR_MODULE_NETWORK + 30;</span>
<a href="#l18.16"></a><span id="l18.16" class="difflineminus">-var NS_ERROR_UNKNOWN_PROXY_HOST = NS_ERROR_MODULE_NETWORK + 42;</span>
<a href="#l18.17"></a><span id="l18.17" class="difflineminus">-var NS_ERROR_PROXY_CONNECTION_REFUSED = NS_ERROR_MODULE_NETWORK + 72;</span>
<a href="#l18.18"></a><span id="l18.18"> </span>
<a href="#l18.19"></a><span id="l18.19"> var BinaryInputStream =</span>
<a href="#l18.20"></a><span id="l18.20">   Components.Constructor(&quot;@mozilla.org/binaryinputstream;1&quot;,</span>
<a href="#l18.21"></a><span id="l18.21">                          &quot;nsIBinaryInputStream&quot;, &quot;setInputStream&quot;);</span>
<a href="#l18.22"></a><span id="l18.22"> var BinaryOutputStream =</span>
<a href="#l18.23"></a><span id="l18.23">   Components.Constructor(&quot;@mozilla.org/binaryoutputstream;1&quot;,</span>
<a href="#l18.24"></a><span id="l18.24">                          &quot;nsIBinaryOutputStream&quot;, &quot;setOutputStream&quot;);</span>
<a href="#l18.25"></a><span id="l18.25"> var ScriptableInputStream =</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/chat/modules/test/test_filtering.js</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/chat/modules/test/test_filtering.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -138,18 +138,18 @@ function test_standardMode() {</span>
<a href="#l19.4"></a><span id="l19.4"> </span>
<a href="#l19.5"></a><span id="l19.5">   // Keep special allowed classes.</span>
<a href="#l19.6"></a><span id="l19.6">   for (let className of [&quot;moz-txt-underscore&quot;, &quot;moz-txt-tag&quot;]) {</span>
<a href="#l19.7"></a><span id="l19.7">     let string = &quot;&lt;span class=\&quot;&quot; + className + &quot;\&quot;&gt;foo&lt;/span&gt;&quot;;</span>
<a href="#l19.8"></a><span id="l19.8">     Assert.equal(string, cleanupImMarkup(string));</span>
<a href="#l19.9"></a><span id="l19.9">   }</span>
<a href="#l19.10"></a><span id="l19.10"> </span>
<a href="#l19.11"></a><span id="l19.11">   // Remove font settings</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-  let string = &quot;&lt;font face=\&quot;Times\&quot; color=\&quot;pink\&quot; size=\&quot;3\&quot;&gt;foo&lt;/font&gt;&quot;;</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineminus">-  Assert.equal(&quot;foo&quot;, cleanupImMarkup(string));</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineplus">+  let font_string = &quot;&lt;font face=\&quot;Times\&quot; color=\&quot;pink\&quot; size=\&quot;3\&quot;&gt;foo&lt;/font&gt;&quot;;</span>
<a href="#l19.15"></a><span id="l19.15" class="difflineplus">+  Assert.equal(&quot;foo&quot;, cleanupImMarkup(font_string));</span>
<a href="#l19.16"></a><span id="l19.16"> </span>
<a href="#l19.17"></a><span id="l19.17">   // Discard hr</span>
<a href="#l19.18"></a><span id="l19.18">   Assert.equal(&quot;foobar&quot;, cleanupImMarkup(&quot;foo&lt;hr&gt;bar&quot;));</span>
<a href="#l19.19"></a><span id="l19.19"> </span>
<a href="#l19.20"></a><span id="l19.20">   const okCSS = [</span>
<a href="#l19.21"></a><span id="l19.21">     &quot;font-style: italic&quot;,</span>
<a href="#l19.22"></a><span id="l19.22">     &quot;font-weight: bold&quot;,</span>
<a href="#l19.23"></a><span id="l19.23">   ];</span>
<a href="#l19.24"></a><span id="l19.24" class="difflineat">@@ -206,18 +206,18 @@ function test_permissiveMode() {</span>
<a href="#l19.25"></a><span id="l19.25">     &quot;size=\&quot;3\&quot;&quot;,</span>
<a href="#l19.26"></a><span id="l19.26">   ];</span>
<a href="#l19.27"></a><span id="l19.27">   for (let fontAttribute of fontAttributes) {</span>
<a href="#l19.28"></a><span id="l19.28">     let string = &quot;&lt;font &quot; + fontAttribute + &quot;&gt;foo&lt;/font&gt;&quot;;</span>
<a href="#l19.29"></a><span id="l19.29">     Assert.equal(string, cleanupImMarkup(string));</span>
<a href="#l19.30"></a><span id="l19.30">   }</span>
<a href="#l19.31"></a><span id="l19.31"> </span>
<a href="#l19.32"></a><span id="l19.32">   // Allow hr</span>
<a href="#l19.33"></a><span id="l19.33" class="difflineminus">-  let string = &quot;foo&lt;hr&gt;bar&quot;;</span>
<a href="#l19.34"></a><span id="l19.34" class="difflineminus">-  Assert.equal(string, cleanupImMarkup(string));</span>
<a href="#l19.35"></a><span id="l19.35" class="difflineplus">+  let hr_string = &quot;foo&lt;hr&gt;bar&quot;;</span>
<a href="#l19.36"></a><span id="l19.36" class="difflineplus">+  Assert.equal(hr_string, cleanupImMarkup(hr_string));</span>
<a href="#l19.37"></a><span id="l19.37"> </span>
<a href="#l19.38"></a><span id="l19.38">   // Allow most CSS rules changing the text appearance.</span>
<a href="#l19.39"></a><span id="l19.39">   const okCSS = [</span>
<a href="#l19.40"></a><span id="l19.40">     &quot;font-style: italic&quot;,</span>
<a href="#l19.41"></a><span id="l19.41">     &quot;font-weight: bold&quot;,</span>
<a href="#l19.42"></a><span id="l19.42">     &quot;text-decoration: underline&quot;,</span>
<a href="#l19.43"></a><span id="l19.43">     &quot;color: pink;&quot;,</span>
<a href="#l19.44"></a><span id="l19.44">     &quot;font-family: Times&quot;,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/chat/protocols/irc/irc.js</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/chat/protocols/irc/irc.js</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -3,23 +3,23 @@</span>
<a href="#l20.4"></a><span id="l20.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l20.5"></a><span id="l20.5"> </span>
<a href="#l20.6"></a><span id="l20.6"> var {</span>
<a href="#l20.7"></a><span id="l20.7">   ClassInfo,</span>
<a href="#l20.8"></a><span id="l20.8">   clearTimeout,</span>
<a href="#l20.9"></a><span id="l20.9">   EmptyEnumerator,</span>
<a href="#l20.10"></a><span id="l20.10">   setTimeout,</span>
<a href="#l20.11"></a><span id="l20.11">   executeSoon,</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineplus">+  l10nHelper,</span>
<a href="#l20.13"></a><span id="l20.13">   XPCOMUtils,</span>
<a href="#l20.14"></a><span id="l20.14">   nsSimpleEnumerator,</span>
<a href="#l20.15"></a><span id="l20.15"> } = ChromeUtils.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l20.16"></a><span id="l20.16"> var {Services} = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l20.17"></a><span id="l20.17"> var {</span>
<a href="#l20.18"></a><span id="l20.18">   _,</span>
<a href="#l20.19"></a><span id="l20.19" class="difflineminus">-  _conv,</span>
<a href="#l20.20"></a><span id="l20.20">   ctcpFormatToText,</span>
<a href="#l20.21"></a><span id="l20.21">   ctcpFormatToHTML,</span>
<a href="#l20.22"></a><span id="l20.22">   conversationErrorMessage,</span>
<a href="#l20.23"></a><span id="l20.23">   kListRefreshInterval,</span>
<a href="#l20.24"></a><span id="l20.24"> } = ChromeUtils.import(&quot;resource:///modules/ircUtils.jsm&quot;);</span>
<a href="#l20.25"></a><span id="l20.25"> var {ircHandlers} = ChromeUtils.import(&quot;resource:///modules/ircHandlers.jsm&quot;);</span>
<a href="#l20.26"></a><span id="l20.26"> var {</span>
<a href="#l20.27"></a><span id="l20.27">   GenericAccountPrototype,</span>
<a href="#l20.28"></a><span id="l20.28" class="difflineat">@@ -37,16 +37,20 @@ var {NormalizedMap} = ChromeUtils.import</span>
<a href="#l20.29"></a><span id="l20.29"> var {Socket} = ChromeUtils.import(&quot;resource:///modules/socket.jsm&quot;);</span>
<a href="#l20.30"></a><span id="l20.30"> </span>
<a href="#l20.31"></a><span id="l20.31"> ChromeUtils.defineModuleGetter(this, &quot;PluralForm&quot;,</span>
<a href="#l20.32"></a><span id="l20.32">   &quot;resource://gre/modules/PluralForm.jsm&quot;);</span>
<a href="#l20.33"></a><span id="l20.33"> </span>
<a href="#l20.34"></a><span id="l20.34"> ChromeUtils.defineModuleGetter(this, &quot;DownloadUtils&quot;,</span>
<a href="#l20.35"></a><span id="l20.35">   &quot;resource://gre/modules/DownloadUtils.jsm&quot;);</span>
<a href="#l20.36"></a><span id="l20.36"> </span>
<a href="#l20.37"></a><span id="l20.37" class="difflineplus">+XPCOMUtils.defineLazyGetter(this, &quot;_conv&quot;, () =&gt;</span>
<a href="#l20.38"></a><span id="l20.38" class="difflineplus">+  l10nHelper(&quot;chrome://chat/locale/conversations.properties&quot;)</span>
<a href="#l20.39"></a><span id="l20.39" class="difflineplus">+);</span>
<a href="#l20.40"></a><span id="l20.40" class="difflineplus">+</span>
<a href="#l20.41"></a><span id="l20.41"> /*</span>
<a href="#l20.42"></a><span id="l20.42">  * Parses a raw IRC message into an object (see section 2.3 of RFC 2812). This</span>
<a href="#l20.43"></a><span id="l20.43">  * returns an object with the following fields:</span>
<a href="#l20.44"></a><span id="l20.44">  *   rawMessage The initial message string received without any processing.</span>
<a href="#l20.45"></a><span id="l20.45">  *   command    A string that is the command or response code.</span>
<a href="#l20.46"></a><span id="l20.46">  *   params     An array of strings for the parameters. The last parameter is</span>
<a href="#l20.47"></a><span id="l20.47">  *              stripped of its : prefix.</span>
<a href="#l20.48"></a><span id="l20.48">  *   origin     The user's nickname or the server who sent the message. Can be</span>
<a href="#l20.49"></a><span id="l20.49" class="difflineat">@@ -733,16 +737,17 @@ ircSocket.prototype = {</span>
<a href="#l20.50"></a><span id="l20.50">     // We've received data and are past the authentication stage.</span>
<a href="#l20.51"></a><span id="l20.51">     if (this._account.connected)</span>
<a href="#l20.52"></a><span id="l20.52">       this.resetPingTimer();</span>
<a href="#l20.53"></a><span id="l20.53"> </span>
<a href="#l20.54"></a><span id="l20.54">     // Low level dequote: replace quote character \020 followed by 0, n, r or</span>
<a href="#l20.55"></a><span id="l20.55">     // \020 with a \0, \n, \r or \020, respectively. Any other character is</span>
<a href="#l20.56"></a><span id="l20.56">     // replaced with itself.</span>
<a href="#l20.57"></a><span id="l20.57">     const lowDequote = {&quot;0&quot;: &quot;\0&quot;, &quot;n&quot;: &quot;\n&quot;, &quot;r&quot;: &quot;\r&quot;, &quot;\x10&quot;: &quot;\x10&quot;};</span>
<a href="#l20.58"></a><span id="l20.58" class="difflineplus">+    // eslint-disable-next-line no-control-regex</span>
<a href="#l20.59"></a><span id="l20.59">     let dequotedMessage = aRawMessage.replace(/\x10./g,</span>
<a href="#l20.60"></a><span id="l20.60">       aStr =&gt; lowDequote[aStr[1]] || aStr[1]);</span>
<a href="#l20.61"></a><span id="l20.61"> </span>
<a href="#l20.62"></a><span id="l20.62">     try {</span>
<a href="#l20.63"></a><span id="l20.63">       let message = new ircMessage(dequotedMessage,</span>
<a href="#l20.64"></a><span id="l20.64">                                    this._account._currentServerName);</span>
<a href="#l20.65"></a><span id="l20.65">       this.DEBUG(JSON.stringify(message) + conversionWarning);</span>
<a href="#l20.66"></a><span id="l20.66">       if (!ircHandlers.handleMessage(this._account, message)) {</span>
<a href="#l20.67"></a><span id="l20.67" class="difflineat">@@ -754,17 +759,17 @@ ircSocket.prototype = {</span>
<a href="#l20.68"></a><span id="l20.68">       // Catch the error, display it and hope the connection can continue with</span>
<a href="#l20.69"></a><span id="l20.69">       // this message in error. Errors are also caught inside of handleMessage,</span>
<a href="#l20.70"></a><span id="l20.70">       // but we expect to handle message parsing errors here.</span>
<a href="#l20.71"></a><span id="l20.71">       this.DEBUG(aRawMessage + conversionWarning);</span>
<a href="#l20.72"></a><span id="l20.72">       this.ERROR(e);</span>
<a href="#l20.73"></a><span id="l20.73">     }</span>
<a href="#l20.74"></a><span id="l20.74">   },</span>
<a href="#l20.75"></a><span id="l20.75">   onConnection() {</span>
<a href="#l20.76"></a><span id="l20.76" class="difflineminus">-    this._account._connectionRegistration.call(this._account);</span>
<a href="#l20.77"></a><span id="l20.77" class="difflineplus">+    this._account._connectionRegistration();</span>
<a href="#l20.78"></a><span id="l20.78">   },</span>
<a href="#l20.79"></a><span id="l20.79">   disconnect() {</span>
<a href="#l20.80"></a><span id="l20.80">     if (!this._account)</span>
<a href="#l20.81"></a><span id="l20.81">       return;</span>
<a href="#l20.82"></a><span id="l20.82">     Socket.disconnect.call(this);</span>
<a href="#l20.83"></a><span id="l20.83">     delete this._account;</span>
<a href="#l20.84"></a><span id="l20.84">   },</span>
<a href="#l20.85"></a><span id="l20.85"> </span>
<a href="#l20.86"></a><span id="l20.86" class="difflineat">@@ -988,24 +993,24 @@ ircAccount.prototype = {</span>
<a href="#l20.87"></a><span id="l20.87">       this.sendMessage(&quot;AWAY&quot;); // Mark as back.</span>
<a href="#l20.88"></a><span id="l20.88">   },</span>
<a href="#l20.89"></a><span id="l20.89"> </span>
<a href="#l20.90"></a><span id="l20.90">   // The user's user mode.</span>
<a href="#l20.91"></a><span id="l20.91">   _modes: null,</span>
<a href="#l20.92"></a><span id="l20.92">   _userModeReceived: false,</span>
<a href="#l20.93"></a><span id="l20.93">   setUserMode(aNick, aNewModes, aSetter, aDisplayFullMode) {</span>
<a href="#l20.94"></a><span id="l20.94">     if (this.normalizeNick(aNick) != this.normalizeNick(this._nickname)) {</span>
<a href="#l20.95"></a><span id="l20.95" class="difflineminus">-      WARN(&quot;Received unexpected mode for &quot; + aNick);</span>
<a href="#l20.96"></a><span id="l20.96" class="difflineplus">+      this.WARN(&quot;Received unexpected mode for &quot; + aNick);</span>
<a href="#l20.97"></a><span id="l20.97">       return false;</span>
<a href="#l20.98"></a><span id="l20.98">     }</span>
<a href="#l20.99"></a><span id="l20.99"> </span>
<a href="#l20.100"></a><span id="l20.100">     // Are modes being added or removed?</span>
<a href="#l20.101"></a><span id="l20.101">     let addNewMode = aNewModes[0] == &quot;+&quot;;</span>
<a href="#l20.102"></a><span id="l20.102">     if (!addNewMode &amp;&amp; aNewModes[0] != &quot;-&quot;) {</span>
<a href="#l20.103"></a><span id="l20.103" class="difflineminus">-      WARN(&quot;Invalid mode string: &quot; + aNewModes);</span>
<a href="#l20.104"></a><span id="l20.104" class="difflineplus">+      this.WARN(&quot;Invalid mode string: &quot; + aNewModes);</span>
<a href="#l20.105"></a><span id="l20.105">       return false;</span>
<a href="#l20.106"></a><span id="l20.106">     }</span>
<a href="#l20.107"></a><span id="l20.107">     _setMode.call(this, addNewMode, aNewModes.slice(1));</span>
<a href="#l20.108"></a><span id="l20.108"> </span>
<a href="#l20.109"></a><span id="l20.109">     // The server informs us of the user's mode when connecting.</span>
<a href="#l20.110"></a><span id="l20.110">     // We should not report this initial mode message as a mode change</span>
<a href="#l20.111"></a><span id="l20.111">     // initiated by the user, but instead display the full mode</span>
<a href="#l20.112"></a><span id="l20.112">     // and then remember we have done so.</span>
<a href="#l20.113"></a><span id="l20.113" class="difflineat">@@ -1218,17 +1223,19 @@ ircAccount.prototype = {</span>
<a href="#l20.114"></a><span id="l20.114">           whoisInformation.serverInfo);</span>
<a href="#l20.115"></a><span id="l20.115">     }</span>
<a href="#l20.116"></a><span id="l20.116"> </span>
<a href="#l20.117"></a><span id="l20.117">     // Sort the list of channels, ignoring the prefixes of channel and user.</span>
<a href="#l20.118"></a><span id="l20.118">     let prefixes = this.userPrefixes.concat(this.channelPrefixes);</span>
<a href="#l20.119"></a><span id="l20.119">     let sortWithoutPrefix = function(a, b) {</span>
<a href="#l20.120"></a><span id="l20.120">       a = this.normalize(a, prefixes);</span>
<a href="#l20.121"></a><span id="l20.121">       b = this.normalize(b, prefixes);</span>
<a href="#l20.122"></a><span id="l20.122" class="difflineminus">-      return a &lt; b ? -1 : a &gt; b ? 1 : 0;</span>
<a href="#l20.123"></a><span id="l20.123" class="difflineplus">+      if (a &lt; b)</span>
<a href="#l20.124"></a><span id="l20.124" class="difflineplus">+        return -1;</span>
<a href="#l20.125"></a><span id="l20.125" class="difflineplus">+      return a &gt; b ? 1 : 0;</span>
<a href="#l20.126"></a><span id="l20.126">     }.bind(this);</span>
<a href="#l20.127"></a><span id="l20.127">     let sortChannels = channels =&gt;</span>
<a href="#l20.128"></a><span id="l20.128">       channels.trim().split(/\s+/).sort(sortWithoutPrefix).join(&quot; &quot;);</span>
<a href="#l20.129"></a><span id="l20.129"> </span>
<a href="#l20.130"></a><span id="l20.130">     // Convert booleans into a human-readable form.</span>
<a href="#l20.131"></a><span id="l20.131">     let normalizeBool = aBool =&gt; _(aBool ? &quot;yes&quot; : &quot;no&quot;);</span>
<a href="#l20.132"></a><span id="l20.132"> </span>
<a href="#l20.133"></a><span id="l20.133">     // Convert timespan in seconds into a human-readable form.</span>
<a href="#l20.134"></a><span id="l20.134" class="difflineat">@@ -1504,23 +1511,27 @@ ircAccount.prototype = {</span>
<a href="#l20.135"></a><span id="l20.135">   countBytes(aStr) {</span>
<a href="#l20.136"></a><span id="l20.136">     // Assume that if it's not UTF-8 then each character is 1 byte.</span>
<a href="#l20.137"></a><span id="l20.137">     if (this._encoding != &quot;UTF-8&quot;)</span>
<a href="#l20.138"></a><span id="l20.138">       return aStr.length;</span>
<a href="#l20.139"></a><span id="l20.139"> </span>
<a href="#l20.140"></a><span id="l20.140">     // Count the number of bytes in a UTF-8 encoded string.</span>
<a href="#l20.141"></a><span id="l20.141">     function charCodeToByteCount(c) {</span>
<a href="#l20.142"></a><span id="l20.142">       // UTF-8 stores:</span>
<a href="#l20.143"></a><span id="l20.143" class="difflineminus">-      // - code points below U+0080 on 1 byte,</span>
<a href="#l20.144"></a><span id="l20.144" class="difflineminus">-      // - code points below U+0800 on 2 bytes,</span>
<a href="#l20.145"></a><span id="l20.145" class="difflineplus">+      // - code points below U+0080 are 1 byte,</span>
<a href="#l20.146"></a><span id="l20.146" class="difflineplus">+      // - code points below U+0800 are 2 bytes,</span>
<a href="#l20.147"></a><span id="l20.147">       // - code points U+D800 through U+DFFF are UTF-16 surrogate halves</span>
<a href="#l20.148"></a><span id="l20.148">       // (they indicate that JS has split a 4 bytes UTF-8 character</span>
<a href="#l20.149"></a><span id="l20.149">       // in two halves of 2 bytes each),</span>
<a href="#l20.150"></a><span id="l20.150" class="difflineminus">-      // - other code points on 3 bytes.</span>
<a href="#l20.151"></a><span id="l20.151" class="difflineminus">-      return c &lt; 0x80 ? 1 : (c &lt; 0x800 || (c &gt;= 0xD800 &amp;&amp; c &lt;= 0xDFFF)) ? 2 : 3;</span>
<a href="#l20.152"></a><span id="l20.152" class="difflineplus">+      // - other code points are 3 bytes.</span>
<a href="#l20.153"></a><span id="l20.153" class="difflineplus">+      if (c &lt; 0x80)</span>
<a href="#l20.154"></a><span id="l20.154" class="difflineplus">+        return 1;</span>
<a href="#l20.155"></a><span id="l20.155" class="difflineplus">+      if (c &lt; 0x800 || (c &gt;= 0xD800 &amp;&amp; c &lt;= 0xDFFF))</span>
<a href="#l20.156"></a><span id="l20.156" class="difflineplus">+        return 2;</span>
<a href="#l20.157"></a><span id="l20.157" class="difflineplus">+      return 3;</span>
<a href="#l20.158"></a><span id="l20.158">     }</span>
<a href="#l20.159"></a><span id="l20.159">     let bytes = 0;</span>
<a href="#l20.160"></a><span id="l20.160">     for (let i = 0; i &lt; aStr.length; i++)</span>
<a href="#l20.161"></a><span id="l20.161">       bytes += charCodeToByteCount(aStr.charCodeAt(i));</span>
<a href="#l20.162"></a><span id="l20.162">     return bytes;</span>
<a href="#l20.163"></a><span id="l20.163">   },</span>
<a href="#l20.164"></a><span id="l20.164"> </span>
<a href="#l20.165"></a><span id="l20.165">   // To check if users are online, we need to queue multiple messages.</span>
<a href="#l20.166"></a><span id="l20.166" class="difflineat">@@ -1844,16 +1855,17 @@ ircAccount.prototype = {</span>
<a href="#l20.167"></a><span id="l20.167">     // If aParams is not an array, consider it to be a single parameter and put</span>
<a href="#l20.168"></a><span id="l20.168">     // it into an array.</span>
<a href="#l20.169"></a><span id="l20.169">     let params = Array.isArray(aParams) ? aParams : [aParams];</span>
<a href="#l20.170"></a><span id="l20.170">     if (params.length)</span>
<a href="#l20.171"></a><span id="l20.171">       ircParam += &quot; &quot; + params.join(&quot; &quot;);</span>
<a href="#l20.172"></a><span id="l20.172"> </span>
<a href="#l20.173"></a><span id="l20.173">     // High/CTCP level quoting, replace \134 or \001 with \134\134 or \134a,</span>
<a href="#l20.174"></a><span id="l20.174">     // respectively. This is only done inside the extended data message.</span>
<a href="#l20.175"></a><span id="l20.175" class="difflineplus">+    // eslint-disable-next-line no-control-regex</span>
<a href="#l20.176"></a><span id="l20.176">     const highRegex = /\\|\x01/g;</span>
<a href="#l20.177"></a><span id="l20.177">     ircParam = ircParam.replace(highRegex,</span>
<a href="#l20.178"></a><span id="l20.178">       aChar =&gt; &quot;\\&quot; + (aChar == &quot;\\&quot; ? &quot;\\&quot; : &quot;a&quot;));</span>
<a href="#l20.179"></a><span id="l20.179"> </span>
<a href="#l20.180"></a><span id="l20.180">     // Add the CTCP tagging.</span>
<a href="#l20.181"></a><span id="l20.181">     ircParam = &quot;\x01&quot; + ircParam + &quot;\x01&quot;;</span>
<a href="#l20.182"></a><span id="l20.182"> </span>
<a href="#l20.183"></a><span id="l20.183">     // Send the IRC message as a NOTICE or PRIVMSG.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/chat/protocols/irc/ircCTCP.jsm</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/chat/protocols/irc/ircCTCP.jsm</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -21,17 +21,21 @@ function CTCPMessage(aMessage, aRawCTCPM</span>
<a href="#l21.4"></a><span id="l21.4">   let message = Object.assign({}, aMessage);</span>
<a href="#l21.5"></a><span id="l21.5">   message.ctcp = {};</span>
<a href="#l21.6"></a><span id="l21.6">   message.ctcp.rawMessage = aRawCTCPMessage;</span>
<a href="#l21.7"></a><span id="l21.7"> </span>
<a href="#l21.8"></a><span id="l21.8">   // High/CTCP level dequote: replace the quote char \134 followed by a or \134</span>
<a href="#l21.9"></a><span id="l21.9">   // with \001 or \134, respectively. Any other character after \134 is replaced</span>
<a href="#l21.10"></a><span id="l21.10">   // with itself.</span>
<a href="#l21.11"></a><span id="l21.11">   let dequotedCTCPMessage = message.ctcp.rawMessage.replace(/\\(.|$)/g,</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-    aStr =&gt; aStr[1] ? (aStr[1] == &quot;a&quot; ? &quot;\x01&quot; : aStr[1]) : &quot;&quot;);</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineplus">+    aStr =&gt; {</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineplus">+      if (aStr[1])</span>
<a href="#l21.15"></a><span id="l21.15" class="difflineplus">+        return aStr[1] == &quot;a&quot; ? &quot;\x01&quot; : aStr[1];</span>
<a href="#l21.16"></a><span id="l21.16" class="difflineplus">+      return &quot;&quot;;</span>
<a href="#l21.17"></a><span id="l21.17" class="difflineplus">+    });</span>
<a href="#l21.18"></a><span id="l21.18"> </span>
<a href="#l21.19"></a><span id="l21.19">   let separator = dequotedCTCPMessage.indexOf(&quot; &quot;);</span>
<a href="#l21.20"></a><span id="l21.20">   // If there's no space, then only a command is given.</span>
<a href="#l21.21"></a><span id="l21.21">   // Do not capitalize the command, case sensitive</span>
<a href="#l21.22"></a><span id="l21.22">   if (separator == -1) {</span>
<a href="#l21.23"></a><span id="l21.23">     message.ctcp.command = dequotedCTCPMessage;</span>
<a href="#l21.24"></a><span id="l21.24">     message.ctcp.param = &quot;&quot;;</span>
<a href="#l21.25"></a><span id="l21.25">   }</span>
<a href="#l21.26"></a><span id="l21.26" class="difflineat">@@ -63,16 +67,17 @@ function ctcpHandleMessage(aMessage) {</span>
<a href="#l21.27"></a><span id="l21.27">     return false;</span>
<a href="#l21.28"></a><span id="l21.28"> </span>
<a href="#l21.29"></a><span id="l21.29">   // The raw CTCP message is in the last parameter of the IRC message.</span>
<a href="#l21.30"></a><span id="l21.30">   let rawCTCPParam = aMessage.params.slice(-1)[0];</span>
<a href="#l21.31"></a><span id="l21.31"> </span>
<a href="#l21.32"></a><span id="l21.32">   // Split the raw message into the multiple CTCP messages and pull out the</span>
<a href="#l21.33"></a><span id="l21.33">   // command and parameters.</span>
<a href="#l21.34"></a><span id="l21.34">   let ctcpMessages = [];</span>
<a href="#l21.35"></a><span id="l21.35" class="difflineplus">+  // eslint-disable-next-line no-control-regex</span>
<a href="#l21.36"></a><span id="l21.36">   let otherMessage = rawCTCPParam.replace(/\x01([^\x01]*)\x01/g,</span>
<a href="#l21.37"></a><span id="l21.37">     function(aMatch, aMsg) {</span>
<a href="#l21.38"></a><span id="l21.38">       if (aMsg)</span>
<a href="#l21.39"></a><span id="l21.39">         ctcpMessages.push(new CTCPMessage(aMessage, aMsg));</span>
<a href="#l21.40"></a><span id="l21.40">       return &quot;&quot;;</span>
<a href="#l21.41"></a><span id="l21.41">     });</span>
<a href="#l21.42"></a><span id="l21.42"> </span>
<a href="#l21.43"></a><span id="l21.43">   // If no CTCP messages were found, return false.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/chat/protocols/irc/ircCommands.jsm</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/chat/protocols/irc/ircCommands.jsm</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -341,16 +341,17 @@ var commands = [</span>
<a href="#l22.4"></a><span id="l22.4">     get helpString() { return _(&quot;command.msg&quot;, &quot;msg&quot;); },</span>
<a href="#l22.5"></a><span id="l22.5">     run: messageCommand,</span>
<a href="#l22.6"></a><span id="l22.6">   },</span>
<a href="#l22.7"></a><span id="l22.7">   {</span>
<a href="#l22.8"></a><span id="l22.8">     name: &quot;nick&quot;,</span>
<a href="#l22.9"></a><span id="l22.9">     get helpString() { return _(&quot;command.nick&quot;, &quot;nick&quot;); },</span>
<a href="#l22.10"></a><span id="l22.10">     run(aMsg, aConv) {</span>
<a href="#l22.11"></a><span id="l22.11">       let newNick = aMsg.trim();</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineplus">+      // eslint-disable-next-line mozilla/use-includes-instead-of-indexOf</span>
<a href="#l22.13"></a><span id="l22.13">       if (newNick.indexOf(/\s+/) != -1)</span>
<a href="#l22.14"></a><span id="l22.14">         return false;</span>
<a href="#l22.15"></a><span id="l22.15"> </span>
<a href="#l22.16"></a><span id="l22.16">       let account = getAccount(aConv);</span>
<a href="#l22.17"></a><span id="l22.17">       // The user wants to change their nick, so overwrite the account</span>
<a href="#l22.18"></a><span id="l22.18">       // nickname for this session.</span>
<a href="#l22.19"></a><span id="l22.19">       account._requestedNickname = newNick;</span>
<a href="#l22.20"></a><span id="l22.20">       account.changeNick(newNick);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/chat/protocols/irc/ircUtils.jsm</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/chat/protocols/irc/ircUtils.jsm</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -1,28 +1,24 @@</span>
<a href="#l23.4"></a><span id="l23.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l23.5"></a><span id="l23.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l23.6"></a><span id="l23.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l23.7"></a><span id="l23.7"> </span>
<a href="#l23.8"></a><span id="l23.8" class="difflineminus">-this.EXPORTED_SYMBOLS = [&quot;_&quot;, &quot;_conv&quot;, &quot;ctcpFormatToText&quot;, &quot;ctcpFormatToHTML&quot;,</span>
<a href="#l23.9"></a><span id="l23.9" class="difflineplus">+this.EXPORTED_SYMBOLS = [&quot;_&quot;, &quot;ctcpFormatToText&quot;, &quot;ctcpFormatToHTML&quot;,</span>
<a href="#l23.10"></a><span id="l23.10">                           &quot;conversationErrorMessage&quot;, &quot;kListRefreshInterval&quot;];</span>
<a href="#l23.11"></a><span id="l23.11"> </span>
<a href="#l23.12"></a><span id="l23.12"> var {</span>
<a href="#l23.13"></a><span id="l23.13">   XPCOMUtils,</span>
<a href="#l23.14"></a><span id="l23.14">   l10nHelper,</span>
<a href="#l23.15"></a><span id="l23.15"> } = ChromeUtils.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l23.16"></a><span id="l23.16"> </span>
<a href="#l23.17"></a><span id="l23.17"> XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l23.18"></a><span id="l23.18">   l10nHelper(&quot;chrome://chat/locale/irc.properties&quot;)</span>
<a href="#l23.19"></a><span id="l23.19"> );</span>
<a href="#l23.20"></a><span id="l23.20"> </span>
<a href="#l23.21"></a><span id="l23.21" class="difflineminus">-XPCOMUtils.defineLazyGetter(this, &quot;_conv&quot;, () =&gt;</span>
<a href="#l23.22"></a><span id="l23.22" class="difflineminus">-  l10nHelper(&quot;chrome://chat/locale/conversations.properties&quot;)</span>
<a href="#l23.23"></a><span id="l23.23" class="difflineminus">-);</span>
<a href="#l23.24"></a><span id="l23.24" class="difflineminus">-</span>
<a href="#l23.25"></a><span id="l23.25"> XPCOMUtils.defineLazyGetter(this, &quot;TXTToHTML&quot;, function() {</span>
<a href="#l23.26"></a><span id="l23.26">   let cs = Cc[&quot;@mozilla.org/txttohtmlconv;1&quot;].getService(Ci.mozITXTToHTMLConv);</span>
<a href="#l23.27"></a><span id="l23.27">   return aTXT =&gt; cs.scanTXT(aTXT, cs.kEntities);</span>
<a href="#l23.28"></a><span id="l23.28"> });</span>
<a href="#l23.29"></a><span id="l23.29"> </span>
<a href="#l23.30"></a><span id="l23.30"> // The timespan after which we consider LIST roomInfo to be stale.</span>
<a href="#l23.31"></a><span id="l23.31"> var kListRefreshInterval = 12 * 60 * 60 * 1000; // 12 hours.</span>
<a href="#l23.32"></a><span id="l23.32"> </span>
<a href="#l23.33"></a><span id="l23.33" class="difflineat">@@ -35,22 +31,24 @@ var kListRefreshInterval = 12 * 60 * 60 </span>
<a href="#l23.34"></a><span id="l23.34">  *  aStack  The ordered list of open HTML tags.</span>
<a href="#l23.35"></a><span id="l23.35">  *  aInput  The current input string.</span>
<a href="#l23.36"></a><span id="l23.36">  * There are three output values returned in an array:</span>
<a href="#l23.37"></a><span id="l23.37">  *  The new ordered list of open HTML tags.</span>
<a href="#l23.38"></a><span id="l23.38">  *  The new text output to append.</span>
<a href="#l23.39"></a><span id="l23.39">  *  The number of characters (from the start of the input string) that the</span>
<a href="#l23.40"></a><span id="l23.40">  *  function handled.</span>
<a href="#l23.41"></a><span id="l23.41">  */</span>
<a href="#l23.42"></a><span id="l23.42" class="difflineminus">-var CTCP_TAGS = {&quot;\x02&quot;: &quot;b&quot;, // \002, ^B, Bold</span>
<a href="#l23.43"></a><span id="l23.43" class="difflineminus">-                   &quot;\x16&quot;: &quot;i&quot;, // \026, ^V, Reverse or Inverse (Italics)</span>
<a href="#l23.44"></a><span id="l23.44" class="difflineminus">-                   &quot;\x1D&quot;: &quot;i&quot;, // \035, ^], Italics (mIRC)</span>
<a href="#l23.45"></a><span id="l23.45" class="difflineminus">-                   &quot;\x1F&quot;: &quot;u&quot;, // \037, ^_, Underline</span>
<a href="#l23.46"></a><span id="l23.46" class="difflineminus">-                   &quot;\x03&quot;: mIRCColoring, // \003, ^C, Coloring</span>
<a href="#l23.47"></a><span id="l23.47" class="difflineminus">-                   &quot;\x0F&quot;: null}; // \017, ^O, Clear all formatting</span>
<a href="#l23.48"></a><span id="l23.48" class="difflineplus">+var CTCP_TAGS = {</span>
<a href="#l23.49"></a><span id="l23.49" class="difflineplus">+  &quot;\x02&quot;: &quot;b&quot;, // \002, ^B, Bold</span>
<a href="#l23.50"></a><span id="l23.50" class="difflineplus">+  &quot;\x16&quot;: &quot;i&quot;, // \026, ^V, Reverse or Inverse (Italics)</span>
<a href="#l23.51"></a><span id="l23.51" class="difflineplus">+  &quot;\x1D&quot;: &quot;i&quot;, // \035, ^], Italics (mIRC)</span>
<a href="#l23.52"></a><span id="l23.52" class="difflineplus">+  &quot;\x1F&quot;: &quot;u&quot;, // \037, ^_, Underline</span>
<a href="#l23.53"></a><span id="l23.53" class="difflineplus">+  &quot;\x03&quot;: mIRCColoring, // \003, ^C, Coloring</span>
<a href="#l23.54"></a><span id="l23.54" class="difflineplus">+  &quot;\x0F&quot;: null, // \017, ^O, Clear all formatting</span>
<a href="#l23.55"></a><span id="l23.55" class="difflineplus">+};</span>
<a href="#l23.56"></a><span id="l23.56"> </span>
<a href="#l23.57"></a><span id="l23.57"> // Generate an expression that will search for any of the control characters.</span>
<a href="#l23.58"></a><span id="l23.58"> var CTCP_TAGS_EXP = new RegExp(&quot;[&quot; + Object.keys(CTCP_TAGS).join(&quot;&quot;) + &quot;]&quot;);</span>
<a href="#l23.59"></a><span id="l23.59"> </span>
<a href="#l23.60"></a><span id="l23.60"> // Remove all CTCP formatting characters.</span>
<a href="#l23.61"></a><span id="l23.61"> function ctcpFormatToText(aString) {</span>
<a href="#l23.62"></a><span id="l23.62">   let next,</span>
<a href="#l23.63"></a><span id="l23.63">       input = aString,</span>
<a href="#l23.64"></a><span id="l23.64" class="difflineat">@@ -135,16 +133,17 @@ function ctcpFormatToHTML(aString) {</span>
<a href="#l23.65"></a><span id="l23.65">     input = input.substr(next.index + length);</span>
<a href="#l23.66"></a><span id="l23.66">   }</span>
<a href="#l23.67"></a><span id="l23.67">   // Return unmatched bits and close any open tags at the end.</span>
<a href="#l23.68"></a><span id="l23.68">   return output + input + closeStack(stack);</span>
<a href="#l23.69"></a><span id="l23.69"> }</span>
<a href="#l23.70"></a><span id="l23.70"> </span>
<a href="#l23.71"></a><span id="l23.71"> // mIRC colors are defined at http://www.mirc.com/colors.html.</span>
<a href="#l23.72"></a><span id="l23.72"> // This expression matches \003&lt;one or two digits&gt;[,&lt;one or two digits&gt;].</span>
<a href="#l23.73"></a><span id="l23.73" class="difflineplus">+// eslint-disable-next-line no-control-regex</span>
<a href="#l23.74"></a><span id="l23.74"> var M_IRC_COLORS_EXP = /^\x03(?:(\d\d?)(?:,(\d\d?))?)?/;</span>
<a href="#l23.75"></a><span id="l23.75"> var M_IRC_COLOR_MAP = {</span>
<a href="#l23.76"></a><span id="l23.76">   &quot;0&quot;: &quot;white&quot;,</span>
<a href="#l23.77"></a><span id="l23.77">   &quot;1&quot;: &quot;black&quot;,</span>
<a href="#l23.78"></a><span id="l23.78">   &quot;2&quot;: &quot;navy&quot;, // blue (navy)</span>
<a href="#l23.79"></a><span id="l23.79">   &quot;3&quot;: &quot;green&quot;,</span>
<a href="#l23.80"></a><span id="l23.80">   &quot;4&quot;: &quot;red&quot;,</span>
<a href="#l23.81"></a><span id="l23.81">   &quot;5&quot;: &quot;maroon&quot;, // brown (maroon)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/chat/protocols/irc/test/test_ircCommands.js</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/chat/protocols/irc/test/test_ircCommands.js</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -197,9 +197,10 @@ function testUserModeCommand() {</span>
<a href="#l24.4"></a><span id="l24.4"> function _getRunCommand(aCommandName) {</span>
<a href="#l24.5"></a><span id="l24.5">   for (let command of commands) {</span>
<a href="#l24.6"></a><span id="l24.6">     if (command.name == aCommandName)</span>
<a href="#l24.7"></a><span id="l24.7">       return command.run;</span>
<a href="#l24.8"></a><span id="l24.8">   }</span>
<a href="#l24.9"></a><span id="l24.9"> </span>
<a href="#l24.10"></a><span id="l24.10">   // Fail if no command was found.</span>
<a href="#l24.11"></a><span id="l24.11">   ok(false, &quot;Could not find the '&quot; + aCommandName + &quot;' command.&quot;);</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineplus">+  return null; // Shut-up eslint.</span>
<a href="#l24.13"></a><span id="l24.13"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/chat/protocols/xmpp/xmpp.jsm</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/chat/protocols/xmpp/xmpp.jsm</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -1669,36 +1669,16 @@ var XMPPAccountPrototype = {</span>
<a href="#l25.4"></a><span id="l25.4"> </span>
<a href="#l25.5"></a><span id="l25.5">       // If this happens, there's a bug somewhere.</span>
<a href="#l25.6"></a><span id="l25.6">       this.ERROR(&quot;HandleErrors was passed a handler for '&quot; + condition +</span>
<a href="#l25.7"></a><span id="l25.7">         &quot;'' which is neither a function nor a string.&quot;);</span>
<a href="#l25.8"></a><span id="l25.8">       return false;</span>
<a href="#l25.9"></a><span id="l25.9">     };</span>
<a href="#l25.10"></a><span id="l25.10">   },</span>
<a href="#l25.11"></a><span id="l25.11"> </span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-  // Send an error stanza in response to the given stanza (rfc6120#8.3).</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineminus">-  // aCondition is the name of the defined-condition child, aText an</span>
<a href="#l25.14"></a><span id="l25.14" class="difflineminus">-  // optional plain-text description.</span>
<a href="#l25.15"></a><span id="l25.15" class="difflineminus">-  sendErrorStanza(aStanza, aCondition, aType, aText) {</span>
<a href="#l25.16"></a><span id="l25.16" class="difflineminus">-    // TODO: Support the other stanza types (message, presence).</span>
<a href="#l25.17"></a><span id="l25.17" class="difflineminus">-    let qName = aStanza.qName;</span>
<a href="#l25.18"></a><span id="l25.18" class="difflineminus">-    if (qName != &quot;iq&quot;) {</span>
<a href="#l25.19"></a><span id="l25.19" class="difflineminus">-      this.ERROR(`Sending an error stanza for a ${qName} stanza is not ` +</span>
<a href="#l25.20"></a><span id="l25.20" class="difflineminus">-                 `implemented yet.`);</span>
<a href="#l25.21"></a><span id="l25.21" class="difflineminus">-      return;</span>
<a href="#l25.22"></a><span id="l25.22" class="difflineminus">-    }</span>
<a href="#l25.23"></a><span id="l25.23" class="difflineminus">-</span>
<a href="#l25.24"></a><span id="l25.24" class="difflineminus">-    let error = Stanza.node(&quot;error&quot;, null, {type: aType},</span>
<a href="#l25.25"></a><span id="l25.25" class="difflineminus">-                            Stanza.node(aCondition, Stanza.NS.stanzas));</span>
<a href="#l25.26"></a><span id="l25.26" class="difflineminus">-    if (aText)</span>
<a href="#l25.27"></a><span id="l25.27" class="difflineminus">-      error.addChild(Stanza.node(&quot;text&quot;, Stanza.NS.stanzas, null, aText));</span>
<a href="#l25.28"></a><span id="l25.28" class="difflineminus">-    return this.sendStanza(Stanza.iq(&quot;error&quot;, aStanza.attributes.id,</span>
<a href="#l25.29"></a><span id="l25.29" class="difflineminus">-      aStanza.attributes.from, error));</span>
<a href="#l25.30"></a><span id="l25.30" class="difflineminus">-  },</span>
<a href="#l25.31"></a><span id="l25.31" class="difflineminus">-</span>
<a href="#l25.32"></a><span id="l25.32">   // Returns a callback suitable for use in sendStanza, to handle type==result</span>
<a href="#l25.33"></a><span id="l25.33">   // responses. aHandlers and aThis are passed on to handleErrors for error</span>
<a href="#l25.34"></a><span id="l25.34">   // handling.</span>
<a href="#l25.35"></a><span id="l25.35">   _handleResult(aHandlers, aThis) {</span>
<a href="#l25.36"></a><span id="l25.36">     return aStanza =&gt; {</span>
<a href="#l25.37"></a><span id="l25.37">       if (aStanza.attributes.type == &quot;result&quot;)</span>
<a href="#l25.38"></a><span id="l25.38">         return true;</span>
<a href="#l25.39"></a><span id="l25.39">       return this.handleErrors(aHandlers, aThis)(aStanza);</span>
<a href="#l25.40"></a><span id="l25.40" class="difflineat">@@ -1947,25 +1927,23 @@ var XMPPAccountPrototype = {</span>
<a href="#l25.41"></a><span id="l25.41">     if (this._pendingList)</span>
<a href="#l25.42"></a><span id="l25.42">       this._roomInfoCallbacks.add(aCallback);</span>
<a href="#l25.43"></a><span id="l25.43">   },</span>
<a href="#l25.44"></a><span id="l25.44"> </span>
<a href="#l25.45"></a><span id="l25.45">   onRoomDiscovery(aStanza) {</span>
<a href="#l25.46"></a><span id="l25.46">     let query = aStanza.getElement([&quot;query&quot;]);</span>
<a href="#l25.47"></a><span id="l25.47">     if (!query || query.uri != Stanza.NS.disco_items) {</span>
<a href="#l25.48"></a><span id="l25.48">       this.LOG(&quot;Could not get rooms for this server: &quot; + this._jid.domain);</span>
<a href="#l25.49"></a><span id="l25.49" class="difflineminus">-      return true;</span>
<a href="#l25.50"></a><span id="l25.50" class="difflineplus">+      return;</span>
<a href="#l25.51"></a><span id="l25.51">     }</span>
<a href="#l25.52"></a><span id="l25.52"> </span>
<a href="#l25.53"></a><span id="l25.53">     // XEP-0059: Result Set Management.</span>
<a href="#l25.54"></a><span id="l25.54">     let set = query.getElement([&quot;set&quot;]);</span>
<a href="#l25.55"></a><span id="l25.55">     let last = set ? set.getElement([&quot;last&quot;]) : null;</span>
<a href="#l25.56"></a><span id="l25.56">     if (last) {</span>
<a href="#l25.57"></a><span id="l25.57" class="difflineminus">-      let after = Stanza.node(&quot;after&quot;, null, null, last.innerText);</span>
<a href="#l25.58"></a><span id="l25.58" class="difflineminus">-      let setNode = Stanza.node(&quot;set&quot;, Stanza.NS.rsm, null, after);</span>
<a href="#l25.59"></a><span id="l25.59">       let iq = Stanza.iq(&quot;get&quot;, null, this._mucService,</span>
<a href="#l25.60"></a><span id="l25.60">                          Stanza.node(&quot;query&quot;, Stanza.NS.disco_items));</span>
<a href="#l25.61"></a><span id="l25.61">       this.sendStanza(iq, this.onRoomDiscovery, this);</span>
<a href="#l25.62"></a><span id="l25.62">     }</span>
<a href="#l25.63"></a><span id="l25.63">     else</span>
<a href="#l25.64"></a><span id="l25.64">       this._pendingList = false;</span>
<a href="#l25.65"></a><span id="l25.65"> </span>
<a href="#l25.66"></a><span id="l25.66">     let rooms = [];</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

