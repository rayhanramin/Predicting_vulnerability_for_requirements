<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 794:093282385810477a6776cda35acce28a17799650</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 093282385810477a6776cda35acce28a17799650" />
<meta property="og:url" content="/comm-central/rev/093282385810477a6776cda35acce28a17799650" />
<meta property="og:description" content="Fix bug 462026 - 301 and 302 redirects not done properly with caldav provider. r=dbo" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 093282385810477a6776cda35acce28a17799650 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/093282385810477a6776cda35acce28a17799650">shortlog</a> |
<a href="/comm-central/log/093282385810477a6776cda35acce28a17799650">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/093282385810477a6776cda35acce28a17799650">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/093282385810477a6776cda35acce28a17799650">files</a> |
changeset |
<a href="/comm-central/raw-rev/093282385810477a6776cda35acce28a17799650">raw</a>  | <a href="/comm-central/archive/093282385810477a6776cda35acce28a17799650.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
Fix <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=462026">bug 462026</a> - 301 and 302 redirects not done properly with caldav provider. r=dbo
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#80;&#104;&#105;&#108;&#105;&#112;&#112;&#32;&#75;&#101;&#119;&#105;&#115;&#99;&#104;&#32;&#60;&#109;&#111;&#122;&#105;&#108;&#108;&#97;&#64;&#107;&#101;&#119;&#105;&#115;&#46;&#99;&#104;&#62;</td></tr>
<tr><td></td><td class="date age">Sun, 02 Nov 2008 19:35:03 +0100</td></tr>

<tr>
 <td>changeset 794</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/093282385810477a6776cda35acce28a17799650">093282385810477a6776cda35acce28a17799650</a></td>
</tr>



<tr>
<td>parent 793</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/67040cc96e525c09df10aea6ad007b26f6925936">67040cc96e525c09df10aea6ad007b26f6925936</a>
</td>
</tr>

<tr>
<td>child 795</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/2d18512704e72cdcfc647c2ad667b89cd444a7f0">2d18512704e72cdcfc647c2ad667b89cd444a7f0</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=093282385810477a6776cda35acce28a17799650">719</a></td></tr>
<tr><td>push user</td><td>mozilla@kewis.ch</td></tr>
<tr><td>push date</td><td class="date age">Sun, 02 Nov 2008 18:35:50 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@093282385810 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=093282385810477a6776cda35acce28a17799650">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=093282385810477a6776cda35acce28a17799650&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=093282385810477a6776cda35acce28a17799650&newProject=comm-central&newRevision=093282385810477a6776cda35acce28a17799650&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=093282385810477a6776cda35acce28a17799650&newProject=comm-central&newRevision=093282385810477a6776cda35acce28a17799650&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=093282385810477a6776cda35acce28a17799650&newProject=comm-central&newRevision=093282385810477a6776cda35acce28a17799650&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28dbo%29&revcount=50">dbo</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=462026">462026</a></td></tr>




</table></div>

<div class="page_body description">Fix <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=462026">bug 462026</a> - 301 and 302 redirects not done properly with caldav provider. r=dbo</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/093282385810477a6776cda35acce28a17799650/calendar/base/src/calProviderUtils.js">calendar/base/src/calProviderUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/093282385810477a6776cda35acce28a17799650/calendar/base/src/calProviderUtils.js">file</a> |
<a href="/comm-central/annotate/093282385810477a6776cda35acce28a17799650/calendar/base/src/calProviderUtils.js">annotate</a> |
<a href="/comm-central/diff/093282385810477a6776cda35acce28a17799650/calendar/base/src/calProviderUtils.js">diff</a> |
<a href="/comm-central/comparison/093282385810477a6776cda35acce28a17799650/calendar/base/src/calProviderUtils.js">comparison</a> |
<a href="/comm-central/log/093282385810477a6776cda35acce28a17799650/calendar/base/src/calProviderUtils.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/093282385810477a6776cda35acce28a17799650/calendar/providers/caldav/calDavCalendar.js">calendar/providers/caldav/calDavCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/093282385810477a6776cda35acce28a17799650/calendar/providers/caldav/calDavCalendar.js">file</a> |
<a href="/comm-central/annotate/093282385810477a6776cda35acce28a17799650/calendar/providers/caldav/calDavCalendar.js">annotate</a> |
<a href="/comm-central/diff/093282385810477a6776cda35acce28a17799650/calendar/providers/caldav/calDavCalendar.js">diff</a> |
<a href="/comm-central/comparison/093282385810477a6776cda35acce28a17799650/calendar/providers/caldav/calDavCalendar.js">comparison</a> |
<a href="/comm-central/log/093282385810477a6776cda35acce28a17799650/calendar/providers/caldav/calDavCalendar.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/calendar/base/src/calProviderUtils.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/calendar/base/src/calProviderUtils.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -39,39 +39,51 @@</span>
<a href="#l1.4"></a><span id="l1.4"> /*</span>
<a href="#l1.5"></a><span id="l1.5">  * Using this file requires calUtils.js to be loaded</span>
<a href="#l1.6"></a><span id="l1.6">  */</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8"> /**</span>
<a href="#l1.9"></a><span id="l1.9">  * Prepare HTTP channel with standard request headers and upload</span>
<a href="#l1.10"></a><span id="l1.10">  * data/content-type if needed</span>
<a href="#l1.11"></a><span id="l1.11">  *</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">- * @param arUri                      channel Uri</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">- * @param aUploadData                data to be uploaded, if any</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">- * @param aContentType               value for Content-Type header, if any</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineminus">- * @param aNotificationCallbacks     calendar using channel</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+ * @param arUri                      Channel Uri, will only be used for a new</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+ *                                     channel.</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+ * @param aUploadData                Data to be uploaded, if any. This may be a</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+ *                                     nsIInputStream or string data. In the</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineplus">+ *                                     latter case the string will be converted</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineplus">+ *                                     to an input stream.</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineplus">+ * @param aContentType               Value for Content-Type header, if any</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineplus">+ * @param aNotificationCallbacks     Calendar using channel</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineplus">+ * @param aExisting                  An existing channel to modify (optional)</span>
<a href="#l1.25"></a><span id="l1.25">  */</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineminus">-function calPrepHttpChannel(aUri, aUploadData, aContentType, aNotificationCallbacks) {</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineminus">-    var ioService = getIOService();</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineminus">-    var channel = ioService.newChannelFromURI(aUri);</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineminus">-    var httpchannel = channel.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineplus">+function calPrepHttpChannel(aUri, aUploadData, aContentType, aNotificationCallbacks, aExisting) {</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+    let ioService = getIOService();</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+    let channel = aExisting || ioService.newChannelFromURI(aUri);</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+    let httpchannel = channel.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l1.34"></a><span id="l1.34"> </span>
<a href="#l1.35"></a><span id="l1.35">     httpchannel.setRequestHeader(&quot;Accept&quot;, &quot;text/xml&quot;, false);</span>
<a href="#l1.36"></a><span id="l1.36">     httpchannel.setRequestHeader(&quot;Accept-Charset&quot;, &quot;utf-8,*;q=0.1&quot;, false);</span>
<a href="#l1.37"></a><span id="l1.37">     httpchannel.loadFlags |= Components.interfaces.nsIRequest.LOAD_BYPASS_CACHE;</span>
<a href="#l1.38"></a><span id="l1.38">     httpchannel.notificationCallbacks = aNotificationCallbacks;</span>
<a href="#l1.39"></a><span id="l1.39"> </span>
<a href="#l1.40"></a><span id="l1.40">     if (aUploadData) {</span>
<a href="#l1.41"></a><span id="l1.41">         httpchannel = httpchannel.QueryInterface(Components.interfaces.nsIUploadChannel);</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineminus">-</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineminus">-        var converter =</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineminus">-            Components.classes[&quot;@mozilla.org/intl/scriptableunicodeconverter&quot;]</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineminus">-                      .createInstance(Components.interfaces.nsIScriptableUnicodeConverter);</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineminus">-        converter.charset = &quot;UTF-8&quot;;</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineminus">-        var stream = converter.convertToInputStream(aUploadData);</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineplus">+        let stream;</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineplus">+        if (aUploadData instanceof Components.interfaces.nsIInputStream) {</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineplus">+            // Make sure the stream is reset</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineplus">+            stream = aUploadData.QueryInterface(Components.interfaces.nsISeekableStream);</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineplus">+            stream.seek(Components.interfaces.nsISeekableStream.NS_SEEK_SET, 0);</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineplus">+        } else {</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineplus">+            // Otherwise its something that should be a string, convert it.</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineplus">+            let converter =</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineplus">+                Components.classes[&quot;@mozilla.org/intl/scriptableunicodeconverter&quot;]</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineplus">+                          .createInstance(Components.interfaces.nsIScriptableUnicodeConverter);</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineplus">+            converter.charset = &quot;UTF-8&quot;;</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineplus">+            stream = converter.convertToInputStream(aUploadData.toString());</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineplus">+        }</span>
<a href="#l1.61"></a><span id="l1.61"> </span>
<a href="#l1.62"></a><span id="l1.62">         httpchannel.setUploadStream(stream, aContentType, -1);</span>
<a href="#l1.63"></a><span id="l1.63">     }</span>
<a href="#l1.64"></a><span id="l1.64"> </span>
<a href="#l1.65"></a><span id="l1.65">     return httpchannel;</span>
<a href="#l1.66"></a><span id="l1.66"> }</span>
<a href="#l1.67"></a><span id="l1.67"> </span>
<a href="#l1.68"></a><span id="l1.68"> /**</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/calendar/providers/caldav/calDavCalendar.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/calendar/providers/caldav/calDavCalendar.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -460,19 +460,20 @@ calDavCalendar.prototype = {</span>
<a href="#l2.4"></a><span id="l2.4">         var itemUri = this.makeUri(locationPath);</span>
<a href="#l2.5"></a><span id="l2.5">         LOG(&quot;CalDAV: itemUri.spec = &quot; + itemUri.spec);</span>
<a href="#l2.6"></a><span id="l2.6"> </span>
<a href="#l2.7"></a><span id="l2.7">         var addListener = {};</span>
<a href="#l2.8"></a><span id="l2.8">         var thisCalendar = this;</span>
<a href="#l2.9"></a><span id="l2.9">         addListener.onStreamComplete =</span>
<a href="#l2.10"></a><span id="l2.10">             function onPutComplete(aLoader, aContext, aStatus, aResultLength,</span>
<a href="#l2.11"></a><span id="l2.11">                                    aResult) {</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-            var status;</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+            let request = aLoader.request;</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+            let status;</span>
<a href="#l2.15"></a><span id="l2.15">             try {</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineminus">-                status = aContext.responseStatus;</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+                status = request.responseStatus;</span>
<a href="#l2.18"></a><span id="l2.18">             } catch (ex) {</span>
<a href="#l2.19"></a><span id="l2.19">                 status = Components.interfaces.calIErrors.DAV_PUT_ERROR;</span>
<a href="#l2.20"></a><span id="l2.20">             }</span>
<a href="#l2.21"></a><span id="l2.21">             if (thisCalendar.verboseLogging()) {</span>
<a href="#l2.22"></a><span id="l2.22">                 var str = convertByteArray(aResult, aResultLength);</span>
<a href="#l2.23"></a><span id="l2.23">                 LOG(&quot;CalDAV: recv: &quot; + (str || &quot;&quot;));</span>
<a href="#l2.24"></a><span id="l2.24">             }</span>
<a href="#l2.25"></a><span id="l2.25">             // 201 = HTTP &quot;Created&quot;</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineat">@@ -563,19 +564,20 @@ calDavCalendar.prototype = {</span>
<a href="#l2.27"></a><span id="l2.27"> </span>
<a href="#l2.28"></a><span id="l2.28">         var modListener = {};</span>
<a href="#l2.29"></a><span id="l2.29">         modListener.onStreamComplete =</span>
<a href="#l2.30"></a><span id="l2.30">             function caldav_mod_onStreamComplete(aLoader, aContext, aStatus,</span>
<a href="#l2.31"></a><span id="l2.31">                                                  aResultLength, aResult) {</span>
<a href="#l2.32"></a><span id="l2.32">             // 200 = HTTP &quot;OK&quot;</span>
<a href="#l2.33"></a><span id="l2.33">             // 204 = HTTP &quot;No Content&quot;</span>
<a href="#l2.34"></a><span id="l2.34">             //</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineminus">-            var status;</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+            let request = aLoader.request;</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+            let status;</span>
<a href="#l2.38"></a><span id="l2.38">             try {</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineminus">-                status = aContext.responseStatus;</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineplus">+                status = request.responseStatus;</span>
<a href="#l2.41"></a><span id="l2.41">             } catch (ex) {</span>
<a href="#l2.42"></a><span id="l2.42">                 status = Components.interfaces.calIErrors.DAV_PUT_ERROR;</span>
<a href="#l2.43"></a><span id="l2.43">             }</span>
<a href="#l2.44"></a><span id="l2.44"> </span>
<a href="#l2.45"></a><span id="l2.45">             // We should not accept a 201 status here indefinitely: it indicates a server error</span>
<a href="#l2.46"></a><span id="l2.46">             // of some kind that we want to know about. It's convenient to accept it for now</span>
<a href="#l2.47"></a><span id="l2.47">             // since a number of server impls don't get this right yet.</span>
<a href="#l2.48"></a><span id="l2.48">             if (status == 204 || status == 201 || status == 200) {</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineat">@@ -657,19 +659,20 @@ calDavCalendar.prototype = {</span>
<a href="#l2.50"></a><span id="l2.50">         }</span>
<a href="#l2.51"></a><span id="l2.51"> </span>
<a href="#l2.52"></a><span id="l2.52">         var delListener = {};</span>
<a href="#l2.53"></a><span id="l2.53">         var thisCalendar = this;</span>
<a href="#l2.54"></a><span id="l2.54">         var realListener = aListener; // need to access from callback</span>
<a href="#l2.55"></a><span id="l2.55"> </span>
<a href="#l2.56"></a><span id="l2.56">         delListener.onStreamComplete =</span>
<a href="#l2.57"></a><span id="l2.57">         function caldav_dDI_del_onStreamComplete(aLoader, aContext, aStatus, aResultLength, aResult) {</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineminus">-            var status;</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineplus">+            let request = aLoader.request;</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineplus">+            let status;</span>
<a href="#l2.61"></a><span id="l2.61">             try {</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineminus">-                status = aContext.responseStatus;</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineplus">+                status = request.responseStatus;</span>
<a href="#l2.64"></a><span id="l2.64">             } catch (ex) {</span>
<a href="#l2.65"></a><span id="l2.65">                 status = Components.interfaces.calIErrors.DAV_REMOVE_ERROR;</span>
<a href="#l2.66"></a><span id="l2.66">             }</span>
<a href="#l2.67"></a><span id="l2.67"> </span>
<a href="#l2.68"></a><span id="l2.68">             // 204 = HTTP &quot;No content&quot;</span>
<a href="#l2.69"></a><span id="l2.69">             //</span>
<a href="#l2.70"></a><span id="l2.70">             if (status == 204 || status == 200) {</span>
<a href="#l2.71"></a><span id="l2.71">                 if (!aFromInBox) {</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineat">@@ -700,18 +703,19 @@ calDavCalendar.prototype = {</span>
<a href="#l2.73"></a><span id="l2.73">             } else {</span>
<a href="#l2.74"></a><span id="l2.74">                 LOG(&quot;CalDAV: Unexpected status deleting item: &quot; + status);</span>
<a href="#l2.75"></a><span id="l2.75">                 thisCalendar.reportDavError(Components.interfaces.calIErrors.DAV_REMOVE_ERROR);</span>
<a href="#l2.76"></a><span id="l2.76">             }</span>
<a href="#l2.77"></a><span id="l2.77">         };</span>
<a href="#l2.78"></a><span id="l2.78">         var delListener2 = {};</span>
<a href="#l2.79"></a><span id="l2.79">         delListener2.onStreamComplete =</span>
<a href="#l2.80"></a><span id="l2.80">         function caldav_dDI_del2_onStreamComplete(aLoader, aContext, aStatus, aResultLength, aResult) {</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineminus">-            var status2 = aContext.responseStatus;</span>
<a href="#l2.82"></a><span id="l2.82" class="difflineminus">-            if (status2 == 404) {</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineplus">+            let request = aLoader.request;</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineplus">+            let status = request.responseStatus;</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineplus">+            if (status == 404) {</span>
<a href="#l2.86"></a><span id="l2.86">                 // someone else already deleted it</span>
<a href="#l2.87"></a><span id="l2.87">                 return;</span>
<a href="#l2.88"></a><span id="l2.88">             } else {</span>
<a href="#l2.89"></a><span id="l2.89">                 thisCalendar.promptOverwrite(CALDAV_DELETE_ITEM, aItem,</span>
<a href="#l2.90"></a><span id="l2.90">                                              realListener, null);</span>
<a href="#l2.91"></a><span id="l2.91">             }</span>
<a href="#l2.92"></a><span id="l2.92">         };</span>
<a href="#l2.93"></a><span id="l2.93"> </span>
<a href="#l2.94"></a><span id="l2.94" class="difflineat">@@ -835,18 +839,19 @@ calDavCalendar.prototype = {</span>
<a href="#l2.95"></a><span id="l2.95">                                              &quot;text/xml; charset=utf-8&quot;,</span>
<a href="#l2.96"></a><span id="l2.96">                                              this);</span>
<a href="#l2.97"></a><span id="l2.97">         httpchannel.setRequestHeader(&quot;Depth&quot;, &quot;0&quot;, false);</span>
<a href="#l2.98"></a><span id="l2.98">         httpchannel.requestMethod = &quot;PROPFIND&quot;;</span>
<a href="#l2.99"></a><span id="l2.99"> </span>
<a href="#l2.100"></a><span id="l2.100">         var streamListener = {};</span>
<a href="#l2.101"></a><span id="l2.101">         streamListener.onStreamComplete =</span>
<a href="#l2.102"></a><span id="l2.102">             function safeRefresh_safeRefresh_onStreamComplete(aLoader, aContext, aStatus, aResultLength, aResult) {</span>
<a href="#l2.103"></a><span id="l2.103" class="difflineplus">+            let request = aLoader.request;</span>
<a href="#l2.104"></a><span id="l2.104">             try {</span>
<a href="#l2.105"></a><span id="l2.105" class="difflineminus">-                LOG(&quot;CalDAV: Status &quot; + aContext.responseStatus +</span>
<a href="#l2.106"></a><span id="l2.106" class="difflineplus">+                LOG(&quot;CalDAV: Status &quot; + request.responseStatus +</span>
<a href="#l2.107"></a><span id="l2.107">                     &quot; checking ctag for calendar &quot; + thisCalendar.name);</span>
<a href="#l2.108"></a><span id="l2.108">             } catch (ex) {</span>
<a href="#l2.109"></a><span id="l2.109">                 LOG(&quot;CalDAV: Error without status on checking ctag for calendar &quot; +</span>
<a href="#l2.110"></a><span id="l2.110">                     thisCalendar.name);</span>
<a href="#l2.111"></a><span id="l2.111">             }</span>
<a href="#l2.112"></a><span id="l2.112"> </span>
<a href="#l2.113"></a><span id="l2.113">             var str = convertByteArray(aResult, aResultLength);</span>
<a href="#l2.114"></a><span id="l2.114">             if (!str) {</span>
<a href="#l2.115"></a><span id="l2.115" class="difflineat">@@ -954,21 +959,22 @@ calDavCalendar.prototype = {</span>
<a href="#l2.116"></a><span id="l2.116"> </span>
<a href="#l2.117"></a><span id="l2.117">         var thisCalendar = this;</span>
<a href="#l2.118"></a><span id="l2.118"> </span>
<a href="#l2.119"></a><span id="l2.119">         var etagListener = {};</span>
<a href="#l2.120"></a><span id="l2.120"> </span>
<a href="#l2.121"></a><span id="l2.121">         etagListener.onStreamComplete =</span>
<a href="#l2.122"></a><span id="l2.122">             function getUpdatedItems_getetag_onStreamComplete(aLoader, aContext, aStatus,</span>
<a href="#l2.123"></a><span id="l2.123">                                                               aResultLength, aResult) {</span>
<a href="#l2.124"></a><span id="l2.124" class="difflineminus">-            var responseStatus;</span>
<a href="#l2.125"></a><span id="l2.125" class="difflineplus">+            let responseStatus;</span>
<a href="#l2.126"></a><span id="l2.126" class="difflineplus">+            let request = aLoader.request;</span>
<a href="#l2.127"></a><span id="l2.127">             try {</span>
<a href="#l2.128"></a><span id="l2.128" class="difflineminus">-                LOG(&quot;CalDAV: Status &quot; + aContext.responseStatus +</span>
<a href="#l2.129"></a><span id="l2.129" class="difflineplus">+                LOG(&quot;CalDAV: Status &quot; + request.responseStatus +</span>
<a href="#l2.130"></a><span id="l2.130">                     &quot; on getetag for calendar &quot; + thisCalendar.name);</span>
<a href="#l2.131"></a><span id="l2.131" class="difflineminus">-                responseStatus = aContext.responseStatus;</span>
<a href="#l2.132"></a><span id="l2.132" class="difflineplus">+                responseStatus = request.responseStatus;</span>
<a href="#l2.133"></a><span id="l2.133">             } catch (ex) {</span>
<a href="#l2.134"></a><span id="l2.134">                 LOG(&quot;CalDAV: Error without status on getetag for calendar &quot; +</span>
<a href="#l2.135"></a><span id="l2.135">                     thisCalendar.name);</span>
<a href="#l2.136"></a><span id="l2.136">                 responseStatus = &quot;none&quot;;</span>
<a href="#l2.137"></a><span id="l2.137">             }</span>
<a href="#l2.138"></a><span id="l2.138"> </span>
<a href="#l2.139"></a><span id="l2.139">             if (responseStatus == 207) {</span>
<a href="#l2.140"></a><span id="l2.140">                 // We only need to parse 207's, anything else is probably a</span>
<a href="#l2.141"></a><span id="l2.141" class="difflineat">@@ -990,17 +996,17 @@ calDavCalendar.prototype = {</span>
<a href="#l2.142"></a><span id="l2.142">                     contenttype = response..D::[&quot;getcontenttype&quot;];</span>
<a href="#l2.143"></a><span id="l2.143">                     // workaround for a Scalix bug which causes incorrect</span>
<a href="#l2.144"></a><span id="l2.144">                     // contenttype to be returned. Remove when that's fixed</span>
<a href="#l2.145"></a><span id="l2.145">                     if (contenttype == &quot;message/rfc822&quot;) {</span>
<a href="#l2.146"></a><span id="l2.146">                         contenttype = &quot;text/calendar&quot;;</span>
<a href="#l2.147"></a><span id="l2.147">                     }</span>
<a href="#l2.148"></a><span id="l2.148">                     // end Scalix workaround</span>
<a href="#l2.149"></a><span id="l2.149">                     if (contenttype.toString().substr(0, 13) != &quot;text/calendar&quot;) {</span>
<a href="#l2.150"></a><span id="l2.150" class="difflineminus">-                          continue;</span>
<a href="#l2.151"></a><span id="l2.151" class="difflineplus">+                        continue;</span>
<a href="#l2.152"></a><span id="l2.152">                     }</span>
<a href="#l2.153"></a><span id="l2.153">                     var href = response..D::[&quot;href&quot;];</span>
<a href="#l2.154"></a><span id="l2.154">                     var resourcePath = thisCalendar.ensurePath(href);</span>
<a href="#l2.155"></a><span id="l2.155">                     itemsReported[resourcePath.toString()] = true;</span>
<a href="#l2.156"></a><span id="l2.156"> </span>
<a href="#l2.157"></a><span id="l2.157">                     var itemuid = thisCalendar.mHrefIndex[resourcePath];</span>
<a href="#l2.158"></a><span id="l2.158">                     if (!itemuid || etag != thisCalendar.mItemInfoCache[itemuid].etag) {</span>
<a href="#l2.159"></a><span id="l2.159">                         itemsNeedFetching.push(resourcePath);</span>
<a href="#l2.160"></a><span id="l2.160" class="difflineat">@@ -1105,17 +1111,17 @@ calDavCalendar.prototype = {</span>
<a href="#l2.161"></a><span id="l2.161">             thisCalendar.getCalendarData(aUri,</span>
<a href="#l2.162"></a><span id="l2.162">                                          multigetQueryString,</span>
<a href="#l2.163"></a><span id="l2.163">                                          null,</span>
<a href="#l2.164"></a><span id="l2.164">                                          null,</span>
<a href="#l2.165"></a><span id="l2.165">                                          aChangeLogListener);</span>
<a href="#l2.166"></a><span id="l2.166">         };</span>
<a href="#l2.167"></a><span id="l2.167"> </span>
<a href="#l2.168"></a><span id="l2.168">         if (this.verboseLogging()) {</span>
<a href="#l2.169"></a><span id="l2.169" class="difflineminus">-            LOG(&quot;CalDAV: send: &quot; + queryString);</span>
<a href="#l2.170"></a><span id="l2.170" class="difflineplus">+            LOG(&quot;CalDAV: send(&quot; + aUri.spec + &quot;): &quot; + queryString);</span>
<a href="#l2.171"></a><span id="l2.171">         }</span>
<a href="#l2.172"></a><span id="l2.172"> </span>
<a href="#l2.173"></a><span id="l2.173">         var httpchannel = calPrepHttpChannel(aUri,</span>
<a href="#l2.174"></a><span id="l2.174">                                              queryString,</span>
<a href="#l2.175"></a><span id="l2.175">                                              &quot;text/xml; charset=utf-8&quot;,</span>
<a href="#l2.176"></a><span id="l2.176">                                              this);</span>
<a href="#l2.177"></a><span id="l2.177">         httpchannel.requestMethod = &quot;PROPFIND&quot;;</span>
<a href="#l2.178"></a><span id="l2.178">         httpchannel.setRequestHeader(&quot;Depth&quot;, &quot;1&quot;, false);</span>
<a href="#l2.179"></a><span id="l2.179" class="difflineat">@@ -1129,26 +1135,27 @@ calDavCalendar.prototype = {</span>
<a href="#l2.180"></a><span id="l2.180">         var thisCalendar = this;</span>
<a href="#l2.181"></a><span id="l2.181">         var caldataListener = {};</span>
<a href="#l2.182"></a><span id="l2.182">         var C = new Namespace(&quot;C&quot;, &quot;urn:ietf:params:xml:ns:caldav&quot;);</span>
<a href="#l2.183"></a><span id="l2.183">         var D = new Namespace(&quot;D&quot;, &quot;DAV:&quot;);</span>
<a href="#l2.184"></a><span id="l2.184"> </span>
<a href="#l2.185"></a><span id="l2.185">         caldataListener.onStreamComplete =</span>
<a href="#l2.186"></a><span id="l2.186">             function getCalendarData_gCD_onStreamComplete(aLoader, aContext, aStatus,</span>
<a href="#l2.187"></a><span id="l2.187">                                                           aResultLength, aResult) {</span>
<a href="#l2.188"></a><span id="l2.188" class="difflineplus">+            let request = aLoader.request;</span>
<a href="#l2.189"></a><span id="l2.189" class="difflineplus">+            let responseStatus;</span>
<a href="#l2.190"></a><span id="l2.190">             try {</span>
<a href="#l2.191"></a><span id="l2.191" class="difflineminus">-                LOG(&quot;CalDAV: Status &quot; + aContext.responseStatus +</span>
<a href="#l2.192"></a><span id="l2.192" class="difflineplus">+                LOG(&quot;CalDAV: Status &quot; + request.responseStatus +</span>
<a href="#l2.193"></a><span id="l2.193">                     &quot; fetching calendar-data for calendar &quot; + thisCalendar.name);</span>
<a href="#l2.194"></a><span id="l2.194" class="difflineminus">-                responseStatus = aContext.responseStatus;</span>
<a href="#l2.195"></a><span id="l2.195" class="difflineplus">+                responseStatus = request.responseStatus;</span>
<a href="#l2.196"></a><span id="l2.196">             } catch (ex) {</span>
<a href="#l2.197"></a><span id="l2.197">                 LOG(&quot;CalDAV: Error without status fetching calendar-data for calendar &quot; +</span>
<a href="#l2.198"></a><span id="l2.198">                     thisCalendar.name);</span>
<a href="#l2.199"></a><span id="l2.199">                 responseStatus = &quot;none&quot;;</span>
<a href="#l2.200"></a><span id="l2.200">             }</span>
<a href="#l2.201"></a><span id="l2.201" class="difflineminus">-            responseStatus = aContext.responseStatus;</span>
<a href="#l2.202"></a><span id="l2.202">             if (responseStatus != 207) {</span>
<a href="#l2.203"></a><span id="l2.203">                 LOG(&quot;error: got status &quot; + responseStatus + &quot; fetching calendar data&quot;);</span>
<a href="#l2.204"></a><span id="l2.204">                 if (thisCalendar.isCached &amp;&amp; aChangeLogListener)</span>
<a href="#l2.205"></a><span id="l2.205">                     aChangeLogListener.onResult({ status: Components.results.NS_ERROR_FAILURE },</span>
<a href="#l2.206"></a><span id="l2.206">                                                 Components.results.NS_ERROR_FAILURE);</span>
<a href="#l2.207"></a><span id="l2.207">                 return;</span>
<a href="#l2.208"></a><span id="l2.208">             }</span>
<a href="#l2.209"></a><span id="l2.209">             var str = convertByteArray(aResult, aResultLength);</span>
<a href="#l2.210"></a><span id="l2.210" class="difflineat">@@ -1335,26 +1342,27 @@ calDavCalendar.prototype = {</span>
<a href="#l2.211"></a><span id="l2.211">                                              this);</span>
<a href="#l2.212"></a><span id="l2.212">         httpchannel.setRequestHeader(&quot;Depth&quot;, &quot;0&quot;, false);</span>
<a href="#l2.213"></a><span id="l2.213">         httpchannel.requestMethod = &quot;PROPFIND&quot;;</span>
<a href="#l2.214"></a><span id="l2.214"> </span>
<a href="#l2.215"></a><span id="l2.215">         var streamListener = {};</span>
<a href="#l2.216"></a><span id="l2.216"> </span>
<a href="#l2.217"></a><span id="l2.217">         streamListener.onStreamComplete =</span>
<a href="#l2.218"></a><span id="l2.218">             function checkDavResourceType_oSC(aLoader, aContext, aStatus, aResultLength, aResult) {</span>
<a href="#l2.219"></a><span id="l2.219" class="difflineplus">+            let request = aLoader.request;</span>
<a href="#l2.220"></a><span id="l2.220">             try {</span>
<a href="#l2.221"></a><span id="l2.221" class="difflineminus">-                LOG(&quot;CalDAV: Status &quot; + aContext.responseStatus +</span>
<a href="#l2.222"></a><span id="l2.222" class="difflineplus">+                LOG(&quot;CalDAV: Status &quot; + request.responseStatus +</span>
<a href="#l2.223"></a><span id="l2.223">                     &quot; on initial PROPFIND for calendar &quot; + thisCalendar.name);</span>
<a href="#l2.224"></a><span id="l2.224">             } catch (ex) {</span>
<a href="#l2.225"></a><span id="l2.225">                 LOG(&quot;CalDAV: Error without status on initial PROPFIND for calendar &quot; +</span>
<a href="#l2.226"></a><span id="l2.226">                     thisCalendar.name);</span>
<a href="#l2.227"></a><span id="l2.227">             }</span>
<a href="#l2.228"></a><span id="l2.228">             var wwwauth;</span>
<a href="#l2.229"></a><span id="l2.229">             try {</span>
<a href="#l2.230"></a><span id="l2.230" class="difflineminus">-                wwwauth = aContext.getRequestHeader(&quot;Authorization&quot;);</span>
<a href="#l2.231"></a><span id="l2.231" class="difflineplus">+                wwwauth = request.getRequestHeader(&quot;Authorization&quot;);</span>
<a href="#l2.232"></a><span id="l2.232">                 thisCalendar.mAuthScheme = wwwauth.split(&quot; &quot;)[0];</span>
<a href="#l2.233"></a><span id="l2.233">             } catch (ex) {</span>
<a href="#l2.234"></a><span id="l2.234">                 // no auth header could mean a public calendar</span>
<a href="#l2.235"></a><span id="l2.235">                 thisCalendar.mAuthScheme = &quot;none&quot;;</span>
<a href="#l2.236"></a><span id="l2.236">             }</span>
<a href="#l2.237"></a><span id="l2.237"> </span>
<a href="#l2.238"></a><span id="l2.238">             if (thisCalendar.mUriParams) {</span>
<a href="#l2.239"></a><span id="l2.239">                 thisCalendar.mAuthScheme = &quot;Ticket&quot;;</span>
<a href="#l2.240"></a><span id="l2.240" class="difflineat">@@ -1462,24 +1470,27 @@ calDavCalendar.prototype = {</span>
<a href="#l2.241"></a><span id="l2.241">         if (this.verboseLogging()) {</span>
<a href="#l2.242"></a><span id="l2.242">             LOG(&quot;CalDAV: send: OPTIONS&quot;);</span>
<a href="#l2.243"></a><span id="l2.243">         }</span>
<a href="#l2.244"></a><span id="l2.244"> </span>
<a href="#l2.245"></a><span id="l2.245">         var streamListener = {};</span>
<a href="#l2.246"></a><span id="l2.246">         streamListener.onStreamComplete =</span>
<a href="#l2.247"></a><span id="l2.247">             function checkServerCaps_oSC(aLoader, aContext, aStatus,</span>
<a href="#l2.248"></a><span id="l2.248">                                          aResultLength, aResult) {</span>
<a href="#l2.249"></a><span id="l2.249" class="difflineminus">-            var dav = null;</span>
<a href="#l2.250"></a><span id="l2.250" class="difflineplus">+            let request = aLoader.request;</span>
<a href="#l2.251"></a><span id="l2.251" class="difflineplus">+            let dav = null;</span>
<a href="#l2.252"></a><span id="l2.252">             try {</span>
<a href="#l2.253"></a><span id="l2.253" class="difflineminus">-                dav = aContext.getResponseHeader(&quot;DAV&quot;);</span>
<a href="#l2.254"></a><span id="l2.254" class="difflineplus">+                dav = request.getResponseHeader(&quot;DAV&quot;);</span>
<a href="#l2.255"></a><span id="l2.255">                 if (thisCalendar.verboseLogging()) {</span>
<a href="#l2.256"></a><span id="l2.256">                     LOG(&quot;CalDAV: DAV header: &quot; + dav);</span>
<a href="#l2.257"></a><span id="l2.257">                 }</span>
<a href="#l2.258"></a><span id="l2.258">             } catch (ex) {</span>
<a href="#l2.259"></a><span id="l2.259" class="difflineminus">-                LOG(&quot;CalDAV: Error getting DAV header, status &quot; + aContext.responseStatus);</span>
<a href="#l2.260"></a><span id="l2.260" class="difflineplus">+                LOG(&quot;CalDAV: Error getting DAV header, status &quot; + request.responseStatus +</span>
<a href="#l2.261"></a><span id="l2.261" class="difflineplus">+                    &quot;, data: &quot; + convertByteArray(aResult, aResultLength));</span>
<a href="#l2.262"></a><span id="l2.262" class="difflineplus">+            </span>
<a href="#l2.263"></a><span id="l2.263">             }</span>
<a href="#l2.264"></a><span id="l2.264">             // Google does not yet support OPTIONS but does support scheduling</span>
<a href="#l2.265"></a><span id="l2.265">             // so we'll spoof the DAV header until Google gets fixed</span>
<a href="#l2.266"></a><span id="l2.266">             if (thisCalendar.calendarUri.host == &quot;www.google.com&quot;) {</span>
<a href="#l2.267"></a><span id="l2.267">                 dav = &quot;calendar-schedule&quot;;</span>
<a href="#l2.268"></a><span id="l2.268">                 // Google also reports an inbox URL distinct from the calendar</span>
<a href="#l2.269"></a><span id="l2.269">                 // URL but a) doesn't use it and b) 405s on etag queries to it</span>
<a href="#l2.270"></a><span id="l2.270">                 thisCalendar.mShouldPollInbox = false;</span>
<a href="#l2.271"></a><span id="l2.271" class="difflineat">@@ -1553,18 +1564,19 @@ calDavCalendar.prototype = {</span>
<a href="#l2.272"></a><span id="l2.272"> </span>
<a href="#l2.273"></a><span id="l2.273">         httpchannel.setRequestHeader(&quot;Depth&quot;, &quot;0&quot;, false);</span>
<a href="#l2.274"></a><span id="l2.274">         httpchannel.requestMethod = &quot;PROPFIND&quot;;</span>
<a href="#l2.275"></a><span id="l2.275"> </span>
<a href="#l2.276"></a><span id="l2.276">         var streamListener = {};</span>
<a href="#l2.277"></a><span id="l2.277">         streamListener.onStreamComplete =</span>
<a href="#l2.278"></a><span id="l2.278">             function findInOutBoxes_oSC(aLoader, aContext, aStatus,</span>
<a href="#l2.279"></a><span id="l2.279">                                          aResultLength, aResult) {</span>
<a href="#l2.280"></a><span id="l2.280" class="difflineminus">-            if (aContext.responseStatus != 207) {</span>
<a href="#l2.281"></a><span id="l2.281" class="difflineminus">-                LOG(&quot;CalDAV: Unexpected status &quot; + aContext.responseStatus +</span>
<a href="#l2.282"></a><span id="l2.282" class="difflineplus">+            let request = aLoader.request;</span>
<a href="#l2.283"></a><span id="l2.283" class="difflineplus">+            if (request.responseStatus != 207) {</span>
<a href="#l2.284"></a><span id="l2.284" class="difflineplus">+                LOG(&quot;CalDAV: Unexpected status &quot; + request.responseStatus +</span>
<a href="#l2.285"></a><span id="l2.285">                     &quot; while querying principal namespace&quot;);</span>
<a href="#l2.286"></a><span id="l2.286">                 thisCalendar.completeCheckServerInfo(aChangeLogListener,</span>
<a href="#l2.287"></a><span id="l2.287">                                                      Components.results.NS_ERROR_FAILURE);</span>
<a href="#l2.288"></a><span id="l2.288">                 return;</span>
<a href="#l2.289"></a><span id="l2.289">             }</span>
<a href="#l2.290"></a><span id="l2.290"> </span>
<a href="#l2.291"></a><span id="l2.291">             var str = convertByteArray(aResult, aResultLength);</span>
<a href="#l2.292"></a><span id="l2.292">             if (!str) {</span>
<a href="#l2.293"></a><span id="l2.293" class="difflineat">@@ -1691,19 +1703,19 @@ calDavCalendar.prototype = {</span>
<a href="#l2.294"></a><span id="l2.294">             if (!str) {</span>
<a href="#l2.295"></a><span id="l2.295">                 LOG(&quot;CalDAV: Failed to report principals namespace&quot;);</span>
<a href="#l2.296"></a><span id="l2.296">                 doesntSupportScheduling();</span>
<a href="#l2.297"></a><span id="l2.297">                 return;</span>
<a href="#l2.298"></a><span id="l2.298">             } else if (thisCalendar.verboseLogging()) {</span>
<a href="#l2.299"></a><span id="l2.299">                 LOG(&quot;CalDAV: recv: &quot; + str);</span>
<a href="#l2.300"></a><span id="l2.300">             }</span>
<a href="#l2.301"></a><span id="l2.301"> </span>
<a href="#l2.302"></a><span id="l2.302" class="difflineminus">-            if (aContext.responseStatus != 207) {</span>
<a href="#l2.303"></a><span id="l2.303" class="difflineplus">+            if (aLoader.request.responseStatus != 207) {</span>
<a href="#l2.304"></a><span id="l2.304">                 LOG(&quot;CalDAV: Bad response to in/outbox query, status &quot; +</span>
<a href="#l2.305"></a><span id="l2.305" class="difflineminus">-                    aContext.responseStatus);</span>
<a href="#l2.306"></a><span id="l2.306" class="difflineplus">+                    aLoader.request.responseStatus);</span>
<a href="#l2.307"></a><span id="l2.307">                 doesntSupportScheduling();</span>
<a href="#l2.308"></a><span id="l2.308">                 return;</span>
<a href="#l2.309"></a><span id="l2.309">             }</span>
<a href="#l2.310"></a><span id="l2.310"> </span>
<a href="#l2.311"></a><span id="l2.311">             var multistatus = safeNewXML(str);</span>
<a href="#l2.312"></a><span id="l2.312">             var multistatusLength = multistatus.*::response.length();</span>
<a href="#l2.313"></a><span id="l2.313"> </span>
<a href="#l2.314"></a><span id="l2.314">             for each (let response in multistatus.*::response) {</span>
<a href="#l2.315"></a><span id="l2.315" class="difflineat">@@ -1932,24 +1944,25 @@ calDavCalendar.prototype = {</span>
<a href="#l2.316"></a><span id="l2.316">         httpchannel.setRequestHeader(&quot;Originator&quot;, organizer, false);</span>
<a href="#l2.317"></a><span id="l2.317">         httpchannel.setRequestHeader(&quot;Recipient&quot;, mailto_aCalId, false);</span>
<a href="#l2.318"></a><span id="l2.318"> </span>
<a href="#l2.319"></a><span id="l2.319">         var streamListener = {};</span>
<a href="#l2.320"></a><span id="l2.320"> </span>
<a href="#l2.321"></a><span id="l2.321">         streamListener.onStreamComplete =</span>
<a href="#l2.322"></a><span id="l2.322">             function caldav_GFBI_oSC(aLoader, aContext, aStatus,</span>
<a href="#l2.323"></a><span id="l2.323">                                          aResultLength, aResult) {</span>
<a href="#l2.324"></a><span id="l2.324" class="difflineminus">-            var str = convertByteArray(aResult, aResultLength);</span>
<a href="#l2.325"></a><span id="l2.325" class="difflineplus">+            let request = aLoader.request;</span>
<a href="#l2.326"></a><span id="l2.326" class="difflineplus">+            let str = convertByteArray(aResult, aResultLength);</span>
<a href="#l2.327"></a><span id="l2.327">             if (!str) {</span>
<a href="#l2.328"></a><span id="l2.328">                 LOG(&quot;CalDAV: Failed to parse freebusy response&quot;);</span>
<a href="#l2.329"></a><span id="l2.329">             } else if (thisCalendar.verboseLogging()) {</span>
<a href="#l2.330"></a><span id="l2.330">                 LOG(&quot;CalDAV: recv: &quot; + str);</span>
<a href="#l2.331"></a><span id="l2.331">             }</span>
<a href="#l2.332"></a><span id="l2.332"> </span>
<a href="#l2.333"></a><span id="l2.333" class="difflineminus">-            if (aContext.responseStatus == 200) {</span>
<a href="#l2.334"></a><span id="l2.334" class="difflineplus">+            if (request.responseStatus == 200) {</span>
<a href="#l2.335"></a><span id="l2.335">                 var periodsToReturn = [];</span>
<a href="#l2.336"></a><span id="l2.336">                 var CalPeriod = new Components.Constructor(&quot;@mozilla.org/calendar/period;1&quot;,</span>
<a href="#l2.337"></a><span id="l2.337">                                                            &quot;calIPeriod&quot;);</span>
<a href="#l2.338"></a><span id="l2.338">                 var fbTypeMap = {};</span>
<a href="#l2.339"></a><span id="l2.339">                 fbTypeMap[&quot;FREE&quot;] = calIFreeBusyInterval.FREE;</span>
<a href="#l2.340"></a><span id="l2.340">                 fbTypeMap[&quot;BUSY&quot;] = calIFreeBusyInterval.BUSY;</span>
<a href="#l2.341"></a><span id="l2.341">                 fbTypeMap[&quot;BUSY-UNAVAILABLE&quot;] = calIFreeBusyInterval.BUSY_UNAVAILABLE;</span>
<a href="#l2.342"></a><span id="l2.342">                 fbTypeMap[&quot;BUSY-TENTATIVE&quot;] = calIFreeBusyInterval.BUSY_TENTATIVE;</span>
<a href="#l2.343"></a><span id="l2.343" class="difflineat">@@ -2018,17 +2031,17 @@ calDavCalendar.prototype = {</span>
<a href="#l2.344"></a><span id="l2.344">                     }</span>
<a href="#l2.345"></a><span id="l2.345">                     calIterateIcalComponent(getIcsService().parseICS(caldata, null), iterFunc);</span>
<a href="#l2.346"></a><span id="l2.346">                 } catch (exc) {</span>
<a href="#l2.347"></a><span id="l2.347">                     LOG(&quot;Error parsing free-busy info.&quot;);</span>
<a href="#l2.348"></a><span id="l2.348">                 }</span>
<a href="#l2.349"></a><span id="l2.349"> </span>
<a href="#l2.350"></a><span id="l2.350">                 aListener.onResult(null, periodsToReturn);</span>
<a href="#l2.351"></a><span id="l2.351">             } else {</span>
<a href="#l2.352"></a><span id="l2.352" class="difflineminus">-                LOG(&quot;CalDAV: Received status &quot; + aContext.responseStatus + &quot; from freebusy query&quot;);</span>
<a href="#l2.353"></a><span id="l2.353" class="difflineplus">+                LOG(&quot;CalDAV: Received status &quot; + request.responseStatus + &quot; from freebusy query&quot;);</span>
<a href="#l2.354"></a><span id="l2.354">                 aListener.onResult(null, null);</span>
<a href="#l2.355"></a><span id="l2.355">             }</span>
<a href="#l2.356"></a><span id="l2.356">         };</span>
<a href="#l2.357"></a><span id="l2.357"> </span>
<a href="#l2.358"></a><span id="l2.358">         var streamLoader = createStreamLoader();</span>
<a href="#l2.359"></a><span id="l2.359">         calSendHttpRequest(streamLoader, httpchannel, streamListener);</span>
<a href="#l2.360"></a><span id="l2.360">     },</span>
<a href="#l2.361"></a><span id="l2.361"> </span>
<a href="#l2.362"></a><span id="l2.362" class="difflineat">@@ -2178,19 +2191,20 @@ calDavCalendar.prototype = {</span>
<a href="#l2.363"></a><span id="l2.363">             for each (var recipient in aRecipients) {</span>
<a href="#l2.364"></a><span id="l2.364">                 httpchannel.setRequestHeader(&quot;Recipient&quot;, recipient.id, true);</span>
<a href="#l2.365"></a><span id="l2.365">             }</span>
<a href="#l2.366"></a><span id="l2.366"> </span>
<a href="#l2.367"></a><span id="l2.367">             var thisCalendar = this;</span>
<a href="#l2.368"></a><span id="l2.368">             var streamListener = {</span>
<a href="#l2.369"></a><span id="l2.369">                 onStreamComplete: function caldav_sendItems_oSC(aLoader, aContext, aStatus,</span>
<a href="#l2.370"></a><span id="l2.370">                                                                 aResultLength, aResult) {</span>
<a href="#l2.371"></a><span id="l2.371" class="difflineminus">-                    var status;</span>
<a href="#l2.372"></a><span id="l2.372" class="difflineplus">+                    let request = aLoader.request;</span>
<a href="#l2.373"></a><span id="l2.373" class="difflineplus">+                    let status;</span>
<a href="#l2.374"></a><span id="l2.374">                     try {</span>
<a href="#l2.375"></a><span id="l2.375" class="difflineminus">-                        status = aContext.responseStatus;</span>
<a href="#l2.376"></a><span id="l2.376" class="difflineplus">+                        status = request.responseStatus;</span>
<a href="#l2.377"></a><span id="l2.377">                     } catch (ex) {</span>
<a href="#l2.378"></a><span id="l2.378">                         status = Components.interfaces.calIErrors.DAV_POST_ERROR;</span>
<a href="#l2.379"></a><span id="l2.379">                         LOG(&quot;CalDAV: no response status when sending iTIP.&quot;);</span>
<a href="#l2.380"></a><span id="l2.380">                     }</span>
<a href="#l2.381"></a><span id="l2.381"> </span>
<a href="#l2.382"></a><span id="l2.382">                     if (status != 200) {</span>
<a href="#l2.383"></a><span id="l2.383">                         LOG(&quot;Sending iITIP failed with status &quot; + status);</span>
<a href="#l2.384"></a><span id="l2.384">                     }</span>
<a href="#l2.385"></a><span id="l2.385" class="difflineat">@@ -2265,17 +2279,60 @@ calDavCalendar.prototype = {</span>
<a href="#l2.386"></a><span id="l2.386">         if (this.verboseLogging()) {</span>
<a href="#l2.387"></a><span id="l2.387">             LOG(&quot;CalDAV: send: &quot; + serializedItem);</span>
<a href="#l2.388"></a><span id="l2.388">         }</span>
<a href="#l2.389"></a><span id="l2.389">         return serializedItem;</span>
<a href="#l2.390"></a><span id="l2.390">     },</span>
<a href="#l2.391"></a><span id="l2.391"> </span>
<a href="#l2.392"></a><span id="l2.392">     // nsIChannelEventSink implementation</span>
<a href="#l2.393"></a><span id="l2.393">     onChannelRedirect: function caldav_onChannelRedirect(aOldChannel, aNewChannel, aFlags) {</span>
<a href="#l2.394"></a><span id="l2.394" class="difflineminus">-        // TODO We might need to re-prepare the new channel here</span>
<a href="#l2.395"></a><span id="l2.395" class="difflineplus">+</span>
<a href="#l2.396"></a><span id="l2.396" class="difflineplus">+        let uploadData;</span>
<a href="#l2.397"></a><span id="l2.397" class="difflineplus">+        let uploadContent;</span>
<a href="#l2.398"></a><span id="l2.398" class="difflineplus">+        if (aOldChannel instanceof Components.interfaces.nsIUploadChannel &amp;&amp;</span>
<a href="#l2.399"></a><span id="l2.399" class="difflineplus">+            aOldChannel.uploadStream) {</span>
<a href="#l2.400"></a><span id="l2.400" class="difflineplus">+            uploadData = aOldChannel.uploadStream;</span>
<a href="#l2.401"></a><span id="l2.401" class="difflineplus">+            uploadContent = aOldChannel.getRequestHeader(&quot;Content-Type&quot;);</span>
<a href="#l2.402"></a><span id="l2.402" class="difflineplus">+        }</span>
<a href="#l2.403"></a><span id="l2.403" class="difflineplus">+</span>
<a href="#l2.404"></a><span id="l2.404" class="difflineplus">+        calPrepHttpChannel(null,</span>
<a href="#l2.405"></a><span id="l2.405" class="difflineplus">+                           uploadData,</span>
<a href="#l2.406"></a><span id="l2.406" class="difflineplus">+                           uploadContent,</span>
<a href="#l2.407"></a><span id="l2.407" class="difflineplus">+                           this,</span>
<a href="#l2.408"></a><span id="l2.408" class="difflineplus">+                           aNewChannel);</span>
<a href="#l2.409"></a><span id="l2.409" class="difflineplus">+</span>
<a href="#l2.410"></a><span id="l2.410" class="difflineplus">+        // Make sure we can get/set headers on both channels.</span>
<a href="#l2.411"></a><span id="l2.411" class="difflineplus">+        aNewChannel.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l2.412"></a><span id="l2.412" class="difflineplus">+        aOldChannel.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l2.413"></a><span id="l2.413" class="difflineplus">+</span>
<a href="#l2.414"></a><span id="l2.414" class="difflineplus">+</span>
<a href="#l2.415"></a><span id="l2.415" class="difflineplus">+        function copyHeader(aHdr) {</span>
<a href="#l2.416"></a><span id="l2.416" class="difflineplus">+            try {</span>
<a href="#l2.417"></a><span id="l2.417" class="difflineplus">+                let hdrValue = aOldChannel.getRequestHeader(aHdr);</span>
<a href="#l2.418"></a><span id="l2.418" class="difflineplus">+                if (hdrValue) {</span>
<a href="#l2.419"></a><span id="l2.419" class="difflineplus">+                    aNewChannel.setRequestHeader(aHdr, hdrValue, false);</span>
<a href="#l2.420"></a><span id="l2.420" class="difflineplus">+                }</span>
<a href="#l2.421"></a><span id="l2.421" class="difflineplus">+            } catch(e) {</span>
<a href="#l2.422"></a><span id="l2.422" class="difflineplus">+                if (e.code != Components.results.NS_ERROR_NOT_AVAILIBLE) {</span>
<a href="#l2.423"></a><span id="l2.423" class="difflineplus">+                    // The header could possibly not be availible, ignore that</span>
<a href="#l2.424"></a><span id="l2.424" class="difflineplus">+                    // case but throw otherwise</span>
<a href="#l2.425"></a><span id="l2.425" class="difflineplus">+                    throw e;</span>
<a href="#l2.426"></a><span id="l2.426" class="difflineplus">+               }</span>
<a href="#l2.427"></a><span id="l2.427" class="difflineplus">+            }</span>
<a href="#l2.428"></a><span id="l2.428" class="difflineplus">+        }</span>
<a href="#l2.429"></a><span id="l2.429" class="difflineplus">+</span>
<a href="#l2.430"></a><span id="l2.430" class="difflineplus">+        // If any other header is used, it should be added here. We might want</span>
<a href="#l2.431"></a><span id="l2.431" class="difflineplus">+        // to just copy all headers over to the new channel.</span>
<a href="#l2.432"></a><span id="l2.432" class="difflineplus">+        copyHeader(&quot;Depth&quot;);</span>
<a href="#l2.433"></a><span id="l2.433" class="difflineplus">+        copyHeader(&quot;Originator&quot;);</span>
<a href="#l2.434"></a><span id="l2.434" class="difflineplus">+        copyHeader(&quot;Recipient&quot;);</span>
<a href="#l2.435"></a><span id="l2.435" class="difflineplus">+        copyHeader(&quot;If-None-Match&quot;);</span>
<a href="#l2.436"></a><span id="l2.436" class="difflineplus">+        copyHeader(&quot;If-Match&quot;);</span>
<a href="#l2.437"></a><span id="l2.437" class="difflineplus">+</span>
<a href="#l2.438"></a><span id="l2.438" class="difflineplus">+        aNewChannel.requestMethod = aOldChannel.requestMethod;</span>
<a href="#l2.439"></a><span id="l2.439">     }</span>
<a href="#l2.440"></a><span id="l2.440"> };</span>
<a href="#l2.441"></a><span id="l2.441"> </span>
<a href="#l2.442"></a><span id="l2.442"> function calDavObserver(aCalendar) {</span>
<a href="#l2.443"></a><span id="l2.443">     this.mCalendar = aCalendar;</span>
<a href="#l2.444"></a><span id="l2.444"> }</span>
<a href="#l2.445"></a><span id="l2.445"> </span>
<a href="#l2.446"></a><span id="l2.446"> calDavObserver.prototype = {</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

