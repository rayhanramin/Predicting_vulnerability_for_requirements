<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 945:65e60597a8f478b9de98af81d41eba4bfdb64d43</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 65e60597a8f478b9de98af81d41eba4bfdb64d43" />
<meta property="og:url" content="/comm-central/rev/65e60597a8f478b9de98af81d41eba4bfdb64d43" />
<meta property="og:description" content="jsdoc documentation generation support changes" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 65e60597a8f478b9de98af81d41eba4bfdb64d43 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/65e60597a8f478b9de98af81d41eba4bfdb64d43">shortlog</a> |
<a href="/comm-central/log/65e60597a8f478b9de98af81d41eba4bfdb64d43">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/65e60597a8f478b9de98af81d41eba4bfdb64d43">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/65e60597a8f478b9de98af81d41eba4bfdb64d43">files</a> |
changeset |
<a href="/comm-central/raw-rev/65e60597a8f478b9de98af81d41eba4bfdb64d43">raw</a>  | <a href="/comm-central/archive/65e60597a8f478b9de98af81d41eba4bfdb64d43.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
jsdoc documentation generation support changes
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#65;&#110;&#100;&#114;&#101;&#119;&#32;&#83;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#32;&#60;&#97;&#115;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#64;&#97;&#115;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#46;&#111;&#114;&#103;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 22 Sep 2008 16:52:36 -0700</td></tr>

<tr>
 <td>changeset 945</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/65e60597a8f478b9de98af81d41eba4bfdb64d43">65e60597a8f478b9de98af81d41eba4bfdb64d43</a></td>
</tr>



<tr>
<td>parent 944</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/d0af9697234b9a497a5b964b368ec41b68d8b9eb">d0af9697234b9a497a5b964b368ec41b68d8b9eb</a>
</td>
</tr>

<tr>
<td>child 946</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/23ca8d6609ae15a5b5ce8fc4a6e2cf267f1f10f5">23ca8d6609ae15a5b5ce8fc4a6e2cf267f1f10f5</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=65e60597a8f478b9de98af81d41eba4bfdb64d43">743</a></td></tr>
<tr><td>push user</td><td>dmosedale@mozilla.com</td></tr>
<tr><td>push date</td><td class="date age">Tue, 04 Nov 2008 20:01:44 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@a79b923a9cba [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=a79b923a9cba395cb3911b27c9599ffb8c997caf">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=a79b923a9cba395cb3911b27c9599ffb8c997caf&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a79b923a9cba395cb3911b27c9599ffb8c997caf&newProject=comm-central&newRevision=d32b4cc6f46d1195ae66fd0cf8395c60b9259ca6&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a79b923a9cba395cb3911b27c9599ffb8c997caf&newProject=comm-central&newRevision=d32b4cc6f46d1195ae66fd0cf8395c60b9259ca6&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a79b923a9cba395cb3911b27c9599ffb8c997caf&newProject=comm-central&newRevision=d32b4cc6f46d1195ae66fd0cf8395c60b9259ca6&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>






</table></div>

<div class="page_body description">jsdoc documentation generation support changes</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/65e60597a8f478b9de98af81d41eba4bfdb64d43/modules/collection.js">modules/collection.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/65e60597a8f478b9de98af81d41eba4bfdb64d43/modules/collection.js">file</a> |
<a href="/comm-central/annotate/65e60597a8f478b9de98af81d41eba4bfdb64d43/modules/collection.js">annotate</a> |
<a href="/comm-central/diff/65e60597a8f478b9de98af81d41eba4bfdb64d43/modules/collection.js">diff</a> |
<a href="/comm-central/comparison/65e60597a8f478b9de98af81d41eba4bfdb64d43/modules/collection.js">comparison</a> |
<a href="/comm-central/log/65e60597a8f478b9de98af81d41eba4bfdb64d43/modules/collection.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/65e60597a8f478b9de98af81d41eba4bfdb64d43/modules/datamodel.js">modules/datamodel.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/65e60597a8f478b9de98af81d41eba4bfdb64d43/modules/datamodel.js">file</a> |
<a href="/comm-central/annotate/65e60597a8f478b9de98af81d41eba4bfdb64d43/modules/datamodel.js">annotate</a> |
<a href="/comm-central/diff/65e60597a8f478b9de98af81d41eba4bfdb64d43/modules/datamodel.js">diff</a> |
<a href="/comm-central/comparison/65e60597a8f478b9de98af81d41eba4bfdb64d43/modules/datamodel.js">comparison</a> |
<a href="/comm-central/log/65e60597a8f478b9de98af81d41eba4bfdb64d43/modules/datamodel.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/65e60597a8f478b9de98af81d41eba4bfdb64d43/modules/datastore.js">modules/datastore.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/65e60597a8f478b9de98af81d41eba4bfdb64d43/modules/datastore.js">file</a> |
<a href="/comm-central/annotate/65e60597a8f478b9de98af81d41eba4bfdb64d43/modules/datastore.js">annotate</a> |
<a href="/comm-central/diff/65e60597a8f478b9de98af81d41eba4bfdb64d43/modules/datastore.js">diff</a> |
<a href="/comm-central/comparison/65e60597a8f478b9de98af81d41eba4bfdb64d43/modules/datastore.js">comparison</a> |
<a href="/comm-central/log/65e60597a8f478b9de98af81d41eba4bfdb64d43/modules/datastore.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/65e60597a8f478b9de98af81d41eba4bfdb64d43/modules/explattr.js">modules/explattr.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/65e60597a8f478b9de98af81d41eba4bfdb64d43/modules/explattr.js">file</a> |
<a href="/comm-central/annotate/65e60597a8f478b9de98af81d41eba4bfdb64d43/modules/explattr.js">annotate</a> |
<a href="/comm-central/diff/65e60597a8f478b9de98af81d41eba4bfdb64d43/modules/explattr.js">diff</a> |
<a href="/comm-central/comparison/65e60597a8f478b9de98af81d41eba4bfdb64d43/modules/explattr.js">comparison</a> |
<a href="/comm-central/log/65e60597a8f478b9de98af81d41eba4bfdb64d43/modules/explattr.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/65e60597a8f478b9de98af81d41eba4bfdb64d43/modules/fundattr.js">modules/fundattr.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/65e60597a8f478b9de98af81d41eba4bfdb64d43/modules/fundattr.js">file</a> |
<a href="/comm-central/annotate/65e60597a8f478b9de98af81d41eba4bfdb64d43/modules/fundattr.js">annotate</a> |
<a href="/comm-central/diff/65e60597a8f478b9de98af81d41eba4bfdb64d43/modules/fundattr.js">diff</a> |
<a href="/comm-central/comparison/65e60597a8f478b9de98af81d41eba4bfdb64d43/modules/fundattr.js">comparison</a> |
<a href="/comm-central/log/65e60597a8f478b9de98af81d41eba4bfdb64d43/modules/fundattr.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/65e60597a8f478b9de98af81d41eba4bfdb64d43/modules/gloda.js">modules/gloda.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/65e60597a8f478b9de98af81d41eba4bfdb64d43/modules/gloda.js">file</a> |
<a href="/comm-central/annotate/65e60597a8f478b9de98af81d41eba4bfdb64d43/modules/gloda.js">annotate</a> |
<a href="/comm-central/diff/65e60597a8f478b9de98af81d41eba4bfdb64d43/modules/gloda.js">diff</a> |
<a href="/comm-central/comparison/65e60597a8f478b9de98af81d41eba4bfdb64d43/modules/gloda.js">comparison</a> |
<a href="/comm-central/log/65e60597a8f478b9de98af81d41eba4bfdb64d43/modules/gloda.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/65e60597a8f478b9de98af81d41eba4bfdb64d43/modules/indexer.js">modules/indexer.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/65e60597a8f478b9de98af81d41eba4bfdb64d43/modules/indexer.js">file</a> |
<a href="/comm-central/annotate/65e60597a8f478b9de98af81d41eba4bfdb64d43/modules/indexer.js">annotate</a> |
<a href="/comm-central/diff/65e60597a8f478b9de98af81d41eba4bfdb64d43/modules/indexer.js">diff</a> |
<a href="/comm-central/comparison/65e60597a8f478b9de98af81d41eba4bfdb64d43/modules/indexer.js">comparison</a> |
<a href="/comm-central/log/65e60597a8f478b9de98af81d41eba4bfdb64d43/modules/indexer.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/65e60597a8f478b9de98af81d41eba4bfdb64d43/modules/noun_tag.js">modules/noun_tag.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/65e60597a8f478b9de98af81d41eba4bfdb64d43/modules/noun_tag.js">file</a> |
<a href="/comm-central/annotate/65e60597a8f478b9de98af81d41eba4bfdb64d43/modules/noun_tag.js">annotate</a> |
<a href="/comm-central/diff/65e60597a8f478b9de98af81d41eba4bfdb64d43/modules/noun_tag.js">diff</a> |
<a href="/comm-central/comparison/65e60597a8f478b9de98af81d41eba4bfdb64d43/modules/noun_tag.js">comparison</a> |
<a href="/comm-central/log/65e60597a8f478b9de98af81d41eba4bfdb64d43/modules/noun_tag.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/65e60597a8f478b9de98af81d41eba4bfdb64d43/modules/query.js">modules/query.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/65e60597a8f478b9de98af81d41eba4bfdb64d43/modules/query.js">file</a> |
<a href="/comm-central/annotate/65e60597a8f478b9de98af81d41eba4bfdb64d43/modules/query.js">annotate</a> |
<a href="/comm-central/diff/65e60597a8f478b9de98af81d41eba4bfdb64d43/modules/query.js">diff</a> |
<a href="/comm-central/comparison/65e60597a8f478b9de98af81d41eba4bfdb64d43/modules/query.js">comparison</a> |
<a href="/comm-central/log/65e60597a8f478b9de98af81d41eba4bfdb64d43/modules/query.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/65e60597a8f478b9de98af81d41eba4bfdb64d43/modules/suffixtree.js">modules/suffixtree.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/65e60597a8f478b9de98af81d41eba4bfdb64d43/modules/suffixtree.js">file</a> |
<a href="/comm-central/annotate/65e60597a8f478b9de98af81d41eba4bfdb64d43/modules/suffixtree.js">annotate</a> |
<a href="/comm-central/diff/65e60597a8f478b9de98af81d41eba4bfdb64d43/modules/suffixtree.js">diff</a> |
<a href="/comm-central/comparison/65e60597a8f478b9de98af81d41eba4bfdb64d43/modules/suffixtree.js">comparison</a> |
<a href="/comm-central/log/65e60597a8f478b9de98af81d41eba4bfdb64d43/modules/suffixtree.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/65e60597a8f478b9de98af81d41eba4bfdb64d43/modules/utils.js">modules/utils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/65e60597a8f478b9de98af81d41eba4bfdb64d43/modules/utils.js">file</a> |
<a href="/comm-central/annotate/65e60597a8f478b9de98af81d41eba4bfdb64d43/modules/utils.js">annotate</a> |
<a href="/comm-central/diff/65e60597a8f478b9de98af81d41eba4bfdb64d43/modules/utils.js">diff</a> |
<a href="/comm-central/comparison/65e60597a8f478b9de98af81d41eba4bfdb64d43/modules/utils.js">comparison</a> |
<a href="/comm-central/log/65e60597a8f478b9de98af81d41eba4bfdb64d43/modules/utils.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/modules/collection.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/modules/collection.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -42,33 +42,33 @@ const Ci = Components.interfaces;</span>
<a href="#l1.4"></a><span id="l1.4"> const Cr = Components.results;</span>
<a href="#l1.5"></a><span id="l1.5"> const Cu = Components.utils;</span>
<a href="#l1.6"></a><span id="l1.6"> </span>
<a href="#l1.7"></a><span id="l1.7"> Cu.import(&quot;resource://gloda/modules/log4moz.js&quot;);</span>
<a href="#l1.8"></a><span id="l1.8"> </span>
<a href="#l1.9"></a><span id="l1.9"> const LOG = Log4Moz.Service.getLogger(&quot;gloda.collection&quot;);</span>
<a href="#l1.10"></a><span id="l1.10"> </span>
<a href="#l1.11"></a><span id="l1.11"> /**</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+ * @namespace Central registry and logic for all collections. </span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+ *</span>
<a href="#l1.14"></a><span id="l1.14">  * The collection manager is a singleton that has the following tasks:</span>
<a href="#l1.15"></a><span id="l1.15">  * - Let views of objects (nouns) know when their objects have changed.  For</span>
<a href="#l1.16"></a><span id="l1.16">  *   example, an attribute has changed due to user action.</span>
<a href="#l1.17"></a><span id="l1.17">  * - Let views of objects based on queries know when new objects match their</span>
<a href="#l1.18"></a><span id="l1.18">  *   query, or when their existing objects no longer match due to changes.</span>
<a href="#l1.19"></a><span id="l1.19">  * - Caching/object-identity maintenance.  It is ideal if we only ever have</span>
<a href="#l1.20"></a><span id="l1.20">  *   one instance of an object at a time.  (More specifically, only one instance</span>
<a href="#l1.21"></a><span id="l1.21">  *   per database row 'id'.)  The collection mechanism lets us find existing</span>
<a href="#l1.22"></a><span id="l1.22">  *   instances to this end.  Caching can be directly integrated by being treated</span>
<a href="#l1.23"></a><span id="l1.23">  *   as a special collection.</span>
<a href="#l1.24"></a><span id="l1.24">  */</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineminus">-function GlodaCollectionManager() {</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineminus">-  this._collectionsByNoun = {};</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineminus">-  this._cachesByNoun = {};</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineminus">-}</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineplus">+var GlodaCollectionManager = {</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineplus">+  _collectionsByNoun = {},</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+  _cachesByNoun = {},</span>
<a href="#l1.32"></a><span id="l1.32"> </span>
<a href="#l1.33"></a><span id="l1.33" class="difflineminus">-GlodaCollectionManager.prototype = {</span>
<a href="#l1.34"></a><span id="l1.34">   /**</span>
<a href="#l1.35"></a><span id="l1.35">    * Registers the existence of a collection with the collection manager.  This</span>
<a href="#l1.36"></a><span id="l1.36">    *  is done using a weak reference so that the collection can go away if it</span>
<a href="#l1.37"></a><span id="l1.37">    *  wants to.</span>
<a href="#l1.38"></a><span id="l1.38">    */</span>
<a href="#l1.39"></a><span id="l1.39">   registerCollection: function gloda_colm_registerCollection(aCollection) {</span>
<a href="#l1.40"></a><span id="l1.40">     let collections;</span>
<a href="#l1.41"></a><span id="l1.41">     let nounID = aCollection.query._nounMeta.id;</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineat">@@ -359,27 +359,26 @@ GlodaCollectionManager.prototype = {</span>
<a href="#l1.43"></a><span id="l1.43">     // collections</span>
<a href="#l1.44"></a><span id="l1.44">     for each (let collection in this.getCollectionsForNounID(aNounID)) {</span>
<a href="#l1.45"></a><span id="l1.45">       let removeItems = [item for each (item in aItems)</span>
<a href="#l1.46"></a><span id="l1.46">                          if (item.id in collection._idMap)];</span>
<a href="#l1.47"></a><span id="l1.47">       if (removeItems.length)</span>
<a href="#l1.48"></a><span id="l1.48">         collection._onItemsRemoved(removeItems);</span>
<a href="#l1.49"></a><span id="l1.49">     }</span>
<a href="#l1.50"></a><span id="l1.50">   },</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineminus">-}</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineminus">-// singleton</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineminus">-GlodaCollectionManager = new GlodaCollectionManager();</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineplus">+};</span>
<a href="#l1.55"></a><span id="l1.55"> </span>
<a href="#l1.56"></a><span id="l1.56"> /**</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineminus">- * A GlodaCollection is intended to be a current view of the set of first-class</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineminus">- *  nouns meeting a given query.  Assuming a listener is present, events are</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineplus">+ * @class A current view of the set of first-class nouns meeting a given query.</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineplus">+ *  Assuming a listener is present, events are</span>
<a href="#l1.61"></a><span id="l1.61">  *  generated when new objects meet the query, existing objects no longer meet</span>
<a href="#l1.62"></a><span id="l1.62">  *  the query, or existing objects have experienced a change in attributes that</span>
<a href="#l1.63"></a><span id="l1.63">  *  does not affect their ability to be present (but the listener may care about</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineminus">- *  because it is exposing those attributes). </span>
<a href="#l1.65"></a><span id="l1.65" class="difflineplus">+ *  because it is exposing those attributes).</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineplus">+ * @constructor </span>
<a href="#l1.67"></a><span id="l1.67">  */</span>
<a href="#l1.68"></a><span id="l1.68"> function GlodaCollection(aNounMeta, aItems, aQuery, aListener) {</span>
<a href="#l1.69"></a><span id="l1.69">   // if aNounMeta is null, we are just being invoked for subclassing</span>
<a href="#l1.70"></a><span id="l1.70">   if (aNounMeta === undefined)</span>
<a href="#l1.71"></a><span id="l1.71">     return;</span>
<a href="#l1.72"></a><span id="l1.72"> </span>
<a href="#l1.73"></a><span id="l1.73">   this._nounMeta = aNounMeta;</span>
<a href="#l1.74"></a><span id="l1.74">   // should we also maintain a unique value mapping...</span>
<a href="#l1.75"></a><span id="l1.75" class="difflineat">@@ -398,17 +397,17 @@ function GlodaCollection(aNounMeta, aIte</span>
<a href="#l1.76"></a><span id="l1.76">     for each (let item in this.items) {</span>
<a href="#l1.77"></a><span id="l1.77">       this._idMap[item.id] = item;</span>
<a href="#l1.78"></a><span id="l1.78">     }</span>
<a href="#l1.79"></a><span id="l1.79">   }</span>
<a href="#l1.80"></a><span id="l1.80">   </span>
<a href="#l1.81"></a><span id="l1.81">   this.query = aQuery || null;</span>
<a href="#l1.82"></a><span id="l1.82">   this._listener = aListener || null;</span>
<a href="#l1.83"></a><span id="l1.83"> }</span>
<a href="#l1.84"></a><span id="l1.84" class="difflineminus">- </span>
<a href="#l1.85"></a><span id="l1.85" class="difflineplus">+</span>
<a href="#l1.86"></a><span id="l1.86"> GlodaCollection.prototype = {</span>
<a href="#l1.87"></a><span id="l1.87">   get listener() { return this._listener; },</span>
<a href="#l1.88"></a><span id="l1.88">   set listener(aListener) { this._listener = aListener; },</span>
<a href="#l1.89"></a><span id="l1.89">   </span>
<a href="#l1.90"></a><span id="l1.90">   /**</span>
<a href="#l1.91"></a><span id="l1.91">    * Clear the contents of this collection.  This only makes sense for explicit</span>
<a href="#l1.92"></a><span id="l1.92">    *  collections or wildcard collections.  (Actual query-based collections</span>
<a href="#l1.93"></a><span id="l1.93">    *  should represent the state of the query, so unless we're going to delete</span>
<a href="#l1.94"></a><span id="l1.94" class="difflineat">@@ -471,33 +470,37 @@ GlodaCollection.prototype = {</span>
<a href="#l1.95"></a><span id="l1.95">     items.slice(iWrite);</span>
<a href="#l1.96"></a><span id="l1.96">     </span>
<a href="#l1.97"></a><span id="l1.97">     if (this._listener)</span>
<a href="#l1.98"></a><span id="l1.98">       this._listener.onItemsRemoved(aItems);</span>
<a href="#l1.99"></a><span id="l1.99">   },</span>
<a href="#l1.100"></a><span id="l1.100"> };</span>
<a href="#l1.101"></a><span id="l1.101"> </span>
<a href="#l1.102"></a><span id="l1.102"> /**</span>
<a href="#l1.103"></a><span id="l1.103" class="difflineminus">- * A LRU-discard cache.  We use a doubly linked-list for the eviction</span>
<a href="#l1.104"></a><span id="l1.104" class="difflineminus">- *  tracking.  Since we require that there is at most one LRU-discard cache per</span>
<a href="#l1.105"></a><span id="l1.105" class="difflineminus">- *  noun class, we simplify our lives by adding our own attributes to the</span>
<a href="#l1.106"></a><span id="l1.106" class="difflineminus">- *  cached objects.</span>
<a href="#l1.107"></a><span id="l1.107" class="difflineplus">+ * Create an LRU cache collection for the given noun with the given size.</span>
<a href="#l1.108"></a><span id="l1.108" class="difflineplus">+ * @constructor</span>
<a href="#l1.109"></a><span id="l1.109">  */</span>
<a href="#l1.110"></a><span id="l1.110"> function GlodaLRUCacheCollection(aNounMeta, aCacheSize) {</span>
<a href="#l1.111"></a><span id="l1.111">   GlodaCollection.call(this, aNounMeta, null, null, null);</span>
<a href="#l1.112"></a><span id="l1.112">   </span>
<a href="#l1.113"></a><span id="l1.113">   this._head = null; // aka oldest!</span>
<a href="#l1.114"></a><span id="l1.114">   this._tail = null; // aka newest!</span>
<a href="#l1.115"></a><span id="l1.115">   this._size = 0;</span>
<a href="#l1.116"></a><span id="l1.116">   // let's keep things sane, and simplify our logic a little...</span>
<a href="#l1.117"></a><span id="l1.117">   if (aCacheSize &lt; 32)</span>
<a href="#l1.118"></a><span id="l1.118">     aCacheSize = 32;</span>
<a href="#l1.119"></a><span id="l1.119">   this._maxCacheSize = aCacheSize;</span>
<a href="#l1.120"></a><span id="l1.120"> }</span>
<a href="#l1.121"></a><span id="l1.121" class="difflineminus">-</span>
<a href="#l1.122"></a><span id="l1.122" class="difflineplus">+/**</span>
<a href="#l1.123"></a><span id="l1.123" class="difflineplus">+ * @class A LRU-discard cache.  We use a doubly linked-list for the eviction</span>
<a href="#l1.124"></a><span id="l1.124" class="difflineplus">+ *  tracking.  Since we require that there is at most one LRU-discard cache per</span>
<a href="#l1.125"></a><span id="l1.125" class="difflineplus">+ *  noun class, we simplify our lives by adding our own attributes to the</span>
<a href="#l1.126"></a><span id="l1.126" class="difflineplus">+ *  cached objects.</span>
<a href="#l1.127"></a><span id="l1.127" class="difflineplus">+ * @augments GlodaCollection</span>
<a href="#l1.128"></a><span id="l1.128" class="difflineplus">+ */</span>
<a href="#l1.129"></a><span id="l1.129"> GlodaLRUCacheCollection.prototype = new GlodaCollection;</span>
<a href="#l1.130"></a><span id="l1.130"> GlodaLRUCacheCollection.prototype.add = function cache_add(aItems) {</span>
<a href="#l1.131"></a><span id="l1.131">   for each (let item in aItems) {</span>
<a href="#l1.132"></a><span id="l1.132">     if (item.id in this._idMap) {</span>
<a href="#l1.133"></a><span id="l1.133">       // DEBUGME so, we're dealing with this, but it shouldn't happen.  need</span>
<a href="#l1.134"></a><span id="l1.134">       //  trace-debuggage.</span>
<a href="#l1.135"></a><span id="l1.135">       continue;</span>
<a href="#l1.136"></a><span id="l1.136">     }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/modules/datamodel.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/modules/datamodel.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -42,16 +42,19 @@ EXPORTED_SYMBOLS = [&quot;GlodaAttributeDef&quot;,</span>
<a href="#l2.4"></a><span id="l2.4"> const Cc = Components.classes;</span>
<a href="#l2.5"></a><span id="l2.5"> const Ci = Components.interfaces;</span>
<a href="#l2.6"></a><span id="l2.6"> const Cr = Components.results;</span>
<a href="#l2.7"></a><span id="l2.7"> const Cu = Components.utils;</span>
<a href="#l2.8"></a><span id="l2.8"> </span>
<a href="#l2.9"></a><span id="l2.9"> Cu.import(&quot;resource://gloda/modules/log4moz.js&quot;);</span>
<a href="#l2.10"></a><span id="l2.10"> const LOG = Log4Moz.Service.getLogger(&quot;gloda.datamodel&quot;);</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+/**</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+ * @class Represents a gloda attribute definition.</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+ */</span>
<a href="#l2.15"></a><span id="l2.15"> function GlodaAttributeDef(aDatastore, aID, aCompoundName, aProvider, aAttrType,</span>
<a href="#l2.16"></a><span id="l2.16">                            aPluginName, aAttrName, aSubjectTypes,</span>
<a href="#l2.17"></a><span id="l2.17">                            aObjectType, aObjectNounMeta,</span>
<a href="#l2.18"></a><span id="l2.18">                            aExplanationFormat) {</span>
<a href="#l2.19"></a><span id="l2.19">   this._datastore = aDatastore;</span>
<a href="#l2.20"></a><span id="l2.20">   this._id = aID;</span>
<a href="#l2.21"></a><span id="l2.21">   this._compoundName = aCompoundName;</span>
<a href="#l2.22"></a><span id="l2.22">   this._provider = aProvider;</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineat">@@ -151,16 +154,19 @@ GlodaAttributeDef.prototype = {</span>
<a href="#l2.24"></a><span id="l2.24">     }</span>
<a href="#l2.25"></a><span id="l2.25">   },</span>
<a href="#l2.26"></a><span id="l2.26">   </span>
<a href="#l2.27"></a><span id="l2.27">   toString: function() {</span>
<a href="#l2.28"></a><span id="l2.28">     return this._compoundName;</span>
<a href="#l2.29"></a><span id="l2.29">   },</span>
<a href="#l2.30"></a><span id="l2.30"> };</span>
<a href="#l2.31"></a><span id="l2.31"> </span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+/**</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+ * @class A gloda conversation (thread) exists so that messages can belong.</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+ */</span>
<a href="#l2.35"></a><span id="l2.35"> function GlodaConversation(aDatastore, aID, aSubject, aOldestMessageDate,</span>
<a href="#l2.36"></a><span id="l2.36">                            aNewestMessageDate) {</span>
<a href="#l2.37"></a><span id="l2.37">   this._datastore = aDatastore;</span>
<a href="#l2.38"></a><span id="l2.38">   this._id = aID;</span>
<a href="#l2.39"></a><span id="l2.39">   this._subject = aSubject;</span>
<a href="#l2.40"></a><span id="l2.40">   this._oldestMessageDate = aOldestMessageDate;</span>
<a href="#l2.41"></a><span id="l2.41">   this._newestMessageDate = aNewestMessageDate;</span>
<a href="#l2.42"></a><span id="l2.42"> </span>
<a href="#l2.43"></a><span id="l2.43" class="difflineat">@@ -187,17 +193,19 @@ GlodaConversation.prototype = {</span>
<a href="#l2.44"></a><span id="l2.44">     return this._messages;</span>
<a href="#l2.45"></a><span id="l2.45">   },</span>
<a href="#l2.46"></a><span id="l2.46">   </span>
<a href="#l2.47"></a><span id="l2.47">   toString: function gloda_conversation_toString() {</span>
<a href="#l2.48"></a><span id="l2.48">     return this._subject;</span>
<a href="#l2.49"></a><span id="l2.49">   },</span>
<a href="#l2.50"></a><span id="l2.50"> };</span>
<a href="#l2.51"></a><span id="l2.51"> </span>
<a href="#l2.52"></a><span id="l2.52" class="difflineminus">-</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineplus">+/**</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineplus">+ * @class A message representation.</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineplus">+ */</span>
<a href="#l2.56"></a><span id="l2.56"> function GlodaMessage(aDatastore, aID, aFolderID, aMessageKey,</span>
<a href="#l2.57"></a><span id="l2.57">                       aConversationID, aConversation, aDate,</span>
<a href="#l2.58"></a><span id="l2.58">                       aHeaderMessageID, aDeleted) {</span>
<a href="#l2.59"></a><span id="l2.59">   this._datastore = aDatastore;</span>
<a href="#l2.60"></a><span id="l2.60">   this._id = aID;</span>
<a href="#l2.61"></a><span id="l2.61">   this._folderID = aFolderID;</span>
<a href="#l2.62"></a><span id="l2.62">   this._messageKey = aMessageKey;</span>
<a href="#l2.63"></a><span id="l2.63">   this._conversationID = aConversationID;</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineat">@@ -397,16 +405,20 @@ GlodaMessage.prototype = {</span>
<a href="#l2.65"></a><span id="l2.65">     let instances = this.getAttributeInstances(aAttr);</span>
<a href="#l2.66"></a><span id="l2.66">     if (instances.length &gt; 0)</span>
<a href="#l2.67"></a><span id="l2.67">       return instances[0];</span>
<a href="#l2.68"></a><span id="l2.68">     else</span>
<a href="#l2.69"></a><span id="l2.69">       return null;</span>
<a href="#l2.70"></a><span id="l2.70">   },</span>
<a href="#l2.71"></a><span id="l2.71"> };</span>
<a href="#l2.72"></a><span id="l2.72"> </span>
<a href="#l2.73"></a><span id="l2.73" class="difflineplus">+/**</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineplus">+ * @class Contacts correspond to people (one per person), and may own multiple</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineplus">+ *  identities (e-mail address, IM account, etc.) </span>
<a href="#l2.76"></a><span id="l2.76" class="difflineplus">+ */</span>
<a href="#l2.77"></a><span id="l2.77"> function GlodaContact(aDatastore, aID, aDirectoryUUID, aContactUUID, aName,</span>
<a href="#l2.78"></a><span id="l2.78">                       aPopularity, aFrecency) {</span>
<a href="#l2.79"></a><span id="l2.79">   this._datastore = aDatastore;</span>
<a href="#l2.80"></a><span id="l2.80">   this._id = aID;</span>
<a href="#l2.81"></a><span id="l2.81">   this._directoryUUID = aDirectoryUUID;</span>
<a href="#l2.82"></a><span id="l2.82">   this._contactUUID = aContactUUID;</span>
<a href="#l2.83"></a><span id="l2.83">   this._name = aName;</span>
<a href="#l2.84"></a><span id="l2.84">   this._popularity = aPopularity;</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineat">@@ -441,16 +453,19 @@ GlodaContact.prototype = {</span>
<a href="#l2.86"></a><span id="l2.86">     return this._identities;</span>
<a href="#l2.87"></a><span id="l2.87">   },</span>
<a href="#l2.88"></a><span id="l2.88">   </span>
<a href="#l2.89"></a><span id="l2.89">   toString: function gloda_contact_toString() {</span>
<a href="#l2.90"></a><span id="l2.90">     return this._name;</span>
<a href="#l2.91"></a><span id="l2.91">   }</span>
<a href="#l2.92"></a><span id="l2.92"> };</span>
<a href="#l2.93"></a><span id="l2.93"> </span>
<a href="#l2.94"></a><span id="l2.94" class="difflineplus">+/**</span>
<a href="#l2.95"></a><span id="l2.95" class="difflineplus">+ * @class A specific means of communication for a contact.</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineplus">+ */</span>
<a href="#l2.97"></a><span id="l2.97"> function GlodaIdentity(aDatastore, aID, aContactID, aContact, aKind, aValue,</span>
<a href="#l2.98"></a><span id="l2.98">                        aDescription, aIsRelay) {</span>
<a href="#l2.99"></a><span id="l2.99">   this._datastore = aDatastore;</span>
<a href="#l2.100"></a><span id="l2.100">   this._id = aID;</span>
<a href="#l2.101"></a><span id="l2.101">   this._contactID = aContactID;</span>
<a href="#l2.102"></a><span id="l2.102">   this._contact = aContact;</span>
<a href="#l2.103"></a><span id="l2.103">   this._kind = aKind;</span>
<a href="#l2.104"></a><span id="l2.104">   this._value = aValue;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/modules/datastore.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/modules/datastore.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -54,23 +54,25 @@ Cu.import(&quot;resource://gloda/modules/data</span>
<a href="#l3.4"></a><span id="l3.4"> Cu.import(&quot;resource://gloda/modules/collection.js&quot;);</span>
<a href="#l3.5"></a><span id="l3.5"> </span>
<a href="#l3.6"></a><span id="l3.6"> // XXX from Gloda.js.  duplicated here for dependency reasons.  bad!</span>
<a href="#l3.7"></a><span id="l3.7"> const kSpecialColumn = 1;</span>
<a href="#l3.8"></a><span id="l3.8"> const kSpecialString = 2;</span>
<a href="#l3.9"></a><span id="l3.9"> const kSpecialFulltext = 3;</span>
<a href="#l3.10"></a><span id="l3.10"> </span>
<a href="#l3.11"></a><span id="l3.11"> /**</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">- * This callback handles processing the asynchronous query results of</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+ * @class This callback handles processing the asynchronous query results of</span>
<a href="#l3.14"></a><span id="l3.14">  *  GlodaDatastore.getMessagesByMessageID.  Because that method is only</span>
<a href="#l3.15"></a><span id="l3.15">  *  called as part of the indexing process, we are guaranteed that there will</span>
<a href="#l3.16"></a><span id="l3.16">  *  be no real caching ramifications.  Accordingly, we can also defer our cache</span>
<a href="#l3.17"></a><span id="l3.17">  *  processing (via GlodaCollectionManager) until the query completes.</span>
<a href="#l3.18"></a><span id="l3.18">  *</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineminus">- * @param aMsgIDToIndex Map from message-id to the desired   </span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+ * @param aMsgIDToIndex Map from message-id to the desired</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+ *</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+ * @constructor</span>
<a href="#l3.23"></a><span id="l3.23">  */</span>
<a href="#l3.24"></a><span id="l3.24"> function MessagesByMessageIdCallback(aStatement, aMsgIDToIndex, aResults,</span>
<a href="#l3.25"></a><span id="l3.25">                                      aCallback, aCallbackThis, aCallbackArgs) {</span>
<a href="#l3.26"></a><span id="l3.26">   this.statement = aStatement;</span>
<a href="#l3.27"></a><span id="l3.27">   this.msgIDToIndex = aMsgIDToIndex;</span>
<a href="#l3.28"></a><span id="l3.28">   this.results = aResults;</span>
<a href="#l3.29"></a><span id="l3.29">   this.callback = aCallback;</span>
<a href="#l3.30"></a><span id="l3.30">   this.callbackThis = aCallbackThis;</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineat">@@ -106,16 +108,20 @@ MessagesByMessageIdCallback.prototype = </span>
<a href="#l3.32"></a><span id="l3.32">     this.statement = null;</span>
<a href="#l3.33"></a><span id="l3.33"> </span>
<a href="#l3.34"></a><span id="l3.34">     this.callback.apply(this.callbackThis, args);</span>
<a href="#l3.35"></a><span id="l3.35">     </span>
<a href="#l3.36"></a><span id="l3.36">     GlodaDatastore._asyncCompleted();</span>
<a href="#l3.37"></a><span id="l3.37">   }</span>
<a href="#l3.38"></a><span id="l3.38"> };</span>
<a href="#l3.39"></a><span id="l3.39"> </span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+/**</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+ * @class Handles the results from a GlodaDatastore.queryFromQuery call.</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineplus">+ * @constructor</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineplus">+ */</span>
<a href="#l3.44"></a><span id="l3.44"> function QueryFromQueryCallback(aStatement, aNounMeta, aCollection) {</span>
<a href="#l3.45"></a><span id="l3.45">   this.statement = aStatement;</span>
<a href="#l3.46"></a><span id="l3.46">   this.nounMeta = aNounMeta;</span>
<a href="#l3.47"></a><span id="l3.47">   this.collection = aCollection;</span>
<a href="#l3.48"></a><span id="l3.48">   </span>
<a href="#l3.49"></a><span id="l3.49">   GlodaDatastore._pendingAsyncStatements++;</span>
<a href="#l3.50"></a><span id="l3.50"> }</span>
<a href="#l3.51"></a><span id="l3.51"> </span>
<a href="#l3.52"></a><span id="l3.52" class="difflineat">@@ -244,18 +250,19 @@ QueryFromQueryCallback.prototype = {</span>
<a href="#l3.53"></a><span id="l3.53">  *  relates them via an attribute.  To do so, it must create new recipe rows</span>
<a href="#l3.54"></a><span id="l3.54">  *  in its own table as new recipes are discovered.  No automatic mechanism</span>
<a href="#l3.55"></a><span id="l3.55">  *  will purge recipes as their source messages are purged, nor does any</span>
<a href="#l3.56"></a><span id="l3.56">  *  event-driven mechanism explicitly inform the plugin.  (It could infer</span>
<a href="#l3.57"></a><span id="l3.57">  *  such an event from the indexing/attribute-providing process, or poll the</span>
<a href="#l3.58"></a><span id="l3.58">  *  states of attributes to accomplish this, but that is not desirable.)  This</span>
<a href="#l3.59"></a><span id="l3.59">  *  needs to be addressed, and may be best addressed at layers above</span>
<a href="#l3.60"></a><span id="l3.60">  *  datastore.js.</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineplus">+ * @namespace</span>
<a href="#l3.62"></a><span id="l3.62">  */</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineminus">-let GlodaDatastore = {</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineplus">+var GlodaDatastore = {</span>
<a href="#l3.65"></a><span id="l3.65">   _log: null,</span>
<a href="#l3.66"></a><span id="l3.66"> </span>
<a href="#l3.67"></a><span id="l3.67">   /* ******************* SCHEMA ******************* */</span>
<a href="#l3.68"></a><span id="l3.68"> </span>
<a href="#l3.69"></a><span id="l3.69">   _schemaVersion: 8,</span>
<a href="#l3.70"></a><span id="l3.70">   _schema: {</span>
<a href="#l3.71"></a><span id="l3.71">     tables: {</span>
<a href="#l3.72"></a><span id="l3.72">       </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/modules/explattr.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/modules/explattr.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -50,23 +50,21 @@ Cu.import(&quot;resource://gloda/modules/noun</span>
<a href="#l4.4"></a><span id="l4.4"> </span>
<a href="#l4.5"></a><span id="l4.5"> </span>
<a href="#l4.6"></a><span id="l4.6"> const EXT_BUILTIN = &quot;built-in&quot;;</span>
<a href="#l4.7"></a><span id="l4.7"> const FA_TAG = &quot;TAG&quot;;</span>
<a href="#l4.8"></a><span id="l4.8"> const FA_STAR = &quot;STAR&quot;;</span>
<a href="#l4.9"></a><span id="l4.9"> const FA_READ = &quot;READ&quot;;</span>
<a href="#l4.10"></a><span id="l4.10"> </span>
<a href="#l4.11"></a><span id="l4.11"> /**</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">- * The Gloda Fundamental Attribute provider is a special-case attribute</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">- *  provider; it provides attributes that the rest of the providers should be</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">- *  able to assume exist.  Also, it may end up accessing things at a lower level</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineminus">- *  than most extension providers should do.  In summary, don't mimic this code</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineminus">- *  unless you won't complain when your code breaks.</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+ * @namespace Explicit attribute provider.  Indexes/defines attributes that are</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+ *  explicitly a result of user action.  This dubiously includes marking a</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+ *  message as read. </span>
<a href="#l4.20"></a><span id="l4.20">  */</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineminus">-let GlodaExplicitAttr = {</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+var GlodaExplicitAttr = {</span>
<a href="#l4.23"></a><span id="l4.23">   providerName: &quot;gloda.explattr&quot;,</span>
<a href="#l4.24"></a><span id="l4.24">   _log: null,</span>
<a href="#l4.25"></a><span id="l4.25">   _strBundle: null,</span>
<a href="#l4.26"></a><span id="l4.26">   _mstTagService: null,</span>
<a href="#l4.27"></a><span id="l4.27"> </span>
<a href="#l4.28"></a><span id="l4.28">   init: function gloda_explattr_init(aStrBundle) {</span>
<a href="#l4.29"></a><span id="l4.29">     this._log =  Log4Moz.Service.getLogger(&quot;gloda.explattr&quot;);</span>
<a href="#l4.30"></a><span id="l4.30">     this._strBundle = aStrBundle;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/modules/fundattr.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/modules/fundattr.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -44,23 +44,23 @@ const Cu = Components.utils;</span>
<a href="#l5.4"></a><span id="l5.4"> </span>
<a href="#l5.5"></a><span id="l5.5"> Cu.import(&quot;resource://gloda/modules/log4moz.js&quot;);</span>
<a href="#l5.6"></a><span id="l5.6"> </span>
<a href="#l5.7"></a><span id="l5.7"> Cu.import(&quot;resource://gloda/modules/utils.js&quot;);</span>
<a href="#l5.8"></a><span id="l5.8"> Cu.import(&quot;resource://gloda/modules/gloda.js&quot;);</span>
<a href="#l5.9"></a><span id="l5.9"> Cu.import(&quot;resource://gloda/modules/datastore.js&quot;);</span>
<a href="#l5.10"></a><span id="l5.10"> </span>
<a href="#l5.11"></a><span id="l5.11"> /**</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">- * The Gloda Fundamental Attribute provider is a special-case attribute</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+ * @namespace The Gloda Fundamental Attribute provider is a special attribute</span>
<a href="#l5.14"></a><span id="l5.14">  *  provider; it provides attributes that the rest of the providers should be</span>
<a href="#l5.15"></a><span id="l5.15">  *  able to assume exist.  Also, it may end up accessing things at a lower level</span>
<a href="#l5.16"></a><span id="l5.16">  *  than most extension providers should do.  In summary, don't mimic this code</span>
<a href="#l5.17"></a><span id="l5.17">  *  unless you won't complain when your code breaks.</span>
<a href="#l5.18"></a><span id="l5.18">  */</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineminus">-let GlodaFundAttr = {</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineplus">+var GlodaFundAttr = {</span>
<a href="#l5.21"></a><span id="l5.21">   providerName: &quot;gloda.fundattr&quot;,</span>
<a href="#l5.22"></a><span id="l5.22">   _log: null,</span>
<a href="#l5.23"></a><span id="l5.23">   _strBundle: null,</span>
<a href="#l5.24"></a><span id="l5.24"> </span>
<a href="#l5.25"></a><span id="l5.25">   init: function gloda_explattr_init(aStrBundle) {</span>
<a href="#l5.26"></a><span id="l5.26">     this._log =  Log4Moz.Service.getLogger(&quot;gloda.fundattr&quot;);</span>
<a href="#l5.27"></a><span id="l5.27">     this._strBundle = aStrBundle;</span>
<a href="#l5.28"></a><span id="l5.28">   </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/modules/gloda.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/modules/gloda.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -46,18 +46,18 @@ Cu.import(&quot;resource://gloda/modules/log4</span>
<a href="#l6.4"></a><span id="l6.4"> </span>
<a href="#l6.5"></a><span id="l6.5"> Cu.import(&quot;resource://gloda/modules/datastore.js&quot;);</span>
<a href="#l6.6"></a><span id="l6.6"> Cu.import(&quot;resource://gloda/modules/datamodel.js&quot;);</span>
<a href="#l6.7"></a><span id="l6.7"> Cu.import(&quot;resource://gloda/modules/collection.js&quot;);</span>
<a href="#l6.8"></a><span id="l6.8"> Cu.import(&quot;resource://gloda/modules/query.js&quot;);</span>
<a href="#l6.9"></a><span id="l6.9"> Cu.import(&quot;resource://gloda/modules/utils.js&quot;);</span>
<a href="#l6.10"></a><span id="l6.10"> </span>
<a href="#l6.11"></a><span id="l6.11"> /**</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">- * This object/namespace provides the user-visible (and extension visible)</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">- *  global database functionality.  There is currently a dependency/ordering</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+ * Provides the user-visible (and extension visible) global database</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+ *  functionality.  There is currently a dependency/ordering</span>
<a href="#l6.16"></a><span id="l6.16">  *  problem in that the concept of 'gloda' also includes some logic that is</span>
<a href="#l6.17"></a><span id="l6.17">  *  contributed by built-in extensions, if you will.  Those built-in extensions</span>
<a href="#l6.18"></a><span id="l6.18">  *  (fundattr.js, explattr.js) also import this file.  To avoid a circular</span>
<a href="#l6.19"></a><span id="l6.19">  *  dependency, those built-in extensions are loaded by everybody.js.  The</span>
<a href="#l6.20"></a><span id="l6.20">  *  simplest/best solution is probably to move everybody.js to be gloda.js and</span>
<a href="#l6.21"></a><span id="l6.21">  *  have it re-export only 'Gloda'.  gloda.js (this file) can then move to be</span>
<a href="#l6.22"></a><span id="l6.22">  *  gloda_int.js (or whatever our eventual naming scheme is), which built-in</span>
<a href="#l6.23"></a><span id="l6.23">  *  extensions can explicitly rely upon.</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineat">@@ -132,18 +132,19 @@ Cu.import(&quot;resource://gloda/modules/util</span>
<a href="#l6.25"></a><span id="l6.25">  *  tells us who a message is 'from' based on the e-mail address present.</span>
<a href="#l6.26"></a><span id="l6.26">  *  However, other plugins may actually know better.  For example, the bugzilla</span>
<a href="#l6.27"></a><span id="l6.27">  *  daemon e-mails based on bug activity although the daemon gets the credit</span>
<a href="#l6.28"></a><span id="l6.28">  *  as the official sender.  A bugzilla plugin can easily extract the actual</span>
<a href="#l6.29"></a><span id="l6.29">  *  person/e-mail addressed who did something on the bug to cause the</span>
<a href="#l6.30"></a><span id="l6.30">  *  notification to be sent.  In practice, we would like that person to be</span>
<a href="#l6.31"></a><span id="l6.31">  *  the 'sender' of the bugmail.  But we can't really do that right, yet.</span>
<a href="#l6.32"></a><span id="l6.32">  * </span>
<a href="#l6.33"></a><span id="l6.33" class="difflineplus">+ * @namespace</span>
<a href="#l6.34"></a><span id="l6.34">  */</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineminus">-let Gloda = {</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineplus">+var Gloda = {</span>
<a href="#l6.37"></a><span id="l6.37">   /**</span>
<a href="#l6.38"></a><span id="l6.38">    * Initialize logging, the datastore (SQLite database), the core nouns and</span>
<a href="#l6.39"></a><span id="l6.39">    *  attributes, and the contact and identities that belong to the presumed</span>
<a href="#l6.40"></a><span id="l6.40">    *  current user (based on accounts).</span>
<a href="#l6.41"></a><span id="l6.41">    *</span>
<a href="#l6.42"></a><span id="l6.42">    * Additional nouns and the core attribute providers are initialized by the</span>
<a href="#l6.43"></a><span id="l6.43">    *  everybody.js module which ensures all of those dependencies are loaded</span>
<a href="#l6.44"></a><span id="l6.44">    *  (and initialized).</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineat">@@ -630,19 +631,19 @@ let Gloda = {</span>
<a href="#l6.46"></a><span id="l6.46">    * One conceptual issue raised by this mechanism is the interaction of actions</span>
<a href="#l6.47"></a><span id="l6.47">    *  with facts like &quot;this message is read&quot;.  We currently implement the 'fact'</span>
<a href="#l6.48"></a><span id="l6.48">    *  by defining an attribute with a 'boolean' noun type.  To deal with this,</span>
<a href="#l6.49"></a><span id="l6.49">    *  in various places we pass-in the attribute as well as the noun value.</span>
<a href="#l6.50"></a><span id="l6.50">    *  Since the relationships for booleans and integers in these cases is</span>
<a href="#l6.51"></a><span id="l6.51">    *  standard and well-defined, this works out pretty well, but suggests we</span>
<a href="#l6.52"></a><span id="l6.52">    *  need to think things through.</span>
<a href="#l6.53"></a><span id="l6.53">    *</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineminus">-   * @param The ID of the noun you want to define an action on.</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineminus">-   * @param The dictionary describing the noun.  The dictionary should have</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineminus">-   *     the following fields:</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineplus">+   * @param aNounID The ID of the noun you want to define an action on.</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineplus">+   * @param aAction Meta The dictionary describing the noun.  The dictionary</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineplus">+   *     should have the following fields:</span>
<a href="#l6.60"></a><span id="l6.60">    * - actionType: a string indicating the type of action.  Currently, only</span>
<a href="#l6.61"></a><span id="l6.61">    *   &quot;filter&quot; is a legal value.</span>
<a href="#l6.62"></a><span id="l6.62">    * - actionTarget: the noun ID of the noun type on which this action is</span>
<a href="#l6.63"></a><span id="l6.63">    *   applicable.  For example,</span>
<a href="#l6.64"></a><span id="l6.64">    *</span>
<a href="#l6.65"></a><span id="l6.65">    * The following should be present for actionType==&quot;filter&quot;;</span>
<a href="#l6.66"></a><span id="l6.66">    * - shortName: The name that should be used to display this constraint.  For</span>
<a href="#l6.67"></a><span id="l6.67">    *   example, a checkbox-heavy UI might display a checkbox for each constraint</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineat">@@ -1321,22 +1322,22 @@ let Gloda = {</span>
<a href="#l6.69"></a><span id="l6.69">   },</span>
<a href="#l6.70"></a><span id="l6.70">   </span>
<a href="#l6.71"></a><span id="l6.71">   /**</span>
<a href="#l6.72"></a><span id="l6.72">    * Deprecated mechanism for querying for messages.  Use newQuery now,</span>
<a href="#l6.73"></a><span id="l6.73">    *  specifying the message noun id.  Still works for now, but not for long.</span>
<a href="#l6.74"></a><span id="l6.74">    */</span>
<a href="#l6.75"></a><span id="l6.75">   queryMessagesAPV: function gloda_ns_queryMessagesAPV(aAPVs) {</span>
<a href="#l6.76"></a><span id="l6.76">     return GlodaDatastore.queryMessagesAPV(aAPVs);</span>
<a href="#l6.77"></a><span id="l6.77" class="difflineminus">-  },</span>
<a href="#l6.78"></a><span id="l6.78" class="difflineplus">+  }</span>
<a href="#l6.79"></a><span id="l6.79"> };</span>
<a href="#l6.80"></a><span id="l6.80"> </span>
<a href="#l6.81"></a><span id="l6.81"> /* and initialize the Gloda object/NS before we return... */</span>
<a href="#l6.82"></a><span id="l6.82"> try {</span>
<a href="#l6.83"></a><span id="l6.83">   Gloda._init();</span>
<a href="#l6.84"></a><span id="l6.84"> }</span>
<a href="#l6.85"></a><span id="l6.85"> catch (ex) {</span>
<a href="#l6.86"></a><span id="l6.86">   Gloda._log.debug(&quot;Exception during Gloda init (&quot; + ex.fileName + &quot;:&quot; +</span>
<a href="#l6.87"></a><span id="l6.87">                    ex.lineNumber + &quot;): &quot; + ex);</span>
<a href="#l6.88"></a><span id="l6.88" class="difflineminus">-}</span>
<a href="#l6.89"></a><span id="l6.89" class="difflineplus">+};</span>
<a href="#l6.90"></a><span id="l6.90"> /* but don't forget that we effectively depend on everybody.js too, and</span>
<a href="#l6.91"></a><span id="l6.91">    currently on our importer to be importing that if they need us fully armed</span>
<a href="#l6.92"></a><span id="l6.92">    and operational. */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/modules/indexer.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/modules/indexer.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -127,17 +127,17 @@ function fixIterator(aEnum, aIface) {</span>
<a href="#l7.4"></a><span id="l7.4">     }</span>
<a href="#l7.5"></a><span id="l7.5">     return { __iterator__: iter };</span>
<a href="#l7.6"></a><span id="l7.6">   } catch(ex) {}</span>
<a href="#l7.7"></a><span id="l7.7"> }</span>
<a href="#l7.8"></a><span id="l7.8"> </span>
<a href="#l7.9"></a><span id="l7.9"> const MSG_FLAG_OFFLINE = 0x80;</span>
<a href="#l7.10"></a><span id="l7.10"> </span>
<a href="#l7.11"></a><span id="l7.11"> /**</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">- * Capture the indexing batch concept explicitly.</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+ * @class Capture the indexing batch concept explicitly.</span>
<a href="#l7.14"></a><span id="l7.14">  *</span>
<a href="#l7.15"></a><span id="l7.15">  * @param aJobType The type of thing we are indexing.  Current choices are:</span>
<a href="#l7.16"></a><span id="l7.16">  *   &quot;folder&quot; and &quot;message&quot;.  Previous choices included &quot;account&quot;.  The indexer</span>
<a href="#l7.17"></a><span id="l7.17">  *   currently knows too much about these; they should be de-coupled.</span>
<a href="#l7.18"></a><span id="l7.18">  * @param aDeltaType -1 for deletion, 0 for move, 1 for addition/new.</span>
<a href="#l7.19"></a><span id="l7.19">  * @param aID Specific to the job type, but for now only used to hold folder</span>
<a href="#l7.20"></a><span id="l7.20">  *     IDs.</span>
<a href="#l7.21"></a><span id="l7.21">  *</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineat">@@ -148,44 +148,31 @@ const MSG_FLAG_OFFLINE = 0x80;</span>
<a href="#l7.23"></a><span id="l7.23">  * @ivar offset The current offset into the 'items' list (if used), updated as</span>
<a href="#l7.24"></a><span id="l7.24">  *     processing occurs.  If 'items' is not used, the processing code can also</span>
<a href="#l7.25"></a><span id="l7.25">  *     update this in a similar fashion.  This is used by the status</span>
<a href="#l7.26"></a><span id="l7.26">  *     notification code in conjunction with goal.</span>
<a href="#l7.27"></a><span id="l7.27">  * @ivar goal The total number of items to index/actions to perform in this job.</span>
<a href="#l7.28"></a><span id="l7.28">  *     This number may increase during the life of the job, but should not</span>
<a href="#l7.29"></a><span id="l7.29">  *     decrease.  This is used by the status notification code in conjunction</span>
<a href="#l7.30"></a><span id="l7.30">  *     with the goal.</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineplus">+ *</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+ * @constructor</span>
<a href="#l7.33"></a><span id="l7.33">  */</span>
<a href="#l7.34"></a><span id="l7.34"> function IndexingJob(aJobType, aDeltaType, aID) {</span>
<a href="#l7.35"></a><span id="l7.35">   this.jobType = aJobType;</span>
<a href="#l7.36"></a><span id="l7.36">   this.deltaType = aDeltaType;</span>
<a href="#l7.37"></a><span id="l7.37">   this.id = aID;</span>
<a href="#l7.38"></a><span id="l7.38">   this.items = [];</span>
<a href="#l7.39"></a><span id="l7.39">   this.offset = 0;</span>
<a href="#l7.40"></a><span id="l7.40">   this.goal = null;</span>
<a href="#l7.41"></a><span id="l7.41"> }</span>
<a href="#l7.42"></a><span id="l7.42"> </span>
<a href="#l7.43"></a><span id="l7.43" class="difflineminus">-/** Synchronous activities performed, you can drive us more. */</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineminus">-const kWorkSync = 0;</span>
<a href="#l7.45"></a><span id="l7.45"> /**</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineminus">- * Asynchronous activity performed, you need to relinquish flow control and</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineminus">- *  trust us to call callbackDriver later.</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineminus">- */</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineminus">-const kWorkAsync = 1;</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineminus">-/**</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineminus">- * We are all done with our task, close us and figure out something else to do.</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineminus">- */</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineminus">-const kWorkDone = 2;</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineminus">-/**</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineminus">- * We are not done with our task, but we think it's a good idea to take a</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineminus">- *  breather.</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineminus">- */</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineminus">-const kWorkPause = 3;</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineminus">-</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineminus">-/**</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineplus">+ * @namespace Core indexing logic, plus message-specific indexing logic.</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineplus">+ *</span>
<a href="#l7.63"></a><span id="l7.63">  * === Indexing Goals</span>
<a href="#l7.64"></a><span id="l7.64">  * We have the following goals:</span>
<a href="#l7.65"></a><span id="l7.65">  *</span>
<a href="#l7.66"></a><span id="l7.66">  * Responsiveness</span>
<a href="#l7.67"></a><span id="l7.67">  * - When the user wants to quit, we should be able to stop and quit in a timely</span>
<a href="#l7.68"></a><span id="l7.68">  *   fasion.</span>
<a href="#l7.69"></a><span id="l7.69">  * - We should not interfere with the user's thunderbird usage.</span>
<a href="#l7.70"></a><span id="l7.70">  *</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineat">@@ -255,17 +242,17 @@ const kWorkPause = 3;</span>
<a href="#l7.72"></a><span id="l7.72">  *  certainly works.</span>
<a href="#l7.73"></a><span id="l7.73">  *  </span>
<a href="#l7.74"></a><span id="l7.74">  * We are not sufficiently good at detaching our listeners so as to avoid</span>
<a href="#l7.75"></a><span id="l7.75">  *  crashes.  We want to hook the shutdown notification, but we don't.  We do</span>
<a href="#l7.76"></a><span id="l7.76">  *  try to hook database-is-going-away notifications, but it's really not</span>
<a href="#l7.77"></a><span id="l7.77">  *  tested.  We definitely do crash sometimes when you're shutting down.</span>
<a href="#l7.78"></a><span id="l7.78">  * </span>
<a href="#l7.79"></a><span id="l7.79">  */</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineminus">-let GlodaIndexer = {</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineplus">+var GlodaIndexer = {</span>
<a href="#l7.82"></a><span id="l7.82">   /**</span>
<a href="#l7.83"></a><span id="l7.83">    * A partial attempt to generalize to support multiple databases.  Each</span>
<a href="#l7.84"></a><span id="l7.84">    *  database would have its own datastore would have its own indexer.  But</span>
<a href="#l7.85"></a><span id="l7.85">    *  we rather inter-mingle our use of this field with the singleton global</span>
<a href="#l7.86"></a><span id="l7.86">    *  GlodaDatastore.</span>
<a href="#l7.87"></a><span id="l7.87">    */</span>
<a href="#l7.88"></a><span id="l7.88">   _datastore: GlodaDatastore,</span>
<a href="#l7.89"></a><span id="l7.89">   _log: Log4Moz.Service.getLogger(&quot;gloda.indexer&quot;),</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineat">@@ -476,16 +463,33 @@ let GlodaIndexer = {</span>
<a href="#l7.91"></a><span id="l7.91">    *  it means the value is known reliably.  If this value is null, it means</span>
<a href="#l7.92"></a><span id="l7.92">    *  that we don't know, likely because we have started up and have not checked</span>
<a href="#l7.93"></a><span id="l7.93">    *  the database.</span>
<a href="#l7.94"></a><span id="l7.94">    */</span>
<a href="#l7.95"></a><span id="l7.95">   pendingDeletions: null,</span>
<a href="#l7.96"></a><span id="l7.96">   </span>
<a href="#l7.97"></a><span id="l7.97">   GLODA_MESSAGE_ID_PROPERTY: &quot;gloda-id&quot;,</span>
<a href="#l7.98"></a><span id="l7.98">   GLODA_DIRTY_PROPERTY: &quot;gloda-dirty&quot;,</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineplus">+</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineplus">+  /** Synchronous activities performed, you can drive us more. */</span>
<a href="#l7.101"></a><span id="l7.101" class="difflineplus">+  kWorkSync: 0,</span>
<a href="#l7.102"></a><span id="l7.102" class="difflineplus">+  /**</span>
<a href="#l7.103"></a><span id="l7.103" class="difflineplus">+   * Asynchronous activity performed, you need to relinquish flow control and</span>
<a href="#l7.104"></a><span id="l7.104" class="difflineplus">+   *  trust us to call callbackDriver later.</span>
<a href="#l7.105"></a><span id="l7.105" class="difflineplus">+   */</span>
<a href="#l7.106"></a><span id="l7.106" class="difflineplus">+  kWorkAsync: 1,</span>
<a href="#l7.107"></a><span id="l7.107" class="difflineplus">+  /**</span>
<a href="#l7.108"></a><span id="l7.108" class="difflineplus">+   * We are all done with our task, close us and figure out something else to do.</span>
<a href="#l7.109"></a><span id="l7.109" class="difflineplus">+   */</span>
<a href="#l7.110"></a><span id="l7.110" class="difflineplus">+  kWorkDone: 2,</span>
<a href="#l7.111"></a><span id="l7.111" class="difflineplus">+  /**</span>
<a href="#l7.112"></a><span id="l7.112" class="difflineplus">+   * We are not done with our task, but we think it's a good idea to take a</span>
<a href="#l7.113"></a><span id="l7.113" class="difflineplus">+   *  breather.</span>
<a href="#l7.114"></a><span id="l7.114" class="difflineplus">+   */</span>
<a href="#l7.115"></a><span id="l7.115" class="difflineplus">+  kWorkPause: 3,</span>
<a href="#l7.116"></a><span id="l7.116">   </span>
<a href="#l7.117"></a><span id="l7.117">   /**</span>
<a href="#l7.118"></a><span id="l7.118">    * Our current job number, out of _indexingJobGoal.  Although our jobs comes</span>
<a href="#l7.119"></a><span id="l7.119">    *  from _indexQueue, this is not an offset into that list because we forget</span>
<a href="#l7.120"></a><span id="l7.120">    *  jobs once we complete them.  As such, this value is strictly for progress</span>
<a href="#l7.121"></a><span id="l7.121">    *  tracking.</span>
<a href="#l7.122"></a><span id="l7.122">    */ </span>
<a href="#l7.123"></a><span id="l7.123">   _indexingJobCount: 0,</span>
<a href="#l7.124"></a><span id="l7.124" class="difflineat">@@ -699,17 +703,17 @@ let GlodaIndexer = {</span>
<a href="#l7.125"></a><span id="l7.125">       catch ( e if e.result == Cr.NS_ERROR_NOT_INITIALIZED) {</span>
<a href="#l7.126"></a><span id="l7.126">         // this means that we need to pend on the update.</span>
<a href="#l7.127"></a><span id="l7.127">         this._log.debug(&quot;Pending on folder load...&quot;);</span>
<a href="#l7.128"></a><span id="l7.128">         this._pendingFolderEntry = this._indexingFolder;</span>
<a href="#l7.129"></a><span id="l7.129">         this._indexingFolder = null;</span>
<a href="#l7.130"></a><span id="l7.130">         this._indexingFolderID = null;</span>
<a href="#l7.131"></a><span id="l7.131">         this._indexingDatabase = null;</span>
<a href="#l7.132"></a><span id="l7.132">         this._indexingIterator = null;</span>
<a href="#l7.133"></a><span id="l7.133" class="difflineminus">-        return kWorkAsync;</span>
<a href="#l7.134"></a><span id="l7.134" class="difflineplus">+        return this.kWorkAsync;</span>
<a href="#l7.135"></a><span id="l7.135">       }</span>
<a href="#l7.136"></a><span id="l7.136">       // we get an nsIMsgDatabase out of this (unsurprisingly) which</span>
<a href="#l7.137"></a><span id="l7.137">       //  explicitly inherits from nsIDBChangeAnnouncer, which has the</span>
<a href="#l7.138"></a><span id="l7.138">       //  AddListener call we want.</span>
<a href="#l7.139"></a><span id="l7.139">       if (this._indexingDatabase == null)</span>
<a href="#l7.140"></a><span id="l7.140">         this._indexingDatabase = folder.getMsgDatabase(null);</span>
<a href="#l7.141"></a><span id="l7.141">       if (aNeedIterator)</span>
<a href="#l7.142"></a><span id="l7.142">         this._indexingIterator = fixIterator(</span>
<a href="#l7.143"></a><span id="l7.143" class="difflineat">@@ -726,17 +730,17 @@ let GlodaIndexer = {</span>
<a href="#l7.144"></a><span id="l7.144">       this._indexingDatabase = null;</span>
<a href="#l7.145"></a><span id="l7.145">       this._indexingIterator = null;</span>
<a href="#l7.146"></a><span id="l7.146">       </span>
<a href="#l7.147"></a><span id="l7.147">       // re-throw, we just wanted to make sure this junk is cleaned up and</span>
<a href="#l7.148"></a><span id="l7.148">       //  get localized error logging...</span>
<a href="#l7.149"></a><span id="l7.149">       throw ex;</span>
<a href="#l7.150"></a><span id="l7.150">     }</span>
<a href="#l7.151"></a><span id="l7.151">     </span>
<a href="#l7.152"></a><span id="l7.152" class="difflineminus">-    return kWorkSync;</span>
<a href="#l7.153"></a><span id="l7.153" class="difflineplus">+    return this.kWorkSync;</span>
<a href="#l7.154"></a><span id="l7.154">   },</span>
<a href="#l7.155"></a><span id="l7.155">   </span>
<a href="#l7.156"></a><span id="l7.156">   _indexerLeaveFolder: function gloda_index_indexerLeaveFolder(aExpected) {</span>
<a href="#l7.157"></a><span id="l7.157">     if (this._indexingFolder !== null) {</span>
<a href="#l7.158"></a><span id="l7.158">       // remove our listener!</span>
<a href="#l7.159"></a><span id="l7.159">       this._indexingDatabase.RemoveListener(this._databaseAnnouncerListener);</span>
<a href="#l7.160"></a><span id="l7.160">       // null everyone out</span>
<a href="#l7.161"></a><span id="l7.161">       this._indexingFolder = null;</span>
<a href="#l7.162"></a><span id="l7.162" class="difflineat">@@ -811,30 +815,30 @@ let GlodaIndexer = {</span>
<a href="#l7.163"></a><span id="l7.163">       // kWorkAsync, kWorkDone, kWorkPause are allowed out; kWorkSync is not</span>
<a href="#l7.164"></a><span id="l7.164">       // On kWorkDone, we want to schedule another timer to fire on us if we are</span>
<a href="#l7.165"></a><span id="l7.165">       //  not done indexing.  (On kWorkAsync, we don't care what happens, because</span>
<a href="#l7.166"></a><span id="l7.166">       //  someone else will be receiving the callback, and they will call us when</span>
<a href="#l7.167"></a><span id="l7.167">       //  they are done doing their thing.</span>
<a href="#l7.168"></a><span id="l7.168">       switch (this._batch.next()) {</span>
<a href="#l7.169"></a><span id="l7.169">         // job's done, close the batch and re-schedule ourselves if there's more</span>
<a href="#l7.170"></a><span id="l7.170">         //  to do.</span>
<a href="#l7.171"></a><span id="l7.171" class="difflineminus">-        case kWorkDone:</span>
<a href="#l7.172"></a><span id="l7.172" class="difflineplus">+        case this.kWorkDone:</span>
<a href="#l7.173"></a><span id="l7.173">           this._batch.close();</span>
<a href="#l7.174"></a><span id="l7.174">           this._batch = null;</span>
<a href="#l7.175"></a><span id="l7.175">           // (intentional fall-through to re-scheduling logic) </span>
<a href="#l7.176"></a><span id="l7.176">         // the batch wants to get re-scheduled, do so.</span>
<a href="#l7.177"></a><span id="l7.177" class="difflineminus">-        case kWorkPause:</span>
<a href="#l7.178"></a><span id="l7.178" class="difflineplus">+        case this.kWorkPause:</span>
<a href="#l7.179"></a><span id="l7.179">           if (this.indexing)</span>
<a href="#l7.180"></a><span id="l7.180">             this._timer.initWithCallback(this._wrapCallbackDriver,</span>
<a href="#l7.181"></a><span id="l7.181">                                          this._indexInterval,</span>
<a href="#l7.182"></a><span id="l7.182">                                          Ci.nsITimer.TYPE_ONE_SHOT);</span>
<a href="#l7.183"></a><span id="l7.183">           else // it's important to indicate no more callbacks are in flight</span>
<a href="#l7.184"></a><span id="l7.184">             this._indexingActive = false;</span>
<a href="#l7.185"></a><span id="l7.185">           break;</span>
<a href="#l7.186"></a><span id="l7.186" class="difflineminus">-        case kWorkAsync:</span>
<a href="#l7.187"></a><span id="l7.187" class="difflineplus">+        case this.kWorkAsync:</span>
<a href="#l7.188"></a><span id="l7.188">           // there is nothing to do.  some other code is now responsible for</span>
<a href="#l7.189"></a><span id="l7.189">           //  calling us.</span>
<a href="#l7.190"></a><span id="l7.190">           break;</span>
<a href="#l7.191"></a><span id="l7.191">       }</span>
<a href="#l7.192"></a><span id="l7.192">     }</span>
<a href="#l7.193"></a><span id="l7.193">     finally {    </span>
<a href="#l7.194"></a><span id="l7.194">       this._inCallback = false;</span>
<a href="#l7.195"></a><span id="l7.195">     }</span>
<a href="#l7.196"></a><span id="l7.196" class="difflineat">@@ -873,22 +877,22 @@ let GlodaIndexer = {</span>
<a href="#l7.197"></a><span id="l7.197">         }</span>
<a href="#l7.198"></a><span id="l7.198">       </span>
<a href="#l7.199"></a><span id="l7.199">         // XXX for performance, we may want to move the try outside the for loop</span>
<a href="#l7.200"></a><span id="l7.200">         //  with a quasi-redundant outer loop that shunts control back inside</span>
<a href="#l7.201"></a><span id="l7.201">         //  if we left the loop due to an exception (without consuming all the</span>
<a href="#l7.202"></a><span id="l7.202">         //  tokens.)</span>
<a href="#l7.203"></a><span id="l7.203">         try {</span>
<a href="#l7.204"></a><span id="l7.204">           switch (this._actualWorker.next()) {</span>
<a href="#l7.205"></a><span id="l7.205" class="difflineminus">-            case kWorkSync:</span>
<a href="#l7.206"></a><span id="l7.206" class="difflineplus">+            case this.kWorkSync:</span>
<a href="#l7.207"></a><span id="l7.207">               break;</span>
<a href="#l7.208"></a><span id="l7.208" class="difflineminus">-            case kWorkAsync:</span>
<a href="#l7.209"></a><span id="l7.209" class="difflineplus">+            case this.kWorkAsync:</span>
<a href="#l7.210"></a><span id="l7.210">               yield kWorkAsync;</span>
<a href="#l7.211"></a><span id="l7.211">               break;</span>
<a href="#l7.212"></a><span id="l7.212" class="difflineminus">-            case kWorkDone:</span>
<a href="#l7.213"></a><span id="l7.213" class="difflineplus">+            case this.kWorkDone:</span>
<a href="#l7.214"></a><span id="l7.214">               this._actualWorker.close();</span>
<a href="#l7.215"></a><span id="l7.215">               this._actualWorker = null;</span>
<a href="#l7.216"></a><span id="l7.216">               break;</span>
<a href="#l7.217"></a><span id="l7.217">           }</span>
<a href="#l7.218"></a><span id="l7.218">         }</span>
<a href="#l7.219"></a><span id="l7.219">         catch (ex) {</span>
<a href="#l7.220"></a><span id="l7.220">           this._log.debug(&quot;Bailing on job (at &quot; + ex.fileName + &quot;:&quot; +</span>
<a href="#l7.221"></a><span id="l7.221">               ex.lineNumber + &quot;) because: &quot; + ex);</span>
<a href="#l7.222"></a><span id="l7.222" class="difflineat">@@ -899,28 +903,28 @@ let GlodaIndexer = {</span>
<a href="#l7.223"></a><span id="l7.223">             this._actualWorker = null;</span>
<a href="#l7.224"></a><span id="l7.224">           }</span>
<a href="#l7.225"></a><span id="l7.225">         }</span>
<a href="#l7.226"></a><span id="l7.226">       }</span>
<a href="#l7.227"></a><span id="l7.227">       </span>
<a href="#l7.228"></a><span id="l7.228">       // take a breather by having the caller re-schedule us sometime in the</span>
<a href="#l7.229"></a><span id="l7.229">       //  future, but only if we're going to perform another loop iteration.</span>
<a href="#l7.230"></a><span id="l7.230">       if (commitTokens &gt; 0)</span>
<a href="#l7.231"></a><span id="l7.231" class="difflineminus">-        yield kWorkPause;</span>
<a href="#l7.232"></a><span id="l7.232" class="difflineplus">+        yield this.kWorkPause;</span>
<a href="#l7.233"></a><span id="l7.233">     }</span>
<a href="#l7.234"></a><span id="l7.234">     // XXX doing the dirty commit/check every time could be pretty expensive...</span>
<a href="#l7.235"></a><span id="l7.235">     GlodaCollectionManager.cacheCommitDirty();</span>
<a href="#l7.236"></a><span id="l7.236">     GlodaDatastore._commitTransaction();</span>
<a href="#l7.237"></a><span id="l7.237">     </span>
<a href="#l7.238"></a><span id="l7.238">     // try and get a job if we don't have one for the sake of the notification</span>
<a href="#l7.239"></a><span id="l7.239">     if (this.indexing &amp;&amp; (this._actualWorker === null))</span>
<a href="#l7.240"></a><span id="l7.240">       this._hireJobWorker();</span>
<a href="#l7.241"></a><span id="l7.241">     this._notifyListeners();</span>
<a href="#l7.242"></a><span id="l7.242">     </span>
<a href="#l7.243"></a><span id="l7.243" class="difflineminus">-    yield kWorkDone;</span>
<a href="#l7.244"></a><span id="l7.244" class="difflineplus">+    yield this.kWorkDone;</span>
<a href="#l7.245"></a><span id="l7.245">   },</span>
<a href="#l7.246"></a><span id="l7.246"> </span>
<a href="#l7.247"></a><span id="l7.247">   /**</span>
<a href="#l7.248"></a><span id="l7.248">    * Perform the initialization step and return a generator if there is any</span>
<a href="#l7.249"></a><span id="l7.249">    *  steady-state processing to be had.</span>
<a href="#l7.250"></a><span id="l7.250">    */</span>
<a href="#l7.251"></a><span id="l7.251">   _hireJobWorker: function gloda_index_hireJobWorker() {</span>
<a href="#l7.252"></a><span id="l7.252">     if (this._indexQueue.length == 0) {</span>
<a href="#l7.253"></a><span id="l7.253" class="difflineat">@@ -1034,17 +1038,17 @@ let GlodaIndexer = {</span>
<a href="#l7.254"></a><span id="l7.254">         </span>
<a href="#l7.255"></a><span id="l7.255">           aJob.lastFolderIndexedUri = folder.URI;</span>
<a href="#l7.256"></a><span id="l7.256">           this._indexingJobGoal += 2;</span>
<a href="#l7.257"></a><span id="l7.257">           // add a job for the folder indexing</span>
<a href="#l7.258"></a><span id="l7.258">           this._indexQueue.push(new IndexingJob(&quot;folder&quot;, 0,</span>
<a href="#l7.259"></a><span id="l7.259">               this._datastore._mapFolderURI(aJob.lastFolderIndexedUri)));</span>
<a href="#l7.260"></a><span id="l7.260">           // re-schedule this job (although this worker will die)</span>
<a href="#l7.261"></a><span id="l7.261">           this._indexQueue.push(aJob);</span>
<a href="#l7.262"></a><span id="l7.262" class="difflineminus">-          yield kWorkDone;</span>
<a href="#l7.263"></a><span id="l7.263" class="difflineplus">+          yield this.kWorkDone;</span>
<a href="#l7.264"></a><span id="l7.264">         }</span>
<a href="#l7.265"></a><span id="l7.265">         else</span>
<a href="#l7.266"></a><span id="l7.266">         {</span>
<a href="#l7.267"></a><span id="l7.267">           if (aJob.lastFolderIndexedUri == folder.URI)</span>
<a href="#l7.268"></a><span id="l7.268">             useNextFolder = true;</span>
<a href="#l7.269"></a><span id="l7.269">         }</span>
<a href="#l7.270"></a><span id="l7.270">       }</span>
<a href="#l7.271"></a><span id="l7.271">     }</span>
<a href="#l7.272"></a><span id="l7.272" class="difflineat">@@ -1053,17 +1057,17 @@ let GlodaIndexer = {</span>
<a href="#l7.273"></a><span id="l7.273">     if (this.pendingDeletion || this.pendingDeletion === null) {</span>
<a href="#l7.274"></a><span id="l7.274">       this._indexingJobGoal++;</span>
<a href="#l7.275"></a><span id="l7.275">       this._indexQueue.push(new IndexingJob(&quot;delete&quot;, 0, null));</span>
<a href="#l7.276"></a><span id="l7.276">       // no need to set this.indexing to true, it must be true if we are here.</span>
<a href="#l7.277"></a><span id="l7.277">     }</span>
<a href="#l7.278"></a><span id="l7.278">     </span>
<a href="#l7.279"></a><span id="l7.279">     // we don't have any more work to do...</span>
<a href="#l7.280"></a><span id="l7.280">     this._indexingSweepActive = false;</span>
<a href="#l7.281"></a><span id="l7.281" class="difflineminus">-    yield kWorkDone;</span>
<a href="#l7.282"></a><span id="l7.282" class="difflineplus">+    yield this.kWorkDone;</span>
<a href="#l7.283"></a><span id="l7.283">   },</span>
<a href="#l7.284"></a><span id="l7.284"> </span>
<a href="#l7.285"></a><span id="l7.285">   /**</span>
<a href="#l7.286"></a><span id="l7.286">    * Index the contents of a folder.</span>
<a href="#l7.287"></a><span id="l7.287">    */</span>
<a href="#l7.288"></a><span id="l7.288">   _worker_folderIndex: function gloda_worker_folderIndex(aJob) {</span>
<a href="#l7.289"></a><span id="l7.289">     yield this._indexerEnterFolder(aJob.id, true);</span>
<a href="#l7.290"></a><span id="l7.290">     aJob.goal = this._indexingFolder.getTotalMessages(false);</span>
<a href="#l7.291"></a><span id="l7.291" class="difflineat">@@ -1075,17 +1079,17 @@ let GlodaIndexer = {</span>
<a href="#l7.292"></a><span id="l7.292">     let isLocal = this._indexingFolder instanceof Ci.nsIMsgLocalMailFolder;</span>
<a href="#l7.293"></a><span id="l7.293">     // we can safely presume if we are here that this folder has been selected</span>
<a href="#l7.294"></a><span id="l7.294">     //  for offline processing...</span>
<a href="#l7.295"></a><span id="l7.295">     </span>
<a href="#l7.296"></a><span id="l7.296">     for (let msgHdr in this._indexingIterator) {</span>
<a href="#l7.297"></a><span id="l7.297">       // per above, we want to periodically release control while doing all</span>
<a href="#l7.298"></a><span id="l7.298">       //  this header traversal/investigation.</span>
<a href="#l7.299"></a><span id="l7.299">       if (++aJob.offset % HEADER_CHECK_BLOCK_SIZE == 0)</span>
<a href="#l7.300"></a><span id="l7.300" class="difflineminus">-        yield kWorkSync;</span>
<a href="#l7.301"></a><span id="l7.301" class="difflineplus">+        yield this.kWorkSync;</span>
<a href="#l7.302"></a><span id="l7.302">       </span>
<a href="#l7.303"></a><span id="l7.303">       if (isLocal || msgHdr.flags&amp;MSG_FLAG_OFFLINE) {</span>
<a href="#l7.304"></a><span id="l7.304">         // this returns 0 when missing</span>
<a href="#l7.305"></a><span id="l7.305">         let glodaMessageId = msgHdr.getUint32Property(</span>
<a href="#l7.306"></a><span id="l7.306">                              this.GLODA_MESSAGE_ID_PROPERTY);</span>
<a href="#l7.307"></a><span id="l7.307">         </span>
<a href="#l7.308"></a><span id="l7.308">         // if it has a gloda message id, it has been indexed, but it still</span>
<a href="#l7.309"></a><span id="l7.309">         //  could be dirty.</span>
<a href="#l7.310"></a><span id="l7.310" class="difflineat">@@ -1102,17 +1106,17 @@ let GlodaIndexer = {</span>
<a href="#l7.311"></a><span id="l7.311">       }</span>
<a href="#l7.312"></a><span id="l7.312">     }</span>
<a href="#l7.313"></a><span id="l7.313">     </span>
<a href="#l7.314"></a><span id="l7.314">     this._indexingFolder.setStringProperty(this.GLODA_DIRTY_PROPERTY, &quot;0&quot;);</span>
<a href="#l7.315"></a><span id="l7.315">     </span>
<a href="#l7.316"></a><span id="l7.316">     // by definition, it's not likely we'll visit this folder again anytime soon</span>
<a href="#l7.317"></a><span id="l7.317">     this._indexerLeaveFolder();</span>
<a href="#l7.318"></a><span id="l7.318">     </span>
<a href="#l7.319"></a><span id="l7.319" class="difflineminus">-    yield kWorkDone;</span>
<a href="#l7.320"></a><span id="l7.320" class="difflineplus">+    yield this.kWorkDone;</span>
<a href="#l7.321"></a><span id="l7.321">   },</span>
<a href="#l7.322"></a><span id="l7.322">   </span>
<a href="#l7.323"></a><span id="l7.323">   /**</span>
<a href="#l7.324"></a><span id="l7.324">    * Index a specific list of messages that we know to index from</span>
<a href="#l7.325"></a><span id="l7.325">    *  event-notification hints.</span>
<a href="#l7.326"></a><span id="l7.326">    */</span>
<a href="#l7.327"></a><span id="l7.327">   _worker_messageIndex: function gloda_worker_messageAdd(aJob) {</span>
<a href="#l7.328"></a><span id="l7.328">     for (; aJob.offset &lt; aJob.items.length; aJob.offset++) {</span>
<a href="#l7.329"></a><span id="l7.329" class="difflineat">@@ -1130,19 +1134,19 @@ let GlodaIndexer = {</span>
<a href="#l7.330"></a><span id="l7.330">       else</span>
<a href="#l7.331"></a><span id="l7.331">         // same deal as in move processing.</span>
<a href="#l7.332"></a><span id="l7.332">         // TODO fixme to not assume singular message-id's.</span>
<a href="#l7.333"></a><span id="l7.333">         msgHdr = this._indexingDatabase.getMsgHdrForMessageID(item[1]);</span>
<a href="#l7.334"></a><span id="l7.334">       </span>
<a href="#l7.335"></a><span id="l7.335">       if (msgHdr)</span>
<a href="#l7.336"></a><span id="l7.336">         yield this._indexMessage(msgHdr);</span>
<a href="#l7.337"></a><span id="l7.337">       else</span>
<a href="#l7.338"></a><span id="l7.338" class="difflineminus">-        yield kWorkSync;</span>
<a href="#l7.339"></a><span id="l7.339" class="difflineplus">+        yield this.kWorkSync;</span>
<a href="#l7.340"></a><span id="l7.340">     }</span>
<a href="#l7.341"></a><span id="l7.341" class="difflineminus">-    yield kWorkDone;</span>
<a href="#l7.342"></a><span id="l7.342" class="difflineplus">+    yield this.kWorkDone;</span>
<a href="#l7.343"></a><span id="l7.343">   },</span>
<a href="#l7.344"></a><span id="l7.344">   </span>
<a href="#l7.345"></a><span id="l7.345">   /**</span>
<a href="#l7.346"></a><span id="l7.346">    * Process pending deletes...</span>
<a href="#l7.347"></a><span id="l7.347">    */</span>
<a href="#l7.348"></a><span id="l7.348">   _worker_processDeletes: function gloda_worker_processDeletes(aJob) {</span>
<a href="#l7.349"></a><span id="l7.349">     // get a block of messages to delete.  for now, let's just do this</span>
<a href="#l7.350"></a><span id="l7.350">     //  synchronously.  we don't care if there are un-landed delete changes</span>
<a href="#l7.351"></a><span id="l7.351" class="difflineat">@@ -1152,26 +1156,26 @@ let GlodaIndexer = {</span>
<a href="#l7.352"></a><span id="l7.352">     //  sufficiently close to zero until we move to being async.)</span>
<a href="#l7.353"></a><span id="l7.353">     let messagesToDelete = this._datastore.getDeletedMessageBlock();</span>
<a href="#l7.354"></a><span id="l7.354">     let processedAny = false;</span>
<a href="#l7.355"></a><span id="l7.355">     while (messagesToDelete.length) {</span>
<a href="#l7.356"></a><span id="l7.356">       aJob.goal += messagesToDelete.length;</span>
<a href="#l7.357"></a><span id="l7.357">       for each (let message in messagesToDelete) {</span>
<a href="#l7.358"></a><span id="l7.358">         this._deleteMessage(message);</span>
<a href="#l7.359"></a><span id="l7.359">         aJob.offset++;</span>
<a href="#l7.360"></a><span id="l7.360" class="difflineminus">-        yield kWorkSync;</span>
<a href="#l7.361"></a><span id="l7.361" class="difflineplus">+        yield this.kWorkSync;</span>
<a href="#l7.362"></a><span id="l7.362">       }</span>
<a href="#l7.363"></a><span id="l7.363">       </span>
<a href="#l7.364"></a><span id="l7.364">       processedAny = true;</span>
<a href="#l7.365"></a><span id="l7.365">       messagesToDelete = this._datastore.getDeletedMessageBlock(); </span>
<a href="#l7.366"></a><span id="l7.366">     }</span>
<a href="#l7.367"></a><span id="l7.367">     if (processedAny)</span>
<a href="#l7.368"></a><span id="l7.368">       this.pendingDeletions = false;</span>
<a href="#l7.369"></a><span id="l7.369">     </span>
<a href="#l7.370"></a><span id="l7.370" class="difflineminus">-    yield kWorkDone;</span>
<a href="#l7.371"></a><span id="l7.371" class="difflineplus">+    yield this.kWorkDone;</span>
<a href="#l7.372"></a><span id="l7.372">   },</span>
<a href="#l7.373"></a><span id="l7.373"> </span>
<a href="#l7.374"></a><span id="l7.374">   /**</span>
<a href="#l7.375"></a><span id="l7.375">    * Queue all of the folders of all of the accounts of the current profile</span>
<a href="#l7.376"></a><span id="l7.376">    *  for indexing.  We traverse all folders and queue them immediately to try</span>
<a href="#l7.377"></a><span id="l7.377">    *  and have an accurate estimate of the number of folders that need to be</span>
<a href="#l7.378"></a><span id="l7.378">    *  indexed.  (We previously queued accounts rather than immediately</span>
<a href="#l7.379"></a><span id="l7.379">    *  walking their list of folders.)</span>
<a href="#l7.380"></a><span id="l7.380" class="difflineat">@@ -1762,17 +1766,17 @@ let GlodaIndexer = {</span>
<a href="#l7.381"></a><span id="l7.381">       return &quot;Global Database Indexer&quot;; // L10n-me</span>
<a href="#l7.382"></a><span id="l7.382">     },</span>
<a href="#l7.383"></a><span id="l7.383">   }, </span>
<a href="#l7.384"></a><span id="l7.384">   </span>
<a href="#l7.385"></a><span id="l7.385">   _indexMessage: function gloda_indexMessage(aMsgHdr) {</span>
<a href="#l7.386"></a><span id="l7.386">     this._log.debug(&quot;*** Indexing message: &quot; + aMsgHdr.messageKey + &quot; : &quot; +</span>
<a href="#l7.387"></a><span id="l7.387">                     aMsgHdr.subject);</span>
<a href="#l7.388"></a><span id="l7.388">     MsgHdrToMimeMessage(aMsgHdr, this, this._indexMessageWithBody);</span>
<a href="#l7.389"></a><span id="l7.389" class="difflineminus">-    return kWorkAsync;</span>
<a href="#l7.390"></a><span id="l7.390" class="difflineplus">+    return this.kWorkAsync;</span>
<a href="#l7.391"></a><span id="l7.391">   },</span>
<a href="#l7.392"></a><span id="l7.392">   </span>
<a href="#l7.393"></a><span id="l7.393">   _indexMessageWithBody: function gloda_index_indexMessageWithBody(</span>
<a href="#l7.394"></a><span id="l7.394">        aMsgHdr, aMimeMsg) {</span>
<a href="#l7.395"></a><span id="l7.395"> </span>
<a href="#l7.396"></a><span id="l7.396">     // -- Find/create the conversation the message belongs to.</span>
<a href="#l7.397"></a><span id="l7.397">     // Our invariant is that all messages that exist in the database belong to</span>
<a href="#l7.398"></a><span id="l7.398">     //  a conversation.</span>
<a href="#l7.399"></a><span id="l7.399" class="difflineat">@@ -1783,17 +1787,17 @@ let GlodaIndexer = {</span>
<a href="#l7.400"></a><span id="l7.400">                       (i in range(0, aMsgHdr.numReferences))];</span>
<a href="#l7.401"></a><span id="l7.401">     // also see if we already know about the message...</span>
<a href="#l7.402"></a><span id="l7.402">     references.push(aMsgHdr.messageId);</span>
<a href="#l7.403"></a><span id="l7.403">     </span>
<a href="#l7.404"></a><span id="l7.404">     this._datastore.getMessagesByMessageID(references,</span>
<a href="#l7.405"></a><span id="l7.405">       this._indexMessageWithBodyAndAncestors, this,</span>
<a href="#l7.406"></a><span id="l7.406">       [references, aMsgHdr, aMimeMsg]);</span>
<a href="#l7.407"></a><span id="l7.407">     </span>
<a href="#l7.408"></a><span id="l7.408" class="difflineminus">-    return kWorkAsync;</span>
<a href="#l7.409"></a><span id="l7.409" class="difflineplus">+    return this.kWorkAsync;</span>
<a href="#l7.410"></a><span id="l7.410">   },</span>
<a href="#l7.411"></a><span id="l7.411">   </span>
<a href="#l7.412"></a><span id="l7.412">   _indexMessageWithBodyAndAncestors:</span>
<a href="#l7.413"></a><span id="l7.413">     function gloda_index_indexMessageWithBodyAndAncestors(ancestorLists,</span>
<a href="#l7.414"></a><span id="l7.414">       references, aMsgHdr, aMimeMsg) {</span>
<a href="#l7.415"></a><span id="l7.415">     // (ancestorLists has a direct correspondence to the message ids)</span>
<a href="#l7.416"></a><span id="l7.416">     </span>
<a href="#l7.417"></a><span id="l7.417">     // pull our current message lookup results off</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/modules/noun_tag.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/modules/noun_tag.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -39,32 +39,36 @@ EXPORTED_SYMBOLS = ['Tagged', 'TagNoun']</span>
<a href="#l8.4"></a><span id="l8.4"> </span>
<a href="#l8.5"></a><span id="l8.5"> const Cc = Components.classes;</span>
<a href="#l8.6"></a><span id="l8.6"> const Ci = Components.interfaces;</span>
<a href="#l8.7"></a><span id="l8.7"> const Cr = Components.results;</span>
<a href="#l8.8"></a><span id="l8.8"> const Cu = Components.utils;</span>
<a href="#l8.9"></a><span id="l8.9"> </span>
<a href="#l8.10"></a><span id="l8.10"> Cu.import(&quot;resource://gloda/modules/gloda.js&quot;);</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+/**</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+ * @class Represents a tag applied at a certain time.  Or rather it would if we</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+ *  were clever enough to track and maintain that time accurately.</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+ */</span>
<a href="#l8.16"></a><span id="l8.16"> function Tagged(aTag, aDate) {</span>
<a href="#l8.17"></a><span id="l8.17">   this.tag = aTag;</span>
<a href="#l8.18"></a><span id="l8.18">   this.date = aDate;</span>
<a href="#l8.19"></a><span id="l8.19"> }</span>
<a href="#l8.20"></a><span id="l8.20"> </span>
<a href="#l8.21"></a><span id="l8.21"> Tagged.prototype = {</span>
<a href="#l8.22"></a><span id="l8.22">   toString: function () {</span>
<a href="#l8.23"></a><span id="l8.23">     return this.tag.tag;</span>
<a href="#l8.24"></a><span id="l8.24">   }</span>
<a href="#l8.25"></a><span id="l8.25"> };</span>
<a href="#l8.26"></a><span id="l8.26"> </span>
<a href="#l8.27"></a><span id="l8.27"> /**</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineminus">- * We are the tag noun provider.  Since the tag unique value is stored as a</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineplus">+ * @namespace Tag noun provider.  Since the tag unique value is stored as a</span>
<a href="#l8.30"></a><span id="l8.30">  *  parameter, we are an odd case and semantically confused.</span>
<a href="#l8.31"></a><span id="l8.31">  */</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineminus">-let TagNoun = {</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineplus">+var TagNoun = {</span>
<a href="#l8.34"></a><span id="l8.34">   name: &quot;tag&quot;,</span>
<a href="#l8.35"></a><span id="l8.35">   class: Tagged,</span>
<a href="#l8.36"></a><span id="l8.36">   firstClass: false,</span>
<a href="#l8.37"></a><span id="l8.37">   _msgTagService: null,</span>
<a href="#l8.38"></a><span id="l8.38">   </span>
<a href="#l8.39"></a><span id="l8.39">   _init: function () {</span>
<a href="#l8.40"></a><span id="l8.40">     this._msgTagService = Cc[&quot;@mozilla.org/messenger/tagservice;1&quot;].</span>
<a href="#l8.41"></a><span id="l8.41">                           getService(Ci.nsIMsgTagService);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/modules/query.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/modules/query.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -40,22 +40,25 @@ EXPORTED_SYMBOLS = [&quot;GlodaQueryClassFact</span>
<a href="#l9.4"></a><span id="l9.4"> const Cc = Components.classes;</span>
<a href="#l9.5"></a><span id="l9.5"> const Ci = Components.interfaces;</span>
<a href="#l9.6"></a><span id="l9.6"> const Cr = Components.results;</span>
<a href="#l9.7"></a><span id="l9.7"> const Cu = Components.utils;</span>
<a href="#l9.8"></a><span id="l9.8"> </span>
<a href="#l9.9"></a><span id="l9.9"> Cu.import(&quot;resource://gloda/modules/log4moz.js&quot;);</span>
<a href="#l9.10"></a><span id="l9.10"> </span>
<a href="#l9.11"></a><span id="l9.11"> /**</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">- * @ivar _owner The query instance that holds the list of unions...</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">- * @ivar _constraints A list of (lists of OR constraints) that are ANDed</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+ * @class Query class core; each noun gets its own sub-class where attributes</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+ *  have helper methods bound.</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+ * </span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+ * @property _owner The query instance that holds the list of unions...</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineplus">+ * @property _constraints A list of (lists of OR constraints) that are ANDed</span>
<a href="#l9.19"></a><span id="l9.19">  *     together.  For example [[FROM bob, FROM jim], [DATE last week]] would</span>
<a href="#l9.20"></a><span id="l9.20">  *     be requesting us to find all the messages from either bob or jim, and</span>
<a href="#l9.21"></a><span id="l9.21">  *     sent in the last week.</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineminus">- * @ivar _unions A list of other queries whose results are unioned with our</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineplus">+ * @property _unions A list of other queries whose results are unioned with our</span>
<a href="#l9.24"></a><span id="l9.24">  *     own.  There is no concept of nesting or sub-queries apart from this</span>
<a href="#l9.25"></a><span id="l9.25">  *     mechanism.</span>
<a href="#l9.26"></a><span id="l9.26">  */</span>
<a href="#l9.27"></a><span id="l9.27"> function GlodaQueryClass() {</span>
<a href="#l9.28"></a><span id="l9.28">   // if we are an 'or' clause, who is our parent whom other 'or' clauses should</span>
<a href="#l9.29"></a><span id="l9.29">   //  spawn from...</span>
<a href="#l9.30"></a><span id="l9.30">   this._owner = null;</span>
<a href="#l9.31"></a><span id="l9.31">   // our personal chain of and-ing.</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineat">@@ -174,17 +177,17 @@ GlodaQueryClass.prototype = {</span>
<a href="#l9.33"></a><span id="l9.33">         return true;</span>
<a href="#l9.34"></a><span id="l9.34">     }</span>
<a href="#l9.35"></a><span id="l9.35">     </span>
<a href="#l9.36"></a><span id="l9.36">     return false;</span>
<a href="#l9.37"></a><span id="l9.37">   },</span>
<a href="#l9.38"></a><span id="l9.38"> };</span>
<a href="#l9.39"></a><span id="l9.39"> </span>
<a href="#l9.40"></a><span id="l9.40"> /**</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineminus">- * A query that only 'tests' for already belonging to the collection.</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineplus">+ * @class A query that only 'tests' for already belonging to the collection.</span>
<a href="#l9.43"></a><span id="l9.43">  */</span>
<a href="#l9.44"></a><span id="l9.44"> function GlodaExplicitQueryClass() {</span>
<a href="#l9.45"></a><span id="l9.45"> }</span>
<a href="#l9.46"></a><span id="l9.46"> </span>
<a href="#l9.47"></a><span id="l9.47"> GlodaExplicitQueryClass.prototype = {</span>
<a href="#l9.48"></a><span id="l9.48">   // don't let people try and mess with us</span>
<a href="#l9.49"></a><span id="l9.49">   or: function() { return null; },</span>
<a href="#l9.50"></a><span id="l9.50">   // don't let people try and query on us (until we have a real use case for</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineat">@@ -194,17 +197,17 @@ GlodaExplicitQueryClass.prototype = {</span>
<a href="#l9.52"></a><span id="l9.52">    * Matches only items that are already in the collection (by id).</span>
<a href="#l9.53"></a><span id="l9.53">    */</span>
<a href="#l9.54"></a><span id="l9.54">   test: function gloda_query_explicit_test(aObj) {</span>
<a href="#l9.55"></a><span id="l9.55">     return (aObj.id in this.collection._idMap);</span>
<a href="#l9.56"></a><span id="l9.56">   }</span>
<a href="#l9.57"></a><span id="l9.57"> };</span>
<a href="#l9.58"></a><span id="l9.58"> </span>
<a href="#l9.59"></a><span id="l9.59"> /**</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineminus">- * A query that 'tests' true for everything.  Intended for debugging purposes</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineplus">+ * @class A query that 'tests' true for everything.  Intended for debugging purposes</span>
<a href="#l9.62"></a><span id="l9.62">  *  only.</span>
<a href="#l9.63"></a><span id="l9.63">  */</span>
<a href="#l9.64"></a><span id="l9.64"> function GlodaWildcardQueryClass() {</span>
<a href="#l9.65"></a><span id="l9.65"> }</span>
<a href="#l9.66"></a><span id="l9.66"> </span>
<a href="#l9.67"></a><span id="l9.67"> GlodaWildcardQueryClass.prototype = {</span>
<a href="#l9.68"></a><span id="l9.68">   // don't let people try and mess with us</span>
<a href="#l9.69"></a><span id="l9.69">   or: function() { return null; },</span>
<a href="#l9.70"></a><span id="l9.70" class="difflineat">@@ -214,17 +217,22 @@ GlodaWildcardQueryClass.prototype = {</span>
<a href="#l9.71"></a><span id="l9.71">   /**</span>
<a href="#l9.72"></a><span id="l9.72">    * Everybody wins!</span>
<a href="#l9.73"></a><span id="l9.73">    */</span>
<a href="#l9.74"></a><span id="l9.74">   test: function gloda_query_explicit_test(aObj) {</span>
<a href="#l9.75"></a><span id="l9.75">     return true;</span>
<a href="#l9.76"></a><span id="l9.76">   }</span>
<a href="#l9.77"></a><span id="l9.77"> };</span>
<a href="#l9.78"></a><span id="l9.78"> </span>
<a href="#l9.79"></a><span id="l9.79" class="difflineminus">-</span>
<a href="#l9.80"></a><span id="l9.80" class="difflineplus">+/**</span>
<a href="#l9.81"></a><span id="l9.81" class="difflineplus">+ * Factory method to effectively create per-noun subclasses of GlodaQueryClass,</span>
<a href="#l9.82"></a><span id="l9.82" class="difflineplus">+ *  GlodaExplicitQueryClas, and GlodaWildcardQueryClass.  For GlodaQueryClass</span>
<a href="#l9.83"></a><span id="l9.83" class="difflineplus">+ *  this allows us to add per-noun helpers.  For the others, this is merely a</span>
<a href="#l9.84"></a><span id="l9.84" class="difflineplus">+ *  means of allowing us to attach the (per-noun) nounMeta to the 'class'.</span>
<a href="#l9.85"></a><span id="l9.85" class="difflineplus">+ */</span>
<a href="#l9.86"></a><span id="l9.86"> function GlodaQueryClassFactory(aNounMeta) {</span>
<a href="#l9.87"></a><span id="l9.87">   let newQueryClass = function() {</span>
<a href="#l9.88"></a><span id="l9.88">     GlodaQueryClass.call(this);</span>
<a href="#l9.89"></a><span id="l9.89">   }; </span>
<a href="#l9.90"></a><span id="l9.90">   </span>
<a href="#l9.91"></a><span id="l9.91">   newQueryClass.prototype = new GlodaQueryClass;</span>
<a href="#l9.92"></a><span id="l9.92">   newQueryClass.prototype._queryClass = newQueryClass;</span>
<a href="#l9.93"></a><span id="l9.93">   newQueryClass.prototype._nounMeta = aNounMeta;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/modules/suffixtree.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/modules/suffixtree.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -55,17 +55,17 @@ function MultiSuffixTree(aStrings, aItem</span>
<a href="#l10.4"></a><span id="l10.4">   }</span>
<a href="#l10.5"></a><span id="l10.5">   </span>
<a href="#l10.6"></a><span id="l10.6">   this._construct(s);</span>
<a href="#l10.7"></a><span id="l10.7">   this._offsetsToItems = offsetsToItems;</span>
<a href="#l10.8"></a><span id="l10.8">   this._numItems = aItems.length;</span>
<a href="#l10.9"></a><span id="l10.9"> }</span>
<a href="#l10.10"></a><span id="l10.10"> </span>
<a href="#l10.11"></a><span id="l10.11"> /**</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">- *</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+ * @constructor</span>
<a href="#l10.14"></a><span id="l10.14">  */</span>
<a href="#l10.15"></a><span id="l10.15"> function State(aStartIndex, aEndIndex, aSuffix) {</span>
<a href="#l10.16"></a><span id="l10.16">   this.start = aStartIndex;</span>
<a href="#l10.17"></a><span id="l10.17">   this.end = aEndIndex;</span>
<a href="#l10.18"></a><span id="l10.18">   this.suffix = aSuffix;</span>
<a href="#l10.19"></a><span id="l10.19"> }</span>
<a href="#l10.20"></a><span id="l10.20"> </span>
<a href="#l10.21"></a><span id="l10.21"> var dump;</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineat">@@ -100,16 +100,17 @@ State.prototype = {</span>
<a href="#l10.23"></a><span id="l10.23">   toString: function State_toString() {</span>
<a href="#l10.24"></a><span id="l10.24">     return &quot;[Start: &quot; + this.start + &quot; End: &quot; + this.end +</span>
<a href="#l10.25"></a><span id="l10.25">            (this.suffix ? &quot; non-null suffix]&quot; : &quot; null suffix]&quot;); </span>
<a href="#l10.26"></a><span id="l10.26">   }</span>
<a href="#l10.27"></a><span id="l10.27"> };</span>
<a href="#l10.28"></a><span id="l10.28"> </span>
<a href="#l10.29"></a><span id="l10.29"> /**</span>
<a href="#l10.30"></a><span id="l10.30">  * Suffix tree implemented using Ukkonen's algorithm.</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineplus">+ * @constructor</span>
<a href="#l10.32"></a><span id="l10.32">  */</span>
<a href="#l10.33"></a><span id="l10.33"> function SuffixTree(aStr) {</span>
<a href="#l10.34"></a><span id="l10.34">   this._construct(aStr);</span>
<a href="#l10.35"></a><span id="l10.35"> }</span>
<a href="#l10.36"></a><span id="l10.36"> </span>
<a href="#l10.37"></a><span id="l10.37"> /**</span>
<a href="#l10.38"></a><span id="l10.38">  * States are </span>
<a href="#l10.39"></a><span id="l10.39">  */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/modules/utils.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/modules/utils.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -37,18 +37,21 @@</span>
<a href="#l11.4"></a><span id="l11.4"> </span>
<a href="#l11.5"></a><span id="l11.5"> EXPORTED_SYMBOLS = ['GlodaUtils'];</span>
<a href="#l11.6"></a><span id="l11.6"> </span>
<a href="#l11.7"></a><span id="l11.7"> const Cc = Components.classes;</span>
<a href="#l11.8"></a><span id="l11.8"> const Ci = Components.interfaces;</span>
<a href="#l11.9"></a><span id="l11.9"> const Cr = Components.results;</span>
<a href="#l11.10"></a><span id="l11.10"> const Cu = Components.utils;</span>
<a href="#l11.11"></a><span id="l11.11"> </span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-let GlodaUtils = {</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+/**</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+ * @namespace A holding place for logic that is not gloda-specific and should</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineplus">+ *  reside elsewhere.</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineplus">+ */</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineplus">+var GlodaUtils = {</span>
<a href="#l11.19"></a><span id="l11.19">   _mimeConverter: null,</span>
<a href="#l11.20"></a><span id="l11.20">   deMime: function gloda_utils_deMime(aString) {</span>
<a href="#l11.21"></a><span id="l11.21">     if (this._mimeConverter == null) {</span>
<a href="#l11.22"></a><span id="l11.22">       this._mimeConverter = Cc[&quot;@mozilla.org/messenger/mimeconverter;1&quot;].</span>
<a href="#l11.23"></a><span id="l11.23">                             getService(Ci.nsIMimeConverter);</span>
<a href="#l11.24"></a><span id="l11.24">     }</span>
<a href="#l11.25"></a><span id="l11.25">     </span>
<a href="#l11.26"></a><span id="l11.26">     return this._mimeConverter.decodeMimeHeader(aString, null, false, true);</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

